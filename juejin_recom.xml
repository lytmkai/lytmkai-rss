<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Spring Boot 与 Disruptor 高性能并发实战]]></title>    <link>https://juejin.cn/post/7588092534161915904</link>    <guid>https://juejin.cn/post/7588092534161915904</guid>    <pubDate>2025-12-27T14:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588092534161915904" data-draft-id="7588095884069928960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 与 Disruptor 高性能并发实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T14:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 与 Disruptor 高性能并发实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:10:24.000Z" title="Sat Dec 27 2025 14:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. Disruptor 框架简介</h2>
<p>Disruptor 是 LMAX 公司开发的高性能无锁并发框架，专门为解决高并发场景下的数据交换问题而设计。它基于<strong>环形缓冲区</strong>和<strong>无锁算法</strong>实现，能够在单个线程上每秒处理数百万笔订单，在金融交易、实时数据处理等领域有着卓越表现。</p>
<h3 data-id="heading-1">1.1 为什么需要 Disruptor</h3>
<p>传统阻塞队列（如 ArrayBlockingQueue）在高并发环境下存在性能瓶颈：线程会因竞争锁而频繁挂起和恢复，产生大量上下文切换开销。实验表明，对有锁数据结构进行5亿次操作，<strong>加锁多线程并发</strong>情况下速度比<strong>单线程无锁</strong>慢3个数量级，而 CAS 操作性能约为锁操作的8倍。</p>
<p>Disruptor 通过无锁设计解决了这一核心问题，特别适用于需要高吞吐量和低延迟的应用场景。</p>
<h2 data-id="heading-2">2. Disruptor 核心架构与性能原理</h2>
<h3 data-id="heading-3">2.1 环形缓冲区（Ring Buffer）</h3>
<p>Ring Buffer 是 Disruptor 的核心数据结构，它是一个固定大小的环形数组。这种设计具有显著优势：</p>
<ul>
<li><strong>内存连续</strong>：数组元素在内存中连续分布，有利于 CPU 缓存预加载</li>
<li><strong>复用内存</strong>：预先分配所有事件对象，避免运行时频繁创建对象和垃圾回收</li>
<li><strong>快速定位</strong>：通过位运算替代取模操作，<code>sequence &amp; (array length - 1) = array index</code></li>
</ul>
<h3 data-id="heading-4">2.2 无锁设计实现</h3>
<p>Disruptor 采用 CAS（Compare-And-Swap）操作实现线程安全，完全避免传统锁机制。单生产者模式下甚至不需要任何同步机制，多生产者模式下也仅对序列号进行 CAS 操作。</p>
<h3 data-id="heading-5">2.3 解决伪共享（False Sharing）</h3>
<p>伪共享是现代多核处理器中影响性能的重要因素。当不同线程修改同一缓存行中的不同变量时，会导致缓存行无效化。Disruptor 通过<strong>缓存行填充</strong>技术解决这一问题。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Disruptor 通过填充避免伪共享的示例</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RingBufferPad</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">long</span> p1, p2, p3, p4, p5, p6, p7; <span class="hljs-comment">// 缓存行填充</span>
}
</code></pre>
<h3 data-id="heading-6">2.4 序列号机制</h3>
<p>Disruptor 使用序列号（Sequence）来协调生产者和消费者的工作进度：</p>
<ul>
<li>每个生产者和消费者都有自己独立的序列号</li>
<li>通过序列号跟踪处理进度，避免竞争</li>
<li>序列号本身也进行缓存行填充，防止伪共享</li>
</ul>
<h2 data-id="heading-7">3. Spring Boot 集成 Disruptor 实战</h2>
<p>下面通过一个完整的订单处理案例展示如何在 Spring Boot 项目中集成和使用 Disruptor。</p>
<h3 data-id="heading-8">3.1 环境配置</h3>
<p>首先，在 Maven 项目中添加 Disruptor 依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot 相关依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Disruptor 依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.lmax<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>disruptor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">3.2 定义事件（Event）</h3>
<p>事件是在 Disruptor 中传递的数据载体：</p>
<pre><code class="hljs language-arduino" lang="arduino">@Data
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEvent</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> userId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> status;
}
</code></pre>
<h3 data-id="heading-10">3.3 实现事件工厂</h3>
<p>事件工厂负责预创建事件对象，供 Ring Buffer 使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EventFactory</span>&lt;<span class="hljs-title class_">OrderEvent</span>&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">OrderEvent</span> <span class="hljs-title function_">newInstance</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEvent</span>();
    }
}
</code></pre>
<h3 data-id="heading-11">3.4 实现事件处理器</h3>
<p>事件处理器包含具体的业务逻辑：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrderEventHandler</span> <span class="hljs-title">implements</span> <span class="hljs-title">EventHandler</span>&lt;<span class="hljs-title">OrderEvent</span>&gt; {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onEvent</span>(<span class="hljs-params">OrderEvent <span class="hljs-keyword">event</span>, <span class="hljs-built_in">long</span> sequence, boolean endOfBatch</span>)</span> {
        <span class="hljs-comment">// 处理订单的具体业务逻辑</span>
        processOrder(<span class="hljs-keyword">event</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processOrder</span>(<span class="hljs-params">OrderEvent orderEvent</span>)</span> {
        <span class="hljs-comment">// 模拟订单支付逻辑</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"处理订单: "</span> + orderEvent.getOrderId() + 
                          <span class="hljs-string">", 用户: "</span> + orderEvent.getUserId() + 
                          <span class="hljs-string">", 金额: "</span> + orderEvent.getPrice());
        
        <span class="hljs-comment">// 假设订单处理通过后更新订单状态</span>
        orderEvent.setStatus(<span class="hljs-string">"已支付"</span>);
        
        <span class="hljs-comment">// 模拟库存扣减逻辑</span>
        reduceInventory(orderEvent);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"订单处理完成: "</span> + orderEvent.getOrderId() + <span class="hljs-string">" 状态: "</span> + orderEvent.getStatus());
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduceInventory</span>(<span class="hljs-params">OrderEvent orderEvent</span>)</span> {
        <span class="hljs-comment">// 模拟库存扣减逻辑</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"扣减库存: 订单 "</span> + orderEvent.getOrderId());
    }
}
</code></pre>
<h3 data-id="heading-12">3.5 实现生产者</h3>
<p>生产者负责向 Ring Buffer 发布事件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventProducer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RingBuffer&lt;OrderEvent&gt; ringBuffer;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderEventProducer</span><span class="hljs-params">(RingBuffer&lt;OrderEvent&gt; ringBuffer)</span> {
        <span class="hljs-built_in">this</span>.ringBuffer = ringBuffer;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onData</span><span class="hljs-params">(String userId, <span class="hljs-type">double</span> price)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">sequence</span> <span class="hljs-operator">=</span> ringBuffer.next();  <span class="hljs-comment">// 获取下一个序列号</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">OrderEvent</span> <span class="hljs-variable">orderEvent</span> <span class="hljs-operator">=</span> ringBuffer.get(sequence); <span class="hljs-comment">// 获取事件对象</span>
            orderEvent.setOrderId(UUID.randomUUID().toString());
            orderEvent.setUserId(userId);
            orderEvent.setPrice(price);
            orderEvent.setStatus(<span class="hljs-string">"未支付"</span>);
        } <span class="hljs-keyword">finally</span> {
            ringBuffer.publish(sequence);  <span class="hljs-comment">// 发布事件</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-13">3.6 配置 Disruptor</h3>
<p>在 Spring Boot 中配置 Disruptor Bean：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisruptorConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Disruptor&lt;OrderEvent&gt; <span class="hljs-title function_">disruptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">OrderEventFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEventFactory</span>();
        <span class="hljs-type">int</span> <span class="hljs-variable">bufferSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span>; <span class="hljs-comment">// RingBuffer 大小，必须是2的幂</span>
        
        <span class="hljs-comment">// 创建 Disruptor</span>
        Disruptor&lt;OrderEvent&gt; disruptor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Disruptor</span>&lt;&gt;(
            factory, 
            bufferSize, 
            Executors.defaultThreadFactory(),
            ProducerType.MULTI,  <span class="hljs-comment">// 多生产者模式</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">YieldingWaitStrategy</span>()  <span class="hljs-comment">// 等待策略</span>
        );
        
        <span class="hljs-comment">// 绑定事件处理器</span>
        disruptor.handleEventsWith(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEventHandler</span>());
        disruptor.start();
        
        <span class="hljs-keyword">return</span> disruptor;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> OrderEventProducer <span class="hljs-title function_">orderEventProducer</span><span class="hljs-params">(Disruptor&lt;OrderEvent&gt; disruptor)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEventProducer</span>(disruptor.getRingBuffer());
    }
}
</code></pre>
<h3 data-id="heading-14">3.7 创建 REST 控制器</h3>
<p>通过 REST API 接收订单请求：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/orders"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderEventProducer</span> orderEventProducer;
    
    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">createOrder</span>(<span class="hljs-params"><span class="hljs-meta">@RequestBody</span> OrderRequest orderRequest</span>) {
        orderEventProducer.<span class="hljs-title function_">onData</span>(orderRequest.<span class="hljs-title function_">getUserId</span>(), orderRequest.<span class="hljs-title function_">getPrice</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(<span class="hljs-string">"订单创建成功，正在处理！"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderRequest</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> userId;
    <span class="hljs-keyword">private</span> double price;
    
    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUserId</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> userId; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUserId</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userId</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">userId</span> = userId; }
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getPrice</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> price; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPrice</span>(<span class="hljs-params">double price</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">price</span> = price; }
}
</code></pre>
<h2 data-id="heading-15">4. 高级特性与优化配置</h2>
<h3 data-id="heading-16">4.1 等待策略选择</h3>
<p>Disruptor 提供多种等待策略，适用于不同场景：</p>
<ul>
<li><strong>BlockingWaitStrategy</strong>：默认策略，使用锁和条件变量，CPU 消耗最小</li>
<li><strong>SleepingWaitStrategy</strong>：平衡延迟和 CPU 消耗，适用于异步日志记录等场景</li>
<li><strong>YieldingWaitStrategy</strong>：低延迟策略，通过自旋和 Thread.yield() 实现</li>
<li><strong>BusySpinWaitStrategy</strong>：性能最佳，但 CPU 占用最高，适用于低延迟系统</li>
</ul>
<h3 data-id="heading-17">4.2 多消费者模式</h3>
<p>Disruptor 支持复杂的消费者依赖关系：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 并行处理：三个消费者同时处理每个事件</span>
disruptor<span class="hljs-selector-class">.handleEventsWith</span>(handler1, handler2, handler3);

<span class="hljs-comment">// 顺序处理：handler1 完成后才执行 handler2</span>
disruptor<span class="hljs-selector-class">.handleEventsWith</span>(handler1)<span class="hljs-selector-class">.then</span>(handler2);

<span class="hljs-comment">// 菱形处理模式</span>
disruptor<span class="hljs-selector-class">.handleEventsWith</span>(handler1, handler2)<span class="hljs-selector-class">.then</span>(handler3);
</code></pre>
<h3 data-id="heading-18">4.3 批量事件处理</h3>
<p>Disruptor 天然支持批量处理，消费者可以一次处理多个可用事件，减少调用次数，提高吞吐量。</p>
<h2 data-id="heading-19">5. 性能优化建议</h2>
<h3 data-id="heading-20">5.1 合理设置 Ring Buffer 大小</h3>
<p>Ring Buffer 大小应为 2 的幂，以便使用位运算替代昂贵的取模操作。大小设置需权衡：</p>
<ul>
<li>过大：占用内存多，增加垃圾回收压力</li>
<li>过小：容易导致生产者阻塞，影响吞吐量</li>
</ul>
<h3 data-id="heading-21">5.2 避免事件对象中创建临时对象</h3>
<p>在事件处理中应避免创建临时对象，以减少垃圾回收压力。可以复用事件对象或使用对象池。</p>
<h3 data-id="heading-22">5.3 监控与调优</h3>
<p>监控 Disruptor 性能指标，包括：</p>
<ul>
<li>生产者与消费者的序列号差距</li>
<li>事件处理延迟分布</li>
<li>系统资源使用情况（CPU、内存）</li>
</ul>
<p>根据监控结果调整等待策略、消费者数量等参数。</p>
<h2 data-id="heading-23">6. 适用场景与限制</h2>
<h3 data-id="heading-24">6.1 理想应用场景</h3>
<ul>
<li><strong>金融交易系统</strong>：高吞吐量、低延迟的订单处理</li>
<li><strong>实时数据处理</strong>：日志处理、实时计算等</li>
<li><strong>游戏服务器</strong>：处理大量玩家并发操作</li>
<li><strong>消息引擎</strong>：高吞吐量的消息传递</li>
</ul>
<h3 data-id="heading-25">6.2 不适用场景</h3>
<ul>
<li><strong>数据持久化</strong>：Disruptor 是内存队列，宕机可能导致数据丢失</li>
<li><strong>分布式系统</strong>：Disruptor 适用于单机高并发，分布式场景需结合消息中间件</li>
<li><strong>简单业务</strong>：低并发场景下优势不明显，反而增加系统复杂度</li>
</ul>
<h2 data-id="heading-26">7. 总结</h2>
<p>Disruptor 通过其独特的环形缓冲区设计和无锁算法，为高并发应用提供了卓越的性能。在 Spring Boot 项目中集成 Disruptor 可以显著提升系统吞吐量，特别是在订单处理、实时计算等场景下。</p>
<p>成功使用 Disruptor 的关键在于：</p>
<ol>
<li>理解其核心原理，特别是内存布局和序列号机制</li>
<li>根据业务特点选择合适的等待策略和消费者模式</li>
<li>进行充分的性能测试和监控，持续调优参数</li>
</ol>
<p>当应用面临高并发挑战，且传统队列成为性能瓶颈时，Disruptor 是一个值得考虑的解决方案，能够帮助系统实现百万级 TPS 的处理能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vert.x框架详解与项目实战：构建高性能异步应用]]></title>    <link>https://juejin.cn/post/7588095884069945344</link>    <guid>https://juejin.cn/post/7588095884069945344</guid>    <pubDate>2025-12-27T14:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884069945344" data-draft-id="7588092534161948672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vert.x框架详解与项目实战：构建高性能异步应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T14:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vert.x框架详解与项目实战：构建高性能异步应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:17:26.000Z" title="Sat Dec 27 2025 14:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Vert.x框架概述</h2>
<h3 data-id="heading-1">1.1 什么是Vert.x？</h3>
<p>Vert.x是一个在JVM上构建响应式应用程序的工具包，采用事件驱动和非阻塞的设计理念。它支持多种编程语言（Java、Kotlin、Scala、Groovy、JavaScript等），使开发者能够用熟悉的语言构建高性能、可扩展的分布式系统。</p>
<h3 data-id="heading-2">1.2 核心特性</h3>
<ul>
<li><strong>事件驱动和非阻塞I/O</strong>：基于Netty，充分利用系统资源</li>
<li><strong>多语言支持</strong>：Polyglot特性允许混合使用多种语言</li>
<li><strong>高并发处理</strong>：单机可处理数百万并发连接</li>
<li><strong>轻量级</strong>：核心库体积小，模块化设计</li>
<li><strong>完整的响应式编程支持</strong>：原生支持RxJava、SmallRye Mutiny等</li>
</ul>
<h2 data-id="heading-3">二、Vert.x核心架构解析</h2>
<h3 data-id="heading-4">2.1 事件循环模型</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// Vert.x的事件循环线程示例</span>
<span class="hljs-selector-tag">vertx</span><span class="hljs-selector-class">.setPeriodic</span>(<span class="hljs-number">1000</span>, id -&gt; {
    <span class="hljs-comment">// 此回调在事件循环线程执行</span>
    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"Timer fired in event loop thread: "</span> 
        + Thread.<span class="hljs-built_in">currentThread</span>().<span class="hljs-built_in">getName</span>());
});
</code></pre>
<p>Vert.x采用多Reactor模式，默认事件循环线程数 = CPU核心数 * 2。这种设计避免了传统阻塞模型中的线程上下文切换开销。</p>
<h3 data-id="heading-5">2.2 Verticle：Vert.x的基本部署单元</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainVerticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractVerticle</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void start() {
        <span class="hljs-comment">// 启动HTTP服务器</span>
        vertx.createHttpServer()
            .requestHandler(req -&gt; {
                req.response()
                   .putHeader(<span class="hljs-string">"content-type"</span>, <span class="hljs-string">"text/plain"</span>)
                   .end(<span class="hljs-string">"Hello from Vert.x!"</span>);
            })
            .listen(<span class="hljs-number">8888</span>);
    }
}
</code></pre>
<p>Verticle有三种类型：</p>
<ol>
<li><strong>Standard Verticle</strong>：标准verticle，在事件循环线程执行</li>
<li><strong>Worker Verticle</strong>：工作verticle，在工作线程池执行</li>
<li><strong>Multi-threaded Worker Verticle</strong>：多线程工作verticle</li>
</ol>
<h3 data-id="heading-6">2.3 Event Bus：应用神经系统</h3>
<p>Vert.x的事件总线提供了分布式、全双工的通信机制，支持：</p>
<ul>
<li>发布/订阅模式</li>
<li>点对点请求/响应</li>
<li>集群模式下跨节点的通信</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 发送消息</span>
eventBus.send(<span class="hljs-string">"news.uk.sport"</span>, <span class="hljs-string">"Yay! Someone kicked a ball"</span>);

<span class="hljs-comment">// 接收消息</span>
eventBus.consumer(<span class="hljs-string">"news.uk.sport"</span>, message -&gt; {
    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Received news: "</span> + message.body());
});
</code></pre>
<h2 data-id="heading-7">三、实战项目：构建实时数据处理系统</h2>
<h3 data-id="heading-8">3.1 项目概述</h3>
<p>我们将构建一个实时数据处理系统，包含以下模块：</p>
<ul>
<li>REST API网关</li>
<li>实时数据处理器</li>
<li>WebSocket推送服务</li>
<li>分布式事件总线通信</li>
<li>监控指标收集</li>
</ul>
<h3 data-id="heading-9">3.2 项目初始化</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven依赖配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.vertx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>vertx-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.vertx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>vertx-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.vertx<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>vertx-web-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">3.3 主启动类实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessingApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">Vertx</span> vertx = <span class="hljs-title class_">Vertx</span>.<span class="hljs-title function_">vertx</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VertxOptions</span>()
            .<span class="hljs-title function_">setEventLoopPoolSize</span>(<span class="hljs-number">16</span>)
            .<span class="hljs-title function_">setWorkerPoolSize</span>(<span class="hljs-number">20</span>));
        
        <span class="hljs-comment">// 部署verticle</span>
        <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">String</span>&gt; apiDeployment = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">promise</span>();
        <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">String</span>&gt; processorDeployment = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">promise</span>();
        
        vertx.<span class="hljs-title function_">deployVerticle</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiGatewayVerticle</span>(), apiDeployment);
        vertx.<span class="hljs-title function_">deployVerticle</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataProcessorVerticle</span>(), processorDeployment);
        
        <span class="hljs-comment">// 异步等待所有verticle部署完成</span>
        <span class="hljs-title class_">CompositeFuture</span>.<span class="hljs-title function_">all</span>(apiDeployment.<span class="hljs-title function_">future</span>(), processorDeployment.<span class="hljs-title function_">future</span>())
            .<span class="hljs-title function_">onComplete</span>(result -&gt; {
                <span class="hljs-keyword">if</span> (result.<span class="hljs-title function_">succeeded</span>()) {
                    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"所有verticle部署成功！"</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-title class_">System</span>.<span class="hljs-property">err</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"部署失败: "</span> + result.<span class="hljs-title function_">cause</span>().<span class="hljs-title function_">getMessage</span>());
                }
            });
    }
}
</code></pre>
<h3 data-id="heading-11">3.4 REST API网关实现</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ApiGatewayVerticle</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">AbstractVerticle</span> {
    
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">start</span>() {
        <span class="hljs-selector-tag">Router</span> <span class="hljs-selector-tag">router</span> = <span class="hljs-selector-tag">Router</span><span class="hljs-selector-class">.router</span>(vertx);
        
        <span class="hljs-comment">// 启用CORS</span>
        <span class="hljs-selector-tag">router</span><span class="hljs-selector-class">.route</span>()<span class="hljs-selector-class">.handler</span>(CorsHandler.<span class="hljs-built_in">create</span>(<span class="hljs-string">"*"</span>));
        
        <span class="hljs-comment">// 请求日志中间件</span>
        <span class="hljs-selector-tag">router</span><span class="hljs-selector-class">.route</span>()<span class="hljs-selector-class">.handler</span>(ctx -&gt; {
            <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"Received request: "</span> + ctx.<span class="hljs-built_in">request</span>().<span class="hljs-built_in">method</span>() 
                + <span class="hljs-string">" "</span> + ctx.<span class="hljs-built_in">request</span>().<span class="hljs-built_in">path</span>());
            <span class="hljs-selector-tag">ctx</span><span class="hljs-selector-class">.next</span>();
        });
        
        <span class="hljs-comment">// 数据接收端点</span>
        <span class="hljs-selector-tag">router</span><span class="hljs-selector-class">.post</span>(<span class="hljs-string">"/api/data"</span>)
            <span class="hljs-selector-class">.handler</span>(BodyHandler.<span class="hljs-built_in">create</span>())
            <span class="hljs-selector-class">.handler</span>(<span class="hljs-attribute">this</span>::handleDataIngestion);
        
        <span class="hljs-comment">// 健康检查端点</span>
        <span class="hljs-selector-tag">router</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"/health"</span>)<span class="hljs-selector-class">.handler</span>(ctx -&gt; {
            <span class="hljs-selector-tag">ctx</span><span class="hljs-selector-class">.json</span>(new <span class="hljs-built_in">JsonObject</span>()
                .<span class="hljs-built_in">put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"UP"</span>)
                .<span class="hljs-built_in">put</span>(<span class="hljs-string">"timestamp"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>()));
        });
        
        <span class="hljs-comment">// 启动HTTP服务器</span>
        <span class="hljs-selector-tag">vertx</span><span class="hljs-selector-class">.createHttpServer</span>()
            <span class="hljs-selector-class">.requestHandler</span>(router)
            <span class="hljs-selector-class">.listen</span>(<span class="hljs-number">8080</span>)
            <span class="hljs-selector-class">.onSuccess</span>(server -&gt; {
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"API网关启动在端口 8080"</span>);
            })
            <span class="hljs-selector-class">.onFailure</span>(<span class="hljs-attribute">Throwable</span>::printStackTrace);
    }
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">handleDataIngestion</span>(RoutingContext ctx) {
        <span class="hljs-selector-tag">JsonObject</span> <span class="hljs-selector-tag">data</span> = <span class="hljs-selector-tag">ctx</span><span class="hljs-selector-class">.getBodyAsJson</span>();
        
        <span class="hljs-comment">// 验证数据</span>
        <span class="hljs-selector-tag">if</span> (data == null || !data.<span class="hljs-built_in">containsKey</span>(<span class="hljs-string">"sensorId"</span>)) {
            <span class="hljs-selector-tag">ctx</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-number">400</span>);
            <span class="hljs-selector-tag">return</span>;
        }
        
        <span class="hljs-comment">// 通过事件总线发布数据</span>
        <span class="hljs-selector-tag">vertx</span><span class="hljs-selector-class">.eventBus</span>()<span class="hljs-selector-class">.request</span>(<span class="hljs-string">"data.process"</span>, data, reply -&gt; {
            <span class="hljs-selector-tag">if</span> (reply.<span class="hljs-built_in">succeeded</span>()) {
                <span class="hljs-selector-tag">ctx</span><span class="hljs-selector-class">.json</span>(new <span class="hljs-built_in">JsonObject</span>()
                    .<span class="hljs-built_in">put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"processed"</span>)
                    .<span class="hljs-built_in">put</span>(<span class="hljs-string">"messageId"</span>, reply.<span class="hljs-built_in">result</span>().<span class="hljs-built_in">body</span>()));
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">ctx</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-number">500</span>);
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-12">3.5 数据处理器实现</h3>
<pre><code class="hljs language-scss" lang="scss">public class DataProcessorVerticle extends AbstractVerticle {
    
    private static final int BATCH_SIZE = <span class="hljs-number">1000</span>;
    private List&lt;JsonObject&gt; batchBuffer = new ArrayList&lt;&gt;();
    
    <span class="hljs-keyword">@Override</span>
    public void start() {
        <span class="hljs-comment">// 注册数据处理器</span>
        vertx<span class="hljs-selector-class">.eventBus</span>().&lt;JsonObject&gt;<span class="hljs-built_in">consumer</span>("data.process", message -&gt; {
            JsonObject data = message.body();
            
            <span class="hljs-comment">// 异步处理数据</span>
            <span class="hljs-built_in">processData</span>(data)
                <span class="hljs-selector-class">.onSuccess</span>(processedData -&gt; {
                    // 添加到批处理缓冲区
                    batchBuffer.add(processedData);
                    
                    <span class="hljs-comment">// 达到批处理大小时批量存储</span>
                    if (batchBuffer.size() &gt;= BATCH_SIZE) {
                        <span class="hljs-built_in">flushBatch</span>();
                    }
                    
                    <span class="hljs-comment">// 发送处理完成响应</span>
                    message<span class="hljs-selector-class">.reply</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>());
                    
                    <span class="hljs-comment">// 实时推送到WebSocket客户端</span>
                    vertx<span class="hljs-selector-class">.eventBus</span>()<span class="hljs-selector-class">.publish</span>("data.realtime", processedData);
                })
                <span class="hljs-selector-class">.onFailure</span>(err -&gt; {
                    System.err.println("数据处理失败: " + err.getMessage());
                    message<span class="hljs-selector-class">.fail</span>(<span class="hljs-number">500</span>, err.getMessage());
                });
        });
        
        <span class="hljs-comment">// 定时刷新批处理</span>
        vertx<span class="hljs-selector-class">.setPeriodic</span>(<span class="hljs-number">5000</span>, id -&gt; {
            if (!batchBuffer.isEmpty()) {
                <span class="hljs-built_in">flushBatch</span>();
            }
        });
        
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("数据处理器已启动");
    }
    
    private Future&lt;JsonObject&gt; <span class="hljs-built_in">processData</span>(JsonObject rawData) {
        Promise&lt;JsonObject&gt; promise = Promise<span class="hljs-selector-class">.promise</span>();
        
        <span class="hljs-comment">// 使用工作线程执行CPU密集型处理</span>
        vertx<span class="hljs-selector-class">.executeBlocking</span>(future -&gt; {
            try {
                // 模拟数据处理
                JsonObject processed = rawData.copy();
                processed<span class="hljs-selector-class">.put</span>("processed", true)
                         <span class="hljs-selector-class">.put</span>("timestamp", System.currentTimeMillis())
                         <span class="hljs-selector-class">.put</span>("processedBy", "worker-" + Thread.currentThread()<span class="hljs-selector-class">.getName</span>());
                
                <span class="hljs-comment">// 模拟处理延迟</span>
                Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">10</span>);
                
                future<span class="hljs-selector-class">.complete</span>(processed);
            } catch (Exception e) {
                future<span class="hljs-selector-class">.fail</span>(e);
            }
        }, promise);
        
        return promise<span class="hljs-selector-class">.future</span>();
    }
    
    private void <span class="hljs-built_in">flushBatch</span>() {
        if (batchBuffer.isEmpty()) return;
        
        List&lt;JsonObject&gt; toFlush = new ArrayList&lt;&gt;(batchBuffer);
        batchBuffer<span class="hljs-selector-class">.clear</span>();
        
        <span class="hljs-comment">// 异步存储到数据库</span>
        <span class="hljs-built_in">storeBatch</span>(toFlush)
            <span class="hljs-selector-class">.onSuccess</span>(count -&gt; {
                System.out.println("批量存储成功，记录数: " + count);
            })
            <span class="hljs-selector-class">.onFailure</span>(err -&gt; {
                System.err.println("批量存储失败: " + err.getMessage());
                <span class="hljs-comment">// 重新加入缓冲区</span>
                batchBuffer<span class="hljs-selector-class">.addAll</span>(toFlush);
            });
    }
    
    private Future&lt;Integer&gt; <span class="hljs-built_in">storeBatch</span>(List&lt;JsonObject&gt; batch) {
        <span class="hljs-comment">// 这里可以实现实际的数据库存储逻辑</span>
        <span class="hljs-comment">// 示例中仅模拟异步存储</span>
        Promise&lt;Integer&gt; promise = Promise<span class="hljs-selector-class">.promise</span>();
        vertx<span class="hljs-selector-class">.setTimer</span>(<span class="hljs-number">100</span>, id -&gt; {
            promise.complete(batch.size());
        });
        return promise<span class="hljs-selector-class">.future</span>();
    }
}
</code></pre>
<h3 data-id="heading-13">3.6 WebSocket实时推送服务</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebSocketServerVerticle</span> <span class="hljs-title">extends</span> <span class="hljs-title">AbstractVerticle</span> {
    
    <span class="hljs-keyword">private</span> Set&lt;ServerWebSocket&gt; clients = ConcurrentHashMap.newKeySet();
    
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span>()</span> {
        <span class="hljs-comment">// 创建WebSocket服务器</span>
        vertx.createHttpServer()
            .webSocketHandler(<span class="hljs-keyword">this</span>::handleWebSocket)
            .listen(<span class="hljs-number">8081</span>)
            .onSuccess(server -&gt; {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"WebSocket服务器启动在端口 8081"</span>);
            });
        
        <span class="hljs-comment">// 订阅实时数据</span>
        vertx.eventBus().&lt;JsonObject&gt;consumer(<span class="hljs-string">"data.realtime"</span>, message -&gt; {
            JsonObject data = message.body();
            broadcastToClients(data);
        });
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleWebSocket</span>(<span class="hljs-params">ServerWebSocket ws</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"新的WebSocket连接: "</span> + ws.remoteAddress());
        clients.<span class="hljs-keyword">add</span>(ws);
        
        ws.textMessageHandler(message -&gt; {
            <span class="hljs-comment">// 处理客户端消息</span>
            handleClientMessage(ws, message);
        });
        
        ws.closeHandler(v -&gt; {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"WebSocket连接关闭"</span>);
            clients.<span class="hljs-keyword">remove</span>(ws);
        });
        
        ws.exceptionHandler(err -&gt; {
            System.err.println(<span class="hljs-string">"WebSocket错误: "</span> + err.getMessage());
            clients.<span class="hljs-keyword">remove</span>(ws);
        });
        
        <span class="hljs-comment">// 发送欢迎消息</span>
        ws.writeTextMessage(<span class="hljs-keyword">new</span> JsonObject()
            .put(<span class="hljs-string">"type"</span>, <span class="hljs-string">"welcome"</span>)
            .put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"连接成功"</span>)
            .encode());
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">broadcastToClients</span>(<span class="hljs-params">JsonObject data</span>)</span> {
        String json = data.encode();
        clients.forEach(client -&gt; {
            <span class="hljs-keyword">if</span> (!client.isClosed()) {
                client.writeTextMessage(json);
            }
        });
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleClientMessage</span>(<span class="hljs-params">ServerWebSocket ws, String message</span>)</span> {
        <span class="hljs-comment">// 处理客户端消息</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"收到客户端消息: "</span> + message);
    }
}
</code></pre>
<h2 data-id="heading-14">四、Vert.x高级特性实战</h2>
<h3 data-id="heading-15">4.1 使用响应式编程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveDataProcessor</span> {
    
    <span class="hljs-keyword">public</span> Single&lt;JsonObject&gt; processReactive(JsonObject <span class="hljs-keyword">data</span>) {
        <span class="hljs-keyword">return</span> Single.create(emitter -&gt; {
            vertx.eventBus().&lt;JsonObject&gt;request(<span class="hljs-string">"data.process"</span>, <span class="hljs-keyword">data</span>)
                .onSuccess(reply -&gt; {
                    JsonObject result = reply.body();
                    result.put(<span class="hljs-string">"reactiveProcessed"</span>, <span class="hljs-literal">true</span>);
                    emitter.onSuccess(result);
                })
                .onFailure(emitter::onError);
        });
    }
    
    <span class="hljs-keyword">public</span> Flowable&lt;JsonObject&gt; processStream(List&lt;JsonObject&gt; dataStream) {
        <span class="hljs-keyword">return</span> Flowable.fromIterable(dataStream)
            .flatMapSingle(<span class="hljs-keyword">this</span>::processReactive)
            .buffer(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 每100条批处理</span>
            .flatMap(Flowable::fromIterable);
    }
}
</code></pre>
<h3 data-id="heading-16">4.2 集群模式配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClusterApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ClusterManager</span> <span class="hljs-variable">mgr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HazelcastClusterManager</span>();
        
        <span class="hljs-type">VertxOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VertxOptions</span>()
            .setClusterManager(mgr)
            .setClustered(<span class="hljs-literal">true</span>);
        
        Vertx.clusteredVertx(options, res -&gt; {
            <span class="hljs-keyword">if</span> (res.succeeded()) {
                <span class="hljs-type">Vertx</span> <span class="hljs-variable">vertx</span> <span class="hljs-operator">=</span> res.result();
                <span class="hljs-comment">// 在集群中部署verticle</span>
                vertx.deployVerticle(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiGatewayVerticle</span>());
                System.out.println(<span class="hljs-string">"应用已加入集群"</span>);
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"集群启动失败: "</span> + res.cause().getMessage());
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-17">4.3 配置管理</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigAwareVerticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractVerticle</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    public void start() {
        <span class="hljs-comment">// 从文件加载配置</span>
        <span class="hljs-type">ConfigStoreOptions</span> fileStore = <span class="hljs-keyword">new</span> <span class="hljs-type">ConfigStoreOptions</span>()
            .setType(<span class="hljs-string">"file"</span>)
            .setConfig(<span class="hljs-keyword">new</span> <span class="hljs-type">JsonObject</span>().put(<span class="hljs-string">"path"</span>, <span class="hljs-string">"config.json"</span>));
        
        <span class="hljs-type">ConfigRetriever</span> retriever = <span class="hljs-type">ConfigRetriever</span>.create(vertx,
            <span class="hljs-keyword">new</span> <span class="hljs-type">ConfigRetrieverOptions</span>().addStore(fileStore));
        
        <span class="hljs-comment">// 监听配置变更</span>
        retriever.listen(change -&gt; {
            <span class="hljs-type">JsonObject</span> newConfig = change.getNewConfiguration();
            <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"配置已更新: "</span> + newConfig.encodePrettily());
            handleConfigUpdate(newConfig);
        });
        
        <span class="hljs-comment">// 获取初始配置</span>
        retriever.getConfig().onSuccess(config -&gt; {
            <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"应用启动配置: "</span> + config.encodePrettily());
            initialize(config);
        });
    }
}
</code></pre>
<h2 data-id="heading-18">五、性能优化与最佳实践</h2>
<h3 data-id="heading-19">5.1 性能优化策略</h3>
<ol>
<li>
<p><strong>适当调整线程池大小</strong></p>
<pre><code class="hljs language-scss" lang="scss">VertxOptions options = new <span class="hljs-built_in">VertxOptions</span>()
    <span class="hljs-selector-class">.setEventLoopPoolSize</span>(Runtime.getRuntime()<span class="hljs-selector-class">.availableProcessors</span>() * <span class="hljs-number">2</span>)
    <span class="hljs-selector-class">.setWorkerPoolSize</span>(<span class="hljs-number">20</span>)
    <span class="hljs-selector-class">.setInternalBlockingPoolSize</span>(<span class="hljs-number">20</span>);
</code></pre>
</li>
<li>
<p><strong>使用Future/Promise避免回调地狱</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> Future&lt;JsonObject&gt; processDataPipeline(JsonObject input) {
    <span class="hljs-keyword">return</span> validateInput(input)
        .compose(<span class="hljs-keyword">this</span>::enrichData)
        .compose(<span class="hljs-keyword">this</span>::transformData)
        .compose(<span class="hljs-keyword">this</span>::persistData);
}
</code></pre>
</li>
<li>
<p><strong>合理使用executeBlocking</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">vertx.<span class="hljs-built_in">executeBlocking</span>(promise -&gt; {
    <span class="hljs-comment">// 执行阻塞操作</span>
    <span class="hljs-type">String</span> result = <span class="hljs-built_in">blockingOperation</span>();
    promise.<span class="hljs-built_in">complete</span>(result);
}, <span class="hljs-literal">false</span>, res -&gt; {  <span class="hljs-comment">// ordered参数设为false可并行执行</span>
    <span class="hljs-comment">// 处理结果</span>
});
</code></pre>
</li>
</ol>
<h3 data-id="heading-20">5.2 监控与度量</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MetricsVerticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractVerticle</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void start() {
        <span class="hljs-comment">// 启用Micrometer指标</span>
        <span class="hljs-type">MicrometerMetricsOptions</span> options = <span class="hljs-keyword">new</span> <span class="hljs-type">MicrometerMetricsOptions</span>()
            .setPrometheusOptions(<span class="hljs-keyword">new</span> <span class="hljs-type">VertxPrometheusOptions</span>().setEnabled(<span class="hljs-literal">true</span>))
            .setEnabled(<span class="hljs-literal">true</span>);
        
        <span class="hljs-type">Vertx</span> vertxWithMetrics = <span class="hljs-type">Vertx</span>.vertx(
            <span class="hljs-keyword">new</span> <span class="hljs-type">VertxOptions</span>().setMetricsOptions(options));
        
        <span class="hljs-comment">// 自定义指标</span>
        <span class="hljs-type">MeterRegistry</span> registry = <span class="hljs-type">BackendRegistries</span>.getDefaultNow();
        <span class="hljs-type">Counter</span> requestCounter = <span class="hljs-type">Counter</span>.builder(<span class="hljs-string">"http.requests"</span>)
            .description(<span class="hljs-string">"HTTP请求数量"</span>)
            .register(registry);
        
        <span class="hljs-comment">// 在路由中使用</span>
        router.route().handler(ctx -&gt; {
            requestCounter.increment();
            ctx.next();
        });
    }
}
</code></pre>
<h2 data-id="heading-21">六、部署与运维</h2>
<h3 data-id="heading-22">6.1 Docker容器化部署</h3>
<pre><code class="hljs language-bash" lang="bash">FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY target/vertx-app-1.0.0-fat.jar app.jar
EXPOSE 8080 8081
ENTRYPOINT [<span class="hljs-string">"java"</span>, <span class="hljs-string">"-jar"</span>, <span class="hljs-string">"app.jar"</span>]
</code></pre>
<h3 data-id="heading-23">6.2 Kubernetes部署配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">vertx-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">vertx-app</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">vertx-app</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">vertx-app</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">vertx-app:1.0.0</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8081</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
</code></pre>
<h2 data-id="heading-24">七、总结</h2>
<p>Vert.x作为一个现代化的响应式框架，通过事件驱动和非阻塞I/O的设计，为构建高性能、可扩展的分布式系统提供了强大支持。本文通过完整的实战项目展示了：</p>
<ol>
<li><strong>Vert.x核心概念的实际应用</strong>：包括Verticle、Event Bus、异步编程模型</li>
<li><strong>完整项目架构</strong>：从API网关到实时数据处理再到WebSocket推送</li>
<li><strong>最佳实践</strong>：错误处理、配置管理、性能优化</li>
<li><strong>生产就绪特性</strong>：集群、监控、容器化部署</li>
</ol>
<p>Vert.x的学习曲线可能较陡峭，特别是对于习惯传统同步编程的开发者。但一旦掌握其异步编程范式，就能构建出高性能、可扩展的现代化应用系统。建议从简单的HTTP服务开始，逐步深入到事件总线、集群等高级特性，最终构建完整的分布式系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vert.x与传统Spring框架在性能、并发处理方面有哪些差异]]></title>    <link>https://juejin.cn/post/7588095884069961728</link>    <guid>https://juejin.cn/post/7588095884069961728</guid>    <pubDate>2025-12-27T14:21:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884069961728" data-draft-id="7588004601393807394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vert.x与传统Spring框架在性能、并发处理方面有哪些差异"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T14:21:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vert.x与传统Spring框架在性能、并发处理方面有哪些差异
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:21:45.000Z" title="Sat Dec 27 2025 14:21:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Vert.x 和 Spring 框架在性能与并发处理上的差异，根源在于它们截然不同的设计哲学和架构模型。下面这个表格汇总了它们的核心区别，方便你快速把握要点。</p>



































<table><thead><tr><th>特性维度</th><th>Vert.x</th><th>Spring (传统阻塞模式)</th></tr></thead><tbody><tr><td><strong>核心架构</strong></td><td>事件驱动、非阻塞 I/O (基于 Netty)</td><td>基于 Servlet 容器（如 Tomcat）的线程池模型</td></tr><tr><td><strong>并发模型</strong></td><td><strong>事件循环 (Event Loop)</strong> ，少量线程处理海量连接</td><td><strong>“一个请求一个线程” (Thread-per-Request)</strong></td></tr><tr><td><strong>性能特点</strong></td><td><strong>高吞吐、低延迟</strong>，擅长处理<strong>大量并发长连接</strong></td><td>在复杂业务逻辑和<strong>CPU密集型</strong>任务中表现稳健</td></tr><tr><td><strong>资源消耗</strong></td><td>轻量级，资源占用少，扩展性强</td><td>线程池和组件堆栈带来相对较高的内存开销</td></tr><tr><td><strong>编程范式</strong></td><td>异步回调、Future/Promise、响应式编程</td><td>同步阻塞，更符合直觉，易于调试</td></tr></tbody></table>
<h3 data-id="heading-0">🔧 理解差异的根源</h3>
<p>表格中的对比源于两者根本的设计哲学不同：</p>
<ul>
<li><strong>Vert.x 的事件循环模型</strong>：Vert.x 的核心是一个或多个 <strong>事件循环线程</strong>。它不会为每个请求创建新线程，而是将I/O操作（如网络请求、数据库查询）注册为事件。当操作在后台完成时，回调函数被触发。这使得它能够用<strong>极少的线程支撑极高的并发连接</strong>，非常适合I/O密集型应用。</li>
<li><strong>Spring 的线程池模型</strong>：传统 Spring MVC 默认使用同步模型。每个请求都会占用一个独立的线程。如果请求因等待数据库响应而阻塞，这个线程就被占用，无法处理其他请求。当并发请求数超过线程池大小时，新请求必须排队等待，性能会急剧下降。</li>
</ul>
<h3 data-id="heading-1">📊 关键性能数据参考</h3>
<p>具体的性能测试数据能让你有更直观的感受：</p>
<ul>
<li><strong>REST API 请求处理</strong>：在基准测试中，Vert.x 的请求处理速率被证实可以达到 <strong>Spring Boot 的 2 倍</strong>。另一项测试甚至显示其性能可达 Spring 的 <strong>9 倍</strong>。</li>
<li><strong>高并发混合查询</strong>：在 TechEmpower 性能基准测试中，Vert.x 的综合排名非常靠前，展现出极强的并发处理能力。</li>
<li><strong>实际应用测试</strong>：有开发者通过模拟高并发场景发现，采用 Vert.x 架构的系统吞吐量可达传统 Spring Boot 架构的 <strong>3.3 倍</strong>。</li>
</ul>
<h3 data-id="heading-2">🚀 Spring 的响应式方案：Spring WebFlux</h3>
<p>值得注意的是，Spring 框架也提供了响应式解决方案来应对高并发场景，即 <strong>Spring WebFlux</strong>。它同样基于非阻塞模型，底层也可以使用 Netty，旨在与 Vert.x 竞争。但在实际应用中，如果项目依赖了众多同步的第三方库（如传统的 JPA 或 MyBatis），整个调用链可能无法保持非阻塞，从而无法完全发挥 WebFlux 的威力。</p>
<h3 data-id="heading-3">💡 如何根据场景做选择</h3>
<p>了解了这些差异和数据后，你的技术选型思路就会清晰很多：</p>
<ul>
<li>
<p><strong>优先选择 Vert.x 的场景</strong>：</p>
<ul>
<li><strong>高并发、低延迟的实时服务</strong>：如实时聊天、消息推送、游戏服务器、物联网（IoT）数据采集等。</li>
<li><strong>API 网关或代理服务</strong>：需要高效路由大量网络请求的场景。</li>
<li><strong>团队熟悉响应式编程范式</strong>，且技术栈能保证全链路异步（例如使用异步数据库驱动）。</li>
</ul>
</li>
<li>
<p><strong>优先选择 Spring Boot 的场景</strong>：</p>
<ul>
<li><strong>传统的企业级应用或需要快速交付的业务系统</strong>：Spring Boot 的开箱即用、极佳的开发效率和强大的生态是巨大优势。</li>
<li><strong>数据密集型应用</strong>：涉及复杂事务管理、多种数据源集成，需要强大 ORM（如 Hibernate）支持的场景。</li>
<li><strong>需要与庞大的 Spring 生态系统（如 Spring Security, Spring Cloud, Spring Data）深度集成</strong>的项目。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vert.x与Spring框架：开发效率与团队学习成本深度对比]]></title>    <link>https://juejin.cn/post/7588095884069994496</link>    <guid>https://juejin.cn/post/7588095884069994496</guid>    <pubDate>2025-12-27T14:26:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884069994496" data-draft-id="7588004601393823778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vert.x与Spring框架：开发效率与团队学习成本深度对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T14:26:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vert.x与Spring框架：开发效率与团队学习成本深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:26:03.000Z" title="Sat Dec 27 2025 14:26:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：选择框架的双重考量</h2>
<p>在技术选型过程中，性能数据只是决策的一个方面，而<strong>开发效率</strong>和<strong>团队学习成本</strong>往往对项目成功有着更直接的影响。Vert.x和Spring代表了两种截然不同的开发哲学，这些差异直接体现在开发体验和上手难度上。本文将深入分析这两大框架在开发效率和学习成本方面的具体差异，帮助团队做出更合理的技术决策。</p>
<h2 data-id="heading-1">一、编程模型对比：异步与同步的本质差异</h2>
<h3 data-id="heading-2">1.1 Vert.x的事件驱动模型</h3>
<p>Vert.x采用<strong>异步非阻塞</strong>架构，基于事件循环（Event Loop）机制。这种模型要求开发者采用回调、Promise或响应式编程风格，代码执行流程不再是传统的顺序执行。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// Vert.x的异步编程示例</span>
vertx.<span class="hljs-title function_ invoke__">createHttpServer</span>()
    .<span class="hljs-title function_ invoke__">requestHandler</span>(req <span class="hljs-punctuation">-&gt;</span> {
        <span class="hljs-comment">// 异步处理请求</span>
        <span class="hljs-title function_ invoke__">someAsyncOperation</span>(result <span class="hljs-punctuation">-&gt;</span> {
            req.<span class="hljs-title function_ invoke__">response</span>().<span class="hljs-title function_ invoke__">end</span>(<span class="hljs-string">"Result: "</span> + result);
        });
    })
    .<span class="hljs-title function_ invoke__">listen</span>(<span class="hljs-number">8080</span>);
</code></pre>
<p>这种模型的优势在于<strong>高并发性能</strong>，但需要开发者转变思维方式，从"命令式"转向"响应式"。</p>
<h3 data-id="heading-3">1.2 Spring的传统同步模型</h3>
<p>Spring Boot默认采用熟悉的<strong>同步阻塞式</strong>编程模型，更符合人类的线性思维习惯。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// Spring的同步编程示例</span>
<span class="hljs-variable">@RestController</span>
public class UserController {
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/users/{id}"</span>)
    public User <span class="hljs-built_in">getUser</span>(<span class="hljs-variable">@PathVariable</span> String id) {
        <span class="hljs-comment">// 同步阻塞直到返回结果</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.findById</span>(id);
    }
}
</code></pre>
<p>这种模型虽然在高并发场景下资源效率较低，但<strong>逻辑清晰</strong>，易于理解和调试。</p>
<h2 data-id="heading-4">二、开发效率综合分析</h2>
<h3 data-id="heading-5">2.1 Spring Boot的开发效率优势</h3>
<p>Spring Boot在开发效率方面具有显著优势，主要体现在：</p>
<ul>
<li><strong>开箱即用</strong>：通过自动配置减少了大量的样板代码</li>
<li><strong>强大的生态系统</strong>：集成了Spring全家桶（Spring Data、Security、Cloud等），提供了企业级应用所需的全套解决方案</li>
<li><strong>丰富的第三方集成</strong>：几乎所有常见需求都有成熟的Spring集成方案</li>
</ul>
<p>这些特性使得Spring Boot特别适合<strong>快速迭代</strong>的传统企业级应用开发。</p>
<h3 data-id="heading-6">2.2 Vert.x的开发效率特点</h3>
<p>Vert.x的开发效率特点更为复杂：</p>
<ul>
<li><strong>初期学习曲线较陡</strong>：异步编程模型需要适应期</li>
<li><strong>模块化设计</strong>：Vert.x的组件为松耦合，便于定制和扩展</li>
<li><strong>轻量级</strong>：核心库小巧灵活，无需复杂配置即可运行</li>
</ul>
<p>一旦团队掌握了异步编程范式，Vert.x在构建<strong>轻量级微服务</strong>和<strong>云原生应用</strong>时能提供高效的开发体验。</p>
<h2 data-id="heading-7">三、学习成本深度解析</h2>
<h3 data-id="heading-8">3.1 Spring框架的学习曲线</h3>
<p>Spring虽然功能强大，但其<strong>概念复杂度高</strong>，学习曲线陡峭。新手需要掌握依赖注入、面向切面编程、各种配置方式等概念。特别是在微服务场景下，Spring需要引入大量组件（如注册中心、配置中心等），增加了学习成本。</p>
<p>不过，Spring拥有<strong>庞大的社区支持</strong>和<strong>丰富的学习资源</strong>，这在一定程度上降低了学习难度。</p>
<h3 data-id="heading-9">3.2 Vert.x的学习挑战</h3>
<p>Vert.x诞生于云计算时代，设计上更加简洁，概念精简。但它面临的挑战包括：</p>
<ul>
<li><strong>异步编程思维</strong>：需要适应回调地狱、异步流控制等概念</li>
<li><strong>调试困难</strong>：异步调用链使问题定位和调试更加复杂</li>
<li><strong>生态相对较小</strong>：虽然Vert.x生态已覆盖Web开发、数据访问、微服务等领域，但相比Spring仍不够成熟</li>
</ul>
<h2 data-id="heading-10">四、团队适配性考量</h2>
<h3 data-id="heading-11">4.1 团队技术背景的影响</h3>
<p>团队现有技术栈对框架选择有重要影响：</p>
<ul>
<li><strong>传统Java团队</strong>：熟悉Spring的团队继续使用Spring通常效率更高</li>
<li><strong>全栈或Node.js背景团队</strong>：对事件驱动模型有经验的团队更容易上手Vert.x</li>
<li><strong>微服务专门团队</strong>：Vert.x的轻量性和高性能使其在微服务架构中具有优势</li>
</ul>
<h3 data-id="heading-12">4.2 项目类型与规模考量</h3>
<ul>
<li><strong>大型复杂企业应用</strong>：Spring的全面功能和稳定性更适合</li>
<li><strong>高并发、低延迟应用</strong>：Vert.x的性能优势明显</li>
<li><strong>初创项目或原型开发</strong>：Spring Boot的快速开发能力有优势</li>
</ul>
<h2 data-id="heading-13">五、实际应用中的选择策略</h2>
<h3 data-id="heading-14">5.1 混合使用模式</h3>
<p>在实际项目中，可以考虑<strong>结合使用Vert.x和Spring</strong>，取长补短：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Spring Boot处理业务逻辑，Vert.x处理高并发I/O操作</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">BusinessService</span> businessService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleHighConcurrency</span>(<span class="hljs-params"/>) {
        vertx.<span class="hljs-title function_">executeBlocking</span>(promise -&gt; {
            <span class="hljs-comment">// 使用Vert.x处理高并发I/O</span>
            <span class="hljs-title class_">Object</span> result = businessService.<span class="hljs-title function_">process</span>();
            promise.<span class="hljs-title function_">complete</span>(result);
        }, result -&gt; {
            <span class="hljs-comment">// 处理结果</span>
        });
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 渐进式采用策略</h3>
<p>对于考虑转向Vert.x的团队，可以采用渐进式策略：</p>
<ol>
<li><strong>试点项目</strong>：选择非核心但高并发的服务作为试点</li>
<li><strong>团队培训</strong>：逐步培养团队的异步编程能力</li>
<li><strong>混合架构</strong>：在现有Spring应用中逐步引入Vert.x组件</li>
</ol>
<h2 data-id="heading-16">六、未来发展趋势</h2>
<h3 data-id="heading-17">6.1 响应式编程的兴起</h3>
<p>随着云原生和微服务架构的普及，响应式编程理念正在主流化。Spring也推出了<strong>WebFlux</strong>作为响应式解决方案，这反映了行业向异步非阻塞模式发展的趋势。</p>
<h3 data-id="heading-18">6.2 共存而非取代</h3>
<p>Vert.x和Spring在未来可能会是<strong>共存而非取代</strong>的关系。Spring在企业级应用和传统Web开发中依然有强大的生命力，而Vert.x则在需要高并发和低延迟的场景中表现出色。</p>
<h2 data-id="heading-19">结论：平衡性能与开发效率</h2>
<p>Vert.x和Spring在开发效率和学习成本方面的差异，反映了两种不同的设计哲学和适用场景。选择框架时，团队需要综合考虑：</p>
<ol>
<li><strong>项目需求和性能要求</strong>：高并发场景优先考虑Vert.x，复杂企业级应用倾向Spring</li>
<li><strong>团队技术背景</strong>：团队对异步编程的接受度和学习能力</li>
<li><strong>项目周期和资源</strong>：快速迭代项目可能更适合Spring，性能敏感型项目可考虑Vert.x</li>
<li><strong>长期维护考量</strong>：框架的稳定性、生态成熟度和社区支持</li>
</ol>
<p>最终，没有绝对的优劣，只有<strong>适合特定场景和团队的选择</strong>。明智的做法是根据具体需求，可能甚至结合两者优势，构建最适合的技术栈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain学习：Memory实战——让你的大模型记住你]]></title>    <link>https://juejin.cn/post/7588084804093460518</link>    <guid>https://juejin.cn/post/7588084804093460518</guid>    <pubDate>2025-12-27T14:35:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588084804093460518" data-draft-id="7587779957675327539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain学习：Memory实战——让你的大模型记住你"/> <meta itemprop="keywords" content="前端,LangChain,JavaScript"/> <meta itemprop="datePublished" content="2025-12-27T14:35:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain学习：Memory实战——让你的大模型记住你
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:35:01.000Z" title="Sat Dec 27 2025 14:35:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在研究怎么让大模型真正“记住”用户说过的话，而不是每次对话都像失忆了一样从头来过今天就把我的学习笔记、代码示例、踩坑心得全部整合起来，写成这篇超详细的实战指南。</p>
<p>这篇文章的目标很简单：让你看完就能上手，在自己的项目里快速加上“记忆”功能。咱们从最基础的无状态调用开始，一步步深入到多轮对话、Token 控制、多用户场景、持久化存储，最后再聊聊生产环境的最佳实践。</p>
<h2 data-id="heading-1">一、为什么 LLM 默认没有记忆？</h2>
<p>所有大模型的 API 调用（OpenAI、DeepSeek、Claude、Gemini 等）本质上都是<strong>无状态</strong>的。每次请求都是独立的，模型完全不知道你上一次说了什么。</p>
<p>来看一个最简单的例子：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;


<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
});

<span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"我叫华高俊，喜欢打和平精英"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res1.<span class="hljs-property">content</span>);  <span class="hljs-comment">// 正常回复</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'///////'</span>)
<span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"我叫什么名字？"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res2.<span class="hljs-property">content</span>);  <span class="hljs-comment">// 模型：？？？我不知道啊...</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d212d55d5c5b4b22aa7a1bfcfd8948c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767450901&amp;x-signature=RHthXGfUjqMrzaPn7tlBwDlNwNc%3D" alt="image.png" loading="lazy"/></p>
<p>第二次问名字，模型直接懵了。因为两次调用之间没有任何关联。</p>
<p>要让模型有记忆，最原始的办法就是手动维护一个消息列表，每次调用都把历史带上：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">let</span> messages = [
  { <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"我叫华高俊，喜欢打和平精英"</span> },
  { <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"好的，我记住了！"</span> },
  { <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"我叫什么名字？"</span> }
];

<span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(messages);
</code></pre>
<p>短期看没问题，但对话轮数一多，这个列表就会像滚雪球一样越来越大，导致：</p>
<ul>
<li>Token 消耗暴涨，成本高</li>
<li>容易超出模型上下文窗口（比如 128k token 上限）</li>
<li>Prompt 结构容易写乱</li>
</ul>
<p>LangChain 的 Memory 模块就是为了优雅地解决这个问题而生的。</p>
<h2 data-id="heading-2">二、Memory 的核心：RunnableWithMessageHistory</h2>
<p>在现代 LangChain JS（基于 LCEL 架构）里，实现记忆最推荐的方式是使用 RunnableWithMessageHistory。它能自动完成：</p>
<ol>
<li>根据会话 ID 加载历史消息</li>
<li>把历史注入到 Prompt 的 {history} 占位符</li>
<li>调用模型</li>
<li>把本次用户输入和模型回复自动保存回历史</li>
</ol>
<p>核心代码长这样：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/prompts"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/chat_history"</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个有记忆的助手，用中文友好回复。"</span>],
  [<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{history}"</span>],  <span class="hljs-comment">// 历史消息注入点</span>
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>],         <span class="hljs-comment">// 当前用户输入</span>
]);

<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(model);

<span class="hljs-comment">// 多用户存储（生产必备）</span>
<span class="hljs-keyword">const</span> messageHistories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;string, <span class="hljs-title class_">InMemoryChatMessageHistory</span>&gt;();

<span class="hljs-keyword">const</span> chainWithHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>({
  <span class="hljs-attr">runnable</span>: chain,
  <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-keyword">async</span> (sessionId) =&gt; {
    <span class="hljs-keyword">if</span> (!messageHistories.<span class="hljs-title function_">has</span>(sessionId)) {
      messageHistories.<span class="hljs-title function_">set</span>(sessionId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>());
    }
    <span class="hljs-keyword">return</span> messageHistories.<span class="hljs-title function_">get</span>(sessionId)!;
  },
  <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">"input"</span>,     <span class="hljs-comment">// 输入对象中的键名</span>
  <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">"history"</span>, <span class="hljs-comment">// prompt 中的占位符键名</span>
});
</code></pre>
<p>调用方式：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">await</span> chainWithHistory.<span class="hljs-title function_">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">"我叫华高俊，喜欢打和平精英"</span> },
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"user-001"</span> } }
);

<span class="hljs-keyword">await</span> chainWithHistory.<span class="hljs-title function_">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">"我是？"</span> },
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"user-001"</span> } }  <span class="hljs-comment">// 相同 sessionId 才有记忆</span>
);
</code></pre>
<p>第二次调用时，模型就能正确回答“华高俊”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dbb5c30e39443bd939070866a4a9370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767450901&amp;x-signature=PUl01aucZJ7IwahBOZGymWHk2Q4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">三、完整调用流程深度拆解</h2>
<p>很多新手（包括曾经的我）看到代码能跑，但不清楚内部到底是怎么工作的。下面把一次 invoke 的完整流程拆开来说：</p>
<ol>
<li>
<p><strong>接收输入和 sessionId</strong> 你调用 chainWithHistory.invoke({ input: "..." }, { configurable: { sessionId: "xxx" } })</p>
</li>
<li>
<p><strong>获取对应会话的历史实例</strong> 调用你提供的 getMessageHistory("xxx")，返回一个 BaseChatMessageHistory 实例（比如 InMemoryChatMessageHistory）</p>
</li>
<li>
<p><strong>读取历史消息</strong> 自动执行 await history.getMessages()，得到所有之前的消息数组</p>
</li>
<li>
<p><strong>构造完整输入对象</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{
  <span class="hljs-attr">history</span>: [所有旧消息],
  <span class="hljs-attr">input</span>: <span class="hljs-string">"当前用户输入"</span>
}
</code></pre>
</li>
<li>
<p><strong>渲染 Prompt</strong></p>
<ul>
<li>{history} 被替换成完整的历史消息列表</li>
<li>{input} 被替换成本次用户输入（作为 HumanMessage）</li>
<li>最终形成一个完整的 messages 数组传给模型</li>
</ul>
</li>
<li>
<p><strong>调用模型得到回复</strong></p>
</li>
<li>
<p><strong>自动保存本次对话</strong>（关键！） RunnableWithMessageHistory 会自动：</p>
<ul>
<li>history.addMessage(new HumanMessage(本次输入))</li>
<li>history.addMessage(new AIMessage(模型回复))</li>
</ul>
</li>
<li>
<p><strong>返回模型回复</strong></p>
</li>
</ol>
<p>整个过程除了提供 getMessageHistory 外，其他全是自动的。这就是为什么说它“优雅”的原因。</p>
<h2 data-id="heading-4">四、关键组件逐个详解</h2>
<h3 data-id="heading-5">1. ChatPromptTemplate.fromMessages</h3>
<p>这是构建聊天 Prompt 的首选方式，写法直观：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"系统提示"</span>],
  [<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{history}"</span>],  <span class="hljs-comment">// 必须和 historyMessagesKey 一致</span>
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>],          <span class="hljs-comment">// 必须和 inputMessagesKey 一致</span>
]);
</code></pre>
<p>支持的 role 有：system、human、ai、placeholder。还可以插入 few-shot 示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">[
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"你是谁？"</span>],
  [<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我是华高俊的私人助手。"</span>],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>]
]
</code></pre>
<h3 data-id="heading-6">2. InMemoryChatMessageHistory</h3>
<p>最简单的内存存储类，内部就是一个 messages: BaseMessage[] 数组。</p>
<ul>
<li>优点：简单、快速、适合本地测试和调试</li>
<li>缺点：进程重启就丢失、不支持多实例共享</li>
</ul>
<p>构造函数支持预加载：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>([
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">"旧消息"</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">AIMessage</span>(<span class="hljs-string">"旧回复"</span>)
]);
</code></pre>
<p>手动操作方法：</p>
<ul>
<li>await history.getMessages() 获取</li>
<li>await history.addMessage(msg) 添加</li>
<li>await history.clear() 清空（比如用户点“新对话”）</li>
</ul>
<h3 data-id="heading-7">3. sessionId 的重要性</h3>
<p>如果你像这样写：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-attr">getMessageHistory</span>: <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>()
</code></pre>
<p>那所有用户都会共享同一个历史！上线后用户A看到用户B的聊天记录，灾难。</p>
<p>必须用 Map/Set 或数据库按 sessionId（通常是用户ID + 设备ID）隔离。</p>
<h2 data-id="heading-8">五、Token 爆炸怎么办？高级 Memory 策略</h2>
<p>全量保存历史（Buffer 风格）简单，但对话长了 Token 很容易爆。LangChain 提供了多种控制策略：</p>
<ol>
<li>
<p><strong>窗口记忆（Window）</strong> 只保留最近 N 轮对话。实现方式：在 getMessageHistory 中 slice：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> all = <span class="hljs-keyword">await</span> baseHistory.<span class="hljs-title function_">getMessages</span>();
<span class="hljs-keyword">return</span> all.<span class="hljs-title function_">slice</span>(-maxTurns * <span class="hljs-number">2</span>);  <span class="hljs-comment">// 每轮两句</span>
</code></pre>
</li>
<li>
<p><strong>摘要记忆（Summary）</strong> 用 LLM 把旧对话压缩成摘要，保留关键信息不丢失细节。</p>
</li>
<li>
<p><strong>混合摘要缓冲（Summary Buffer）</strong> 最近几轮保留原文，旧的用摘要替换。最推荐的生产方案。</p>
<p>LangChain JS 有现成实现（旧版 Memory 类）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConversationSummaryBufferMemory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/memory"</span>;

<span class="hljs-keyword">const</span> memory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversationSummaryBufferMemory</span>({
  <span class="hljs-attr">llm</span>: model,
  <span class="hljs-attr">maxTokenLimit</span>: <span class="hljs-number">1000</span>,  <span class="hljs-comment">// 超过就摘要旧部分</span>
});
</code></pre>
<p>新版 LCEL 也可以通过自定义 getMessageHistory 实现类似逻辑。</p>
</li>
</ol>
<h2 data-id="heading-9">六、生产环境必备：持久化存储</h2>
<p>InMemory 只能用于开发测试，上线必须换持久化实现：</p>






























<table><thead><tr><th>存储</th><th>包</th><th>场景</th></tr></thead><tbody><tr><td>Upstash Redis</td><td>@langchain/upstash</td><td>Serverless（如 Vercel）首选</td></tr><tr><td>Redis</td><td>@langchain/redis</td><td>高性能传统服务</td></tr><tr><td>MongoDB</td><td>@langchain/mongodb</td><td>需要复杂查询</td></tr><tr><td>Postgres</td><td>@langchain/community</td><td>已有 SQL 生态</td></tr></tbody></table>
<p>替换方式只需改 getMessageHistory 返回对应类即可，其他代码不动。</p>
<h2 data-id="heading-10">七、实际项目中的最佳实践</h2>
<ol>
<li><strong>多用户必用 sessionId</strong>，建议格式：user:<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>I</mi><mi>d</mi></mrow><mo>:</mo><mi>c</mi><mi>h</mi><mi>a</mi><mi>t</mi><mo>:</mo></mrow><annotation encoding="application/x-tex">{userId}:chat:</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord"><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">ser</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">d</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">ha</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:</span></span></span></span></span>{chatId}</li>
<li><strong>提供“清除对话”功能</strong>：手动调用 history.clear()</li>
<li><strong>监控 Token 使用</strong>：用 LangSmith 或自己统计，及时触发摘要</li>
<li><strong>结合 RAG</strong>：Memory 存对话历史，VectorStore 存知识库，职责分开</li>
<li><strong>错误处理</strong>：模型调用失败时不要保存本次消息，避免脏数据</li>
<li><strong>预加载历史</strong>：用户重新打开旧对话时，从数据库加载后 addMessages</li>
</ol>
<h2 data-id="heading-11">八、总结</h2>
<p>LangChain 的 Memory 模块本质上就是帮你自动化了“读历史 → 发模型 → 存新消息”这个循环。核心只有三件事：</p>
<ul>
<li>用 ChatPromptTemplate.fromMessages 写好带 {history} 和 {input} 的模板</li>
<li>用 RunnableWithMessageHistory 包装 chain</li>
<li>提供可靠的 getMessageHistory（开发用 InMemory，上线用 Redis 等）</li>
</ul>
<p>掌握了这套流程，你就能轻松做出各种有记忆的聊天应用：客服机器人、个人助手、写作搭档、角色扮演……</p>
<p>从我最初的“手动滚雪球”消息列表，到现在几行代码就搞定多用户持久化记忆，LangChain 确实省了很多心。希望这篇干货能帮你在项目里快速落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[传统工具调用太痛苦？LangChain 一键打通 LLM 与真实世界]]></title>    <link>https://juejin.cn/post/7588191506606080006</link>    <guid>https://juejin.cn/post/7588191506606080006</guid>    <pubDate>2025-12-27T14:57:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588191506606080006" data-draft-id="7588149079417126966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="传统工具调用太痛苦？LangChain 一键打通 LLM 与真实世界"/> <meta itemprop="keywords" content="LangChain,LLM,前端"/> <meta itemprop="datePublished" content="2025-12-27T14:57:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            传统工具调用太痛苦？LangChain 一键打通 LLM 与真实世界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:57:50.000Z" title="Sat Dec 27 2025 14:57:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型想“干活”，但得靠你动手：LangChain 工具调用详解</h2>
<blockquote>
<p><strong>大语言模型能告诉你“该查北京天气”，却无法自己打开 API。它只负责“想”，你负责“做”——而 LangChain 让这个协作变得优雅又安全。</strong></p>
</blockquote>
<p>在构建智能应用时，我们常希望大模型不仅能聊天，还能<strong>执行真实操作</strong>：查天气、算数学、查数据库……<br/>
但 LLM 本身只是一个<strong>文本生成器</strong>，没有访问外部系统的能力。于是，“工具调用”（Tool Calling）成为连接“想法”与“行动”的桥梁。</p>
<p>本文将先简要对比<strong>传统手写工具调度</strong>的繁琐之处，再深入解析你代码中 <strong>LangChain 的工具调用实现</strong>，揭示其如何通过声明式设计大幅降低复杂度。</p>
<hr/>
<h3 data-id="heading-1">🧱 传统方式：手写调度的复杂性</h3>
<p>在没有框架支持的时代，开发者需要<strong>手动完成从意图识别到函数调用的全过程</strong>——就像一个既当指挥官、又当翻译、还得亲自跑腿的全能杂工。</p>
<h4 data-id="heading-2">1. 分散无规范的工具定义</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 工具函数各自独立定义</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getWeather</span>(<span class="hljs-params">city</span>) {
  <span class="hljs-comment">// ...查天气逻辑</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p>问题显而易见：</p>
<ul>
<li>没有统一接口；</li>
<li>参数格式随意（有的用字符串，有的用数字）；</li>
<li>更关键的是：<strong>模型根本不知道这些函数存在</strong>。</li>
</ul>
<blockquote>
<p>💡 这就像你有一堆专业工具（扳手、电钻、温度计），但没贴标签、也没说明书。哪怕请来一位顶级工程师（大模型），他也只能干瞪眼：“我不知道你能做什么。”</p>
</blockquote>
<hr/>
<h4 data-id="heading-3">2. 繁琐的工具说明（OpenAI 原生 JSON）</h4>
<p>为了让模型知道工具的存在，你不得不手写冗长的 JSON Schema：</p>
<pre><code class="hljs language-js" lang="js">tools = [
  {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
    <span class="hljs-string">"function"</span>: {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"get-weather"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取指定城市的当前天气"</span>,
      <span class="hljs-string">"parameters"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
          <span class="hljs-string">"location"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称，如'北京'"</span>
          }
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"location"</span>]
      }
    }
  }
]
</code></pre>
<p>如果你有 10 个工具，就得重复写 10 次类似的结构。<br/>
不仅容易出错，还难以维护——<strong>修改一个参数，可能要同时改 JSON 和函数实现两处地方</strong>。</p>
<blockquote>
<p>🛠️ 这就像给每个工具单独手写一张纸质说明书，再钉在墙上。新员工（模型）来了，得对着墙一条条读，还可能看错行。</p>
</blockquote>
<hr/>
<h4 data-id="heading-4">3. 脆弱的调用逻辑：硬编码 + 正则解析</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleQuery</span>(<span class="hljs-params">query</span>) {
  <span class="hljs-keyword">if</span> (query.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"天气"</span>)) {
    <span class="hljs-keyword">const</span> city = query.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(北京|上海|广州)/</span>)?.[<span class="hljs-number">0</span>] || <span class="hljs-string">"未知"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getWeather</span>(city);
  } 
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (query.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"加"</span>) || query.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"+"</span>)) {
    <span class="hljs-keyword">const</span> nums = query.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\d+/g</span>);
    <span class="hljs-keyword">if</span> (nums &amp;&amp; nums.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">add</span>(<span class="hljs-built_in">parseInt</span>(nums[<span class="hljs-number">0</span>]), <span class="hljs-built_in">parseInt</span>(nums[<span class="hljs-number">1</span>]));
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">"我不懂这个问题"</span>;
}
</code></pre>
<p>这种写法的问题在于：</p>
<ul>
<li><strong>意图识别靠关键词</strong>：用户说“北京今天热得像30度”，可能被误判为加法；</li>
<li><strong>参数提取靠正则</strong>：自然语言千变万化，规则很快失效；</li>
<li><strong>每加一个工具，就要改主函数</strong>：违反“开闭原则”，代码越来越臃肿。</li>
</ul>
<blockquote>
<p>💡 <strong>这就像你雇了一位诺贝尔奖得主当战略顾问，却逼他背电话簿、写正则表达式、自己跑气象站——完全浪费了他的智慧。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🤖 LangChain 的解法：让模型决策，你来执行</h3>
<p>LangChain 提供了一套<strong>声明式工具抽象</strong>，把“工具说明书”和“工具本身”合二为一，形成一个<strong>自描述、可验证、即插即用的模块</strong>。</p>
<p>核心思想非常清晰：</p>
<blockquote>
<p><strong>你告诉模型有哪些工具可用 → 模型自主决定是否调用 → 你收到调用请求后执行真实函数。</strong></p>
</blockquote>
<p>下面结合你的代码，一步步拆解这场“人机协作”。</p>
<hr/>
<h4 data-id="heading-6">🔧 第一步：用 <code>tool()</code> 定义结构化工具 —— “带智能标签的工具箱”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 天气查询工具</span>
<span class="hljs-keyword">const</span> weathertool = <span class="hljs-title function_">tool</span>(
  <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-keyword">const</span> weather = fakeWeatherDB[city];
    <span class="hljs-keyword">if</span> (!weather) <span class="hljs-keyword">return</span> <span class="hljs-string">`城市<span class="hljs-subst">${city}</span>的天气信息不存在`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">`当前<span class="hljs-subst">${city}</span>的天气是<span class="hljs-subst">${weather.temp}</span>, <span class="hljs-subst">${weather.condition}</span>, 风力<span class="hljs-subst">${weather.wind}</span>`</span>;
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"查询指定城市的今日天气情况"</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"要查询天气的城市名称"</span>)
    })
  }
);

<span class="hljs-comment">// 加法工具</span>
<span class="hljs-keyword">const</span> addTool = <span class="hljs-title function_">tool</span>(
  <span class="hljs-keyword">async</span> ({ a, b }) =&gt; <span class="hljs-title class_">String</span>(a + b),
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"add"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"计算两个数字的和"</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">a</span>: z.<span class="hljs-title function_">number</span>(),
      <span class="hljs-attr">b</span>: z.<span class="hljs-title function_">number</span>()
    })
  }
);
</code></pre>
<h5 data-id="heading-7">这里做了三件事：</h5>
<ol>
<li>
<p><strong>封装执行逻辑</strong><br/>
函数接收一个对象参数（如 <code>{ city }</code>），通过解构获取字段。<br/>
返回值必须是 <strong>字符串</strong>（LLM 工具协议要求）。</p>
</li>
<li>
<p><strong>提供元数据</strong></p>
<ul>
<li><code>name</code>：工具唯一标识（模型调用时使用）</li>
<li><code>description</code>：自然语言描述，帮助模型理解用途</li>
</ul>
</li>
<li>
<p><strong>定义参数规范（Zod Schema）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>() })
</code></pre>
<ul>
<li>相当于给模型一份“任务单填写指南”</li>
<li>LangChain 会自动将其转为 JSON Schema 注入模型</li>
<li>运行时还可校验参数合法性（类型安全）</li>
</ul>
</li>
</ol>
<blockquote>
<p>✅ <strong>优势</strong>：工具定义一体化，自描述、可验证、易测试。<br/>
就像给每个工具贴上<strong>智能 RFID 标签</strong>：一扫就知道名字、用途、怎么用。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">🔗 第二步：用 <code>.bindTools()</code> 绑定工具集 —— “向顾问展示工具墙”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">modelName</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
}).<span class="hljs-title function_">bindTools</span>([addTool, weathertool]);
</code></pre>
<p>这行代码的作用是：<br/>
<strong>将工具列表“注册”给模型</strong>，相当于带模型参观你的“工具墙”：</p>
<blockquote>
<p>“看，这里有两件装备：</p>
<ul>
<li><strong>加法计算器</strong>：输入两个数字，输出它们的和；</li>
<li><strong>天气雷达</strong>：输入城市名，返回实时天气。<br/>
遇到相关问题，你可以直接‘点名’调用它们。”</li>
</ul>
</blockquote>
<p>此时，模型在推理时会参考这些工具的 <code>name</code>、<code>description</code> 和 <code>parameters</code>，<strong>自主判断是否需要调用、调用哪个、传什么参数</strong>。</p>
<hr/>
<h4 data-id="heading-9">📬 第三步：模型返回 <code>tool_calls</code> —— “写下任务单，但不执行”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"北京的天气怎么样？"</span>);
</code></pre>
<p><strong>关键点</strong>：模型不会直接回答天气，而是返回：</p>
<pre><code class="hljs language-js" lang="js">res.<span class="hljs-property">tool_calls</span> = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
    <span class="hljs-attr">args</span>: { <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> },  <span class="hljs-comment">// ← 已是解析好的对象！</span>
    <span class="hljs-attr">id</span>: <span class="hljs-string">"call_abc123"</span>
  }
]
</code></pre>
<h5 data-id="heading-10">为什么这样设计？</h5>
<ul>
<li><strong>安全隔离</strong>：模型运行在沙盒中，不能直接调用你的函数（防止任意代码执行）。</li>
<li><strong>可控执行</strong>：你可以在调用前加权限检查、日志、重试等逻辑。</li>
<li><strong>灵活响应</strong>：你可以选择不执行、模拟响应（测试）、或并行调用多个工具。</li>
</ul>
<blockquote>
<p>⚠️ <strong>重要</strong>：<code>tool_calls</code> 只是模型的“调用意图”，<strong>不代表工具已被执行</strong>。<br/>
就像 CEO 在会议室说：“查一下北京天气。”<br/>
但他不会亲自打开电脑——他只是<strong>发出指令</strong>。真正的执行，要靠你这个“执行助理”去完成。</p>
</blockquote>
<hr/>
<h4 data-id="heading-11">🛠️ 第四步：你手动“兑现”调用 —— “执行任务，带回结果”</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// const res = await model.invoke("3+5 等于多少？");</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"北京的天气怎么样？"</span>);
<span class="hljs-comment">// 可选链 es6 新增 有利于代码的简洁和优雅</span>
<span class="hljs-keyword">if</span>(res.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span>){
    <span class="hljs-comment">//console.log(res.tool_calls[0]);</span>
    <span class="hljs-keyword">if</span>(res.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>].<span class="hljs-property">name</span>===<span class="hljs-string">"add"</span>){
       <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> addTool.<span class="hljs-title function_">invoke</span>(res.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>].<span class="hljs-property">args</span>);
       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终结果:"</span>,result);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(res.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>].<span class="hljs-property">name</span>===<span class="hljs-string">"get_weather"</span>){
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> weathertool.<span class="hljs-title function_">invoke</span>(res.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>].<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终结果:"</span>,result);
    }
</code></pre>
<p>这里发生了什么？</p>
<ul>
<li><code>call.args</code> 是一个<strong>普通 JavaScript 对象</strong>（如 <code>{ city: "北京" }</code>），已由 LangChain 自动解析（无需 <code>JSON.parse</code>！）。</li>
<li>工具大模型返回的tool_calls确定大模型决定调用的工具名称来手动的执行这个工具函数</li>
<li><code>tool_calls.agrs</code>中存储的就是工具对应的需要的参数,在调用工具时将参数传入执行</li>
<li>函数执行后返回字符串，你可直接展示，或再传回模型生成更自然的回答（Agent 模式）。</li>
</ul>
<blockquote>
<p>💡 <strong>这就是“人机协作”的精髓</strong>：<br/>
模型是“大脑”，负责思考与决策；<br/>
你的代码是“手脚”，负责感知与行动。<br/>
而 LangChain，就是那根连接神经与肌肉的<strong>反射弧</strong>。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b222a6c1b5e45c48ff2a7047da254f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767452270&amp;x-signature=KHgLxUYtxejxX15lIMvnVuibsqU%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-12">🌟 总结：LangChain 如何简化工具调用</h3>



































<table><thead><tr><th>环节</th><th>传统方式</th><th>LangChain</th></tr></thead><tbody><tr><td><strong>工具定义</strong></td><td>分散函数，无描述</td><td><code>tool()</code> 一体化封装（函数+描述+schema）</td></tr><tr><td><strong>意图识别</strong></td><td>手写关键词/NLP</td><td>模型自主决策</td></tr><tr><td><strong>参数提取</strong></td><td>正则/规则解析</td><td>模型生成结构化参数，框架自动解析</td></tr><tr><td><strong>调用执行</strong></td><td>硬编码 <code>if/else</code></td><td>根据 <code>tool_calls</code> 动态分发</td></tr><tr><td><strong>扩展新工具</strong></td><td>修改主逻辑</td><td>只需定义新 <code>tool</code> 并加入数组</td></tr></tbody></table>
<blockquote>
<p><strong>LangChain 不是替你写业务逻辑，而是替你写“调度逻辑”。</strong><br/>
你只需专注工具本身的实现，剩下的交给框架。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">✅ 结语</h3>
<p>大模型是“大脑”，你的代码是“手脚”。<br/>
LangChain 提供的 <code>tool()</code> 机制，正是那根连接“思想”与“行动”的神经通路。</p>
<p>理解 <code>tool_calls</code> 只是“提议”而非“执行”，是掌握智能体（Agent）开发的第一步。<br/>
而你，就是那个让 AI 从“纸上谈兵”走向“真枪实干”的关键执行者。</p>
<blockquote>
<p><strong>别让天才顾问只动嘴——给他一套好工具，再配一个靠谱的执行者，奇迹才会发生。</strong></p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PostCSS完全指南：功能/配置/插件/SourceMap/AST/插件开发/自定义语法]]></title>    <link>https://juejin.cn/post/7588146449005756452</link>    <guid>https://juejin.cn/post/7588146449005756452</guid>    <pubDate>2025-12-27T15:02:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005756452" data-draft-id="7588152122186891318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PostCSS完全指南：功能/配置/插件/SourceMap/AST/插件开发/自定义语法"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2025-12-27T15:02:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漂流瓶jz"/> <meta itemprop="url" content="https://juejin.cn/user/3694779980078877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PostCSS完全指南：功能/配置/插件/SourceMap/AST/插件开发/自定义语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3694779980078877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漂流瓶jz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T15:02:13.000Z" title="Sat Dec 27 2025 15:02:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PostCSS是什么</h2>
<p>PostCSS是一个转义CSS代码的工具，它的输入为CSS文件，输出也是CSS文件。它首先把CSS转换为抽象语法树AST，再使用插件对语法树进行修改，最后生成新的CSS代码。它的作用非常像JavaScript中的Babel。</p>
<p>在CSS领域，存在感更强的是SCSS和Less，它们是CSS的预处理器，扩充了CSS的语法和功能，可以编写复用性更强的代码。预处理器经过编译后，是CSS代码。而PostCSS正如它的名字，最常被用做CSS的后处理器，做一些兼容性功能。例如添加浏览器引擎的前缀，转换CSS代码以兼容不支持的浏览器等。预处理器和后处理器的关系类似于这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2194490e5c1548fa83eb6434608d5d01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryC5rWB55O2ano=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767452532&amp;x-signature=P8GqL%2FuHKKz1v0tAYFojI%2FLijOY%3D" alt="postcss-1.png" loading="lazy"/></p>
<p>对比JavaScript的生态位，SCSS和Less像TypeScript扩充语法，PostCSS像Babel转义兼容语法。但PostCSS允许我们自定义语法规则，因此用作预处理器，甚至只用PostCSS也是可以的。</p>
<h2 data-id="heading-1">PostCSS使用</h2>
<p>这里我们以最常用的插件Autoprefixer举例，这是一个根据兼容性设置添加浏览器引擎前缀的插件。首先创建<code>css/index.css</code>，作为我们要转义的CSS代码。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">::placeholder</span> {
  <span class="hljs-attribute">color</span>: gray;
}

<span class="hljs-selector-class">.image</span> {
  <span class="hljs-attribute">width</span>: stretch;
}
</code></pre>
<h3 data-id="heading-2">API方式</h3>
<p>首先试一下JavaScriptAPI的方式使用PostCSS。执行下面的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);

<span class="hljs-keyword">const</span> originData = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"./css/index.css"</span>, <span class="hljs-string">"utf-8"</span>);

<span class="hljs-title function_">postcss</span>([autoprefixer])
  .<span class="hljs-title function_">process</span>(originData, { <span class="hljs-attr">from</span>: <span class="hljs-string">"css/index.css"</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">"out.css"</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">css</span>);
    fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">'out.css'</span>, res.<span class="hljs-property">css</span>);
  });
</code></pre>
<p>我们读取CSS文件为字符串，放入PostCSS中进行转义，最后手动写入输出文件。虽然PostCSS要求指定from和to表示输入输出的文件路径，但实际上它们是给SourceMap用的，并不会真正帮我们读取写入（但还是必填）。最后生成的结果如下：</p>
<pre><code class="hljs language-css" lang="css">::-moz-placeholder {
  <span class="hljs-attribute">color</span>: gray;
}

<span class="hljs-selector-pseudo">::placeholder</span> {
  <span class="hljs-attribute">color</span>: gray;
}

<span class="hljs-selector-class">.image</span> {
  <span class="hljs-attribute">width</span>: -webkit-fill-available;
  <span class="hljs-attribute">width</span>: -moz-available;
  <span class="hljs-attribute">width</span>: stretch;
}
</code></pre>
<p>可以看到生成的CSS代码中的部分属性添加了浏览器前缀了。具体哪些前缀被添加，要根据Browserslist浏览器兼容范围确定。（在后面介绍插件的部分会提到）</p>
<h3 data-id="heading-3">命令行方式</h3>
<p>使用PostCSS CLI可以支持以命令行方式转义CSS文件。首先需要安装postcss-cli依赖，然后命令行执行：</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 单个文件</span>
postcss css/index.css -u autoprefixer -o out.css --no-map
<span class="hljs-comment"># 目录</span>
postcss css -u autoprefixer -d output --no-map
</code></pre>
<p>PostCSS CLI支持转义单个文件或者目录，目录会转义其中的每个文件。其中-u表示传入的插件名，-o表示输出的文件名，-d表示输出目录，--no-map表示不输出SourceMap。经过转义后，输出结果与上面API方式一致。如果更多配置，则需要使用PostCSS配置文件，我们在后面单独介绍。</p>
<h2 data-id="heading-4">Webpack中使用PostCSS</h2>
<p>在Webpack中使用PostCSS，主要依靠postcss-loader。</p>
<h3 data-id="heading-5">创建Webpack项目</h3>
<p>我们先创建一个Webpack项目，可以打包CSS，但不包含PostCSS。</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 创建项目</span>
npm init -y
<span class="hljs-comment"># 安装依赖</span>
npm add webpack webpack-cli style-loader css-loader
</code></pre>
<p>创建src/index.css，内容为即为前面的CSS代码。再创建src/index.js，引入CSS文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">"./index.css"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>然后再创建Webapck配置文件webpack.config.js：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">"production"</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.js"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"main.js"</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>],
      },
    ],
  },
};
</code></pre>
<p>其中最关键的是style-loader和css-loader，这是引入CSS文件的必要loader。loader是从后向前链式调用，先css-loader，再style-loader。然后在package.json中增加命令：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack"</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>最后执行<code>npm run build</code>,结果输出到dist/main.js中。结果较长，这里只截取包含CSS的部分。可以看到，CSS被打包进JavaScript代码中，其内容未变。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34e6f405564945d4acc5d386090dc5ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryC5rWB55O2ano=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767452532&amp;x-signature=A11hk2OegBvhOjhE91n7ZHpV1TE%3D" alt="postcss-2.png" loading="lazy"/></p>
<h3 data-id="heading-6">引入postcss-loader</h3>
<p>安装三个相关依赖：postcss postcss-loader autoprefixer。然后修改webpack.config.js，引入PostCSS：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">"production"</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.js"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"main.js"</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">"style-loader"</span>,
          <span class="hljs-string">"css-loader"</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">"postcss-loader"</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">postcssOptions</span>: {
                <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'autoprefixer'</span>],
              },
            },
          },
        ],
      },
    ],
  },
};
</code></pre>
<p>注意其中重点是新增加了postcss-loader，它的位置在数组的最后。意味着CSS文件先经过它处理，然后再给css-loader和style-loader。postcssOptions选项中可以配置插件。postcss-loader也支持使用配置文件postcss.config.js。</p>
<p>重新执行<code>npm run build</code>后，查看结果发现，除了原有代码外，还增加了浏览器前缀，说明代码成功被PostCSS转义了。(下图为了方便用两行展示CSS字符串，实际为一行)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca735ee80134468a1118dd454721498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryC5rWB55O2ano=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767452532&amp;x-signature=2N2Q5tW4qve3Z0yiMFRnat17l%2Fs%3D" alt="postcss-3.png" loading="lazy"/></p>
<h2 data-id="heading-7">配置文件postcss.config.js</h2>
<p>在命令行或Webapck方式使用PostCSS时，都支持postcss.config.js作为配置文件。但是这两种配置文件的居然是不一样的，部分场景互相不兼容。因此这里分别介绍两种方式的配置文件。</p>
<h3 data-id="heading-8">命令行方式配置文件</h3>
<h4 data-id="heading-9">引入插件</h4>
<p>命令行仅支持直接引入插件对象的方式。例如前面我们列举的例子，使用配置文件内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [autoprefixer],
};
</code></pre>
<p>然后执行的命令进行修改，输出效果一致。</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 原命令</span>
postcss css/index.css -u autoprefixer -o out.css --no-map
<span class="hljs-comment"># 新命令</span>
postcss css/index.css -o out.css
</code></pre>
<h4 data-id="heading-10">插件参数</h4>
<p>为了描述插件参数，我们换一个postcss-color-gray插件。配置文件内容如下，先不使用插件参数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> postcssColorGray = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-color-gray"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [postcssColorGray],
};
</code></pre>
<p>然后使用插件语法，重新写一段CSS代码，转义后的代码也在下面列出：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">gray</span>(<span class="hljs-number">0</span> / <span class="hljs-number">90%</span>);
}

<span class="hljs-comment">/* 转义后CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.9</span>);
}
</code></pre>
<p>可以看到插件生效了。然后我们修改配置文件，增加插件参数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> postcssColorGray = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-color-gray"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">postcssColorGray</span>({ <span class="hljs-attr">preserve</span>: <span class="hljs-literal">true</span> })],
};
</code></pre>
<p>重新执行命令行，转义后的代码发生了变化，保留了gray函数，参数生效了。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 转义后CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.9</span>);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">gray</span>(<span class="hljs-number">0</span> / <span class="hljs-number">90%</span>);
}
</code></pre>
<h4 data-id="heading-11">配置文件名称和格式</h4>
<p>虽然PostCSS CLI中仅仅提到了配置文件名称为postcss.config.js，但我参考隔壁postcss-loader的文件名对PostCSS CLI进行了尝试，发现居然是支持的！这里我们描述一下。</p>
<p>首先是JavaScript类的配置文件，包括.postcssrc.js, .postcssrc.cjs, postcss.config.cjs等，PostCSS CLI是支持的，文件内容和执行效果都与postcss.config.js一致。</p>
<p>然后是JSON格式的配置文件，例如.postcssrc, .postcssrc.json等，PostCSS CLI也是支持的，但是由于插件必须直接引入插件对象，因此JSON格式实际上并不能用。它的报错和在postcss.config.js中直接写插件名称字符串的报错是一致的，因此判定文件本身被读取了，但不支持插件。这里举例下配置文件内容，以.postcssrc.json为例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"postcss-color-gray"</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"preserve"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后报错内容如下，可以看到是在读插件过程中的错误。使用yaml类的文件格式，报错也是一致的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee681bd3a96146b8b67467c81096001e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryC5rWB55O2ano=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767452532&amp;x-signature=bVVEay2GZom23jRhzZvsemrUFgc%3D" alt="postcss-4.png" loading="lazy"/></p>
<h4 data-id="heading-12">读取上下文</h4>
<p>配置文件还可以导出一个函数，函数可以接收上下文入参，最终返回配置对象。这里我们给出配置文件的示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> postcssColorGray = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-color-gray"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title function_">postcssColorGray</span>(ctx.<span class="hljs-property">env</span> === <span class="hljs-string">"development"</span> ? { <span class="hljs-attr">preserve</span>: <span class="hljs-literal">true</span> } : {}),
    ],
  };
};

<span class="hljs-comment">/* 输出结果
{
  cwd: 'E:\\testProj\\postcss-test\\apitest',
  env: undefined,
  options: {
    map: { inline: true },
    parser: undefined,
    syntax: undefined,
    stringifier: undefined
  },
  file: {
    dirname: 'E:\\testProj\\postcss-test\\apitest\\css',
    basename: 'index.css',
    extname: '.css'
  }
}
*/</span>
</code></pre>
<p>通过上面代码可以看到，可以根据上下文入参调整配置对象的内容。这里简单说明上下文入参含义：</p>
<ul>
<li>env: 为process.env.NODE_ENV的值</li>
<li>file: 文件名相关参数
<ul>
<li>dirname: 文件路径</li>
<li>basename: 文件名</li>
<li>extname: 文件扩展名</li>
</ul>
</li>
<li>options: 命令行中输入的选项</li>
</ul>
<h3 data-id="heading-13">Webpack方式配置文件</h3>
<h4 data-id="heading-14">引入插件</h4>
<p>Webpack方式不仅支持直接引入插件对象的方式，还支持直接写插件名称字符串。两种方式这里都列举下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 直接引入插件对象</span>
<span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [autoprefixer],
};

<span class="hljs-comment">// 直接写插件名称字符串</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'autoprefixer'</span>],
};
</code></pre>
<p>然后删除Webapck配置中的插件配置，效果一致。Webapack中配置可以是这样（仅展示相关片段）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">module</span>: {
  <span class="hljs-attr">rules</span>: [
    {
      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
      <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, <span class="hljs-string">"postcss-loader"</span>],
    },
  ],
},
</code></pre>
<h4 data-id="heading-15">插件参数</h4>
<p>这里还使用前面命令行中插件参数一节里面的postcss-color-gray插件和CSS代码。这里尝试用两种插件配置方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 直接引入插件对象</span>
<span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-keyword">const</span> postcssColorGray = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-color-gray"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [autoprefixer, <span class="hljs-title function_">postcssColorGray</span>({ <span class="hljs-attr">preserve</span>: <span class="hljs-literal">true</span> })],
};

<span class="hljs-comment">// 直接写插件名称字符串</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'autoprefixer'</span>, [<span class="hljs-string">'postcss-color-gray'</span>, { <span class="hljs-attr">preserve</span>: <span class="hljs-literal">true</span> }]],
};
</code></pre>
<p>查看结果，两种方式都能正常接收参数，结果与命令行方式一致。这里还举例了传入多个插件的方式。</p>
<h4 data-id="heading-16">配置文件名称和格式</h4>
<p>Webpack方式的配置文件，支持多种配置文件格式和文件名，包括.postcssrc, .postcssrc.json, .postcssrc.yaml, .postcssrc.js, postcss.config.cjs等等，具体可以看postcss-loader的文档。其中JSON和YAML类的格式仅支持直接写插件名称字符串，这里示例下配置文件的格式，首先是JSON格式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"autoprefixer"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">[</span><span class="hljs-string">"postcss-color-gray"</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"preserve"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后是YAML格式，实际内容一致：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">plugins:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">autoprefixer</span>
  <span class="hljs-bullet">-</span> <span class="hljs-bullet">-</span> <span class="hljs-string">postcss-color-gray</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">preserve:</span> <span class="hljs-literal">true</span>
</code></pre>
<h4 data-id="heading-17">读取上下文</h4>
<p>Webpack方式的配置文件也可以导出一个函数，函数可以接收上下文入参，最终返回配置对象。这里我们给出配置文件的示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ctx);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [[<span class="hljs-string">"postcss-color-gray"</span>, ctx.<span class="hljs-property">mode</span> === <span class="hljs-string">"development"</span> ? { <span class="hljs-attr">preserve</span>: <span class="hljs-literal">true</span> } : {}]],
  };
};

<span class="hljs-comment">/* 输出结果
{
  mode: 'production',
  file: 'E:\\testProj\\postcss-test\\webpacktest\\src\\index.css',
  webpackLoaderContext: {} // 内容很多，这里省略
  env: 'production',
  options: { plugins: [ 'autoprefixer' ] }
*/</span>
</code></pre>
<p>这里的输出与命令行方式类似，但不完全一样，这里简单说明上下文入参含义：</p>
<ul>
<li>env和mode: 为process.env.NODE_ENV的值</li>
<li>file: 文件路径</li>
<li>options: Webpack配置中的postcssOptions选项</li>
<li>webpackLoaderContext:  Webpack loader的上下文，内容很多</li>
</ul>
<h3 data-id="heading-18">其余参数</h3>
<p>这些配置文件都可以接收PostCSS的API中ProcessOptions的参数，除了from和to。这里列举几个：</p>
<ul>
<li>parser 传入解析AST的方法</li>
<li>stringifier 传入从AST生成字符串的方法</li>
<li>syntax 传入AST解析和生成的方法，相当于parser + stringifier</li>
<li>map SourceMap选项</li>
</ul>
<p>这些参数的具体用法会在后面介绍到。</p>
<h3 data-id="heading-19">不同点总结</h3>
<p>从上面命令行方式与Webpack方式配置文件的描述，我们可以明确两种方式配置文件的不同点：</p>
<ul>
<li>最主要的不同是引入插件方式的不同：命令行仅支持直接引入插件对象的方式，Webpack方式还支持直接写插件名称字符串。这导致了插件传参方式和配置文件格式的限制。</li>
<li>其次是读取上下文参数的不同。这是由于两者运行方式不同，命令行与Webpack方式可以接收到的配置数据不同，因此上下文参数不一样。</li>
</ul>
<h2 data-id="heading-20">各类插件简介</h2>
<p>PostCSS中提供了非常多的插件，作用各不相同，这里列举几个进行介绍：</p>
<h3 data-id="heading-21">Autoprefixer</h3>
<p>Autoprefixer是PostCSS中最知名的插件，它的作用是根据浏览器兼容性，添加浏览器引擎前缀。浏览器引擎前缀是浏览器为了给实验性或者浏览器引擎独有的非标准CSS属性添加的前缀，这样这个实验属性就不会影响到其它浏览器，开发者也能识别这是针对某种浏览器做的优化。常见的前缀有：</p>
<ul>
<li>-webkit-: 基于WebKit内核的浏览器，例如Chrome、Safari等</li>
<li>-moz-: 火狐浏览器</li>
<li>-o-: 旧版(WebKit之前的)Opera浏览器</li>
<li>-ms-: IE 浏览器</li>
</ul>
<p>这里举一个例子，transition属性用上面的浏览器引擎前缀可以写为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> {
  <span class="hljs-comment">/* 原属性 */</span>
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">4s</span> ease;
  <span class="hljs-comment">/* 增加浏览器引擎前缀 */</span>
  -webkit-<span class="hljs-attribute">transition</span>: all <span class="hljs-number">4s</span> ease;
  -moz-<span class="hljs-attribute">transition</span>: all <span class="hljs-number">4s</span> ease;
  -ms-<span class="hljs-attribute">transition</span>: all <span class="hljs-number">4s</span> ease;
  -o-<span class="hljs-attribute">transition</span>: all <span class="hljs-number">4s</span> ease;
}
</code></pre>
<p>现在添加浏览器引擎前缀经常是为了兼容性，为了在旧版本浏览器也可以使用较新的CSS特性。而Autoprefixer插件就可以帮我们做到这件事。这个插件没有浏览器兼容配置，而是读取工程的Browserslist配置。这里举个例子。首先给出我们要转义的CSS代码：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">width</span>: stretch;
}
</code></pre>
<p>通过在package.json中设置不同的Browserslist配置，我们能得到不同的代码生成结果，这对应的是不同浏览器版本的兼容性。兼容的版本越多，那么需要处理的就越多。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 配置 "browserslist": "&gt; 1%" 的生成结果 */</span> 
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">width</span>: -webkit-fill-available;
  <span class="hljs-attribute">width</span>: stretch;
}

<span class="hljs-comment">/* 配置 "browserslist": "&gt; 0.01%" 的生成结果 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">display</span>: -moz-box;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">width</span>: -webkit-fill-available;
  <span class="hljs-attribute">width</span>: -moz-available;
  <span class="hljs-attribute">width</span>: stretch;
}
</code></pre>
<h3 data-id="heading-22">postcss-custom-properties</h3>
<p>postcss-custom-properties是一个增加CSS变量兼容性的插件，对于不支持的CSS var的浏览器提供后备值。这里来举例试一下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--jzb, red);
}

<span class="hljs-comment">/* 生成CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
  <span class="hljs-attribute">color</span>: red;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--jzb, red);
}
</code></pre>
<p>通过上面例子可以看到，如果提供了CSS var的后备值，那么插件将会生成一个不带CSS var的版本。如果不支持的浏览器读取到不带CSS var的版本，可以正常展示；支持的浏览器则使用var的版本覆盖前一个不支持的属性值。这样实现了CSS var的浏览器兼容性处理。如果我们没有提供后备值，则不会生成兼容性代码。</p>
<p>但是如果在同一个文件中提供了CSS变量的值，那么即使var函数中没提供后备值，也可以生成兼容性代码。我们看一下例子：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--jza</span>: blue;
}
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--jzb);
}

<span class="hljs-comment">/* 生成CSS代码 */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--jza</span>: blue;
}
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: blue;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--jzb);
}
</code></pre>
<p>可以看到例子中--jza提供了变量值，因此生成了兼容性代码；jzb没有则不会生成。变量值必须与使用变量的代码在同一个文件中才有效。</p>
<h3 data-id="heading-23">postcss-global-data</h3>
<p>在前面postcss-custom-properties插件中我们看到，只有在同一个文件中提供了CSS变量值，才能生成兼容性代码。但是工程中的全局变量与使用位置一般不会在一个文件内，这会导致postcss-custom-properties插件无法识别。而postcss-global-data就可以解决这个问题。</p>
<p>postcss-global-data插件允许我们提供一些全局CSS文件，作为每个被编译文件的附加数据使用。但这些全局文件的编译结果会在输出前被移除，因此不会使每个编译后文件的代码体积增加。我们来看一下例子，首先是PostCSS配置文件, 注意postcss-global-data插件必须在前：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> postcssCustomProperties = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-custom-properties"</span>);
<span class="hljs-keyword">const</span> postcssGlobalData = <span class="hljs-built_in">require</span>(<span class="hljs-string">"@csstools/postcss-global-data"</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title function_">postcssGlobalData</span>({
        <span class="hljs-attr">files</span>: [<span class="hljs-string">"./global.css"</span>],
      }),
      postcssCustomProperties,
    ],
  };
};
</code></pre>
<p>然后是要编译的文件index.css和全局CSS文件global.css：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* global.css */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--jza</span>: blue;
}

<span class="hljs-comment">/* index.css */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
}
</code></pre>
<p>最后我们看下编译的结果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 未使用postcss-global-data插件 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
}

<span class="hljs-comment">/* 已使用postcss-global-data插件 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: blue;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza);
}
</code></pre>
<p>可以看到在使用postcss-global-data插件的情况下，生成代码中增加了兼容性代码，读取了全局CSS文件中的变量值。但是全局CSS文件global.css中的CSS代码却没有包含进来。</p>
<h3 data-id="heading-24">cssnano</h3>
<p>cssnano是一个代码压缩工具，将CSS代码进行语义化压缩。与gzip等纯压缩工具的不一样的是，它会根据语义对代码本身进行改动，例如去掉注释，去掉重复属性，合并选择器等等。这里我们举例试试：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">color</span>: red;
  <span class="hljs-comment">/* 我是注释 */</span>
  <span class="hljs-attribute">color</span>: red;
}
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-comment">/* 生成CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span>{<span class="hljs-attribute">color</span>:red;<span class="hljs-attribute">width</span>:<span class="hljs-number">20px</span>}
</code></pre>
<p>可以看到，同样的选择器被合并，同样的属性值被合并了，注释和中间的换行符空格都去掉了。cssnano还支持预设或者插件，这里就不描述了。</p>
<h2 data-id="heading-25">PostCSS兼容性插件</h2>
<h3 data-id="heading-26">使用postcss-preset-env</h3>
<p>前面介绍了几个PostCSS的插件，但有一个插件却留到了这一节介绍：postcss-preset-env。类似与Babel中的@babel/preset-env预设，postcss-preset-env中包含了很多PostCSS浏览器兼容性的插件。它会读取我们配置的浏览器兼容版本，根据CSSDB上面的特性列表以及我们代码使用了哪些新特性，选择应用哪些插件，从而在浏览器不支持某些CSS新特性的情况下，允许使用新特性。</p>
<p>首先接入插件，由于postcss-preset-env是做兼容性处理的，因此需要放在其它插件的后面，让兼容性插件最后处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> postcssPresetEnv = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-preset-env"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// 其他插件</span>
    <span class="hljs-title function_">postcssPresetEnv</span>({ <span class="hljs-comment">/* 插件参数 */</span> }),
  ],
};
</code></pre>
<p>postcss-preset-env插件也是读取工程中的Browserslist配置。这里我们提供一段CSS源代码，让postcss-preset-env插件在不同浏览器配置下编译试试。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: stretch;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#01020380</span>;
}

<span class="hljs-comment">/* 转义后CSS代码 "browserslist": "&gt; 1%" */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: -webkit-fill-available;
  <span class="hljs-attribute">width</span>: stretch;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#01020380</span>;
}

<span class="hljs-comment">/* 转义后CSS代码 "browserslist": "&gt; 0.1%" */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: -webkit-fill-available;
  <span class="hljs-attribute">width</span>: -moz-available;
  <span class="hljs-attribute">width</span>: stretch;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">0.50196</span>);
}
</code></pre>
<p>通过上面的结果，我们可以看到不同的浏览器兼容性配置，会生成不同的代码。postcss-preset-env中包含了Autoprefixer，因此会自动添加浏览器引擎前缀。此外，还会根据支持程度添加其它兼容性代码。</p>
<p>例如#rrggbbaa，是分别以两个16进制数字表示红R绿G蓝B透明度A表示颜色的方式，只在相对较新的浏览器中支持。当browserslist&gt;1%时不进行转义，当&gt;0.1%时就转义为rgba函数的形式。</p>
<h3 data-id="heading-27">是否任何语法都能转义</h3>
<p>postcss-preset-env插件可以根据源CSS代码使用的特性来转义代码，增加兼容性。那么是不是什么特性都能转义，转义后的效果是不是与转义前一致？这很显然是否定的。即使是JavaScript代码，转义和Polyfill也做不到将所有新特性的兼容模式运行和新特性完全一致。例如Vue3之所以不兼容IE的一个原因，就是无法兼容JavaScript语法中Proxy的所有特性。至于CSS兼容性的限制就更大了。这里我们依然使用之前的CSS变量代码来举例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza, red);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--jzb);
}

<span class="hljs-comment">/* 生成CSS代码 "browserslist": "&gt; 0.001%" */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">background</span>: red;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--jza, red);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--jzb);
}
</code></pre>
<p>即使浏览器兼容性配置的要求很高，生成的代码也是这样。当我们提供了后备值时，插件会为我们生成兼容性的固定值background: red。如果没提供，那插件则无能为例。不管有没有生成固定值，这段代码在不支持CSS变量的浏览器运行时，效果与支持的浏览器不一样：因为变量的运行时变更功能无法被兼容。因此这明显可以得出：转义插件并不是任何属性都能转义，相反它不能做到的事情特别多，只能够尽量。</p>
<h2 data-id="heading-28">PostCSS与SCSS和Less</h2>
<p>这一部分我们以Webapck作为环境，从直接引入SCSS与Less开始，再到用PostCSS做后处理器，再直接用PostCSS解析SCSS与Less。</p>
<h3 data-id="heading-29">Webapck引入SCSS</h3>
<p>首先尝试在Webpack中引入SCSS。还是前面创建的Webpack工程，安装依赖sass和sass-loader，然后修改webpack.config.js：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">"production"</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.js"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"main.js"</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, <span class="hljs-string">"sass-loader"</span>],
      },
    ],
  },
};
</code></pre>
<p>可以看到，增加了一条规则匹配SCSS文件。先使用sass-loader把SCSS解析成CSS，然后再用常规的CSS处理。我们要打包的代码如下。首先是入口文件，其中引入了CSS和SCSS文件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">"./index.scss"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.css"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>然后是CSS和SCSS文件内容：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* index.css */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">color</span>: blue;
}

<span class="hljs-comment">/* index.scss */</span>
$jzabc: red;
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">color</span>: $jzabc;
}
</code></pre>
<p>SCSS文件中使用了变量的特性，SCSS在编译后会变成它的实际值，我们看看打包结果。文件较长，仅展示相关部分：</p>
<pre><code class="hljs language-js" lang="js">i.<span class="hljs-title function_">push</span>([e.<span class="hljs-property">id</span>, <span class="hljs-string">".jzplp {\n  color: blue;\n}"</span>, <span class="hljs-string">""</span>]);
i.<span class="hljs-title function_">push</span>([e.<span class="hljs-property">id</span>, <span class="hljs-string">"div{color:red}"</span>, <span class="hljs-string">""</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>可以看到，SCSS文件被编译成功，也打包进了最终成果中。</p>
<h3 data-id="heading-30">Webapck引入Less</h3>
<p>再尝试在Webpack中引入Less。安装依赖less和less-loader，然后修改webpack.config.js，这里只列出module部分，其它和Webapck引入SCSS一致：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.less$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, <span class="hljs-string">"less-loader"</span>],
      },
    ],
  },
};
</code></pre>
<p>然后创建index.less，内容如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@jzabc:</span> red;
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-variable">@jzabc</span>;
}
</code></pre>
<p>在index.js中引入index.less：<code>import "./index.less";</code>。其它内容和上面一致，然后进行打包，生成结果如下（仅展示相关部分）。可以看到，Less文件也被编译成功，也打包进了最终成果中。</p>
<pre><code class="hljs language-js" lang="js">i.<span class="hljs-title function_">push</span>([e.<span class="hljs-property">id</span>, <span class="hljs-string">"div {\n  color: red;\n}\n"</span>, <span class="hljs-string">""</span>]);
i.<span class="hljs-title function_">push</span>([e.<span class="hljs-property">id</span>, <span class="hljs-string">".jzplp {\n  color: blue;\n}"</span>, <span class="hljs-string">""</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<h3 data-id="heading-31">用PostCSS做后处理器</h3>
<p>在文章的一开始，我们介绍了PostCSS最常用作后处理器，这一节我们就在前面引入SCSS与Less的基础上，集成PostCSS用作后处理器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);

<span class="hljs-keyword">const</span> postcssConfig = {
  <span class="hljs-attr">loader</span>: <span class="hljs-string">"postcss-loader"</span>,
  <span class="hljs-attr">options</span>: {
    <span class="hljs-attr">postcssOptions</span>: {
      <span class="hljs-attr">plugins</span>: [<span class="hljs-string">"autoprefixer"</span>],
    },
  },
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">"production"</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.js"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"main.js"</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, postcssConfig],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.less$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, postcssConfig, <span class="hljs-string">"less-loader"</span>],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/i</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, postcssConfig, <span class="hljs-string">"sass-loader"</span>],
      },
    ],
  },
};
</code></pre>
<p>上面同时支持CSS/SCSS/Less文件引入，都配置了PostCSS。看PostCSS的位置是在SCSS和Less之后，这就是后处理器的含义。然后是要打包的各个文件代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* index.js */</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.scss"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.css"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);

<span class="hljs-comment">/* index.scss */</span>
<span class="hljs-attr">$jzabc</span>: red;
.<span class="hljs-property">jzplp</span>-scss {
  <span class="hljs-attr">color</span>: $jzabc;
  <span class="hljs-attr">width</span>: stretch;
}

<span class="hljs-comment">/* index.less */</span>
@<span class="hljs-attr">jzabc</span>: red;
.<span class="hljs-property">jzplp</span>-less {
  <span class="hljs-attr">color</span>: @jzabc;
  <span class="hljs-attr">width</span>: stretch;
}

<span class="hljs-comment">/* index.css */</span>
.<span class="hljs-property">jzplp</span>-css {
  <span class="hljs-attr">color</span>: blue;
  <span class="hljs-attr">width</span>: stretch;
}
</code></pre>
<p>最后生成的结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">".jzplp-scss{color:red;width:-webkit-fill-available;width:-moz-available;width:stretch}"</span>,
<span class="hljs-string">".jzplp-css {\n  color: blue;\n  width: -webkit-fill-available;\n  width: -moz-available;\n  width: stretch;\n}"</span>,
<span class="hljs-string">".jzplp-less {\n  color: red;\n  width: -webkit-fill-available;\n  width: -moz-available;\n  width: stretch;\n}\n"</span>,
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>可以看到，不仅成功编译了SCSS和Less，而且代码经过了PostCSS处理，加上了浏览器引擎前缀。</p>
<h3 data-id="heading-32">PostCSS直接解析SCSS与Less</h3>
<p>在前面PostCSS用作后处理器的方式中，修改一下编译的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* index.js */</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.scss"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.less"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.css"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);

<span class="hljs-comment">/* index.scss */</span>
<span class="hljs-attr">$jzabc</span>: stretch;
.<span class="hljs-property">jzplp</span>-scss {
  <span class="hljs-attr">width</span>: $jzabc;
}

<span class="hljs-comment">/* index.less */</span>
@<span class="hljs-attr">jzabc</span>: stretch;
.<span class="hljs-property">jzplp</span>-less {
  <span class="hljs-attr">width</span>: @jzabc;
}
</code></pre>
<p>重新编译，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">".jzplp-less {\n  width: -webkit-fill-available;\n  width: -moz-available;\n  width: stretch;\n}\n"</span>
<span class="hljs-string">".jzplp-scss{width:-webkit-fill-available;width:-moz-available;width:stretch}"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>如果我们将postcss-loader与less-loader和sass-loader换一下位置，先处理PostCSS，再编译SCSS和Less，结果会如何呢？参考配置如下，仅展示改动部分：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.less$/i</span>,
  <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, <span class="hljs-string">"less-loader"</span>, postcssConfig],
},
{
  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/i</span>,
  <span class="hljs-attr">use</span>: [<span class="hljs-string">"style-loader"</span>, <span class="hljs-string">"css-loader"</span>, <span class="hljs-string">"sass-loader"</span>, postcssConfig],
},
</code></pre>
<p>重新编译，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">".jzplp-less {\n  width: stretch;\n}\n"</span>
<span class="hljs-string">".jzplp-scss{width:stretch}"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>可以看到生成结果并不同，stretch没有增加浏览器引擎前缀。原因是先经过PostCSS处理时，并不能识别SCSS和Less语法，因此无法处理相关的内容。而其中的正常CSS语法，PostCSS依然可以处理。</p>
<p>PostCSS还提供了SCSS和Less语法的解析器postcss-scss和postcss-less，我们引入试一下。首先修改Webapck配置：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.less$/i</span>,
  <span class="hljs-attr">use</span>: [
    <span class="hljs-string">"style-loader"</span>,
    <span class="hljs-string">"css-loader"</span>,
    <span class="hljs-string">"less-loader"</span>,
    {
      <span class="hljs-attr">loader</span>: <span class="hljs-string">"postcss-loader"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">postcssOptions</span>: {
          <span class="hljs-attr">syntax</span>: <span class="hljs-string">'postcss-less'</span>,
          <span class="hljs-attr">plugins</span>: [<span class="hljs-string">"autoprefixer"</span>],
        },
      },
    },
  ],
},
{
  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/i</span>,
  <span class="hljs-attr">use</span>: [
    <span class="hljs-string">"style-loader"</span>,
    <span class="hljs-string">"css-loader"</span>,
    <span class="hljs-string">"sass-loader"</span>,
    {
      <span class="hljs-attr">loader</span>: <span class="hljs-string">"postcss-loader"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">postcssOptions</span>: {
          <span class="hljs-attr">syntax</span>: <span class="hljs-string">'postcss-scss'</span>,
          <span class="hljs-attr">plugins</span>: [<span class="hljs-string">"autoprefixer"</span>],
        },
      },
    },
  ],
},
</code></pre>
<p>重新编译，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">".jzplp-less {\n  width: stretch;\n}\n"</span>
<span class="hljs-string">".jzplp-scss{width:stretch}"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"你好，jzplp"</span>);
</code></pre>
<p>可以看到效果与上面PostCSS先处理的情况一致，stretch没有增加浏览器引擎前缀。这是因为postcss-scss和postcss-less都是将SCSS和Less代码转换为AST，然后再将AST转换回来，并不编译为CSS代码。因此SCSS和Less变量并未被PostCSS插件转义。它们的作用主要是提供SCSS和Less的AST结点，方便对应的SCSS和Less的PostCSS插件做处理。虽然相关文档的使用场景说了可以直接使用普通PostCSS插件处理，但上面的测试结果说明，可以处理但并不完美。</p>
<h2 data-id="heading-33">PostCSS的SourceMap</h2>
<h3 data-id="heading-34">命令行生成SourceMap</h3>
<p>首先来看一下命令行方式如何生成SourceMap。先给出一个简单的源文件：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: stretch;
}
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--abc, red);
}
</code></pre>
<p>然后执行命令：<code>postcss index.css -u autoprefixer -o out.css</code>。这种情况下PostCSS不会去读postcss.config.js配置文件，而是仅使用命令行传参来转义。，默认情况下，PostCSS会生成inline，即附加在生成文件中作为注释的SourceMap。生成结果如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: -webkit-fill-available;
  <span class="hljs-attribute">width</span>: -moz-available;
  <span class="hljs-attribute">width</span>: stretch;
}
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--abc, red);
}

<span class="hljs-comment">/*# sourceMappingURL* 防止报错 *=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNzcy9pbmRleC5jc3MiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7RUFDRSw2QkFBYztFQUFkLHFCQUFjO0VBQWQsY0FBYztBQUNoQjtBQUNBO0VBQ0Usc0JBQXNCO0FBQ3hCIiwiZmlsZSI6Im91dC5jc3MiLCJzb3VyY2VzQ29udGVudCI6WyIuanpwbHAge1xyXG4gIHdpZHRoOiBzdHJldGNoO1xyXG59XHJcbmRpdiB7XHJcbiAgY29sb3I6IHZhcigtLWFiYywgcmVkKTtcclxufVxyXG4iXX0= */</span>
</code></pre>
<p>如果不希望生成SourceMap，那么命令行中附加--no-map即可：<code>postcss css/index.css -u autoprefixer -o out.css --no-map</code>。但如果希望生成独立的SourceMap文件，就必须使用PostCSS配置文件了。我们先把命令行修改为：<code>postcss css/index.css -o out.css</code>。然后配置postcss.config.js：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [autoprefixer],
};
</code></pre>
<p>执行命令行，发现生成文件与--no-map效果一致，不生成SourceMap。如果生成inline的SourceMap，配置文件修改为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [autoprefixer],
  <span class="hljs-attr">map</span>: <span class="hljs-literal">true</span>,
};
</code></pre>
<p>如果希望生成的独立的配置文件，则配置文件修改为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [autoprefixer],
  <span class="hljs-attr">map</span>: { <span class="hljs-attr">inline</span>: <span class="hljs-literal">false</span> },
};
</code></pre>
<p>这时候会生成一个文件out.css.map，其内容如下：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>,
  <span class="hljs-string">"sources"</span>: [
    <span class="hljs-string">"css/index.css"</span>
  ],
  <span class="hljs-string">"names"</span>: [],
  <span class="hljs-string">"mappings"</span>: <span class="hljs-string">"AAAA;EACE,6BAAc;EAAd,qBAAc;EAAd,cAAc;AAChB;AACA;EACE,sBAAsB;AACxB"</span>,
  <span class="hljs-string">"file"</span>: <span class="hljs-string">"out.css"</span>,
  <span class="hljs-string">"sourcesContent"</span>: [
    <span class="hljs-string">".jzplp {\r\n  width: stretch;\r\n}\r\ndiv {\r\n  color: var(--abc, red);\r\n}\r\n"</span>
  ]
}
</code></pre>
<p>可以看到，这个SourceMap文件的格式规范与之前JavaScript的SourceMap规范是一致的。</p>
<h3 data-id="heading-35">API方式生成SourceMap</h3>
<p>API方式与命令行的配置方式类似，首先是生成inline的SourceMap：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"autoprefixer"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);

<span class="hljs-keyword">const</span> originData = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"./css/index.css"</span>, <span class="hljs-string">"utf-8"</span>);

<span class="hljs-title function_">postcss</span>([autoprefixer])
  .<span class="hljs-title function_">process</span>(originData, { <span class="hljs-attr">from</span>: <span class="hljs-string">"css/index.css"</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">"out.css"</span>, <span class="hljs-attr">map</span>: <span class="hljs-literal">true</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">css</span>);
    fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">'out.css'</span>, res.<span class="hljs-property">css</span>);
  });
</code></pre>
<p>生成的SourceMap会直接在res.css中作为注释存在，输出到文件中和命令行输出一致。如果不希望生成inline的SourceMap，则是这样配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">postcss</span>([autoprefixer])
  .<span class="hljs-title function_">process</span>(originData, {
    <span class="hljs-attr">from</span>: <span class="hljs-string">"css/index.css"</span>,
    <span class="hljs-attr">to</span>: <span class="hljs-string">"out.css"</span>,
    <span class="hljs-attr">map</span>: { <span class="hljs-attr">inline</span>: <span class="hljs-literal">false</span> },
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">map</span>);
    <span class="hljs-keyword">const</span> str = res.<span class="hljs-property">map</span>.<span class="hljs-title function_">toString</span>();
    fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">"out.css"</span>, res.<span class="hljs-property">css</span>);
    fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">"out.css.map"</span>, str);
  });

<span class="hljs-comment">/* 输出结果
SourceMapGenerator{...省略 }
*/</span>
</code></pre>
<p>这时候SourceMap在res.map中，而且不是以字符串的形式存在，而是以SourceMapGenerator对象的形式存在。我们在<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fjs-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/js-sourcemap.html" ref="nofollow noopener noreferrer">快速定位源码问题：SourceMap的生成/使用/文件格式与历史</a>文章中描述过，这是source-map包中的对象类型，可以直接输出SourceMap字符串，也可以做进一步处理。这里将它输出成字符串，并打印到文件中，内容和命令行输出一致。</p>
<h3 data-id="heading-36">SourceMap内容解析</h3>
<p>我们使用前面文章<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fwebpack-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/webpack-sourcemap.html" ref="nofollow noopener noreferrer">Webpack中各种devtool配置的含义与SourceMap生成逻辑</a>中介绍过的解析SourceMap工具代码，来解析上面生成的SourceMap文件。解析结果如下：</p>
<pre><code class="hljs language-ruby" lang="ruby">生成代码行<span class="hljs-number">1</span>  列<span class="hljs-number">0</span>  源代码行<span class="hljs-number">1</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">2</span>  列<span class="hljs-number">2</span>  源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">2</span>  列<span class="hljs-number">31</span> 源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">16</span> 源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">3</span>  列<span class="hljs-number">2</span>  源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">3</span>  列<span class="hljs-number">23</span> 源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">16</span> 源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">4</span>  列<span class="hljs-number">2</span>  源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">4</span>  列<span class="hljs-number">16</span> 源代码行<span class="hljs-number">2</span>  列<span class="hljs-number">16</span> 源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">5</span>  列<span class="hljs-number">0</span>  源代码行<span class="hljs-number">3</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">6</span>  列<span class="hljs-number">0</span>  源代码行<span class="hljs-number">4</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">7</span>  列<span class="hljs-number">2</span>  源代码行<span class="hljs-number">5</span>  列<span class="hljs-number">2</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">7</span>  列<span class="hljs-number">24</span> 源代码行<span class="hljs-number">5</span>  列<span class="hljs-number">24</span> 源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
生成代码行<span class="hljs-number">8</span>  列<span class="hljs-number">0</span>  源代码行<span class="hljs-number">6</span>  列<span class="hljs-number">0</span>  源名称-            源文件<span class="hljs-symbol">:css/index</span>.css
</code></pre>
<p>可以看到，全是生成代码和源码的对应关系，一个标识符都没有。这也正常，毕竟CSS代码中并没有真正意义上JavaScript的那种标识。这里我们表格列一下对应关系指向的具体内容：</p>













































































































<table><thead><tr><th>源代码标识符</th><th>源代码行号</th><th>源代码列号</th><th>生成代码标识符</th><th>生成代码行号</th><th>生成代码列号</th></tr></thead><tbody><tr><td>.jzplp</td><td>1</td><td>0</td><td>.jzplp</td><td>1</td><td>0</td></tr><tr><td>width</td><td>2</td><td>2</td><td>width</td><td>2</td><td>2</td></tr><tr><td>;</td><td>2</td><td>16</td><td>;</td><td>2</td><td>31</td></tr><tr><td>width</td><td>2</td><td>2</td><td>width</td><td>3</td><td>2</td></tr><tr><td>;</td><td>2</td><td>16</td><td>;</td><td>3</td><td>23</td></tr><tr><td>width</td><td>2</td><td>2</td><td>width</td><td>4</td><td>2</td></tr><tr><td>;</td><td>2</td><td>16</td><td>;</td><td>4</td><td>16</td></tr><tr><td>}</td><td>3</td><td>0</td><td>}</td><td>5</td><td>0</td></tr><tr><td>div</td><td>4</td><td>0</td><td>div</td><td>6</td><td>0</td></tr><tr><td>color</td><td>5</td><td>2</td><td>color</td><td>7</td><td>2</td></tr><tr><td>;</td><td>5</td><td>24</td><td>;</td><td>7</td><td>24</td></tr><tr><td>}</td><td>6</td><td>0</td><td>}</td><td>8</td><td>0</td></tr></tbody></table>
<p>通过上面的表格，可以看到PostCSS记录SourceMap的规律：标记规则选择器的开头，规则大括号的结尾}。标记CSS声明的开头，声明值的结尾;。</p>
<h2 data-id="heading-37">PostCSS的AST</h2>
<h3 data-id="heading-38">生成AST数据</h3>
<p>我们来试一下如何使用PostCSS生成AST数据。首先还是先构造一个CSS文件，里面涵盖了CSS的一些常见场景：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--abc, red);
}
<span class="hljs-selector-tag">div</span> <span class="hljs-selector-class">.jzplp2</span> {
  <span class="hljs-attribute">color</span>: blue <span class="hljs-meta">!important</span>;
}
<span class="hljs-comment">/* this is comment jzplp */</span>
<span class="hljs-selector-class">.jz1</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
  <span class="hljs-selector-class">.jz2</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
  }
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-id">#jz3</span> {
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid red;
  }
}
</code></pre>
<p>然后使用前面API的方式处理CSS文件，在res.root中就能拿到AST数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);

<span class="hljs-keyword">const</span> originData = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"./css/index.css"</span>, <span class="hljs-string">"utf-8"</span>);
<span class="hljs-title function_">postcss</span>()
  .<span class="hljs-title function_">process</span>(originData, {
    <span class="hljs-attr">from</span>: <span class="hljs-string">"css/index.css"</span>,
    <span class="hljs-attr">to</span>: <span class="hljs-string">"out.css"</span>,
    <span class="hljs-attr">map</span>: { <span class="hljs-attr">inline</span>: <span class="hljs-literal">false</span> },
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">root</span>);
  });
</code></pre>
<p>PostCSS还提供了方法，可以直接解析CSS拿到AST数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);

<span class="hljs-keyword">const</span> originData = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"./css/index.css"</span>, <span class="hljs-string">"utf-8"</span>);
<span class="hljs-keyword">const</span> data = postcss.<span class="hljs-title function_">parse</span>(originData);
<span class="hljs-keyword">const</span> dataJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data.<span class="hljs-title function_">toJSON</span>());
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dataJson);
</code></pre>
<p>然后得到我们最终拿到的AST数据的JSON格式，后面的分析都基于这份数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"root"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">": "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"decl"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">24</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"width"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10px"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">": "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"decl"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">51</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">28</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"color"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"var(--abc, red)"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">54</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"selector"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".jzplp"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">": "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"decl"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">96</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">73</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"color"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"important"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blue"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">99</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">56</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"selector"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"div .jzplp2"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"left"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"right"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"comment"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">27</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">128</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"this is comment jzplp"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">": "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"decl"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">152</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">140</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"margin"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5px"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rule"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n    "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">": "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"decl"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">23</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">187</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">168</span> <span class="hljs-punctuation">}</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"padding"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10px 20px"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">13</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">192</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">11</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">156</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"selector"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".jz2"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">195</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">130</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"selector"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".jz1"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"afterName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"atrule"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"media"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">270</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">197</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(max-width: 768px)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">" "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"semicolon"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"after"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n  "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rule"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"raws"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"before"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\r\n    "</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"between"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">": "</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"decl"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">26</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">17</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">262</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">17</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">240</span> <span class="hljs-punctuation">}</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"border"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1px solid red"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">267</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">228</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"selector"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#jz3"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">270</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inputId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hasBOM"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"css"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".jzplp {\r\n  width: 10px;\r\n  color: var(--abc, red);\r\n}\r\ndiv .jzplp2 {\r\n  color: blue !important;\r\n}\r\n/* this is comment jzplp */\r\n.jz1 {\r\n  margin: 5px;\r\n  .jz2 {\r\n    padding: 10px 20px;\r\n  }\r\n}\r\n@media (max-width: 768px) {\r\n  #jz3 {\r\n    border: 1px solid red;\r\n  }\r\n}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;input css abVh40&gt;"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-39">公共属性</h3>
<p>PostCSS的AST结点类型不多，且不同的结点有一些公共属性，这里列举一下：</p>



































<table><thead><tr><th>属性名</th><th>属性含义</th><th>数据举例</th><th>数据举例说明</th></tr></thead><tbody><tr><td>type</td><td>结点类型</td><td>decl</td><td>CSS声明类型</td></tr><tr><td>nodes</td><td>子结点列表</td><td>[...]</td><td>子结点数组</td></tr><tr><td>raws</td><td>结点中的空白字符</td><td>{ "semicolon": false, "after": "\r\n" }</td><td>下面单独说明</td></tr><tr><td>source</td><td>结点的源码位置</td><td>{...}</td><td>下面单独说明</td></tr></tbody></table>
<p>其中最重要的是type和nodes属性，一个表示结点的类型，一个是包含的子结点列表。raws中分类整理了结点中的空白字符，这里列举一下属性含义：</p>
<ul>
<li>raws.before 结点前的空白符</li>
<li>raws.after 结点后的空白符</li>
<li>raws.between 对于decl结点是属性和值中间的空白符，例如<code>key: value</code>中间的<code>： </code>，对于其它结点类型是其它位置的空白。</li>
<li>raws.semicolon 如果最后一个子结点有分号则为true</li>
<li>raws.afterName 在at规则和它的条件之间的空白。例如<code>@media (</code>中间</li>
<li>raws.left 注释中/*之后，注释内容之前。</li>
<li>raws.right 注释内容之后，注释*/之前。</li>
</ul>
<p>source是生成SourceMap使用的数据，通过文件标识+起点终点的行号列号，可以精确找到结点在源文件的位置。这里也列举一下属性含义：</p>
<ul>
<li>source.inputId 源文件标识</li>
<li>source.start 起点位置信息</li>
<li>source.end 终点位置信息</li>
<li>source.start.line或source.end.line 行号</li>
<li>source.start.column或source.end.column 列号</li>
<li>source.start.offset或source.end.offset 距离文件起始的偏移量</li>
</ul>
<h3 data-id="heading-40">CSS结点类型和私有属性</h3>
<p>这里列举一下PostCSS的AST结点类型，以及它们私有的属性：</p>
<p><strong>root结点类型</strong></p>
<p>标识一个CSS文件，其中包含所有解析的结点。</p>
<p><strong>rule结点类型</strong></p>
<p>rule结点是一个CSS规则，包含选择器，后面跟着一个声明块。举例如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 一个rule结点 */</span>
<span class="hljs-selector-class">.jzplp</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--abc, red);
}
<span class="hljs-comment">/* 一个rule结点 */</span>
<span class="hljs-selector-class">.jz1</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
  <span class="hljs-comment">/* 嵌套一个rule结点 */</span>
  <span class="hljs-selector-class">.jz2</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
  }
}
</code></pre>
<p>rule结点有一个私有属性selector，表示这个结点的选择器，值例如<code>.jzplp</code>，或者组合选择器<code>div .jzplp2</code>。</p>
<p><strong>comment结点类型</strong></p>
<p>comment结点表示一个注释。它有个私有属性text，表示注释内容。</p>
<p><strong>decl结点类型</strong></p>
<p>decl结点表示一个CSS声明，即<code>key: value;</code>的结构。例如<code>width: 10px;</code>或者<code>border: 1px solid red;</code>。即使值包含函数或者多个值集合，decl结点也不再细分，不包含子结点。decl结点的私有属性如下：</p>
<ul>
<li>prop: CSS声明属性名，例如width</li>
<li>value: CSS声明属性值，例如10px</li>
<li>important: 如果声明设置了<code>!important</code>，这里的值为true</li>
</ul>
<p><strong>atrule结点类型</strong></p>
<p>atrule结点表示一个at规则，即以@符号开头的规则。举例如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 一个atrule结点 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-comment">/* 嵌套一个rule结点 */</span>
  <span class="hljs-selector-id">#jz3</span> {
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid red;
  }
}
</code></pre>
<p>atrule结点有私有属性name，表示@后面跟的标识符，例如上面的media。还有一个私有属性params，表示at规则内的参数，例如上面的<code>(max-width: 768px)</code>。</p>
<h2 data-id="heading-41">插件开发</h2>
<h3 data-id="heading-42">新建插件</h3>
<p>首先我们创建pluginJzplp.js文件存放插件代码，然后在PostCSS配置文件中引入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// pluginJzplp.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'init'</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Root'</span>);
    },
    <span class="hljs-title class_">Declaration</span>() {},
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;

<span class="hljs-comment">// postcss.config.js</span>
<span class="hljs-keyword">const</span> pluginJzplp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pluginJzplp'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [pluginJzplp],
};
</code></pre>
<p>可以看到，插件就是一个函数，函数的返回值是一个对象，其中postcssPlugin属性表示函数名称，其它属性大部分都和遍历AST有关。这个函数本身还需要设置postcss属性为true，这样才能被PostCSS认为是插件。我们看下执行后的输出：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 转义单文件</span>
<span class="hljs-keyword">init</span>
<span class="hljs-keyword">init</span>
Root
<span class="hljs-comment">// 转义两个文件</span>
<span class="hljs-keyword">init</span>
<span class="hljs-keyword">init</span>
Root
<span class="hljs-keyword">init</span>
<span class="hljs-keyword">init</span>
Root
</code></pre>
<p>可以看到，每转义一个文件，插件函数会被执行两次，但实际遍历（输出Root）只有一次。我们再来看下函数入参：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// pluginJzplp.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params">p1, p2, p3</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1, p2, p3);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Root'</span>);
    },
    <span class="hljs-title class_">Declaration</span>() {},
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;

<span class="hljs-comment">// postcss.config.js</span>
<span class="hljs-keyword">const</span> pluginJzplp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pluginJzplp'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-string">'jz1'</span>, <span class="hljs-string">'jz2'</span>, <span class="hljs-number">3</span>)],
};

<span class="hljs-comment">/* 单文件输出结果
jz1 jz2 3
Root
Root
*/</span>
</code></pre>
<p>可以看到，插件函数的入参全部是插件引入时传的参数。</p>
<h3 data-id="heading-43">遍历AST</h3>
<p>PostCSS插件遍历AST的方法与Babel类似，都是以结点类型名作为函数属性。当遍历到对应类型的结点时，函数被触发，入参为对应的结点数据。我们来看一个插件例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Root"</span>);
    },
    <span class="hljs-title class_">Rule</span>(data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Rule"</span>, data.<span class="hljs-property">selector</span>);
    },
    <span class="hljs-title class_">Declaration</span>: {
      <span class="hljs-title function_">color</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Declaration color"</span>, data.<span class="hljs-property">value</span>);
      },
      <span class="hljs-title function_">width</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Declaration width"</span>, data.<span class="hljs-property">value</span>);
      },
    },
    <span class="hljs-title class_">AtRule</span>: {
      <span class="hljs-title function_">media</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AtRule media"</span>, data.<span class="hljs-property">params</span>);
      },
    },
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;

<span class="hljs-comment">/* 输出结果
Root
Rule .jzplp
Declaration width 10px
Declaration color var(--abc, red)
Rule div .jzplp2
Declaration color blue
Rule .jz1
Rule .jz2
AtRule media (max-width: 768px)
Rule #jz3
*/</span>
</code></pre>
<p>对应节点类型函数的入参，就是这个类型的结点数据本身，上面的例子中输出了一些节点属性。对于AtRule和Declaration类型的结点可以接受更细分的类型函数，例如Declaration可以把属性名作为key分别定义遍历函数。</p>
<p>每个类型的结点可以定义两种类型的函数，一种是进入结点时，一种是退出结点时。区别在于是否已经遍历过子结点。上面的介绍的函数都是进入结点时的函数，退出函数名则需要在后面加Exit，例如RootExit, RuleExit。只有拥有子结点的类型有退出函数，Declaration这种没有子结点的结点就只有一个函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Once</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Once"</span>);
    },
    <span class="hljs-title class_">OnceExit</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"OnceExit"</span>);
    },
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Root"</span>);
    },
    <span class="hljs-title class_">RootExit</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"RootExit"</span>);
    },
    <span class="hljs-title class_">Rule</span>(data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Rule"</span>, data.<span class="hljs-property">selector</span>);
    },
    <span class="hljs-title class_">RuleExit</span>(data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"RuleExit"</span>, data.<span class="hljs-property">selector</span>);
    },
    <span class="hljs-title class_">Declaration</span>(data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Declaration"</span>, data.<span class="hljs-property">prop</span>, data.<span class="hljs-property">value</span>);
    },
    <span class="hljs-title class_">AtRule</span>: {
      <span class="hljs-title function_">media</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AtRule media"</span>, data.<span class="hljs-property">params</span>);
      },
    },
    <span class="hljs-title class_">AtRuleExit</span>: {
      <span class="hljs-title function_">media</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AtRuleExit media"</span>, data.<span class="hljs-property">params</span>);
      },
    },
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;

<span class="hljs-comment">/* 输出结果
Once
Root
Rule .jzplp
Declaration width 10px
Declaration color var(--abc, red)
RuleExit .jzplp
Rule div .jzplp2
Declaration color blue
RuleExit div .jzplp2
Rule .jz1
Declaration margin 5px
Rule .jz2
Declaration padding 10px 20px
RuleExit .jz2
RuleExit .jz1
AtRule media (max-width: 768px)
Rule #jz3
Declaration border 1px solid red
RuleExit #jz3
AtRuleExit media (max-width: 768px)
RootExit
OnceExit
*/</span>
</code></pre>
<p>通过上面的例子可以看到，先触发进入结点的函数，再访问内部结点，然后再触发退出结点的函数。上面例子中还有Once和OnceExit函数，这两个是最早和最后触发的两个函数，入参是root数据。</p>
<h3 data-id="heading-44">修改AST结点属性</h3>
<p>首先从修改AST结点的属性开始。下面的插件修改了Declaration和AtRule的属性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Root"</span>);
    },
    <span class="hljs-title class_">RootExit</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"RootExit"</span>);
    },
    <span class="hljs-title class_">Rule</span>(data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Rule"</span>, data.<span class="hljs-property">selector</span>);
    },
    <span class="hljs-title class_">RuleExit</span>(data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"RuleExit"</span>, data.<span class="hljs-property">selector</span>);
    },
    <span class="hljs-title class_">Declaration</span>: {
      <span class="hljs-title function_">color</span>(<span class="hljs-params">data</span>) {
        data.<span class="hljs-property">value</span> = <span class="hljs-string">"yellow"</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Declaration color"</span>);
      },
    },
    <span class="hljs-title class_">AtRule</span>: {
      <span class="hljs-title function_">media</span>(<span class="hljs-params">data</span>) {
        data.<span class="hljs-property">params</span> = <span class="hljs-string">"(max-width: 1000px)"</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AtRule media"</span>);
      },
    },
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;
</code></pre>
<p>我们简化一下转义的CSS代码，运行PostCSS后查看输出结果，发现生成的代码中确实被改掉了。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-tag">div</span> <span class="hljs-selector-class">.jzplp2</span> {
  <span class="hljs-attribute">color</span>: blue <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.jz2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {}

<span class="hljs-comment">/* 生成CSS代码 */</span>
<span class="hljs-selector-tag">div</span> <span class="hljs-selector-class">.jzplp2</span> {
  <span class="hljs-attribute">color</span>: yellow <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.jz2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">1000px</span>) {}

<span class="hljs-comment">/* 命令行输出
Root
Rule div .jzplp2
Declaration color
RuleExit div .jzplp2
Rule .jz2
RuleExit .jz2
AtRule media
RootExit
Root
Rule div .jzplp2
Declaration color
RuleExit div .jzplp2
AtRule media
RootExit
*/</span>

<span class="hljs-comment">/* 插件中删掉修改AtRule的代码 命令行输出
Root
Rule div .jzplp2
Declaration color
RuleExit div .jzplp2
Rule .jz2
RuleExit .jz2
AtRule media
RootExit
Root
Rule div .jzplp2
Declaration color
RuleExit div .jzplp2
RootExit
*/</span>
</code></pre>
<p>从命令行中输出中，我们还发现，Root被遍历了两次。第一次遍历了全部属性，第二次仅仅遍历了修改过的属性以及他们的父结点。如果把插件中修改AtRule的代码删除再执行，发现Root还是被遍历了两次。因此父结点的再上级结点也会被遍历，一直到根结点。因此，假设我们一直将属性修改为不同的值，就会触发无限循环遍历。开发插件的时候要注意这件事。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Root"</span>);
    },
    <span class="hljs-title class_">RootExit</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"RootExit"</span>);
    },
    <span class="hljs-title class_">Declaration</span>: {
      <span class="hljs-title function_">width</span>(<span class="hljs-params">data</span>) {
        data.<span class="hljs-property">value</span> = ++a;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Declaration width"</span>);
      },
    },
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;

<span class="hljs-comment">/* 命令行输出
Root
Declaration width
RootExit
Root
Declaration width
RootExit
Root
...无限循环
*/</span>
</code></pre>
<h3 data-id="heading-45">增删AST结点</h3>
<p>PostCSS提供了每个结点的创建函数，可以创建对应类型的结点。每个结点上还挂载了父节点，子结点，各种位置添加结点的函数，可以让我们方便增删和处理结点。例如下面这个插件例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Root</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Root"</span>);
    },
    <span class="hljs-title class_">RootExit</span>() {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"RootExit"</span>);
    },
    <span class="hljs-title class_">Declaration</span>: {
      <span class="hljs-title function_">width</span>(<span class="hljs-params">data, { Declaration }</span>) {
        <span class="hljs-keyword">const</span> decl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Declaration</span>({ <span class="hljs-attr">prop</span>: <span class="hljs-string">"color"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"black"</span> });
        data?.<span class="hljs-property">parent</span>?.<span class="hljs-title function_">append</span>(decl);
      },
    },
    <span class="hljs-title class_">Rule</span>(data, { <span class="hljs-title class_">Rule</span>, <span class="hljs-title class_">Declaration</span> }) {
      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">selector</span> === <span class="hljs-string">"div .jzplp2"</span>) {
        <span class="hljs-keyword">const</span> decl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Declaration</span>({ <span class="hljs-attr">prop</span>: <span class="hljs-string">"color"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"yellow"</span> });
        <span class="hljs-keyword">const</span> rule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rule</span>({ <span class="hljs-attr">selector</span>: <span class="hljs-string">".jz3"</span>, <span class="hljs-attr">nodes</span>: [decl] });
        data.<span class="hljs-title function_">before</span>(rule);
      }
    },
    <span class="hljs-title class_">AtRule</span>: {
      <span class="hljs-title function_">media</span>(<span class="hljs-params">data</span>) {
        <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">flag</span>) {
          data.<span class="hljs-property">flag</span> = <span class="hljs-number">1</span>;
          <span class="hljs-keyword">const</span> cloned = data.<span class="hljs-title function_">clone</span>(data);
          data.<span class="hljs-title function_">push</span>(cloned);
        }
      },
    },
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;
</code></pre>
<p>注意部分可能造成无限循环的场景需要进行限制。输出结果如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源CSS代码 */</span>
<span class="hljs-selector-tag">div</span> <span class="hljs-selector-class">.jzplp2</span> {
  <span class="hljs-attribute">color</span>: blue <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.jz2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {}


<span class="hljs-comment">/* 生成CSS代码 */</span>
<span class="hljs-selector-class">.jz3</span> {
  <span class="hljs-attribute">color</span>: yellow;
}
<span class="hljs-selector-tag">div</span> <span class="hljs-selector-class">.jzplp2</span> {
  <span class="hljs-attribute">color</span>: blue <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-class">.jz2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">color</span>: black;
}
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {}}

<span class="hljs-comment">/* 命令行输出
Root
RootExit
Root
RootExit
*/</span>
</code></pre>
<h2 data-id="heading-46">AST辅助工具</h2>
<p>在前面介绍过PostCSS的AST结点类型一共就只有几种，例如规则rule规则结点和decl声明结点。但CSS实际的复杂度要更高，例如结点选择器还可以分为属性选择器，类选择器，标签选择器，还有组合选择器，伪类伪元素选择器等等，有些甚至是函数的形态。CSS声明的值也是多种多样，有字符串，数字，函数，组合值等等。像这类数据PostCSS并没有直接提供解析方式，但有一些开源工具可以帮助解析。下面我们列举几个工具简单介绍：</p>
<h3 data-id="heading-47">postcss-selector-parser</h3>
<p>postcss-selector-parser是一个解析CSS选择器的工具。虽然名字中带postcss，但实际上不依赖PostCSS运行。postcss-selector-parser可以将选择器字符串解析为AST数据。其中包含一些结点类型，用type字段表示：</p>
<ul>
<li>attribute 属性选择器结点</li>
<li>class 类选择器结点</li>
<li>combinator 组合选择器结点</li>
<li>id id选择器结点</li>
<li>pseudo 伪类和伪元素选择器结点</li>
<li>tag 标签选择器结点</li>
<li>selector 选择器容器结点</li>
<li>等等...</li>
</ul>
<p>这里我们构造一个复杂一点的选择器字符串，遍历结点，看能解析出哪些类型：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'postcss-selector-parser'</span>);
<span class="hljs-keyword">const</span> selectorStr = <span class="hljs-string">'.jz1, div+jz2:not(#jzplp::first-line)'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">transform</span> = selectors =&gt; {
    selectors.<span class="hljs-title function_">walk</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">type</span>.<span class="hljs-title function_">padEnd</span>(<span class="hljs-number">12</span>), data.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padEnd</span>(<span class="hljs-number">35</span>), data?.<span class="hljs-property">nodes</span>?.<span class="hljs-property">map</span>?.(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">toString</span>()));
    });
};
<span class="hljs-keyword">const</span> transformed = <span class="hljs-title function_">parser</span>(transform).<span class="hljs-title function_">processSync</span>(selectorStr);

<span class="hljs-comment">/*
selector     .jz1                                [ '.jz1' ]
class        .jz1                                undefined
selector      div+jz2:not(#jzplp::first-line)    [ ' div', '+', 'jz2', ':not(#jzplp::first-line)' ]
tag           div                                undefined
combinator   +                                   undefined
tag          jz2                                 undefined
pseudo       :not(#jzplp::first-line)            [ '#jzplp::first-line' ]
selector     #jzplp::first-line                  [ '#jzplp', '::first-line' ]
id           #jzplp                              undefined
pseudo       ::first-line                        []
*/</span>
</code></pre>
<p>可以看到，组合选择器里面并不包含其它选择器，而是仅有连接符号本身。这个工具本身没有直接包含将代码转为JSON形式的AST数据的方法。我试了下ast方法，输出的内容也不是JSON数据，因此这里就不列出了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'postcss-selector-parser'</span>);
<span class="hljs-title function_">parser</span>(<span class="hljs-function">() =&gt;</span> {})
  .<span class="hljs-title function_">ast</span>(selectorStr)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));
<span class="hljs-comment">// 输出非JSON数据</span>
</code></pre>
<p>工具内提供了各种创建AST结点的方法，这里我们尝试修改和添加AST结点试试。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-selector-parser"</span>);
<span class="hljs-keyword">const</span> selectorStr = <span class="hljs-string">".jz1, div+jz2:not(#jzplp::first-line)"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">transform</span> = (<span class="hljs-params">selectors</span>) =&gt; {
  selectors.<span class="hljs-title function_">walk</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    <span class="hljs-comment">// 修改结点属性</span>
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">"tag"</span> &amp;&amp; data.<span class="hljs-property">value</span> === <span class="hljs-string">"jz2"</span>) data.<span class="hljs-property">value</span> = <span class="hljs-string">"h1"</span>;
    <span class="hljs-comment">// 添加结点</span>
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">"selector"</span> &amp;&amp; data.<span class="hljs-title function_">toString</span>() === <span class="hljs-string">'.jz1'</span>) {
      <span class="hljs-keyword">const</span> attr = parser.<span class="hljs-title function_">attribute</span>({ <span class="hljs-attr">attribute</span>: <span class="hljs-string">"href"</span> });
      data.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">push</span>(attr);
    }
  });
};
<span class="hljs-keyword">const</span> transformed = <span class="hljs-title function_">parser</span>(transform).<span class="hljs-title function_">processSync</span>(selectorStr);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(transformed);

<span class="hljs-comment">/* 输出结果
.jz1[href], div+h1:not(#jzplp::first-line)
*/</span>
</code></pre>
<h3 data-id="heading-48">postcss-value-parser</h3>
<p>postcss-selector-parser是一个解析CSS值的工具，也可以脱离PostCSS运行。它将CSS声明中的值字符串解析为AST数据。首先我们构造一个复杂的值例子，输出对应的AST数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> valueParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss-value-parser"</span>);
<span class="hljs-keyword">const</span> valueStr = <span class="hljs-string">"calc(50vh + 10px) solid var(--jzplp, rgba(255,255,255, 0.5))"</span>;
<span class="hljs-keyword">var</span> parsedValue = <span class="hljs-title function_">valueParser</span>(valueStr);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsedValue));

<span class="hljs-comment">/* 输出结果
{
  "nodes": [
    {
      "type": "function",
      "sourceIndex": 0,
      "value": "calc",
      "before": "",
      "after": "",
      "sourceEndIndex": 17,
      "nodes": [
        { "type": "word", "sourceIndex": 5, "sourceEndIndex": 9, "value": "50vh" },
        { "type": "space", "sourceIndex": 9, "sourceEndIndex": 10, "value": " " },
        { "type": "word", "sourceIndex": 10, "sourceEndIndex": 11, "value": "+" },
        { "type": "space", "sourceIndex": 11, "sourceEndIndex": 12, "value": " " },
        { "type": "word", "sourceIndex": 12, "sourceEndIndex": 16, "value": "10px" }
      ]
    },
    { "type": "space", "sourceIndex": 17, "sourceEndIndex": 18, "value": " " },
    { "type": "word", "sourceIndex": 18, "sourceEndIndex": 23, "value": "solid" },
    { "type": "space", "sourceIndex": 23, "sourceEndIndex": 24, "value": " " },
    {
      "type": "function",
      "sourceIndex": 24,
      "value": "var",
      "before": "",
      "after": "",
      "sourceEndIndex": 60,
      "nodes": [
        { "type": "word", "sourceIndex": 28, "sourceEndIndex": 35, "value": "--jzplp" },
        { "type": "div", "sourceIndex": 35, "sourceEndIndex": 37, "value": ",", "before": "", "after": " " },
        {
          "type": "function",
          "sourceIndex": 37,
          "value": "rgba",
          "before": "",
          "after": "",
          "sourceEndIndex": 59,
          "nodes": [
            { "type": "word", "sourceIndex": 42, "sourceEndIndex": 45, "value": "255" },
            { "type": "div", "sourceIndex": 45, "sourceEndIndex": 46, "value": ",", "before": "", "after": "" },
            { "type": "word", "sourceIndex": 46, "sourceEndIndex": 49, "value": "255" },
            { "type": "div", "sourceIndex": 49, "sourceEndIndex": 50, "value": ",", "before": "", "after": "" },
            { "type": "word", "sourceIndex": 50, "sourceEndIndex": 53, "value": "255" },
            { "type": "div", "sourceIndex": 53, "sourceEndIndex": 55, "value": ",", "before": "", "after": " " },
            { "type": "word", "sourceIndex": 55, "sourceEndIndex": 58, "value": "0.5" }
          ]
        }
      ]
    }
  ]
}
*/</span>
</code></pre>
<p>通过上面的例子，CSS声明值被解析成了JSON形式的AST数据。其中每个结点以type属性来区分类型。我们列举下其中的常用AST结点：</p>
<ul>
<li>word 普通值结点，例如 10px, 255等</li>
<li>string 字符串节点，例如 "/jz/123"</li>
<li>div 分隔节点，例如 逗号，斜杠等</li>
<li>space 空格结点</li>
<li>comment 注释结点</li>
<li>function 函数结点，里面可以包含其它结点，例如 rgba(), var()等</li>
</ul>
<p>然后我们再试着遍历AST，以及修改结点内容。这里在前面代码的基础上继续写：</p>
<pre><code class="hljs language-js" lang="js">parsedValue.<span class="hljs-title function_">walk</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(node.<span class="hljs-property">type</span>.<span class="hljs-title function_">padEnd</span>(<span class="hljs-number">10</span>), <span class="hljs-string">"["</span>, node.<span class="hljs-property">value</span>.<span class="hljs-title function_">padEnd</span>(<span class="hljs-number">10</span>), <span class="hljs-string">"]"</span>);
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-string">"word"</span> &amp;&amp; node.<span class="hljs-property">value</span> === <span class="hljs-string">"10px"</span>)  node.<span class="hljs-property">value</span> = <span class="hljs-string">"10em"</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(parsedValue.<span class="hljs-title function_">toString</span>());

<span class="hljs-comment">/* 输出结果
function   [ calc       ]
word       [ 50vh       ]
space      [            ]
word       [ +          ]
space      [            ]
word       [ 10px       ]
space      [            ]
word       [ solid      ]
space      [            ]
function   [ var        ]
word       [ --jzplp    ]
div        [ ,          ]
function   [ rgba       ]
word       [ 255        ]
div        [ ,          ]
word       [ 255        ]
div        [ ,          ]
word       [ 255        ]
div        [ ,          ]
word       [ 0.5        ]
calc(50vh + 10em) solid var(--jzplp, rgba(255,255,255, 0.5))
*/</span>
</code></pre>
<h2 data-id="heading-49">自定义语法规则</h2>
<p>PostCSS不仅可以编译CSS语法，还可以自定义语法规则实现功能扩展。</p>
<h3 data-id="heading-50">编写自定义语法规则</h3>
<p>PostCSS编写自定义语法的方法，就是实现parser/stringifier/syntax方法，然后在PostCSS参数中传入对应方法即可。</p>
<ul>
<li>parser方法 将字符串转为抽象语法树</li>
<li>stringifier方法 将抽象语法树转为字符串</li>
<li>syntax 相当于parser + stringifier</li>
</ul>
<p>编写自定义语法规则是一件很复杂的事情，需要经过词法分析句法分析等步骤，很显然超出了这篇文章的范畴。因此这里我们只给出一个非常简单的demo，示意一下自定义语法的开发接口。首先来看下自定义语法的方式。这里我们设置文件内容的每行为xxx=xxx，尝试用自定义语法解析和生成这样的结构。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* 需要解析的文件 index.jzcss
jzplp=12345
jz2=98765
*/</span>

<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseLine</span>(<span class="hljs-params">strLine</span>) {
  <span class="hljs-keyword">const</span> strList = strLine.<span class="hljs-title function_">split</span>(<span class="hljs-string">"="</span>);
  <span class="hljs-keyword">const</span> customKey = { <span class="hljs-attr">type</span>: <span class="hljs-string">"customKey"</span>, <span class="hljs-attr">value</span>: strList[<span class="hljs-number">0</span>] };
  <span class="hljs-keyword">const</span> customValue = { <span class="hljs-attr">type</span>: <span class="hljs-string">"customValue"</span>, <span class="hljs-attr">value</span>: strList[<span class="hljs-number">1</span>] };
  <span class="hljs-keyword">const</span> equal = { <span class="hljs-attr">type</span>: <span class="hljs-string">"equal"</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"="</span>, <span class="hljs-attr">nodes</span>: [customKey, customValue] };
  <span class="hljs-keyword">return</span> equal;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">cssStr</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"parser!"</span>);
  <span class="hljs-keyword">const</span> strList = cssStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>);
  <span class="hljs-keyword">const</span> nodes = strList.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> <span class="hljs-title function_">parseLine</span>(line));
  <span class="hljs-keyword">const</span> root = postcss.<span class="hljs-title function_">root</span>();
  root.<span class="hljs-property">nodes</span> = nodes;
  <span class="hljs-keyword">return</span> root;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">recursion</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-string">"customKey"</span> || node.<span class="hljs-property">type</span> === <span class="hljs-string">"customValue"</span>) <span class="hljs-keyword">return</span> node.<span class="hljs-property">value</span>;
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-string">"equal"</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">recursion</span>(node.<span class="hljs-property">nodes</span>[<span class="hljs-number">0</span>]) + node.<span class="hljs-property">value</span> + <span class="hljs-title function_">recursion</span>(node.<span class="hljs-property">nodes</span>[<span class="hljs-number">1</span>]);
  <span class="hljs-keyword">return</span> node.<span class="hljs-property">nodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-title function_">recursion</span>(item)).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">stringify</span>(<span class="hljs-params">root, builder</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"stringify!"</span>);
  <span class="hljs-title function_">builder</span>(<span class="hljs-title function_">recursion</span>(root), root);
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  parse,
  stringify,
};
</code></pre>
<p>首先是parse方法，外面包裹一个PostCSS的root结点。里面切分出每行，对每行切分出equal等号结点，子结点为customKey和customValue两个。解析成AST数据后返回。stringify方法使用了递归，针对不同的结点类型输出不同的字符串，进行拼合。最后将字符串和root结点传回builder回调。然后我们尝试使用自定义规则来解析文件，输出AST数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);
<span class="hljs-keyword">const</span> customParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./parser"</span>);

<span class="hljs-keyword">const</span> originData = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"./index.jzcss"</span>, <span class="hljs-string">"utf-8"</span>);
<span class="hljs-title function_">postcss</span>()
  .<span class="hljs-title function_">process</span>(originData, {
    <span class="hljs-attr">from</span>: <span class="hljs-string">"index.jzcss"</span>,
    <span class="hljs-attr">to</span>: <span class="hljs-string">"out.css"</span>,
    <span class="hljs-attr">syntax</span>: customParser,
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">css</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res.<span class="hljs-property">root</span>.<span class="hljs-title function_">toJSON</span>()));
  });

<span class="hljs-comment">/* 输出结果
parser!
stringify!
jzplp=12345
jz2=98765
{
  "raws": {},
  "type": "root",
  "nodes": [
    {
      "type": "equal",
      "value": "=",
      "nodes": [
        { "type": "customKey", "value": "jzplp" },
        { "type": "customValue", "value": "12345\r" }
      ]
    },
    {
      "type": "equal",
      "value": "=",
      "nodes": [
        { "type": "customKey", "value": "jz2" },
        { "type": "customValue", "value": "98765" }
      ]
    }
  ],
  "lastEach": 1,
  "indexes": {},
  "inputs": []
}
*/</span>
</code></pre>
<h3 data-id="heading-51">为自定义规则编写插件</h3>
<p>创建了自定义规则结点之后，我们再为这种规则结点编写一个插件，尝试修改AST结点再生成代码。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pluginJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">"postcss-plugin-jzplp"</span>,
    <span class="hljs-title class_">Once</span>(root) {
      root.<span class="hljs-title function_">walk</span>(<span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-string">"equal"</span>) {
          node.<span class="hljs-property">value</span> = <span class="hljs-string">"=="</span>;
          <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodes</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> === <span class="hljs-string">"jz2"</span>)
            node.<span class="hljs-property">nodes</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = <span class="hljs-string">"jzplp2"</span>;
        }
      });
    },
  };
}
pluginJzplp.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pluginJzplp;
</code></pre>
<p>我们自己创建的结点类型太简陋了，不能被PostCSS识别为结点，不能使用结点类型名称开头的函数；walk函数也无法遍历更深层的结点。因此我们手动修改子结点的属性。最后引入插件并执行，从输出结果看改动成功了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);
<span class="hljs-keyword">const</span> customParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./parser"</span>);
<span class="hljs-keyword">const</span> pluginJzplp = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./pluginJzplp"</span>);
<span class="hljs-keyword">const</span> originData = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"./index.jzcss"</span>, <span class="hljs-string">"utf-8"</span>);

<span class="hljs-title function_">postcss</span>([pluginJzplp])
  .<span class="hljs-title function_">process</span>(originData, {
    <span class="hljs-attr">from</span>: <span class="hljs-string">"index.jzcss"</span>,
    <span class="hljs-attr">to</span>: <span class="hljs-string">"out.css"</span>,
    <span class="hljs-attr">syntax</span>: customParser,
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">css</span>);
  });

<span class="hljs-comment">/* 输出结果
jzplp==12345
jzplp2==98765
*/</span>
</code></pre>
<h2 data-id="heading-52">总结</h2>
<p>这篇文章介绍了PostCSS的作用：转换CSS的代码成AST，经过插件处理再生成新CSS代码，经常被用作后处理和添加兼容性；还介绍了各种使用方法：命令行方式，API方式，Webapck）；然后介绍了几个插件的作用，以及与SCSS和Less组合使用。后面又介绍了PostCSS的SourceMap与AST结构，如何开发插件与自定义语法。</p>
<p>从作用上来，虽然CSS本身不是完整的编程语言，但PostCSS对CSS却像编程语言一样处理。只不过AST结点类型只有几种，看起来有点简陋，还需要额外的辅助工具，比如解析选择器和声明值。这些辅助工具也是用AST来实现的。</p>
<p>除了PostCSS之外，还有CSSTree，CSSOM等都可以将CSS转换为AST语法树，但都没有PostCSS知名度高，有的甚至已经不维护了。</p>
<h2 data-id="heading-53">参考</h2>
<ul>
<li>PostCSS 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fpostcss.org%2F" target="_blank" title="https://postcss.org/" ref="nofollow noopener noreferrer">postcss.org/</a></li>
<li>GitHub PostCSS<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss" target="_blank" title="https://github.com/postcss/postcss" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>PostCSS 中文文档<br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fpostcss.docschina.org%2F" target="_blank" title="http://postcss.docschina.org/" ref="nofollow noopener noreferrer">postcss.docschina.org/</a></li>
<li>AST explorer<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fastexplorer.net%2F" target="_blank" title="https://astexplorer.net/" ref="nofollow noopener noreferrer">astexplorer.net/</a></li>
<li>PostCSS plugins列表<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss%2Fblob%2Fmain%2Fdocs%2Fplugins.md" target="_blank" title="https://github.com/postcss/postcss/blob/main/docs/plugins.md" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>PostCSS writing a plugin<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss%2Fblob%2Fmain%2Fdocs%2Fwriting-a-plugin.md" target="_blank" title="https://github.com/postcss/postcss/blob/main/docs/writing-a-plugin.md" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>各位前端大神能不能通俗的说一下PostCSS到底能做什么？对于手写css的优势在哪？<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F46312839%2Fanswer%2F190520136" target="_blank" title="https://www.zhihu.com/question/46312839/answer/190520136" ref="nofollow noopener noreferrer">www.zhihu.com/question/46…</a></li>
<li>GitHub Autoprefixer<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fautoprefixer" target="_blank" title="https://github.com/postcss/autoprefixer" ref="nofollow noopener noreferrer">github.com/postcss/aut…</a></li>
<li>GitHub PostCSS CLI<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss-cli" target="_blank" title="https://github.com/postcss/postcss-cli" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>GitHub postcss-loader<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwebpack%2Fpostcss-loader" target="_blank" title="https://github.com/webpack/postcss-loader" ref="nofollow noopener noreferrer">github.com/webpack/pos…</a></li>
<li>Webpack文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwebpack.js.org%2F" target="_blank" title="https://webpack.js.org/" ref="nofollow noopener noreferrer">webpack.js.org/</a></li>
<li>Webpack中文文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2F" target="_blank" title="https://webpack.docschina.org/" ref="nofollow noopener noreferrer">webpack.docschina.org/</a></li>
<li>MDN 浏览器引擎前缀<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FVendor_Prefix" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Glossary/Vendor_Prefix" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>GitHub postcss-custom-properties<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcsstools%2Fpostcss-plugins%2Ftree%2Fmain%2Fplugins%2Fpostcss-custom-properties" target="_blank" title="https://github.com/csstools/postcss-plugins/tree/main/plugins/postcss-custom-properties" ref="nofollow noopener noreferrer">github.com/csstools/po…</a></li>
<li>MDN CSS var()<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FValues%2Fvar" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Values/var" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>GitHub cssnano<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcssnano%2Fcssnano" target="_blank" title="https://github.com/cssnano/cssnano" ref="nofollow noopener noreferrer">github.com/cssnano/css…</a></li>
<li>cssnano 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcssnano.github.io%2Fcssnano%2F" target="_blank" title="https://cssnano.github.io/cssnano/" ref="nofollow noopener noreferrer">cssnano.github.io/cssnano/</a></li>
<li>GitHub postcss-preset-env<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcsstools%2Fpostcss-plugins%2Ftree%2Fmain%2Fplugin-packs%2Fpostcss-preset-env" target="_blank" title="https://github.com/csstools/postcss-plugins/tree/main/plugin-packs/postcss-preset-env" ref="nofollow noopener noreferrer">github.com/csstools/po…</a></li>
<li>MDN CSS hex-color<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FValues%2Fhex-color" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Values/hex-color" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>GitHub postcss-scss<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss-scss" target="_blank" title="https://github.com/postcss/postcss-scss" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>GitHub postcss-less<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshellscape%2Fpostcss-less" target="_blank" title="https://github.com/shellscape/postcss-less" ref="nofollow noopener noreferrer">github.com/shellscape/…</a></li>
<li>Less文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Flesscss.org%2F" target="_blank" title="https://lesscss.org/" ref="nofollow noopener noreferrer">lesscss.org/</a></li>
<li>SCSS文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fsass-lang.com%2F" target="_blank" title="https://sass-lang.com/" ref="nofollow noopener noreferrer">sass-lang.com/</a></li>
<li>快速定位源码问题：SourceMap的生成/使用/文件格式与历史<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fjs-sourcemap.html" target="_blank" title="https://jzplp.github.io/2025/js-sourcemap.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/js-sou…</a></li>
<li>MDN CSS语法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FGuides%2FSyntax%2FIntroduction" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Guides/Syntax/Introduction" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>MDN CSS At规则<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FGuides%2FSyntax%2FAt-rules" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Guides/Syntax/At-rules" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>解锁Babel核心功能：从转义语法到插件开发<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fbabel-intro.html" target="_blank" title="https://jzplp.github.io/2025/babel-intro.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/babel-…</a></li>
<li>GitHub postcss-selector-parser<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss-selector-parser" target="_blank" title="https://github.com/postcss/postcss-selector-parser" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>postcss-selector-parser API Documentation<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpostcss%2Fpostcss-selector-parser%2Fblob%2Fmaster%2FAPI.md" target="_blank" title="https://github.com/postcss/postcss-selector-parser/blob/master/API.md" ref="nofollow noopener noreferrer">github.com/postcss/pos…</a></li>
<li>GitHub postcss-value-parser<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTrySound%2Fpostcss-value-parser" target="_blank" title="https://github.com/TrySound/postcss-value-parser" ref="nofollow noopener noreferrer">github.com/TrySound/po…</a></li>
<li>PostCSS文档 How to Write Custom Syntax<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fpostcss.org%2Fdocs%2Fhow-to-write-custom-syntax" target="_blank" title="https://postcss.org/docs/how-to-write-custom-syntax" ref="nofollow noopener noreferrer">postcss.org/docs/how-to…</a></li>
<li>JavaScript语法树简介：AST/CST/词法/语法分析/ESTree/生成工具<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fjs-ast.html" target="_blank" title="https://jzplp.github.io/2025/js-ast.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/js-ast…</a></li>
<li>CSSTree docs &amp; tools<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcsstree.github.io%2Fdocs%2F" target="_blank" title="https://csstree.github.io/docs/" ref="nofollow noopener noreferrer">csstree.github.io/docs/</a></li>
<li>GitHub CSSTree<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcsstree%2Fcsstree" target="_blank" title="https://github.com/csstree/csstree" ref="nofollow noopener noreferrer">github.com/csstree/css…</a></li>
<li>GitHub CSSOM<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNV%2FCSSOM" target="_blank" title="https://github.com/NV/CSSOM" ref="nofollow noopener noreferrer">github.com/NV/CSSOM</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端学习AI】Function Calling]]></title>    <link>https://juejin.cn/post/7588043318359457827</link>    <guid>https://juejin.cn/post/7588043318359457827</guid>    <pubDate>2025-12-27T13:24:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318359457827" data-draft-id="7588004376868110371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端学习AI】Function Calling"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T13:24:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端学习AI】Function Calling
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T13:24:24.000Z" title="Sat Dec 27 2025 13:24:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">核心定义</h2>
<p>Function Calling（函数调用）是大模型与外部工具/函数交互的核心能力，能够让模型根据用户需求自主判断是否需要调用指定函数，通过结构化参数传递调用指令并获取执行结果，最终结合结果生成精准响应，以此解决大模型自身无法完成的复杂计算、实时数据查询等任务。</p>
<h2 data-id="heading-1">两种工具添加方案</h2>
<h3 data-id="heading-2">方案一：直接通过 Tool.from_function 定义工具</h3>
<p>该方案适用于函数逻辑简单的场景，可直接通过字典指定参数规范，无需额外定义专门的参数模型，实现快速封装。</p>
<h4 data-id="heading-3">步骤1：基础依赖与初始化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> Tool
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-comment"># 大模型初始化</span>
llm = ChatOpenAI(
    <span class="hljs-comment"># 模型名称</span>
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    <span class="hljs-comment"># 模型基础地址</span>
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    <span class="hljs-comment"># 填写个人 API Key</span>
    api_key=<span class="hljs-string">""</span>,
)

<span class="hljs-comment"># 提示模板定义</span>
chat_prompt_template = ChatPromptTemplate.from_messages(
    [
        <span class="hljs-comment"># 系统角色定义</span>
        (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个{role}专家，可以帮助用户解决问题"</span>),
        <span class="hljs-comment"># 用户输入占位符</span>
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
    ]
)
</code></pre>
<h4 data-id="heading-4">步骤2：封装为工具</h4>
<p>通过 <code>Tool.from_function</code> 方法将自定义函数封装为工具，需明确指定工具名称、功能描述及参数校验模型：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 定义参数模型</span>
class SunArgs(BaseModel):
    <span class="hljs-comment"># 整数类型参数1</span>
    num1: <span class="hljs-attr">int</span> = Field(description=<span class="hljs-string">"第一个数"</span>)
    <span class="hljs-comment"># 整数类型参数2</span>
    num2: <span class="hljs-attr">int</span> = Field(description=<span class="hljs-string">"第二个数"</span>)
    
<span class="hljs-comment"># 定义求和函数</span>
def sum(a, b):
    return a + b

<span class="hljs-attr">sum_tool</span> = Tool.from_function(
    <span class="hljs-comment"># 关联核心函数</span>
    <span class="hljs-attr">func</span>=sum,
    <span class="hljs-comment"># 工具名称（模型调用时识别的名称）</span>
    <span class="hljs-attr">name</span>=<span class="hljs-string">"sum"</span>,
    <span class="hljs-comment"># 工具功能描述（帮助模型判断是否调用）</span>
    <span class="hljs-attr">description</span>=<span class="hljs-string">"计算两个数的和"</span>,
    <span class="hljs-comment"># 参数规范，指定参数类型与描述</span>
    <span class="hljs-attr">args_schema</span>=SunArgs,
)
</code></pre>
<h4 data-id="heading-5">步骤3：绑定工具并执行调用</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 为大模型绑定工具（可绑定多个，传入列表）</span>
<span class="hljs-attr">llm</span> = llm.bind_tools([sum_tool])

<span class="hljs-comment"># 组合提示模板与大模型，形成调用链</span>
<span class="hljs-attr">llm</span> = chat_prompt_template | llm

<span class="hljs-comment"># 调用模型，传入角色与用户需求</span>
<span class="hljs-attr">response</span> = llm.invoke(input={<span class="hljs-string">"role"</span>: <span class="hljs-string">"数学"</span>, <span class="hljs-string">"input"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 解析工具调用结果并执行函数</span>
<span class="hljs-attr">tool_calls</span> = response.tool_calls
for tool_call in tool_calls:
    <span class="hljs-comment"># 匹配工具名称</span>
    if tool_call<span class="hljs-section">["name"]</span> == "sum":
        <span class="hljs-comment"># 获取模型传递的参数</span>
        <span class="hljs-attr">args</span> = tool_call[<span class="hljs-string">"args"</span>]
        <span class="hljs-comment"># 执行函数</span>
        <span class="hljs-attr">result</span> = sum(**args)
        <span class="hljs-comment"># 输出结果：30</span>
        print(result)
</code></pre>
<h3 data-id="heading-6">方案二：通过 @tool 装饰器定义工具（推荐）</h3>
<h4 data-id="heading-7">步骤1：基础依赖与初始化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> Tool
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-comment"># 大模型初始化</span>
llm = ChatOpenAI(
    <span class="hljs-comment"># 模型名称</span>
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    <span class="hljs-comment"># 模型基础地址</span>
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    <span class="hljs-comment"># 填写个人 API Key</span>
    api_key=<span class="hljs-string">""</span>,
)

<span class="hljs-comment"># 提示模板定义</span>
chat_prompt_template = ChatPromptTemplate.from_messages(
    [
        <span class="hljs-comment"># 系统角色定义</span>
        (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个{role}专家，可以帮助用户解决问题"</span>),
        <span class="hljs-comment"># 用户输入占位符</span>
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
    ]
)
</code></pre>
<h4 data-id="heading-8">步骤2：用装饰器定义工具函数</h4>
<p>通过 <code>@tool</code> 装饰器可直接将自定义函数封装为工具，无需额外调用 <code>Tool.from_function</code> 方法，只需关联对应的参数模型即可完成配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 定义参数模型</span>
class SunArgs(BaseModel):
    <span class="hljs-comment"># 整数类型参数1</span>
    num1: <span class="hljs-attr">int</span> = Field(description=<span class="hljs-string">"第一个数"</span>)
    <span class="hljs-comment"># 整数类型参数2</span>
    num2: <span class="hljs-attr">int</span> = Field(description=<span class="hljs-string">"第二个数"</span>)

@tool(
    <span class="hljs-comment"># 工具功能描述</span>
    <span class="hljs-attr">description</span>=<span class="hljs-string">"计算两个数的和"</span>,
    <span class="hljs-comment"># 关联参数模型</span>
    <span class="hljs-attr">args_schema</span>=SunArgs,
)
def sum(num1, num2):
    return num1 + num2
</code></pre>
<h5 data-id="heading-9">步骤3：绑定工具并执行调用</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 绑定工具（直接传入函数，无需额外封装）</span>
<span class="hljs-attr">llm</span> = llm.bind_tools([sum])

<span class="hljs-comment"># 组合提示模板与大模型</span>
<span class="hljs-attr">llm</span> = chat_prompt_template | llm

<span class="hljs-comment"># 调用模型</span>
<span class="hljs-attr">response</span> = llm.invoke(input={<span class="hljs-string">"role"</span>: <span class="hljs-string">"数学"</span>, <span class="hljs-string">"input"</span>: <span class="hljs-string">"计算10和20的和"</span>})

<span class="hljs-comment"># 解析并执行工具调用</span>
for tool_call in response.tool_calls:
    if tool_call<span class="hljs-section">["name"]</span> == "sum":
        <span class="hljs-attr">args</span> = tool_call[<span class="hljs-string">"args"</span>]
        <span class="hljs-comment"># 通过 invoke 方法执行函数</span>
        <span class="hljs-attr">result</span> = sum.invoke(args)
        <span class="hljs-comment"># 输出结果：30</span>
        print(result)
</code></pre>
<h2 data-id="heading-10">核心关键要点</h2>
<ul>
<li><strong>工具调用位置</strong>：工具函数必须部署在服务端执行，大模型仅负责输出工具调用指令，不具备直接执行工具函数的能力，需由后端服务解析指令后触发函数运行。</li>
<li><strong>工具描述精准性</strong>：工具的 <code>description</code> 字段需简洁且精准（例如“计算两个整数的和”），清晰告知模型工具的核心功能，其表述质量直接决定模型能否准确识别需求并触发正确调用。</li>
<li><strong>参数定义规范性</strong>：两种方案均需明确参数的类型与功能描述；推荐使用 <code>Pydantic</code> 的 <code>BaseModel</code> 定义参数模型，该方式可实现参数自动校验，能显著降低模型调用时的参数错误率。</li>
<li><strong>调用结果解析</strong>：需通过 <code>response.tool_calls</code> 获取模型返回的工具调用指令，遍历解析出工具名称与输入参数后，执行对应的工具函数，最终获取执行结果并用于后续响应生成。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在实际项目中，如何根据具体业务场景选择合适的并发容器？]]></title>    <link>https://juejin.cn/post/7588095884069896192</link>    <guid>https://juejin.cn/post/7588095884069896192</guid>    <pubDate>2025-12-27T13:50:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884069896192" data-draft-id="7588092534161801216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在实际项目中，如何根据具体业务场景选择合适的并发容器？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T13:50:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在实际项目中，如何根据具体业务场景选择合适的并发容器？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T13:50:44.000Z" title="Sat Dec 27 2025 13:50:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 什么是并发容器</h2>
<p>在现代多核处理器成为主流的今天，<strong>并发编程</strong>已成为Java开发者的必备技能。传统的集合容器（如ArrayList、HashMap）在单线程环境下表现优异，但在多线程并发访问时会导致<strong>数据竞争</strong>、<strong>内存不一致</strong>甚至<strong>死循环</strong>等问题。</p>
<p>并发容器的核心价值在于通过精妙的锁策略和数据结构优化，在保证线程安全的前提下最大化性能。主要解决三大并发挑战：</p>
<ul>
<li><strong>数据竞争</strong>：当多个线程同时修改同一数据时产生不可预知结果</li>
<li><strong>可见性</strong>：一个线程的修改其他线程无法立即看到</li>
<li><strong>原子性</strong>：复合操作执行过程中被中断导致数据不一致</li>
</ul>
<h2 data-id="heading-1">2. 并发容器分类与适用场景</h2>
<p>下表总结了主要并发容器及其典型应用场景，方便开发者快速选型：</p>





























































<table><thead><tr><th>容器类型</th><th>实现类</th><th>线程安全机制</th><th>适用场景</th><th>性能特点</th></tr></thead><tbody><tr><td><strong>并发Map</strong></td><td>ConcurrentHashMap</td><td>分段锁+CAS（JDK7）、synchronized+CAS（JDK8）</td><td>高并发读写、缓存</td><td>读完全无锁，写锁粒度细</td></tr><tr><td/><td>ConcurrentSkipListMap</td><td>跳表+CAS</td><td>大数据量有序访问、排行榜</td><td>存取O(log n)，支持范围查询</td></tr><tr><td><strong>并发List</strong></td><td>CopyOnWriteArrayList</td><td>写时复制+ReentrantLock</td><td>读多写少（配置、黑名单）</td><td>读无锁，写性能较差</td></tr><tr><td/><td>Vector</td><td>全表锁synchronized</td><td>强一致性低并发场景（已过时）</td><td>全局锁，性能差</td></tr><tr><td><strong>阻塞队列</strong></td><td>ArrayBlockingQueue</td><td>单锁ReentrantLock</td><td>固定大小生产者-消费者</td><td>有界，吞吐量中等</td></tr><tr><td/><td>LinkedBlockingQueue</td><td>双锁分离</td><td>高吞吐任务队列</td><td>可选有界，吞吐量高</td></tr><tr><td><strong>非阻塞队列</strong></td><td>ConcurrentLinkedQueue</td><td>CAS无锁算法</td><td>高并发消息传递</td><td>无锁，ABA问题</td></tr></tbody></table>
<h2 data-id="heading-2">3. Map容器选型：ConcurrentHashMap vs ConcurrentSkipListMap</h2>
<h3 data-id="heading-3">3.1 高并发缓存场景：ConcurrentHashMap</h3>
<p><strong>案例：电商商品销量统计系统</strong></p>
<p>电商平台需要实时统计每个商品的销量，并展示销量TOP 10榜单。这一场景特点包括<strong>高并发写入</strong>（大量用户同时购买）和<strong>实时查询</strong>需求。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 电商销量统计实现</span>
<span class="hljs-title class_">ConcurrentHashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Long</span>&gt; salesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// 线程安全的销量累加</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">incrementSales</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> productId</span>) {
    salesMap.<span class="hljs-title function_">compute</span>(productId, (k, v) -&gt; v == <span class="hljs-literal">null</span> ? <span class="hljs-number">1</span> : v + <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 获取销量前十商品</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getTop10Products</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> salesMap.<span class="hljs-title function_">entrySet</span>().<span class="hljs-title function_">stream</span>()
        .<span class="hljs-title function_">sorted</span>(<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>.&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Long</span>&gt;<span class="hljs-title function_">comparingByValue</span>().<span class="hljs-title function_">reversed</span>())
        .<span class="hljs-title function_">limit</span>(<span class="hljs-number">10</span>)
        .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>::getKey)
        .<span class="hljs-title function_">collect</span>(<span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">toList</span>());
}
</code></pre>
<p><strong>选型理由</strong>：</p>
<ul>
<li>ConcurrentHashMap采用<strong>桶级别锁粒度</strong>，不同线程可同时访问不同哈希桶</li>
<li><strong>弱一致性迭代器</strong>允许在遍历同时进行修改，不抛ConcurrentModificationException</li>
<li>在JDK8中进一步优化为synchronized+CAS，性能更优</li>
</ul>
<h3 data-id="heading-4">3.2 大数据量有序场景：ConcurrentSkipListMap</h3>
<p><strong>案例：手机流量实时监控系统</strong></p>
<p>运营商系统需要存储数千万用户的实时流量数据，支持高并发更新和范围查询（如查询流量使用前100的用户）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">ConcurrentSkipListMap</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">TrafficData</span>&gt; trafficMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentSkipListMap</span>&lt;&gt;();

<span class="hljs-comment">// 插入用户流量数据</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserTraffic</span>(<span class="hljs-params">Long userId, TrafficData data</span>) {
    trafficMap.<span class="hljs-title function_">put</span>(userId, data);
}

<span class="hljs-comment">// 查询流量前100的用户</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">TrafficData</span>&gt; <span class="hljs-title function_">getTop100Users</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> trafficMap.<span class="hljs-title function_">descendingMap</span>().<span class="hljs-title function_">headMap</span>(100L);
}
</code></pre>
<p><strong>选型理由</strong>：</p>
<ul>
<li><strong>跳表结构</strong>支持O(log n)的查询、插入和删除操作</li>
<li>天然<strong>有序性</strong>支持范围查询和排序操作</li>
<li>与红黑树相比，跳表在并发环境下<strong>锁竞争更少</strong>，因为只需锁定局部节点</li>
</ul>
<h2 data-id="heading-5">4. List容器选型：CopyOnWriteArrayList的精准应用</h2>
<h3 data-id="heading-6">4.1 读多写少场景典范</h3>
<p><strong>案例：用户黑名单管理系统</strong></p>
<p>电商系统需要维护用户黑名单，拦截恶意用户参与秒杀活动。这一场景<strong>读多写少</strong>特点明显：每秒数千次查询请求，每天仅更新1-2次黑名单。</p>
<pre><code class="hljs language-scss" lang="scss">CopyOnWriteArrayList&lt;Long&gt; blacklist = new CopyOnWriteArrayList&lt;&gt;();

<span class="hljs-comment">// 后台定时更新黑名单（低频率写）</span>
scheduledExecutor<span class="hljs-selector-class">.scheduleAtFixedRate</span>(() -&gt; {
    List&lt;Long&gt; newList = <span class="hljs-built_in">fetchLatestBlacklistFromDB</span>();
    blacklist<span class="hljs-selector-class">.clear</span>();
    blacklist<span class="hljs-selector-class">.addAll</span>(newList);
}, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, TimeUnit<span class="hljs-selector-class">.HOURS</span>);

<span class="hljs-comment">// 高频查询（无锁）</span>
public boolean <span class="hljs-built_in">isUserBlocked</span>(Long userId) {
    return blacklist<span class="hljs-selector-class">.contains</span>(userId);
}
</code></pre>
<p><strong>选型理由</strong>：</p>
<ul>
<li><strong>写时复制</strong>机制保证读操作完全无锁，性能极高</li>
<li>适合<strong>数据量不大</strong>且<strong>写操作频率低</strong>的场景</li>
<li>允许<strong>弱一致性</strong>，读操作可能短暂看到旧数据</li>
</ul>
<h3 data-id="heading-7">4.2 避坑指南：误用场景分析</h3>
<p><strong>错误案例：实时聊天消息列表</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误用法：频繁写入的聊天室</span>
<span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;<span class="hljs-title class_">String</span>&gt; chatMessages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();

<span class="hljs-comment">// 每个新消息都会复制整个数组</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addChatMessage</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
    chatMessages.<span class="hljs-title function_">add</span>(message); <span class="hljs-comment">// 频繁复制导致内存暴涨</span>
}
</code></pre>
<p><strong>后果</strong>：聊天消息频繁写入会导致<strong>内存暴涨</strong>和<strong>频繁Full GC</strong>，严重影响系统性能。</p>
<p><strong>正确替代方案</strong>：考虑使用ConcurrentLinkedQueue或LinkedBlockingQueue。</p>
<h2 data-id="heading-8">5. 并发队列选型：阻塞vs非阻塞</h2>
<h3 data-id="heading-9">5.1 生产者-消费者模式：BlockingQueue系列</h3>
<p><strong>案例：线程池任务调度系统</strong></p>
<p>需要实现任务提交与执行的解耦，控制资源使用防止内存溢出。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 固定大小的任务队列</span>
<span class="hljs-title class_">BlockingQueue</span>&lt;<span class="hljs-title class_">Runnable</span>&gt; taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>);

<span class="hljs-comment">// 生产者提交任务</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">submitTask</span>(<span class="hljs-params">Runnable task</span>) {
    <span class="hljs-keyword">try</span> {
        taskQueue.<span class="hljs-title function_">put</span>(task); <span class="hljs-comment">// 队列满时自动阻塞</span>
    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
        <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
    }
}

<span class="hljs-comment">// 消费者处理任务</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processTasks</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-title class_">Runnable</span> task = taskQueue.<span class="hljs-title function_">take</span>(); <span class="hljs-comment">// 队列空时自动阻塞</span>
        executor.<span class="hljs-title function_">execute</span>(task);
    }
}
</code></pre>
<p><strong>选型对比</strong>：</p>
<ul>
<li><strong>ArrayBlockingQueue</strong>：固定大小，内存控制性好，适合<strong>资源受限</strong>环境</li>
<li><strong>LinkedBlockingQueue</strong>：默认无界（实际为Integer.MAX_VALUE），<strong>吞吐量更高</strong>，适合<strong>任务量波动大</strong>的场景</li>
<li><strong>SynchronousQueue</strong>：不存储元素，直接传递，适合<strong>高吞吐</strong>的线程池工作队列</li>
</ul>
<h3 data-id="heading-10">5.2 高吞吐消息传递：ConcurrentLinkedQueue</h3>
<p><strong>案例：订单处理系统中的异步消息</strong></p>
<p>需要高并发非阻塞的任务分发，避免线程阻塞影响系统响应。</p>
<pre><code class="hljs language-csharp" lang="csharp">ConcurrentLinkedQueue&lt;OrderEvent&gt; eventQueue = <span class="hljs-keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();

<span class="hljs-comment">// 多生产者并发提交</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">submitOrderEvent</span>(<span class="hljs-params">OrderEvent <span class="hljs-keyword">event</span></span>)</span> {
    eventQueue.offer(<span class="hljs-keyword">event</span>); <span class="hljs-comment">// 无阻塞插入</span>
}

<span class="hljs-comment">// 批量处理提升效率</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processEventsBatch</span>()</span> {
    List&lt;OrderEvent&gt; batch = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-number">100</span>);
    OrderEvent <span class="hljs-keyword">event</span>;
    
    <span class="hljs-comment">// 批量获取减少锁竞争</span>
    <span class="hljs-keyword">while</span> ((<span class="hljs-keyword">event</span> = eventQueue.poll()) != <span class="hljs-literal">null</span> &amp;&amp; batch.size() &lt; <span class="hljs-number">100</span>) {
        batch.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">event</span>);
    }
    
    <span class="hljs-keyword">if</span> (!batch.isEmpty()) {
        processBatch(batch);
    }
}
</code></pre>
<p><strong>选型理由</strong>：</p>
<ul>
<li><strong>完全无锁</strong>实现，依赖CAS操作避免线程阻塞</li>
<li>适合<strong>高并发</strong>且<strong>处理速度匹配</strong>的场景</li>
<li>注意可能的<strong>ABA问题</strong>（但Java实现已解决）</li>
</ul>
<h2 data-id="heading-11">6. 一致性要求与性能权衡</h2>
<h3 data-id="heading-12">6.1 强一致性场景的特殊考量</h3>
<p><strong>案例：金融交易配置管理</strong></p>
<p>在低并发但要求强一致性的配置管理场景中，有时仍需考虑传统容器。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 强一致性配置管理</span>
Hashtable&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; config = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;();

<span class="hljs-comment">// 或者使用同步包装器</span>
Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; syncMap = Collections.<span class="hljs-built_in">synchronizedMap</span>(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li><strong>配置信息</strong>读取和更新</li>
<li><strong>低频操作</strong>但需要立即可见的场景</li>
<li>替代方案：考虑使用<strong>显式锁控制</strong>的普通HashMap</li>
</ul>
<h3 data-id="heading-13">6.2 弱一致性的合理利用</h3>
<p>大部分并发容器（ConcurrentHashMap、CopyOnWriteArrayList）提供<strong>弱一致性</strong>保证，这在实际业务中通常是可接受的。</p>
<p><strong>可接受场景</strong>：</p>
<ul>
<li>商品库存缓存（短暂不一致不影响业务）</li>
<li>用户会话信息（秒级延迟可接受）</li>
<li>监控指标统计（允许少量数据误差）</li>
</ul>
<h2 data-id="heading-14">7. 综合选型策略与性能调优</h2>
<h3 data-id="heading-15">7.1 选型决策树</h3>
<ol>
<li><strong>确定数据结构类型</strong>（Map、List、Queue）</li>
<li><strong>分析读写比例</strong>（读多写少vs写多读少）</li>
<li><strong>评估数据量级</strong>（小数据vs大数据量）</li>
<li><strong>明确一致性要求</strong>（强一致vs弱一致）</li>
<li><strong>考虑有序性需求</strong>（是否需要排序）</li>
</ol>
<h3 data-id="heading-16">7.2 性能优化实践</h3>
<ol>
<li><strong>合理初始化容量</strong>避免频繁扩容</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ConcurrentHashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; cache = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">16</span>, <span class="hljs-number">0.</span>75f, <span class="hljs-number">8</span>); <span class="hljs-comment">// 指定初始容量和并发级别</span>
</code></pre>
<ol>
<li><strong>利用原子操作</strong>避免显式锁</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 使用原子操作方法</span>
map.<span class="hljs-built_in">computeIfAbsent</span>(<span class="hljs-string">"key"</span>, k -&gt; <span class="hljs-built_in">createExpensiveValue</span>(k));
map.<span class="hljs-built_in">merge</span>(<span class="hljs-string">"counter"</span>, <span class="hljs-number">1L</span>, Long::sum);
</code></pre>
<ol>
<li><strong>批量操作</strong>减少锁竞争频率</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量处理减少锁粒度</span>
<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Object</span>&gt; batch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-comment">// ... 收集一批操作</span>
list.<span class="hljs-title function_">addAll</span>(batch); <span class="hljs-comment">// 单次锁获取</span>
</code></pre>
<h2 data-id="heading-17">8. 总结</h2>
<p>在实际项目中选择合适的并发容器，需要综合考虑<strong>业务场景</strong>、<strong>数据特征</strong>和<strong>性能要求</strong>三大因素。没有绝对的"最佳"容器，只有针对特定场景的"最合适"选择。</p>
<p><strong>核心选型原则</strong>：</p>
<ul>
<li>读多写少优先考虑CopyOnWrite系列</li>
<li>高并发读写Map首选ConcurrentHashMap</li>
<li>生产者-消费者模式使用BlockingQueue</li>
<li>大数据量有序场景选择ConcurrentSkipListMap</li>
<li>高吞吐非阻塞场景考虑ConcurrentLinkedQueue</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1实现通用微任务调度器：理解前端异步调度核心]]></title>    <link>https://juejin.cn/post/7588149079416864822</link>    <guid>https://juejin.cn/post/7588149079416864822</guid>    <pubDate>2025-12-27T12:41:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079416864822" data-draft-id="7588152122186448950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1实现通用微任务调度器：理解前端异步调度核心"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T12:41:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1实现通用微任务调度器：理解前端异步调度核心
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:41:41.000Z" title="Sat Dec 27 2025 12:41:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从0到1实现通用微任务调度器：理解前端异步调度核心</h2>
<p>微任务（Microtask）是前端异步编程的核心概念，广泛应用于Vue/react的更新、Promise回调、事件循环优化等场景。手动实现一个通用的微任务调度器，不仅能加深对事件循环的理解，还能解决「批量执行异步任务、统一控制执行时机」的实际开发需求。</p>
<p>本文将从「最小可用版」到「生产级优化版」，一步步拆解微任务调度器的实现思路，最终给出可直接复用的完整代码。</p>
<h3 data-id="heading-1">一、核心需求与设计思路</h3>
<h4 data-id="heading-2">1. 要解决的问题</h4>
<p>在前端开发中，频繁触发的异步任务（如多次更新DOM、批量数据处理）如果直接执行，会导致多次微任务创建，增加性能开销。我们需要：</p>
<ul>
<li>
<p>批量管理任务，去重且统一在微任务队列执行；</p>
</li>
<li>
<p>支持任务执行前/后的回调（如初始化/清理逻辑）；</p>
</li>
<li>
<p>外部可通过<code>await</code>等待所有任务执行完成；</p>
</li>
<li>
<p>兼容浏览器/Node.js环境（处理<code>queueMicrotask</code> API兼容性）。</p>
</li>
</ul>
<h4 data-id="heading-3">2. 核心设计原则</h4>
<ul>
<li>
<p><strong>去重执行</strong>：用<code>Set</code>存储任务，避免重复添加；</p>
</li>
<li>
<p><strong>防重复调度</strong>：标记是否已将执行逻辑放入微任务队列，避免多次触发；</p>
</li>
<li>
<p><strong>状态隔离</strong>：用私有属性封装内部状态（如<code>isFlushing</code>），对外暴露可控的API；</p>
</li>
<li>
<p><strong>兼容降级</strong>：无<code>queueMicrotask</code>时，用<code>Promise.resolve().then()</code>兜底。</p>
</li>
</ul>
<h3 data-id="heading-4">二、Step 1：实现最小可用版调度器</h3>
<p>先搭建核心骨架，完成「添加任务、批量执行」的基础能力，暂不处理回调、异常、兼容等细节。</p>
<h4 data-id="heading-5">1. 定义基础类型</h4>
<p>先明确核心类型，让代码语义更清晰：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 待执行的任务类型（无参无返回值函数）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TaskToQueue</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 取消回调的函数类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Unsubscribe</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
</code></pre>
<h4 data-id="heading-6">2. 核心类实现（最小版）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 最小可用版微任务调度器
 * 核心能力：添加任务、批量在微任务执行、防重复调度
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MicroScheduler</span> {
  <span class="hljs-comment">// 任务队列：Set自动去重</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">TaskToQueue</span>&gt;();
  <span class="hljs-comment">// 标记是否已调度微任务执行（防重复）</span>
  <span class="hljs-keyword">private</span> isFlushScheduled = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 标记是否正在执行任务（避免嵌套执行）</span>
  <span class="hljs-keyword">private</span> isFlushing = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">/**
   * 添加任务到队列，并触发调度
   */</span>
  <span class="hljs-title function_">enqueue</span>(<span class="hljs-attr">task</span>: <span class="hljs-title class_">TaskToQueue</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">add</span>(task);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleFlush</span>();
  }

  <span class="hljs-comment">/**
   * 调度任务执行到微任务队列（核心：防重复调度）
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">scheduleFlush</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 已调度/正在执行，直接返回</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 核心：将执行逻辑放入微任务队列</span>
    <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTasks</span>();
    });
  }

  <span class="hljs-comment">/**
   * 批量执行所有任务
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">executeTasks</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 遍历执行所有任务，执行后从队列移除</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> {
      <span class="hljs-title function_">task</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">delete</span>(task);
    });

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<h4 data-id="heading-7">3. 测试最小版功能</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 实例化调度器</span>
<span class="hljs-keyword">const</span> scheduler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MicroScheduler</span>();

<span class="hljs-comment">// 添加2个任务（故意重复添加，测试去重）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">task1</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行任务1'</span>);
scheduler.<span class="hljs-title function_">enqueue</span>(task1);
scheduler.<span class="hljs-title function_">enqueue</span>(task1); <span class="hljs-comment">// 重复添加，Set会自动去重</span>
scheduler.<span class="hljs-title function_">enqueue</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行任务2'</span>));

<span class="hljs-comment">// 输出结果（微任务阶段执行）：</span>
<span class="hljs-comment">// 执行任务1</span>
<span class="hljs-comment">// 执行任务2</span>
</code></pre>
<h4 data-id="heading-8">关键逻辑说明</h4>
<ul>
<li>
<p><code>scheduleFlush</code>：核心防重复逻辑，确保多次调用<code>enqueue</code>仅触发一次微任务；</p>
</li>
<li>
<p><code>isFlushing</code>：避免执行任务时嵌套调用<code>executeTasks</code>（如任务中再次<code>enqueue</code>）；</p>
</li>
<li>
<p><code>Set</code>存储任务：天然解决重复添加问题，比数组更高效。</p>
</li>
</ul>
<h3 data-id="heading-9">三、Step 2：扩展核心能力</h3>
<p>在最小版基础上，添加「同步执行、前后回调、外部等待」能力，逐步完善功能。</p>
<h4 data-id="heading-10">1. 添加同步执行方法<code>flushSync</code></h4>
<p>支持手动同步执行任务（不等待微任务）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 同步触发任务执行（立即执行，不等待微任务）
 */</span>
<span class="hljs-title function_">flushSync</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTasks</span>();
}
</code></pre>
<h4 data-id="heading-11">2. 添加执行前/后回调</h4>
<p>支持注册/取消「执行前/后」的回调，满足初始化、清理等场景：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 新增：执行前/后回调队列</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> beforeFlushCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> afterFlushCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;();

<span class="hljs-comment">/**
 * 注册「任务执行前」的回调
 * <span class="hljs-doctag">@returns</span> 取消回调的函数
 */</span>
<span class="hljs-title function_">onBeforeFlush</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>.<span class="hljs-title function_">add</span>(callback);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>.<span class="hljs-title function_">delete</span>(callback);
}

<span class="hljs-comment">/**
 * 注册「任务执行后」的回调
 */</span>
<span class="hljs-title function_">onAfterFlush</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>.<span class="hljs-title function_">add</span>(callback);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>.<span class="hljs-title function_">delete</span>(callback);
}

<span class="hljs-comment">// 改造executeTasks：执行前后回调</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">executeTasks</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 1. 执行前置回调</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> <span class="hljs-title function_">cb</span>());

  <span class="hljs-comment">// 2. 执行任务</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> {
    <span class="hljs-title function_">task</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">delete</span>(task);
  });

  <span class="hljs-comment">// 3. 执行后置回调</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> <span class="hljs-title function_">cb</span>());

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-12">3. 支持外部<code>await</code>等待执行完成</h4>
<p>添加<code>tick</code>属性，基于固定的<code>Promise</code>实现外部等待（核心：用初始化的<code>Promise</code>做「时间锚点」，避免每次创建新Promise导致等待失效）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 新增：固定的微任务Promise（仅初始化一次）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> microtaskPromise = <span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-literal">undefined</span>);

<span class="hljs-comment">// 公开只读属性：外部可await</span>
<span class="hljs-keyword">readonly</span> tick = <span class="hljs-variable language_">this</span>.<span class="hljs-property">microtaskPromise</span>;
</code></pre>
<h4 data-id="heading-13">测试扩展能力</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> scheduler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MicroScheduler</span>();

<span class="hljs-comment">// 注册前后回调</span>
<span class="hljs-keyword">const</span> unsubBefore = scheduler.<span class="hljs-title function_">onBeforeFlush</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务执行前'</span>));
scheduler.<span class="hljs-title function_">onAfterFlush</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务执行后'</span>));

<span class="hljs-comment">// 添加任务</span>
scheduler.<span class="hljs-title function_">enqueue</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行任务'</span>));

<span class="hljs-comment">// 外部等待任务执行完成</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> scheduler.<span class="hljs-property">tick</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有任务执行完毕'</span>);
  <span class="hljs-title function_">unsubBefore</span>(); <span class="hljs-comment">// 取消前置回调</span>
}

<span class="hljs-title function_">test</span>();

<span class="hljs-comment">// 输出顺序：</span>
<span class="hljs-comment">// 任务执行前</span>
<span class="hljs-comment">// 执行任务</span>
<span class="hljs-comment">// 任务执行后</span>
<span class="hljs-comment">// 所有任务执行完毕</span>
</code></pre>
<h3 data-id="heading-14">四、Step 3：兼容与容错优化（生产级）</h3>
<p>完成核心功能后，添加「环境兼容、参数校验、异常捕获」，让代码更健壮。</p>
<h4 data-id="heading-15">1. 兼容<code>queueMicrotask</code> API</h4>
<p>Node.js和部分老浏览器可能未实现<code>queueMicrotask</code>，需降级到<code>Promise</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 声明全局queueMicrotask类型（兼容TS）</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">queueMicrotask</span>: (<span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">undefined</span>;

<span class="hljs-comment">// 新增：兼容后的微任务执行函数</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">queueMicrotaskFn</span>: <span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 改造构造函数：初始化兼容函数</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">queueMicrotaskFn</span> =
    <span class="hljs-keyword">typeof</span> queueMicrotask !== <span class="hljs-string">'undefined'</span>
      ? queueMicrotask
      : <span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">microtaskPromise</span>.<span class="hljs-title function_">then</span>(cb);
}

<span class="hljs-comment">// 改造scheduleFlush：使用兼容后的函数</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">scheduleFlush</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queueMicrotaskFn</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTasks</span>();
  });
}
</code></pre>
<h4 data-id="heading-16">2. 添加参数校验</h4>
<p>避免传入非函数类型的任务/回调：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 改造enqueue</span>
<span class="hljs-title function_">enqueue</span>(<span class="hljs-attr">task</span>: <span class="hljs-title class_">TaskToQueue</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> task !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'enqueue 必须传入函数类型的任务'</span>);
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">add</span>(task);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleFlush</span>();
}

<span class="hljs-comment">// 封装回调注册逻辑，添加校验</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">registerCallback</span>(<span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;, <span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'回调必须是函数类型'</span>);
  }
  callbacks.<span class="hljs-title function_">add</span>(callback);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> callbacks.<span class="hljs-title function_">delete</span>(callback);
}

<span class="hljs-comment">// 改造onBeforeFlush/onAfterFlush，复用校验逻辑</span>
<span class="hljs-title function_">onBeforeFlush</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>, callback);
}

<span class="hljs-title function_">onAfterFlush</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>, callback);
}
</code></pre>
<h4 data-id="heading-17">3. 异常捕获（容错）</h4>
<p>单个任务/回调执行失败，不影响整体流程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">executeTasks</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 执行前置回调（捕获单个回调异常）</span>
    <span class="hljs-keyword">const</span> beforeCallbacks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>);
    beforeCallbacks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">cb</span>();
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'执行前置回调失败:'</span>, e);
      }
    });

    <span class="hljs-comment">// 2. 执行任务（复制队列，避免迭代时修改）</span>
    <span class="hljs-keyword">const</span> tasks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>);
    tasks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">task</span>();
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'执行任务失败:'</span>, e);
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">delete</span>(task);
    });
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 无论是否出错，都执行后置回调+重置状态</span>
    <span class="hljs-keyword">const</span> afterCallbacks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>);
    afterCallbacks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">cb</span>();
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'执行后置回调失败:'</span>, e);
      }
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<h3 data-id="heading-18">五、完整生产级代码</h3>
<p>整合所有优化，最终的完整代码如下（可直接复制复用）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 类型命名更精准，贴合场景</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TaskToQueue</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
<span class="hljs-comment">// 取消回调的函数类型（语义更清晰）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Unsubscribe</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 声明全局 queueMicrotask 类型（兼容 Node.js 和浏览器环境）</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">queueMicrotask</span>: (<span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">undefined</span>;

<span class="hljs-comment">/**
 * 微任务调度器类
 * 核心能力：批量管理任务，统一在微任务队列执行，支持执行前后回调
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MicroScheduler</span> {
  <span class="hljs-comment">// ========== 私有属性（封装，外部不可访问） ==========</span>
  <span class="hljs-comment">// 任务队列：Set 自动去重，避免重复执行</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">TaskToQueue</span>&gt;();
  <span class="hljs-comment">// 执行前回调队列</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> beforeFlushCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;();
  <span class="hljs-comment">// 执行后回调队列</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> afterFlushCallbacks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;();
  <span class="hljs-comment">// 标记是否正在执行任务</span>
  <span class="hljs-keyword">private</span> isFlushing = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 标记是否已将 flush 调度到微任务队列</span>
  <span class="hljs-keyword">private</span> isFlushScheduled = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 固定的微任务 Promise，用于外部 await 等待执行完成（仅初始化一次）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> microtaskPromise = <span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-literal">undefined</span>);
  <span class="hljs-comment">// 兼容后的微任务执行函数（适配无 queueMicrotask 的环境）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">queueMicrotaskFn</span>: <span class="hljs-function">(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-comment">// ========== 公开只读属性（外部可访问，不可修改） ==========</span>
  <span class="hljs-comment">/**
   * 用于等待微任务执行完成的 Promise
   * 外部可通过 await scheduler.tick 等待任务执行完毕
   */</span>
  <span class="hljs-keyword">readonly</span> tick = <span class="hljs-variable language_">this</span>.<span class="hljs-property">microtaskPromise</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 兼容 queueMicrotask API（前端工程化必备）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queueMicrotaskFn</span> =
      <span class="hljs-keyword">typeof</span> queueMicrotask !== <span class="hljs-string">'undefined'</span>
        ? queueMicrotask
        : <span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">microtaskPromise</span>.<span class="hljs-title function_">then</span>(cb);
  }

  <span class="hljs-comment">// ========== 公开方法（外部可调用） ==========</span>
  <span class="hljs-comment">/**
   * 添加任务到调度队列，并触发异步执行调度
   * <span class="hljs-doctag">@param</span> task 待执行的微任务（无参无返回值函数）
   */</span>
  <span class="hljs-title function_">enqueue</span>(<span class="hljs-attr">task</span>: <span class="hljs-title class_">TaskToQueue</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> task !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'enqueue 必须传入函数类型的任务'</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">add</span>(task);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleFlush</span>();
  }

  <span class="hljs-comment">/**
   * 异步触发任务批量执行（放入微任务队列）
   * 多次调用仅会触发一次微任务，避免重复执行
   */</span>
  <span class="hljs-title function_">flush</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleFlush</span>();
  }

  <span class="hljs-comment">/**
   * 同步触发任务批量执行（立即执行，不等待微任务）
   */</span>
  <span class="hljs-title function_">flushSync</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTasks</span>();
  }

  <span class="hljs-comment">/**
   * 注册「任务执行前」的回调
   * <span class="hljs-doctag">@param</span> callback 执行前的回调函数
   * <span class="hljs-doctag">@returns</span> 取消回调的函数（调用后不再触发该回调）
   */</span>
  <span class="hljs-title function_">onBeforeFlush</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>, callback);
  }

  <span class="hljs-comment">/**
   * 注册「任务执行后」的回调
   * <span class="hljs-doctag">@param</span> callback 执行后的回调函数
   * <span class="hljs-doctag">@returns</span> 取消回调的函数（调用后不再触发该回调）
   */</span>
  <span class="hljs-title function_">onAfterFlush</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerCallback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>, callback);
  }

  <span class="hljs-comment">// ========== 私有方法（内部逻辑，对外隐藏） ==========</span>
  <span class="hljs-comment">/**
   * 调度 flush 到微任务队列（核心：防重复调度）
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">scheduleFlush</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queueMicrotaskFn</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushScheduled</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTasks</span>();
    });
  }

  <span class="hljs-comment">/**
   * 核心执行逻辑：执行前后回调 + 批量执行任务
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">executeTasks</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 执行前置回调（复制后遍历，避免迭代时修改）</span>
      <span class="hljs-keyword">const</span> beforeCallbacks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeFlushCallbacks</span>);
      beforeCallbacks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">cb</span>();
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'调度器执行前置回调失败:'</span>, e);
        }
      });

      <span class="hljs-comment">// 2. 执行所有任务（复制后遍历，避免迭代时修改队列）</span>
      <span class="hljs-keyword">const</span> tasks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>);
      tasks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">task</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">task</span>();
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-comment">// 捕获单个任务异常，不影响其他任务执行（前端容错最佳实践）</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'调度器执行任务失败:'</span>, e);
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">delete</span>(task);
      });
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-comment">// 无论是否出错，都重置状态 + 执行后置回调</span>
      <span class="hljs-keyword">const</span> afterCallbacks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">afterFlushCallbacks</span>);
      afterCallbacks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">cb</span>();
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'调度器执行后置回调失败:'</span>, e);
        }
      });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFlushing</span> = <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">/**
   * 注册回调并返回取消函数（复用逻辑）
   * <span class="hljs-doctag">@param</span> callbacks 回调队列
   * <span class="hljs-doctag">@param</span> callback 要注册的回调函数
   * <span class="hljs-doctag">@returns</span> 取消回调的函数
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">registerCallback</span>(<span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>&gt;, <span class="hljs-attr">callback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Unsubscribe</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'回调必须是函数类型'</span>);
    }
    callbacks.<span class="hljs-title function_">add</span>(callback);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> callbacks.<span class="hljs-title function_">delete</span>(callback);
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MicroScheduler</span>;
</code></pre>
<h3 data-id="heading-19">六、使用场景与扩展方向</h3>
<h4 data-id="heading-20">1. 典型使用场景</h4>
<ul>
<li>
<p><strong>批量DOM更新</strong>：多次修改DOM的任务加入调度器，避免频繁重排重绘；</p>
</li>
<li>
<p><strong>状态管理库</strong>：如Vue的响应式更新，批量执行依赖收集后的回调；</p>
</li>
<li>
<p><strong>异步数据处理</strong>：批量处理接口返回的数据，统一执行后续逻辑。</p>
</li>
</ul>
<h4 data-id="heading-21">2. 扩展方向</h4>
<ul>
<li>
<p>添加「任务优先级」：区分高/低优先级任务，按优先级执行；</p>
</li>
<li>
<p>支持「任务超时」：设置任务执行超时时间，超时后抛出异常；</p>
</li>
<li>
<p>增加「任务统计」：记录任务执行数量、耗时，便于性能监控。</p>
</li>
</ul>
<h3 data-id="heading-22">七、总结</h3>
<p>实现微任务调度器的核心是「理解事件循环+控制执行时机」：</p>
<ol>
<li>
<p>用<code>Set</code>管理任务，解决重复执行问题；</p>
</li>
<li>
<p>用<code>isFlushScheduled/isFlushing</code>控制调度时机，避免重复执行；</p>
</li>
<li>
<p>用固定的<code>Promise</code>做时间锚点，支持外部可靠等待；</p>
</li>
<li>
<p>兼容环境+异常捕获，保证生产环境可用。</p>
</li>
</ol>
<p>从「最小可用版」到「生产级优化版」的实现过程，不仅能掌握微任务的核心逻辑，还能学习到前端工程化的最佳实践（封装、兼容、容错）。希望本文能帮助你理解异步调度的本质，也能在实际项目中落地这个通用的微任务调度器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mybatis入门到精通 一]]></title>    <link>https://juejin.cn/post/7588084804093280294</link>    <guid>https://juejin.cn/post/7588084804093280294</guid>    <pubDate>2025-12-27T12:44:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588084804093280294" data-draft-id="7588084804093263910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mybatis入门到精通 一"/> <meta itemprop="keywords" content="Java,MyBatis,源码阅读"/> <meta itemprop="datePublished" content="2025-12-27T12:44:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员侠客行"/> <meta itemprop="url" content="https://juejin.cn/user/556801719828361"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mybatis入门到精通 一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/556801719828361/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员侠客行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:44:30.000Z" title="Sat Dec 27 2025 12:44:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Java项目开发中，只要使用了关系型数据库，几乎都会用到Mybatis框架。从本文起，我们一起来看看Mybatis的源码实现，从而深入掌握这个框架。</p>
<p>本文从JDBC规范说起，直接使用java.sql包编程，展示了使用底层API做实战开发不可避免的痛点；当引入Mybatis时，又是如何的高效、灵活。进而介绍了Mybatis框架的功能架构和配置解析流程。</p>
<h2 data-id="heading-1">一 什么是JDBC</h2>
<p>JDBC（Java Database Connectivity）是Java中访问关系型数据库的一套规范化API，将Java应用中使用它，可以执行SQL语句、检索结果和更改数据等。</p>
<h3 data-id="heading-2">1.1 示例</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.DriverManager;
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;
<span class="hljs-keyword">import</span> java.sql.ResultSet;
<span class="hljs-keyword">import</span> java.sql.SQLException;

<span class="hljs-comment">/**
 * JDBC 查询 MySQL 用户
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcExample</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DB_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/test_db?useSSL=false&amp;serverTimezone=UTC&amp;allowPublicKeyRetrieval=true"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DB_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">"root"</span>;       <span class="hljs-comment">// 你的数据库用户名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DB_PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456"</span>; <span class="hljs-comment">// 你的数据库密码</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException {
        <span class="hljs-comment">// 1. 加载驱动（MySQL 8.0+ 可省略，Driver 类会自动注册）</span>
        Class.forName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);

        <span class="hljs-keyword">try</span> (
            <span class="hljs-comment">// 获取数据库连接</span>
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            <span class="hljs-comment">// 预编译 SQL（防止 SQL 注入）</span>
            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt</span> <span class="hljs-operator">=</span> conn.prepareStatement(<span class="hljs-string">"SELECT id, username, age, email FROM user WHERE age &gt; ?"</span>);
        ) {
            <span class="hljs-comment">// 3. 设置 SQL 参数（索引从 1 开始）</span>
            pstmt.setInt(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>);
            <span class="hljs-comment">// 4. 执行查询，获取结果集</span>
            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> pstmt.executeQuery();
            <span class="hljs-comment">// 5. 遍历结果集</span>
            <span class="hljs-keyword">while</span> (rs.next()) {
                <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> rs.getInt(<span class="hljs-string">"id"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">"username"</span>);
                <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> rs.getInt(<span class="hljs-string">"age"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">email</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">"email"</span>);
                System.out.printf(<span class="hljs-string">"ID: %d, 用户名: %s, 年龄: %d, 邮箱: %s%n"</span>, id, username, age, email);
            }
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            System.err.println(<span class="hljs-string">"JDBC 操作异常："</span>);
        }
    }
}
</code></pre>
<p>上面示例中出现了JDBC中几个核心类：Driver、DriverManager、Connection、PreparedStatement、ResultSet</p>





























<table><thead><tr><th><strong>核心类</strong></th><th><strong>核心作用</strong></th></tr></thead><tbody><tr><td><code>Driver</code></td><td>注册驱动，建立通信桥梁，适配不同数据库（如MySQL/Oracle）</td></tr><tr><td><code>DriverManager</code></td><td>管理驱动，获取数据库连接</td></tr><tr><td><code>Connection</code></td><td>代表数据库物理连接，所有操作入口，实现事务管理、创建<code>Statement</code></td></tr><tr><td><code>PreparedStatement</code></td><td><code>Statement</code>接口实现，预编译 SQL，能防注入、提升性能</td></tr><tr><td><code>ResultSet</code></td><td>存储查询结果，提供取值能力</td></tr></tbody></table>
<h3 data-id="heading-3">1.2 不足之处</h3>
<p>在项目实战中，使用示例代码操作数据库，存在很多不足。</p>





































<table><thead><tr><th><strong>不足点</strong></th><th><strong>具体表现</strong></th></tr></thead><tbody><tr><td>代码冗余且重复</td><td>① 每次操作需重复写加载驱动、获取连接、创建 Statement、关闭资源等模板代码；② 遍历 ResultSet 封装用户对象</td></tr><tr><td>SQL 与 Java 代码耦合</td><td>SQL 语句硬编码在 Java 代码中，修改 SQL 需重新编译 Java 代码。</td></tr><tr><td>手动处理参数 / 结果集</td><td>① 参数需手动绑定，参数索引易出错；② 结果集需手动封装为对象，字段映射繁琐且易漏。</td></tr><tr><td>资源管理易出问题</td><td>用 try-with-resources，在 finally 手动关闭Connection/ResultSet</td></tr><tr><td>事务管理繁琐</td><td>需手动调用<code>conn.setAutoCommit(false)</code>/<code>commit()</code>/<code>rollback()</code>，多表操作时事务控制代码分散。</td></tr><tr><td>无缓存 / 性能优化能力</td><td>每次查询均直接访问数据库，无 SQL 缓存、结果缓存机制；分页、批量操作需手写 SQL</td></tr><tr><td>数据库适配性差</td><td>切换数据库时，需修改连接 URL、驱动类、SQL 语法（如分页、函数），代码改动量大。</td></tr></tbody></table>
<p>直接使用 JDBC 相当于 “手动搬砖”，需关注所有底层细节（资源、参数、SQL、事务），开发效率低、易出错、维护成本高。</p>
<p><strong>因此，Mybatis出现了，它</strong> <strong>封装了 JDBC 所有冗余且易出错的细节</strong> <strong>，既解决上述痛点，又避免了全自动化 ORM（如 Hibernate）对 SQL 的过度封装，是 Java 项目中数据库操作的最优解之一。</strong></p>
<h2 data-id="heading-4">二 初识Mybatis</h2>
<p>MyBatis 作为 JDBC 的轻量级封装框架，有以下核心价值：</p>
<ol>
<li>消除模板代码，提升开发效率</li>
</ol>
<ul>
<li>MyBatis 封装了连接获取、资源关闭、Statement 创建等冗余逻辑，通过<code>SqlSession</code>统一管理操作入口，无需重复编写模板代码；</li>
<li>内置结果集自动映射：MyBatis 可自动将 ResultSet 字段映射到实体类属性，无需手动<code>getXxx()</code>封装。</li>
</ul>
<ol start="2">
<li>SQL 与代码解耦，便于维护</li>
</ol>
<ul>
<li>SQL 集中写在 XML 映射文件或注解中，修改 SQL 无需编译 Java 代码；</li>
<li>支持动态 SQL（<code>&lt;if&gt;</code>/<code>&lt;where&gt;</code>/<code>&lt;foreach&gt;</code>），解决 JDBC 中拼接 SQL 的痛点</li>
</ul>
<ol start="3">
<li>参数 / 结果集自动处理，降低出错率</li>
</ol>
<ul>
<li>参数绑定：支持按名称（如<code>#{age}</code>）绑定，无需关注参数索引，避免<code>setInt(1, 20)</code>的索引错误；</li>
<li>结果映射：支持一对一、一对多关联查询的自动映射（如用户关联订单），无需手动嵌套遍历 ResultSet。</li>
</ul>
<ol start="4">
<li>内置防 SQL 注入机制</li>
</ol>
<ul>
<li>MyBatis 默认使用<code>#{}</code>参数占位符（底层封装 PreparedStatement），自动规避 SQL 注入；</li>
</ul>
<ol start="5">
<li>自动化资源与事务管理</li>
</ol>
<ul>
<li>集成连接池（如 HikariCP），自动管理 Connection 的创建 / 释放，避免连接泄漏；</li>
<li>支持声明式事务（如 Spring+MyBatis 中<code>@Transactional</code>注解），无需手动调用<code>commit()</code>/<code>rollback()</code>。</li>
</ul>
<ol start="6">
<li>内置性能优化能力</li>
</ol>
<ul>
<li>支持一级缓存（SqlSession 级别）、二级缓存（Mapper 级别），减少重复查询；</li>
<li>提供分页插件（如 PageHelper），无需手写<code>LIMIT</code>语句，分页逻辑统一管理。</li>
</ul>
<ol start="7">
<li>良好的数据库适配性</li>
</ol>
<ul>
<li>通过配置不同的数据库方言（dialect），可快速切换数据库，SQL 语法差异由框架适配（如分页、主键生成策略）。</li>
</ul>
<p>Mybatis的业务架构如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4075876cf1f401bb9fb1b39550aa11d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=q2eBrxWti12o3cOJjFHrGmv3PAw%3D" alt="" loading="lazy"/></p>
<p>来看一个使用示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.learn.more.entiry.User;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.Reader;
<span class="hljs-keyword">import</span> org.apache.ibatis.io.Resources;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;
<span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcDemo</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">Reader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      reader = Resources.getResourceAsReader(<span class="hljs-string">"mybatis‐config.xml"</span>);
      <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(reader);
      session = sqlMapper.openSession();
      <span class="hljs-type">UserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> session.getMapper(UserMapper.class);
      <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.selectById(<span class="hljs-number">1L</span>);
      System.out.println(user.toString());
    } <span class="hljs-keyword">catch</span> (Exception e) {
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (reader != <span class="hljs-literal">null</span>) {
        reader.close();
      }
      <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
        session.close();
      }
    }
  }
}
</code></pre>
<h2 data-id="heading-5">三 Mybatis启动流程</h2>
<p>Mybatis启动过程，就是解析配置文件、初始化基础组件，最终创建SqlSession的过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5de8e6878bcc4741998920b7c946bf86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=5QKE4rGCRdLjoNgmj1%2BkhmdtjXk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.1 解析主配置文件</h3>
<p>使用Mybatis时，有两个配置文件；一个用于声明Mybatis运行参数，一个用于声明CRUD语句的mapper文件。</p>
<p>先来看Mybatis的主配置文件。如下，从中可以获取环境信息、Mapper文件列表、全局设置、类型别名、类型处理器、插件配置等。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span>
<span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Config 3.0//EN"</span>
<span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">properties</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"org/apache/ibatis/databases/blog/blog-derby.properties"</span>/&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">typeAlias</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">"Author"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.apache.ibatis.domain.blog.Author"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">typeHandlers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">typeHandler</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">"String"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> <span class="hljs-attr">handler</span>=<span class="hljs-string">"org.apache.ibatis.builder.CustomStringTypeHandler"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">typeHandlers</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">objectFactory</span> /&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span> <span class="hljs-attr">interceptor</span>=<span class="hljs-string">"org.apache.ibatis.builder.ExamplePlugin"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"pluginProperty"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"100"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"development"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"development"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">""</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">transactionManager</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"UNPOOLED"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${driver}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${url}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${username}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${password}"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"org/apache/ibatis/builder/AuthorMapper.xml"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<p>源码中是如何处理上述配置的呢？如下代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-string">"org/apache/ibatis/builder/MapperConfig.xml"</span>;
<span class="hljs-keyword">final</span> <span class="hljs-type">Reader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> Resources.getResourceAsReader(resource);
<span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(reader);
</code></pre>
<p><strong>来看SqlSessionFactoryBuilder#build方法，它会将XML中配置信息转化为Configuration对象。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8e255e9a4948f3af322f22e5b4de2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=gRPmKGMcQjKLytyRwWvWO%2BlF1i8%3D" alt="" loading="lazy"/></p>
<p>使用XMLConfigBuilder#parseConfiguration方法，逐个处理XML标签，最终构建Configuration对象。处理XML文件时使用了org.w3c.dom、org.xml.sax等依赖包。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7664fac068a4d25b55b4180a4734009~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=nlx8AdmjM6vb1SI%2Bh%2Fg%2BTsxX5ic%3D" alt="" loading="lazy"/></p>
<p>Configuration类持有所有配置信息，部分如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07d3d580d371481591d9f2f3e834c1b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=2UT%2FDhiFGg713hmWwsy9nTf0vxI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.1.1 全局属性</h4>
<p>对于一些全局属性，未配置时有默认值。在使用Mybatis时需要关注。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4e31e2c4eb842738ef6b05af27ed52e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=pA6poTsEuZdp%2BJ6rbHz1MZXLVTI%3D" alt="" loading="lazy"/></p>
<p>最后，使用Configuration对象创建一个SqlSessionFactory实例。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91a8cae93f0f452984a1d6e135281489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=9v1lDA0MjqoRoOY9RIQKw5SE0Xw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.1.2 类型别名注册</h4>
<p>TypeAliasRegistry类，用于保存简化名到Java类的映射；这使得我们可以在Mapper.xml中配置如resultType="int"，而不用java.lang.Integer全类名。</p>
<p>创建TypeAliasRegistry时自行注册了常用Java类型的别名。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2438f0d1efef4285954ec9e4ee0d5f35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=tiFr3o1zkdld3DXnnGXCXePFoiE%3D" alt="" loading="lazy"/></p>
<p>创建Configuration对象时，默认注册了mybatis框架自身需要的一些别名。这也是能配置如的原因。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/191012bf717d44acb2ecdef2a4311572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=%2BM1yVuGnVS4oc9iK5eic7aPZtB4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.1.3 类型处理器</h4>
<p>TypeHandler用于定义javaType与jdbcType之间相会转换逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; JDBC_TYPE_HANDLER_MAP = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnumMap</span>&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(JdbcType.class);
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; TYPE_HANDLER_MAP = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt;();
</code></pre>
<p>比如要将MySQL中的TINYINT处理成Java中的Byte，将使用ByteTypeHandler。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db2f495d9f6b4f7a9ed4a6468e3f9b85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=EUS8w6MfY5ZuffFjqZPc2rxV%2Fng%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.2 解析Mapper文件</h3>
<p>在主配置文件中，mapper文件有多种配置方式。</p>
<pre><code class="hljs language-java" lang="java">&lt;configuration&gt;
  &lt;mappers&gt;
    &lt;!-- 指定Mapper XML文件的相对路径 --&gt;
    &lt;mapper resource=<span class="hljs-string">"com/example/mapper/UserMapper.xml"</span>/&gt;
    &lt;!-- 接口类路径，要求接口与 XML 同路径同名 --&gt;
    &lt;mapper class=<span class="hljs-string">"com.example.mapper.UserMapper"</span>/&gt;
    &lt;mapper url=<span class="hljs-string">"file:///D:/project/com/example/mapper/UserMapper.xml"</span>/&gt;
    &lt;!-- 扫描指定包下的所有Mapper接口（需满足接口与XML同路径同名） --&gt;
    &lt;<span class="hljs-keyword">package</span> name=<span class="hljs-string">"com.example.mapper"</span>/&gt;
  &lt;/mappers&gt;
&lt;/configuration&gt;
</code></pre>
<p>在XMLConfigBuilder#mapperElement中，分别处理了以上几种配置方式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394becb5c8a44d22b24654ad13b021b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=SVXx%2F9qCn%2BK64WIvJdQP9895DW4%3D" alt="" loading="lazy"/></p>
<p>源码中会通过XMLMapperBuilder，来完成Mapper文件解析。同时将Mapper.xml文件对应的接口，注册到Configuration。</p>
<p>已下面这个文件为例，是对User信息的CRUD。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span>
        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
        <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.example.pojo.User"</span>&gt;</span>
        SELECT id, username, age, create_time FROM user WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"addUser"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.example.pojo.User"</span>&gt;</span>
        INSERT INTO user (username, age, create_time)
        VALUES (#{username}, #{age}, #{createTime})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateUser"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.example.pojo.User"</span>&gt;</span>
        UPDATE user 
        SET username = #{username}, 
            age = #{age}, 
            create_time = #{createTime}
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteUserById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span>&gt;</span>
        DELETE FROM user WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<p>在XMLMapperBuilder#configurationElement中，解析了各个标签。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4045235d72f4865b4b08435556c177a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=Cx97TMb3Grf20z6hvC8TcFG8aPY%3D" alt="" loading="lazy"/></p>
<p>一个Mapper文件的解析结果，会按照用途被保存到Configuration中：</p>
<ul>
<li>Configuration#mapperRegistry属性，记录着mapper接口与其代理工厂<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa770ed0f0894d6f8ce4877caebbf801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=QJ%2F7GQZlQluh5a7m5r1vFbpQa1M%3D" alt="" loading="lazy"/></li>
</ul>

<ul>
<li>解析XML中的CRUD语句，封装为MappedStatement对象，保存在Configuration#mappedStatements属性中<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6900ce637e23408a934bd60d96c8447a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=8Y0EF%2FnjGV3qSJw4QKzcgcNcH2Y%3D" alt="" loading="lazy"/></li>
</ul>

<ul>
<li>将resultMap保存在Configuration#resultMaps</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d9347d07a9d4d60a232e3976cc4547f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=R9%2FTbuRub0cxK0qzKIQd4bGZRt8%3D" alt="" loading="lazy"/></p>
<ul>
<li>将parameterMap保存在Configuration#parameterMaps<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be6a50aea44646b5b51b2513d001cbcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=wk%2FT6%2F8qPOrwfmm4PKg9Z6ilMkg%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-11">3.3 创建SqlSession</h3>
<p>经过以上步骤，创建了一个包含了MyBatis需要的所有配置Configration对象，接着会创建一个</p>
<p>SqlSessionFactory对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Configuration config)</span> {
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span>(config);
}
</code></pre>
<p>SqlSessionFactory接口有两个实现：SqlSessionManager、DefaultSqlSessionFactory。两者的差异在于：</p>
<p>DefaultSqlSessionFactory</p>
<ul>
<li>纯工厂模式：专注于创建SqlSession实例</li>
<li>无状态设计：线程安全，可被多线程共享</li>
<li>简单直接：每次调用openSession()都创建新的SqlSession</li>
</ul>
<p>SqlSessionManager</p>
<ul>
<li>工厂+会话双重身份：既是SqlSessionFactory又是SqlSession</li>
<li>会话管理：提供托管会话功能，支持ThreadLocal会话绑定</li>
<li>代理模式：内部使用动态代理处理SqlSession操作</li>
</ul>
<p>SqlSessionManager内部委托给DefaultSqlSessionFactory，本质上是对DefaultSqlSessionFactory的功能扩展，通过代理模式提供了更高级的会话管理能力：一个线程中始终使用同一个SqlSession。</p>
<p>Mybatis中默认使用DefaultSqlSessionFactory。通过以下步骤，将创建一个SqlSession对象。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21995e3fc2c04b6d9327af9b63c13b66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767444270&amp;x-signature=NU87kvYkUZEeH%2FgpPgXns1S6DrI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025，我的“AI搭子”：那个我以为用不上的AI，成了我每天都离不开的搭档！！]]></title>    <link>https://juejin.cn/post/7588152122186580022</link>    <guid>https://juejin.cn/post/7588152122186580022</guid>    <pubDate>2025-12-27T12:59:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588152122186580022" data-draft-id="7588149079416782902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025，我的“AI搭子”：那个我以为用不上的AI，成了我每天都离不开的搭档！！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T12:59:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025，我的“AI搭子”：那个我以为用不上的AI，成了我每天都离不开的搭档！！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:59:44.000Z" title="Sat Dec 27 2025 12:59:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>由于现在已经养成了对TRAE的高度依赖，可是呢，每个月的快速请求额度又是有限的，所以，现在的自己每天早上到公司，打开电脑的第一件事，已经变成了看TRAE的剩余额度。看了每天所剩的额度在去规划这一天的工作安排。</p>
</blockquote>
<p>两年前的我，肯定想不到自己会有这么一天。那时候，AI对我来说，就是新闻里那些高深莫测的东西，需要懂算法、会建模、数学要好——我？一个做手机端开发的，每天跟UI和业务逻辑较劲，跟AI能有什么交集？</p>
<p>第一次听说ChatGPT，还是技术群里有人在问：“你们试过让AI帮忙看代码吗？” 当时我心想，这玩意儿能看懂代码？扯呢吧。</p>
<p>真正让我放下成见的，是一个周末。我在调试一个JSON解析的bug，卡了两个小时，翻遍了文档也没找出问题。心烦意乱之下，把那串错误日志丢给了刚注册的ChatGPT。</p>
<p><strong>它几乎立刻回我：“第七行少了个转义符。”</strong></p>
<p>我愣了一下，回去检查，果然。就那么简单，简单到我盯着看了无数遍都没发现。那一刻的震惊，不是因为它有多“智能”，而是因为它解决问题的<strong>方式</strong>——就像有个懂行的同事坐你旁边，你一问，他随口就答出来了。</p>
<p>后来，我开始试着用它查文档。不再是一页页翻MDN或者Stack Overflow，而是直接问：“Swift里怎么优雅地处理可选类型嵌套？” 它会给例子，会给不同场景的方案，甚至告诉我哪个性能更好。</p>
<p>但要说真正让我对AI编程“上头”的，还得是2023年夏天那个项目。</p>
<p>产品经理拿着竞品截图来找我们：“这个效果，能做吗？两周后要。”</p>
<p>那是个相当复杂的交互动画——卡片3D翻转、粒子效果、物理回弹。按传统做法，先研究实现方案，再写demo测试，调参数，没个四五天出不来，还不一定达到效果。</p>
<p>眼看时间不够，我硬着头皮说：“我试试用ChatGPT帮忙。”</p>
<p>现在想想，当时的做法真是够笨的。我找不到专业词汇描述那个动画，索性截了几张图，配上我能想到的所有描述词：“卡片翻转的时候不是干巴巴的，是先缩小一点再放大，边缘有光晕散开……”</p>
<p>发出去的时候，我自己都觉得有点好笑，这能行？</p>
<p><strong>但几分钟后，它真的给了一段代码</strong>。不是完美的——有些API用错了，有些参数设置不太合理——但框架出来了。更重要的是，它理解了“先缩小再放大”是什么意思，用关键帧动画实现了那种有弹性的感觉。</p>
<p>我开始跟它对话：“这里性能会不会有问题？”
“是的，如果粒子太多会卡顿，建议控制在30个以下。”
“那怎么在低端机上降级？”
“可以检测设备型号，或者用更简单的透明度动画替代。”</p>
<p>就这样，你一句我一句，那段动画居然在两天的反复调试后搞定了。提交代码的时候，我保存了跟ChatGPT的对话记录——足足180多条。产品上线后，用户反馈说动画很流畅，我心里清楚，<strong>这流畅背后，是一半我的经验，一半AI的试错</strong>。</p>
<p>后来ChatGPT不好用了，我失落了一阵子。就像习惯了用计算器的人，突然要重回纸笔算数。</p>
<p>直到发现TRAE。第一次用它的时候，最让我惊讶的不是它能写代码，而是它写完会问一句：“需要我直接帮你把这段代码写到文件里吗？”</p>
<p>我点了确认，然后看着它真的修改了我的项目文件。那一刻的感觉很奇妙——<strong>我不只是在跟一个工具对话，而是在跟一个能“动手”的搭档协作</strong>。</p>
<p>它开始理解我的上下文。我扔给它一个几百行的ViewController文件，说“这里加个下拉刷新”，它不会机械地插入标准代码，而是先分析我的文件结构：</p>
<p>“你这里已经用了TableView的代理模式，我建议在这个方法里扩展实现刷新逻辑，这样更符合你现在的架构。”</p>
<p>我经常一边看它写代码，一边喝咖啡。有时候它会犯一些明显的错误——比如用了已经被标记弃用的方法——但当我指出来，它会立刻改正，并且解释为什么新方法更好。<strong>这种互动不像是在用工具，更像是在带一个聪明的实习生</strong>。</p>
<p>后来TRAE出了SOLO模式，我把整个小功能模块交给它试了试。</p>
<p>那次是要做个图片滤镜功能。我给了需求：“要能调亮度、对比度、饱和度，要有实时预览，保存的时候不能卡住主线程。”</p>
<p>然后我看着它一步步来：</p>
<p>“根据你的需求，我建议分成三个类：一个负责处理的，一个存参数的，一个做预览界面的。你觉得行吗？”</p>
<p>“行。”</p>
<p>“那你是想用Core Image还是自己写着色器？Core Image稳一点，着色器灵活一点。”</p>
<p>“Core Image吧。”</p>
<p>就这样，它写一段，问我一下，再继续。四十多分钟后，一个完整的模块出来了，连单元测试都写好了。代码风格统一，注释清晰，甚至考虑了内存管理和性能优化——<strong>比我平时赶时间写的要规整得多</strong>。</p>
<p>现在，我已经不太能想象没有AI工具要怎么工作了。每天早上规划任务的时候，我会下意识地分类：这个可以交给TRAE做初版，那个需要我自己先想清楚再让它帮忙。</p>
<p>当然，依赖也会有焦虑。有时候TRAE反应慢了，或者额度快用完了，我会突然有点慌——就像网速突然变慢时的那种烦躁。但更多时候，它是把我从重复劳动里解放出来了。我不再需要花半天时间写那些千篇一律的网络请求层，或者一遍遍地调试动画参数。<strong>我更像是个导演，告诉它我要什么效果，它去尝试，我来选择</strong>。</p>
<p>上个月带实习生，他看我工作方式，问：“这样会不会让自己变懒啊？什么都让AI做。”</p>
<p>我想了想，说：“以前没有计算器的时候，人们也算数。有了计算器，我们不是变懒了，而是可以去想更复杂的数学问题了。”</p>
<p>对我来说，AI工具就是那个“计算器”。它没取代我的思考，但它让我<strong>不用在简单的错误上浪费时间</strong>，不用在重复的代码上消磨耐心。我能把更多精力放在产品逻辑上，放在用户体验上，放在那些真正需要“人”去判断的事情上。</p>
<h5 data-id="heading-0">其实在自己使用AI工具提高自己工作效率的这一年里，时常也会和周围的小伙伴谈论起AI相关的一些话题，自己也在这里大致总结了亦喜爱自己的心得：</h5>
<p>我觉着至少现在的AI没有让我变成不需要写代码的“产品经理”，但它让我成了一个<strong>更高效、更少犯低级错误、更能聚焦核心问题的开发者</strong>。每天跟它对话，看着它帮我从想法变成代码，这种感觉，就像有了个永远在线、从不抱怨、还会越来越聪明的搭档。</p>
<p>或许这就是我的“Vibe Coding”时刻——<strong>不再把编码当成孤独的苦修，而是变成一场有回应的对话</strong>。代码依然是我写的，但写的过程，多了个能随时交流的伙伴。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端学习AI】FewShotPromptTemplate]]></title>    <link>https://juejin.cn/post/7588004601393479714</link>    <guid>https://juejin.cn/post/7588004601393479714</guid>    <pubDate>2025-12-27T11:28:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601393479714" data-draft-id="7588034035287654415" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端学习AI】FewShotPromptTemplate "/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T11:28:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端学习AI】FewShotPromptTemplate 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:28:10.000Z" title="Sat Dec 27 2025 11:28:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">核心定义</h2>
<p>FewShotPromptTemplate 是 LangChain 中构建<strong>少样本提示</strong>的模板类，核心是在提示词中嵌入少量示例，引导大模型遵循示例的格式、逻辑或风格完成任务，提升输出准确性与一致性。</p>
<h2 data-id="heading-1">核心作用</h2>
<p>通过「示例集 + 模板字符串 + 动态变量」，让模型快速掌握任务输入输出模式，解决陌生任务或复杂格式适配问题，避免繁琐规则编写，提升提示词复用性与任务适配性。</p>
<h2 data-id="heading-2">核心概念</h2>
<ul>
<li><strong>示例（Examples）</strong> ：少样本学习的样本数据，通常为列表形式，每个元素是含输入输出的字典（如 <code>[{"input": "文本1", "output": "结果1"}, ...]</code>），用于展示任务具体模式。</li>
<li><strong>示例模板（Example Prompt Template）</strong> ：用于格式化单个示例的子模板，定义每个示例在提示词中的呈现形式（如输入输出的排版、描述性文字）。</li>
<li><strong>前缀（Prefix）</strong> ：提示词的前置说明部分，用于告知模型任务目标、示例的作用（如“以下是文本分类任务的示例，请参考示例将输入文本分类到对应类别”）。</li>
<li><strong>后缀（Suffix）</strong> ：提示词的后置部分，用于承载用户的动态输入变量，引导模型完成当前任务（如“请对以下文本进行分类：{input_text}”）。</li>
</ul>
<h2 data-id="heading-3">创建实例</h2>
<p>核心原则：先定义示例集和示例模板，再通过 <code>FewShotPromptTemplate</code>组合示例、前缀、后缀等，生成完整少样本提示模板。</p>
<h3 data-id="heading-4">基础创建（完整流程）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> FewShotPromptTemplate, PromptTemplate

<span class="hljs-comment"># 定义示例集（少样本数据）</span>
examples = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"我喜欢阳光明媚的天气"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"今天的工作太多，压力好大"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"消极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"收到了朋友送的礼物，很开心"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"错过末班车，只能打车回家了"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"中性情绪"</span>}
]

<span class="hljs-comment"># 定义示例模板（格式化单个示例）</span>
example_prompt = PromptTemplate(
    input_variables=[<span class="hljs-string">"input"</span>, <span class="hljs-string">"output"</span>],
    template=<span class="hljs-string">"输入：{input}\n输出：{output}\n"</span>
)

<span class="hljs-comment"># 定义 FewShotPromptTemplate</span>
few_shot_prompt = FewShotPromptTemplate(
    <span class="hljs-comment"># 传入示例集</span>
    examples=examples,
    <span class="hljs-comment"># 传入示例模板</span>
    example_prompt=example_prompt,
    <span class="hljs-comment"># 前置说明</span>
    prefix=<span class="hljs-string">"请参考以下示例，判断输入文本的情绪类别（积极情绪/消极情绪/中性情绪）："</span>,
    <span class="hljs-comment"># 后置用户输入部分</span>
    suffix=<span class="hljs-string">"输入：{user_input}\n输出："</span>,
    <span class="hljs-comment"># 待填充的动态变量（用户输入文本）</span>
    input_variables=[<span class="hljs-string">"user_input"</span>]
)
</code></pre>
<h3 data-id="heading-5">含示例筛选的创建（动态控制示例数量）</h3>
<p>通过 <code>example_selector</code> 参数指定示例选择器，可动态筛选示例（如控制数量、按相似度筛选），适配不同长度限制或任务难度场景。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> FewShotPromptTemplate, PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.prompts.example_selector <span class="hljs-keyword">import</span> LengthBasedExampleSelector

<span class="hljs-comment"># 定义示例集（更多样本）</span>
examples = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"我喜欢阳光明媚的天气"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"今天的工作太多，压力好大"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"消极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"收到了朋友送的礼物，很开心"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"错过末班车，只能打车回家了"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"中性情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"电影情节很精彩，推荐大家观看"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"餐厅的食物很美味，服务也很好"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"路上堵车，迟到了十分钟"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"消极情绪"</span>}
]

<span class="hljs-comment"># 定义示例模板</span>
example_prompt = PromptTemplate(
    input_variables=[<span class="hljs-string">"input"</span>, <span class="hljs-string">"output"</span>],
    template=<span class="hljs-string">"输入：{input}\n输出：{output}\n"</span>
)

<span class="hljs-comment"># 定义示例选择器（按长度筛选，控制示例总长度）</span>
example_selector = LengthBasedExampleSelector(
    examples=examples,
    example_prompt=example_prompt,
    <span class="hljs-comment"># 示例总长度上限（字符数），超过则自动减少示例</span>
    max_length=<span class="hljs-number">100</span>
)

<span class="hljs-comment"># 定义 FewShotPromptTemplate（传入示例选择器，而非直接传 examples）</span>
few_shot_prompt = FewShotPromptTemplate(
    <span class="hljs-comment"># 动态示例选择器</span>
    example_selector=example_selector,
    example_prompt=example_prompt,
    prefix=<span class="hljs-string">"请参考以下示例，判断输入文本的情绪类别（积极情绪/消极情绪/中性情绪）："</span>,
    suffix=<span class="hljs-string">"输入：{user_input}\n输出："</span>,
    input_variables=[<span class="hljs-string">"user_input"</span>]
)
</code></pre>
<h3 data-id="heading-6">无示例的少样本模板（ZeroShot 兼容）</h3>
<p>若需兼容零样本场景（无需示例），可通过 <code>examples=[]</code> 创建空示例模板，后续可动态添加示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> FewShotPromptTemplate, PromptTemplate

<span class="hljs-comment"># 空示例集</span>
examples = []

<span class="hljs-comment"># 示例模板</span>
example_prompt = PromptTemplate(
    input_variables=[<span class="hljs-string">"input"</span>, <span class="hljs-string">"output"</span>],
    template=<span class="hljs-string">"输入：{input}\n输出：{output}\n"</span>
)

<span class="hljs-comment"># 定义空示例少样本模板</span>
few_shot_prompt = FewShotPromptTemplate(
    examples=examples,
    example_prompt=example_prompt,
    prefix=<span class="hljs-string">"请判断输入文本的情绪类别（积极情绪/消极情绪/中性情绪）："</span>,
    suffix=<span class="hljs-string">"输入：{user_input}\n输出："</span>,
    input_variables=[<span class="hljs-string">"user_input"</span>]
)

<span class="hljs-comment"># 后续可动态添加示例</span>
few_shot_prompt.examples.append({<span class="hljs-string">"input"</span>: <span class="hljs-string">"今天心情很好"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"积极情绪"</span>})
</code></pre>
<h2 data-id="heading-7">实例属性</h2>
<h3 data-id="heading-8">examples</h3>
<p>核心属性，存储少样本示例列表，每个元素为含输入输出的字典（如 <code>[{"input": "...", "output": "..."}]</code>）。</p>
<h3 data-id="heading-9">example_prompt</h3>
<p>示例模板对象（<code>PromptTemplate</code> 实例），定义单个示例的格式化规则。</p>
<h3 data-id="heading-10">prefix / suffix</h3>
<p>字符串属性，分别对应提示词的前置说明和后置用户输入部分，共同构成完整提示词的框架。</p>
<h3 data-id="heading-11">input_variables</h3>
<p>待填充动态变量列表（如 <code>["user_input"]</code>），不包含示例中的变量（示例变量由 <code>example_prompt</code> 单独定义）。</p>
<h3 data-id="heading-12">example_selector（可选）</h3>
<p>示例选择器对象（如 <code>LengthBasedExampleSelector</code>），用于动态筛选示例，未指定时直接使用全部 examples。</p>
<h2 data-id="heading-13">实例方法</h2>
<h3 data-id="heading-14">format</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">**kwargs: <span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-15">功能</h4>
<p>填充动态变量，结合示例、前缀、后缀生成完整的少样本提示词字符串。</p>
<h4 data-id="heading-16">参数</h4>
<ul>
<li><code>**kwargs</code>：键值对参数，填充 <code>input_variables</code> 中定义的动态变量</li>
</ul>
<h4 data-id="heading-17">返回值</h4>
<p>字符串类型的最终少样本提示词。</p>
<h4 data-id="heading-18">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 续基础创建示例</span>
prompt_str = few_shot_prompt.<span class="hljs-built_in">format</span>(user_input=<span class="hljs-string">"今天的考试很顺利"</span>)
<span class="hljs-built_in">print</span>(prompt_str)
<span class="hljs-comment"># 输出结果：</span>
<span class="hljs-comment"># 请参考以下示例，判断输入文本的情绪类别（积极情绪/消极情绪/中性情绪）：</span>
<span class="hljs-comment"># 输入：我喜欢阳光明媚的天气</span>
<span class="hljs-comment"># 输出：积极情绪</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># 输入：今天的工作太多，压力好大</span>
<span class="hljs-comment"># 输出：消极情绪</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># 输入：收到了朋友送的礼物，很开心</span>
<span class="hljs-comment"># 输出：积极情绪</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># 输入：错过末班车，只能打车回家了</span>
<span class="hljs-comment"># 输出：中性情绪</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># 输入：今天的考试很顺利</span>
<span class="hljs-comment"># 输出：</span>
</code></pre>
<h3 data-id="heading-19">format_prompt</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_prompt</span>(<span class="hljs-params">**kwargs: <span class="hljs-type">Any</span></span>) -&gt; PromptValue
</code></pre>
<h4 data-id="heading-20">功能</h4>
<p>填充动态变量后，生成 LangChain 模型可直接接收的 <code>PromptValue</code> 对象（无需手动转换字符串）。</p>
<h4 data-id="heading-21">参数</h4>
<ul>
<li><code>**kwargs</code>：键值对参数，填充动态变量</li>
</ul>
<h4 data-id="heading-22">返回值</h4>
<p><code>PromptValue</code> 对象，可直接传入 LangChain 模型的 <code>invoke()</code> 等方法。</p>
<h4 data-id="heading-23">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 续基础创建示例</span>
prompt = few_shot_prompt.format_prompt(user_input=<span class="hljs-string">"今天的考试很顺利"</span>)
<span class="hljs-comment"># 直接传入模型调用</span>
<span class="hljs-comment"># model.invoke(prompt)</span>
</code></pre>
<h3 data-id="heading-24">invoke</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">
    <span class="hljs-built_in">input</span>: <span class="hljs-built_in">dict</span>,
    config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    **kwargs: <span class="hljs-type">Any</span>
</span>) -&gt; PromptValue
</code></pre>
<h4 data-id="heading-25">功能</h4>
<p>适配 LangChain 链式调用（<code>Runnable</code> 接口）的规范方法，生成 <code>PromptValue</code> 对象，用于流水线式模型调用流程。</p>
<h4 data-id="heading-26">参数</h4>
<ul>
<li>
<p><code>input</code>：字典类型，键为变量名，值为变量值（核心传参方式）；</p>
</li>
<li>
<p><code>config</code>：运行时配置（如超时时间、日志等级等）；</p>
</li>
<li>
<p><code>**kwargs</code>：额外键值对变量（补充 input 中未包含的变量）。</p>
</li>
</ul>
<h4 data-id="heading-27">返回值</h4>
<p><code>PromptValue</code> 对象，可直接用于链式调用中的模型输入。</p>
<h4 data-id="heading-28">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 续基础创建示例</span>
prompt = few_shot_prompt.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"user_input"</span>: <span class="hljs-string">"今天的考试很顺利"</span>})
</code></pre>
<h2 data-id="heading-29">关键注意事项</h2>
<ul>
<li>示例质量直接影响模型效果：示例需准确、典型，覆盖任务核心场景，避免错误或模糊示例；</li>
<li>示例数量需平衡：过少可能无法让模型掌握任务模式，过多可能导致提示词过长（超出模型上下文窗口），建议3-5个示例为宜；</li>
<li>示例模板需统一：所有示例需遵循相同的格式化规则（如输入输出的排版、字段名称），避免格式混乱；</li>
<li>动态变量与示例变量需区分：<code>input_variables</code> 仅定义用户动态输入变量，示例变量由 <code>example_prompt</code> 单独定义，不可混淆；</li>
<li>建议结合示例选择器优化：示例较多时，使用 <code>example_selector</code> 动态控制示例长度，避免超出模型上下文限制。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph智能体开发设计模式（一）——提示链模式、路由模式、并行化模式]]></title>    <link>https://juejin.cn/post/7588042910198136882</link>    <guid>https://juejin.cn/post/7588042910198136882</guid>    <pubDate>2025-12-27T11:35:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198136882" data-draft-id="7588080521445097518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph智能体开发设计模式（一）——提示链模式、路由模式、并行化模式"/> <meta itemprop="keywords" content="人工智能,Agent,LangChain"/> <meta itemprop="datePublished" content="2025-12-27T11:35:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph智能体开发设计模式（一）——提示链模式、路由模式、并行化模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:35:37.000Z" title="Sat Dec 27 2025 11:35:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>上篇文章 <a href="https://juejin.cn/post/7586901995429806089" target="_blank" title="https://juejin.cn/post/7586901995429806089">LangGraph1.0速通指南（三）—— LangGraph1.0 自动邮件处理智能体实战</a>阅读完成后，大家就系统掌握了 LangGraph 1.0 中“点”、“边”、“图”、“记忆”与“人在回路”等核心功能，并通过一个完整的自动邮件处理智能体，学习了使用 LangGraph 开发智能体的基本方法。</p>
<p>然而，要想高效构建一个可靠、可扩展的智能体，仅仅熟悉语法和基础功能是不够的。笔者在《<a href="https://juejin.cn/post/7584689488770252835" target="_blank" title="https://juejin.cn/post/7584689488770252835">LangGraph 1.0 速通指南（一）—— LangGraph 1.0 核心概念、点、边</a>》中曾将 LangGraph 比作“智能体开发的编程语言”。既然是一种语言，自然存在一系列经过实践检验、可复用的优秀构造模式——这正是智能体开发的设计模式。</p>
<p>从本文开始，笔者将开启 LangGraph 设计模式系列的分享，系统介绍如何运用这些模式来构建更清晰、健壮且易于维护的智能体工作流。本系列将涵盖常见的工作流模式与多智能体架构模式，预计通过五篇文章展开。相关内容均列于笔者的专栏<a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>，同时也要说明该专栏适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 34 讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号<strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-1">一、LangGraph设计模式</h2>
<h2 data-id="heading-2">1.1 LangGraph设计模式总览</h2>
<p>随着大模型智能体能力的不断增强，其需要处理的任务也日趋复杂。如同城市建设需要规划蓝图、软件开发离不开架构设计一样，构建强大且稳健的人工智能体系统，同样需要精心设计的<strong>架构模式</strong>作为支撑。</p>
<p>从本期开始，笔者将系统介绍在 LangGraph 框架下构建各类智能体系统的关键架构模式。这些模式将涵盖从基础的工作流编排，到更高级的多智能体协同设计，为大家开发智能体提供一套可复用、可扩展的方法论。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42601670472d4b1580d462ddc8140d1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=nQhuluOIlopgnAlslSEQPRweyz8%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<h2 data-id="heading-3">1.2 LangGraph工作流模式</h2>
<p>笔者首先介绍 LangGraph 的<strong>工作流模式</strong>，它常被称为<strong>单智能体模式</strong>。需要明确的是，“单智能体”并非指仅使用一个大模型，而是指系统目标单一，且所有决策由一个统一的智能体核心来完成。一个基础的单智能体通常由以下部分构成：大模型（如 DeepSeek、Qwen3）作为“大脑”，可调用各种工具，具备记忆存储与检索能力，并通过系统提示词来响应用户输入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/487310fd2d7243578969c0e73b820f7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=Y59xUBmuDxMXtrg8JG2qQUQ9dr0%3D" alt="" loading="lazy"/></p>
<p>而 LangGraph 的工作流模式，正是在此基础上，通过引入规划与多步调用机制等，来更高效、更可靠地完成复杂用户任务。常见的工作流模式包括<strong>提示链模式、路由模式、并行化模式、协调器-工作者模式、评估器-优化器模式</strong>等。本期笔者先从几个相对基础的模式开始分享：<strong>提示链模式、路由模式和并行化模式</strong>。</p>
<h2 data-id="heading-4">二、提示链模式</h2>
<h2 data-id="heading-5">2.1 提示链模式定义</h2>
<p>提示链模式是最基础的工作流模式之一，其核心思想是将复杂任务分解为一系列更简单、相互关联的步骤。在该模式中，大模型被多次顺序调用，且前一次调用的输出常作为后续调用的输入，从而形成一个多阶段、串行处理的工作流。</p>
<p>为了确保流程的质量和方向，提示链模式在步骤之间通常会引入程序化的检查点，称为 “门控”（Gate） 。门控作为质量审查节点，能够校验上一步的输出是否满足特定条件，从而决定流程是继续向前、转向特定分支还是提前结束。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a4fdf0bd7342949675ec5c1e50b366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=AxRsOOqQuuagGPX1xjO7xhfJc0s%3D" alt="" loading="lazy"/></p>
<p>提示链模式的核心优势在于：</p>
<ol>
<li>分解复杂度：将庞杂任务拆分为更小、更易管理的子任务，降低单次处理的认知负荷。</li>
<li>提升准确性与可控性：通过多步骤的精细化和中间检查，能够获得比单次大模型调用更可靠、更符合预期的输出。</li>
</ol>
<p>该模式特别适用于那些能够被清晰划分为顺序子任务的场景。例如，要生成一个小众语言的营销文案，可以将其拆解为：第一步由大模型生成高质量的英文/中文原稿，第二步再由大模型将其翻译为目标语言。在第一步之后，还可以加入门控检查，确保原稿的调性、长度或关键信息点符合要求，从而更好地控制最终结果的质量。</p>
<h2 data-id="heading-6">2.2 提示链模式代码示例</h2>
<p>单纯的概念描述不够直观，接下来笔者通过一个具体的代码实例来理解。本例将模拟一个多步骤生成优质笑话的流程：首先生成简短笑话，然后根据检查结果决定是否增强趣味性，最后进行润色转折。</p>
<ol>
<li>
<p><strong>引入相关依赖：</strong> 在项目文件夹下新建.env文件，填入你的DEEPSEEK_API_KEY。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> END, START, StateGraph
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

<span class="hljs-comment">#0. 配置模型</span>
load_dotenv()

llm = ChatDeepSeek(
    model=<span class="hljs-string">"deepseek-chat"</span>,
)
</code></pre>
</li>
<li>
<p><strong>定义状态：</strong> 这是一个三阶段流程，因此状态需要记录初始主题、各阶段生成的笑话。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 定义图状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    topic: <span class="hljs-built_in">str</span>
    joke: <span class="hljs-built_in">str</span>
    improved_joke: <span class="hljs-built_in">str</span>
    final_joke: <span class="hljs-built_in">str</span>
</code></pre>
</li>
<li>
<p><strong>定义节点函数：</strong> 包括三个大模型调用节点和一个门控检查节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 2. 定义节点函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_joke</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    第一个大模型调用，根据主题生成初始笑话
    '''</span>
    topic = state[<span class="hljs-string">'topic'</span>]
    msg = llm.invoke(<span class="hljs-string">f'写一个关于<span class="hljs-subst">{topic}</span>的简短笑话'</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'joke'</span>: msg.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_punchline</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    模拟门控函数——笑话中是否包含?或!
    '''</span>
    joke = state[<span class="hljs-string">'joke'</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-string">'?'</span> <span class="hljs-keyword">in</span> joke <span class="hljs-keyword">or</span> <span class="hljs-string">'？'</span> <span class="hljs-keyword">in</span> joke:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Fail"</span> <span class="hljs-comment"># 未能通过门控检查, 需要继续增强</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Pass"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">improve_joke</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    第二个大模型调用，通过添加文字游戏改进笑话
    '''</span>
    joke = state[<span class="hljs-string">'joke'</span>]
    msg = llm.invoke(<span class="hljs-string">f'通过添加文字游戏使笑话更有趣，当前笑话是: <span class="hljs-subst">{joke}</span>'</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'improved_joke'</span>: msg.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">polish_joke</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    第三个大模型调用，最终润色笑话，添加令人惊讶的转折
    '''</span>
    improved_joke = state[<span class="hljs-string">'improved_joke'</span>]
    msg = llm.invoke(<span class="hljs-string">f'为这个笑话添加一个令人惊讶的转折: <span class="hljs-subst">{improved_joke}</span>'</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'final_joke'</span>: msg.content
    }
</code></pre>
</li>
<li>
<p><strong>定义边并构建图：</strong> 通过条件边来实现门控逻辑。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#2. 定义边和图</span>
workflow = StateGraph(State)
workflow.add_node(<span class="hljs-string">'generate_joke'</span>, generate_joke)
workflow.add_node(<span class="hljs-string">'improve_joke'</span>, improve_joke)
workflow.add_node(<span class="hljs-string">'polish_joke'</span>, polish_joke)

workflow.add_edge(START, <span class="hljs-string">'generate_joke'</span>)
workflow.add_conditional_edges(<span class="hljs-string">'generate_joke'</span>, check_punchline, {
    <span class="hljs-string">'Fail'</span>: <span class="hljs-string">'improve_joke'</span>,
    <span class="hljs-string">'Pass'</span>: END
})
workflow.add_edge(<span class="hljs-string">'improve_joke'</span>, <span class="hljs-string">'polish_joke'</span>)
workflow.add_edge(<span class="hljs-string">'polish_joke'</span>, END)

chain = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
</li>
<li>
<p><strong>测试运行：</strong> 当生成的简短笑话包含‘?’时，无法通过门控检查，流程会进入增强和润色环节。虽然笔者一直觉得大模型生成的笑话不好笑，但从最终表现形式上看，笑话已经从简短的一小段扩充到丰富的内容，这正是提示链模式通过顺序分解任务来提升输出效果的体现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#3. 测试运行</span>
state = chain.invoke({<span class="hljs-string">'topic'</span>: <span class="hljs-string">'小猫'</span>})

<span class="hljs-built_in">print</span>(<span class="hljs-string">'初始笑话:'</span>)
<span class="hljs-built_in">print</span>(state[<span class="hljs-string">'joke'</span>])


<span class="hljs-keyword">if</span> <span class="hljs-string">'improved_joke'</span> <span class="hljs-keyword">in</span> state:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'改进后笑话:'</span>)
    <span class="hljs-built_in">print</span>(state[<span class="hljs-string">'improved_joke'</span>])

    <span class="hljs-built_in">print</span>(<span class="hljs-string">'最终笑话:'</span>)
    <span class="hljs-built_in">print</span>(state[<span class="hljs-string">'final_joke'</span>])
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a958ce30b13745efb431312b63501f6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=hYbNXM%2FJ0dGQWspkvg23JWZ25Vk%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<h2 data-id="heading-7">三、路由模式</h2>
<h2 data-id="heading-8">3.1 路由模式概念</h2>
<p>路由模式旨在通过对输入请求进行智能分类，并将其定向到专门的下游处理节点，从而高效应对多样化的任务需求。在 LangGraph 的实现中，这通常涉及定义一个路由器节点（负责分类决策）和一组下游节点（每个节点专精于处理某一特定类型的任务）。工作流会使用条件边，根据路由器节点的分类结果，将任务流转导向最合适的处理分支。</p>
<p>路由模式的核心思想是引入一个分流步骤。该步骤可以由大模型驱动，也可以由更传统的分类模型支持。整个工作流的成功在很大程度上取决于这个分类步骤的准确性：如果输入被错误分类，就会被引导至不恰当的处理路径，从而导致输出结果不正确或不满足预期。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2ed3ffd7ff8469abbb71641eb1b74f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=0ehxlE48vrXe3473LWlS%2FgL27Zg%3D" alt="" loading="lazy"/></p>
<p>路由模式非常适合处理同一大类任务下包含多种不同处理逻辑的场景。以下是两个典型适用例子：</p>
<ol>
<li>客户服务分流：在客户服务应用中，路由可用于区分不同类型的客户查询。例如，一般咨询、退款请求和技术支持工单可以被路由到不同的专用下游流程。一般咨询可能触发简单的FAQ检索；退款请求则可能启动一个需要查询订单历史并调用支付接口的工作流；而技术支持则会被导向包含详细故障排查步骤的专业流程。</li>
<li>资源与成本优化：路由还可用于优化系统的响应速度与计算成本。例如，可以根据请求的复杂度或紧急性进行分类：将简单、常见的查询路由到更轻量、快速且成本低廉的模型（如 Qwen3-8B），而将复杂、特殊的请求定向给能力更强但资源消耗也更大的模型（如 DeepSeek-671B）。</li>
</ol>
<h2 data-id="heading-9">3.2 路由模式代码示例</h2>
<p>单纯概念描述不直观，笔者通过一个具体的代码实例来理解。本例是一个内容生成器，根据用户输入决定是输出笑话、故事还是诗歌。</p>
<ol>
<li>
<p><strong>引入依赖</strong> （同样需要配置好.env文件中的DEEPSEEK_API_KEY）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage, SystemMessage
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

llm = ChatDeepSeek(
    model=<span class="hljs-string">"deepseek-chat"</span>,
)
</code></pre>
</li>
<li>
<p><strong>定义状态：</strong> 状态需要记录用户输入、路由决策以及最终输出。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-built_in">input</span>: <span class="hljs-built_in">str</span>
    decision: <span class="hljs-built_in">str</span>
    output: <span class="hljs-built_in">str</span>
</code></pre>
</li>
<li>
<p><strong>定义节点函数：</strong> 包括三个专精于不同创作类型的下游节点，以及一个负责分类的路由器节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 定义节点</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_story</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    写故事节点
    '''</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'进入写故事处理逻辑'</span>)
    result = llm.invoke(state[<span class="hljs-string">'input'</span>])
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'output'</span>: result.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_joke</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    写笑话节点
    '''</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'进入写笑话处理逻辑'</span>)
    result = llm.invoke(state[<span class="hljs-string">'input'</span>])
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'output'</span>: result.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_poetry</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    写诗歌节点
    '''</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'进入写诗歌处理逻辑'</span>)
    result = llm.invoke(state[<span class="hljs-string">'input'</span>])
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'output'</span>: result.content
    }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Classification</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    response_format: <span class="hljs-type">Literal</span>[<span class="hljs-string">'story'</span>, <span class="hljs-string">'joke'</span>, <span class="hljs-string">'poetry'</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">llm_call_router</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    使用结构化输出将输入路由到适当的节点
    '''</span>
    structed_llm = llm.with_structured_output(Classification)
    input_content = state[<span class="hljs-string">'input'</span>]
    response = structed_llm.invoke([
        SystemMessage(content=<span class="hljs-string">'''
            你是一个分类路由，根据用户的输入进行分类，分类结果是story, joke, poetry三者中的一种
        '''</span>),
        HumanMessage(content=input_content)
    ])
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'decision'</span>: response[<span class="hljs-string">'response_format'</span>]
    }
</code></pre>
</li>
<li>
<p><strong>定义边并构建图：</strong> 利用条件边实现基于决策的分支路由。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义条件边函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_decision</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">'decision'</span>] == <span class="hljs-string">'story'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'llm_story'</span>
    <span class="hljs-keyword">elif</span> state[<span class="hljs-string">'decision'</span>] == <span class="hljs-string">'joke'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'llm_joke'</span>
    <span class="hljs-keyword">elif</span> state[<span class="hljs-string">'decision'</span>] == <span class="hljs-string">'poetry'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'llm_poetry'</span>

<span class="hljs-comment"># 2. 定义边和图</span>
router_builder = StateGraph(State)

router_builder.add_node(<span class="hljs-string">'llm_story'</span>, generate_story)
router_builder.add_node(<span class="hljs-string">'llm_joke'</span>, generate_joke)
router_builder.add_node(<span class="hljs-string">'llm_poetry'</span>, generate_poetry)
router_builder.add_node(<span class="hljs-string">'llm_call_router'</span>, llm_call_router)

router_builder.add_edge(START, <span class="hljs-string">'llm_call_router'</span>)
router_builder.add_conditional_edges(
    <span class="hljs-string">'llm_call_router'</span>,
    route_decision,
    {
        <span class="hljs-string">'llm_story'</span>: <span class="hljs-string">'llm_story'</span>,
        <span class="hljs-string">'llm_joke'</span>: <span class="hljs-string">'llm_joke'</span>,
        <span class="hljs-string">'llm_poetry'</span>: <span class="hljs-string">'llm_poetry'</span>
    }
)
router_builder.add_edge(<span class="hljs-string">'llm_story'</span>, END)
router_builder.add_edge(<span class="hljs-string">'llm_joke'</span>, END)
router_builder.add_edge(<span class="hljs-string">'llm_poetry'</span>, END)

workflow = router_builder.<span class="hljs-built_in">compile</span>()
</code></pre>
<ol start="5">
<li><strong>运行测试：</strong> 输入“给我写一个关于苍井空的笑话”。如图所示，路由器成功将请求分类为joke，并将其引导至生成笑话的节点进行处理与输出（不得不说，当前大模型在内容生成上仍趋于保守）。</li>
</ol>
<pre><code class="hljs language-python" lang="python">result = workflow.invoke({
    <span class="hljs-string">'input'</span>: <span class="hljs-string">'给我写一个关于苍井空的笑话'</span>
})

<span class="hljs-built_in">print</span>(result[<span class="hljs-string">'output'</span>])
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29a105cb4f2b4c6aa5f95cea7f681e19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=hd5GAeTaq52cbDeV8JhEeTjJbQ4%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<h2 data-id="heading-10">四、并行模式</h2>
<h2 data-id="heading-11">4.1 并行模式概念</h2>
<p>并行模式旨在充分利用大模型的能力，同时处理一个任务中不同方面或同一任务的不同变体。与顺序执行的提示链模式不同，并行模式允许多个大模型调用同时进行，最后将各自的输出进行聚合，从而显著提升处理效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b34e3c638ab407099aeb8fa2589da8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=JBOekez2uaj%2FfCwpUjHmHvtvinc%3D" alt="" loading="lazy"/></p>
<p>根据任务目标的不同，并行模式的主要聚合方式可分为两类：分段 与 投票 。</p>
<ul>
<li>分段：适用于将一个复杂任务拆分为多个独立的子任务。这些子任务可以并行执行，每个由一个独立的大模型调用处理，最终将结果组合成完整输出。例如，要全面评估一段内容，可以并行调用多个模型，分别评估其事实准确性、逻辑连贯性和文风匹配度，最后聚合这些维度的评分，得到一个综合评估报告。</li>
<li>投票：适用于通过共识机制提升结果的准确性。即对同一任务并行执行多次，每次使用略有不同的提示词或配置，然后根据多数输出或某种共识来决定最终结果。例如，在审查一段代码是否存在安全漏洞时，可以用三个并行的模型，分别从“内存安全”、“注入攻击”和“逻辑缺陷”三个角度进行审查。如果其中两个模型都认为存在漏洞，则可以相对可靠地判定该代码有风险。</li>
</ul>
<h2 data-id="heading-12">4.2 并行模式</h2>
<p>单纯概念描述不直观，笔者通过一个具体的代码实例来理解。该任务是通过用户输入的主题，生成一个包含故事、笑话和诗歌的合集。</p>
<ol>
<li>
<p><strong>引入依赖</strong>（同样需要配置好.env文件中的DEEPSEEK_API_KEY）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

llm = ChatDeepSeek(
    model=<span class="hljs-string">"deepseek-chat"</span>,
)
</code></pre>
</li>
<li>
<p><strong>定义工作流的状态：</strong> 围绕一个主题，并行生成笑话、故事和诗歌，最后聚合为合集。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    topic: <span class="hljs-built_in">str</span>
    joke: <span class="hljs-built_in">str</span>
    story: <span class="hljs-built_in">str</span>
    poetry: <span class="hljs-built_in">str</span>
    combined_output: <span class="hljs-built_in">str</span>
</code></pre>
</li>
<li>
<p><strong>定义节点函数：</strong> 除了生成笑话、故事、诗歌三个并行执行的节点外，还需要一个聚合节点将三者的输出整合。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_joke</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    生成笑话的节点
    '''</span>
    topic = state[<span class="hljs-string">'topic'</span>]
    msg = llm.invoke(<span class="hljs-string">f'写一个关于<span class="hljs-subst">{topic}</span>的笑话'</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'joke'</span>: msg.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_story</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    生成故事的节点
    '''</span>
    topic = state[<span class="hljs-string">'topic'</span>]
    msg = llm.invoke(<span class="hljs-string">f'写一个关于<span class="hljs-subst">{topic}</span>的故事'</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'story'</span>: msg.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_poetry</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    生成诗歌的节点
    '''</span>
    topic = state[<span class="hljs-string">'topic'</span>]
    msg = llm.invoke(<span class="hljs-string">f'写一个关于<span class="hljs-subst">{topic}</span>的诗歌'</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'poetry'</span>: msg.content
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">aggregator</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-string">'''
    聚合笑话、故事、诗歌的节点
    '''</span>
    topic = state[<span class="hljs-string">'topic'</span>]
    joke = state[<span class="hljs-string">'joke'</span>]
    story = state[<span class="hljs-string">'story'</span>]
    poetry = state[<span class="hljs-string">'poetry'</span>]
    combined = <span class="hljs-string">f'这是一个关于 <span class="hljs-subst">{topic}</span> 的故事、笑话和诗歌的合集\n\n'</span>
    combined += <span class="hljs-string">f'故事\n <span class="hljs-subst">{story}</span>\n\n'</span>
    combined += <span class="hljs-string">f'笑话\n <span class="hljs-subst">{joke}</span>\n\n'</span>
    combined += <span class="hljs-string">f'诗歌\n <span class="hljs-subst">{poetry}</span>\n\n'</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'combined_output'</span>: combined
    }
</code></pre>
</li>
<li>
<p><strong>定义边和图：</strong> 注意，这里三个生成节点都从START同时开始，体现了并行性。</p>
<pre><code class="hljs language-python" lang="python">parallel_builder = StateGraph(State)

parallel_builder.add_node(<span class="hljs-string">'generate_joke'</span>, generate_joke)
parallel_builder.add_node(<span class="hljs-string">'generate_story'</span>, generate_story)
parallel_builder.add_node(<span class="hljs-string">'generate_poetry'</span>, generate_poetry)
parallel_builder.add_node(<span class="hljs-string">'aggregator'</span>, aggregator)

parallel_builder.add_edge(START, <span class="hljs-string">'generate_joke'</span>)
parallel_builder.add_edge(START, <span class="hljs-string">'generate_story'</span>)
parallel_builder.add_edge(START, <span class="hljs-string">'generate_poetry'</span>)
parallel_builder.add_edge(<span class="hljs-string">'generate_joke'</span>, <span class="hljs-string">'aggregator'</span>)
parallel_builder.add_edge(<span class="hljs-string">'generate_story'</span>, <span class="hljs-string">'aggregator'</span>)
parallel_builder.add_edge(<span class="hljs-string">'generate_poetry'</span>, <span class="hljs-string">'aggregator'</span>)
parallel_builder.add_edge(<span class="hljs-string">'aggregator'</span>, END)

workflow = parallel_builder.<span class="hljs-built_in">compile</span>()
</code></pre>
</li>
<li>
<p><strong>运行测试：</strong> 使用“pgone 与 李小璐”作为主题进行测试，结果如下（deepseek 连这个故事也不能讲嘛）</p>
<pre><code class="hljs language-python" lang="python">state = workflow.invoke({
    <span class="hljs-string">'topic'</span>: <span class="hljs-string">'pgone 与 李小璐'</span>
})
<span class="hljs-built_in">print</span>(state[<span class="hljs-string">'combined_output'</span>])
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f2cf4063d140d7ba1e38e35ef97a95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767440137&amp;x-signature=a5zpXIcYBWw8LeuQl9HtJRVB7P8%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<p>以上就是今天的全部内容，完整代码大家可以关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，并私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-13">五、总结</h2>
<p>本文分享了LangGraph智能体开发的设计模式：工作流模式和多智能体模式，同时详细讲解了三种核心工作流模式。提示链模式通过顺序分解任务与门控检查提升准确性；路由模式借助智能分类实现专业化任务分流；并行模式同时处理多个子任务以提升效率。这些模式为构建复杂、可靠的智能体系统提供了可复用的基础架构。当然今天的内容仅仅是开胃小菜，下一期内容笔者将分享更加灵活的设计模式：协调器-工作者模式和评估器-优化器模式，大家敬请期待。</p>
<p><a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>专栏内容源自笔者在实际学习和工作中对 LangChain 与 LangGraph 的深度使用经验，旨在帮助大家系统性地、高效地掌握 AI Agent 的开发方法，在各大技术平台获得了不少关注与支持。目前已更新34讲，正在更新LangGraph1.0速通指南，并随时补充笔者在实际工作中总结的拓展知识点。如果大家感兴趣，欢迎关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 大模型真好玩，每期分享涉及的代码均可在公众号私信: LangChain智能体开发免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tailwind CSS：用“类名编程”重构你的前端开发体验]]></title>    <link>https://juejin.cn/post/7588073726208671750</link>    <guid>https://juejin.cn/post/7588073726208671750</guid>    <pubDate>2025-12-27T11:45:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588073726208671750" data-draft-id="7588073726208655366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tailwind CSS：用“类名编程”重构你的前端开发体验"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-12-27T11:45:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tailwind CSS：用“类名编程”重构你的前端开发体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:45:10.000Z" title="Sat Dec 27 2025 11:45:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从前端“写样式”到“拼乐高”：Tailwind 是什么？</h2>
<p>如果你还在为 <code>.btn-primary-large-rounded-shadow-hover</code> 这种类名而失眠，那你可能需要认识一下这位前端界的“极简主义艺术家”——<strong>Tailwind CSS</strong>。</p>
<p>它不让你写 CSS，而是让你“<strong>用类名造 UI</strong>”。听起来像玄学？别急，举个🌰：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;button <span class="hljs-keyword">class</span>=<span class="hljs-string">"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"</span>&gt;
  我是按钮，点我不会怀孕
&lt;/button&gt;
</code></pre>
<p>看懂了吗？<code>px-4</code> 是内边距，<code>bg-blue-600</code> 是背景蓝，<code>hover:</code> 表示“当我被悬停时”，连动画过渡 <code>transition</code> 都给你安排得明明白白。</p>
<p>这不是代码，这是<strong>UI 的说明书</strong>。Tailwind 把 CSS 拆成一个个“原子类”，你只需要像搭乐高一样组合它们，就能快速构建出漂亮、响应式的界面。</p>
<hr/>
<h2 data-id="heading-1">二、从零开始：3 分钟搭建一个 React + Tailwind 项目（比泡面还快）</h2>
<p>我们来走一遍真实开发流程，保证你手不抖、心不慌。</p>
<h3 data-id="heading-2">✅ 第一步：初始化 Vite 项目（现代前端的“快捷启动键”）</h3>
<pre><code class="hljs language-bash" lang="bash">npm init vite
</code></pre>
<p>然后按提示走：</p>
<ul>
<li>项目名：<code>my-cool-app</code></li>
<li>框架：<code>React</code></li>
<li>变体：<code>JavaScript</code></li>
</ul>
<p>接着进入项目并安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> my-cool-app
npm install
</code></pre>
<blockquote>
<p>💡 小贴士：Vite 是新时代的打包工具，快得像开了氮气加速，热更新比你换台电视还快。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">✅ 第二步：安装 Tailwind（给 React 装上“喷气背包”）</h3>
<pre><code class="hljs language-bash" lang="bash">npm install -D tailwindcss postcss autoprefixer
</code></pre>
<blockquote>
<p>📌 注意：<code>-D</code> 表示开发依赖，毕竟生产环境不需要编译器帮你“拼类名”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">✅ 第三步：生成配置文件（Tailwind 的“出生证明”）</h3>
<pre><code class="hljs language-bash" lang="bash">npx tailwindcss init -p
</code></pre>
<p>这会生成两个关键文件：</p>
<ul>
<li><code>tailwind.config.js</code> —— Tailwind 的“大脑”</li>
<li><code>postcss.config.js</code> —— 编译流程的“交通警察”</li>
</ul>
<hr/>
<h3 data-id="heading-5">✅ 第四步：配置内容扫描路径（防止“内存泄漏”式打包）</h3>
<p>编辑 <code>tailwind.config.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import('tailwindcss').Config</span>} */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">content</span>: [
    <span class="hljs-string">"./index.html"</span>,
    <span class="hljs-string">"./src/**/*.{js,jsx}"</span>,
  ],
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">extend</span>: {},
  },
  <span class="hljs-attr">plugins</span>: [],
}
</code></pre>
<blockquote>
<p>⚠️ 划重点：<code>content</code> 字段告诉 Tailwind：“只打包我实际用到的类”，否则你会得到一个包含 10,000+ 类的 CSS 文件——那不是样式表，那是《CSS 百科全书》。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">✅ 第五步：引入 Tailwind（给项目注入“超能力”）</h3>
<p>在 <code>src/index.css</code> 中加入：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@tailwind</span> base;
<span class="hljs-keyword">@tailwind</span> components;
<span class="hljs-keyword">@tailwind</span> utilities;
</code></pre>
<p>然后在 <code>main.jsx</code> 引入这个 CSS：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>
</code></pre>
<p>最后，启动项目：</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>🎉 成功！你现在拥有了一个 <strong>React + Vite + Tailwind</strong> 的现代化前端开发环境，可以开始“类名编程”了！</p>
<hr/>
<h2 data-id="heading-7">三、Tailwind 的三大绝技：响应式、状态、原子化</h2>
<h3 data-id="heading-8">🔥 绝技一：移动端优先，响应式如丝般顺滑</h3>
<p>传统写法：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.layout</span> { <span class="hljs-attribute">display</span>: flex; }
}
</code></pre>
<p>Tailwind 写法：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;div className=<span class="hljs-string">"flex flex-col md:flex-row gap-4"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"md:w-2/3"</span>&gt;</span>主内容<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"md:w-1/3"</span>&gt;</span>侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<ul>
<li>移动端：垂直排列，占满宽度</li>
<li><code>md:</code> 断点以上：水平排列，主内容 2/3，侧边栏 1/3</li>
</ul>
<p>无需写一行媒体查询，Tailwind 已经帮你预设好断点（sm: 640px, md: 768px, lg: 1024px...），简直是“断点自由主义者”。</p>
<hr/>
<h3 data-id="heading-9">🔥 绝技二：状态管理不用 JS，CSS 自己搞定</h3>
<p>想实现“鼠标悬停变色 + 渐变动画”？</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;button className=<span class="hljs-string">"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition"</span>&gt;
  悬停我试试？
&lt;/button&gt;
</code></pre>
<ul>
<li><code>hover:bg-blue-700</code>：悬停时背景变深</li>
<li><code>transition</code>：加上平滑过渡</li>
<li>不需要 JS 监听 <code>onMouseEnter</code>，也不需要写额外 CSS</li>
</ul>
<p>Tailwind 支持 <code>focus:</code>、<code>active:</code>、<code>disabled:</code> 等伪类，真正做到了“<strong>样式即交互</strong>”。</p>
<hr/>
<h3 data-id="heading-10">🔥 绝技三：原子化类名，组合自由度拉满</h3>
<p>Tailwind 的每个类只做一件事：</p>
<ul>
<li><code>text-center</code> → 文本居中</li>
<li><code>mt-4</code> → 上边距 1rem</li>
<li><code>shadow-lg</code> → 大阴影</li>
<li><code>rounded-xl</code> → 超大圆角</li>
</ul>
<p>你可以像调鸡尾酒一样混合它们：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;div className=<span class="hljs-string">"bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition transform hover:scale-105"</span>&gt;
  我是一个会“呼吸”的卡片
&lt;/div&gt;
</code></pre>
<blockquote>
<p>🤯 想象一下：以前你要写 <code>.card-hover-effect</code>，现在直接用类名描述行为，连文档都不用写。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">四、React + Tailwind：组件化的“黄金搭档”</h2>
<p>Tailwind 和 React 是天作之合。来看一个实战例子：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">ArticleCard</span> = (<span class="hljs-params">{ title, summary }</span>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-5 bg-white rounded-xl shadow hover:shadow-lg transition border"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-bold text-gray-800"</span>&gt;</span>{title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500 mt-2"</span>&gt;</span>{summary}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ArticleCard</span> 
        <span class="hljs-attr">title</span>=<span class="hljs-string">"Tailwind 真香警告"</span> 
        <span class="hljs-attr">summary</span>=<span class="hljs-string">"用 utility class 快速构建 UI，告别 SCSS 嵌套地狱"</span> 
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ArticleCard</span> 
        <span class="hljs-attr">title</span>=<span class="hljs-string">"React 组件化哲学"</span> 
        <span class="hljs-attr">summary</span>=<span class="hljs-string">"把 UI 拆成乐高，组合出千变万化"</span> 
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>你会发现：</p>
<ul>
<li>样式全部由类名控制，组件逻辑更清晰</li>
<li>无需维护 <code>.scss</code> 文件，结构和样式都在 JSX 中</li>
<li>修改 UI？改几个类名就行，不用翻遍 CSS 文件</li>
</ul>
<hr/>
<h2 data-id="heading-12">五、常见误解 &amp; 正确打开方式</h2>
<h3 data-id="heading-13">❌ 误解一：“类名太多，HTML 变丑了”</h3>
<p><strong>反驳</strong>：HTML 本来就不是给人“读”的，是给浏览器“吃”的。你见过谁吐槽“这家餐厅菜单太长”吗？关键是菜好不好吃。</p>
<p>而且，你可以用 <code>@apply</code> 提取常用组合：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.btn-primary</span> {
  <span class="hljs-keyword">@apply</span> px-<span class="hljs-number">4</span> py-<span class="hljs-number">2</span> bg-blue-<span class="hljs-number">600</span> text-white rounded <span class="hljs-attribute">hover</span>:bg-blue-<span class="hljs-number">700</span> transition;
}
</code></pre>
<p>然后在 JSX 中：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;button className=<span class="hljs-string">"btn-primary"</span>&gt;提交&lt;/button&gt;
</code></pre>
<blockquote>
<p>✅ 建议：小项目直接用原子类，大项目可结合 <code>@apply</code> 或组件封装。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">❌ 误解二：“Tailwind 学习成本高”</h3>
<p><strong>真相</strong>：Tailwind 的命名极其规律：</p>
<ul>
<li><code>p-{size}</code> → padding</li>
<li><code>m-{direction}-{size}</code> → margin</li>
<li><code>text-{color}</code> → 文字颜色</li>
<li><code>w-{fraction}</code> → 宽度（w-1/2 就是 50%）</li>
</ul>
<p>背 10 个类，就能写 80% 的布局。官方文档搜索功能强大，<code>Ctrl+K</code> 一搜就出结果，比记 CSS 属性还快。</p>
<hr/>
<h2 data-id="heading-15">六、总结：Tailwind 是“懒人”的胜利，也是“高效者”的武器</h2>
<p>Tailwind 并不是要取代 CSS，而是提供了一种<strong>更高效、更一致、更可控</strong>的 UI 构建方式。</p>





















<table><thead><tr><th>传统 CSS</th><th>Tailwind</th></tr></thead><tbody><tr><td>写规则 → 编译 → 调试</td><td>直接用类名 → 实时预览</td></tr><tr><td>容易冗余、难复用</td><td>原子化、高复用</td></tr><tr><td>响应式需手动写 media query</td><td>断点前缀一键切换</td></tr></tbody></table>
<blockquote>
<p>🎯 <strong>适合谁？</strong></p>
<ul>
<li>快速原型开发</li>
<li>设计系统统一的项目</li>
<li>不想写 CSS 但又想要精致 UI 的人</li>
<li>想摆脱“<code>.container-wrapper-inner-content-box</code>”这种类名噩梦的人</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-16">最后一句暴言：</h2>
<blockquote>
<p><strong>“未来三年，不会用 Tailwind 的前端，就像不会用 Git 的程序员。”</strong></p>
</blockquote>
<p>别等了，现在就去 <code>npm create vite</code>，然后 <code>npm install -D tailwindcss</code>，开启你的“类名编程”之旅吧！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别抽卡！小红书联合复旦开源新神器，AI绘图终于能指哪打哪了]]></title>    <link>https://juejin.cn/post/7588149079416700982</link>    <guid>https://juejin.cn/post/7588149079416700982</guid>    <pubDate>2025-12-27T10:14:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079416700982" data-draft-id="7588149079416668214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别抽卡！小红书联合复旦开源新神器，AI绘图终于能指哪打哪了"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-27T10:14:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别抽卡！小红书联合复旦开源新神器，AI绘图终于能指哪打哪了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T10:14:50.000Z" title="Sat Dec 27 2025 10:14:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做过AI绘画的朋友大概都有过这种抓狂时刻：光影完美、画质惊艳，但你想让猫在左边、狗在右边，AI偏偏给你画成它们抱在一起，或者干脆把猫画到了天上。</p>
<p>这种“构图靠抽卡”的玄学时代，可能要被小红书AI团队和复旦大学联手终结了。</p>
<p>就在最近，一项名为 <strong>InstanceAssemble</strong> 的技术被顶会 NeurIPS 2025 收录，并直接在 GitHub 上开源。简单来说，它给 AI 装上了一个精准的“空间导航仪”，让文生图从“盲盒模式”进化到了“精准施工”阶段。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fgsdgfgfd-1024x490.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/gsdgfgfd-1024x490.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b82fa5d3224175bc25c04c6650fb3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767435290&amp;x-signature=lsa8vFZT9S0vtVIKpbCTvalsgR4%3D" alt="gsdgfgfd" loading="lazy"/></a></p>
<h2 data-id="heading-0">为什么现在的 AI 总是不听指挥？</h2>
<p>目前的顶流模型，无论是 Stable Diffusion 还是 Flux，在处理“空间布局”时都有个通病：它们更擅长理解画面的整体氛围，却很难理解具体的空间指令。</p>
<p>当你输入“左边放个苹果，右边放个香蕉”，AI 处理时往往是一股脑地把语义混合在一起。这就导致了业界著名的“语义泄漏”问题——比如把香蕉画成了红色，或者两个物体的位置完全错乱。一旦画面里的物体超过两三个，AI 基本就开始胡乱发挥了。</p>
<h2 data-id="heading-1">InstanceAssemble 的解题思路：分而治之</h2>
<p>InstanceAssemble 的核心逻辑非常像是一个严谨的施工队。它抛弃了以往那种“大锅乱炖”的生成方式，引入了一种被称为 <strong>“实例组装注意力（Instance Assembly Attention）”</strong> 的新机制。</p>
<p>你可以把它理解为“分区分组管理”：</p>
<ol>
<li><strong>全局控场</strong>：模型先通过基础架构生成画面的大背景和整体光影氛围。</li>
<li><strong>定点组装</strong>：对于你指定的每一个物体（比如沙发、台灯、挂画），技术会锁定它们各自的坐标区域（Bounding Box）。</li>
<li><strong>独立计算</strong>：最绝的一点在于，每个物体的注意力计算被严格限制在自己的“地盘”里。画沙发时，AI 绝不看旁边的台灯一眼。</li>
</ol>
<p>这种机制完美解决了物体之间的干扰问题。哪怕是面对那种包含二三十个物体的超复杂室内设计图，它也能保证每个物体都在它该在的地方，长成它该有的样子。</p>
<h2 data-id="heading-2">惊人的“轻量化”数据</h2>
<p>通常提到这种精细控制，大家的第一反应是：这得消耗多大的算力？模型得重训多久？</p>
<p>InstanceAssemble 给出的答案让人相当意外。它采用了 LoRA（低秩适配）方案，并不需要重新训练那个庞大的底模。</p>
<p>看看这组数据：</p>
<ul>
<li>适配 <strong>Stable Diffusion 3-Medium</strong>：只需增加约 <strong>3.46%</strong> 的参数量。</li>
<li>适配最新的 <strong>Flux.1</strong>：额外参数量甚至低至 <strong>0.84%</strong>。</li>
</ul>
<p>这意味着，你不需要为了这就换一张4090显卡，也不需要下载几百个G的新模型，仅仅通过外挂一个极轻量的模块，就能让当红炸子鸡 Flux 拥有顶级的布局控制能力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fsadasfsd.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/sadasfsd.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b759a4cd8384788bf23020b11cbc4b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767435290&amp;x-signature=eLLN4O2%2FND6Bdmb9F64iC%2BDNG%2BU%3D" alt="sadasfsd" loading="lazy"/></a></p>
<h2 data-id="heading-3">实战效果如何？</h2>
<p>为了验证这东西到底行不行，团队甚至专门搞了个高难度的测试集 <strong>DenseLayout</strong>，里面塞满了密密麻麻的物体布局。</p>
<p>测试结果显示，在处理包含10个以上物体的“地狱级”构图时，现有的大部分主流方法（如 ControlNet 或 GLIGEN）性能都会出现断崖式下跌，只有 InstanceAssemble 依然稳得住。它的布局对齐准确率比现有基线方法提升了整整一截。</p>
<p>更具实用价值的是，由于它训练时并没有见过那么密集的布局，但测试时却能完美泛化。也就是说，你哪怕给它一个从未见过的复杂广告排版，它也能依样画葫芦地生成出来。</p>
<h2 data-id="heading-4">写在最后</h2>
<p>InstanceAssemble 的出现，对于设计行业来说是个极大的利好。</p>
<p>以前设计师用 AI 做海报，最头疼的就是没法控制产品图的位置，往往需要生成几百张图再后期 PS 合成。现在，你只需要画好几个框，告诉 AI 这里放香水、那里放花瓣，一张符合排版规范的高质量商业图就出来了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-27_18.04.51.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-27_18.04.51.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa63b753c2f94e7a83db0a9324540cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767435290&amp;x-signature=VfG2W3MzdcVDelyuElglgSFqiK8%3D" alt="iShot_2025-12-27_18.04.51" loading="lazy"/></a></p>
<p>目前，该项目的代码和预训练模型已经全部在 GitHub 上开源。对于想要在广告设计、游戏美术或者电商素材生成领域应用 AI 的开发者和创作者来说，这绝对是一个值得立刻上手尝试的工具。</p>
<p>AI 绘画，正在从“玩具”向“工具”迈出坚实的一步。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官: “ 说一下 JS 中什么是事件循环 ? ”]]></title>    <link>https://juejin.cn/post/7588043318358949923</link>    <guid>https://juejin.cn/post/7588043318358949923</guid>    <pubDate>2025-12-27T09:36:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318358949923" data-draft-id="7588004376867504163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官: “ 说一下 JS 中什么是事件循环 ? ”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-27T09:36:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官: “ 说一下 JS 中什么是事件循环 ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T09:36:27.000Z" title="Sat Dec 27 2025 09:36:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JS 中的事件循环原理以及异步执行过程</h2>
<p>这些知识点对新手来说可能有点难，但是是必须迈过的坎，逃避是解决不了问题的，本篇文章旨在帮你彻底搞懂它们。</p>
<hr/>
<h2 data-id="heading-1">1. JS 是单线程的</h2>
<p>我们都知道 JS 是单线程执行的（原因：我们不想并行地操作 DOM，DOM 树不是线程安全的，如果多线程，那会造成冲突）。</p>
<p>这里小说明一下：V8 是谷歌浏览器的 JS 执行引擎，在运行 JS 代码的时候，是以函数作为一个个帧（保存当前函数的执行环境）按代码的执行顺序压入执行栈（call stack）中，栈顶的函数先执行，执行完毕后弹出再执行下一个函数。其中堆是用来存放各种 JS 对象的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84e209dca5f4171b1495763de9775ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=moHdlTyTSPHdOW%2BsgweuZUL4kA0%3D" alt="image.png" loading="lazy"/></p>
<p>假设浏览器就是上图的这种结构的话，执行同步代码是没什么问题的，如下</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">foo</span>() {
    <span class="hljs-built_in">bar</span>()
    console<span class="hljs-selector-class">.log</span>('foo')
}
function <span class="hljs-built_in">bar</span>() {
    <span class="hljs-built_in">baz</span>()
    console<span class="hljs-selector-class">.log</span>('bar')
}
function <span class="hljs-built_in">baz</span>() {
    console<span class="hljs-selector-class">.log</span>('baz')
}

<span class="hljs-built_in">foo</span>()
</code></pre>
<p>我们定义了 <code>foo</code>、<code>bar</code>、<code>baz</code> 三个函数，然后调用 <code>foo</code> 函数，控制台输出的结果为：</p>
<pre><code class="hljs">baz
bar
foo
</code></pre>
<p>执行过程如下：</p>
<ol>
<li>一个全局匿名函数最先执行（JS 的全局执行入口，之后的例子将忽略），遇到 <code>foo</code> 函数被调用，将 <code>foo</code> 函数压入执行栈。</li>
<li>执行 <code>foo</code> 函数，发现 <code>foo</code> 函数体中调用了 <code>bar</code> 函数，则将 <code>bar</code> 函数压入执行栈。</li>
<li>执行 <code>bar</code> 函数，发现 <code>bar</code> 函数体中调用了 <code>baz</code> 函数，又将 <code>baz</code> 函数压入执行栈。</li>
<li>执行 <code>baz</code> 函数，函数体中只有一条语句 <code>console.log('baz')</code>，执行，在控制台打印：<code>baz</code>，然后 <code>baz</code> 函数执行完毕弹出执行栈。</li>
<li>此时的栈顶为 <code>bar</code> 函数，<code>bar</code> 函数体中的 <code>baz()</code> 语句已经执行完，接着执行下一条语句（<code>console.log('bar')</code>），在控制台打印：<code>bar</code>，然后 <code>bar</code> 函数执行完毕弹出执行栈。</li>
<li>此时的栈顶为 <code>foo</code> 函数，<code>foo</code> 函数体中的 <code>bar()</code> 语句已经执行完，接着执行下一条语句（<code>console.log('foo')</code>），在控制台打印：<code>foo</code>，然后 <code>foo</code> 函数执行完毕弹出执行栈。</li>
<li>至此，执行栈为空，这一轮执行完毕。</li>
</ol>
<h4 data-id="heading-2">动图展示</h4>
<p><strong>还是图直观点，以上步骤对应的执行流程图如下：</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7babfceef98c4350854b9009daac673f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=xETmIWfBdx16y%2FGxFpfDIajXjgk%3D" alt="fc266fc5ceece50a1622961cf201eec5.gif" width="100%" loading="lazy"/>
<p><strong>非动图</strong> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4563ea7eca1e4c9c9c8150cbbb808191~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=OqHzjLatjxwHMU%2BGsUCvsojpNsA%3D" alt="image.png" width="100%" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">2. 事件循环（event loop）</h2>
<ul>
<li>
<p>事件循环：JS 处理异步任务的机制，因单线程特性，通过循环读取任务队列实现非阻塞。</p>
</li>
<li>
<p>过程：</p>
<ol>
<li>执行同步代码（调用栈清空）。</li>
<li>执行所有微任务（<code>Promise</code>回调等），直到微任务队列清空。</li>
<li>执行一个宏任务（<code>setTimeout</code>等），然后回到步骤 2，循环往复。</li>
</ol>
</li>
</ul>
<p>我们改变一下代码 1，
如下是代码 2：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">foo</span>() {
    <span class="hljs-built_in">bar</span>()
    console<span class="hljs-selector-class">.log</span>('foo')
}
function <span class="hljs-built_in">bar</span>() {
    <span class="hljs-built_in">baz</span>()
    console<span class="hljs-selector-class">.log</span>('bar')
}
function <span class="hljs-built_in">baz</span>() { 
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
        console<span class="hljs-selector-class">.log</span>('setTimeout: <span class="hljs-number">2s</span>')
    }, <span class="hljs-number">2000</span>)
    console<span class="hljs-selector-class">.log</span>('baz') 
}

<span class="hljs-built_in">foo</span>()
</code></pre>
<p>根据 1 中的假设，浏览器只由一个 JS 引擎构成的话，那么所有的代码必然同步执行（因为 JS 执行是单线程的，所以当前栈顶函数不管执行时间需要多久，执行栈中该函数下面的其他函数必须等它执行完弹出后才能执行（这就是代码被阻塞的意思）），执行到 <code>baz</code> 函数体中的 <code>setTimeout</code> 时应该等 2 秒，在控制台中输出 <code>setTimeout: 2s</code>，然后再输出：<code>baz</code>。所以我们期望的输出顺序应该是：<code>setTimeout: 2s -&gt; baz -&gt; bar -&gt; foo</code>（这是错的）。</p>
<p>浏览器如果真这样设计的话，肯定是有问题的！遇到 AJAX 请求、<code>setTimeout</code> 等比较耗时的操作时，我们页面需要长时间等待，就被阻塞住啥也干不了，出现了页面 “假死”，这样绝对不是我们想要的结果。</p>
<p>实际当然并非我以为的那样，这里先重点提醒一下：<strong>JS 是单线程的，这一点也没错，但是浏览器中并不仅仅只是由一个 JS 引擎构成，它还包括其他的一些线程来处理别的事情</strong>。如下图 !</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27284cf6e7584462a975b02db3927614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=ABAeyN2SPdhMnXATooMLIHiYYds%3D" alt="image.png" width="100%" loading="lazy"/>
<p>浏览器除了 JS 引擎（JS 执行线程，后面我们只关注 JS 引擎中的执行栈）以外，还有 Web APIs（浏览器提供的接口，这是在 JS 引擎以外的）线程、GUI 渲染线程等。JS 引擎在执行过程中，如果遇到相关的事件（DOM 操作、鼠标点击事件、滚轮事件、AJAX 请求、<code>setTimeout</code> 等），并不会因此阻塞，它会将这些事件移交给 Web APIs 线程处理，而自己则接着往下执行。Web APIs 则会按照一定的规则将这些事件放入一个任务队列（callback queue，也叫 task queue）中，当 JS 执行栈中的代码执行完毕以后，它就会去任务队列中获取一个事件回调放入执行栈中执行，然后如此往复，这就是所谓的事件循环机制。</p>





























<table><thead><tr><th>线程名</th><th>作用</th></tr></thead><tbody><tr><td><strong>JS 引擎线程</strong></td><td>也称为 JS 内核，负责处理 JavaScript 脚本。（例如 V8 引擎）<strong>①</strong>负责解析 JS 脚本，运行代码。<strong>②</strong>一直等待着任务队列中的任务的到来，然后加以处理。<strong>③</strong>一个 Tab 页（renderer 进程）中无论什么时候都只有一个 JS 线程运行 JS 程序。</td></tr><tr><td><strong>事件触发线程</strong></td><td>归属于渲染进程而不是 JS 引擎，用来控制事件循环。<strong>①</strong>当 JS 引擎执行代码块如<code>setTimeout</code>时（也可来自浏览器内核的其他线程，如鼠标点击、Ajax 异步请求等），会将对应任务添加到事件线程中。<strong>②</strong>当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待 JS 引擎的处理。                                                                                 <strong>注意</strong>：由于 JS 的单线程关系，所以这些待处理队列中的事件都是排队等待 JS 引擎处理，JS 引擎空闲时才会执行。</td></tr><tr><td><strong>定时触发器线程</strong></td><td><code>setInterval</code>和<code>setTimeout</code>所在的线程。<strong>①</strong>浏览器定时计数器并不是由 JS 引擎计数的。<strong>②</strong>JS 引擎是单线程的，如果处于阻塞线程状态就会影响计时的准确，因此，通过单独的线程来计时并触发定时。<strong>③</strong>计时完毕后，添加到事件队列中，等待 JS 引擎空闲后执行。<strong>注意</strong>：W3C 在 HTML 标准中规定，<code>setTimeout</code>中低于 4ms 的时间间隔算为 4ms。</td></tr><tr><td><strong>异步 HTTP 请求线程</strong></td><td><code>XMLHttpRequest</code>在连接后通过浏览器新开一个线程请求。当检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调放入事件队列中，再由 JS 引擎执行。</td></tr><tr><td><strong>GUI 渲染线程</strong></td><td>负责渲染浏览器界面，包括：<strong>①</strong>解析 HTML、CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。<strong>②</strong>重绘（Repaint）以及回流（Reflow）处理。</td></tr></tbody></table>
<p>这里让我们对事件循环先来做个<strong>小总结</strong>：</p>
<ol>
<li>JS线程负责处理JS代码，当遇到一些<strong>异步操作</strong>的时候，则将这些<strong>异步事件移交给Web APIs 处理</strong>，自己则继续往下执行。</li>
<li>Web APIs线程将接收到的事件按照一定规则按顺序<strong>添加到任务队列</strong>中（应该是添加到任务集合中的各个事件队列中）。</li>
<li>JS线程<strong>处理完当前的所有任务以后</strong>（执行栈为空），它会去查看任务队列中是否有等待被处理的事件，若有，则<strong>取出一个事件回调放入执行栈</strong>中执行。</li>
<li>然后不断循环第3步。</li>
</ol>
<p>让我们来看看真正的浏览器中执行是什么个流程吧！</p>
<h4 data-id="heading-4">动图展示</h4>
<p><strong>第二段代码</strong> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b59fc9945b1e4d41b4f7cdd7e982030c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=r%2BA2FvFKSJ4fg7dq813EQu8Vbo0%3D" alt="3.gif" width="100%" loading="lazy"/></p>
<p>细心的小伙伴可能有发现Web API在计时器时间到达后将匿名回调函数添加到任务队列中了，虽然定时器时间已到，但它目前并不能执行！！！因为JS的执行栈此时并非空，必须要等到当前执行栈为空后才有机会被召回到执行栈执行。由此，我们可以得出一个结论：<strong>setTimeout设置的时间其实只是最小延迟时间</strong>，而并不是确切的等待时间。（<strong>当主线程的任务耗时比较长的时候，等待时间将会变得更长</strong>）</p>
<hr/>
<h2 data-id="heading-5">3. 事件循环（进阶）与异步</h2>
<h3 data-id="heading-6">3.1 试试 <code>setTimeout(fn, 0)</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout: 0s'</span>)
}, <span class="hljs-number">0</span>);

<span class="hljs-title function_">foo</span>();
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">foo
setTimeout: <span class="hljs-number">0</span>s
</code></pre>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e31e9e87364ffeb0149d7f793b8255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=U66NZMaWK72gkAc0QVNdVPO4tMk%3D" alt="4.gif" width="100%" loading="lazy"/>
<p>即使 <code>setTimeout</code> 的延时设置为 0（实际上最小延时 &gt;= 4ms），JS 执行栈也将该延时事件发放给 Web API 处理，Web API 再将事件添加到任务队列中，等 JS 执行栈为空时，该延时事件再压入执行栈中执行。</p>
<hr/>
<h3 data-id="heading-7">3.2 事件循环中的 Promise</h3>
<p>其实以上的浏览器模型是ES5标准的，ES6+标准中的任务队列在此基础上新增了一种，变成了如下两种：</p>
<h4 data-id="heading-8">3.2.1 宏任务 / 微任务</h4>
<p>现在W3C重新对事件循环进行了定义,<strong>取消了宏任务</strong>,取而代之的是<strong><strong>任务队列</strong></strong>,微任务依旧保留,优先级为最高。</p>
<blockquote>
<p>MDN 官网 : 事件循环会将作业分成两类： <em>任务</em>和<em>微任务</em>。微任务具有更高的优先级，在任务队列被拉出之前，微任务队列会先被排空</p>
</blockquote>
<blockquote>
<p><strong>任务队列（macrotask queue）</strong> ：<strong>普通优先级</strong>的任务，通常包括：</p>
</blockquote>
<ul>
<li><code>setTimeout</code> / <code>setInterval</code> / <code>setImmediate</code>（Node.js）</li>
<li>I/O 操作（文件读写、Ajax事件 / 网络请求等）</li>
<li>UI 渲染事件 (用户交互事件)</li>
<li>脚本整体代码（第一次执行的同步代码）</li>
</ul>
<blockquote>
<p><strong>微任务队列（microtask queue）</strong> ：<strong>高优先级</strong>的任务，通常包括：</p>
</blockquote>
<ul>
<li><code>Promise.then</code> / <code>Promise.catch</code> / <code>Promise.finally</code></li>
<li><code>async/await</code> 中 <code>await</code> 后面的代码（其实是 <code>.then</code> 的语法糖）</li>
<li><code>MutationObserver</code>（浏览器）</li>
<li><code>process.nextTick</code>（Node.js，优先级比普通微任务更高）</li>
</ul>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/759f9827e0974e309c1b75cd905f9aa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=Z8FQRENJth1%2BKTUCGoKebYea4Vs%3D" alt="image.png" width="100%" loading="lazy"/>
<p>事件循环的处理流程变成了如下：</p>
<ol>
<li>JS 线程负责处理 JS 代码，当遇到一些异步操作的时候，则将这些异步事件移交给 Web APIs 处理，自己则继续往下执行。</li>
<li>Web APIs 线程将接收到的事件按照一定规则添加到任务队列中，宏事件添加到宏任务队列中，微事件添加到微事件队列中。</li>
<li>JS 线程处理完当前的所有任务以后（执行栈为空），它会先去微任务队列获取事件，并将微任务队列中的所有事件一件件执行完毕，直到微任务队列为空后再去宏任务队列中取出一个事件执行。</li>
<li>然后不断循环第 3 步。</li>
</ol>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c60d076b81c941f19f0979fa938856cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=07nVSf%2Bw7l2PhsICMBIw3Uoc4nU%3D" alt="image.png" width="70%" loading="lazy"/>
<p>排一下先后顺序： <strong>执行栈 --&gt; 微任务 --&gt; 渲染 --&gt; 下一个宏任务</strong>。</p>
<hr/>
<h4 data-id="heading-9">3.2.2 单独使用 Promise</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global start'</span>)

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise'</span>)
    <span class="hljs-title function_">resolve</span>()
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise then'</span>)
})

<span class="hljs-title function_">foo</span>()

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global end'</span>)
</code></pre>
<p>控制台输出的结果为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">global</span> <span class="hljs-keyword">start</span>
promise
foo
<span class="hljs-keyword">global</span> <span class="hljs-keyword">end</span>
promise <span class="hljs-keyword">then</span>
</code></pre>
<p><strong>动图展示</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2715f43c9f1744ddbe61e23fbf1141ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=rum87u1ykYIV79iEis1KQ4IVMXA%3D" alt="5.gif" width="100%" loading="lazy"/>
<p><strong>代码执行过程解析(文字描述)</strong></p>
<ol>
<li><strong>执行同步代码</strong></li>
</ol>
<ul>
<li>执行 <code>console.log('global start')</code>，控制台输出：global start</li>
</ul>
<ol start="2">
<li><strong>执行 <code>new Promise(...)</code></strong></li>
</ol>
<ul>
<li>
<p><strong>注意</strong>：在使用 <code>new</code> 关键字创建 <code>Promise</code> 对象时，传递给 <code>Promise</code> 的函数称为 <strong>executor</strong>。</p>
<ul>
<li>当 <code>Promise</code> 被创建时，<strong>executor 函数会自动同步执行</strong>。</li>
<li><code>.then</code> 里的回调才是异步执行的部分。</li>
</ul>
</li>
<li>
<p>执行 <code>Promise</code> 参数中的匿名函数（同步执行）：</p>
<ul>
<li>
<p>执行 <code>console.log('promise')</code>，控制台输出：promise</p>
</li>
<li>
<p>执行 <code>resolve()</code>，将 <code>Promise</code> 状态变为 <code>resolved</code>。</p>
</li>
</ul>
</li>
<li>
<p>继续执行 <code>.then(...)</code>：</p>
<ul>
<li>遇到 <code>.then</code> 会将回调提交给 <strong>Web API</strong> 处理。</li>
<li>Web API 将该回调添加到 <strong>微任务队列</strong>（此时微任务队列中有一个 Promise 事件待执行）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>继续执行同步代码</strong></li>
</ol>
<ul>
<li>
<p>执行栈在提交完 Promise 事件后，继续往下执行：</p>
<ul>
<li>
<p>执行 <code>foo()</code> 函数，控制台输出：foo</p>
</li>
<li>
<p>执行 <code>console.log('global end')</code>，控制台输出：global end</p>
</li>
</ul>
</li>
<li>
<p>至此，本轮事件循环的同步代码执行完毕，执行栈为空。</p>
</li>
</ul>
<ol start="4">
<li><strong>处理微任务队列</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制首先查看 <strong>微任务队列</strong> 是否为空：</p>
<ul>
<li>
<p>发现有一个 Promise 事件待执行，将其压入执行栈。</p>
</li>
<li>
<p>执行 <code>.then</code> 中的回调：</p>
<ul>
<li>执行 <code>console.log('promise then')</code>，控制台输出：promise then</li>
</ul>
</li>
<li>
<p>至此，新的一轮事件循环（Promise 事件）执行完毕，执行栈为空。</p>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>检查任务队列</strong></li>
</ol>
<ul>
<li>
<p>执行栈再次为空，事件循环：</p>
<ol>
<li>先查看 <strong>微任务队列</strong>，发现已空。</li>
<li>再查看 <strong>宏任务队列</strong>，发现也为空。</li>
</ol>
</li>
<li>
<p>执行栈进入等待事件状态。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-10">3.2.3 Promise 结合 setTimeout</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global start'</span>)

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout: 0s'</span>)
}, <span class="hljs-number">0</span>)

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise'</span>)
    <span class="hljs-title function_">resolve</span>()
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise then'</span>)
})

<span class="hljs-title function_">foo</span>()

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global end'</span>)
</code></pre>
<p>控制台输出的结果为：</p>
<pre><code class="hljs language-arduino" lang="arduino">global start
promise
foo
global end
promise then
setTimeout: <span class="hljs-number">0</span>s
</code></pre>
<p><strong>动图展示</strong></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d19dfd6c6d504401b305c98176137f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2D5a-7Z2lybGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767437343&amp;x-signature=6VQHqRrbjtquZa5pHYaMkfFYHn0%3D" alt="6.gif" width="100%" loading="lazy"/>
<ol>
<li><strong>执行同步代码</strong></li>
</ol>
<ul>
<li>执行 <code>console.log('global start')</code>，控制台输出：
global start</li>
</ul>
<ol start="2">
<li><strong>处理 <code>setTimeout</code>（改变部分）</strong></li>
</ol>
<ul>
<li>
<p>继续往下执行，遇到 <code>setTimeout</code>：</p>
<ul>
<li>JS 执行栈将其移交给 <strong>Web API</strong> 处理。</li>
<li>延迟 0 秒后，Web API 将 <code>setTimeout</code> 事件添加到 <strong>宏任务队列</strong>（此时宏任务队列中有一个 <code>setTimeout</code> 事件待处理）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>继续执行同步代码</strong></li>
</ol>
<ul>
<li>
<p>JS 线程转交 <code>setTimeout</code> 事件后，继续往下执行：</p>
<ul>
<li>
<p>遇到 <code>new Promise(...)</code>：</p>
<ul>
<li>
<p>Promise 的 executor 函数 <strong>同步执行</strong>：</p>
<ul>
<li>
<p>执行 <code>console.log('promise')</code>，控制台输出：promise</p>
</li>
<li>
<p>执行 <code>resolve()</code>，将 Promise 状态变为 <code>resolved</code>。</p>
</li>
</ul>
</li>
<li>
<p>执行 <code>.then(...)</code>：</p>
<ul>
<li>遇到 <code>.then</code> 会将回调提交给 <strong>Web API</strong> 处理。</li>
<li>Web API 将该回调添加到 <strong>微任务队列</strong>（此时微任务队列中有一个 Promise 事件待处理）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>继续执行同步代码</strong></li>
</ol>
<ul>
<li>
<p>执行栈在提交完 Promise 事件后，继续往下执行：</p>
<ul>
<li>
<p>执行 <code>foo()</code> 函数，控制台输出：foo</p>
</li>
<li>
<p>执行 <code>console.log('global end')</code>，控制台输出：global end</p>
</li>
</ul>
</li>
<li>
<p>至此，本轮事件循环的同步代码执行完毕，执行栈为空。</p>
</li>
</ul>
<ol start="5">
<li><strong>处理微任务队列</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制首先查看 <strong>微任务队列</strong> 是否为空：</p>
<ul>
<li>
<p>发现有一个 Promise 事件待执行，将其压入执行栈。</p>
</li>
<li>
<p>执行 <code>.then</code> 中的回调：</p>
<ul>
<li>执行 <code>console.log('promise then')</code>，控制台输出： promise then</li>
</ul>
</li>
<li>
<p>至此，新的一轮事件循环（Promise 事件）执行完毕，执行栈为空。</p>
</li>
</ul>
</li>
</ul>
<ol start="6">
<li><strong>处理宏任务队列（改变部分）</strong></li>
</ol>
<ul>
<li>
<p>执行栈再次为空，事件循环：</p>
<ol>
<li>
<p>先查看 <strong>微任务队列</strong>，发现已空。</p>
</li>
<li>
<p>再查看 <strong>宏任务队列</strong>，发现有一个 <code>setTimeout</code> 事件待处理：</p>
</li>
</ol>
<ul>
<li>
<p>将 <code>setTimeout</code> 中的匿名函数压入执行栈执行：</p>
<ul>
<li>执行 <code>console.log('setTimeout: 0s')</code>，控制台输出：setTimeout: 0s</li>
</ul>
</li>
<li>
<p>至此，新的一轮事件循环（<code>setTimeout</code> 事件）执行完毕，执行栈为空。</p>
</li>
</ul>
</li>
</ul>
<p>7.** 检查任务队列**</p>
<ul>
<li>
<p>执行栈再次为空，事件循环：</p>
<ol>
<li>先查看 <strong>微任务队列</strong>，发现已空。</li>
<li>再查看 <strong>宏任务队列</strong>，发现也为空。</li>
</ol>
</li>
<li>
<p>执行栈进入等待事件状态。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">3.3 事件循环中的 async/await</h3>
<p>这里简单介绍下async函数：</p>
<ol>
<li>
<p>函数前面 <strong>async 关键字的作用</strong>就2点：①这个函数总是返回一个promise。②允许函数内使用await关键字。</p>
</li>
<li>
<p><strong>关键字 await 使 async 函数一直等待</strong>（执行栈当然不可能停下来等待的，await将其后面的内容包装成promise交给Web APIs后，执行栈会跳出async函数继续执行），直到promise执行完并返回结果。<strong>await只在async函数函数里面奏效</strong>。</p>
</li>
<li>
<p>async函数只是一种比promise更优雅得获取promise结果（promise链式调用时）的一种语法而已。</p>
</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>)
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global start'</span>)
<span class="hljs-title function_">async1</span>()
<span class="hljs-title function_">foo</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'global end'</span>)
</code></pre>
<p>执行的结果如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">global</span> <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
foo
<span class="hljs-keyword">global</span> <span class="hljs-keyword">end</span>
async1 <span class="hljs-keyword">end</span>
</code></pre>
<ol>
<li><strong>执行同步代码</strong></li>
</ol>
<ul>
<li>执行 <code>console.log('global start')</code>，控制台输出：global start</li>
</ul>
<ol start="2">
<li><strong>调用 <code>async1()</code></strong></li>
</ol>
<ul>
<li>
<p>执行 <code>async1()</code>，进入 <code>async1</code> 函数体：</p>
<ul>
<li>
<p>执行 <code>console.log('async1 start')</code>，控制台输出：async1 start</p>
</li>
<li>
<p>执行 <code>await async2()</code>：</p>
<ul>
<li><code>await</code> 关键字会暂停 <code>async1</code> 函数的执行，直到 <code>await</code> 后面的 Promise 返回结果。</li>
<li><code>await async2()</code> 会像调用普通函数一样执行 <code>async2()</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>执行 <code>async2()</code></strong></li>
</ol>
<ul>
<li>
<p>进入 <code>async2</code> 函数体：</p>
<ul>
<li>
<p>执行 <code>console.log('async2')</code>，控制台输出：async2</p>
</li>
<li>
<p><code>async2</code> 函数执行结束，弹出执行栈。</p>
</li>
<li>
<p>由于 <code>async2</code> 没有显式返回 Promise，它会隐式返回一个已 resolved 的 Promise。</p>
</li>
</ul>
</li>
</ul>
<p>4.<strong>暂停 <code>async1()</code> 并继续执行同步代码</strong></p>
<ul>
<li>
<p>因为 <code>await</code> 关键字之后的代码被暂停，<code>async1</code> 函数执行结束，弹出执行栈。</p>
</li>
<li>
<p>JS 主线程继续向下执行：</p>
<ul>
<li>
<p>执行 <code>foo()</code> 函数，控制台输出：foo</p>
</li>
<li>
<p>执行 <code>console.log('global end')</code>，控制台输出：global end</p>
</li>
</ul>
</li>
<li>
<p>至此，本轮事件循环的同步代码执行完毕，执行栈为空。</p>
</li>
</ul>
<ol start="5">
<li><strong>事件循环处理微任务</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制开始工作：</p>
<ol>
<li>
<p>先查看 <strong>微任务队列</strong>：</p>
<ul>
<li>
<p>发现有一个微任务事件，该事件是 <code>async1</code> 函数中 <code>await async2()</code> 之后的代码（可以理解为：用一个匿名函数包裹 <code>await</code> 之后的代码，作为微任务事件）。</p>
</li>
<li>
<p>执行该微任务：</p>
<ul>
<li>执行 <code>console.log('async1 end')</code>，控制台输出：async1 end</li>
</ul>
</li>
</ul>
</li>
<li>
<p>执行栈再次为空，本轮事件执行结束。</p>
</li>
</ol>
</li>
</ul>
<ol start="6">
<li><strong>检查任务队列</strong></li>
</ol>
<ul>
<li>
<p>事件循环机制再次查看：</p>
<ol>
<li><strong>微任务队列</strong>：已空。</li>
<li><strong>宏任务队列</strong>：也为空。</li>
</ol>
</li>
<li>
<p>执行栈进入等待事件状态。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-12">4. 大综合（自测）</h2>
<h4 data-id="heading-13">4.1 简单融合</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>);
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2'</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>);
}, <span class="hljs-number">0</span>)

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>);
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>);
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
promise1
script <span class="hljs-keyword">end</span>
async1 <span class="hljs-keyword">end</span>
promise2
setTimeout
</code></pre>
<hr/>
<h4 data-id="heading-14">4.2 变形 1</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 end'</span>);
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>);
        <span class="hljs-title function_">resolve</span>();
    }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>);
    });
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>);
}, <span class="hljs-number">0</span>)

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise3'</span>);
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise4'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>);
</code></pre>
<p>输出的结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
promise1
promise3
script <span class="hljs-keyword">end</span>
promise2
async1 <span class="hljs-keyword">end</span>
promise4
setTimeout
</code></pre>
<hr/>
<h4 data-id="heading-15">4.3 变形 2</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async1 start'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout1'</span>);
    },<span class="hljs-number">0</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'async2'</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout3'</span>);
}, <span class="hljs-number">0</span>)

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>);
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>);
</code></pre>
<p>输出的结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
promise1
script <span class="hljs-keyword">end</span>
promise2
setTimeout3
setTimeout1
</code></pre>
<hr/>
<h4 data-id="heading-16">4.4 变形 3</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">a1</span> () {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a1 start'</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">a2</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a1 end'</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">a2</span> () {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a2'</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script start'</span>)

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'setTimeout'</span>)
}, <span class="hljs-number">0</span>)

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise1'</span>)
})

<span class="hljs-title function_">a1</span>()

<span class="hljs-keyword">let</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'promise2.then'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise2'</span>)
})

promise2.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise3'</span>)
    })
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'script end'</span>)
</code></pre>
<p>输出的结果：</p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
a1 <span class="hljs-keyword">start</span>
a2
promise2
script <span class="hljs-keyword">end</span>
promise1
a1 <span class="hljs-keyword">end</span>
promise2.then
promise3
setTimeout
</code></pre>
<hr/>
<h2 data-id="heading-17">5. 结语</h2>
<ul>
<li><strong>JS 是单线程执行的</strong>，同一时间只能处理一件事。</li>
<li><strong>浏览器是多线程的</strong>，JS 引擎通过分发这些耗时的异步事件给 Web APIs 线程处理，避<strong>免了单线程被阻塞。</strong></li>
<li>事件循环机制是为了协调事件、用户交互、JS 脚本、页面渲染、网络请求等事件的<strong>有序执行</strong>。</li>
<li><strong>微任务的优先级高于宏任务</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[el-table源码解读2-2——createStore()初始化方法]]></title>    <link>https://juejin.cn/post/7588028859541635098</link>    <guid>https://juejin.cn/post/7588028859541635098</guid>    <pubDate>2025-12-27T09:37:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541635098" data-draft-id="7588086766248181811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="el-table源码解读2-2——createStore()初始化方法"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-27T09:37:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            el-table源码解读2-2——createStore()初始化方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T09:37:53.000Z" title="Sat Dec 27 2025 09:37:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>1. createStore()初始化方法</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createStore&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">table</span>: <span class="hljs-title class_">Table</span>&lt;T&gt;,
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">TableProps</span>&lt;T&gt;
) {
  <span class="hljs-keyword">if</span> (!table) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Table is required.'</span>)
  }

  <span class="hljs-keyword">const</span> store = useStore&lt;T&gt;()
  <span class="hljs-comment">// fix https://github.com/ElemeFE/element/issues/14075</span>
  <span class="hljs-comment">// related pr https://github.com/ElemeFE/element/pull/14146</span>

  <span class="hljs-comment">/**
   * 原始方法：_toggleAllSelection 是执行全选/取消全选的逻辑
   * 防抖包装：用 debounce 包装，延迟 10ms 执行
   * 方法替换：将防抖后的方法赋值给 toggleAllSelection
   */</span>
  store.<span class="hljs-property">toggleAllSelection</span> = <span class="hljs-title function_">debounce</span>(store.<span class="hljs-property">_toggleAllSelection</span>, <span class="hljs-number">10</span>)
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">InitialStateMap</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
    <span class="hljs-comment">/**
     * props是Table组件的props，key是InitialStateMap的key
     * 这段代码用于初始化 store 的状态：
     * 遍历 InitialStateMap 的所有 key，从 props 中取值并同步到 store。
     */</span>
    <span class="hljs-title function_">handleValue</span>(<span class="hljs-title function_">getArrKeysValue</span>(props, key), key, store)
  })
  <span class="hljs-comment">// 监听InitialStateMap中定义的所有属性</span>
  <span class="hljs-title function_">proxyTableProps</span>(store, props)
  <span class="hljs-keyword">return</span> store
}
</code></pre>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">/**
   * 原始方法：_toggleAllSelection 是执行全选/取消全选的逻辑
   * 防抖包装：用 debounce 包装，延迟 10ms 执行
   * 方法替换：将防抖后的方法赋值给 toggleAllSelection
   */</span>
   
  store.<span class="hljs-property">toggleAllSelection</span> = <span class="hljs-title function_">debounce</span>(store.<span class="hljs-property">_toggleAllSelection</span>, <span class="hljs-number">10</span>)
  
<span class="hljs-comment">// 用户点击全选框时</span>
store.<span class="hljs-title function_">toggleAllSelection</span>()  <span class="hljs-comment">// 调用防抖后的方法</span>
  → debounce 延迟 10ms
    → <span class="hljs-title function_">_toggleAllSelection</span>()  <span class="hljs-comment">// 执行实际逻辑</span>
      → 修改 selection 和 isAllSelected 状态
      
为什么需要防抖？
_toggleAllSelection方法会遍历所有行数据、更新每行的选择状态、触发事件，
如果用户快速连续点击，可能会导致状态不一致、性能问题、<span class="hljs-variable constant_">UI</span>闪烁，而防抖可以避免这些问题      
</code></pre>
<p><strong>2. getArrKeysValue()</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 从 props 中按路径取值，支持嵌套属性（如 'treeProps.hasChildren'）
 * <span class="hljs-doctag">@param</span> props Table组件的props
 * <span class="hljs-doctag">@param</span> key InitialStateMap的key
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-keyword">function</span> getArrKeysValue&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">TableProps</span>&lt;T&gt;,
  <span class="hljs-attr">key</span>: string
) {
  <span class="hljs-keyword">if</span> ((key <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> props).<span class="hljs-title function_">includes</span>(<span class="hljs-string">'.'</span>)) {
    <span class="hljs-keyword">const</span> keyList = (key <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> props).<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>)
    <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: string | <span class="hljs-title class_">Record</span>&lt;string, any&gt; = props
    keyList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
      value = (value <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;string, any&gt;)[k]
    })
    <span class="hljs-keyword">return</span> value
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> (props <span class="hljs-keyword">as</span> any)[key] <span class="hljs-keyword">as</span> boolean | string
  }
}

</code></pre>
<p><strong>3. handleValue()</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 将props的值同步到store的状态中，并处理映射关系和默认值
 * <span class="hljs-doctag">@param</span> value 从props中按InitialStateMap的key取到的值，支持嵌套属性（如 'treeProps.hasChildren'）
 * <span class="hljs-doctag">@param</span> propsKey InitialStateMap的key
 * <span class="hljs-doctag">@param</span> store TableStore
 */</span>
<span class="hljs-keyword">function</span> handleValue&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">value</span>: string | boolean | <span class="hljs-title class_">Record</span>&lt;string, any&gt;,
  <span class="hljs-attr">propsKey</span>: string,
  <span class="hljs-attr">store</span>: <span class="hljs-title class_">Store</span>&lt;T&gt;
) {
  <span class="hljs-comment">// 保存从props中按InitialStateMap的key取到的原始值</span>
  <span class="hljs-keyword">let</span> newVal = value
  <span class="hljs-comment">// 从InitialStateMap获取映射配置</span>
  <span class="hljs-comment">// 可能是字符串（如 'rowKey'）或对象（如 { key: 'lazyColumnIdentifier', default: 'hasChildren' }）</span>
  <span class="hljs-keyword">let</span> storeKey = <span class="hljs-title class_">InitialStateMap</span>[propsKey <span class="hljs-keyword">as</span> keyof <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">InitialStateMap</span>]
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isObject</span>(storeKey)) {
    <span class="hljs-comment">// 如果newVal为空，则使用默认值</span>
    newVal = newVal || storeKey.<span class="hljs-property">default</span>
    storeKey = storeKey.<span class="hljs-property">key</span>
  }
  ; ((store.<span class="hljs-property">states</span> <span class="hljs-keyword">as</span> any)[storeKey] <span class="hljs-keyword">as</span> any).<span class="hljs-property">value</span> = newVal
}

</code></pre>
<p><strong>4. proxyTableProps()</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 用于监听 props 的变化，当 props 中的值改变时，自动同步到 store 的状态中
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">store</span>
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">props</span>
 */</span>
<span class="hljs-keyword">function</span> proxyTableProps&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultRow</span>&gt;(
  <span class="hljs-attr">store</span>: <span class="hljs-title class_">Store</span>&lt;T&gt;,
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">TableProps</span>&lt;T&gt;
) {
  <span class="hljs-comment">// 遍历 InitialStateMap 的所有 key，为每个 key 创建一个 watch 监听器</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">InitialStateMap</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
    <span class="hljs-title function_">watch</span>(
      <span class="hljs-comment">// 监听 getArrKeysValue(props, key) 的返回值</span>
      <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getArrKeysValue</span>(props, key),
      <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
        <span class="hljs-comment">// 当值变化时，调用 handleValue 同步到 store</span>
        <span class="hljs-title function_">handleValue</span>(value, key, store)
      }
    )
  })
}
</code></pre>
<h2 data-id="heading-0"><strong>核心编程思维提炼</strong></h2>
<h3 data-id="heading-1">1. 配置驱动编程（Configuration-Driven Programming）</h3>
<p>思维：将变化的部分抽离为配置，用统一逻辑处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 硬编码思维（你可能会这样写）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">syncPropsToStore</span>(<span class="hljs-params">props, store</span>) {
  store.<span class="hljs-property">states</span>.<span class="hljs-property">rowKey</span>.<span class="hljs-property">value</span> = props.<span class="hljs-property">rowKey</span>
  store.<span class="hljs-property">states</span>.<span class="hljs-property">data</span>.<span class="hljs-property">value</span> = props.<span class="hljs-property">data</span>
  store.<span class="hljs-property">states</span>.<span class="hljs-property">defaultExpandAll</span>.<span class="hljs-property">value</span> = props.<span class="hljs-property">defaultExpandAll</span>
  <span class="hljs-comment">// ... 每个都要写一遍</span>
}

<span class="hljs-comment">// ✅ 配置驱动思维（Element Plus 的做法）</span>
<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">rowKey</span>: <span class="hljs-string">'rowKey'</span>,
  <span class="hljs-attr">data</span>: <span class="hljs-string">'data'</span>,
  <span class="hljs-attr">defaultExpandAll</span>: <span class="hljs-string">'defaultExpandAll'</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(config).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  store.<span class="hljs-property">states</span>[config[key]].<span class="hljs-property">value</span> = props[key]
})
</code></pre>
<p>实际应用场景：</p>
<ul>
<li>API 字段映射：后端字段名 → 前端字段名</li>
</ul>

<ul>
<li>表单验证规则：统一配置，统一处理</li>
</ul>

<ul>
<li>权限控制：路由权限配置表</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 实际工作中的应用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_FIELD_MAP</span> = {
  <span class="hljs-string">'user_name'</span>: <span class="hljs-string">'userName'</span>,
  <span class="hljs-string">'create_time'</span>: <span class="hljs-string">'createTime'</span>,
  <span class="hljs-string">'user_info.avatar'</span>: <span class="hljs-string">'avatar'</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">transformApiData</span>(<span class="hljs-params">apiData</span>) {
  <span class="hljs-keyword">const</span> result = {}
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable constant_">API_FIELD_MAP</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">apiKey</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> frontendKey = <span class="hljs-variable constant_">API_FIELD_MAP</span>[apiKey]
    result[frontendKey] = <span class="hljs-title function_">getNestedValue</span>(apiData, apiKey)
  })
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h3 data-id="heading-2">2. 映射层模式（Mapping Layer Pattern）</h3>
<p>思维：在数据源和目标之间建立映射层，解耦命名差异。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 映射层的作用</span>
<span class="hljs-title class_">Props</span> 命名（用户友好）  →  映射层  →  <span class="hljs-title class_">Store</span> 命名（内部实现）
<span class="hljs-string">'treeProps.hasChildren'</span>  →  <span class="hljs-title class_">InitialStateMap</span>  →  <span class="hljs-string">'lazyColumnIdentifier'</span>
</code></pre>
<p>实际应用场景：</p>
<ul>
<li>第三方 API 对接：外部 API 字段 → 内部数据模型</li>
</ul>

<ul>
<li>多语言支持：语言 key → 翻译文本</li>
</ul>

<ul>
<li>状态机转换：状态名 → 状态值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 实际工作中的应用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS_MAP</span> = {
  <span class="hljs-string">'pending'</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'待处理'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'orange'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },
  <span class="hljs-string">'processing'</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'处理中'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">1</span> },
  <span class="hljs-string">'completed'</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'已完成'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'green'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getStatusInfo</span>(<span class="hljs-params">status</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">STATUS_MAP</span>[status] || <span class="hljs-variable constant_">STATUS_MAP</span>[<span class="hljs-string">'pending'</span>]
}
</code></pre>
<h3 data-id="heading-3">3. 数据转换管道（Data Transformation Pipeline）</h3>
<p>思维：将复杂的数据转换拆分为多个步骤，每个步骤职责单一。</p>
<p>解释 <code>reduce</code> 和数据管道的执行过程：</p>
<h4 data-id="heading-4"><code>reduce</code> 方法详解</h4>
<h4 data-id="heading-5">1. <code>reduce</code> 的基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript">array.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">accumulator, currentValue</span>) =&gt;</span> {
  <span class="hljs-comment">// 处理逻辑</span>
  <span class="hljs-keyword">return</span> newAccumulator
}, initialValue)
</code></pre>
<ul>
<li><code>accumulator</code>（累加器）：上一次处理的结果</li>
<li><code>currentValue</code>（当前值）：当前处理的元素</li>
<li><code>initialValue</code>（初始值）：第一次处理时的初始值</li>
</ul>
<h4 data-id="heading-6">2. 数据管道的执行过程</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dataPipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">transformApiFields</span>(data),      <span class="hljs-comment">// 步骤1：字段转换</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">validateData</span>(data),            <span class="hljs-comment">// 步骤2：数据验证</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">formatDates</span>(data),             <span class="hljs-comment">// 步骤3：日期格式化</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">enrichData</span>(data),              <span class="hljs-comment">// 步骤4：数据增强</span>
]

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">return</span> dataPipeline.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">data, transform</span>) =&gt;</span> <span class="hljs-title function_">transform</span>(data), rawData)
}
</code></pre>
<h4 data-id="heading-7">3. 逐步执行过程（拆解）</h4>
<p>等价写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-comment">// 初始值：rawData</span>
  <span class="hljs-keyword">let</span> result = rawData
  
  <span class="hljs-comment">// 第1次循环：transform = transformApiFields</span>
  result = <span class="hljs-title function_">transformApiFields</span>(result)
  <span class="hljs-comment">// 此时 result = transformApiFields(rawData)</span>
  
  <span class="hljs-comment">// 第2次循环：transform = validateData</span>
  result = <span class="hljs-title function_">validateData</span>(result)
  <span class="hljs-comment">// 此时 result = validateData(transformApiFields(rawData))</span>
  
  <span class="hljs-comment">// 第3次循环：transform = formatDates</span>
  result = <span class="hljs-title function_">formatDates</span>(result)
  <span class="hljs-comment">// 此时 result = formatDates(validateData(transformApiFields(rawData)))</span>
  
  <span class="hljs-comment">// 第4次循环：transform = enrichData</span>
  result = <span class="hljs-title function_">enrichData</span>(result)
  <span class="hljs-comment">// 此时 result = enrichData(formatDates(validateData(transformApiFields(rawData))))</span>
  
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h4 data-id="heading-8">4. 用具体例子演示</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设原始数据</span>
<span class="hljs-keyword">const</span> rawData = {
  <span class="hljs-attr">user_name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">create_time</span>: <span class="hljs-string">'2024-01-01'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
}

<span class="hljs-comment">// 定义转换函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">transformApiFields</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">userName</span>: data.<span class="hljs-property">user_name</span>,  <span class="hljs-comment">// 下划线转驼峰</span>
    <span class="hljs-attr">createTime</span>: data.<span class="hljs-property">create_time</span>,
    <span class="hljs-attr">age</span>: data.<span class="hljs-property">age</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">validateData</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">userName</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户名不能为空'</span>)
  <span class="hljs-keyword">return</span> data
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatDates</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    ...data,
    <span class="hljs-attr">createTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(data.<span class="hljs-property">createTime</span>).<span class="hljs-title function_">toLocaleDateString</span>()
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">enrichData</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    ...data,
    <span class="hljs-attr">status</span>: <span class="hljs-string">'active'</span>,
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)
  }
}

<span class="hljs-comment">// 数据管道</span>
<span class="hljs-keyword">const</span> dataPipeline = [
  transformApiFields,
  validateData,
  formatDates,
  enrichData
]

<span class="hljs-comment">// 执行过程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">return</span> dataPipeline.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">data, transform</span>) =&gt;</span> <span class="hljs-title function_">transform</span>(data), rawData)
}

<span class="hljs-comment">// 执行结果</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">processData</span>(rawData)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   userName: '张三',</span>
<span class="hljs-comment">//   createTime: '2024/1/1',</span>
<span class="hljs-comment">//   age: 25,</span>
<span class="hljs-comment">//   status: 'active',</span>
<span class="hljs-comment">//   id: 'abc123xyz'</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h4 data-id="heading-9">5. 执行流程图</h4>
<pre><code class="hljs language-css" lang="css">原始数据: { user_name: <span class="hljs-string">'张三'</span>, create_time: <span class="hljs-string">'2024-01-01'</span>, age: <span class="hljs-number">25</span> }
    ↓
<span class="hljs-selector-attr">[reduce 开始，初始值 = rawData]</span>
    ↓
步骤<span class="hljs-number">1</span>: <span class="hljs-built_in">transformApiFields</span>(rawData)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024-01-01'</span>, age: <span class="hljs-number">25</span> }
    ↓
步骤<span class="hljs-number">2</span>: <span class="hljs-built_in">validateData</span>(上一步结果)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024-01-01'</span>, age: <span class="hljs-number">25</span> } (验证通过)
    ↓
步骤<span class="hljs-number">3</span>: <span class="hljs-built_in">formatDates</span>(上一步结果)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024/1/1'</span>, age: <span class="hljs-number">25</span> }
    ↓
步骤<span class="hljs-number">4</span>: <span class="hljs-built_in">enrichData</span>(上一步结果)
    → { userName: <span class="hljs-string">'张三'</span>, createTime: <span class="hljs-string">'2024/1/1'</span>, age: <span class="hljs-number">25</span>, status: <span class="hljs-string">'active'</span>, id: <span class="hljs-string">'abc123xyz'</span> }
    ↓
最终结果
</code></pre>
<h4 data-id="heading-10">6. 用 for 循环等价写法（更容易理解）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">let</span> result = rawData  <span class="hljs-comment">// 初始值</span>
  
  <span class="hljs-comment">// 依次执行每个转换函数</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; dataPipeline.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> transform = dataPipeline[i]
    result = <span class="hljs-title function_">transform</span>(result)  <span class="hljs-comment">// 将上一步的结果作为下一步的输入</span>
  }
  
  <span class="hljs-keyword">return</span> result
}
</code></pre>
<h4 data-id="heading-11">7. 为什么用 <code>reduce</code>？</h4>
<p>优势：</p>
<ol>
<li>函数式编程：更简洁、声明式</li>
<li>链式处理：数据像流水线一样依次处理</li>
<li>易于扩展：添加新步骤只需在数组中添加函数</li>
<li>易于测试：每个转换函数可以独立测试</li>
</ol>
<h4 data-id="heading-12">8. 实际工作中的应用场景</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景1：表单数据处理</span>
<span class="hljs-keyword">const</span> formDataPipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">trimFields</span>(data),           <span class="hljs-comment">// 去除空格</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">validateRequired</span>(data),     <span class="hljs-comment">// 必填验证</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">validateFormat</span>(data),       <span class="hljs-comment">// 格式验证</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">transformToApiFormat</span>(data)  <span class="hljs-comment">// 转换为 API 格式</span>
]

<span class="hljs-comment">// 场景2：列表数据处理</span>
<span class="hljs-keyword">const</span> listDataPipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">transformFields</span>(data),      <span class="hljs-comment">// 字段转换</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">filterInvalid</span>(data),        <span class="hljs-comment">// 过滤无效数据</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">sortByDate</span>(data),           <span class="hljs-comment">// 按日期排序</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">paginate</span>(data)              <span class="hljs-comment">// 分页</span>
]

<span class="hljs-comment">// 场景3：API 响应处理</span>
<span class="hljs-keyword">const</span> apiResponsePipeline = [
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">extractData</span>(data),          <span class="hljs-comment">// 提取数据</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">handleError</span>(data),          <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">normalizeData</span>(data),      <span class="hljs-comment">// 数据标准化</span>
  <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">cacheData</span>(data)             <span class="hljs-comment">// 缓存数据</span>
]
</code></pre>
<h4 data-id="heading-13">9. 调试技巧</h4>
<p>如果想看每一步的结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
  <span class="hljs-keyword">return</span> dataPipeline.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">data, transform, index</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>:`</span>, data)
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">transform</span>(data)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span> 结果:`</span>, result)
    <span class="hljs-keyword">return</span> result
  }, rawData)
}
</code></pre>
<h4 data-id="heading-14">总结</h4>
<ul>
<li><code>reduce</code> 的作用：将数组中的每个函数依次执行，前一个函数的输出作为下一个函数的输入</li>
<li>数据管道：像工厂流水线，数据依次经过每个处理步骤</li>
<li>优势：代码简洁、易于扩展、易于测试</li>
</ul>
<p>这就是函数式编程中的“管道模式”（Pipeline Pattern）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[django操作mysql常见错误大全]]></title>    <link>https://juejin.cn/post/7588043318359015459</link>    <guid>https://juejin.cn/post/7588043318359015459</guid>    <pubDate>2025-12-27T10:45:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318359015459" data-draft-id="7587997157238571060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="django操作mysql常见错误大全"/> <meta itemprop="keywords" content="Django,MySQL"/> <meta itemprop="datePublished" content="2025-12-27T10:45:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            django操作mysql常见错误大全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T10:45:04.000Z" title="Sat Dec 27 2025 10:45:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>因为我的机器使用的是mysql容器，所以可以打印环境环境获取登录账密</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it db <span class="hljs-built_in">printenv</span> | grep MYSQL
</code></pre>
<p>下面用「Django + MySQL」的视角，把 <strong>开发/上线 99% 会踩的 MySQL 典型错误</strong> 汇总成一张“踩坑地图”。<br/>
每个错误都给出：</p>
<ol>
<li>异常堆栈（Django 真实报错）</li>
<li>根因一句话</li>
<li>复现代码（最小 Django 示例）</li>
<li>修复方案（含 ORM 写法或配置）</li>
</ol>
<p>复制即可复现，跟着敲一遍，以后看到同样日志秒定位。</p>
<hr/>
<h2 data-id="heading-0">0. 环境统一</h2>
<ul>
<li>Django 4.2 + mysqlclient 2.2 + MySQL 8.0</li>
<li>默认配置（不改 SQL_MODE）以便暴露问题</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># settings.py</span>
DATABASES = {
    <span class="hljs-string">"default"</span>: {
        <span class="hljs-string">"ENGINE"</span>: <span class="hljs-string">"django.db.backends.mysql"</span>,
        <span class="hljs-string">"NAME"</span>: <span class="hljs-string">"django_err"</span>,
        <span class="hljs-string">"USER"</span>: <span class="hljs-string">"root"</span>,
        <span class="hljs-string">"PASSWORD"</span>: <span class="hljs-string">"password"</span>,
        <span class="hljs-string">"HOST"</span>: <span class="hljs-string">"127.0.0.1"</span>,
        <span class="hljs-string">"PORT"</span>: <span class="hljs-string">"3306"</span>,
        <span class="hljs-string">"OPTIONS"</span>: {<span class="hljs-string">"init_command"</span>: <span class="hljs-string">"SET sql_mode='STRICT_TRANS_TABLES'"</span>},  <span class="hljs-comment"># 严格模式先打开</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-1">1. Duplicate entry —— 主键/唯一键冲突</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.IntegrityError: (1062, "Duplicate entry 'tom' for key 'users.username'")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(models.Model):
    username = models.CharField(max_length=<span class="hljs-number">50</span>, unique=<span class="hljs-literal">True</span>)

User.objects.create(username=<span class="hljs-string">"tom"</span>)
User.objects.create(username=<span class="hljs-string">"tom"</span>)  <span class="hljs-comment"># 再敲一次</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 代码层先查后插 或 数据库层 on conflict</span>
user, created = User.objects.get_or_create(username=<span class="hljs-string">"tom"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-2">2. Data too long —— 列长度超限</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.DataError: (1406, "Data too long for column 'title' at row 1")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span>(models.Model):
    title = models.CharField(max_length=<span class="hljs-number">10</span>)

Article.objects.create(title=<span class="hljs-string">"12345678901"</span>)  <span class="hljs-comment"># 11 个字符</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 要么改模型</span>
title = models.CharField(max_length=<span class="hljs-number">255</span>)
<span class="hljs-comment"># 要么截断</span>
Article.objects.create(title=long_title[:<span class="hljs-number">10</span>])
</code></pre>
<hr/>
<h2 data-id="heading-3">3. DoesNotExist —— 查询为空抛异常</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.core.exceptions.ObjectDoesNotExist: User matching query does not exist.
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python">user = User.objects.get(pk=<span class="hljs-number">999</span>)  <span class="hljs-comment"># 没有这条记录</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用 filter + first 或 get_object_or_404</span>
user = User.objects.<span class="hljs-built_in">filter</span>(pk=<span class="hljs-number">999</span>).first()  <span class="hljs-comment"># 返回 None</span>
<span class="hljs-keyword">from</span> django.shortcuts <span class="hljs-keyword">import</span> get_object_or_404
user = get_object_or_404(User, pk=<span class="hljs-number">999</span>)
</code></pre>
<hr/>
<h2 data-id="heading-4">4. Field cannot be null —— 非空约束</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.IntegrityError: (1048, "Column 'email' cannot be null")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(models.Model):
    email = models.EmailField()  <span class="hljs-comment"># 默认 blank=False, null=False</span>

User.objects.create(username=<span class="hljs-string">"tom"</span>)  <span class="hljs-comment"># 没给 email</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 允许空</span>
email = models.EmailField(blank=<span class="hljs-literal">True</span>, null=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 2. 给默认值</span>
email = models.EmailField(default=<span class="hljs-string">""</span>)
<span class="hljs-comment"># 3. 代码里传值</span>
User.objects.create(username=<span class="hljs-string">"tom"</span>, email=<span class="hljs-string">"tom@example.com"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-5">5. Incorrect string value —— 表情符/生僻字乱码</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (1366, "Incorrect string value: '\\xF0\\x9F\\x98\\x80...' for column 'nickname'")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python">User.objects.create(nickname=<span class="hljs-string">"😀"</span>)  <span class="hljs-comment"># utf8mb3 存不进 emoji</span>
</code></pre>
<p><strong>修复</strong></p>
<ol>
<li>数据库/表/列字符集改成 <code>utf8mb4</code>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> DATABASE django_err <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">CONVERT</span> <span class="hljs-keyword">TO</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
</code></pre>
<ol start="2">
<li>连接层也指定：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"OPTIONS"</span>: {<span class="hljs-string">"charset"</span>: <span class="hljs-string">"utf8mb4"</span>},
</code></pre>
<p>再插入 emoji 就正常了。</p>
<hr/>
<h2 data-id="heading-6">6. Lost connection —— 长查询被 kill</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (2013, 'Lost connection to MySQL server during query')
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 故意搞个大表全表扫 + 不睡觉</span>
User.objects.<span class="hljs-built_in">all</span>().select_related(<span class="hljs-string">"profile"</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">100000</span>]  <span class="hljs-comment"># 100 万次 join</span>
</code></pre>
<p><strong>修复</strong></p>
<ul>
<li>优化 SQL（加索引、分页、只取所需列）</li>
<li>调大 <code>wait_timeout</code> / <code>interactive_timeout</code>（治标不治本）</li>
<li>用 <code>iterator()</code> 分批拉：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> User.objects.<span class="hljs-built_in">all</span>().iterator(chunk_size=<span class="hljs-number">2000</span>):
    ...
</code></pre>
<hr/>
<h2 data-id="heading-7">7. Too many connections —— 连接打满</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (1040, 'Too many connections')
</code></pre>
<p><strong>复现</strong><br/>
并发压测 <code>ab -n 10000 -c 200 ...</code> 超过 <code>max_connections=151</code> 即可。</p>
<p><strong>修复</strong></p>
<ol>
<li>数据库层：温和涨上限</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> max_connections <span class="hljs-operator">=</span> <span class="hljs-number">300</span>;
</code></pre>
<ol start="2">
<li>应用层：用连接池 + 合理并发</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># settings.py 里加</span>
DATABASES[<span class="hljs-string">"default"</span>][<span class="hljs-string">"CONN_MAX_AGE"</span>] = <span class="hljs-number">600</span>  <span class="hljs-comment"># 复用连接</span>
</code></pre>
<ol start="3">
<li>代码里别泄露连接（长时间不 close）</li>
</ol>
<hr/>
<h2 data-id="heading-8">8. Deadlock found —— 并发死锁</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.OperationalError: (1213, 'Deadlock found when trying to get lock; try restarting transaction')
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 两个 view 同时</span>
<span class="hljs-meta">@transaction.atomic</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">debit</span>(<span class="hljs-params">request</span>):
    a = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>)
    b = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>)
    ...

<span class="hljs-comment"># 另一个线程反向顺序</span>
<span class="hljs-meta">@transaction.atomic</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">debit2</span>(<span class="hljs-params">request</span>):
    b = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>)  <span class="hljs-comment"># 先 2</span>
    a = Account.objects.select_for_update().get(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 后 1</span>
</code></pre>
<p>交叉拿锁 → 死锁。</p>
<p><strong>修复</strong></p>
<ul>
<li>固定加锁顺序（总是 1→2）</li>
<li>精简事务范围，尽快提交</li>
<li>捕获重试（Django 3.2+ 自动重试 <code>max_retries=3</code>）</li>
</ul>
<hr/>
<h2 data-id="heading-9">9. IntegrityError —— 外键级联失败</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.IntegrityError: (1452, 'Cannot add or update a child row: a foreign key constraint fails ...)
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)

Order.objects.create(user_id=<span class="hljs-number">9999</span>)  <span class="hljs-comment"># 不存在 user 9999</span>
</code></pre>
<p><strong>修复</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 保证外键值存在</span>
user = User.objects.get(pk=user_id)
Order.objects.create(user=user)
</code></pre>
<hr/>
<h2 data-id="heading-10">10. ProgrammingError —— 拼错 raw SQL</h2>
<p><strong>异常</strong></p>
<pre><code class="hljs language-django" lang="django">django.db.utils.ProgrammingError: (1064, "You have an error in your SQL syntax; check the manual ...")
</code></pre>
<p><strong>复现</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connection
<span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> c:
    c.execute(<span class="hljs-string">"SELCT * FROM users WHERE id = %s"</span>, [<span class="hljs-number">1</span>])  <span class="hljs-comment"># SELCT 拼错</span>
</code></pre>
<p><strong>修复</strong></p>
<ul>
<li>用 ORM 先顶一波，必须 raw 时开 <code>sql_mode=STRICT</code> 并打印语句再执行。</li>
</ul>
<hr/>
<h2 data-id="heading-11">一键速查表（打印贴墙）</h2>





















































<table><thead><tr><th>错误码</th><th>Django 异常</th><th>典型场景</th><th>最快修复</th></tr></thead><tbody><tr><td>1062</td><td>IntegrityError</td><td>唯一键冲突</td><td><code>get_or_create</code></td></tr><tr><td>1406</td><td>DataError</td><td>列太长</td><td>加长/截断</td></tr><tr><td>1048</td><td>IntegrityError</td><td>非空未给</td><td>设默认值</td></tr><tr><td>1366</td><td>OperationalError</td><td>emoji 乱码</td><td>改 <code>utf8mb4</code></td></tr><tr><td>2013</td><td>OperationalError</td><td>长查询</td><td>索引+分页</td></tr><tr><td>1040</td><td>OperationalError</td><td>连接打满</td><td>连接池+涨上限</td></tr><tr><td>1213</td><td>OperationalError</td><td>死锁</td><td>固定顺序+重试</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">结语</h2>
<p>把上面 10 个案例挨个 <code>python manage.py shell</code> 跑一遍，再遇到一样日志就能秒定位。<br/>
建议收藏 + 星标，下次面试/上线/救火，直接翻表。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter组件封装：视频播放组件全局封装]]></title>    <link>https://juejin.cn/post/7588028859540291610</link>    <guid>https://juejin.cn/post/7588028859540291610</guid>    <pubDate>2025-12-26T12:52:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859540291610" data-draft-id="7582777037864190002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter组件封装：视频播放组件全局封装"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T12:52:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SoaringHeart"/> <meta itemprop="url" content="https://juejin.cn/user/3544481219481374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter组件封装：视频播放组件全局封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481219481374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SoaringHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:52:52.000Z" title="Fri Dec 26 2025 12:52:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、需求来源</h2>
<p>最近要开发一个在线视频播放的功能，每次实时获取播放，有些卡顿和初始化慢的问题，就随手优化一下。</p>
<h2 data-id="heading-1">二、使用示例</h2>
<p>1、数据源</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoDetailsProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{

    <span class="hljs-comment">/// 当前播放中的</span>
    <span class="hljs-keyword">final</span> _videoModelController = <span class="hljs-type">StreamController</span>&lt;<span class="hljs-type">VideoDetailModel</span>?&gt;.broadcast();

    <span class="hljs-comment">/// 当前播放中 Stream&lt;VideoDetailModel&gt;</span>
    <span class="hljs-type">Stream</span>&lt;<span class="hljs-type">VideoDetailModel</span>?&gt; get videoModelStream =&gt; _videoModelController.stream;


    <span class="hljs-comment">/// 点击（model不为空时播放，为空时关闭）</span>
    sinkModelForVideoPlayer({required <span class="hljs-type">VideoDetailModel</span>? model}) {
      _videoModelController.add(model);
    }

}
</code></pre>
<p>2、显示播放器组件</p>
<pre><code class="hljs language-php" lang="php">StreamBuilder&lt;VideoDetailModel<span class="hljs-meta">?&gt;</span>(
  stream: provider.videoModelStream,
  builder: (context, snapshot) {
    <span class="hljs-keyword">if</span> (snapshot.data == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SizedBox</span>();
    }
    <span class="hljs-keyword">final</span> model = snapshot.data;
    <span class="hljs-keyword">if</span> (model?.isVideo != <span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SizedBox</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">SafeArea</span>(
      <span class="hljs-attr">top</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">bottom</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">left</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">right</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">Container</span>(
        <span class="hljs-attr">decoration</span>: <span class="hljs-title function_ invoke__">BoxDecoration</span>(
          <span class="hljs-attr">color</span>: Colors.black,
        ),
        <span class="hljs-attr">child</span>: <span class="hljs-title function_ invoke__">AppVideoPlayer</span>(
          <span class="hljs-attr">key</span>: <span class="hljs-title function_ invoke__">Key</span>(model?.url ?? <span class="hljs-string">""</span>),
          <span class="hljs-attr">url</span>: model?.url ?? <span class="hljs-string">""</span>,
          <span class="hljs-attr">onFullScreen</span>: (value) async {
            <span class="hljs-keyword">if</span> (!value) {
              await Future.<span class="hljs-title function_ invoke__">delayed</span>(<span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Duration</span>(<span class="hljs-attr">milliseconds</span>: <span class="hljs-number">300</span>));//等待旋转完成
              SystemChromeExt.<span class="hljs-title function_ invoke__">changeDeviceOrientation</span>(<span class="hljs-attr">isPortrait</span>: <span class="hljs-literal">true</span>);
            }
          },
          <span class="hljs-attr">onClose</span>: () {
            DLog.<span class="hljs-title function_ invoke__">d</span>(<span class="hljs-string">"close"</span>);
            provider.<span class="hljs-title function_ invoke__">sinkModelForVideoPlayer</span>(<span class="hljs-attr">model</span>: <span class="hljs-literal">null</span>);
          },
        ),
      ),
    );
  },
)
</code></pre>
<h2 data-id="heading-2">三、源码</h2>
<h4 data-id="heading-3">1、AppVideoPlayer.dart</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  AppVideoPlayer.dart</span>
<span class="hljs-comment">//  flutter_templet_project</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/12 18:11.</span>
<span class="hljs-comment">//  Copyright © 2025/12/12 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:chewie/chewie.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/basicWidget/AppVideoPlayer/AppVideoPlayerService.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/extension/extension_local.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:video_player/video_player.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">播放器</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> AppVideoPlayer({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.controller,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.url,
    <span class="hljs-keyword">this</span>.autoPlay = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.looping = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">this</span>.aspectRatio = <span class="hljs-number">16</span> / <span class="hljs-number">9</span>,
    <span class="hljs-keyword">this</span>.isPortrait = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.fullScreenVN,
    <span class="hljs-keyword">this</span>.onFullScreen,
    <span class="hljs-keyword">this</span>.onClose,
  });

  <span class="hljs-keyword">final</span> AppVideoPlayerController? controller;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> url;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> autoPlay;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> looping;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> aspectRatio;

  <span class="hljs-comment">/// <span class="markdown">设备方向</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isPortrait;

  <span class="hljs-keyword">final</span> ValueNotifier&lt;<span class="hljs-built_in">bool</span>&gt;? fullScreenVN;

  <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">bool</span> isFullScreen)? onFullScreen;

  <span class="hljs-keyword">final</span> VoidCallback? onClose;

  <span class="hljs-meta">@override</span>
  State&lt;AppVideoPlayer&gt; createState() =&gt; _AppVideoPlayerState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AppVideoPlayerState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AppVideoPlayer</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">WidgetsBindingObserver</span>, <span class="hljs-title">AutomaticKeepAliveClientMixin</span> </span>{
  VideoPlayerController? _videoController;
  ChewieController? _chewieController;

  <span class="hljs-built_in">Duration</span> position = <span class="hljs-built_in">Duration</span>.zero;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    widget.controller?._detach(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.removeObserver(<span class="hljs-keyword">this</span>);
    _onClose();
    <span class="hljs-comment">// 不销毁 VideoPlayerController，让全局复用</span>
    <span class="hljs-comment">// _chewieController?.dispose();</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    widget.controller?._attach(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.addObserver(<span class="hljs-keyword">this</span>);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      initPlayer();
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeAppLifecycleState(AppLifecycleState state) {
    <span class="hljs-keyword">switch</span> (state) {
      <span class="hljs-keyword">case</span> AppLifecycleState.inactive:
      <span class="hljs-keyword">case</span> AppLifecycleState.hidden:
      <span class="hljs-keyword">case</span> AppLifecycleState.paused:
        {
          _chewieController?.pause();
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> AppLifecycleState.detached:
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> AppLifecycleState.resumed:
        {
          _chewieController?.play();
        }
        <span class="hljs-keyword">break</span>;
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; initPlayer() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// DLog.d(widget.url.split("/").last);</span>
    <span class="hljs-keyword">assert</span>(widget.url.startsWith(<span class="hljs-string">"http"</span>), <span class="hljs-string">"url 错误"</span>);

    _videoController = <span class="hljs-keyword">await</span> AppVideoPlayerService.instance.getController(widget.url);

    _chewieController?.dispose();
    _chewieController = ChewieController(
      videoPlayerController: _videoController!,
      autoPlay: widget.autoPlay,
      looping: widget.looping,
      aspectRatio: widget.aspectRatio,
      autoInitialize: <span class="hljs-keyword">true</span>,
      allowFullScreen: <span class="hljs-keyword">true</span>,
      allowMuting: <span class="hljs-keyword">false</span>,
      showControlsOnInitialize: <span class="hljs-keyword">false</span>,
      <span class="hljs-comment">// customControls: const AppVideoControls(),</span>
    );

    _chewieController!.addListener(() {
      <span class="hljs-keyword">final</span> isFullScreen = _chewieController!.isFullScreen;
      widget.fullScreenVN?.value = isFullScreen;
      widget.onFullScreen?.call(isFullScreen);
      <span class="hljs-keyword">if</span> (isFullScreen) {
        DLog.d(<span class="hljs-string">"进入全屏"</span>);
      } <span class="hljs-keyword">else</span> {
        DLog.d(<span class="hljs-string">"退出全屏"</span>);
      }
    });
    <span class="hljs-keyword">if</span> (mounted) {
      setState(() {});
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _onClose() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_videoController?.value.isPlaying == <span class="hljs-keyword">true</span>) {
      _videoController?.pause();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(<span class="hljs-keyword">covariant</span> AppVideoPlayer oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    <span class="hljs-keyword">if</span> (oldWidget.url != widget.url) {
      initPlayer();
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeDependencies() {
    <span class="hljs-keyword">super</span>.didChangeDependencies();

    <span class="hljs-comment">/// <span class="markdown">🔥屏幕横竖切换时 rebuild Chewie，但不 rebuild video</span></span>
    DLog.d([MediaQuery.of(context).orientation]);
    <span class="hljs-comment">// setState(() {});</span>
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">super</span>.build(context);
    <span class="hljs-keyword">if</span> (widget.url.startsWith(<span class="hljs-string">"http"</span>) != <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> SizedBox();
    }

    <span class="hljs-keyword">if</span> (_chewieController == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: CircularProgressIndicator());
    }
    <span class="hljs-comment">// return Chewie(controller: _chewieController!);</span>
    <span class="hljs-keyword">return</span> Stack(
      children: [
        Positioned.fill(
          child: Chewie(
            controller: _chewieController!,
          ),
        ),
        Positioned(
          right: <span class="hljs-number">20</span>,
          top: <span class="hljs-number">10</span>,
          child: Container(
            <span class="hljs-comment">// decoration: BoxDecoration(</span>
            <span class="hljs-comment">//   color: Colors.red,</span>
            <span class="hljs-comment">//   border: Border.all(color: Colors.blue),</span>
            <span class="hljs-comment">// ),</span>
            child: buildCloseBtn(onTap: widget.onClose),
          ),
        ),
      ],
    );
  }

  Widget buildCloseBtn({VoidCallback? onTap}) {
    <span class="hljs-keyword">return</span> GestureDetector(
      behavior: HitTestBehavior.opaque,
      onTap: () {
        DLog.d(<span class="hljs-string">"buildCloseBtn"</span>);
        _onClose();
        <span class="hljs-keyword">if</span> (onTap != <span class="hljs-keyword">null</span>) {
          onTap();
          <span class="hljs-keyword">return</span>;
        }
        Navigator.pop(context);
      },
      child: Container(
        <span class="hljs-comment">// padding: EdgeInsets.all(6),</span>
        <span class="hljs-comment">// decoration: BoxDecoration(</span>
        <span class="hljs-comment">//   color: Colors.black54,</span>
        <span class="hljs-comment">//   shape: BoxShape.circle,</span>
        <span class="hljs-comment">//   border: Border.all(color: Colors.blue),</span>
        <span class="hljs-comment">// ),</span>
        child: <span class="hljs-keyword">const</span> Icon(Icons.close, color: Colors.white, size: <span class="hljs-number">24</span>),
      ),
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> wantKeepAlive =&gt; <span class="hljs-keyword">true</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayerController</span> </span>{
  _AppVideoPlayerState? _anchor;

  <span class="hljs-keyword">void</span> _attach(_AppVideoPlayerState anchor) {
    _anchor = anchor;
  }

  <span class="hljs-keyword">void</span> _detach(_AppVideoPlayerState anchor) {
    <span class="hljs-keyword">if</span> (_anchor == anchor) {
      _anchor = <span class="hljs-keyword">null</span>;
    }
  }

  VideoPlayerController? <span class="hljs-keyword">get</span> videoController {
    <span class="hljs-keyword">assert</span>(_anchor != <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> _anchor!._videoController;
  }

  ChewieController? <span class="hljs-keyword">get</span> chewieController {
    <span class="hljs-keyword">assert</span>(_anchor != <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> _anchor!._chewieController;
  }
}
</code></pre>
<h4 data-id="heading-4">2、AppVideoPlayerService.dart</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  AppVideoPlayerService.dart</span>
<span class="hljs-comment">//  flutter_templet_project</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by shang on 2025/12/12 18:10.</span>
<span class="hljs-comment">//  Copyright © 2025/12/12 shang. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_templet_project/extension/extension_local.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:quiver/collection.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:video_player/video_player.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">视频播放控制器全局管理</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppVideoPlayerService</span> </span>{
  AppVideoPlayerService._();
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AppVideoPlayerService _instance = AppVideoPlayerService._();
  <span class="hljs-keyword">factory</span> AppVideoPlayerService() =&gt; _instance;
  <span class="hljs-keyword">static</span> AppVideoPlayerService <span class="hljs-keyword">get</span> instance =&gt; _instance;

  <span class="hljs-comment">/// <span class="markdown">播放器字典</span></span>
  LruMap&lt;<span class="hljs-built_in">String</span>, VideoPlayerController&gt; <span class="hljs-keyword">get</span> controllerMap =&gt; _controllerMap;
  <span class="hljs-comment">// final _controllerMap = &lt;String, VideoPlayerController&gt;{};</span>
  <span class="hljs-keyword">final</span> _controllerMap = LruMap&lt;<span class="hljs-built_in">String</span>, VideoPlayerController&gt;(maximumSize: <span class="hljs-number">10</span>);

  <span class="hljs-comment">/// <span class="markdown">最新使用播放器</span></span>
  VideoPlayerController? current;

  <span class="hljs-comment">/// <span class="markdown">有缓存控制器</span></span>
  <span class="hljs-built_in">bool</span> hasCtrl({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> url}) =&gt; _controllerMap[url] != <span class="hljs-keyword">null</span>;

  <span class="hljs-comment">/// <span class="markdown">是网络视频</span></span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isVideo(<span class="hljs-built_in">String?</span> url) {
    <span class="hljs-keyword">if</span> (url?.isNotEmpty != <span class="hljs-keyword">true</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-keyword">final</span> videoUri = <span class="hljs-built_in">Uri</span>.tryParse(url!);
    <span class="hljs-keyword">if</span> (videoUri == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    <span class="hljs-keyword">final</span> videoExt = [<span class="hljs-string">'.mp4'</span>, <span class="hljs-string">'.mov'</span>, <span class="hljs-string">'.avi'</span>, <span class="hljs-string">'.wmv'</span>, <span class="hljs-string">'.flv'</span>, <span class="hljs-string">'.mkv'</span>, <span class="hljs-string">'.webm'</span>];
    <span class="hljs-keyword">final</span> ext = url.toLowerCase();
    <span class="hljs-keyword">final</span> result = videoExt.any((e) =&gt; ext.endsWith(e));
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">/// <span class="markdown">获取 VideoPlayerController</span></span>
  Future&lt;VideoPlayerController?&gt; getController(<span class="hljs-built_in">String</span> url, {<span class="hljs-built_in">bool</span> isLog = <span class="hljs-keyword">false</span>}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">assert</span>(url.startsWith(<span class="hljs-string">"http"</span>), <span class="hljs-string">"必须是视频链接,请检查链接是否合法"</span>);
    <span class="hljs-keyword">final</span> vc = _controllerMap[url];
    <span class="hljs-keyword">if</span> (vc != <span class="hljs-keyword">null</span>) {
      current = vc;
      <span class="hljs-keyword">if</span> (isLog) {
        DLog.d([<span class="hljs-string">"缓存: <span class="hljs-subst">${vc.hashCode}</span>"</span>]);
      }
      <span class="hljs-keyword">return</span> vc;
    }

    <span class="hljs-keyword">final</span> videoUri = <span class="hljs-built_in">Uri</span>.tryParse(url);
    <span class="hljs-keyword">if</span> (videoUri == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-keyword">final</span> ctrl = VideoPlayerController.networkUrl(videoUri);
    <span class="hljs-keyword">await</span> ctrl.initialize();
    _controllerMap[url] = ctrl;
    current = ctrl;
    <span class="hljs-keyword">if</span> (isLog) {
      DLog.d([<span class="hljs-string">"新建: <span class="hljs-subst">${_controllerMap[url].hashCode}</span>"</span>]);
    }
    <span class="hljs-keyword">return</span> ctrl;
  }

  <span class="hljs-comment">/// <span class="markdown">播放</span></span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; play({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> url, <span class="hljs-built_in">bool</span> onlyOne = <span class="hljs-keyword">true</span>}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> getController(url);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> e <span class="hljs-keyword">in</span> _controllerMap.entries) {
      <span class="hljs-keyword">if</span> (e.key == url) {
        <span class="hljs-keyword">if</span> (!e.value.value.isPlaying) {
          e.value.play();
        } <span class="hljs-keyword">else</span> {
          e.value.pause();
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (onlyOne) {
          e.value.pause();
        }
      }
    }
  }

  <span class="hljs-comment">/// <span class="markdown">暂停所有视频</span></span>
  <span class="hljs-keyword">void</span> pauseAll() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> e <span class="hljs-keyword">in</span> _controllerMap.entries) {
      e.value.pause();
    }
  }

  <span class="hljs-keyword">void</span> dispose(<span class="hljs-built_in">String</span> url) {
    _controllerMap[url]?.dispose();
    _controllerMap.remove(url);
  }

  <span class="hljs-keyword">void</span> disposeAll() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> c <span class="hljs-keyword">in</span> _controllerMap.values) {
      c.dispose();
    }
    _controllerMap.clear();
  }
}
</code></pre>
<h2 data-id="heading-5">最后、总结</h2>
<p>1、播放视频组件和视频列表是分开的，通过监听 VideoPlayerController 保持状态（播放，暂停）一致性，类似网络视频小窗口播放。</p>
<p>2、通过 AppVideoPlayerService 实现全局 VideoPlayerController 缓存，提高初始化加载速度。</p>
<p>3、通过 quiver 的 LruMap 实现最大缓存数控制，防止内存爆炸。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshang1219178163%2Fflutter_templet_project%2Ftree%2Fv3.27.0%2Flib%2FbasicWidget%2FAppVideoPlayer" target="_blank" title="https://github.com/shang1219178163/flutter_templet_project/tree/v3.27.0/lib/basicWidget/AppVideoPlayer" ref="nofollow noopener noreferrer">github</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端学习AI】Python环境搭建]]></title>    <link>https://juejin.cn/post/7588004601393266722</link>    <guid>https://juejin.cn/post/7588004601393266722</guid>    <pubDate>2025-12-27T09:04:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601393266722" data-draft-id="7588004601393250338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端学习AI】Python环境搭建"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T09:04:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端学习AI】Python环境搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T09:04:30.000Z" title="Sat Dec 27 2025 09:04:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">Anaconda：多版本环境管理工具</h2>
<h3 data-id="heading-1">工具概述</h3>
<p>Anaconda 是 Python 数据科学领域常用的环境管理工具，可快速创建、切换多版本 Python 环境，避免版本冲突，同时内置大量科学计算依赖包。</p>
<h3 data-id="heading-2">安装方式</h3>
<h4 data-id="heading-3">1. 下载渠道选择（优先镜像源）</h4>
<p>官方下载渠道存在两大痛点：① 需登录账号才能下载；② 服务器位于境外，国内下载速度极慢。</p>
<p><strong>推荐渠道</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fanaconda%2Farchive%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/" ref="nofollow noopener noreferrer">清华镜像源</a>，无需登录，下载速度快，资源与官方同步。</p>
<h4 data-id="heading-4">2. 版本选择原则</h4>
<p>核心标准：以「发布日期」为判断依据，优先选择最新版本，避免旧版本存在的兼容性错误、安装异常等问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8abfa762ea74bdfb015f629cd3d45ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5rOl56eN6I236Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767431070&amp;x-signature=Ew1mhq2W%2BqyonwoZ9hYuv8ivBGc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：不要直接选择网页最底部的版本，需按发布日期排序后挑选最新版。</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>：官方已停止发布Windows32位的软件</p>
</blockquote>
<h4 data-id="heading-5">3. 配置环境变量</h4>
<p>Anaconda 安装后需手动配置环境变量，否则无法在控制台直接使用 <code>conda</code> 命令。</p>
<h5 data-id="heading-6">3.1 配置步骤</h5>
<ol>
<li>进入系统设置：设置 → 系统 → 关于 → 高级系统设置 → 环境变量；</li>
<li>在「系统变量」中找到 <code>Path</code> 变量，点击「编辑」；</li>
<li>新增 Anaconda 相关路径（参考下方默认路径，需根据实际安装目录调整）；</li>
<li>保存配置，重启控制台使设置生效。</li>
</ol>
<h5 data-id="heading-7">3.2 默认环境变量路径（参考）</h5>
<pre><code class="hljs language-text" lang="text">C:\ProgramData\anaconda3
C:\ProgramData\anaconda3\Scripts
C:\ProgramData\anaconda3\Library\bin
</code></pre>
<h5 data-id="heading-8">3.3 安装与配置验证</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 conda 版本，正常显示版本号则安装配置成功</span>
conda --version
</code></pre>
<blockquote>
<p><strong>提示</strong>：若提示“conda 不是内部或外部命令”，请检查环境变量路径是否正确，或重启控制台重试。</p>
</blockquote>
<h3 data-id="heading-9">使用示例</h3>
<p>Anaconda 的核心价值在于环境的创建、切换、管理，建议使用 Anaconda  内置安装的界面应用 Anaconda  Navigator。</p>
<h2 data-id="heading-10">uv： Python 包管理器</h2>
<h3 data-id="heading-11">工具概述</h3>
<p>uv 由 Astral 公司基于 Rust 开发，兼容 pip 使用习惯，核心优势为「安装速度极快」「内存占用低」「内置虚拟环境管理」，是 pip/venv 的高效替代方案，可大幅提升包安装与项目管理效率。</p>
<h3 data-id="heading-12">安装方式</h3>
<h4 data-id="heading-13">1. 安装方法（优先镜像源）</h4>
<p>直接从官方源安装易因网络问题导致超时，推荐使用国内镜像源，Windows/macOS/Linux 系统通用。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清华 PyPI 镜像安装（推荐）</span>
pip3 install uv -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h5 data-id="heading-14">1.1 安装验证</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 uv 版本，正常显示版本号则安装成功</span>
uv --version
</code></pre>
<blockquote>
<p><strong>提示</strong>：若 Windows 系统提示“uv 不是内部或外部命令”，需检查 Python 的 Scripts 目录（如 C:\ProgramData\anaconda3\Scripts）是否加入环境变量，或重启终端重试。</p>
</blockquote>
<h3 data-id="heading-15">使用示例</h3>
<h4 data-id="heading-16">1. 初始化项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化名为 project_demo 的项目（会自动生成 pyproject.toml 文件）</span>
uv init project_demo
</code></pre>
<h4 data-id="heading-17">2. 配置镜像源</h4>
<p>在项目根目录的 <code>pyproject.toml</code> 文件中配置 uv 镜像源，确保后续包安装速度：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"project_demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.13"</span>  <span class="hljs-comment"># 需根据实际使用的 Python 版本调整</span>

<span class="hljs-section">[tool.uv]</span>
<span class="hljs-comment"># 配置清华 PyPI 镜像源</span>
<span class="hljs-attr">index-url</span> = <span class="hljs-string">"https://pypi.tuna.tsinghua.edu.cn/simple"</span>
</code></pre>
<blockquote>
<p><strong>提示</strong>：全局安装uv模块，需要以管理员身份运行cmd窗口</p>
</blockquote>
<h4 data-id="heading-18">3.安装模块</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 langchain_openai 模块</span>
uv add langchain_openai
</code></pre>
<h2 data-id="heading-19">Ruff：高性能代码检查与格式化工具</h2>
<h3 data-id="heading-20">工具概述</h3>
<p>Ruff 是基于 Rust 开发的 Python 代码检查（Linter）与格式化（Formatter）二合一工具，核心价值是自动化规范代码风格、检测潜在问题，提升开发效率与代码质量。</p>
<h3 data-id="heading-21">配置文件（pyproject.toml）</h3>
<p>通过项目根目录的 <code>pyproject.toml</code> 文件自定义 Ruff 规则，优先级高于默认配置，可适配项目专属规范。</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"project-demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.10"</span>

<span class="hljs-section">[tool.ruff]</span>
<span class="hljs-attr">target-version</span> = <span class="hljs-string">"py310"</span>  <span class="hljs-comment"># 适配的 Python 版本，与上方保持一致</span>
<span class="hljs-attr">line-length</span> = <span class="hljs-number">88</span>  <span class="hljs-comment"># 代码行长度限制（默认 88，符合 PEP8 规范）</span>

<span class="hljs-section">[tool.ruff.lint]</span>
<span class="hljs-comment"># 启用核心规则集（推荐，避免过度检查）</span>
<span class="hljs-attr">select</span> = [<span class="hljs-string">"E"</span>, <span class="hljs-string">"W"</span>, <span class="hljs-string">"F"</span>, <span class="hljs-string">"I"</span>, <span class="hljs-string">"B"</span>]
<span class="hljs-comment"># 禁用特定规则（根据项目需求调整，示例：禁用行长度检查）</span>
<span class="hljs-attr">disable</span> = [<span class="hljs-string">"E501"</span>]
<span class="hljs-comment"># 忽略无需检查的文件/目录（必配置，避免检查冗余文件）</span>
<span class="hljs-attr">exclude</span> = [
    <span class="hljs-string">"venv/"</span>,
    <span class="hljs-string">"__pycache__/"</span>,
    <span class="hljs-string">"build/"</span>,
    <span class="hljs-string">"dist/"</span>,
    <span class="hljs-string">".git/"</span>
]

<span class="hljs-section">[tool.ruff.format]</span>
<span class="hljs-attr">line-length</span> = <span class="hljs-number">88</span>  <span class="hljs-comment"># 格式化行长度与检查规则保持一致</span>
<span class="hljs-attr">quote-style</span> = <span class="hljs-string">"preserve"</span>  <span class="hljs-comment"># 保留原有引号风格（默认会统一为双引号）</span>
</code></pre>

























<table><thead><tr><th align="left">规则类别</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">E/W</td><td align="left">PEP8 规范相关问题（如缩进错误、空格缺失）</td></tr><tr><td align="left">F</td><td align="left">代码逻辑错误（如未定义变量、函数参数错误）</td></tr><tr><td align="left">I</td><td align="left">导入相关问题（如未使用导入、导入顺序混乱）</td></tr><tr><td align="left">B</td><td align="left">潜在 Bug 风险（如不安全的断言、空 except 语句）</td></tr></tbody></table>
<h3 data-id="heading-22">控制台集成</h3>
<h4 data-id="heading-23">1. 使用 pip 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础安装</span>
pip install ruff

<span class="hljs-comment"># 国内镜像源加速安装（推荐，解决下载慢问题）</span>
pip install ruff -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h5 data-id="heading-24">1.1 安装验证</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 Ruff 版本，正常显示版本号则安装成功</span>
ruff --version
</code></pre>
<h3 data-id="heading-25">控制台使用示例</h3>
<p>Ruff 的核心命令分为两类：「代码检查」（<code>ruff check</code>）和「代码格式化」（<code>ruff format</code>），分工明确，配合使用效果最佳。</p>
<h4 data-id="heading-26">代码格式化（ruff format）</h4>
<p>作用：自动优化代码样式，解决缩进混乱、空格缺失、行过长等格式问题，让代码整洁统一。</p>
<h5 data-id="heading-27">基础用法</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 格式化单个文件</span>
ruff format main.py

<span class="hljs-comment"># 格式化指定目录（递归处理所有 .py 文件）</span>
ruff format ./src/

<span class="hljs-comment"># 格式化当前目录所有文件（最常用）</span>
ruff format .
</code></pre>
<h5 data-id="heading-28">只检查不修改（--check 参数）</h5>
<p>适用于代码提交前校验，仅检测格式问题，不实际修改文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查单个文件格式</span>
ruff format --check main.py

<span class="hljs-comment"># 检查当前目录所有文件格式</span>
ruff format --check .
</code></pre>
<h4 data-id="heading-29">代码检查（ruff check）</h4>
<p>作用：检测代码中的逻辑错误、规范违规等问题（如未定义变量、未使用导入），仅报告问题，不主动修改文件。</p>
<h5 data-id="heading-30">基础用法</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查单个文件</span>
ruff check main.py

<span class="hljs-comment"># 检查当前目录所有文件</span>
ruff check .
</code></pre>
<h5 data-id="heading-31">自动修复问题（--fix 参数）</h5>
<p>一键修复支持自动修复的问题（如删除未使用导入、调整缩进）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动修复单个文件的可修复问题</span>
ruff check --fix main.py

<span class="hljs-comment"># 自动修复当前目录所有文件的可修复问题</span>
ruff check --fix .
</code></pre>
<h4 data-id="heading-32">核心命令区别对比</h4>



































<table><thead><tr><th align="left">命令</th><th align="left">核心目标</th><th align="left">是否修改文件</th><th align="left">典型场景</th></tr></thead><tbody><tr><td align="left">ruff format</td><td align="left">调整代码样式（美观度、统一性）</td><td align="left">✅ 是</td><td align="left">本地开发时统一代码格式</td></tr><tr><td align="left">ruff format --check</td><td align="left">检查格式问题，不修复</td><td align="left">❌ 否</td><td align="left">代码提交前格式合规校验</td></tr><tr><td align="left">ruff check</td><td align="left">检测代码错误、逻辑风险</td><td align="left">❌ 否</td><td align="left">开发中排查代码潜在问题</td></tr><tr><td align="left">ruff check --fix</td><td align="left">修复代码错误、规范违规问题</td><td align="left">✅ 是</td><td align="left">批量修复项目中的违规代码</td></tr></tbody></table>
<h3 data-id="heading-33">VS Code编辑器集成</h3>
<p>可实现「保存时自动格式化+自动修复问题」，无需手动执行命令，提升开发效率。</p>
<h4 data-id="heading-34">1. 安装 Ruff 插件</h4>
<ol>
<li>打开 VS Code，点击左侧「扩展」图标。</li>
<li>在搜索框输入「Ruff」，选择官方出品的插件。</li>
<li>点击「安装」，等待安装完成。</li>
</ol>
<h4 data-id="heading-35">2. 配置自动保存触发</h4>
<ol>
<li>在项目根目录新建文件夹 <code>.vscode</code>。</li>
<li>在 <code>.vscode</code> 文件夹内新建文件 <code>settings.json</code>。</li>
<li>写入以下配置：</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 保存时自动格式化代码</span>
    <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 保存时自动触发代码检查修复</span>
    <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"source.fixAll"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// 将 Ruff 设置为 Python 文件的默认格式化工具</span>
    <span class="hljs-attr">"[python]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"charliermarsh.ruff"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置生效后，编辑 Python 文件并保存（Ctrl+S），会自动执行 Ruff 格式化与可修复问题修复。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？]]></title>    <link>https://juejin.cn/post/7587998744294719494</link>    <guid>https://juejin.cn/post/7587998744294719494</guid>    <pubDate>2025-12-26T10:25:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294719494" data-draft-id="7587998744294424582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-26T10:25:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别传统低效！AgentRun 如何用 Serverless + Agent 打造现代化的舆情分析系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:25:17.000Z" title="Fri Dec 26 2025 10:25:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：江昱</p>
<p>舆情分析是企业感知市场脉搏、预警公关危机的“听诊器”，然而传统的舆情分析系统更像是一个个“手工作坊”，面临数据收集效率低、分析深度不够、实时性差等问题，经常反馈之后，等企业拿到报告时，舆论热点早已转移，错过最佳时间。这些挑战，正是所有舆情系统开发者共同的痛点。</p>
<p>本方案将基于真实的代码实现，向您介绍如何使用函数计算 AgentRun 平台，构建一个现代化的“舆情分析专家”，<strong>该系统不仅实现了从数据采集到报告生成的可视化、全流程自动化，更通过流式架构，让洞察实时呈现。</strong></p>
<h2 data-id="heading-0">系统架构设计</h2>
<p>整个舆情分析系统采用分层架构设计，核心思想是通过代码严格控制流程执行顺序，而非依赖 LLM 的自主决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2b33e0db21440e8a5e7692c9e80eee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=e17egUD1fN2nxegUH1NiMJ9QW9o%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">快速体验和效果预览</h2>
<p>在深入技术细节前，我们先直观感受一下这套系统的效果。通过 AgentRun 平台，只需简单几步即可完成部署。</p>
<h3 data-id="heading-2">快速部署</h3>
<p>打开阿里云函数计算 AgentRun 探索页面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8251150fb8fe44c3b0ce7b9bcca453af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=XigYs%2B%2FF2WIkqzNq7XkuS6etzWU%3D" alt="图片" loading="lazy"/></p>
<p>可以找到舆情分析专家案例，并点击卡片右下角进行部署，填写完整对应的参数信息即可点击右下角确定创建按钮：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e08339566414b16ae6d04f225f5403a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=h2f8rKDyFb4nUbxzwjurgt%2Ff8W4%3D" alt="图片" loading="lazy"/></p>
<p>此处需要稍等片刻，创建完之后可以看到体验地址，也可以跳转到运行时与沙箱看到部署完的 Agent：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b6f6d2b3394d4d902053ffa8c127be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=qaaZpWZiU82BqewpWU8nd9M5rRw%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f94cdee53e543a49247c8e2bf19ba3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=hKzteXD4wlEFD%2F1wXxPuCxp4i5E%3D" alt="图片" loading="lazy"/></p>
<p>首页地址即右侧 <code>main_web</code> 地址，直接查看线上效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04adff44127141059fa20f50a065734b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=xBW%2BaqF3Ff%2FS2qrqm%2BPughaIq64%3D" alt="图片" loading="lazy"/></p>
<p>也可以查看该应用案例代码，并进行在线二次开发：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff65e6b0fbf472383cfea7e62dc41f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=Gjct%2BWU%2BX0GtLt0iKi38vEHqzrA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">效果体验</h3>
<p>打开体验地址，可以看到舆情分析专家页面，此时可以输入一个词进行舆情分析：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e85d5f4bb89e4cc49bc5fb2d8bd6c99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=VqRXCcfCOQMNs6tRSPeG8ypMvZQ%3D" alt="图片" loading="lazy"/></p>
<p>分析过程中，系统会调用函数计算 AgentRun 的 Sandbox 沙箱（确切说是创建的时候，选择的浏览器沙箱），可以看到 AI 控制云上的浏览器进行数据检索：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da85bf3d6e474aeb83af3090b2cbb8e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=AtItZdsToxHhYgp9iLLbZ3I%2B8NA%3D" alt="图片" loading="lazy"/></p>
<p>完成之后，系统会整理所有采集到的数据和信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d657c650fbd4964b94801ac83e67c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=nBd6IoDZ5%2Bm1yr1Vj8iViXjDiYQ%3D" alt="图片" loading="lazy"/></p>
<p>最终生成文字+图表的“可视化报告”：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ee44786a594c39a7d3d9a1e6c0ae14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=4ud8UbB2u6GmL0VNgdL3oi%2FlHW8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb00b156cc44b8693697aa9034b5a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=mgJR4KqfHaD9Hzd6NWL0K0Zm0ug%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">AgentRun 相比传统方案的核心优势</h2>
<h3 data-id="heading-5">安全隔离的执行环境</h3>
<p>传统舆情系统通常直接在服务器上运行爬虫程序，面临着安全风险和环境污染问题。当某个网站的反爬机制触发时，可能影响整个服务器的稳定性。而 AgentRun Sandbox 提供了完全隔离的浏览器环境，即使单个采集任务出现问题，也不会影响系统的整体运行。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_browser_sandbox</span>() -&gt; <span class="hljs-type">Optional</span>[BrowserSandbox]:
    <span class="hljs-string">"""创建隔离的浏览器环境，避免环境污染"""</span>
    <span class="hljs-keyword">try</span>:
        sandbox = <span class="hljs-keyword">await</span> Sandbox.create_async(
            template_type=TemplateType.BROWSER,
            template_name=agentrun_browser_sandbox_name,
        )
        _sandboxes[sandbox.sandbox_id] = sandbox
        <span class="hljs-keyword">return</span> sandbox
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 单个Sandbox失败不影响其他实例</span>
        <span class="hljs-keyword">raise</span> SandboxCreationError(<span class="hljs-string">f"创建 Sandbox 失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-6">真实浏览器环境模拟</h3>
<p>传统爬虫方案通常使用简单的 HTTP 请求库，容易被现代网站的反爬机制识别和拦截。AgentRun Sandbox 提供的是真实的 Chrome 浏览器环境，能够完整执行 JavaScript、处理复杂的页面交互，大大提高了数据采集的成功率。从代码中可以看到，系统通过 Playwright 连接到真实的 Chrome 实例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-title">async_playwright</span>() <span class="hljs-keyword">as</span> playwright:
    browser</span> = <span class="hljs-keyword">await</span> playwright.chromium.connect_over_cdp(sandbox.get_cdp_url())
    context = browser.contexts[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> browser.contexts <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> browser.new_context()
    page = context.pages[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> context.pages <span class="hljs-keyword">else</span> <span class="hljs-keyword">await</span> context.new_page()
</code></pre>
<h3 data-id="heading-7">可视化调试能力</h3>
<p>函数计算 AgentRun 最独特的优势是提供了实时的 VNC 预览功能，开发者和用户可以实时观察浏览器的操作过程。这种透明性在传统方案中是无法实现的，它不仅有助于调试和优化采集逻辑，还能让用户直观地了解系统的工作状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6f57bcd347d48788a3d988d39013957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=vOQWwMQljnWyZPeKCmaGs0cfHUs%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">弹性扩展和故障恢复</h3>
<p>传统系统在面临大规模采集任务时，往往需要复杂的分布式架构设计。而函数计算 AgentRun 天然支持多 Sandbox 并行处理，系统可以根据需要动态创建和销毁浏览器实例。更重要的是，当某个实例出现故障时，系统能够自动检测并重建：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">recreate_sandbox_if_closed</span>(<span class="hljs-params">sandbox_id: <span class="hljs-built_in">str</span>, error_message: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""智能故障检测和自动重建机制"""</span>
    closed_error_patterns = [
        <span class="hljs-string">"Target page, context or browser has been closed"</span>,
        <span class="hljs-string">"Browser has been closed"</span>,
        <span class="hljs-string">"Connection closed"</span>,
    ]
    is_closed_error = <span class="hljs-built_in">any</span>(pattern.lower() <span class="hljs-keyword">in</span> error_message.lower() 
                         <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> closed_error_patterns)
    <span class="hljs-keyword">if</span> is_closed_error:
        <span class="hljs-keyword">await</span> remove_sandbox(sandbox_id)
        new_sandbox = <span class="hljs-keyword">await</span> create_browser_sandbox()
        <span class="hljs-keyword">return</span> new_sandbox
</code></pre>
<p>AgentRun Sandbox 采用阿里云函数计算实现，支持百万沙箱模板（函数级别）并发运行，Serverless 弹性伸缩，支持 3.5w+ 沙箱/分钟，支持缩容到 0，按请求感知调度。</p>
<h2 data-id="heading-9">后端核心实现</h2>
<h3 data-id="heading-10">Agent 工具链设计</h3>
<p>系统的核心是一个基于 PydanticAI 的智能体，该智能体包含四个关键工具，每个工具负责舆情分析的不同阶段。Agent 的设计遵循严格的执行顺序，确保数据收集的完整性和分析的准确性。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">opinion_agent</span> = Agent(
    agentrun_model,
    <span class="hljs-attr">deps_type</span>=StateDeps,
    <span class="hljs-attr">system_prompt</span>=<span class="hljs-string">"""你是舆情分析系统的执行者。
你的任务是按照以下严格流程执行舆情分析：
【流程】
1. 收到关键词后，调用 collect_data 工具收集数据
2. 数据收集完成后，调用 analyze_data 工具分析数据
3. 分析完成后，调用 write_report 工具撰写报告
4. 报告完成后，调用 render_html 工具生成 HTML
【重要规则】
- 必须按顺序调用工具
- 每个工具只调用一次
- 不要跳过任何步骤
- 不要编造数据
"""</span>,
    <span class="hljs-attr">retries</span>=<span class="hljs-number">3</span>,
)
</code></pre>
<h3 data-id="heading-11">流式输出与实时反馈</h3>
<p>传统舆情系统通常采用批处理模式，用户需要等待很长时间才能看到结果。而基于函数计算 AgentRun 的系统实现了真正的流式输出，用户可以实时观察每个处理步骤的进展。这种实时性不仅提升了用户体验，也便于及时发现和解决问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">push_state_event</span>(<span class="hljs-params">run_id: <span class="hljs-built_in">str</span>, state: OpinionState</span>):
    <span class="hljs-string">"""实时推送状态更新，用户无需等待"""</span>
    event = StateSnapshotEvent(
        <span class="hljs-built_in">type</span>=EventType.STATE_SNAPSHOT,
        snapshot=state.model_dump(),
        timestamp=<span class="hljs-built_in">int</span>(time.time() * <span class="hljs-number">1000</span>)
    )
    <span class="hljs-keyword">await</span> event_manager.push_event(run_id, event)
</code></pre>
<h3 data-id="heading-12">智能数据质量控制</h3>
<p>系统实现了严格的数据质量控制机制，通过多维度评估确保收集到的数据具有较高的相关性和价值。这种质量控制在传统系统中往往是缺失的，导致大量噪音数据影响分析结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, title: <span class="hljs-built_in">str</span>, snippet: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""多维度相关性评估，确保数据质量"""</span>
    text = <span class="hljs-string">f"<span class="hljs-subst">{title}</span> <span class="hljs-subst">{snippet}</span>"</span>
    text_lower = text.lower()
    <span class="hljs-comment"># 检测关键词匹配度</span>
    has_chinese_keyword = <span class="hljs-built_in">any</span>(<span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'鿿'</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> keyword)
    result_has_chinese = <span class="hljs-built_in">any</span>(<span class="hljs-string">'\u4e00'</span> &lt;= char &lt;= <span class="hljs-string">'鿿'</span> <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> text)
    <span class="hljs-comment"># 中文关键词必须在结果中有中文内容</span>
    <span class="hljs-keyword">if</span> has_chinese_keyword <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> result_has_chinese:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 排除明显的无关网站</span>
    irrelevant_patterns = [
        <span class="hljs-string">"calculator"</span>, <span class="hljs-string">"deepseek"</span>, <span class="hljs-string">"chegg"</span>, <span class="hljs-string">"stackoverflow"</span>, 
        <span class="hljs-string">"翻译"</span>, <span class="hljs-string">"dictionary"</span>, <span class="hljs-string">"词典"</span>
    ]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(pattern <span class="hljs-keyword">in</span> text_lower <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> irrelevant_patterns):
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    <span class="hljs-comment"># 计算相关性得分</span>
    score = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> text:
        score += <span class="hljs-number">0.6</span>  <span class="hljs-comment"># 基础分</span>
    <span class="hljs-comment"># 时效性加分</span>
    time_keywords = [<span class="hljs-string">"最新"</span>, <span class="hljs-string">"今日"</span>, <span class="hljs-string">"近日"</span>, <span class="hljs-string">"2024"</span>, <span class="hljs-string">"2025"</span>]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>(tk <span class="hljs-keyword">in</span> text <span class="hljs-keyword">for</span> tk <span class="hljs-keyword">in</span> time_keywords):
        score += <span class="hljs-number">0.1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">min</span>(<span class="hljs-number">1.0</span>, score))
</code></pre>
<h2 data-id="heading-13">深度内容抓取技术</h2>
<h3 data-id="heading-14">平台适配策略</h3>
<p>不同的社交媒体平台具有不同的页面结构和内容组织方式，传统系统往往采用统一的抓取策略，导致数据质量参差不齐。AgentRun 系统针对不同平台实现了定制化的抓取逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">explore_page_with_llm</span>(<span class="hljs-params">page, keyword: <span class="hljs-built_in">str</span>, url: <span class="hljs-built_in">str</span>, source: <span class="hljs-built_in">str</span>, initial_content: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""基于平台特性的智能内容抓取"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"weibo.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># 微博特定的评论和转发抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".WB_feed_expand, [class*='comment']"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_retweets"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".WB_feed_expand, [class*='repost']"</span>},
        ]
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"zhihu.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># 知乎回答和评论抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_more_answers"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".AnswerItem, .List-item"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".Comments-container, .CommentItem"</span>},
        ]
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"bilibili.com"</span> <span class="hljs-keyword">in</span> url:
        <span class="hljs-comment"># B站视频评论抓取</span>
        available_actions = [
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_comments"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".reply-item, .root-reply"</span>},
            {<span class="hljs-string">"action"</span>: <span class="hljs-string">"view_related"</span>, <span class="hljs-string">"selector"</span>: <span class="hljs-string">".video-page-card, .recommend-list"</span>},
        ]
</code></pre>
<h3 data-id="heading-15">LLM 驱动的智能探索</h3>
<p>系统创新性地引入了 LLM 驱动的智能探索机制，让 AI 决定是否需要深入抓取某个页面的额外内容，如评论区、相关推荐等。这种智能决策大大提高了数据采集的效率和针对性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">llm_decide_exploration</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, page_url: <span class="hljs-built_in">str</span>, page_content: <span class="hljs-built_in">str</span>, source: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""LLM 智能决策是否进行深度探索"""</span>
    prompt = <span class="hljs-string">f"""请根据以下信息决定是否需要进一步探索页面获取更多舆情数据。
【搜索关键词】<span class="hljs-subst">{keyword}</span>
【当前页面】<span class="hljs-subst">{page_url}</span>
【已获取内容预览】<span class="hljs-subst">{page_content[:<span class="hljs-number">500</span>]}</span>
【决策标准】
1. 如果当前内容已经足够丰富，可能不需要进一步探索
2. 如果是微博/B站等平台，评论区通常包含重要的舆情信息
3. 权衡时间成本，每个页面最多探索1-2个操作
请返回 JSON 格式的决策结果。
"""</span>
    result = <span class="hljs-keyword">await</span> explorer.run(prompt)
    <span class="hljs-keyword">return</span> json.loads(result.output)
</code></pre>
<h2 data-id="heading-16">前端 VNC 集成实现</h2>
<h3 data-id="heading-17">动态库加载机制</h3>
<p>前端 VNC 客户端需要动态加载 noVNC 库，系统实现了智能的加载机制，支持本地资源和 CDN 回退：</p>
<pre><code class="hljs language-ini" lang="ini">function loadScript(url) {
    return new Promise(function(resolve, reject) {
        var <span class="hljs-attr">script</span> = document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.src</span> = baseUrl + url<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.onload</span> = resolve<span class="hljs-comment">;</span>
        <span class="hljs-attr">script.onerror</span> = function() {
            // 本地加载失败，尝试 CDN
            var <span class="hljs-attr">fallbackUrl</span> = url.includes(<span class="hljs-string">'wordcloud'</span>) 
                ? 'https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js'
                : 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js'<span class="hljs-comment">;</span>
            var <span class="hljs-attr">fallbackScript</span> = document.createElement(<span class="hljs-string">'script'</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.src</span> = fallbackUrl<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.onload</span> = resolve<span class="hljs-comment">;</span>
            <span class="hljs-attr">fallbackScript.onerror</span> = reject<span class="hljs-comment">;</span>
            document.head.appendChild(fallbackScript)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
        document.head.appendChild(script)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-18">多协议适配</h3>
<p>考虑到部署环境的复杂性，VNC 组件实现了 HTTP/HTTPS 环境下的 WebSocket 协议自适应：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> adjustWebSocketUrl = useCallback((url: string): string =&gt; {
    <span class="hljs-keyword">const</span> isHttps = window.location.protocol === <span class="hljs-string">'https:'</span>;
    <span class="hljs-keyword">if</span> (!isHttps &amp;&amp; url.startsWith(<span class="hljs-string">'wss://'</span>)) {
        <span class="hljs-keyword">return</span> url.replace(<span class="hljs-string">'wss://'</span>, <span class="hljs-string">'ws://'</span>);
    }
    <span class="hljs-keyword">if</span> (isHttps &amp;&amp; url.startsWith(<span class="hljs-string">'ws://'</span>)) {
        <span class="hljs-keyword">return</span> url.replace(<span class="hljs-string">'ws://'</span>, <span class="hljs-string">'wss://'</span>);
    }
    <span class="hljs-keyword">return</span> url;
}, []);
</code></pre>
<h2 data-id="heading-19">智能分析与报告生成</h2>
<h3 data-id="heading-20">标准化情感分析</h3>
<p>系统实现了基于关键词词典的情感分析算法，相比传统的机器学习模型，这种方法更加透明和可控：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SentimentStandards</span>:
    <span class="hljs-string">"""情感倾向标准化计算"""</span>
    POSITIVE_KEYWORDS = [
        <span class="hljs-string">"优秀"</span>, <span class="hljs-string">"卓越"</span>, <span class="hljs-string">"创新"</span>, <span class="hljs-string">"领先"</span>, <span class="hljs-string">"突破"</span>, <span class="hljs-string">"成功"</span>, <span class="hljs-string">"赞"</span>, <span class="hljs-string">"好评"</span>, <span class="hljs-string">"支持"</span>,
        <span class="hljs-string">"认可"</span>, <span class="hljs-string">"满意"</span>, <span class="hljs-string">"信赖"</span>, <span class="hljs-string">"期待"</span>, <span class="hljs-string">"看好"</span>, <span class="hljs-string">"值得"</span>, <span class="hljs-string">"推荐"</span>, <span class="hljs-string">"喜欢"</span>
    ]
    NEGATIVE_KEYWORDS = [
        <span class="hljs-string">"差"</span>, <span class="hljs-string">"糟糕"</span>, <span class="hljs-string">"失败"</span>, <span class="hljs-string">"落后"</span>, <span class="hljs-string">"问题"</span>, <span class="hljs-string">"缺陷"</span>, <span class="hljs-string">"批评"</span>, <span class="hljs-string">"质疑"</span>, <span class="hljs-string">"担忧"</span>,
        <span class="hljs-string">"失望"</span>, <span class="hljs-string">"不满"</span>, <span class="hljs-string">"抱怨"</span>, <span class="hljs-string">"投诉"</span>, <span class="hljs-string">"差评"</span>, <span class="hljs-string">"垃圾"</span>, <span class="hljs-string">"骗局"</span>
    ]
    @<span class="hljs-built_in">staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_sentiment_score</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""计算情感得分 (-1.0 到 1.0)"""</span>
        positive_count = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> SentimentStandards.POSITIVE_KEYWORDS <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> text)
        negative_count = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span> <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> SentimentStandards.NEGATIVE_KEYWORDS <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> text)
        total_count = positive_count + negative_count
        <span class="hljs-keyword">if</span> total_count == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">return</span> (positive_count - negative_count) / total_count
</code></pre>
<h3 data-id="heading-21">流式报告生成</h3>
<p>报告生成过程采用流式输出，用户可以实时观察报告的撰写过程，这种体验是传统系统无法提供的：</p>
<pre><code class="hljs language-ini" lang="ini">async with writer.run_stream(report_prompt) as result:
    async for text in result.stream_text():
        <span class="hljs-attr">report_content</span> = text
        <span class="hljs-attr">state.report_text</span> = report_content
        <span class="hljs-attr">current_time</span> = asyncio.get_event_loop().time()
        <span class="hljs-attr">content_delta</span> = len(report_content) - last_event_length
        <span class="hljs-attr">time_delta</span> = current_time - last_event_time
        <span class="hljs-comment"># 每 100 字符或每 0.3 秒发送一次更新</span>
        if content_delta &gt;= 100 or time_delta &gt;= 0.3:
            await push_state_event(run_id, state)
</code></pre>
<h2 data-id="heading-22">部署与运维优势</h2>
<h3 data-id="heading-23">简化的部署流程</h3>
<p>相比传统舆情系统需要复杂的分布式爬虫集群部署，AgentRun 系统的部署相对简单。只需要配置好环境变量和 AgentRun Sandbox 模板，系统就能自动管理浏览器实例的创建和销毁：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 核心配置</span>
<span class="hljs-attr">AGENTRUN_MODEL_NAME</span>=your_model_name
<span class="hljs-attr">MODEL_NAME</span>=qwen3-max
<span class="hljs-attr">AGENTRUN_BROWSER_SANDBOX_NAME</span>=your_browser_template
<span class="hljs-attr">TIMEOUT</span>=<span class="hljs-number">180</span>
</code></pre>
<h3 data-id="heading-24">自动化运维能力</h3>
<p>系统内置了完善的监控和自恢复机制，大大降低了运维复杂度。当检测到异常时，系统能够自动重建资源，保证服务的连续性：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 连接失败时自动重连（每 10 秒尝试一次）</span>
useEffect(() =&gt; {
    if (<span class="hljs-attr">status</span> === <span class="hljs-string">'error'</span> &amp;&amp; active &amp;&amp; rfbLoaded) {
        <span class="hljs-attr">reconnectTimerRef.current</span> = setTimeout(() =&gt; {
            cleanupRfb()<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastUrlRef.current</span> = null<span class="hljs-comment">;</span>
            fetchVncUrl(true)<span class="hljs-comment">;</span>
        }, RECONNECT_INTERVAL)<span class="hljs-comment">;</span>
    }
}, <span class="hljs-section">[status, active, rfbLoaded]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-25">性能与扩展性分析</h2>
<h3 data-id="heading-26">并发处理能力</h3>
<p>传统系统的并发能力往往受限于单机资源，而函数计算 AgentRun 系统可以根据需要动态创建多个 Sandbox 实例，实现真正的水平扩展。系统通过异步编程模型和连接池管理，能够高效处理大量并发请求：</p>
<pre><code class="hljs language-ini" lang="ini">uvicorn.run(
    "main:app",
    <span class="hljs-attr">host</span>=<span class="hljs-string">"0.0.0.0"</span>,
    <span class="hljs-attr">port</span>=<span class="hljs-number">8000</span>,
    <span class="hljs-attr">log_level</span>=<span class="hljs-string">"info"</span>,
    <span class="hljs-attr">timeout_keep_alive</span>=<span class="hljs-number">120</span>,
    <span class="hljs-attr">limit_concurrency</span>=<span class="hljs-number">100</span>,  <span class="hljs-comment"># 支持高并发</span>
)
</code></pre>
<h3 data-id="heading-27">资源弹性管理</h3>
<p>系统实现了智能的资源管理策略，能够根据任务负载动态调整 Sandbox 实例数量。这种弹性扩展能力是传统固定架构难以实现的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_sandboxes</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-string">"""动态获取所有可用的Sandbox实例"""</span>
    result = []
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> _sandbox_lock:
        <span class="hljs-keyword">for</span> sandbox_id, sandbox <span class="hljs-keyword">in</span> _sandboxes.items():
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 检查实例健康状态</span>
                vnc_url = sandbox.get_vnc_url()
                result.append({
                    <span class="hljs-string">"sandbox_id"</span>: sandbox_id,
                    <span class="hljs-string">"vnc_url"</span>: vnc_url,
                    <span class="hljs-string">"active"</span>: <span class="hljs-literal">True</span>,
                })
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-comment"># 自动清理失效实例</span>
                result.append({
                    <span class="hljs-string">"sandbox_id"</span>: sandbox_id,
                    <span class="hljs-string">"active"</span>: <span class="hljs-literal">False</span>,
                })
    <span class="hljs-keyword">return</span> result
</code></pre>
<h2 data-id="heading-28">总结</h2>
<p>基于函数计算 AgentRun 构建的舆情分析系统展现了现代 AI 技术在实际业务场景中的强大应用潜力。相比传统方案，函数计算 AgentRun 系统在安全性、可靠性、可观测性和扩展性方面都具有显著优势。</p>
<p>通过隔离的浏览器环境，系统解决了传统爬虫面临的安全风险和环境污染问题。实时的 VNC 预览功能提供了前所未有的透明度，让开发者和用户能够直观地观察系统工作状态。智能的故障检测和自恢复机制大大降低了运维复杂度，而流式输出设计则显著提升了用户体验。</p>
<p>更重要的是，函数计算 AgentRun 系统将复杂的舆情分析任务完全自动化，从多平台数据采集、深度内容抓取、智能情感分析到专业报告生成，整个流程无需人工干预。这种端到端的自动化能力，结合 AI 技术的持续进步，将为企业和机构的舆情分析工作带来革命性的改变。</p>
<p>欢迎加入“函数计算 AgentRun 客户群”与我们交流，钉钉群号：134570017218。</p>
<p><strong>快速了解函数计算 AgentRun：</strong></p>
<p><strong>一句话介绍：</strong> 函数计算 AgentRun 是一个以高代码为核心的一站式 Agentic AI 基础设施平台。秉持生态开放和灵活组装的理念，为企业级 Agent 应用提供从开发、部署到运维的全生命周期管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7333e7a6ace849a3a84cd2cef2836b4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349516&amp;x-signature=PGzjK9qak75XL0U0Ax7gSsa1tBw%3D" alt="图片" loading="lazy"/></p>
<p><em>函数计算 AgentRun 架构图</em></p>
<p>AgentRun 运行时基于阿里云函数计算 FC 构建，继承了 Serverless 计算极致弹性、按量付费、零运维的核心优势。通过深度集成 AgentScope、Langchain、RAGFlow、Mem0 等主流开源生态。AgentRun 将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，助力企业实现成本与效率的极致优化，平均 TCO 降低 60%。 </p>
<p>让开发者只需专注于 Agent 的业务逻辑创新，无需关心底层基础设施，让 Agentic AI 真正进入企业生产环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS复杂去重一定要先排序吗？深度解析与性能对比]]></title>    <link>https://juejin.cn/post/7588002126258110470</link>    <guid>https://juejin.cn/post/7588002126258110470</guid>    <pubDate>2025-12-26T09:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588002126258110470" data-draft-id="7587995707165442067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS复杂去重一定要先排序吗？深度解析与性能对比"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-26T09:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Fronty"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS复杂去重一定要先排序吗？深度解析与性能对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Fronty
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:53:34.000Z" title="Fri Dec 26 2025 09:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>在日常开发中，数组去重是JavaScript中常见的操作。对于简单数据类型，我们通常会毫不犹豫地使用Set。但当面对复杂对象数组时，很多开发者会产生疑问：复杂去重一定要先排序吗？</p>
<p>这个问题背后其实隐藏着几个更深层次的考量:</p>
<ul>
<li>排序是否会影响原始数据顺序？</li>
<li>排序的性能开销是否值得？</li>
<li>是否有更优雅的解决方案？</li>
</ul>
<h4 data-id="heading-1">1. 常见的排序去重方案</h4>
<h5 data-id="heading-2">1.1 传统的排序去重思路</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 先排序后去重的经典写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sortThenUnique</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">return</span> arr
    .<span class="hljs-title function_">slice</span>()
    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-comment">// 避免修改原始数组</span>
      <span class="hljs-keyword">const</span> valueA = key ? a[key] : a;
      <span class="hljs-keyword">const</span> valueB = key ? b[key] : b;
      <span class="hljs-keyword">if</span> (valueA &lt; valueB) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (valueA &gt; valueB) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    })
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index, array</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 保留第一个元素</span>
      <span class="hljs-keyword">const</span> value = key ? item[key] : item;
      <span class="hljs-keyword">const</span> prevValue = key ? array[index - <span class="hljs-number">1</span>][key] : array[index - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">return</span> value !== prevValue; <span class="hljs-comment">// 仅保留与前一个元素不同的元素</span>
    });
}
</code></pre>
<h5 data-id="heading-3">1.2 排序去重的优缺点</h5>
<p><strong>优点:</strong></p>
<ul>
<li>代码逻辑相对直观</li>
<li>对于已排序或需要排序的数据，可以一步完成</li>
<li>在某些算法题中可能是必要步骤</li>
</ul>
<p><strong>缺点:</strong></p>
<ul>
<li>时间复杂度至少为 O(n log n)</li>
<li>改变了原始数据的顺序</li>
<li>对于不需要排序的场景是额外开销</li>
</ul>
<h4 data-id="heading-4">2. 不排序的去重方案</h4>
<h5 data-id="heading-5">2.1 基于Map的保持顺序方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueByKey</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">const</span> keyValue = item[key];
    <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(keyValue)) {
      seen.<span class="hljs-title function_">set</span>(keyValue, <span class="hljs-literal">true</span>);
      result.<span class="hljs-title function_">push</span>(item);
    }
  }
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 支持多个字段的复合键</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueByMultipleKeys</span>(<span class="hljs-params">arr, keys</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> compositeKey = keys.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> item[key]).<span class="hljs-title function_">join</span>(<span class="hljs-string">"|"</span>);
    <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(compositeKey)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    seen.<span class="hljs-title function_">add</span>(compositeKey);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}
</code></pre>
<h5 data-id="heading-6">2.2 基于对象的缓存方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueByKeyWithObject</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">const</span> cache = {};
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> keyValue = item[key];
    <span class="hljs-keyword">if</span> (cache[keyValue]) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    cache[keyValue] = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}
</code></pre>
<h5 data-id="heading-7">2.3 基于自定义比较函数的方案</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueWithCustomComparator</span>(<span class="hljs-params">arr, comparator</span>) {
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">current, index, self</span>) =&gt;</span> {
    <span class="hljs-comment">// 查找第一个相同元素的位置</span>
    <span class="hljs-keyword">return</span> self.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-title function_">comparator</span>(item, current)) === index;
  });
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }, <span class="hljs-comment">// 重复</span>
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">26</span> }, <span class="hljs-comment">// ID相同但年龄不同</span>
];

<span class="hljs-keyword">const</span> uniqueUsers = <span class="hljs-title function_">uniqueWithCustomComparator</span>(
  users,
  <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> === b.<span class="hljs-property">id</span> &amp;&amp; a.<span class="hljs-property">name</span> === b.<span class="hljs-property">name</span>
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(uniqueUsers);
<span class="hljs-comment">// [ { id: 1, name: 'Alice', age: 25 }, { id: 2, name: 'Bob', age: 30 } ]</span>
</code></pre>
<h4 data-id="heading-8">3. 性能对比分析</h4>
<h5 data-id="heading-9">3.1 时间复杂度对比</h5>



































<table><thead><tr><th align="left">方法</th><th align="left">时间复杂度</th><th align="left">空间复杂度</th><th align="left">是否保持顺序</th></tr></thead><tbody><tr><td align="left">排序后去重</td><td align="left">O(n log n)</td><td align="left">O(1) 或 O(n)</td><td align="left">否</td></tr><tr><td align="left">Map去重</td><td align="left">O(n)</td><td align="left">O(n)</td><td align="left">是</td></tr><tr><td align="left">对象缓存去重</td><td align="left">O(n)</td><td align="left">O(n)</td><td align="left">是</td></tr><tr><td align="left">filter + findIndex</td><td align="left">O(n²)</td><td align="left">O(1)</td><td align="left">是</td></tr></tbody></table>
<h5 data-id="heading-10">3.2 实际性能测试</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能测试代码示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTestData</span>(<span class="hljs-params">count</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({<span class="hljs-attr">length</span>: count}, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * count / <span class="hljs-number">10</span>), <span class="hljs-comment">// 产生大量重复</span>
    <span class="hljs-attr">value</span>: <span class="hljs-string">`item-<span class="hljs-subst">${i}</span>`</span>,
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()
  }));
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">runPerformanceTest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">generateTestData</span>(<span class="hljs-number">10000</span>);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Map去重'</span>);
  <span class="hljs-title function_">uniqueByKey</span>(data, <span class="hljs-string">'id'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Map去重'</span>);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'排序去重'</span>);
  <span class="hljs-title function_">sortThenUnique</span>(data, <span class="hljs-string">'id'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'排序去重'</span>);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'filter+findIndex'</span>);
  <span class="hljs-title function_">uniqueWithCustomComparator</span>(data, <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> === b.<span class="hljs-property">id</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'filter+findIndex'</span>);
}
</code></pre>
<p><strong>测试结果趋势:</strong></p>
<ul>
<li>数据量&lt;1000：各种方法差异不大</li>
<li>数据量1000-10000：Map方案明显占优</li>
<li>数据量&gt;10000：排序方案开始显现劣势</li>
</ul>
<h4 data-id="heading-11">4. 应用场景与选择建议</h4>
<h5 data-id="heading-12">4.1 什么时候应该考虑排序？</h5>
<h6 data-id="heading-13">1.需要有序输出时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 既要去重又要按特定字段排序</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getSortedUniqueUsers</span> = (<span class="hljs-params">users</span>) =&gt; {
  <span class="hljs-keyword">const</span> uniqueUsers = <span class="hljs-title function_">uniqueByKey</span>(users, <span class="hljs-string">'id'</span>);
  <span class="hljs-keyword">return</span> uniqueUsers.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">name</span>.<span class="hljs-title function_">localeCompare</span>(b.<span class="hljs-property">name</span>));
};
</code></pre>
<h6 data-id="heading-14">2. 数据本身就需要排序时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果业务本来就需要排序，可以合并操作</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processData</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-comment">// 先排序便于后续处理</span>
  data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">timestamp</span> - b.<span class="hljs-property">timestamp</span>);
  <span class="hljs-comment">// 去重</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">uniqueByKey</span>(data, <span class="hljs-string">'id'</span>);
};
</code></pre>
<h6 data-id="heading-15">3.处理流式数据时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时数据流，需要维持有序状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SortedUniqueCollection</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">const</span> keyValue = item[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>];
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">has</span>(keyValue)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">add</span>(keyValue);
      <span class="hljs-comment">// 插入到正确位置维持有序</span>
      <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span> &amp;&amp; 
             <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[index][<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>] &lt; keyValue) {
        index++;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">0</span>, item);
    }
  }
}
</code></pre>
<h5 data-id="heading-16">4.2 什么时候应该避免排序？</h5>
<h6 data-id="heading-17">1.需要保持原始顺序时</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 日志记录、时间线数据等</span>
<span class="hljs-keyword">const</span> logEntries = [
  {<span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:00'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'启动'</span>},
  {<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:01'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'初始化'</span>},
  {<span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:02'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'启动'</span>}, <span class="hljs-comment">// 重复</span>
  {<span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">time</span>: <span class="hljs-string">'10:03'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'运行'</span>}
];

<span class="hljs-comment">// 保持时间顺序很重要！</span>
<span class="hljs-keyword">const</span> uniqueLogs = <span class="hljs-title function_">uniqueByKey</span>(logEntries, <span class="hljs-string">'id'</span>);
</code></pre>
<h6 data-id="heading-18">2.性能敏感的应用</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时渲染大量数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderItems</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-comment">// 使用Map去重避免不必要的排序开销</span>
  <span class="hljs-keyword">const</span> uniqueItems = <span class="hljs-title function_">uniqueByKey</span>(items, <span class="hljs-string">'id'</span>);
  <span class="hljs-comment">// 快速渲染</span>
  <span class="hljs-keyword">return</span> uniqueItems.<span class="hljs-title function_">map</span>(renderItem);
}
</code></pre>
<h6 data-id="heading-19">3. 数据不可变要求</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React/Vue等框架中，避免改变原数组</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">DeduplicatedList</span> = (<span class="hljs-params">{ items }</span>) =&gt; {
  <span class="hljs-comment">// 不改变原始数据</span>
  <span class="hljs-keyword">const</span> uniqueItems = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">uniqueByKey</span>(items, <span class="hljs-string">'id'</span>),
    [items]
  );
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{uniqueItems}</span> /&gt;</span></span>;
};
</code></pre>
<h4 data-id="heading-20">5. 高级技巧和优化</h4>
<h5 data-id="heading-21">5.1 惰性去重迭代器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">uniqueIterator</span>(<span class="hljs-params">arr, getKey</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">getKey</span>(item);
    <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(key)) {
      seen.<span class="hljs-title function_">add</span>(key);
      <span class="hljs-keyword">yield</span> item;
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> data = [...]; <span class="hljs-comment">// 大数据集</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> <span class="hljs-title function_">uniqueIterator</span>(data, <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x.<span class="hljs-property">id</span>)) {
  <span class="hljs-comment">// 逐个处理，节省内存</span>
  <span class="hljs-title function_">processItem</span>(item);
}
</code></pre>
<h5 data-id="heading-22">5.2 增量去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalDeduplicator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">0</span>;
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">items</span>) {
    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> keyValue = item[<span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span>];
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">has</span>(keyValue)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">set</span>(keyValue, ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>); <span class="hljs-comment">// 记录添加顺序</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
  }
  
  <span class="hljs-title function_">getAddedOrder</span>(<span class="hljs-params">keyValue</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">seen</span>.<span class="hljs-title function_">get</span>(keyValue);
  }
}
</code></pre>
<h5 data-id="heading-23">5.3 内存优化版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoryEfficientUnique</span>(<span class="hljs-params">arr, key</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> result = [];
  
  <span class="hljs-comment">// 使用WeakMap处理对象键</span>
  <span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> item = arr[i];
    <span class="hljs-keyword">const</span> keyValue = item[key];
    
    <span class="hljs-comment">// 对于对象类型的键值，使用WeakMap</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> keyValue === <span class="hljs-string">'object'</span> &amp;&amp; keyValue !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (!weakMap.<span class="hljs-title function_">has</span>(keyValue)) {
        weakMap.<span class="hljs-title function_">set</span>(keyValue, <span class="hljs-literal">true</span>);
        result.<span class="hljs-title function_">push</span>(item);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(keyValue)) {
        seen.<span class="hljs-title function_">set</span>(keyValue, <span class="hljs-literal">true</span>);
        result.<span class="hljs-title function_">push</span>(item);
      }
    }
  }
  
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-24">6. 实战案例分析</h4>
<h5 data-id="heading-25">6.1 电商商品去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：合并多个来源的商品数据</span>
<span class="hljs-keyword">const</span> productsFromAPI = [...];
<span class="hljs-keyword">const</span> productsFromCache = [...];
<span class="hljs-keyword">const</span> userUploadedProducts = [...];

<span class="hljs-comment">// 需求：按商品SKU去重，保持最新数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeProducts</span>(<span class="hljs-params">productLists</span>) {
  <span class="hljs-keyword">const</span> merged = [];
  <span class="hljs-keyword">const</span> skuMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// 按优先级处理（后处理的优先级高）</span>
  productLists.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">list</span> =&gt;</span> {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> existing = skuMap.<span class="hljs-title function_">get</span>(product.<span class="hljs-property">sku</span>);
      <span class="hljs-keyword">if</span> (!existing || product.<span class="hljs-property">updatedAt</span> &gt; existing.<span class="hljs-property">updatedAt</span>) {
        <span class="hljs-keyword">if</span> (existing) {
          <span class="hljs-comment">// 移除旧的</span>
          <span class="hljs-keyword">const</span> index = merged.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">sku</span> === product.<span class="hljs-property">sku</span>);
          merged.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
        }
        merged.<span class="hljs-title function_">push</span>(product);
        skuMap.<span class="hljs-title function_">set</span>(product.<span class="hljs-property">sku</span>, product);
      }
    });
  });
  
  <span class="hljs-keyword">return</span> merged;
}
</code></pre>
<h5 data-id="heading-26">6.2 实时消息去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：聊天应用消息去重</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageDeduplicator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">timeWindow = <span class="hljs-number">5000</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeWindow</span> = timeWindow;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-title function_">addMessage</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> { id } = message;
    
    <span class="hljs-comment">// 清理过期记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>(now);
    
    <span class="hljs-comment">// 检查是否重复</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span>.<span class="hljs-title function_">has</span>(id)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 添加新记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span>.<span class="hljs-title function_">add</span>(id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span>.<span class="hljs-title function_">set</span>(id, now);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">now</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, timestamp] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span>) {
      <span class="hljs-keyword">if</span> (now - timestamp &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeWindow</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageIds</span>.<span class="hljs-title function_">delete</span>(id);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timestamps</span>.<span class="hljs-title function_">delete</span>(id);
      }
    }
  }
}
</code></pre>
<h4 data-id="heading-27">结论</h4>
<p>回到最初的问题：JS复杂去重一定要先排序吗？</p>
<p>答案是否定的。 排序只是众多去重策略中的一种，而非必需步骤。</p>
<p><strong>我的建议:</strong></p>
<ol>
<li><strong>默认使用Map方案:</strong> 对于大多数场景，基于Map或Set的去重方法在性能和功能上都是最佳选择。</li>
<li><strong>根据需求选择:</strong></li>
</ol>
<ul>
<li>需要保持顺序 → 使用Map</li>
<li>需要排序结果 → 先排序或后排序</li>
<li>数据量很大 → 考虑迭代器或流式处理</li>
<li>内存敏感 → 使用WeakMap或定期清理</li>
</ul>
<ol start="3">
<li><strong>考虑可读性和维护性:</strong> 有时清晰的代码比微小的性能优化更重要。</li>
<li><strong>进行实际测试:</strong> 在性能关键路径上，用真实数据测试不同方案。</li>
</ol>
<p><strong>实践总结:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通用推荐方案</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deduplicate</span>(<span class="hljs-params">arr, identifier = v =&gt; v</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">typeof</span> identifier === <span class="hljs-string">'function'</span> 
      ? <span class="hljs-title function_">identifier</span>(item)
      : item[identifier];
    
    <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    seen.<span class="hljs-title function_">add</span>(key);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}

<span class="hljs-comment">// 需要排序时的方案</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deduplicateAndSort</span>(<span class="hljs-params">arr, key, sortBy</span>) {
  <span class="hljs-keyword">const</span> unique = <span class="hljs-title function_">deduplicate</span>(arr, key);
  <span class="hljs-keyword">return</span> unique.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> aVal = a[sortBy];
    <span class="hljs-keyword">const</span> bVal = b[sortBy];
    <span class="hljs-keyword">return</span> aVal &lt; bVal ? -<span class="hljs-number">1</span> : aVal &gt; bVal ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
  });
}
</code></pre>
<p>记住，没有银弹。最合适的去重方案取决于你的具体需求：数据规模、顺序要求、性能需求和代码上下文。希望这篇文章能帮助你在面对复杂去重问题时做出明智的选择！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VueCropper加载OBS图片跨域问题]]></title>    <link>https://juejin.cn/post/7587743345197465652</link>    <guid>https://juejin.cn/post/7587743345197465652</guid>    <pubDate>2025-12-26T09:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587743345197465652" data-draft-id="7587743345197449268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VueCropper加载OBS图片跨域问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T09:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VueCropper加载OBS图片跨域问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:30:22.000Z" title="Fri Dec 26 2025 09:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题场景</h2>
<p>在集成 <code>VueCropper</code> 图片裁剪组件时，遇到一个典型的跨域问题：加载存储在 OBS 上的图片时，浏览器会对同一张图片发起两次请求，最终第二次请求触发跨域错误。以下是问题的完整排查过程与现象梳理：</p>
<ol>
<li>请求行为异常：同一张 OBS 图片被浏览器发起两次请求，第一次请求正常响应，第二次请求直接抛出跨域相关错误（如 <code>CORS policy: No 'Access-Control-Allow-Origin' header</code>）；</li>
<li>初步排查方向：初期优先怀疑 OBS 服务器跨域配置缺失，反馈运维核查后，确认 OBS 已正确配置跨域允许规则（含允许当前前端域名、支持 GET 方法等）；</li>
<li>关键测试突破：通过浏览器开发者工具测试发现，开启「停用缓存」功能后，跨域错误消失。据此锁定问题根源与浏览器缓存机制相关；</li>
<li>核心差异定位：对比两次请求的详细信息，发现跨域标识配置不一致——第一次加载图片未设置 <code>crossOrigin</code> 标识，第二次加载时则添加了该标识；</li>
<li>问题逻辑闭环：第一次请求因无 <code>crossOrigin</code> 标识，OBS 服务器识别为非跨域请求，未返回跨域响应头；第二次请求虽开启 <code>crossOrigin</code>，但因图片 URL 未变，浏览器直接复用缓存的无跨域响应头资源，导致跨域校验失败。</li>
</ol>
<h2 data-id="heading-1">问题根源</h2>
<p>为验证上述排查结论，通过原生 JavaScript 代码复现了问题场景，最终确认问题根源为 <strong>跨域策略与浏览器缓存冲突</strong>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    <span class="hljs-comment">// 第一次加载：未设置 crossOrigin 标识</span>
    image.<span class="hljs-property">src</span> = <span class="hljs-string">'https://xxx.png'</span>; 
    image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>);
        <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
        <span class="hljs-comment">// 第二次加载：设置跨域标识（与第一次不一致）</span>
        image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>;
        <span class="hljs-comment">// 加载同一张图片，触发跨域错误</span>
        image2.<span class="hljs-property">src</span> = image.<span class="hljs-property">src</span>; 
        image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>);
        });
    });
});
</code></pre>
<p>该问题的核心矛盾是「同一张图片的两次请求采用不一致的跨域策略」，结合浏览器缓存机制与 OBS 服务器的跨域响应规则，具体错误逻辑可拆解为两步：</p>
<ol>
<li>非跨域模式缓存：第一次加载未设置 <code>crossOrigin</code>，浏览器以「非跨域模式」发起请求（请求头 <code>Sec-Fetch-Mode = no-cors</code>）；OBS 服务器识别该模式后，不返回 <code>Access-Control-Allow-Origin</code> 等跨域响应头，浏览器则将这份「无跨域响应头的图片资源」缓存至本地；</li>
<li>跨域模式缓存冲突：第二次加载设置 <code>crossOrigin: "anonymous"</code>，浏览器需以「跨域模式」请求；但因图片 URL 未变，浏览器直接复用本地缓存的无跨域响应头资源，跨域校验无法通过，最终触发错误。</li>
</ol>
<p>关键结论：同一张图片的所有请求，跨域标识必须完全统一（要么所有请求都设 <code>crossOrigin</code>，要么都不设），否则会因缓存机制导致跨域策略冲突。</p>
<h2 data-id="heading-2">解决办法</h2>
<h3 data-id="heading-3">1. 核心通用方案：统一跨域标识（推荐首选）</h3>
<p>思路：统一所有加载该图片的 <code>Image</code> 实例的跨域配置（均设置或均不设置 <code>crossOrigin</code>），确保两次请求的跨域策略一致，从根源避免缓存与跨域规则的冲突。</p>
<p>核心注意点：<code>crossOrigin</code> 必须在 <code>src</code> 赋值 <strong>之前</strong> 设置。若先赋值 <code>src</code>，浏览器会提前以默认模式发起请求，仍会触发跨域冲突。</p>
<p>正确代码示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 第一次加载：提前设置 crossOrigin，统一跨域策略</span>
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>; 
  image.<span class="hljs-property">src</span> = <span class="hljs-string">'https://xxx.png'</span>;

  image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>);
      <span class="hljs-comment">// 第二次加载：保持 crossOrigin 配置一致</span>
      <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
      image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>; 
      image2.<span class="hljs-property">src</span> = image.<span class="hljs-property">src</span>;

      image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>);
      });
  });

  <span class="hljs-comment">// 添加错误监听，便于问题排查</span>
  image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片1加载失败:'</span>, e));
  image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片2加载失败:'</span>, e));
});
</code></pre>
<p>适用场景：绝大多数前端场景（包括 <code>VueCropper </code> 等依赖 canvas 的裁剪组件场景），且图片存储端<code>（OBS/CDN）</code>已配置跨域允许规则。</p>
<h3 data-id="heading-4">2. 绕过缓存方案：让第二次请求视为「新资源」</h3>
<p>思路：若历史代码无法批量修改 <code>crossOrigin</code> 配置，可通过让第二次请求「避开缓存」，迫使浏览器重新向 OBS 服务器发起请求（而非复用旧缓存），从而避免跨域策略冲突。</p>
<p>推荐方案：给图片 URL 添加随机参数（如时间戳），使浏览器识别为「新资源」，触发全新请求：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> image2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image2.<span class="hljs-property">crossOrigin</span> = <span class="hljs-string">"anonymous"</span>;
  <span class="hljs-comment">// 追加时间戳参数，避开浏览器缓存</span>
  image2.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${image.src}</span>&amp;t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>; 
  image2.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片2加载完成'</span>));
});
</code></pre>
<p>适用场景：历史代码架构复杂，无法批量统一 <code>crossOrigin</code> 配置，需快速临时修复跨域问题。</p>
<p>缺点：完全失去缓存优势，每次请求均需重新下载图片，会增加带宽消耗并延长页面加载时间，仅建议临时使用。</p>
<h3 data-id="heading-5">3. 后端/存储端方案：从根源消除跨域</h3>
<p>思路：通过后端代理或域名绑定，将「跨域图片请求」转为「同源请求」，从根源上消除跨域问题，无需前端额外配置 <code>crossOrigin</code>。</p>
<p>具体做法：</p>
<ol>
<li>同源代理（推荐）：前端请求自身后端的代理接口，由后端代为拉取 OBS 图片并返回给前端。此时前端接收的图片为同源资源，无需任何跨域配置。</li>
</ol>
<p>示例（<code>Node.js/Express</code> 代理）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端代理代码（Node.js/Express）</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 图片代理接口：接收前端传递的 OBS 图片 URL</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/proxy-image'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> imgUrl = req.<span class="hljs-property">query</span>.<span class="hljs-property">url</span>;
  <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 后端请求 OBS 图片，以流形式返回给前端</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(imgUrl, { <span class="hljs-attr">responseType</span>: <span class="hljs-string">'stream'</span> });
      response.<span class="hljs-property">data</span>.<span class="hljs-title function_">pipe</span>(res);
  } <span class="hljs-keyword">catch</span> (err) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'图片加载失败'</span>);
  }
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'代理服务启动在 3000 端口'</span>));
</code></pre>
<p>前端代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端代码：请求后端代理接口，无跨域问题</span>
<span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
image.<span class="hljs-property">src</span> = <span class="hljs-string">`http://localhost:3000/proxy-image?url=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">'https://xxx.png'</span>)}</span>`</span>;
image.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片加载完成'</span>));
</code></pre>
<p>适用场景：前端需大量处理跨域图片（如批量裁剪、像素操作）；追求稳定可靠的跨域解决方案，不希望依赖前端代码配置。</p>
<p>优点：彻底解决跨域问题，前端无需任何跨域相关配置；缓存机制可正常生效，不影响加载性能；安全性更高（避免设置 <code>*</code> 允许所有域名跨域）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PAG在得物社区S级活动的落地]]></title>    <link>https://juejin.cn/post/7587675306659020800</link>    <guid>https://juejin.cn/post/7587675306659020800</guid>    <pubDate>2025-12-26T07:45:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675306659020800" data-draft-id="7587675306658627584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PAG在得物社区S级活动的落地"/> <meta itemprop="keywords" content="设计"/> <meta itemprop="datePublished" content="2025-12-26T07:45:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PAG在得物社区S级活动的落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:45:34.000Z" title="Fri Dec 26 2025 07:45:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>近期，得物社区活动「用篮球认识我」推出 “用户上传图片生成专属球星卡” 核心玩法。</p>
<p>初期规划由服务端基于 PAG 技术合成，为了让用户可以更自由的定制专属球星卡，经多端评估后确定：由 H5 端承接 “图片交互调整 - 球星卡生成” 核心链路，支持用户单指拖拽、双指缩放 / 旋转人像，待调整至理想位置后触发合成。而 PAG 作为腾讯自研开源的动效工作流解决方案，凭借跨平台渲染一致性、图层实时编辑、轻量化文件性能，能精准匹配需求，成为本次核心技术选型。</p>
<p>鉴于 H5 端需落地该核心链路，且流程涉及 PAG 技术应用，首先需对 PAG 技术进行深入了解，为后续开发与适配奠定基础。</p>
<h2 data-id="heading-1">二、PAG是什么？</h2>
<p>这里简单介绍一下，PAG 是腾讯自研并开源的动效工作流解决方案，核心是实现 Adobe After Effects（AE）动效的一键导出与跨平台应用，包含渲染 SDK、AE 导出插件（PAGExporter）、桌面预览工具（PAGViewer）三部分。</p>
<p>它导出的二进制 PAG 文件压缩率高、解码快，能集成多类资源；支持 Android、iOS、Web 等全平台，且各端渲染一致、开启 GPU 加速；既兼容大部分 AE 动效特性，也允许运行时编辑 —— 比如替换文本 / 图片、调整图层与时间轴，目前已广泛用于各类产品的动效场景。</p>
<p>已知业界中图片基础编辑（如裁剪、调色）、贴纸叠加、滤镜渲染等高频功能，在客户端发布器场景下已广泛采用 PAG技术实现，这一应用趋势在我司及竞品的产品中均有体现，成为支撑这类视觉交互功能的主流技术选择。</p>
<p>正是基于PAG 的跨平台渲染、图层实时编辑特性，其能精准承接 H5 端‘图片交互调整 + 球星卡合成’的核心链路，解决服务端固定合成的痛点，因此成为本次需求的核心技术选型。</p>
<p>为了让大家更直观地感受「用篮球认识我」活动中 “用户上传图片生成专属球星卡” 玩法，我们准备了活动实际效果录屏。通过录屏，你可以清晰看到用户如何通过单指拖拽、双指缩放 / 旋转人像，完成构图调整后生成球星卡的全过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6d364c65f564fdb941ca847fa126f8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=V5UBY3EPViU4uKz7GXyKm%2BQbsXg%3D" alt="截屏2025-12-26 下午2.53.53.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dcfe266cdd24d82a2bb2786b546c284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=UxMDfNCTXiTbWYYDFzIEEJsjEPQ%3D" alt="截屏2025-12-26 下午2.54.01.png" loading="lazy"/></p>
<p>接下来，我们将围绕业务目标，详细拆解实现该链路的具体任务优先级与核心模块。</p>
<h2 data-id="heading-2">三、如何实现核心交互链路？</h2>
<p>结合「用篮球认识我」球星卡生成的核心业务目标，按‘基础功能→交互体验→拓展能力→稳定性’优先级，将需求拆解为以下 6 项任务：</p>
<ol>
<li><strong>PAG 播放器基础功能搭建</strong>：实现播放 / 暂停、图层替换、文本修改、合成图导出，为后续交互打基础；</li>
<li><strong>图片交互变换功能开发</strong>：支持单指拖拽、双指缩放 / 旋转，满足人像构图调整需求；</li>
<li><strong>交互与预览实时同步</strong>：将图片调整状态实时同步至 PAG 图层，实现 “操作即预览”；</li>
<li><strong>批量合成能力拓展</strong>：基于单张合成逻辑，支持一次性生成多张球星卡（依赖任务 1-3）；</li>
<li><strong>全链路性能优化</strong>：优化 PAG 实例释放、图层渲染效率，保障 H5 流畅度（贯穿全流程）；</li>
<li><strong>异常场景降级兼容</strong>：针对 SDK 不支持场景，设计静态图层、服务端合成等兜底方案（同步推进）。</li>
</ol>
<p>在明确核心任务拆解后，首要环节是搭建 PAG 播放器基础能力 —— 这是后续图层替换、文本修改、球星卡合成的前提，需从 SDK 加载、播放器初始化、核心功能封装逐步落地。</p>
<h2 data-id="heading-3">四、基础PAG播放器实现</h2>
<h3 data-id="heading-4">加载PAG SDK</h3>
<p>因为是首次接触PAG ，所以在首次加载 SDK 环节便遇到了需要注意的细节：</p>
<p>libpag 的 SDK 加载包含两部分核心文件：</p>
<ul>
<li>主体 libpag.min.js</li>
<li>配套的 libpag.wasm</li>
</ul>
<p><strong>需特别注意</strong>：默认情况下，wasm文件需与 libpag.min.js 置于同一目录，若需自定义路径，也可手动指定其位置。（加载SDK参考文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpag.io%2Fdocs%2Fuse-web-sdk.html%25EF%25BC%2589" target="_blank" title="https://pag.io/docs/use-web-sdk.html%EF%BC%89" ref="nofollow noopener noreferrer">pag.io/docs/use-we…</a></p>
<p>在本项目中，我们将两个文件一同上传至 OSS的同一路径下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fh5static.xx%2F10122053%2Flibpag.min.js" target="_blank" title="https://h5static.xx/10122053/libpag.min.js" ref="nofollow noopener noreferrer">h5static.xx/10122053/li…</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fh5static.xx%2F10122053%2Flibpag.wasm" target="_blank" title="https://h5static.xx/10122053/libpag.wasm" ref="nofollow noopener noreferrer">h5static.xx/10122053/li…</a></p>
<p>通过 CDN 方式完成加载，确保资源路径匹配。</p>
<p>SDK加载核心代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> loadLibPag = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 若已加载，直接返回</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>
  }
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 动态创建script标签加载SDK</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>)
    script.<span class="hljs-property">src</span> = <span class="hljs-string">'https://h5static.XX/10122053/libpag.min.js'</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      script.<span class="hljs-property">onload</span> = <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-comment">// 等待500ms确保库完全初始化</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">500</span>))
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'LibPag script loaded, checking window.libpag:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>)
        
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">libpag</span>)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'window.libpag is not available'</span>))
        }
      }
      <span class="hljs-comment">// 加载失败处理</span>
      script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Failed to load libPag script'</span>))
    })
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load libPag: <span class="hljs-subst">${error}</span>`</span>)
  }
}, [])
</code></pre>
<h3 data-id="heading-5">初始化播放器</h3>
<p>加载完 SDK 后，window 对象会生成 libpag 对象，以此为基础可完成播放器初始化，步骤如下：</p>
<ul>
<li>准备 canvas 容器作为渲染载体；</li>
<li>加载 PAG 核心库并初始化 PAG 环境；</li>
<li>加载目标.pag 文件（动效模板）；</li>
<li>创建 PAGView 实例关联 canvas 与动效文件；</li>
<li>封装播放器控制接口（播放 / 暂停 / 销毁等），并处理资源释放与重复初始化问题。</li>
</ul>
<p>需说明的是，本需求核心诉求是 “合成球星卡图片”，不涉及PAG的视频相关能力，因此暂不扩展视频功能，在播放器初始化后完成立即暂停，后续仅围绕 “图层替换（如用户人像）”“文本替换（如球星名称）” 等核心需求展开。</p>
<p>核心代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { width, height } = props


<span class="hljs-comment">// Canvas渲染容器</span>
<span class="hljs-keyword">const</span> canvasRef = useRef&lt;<span class="hljs-title class_">HTMLCanvasElement</span>&gt;(<span class="hljs-literal">null</span>)
<span class="hljs-comment">// PAG动效模板地址（球星卡模板）</span>
<span class="hljs-keyword">const</span> src = <span class="hljs-string">'https://h5static.XX/10122053/G-lv1.pag'</span>


<span class="hljs-comment">// 初始化播放器函数</span>
<span class="hljs-keyword">const</span> initPlayer = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>)
    <span class="hljs-keyword">const</span> canvas = canvasRef.<span class="hljs-property">current</span>
    <span class="hljs-comment">// 设置Canvas尺寸与球星卡匹配</span>
    canvas.<span class="hljs-property">width</span> = width
    canvas.<span class="hljs-property">height</span> = height
    
    <span class="hljs-comment">// 1. 加载PAG核心库并初始化环境</span>
    <span class="hljs-keyword">const</span> libpag = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadLibPag</span>()
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAG</span> = <span class="hljs-keyword">await</span> libpag.<span class="hljs-title class_">PAGInit</span>({ <span class="hljs-attr">useScale</span>: <span class="hljs-literal">false</span> })
    
    <span class="hljs-comment">// 2. 加载PAG动效模板</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(src)
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>()
    <span class="hljs-keyword">const</span> pagFile = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGFile</span>.<span class="hljs-title function_">load</span>(buffer)
    
    <span class="hljs-comment">// 3. 创建PAGView，关联Canvas与动效模板</span>
    <span class="hljs-keyword">const</span> pagView = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGView</span>.<span class="hljs-title function_">init</span>(pagFile, canvas)
    
    <span class="hljs-comment">// 4. 封装播放器控制接口</span>
    <span class="hljs-keyword">const</span> player = {
      <span class="hljs-attr">_pagView</span>: pagView,
      <span class="hljs-attr">_pagFile</span>: pagFile,
      <span class="hljs-attr">_PAG</span>: <span class="hljs-variable constant_">PAG</span>,
      <span class="hljs-attr">_isPlaying</span>: <span class="hljs-literal">false</span>,
      
      <span class="hljs-comment">// 播放</span>
      <span class="hljs-keyword">async</span> <span class="hljs-title function_">play</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pagView</span>.<span class="hljs-title function_">play</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_isPlaying</span> = <span class="hljs-literal">true</span>
      },
      <span class="hljs-comment">// 暂停（初始化后默认暂停）</span>
      <span class="hljs-title function_">pause</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pagView</span>.<span class="hljs-title function_">pause</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_isPlaying</span> = <span class="hljs-literal">false</span>
      },
      <span class="hljs-comment">// 销毁实例，释放资源</span>
      <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pagView</span>.<span class="hljs-title function_">destroy</span>()
      },
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'PAG Player initialization failed:'</span>, error)
  } 
}, [src, width, height])
</code></pre>
<p><strong>实现效果</strong></p>
<p>播放器初始化完成后，可在Canvas中正常展示球星卡动效模板（初始化后默认暂停）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fad50f876ee4dea8bea2fbcac6018de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=PzWUqcrlOWM%2FlJAoUKvfd52Nw%2FQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来我们来实现替换图层及文本功能。</p>
<h3 data-id="heading-6">替换图层及文本</h3>
<p>替换 “用户上传人像”（图层）与 “球星名称”（文本）是核心需求，需通过 PAGFile 的原生接口实现，并扩展播放器实例的操作方法：</p>
<ul>
<li><strong>图片图层替换</strong>：调用pagFile.replaceImage(index, image) 接口，将指定索引的图层替换为用户上传图片（支持 CDN 地址、Canvas 元素、Image 元素作为图片源）；</li>
<li><strong>文本内容替换</strong>：调用pagFile.setTextData(index, textData) 接口，修改指定文本图层的内容与字体；</li>
<li><strong>效果生效</strong>：每次替换后需调用 pagView.flush() 强制刷新渲染，确保修改实时生效。</li>
</ul>
<p><strong>实现方案</strong></p>
<ul>
<li>替换图片图层：通过pagFile.replaceImage(index, image)接口，将指定索引的图层替换为用户上传图片；</li>
<li>替换文本内容：通过pagFile.setTextData(index, textData)接口，修改指定文本图层的内容；</li>
<li>扩展播放器接口后，需调用flush()强制刷新渲染，确保替换效果生效。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d4f0a8a802e4de4ab1a0837984704f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=zMWQHOUsbMz7oyiPlhxrpYCdoIg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>初期问题：文本字体未生效</strong></p>
<p>替换文本后发现设定字体未应用。排查后确认：自定义字体包未在 PAG 环境中注册，导致 PAG 无法识别字体。</p>
<p>需在加载 PAG 模板前，优先完成字体注册，确保 PAG 能正常调用目标字体，具体实现步骤如下。</p>
<p>PAG提供PAGFont.registerFont()接口用于注册自定义字体，需传入 “字体名称” 与 “字体文件资源”（如.ttf/.otf 格式文件），流程为：</p>
<ul>
<li>加载字体文件（从 CDN/OSS 获取字体包）；</li>
<li>调用 PAG 接口完成注册；</li>
<li>注册成功后，再加载.pag文件，确保后续文本替换时字体已生效。</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 需注册的字体列表（字体名称+CDN地址）</span>
<span class="hljs-keyword">const</span> fonts = [
  {
    <span class="hljs-attr">family</span>: <span class="hljs-string">'POIZONSans'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://h5static.XX/10122053/20250827-febf35c67d9232d4.ttf'</span>,
  },
  {
    <span class="hljs-attr">family</span>: <span class="hljs-string">'FZLanTingHeiS-DB-GB'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://h5static.XX/10122053/20250821-1e3a4fccff659d1c.ttf'</span>,
  },
]


<span class="hljs-comment">// 在“加载PAG核心库”后、“加载PAG模板”前，新增字体注册逻辑</span>
<span class="hljs-keyword">const</span> initPlayer = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// ... 原有代码（Canvas准备、加载libpag）</span>
  <span class="hljs-keyword">const</span> libpag = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadLibPag</span>()
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAG</span> = <span class="hljs-keyword">await</span> libpag.<span class="hljs-title class_">PAGInit</span>({ <span class="hljs-attr">useScale</span>: <span class="hljs-literal">false</span> })
  
  <span class="hljs-comment">// 新增：注册自定义字体</span>
  <span class="hljs-keyword">if</span> (fonts &amp;&amp; fonts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable constant_">PAG</span>?.<span class="hljs-property">PAGFont</span>?.<span class="hljs-property">registerFont</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { family, url } <span class="hljs-keyword">of</span> fonts) {
        <span class="hljs-keyword">if</span> (!family || !url) <span class="hljs-keyword">continue</span>
        <span class="hljs-comment">// 加载字体文件（CORS跨域配置+强制缓存）</span>
        <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">mode</span>: <span class="hljs-string">'cors'</span>, <span class="hljs-attr">cache</span>: <span class="hljs-string">'force-cache'</span> })
        <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">await</span> resp.<span class="hljs-title function_">blob</span>()
        <span class="hljs-comment">// 转换为File类型（PAG注册需File格式）</span>
        <span class="hljs-keyword">const</span> filename = url.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>() || <span class="hljs-string">'font.ttf'</span>
        <span class="hljs-keyword">const</span> fontFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>([blob], filename)
        <span class="hljs-comment">// 注册字体</span>
        <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGFont</span>.<span class="hljs-title function_">registerFont</span>(family, fontFile)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Registered font for PAG:'</span>, family)
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Register fonts for PAG failed:'</span>, e)
    }
  }
  
  <span class="hljs-comment">// 继续加载PAG模板（原有代码）</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(src)
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>()
  <span class="hljs-keyword">const</span> pagFile = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">PAG</span>.<span class="hljs-property">PAGFile</span>.<span class="hljs-title function_">load</span>(buffer)
  <span class="hljs-comment">// ... 后续创建PAGView、封装播放器接口</span>
}, [src, width, height])
</code></pre>
<p><strong>最终效果</strong></p>
<p>字体注册后，文本替换的字体正常生效，人像与文本均显示正确：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405c50bb121c43049d8116a1584db07f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=objPcWRKzCFp%2FDbwdaU37xX5gJM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>数字字体已应用成功</p>
<p>可以看到，替换文本的字体已正确应用。接下来我们来实现最后一步，将更新图层及文本后的内容导出为CDN图片。</p>
<h3 data-id="heading-7">PagPlayer截帧（导出PagPlayer当前展示内容）</h3>
<p>截帧是将 “调整后的人像 + 替换后的文本 + 动效模板” 固化为最终图片的关键步骤。开发初期曾直接调用pagView.makeSnapshot()遭遇导出空帧，后通过updateSize()+flush()解决同步问题；此外，还有一种更直接的方案 ——直接导出PAG渲染对应的Canvas内容，同样能实现需求，且流程更简洁。</p>
<p><strong>初期问题：直接调用接口导致空帧</strong></p>
<p>开发初期，尝试直接使用PAGView提供的makeSnapshot()接口截帧，但遇到了返回空帧（全透明图片）情况经过反复调试和查阅文档，发现核心原因是PAG 渲染状态与调用时机不同步：</p>
<ul>
<li><strong>尺寸不同步</strong>：PAGView 内部渲染尺寸与 Canvas 实际尺寸不匹配，导致内容未落在可视区域；</li>
<li><strong>渲染延迟</strong>：图层替换、文本修改后，GPU 渲染是异步的，此时截帧只能捕获到未更新的空白或旧帧。</li>
</ul>
<p><strong>解决方案</strong></p>
<p>针对空帧问题，结合 PAG 在 H5 端 “基于 Canvas 渲染” 的特性，梳理出两种可行方案，核心都是 “先确保渲染同步，再获取画面”：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/350f4915f8a14f74a5a91479c8f727c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=rekCHrp2TwcDocokRn6CqTJfcHo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>最终落地流程</strong></p>
<ul>
<li>调用 pagView.updateSize() 与 pagView.flush() 确保渲染同步；</li>
<li>通过canvas.toDataURL('image/jpeg', 0.9) 生成 Base64 格式图片（JPG 格式，清晰度 0.9，平衡质量与体积）；</li>
<li>将 Base64 图片上传至 CDN，获取可访问的球星卡链接。</li>
</ul>
<p>点击截帧按钮后，即可生成对应的截图。</p>
<p>完成 PAG 播放器的基础功能（图层替换、文本修改、截帧导出）后，我们来聚焦用户核心交互需求 —— 人像的拖拽、缩放与旋转，通过封装 Canvas 手势组件，实现精准的人像构图调整能力。</p>
<h2 data-id="heading-8">五、图片变换功能开发：实现人像拖拽、缩放与旋转</h2>
<p>在球星卡合成流程中，用户需自主调整上传人像的位置、尺寸与角度以优化构图。我们可以基于 Canvas 封装完整的手势交互能力组件，支持单指拖拽、双指缩放 / 旋转，同时兼顾高清渲染与跨设备兼容性。</p>
<h3 data-id="heading-9">功能目标</h3>
<p>针对 “用户人像调整” 场景，组件需实现以下核心能力：</p>
<ul>
<li><strong>基础交互</strong>：支持单指拖拽移动人像、双指缩放尺寸、双指旋转角度；</li>
<li><strong>约束控制</strong>：限制缩放范围（如最小 0.1 倍、最大 5 倍），可选关闭旋转功能；</li>
<li><strong>高清渲染</strong>：适配设备像素比（DPR），避免图片拉伸模糊；</li>
<li><strong>状态同步</strong>：实时反馈当前变换参数（偏移量、缩放比、旋转角），支持重置与结果导出。</li>
</ul>
<h3 data-id="heading-10">效果展示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/811762938b80442bad5020688afbaf2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=hQMmlIYHZRjYm%2BGX3fthzZRJpyw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-11">组件设计理念</h3>
<p>在组件设计之初，我们来使用分层理念，将图片编辑操作分解为三个独立层次：</p>
<p><strong>交互感知层</strong></p>
<p><strong>交互感知层 - 捕获用户手势并转换为标准化的变换意图</strong></p>
<ul>
<li>手势语义化：将原始的鼠标/触摸事件转换为语义化的操作意图</li>
<li>单指移动 = 平移意图</li>
<li>双指距离变化 = 缩放意图</li>
<li>双指角度变化 = 旋转意图</li>
<li>双击 = 重置意图</li>
</ul>
<p><strong>变换计算层</strong></p>
<p><strong>变换计算层 - 处理几何变换逻辑和约束规则</strong></p>
<ul>
<li><strong>多点触控的几何计算</strong>：双指操作时，系统会实时计算两个触点形成的几何关系（距离、角度、中心点），然后将这些几何变化映射为图片的变换参数。</li>
<li><strong>交互连续性</strong>：每次手势开始时记录初始状态，移动过程中所有计算都基于这个初始状态进行增量计算，确保变换的连续性和平滑性。</li>
</ul>
<p><strong>渲染执行层</strong></p>
<p><strong>渲染执行层 - 将变换结果绘制到Canvas上</strong></p>
<ul>
<li><strong>高清适配</strong>：Canvas的物理分辨率和显示尺寸分离管理，物理分辨率适配设备像素比保证清晰度，显示尺寸控制界面布局。</li>
<li><strong>变换应用</strong>：绘制时按照特定顺序应用变换 - 先移动到画布中心建立坐标系，再应用用户的平移、旋转、缩放操作，最后以图片中心为原点绘制。这个顺序确保了变换的直观性。</li>
<li><strong>渲染控制</strong>：区分实时交互和静态显示两种场景，实时交互时使用requestAnimationFrame保证流畅性，静态更新时使用防抖减少不必要的重绘。</li>
</ul>
<h3 data-id="heading-12">数据流设计</h3>
<ul>
<li><strong>单向数据流</strong>：用户操作 → 手势解析 → 变换计算 → 约束应用 → 状态更新 → 重新渲染 → 回调通知。这种单向流动保证了数据的可追踪性。</li>
<li><strong>状态同步机制</strong>：内部状态变化时，通过回调机制同步给外部组件，支持实时同步和延迟同步两种模式，适应不同的性能需求。</li>
</ul>
<p>实现独立的人像交互调整功能后，关键是打通 “用户操作” 与 “PAG 预览” 的实时同步链路 —— 确保用户每一次调整都能即时反馈在球星卡模板中，这需要设计分层同步架构与高效调度策略。</p>
<h2 data-id="heading-13">六、交互与预览实时同步</h2>
<p>在球星卡生成流程中，“用户调整人像” 与 “PAG 预览更新” 的实时同步是核心体验指标 —— 用户每一次拖拽、缩放或旋转操作，都需要即时反馈在球星卡模板中，才能让用户精准判断构图效果。我们先来看一下实现效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fda5eb04c8744b7d81053047e34321cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=Fy2ZE0uP%2Bt%2FHLI2li8UCJy387mo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来，我们从逻辑架构、关键技术方案、边界场景处理三方面，拆解 “用户交互调整” 与 “PAG 预览同步” 链路的实现思路。</p>
<h3 data-id="heading-14">逻辑架构：三层协同同步模型</h3>
<p>组件将 “交互 - 同步 - 渲染” 拆分为三个独立但协同的层级，各层职责单一且通过明确接口通信，避免耦合导致的同步延迟或状态混乱。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72b5b151b1cb40cd9fcae281a5dab73d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=oZI%2F8D5Nyk4%2BLU%2FKYCGq5ajDBgs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>核心流转链路</strong>：用户操作 → CanvasImageEditor 生成实时 Canvas → 同步层直接复用 Canvas 更新 PAG 图层 → 调度层批量触发 flush → PagPlayer 渲染最新画面。</p>
<h3 data-id="heading-15">关键方案：低损耗 + 高实时性的平衡</h3>
<p>为同时兼顾 “高频交互导致 GPU 性能瓶颈” 与 “实时预览需即时反馈” ，组件通过三大核心技术方案实现平衡。</p>
<p><strong>复用 Canvas 元素</strong></p>
<p>跳过格式转换环节，减少性能消耗，直接复用 Canvas 元素作为 PAG 图片源。</p>
<p><strong>核心代码逻辑：</strong></p>
<p>通过 canvasEditorRef.current.getCanvas() 获取交互层的 Canvas 实例，直接传入PAG 的 replaceImageFast 接口（快速替换，不触发即时刷新），避免数据冗余处理。</p>
<pre><code class="hljs language-ini" lang="ini">// 直接使用 Canvas 元素更新 PAG，无格式转换
const <span class="hljs-attr">canvas</span> = canvasEditorRef.current.getCanvas()<span class="hljs-comment">;</span>
pagPlayerRef.current.replaceImageFast(editImageIndex, canvas)<span class="hljs-comment">; // 快速替换，不flush</span>
</code></pre>
<p><strong>智能批量调度：</strong></p>
<p><strong>分级处理更新，兼顾流畅与效率</strong></p>
<p>针对用户连续操作（如快速拖拽）产生的高频更新，组件设计 “分级调度策略”，避免每一次操作都触发 PAG 的 flush（GPU 密集型操作）：</p>
<p><strong>调度逻辑</strong>：</p>
<p>实时操作合并：通过 requestAnimationFrame 捕获连续操作，将 16ms 内的多次替换指令合并为一次；</p>
<p><strong>智能 flush 决策</strong>：</p>
<p>若距离上次 flush 超过 100ms（用户操作暂停），立即触发 flushPagView()，确保预览不延迟；</p>
<p>若操作仍在持续，延迟 Math.max(16, updateThrottle/2) 毫秒再 flush，合并多次更新。</p>
<p><strong>防抖降级</strong>：</p>
<p>当 updateThrottle &gt; 16ms（低实时性需求场景），自动降级为防抖策略，避免过度调度。</p>
<p><strong>核心代码片段</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 智能 flush 策略：短间隔合并，长间隔立即刷新</span>
const timeSinceLastFlush = Date<span class="hljs-selector-class">.now</span>() - batchUpdate<span class="hljs-selector-class">.lastFlushTime</span>;
if (timeSinceLastFlush &gt; <span class="hljs-number">100</span>) {
  await <span class="hljs-built_in">flushPagView</span>(); <span class="hljs-comment">// 间隔久，立即刷新</span>
} else {
  <span class="hljs-comment">// 延迟刷新，合并后续操作</span>
  <span class="hljs-built_in">setTimeout</span>(async () =&gt; {
    if (batchUpdate.pendingUpdates &gt; <span class="hljs-number">0</span>) {
      await <span class="hljs-built_in">flushPagView</span>();
    }
  }, Math<span class="hljs-selector-class">.max</span>(<span class="hljs-number">16</span>, updateThrottle/<span class="hljs-number">2</span>));
}
</code></pre>
<p><strong>双向状态校验：</strong></p>
<p><strong>解决首帧 / 切换场景的同步空白</strong></p>
<p>针对 “PAG 加载完成但 Canvas 未就绪”“Canvas 就绪但 PAG 未初始化” 等首帧同步问题，组件设计双向重试校验机制：</p>
<ul>
<li>PAG 加载后校验：handlePagLoad 中启动 60 帧（约 1s）重试，检测 Canvas 与 PAG 均就绪后，触发初始同步；</li>
<li>Canvas 加载后校验：handleCanvasImageLoad 同理，若 PAG 未就绪，重试至两者状态匹配；</li>
<li>编辑模式切换校验：进入 startEdit 时，通过像素检测（getImageData）判断 Canvas 是否有内容，有则立即同步，避免空白预览。</li>
</ul>
<h3 data-id="heading-16">边界场景处理：保障同步稳定性</h3>
<p><strong>编辑模式切换的状态衔接</strong></p>
<ul>
<li>进入编辑：暂停 PAG 播放，显示透明的 Canvas 交互层（opacity: 0，仅保留交互能力），触发初始同步；</li>
<li>退出编辑：清理批量调度定时器，强制 flush 确保最终状态生效，按需恢复 PAG 自动播放。</li>
</ul>
<p><strong>文本替换与图片同步的协同</strong></p>
<p>当外部传入 textReplacements（如球星名称修改）时，通过独立的 applyToPagText 接口更新文本图层，并与图片同步共享 flush 调度，避免重复刷新：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 文本替换后触发统一 flush</span>
<span class="hljs-built_in">useEffect</span>(() =&gt; {
  if (textReplacements?.length) {
    <span class="hljs-built_in">applyToPagText</span>();
    <span class="hljs-built_in">flushPagView</span>();
  }
}, <span class="hljs-selector-attr">[textReplacements]</span>);
</code></pre>
<p><strong>组件卸载的资源清理</strong></p>
<p>卸载时清除批量调度的定时器（clearTimeout），避免内存泄漏；同时 PAG 内部会自动销毁实例，释放 GPU 资源。</p>
<h3 data-id="heading-17">PAG人像居中无遮挡</h3>
<p>假设给定任意一张图片，我们将其绘制到Canvas中时，图片由于尺寸原因可能会展示不完整，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f20320c6d45c4965a2d4a791fab68979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=iXhbtjcj2kDyMBCDzSzqO11S%2B1Y%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那么，如何保证任意尺寸图片在固定尺寸Canvas中初始化默认居中无遮挡呢？</p>
<p>我们采用以下方案：</p>
<p><strong>等比缩放算法（Contain模式）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 计算适配缩放比例，确保图片完整显示</span>
<span class="hljs-type">const</span> fitScale = Math.<span class="hljs-built_in">min</span>(
  editCanvasWidth / image.width,   <span class="hljs-comment">// 宽度适配比例</span>
  availableHeight / image.height   <span class="hljs-comment">// 高度适配比例（考虑留白）</span>
)
</code></pre>
<p>核心原理：</p>
<ul>
<li>选择较小的缩放比例，确保图片在两个方向上都不会超出边界；</li>
<li>这就是CSS的object-fit: contain效果，保证图片完整可见。</li>
<li/>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1844bb68295646529e48d32d674b49b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=OSov7g1%2BbYGqAa16tpQ2j1HJa0I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>顶部留白预留</strong></p>
<p>实际的PAG模板中，顶部会有一部分遮挡，因此需要对整个画布Canvas顶部留白。</p>
<p>如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8c97a982a1e47449476bcb38ef04ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=%2FjPaXe7garlxXEPlEfFnc9KQHqU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>为人像的头部区域预留空间</li>
<li>避免重要的面部特征被PAG模板的装饰元素遮挡</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd54db9849547c885cba5cf79fddbdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=8cDAeZcTpWYZIm%2BSCCH78uelAHc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>核心代码</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 顶部留白比例</span>
<span class="hljs-type">const</span> TOP_BLANK_RATIO = <span class="hljs-number">0.2</span>


<span class="hljs-type">const</span> handleCanvasImageLoad = <span class="hljs-built_in">useCallback</span>(
  <span class="hljs-built_in">async</span> (image: HTMLImageElement) =&gt; {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Canvas图片加载完成:'</span>, image.width, <span class="hljs-string">'x'</span>, image.height)
    <span class="hljs-built_in">setIsImageReady</span>(<span class="hljs-literal">true</span>)


    <span class="hljs-comment">// 初始等比缩放以完整可见（contain）</span>
    <span class="hljs-keyword">if</span> (canvasEditorRef.current) {
      <span class="hljs-comment">// 顶部留白比例</span>
      <span class="hljs-type">const</span> TOP_BLANK_RATIO = spaceTopRatio ?? <span class="hljs-number">0</span>
      <span class="hljs-type">const</span> availableHeight = editCanvasHeight * (<span class="hljs-number">1</span> - TOP_BLANK_RATIO)


      <span class="hljs-comment">// 以可用高度进行等比缩放（同时考虑宽度）</span>
      <span class="hljs-type">const</span> fitScale = Math.<span class="hljs-built_in">min</span>(
        editCanvasWidth / image.width, 
        availableHeight / image.height
      )


      <span class="hljs-comment">// 计算使图片顶部恰好留白 TOP_BLANK_RATIO 的位移</span>
      <span class="hljs-type">const</span> topMargin = editCanvasHeight * TOP_BLANK_RATIO
      <span class="hljs-type">const</span> imageScaledHeight = image.height * fitScale
      <span class="hljs-type">const</span> targetCenterY = topMargin + imageScaledHeight / <span class="hljs-number">2</span>
      <span class="hljs-type">const</span> yOffset = targetCenterY - editCanvasHeight / <span class="hljs-number">2</span>
      
      canvasEditorRef.current.<span class="hljs-built_in">setTransform</span>({ 
        x: <span class="hljs-number">0</span>, 
        y: yOffset, 
        scale: fitScale, 
        rotation: <span class="hljs-number">0</span> 
      })
    }
    <span class="hljs-comment">// ...</span>
  },
  [applyToPag, flushPagView, isEditMode, editCanvasWidth, editCanvasHeight]
)
</code></pre>
<p>在单张球星卡的交互、预览与合成链路跑通后，需进一步拓展批量合成能力，以满足多等级球星卡一次性生成的业务需求，核心在于解决批量场景下的渲染效率、资源管理与并发控制问题。</p>
<h2 data-id="heading-18">七、批量生成</h2>
<p>在以上章节，我们实现了单个卡片的交互及合成，但实际的需求中还有批量生成的需求，用来合成不同等级的球星卡，因此接下来我们需要处理批量生成相关的逻辑（碍于篇幅原因，这里我们就不展示代码了，主要以流程图形式来呈现。</p>
<p>经统计，经过各种手段优化后本活动中批量合成8张图最快仅需3s，最慢10s，批量合成过程用户基本是感知不到。</p>
<h3 data-id="heading-19">关键技术方案</h3>
<ul>
<li>离线渲染隐藏容器：避免布局干扰</li>
<li>资源缓存与预加载：提升合成效率</li>
<li>并发工作协程池：平衡性能与稳定性</li>
<li>多层重试容错：提升合成成功率</li>
<li>图片处理与尺寸适配：保障合成质量</li>
<li>结合业务场景实现批量合成中断下次访问页面后台继续生成的逻辑：保障合成功能稳定性。</li>
</ul>
<h3 data-id="heading-20">核心架构</h3>
<ul>
<li>资源管理层：负责PAG库加载、buffer缓存、预加载调度</li>
<li>任务处理层：单个模板的渲染流水线，包含重试机制</li>
<li>并发控制层：工作协程池管理，任务队列调度</li>
</ul>
<h3 data-id="heading-21">整体批量合成流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612b7f364a01464682a2e01d60f4a0b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=4uzWIL8yDryQcpg0M3eItoblv%2FQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>节拍拉取：按照固定时间间隔依次拉取资源，而非一次性并发获取所有资源</p>
<h3 data-id="heading-22">单个模板处理流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a635fd380fd46e18a0c9653cbda2bca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=udNFW54g0aY206qaj%2B3b4dCCPIs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c97ecbecda84aeeaa2e8375e5a4b760~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=USGY5wKbL7t%2B0UNqfSZZpDRFMSI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-23">并发工作协程模式</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4ffb9d653c3461394a6d8ece9c75c42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=zFxVlSb59WJjwShdqzKBQGKhQsE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>共享游标：多个工作协程共同使用的任务队列指针，用于协调任务分配。</p>
<p>原子获取任务：确保在并发环境下，每个任务只被一个协程获取，避免重复处理。</p>
<p>资源管理与缓存策略</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1b994db9a114173bcf9805939ae4b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339934&amp;x-signature=KO9Wip5uJjz2Mj6ipKUhzkf6CWU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>批量合成与单卡交互的功能落地后，需针对开发过程中出现的卡顿、空帧、加载慢等问题进行针对性优化，同时构建兼容性检测与降级方案，保障不同环境下功能的稳定可用。</p>
<h2 data-id="heading-24">八、性能优化与降级兼容</h2>
<h3 data-id="heading-25">性能优化</h3>
<p>上述功能开发和实现并非一蹴而就，过程中遇到很多问题，诸如：</p>
<ul>
<li>图片拖动卡顿</li>
<li>Canvas导出空图、导出图片模糊</li>
<li>批量合成时间较久</li>
<li>PAG初始加载慢</li>
<li>导出图片时间久</li>
</ul>
<p>等等问题，因此，我们在开发过程中就对各功能组件进行性能优化，大体如下：</p>
<p><strong>PagPlayer（PAG播放器）</strong></p>
<p><strong>资源管理优化</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src变化时主动销毁旧实例，释放WebGL/PAG资源</span>
if (srcChanged) {
  if (pagPlayer) {
    try {
      pagPlayer<span class="hljs-selector-class">.destroy</span>()
    } catch (e) {
      console<span class="hljs-selector-class">.warn</span>('Destroy previous player failed:', e)
    }
  }
}
</code></pre>
<p><strong>WebGL检查与降级</strong>：</p>
<ul>
<li>检查WebGL支持，不可用时降级为2D警告</li>
<li>验证Canvas状态和尺寸</li>
<li>PAGView创建带重试机制</li>
</ul>
<p><strong>字体预注册</strong>：</p>
<ul>
<li>必须在加载PAG文件之前注册字体</li>
<li>使用File类型进行字体注册</li>
</ul>
<p><strong>CanvasImageEditor（Canvas图片编辑器）</strong></p>
<p><strong>高DPI优化：</strong></p>
<ul>
<li>自动检测设备像素比，适配高分辨率设备</li>
<li>分离物理像素和CSS像素，确保清晰度</li>
</ul>
<p><strong>内存管理</strong>：</p>
<ul>
<li>组件卸载时自动清理Canvas资源</li>
<li>启用高质量图像平滑，避免出现边缘锯齿</li>
<li>使用CSS touch-action控制触摸行为</li>
</ul>
<p><strong>EditablePagPlayer（可编辑PAG播放器）</strong></p>
<p><strong>智能批量更新系统：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 高性能实时更新 - 使用RAF + 批量flush</span>
const smartApplyToPag = <span class="hljs-built_in">useMemo</span>(() =&gt; {
  return () =&gt; {
    rafId = <span class="hljs-built_in">requestAnimationFrame</span>(async () =&gt; {
      await <span class="hljs-built_in">applyToPag</span>() <span class="hljs-comment">// 快速图片替换（无flush）</span>
      <span class="hljs-built_in">smartFlush</span>(batchUpdateRef.current) <span class="hljs-comment">// 管理批量flush</span>
    })
  }
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p><strong>批量flush策略：</strong></p>
<ul>
<li>距离上次flush超过100ms立即flush</li>
<li>否则延迟16ms~updateThrottle/2合并多次更新</li>
<li>减少PAG刷新次数，提升性能</li>
</ul>
<p><strong>内存优化</strong>：</p>
<ul>
<li>自动管理Canvas和PAG资源生命周期</li>
<li>智能预热：检测Canvas内容避免不必要初始化</li>
<li>资源复用：复用Canvas元素</li>
</ul>
<p><strong>PAGBatchComposer（批量PAG合成器）</strong></p>
<p><strong>高并发处理：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工作协程：按队列取任务直至耗尽或取消</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">runWorker</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">while</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelled</span>) {
    <span class="hljs-keyword">const</span> idx = cursor++
    <span class="hljs-keyword">if</span> (idx &gt;= total) <span class="hljs-keyword">break</span>
    <span class="hljs-comment">// 处理单个模板...</span>
  }
}
</code></pre>
<p><strong>智能重试机制</strong>：</p>
<ul>
<li>外层重试：最多3次整体重试，递增延迟</li>
<li>内层重试：PAG操作级别重试2次</li>
<li>首次延迟：第一个PAG处理增加500ms延迟</li>
</ul>
<p><strong>内存管理</strong>：</p>
<ul>
<li>每个模板处理完成后立即清理Canvas和PAG对象</li>
<li>集成Canvas计数器监控内存使用</li>
<li>支持强制清理超时实例</li>
</ul>
<p><strong>性能监控debugUtils</strong></p>
<ul>
<li>提供详细的性能监控和调试日志</li>
<li>支持批量统计分析（吞吐量、平均时间等）</li>
</ul>
<h3 data-id="heading-26">降级兼容</h3>
<p>由于核心业务依赖 PAG 技术栈，而 PAG 运行需 WebGL 和 WebAssembly 的基础API支持，因此必须在应用初始化阶段对这些基础 API 进行兼容性检测，并针对不支持的环境执行降级策略，以保障核心功能可用性。</p>
<p>核心API检测代码如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isWebGLAvailable</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    <span class="hljs-keyword">const</span> gl =
      canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>) ||
      (canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'experimental-webgl'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebGLRenderingContext</span> | <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">return</span> !!gl
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isWasmAvailable</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> hasBasic =
      <span class="hljs-keyword">typeof</span> (globalThis <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">WebAssembly</span> === <span class="hljs-string">'object'</span> &amp;&amp;
      <span class="hljs-keyword">typeof</span> (<span class="hljs-title class_">WebAssembly</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">instantiate</span> === <span class="hljs-string">'function'</span>
    <span class="hljs-keyword">if</span> (!hasBasic) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-comment">// 最小模块校验，规避“存在但不可用”的情况</span>
    <span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0x00</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>])
    <span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Module</span>(bytes)
    <span class="hljs-keyword">const</span> inst = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title class_">Instance</span>(mod)
    <span class="hljs-keyword">return</span> inst <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-property">Instance</span>
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isPagRuntimeAvailable</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isWebGLAvailable</span>() &amp;&amp; <span class="hljs-title function_">isWasmAvailable</span>()
}
</code></pre>
<p><strong>环境适配策略</strong></p>
<ul>
<li>兼容环境（检测通过）：直接执行 H5 端 PAG 初始化流程，启用完整的前端交互编辑能力。</li>
<li>不兼容环境（检测失败）：自动切换至服务端合成链路，通过预生成静态卡片保障核心功能可用，确保用户仍能完成球星卡生成的基础流程。</li>
</ul>
<h2 data-id="heading-27">九、小结</h2>
<p>本次「用篮球认识我」球星卡生成功能开发，围绕 “用户自主调整 + 跨端一致渲染” 核心目标，通过 PAG 技术与 Canvas 交互的深度结合，构建了从单卡编辑到批量合成的完整技术链路，可从问题解决、技术沉淀、业务价值三方面总结核心成果：</p>
<p><strong>问题解决：解决业务痛点，优化用户体验</strong></p>
<p>针对初期 “服务端固定合成导致构图偏差” 的核心痛点，通过 H5 端承接关键链路，保障活动玩法完整性：</p>
<ul>
<li>交互自主性：基于 Canvas 封装的CanvasImageEditor组件，支持单指拖拽、双指缩放 / 旋转，让用户可精准调整人像构图，解决 “固定合成无法适配个性化需求” 问题；</li>
<li>预览实时性：设计 “交互感知 - 同步调度 - 渲染执行” 三层模型，通过复用 Canvas 元素、智能批量调度等方案，实现操作与 PAG 预览的即时同步，避免 “调整后延迟反馈” 的割裂感；</li>
<li>场景兼容性：针对 PAG 加载失败、WebGL 不支持等边界场景，设计静态图层兜底、服务端合成降级、截帧前渲染同步等方案，保障功能高可用性。</li>
</ul>
<p><strong>技术沉淀</strong></p>
<p>本次开发过程中，围绕 PAG 技术在 H5 端的应用，沉淀出一套标准化的技术方案与组件体系，可复用于后续图片编辑、动效合成类需求：</p>
<ul>
<li>组件化封装：拆分出PagPlayer（基础播放与图层替换）、CanvasImageEditor（手势交互）、EditablePagPlayer（交互与预览同步）、PAGBatchComposer（批量合成）四大核心组件，各组件职责单一、接口清晰，支持灵活组合；</li>
<li>性能优化：通过 “高清适配（DPR 处理）、资源复用（Canvas 直接传递）、调度优化（RAF 合并更新）、内存管理（实例及时销毁）” 等优化方向，为后续复杂功能的性能调优提供参考范例；</li>
<li>问题解决案例：记录 PAG 字体注册失效、截帧空帧、批量合成卡顿等典型问题的排查思路与解决方案，形成技术文档，降低后续团队使用 PAG 的门槛。</li>
</ul>
<p><strong>业务价值：支撑活动爆发，拓展技术边界</strong></p>
<p>从业务落地效果来看，本次技术方案不仅满足了「用篮球认识我」活动的核心需求，更为社区侧后续视觉化功能提供了技术支撑：</p>
<ul>
<li>活动保障：球星卡生成功能上线后，未出现因技术问题导致的功能不可用。</li>
<li>技术能力拓展：首次在社区 H5 端落地 PAG 动效合成与手势交互结合的方案，填补了 “前端 PAG 应用” 的技术空白，为后续一些复杂交互奠定基础。</li>
</ul>
<p><strong>后续优化方向</strong></p>
<p>尽管当前方案已满足业务需求，但仍有可进一步优化的空间：</p>
<ul>
<li>性能再提升：批量合成场景下，可探索 Web Worker 分担 PAG 解析压力，减少主线程阻塞。</li>
<li>功能扩展：在CanvasImageEditor中增加图片裁剪、滤镜叠加等功能，拓展组件的适用场景。</li>
</ul>
<h3 data-id="heading-28">往期回顾</h3>
<ol>
<li>
<p>Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术</p>
</li>
<li>
<p>Java 设计模式：原理、框架应用与实战全解析｜得物技术</p>
</li>
<li>
<p>Go语言在高并发高可用系统中的实践与解决方案｜得物技术</p>
</li>
<li>
<p>从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术</p>
</li>
<li>
<p>数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术</p>
</li>
</ol>
<h3 data-id="heading-29">文 /无限</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回收团队基于Cursor集成MCP的智能代码修复提示词生成实践]]></title>    <link>https://juejin.cn/post/7587998744294752262</link>    <guid>https://juejin.cn/post/7587998744294752262</guid>    <pubDate>2025-12-26T10:29:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294752262" data-draft-id="7588002126258356230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回收团队基于Cursor集成MCP的智能代码修复提示词生成实践"/> <meta itemprop="keywords" content="程序员,人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-26T10:29:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回收团队基于Cursor集成MCP的智能代码修复提示词生成实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:29:56.000Z" title="Fri Dec 26 2025 10:29:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、痛点</h2>
<h3 data-id="heading-1">痛点一：为什么我的Token消耗的这么快</h3>
<p>Token的消耗量通常受到下面两个因素的影响</p>
<ul>
<li>输入和输出的Token数量：输入的Token越多，输出的Token也会相应增加，因为模型会基于输入的上下文进行内容生成。</li>
<li>任务复杂性：更复杂的任务通常需要消耗更多的Token，而多模态的Agent往往消耗的Token会更高。</li>
</ul>
<p>为什么模糊的提示词会增加Token的消耗量？</p>
<ul>
<li>模糊的提示词可能包含大量与输出不相关的内容，增加输入的Token量。</li>
<li>模糊的提示词通常缺乏具体细节或明确约束，导致模型无法直接理解用户意图。为了覆盖可能的解释，模型倾向于生成更长、更全面的响应，以避免遗漏关键信息，从而增加输出token数量。</li>
<li>模糊的提示词往往无法精准的生成用户想要的内容。用户可能因输出不符合预期而多次修改提示，形成无效交互循环，无形中浪费Token。</li>
</ul>
<h3 data-id="heading-2">痛点二：AI修复代码为什么总是"差点意思"？</h3>
<p>一般都是拿到Sonar 扫描结果复制粘贴, 让AI修复后，一个一个改, 又太慢, 太多问题要么修复不准确，要么把好的代码也改坏了，还有就是问题
太多, 上下文超限修改失败</p>
<p><strong>举个真实的例子：</strong>
Sonar报告：<code>ActivityServiceImpl.java</code> 第120行存在空指针风险</p>
<p>我的提示词（第一版）：</p>
<pre><code class="hljs language-css" lang="css">请修复以下问题：第<span class="hljs-number">120</span>行存在空指针风险
代码：
<span class="hljs-selector-attr">[粘贴整个ActivityServiceImpl.java文件，可能是几千行]</span>
</code></pre>
<p>AI的回复：</p>
<ul>
<li>情况1："这个文件太长了，请提供更具体的代码片段"</li>
<li>情况2：修复了空指针，但把旁边的业务逻辑也改了</li>
<li>情况3："Token超出限制，无法处理"</li>
</ul>
<h3 data-id="heading-3">问题根源在哪？</h3>
<ol>
<li><strong>上下文冗余</strong>：超大文件代码中，真正相关的可能只有20行</li>
<li><strong>缺乏规范引导</strong>：没告诉AI要遵循什么编码规范</li>
<li><strong>信息不准确</strong>：没有精确指出问题在哪个方法、什么结构中</li>
<li><strong>没有示例</strong>：AI缺乏类似问题的修复参考</li>
</ol>
<h2 data-id="heading-4">二、转机：Cursor结合MCP打造自动化修复流程</h2>
<p>关键问题在于：<strong>如何将Sonar扫描结果转换为AI能高效理解的结构化提示词</strong>。</p>
<p>于是，我利用MCP（Model Context Protocol）协议为Cursor开发了一套智能提示词生成系统。</p>
<h3 data-id="heading-5">什么是MCP？</h3>
<p>MCP（Model Context Protocol）是一个开放协议，Cursor支持这个协议，允许我们通过Python等语言编写自定义工具，直接集成到Cursor的AI助手中。简单说就是：<strong>让AI拥有调用你自己编写的工具的能力</strong>。</p>
<h3 data-id="heading-6">我的方案架构</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdb0e7f30b144b9db7dde7e0415c66d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767349796&amp;x-signature=muUTZJGKL%2FsAHZewB9m0evKbyqU%3D" width="500" loading="lazy"/>
<h2 data-id="heading-7">三、核心方案：六步智能提示词生成法</h2>
<p>这套方案的核心思想是：<strong>让AI精确理解问题，而不是让AI去猜测问题</strong>。</p>
<p>整个系统基于以下6个步骤构建：</p>
<h4 data-id="heading-8">第一步：问题类型识别</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IssueTypeClassifier</span>:
    <span class="hljs-string">"""将Sonar规则映射到问题类型"""</span>
    
    RULE_MAPPING = {
        <span class="hljs-comment"># 空指针问题</span>
        <span class="hljs-string">"java:S2259"</span>: <span class="hljs-string">"NullPointer"</span>,
        <span class="hljs-string">"java:S2637"</span>: <span class="hljs-string">"NullPointer"</span>,
        
        <span class="hljs-comment"># 资源泄露</span>
        <span class="hljs-string">"java:S2095"</span>: <span class="hljs-string">"ResourceLeak"</span>,
        <span class="hljs-string">"java:S2093"</span>: <span class="hljs-string">"ResourceLeak"</span>,
        
        <span class="hljs-comment"># 安全漏洞</span>
        <span class="hljs-string">"java:S3649"</span>: <span class="hljs-string">"SQLInjection"</span>,
        <span class="hljs-string">"java:S2076"</span>: <span class="hljs-string">"CommandInjection"</span>,
        
        <span class="hljs-comment"># 代码规范</span>
        <span class="hljs-string">"java:S117"</span>: <span class="hljs-string">"NamingConvention"</span>,
        <span class="hljs-string">"java:S1192"</span>: <span class="hljs-string">"DuplicateString"</span>,
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify</span>(<span class="hljs-params">rule_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""根据规则ID分类问题类型"""</span>
        <span class="hljs-keyword">return</span> IssueTypeClassifier.RULE_MAPPING.get(
            rule_key, 
            <span class="hljs-string">"General"</span>
        )
</code></pre>
<h4 data-id="heading-9">第二步：AST代码结构解析</h4>
<p><strong>什么是AST？</strong></p>
<p>AST（Abstract Syntax Tree，抽象语法树）是将代码理解成树形结构的技术。</p>
<p>当Sonar告诉你"第120行有空指针问题"，我们需要知道：</p>
<ul>
<li>第120行在哪个<strong>方法</strong>里？</li>
<li>这个方法从哪行<strong>开始</strong>，到哪行<strong>结束</strong>？</li>
<li>方法的完整信息（方法名、参数、返回值）</li>
</ul>
<p><strong>AST解析 = 像编译器一样理解代码结构</strong></p>
<p>想象代码是一个家族，AST就是家谱树：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">ClassDeclaration:</span> <span class="hljs-string">ActivityServiceImpl（类）</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">├─</span> <span class="hljs-attr">FieldDeclaration:</span> <span class="hljs-string">activityFacadeHelper（成员变量）</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">├─</span> <span class="hljs-attr">MethodDeclaration:</span> <span class="hljs-string">queryActivityListWithNewImei（方法）</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">position:</span> <span class="hljs-string">line</span> <span class="hljs-number">106</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">parameters:</span> [<span class="hljs-string">Long</span> <span class="hljs-string">orderId</span>, <span class="hljs-string">String</span> <span class="hljs-string">newMachineUuid</span>]
 <span class="hljs-string">│</span>   <span class="hljs-string">├─</span> <span class="hljs-attr">return_type:</span> <span class="hljs-string">OrderAllowActivityMiVO</span>
 <span class="hljs-string">│</span>   <span class="hljs-string">└─</span> <span class="hljs-attr">body:</span> {<span class="hljs-string">...</span>}  <span class="hljs-string">←</span> <span class="hljs-string">第120行在这里</span>
 <span class="hljs-string">│</span>
 <span class="hljs-string">└─</span> <span class="hljs-attr">MethodDeclaration:</span> <span class="hljs-string">editActivityListWithNewImei（另一个方法）</span>
</code></pre>
<p><strong>使用javalang进行AST解析</strong></p>
<p>javalang是一个纯Python库，用Python重新实现了Java语法解析器，<strong>不需要安装Java环境</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> javalang

<span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaCodeParser</span>:
    <span class="hljs-string">"""Java代码结构解析器 - 使用AST精确解析"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_method_context</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, line_number: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-string">"""使用javalang进行AST解析，精确定位方法"""</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            code = f.read()
        
        <span class="hljs-comment"># 1. 解析Java代码，生成AST（语法树）</span>
        tree = javalang.parse.parse(code)
        
        <span class="hljs-comment"># 2. 遍历AST，查找包含目标行的方法节点</span>
        <span class="hljs-keyword">for</span> path, node <span class="hljs-keyword">in</span> tree.<span class="hljs-built_in">filter</span>(javalang.tree.MethodDeclaration):
            method_start = node.position.line
            method_end = calculate_method_end(node)  <span class="hljs-comment"># 计算方法结束位置</span>
            
            <span class="hljs-comment"># 3. 检查目标行是否在此方法范围内</span>
            <span class="hljs-keyword">if</span> method_start &lt;= line_number &lt;= method_end:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">'class_name'</span>: extract_class_name(path),
                    <span class="hljs-string">'method_name'</span>: node.name,              <span class="hljs-comment"># 方法名</span>
                    <span class="hljs-string">'start_line'</span>: method_start,            <span class="hljs-comment"># 方法开始行</span>
                    <span class="hljs-string">'end_line'</span>: method_end,                <span class="hljs-comment"># 方法结束行</span>
                    <span class="hljs-string">'modifiers'</span>: node.modifiers,           <span class="hljs-comment"># ['public', 'static']</span>
                    <span class="hljs-string">'return_type'</span>: node.return_type.name,  <span class="hljs-comment"># 返回值类型</span>
                    <span class="hljs-string">'parameters'</span>: [p.name <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> node.parameters],  <span class="hljs-comment"># 参数列表</span>
                }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p><strong>AST解析的价值</strong>：</p>
<ol>
<li><strong>精确定位</strong>：直接知道第120行在<code>queryActivityListWithNewImei</code>方法内，而不是<code>editActivityListWithNewIme</code>方法</li>
<li><strong>完整信息</strong>：获取方法名、参数类型、返回值等元信息</li>
<li><strong>语法理解</strong>：像编译器一样理解Java语法，不会被注释、字符串、Lambda表达式干扰</li>
<li><strong>高准确率</strong>：准确率可达99%+</li>
</ol>
<p><strong>javalang的特点</strong>：</p>
<ul>
<li>纯Python库，只需<code>pip install javalang</code></li>
<li>不需要安装JDK或Java环境</li>
<li>提供完整的Java语法树节点</li>
<li>支持Java 8+的语法特性</li>
</ul>
<h4 data-id="heading-10">第三步：智能上下文提取</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextExtractor</span>:
    <span class="hljs-string">"""根据问题类型智能提取代码上下文"""</span>
    
    <span class="hljs-comment"># 不同问题类型的提取策略配置</span>
    EXTRACTION_RULES = {
        <span class="hljs-string">"NullPointer"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,           <span class="hljs-comment"># 提取完整方法</span>
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">150</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">True</span>,           <span class="hljs-comment"># 包含import语句</span>
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>, <span class="hljs-comment"># 包含类声明</span>
        },
        <span class="hljs-string">"ResourceLeak"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">100</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>,
        },
        <span class="hljs-string">"SQLInjection"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"full_method"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">120</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">True</span>,
        },
        <span class="hljs-string">"NamingConvention"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"surrounding"</span>,            <span class="hljs-comment"># 只提取周围代码</span>
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">30</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">False</span>,
        },
        <span class="hljs-string">"General"</span>: {
            <span class="hljs-string">"range"</span>: <span class="hljs-string">"surrounding"</span>,
            <span class="hljs-string">"max_lines"</span>: <span class="hljs-number">50</span>,
            <span class="hljs-string">"include_imports"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"include_class_declaration"</span>: <span class="hljs-literal">False</span>,
        },
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, line_number: <span class="hljs-built_in">int</span>, issue_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""智能提取代码上下文"""</span>
        rules = ContextExtractor.EXTRACTION_RULES.get(
            issue_type,
            ContextExtractor.EXTRACTION_RULES[<span class="hljs-string">"General"</span>]
        )
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                lines = f.readlines()
            
            context_lines = []
            
            <span class="hljs-comment"># 1. 提取package和imports（如果需要）</span>
            <span class="hljs-keyword">if</span> rules.get(<span class="hljs-string">"include_imports"</span>):
                <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines[:<span class="hljs-number">50</span>]:
                    <span class="hljs-keyword">if</span> line.strip().startswith((<span class="hljs-string">'package '</span>, <span class="hljs-string">'import '</span>)):
                        context_lines.append(line)
                    <span class="hljs-keyword">elif</span> line.strip() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> line.strip().startswith(<span class="hljs-string">'//'</span>):
                        <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">if</span> context_lines:
                    context_lines.append(<span class="hljs-string">'\n'</span>)
            
            <span class="hljs-comment"># 2. 提取方法或周围代码</span>
            <span class="hljs-keyword">if</span> rules[<span class="hljs-string">"range"</span>] == <span class="hljs-string">"full_method"</span>:
                method_info = JavaCodeParser.extract_method_context(file_path, line_number)
                <span class="hljs-keyword">if</span> method_info:
                    start = method_info[<span class="hljs-string">'start_line'</span>] - <span class="hljs-number">1</span>
                    end = method_info[<span class="hljs-string">'end_line'</span>]
                    
                    <span class="hljs-comment"># 如果需要类声明，向上查找</span>
                    <span class="hljs-keyword">if</span> rules.get(<span class="hljs-string">"include_class_declaration"</span>):
                        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
                            <span class="hljs-keyword">if</span> <span class="hljs-string">'class '</span> <span class="hljs-keyword">in</span> lines[i]:
                                context_lines.append(lines[i])
                                context_lines.append(<span class="hljs-string">'    // ... 其他成员 ...\n\n'</span>)
                                <span class="hljs-keyword">break</span>
                    
                    context_lines.extend(lines[start:end])
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 回退到周围代码</span>
                    start = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, line_number - <span class="hljs-number">25</span>)
                    end = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(lines), line_number + <span class="hljs-number">25</span>)
                    context_lines.extend(lines[start:end])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 提取周围代码</span>
                max_lines = rules[<span class="hljs-string">"max_lines"</span>]
                start = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, line_number - max_lines // <span class="hljs-number">2</span>)
                end = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">len</span>(lines), line_number + max_lines // <span class="hljs-number">2</span>)
                context_lines.extend(lines[start:end])
            
            <span class="hljs-comment"># 3. 限制总行数</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(context_lines) &gt; rules[<span class="hljs-string">"max_lines"</span>]:
                context_lines = context_lines[:rules[<span class="hljs-string">"max_lines"</span>]]
                context_lines.append(<span class="hljs-string">'\n// ... 后续代码省略 ...\n'</span>)
            
            <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(context_lines)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"提取失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"// 无法读取文件: <span class="hljs-subst">{file_path}</span>"</span>
</code></pre>
<p><strong>核心策略</strong>：</p>
<ul>
<li><strong>差异化提取</strong>：空指针问题提取150行含imports，命名规范只提取30行</li>
<li><strong>智能回退</strong>：AST解析失败时自动回退到简单提取</li>
<li><strong>Token控制</strong>：通过max_lines限制，避免上下文过长</li>
</ul>
<h4 data-id="heading-11">第四步：分层模板体系</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PromptTemplateEngine</span>:
    <span class="hljs-string">"""分层的提示词模板引擎"""</span>
    
    <span class="hljs-comment"># Java语言规范</span>
    JAVA_STANDARDS = <span class="hljs-string">"""
请遵循以下Java开发规范：
1. 遵循阿里巴巴Java开发手册的编码规范
2. 所有可能为null的参数必须进行防御性检查
3. 资源（文件流、数据库连接等）必须使用try-with-resources自动管理
4. 异常必须妥善处理，不得吞掉异常
5. 方法复杂度不得过高，保持代码可读性
6. 变量和方法命名要清晰、符合驼峰命名规范
"""</span>
    
    <span class="hljs-comment"># 问题类型特定模板</span>
    ISSUE_TEMPLATES = {
        <span class="hljs-string">"NullPointer"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的空指针风险问题"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 在方法开始处对可能为null的参数进行检查
2. 如果参数为null，抛出IllegalArgumentException异常，并提供清晰的错误信息
3. 保持原有业务逻辑不变
4. 不要修改方法签名
5. 确保修复后不影响其他正常调用
"""</span>
        },
        <span class="hljs-string">"ResourceLeak"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的资源泄露问题"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 使用try-with-resources语句包裹需要关闭的资源
2. 确保在任何情况下（正常或异常）资源都能正确释放
3. 保持原有异常处理方式
4. 保持方法签名不变
"""</span>
        },
        <span class="hljs-string">"SQLInjection"</span>: {
            <span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码中的SQL注入安全漏洞"</span>,
            <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"""
修复要求：
1. 必须使用参数化查询（PreparedStatement）替代字符串拼接
2. 使用占位符（?）和参数绑定传递用户输入
3. 不得使用字符串拼接或格式化方式构建SQL语句
4. 保持查询逻辑不变
"""</span>
        },
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">issue_type: <span class="hljs-built_in">str</span>, issue_data: <span class="hljs-built_in">dict</span>, code_context: <span class="hljs-built_in">str</span>, examples: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成最终提示词"""</span>
        
        template = PromptTemplateEngine.ISSUE_TEMPLATES.get(
            issue_type,
            {<span class="hljs-string">"task"</span>: <span class="hljs-string">"修复以下代码问题"</span>, <span class="hljs-string">"requirements"</span>: <span class="hljs-string">"保持代码风格与项目一致"</span>}
        )
        
        <span class="hljs-comment"># 组装提示词</span>
        prompt = <span class="hljs-string">f"""你是一位精通Java开发的资深工程师。

任务：<span class="hljs-subst">{template[<span class="hljs-string">'task'</span>]}</span>

编码规范：<span class="hljs-subst">{PromptTemplateEngine.JAVA_STANDARDS.strip()}</span>
"""</span>
        
        <span class="hljs-comment"># 添加示例（如果有）</span>
        <span class="hljs-keyword">if</span> examples:
            prompt += <span class="hljs-string">f"\n<span class="hljs-subst">{examples}</span>\n"</span>
        
        <span class="hljs-comment"># 添加问题详情</span>
        prompt += <span class="hljs-string">f"""
问题详情：
- 规则ID: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'rule'</span>, <span class="hljs-string">'Unknown'</span>)}</span>
- 问题类型: <span class="hljs-subst">{issue_type}</span>
- 严重级别: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'MAJOR'</span>)}</span>
- 问题描述: <span class="hljs-subst">{issue_data.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">''</span>)}</span>
- 问题位置: 第<span class="hljs-subst">{issue_data.get(<span class="hljs-string">'line'</span>, <span class="hljs-number">0</span>)}</span>行

待修复代码：
```java
<span class="hljs-subst">{code_context}</span>
``` <span class="hljs-subst">{data-source-line=<span class="hljs-string">"360"</span>}</span>

<span class="hljs-subst">{template[<span class="hljs-string">'requirements'</span>].strip()}</span>

输出格式：
- 仅输出修复后的完整方法代码
- 使用```java```格式包裹代码
- 不要输出多余的解释文字
- 确保代码可以直接替换原有方法
"""</span>
        
        <span class="hljs-keyword">return</span> prompt
</code></pre>
<p><strong>模板设计</strong>：</p>
<ul>
<li><strong>三层结构</strong>：角色设定 + 编码规范 + 问题类型特定要求</li>
<li><strong>灵活扩展</strong>：新增问题类型只需添加模板配置</li>
<li><strong>规范注入</strong>：自动注入阿里巴巴Java开发手册规范</li>
</ul>
<h4 data-id="heading-12">第五步：Few-shot示例库</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleRepository</span>:
    <span class="hljs-string">"""问题修复示例库 - 提供修复前后的对比案例"""</span>
    
    EXAMPLES = {
        <span class="hljs-string">"NullPointer"</span>: <span class="hljs-string">"""
参考示例：

示例1 - 空指针防御性检查：
修复前：
```java
public String getUserEmail(User user) {
    return user.getEmail();
}
``` {data-source-line="395"}
修复后：
```java
public String getUserEmail(User user) {
    if (user == null) {
        throw new IllegalArgumentException("用户对象不能为空");
    }
    return user.getEmail();
}
``` {data-source-line="404"}

示例2 - 多参数空值检查：
修复前：
```java
public void processOrder(Order order, User user) {
    order.setUser(user);
    order.setStatus("processed");
}
``` {data-source-line="413"}
修复后：
```java
public void processOrder(Order order, User user) {
    if (order == null) {
        throw new IllegalArgumentException("订单对象不能为空");
    }
    if (user == null) {
        throw new IllegalArgumentException("用户对象不能为空");
    }
    order.setUser(user);
    order.setStatus("processed");
}
``` {data-source-line="426"}
"""</span>,
        <span class="hljs-string">"ResourceLeak"</span>: <span class="hljs-string">"""
参考示例：

示例 - 使用try-with-resources：
修复前：
```java
public String readFile(String path) throws IOException {
    FileInputStream fis = new FileInputStream(path);
    byte[] buffer = new byte[1024];
    int length = fis.read(buffer);
    return new String(buffer, 0, length);
}
``` {data-source-line="440"}
修复后：
```java
public String readFile(String path) throws IOException {
    try (FileInputStream fis = new FileInputStream(path)) {
        byte[] buffer = new byte[1024];
        int length = fis.read(buffer);
        return new String(buffer, 0, length);
    }
}
``` {data-source-line="450"}
"""</span>,
        <span class="hljs-string">"SQLInjection"</span>: <span class="hljs-string">"""
参考示例：

示例 - 使用PreparedStatement：
修复前：
```java
public User findUserByName(String name) {
    String sql = "SELECT * FROM users WHERE name = '" + name + "'";
    return jdbcTemplate.queryForObject(sql, User.class);
}
``` {data-source-line="462"}
修复后：
```java
public User findUserByName(String name) {
    String sql = "SELECT * FROM users WHERE name = ?";
    return jdbcTemplate.queryForObject(sql, User.class, name);
}
``` {data-source-line="469"}
"""</span>,
    }
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_examples</span>(<span class="hljs-params">issue_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""获取相关示例"""</span>
        <span class="hljs-keyword">return</span> ExampleRepository.EXAMPLES.get(issue_type, <span class="hljs-string">""</span>)
</code></pre>
<p><strong>示例库价值</strong>：</p>
<ul>
<li><strong>Few-shot学习</strong>：让AI通过案例学习修复模式</li>
<li><strong>格式统一</strong>：修复前/后对比，清晰明了</li>
<li><strong>易于扩展</strong>：新增示例只需添加字符串配置</li>
</ul>
<h4 data-id="heading-13">第六步：整合到MCP服务</h4>
<p>现在，将所有组件整合到MCP服务中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os

mcp = FastMCP(<span class="hljs-string">"intelligent-code-fix"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelligentPromptGenerator</span>:
    <span class="hljs-string">"""智能提示词生成器 - 整合6步生成法的核心类"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_for_issue</span>(<span class="hljs-params">issue: <span class="hljs-built_in">dict</span>, base_dir: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""为单个issue生成智能提示词"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 1. 提取issue信息</span>
            rule_key = issue.get(<span class="hljs-string">'rule'</span>, <span class="hljs-string">''</span>)
            component = issue.get(<span class="hljs-string">'component'</span>, <span class="hljs-string">''</span>)
            file_path = component.split(<span class="hljs-string">':'</span>, <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-string">':'</span> <span class="hljs-keyword">in</span> component <span class="hljs-keyword">else</span> component
            full_path = os.path.join(base_dir, file_path)
            line_number = issue.get(<span class="hljs-string">'line'</span>, <span class="hljs-number">0</span>)
            message = issue.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">''</span>)
            severity = issue.get(<span class="hljs-string">'severity'</span>, <span class="hljs-string">'MAJOR'</span>)
            
            <span class="hljs-comment"># 2. 问题类型识别</span>
            issue_type = IssueTypeClassifier.classify(rule_key)
            
            logging.info(<span class="hljs-string">f"处理问题: <span class="hljs-subst">{file_path}</span>:<span class="hljs-subst">{line_number}</span> - <span class="hljs-subst">{issue_type}</span>"</span>)
            
            <span class="hljs-comment"># 3. 提取代码上下文</span>
            code_context = ContextExtractor.extract(full_path, line_number, issue_type)
            
            <span class="hljs-comment"># 4. 获取示例</span>
            examples = ExampleRepository.get_examples(issue_type)
            
            <span class="hljs-comment"># 5. 生成提示词</span>
            issue_data = {
                <span class="hljs-string">'rule'</span>: rule_key,
                <span class="hljs-string">'severity'</span>: severity,
                <span class="hljs-string">'message'</span>: message,
                <span class="hljs-string">'line'</span>: line_number,
            }
            
            prompt = PromptTemplateEngine.generate(
                issue_type=issue_type,
                issue_data=issue_data,
                code_context=code_context,
                examples=examples
            )
            
            <span class="hljs-comment"># 6. 计算元数据</span>
            token_estimate = <span class="hljs-built_in">len</span>(prompt) // <span class="hljs-number">4</span>  <span class="hljs-comment"># 粗略估算</span>
            
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'prompt'</span>: prompt,
                <span class="hljs-string">'metadata'</span>: {
                    <span class="hljs-string">'file'</span>: file_path,
                    <span class="hljs-string">'line'</span>: line_number,
                    <span class="hljs-string">'issue_type'</span>: issue_type,
                    <span class="hljs-string">'rule'</span>: rule_key,
                    <span class="hljs-string">'severity'</span>: severity,
                    <span class="hljs-string">'token_estimate'</span>: token_estimate,
                }
            }
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"生成提示词失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e),
                <span class="hljs-string">'file'</span>: file_path,
                <span class="hljs-string">'line'</span>: line_number,
            }

<span class="hljs-meta">@mcp.tool(<span class="hljs-params"><span class="hljs-string">"auto-fix-sonar-issues"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">auto_fix_sonar_issues</span>(<span class="hljs-params">
    project_name: <span class="hljs-built_in">str</span>,
    cookie: <span class="hljs-built_in">str</span>,
    base_dir: <span class="hljs-built_in">str</span>,
    branch: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,
    page_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    page_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,
    is_new_code_period: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""智能修复Sonar扫描问题 - 核心MCP工具"""</span>
    
    <span class="hljs-comment"># 获取Sonar问题列表</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        params = {
            <span class="hljs-string">"components"</span>: project_name,
            <span class="hljs-string">"ps"</span>: page_size,
            <span class="hljs-string">"p"</span>: page_num,
        }
        <span class="hljs-keyword">if</span> branch:
            params[<span class="hljs-string">"branch"</span>] = branch
        <span class="hljs-keyword">if</span> is_new_code_period:
            params[<span class="hljs-string">"inNewCodePeriod"</span>] = <span class="hljs-string">"true"</span>
        
        response = <span class="hljs-keyword">await</span> client.get(
            <span class="hljs-string">"https://sonar.zhuanspirit.com/api/issues/search"</span>,
            params=params,
            headers={<span class="hljs-string">"Cookie"</span>: cookie},
            timeout=<span class="hljs-number">10.0</span>
        )
        
        data = response.json()
        issues = data.get(<span class="hljs-string">'issues'</span>, [])
        total = data.get(<span class="hljs-string">'total'</span>, <span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 为每个issue生成智能提示词</span>
    results = []
    success_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">for</span> idx, issue <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(issues, <span class="hljs-number">1</span>):
        result = IntelligentPromptGenerator.generate_for_issue(issue, base_dir)
        
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'success'</span>]:
            success_count += <span class="hljs-number">1</span>
            metadata = result[<span class="hljs-string">'metadata'</span>]
            results.append(<span class="hljs-string">f"""
<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">80</span>}</span>
## Issue <span class="hljs-subst">{idx}</span>: <span class="hljs-subst">{metadata[<span class="hljs-string">'file'</span>]}</span> (第<span class="hljs-subst">{metadata[<span class="hljs-string">'line'</span>]}</span>行)

**问题类型**: <span class="hljs-subst">{metadata[<span class="hljs-string">'issue_type'</span>]}</span>  
**严重级别**: <span class="hljs-subst">{metadata[<span class="hljs-string">'severity'</span>]}</span>  
**预估Token**: <span class="hljs-subst">{metadata[<span class="hljs-string">'token_estimate'</span>]}</span>

### 生成的智能提示词：

<span class="hljs-subst">{result[<span class="hljs-string">'prompt'</span>]}</span>
<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">80</span>}</span>
"""</span>)
    
    <span class="hljs-comment"># 组装最终输出</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"""
# 智能代码修复提示词生成完成

## 统计信息
- **项目**: <span class="hljs-subst">{project_name}</span>
- **总问题数**: <span class="hljs-subst">{total}</span>
- **本批次**: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(issues)}</span> 个
- **成功生成**: <span class="hljs-subst">{success_count}</span> 个

## 智能提示词列表
<span class="hljs-subst">{<span class="hljs-string">""</span>.join(results)}</span>

---
由智能提示词生成引擎提供支持
"""</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(<span class="hljs-string">"stdio"</span>)
</code></pre>
<p><strong>整合要点</strong>：</p>
<ul>
<li><strong>错误处理</strong>：每个issue独立处理，单个失败不影响其他</li>
<li><strong>元数据追踪</strong>：记录文件、行号、问题类型、Token估算</li>
<li><strong>结构化输出</strong>：Markdown格式，便于Cursor展示</li>
</ul>
<h3 data-id="heading-14">安装依赖包</h3>
<p>在使用MCP服务之前，需要先安装必要的Python依赖包。创建<code>requirements.txt</code>文件：</p>
<pre><code class="hljs language-txt" lang="txt"># 智能代码修复MCP服务依赖包

# MCP框架 - 用于构建MCP服务
mcp&gt;=0.9.0

# HTTP客户端 - 用于调用Sonar API
httpx&gt;=0.27.0

# Java AST解析器 - 精确解析Java代码结构（强烈推荐）
# 优势：准确率99%+，不受注释、字符串、Lambda影响
# 注意：这是纯Python库，不需要Java环境
javalang&gt;=0.13.0
</code></pre>
<p>安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<p><strong>依赖说明</strong>：</p>
<ul>
<li><strong>mcp</strong>：MCP协议框架，让Python脚本能够被Cursor识别和调用</li>
<li><strong>httpx</strong>：现代化HTTP客户端，用于调用Sonar API获取扫描结果</li>
<li><strong>javalang</strong>：纯Python的Java AST解析器，用于精准定位代码结构，无需安装Java环境</li>
</ul>
<h3 data-id="heading-15">配置MCP（让Cursor识别你的服务）</h3>
<p>%这里改成你本地的路径%
在 <code>~/.cursor/mcp.json</code> 中添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"intelligent-code-fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/Users/Desktop/cursor/intelligent-code-fix.py"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>intelligent-code-fix</code>：MCP服务名称，在Cursor中通过<code>@intelligent-code-fix</code>调用</li>
<li><code>command</code>: Python解释器命令</li>
<li><code>args</code>: Python脚本的绝对路径（请修改为你的实际路径）</li>
<li>修改配置后需要重启Cursor生效</li>
</ul>
<h2 data-id="heading-16">四、使用体验：在Cursor中一键修复</h2>
<h3 data-id="heading-17">配置好MCP后，在Cursor中的使用非常简单</h3>
<h4 data-id="heading-18">步骤1：在Cursor聊天窗口调用MCP工具</h4>
<pre><code class="hljs language-diff" lang="diff">使用 auto-fix-sonar-issues 工具修复Sonar问题

参数：

<span class="hljs-deletion">- project_name: hunter_partner_recycle_core</span>
<span class="hljs-deletion">- cookie: sso_uid=xxx; ticket=xxx; aid=xxx</span>
<span class="hljs-deletion">- base_dir: /Users/xxx/projects/hunter/src/main/java</span>
<span class="hljs-deletion">- branch: feature-3278-163 (可选)</span>
<span class="hljs-deletion">- page_size: 10</span>




</code></pre>
<h4 data-id="heading-19">步骤2：MCP服务自动处理</h4>
<p>系统自动完成：</p>
<ol>
<li>调用Sonar API获取问题列表</li>
<li>为每个问题智能生成提示词</li>
<li>返回结构化的修复建议</li>
</ol>
<h4 data-id="heading-20">步骤3：AI生成修复后的代码</h4>
<pre><code class="hljs language-ini" lang="ini">已生成10个问题的修复建议：

Issue 1: ActivityServiceImpl.java 空指针修复
修复后代码：
<span class="hljs-section">[完整的修复代码]</span>

Issue 2: FileUtil.java 资源泄露修复
修复后代码：
<span class="hljs-section">[完整的修复代码]</span>

</code></pre>
<h4 data-id="heading-21">步骤4：一键应用修复</h4>
<p>直接在Cursor中review并应用修复</p>
<h3 data-id="heading-22">改进效果：</h3>
<ol>
<li>成本降低70% ：精准提取上下文，token使用量大幅减少</li>
<li>准确率提升30%：结构化提示词+示例引导，AI理解更准确</li>
<li>效率提升3倍：自动化流程，无需人工干预</li>
<li>质量可控：分层模板确保代码符合团队规范</li>
<li>易于扩展：新增问题类型只需添加配置</li>
</ol>
<h2 data-id="heading-23">五、写在最后</h2>
<p>真正有效的AI辅助开发，不是简单地把代码扔给AI，而是要做好：</p>
<ul>
<li><strong>问题的精准识别</strong>：知道是什么类型的问题</li>
<li><strong>上下文的智能提取</strong>：给AI最相关的代码，而不是全部代码</li>
<li><strong>规范的有效注入</strong>：让AI知道要遵循什么标准</li>
<li><strong>经验的系统沉淀</strong>：用示例库让AI学习最佳实践</li>
</ul>
<p>这套方案不仅适用于Sonar，也可以推广到其他代码扫描工具（ESLint、Checkstyle等）。核心思想都是：<strong>将非结构化的扫描结果转换为结构化的AI提示词</strong>。</p>
<p>希望这篇文章能给大家带来启发。如果大家也在探索AI辅助开发，欢迎交流！</p>
<blockquote>
<p>关于作者，刘雅斌，侠客汇Java开发工程师。
想了解更多转转公司的业务实践，欢迎点击关注下方公众号</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React下拉框接口请求hook封装]]></title>    <link>https://juejin.cn/post/7587903505134895154</link>    <guid>https://juejin.cn/post/7587903505134895154</guid>    <pubDate>2025-12-26T07:35:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587903505134895154" data-draft-id="7587709130531831817" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React下拉框接口请求hook封装"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T07:35:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jolyne_"/> <meta itemprop="url" content="https://juejin.cn/user/339101640827981"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React下拉框接口请求hook封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339101640827981/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jolyne_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:35:15.000Z" title="Fri Dec 26 2025 07:35:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>记录一下公司 下拉框封装的 接口hook。主要是支持</p>
<ul>
<li>初始化或者指定状态下请求接口</li>
<li>防抖搜索</li>
<li>支持不同类型的接口（get、post）</li>
</ul>
<h2 data-id="heading-1">代码</h2>
<h3 data-id="heading-2">主体 hook</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IObj</span>, <span class="hljs-title class_">IOption</span>, <span class="hljs-title class_">TRecord</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/interface"</span>;
<span class="hljs-keyword">import</span> { to } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/tools"</span>;
<span class="hljs-keyword">import</span> { useMount } <span class="hljs-keyword">from</span> <span class="hljs-string">"@quarkunlimit/react-hooks"</span>;
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">"lodash"</span>;
<span class="hljs-keyword">import</span> { useEffect, useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">IUseMountFetchDataNewProps</span>,
  <span class="hljs-title class_">IUseMountFetchDataResult</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"./interface"</span>;

<span class="hljs-comment">/**
 * 初始化请求下拉框接口
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">props</span>
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useSearchSelectFetchNew = (
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">IUseMountFetchDataNewProps</span>
): <span class="hljs-function"><span class="hljs-params">IUseMountFetchDataResult</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    fetchDataApi,
    request,
    searchParamKey,
    transformOptions,
    refreshFetch,
    initFetch = <span class="hljs-literal">true</span>,
    needSetExtarData = <span class="hljs-literal">false</span>,
  } = props;

  <span class="hljs-keyword">const</span> [data, setData] = useState&lt;<span class="hljs-title class_">IOption</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> isMount = useRef&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> originData = useRef&lt;<span class="hljs-title class_">IOption</span>[]&gt;([]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">otherRequest?: TRecord</span>) =&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">newRequst</span>: <span class="hljs-title class_">IObj</span> = {}
    newRequst = {
        <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">size</span>: <span class="hljs-number">100</span>,
        ...request,
        ...otherRequest
    }
    <span class="hljs-keyword">const</span> [err, res] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(
      (<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchDataApi</span>(newRequst);
      })()
    );
    <span class="hljs-keyword">if</span> (!(err || !res)) {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">transformOptions</span>(res);
      <span class="hljs-title function_">setData</span>(data);
      <span class="hljs-keyword">if</span> (!isMount.<span class="hljs-property">current</span>) {
        originData.<span class="hljs-property">current</span> = data;
        isMount.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      }
    }
  };

  <span class="hljs-keyword">const</span> onSearch = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">trim</span>()) {
      <span class="hljs-title function_">fetchData</span>({
        [searchParamKey]: value,
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setData</span>(originData.<span class="hljs-property">current</span>);
    }
  }, <span class="hljs-number">500</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (refreshFetch) {
      <span class="hljs-title function_">fetchData</span>();
    }
  }, [refreshFetch]);

  <span class="hljs-title function_">useMount</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (initFetch) {
      <span class="hljs-title function_">fetchData</span>();
    }
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setExtarData</span> = (<span class="hljs-params">list: IOption[]</span>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newData</span>: <span class="hljs-title class_">IOption</span>[] = [];
    <span class="hljs-keyword">const</span> idSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> data) {
      newData.<span class="hljs-title function_">push</span>(item);
      idSet.<span class="hljs-title function_">add</span>(item.<span class="hljs-property">value</span>);
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> list) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> item !== <span class="hljs-string">"object"</span>) {
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">if</span> (idSet.<span class="hljs-title function_">has</span>(item?.<span class="hljs-property">value</span>)) {
        <span class="hljs-keyword">continue</span>;
      }
      idSet.<span class="hljs-title function_">add</span>(item.<span class="hljs-property">value</span>);
      newData.<span class="hljs-title function_">push</span>(item);
    }
    <span class="hljs-title function_">setData</span>(newData);
  };

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">options</span>: data,
    onSearch,
    <span class="hljs-attr">onFocus</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(),
    ...(needSetExtarData ? { setExtarData } : {}),
  };
};

</code></pre>
<h3 data-id="heading-3">类型定义</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SelectProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IOption</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUseMountFetchDataNewProps</span> {
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 接口Api */</span>
  <span class="hljs-attr">fetchDataApi</span>: <span class="hljs-function">(<span class="hljs-params">...arg: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">IApiData</span>&gt;;
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 初始化时接口额外参数 */</span>
  request?: <span class="hljs-title class_">TRecord</span> &amp; { enableFlag?: <span class="hljs-built_in">boolean</span>; dataScopeEnableFlag?: <span class="hljs-built_in">boolean</span> };
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 搜索时的key */</span>
  <span class="hljs-attr">searchParamKey</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**<span class="hljs-doctag">@function</span> 转换数据源为options */</span>
  <span class="hljs-attr">transformOptions</span>: <span class="hljs-function">(<span class="hljs-params">res: IApiData</span>) =&gt;</span> <span class="hljs-title class_">IOption</span>[];
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 满足某种条件时加载数据，使用时请将 initFetch 设置为 false  */</span>
  refreshFetch?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/**<span class="hljs-doctag">@param</span> 是否挂载时默认加载数据 */</span>
  initFetch?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 是否需要setExtarData */</span>
  needSetExtarData?: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUseMountFetchDataResult</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SelectProps</span> {
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 下拉框选项 */</span>
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">IOption</span>[];
  <span class="hljs-comment">/** <span class="hljs-doctag">@function</span> 下拉框搜索 */</span>
  <span class="hljs-attr">onSearch</span>: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@function</span> 手动添加额外的数据源 */</span>
  setExtarData?: <span class="hljs-function">(<span class="hljs-params">list: IOption[]</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}
</code></pre>
<h2 data-id="heading-4">使用</h2>
<pre><code class="hljs language-tsx" lang="tsx">
<span class="hljs-comment">/** <span class="hljs-doctag">@function</span> 获取字典值集合 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sys_dict_value</span> = (<span class="hljs-params">params?: IReqSysDictValueDictValue</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Service</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/api/business/v1/sys-dict-value/dict-value"</span>, {
    params,
  }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">IResDetail</span>&lt;<span class="hljs-title class_">IResSysDictValueDictValue</span>[]&gt;&gt;;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IReqSysDictValueDictValue</span> {
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典编码 */</span>
  dictCode?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典编码集合 */</span>
  dictCodeList?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典名称 */</span>
  dictName?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 字典值 */</span>
  dictValue?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 备注 */</span>
  memo?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IResSysDictValueDictValue</span> {
  <span class="hljs-attr">dictCode</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dictName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dictValue</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">enableFlag</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">memo</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">color</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">sortNum</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">TXDiplomaRadio</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">TXDiplomaRadio_</span>(<span class="hljs-params">{
  initFetch = <span class="hljs-literal">true</span>,
  refreshFetch = <span class="hljs-literal">false</span>,
  extraReq = {},
  ...rest
}: ITXDiplomaRadioProps</span>) {
  <span class="hljs-keyword">const</span> { options } = <span class="hljs-title function_">useSearchSelectFetchNew</span>({
    <span class="hljs-attr">fetchDataApi</span>: sys_dict_value（你的接口，返回promise）,
    <span class="hljs-attr">request</span>: {
      <span class="hljs-attr">dictCode</span>: <span class="hljs-string">"diploma"</span>,
      ...extraReq,
    },
    initFetch,
    refreshFetch,
    <span class="hljs-attr">searchParamKey</span>: <span class="hljs-string">"dictName"</span>,
    <span class="hljs-attr">transformOptions</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> res?.<span class="hljs-property">data</span>?.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">x: IResSysDictValueDictValue</span>) =&gt;</span> ({
        <span class="hljs-attr">label</span>: x.<span class="hljs-property">dictName</span>,
        <span class="hljs-attr">value</span>: x.<span class="hljs-property">dictValue</span>,
      }));
    },
  });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Radio.Group</span> <span class="hljs-attr">options</span>=<span class="hljs-string">{options}</span> {<span class="hljs-attr">...rest</span>} /&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TXDiplomaRadio</span>;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Java Stream，将集合转换为一对一Map]]></title>    <link>https://juejin.cn/post/7587684397531021339</link>    <guid>https://juejin.cn/post/7587684397531021339</guid>    <pubDate>2025-12-26T03:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587684397531021339" data-draft-id="7587715742051139594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Java Stream，将集合转换为一对一Map"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-26T03:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申城异乡人"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056985831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Java Stream，将集合转换为一对一Map
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056985831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申城异乡人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:26:34.000Z" title="Fri Dec 26 2025 03:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的开发工作中，我们经常使用到Java Stream，特别是Stream API中提供的<code>Collectors.toList()</code>收集器，</p>
<p>但有些场景下，我们需要将集合转换为Map，这时候就需要使用到Stream API中提供的另一个收集器：</p>
<p><code>Collectors.toMap</code>，它可以将流中的元素映射为键值对，并收集到一个Map中。</p>
<h2 data-id="heading-0">1. 三种主要的重载方法</h2>
<p><code>Collectors.toMap</code>有3种重载方法，分别是：</p>
<p>1)<strong>两个参数的重载方法（最简单的形式）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                                Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper) {
	<span class="hljs-keyword">return</span> toMap(keyMapper, valueMapper, throwingMerger(), HashMap::<span class="hljs-keyword">new</span>);
}
</code></pre>
<p>2)<strong>三个参数的重载方法（包含冲突处理）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                                Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper,
                                BinaryOperator&lt;U&gt; mergeFunction) {
    <span class="hljs-keyword">return</span> toMap(keyMapper, valueMapper, mergeFunction, HashMap::<span class="hljs-keyword">new</span>);
}
</code></pre>
<p>3)<strong>四个参数的重载方法（指定Map实现）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U, M <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Map</span>&lt;K, U&gt;&gt;
   Collector&lt;T, ?, M&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                            Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper,
                            BinaryOperator&lt;U&gt; mergeFunction,
                            Supplier&lt;M&gt; mapSupplier) {
    BiConsumer&lt;M, T&gt; accumulator
            = (map, element) -&gt; map.merge(keyMapper.apply(element),
                                          valueMapper.apply(element), mergeFunction);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CollectorImpl</span>&lt;&gt;(mapSupplier, accumulator, mapMerger(mergeFunction), CH_ID);
}
</code></pre>
<p>接下来，我们结合使用示例详细讲解。</p>
<h2 data-id="heading-1">2. 使用示例</h2>
<h3 data-id="heading-2">2.1 将对象的某些属性转换为Map</h3>
<p>假设有一个城市列表，需要将其转换为Map，其中Key为城市ID、Value为城市名称，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">City</span> {
    <span class="hljs-keyword">private</span> Integer cityId;

    <span class="hljs-keyword">private</span> String cityName;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">City</span><span class="hljs-params">(Integer cityId, String cityName)</span> {
        <span class="hljs-built_in">this</span>.cityId = cityId;
        <span class="hljs-built_in">this</span>.cityName = cityName;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{1=北京, 2=上海, 3=广州, 4=深圳}</p>
</blockquote>
<h3 data-id="heading-3">2.2 将对象列表转换为Map（ID -&gt; 对象）</h3>
<p>仍然使用上面的城市列表，需要将其转换为Map，其中Key为城市ID、Value为城市对象，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>)
);
Map&lt;Integer, City&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, city -&gt; city));
<span class="hljs-type">City</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> cityMap.get(<span class="hljs-number">1</span>);
System.out.println(<span class="hljs-string">"城市ID: "</span> + city.getCityId());
System.out.println(<span class="hljs-string">"城市名称: "</span> + city.getCityName());
</code></pre>
<p>输出结果如下所示：</p>
<blockquote>
<p>城市ID: 1
城市名称: 北京</p>
</blockquote>
<p>上面的写法等价于：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, City&gt; cityMap = cityList.stream()
    	.collect(Collectors.toMap(City::getCityId, Function.identity()));
</code></pre>
<p>因为<code>Function.identity()</code>内部实现是下面这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> &lt;T&gt; Function&lt;T, T&gt; <span class="hljs-title function_">identity</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> t -&gt; t;
}
</code></pre>
<h3 data-id="heading-4">2.3 键冲突处理</h3>
<p>假设上面的城市列表中有一个ID重复的城市：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"天津"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(<span class="hljs-string">"城市ID: 4, 城市名称: "</span> + cityMap.get(<span class="hljs-number">4</span>));
</code></pre>
<p>此时运行代码，会抛出<code>java.lang.IllegalStateException</code>异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad5bff41cf40443994c502a37403892c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=HucqYoD9JvlfNzJv%2FQ7VkGxLxRY%3D" alt="" loading="lazy"/></p>
<p>有3种常见的键冲突处理方式，分别是保留旧值、使用新值和合并值，接下来一一讲解。</p>
<p>1)方式一：保留旧值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, (oldValue, newValue) -&gt; oldValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 深圳</p>
</blockquote>
<p>2)方式二：使用新值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, (oldValue, newValue) -&gt; newValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 天津</p>
</blockquote>
<p>3)方式三：合并值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, 
        		(oldValue, newValue) -&gt; oldValue + <span class="hljs-string">", "</span> + newValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 深圳, 天津</p>
</blockquote>
<h3 data-id="heading-5">2.4 数据分组聚合</h3>
<p>假设有一个销售记录列表，需要将其转换为Map，其中Key为销售员、Value为该销售员的总销售额，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesRecord</span> {
    <span class="hljs-keyword">private</span> String salesPerson;

    <span class="hljs-keyword">private</span> BigDecimal amount;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SalesRecord</span><span class="hljs-params">(String salesPerson, BigDecimal amount)</span> {
        <span class="hljs-built_in">this</span>.salesPerson = salesPerson;
        <span class="hljs-built_in">this</span>.amount = amount;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java">List&lt;SalesRecord&gt; salesRecordList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>)),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"2000"</span>)),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"980"</span>))
);

Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::add));
System.out.println(salesRecordMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=1980}</p>
</blockquote>
<p>上面的例子是销售额累加，也可以只取最小值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::min));
</code></pre>
<p>此时的输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=980}</p>
</blockquote>
<p>或者只取最大值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::max));
</code></pre>
<p>此时的输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=1000}</p>
</blockquote>
<h3 data-id="heading-6">2.5 指定Map实现</h3>
<p>默认情况下，<code>Collectors.toMap</code>是将结果收集到HashMap中，如果有需要，我们也可以指定成TreeMap或者LinkedHashMap。</p>
<p>如果想要保持插入顺序，可以指定使用LinkedHashMap：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName,
                (existing, replacement) -&gt; existing, LinkedHashMap::<span class="hljs-keyword">new</span>));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{2=上海, 1=北京, 4=深圳, 3=广州}</p>
</blockquote>
<p>如果想要按键排序，可以指定使用TreeMap：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName,
                (existing, replacement) -&gt; existing, TreeMap::<span class="hljs-keyword">new</span>));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{1=北京, 2=上海, 3=广州, 4=深圳}</p>
</blockquote>
<h2 data-id="heading-7">3. 注意事项</h2>
<h3 data-id="heading-8">3.1 空异常</h3>
<p>如果valueMapper中取出的值有null值，会抛出<code>java.lang.NullPointerException</code>异常，如下示例：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">5</span>, <span class="hljs-literal">null</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>运行以上代码会抛出异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d288447108164d26985edd91c27e430a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=lP0nkReM4pnGZp6WqyEI2Kyufs0%3D" alt="" loading="lazy"/></p>
<p>有两种解决方案，第一种解决方案是过滤null值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .filter(city -&gt; city.getCityName() != <span class="hljs-literal">null</span>)
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
</code></pre>
<p>第二种解决方案是提供默认值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId,
                city -&gt; Optional.ofNullable(city.getCityName()).orElse(<span class="hljs-string">"未知"</span>)));
</code></pre>
<h3 data-id="heading-9">3.2 键重复异常</h3>
<p>如果出现重复键，且没有提供mergeFunction参数，会抛出<code>java.lang.IllegalStateException</code>异常，如下示例：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"天津"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>运行以上代码会抛出异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f904404b9744e8a1379f64a65540fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=ZFH7K4V%2BTqNshyn32SOOiRBYDUc%3D" alt="" loading="lazy"/></p>
<p>解决方案见本篇文章<strong>2.3 键冲突处理</strong>部分。</p>
<h2 data-id="heading-10">4. 总结</h2>
<p><code>Collectors.toMap</code>是Stream API中提供的一个非常方便的收集器，它可以将流中的元素映射为键值对，并收集到一个Map中。</p>
<p>它适用于一对一映射的场景，但在使用时，要注意避免<code>java.lang.NullPointerException</code>异常和</p>
<p><code>java.lang.IllegalStateException</code>异常。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【日常知识积累】Kotlin let 函数、inline 函数以及 DSL]]></title>    <link>https://juejin.cn/post/7588146449005101092</link>    <guid>https://juejin.cn/post/7588146449005101092</guid>    <pubDate>2025-12-27T08:08:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005101092" data-draft-id="7587630413012680714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【日常知识积累】Kotlin let 函数、inline 函数以及 DSL"/> <meta itemprop="keywords" content="Kotlin,编程语言,Android"/> <meta itemprop="datePublished" content="2025-12-27T08:08:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lei_official"/> <meta itemprop="url" content="https://juejin.cn/user/2351234021066314"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【日常知识积累】Kotlin let 函数、inline 函数以及 DSL
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2351234021066314/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lei_official
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:08:30.000Z" title="Sat Dec 27 2025 08:08:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>凡事有交代 —— 接到任务时，主动明确任务目标、背景、利益相关方、交付物、时间节点。<br/>件件有着落 —— 执行任务过程中，在里程碑节点及时同步，做好预期管理。<br/>事事有回音 —— 任务完成后，有复盘，有汇报，有总结。</p>
</blockquote>
<p>这篇文章记录了近期积累的一些零散知识点，临近元旦、春节，这个时期是一年里工作相对轻松的阶段，同时也是复盘总结过去一年的经验、以及做好明年目标规划的关键节点。<strong>利用好，别虚度</strong>。</p>
<h2 data-id="heading-0">你真的需要使用 let 函数吗？</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d392b67f326648ed9a651e8b1f2addc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427710&amp;x-signature=KRUvnLcCqA%2F33q2JkVaq1FnNvrE%3D" alt="image.png" width="50%" loading="lazy"/>
<p>在 Kotlin 中，<code>let</code>、<code>apply</code>、<code>also</code>、<code>run</code> 等等函数，是降低代码行数、提升可读性的利器，然而它们并不是万能的，如果使用不当，会带来相反的效果。</p>
<h3 data-id="heading-1">let 的一般用法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果元素非空，则对其进行绘制</span>
element?.let { render(it) }

<span class="hljs-comment">// 非 let 写法</span>
<span class="hljs-keyword">if</span> (element != <span class="hljs-literal">null</span>) {
	render(element)
}
</code></pre>
<p>可以看到，<code>let</code> 函数将3行代码精简成为1行，精简了 66% 的代码。它适用于以下场景：</p>
<ul>
<li>单次调用该对象</li>
<li>lambda 行数很少</li>
<li>没有后续依赖</li>
</ul>
<p>与之相反的条件，就是不适用于 let 的场景。</p>
<h3 data-id="heading-2">let 不适用的场景</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 灾难现场1：行数多、有后续依赖</span>
element?.let { e -&gt;
    config?.let { c -&gt;
        adapter?.let { a -&gt;
            renderer?.let { r -&gt;
                r.render(e, c, a)
            }
        }
    }
}

<span class="hljs-comment">// 灾难现场2：超过1行使用 let 对象</span>
element?.let {
    doSomething(it)
    doAnotherThing(it)
    doMore(it)
}
</code></pre>
<p>以上已经是 Kotlin 的反模式了，这样的代码不断<code>向右偏移（rightward drift）</code>，<strong>难读并且难改</strong>，在进行 Code Review 时一定要识别出来。</p>
<h3 data-id="heading-3">替代方案 return fast</h3>
<p>在函数的开头，检查变量条件，如果不符合立刻 return，可以在需要的位置增加日志打印，以便追溯问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateView</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> e = element ?: <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">val</span> c = config ?: <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">val</span> a = adapter ?: <span class="hljs-keyword">return</span>

    render(e, c, a)
}
</code></pre>
<p><strong>为什么这是好代码？</strong></p>
<ul>
<li>没有嵌套</li>
<li>控制流清晰</li>
<li>可调试（每一行都能打断点）</li>
<li>非常符合 “fail fast” 原则</li>
</ul>
<p>更进一步，如果 e、c、a 这三个对象经常一起判空，可以将它们本质上是一个状态，推荐对它们进行状态聚合，有利于长期使用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 状态聚合</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RenderState</span>(
    <span class="hljs-keyword">val</span> element: Element,
    <span class="hljs-keyword">val</span> config: Config,
    <span class="hljs-keyword">val</span> adapter: Adapter
)

<span class="hljs-comment">// 只有一个变量</span>
<span class="hljs-keyword">val</span> state: RenderState? = ...

<span class="hljs-comment">// 使用时判断该变量</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateView</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> s = state ?: <span class="hljs-keyword">return</span>
    render(s)
}
</code></pre>
<p>此外，如果发现，代码里多处进行判空操作，则可以利用 DSL，将判空操作提取出 <code>withReadyElement</code> 函数，</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 提取 inline 函数，集中进行可空性处理</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">withReadyElement</span><span class="hljs-params">(block: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> e = element ?: <span class="hljs-keyword">return</span>
    block(e)
}

<span class="hljs-comment">// 调用点更加美观干净</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateView</span><span class="hljs-params">()</span></span> {
    withReadyElement {
        render(it)
    }
}
</code></pre>
<h2 data-id="heading-4">inline fun 用于消除 Lambda 对象额外开销</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a21849cdca94449b6a88f2f36420c77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427710&amp;x-signature=knoT7IVA8H0X%2BSNR%2BClpTdCKsCo%3D" alt="image.png" width="70%" loading="lazy"/>
<p><code>inline fun</code> 是“为 Lambda 买单的工具”，<strong>用于消除 Lambda 参数引起的对象创建&amp;间接调用开销</strong>，同样地，它也不是“银弹”，如果使用不当，反而会引起性能下降。</p>
<h3 data-id="heading-5">普通 Lambda 函数与 inline Lambda 函数</h3>
<p><strong>普通 Lambda 函数</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    block()
}
</code></pre>
<p>系统在编译这段代码时，实际上发生了：</p>
<ul>
<li>创建一个 <code>Function0</code> 对象（表示0个参数、即无参函数）</li>
<li>捕获外部变量，生成闭包</li>
<li>通过 <code>invoke()</code> 间接调用</li>
</ul>
<p>例如，我们调用 <code>doSomething { println("hello") }</code> 后，编译器实际上创建了一个类，并调用其 <code>invoke</code> 函数。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DoSomething$1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Function0</span>&lt;Unit&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Unit <span class="hljs-title function_">invoke</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"hello"</span>)
        <span class="hljs-keyword">return</span> Unit.INSTANCE;
    }
}
</code></pre>
<p><strong>inline Lambda 函数</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    block()
}

<span class="hljs-comment">// 编译后直接展开</span>
println(<span class="hljs-string">"hello"</span>)
</code></pre>
<h3 data-id="heading-6">标准库的 inline 用法</h3>
<p>在 Kotlin 标准库里，这些函数都是 inline 实现</p>
<ul>
<li><code>let</code></li>
<li><code>apply</code></li>
<li><code>run</code></li>
<li><code>with</code></li>
<li><code>use</code></li>
<li><code>synchronized</code></li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T
</code></pre>
<h3 data-id="heading-7">inline 的负面作用</h3>
<p>由于 inline 本质上采用了 <code>复制-粘贴</code> 的模式，因此它会在每个调用点复制一份函数代码，这会造成 <code>APK / DEX 膨胀</code>，对 Android 来说，更会引起 <strong>方法数增加，甚至突破 64K 限制</strong>。</p>
<h3 data-id="heading-8">inline 的应用场景</h3>
<ul>
<li>参数是 <code>lambda</code> 类型</li>
<li><code>lambda</code> 非常短</li>
<li>该函数 90% 以上是 lambda 调用</li>
<li>应用在循环 / UI / 热路径中</li>
<li>inline 收益 &gt; 代码膨胀成本</li>
</ul>
<h2 data-id="heading-9">DSL，把握好“提升可读性”与“滥用”之间的界限</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f6f805ff7004862a181894f89e18a2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427710&amp;x-signature=s7yDmw0ziEFA4oiyoqcuzxdSf%2Fc%3D" alt="image.png" loading="lazy"/></p>
<p><code>DSL（Domain-Specific Language，领域特定语言）</code>，是一种 <strong>只为某个特定领域服务</strong> 的语言，目标不是“什么都能干”，而是把这个领域的表达做到最清晰、最省心、最不容易写错。</p>
<p>如何理解“领域”呢？在我看来，“领域”是指特定的场景、语境、上下文，它具有一定的重复性，因此通过提炼总结 DSL，能够降低重复使用的成本。“领域”可以是技术上的，也可以是业务场景里的。</p>
<h3 data-id="heading-10">GPL 与 DSL</h3>
<p>与 DSL 相对的概念，是 <strong>通用语言（GPL）</strong>，Java / Kotlin / C++ 都属于此类，它们功能强大且全面，但随之而来的，是写法严谨甚至冗长，无法做到针对特定场景（领域）进行简化。</p>
<p>DSL 则专注于解决一个特定领域的问题，为此进行了特定优化，短、平、快、准。</p>
<p>GPL、DSL 都可以解决问题，重点在于选择使用哪一个。</p>
<h3 data-id="heading-11">DSL 的两大类型：外部 DSL</h3>
<p>外部 DSL 具备 <strong>独立的语法和解析器</strong> ，更像一门新的编程语言，因此其表达能力很强。同时，由于依赖于特定解析器，故定制成本高。</p>
<p>常见的外部 DSL 有：</p>
<ul>
<li>SQL</li>
<li>正则表达式</li>
<li>Gradle Groovy/Kotlin DSL（build.gradle）</li>
<li>HTML / CSS</li>
</ul>
<h3 data-id="heading-12">DSL 的两大类型：内部 DSL</h3>
<p>内部 DSL 在 Kotlin 语言中是非常常见的，例如前文的 <code>let</code>、<code>apply</code>、<code>also</code> 等均属于此类。可以通过 Kotlin 语法特性，使代码“看起来像新的语言”。Kotlin 的标准库中，有很多 API 本身就是 DSL。举两个常见的例子：</p>
<p><strong>例1，Lambda with Receiver</strong></p>
<p>定义 <code>user</code> DSL，代替 <code>set</code> 函数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 Lambda，域内对象为 User</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">user</span><span class="hljs-params">(block: <span class="hljs-type">User</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> u = User()
    u.block()
}

<span class="hljs-comment">// 使用 DSL</span>
user {
	name = <span class="hljs-string">"Lei"</span>
}

<span class="hljs-comment">// 不使用 DSL</span>
user.setName(<span class="hljs-string">"Lei"</span>)
</code></pre>
<p><strong>例2， infix 函数</strong></p>
<p>可以提升可读性，例如定义二元运算符 <code>eq</code>，比较 String 对象：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 声明 DSL</span>
<span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">eq</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span>

<span class="hljs-comment">// 使用 DSL</span>
<span class="hljs-string">"status"</span> eq <span class="hljs-string">"success"</span>
</code></pre>
<blockquote>
<p>Gradle Kotlin、Jetpack Compose、HTML 都是典型的 DSL，UI结构=代码结构，起到“看代码知UI”的作用。</p>
</blockquote>
<h3 data-id="heading-13">DSL 不是炫技工具，而是把业务规则提取为代码的手段</h3>













<table><thead><tr><th>值得设计 DSL</th><th>不该用DSL</th></tr></thead><tbody><tr><td>✅是不是反复写相同结构？<br/>✅业务规则是否固定？<br/>✅现在的代码是否“看不出业务语义”？<br/>✅错误是不是经常发生在“用法不对”？</td><td>❌一次性逻辑<br/>❌需求不稳定<br/>❌团队 Kotlin 水平参差<br/>❌DSL 设计者不在一线维护</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[shadcn-ui 的 Radix Dialog 这两个警告到底在说什么？为什么会报？怎么修？]]></title>    <link>https://juejin.cn/post/7587998744294047750</link>    <guid>https://juejin.cn/post/7587998744294047750</guid>    <pubDate>2025-12-26T08:44:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294047750" data-draft-id="7587825267879182377" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="shadcn-ui 的 Radix Dialog 这两个警告到底在说什么？为什么会报？怎么修？"/> <meta itemprop="keywords" content="前端,WeUI,React.js"/> <meta itemprop="datePublished" content="2025-12-26T08:44:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            shadcn-ui 的 Radix Dialog 这两个警告到底在说什么？为什么会报？怎么修？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T08:44:52.000Z" title="Fri Dec 26 2025 08:44:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题</h2>
<p>最近在项目里遇到两个来自 Radix Dialog 的控制台提示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e5a30b959ff477987d91cbb78c449e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5aSc5a-75pm05aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767343491&amp;x-signature=d1n2YG8uQeurasELGsmVhqqQi6k%3D" alt="image.png" loading="lazy"/></p>
<p>它们不是 “功能错误”，但属于 <strong>无障碍（a11y）级别的警告</strong>：Radix 在开发环境主动提醒你对话框缺少 “可被屏幕阅读器正确理解” 的关键语义。</p>
<p>本文基于 coco-app（React 18 + TS + Tailwind + shadcn-ui）里真实踩坑的修复过程总结。</p>
<hr/>
<h2 data-id="heading-1">1. 背景：Radix Dialog 需要什么语义？</h2>
<p>一个可访问的 Dialog 至少需要：</p>
<ul>
<li><strong>可访问名称（accessible name）</strong>：告诉读屏软件 “这个弹窗叫啥”
<ul>
<li>对应：<code>&lt;DialogTitle /&gt;</code>（内部映射到 <code>aria-labelledby</code>）</li>
</ul>
</li>
<li><strong>可访问描述（accessible description）</strong>：告诉读屏软件 “这个弹窗在说啥/要用户做啥”
<ul>
<li>对应：<code>&lt;DialogDescription /&gt;</code>（内部映射到 <code>aria-describedby</code>）</li>
</ul>
</li>
</ul>
<p>Radix 的示例结构也是这个顺序（Title + Description + 内容 + Close 等）。</p>
<hr/>
<h2 data-id="heading-2">2. 报错 1：为什么必须要 <code>DialogTitle</code>？</h2>
<h3 data-id="heading-3">2.1 报错含义</h3>
<blockquote>
<p><code>DialogContent requires a DialogTitle...</code></p>
</blockquote>
<p>意思是：你的 <code>&lt;DialogContent /&gt;</code> 里没有提供标题，导致 Dialog 没有可访问名称。读屏用户打开弹窗时，不知道这是 “更新提示” 还是 “删除确认”。</p>
<h3 data-id="heading-4">2.2 coco-app 的修复方式</h3>
<p>我们在 <code>UpdateApp</code> 弹窗中增加了一个 “对视觉隐藏、对读屏可见” 的标题：</p>
<ul>
<li>文件：<code>src/components/UpdateApp/index.tsx:164</code></li>
<li>代码形态：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogTitle</span> className=<span class="hljs-string">"sr-only"</span>&gt;{<span class="hljs-title function_">t</span>(<span class="hljs-string">"update.title"</span>)}&lt;/<span class="hljs-title class_">DialogTitle</span>&gt;
</code></pre>
<p>为什么用 <code>sr-only</code>？</p>
<ul>
<li>Tailwind 的 <code>sr-only</code> 能达到<strong>UI 不变，读屏可读</strong>的效果（有些 shadcn 模板会有现成的 <code>VisuallyHidden</code> 组件）。</li>
</ul>
<hr/>
<h2 data-id="heading-5">3. 报错 2：为什么必须要 <code>DialogDescription</code> / <code>aria-describedby</code>？</h2>
<h3 data-id="heading-6">3.1 报错含义</h3>
<blockquote>
<p><code>Warning: Missing Description or aria-describedby={undefined} for {DialogContent}.</code></p>
</blockquote>
<p>意思是：Dialog 没有可访问描述，或者你显式把 <code>aria-describedby</code> 置为 <code>undefined</code> 但又没有描述节点关联上。</p>
<p>Radix 的逻辑大致是：</p>
<ul>
<li>你提供 <code>&lt;DialogDescription /&gt;</code>：Radix 自动把它的 id 绑定到 <code>aria-describedby</code></li>
<li>你不提供 <code>&lt;DialogDescription /&gt;</code>：Radix 会提醒你 “缺描述”，避免读屏用户只听到标题但不知道要做什么</li>
</ul>
<h3 data-id="heading-7">3.2 coco-app 的修复方式</h3>
<p>我们把原先展示更新说明的 <code>div</code> 替换为 <code>DialogDescription</code>（UI class 不变，只换组件语义）：</p>
<ul>
<li>文件：<code>src/components/UpdateApp/index.tsx:179-193</code></li>
<li>代码形态：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogDescription</span> className=<span class="hljs-string">"text-sm leading-5 py-2 text-foreground text-center"</span>&gt;
  {updateInfo ? ... : <span class="hljs-title function_">t</span>(<span class="hljs-string">"update.date"</span>)}
&lt;/<span class="hljs-title class_">DialogDescription</span>&gt;
</code></pre>
<p>这样 Radix 就能自动生成正确的 <code>aria-describedby</code>，warning 消失。</p>
<hr/>
<h2 data-id="heading-8">4. “洁癖”：它不是 bug，但是就是在控制台报红了...</h2>
<p>shadcn-ui 的 <code>Dialog</code> 本质是对 Radix Dialog 的一层轻封装（项目里对应 <code>src/components/ui/dialog.tsx</code>），它不会强制你必须写 Title/Description。</p>
<h3 data-id="heading-9">4.1 为什么更容易踩坑？</h3>
<p>因为 UI 上你可能觉得：</p>
<ul>
<li>我已经有图标（logo）</li>
<li>我已经有一段说明文字（div/p）</li>
<li>我不想显示标题</li>
</ul>
<p>但 <strong>视觉上满足 ≠ 语义上满足</strong>。读屏依赖的是 <code>aria-labelledby/aria-describedby</code> 的关联，而不是你页面里有没有一个看起来像标题的 <code>div</code>。</p>
<hr/>
<h2 data-id="heading-10">5. 最推荐的写法、更标准的写法</h2>
<h3 data-id="heading-11">5.1 标题不想显示：用 <code>sr-only</code></h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogTitle</span> className=<span class="hljs-string">"sr-only"</span>&gt;{<span class="hljs-title function_">t</span>(<span class="hljs-string">"xxx.title"</span>)}&lt;/<span class="hljs-title class_">DialogTitle</span>&gt;
</code></pre>
<h3 data-id="heading-12">5.2 描述存在：用 <code>DialogDescription</code></h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogDescription</span> className=<span class="hljs-string">"sr-only"</span>&gt;
  {<span class="hljs-title function_">t</span>(<span class="hljs-string">"xxx.description"</span>)}
&lt;/<span class="hljs-title class_">DialogDescription</span>&gt;
</code></pre>
<p>是否一定要隐藏 Description？</p>
<ul>
<li>不一定。像更新弹窗这种 “正文就是描述”，直接用 <code>DialogDescription</code> 包住正文最自然。</li>
</ul>
<hr/>
<h2 data-id="heading-13">6. 也可以手动 <code>aria-describedby</code> 吗？可以，但更容易出错</h2>
<p>你当然可以自己写：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">DialogContent</span> aria-describedby=<span class="hljs-string">"my-desc"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"my-desc"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">DialogContent</span>&gt;
</code></pre>
<p>但坑在于：</p>
<ul>
<li>id 可能忘了写 / 重复</li>
<li>条件渲染导致节点不在 DOM（aria 指向不存在的 id）</li>
<li>重构时删掉了 <code>id</code> 没发现</li>
<li>多弹窗复用组件时 id 冲突</li>
</ul>
<p>所以在 shadcn/Radix 体系里，优先使用 <code>DialogTitle</code> / <code>DialogDescription</code> 让 Radix 负责关联更稳。</p>
<hr/>
<h2 data-id="heading-14">7. 真正的“坑点清单”（建议以后 review 的时候对照）</h2>
<ul>
<li>只写了 <code>&lt;DialogContent /&gt;</code>，把标题/正文都塞进普通 <code>div</code></li>
<li>标题用视觉元素表达（比如 logo 或大号文本），但没用 <code>DialogTitle</code></li>
<li>描述是条件渲染的，导致有时没有 <code>DialogDescription</code></li>
<li>想隐藏标题却直接不写（应该隐藏而不是删除）</li>
</ul>
<hr/>
<h2 data-id="heading-15">8. coco-app 里的落地实践（最终结论）</h2>
<p>在 coco-app 里，我们最终遵循了一个简单规则：</p>
<ul>
<li>每个 <code>DialogContent</code> 内部都应该有且只有一个语义标题：<code>DialogTitle</code></li>
<li>只要弹窗有 “说明性文本”，优先用 <code>DialogDescription</code> 承载</li>
<li>如果 UI 不需要展示标题/描述：用 <code>sr-only</code> 隐藏（而不是不写）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 React 里优雅地 “隐藏 iframe 滚动条”]]></title>    <link>https://juejin.cn/post/7587961565477224502</link>    <guid>https://juejin.cn/post/7587961565477224502</guid>    <pubDate>2025-12-26T09:27:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565477224502" data-draft-id="7587998744294146054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 React 里优雅地 “隐藏 iframe 滚动条”"/> <meta itemprop="keywords" content="前端,React.js,CSS"/> <meta itemprop="datePublished" content="2025-12-26T09:27:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 React 里优雅地 “隐藏 iframe 滚动条”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T09:27:30.000Z" title="Fri Dec 26 2025 09:27:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端有一个经典问题：</p>
<blockquote>
<p>你在宿主页面怎么写 CSS，都<strong>管不到 iframe 内部</strong>的滚动条。</p>
</blockquote>
<p>所以正确的前端方案不是 “给外层容器加 overflow”，而是：<strong>尽量在 iframe 自己层面兜底 + 同源时向 iframe 内注入 CSS</strong>。</p>
<p>本文只聚焦前端实现，不展开前后端传参链路。</p>
<hr/>
<h2 data-id="heading-0">1. 为什么你明明设置了，滚动条还是在？</h2>
<p>因为滚动条来自 <strong>iframe 内部 document</strong>：</p>
<ul>
<li>外层 <code>div</code> 的 <code>overflow-hidden</code> 只能裁剪 “iframe 这个盒子” 是否溢出</li>
<li>iframe 里面的页面是否出现滚动条，取决于 iframe 内部的 <code>html/body</code> 或某个容器的 <code>overflow</code></li>
<li>宿主页面的 CSS 不会跨 document 生效（iframe 天生隔离）</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 我们最终用了 “两层方案”，解决现实世界的不确定性</h2>
<p>实现集中在 <code>src/components/Search/ViewExtensionIframe.tsx:1-88</code>。</p>
<h3 data-id="heading-2">2.1 第一层：<code>scrolling="no"</code> 作为低成本兜底</h3>
<pre><code class="hljs language-tsx" lang="tsx">&lt;iframe scrolling={hideScrollbar ? <span class="hljs-string">"no"</span> : <span class="hljs-string">"auto"</span>} /&gt;
</code></pre>
<p>它不是现代标准，但在某些 WebView/嵌入环境里仍能减少滚动条出现的概率。</p>
<p>它的价值在于：<strong>不依赖同源</strong>，哪怕你进不去 iframe，也能 “碰一碰运气”。</p>
<h3 data-id="heading-3">2.2 第二层（主力）：同源时注入一段隐藏滚动条的 CSS</h3>
<p>核心是这段逻辑（同文件 <code>applyHideScrollbarToIframe</code>）：</p>
<ul>
<li><code>src/components/Search/ViewExtensionIframe.tsx:5-39</code></li>
</ul>
<p>做法很直接：</p>
<ol>
<li>拿到 <code>iframe.contentDocument</code></li>
<li>往里面塞一个带固定 <code>id</code> 的 <code>&lt;style&gt;</code></li>
<li>开关关闭时把这个 <code>&lt;style&gt;</code> 删掉</li>
</ol>
<p>注入的 CSS 同时覆盖主流引擎：</p>
<pre><code class="hljs language-css" lang="css">* {
  <span class="hljs-attribute">scrollbar-width</span>: none;      <span class="hljs-comment">/* Firefox */</span>
  -ms-<span class="hljs-attribute">overflow</span>-style: none;   <span class="hljs-comment">/* 老 IE/Edge 风格 */</span>
}
*::-webkit-scrollbar {        <span class="hljs-comment">/* Chrome/Safari */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0px</span>;
}
</code></pre>
<p>为什么用 <code>*</code>？</p>
<ul>
<li>扩展页面的滚动容器不一定是 <code>body</code>，可能是任意 <code>div overflow-auto</code></li>
<li>用 <code>*</code> 能最大概率“全场隐藏”，更通用</li>
</ul>
<p>为什么要固定 <code>id</code>？</p>
<ul>
<li>防止重复注入（多次 onLoad / 状态变化）</li>
<li>关闭时能精确移除，保证可逆</li>
</ul>
<hr/>
<h2 data-id="heading-4">3. 为什么要 “onLoad + useEffect” 双触发？</h2>
<p>这是最容易漏、也最影响体验的一点。</p>
<ul>
<li><code>useEffect</code>：响应 <code>hideScrollbar</code> 变化（开关切换时立刻生效）</li>
<li><code>onLoad</code>：保证“首次加载完成后一定注入成功”</li>
</ul>
<p>原因：iframe 的加载时序不可控。你在 React 渲染完时，iframe 可能还没 ready，<code>contentDocument</code> 为空；等到 onLoad 才能 100% 确认 document 存在。</p>
<p>对应代码：</p>
<ul>
<li><code>src/components/Search/ViewExtensionIframe.tsx:52-55</code></li>
<li><code>src/components/Search/ViewExtensionIframe.tsx:78-84</code></li>
</ul>
<hr/>
<h2 data-id="heading-5">4. 这个方案的边界与坑（提前写清楚，后面少掉头发）</h2>
<h3 data-id="heading-6">4.1 “隐藏滚动条” 不等于 “不能滚”</h3>
<p>我们只隐藏 scrollbar 的视觉表现，滚动行为仍存在（滚轮/触摸板/键盘都能滚）。<br/>
这在沉浸式页面很舒服，但在长页面里也可能让用户不知道 “还能滚”。</p>
<h3 data-id="heading-7">4.2 跨域 iframe：注入会失败，但不会炸</h3>
<p>如果 iframe 加载跨域页面，访问 <code>contentDocument</code> 会触发同源限制。当前实现用 <code>try/catch</code> 静默吞掉异常，结果是：</p>
<ul>
<li>CSS 注入失败</li>
<li>只剩 <code>scrolling="no"</code> 兜底，效果不保证</li>
</ul>
<p>这不是 bug，是浏览器安全模型决定的。</p>
<h3 data-id="heading-8">4.3 全局 <code>*</code> 的副作用</h3>
<p>它会把 iframe 内所有滚动条都干掉，包括某些组件内部滚动区域、代码块滚动等。<br/>
目前我们选择“通用性优先”，但如果未来某些扩展需要保留局部滚动条，就要改为更精确的选择器策略。</p>
<hr/>
<h2 data-id="heading-9">5. 一句话总结</h2>
<p>在前端想稳定控制 iframe 滚动条，最靠谱的思路是：</p>
<ul>
<li><strong>先用 iframe 自身属性做兜底</strong></li>
<li><strong>再在同源条件下对 iframe 内部 document 注入 CSS</strong></li>
<li><strong>用固定 style id 保证幂等与可逆</strong></li>
<li><strong>用 onLoad + effect 解决时序问题</strong></li>
</ul>
<p>这就是 <code>hideScrollbar</code> 在前端真正解决的问题：不是写没写 CSS，而是有没有把 CSS 写到“对的世界里”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么企业都需要职场心理学分析专家？]]></title>    <link>https://juejin.cn/post/7588004601393037346</link>    <guid>https://juejin.cn/post/7588004601393037346</guid>    <pubDate>2025-12-27T08:12:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601393037346" data-draft-id="7588004376867569699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么企业都需要职场心理学分析专家？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T08:12:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么企业都需要职场心理学分析专家？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:12:28.000Z" title="Sat Dec 27 2025 08:12:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么企业都需要职场心理学分析专家？</h2>
<p>在快节奏、高压力的现代职场环境中，员工的行为表现往往不仅仅是表面现象，背后隐藏着复杂的心理动因。这些动因如果得不到科学识别与有效干预，极易演变为沟通障碍、协作低效，甚至引发组织内部的士气危机。因此，越来越多的企业意识到，将心理学系统性地引入管理实践，不仅是一种“柔性管理”手段，更是一项能够提升组织效能与人才保留率的战略投资。</p>
<p>正是基于这一洞察，我利用 <strong>腾讯元器（YuanQi）</strong> 平台，构建了一款面向企业办公场景的实用型 AI 智能体——「职场心理学分析专家」。它聚焦于解决企业管理中三大高频痛点：<strong>看不懂员工行为、沟通效率低下、团队士气低迷</strong>，将心理学理论转化为可落地的管理工具。</p>
<blockquote>
<p><strong>✨ 目标：让心理学成为企业管理的“隐形杠杆”</strong></p>
</blockquote>
<h2 data-id="heading-1">🧠我用腾讯元器打造的心理学分析专家效果预览</h2>
<p>点击链接即刻体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FJoAncj%3Fappid%3D2004808954860119296%26experience%3Dtrue" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/JoAncj?appid=2004808954860119296&amp;experience=true" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d858aa818aa48f48b95c8b58f878534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=vEI2PIKDvXKuJ%2F640Grp9yhUbgQ%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>该智能体融合心理学与社会学理论，通过结构化分析框架，帮助 HR、管理者甚至普通员工，科学解析职场行为背后的深层原因，并提供可操作的管理建议。其目标不仅是“解释问题”，更是“推动改变”。</p>
<h3 data-id="heading-2">职场行为分析</h3>
<p>可以直接用预设的问题来体验，可以看到成功的回复了我们<code>员工频繁迟到的可能原因</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/864e52c98b564ba38489caa5aef043c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=QcNIOZowVu8%2F5ANbQyy7k0Xbc6E%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">职业发展</h3>
<p>当我们不知道职业发展的时候他可以用工作流来回复我们发展的方向。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7cbf9bd73e46c9acd4ceb1687b1751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=QGtj%2FX%2B71MIpxcxdi4Fs%2BIK5xL4%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">智能体能做什么？</h3>
<p>这款 Agent 聚焦三大核心能力：</p>
<p>✅ 职场行为分析：从迟到、沉默、过度加班等行为中挖掘潜在动机</p>
<p>✅ 微表情与非语言信号解读：辅助识别会议/谈判中的真实情绪状态</p>
<p>✅ 基于心理学与社会学理论的结构化输出：提供可操作的管理建议</p>
<p>无论你是 HR、团队管理者，还是普通职场人，都能借助它更科学地理解他人、优化沟通、营造健康职场生态。</p>
<h2 data-id="heading-5">相关介绍</h2>
<h3 data-id="heading-6">腾讯元器</h3>
<p>腾讯元器是腾讯推出的一站式 <strong>AI 智能体（Agent）开发与分发平台</strong>，旨在降低大模型应用的开发门槛，让企业、开发者甚至非技术人员都能快速构建、部署和运营专属智能体。平台深度集成腾讯混元大模型能力，并支持多种主流开源模型（如 DeepSeek、Llama 系列等），通过“提示词 + 知识库 + 工作流”的组合方式，赋予智能体垂直领域专业能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07e6bbfaaad645f9b3b819cdc63df776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=tOwum1IVti0bx35%2FQyS9W%2BEaXCI%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">系统逻辑架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89d87147c9bb4fbd9b36e0d1bb815798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=rRMvKh2oH7fs4eHPuyK6t4ZNqXA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">手把手教程（全网最详细教程）</h2>
<h3 data-id="heading-9">手把手教程总览</h3>
<p>整体流程可以拆成五步：</p>
<ol>
<li>打开腾讯元器并新建智能体</li>
<li>完成基础配置：模型、提示词、欢迎语、开场问题等</li>
<li>测试基础版职场心理学分析专家</li>
<li>搭建进阶工作流：待定</li>
<li>发布到各平台，作为长期可用的职场心理学分析专家 Agent</li>
</ol>
<h3 data-id="heading-10">1.打开腾讯元器</h3>
<p>点击网站直达地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2F" target="_blank" title="https://yuanqi.tencent.com/" ref="nofollow noopener noreferrer">yuanqi.tencent.com/</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/654c914a77864e748f1f9a89f676cf34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=WJIaWdLtAQ4pvmuN%2FyjGSg%2B8Tgc%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">2.新建职场心理学分析专家智能体</h3>
<p>在腾讯元器支持两种类型的智能体：</p>
<p><strong>公众号**</strong>智能体**：支持便捷拉取公众号文章构建知识库，一键发布到公众号后台，实现智能回复功能。</p>
<p><strong>对话式**</strong>智能体**：支持灵活构建通用知识库和工作流，可发布到多个渠道进行对话互动。</p>
<p>如果对<strong>公众号智能体</strong>感兴趣的可以看我的上一篇文章（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2600684" target="_blank" title="https://cloud.tencent.com/developer/article/2600684" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a>）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ef76bfa20d24c6fb2e7bd3ca753bf0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=LTc2wg4CfyQSWSesi2oycRAWckE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>输入智能体的基本信息，如：名称，简介，以及头像。</p>
<p>我的仅供参考：</p>
<blockquote>
<p>名称：职场心理学分析专家
简介：职场心理学分析专家专注于解析职场中个体行为背后的潜在心理动机，帮助理解员工和同事的行为模式。该Agent结合心理学与社会学理论，运用行为概括、动机分析和微表情识别等专业技能，深入剖析职场行为背后的多重心理因素。适用于HR、管理者及职场人士，用于提升团队管理、优化沟通和促进职场氛围健康。
头像：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/102d31bb220e4d81869c9ae1ed574992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=STVomSVTQaqOHCXJc73%2FIh%2B9Tlk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
</blockquote>
<p>如下图所示，点击新建即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b216f7b6c3314e30b1e80c3e9748e6bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=LRcGRzKSQxcISOcUzByxlts6LR8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-12">3.基础配置示例：=</h3>
<p>在右侧进行一些基础的配置，如模型设置，提示词，欢迎语，知识库等。</p>
<p>我这里的具体模型设置：DeepSeek-V3.2</p>
<p>提示词：</p>
<pre><code class="hljs language-md" lang="md">请扮演职场心理学分析专家，分析职场中人们行为背后的潜在心理动机。

<span class="hljs-bullet">-</span> 在任何情况下都不要脱离角色。
<span class="hljs-bullet">-</span> 不要胡说八道或编造事实。

<span class="hljs-section">## 概况：</span>

<span class="hljs-bullet">-</span> 语言：中文
<span class="hljs-bullet">-</span> 描述：你是一个心理学专家，用来分析职场中人们行为背后的潜在心理动机，可能的心理动机分析

<span class="hljs-section">## 技能</span>

<span class="hljs-bullet">1.</span> 职场行为分析
<span class="hljs-bullet">2.</span> 微表情识别
<span class="hljs-bullet">3.</span> 其他有助于分析职场心理状态的心理学、社会学技能

<span class="hljs-section"># 步骤</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**行为概括**</span>：总结需要分析的职场行为。
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**动机分析**</span>：对于概括出的行为，提供至少三个可能的心理动机。
<span class="hljs-bullet">    -</span> 每个动机包含以下几个部分:
<span class="hljs-bullet">        -</span> <span class="hljs-strong">**解释**</span>：描述这个动机的基本情况。
<span class="hljs-bullet">        -</span> <span class="hljs-strong">**可能的原因**</span>：解释为什么这个动机可能是行为背后的原因。
<span class="hljs-bullet">        -</span> <span class="hljs-strong">**潜在影响**</span>：说明这个动机对个体或职场环境可能产生的影响。

<span class="hljs-section"># 输出格式</span>

请在代码块中输出结果，结构如下：

行为概括

动机 1

解释:

可能的原因:

潜在影响:

动机 2

解释:

可能的原因:

潜在影响:

动机 3

解释:

可能的原因:

潜在影响:

<span class="hljs-section"># 示例</span>

行为概括

某员工频繁加班，甚至在周末也在处理工作。

动机 1

解释: 该员工希望在短时间内提升业绩。

可能的原因: 可能是为了给上级留下好印象，争取升职或加薪的机会。

潜在影响: 长期加班可能导致员工身心疲惫，从而影响工作效率和健康。

动机 2

解释: 该员工对工作有较强的责任感和成就感。

可能的原因: 他可能认为完成更多的工作能带来个人意义和职业满足感。

潜在影响: 虽然能短期提振工作绩效，但也有可能加剧员工的疲劳和倦怠。

动机 3

解释: 该员工缺乏时间管理技能，导致工作时间延长。

可能的原因: 工作方法不够有效，大量时间被浪费在低效的任务上。

潜在影响: 如果不加以改善，可能会形成恶性循环，影响长远的工作表现和职业发展。

<span class="hljs-section"># 注意事项</span>

<span class="hljs-bullet">-</span> 妥善分析行为动机，避免主观臆断。
<span class="hljs-bullet">-</span> 提供的解释和分析需要合理且基于心理学和社会学理论。 
</code></pre>
<p>欢迎语:</p>
<pre><code class="hljs language-md" lang="md">您好，我是您的职场心理学分析专家，专注于解析职场行为背后的心理动机。无论是团队沟通、员工行为还是管理难题，我都能为您提供科学、专业的心理动机分析，助您优化职场环境，提升团队效能。
</code></pre>
<p>开场的3个问题：</p>
<pre><code class="hljs language-md" lang="md">某员工频繁迟到，可能有哪些心理动机？

如何分析同事在会议中的肢体语言？

团队成员表现出消极情绪，可能的心理原因是什么？
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/861fa1e9a81c4538a15310e039611a83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=3%2B0KfOduddO2LjaCyoC0NTassF0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>在右侧我们就可以直接对话了，可以看到下图，成功输出了行为概括和动机。</p>
<p>基于提示词直接问：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/482611a921b446ac9aeb6604c8b25577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=AEi7qzI5BwFhsUG3TLe1KAcdS%2BA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>告诉他一个一个职场心理问题：</p>
<blockquote>
<p>某员工频繁迟到，可能有哪些心理动机？</p>
</blockquote>
<p>他会基于这个“职场心理学分析专家”来分析问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b9f8f8a5a6f487c8bd85b87a2b17475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=8xSGg8QKBddvvgT6Dfb1J92hJj8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>他会通过分析并回答：</p>
<blockquote>
<p>行为概括
某员工频繁迟到，经常在上班时间之后才到达工作岗位。动机 1
解释: 该员工可能对工作或工作环境存在潜在的抵触或不满情绪。
可能的原因: 这种抵触可能源于对工作内容不感兴趣、与同事或上级关系紧张、感到工作压力过大或缺乏成就感。迟到行为成为一种被动的、非直接的抵抗方式，用以表达不满或试图重新获得对工作时间的某种控制感。
潜在影响: 长期如此会损害该员工的职业形象和信誉，可能导致绩效评估不佳、错失发展机会，并可能加剧其与团队及上级的矛盾，形成负面循环。动机 2
解释: 该员工可能存在时间管理能力不足或自律性较弱的问题。
可能的原因: 这可能与个人的生活习惯、拖延倾向、对时间预估过于乐观，或者缺乏有效的优先级排序和计划能力有关。其行为背后并非对工作有强烈负面情绪，而是个人组织技能存在短板。
潜在影响: 不仅影响个人工作效率和任务完成质量，也可能给团队协作带来不便（如延误会议、等待其开始工作等），长期会限制其职业发展，并可能被贴上“不可靠”的标签。动机 3
解释: 该员工可能通过迟到行为来寻求关注或测试组织规则的边界。
可能的原因: 这背后可能隐藏着对自身在组织中地位的不安全感，希望通过“特殊”行为来确认上级或组织对自己的容忍度和重视程度。也可能是一种无意识的、希望引起他人（尤其是管理者）注意的方式。
潜在影响: 这种行为容易引发管理者的负面关注和同事的不满，破坏团队公平感。如果管理者处理不当（如过度纵容或过度惩罚），可能进一步强化该员工的不当行为或引发更大的冲突。</p>
</blockquote>
<h3 data-id="heading-13">4.进阶：为职场心理学分析专家加入职业发展工作流</h3>
<p>上面就是一个简单的对话，下面来加入一个高级点的技术，如工作流。</p>
<p>在上方有工作流管理，然后点击新建，手动录入，输入工作流的基本信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab6785d407c24589957db4376e1d4c3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=AnBhnFI8IqBhJFdp1Wgyf1UkUC8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>我们输入工作流的基本信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bb8791b278a446e94191cbe65b4d873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=gZvkjnbHVpRQdUu3Z3kLT%2FOfGDg%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>我填的具体如下：</p>
<blockquote>
<p>工作流名称：职业发展工作流
工作流描述：职业发展导师是一位经验丰富的职业规划和创业咨询专家，专注于为职场新人和创业者提供个性化、实用的职业发展和创业指导。该Agent通过系统化的信息收集，深入了解用户的教育背景、工作经验、兴趣爱好及职业目标，制定切实可行的职业规划方案。它不仅推荐适合的职业方向和晋升路径，还提供技能提升建议、行业趋势分析以及创业可行性评估。通过指导用户如何拓展人际网络、管理工作与生活平衡，帮助用户全面提升职场竞争力。</p>
</blockquote>
<p>创建一个如下图所示的工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/548b6ceb593c45e0bfdb8ff2dc12993f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=V%2FOgYMdIixNJVTN6GEmhLPo6JFk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>其中"职业发展工作流"节点的提示词如下：</p>
<blockquote>
<p>你是一位经验丰富的职业发展顾问和导师，擅长为职场新人和创业者提供全面、实用且具有可操作性的建议。你的任务是通过深入了解用户的教育背景、职业经历、当前面临的挑战与目标，为他们量身定制个性化、切实可行的职业发展方案。用户输入：shuru</p>
</blockquote>
<p>我们来进行测试一下：</p>
<p>点击右上角的调试，对他说：我是一名运营，我该怎么发展</p>
<p>可以看到Agent回复：</p>
<blockquote>
<p>作为一名运营人员，职业发展的关键在于不断提升自己的专业技能、行业知识以及软实力。首先，建议你定期参加行业相关的培训和研讨会，以保持对最新趋势和技术的了解。其次，建立一个强大的网络，包括同事、行业专家和潜在雇主，这将有助于你在行业内建立声誉，并可能带来新的职业机会。
此外，考虑获得一些认证或资格证书，如项目管理专业人士（PMP）认证，这可以证明你的专业能力并增强你的简历。同时，不断反思和评估自己的工作表现，设定明确的职业发展目标，并制定实现这些目标的具体计划。
最后，不要忘记培养自己的领导力和团队合作能力，这些都是在职业生涯中取得成功的重要因素。通过持续学习和实践，你可以逐步提升自己在运营领域的竞争力，实现职业上的成长和发展。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ab6c7c5bcc342e9afbabd5f49864311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=MXU3P83DMo78A93xJ%2FdwXoSmHHM%3D" alt="请在此添加图片描述" loading="lazy"/></p>
</blockquote>
<p>成功的创造了一个职业发展工作流，这下就不用担心职业发展不知道的方向了。</p>
<h3 data-id="heading-14">5.发布</h3>
<h4 data-id="heading-15">发布工作流</h4>
<p>制作好工作流后要记得来这里把他启动才可以运行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0887e06039704d18b0e9eb4080e1215d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=Kkf6T7n36jHFGixSHDbNXPbevVk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-16">发布应用</h4>
<p>接下来测试没问题后，我们就可以发布应用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e163b8db11ab4200b9a8d2dfe8ddc9dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=SgydzZ0yGsWnuWXTbO5RxSEf2qo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>测试通过后，点击右上角的“发布”。腾讯元器支持一键分发到多个高流量渠道：</p>
<ul>
<li><strong>微信公众号</strong>：自动回复，粉丝互动（这里因为已经有了，就不再选择了）。</li>
<li><strong>微信小程序</strong>：独立入口，体验更佳。</li>
<li><strong>智能硬件</strong>：如荣耀YOYO等。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc1bb2aa09844baadd5fcd8c01c80f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=uwBc13hPYEY%2F9q7oVjSh4V65T4w%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>然后就是等待审核。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25b01fea688c48f5aaf342cb1a5d8841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=p%2BbWJRA6vnwLLV3rF%2FBbHkdnXj0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>最终效果如下，用户可以通过简单的指令开启体验丝滑的分析过程。</p>
<p>点击下方链接体验<strong>职场心理学分析专家</strong>（已上架到小米应用商店）：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FJoAncj%3Fappid%3D2004808954860119296%26experience%3Dtrue" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/JoAncj?appid=2004808954860119296&amp;experience=true" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb044951c7b423b9fb79ca2ad9aee1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=2a0VhAgY1LZx6RCwN9WsSS6biKA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-17">总结</h2>
<h3 data-id="heading-18">🌟 为什么选择腾讯元器？</h3>
<ul>
<li>低门槛：无需编程，拖拽+提示词即可构建专业智能体</li>
<li>强生态：无缝对接微信、小程序、硬件设备</li>
<li>知识库支持：可后续接入企业内部培训资料或心理学数据库</li>
</ul>
<h3 data-id="heading-19">⚠️ 小建议（来自真实体验）：</h3>
<p>目前开场问题仅支持3个，建议未来开放更多选项，提升用户引导灵活性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a55efbf790b443c58ede9af150a6b5c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767427948&amp;x-signature=EB4%2BwkPeelidyCqDFJ4lbZota0g%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-20">整体感受：</h3>
<p>在数字化转型浪潮中，企业对“人”的关注正从“绩效输出”转向“心理体验”。本文所构建的「职场心理学分析专家」智能体，正是这一趋势下的技术回应。其核心价值在于将抽象的心理学理论转化为可操作、可复用、可规模化的管理工具。</p>
<p>首先，该智能体解决了传统管理中的“信息盲区”问题。管理者往往只能观察到行为表象（如迟到、沉默），却难以洞察其背后的情绪、动机或认知偏差。而本智能体通过结构化分析框架（行为概括 + 三重动机模型），帮助用户从情绪抵触、能力短板、边界试探等多个角度理解行为，避免误判与冲突升级。</p>
<p>其次，通过集成“职业发展工作流”，智能体不仅具备“诊断”能力，还提供“治疗”方案。它不再局限于问题分析，而是主动引导用户思考职业路径、技能缺口与资源网络，真正实现“赋能式管理”。这种从“解释”到“行动”的跃迁，是传统咨询难以高频覆盖的。</p>
<p>更重要的是，该方案依托腾讯元器平台，具备极强的落地性与扩展性。企业可在1小时内完成部署，无需IT支持；未来还可接入内部知识库，打造专属“组织心理顾问”。这不仅降低了心理学应用的门槛，也为企业构建“高情商组织文化”提供了技术支点。</p>
<p>综上所述，职场心理学分析专家不仅是AI工具，更是企业提升组织情商（Organizational EQ）、增强人才黏性、优化管理决策的智能基础设施。在“以人为本”的企业管理新时代，这样的智能体将成为HR与管理者不可或缺的数字伙伴。</p>
<p>通过腾讯元器，你也能在1小时内，打造一个专业、可靠、可落地的AI心理顾问，</p>
<p>让管理更有人性，让职场更有效能。</p>
<p>👉 立即体验：点击进入小米应用商店（已上架） 👉 动手创建：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FJoAncj%3Fappid%3D2004808954860119296%26experience%3Dtrue" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/JoAncj?appid=2004808954860119296&amp;experience=true" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[取件伙伴性能提升——长列表]]></title>    <link>https://juejin.cn/post/7588034035287162895</link>    <guid>https://juejin.cn/post/7588034035287162895</guid>    <pubDate>2025-12-27T07:53:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035287162895" data-draft-id="7588043318358622243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="取件伙伴性能提升——长列表"/> <meta itemprop="keywords" content="HarmonyOS,性能优化"/> <meta itemprop="datePublished" content="2025-12-27T07:53:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云_杰"/> <meta itemprop="url" content="https://juejin.cn/user/3877341924964713"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            取件伙伴性能提升——长列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3877341924964713/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云_杰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T07:53:59.000Z" title="Sat Dec 27 2025 07:53:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">取件伙伴性能提升——长列表</h2>
<p>在移动应用开发中，List是最常见也是最容易出现性能瓶颈的场景之一。在 <strong>取件伙伴</strong> 项目中，取件列表页面需要展示可能多达数百条的包裹信息。如果不进行优化，随着数据量的增长，应用会出现滑动掉帧、内存占用过高甚至崩溃的问题，特别是最近我增加了在<strong>深色模式下的雪花效果</strong>，列表更是卡的不行！</p>
<p>本文将详细介绍我们如何利用 性能优化 "三剑客" —— <strong><code>LazyForEach</code></strong>、<strong><code>@Reusable</code></strong> 和 <strong><code>cachedCount</code></strong>，将列表渲染性能提升至极致。</p>
<hr/>
<h3 data-id="heading-1">核心问题分析</h3>
<p>在早期的开发中，如果直接使用 <code>ForEach</code> 渲染列表：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 性能较差的写法</span>
<span class="hljs-title class_">List</span>() {
  <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">packages</span>, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-title class_">PackageCard</span>({ <span class="hljs-attr">packageInfo</span>: item })
  })
}
</code></pre>
<p>这种方式存在两个主要缺陷：</p>
<ol>
<li><strong>全量加载</strong>：无论列表有多长，<code>ForEach</code> 都会一次性创建所有的数据对象和组件节点。如果有 1000 个包裹，就会瞬间创建 1000 个 <code>PackageCard</code>，导致内存激增。</li>
<li><strong>频繁销毁与创建</strong>：当用户滑动列表时，移出屏幕的组件会被销毁，新进入屏幕的组件需要重新创建、布局和渲染。对于包含图片和复杂布局的卡片，这种开销是巨大的，直接导致滑动卡顿。</li>
</ol>
<hr/>
<h3 data-id="heading-2">解决方案：性能优化 "三剑客"</h3>
<h4 data-id="heading-3">1. LazyForEach：按需加载</h4>
<p><code>LazyForEach</code> 是专门为长列表设计的渲染控制语法。与 <code>ForEach</code> 不同，它只渲染屏幕可见区域的组件，并配合数据源（IDataSource）实现按需加载。</p>
<h5 data-id="heading-4">实现步骤：</h5>
<p>首先，我们需要实现一个 <code>IDataSource</code> 接口的数据源类：</p>
<p><strong><code>entry/src/main/ets/utils/BasicDataSource.ets</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 通用数据源基类，实现了 IDataSource 接口</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicDataSource</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IDataSource</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">DataChangeListener</span>[] = [];
  <span class="hljs-keyword">private</span> <span class="hljs-attr">originDataArray</span>: T[] = [];

  <span class="hljs-comment">// 获取数据的总条数</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">totalCount</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">originDataArray</span>.<span class="hljs-property">length</span>;
  }

  <span class="hljs-comment">// 获取指定索引的数据</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getData</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): T {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">originDataArray</span>[index];
  }

  <span class="hljs-comment">// 注册/注销监听器（框架调用）</span>
  <span class="hljs-title function_">registerDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">push</span>(listener);
    }
  }
  <span class="hljs-title function_">unregisterDataChangeListener</span>(<span class="hljs-attr">listener</span>: <span class="hljs-title class_">DataChangeListener</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> pos = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(listener);
    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">splice</span>(pos, <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-comment">// === 通知 LazyForEach 刷新 ===</span>
  <span class="hljs-title function_">notifyDataReload</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> listener.<span class="hljs-title function_">onDataReloaded</span>());
  }
  
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setData</span>(<span class="hljs-params">data: T[]</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">originDataArray</span> = data;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyDataReload</span>();
  }
}
</code></pre>
<h4 data-id="heading-5">2. @Reusable：组件复用</h4>
<p>这是解决“滑动卡顿”的关键。通过 <code>@Reusable</code> 装饰器，我们可以让组件具备“复用”能力。当一个列表项滑出屏幕时，它的组件实例不会被销毁，而是被放入缓存池；当新数据滑入屏幕时，直接从缓存池取出实例并更新数据，<strong>跳过了昂贵的组件创建和布局计算过程</strong>。</p>
<p><strong><code>entry/src/main/ets/components/PackageCard.ets</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Reusable</span> <span class="hljs-comment">// &lt;--- 1. 标记为可复用组件</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">PackageCard</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">packageInfo</span>: <span class="hljs-title class_">PackageInfo</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
  
  <span class="hljs-comment">/**
   * 2. 复用生命周期回调
   * 当组件被复用时触发。在此处更新状态变量，驱动 UI 刷新。
   * 
   * <span class="hljs-doctag">@param</span> params 上层传入的新参数
   */</span>
  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {
    <span class="hljs-comment">// 快速更新数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">packageInfo</span> = params.<span class="hljs-property">packageInfo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PackageInfo</span>;
    
    <span class="hljs-comment">// 更新其他状态</span>
    <span class="hljs-keyword">if</span> (params.<span class="hljs-property">compactModeEnabled</span> !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">compactModeEnabled</span> = params.<span class="hljs-property">compactModeEnabled</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;
    }
    <span class="hljs-comment">// ...</span>
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 构建复杂的卡片布局...</span>
    <span class="hljs-comment">// 复用时，这里的节点结构保持不变，仅数据发生变化</span>
  }
}
</code></pre>
<h4 data-id="heading-6">3. cachedCount：预加载</h4>
<p><code>LazyForEach</code> 默认只加载屏幕可见的项。为了让滑动更流畅，我们可以利用 <code>cachedCount</code> 属性，让列表在屏幕上下方预先加载几个项目。</p>
<p><strong><code>entry/src/main/ets/pages/PackagesPage.ets</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">12</span> }) {
  <span class="hljs-comment">// 使用 LazyForEach + 自定义数据源</span>
  <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">packagesDataSource</span>, <span class="hljs-function">(<span class="hljs-params">packageInfo: PackageInfo, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-title class_">ListItem</span>() {
      <span class="hljs-comment">// 使用可复用组件</span>
      <span class="hljs-title class_">PackageCard</span>({
        <span class="hljs-attr">packageInfo</span>: packageInfo,
        <span class="hljs-comment">// ...</span>
      })
    }
  }, <span class="hljs-function">(<span class="hljs-params">item: PackageInfo</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${item.id}</span>_<span class="hljs-subst">${item.updateTime}</span>`</span>) <span class="hljs-comment">// 键值生成器</span>
}
.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
.<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">5</span>) <span class="hljs-comment">// &lt;--- 设置缓存数量为 5</span>
</code></pre>
<ul>
<li><strong>原理</strong>：<code>cachedCount(5)</code> 表示在屏幕视口之外，预先渲染并缓存 5 个列表项。</li>
<li><strong>收益</strong>：当用户快速滑动时，即将进入屏幕的卡片已经渲染好了，消除了白屏和闪烁，极大提升了跟手性。</li>
</ul>
<hr/>
<h3 data-id="heading-7">优化效果对比</h3>



































<table><thead><tr><th align="left">指标</th><th align="left">优化前 (ForEach)</th><th align="left">优化后 (LazyForEach + @Reusable)</th><th align="left">提升原理</th></tr></thead><tbody><tr><td align="left"><strong>首屏加载时间</strong></td><td align="left">慢（加载所有数据）</td><td align="left"><strong>快</strong>（仅加载首屏可见项）</td><td align="left">按需渲染</td></tr><tr><td align="left"><strong>内存占用</strong></td><td align="left">高（随数据量线性增长）</td><td align="left"><strong>低且稳定</strong>（仅维持可见项+缓存项）</td><td align="left">对象复用</td></tr><tr><td align="left"><strong>滑动帧率</strong></td><td align="left">掉帧明显</td><td align="left"><strong>满帧运行 (60/90/120Hz)</strong></td><td align="left">避免频繁创建销毁节点</td></tr><tr><td align="left"><strong>CPU 占用</strong></td><td align="left">高（频繁 GC 和布局计算）</td><td align="left"><strong>低</strong></td><td align="left">复用现有节点结构</td></tr></tbody></table>
<h3 data-id="heading-8">总结</h3>
<p>在开发复杂列表界面时，<strong>"LazyForEach + @Reusable + cachedCount"</strong> 是标准的高性能解决方案。</p>
<ol>
<li>用 <code>LazyForEach</code> 替代 <code>ForEach</code>，解决内存和首屏问题。</li>
<li>用 <code>@Reusable</code> 改造子组件，解决滑动掉帧问题。</li>
<li>用 <code>cachedCount</code> 调节预加载，进一步提升流畅度。</li>
</ol>
<p>这套方案在 PickupPartner 项目中经受住了大量数据的考验，为用户提供了丝滑的操作体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook]]></title>    <link>https://juejin.cn/post/7588086766248132659</link>    <guid>https://juejin.cn/post/7588086766248132659</guid>    <pubDate>2025-12-27T08:05:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766248132659" data-draft-id="7588010346071736330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-27T08:05:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="练习前端两年半"/> <meta itemprop="url" content="https://juejin.cn/user/4012552097381324"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4012552097381324/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    练习前端两年半
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:05:29.000Z" title="Sat Dec 27 2025 08:05:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Vue3 高级技巧】函数重载+Watch：打造类型安全的通用事件监听 Hook</h2>
<h3 data-id="heading-1">📖 引言</h3>
<p>在 Vue3 项目开发中，事件监听是一项非常基础但频繁使用的功能。我们经常需要为 DOM 元素或 window 对象绑定各类事件，如点击、滚动、键盘输入等。虽然原生 API 使用起来并不复杂，但在组件化开发中，手动管理事件的绑定与解绑不仅繁琐，还容易导致内存泄漏。</p>
<p>今天，我们将探索如何利用 Vue3 的<code>watch</code>API 和 TypeScript 的函数重载特性，打造一个<strong>类型安全、自动清理、使用便捷</strong>的通用事件监听 Hook，彻底解决事件管理的痛点。</p>
<h3 data-id="heading-2">🎯 问题剖析：原生事件绑定的痛点</h3>
<p>先来看一段我们在 Vue 组件中经常写的事件绑定代码：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div ref="divRef"&gt;&lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted, onUnmounted } from "vue";
const divRef = ref();
onMounted(() =&gt; {
  divRef.value.addEventListener("click", (e) =&gt; {
    console.log(e);
  });
});
onUnmounted(() =&gt; {
  divRef.value.removeEventListener("click");
});
&lt;/script&gt;
</code></pre>
<p>这段代码看似简单，但存在以下几个问题：</p>
<ol>
<li><strong>代码重复</strong>：每个需要事件绑定的组件都要写类似的<code>onMounted</code>和<code>onUnmounted</code>逻辑</li>
<li><strong>手动管理</strong>：必须手动调用<code>removeEventListener</code>，容易遗漏导致内存泄漏</li>
<li><strong>缺乏灵活性</strong>：无法很好地处理动态渲染的 DOM 元素（如 v-if 控制的元素）</li>
<li><strong>类型不安全</strong>：事件处理函数中的事件对象缺乏类型提示</li>
</ol>
<h3 data-id="heading-3">💡 解决方案：封装通用事件监听 Hook</h3>
<p>针对上述问题，我们可以封装一个通用的事件监听 Hook——<code>useEventListener</code>，利用 Vue3 的<code>watch</code>API 来自动管理事件的生命周期。</p>
<h4 data-id="heading-4">核心实现思路</h4>
<ol>
<li><strong>自动清理机制</strong>：利用<code>watch</code>的<code>onClear</code>回调实现事件的自动解绑</li>
<li><strong>动态目标支持</strong>：同时支持 window 对象和 DOM 元素作为事件目标</li>
<li><strong>响应式处理</strong>：通过<code>watch</code>监听目标元素的变化，支持动态 DOM</li>
<li><strong>类型安全</strong>：使用 TypeScript 的函数重载提供完整的类型提示</li>
</ol>
<h4 data-id="heading-5">基础版本实现</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { watch, unref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-comment">// 判断目标：如果第一个参数是字符串，则目标为window；否则为传入的DOM元素</span>
  <span class="hljs-keyword">const</span> target = <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">"string"</span> ? <span class="hljs-variable language_">window</span> : args.<span class="hljs-title function_">shift</span>();

  <span class="hljs-comment">// 使用watch监听目标元素的变化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unref</span>(target),
    <span class="hljs-function">(<span class="hljs-params">element, _, onClear</span>) =&gt;</span> {
      <span class="hljs-comment">// 处理DOM不存在的情况（如v-if初始为false）</span>
      <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 绑定事件</span>
      element.<span class="hljs-title function_">addEventListener</span>(...args);

      <span class="hljs-comment">// 清理函数：在组件卸载或watch停止时执行</span>
      <span class="hljs-title function_">onClear</span>(<span class="hljs-function">() =&gt;</span> {
        element.<span class="hljs-title function_">removeEventListener</span>(...args);
      });
    },
    {
      <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 立即执行</span>
    }
  );
}
</code></pre>
<h4 data-id="heading-6">用法示例</h4>
<p>封装完成后，我们可以通过两种方式使用这个 Hook：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 给window绑定事件</span>
<span class="hljs-title function_">useEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Window clicked!"</span>), options);

<span class="hljs-comment">// 2. 给指定DOM元素绑定事件</span>
<span class="hljs-title function_">useEventListener</span>(domRef, <span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"DOM clicked!"</span>), options);
</code></pre>
<p>如果需要手动结束事件监听，可以调用返回的<code>stop</code>方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> handle = <span class="hljs-title function_">useEventListener</span>(domRef, <span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {});
<span class="hljs-comment">// 手动终止监听</span>
handle.<span class="hljs-title function_">stop</span>();
</code></pre>
<h3 data-id="heading-7">🚀 进阶优化：函数重载实现类型安全</h3>
<p>基础版本虽然功能完整，但在 TypeScript 环境下使用时缺乏类型提示，这会影响开发体验。为了解决这个问题，我们可以利用 TypeScript 的<strong>函数重载</strong>特性。</p>
<h4 data-id="heading-8">函数重载的定义</h4>
<p>函数重载允许我们为同一个函数提供多个类型定义，TypeScript 会根据传入的参数类型自动选择匹配的重载版本。</p>
<h4 data-id="heading-9">类型安全版本实现</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { watch, unref, <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">// 重载1：给window绑定事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useEventListener&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">WindowEventMap</span>&gt;(
  <span class="hljs-attr">type</span>: K,
  <span class="hljs-attr">handle</span>: <span class="hljs-function">(<span class="hljs-params">event: WindowEventMap[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  options?: <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">AddEventListenerOptions</span>
);

<span class="hljs-comment">// 重载2：给指定DOM元素绑定事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useEventListener&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">HTMLElementEventMap</span>&gt;(
  <span class="hljs-attr">target</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>&gt;,
  <span class="hljs-attr">type</span>: K,
  <span class="hljs-attr">handle</span>: <span class="hljs-function">(<span class="hljs-params">event: HTMLElementEventMap[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  options?: <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">AddEventListenerOptions</span>
);

<span class="hljs-comment">// 通用实现</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
  <span class="hljs-comment">// 判断目标：如果第一个参数是字符串，则目标为window；否则为传入的DOM元素</span>
  <span class="hljs-keyword">const</span> target = <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">"string"</span> ? <span class="hljs-variable language_">window</span> : args.<span class="hljs-title function_">shift</span>();

  <span class="hljs-comment">// 使用watch监听目标元素的变化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unref</span>(target),
    <span class="hljs-function">(<span class="hljs-params">element, _, onClear</span>) =&gt;</span> {
      <span class="hljs-comment">// 处理DOM不存在的情况（如v-if初始为false）</span>
      <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 绑定事件</span>
      element.<span class="hljs-title function_">addEventListener</span>(...args);

      <span class="hljs-comment">// 清理函数：在组件卸载或watch停止时执行</span>
      <span class="hljs-title function_">onClear</span>(<span class="hljs-function">() =&gt;</span> {
        element.<span class="hljs-title function_">removeEventListener</span>(...args);
      });
    },
    {
      <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 立即执行</span>
    }
  );
}
</code></pre>
<h4 data-id="heading-10">类型重载的优势</h4>
<ol>
<li><strong>智能提示</strong>：IDE 会根据传入的参数类型提供对应的事件名称和事件对象类型提示</li>
<li><strong>类型检查</strong>：TypeScript 会检查事件处理函数的参数类型是否正确</li>
<li><strong>错误预防</strong>：避免传入不存在的事件类型或错误的事件处理函数签名</li>
</ol>
<h3 data-id="heading-11">🎯 技术深度解析</h3>
<h4 data-id="heading-12">1. Watch API 的高级用法</h4>
<p>在这个 Hook 中，我们充分利用了 Vue3 <code>watch</code> API 的高级特性：</p>
<ul>
<li><strong>响应式监听</strong>：通过<code>unref(target)</code>确保可以同时处理 ref 和普通值</li>
<li><strong>immediate 选项</strong>：确保组件挂载后立即绑定事件</li>
<li><strong>onClear 回调</strong>：提供了可靠的清理机制，避免内存泄漏</li>
</ul>
<h4 data-id="heading-13">2. TypeScript 类型系统的强大</h4>
<ul>
<li><strong>事件映射类型</strong>：<code>WindowEventMap</code>和<code>HTMLElementEventMap</code>提供了浏览器原生事件的完整类型定义</li>
<li><strong>泛型约束</strong>：使用<code>K extends keyof EventMap</code>确保事件类型的正确性</li>
<li><strong>函数重载</strong>：为不同的使用场景提供精确的类型定义</li>
</ul>
<h4 data-id="heading-14">3. 自动清理机制的原理</h4>
<p>当以下情况发生时，<code>onClear</code>回调会被自动调用：</p>
<ul>
<li>组件卸载时</li>
<li>调用返回的<code>stop</code>方法时</li>
<li>监听的目标元素发生变化时</li>
</ul>
<p>这种机制确保了事件监听始终与组件生命周期同步，彻底避免了内存泄漏。</p>
<h3 data-id="heading-15">📝 最佳实践与注意事项</h3>
<h4 data-id="heading-16">1. 事件处理函数的注意事项</h4>
<ul>
<li><strong>避免箭头函数陷阱</strong>：如果需要在事件处理函数中访问<code>this</code>，应使用普通函数</li>
<li><strong>事件对象的正确使用</strong>：利用 TypeScript 的类型系统确保事件对象的属性访问安全</li>
</ul>
<h4 data-id="heading-17">2. 性能优化建议</h4>
<ul>
<li><strong>事件委托</strong>：对于大量相似元素，优先考虑事件委托而不是为每个元素单独绑定事件</li>
<li><strong>合理使用事件选项</strong>：根据需要设置<code>passive</code>、<code>capture</code>等选项优化性能</li>
</ul>
<h4 data-id="heading-18">3. 扩展使用场景</h4>
<ul>
<li><strong>自定义事件</strong>：可以扩展支持自定义事件的类型定义</li>
<li><strong>组件事件</strong>：结合 Vue 的组件事件系统使用</li>
<li><strong>第三方库集成</strong>：与 Chart.js、Mapbox 等第三方库的事件系统集成</li>
</ul>
<h3 data-id="heading-19">🔧 实战案例：实时键盘监听</h3>
<p>让我们通过一个实际案例来展示<code>useEventListener</code>的强大功能：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;h2&gt;键盘监听演示&lt;/h2&gt;
    &lt;p&gt;当前按下的键：{{ pressedKey }}&lt;/p&gt;
    &lt;p&gt;按下次数：{{ pressCount }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from "vue";
import { useEventListener } from "./useEventListener";

const pressedKey = ref("");
const pressCount = ref(0);

// 使用通用事件监听Hook
useEventListener(
  "keydown",
  (event: KeyboardEvent) =&gt; {
    pressedKey.value = event.key;
    pressCount.value++;
  },
  { passive: true }
);
&lt;/script&gt;
</code></pre>
<p>这个示例展示了如何轻松实现一个实时键盘监听功能，无需手动管理事件的绑定与解绑。</p>
<h3 data-id="heading-20">📚 扩展阅读</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html" ref="nofollow noopener noreferrer">Vue3 Composition API - Watch</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2F2%2Ffunctions.html%23function-overloads" target="_blank" title="https://www.typescriptlang.org/docs/handbook/2/functions.html#function-overloads" ref="nofollow noopener noreferrer">TypeScript 函数重载</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventTarget%2FaddEventListener" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener" ref="nofollow noopener noreferrer">DOM 事件 API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FPerformance%2FMemory_management" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/Performance/Memory_management" ref="nofollow noopener noreferrer">前端内存泄漏排查与解决</a></li>
</ol>
<h3 data-id="heading-21">💭 思考题</h3>
<ol>
<li>如何扩展这个 Hook 以支持自定义事件类型？</li>
<li>如果需要同时监听多个事件，应该如何优化实现？</li>
<li>如何将这个 Hook 与 Vue 的响应式系统更好地结合？</li>
</ol>
<h3 data-id="heading-22">🎉 总结</h3>
<p>通过本文的介绍，我们学习了如何利用 Vue3 的<code>watch</code>API 和 TypeScript 的函数重载特性，打造一个类型安全、自动清理的通用事件监听 Hook。这个 Hook 不仅解决了原生事件绑定的痛点，还提供了良好的开发体验和类型支持。</p>
<p>核心技术点回顾：</p>
<ul>
<li><strong>函数重载</strong>：提供精确的类型定义和智能提示</li>
<li><strong>Watch API</strong>：实现响应式监听和自动清理</li>
<li><strong>自动管理</strong>：事件生命周期与组件同步，避免内存泄漏</li>
<li><strong>灵活使用</strong>：支持 window 和 DOM 元素，适应各种场景</li>
</ul>
<p>这个简单而强大的 Hook 展示了 Vue3 Composition API 的灵活性和 TypeScript 类型系统的强大，是我们在日常开发中值得掌握的高级技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[稳定性性能系列之二——ANR机制深度解析:从触发到上报]]></title>    <link>https://juejin.cn/post/7588034035287080975</link>    <guid>https://juejin.cn/post/7588034035287080975</guid>    <pubDate>2025-12-27T06:51:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035287080975" data-draft-id="7587776610437152783" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="稳定性性能系列之二——ANR机制深度解析:从触发到上报"/> <meta itemprop="keywords" content="性能优化,Android,Debug"/> <meta itemprop="datePublished" content="2025-12-27T06:51:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            稳定性性能系列之二——ANR机制深度解析:从触发到上报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:51:24.000Z" title="Sat Dec 27 2025 06:51:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言:那个让人又爱又恨的ANR Dialog</h2>
<p>还记得第一次看到ANR Dialog吗?</p>
<p>"<strong>应用XX无响应,是否关闭?</strong>"</p>
<p>作为用户,这个对话框让人抓狂——应用卡住了,什么都做不了。但作为开发者,这个对话框却是救命稻草——至少它告诉你出问题了,还给你留下了traces.txt这个"作案现场"。</p>
<p>我曾经遇到过一个让人头疼的ANR:用户在设置界面切换WiFi时,整个系统界面就卡死了。看logcat,发现主线程在等一个锁;再看traces.txt,发现持锁的线程正在进行Binder调用;继续追踪,原来是ContentObserver注册过多导致的Binder资源耗尽...这就像一场侦探游戏,而ANR Dialog是案件的起点。</p>
<p>本文将带你深入ANR机制的内部,从Input事件分发到超时检测,从traces信息收集到Dialog弹出,完整剖析ANR的全生命周期。读完本文,你将能够:</p>
<ol>
<li>理解ANR的4种类型及其超时时间</li>
<li>掌握InputDispatcher如何检测Input ANR</li>
<li>了解ActivityManagerService如何处理ANR</li>
<li>学会分析traces.txt和找到根因</li>
<li>构建ANR监控和预防机制</li>
</ol>
<p>准备好了吗?让我们揭开ANR机制的神秘面纱!</p>
<hr/>
<h2 data-id="heading-1">一、ANR基础概念</h2>
<h3 data-id="heading-2">1.1 什么是ANR?</h3>
<p>ANR (Application Not Responding) 是Android系统的一种保护机制。当应用在规定时间内没有响应用户操作或系统事件时,系统会认为应用"死了",弹出ANR对话框让用户选择是继续等待还是强制关闭。</p>
<p>打个比方:ANR就像餐厅的"上菜超时提醒"。你点了一道菜,如果厨房5分钟还没上菜,服务员就会过来询问"要不要继续等,还是换一道菜"。这避免了你无限期地等下去。</p>
<p><strong>ANR的核心作用</strong>:</p>
<ul>
<li><strong>保护用户体验</strong>: 避免应用长时间无响应</li>
<li><strong>及时发现问题</strong>: 通过traces.txt记录"作案现场"</li>
<li><strong>系统自我保护</strong>: 防止单个应用拖垮整个系统</li>
</ul>
<h3 data-id="heading-3">1.2 ANR的4种类型</h3>
<p>Android系统对不同类型的事件设置了不同的超时时间:</p>



































<table><thead><tr><th>ANR类型</th><th>超时时间</th><th>触发场景</th><th>检测位置</th></tr></thead><tbody><tr><td><strong>Input ANR</strong></td><td>5秒</td><td>用户触摸/按键事件未被处理</td><td>InputDispatcher</td></tr><tr><td><strong>Broadcast ANR</strong></td><td>前台10秒 / 后台60秒</td><td>BroadcastReceiver的onReceive()未执行完</td><td>ActivityManagerService</td></tr><tr><td><strong>Service ANR</strong></td><td>前台20秒 / 后台200秒</td><td>Service的生命周期方法未执行完</td><td>ActivityManagerService</td></tr><tr><td><strong>ContentProvider ANR</strong></td><td>10秒</td><td>ContentProvider发布超时</td><td>ActivityManagerService</td></tr></tbody></table>
<p><strong>为什么超时时间不一样?</strong></p>
<p>这是基于用户体验和系统响应性的权衡:</p>
<ul>
<li><strong>Input ANR最短(5秒)</strong>: 用户操作必须得到快速反馈,否则会认为设备坏了</li>
<li><strong>Broadcast ANR中等(10秒/60秒)</strong>: 广播接收器本应该快速执行,但允许一定的处理时间</li>
<li><strong>Service ANR较长(20秒/200秒)</strong>: 后台服务可以处理耗时操作,给予更多宽容</li>
<li><strong>后台进程超时更长</strong>: 后台操作不影响前台体验,可以等待更久</li>
</ul>
<h3 data-id="heading-4">1.3 ANR vs Freeze vs Watchdog</h3>
<p>经常有人混淆这几个概念,让我们对比一下:</p>









































<table><thead><tr><th>特性</th><th>ANR</th><th>Freeze</th><th>Watchdog</th></tr></thead><tbody><tr><td><strong>检测对象</strong></td><td>应用进程</td><td>应用进程</td><td>System Server</td></tr><tr><td><strong>检测维度</strong></td><td>特定事件响应</td><td>整体响应性</td><td>核心线程健康</td></tr><tr><td><strong>超时时间</strong></td><td>5-200秒</td><td>通常小于秒</td><td>30-60秒</td></tr><tr><td><strong>后果</strong></td><td>弹出ANR Dialog</td><td>可能触发ANR</td><td>系统重启</td></tr><tr><td><strong>作用域</strong></td><td>单个应用</td><td>单个应用</td><td>整个系统</td></tr></tbody></table>
<p><strong>形象的比喻</strong>:</p>
<ul>
<li><strong>ANR</strong>: 餐厅服务员检查你点的菜是否上齐了</li>
<li><strong>Freeze</strong>: 餐厅经理监控服务员是否在工作</li>
<li><strong>Watchdog</strong>: 消防队定时巡查餐厅的消防系统是否正常</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、Input ANR的完整流程</h2>
<p>Input ANR是最常见也是最典型的ANR类型。让我们通过一个用户点击按钮的场景,完整走一遍ANR的检测流程。</p>
<h3 data-id="heading-6">2.1 整体流程概览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3890f02135fe40e5a0a4cb7daaffa516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=fPgI6qx%2BkPMhB9PzmnCNj7VOoBo%3D" alt="02-01-anr-input-flow.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.2 InputReader:事件的源头</h3>
<p>InputReader运行在一个独立的线程中,负责从内核读取输入事件:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// frameworks/native/services/inputflinger/reader/InputReader.cpp</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InputReader::loopOnce</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 从/dev/input/eventX读取原始事件</span>
    <span class="hljs-type">size_t</span> count = mEventHub-&gt;<span class="hljs-built_in">getEvents</span>(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);

    <span class="hljs-comment">// 2. 处理每个事件</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-type">const</span> RawEvent&amp; rawEvent = mEventBuffer[i];

        <span class="hljs-comment">// 3. 根据设备类型(触摸屏、键盘等)转换为Android事件</span>
        <span class="hljs-built_in">processEventsLocked</span>(rawEvent);
    }

    <span class="hljs-comment">// 4. 将处理好的事件交给InputDispatcher</span>
    mQueuedListener-&gt;<span class="hljs-built_in">flush</span>();
}
</code></pre>
<p><strong>关键点</strong>:</p>
<ul>
<li>InputReader是事件的"搬运工",只负责读取和初步处理</li>
<li>它不关心事件是否被应用处理,只管往前送</li>
<li>真正的超时检测发生在InputDispatcher</li>
</ul>
<h3 data-id="heading-8">2.3 InputDispatcher:超时检测的核心</h3>
<p>InputDispatcher是ANR检测的"心脏"。让我们看看它如何检测超时:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// frameworks/native/services/inputflinger/dispatcher/InputDispatcher.cpp</span>

<span class="hljs-comment">// 分发事件的核心逻辑</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InputDispatcher::dispatchOnce</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">nsecs_t</span> nextWakeupTime = LONG_LONG_MAX;

    <span class="hljs-comment">// 1. 从队列中取出待分发的事件</span>
    <span class="hljs-keyword">if</span> (mPendingEvent == <span class="hljs-literal">nullptr</span>) {
        mPendingEvent = mInboundQueue.<span class="hljs-built_in">dequeueAtHead</span>();
    }

    <span class="hljs-comment">// 2. 找到事件的目标Window</span>
    std::vector&lt;InputTarget&gt; inputTargets;
    <span class="hljs-type">int32_t</span> injectionResult = <span class="hljs-built_in">findFocusedWindowTargetsLocked</span>(
            currentTime, mPendingEvent, inputTargets, nextWakeupTime);

    <span class="hljs-comment">// 3. 分发事件到目标Window</span>
    <span class="hljs-keyword">if</span> (injectionResult == INPUT_EVENT_INJECTION_SUCCEEDED) {
        <span class="hljs-built_in">dispatchEventLocked</span>(currentTime, mPendingEvent, inputTargets);
    }

    <span class="hljs-comment">// 4. 检查是否有连接超时</span>
    <span class="hljs-type">nsecs_t</span> nextAnrCheck = <span class="hljs-built_in">checkUnresponsiveConnectionsLocked</span>(currentTime);
    <span class="hljs-keyword">if</span> (nextAnrCheck &lt; nextWakeupTime) {
        nextWakeupTime = nextAnrCheck;
    }
}
</code></pre>
<p><strong>超时检测的关键逻辑</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 检查连接是否响应</span>
<span class="hljs-function"><span class="hljs-type">nsecs_t</span> <span class="hljs-title">InputDispatcher::checkUnresponsiveConnectionsLocked</span><span class="hljs-params">(<span class="hljs-type">nsecs_t</span> currentTime)</span> </span>{
    <span class="hljs-type">nsecs_t</span> nextAnrCheck = LONG_LONG_MAX;

    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; [token, connection] : mConnectionsByToken) {
        <span class="hljs-comment">// 检查这个连接的等待队列</span>
        <span class="hljs-keyword">if</span> (connection-&gt;waitQueue.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 获取队头事件</span>
        DispatchEntry* head = connection-&gt;waitQueue.head;
        <span class="hljs-type">nsecs_t</span> eventTime = head-&gt;eventEntry-&gt;eventTime;

        <span class="hljs-comment">// 计算等待时间</span>
        <span class="hljs-type">nsecs_t</span> waitDuration = currentTime - eventTime;

        <span class="hljs-comment">// 如果超过5秒(5000ms),触发ANR</span>
        <span class="hljs-keyword">if</span> (waitDuration &gt; <span class="hljs-number">5000</span>ms) {
            <span class="hljs-built_in">onAnrLocked</span>(connection);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 记录下次检查时间</span>
            <span class="hljs-type">nsecs_t</span> timeoutTime = eventTime + <span class="hljs-number">5000</span>ms;
            <span class="hljs-keyword">if</span> (timeoutTime &lt; nextAnrCheck) {
                nextAnrCheck = timeoutTime;
            }
        }
    }

    <span class="hljs-keyword">return</span> nextAnrCheck;
}
</code></pre>
<p><strong>精妙的设计</strong>:</p>
<ol>
<li><strong>事件入队列时记录时间戳</strong>: 每个事件分发时,都会记录<code>eventTime</code></li>
<li><strong>定时检查队头事件</strong>: InputDispatcher会定期检查waitQueue的队头</li>
<li><strong>计算等待时长</strong>: <code>waitDuration = currentTime - eventTime</code></li>
<li><strong>超时触发ANR</strong>: 如果等待超过5秒,调用<code>onAnrLocked()</code></li>
</ol>
<p><strong>为什么检查队头而不是队尾?</strong></p>
<p>因为队头是最早发送的事件,如果队头都还没处理完,说明应用真的卡住了。这就像排队买票:如果队伍最前面的人还在办理,后面的人自然也走不了。</p>
<h3 data-id="heading-9">2.4 等待队列(waitQueue)的秘密</h3>
<p>理解waitQueue是理解Input ANR的关键:</p>
<pre><code class="hljs language-ini" lang="ini">waitQueue的生命周期:

1. 事件发送前
   waitQueue: <span class="hljs-section">[]</span>

2. 事件发送给应用
   dispatchEntry入队
   waitQueue: <span class="hljs-section">[Event1]</span>
   记录<span class="hljs-attr">Event1.eventTime</span> = T0

3. 应用处理事件(正常情况)
   应用调用finish()
   waitQueue: <span class="hljs-section">[]</span>  ← Event1被移除

4. 应用卡住(异常情况)
   T0 + 5秒后
   waitQueue: <span class="hljs-section">[Event1]</span>  ← Event1还在!
   InputDispatcher检测到超时
   触发ANR
</code></pre>
<p><strong>代码实现</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 应用处理完事件后调用</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InputDispatcher::finishDispatchCycleLocked</span><span class="hljs-params">(
        <span class="hljs-type">nsecs_t</span> currentTime, sp&lt;Connection&gt; connection)</span> </span>{
    <span class="hljs-comment">// 从waitQueue移除已处理的事件</span>
    <span class="hljs-keyword">while</span> (!connection-&gt;waitQueue.<span class="hljs-built_in">empty</span>()) {
        DispatchEntry* dispatchEntry = connection-&gt;waitQueue.head;
        connection-&gt;waitQueue.<span class="hljs-built_in">dequeue</span>(dispatchEntry);

        <span class="hljs-comment">// 释放资源</span>
        <span class="hljs-built_in">releaseDispatchEntry</span>(dispatchEntry);

        <span class="hljs-comment">// 如果这是最后一个事件,重置超时检查</span>
        <span class="hljs-keyword">if</span> (connection-&gt;waitQueue.<span class="hljs-built_in">empty</span>()) {
            connection-&gt;lastEventTime = LLONG_MIN;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">2.5 ANR分析示例</h3>
<p>让我们看一个真实的Input ANR场景的分析简化:</p>
<p><strong>场景</strong>: 用户在列表界面快速滑动,突然应用无响应</p>
<p><strong>logcat日志</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-number">12</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">15.123</span>  <span class="hljs-number">1234</span>  <span class="hljs-number">1250</span> E InputDispatcher: channel <span class="hljs-string">'e8d3a72 com.example.app/com.example.app.MainActivity (server)'</span> ~ Channel <span class="hljs-keyword">is</span> unresponsive! Waited <span class="hljs-number">5008</span>ms
<span class="hljs-number">12</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">15.234</span>  <span class="hljs-number">1234</span>  <span class="hljs-number">1250</span> I InputDispatcher: Delivering ANR to com.example.app
</code></pre>
<p><strong>traces.txt片段</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8 self=<span class="hljs-number">0</span>x7a4e014c00
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">12345</span> nice=-<span class="hljs-number">10</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">15678923456</span> <span class="hljs-number">8765432109</span> <span class="hljs-number">1234</span> ) utm=<span class="hljs-number">1500</span> stm=<span class="hljs-number">67</span> core=<span class="hljs-number">2</span> HZ=<span class="hljs-number">100</span>
  at com.example.app.RecyclerAdapter.onBindViewHolder(RecyclerAdapter.java:150)
  - waiting to lock &lt;0x0a1b2c3d&gt; (a java.lang.Object) held by thread 15
  at android.support.v7.widget.RecyclerView.dispatchLayout(RecyclerView.java:3500)
  at android.support.v7.widget.RecyclerView.onLayout(RecyclerView.java:4064)
  at android.view.View.layout(View.java:19839)
  ...
</code></pre>
<p><strong>根因分析</strong>:</p>
<ol>
<li><strong>现象</strong>: 主线程被阻塞,状态是<code>Blocked</code></li>
<li><strong>位置</strong>: 卡在<code>RecyclerAdapter.onBindViewHolder()</code></li>
<li><strong>原因</strong>: 主线程在等待一个锁<code>&lt;0x0a1b2c3d&gt;</code>,这个锁被线程15持有</li>
<li><strong>解决</strong>: 找到线程15在干什么,解开死锁</li>
</ol>
<p><strong>关键教训</strong>:</p>
<ul>
<li>永远不要在主线程中等待锁</li>
<li>RecyclerView的Adapter中不要做耗时操作</li>
<li>复杂的数据处理应该在后台线程完成</li>
</ul>
<hr/>
<h2 data-id="heading-11">三、Broadcast ANR的检测机制</h2>
<p>相比Input ANR的"被动检测"(等事件处理完),Broadcast ANR采用"主动检测"(主动设置超时)。</p>
<h3 data-id="heading-12">3.1 广播分发流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c48bed15aa364a7388b593fb3fa3dbc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=5AJxmL0s40v4PxwnY7YHWuJ7aXs%3D" alt="02-02-broadcast-anr-flow.png" loading="lazy"/></p>
<h3 data-id="heading-13">3.2 超时定时器的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java</span>

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processCurBroadcastLocked</span><span class="hljs-params">(BroadcastRecord r, ProcessRecord app)</span> {
    <span class="hljs-comment">// 1. 设置超时时间</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> r.isForeground() ?
            BROADCAST_FG_TIMEOUT : BROADCAST_BG_TIMEOUT;

    <span class="hljs-comment">// 2. 发送延时消息</span>
    mHandler.sendMessageDelayed(
            mHandler.obtainMessage(BROADCAST_TIMEOUT_MSG, r),
            timeout);

    <span class="hljs-comment">// 3. 调用receiver的onReceive()</span>
    app.thread.scheduleReceiver(...);
}

<span class="hljs-comment">// Handler处理超时消息</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> BROADCAST_TIMEOUT_MSG:
            <span class="hljs-type">BroadcastRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (BroadcastRecord) msg.obj;
            <span class="hljs-comment">// 触发ANR</span>
            broadcastTimeoutLocked(r, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">// 广播执行完毕后取消超时</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performReceiveLocked</span><span class="hljs-params">(ProcessRecord app, ...)</span> {
    <span class="hljs-comment">// 1. 执行完毕</span>
    r.receiver = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 2. 取消超时消息</span>
    mHandler.removeMessages(BROADCAST_TIMEOUT_MSG, r);

    <span class="hljs-comment">// 3. 继续处理下一个广播</span>
    processCurBroadcastLocked(r, app);
}
</code></pre>
<p><strong>关键点</strong>:</p>
<ul>
<li>使用Handler的延时消息实现超时检测</li>
<li>如果在超时前完成,<code>removeMessages()</code>取消定时器</li>
<li>如果超时,Handler收到消息,触发ANR</li>
</ul>
<h3 data-id="heading-14">3.3 前台 vs 后台广播的区别</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 超时时间定义</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BROADCAST_FG_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 10秒</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BROADCAST_BG_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 60秒</span>

<span class="hljs-comment">// 如何判断前台还是后台?</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">isForeground</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 广播发送时指定了FLAG_RECEIVER_FOREGROUND</span>
    <span class="hljs-keyword">if</span> ((intent.getFlags() &amp; Intent.FLAG_RECEIVER_FOREGROUND) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 2. 接收进程是前台进程</span>
    <span class="hljs-keyword">if</span> (app.setAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 3. 有序广播的当前接收者是前台</span>
    <span class="hljs-keyword">if</span> (ordered &amp;&amp; curReceiver.priority &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>实战案例</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 案例:一个耗时的BroadcastReceiver</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// ❌ 错误:在主线程做耗时操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
            <span class="hljs-comment">// 大量计算</span>
        }
        <span class="hljs-comment">// 如果超过10秒,触发ANR</span>
    }
}

<span class="hljs-comment">// ✅ 正确做法:使用goAsync()</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 1. 获取PendingResult</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">PendingResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> goAsync();

        <span class="hljs-comment">// 2. 在子线程处理</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 耗时操作</span>
                doHeavyWork();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 3. 完成后通知系统</span>
                result.finish();
            }
        }).start();
    }
}
</code></pre>
<p><strong>goAsync()的作用</strong>:</p>
<ul>
<li>告诉系统"我需要异步处理,别急着超时"</li>
<li>系统会延长超时时间(但仍有上限)</li>
<li>必须在完成后调用<code>result.finish()</code></li>
</ul>
<hr/>
<h2 data-id="heading-15">四、Service ANR的检测机制</h2>
<p>Service ANR的检测逻辑与Broadcast类似,但更复杂,因为Service有多个生命周期方法需要监控。</p>
<h3 data-id="heading-16">4.1 Service生命周期的超时监控</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>

<span class="hljs-comment">// Service启动超时检测</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bringUpServiceLocked</span><span class="hljs-params">(ServiceRecord r, ...)</span> {
    <span class="hljs-comment">// 1. 设置超时时间</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> r.isForeground() ?
            SERVICE_TIMEOUT : SERVICE_BACKGROUND_TIMEOUT;

    <span class="hljs-comment">// 2. 发送超时消息</span>
    mAm.mHandler.sendMessageDelayed(
            mAm.mHandler.obtainMessage(SERVICE_TIMEOUT_MSG, r),
            timeout);

    <span class="hljs-comment">// 3. 启动Service</span>
    app.thread.scheduleCreateService(r, ...);
}

<span class="hljs-comment">// Service生命周期方法执行完毕</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceDoneExecutingLocked</span><span class="hljs-params">(ServiceRecord r, ...)</span> {
    <span class="hljs-comment">// 1. 取消超时消息</span>
    mAm.mHandler.removeMessages(SERVICE_TIMEOUT_MSG, r);

    <span class="hljs-comment">// 2. 更新Service状态</span>
    r.executeNesting--;
    <span class="hljs-keyword">if</span> (r.executeNesting &lt;= <span class="hljs-number">0</span>) {
        r.executing = <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p><strong>监控的生命周期方法</strong>:</p>
<ul>
<li><code>onCreate()</code>: Service创建</li>
<li><code>onStartCommand()</code>: Service启动</li>
<li><code>onBind()</code>: Service绑定</li>
<li><code>onUnbind()</code>: Service解绑</li>
<li><code>onDestroy()</code>: Service销毁</li>
</ul>
<h3 data-id="heading-17">4.2 前台Service的特殊处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 前台Service的超时时间更短</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SERVICE_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>;       <span class="hljs-comment">// 20秒</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SERVICE_BACKGROUND_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 200秒</span>

<span class="hljs-comment">// 启动前台Service的正确姿势</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        <span class="hljs-comment">// 在onCreate()中尽快调用startForeground()</span>
        <span class="hljs-comment">// 否则可能触发ANR</span>
        <span class="hljs-type">Notification</span> <span class="hljs-variable">notification</span> <span class="hljs-operator">=</span> createNotification();
        startForeground(NOTIFICATION_ID, notification);

        <span class="hljs-comment">// 然后再做其他初始化</span>
        initializeResources();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> {
        <span class="hljs-comment">// 如果有耗时操作,放到子线程</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            doHeavyWork();
        }).start();

        <span class="hljs-keyword">return</span> START_STICKY;
    }
}
</code></pre>
<p><strong>为什么前台Service超时时间短?</strong></p>
<p>因为前台Service通常与用户当前的操作相关(如音乐播放、导航),必须快速启动,否则影响用户体验。</p>
<h3 data-id="heading-18">4.3 IntentService的超时问题</h3>
<p>IntentService是一个特殊的Service,它自带工作线程:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// IntentService的内部实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Looper mServiceLooper;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> ServiceHandler mServiceHandler;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 创建工作线程</span>
        <span class="hljs-type">HandlerThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerThread</span>(<span class="hljs-string">"IntentService["</span> + mName + <span class="hljs-string">"]"</span>);
        thread.start();

        mServiceLooper = thread.getLooper();
        mServiceHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceHandler</span>(mServiceLooper);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> {
        <span class="hljs-comment">// 将任务发送到工作线程</span>
        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mServiceHandler.obtainMessage();
        msg.arg1 = startId;
        msg.obj = intent;
        mServiceHandler.sendMessage(msg);
        <span class="hljs-keyword">return</span> START_REDELIVER_INTENT;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ServiceHandler</span><span class="hljs-params">(Looper looper)</span> {
            <span class="hljs-built_in">super</span>(looper);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
            <span class="hljs-comment">// 在工作线程调用onHandleIntent()</span>
            onHandleIntent((Intent)msg.obj);
            stopSelf(msg.arg1);
        }
    }

    <span class="hljs-comment">// 子类实现这个方法</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(Intent intent)</span>;
}
</code></pre>
<p><strong>重要细节</strong>:</p>
<ul>
<li><code>onStartCommand()</code>在主线程,但很快返回</li>
<li><code>onHandleIntent()</code>在工作线程,可以耗时</li>
<li>不会触发Service ANR,因为主线程方法都很快</li>
</ul>
<p><strong>但是要注意<code>onCreate()</code>!</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误:在onCreate()中初始化耗时资源</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IntentService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 这里仍然在主线程!</span>
        loadLargeDatabase();  <span class="hljs-comment">// 可能触发ANR</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(Intent intent)</span> {
        <span class="hljs-comment">// 这里在工作线程,可以耗时</span>
        processData();
    }
}

<span class="hljs-comment">// ✅ 正确:耗时初始化也放到工作线程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IntentService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 只做轻量级初始化</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onHandleIntent</span><span class="hljs-params">(Intent intent)</span> {
        <span class="hljs-comment">// 第一次调用时再初始化</span>
        <span class="hljs-keyword">if</span> (!initialized) {
            loadLargeDatabase();
            initialized = <span class="hljs-literal">true</span>;
        }
        processData();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、ANR信息的收集与上报</h2>
<p>当InputDispatcher或AMS检测到ANR后,会触发一系列的信息收集操作。这些信息对于分析ANR至关重要。</p>
<h3 data-id="heading-20">5.1 ANR触发和信息搜集流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/788e0de317454e1d92142ac1afa051e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=lbufZe1kQrFeVIcdhM766moZHiM%3D" alt="02-03-anr-collection-flow.png" loading="lazy"/></p>
<h3 data-id="heading-21">5.2 appNotResponding()的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appNotResponding</span><span class="hljs-params">(String activityShortComponentName, ApplicationInfo aInfo,
        String parentShortComponentName, WindowProcessController parentProcess,
        <span class="hljs-type">boolean</span> aboveSystem, String annotation)</span> {

    <span class="hljs-comment">// 1. 防止重复ANR</span>
    <span class="hljs-keyword">synchronized</span> (mService) {
        <span class="hljs-keyword">if</span> (mNotResponding) {
            Slog.w(TAG, <span class="hljs-string">"App already notresponding: "</span> + <span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">return</span>;
        }
        mNotResponding = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 2. 记录ANR信息</span>
        mNotRespondingReport = generateErrorReport(
                annotation, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// 3. 收集CPU使用情况</span>
    updateCpuStatsNow();

    <span class="hljs-comment">// 4. 输出到logcat</span>
    Slog.e(TAG, <span class="hljs-string">"ANR in "</span> + processName + <span class="hljs-string">" ("</span> + activityShortComponentName + <span class="hljs-string">")"</span>);
    Slog.e(TAG, <span class="hljs-string">"PID: "</span> + pid);
    Slog.e(TAG, <span class="hljs-string">"Reason: "</span> + annotation);
    Slog.e(TAG, <span class="hljs-string">"Load: "</span> + loadAverage);
    Slog.e(TAG, <span class="hljs-string">"CPU usage from "</span> + cpuUsageStart + <span class="hljs-string">"ms to "</span> + cpuUsageEnd + <span class="hljs-string">"ms later:"</span>);
    Slog.e(TAG, cpuUsageString);

    <span class="hljs-comment">// 5. dump所有相关线程堆栈</span>
    ArrayList&lt;Integer&gt; firstPids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">5</span>);
    firstPids.add(pid);  <span class="hljs-comment">// ANR进程</span>
    firstPids.add(Process.myPid());  <span class="hljs-comment">// System Server</span>

    <span class="hljs-type">File</span> <span class="hljs-variable">tracesFile</span> <span class="hljs-operator">=</span> ActivityManagerService.dumpStackTraces(
            firstPids, processCpuTracker, ...);

    <span class="hljs-comment">// 6. 写入DropBox</span>
    mService.addErrorToDropBox(<span class="hljs-string">"anr"</span>, <span class="hljs-built_in">this</span>, processName, activityShortComponentName,
            parentShortComponentName, parentProcess, annotation,
            cpuUsageString, tracesFile, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 7. 弹出ANR Dialog</span>
    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain();
    msg.what = ActivityManagerService.SHOW_NOT_RESPONDING_UI_MSG;
    msg.obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppNotRespondingDialog</span>.Data(<span class="hljs-built_in">this</span>, aInfo, aboveSystem);
    mService.mUiHandler.sendMessage(msg);
}
</code></pre>
<h3 data-id="heading-22">5.3 traces.txt的生成</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> File <span class="hljs-title function_">dumpStackTraces</span><span class="hljs-params">(ArrayList&lt;Integer&gt; firstPids,
        ProcessCpuTracker processCpuTracker, ...)</span> {

    <span class="hljs-comment">// 1. 创建traces文件</span>
    <span class="hljs-type">File</span> <span class="hljs-variable">tracesFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"/data/anr/traces.txt"</span>);

    <span class="hljs-comment">// 2. dump第一批进程(ANR进程和System Server)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> pid : firstPids) {
        dumpJavaTracesTombstoned(pid, tracesFile, timeout);
    }

    <span class="hljs-comment">// 3. dump Native进程(如果ANR进程有native线程)</span>
    <span class="hljs-keyword">if</span> (DEBUG_ANR) {
        dumpNativeBacktraceToFile(pid, tracesFile);
    }

    <span class="hljs-comment">// 4. dump其他重要进程</span>
    ArrayList&lt;Integer&gt; extraPids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 4.1 最近使用的3个应用</span>
    <span class="hljs-keyword">if</span> (lastPids != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; lastPids.size() &amp;&amp; i &lt; <span class="hljs-number">3</span>; i++) {
            extraPids.add(lastPids.get(i));
        }
    }

    <span class="hljs-comment">// 4.2 所有persistent进程</span>
    <span class="hljs-keyword">synchronized</span> (mPidsSelfLocked) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mPidsSelfLocked.size(); i++) {
            <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mPidsSelfLocked.valueAt(i);
            <span class="hljs-keyword">if</span> (r.persistent) {
                extraPids.add(r.pid);
            }
        }
    }

    <span class="hljs-comment">// 4.3 dump这些进程</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> pid : extraPids) {
        dumpJavaTracesTombstoned(pid, tracesFile, timeout);
    }

    <span class="hljs-keyword">return</span> tracesFile;
}
</code></pre>
<p><strong>traces.txt的结构</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">----- pid 12345 at 2024-12-25 10:30:15 -----
Cmd line: com.example.app
Build fingerprint: 'google/sdk_gphone_x86_64/generic_x86_64:11/RSR1.201013.001/6903271:user/release-keys'
ABI: 'x86_64'
...

"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">12345</span> nice=-<span class="hljs-number">10</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">15678923456</span> <span class="hljs-number">8765432109</span> <span class="hljs-number">1234</span> ) utm=<span class="hljs-number">1500</span> stm=<span class="hljs-number">67</span>
  at com.example.app.MainActivity.onClick(MainActivity.java:150)
  - waiting to lock &lt;0x0a1b2c3d&gt; (a java.lang.Object) held by thread 15
  at android.view.View.performClick(View.java:7125)
  ...

"Thread-15" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">15</span> Native
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x13579bdf
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">12360</span> nice=<span class="hljs-number">0</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7a4e028800
  at android.os.BinderProxy.transactNative(Native Method)
  - locked &lt;0x0a1b2c3d&gt; (a java.lang.Object)
  at android.os.BinderProxy.transact(Binder.java:1129)
  ...

"Binder:12345_2" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">12</span> Native
  ...

----- end 12345 -----
</code></pre>
<p><strong>关键信息解读</strong>:</p>
<ul>
<li><strong>Cmd line</strong>: 进程名称</li>
<li><strong>tid</strong>: 线程ID</li>
<li><strong>状态</strong>: Blocked/Native/Waiting/Runnable</li>
<li><strong>堆栈</strong>: Java方法调用链</li>
<li><strong>锁信息</strong>: <code>waiting to lock &lt;地址&gt;</code> 或 <code>locked &lt;地址&gt;</code></li>
</ul>
<h3 data-id="heading-23">5.4 DropBox:ANR的"黑匣子"</h3>
<p>DropBox是Android的系统日志服务,专门用于存储系统异常事件:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 写入DropBox</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">addErrorToDropBox</span><span class="hljs-params">(String eventType, ProcessRecord process,
        String processName, String activityShortComponentName, ...)</span> {

    <span class="hljs-comment">// 1. 构建DropBox条目</span>
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">1024</span>);
    sb.append(<span class="hljs-string">"Process: "</span>).append(processName).append(<span class="hljs-string">"\n"</span>);
    sb.append(<span class="hljs-string">"PID: "</span>).append(process.pid).append(<span class="hljs-string">"\n"</span>);
    sb.append(<span class="hljs-string">"Reason: "</span>).append(annotation).append(<span class="hljs-string">"\n"</span>);
    sb.append(<span class="hljs-string">"Load: "</span>).append(loadAverage).append(<span class="hljs-string">"\n"</span>);
    sb.append(cpuUsageString);

    <span class="hljs-comment">// 2. 添加traces内容</span>
    <span class="hljs-keyword">if</span> (tracesFile != <span class="hljs-literal">null</span>) {
        sb.append(<span class="hljs-string">"\n\n*** TRACES ***\n"</span>);
        sb.append(FileUtils.readTextFile(tracesFile, DROPBOX_MAX_SIZE, <span class="hljs-string">"..."</span>));
    }

    <span class="hljs-comment">// 3. 写入DropBox</span>
    <span class="hljs-type">DropBoxManager</span> <span class="hljs-variable">dbox</span> <span class="hljs-operator">=</span> mContext.getSystemService(DropBoxManager.class);
    dbox.addText(eventType, sb.toString());
}
</code></pre>
<p><strong>查看DropBox内容</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有ANR记录</span>
adb shell dumpsys dropbox --<span class="hljs-built_in">print</span> anr

<span class="hljs-comment"># 导出最近的ANR</span>
adb shell dumpsys dropbox --<span class="hljs-built_in">print</span> anr &gt; anr_dropbox.txt

<span class="hljs-comment"># 清空DropBox</span>
adb shell dumpsys dropbox --wipe
</code></pre>
<p><strong>DropBox vs traces.txt</strong>:</p>



































<table><thead><tr><th>特性</th><th>DropBox</th><th>traces.txt</th></tr></thead><tbody><tr><td>存储位置</td><td><code>/data/system/dropbox</code></td><td><code>/data/anr/</code></td></tr><tr><td>存储格式</td><td>结构化条目</td><td>纯文本</td></tr><tr><td>容量限制</td><td>有限(会滚动删除)</td><td>单个文件</td></tr><tr><td>包含信息</td><td>ANR+CPU+内存</td><td>仅线程堆栈</td></tr><tr><td>查看方式</td><td>dumpsys dropbox</td><td>adb pull</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-24">六、ANR Dialog的展示</h2>
<p>ANR检测和信息收集完成后,最终会弹出一个对话框让用户决定如何处理。</p>
<h3 data-id="heading-25">6.1 ANR Dialog的类型</h3>
<p>Android有两种ANR Dialog:</p>
<p><strong>1. 应用ANR Dialog</strong>(普通应用):</p>
<pre><code class="hljs language-css" lang="css">─────────────────────────────
│  应用无响应                  │
│                            │
│  "XX"未响应。               │
│                            │
│  您要关闭它吗?               │
│                            │
│  <span class="hljs-selector-attr">[等待]</span>  <span class="hljs-selector-attr">[关闭应用]</span>          │
─────────────────────────────
</code></pre>
<p><strong>2. 系统ANR Dialog</strong>(系统应用或System Server):</p>
<pre><code class="hljs language-css" lang="css">─────────────────────────────
│  系统未响应                 │
│                            │
│  "System UI"未响应。        │
│                            │
│  <span class="hljs-selector-attr">[等待]</span>  <span class="hljs-selector-attr">[确定]</span>             │
─────────────────────────────
</code></pre>
<h3 data-id="heading-26">6.2 Dialog的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/AppNotRespondingDialog.java</span>

<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppNotRespondingDialog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseErrorDialog</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActivityManagerService mService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProcessRecord mProc;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AppNotRespondingDialog</span><span class="hljs-params">(ActivityManagerService service,
            Context context, Data data)</span> {
        <span class="hljs-built_in">super</span>(context);

        mService = service;
        mProc = data.proc;

        <span class="hljs-comment">// 1. 设置Dialog标题</span>
        setTitle(context.getText(com.android.internal.R.string.anr_title));

        <span class="hljs-comment">// 2. 设置消息内容</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        msg.append(context.getString(com.android.internal.R.string.anr_activity_application,
                data.aInfo.loadLabel(context.getPackageManager()).toString(),
                data.proc.info.processName));

        setMessage(msg);

        <span class="hljs-comment">// 3. 设置按钮</span>
        setCancelable(<span class="hljs-literal">false</span>);

        <span class="hljs-comment">// "等待"按钮</span>
        setButton(DialogInterface.BUTTON_POSITIVE,
                context.getText(com.android.internal.R.string.wait),
                mHandler.obtainMessage(WAIT));

        <span class="hljs-comment">// "关闭应用"按钮</span>
        setButton(DialogInterface.BUTTON_NEGATIVE,
                context.getText(com.android.internal.R.string.force_close),
                mHandler.obtainMessage(FORCE_CLOSE));

        <span class="hljs-comment">// "报告"按钮(可选)</span>
        <span class="hljs-keyword">if</span> (data.proc.errorReportReceiver != <span class="hljs-literal">null</span>) {
            setButton(DialogInterface.BUTTON_NEUTRAL,
                    context.getText(com.android.internal.R.string.report),
                    mHandler.obtainMessage(APP_INFO));
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
            <span class="hljs-keyword">switch</span> (msg.what) {
                <span class="hljs-keyword">case</span> WAIT:
                    <span class="hljs-comment">// 用户选择等待,关闭Dialog</span>
                    mService.mUiHandler.sendEmptyMessage(DISMISS_DIALOG);
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> FORCE_CLOSE:
                    <span class="hljs-comment">// 用户选择关闭,杀死应用</span>
                    mService.killAppAtUsersRequest(mProc, AppNotRespondingDialog.<span class="hljs-built_in">this</span>);
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> APP_INFO:
                    <span class="hljs-comment">// 用户选择报告,打开应用信息页</span>
                    mService.mUiHandler.obtainMessage(SHOW_APP_ERROR_REPORT, mProc)
                            .sendToTarget();
                    <span class="hljs-keyword">break</span>;
            }
        }
    };
}
</code></pre>
<h3 data-id="heading-27">6.3 用户操作的后续处理</h3>
<p><strong>用户选择"等待"</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 什么都不做,只是关闭Dialog</span>
<span class="hljs-comment">// ANR进程继续运行</span>
<span class="hljs-comment">// 如果还是没响应,可能再次触发ANR</span>
</code></pre>
<p><strong>用户选择"关闭应用"</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">killAppAtUsersRequest</span><span class="hljs-params">(ProcessRecord app, Dialog fromDialog)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        <span class="hljs-comment">// 1. 标记为用户主动关闭</span>
        app.crashing = <span class="hljs-literal">false</span>;
        app.crashingReport = <span class="hljs-literal">null</span>;
        app.notResponding = <span class="hljs-literal">false</span>;
        app.notRespondingReport = <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 2. 杀死进程</span>
        Process.killProcess(app.pid);

        <span class="hljs-comment">// 3. 清理进程记录</span>
        handleAppDiedLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<p><strong>用户选择"报告"</strong>(某些系统):</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 打开Feedback或BugReport应用</span>
<span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-string">"android.intent.action.APP_ERROR"</span>);
intent.putExtra(<span class="hljs-string">"error_type"</span>, <span class="hljs-string">"anr"</span>);
intent.putExtra(<span class="hljs-string">"package_name"</span>, app.info.packageName);
intent.putExtra(<span class="hljs-string">"process_name"</span>, app.processName);
intent.putExtra(<span class="hljs-string">"pid"</span>, app.pid);
context.startActivity(intent);
</code></pre>
<hr/>
<h2 data-id="heading-28">七、ANR分析实战</h2>
<p>理论讲了这么多,让我们通过几个真实案例,看看如何实战分析ANR。</p>
<h3 data-id="heading-29">7.1 案例1:主线程等锁导致的ANR</h3>
<p><strong>现象</strong>: 用户点击按钮后,应用卡住5秒,弹出ANR</p>
<p><strong>logcat日志</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">12-25 10:30:15.123  1234  1250 E InputDispatcher: Application is not responding: AppWindowToken{e8d3a72 token=Token{b6c7d3e ActivityRecord{a9f8e1d u0 com.example/.MainActivity}}}
12-25 10:30:15.234  1234  1250 I ActivityManager: ANR in com.example.app (com.example.app/.MainActivity)
12-25 10:30:15.234  1234  1250 I ActivityManager: PID: 12345
12-25 10:30:15.234  1234  1250 I ActivityManager: Reason: Input dispatching timed out (Waiting to send non-key event because the touched window has not finished processing certain input events that were delivered to it over 500.0ms ago.  Wait queue length: 1.)
</code></pre>
<p><strong>traces.txt分析</strong>:</p>
<pre><code class="hljs language-php" lang="php">----- pid <span class="hljs-number">12345</span> at <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">25</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">15</span> -----
Cmd line: com.example.app

<span class="hljs-string">"main"</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | group=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x74e04dd8</span>
  | sysTid=<span class="hljs-number">12345</span> nice=-<span class="hljs-number">10</span> cgrp=<span class="hljs-keyword">default</span> sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0x7b5a9f49a8</span>
  | state=S schedstat=( <span class="hljs-number">15678923456</span> <span class="hljs-number">8765432109</span> <span class="hljs-number">1234</span> ) utm=<span class="hljs-number">1500</span> stm=<span class="hljs-number">67</span>
  at com.example.app.DataManager.<span class="hljs-title function_ invoke__">getData</span>(DataManager.<span class="hljs-attr">java</span>:<span class="hljs-number">45</span>)
  - waiting to lock &lt;<span class="hljs-number">0x0a1b2c3d</span>&gt; (a java.lang.Object) held by thread <span class="hljs-number">15</span>
  at com.example.app.MainActivity.<span class="hljs-title function_ invoke__">onClick</span>(MainActivity.<span class="hljs-attr">java</span>:<span class="hljs-number">100</span>)
  at android.view.View.<span class="hljs-title function_ invoke__">performClick</span>(View.<span class="hljs-attr">java</span>:<span class="hljs-number">7125</span>)
  at android.view.View.<span class="hljs-title function_ invoke__">performClickInternal</span>(View.<span class="hljs-attr">java</span>:<span class="hljs-number">7102</span>)
  at android.view.View.access$<span class="hljs-number">3500</span>(View.java:<span class="hljs-number">801</span>)
  at android.view.View<span class="hljs-variable">$PerformClick</span>.<span class="hljs-title function_ invoke__">run</span>(View.<span class="hljs-attr">java</span>:<span class="hljs-number">27851</span>)
  at android.os.Handler.<span class="hljs-title function_ invoke__">handleCallback</span>(Handler.<span class="hljs-attr">java</span>:<span class="hljs-number">883</span>)
  at android.os.Handler.<span class="hljs-title function_ invoke__">dispatchMessage</span>(Handler.<span class="hljs-attr">java</span>:<span class="hljs-number">100</span>)
  at android.os.Looper.<span class="hljs-title function_ invoke__">loop</span>(Looper.<span class="hljs-attr">java</span>:<span class="hljs-number">214</span>)
  at android.app.ActivityThread.<span class="hljs-title function_ invoke__">main</span>(ActivityThread.<span class="hljs-attr">java</span>:<span class="hljs-number">7356</span>)
  ...

<span class="hljs-string">"Thread-15"</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">15</span> Native
  | group=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x13579bdf</span>
  | sysTid=<span class="hljs-number">12360</span> nice=<span class="hljs-number">0</span> cgrp=<span class="hljs-keyword">default</span> sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0x7a4e028800</span>
  | state=S schedstat=( <span class="hljs-number">9876543210</span> <span class="hljs-number">5432109876</span> <span class="hljs-number">123</span> ) utm=<span class="hljs-number">900</span> stm=<span class="hljs-number">87</span>
  at android.os.BinderProxy.<span class="hljs-title function_ invoke__">transactNative</span>(Native Method)
  at android.os.BinderProxy.<span class="hljs-title function_ invoke__">transact</span>(Binder.<span class="hljs-attr">java</span>:<span class="hljs-number">1129</span>)
  - locked &lt;<span class="hljs-number">0x0a1b2c3d</span>&gt; (a java.lang.Object)
  at android.content.IContentProvider$Stub<span class="hljs-variable">$Proxy</span>.<span class="hljs-title function_ invoke__">query</span>(IContentProvider.<span class="hljs-attr">java</span>:xxx)
  at android.content.ContentResolver.<span class="hljs-title function_ invoke__">query</span>(ContentResolver.<span class="hljs-attr">java</span>:xxx)
  at com.example.app.DataManager.<span class="hljs-title function_ invoke__">loadFromDatabase</span>(DataManager.<span class="hljs-attr">java</span>:<span class="hljs-number">80</span>)
  at com.example.app.DataManager$<span class="hljs-number">1</span>.<span class="hljs-title function_ invoke__">run</span>(DataManager.<span class="hljs-attr">java</span>:<span class="hljs-number">60</span>)
  ...
</code></pre>
<p><strong>分析步骤</strong>:</p>
<ol>
<li><strong>看主线程状态</strong>: <code>Blocked</code> - 主线程被阻塞了</li>
<li><strong>看阻塞位置</strong>: <code>DataManager.getData()</code>第45行,在等一个锁<code>&lt;0x0a1b2c3d&gt;</code></li>
<li><strong>找持锁线程</strong>: Thread-15持有这个锁(<code>locked &lt;0x0a1b2c3d&gt;</code>)</li>
<li><strong>看持锁线程在干嘛</strong>: 正在进行Binder调用<code>transactNative()</code>,查询ContentProvider</li>
<li><strong>根本原因</strong>: 线程15持锁做耗时操作,主线程等不到锁</li>
</ol>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 原代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 主线程调用</span>
        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> getData();
            updateUI(data);
        }
    }

    <span class="hljs-keyword">private</span> Data <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 还是在持锁状态!</span>
        <span class="hljs-keyword">return</span> loadFromDatabase();  <span class="hljs-comment">// Binder调用,很慢</span>
    }
}

<span class="hljs-comment">// ✅ 修复后</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 异步加载</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            Data data;
            <span class="hljs-keyword">synchronized</span> (mLock) {
                data = getData();
            }
            <span class="hljs-comment">// 在主线程更新UI</span>
            runOnUiThread(() -&gt; updateUI(data));
        }).start();
    }
}
</code></pre>
<h3 data-id="heading-30">7.2 案例2:Binder调用超时导致的ANR</h3>
<p><strong>现象</strong>: 应用在后台,突然收到Broadcast ANR</p>
<p><strong>logcat</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">12-25 11:00:00.123  1234  1250 W BroadcastQueue: Timeout of broadcast BroadcastRecord{a1b2c3d u0 android.intent.action.BATTERY_CHANGED} - <span class="hljs-attr">receiver</span>=android.content.IIntentReceiver<span class="hljs-variable">$Stub</span><span class="hljs-variable">$Proxy</span>@e4f5g6h
12-25 11:00:00.234  1234  1250 I ActivityManager: ANR in com.example.app (com.example.app/.MyReceiver)
12-25 11:00:00.234  1234  1250 I ActivityManager: Reason: Broadcast of Intent { <span class="hljs-attr">act</span>=android.intent.action.BATTERY_CHANGED }
</code></pre>
<p><strong>traces.txt</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Native
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">23456</span> nice=<span class="hljs-number">0</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">2345678901</span> <span class="hljs-number">1234567890</span> <span class="hljs-number">234</span> ) utm=<span class="hljs-number">200</span> stm=<span class="hljs-number">34</span>
  at android.os.BinderProxy.transactNative(Native Method)
  at android.os.BinderProxy.transact(Binder.java:1129)
  at android.app.IActivityManager$Stub$Proxy.registerContentObserver(IActivityManager.java:xxxx)
  at android.content.ContentResolver.registerContentObserver(ContentResolver.java:xxxx)
  at com.example.app.MyReceiver.onReceive(MyReceiver.java:30)
  at android.app.ActivityThread.handleReceiver(ActivityThread.java:xxxx)
  ...
</code></pre>
<p><strong>分析</strong>:</p>
<ol>
<li><strong>ANR类型</strong>: Broadcast ANR</li>
<li><strong>主线程状态</strong>: <code>Native</code> - 正在执行Native方法</li>
<li><strong>卡在哪里</strong>: <code>BinderProxy.transactNative()</code> - Binder调用</li>
<li><strong>在做什么</strong>: 注册ContentObserver</li>
<li><strong>为什么慢</strong>: 可能System Server繁忙或Binder资源耗尽</li>
</ol>
<p><strong>根因</strong>: 在BroadcastReceiver中进行同步Binder调用,而System Server响应慢</p>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 原代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 同步注册ContentObserver,可能很慢</span>
        context.getContentResolver().registerContentObserver(
                Settings.System.getUriFor(Settings.System.SCREEN_BRIGHTNESS),
                <span class="hljs-literal">false</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentObserver</span>(<span class="hljs-literal">null</span>) {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onChange</span><span class="hljs-params">(<span class="hljs-type">boolean</span> selfChange)</span> {
                        <span class="hljs-comment">// ...</span>
                    }
                });
    }
}

<span class="hljs-comment">// ✅ 修复方案1:使用goAsync()</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">PendingResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> goAsync();

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                context.getContentResolver().registerContentObserver(...);
            } <span class="hljs-keyword">finally</span> {
                result.finish();
            }
        }).start();
    }
}

<span class="hljs-comment">// ✅ 修复方案2:延迟注册</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BroadcastReceiver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 启动Service延迟注册</span>
        <span class="hljs-type">Intent</span> <span class="hljs-variable">serviceIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(context, RegistrationService.class);
        context.startService(serviceIntent);
    }
}
</code></pre>
<h3 data-id="heading-31">7.3 案例3:主线程做数据库操作</h3>
<p><strong>traces.txt</strong>:</p>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">main</span>" <span class="hljs-selector-tag">prio</span>=<span class="hljs-number">5</span> <span class="hljs-selector-tag">tid</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">Native</span>
  | <span class="hljs-selector-tag">sysTid</span>=<span class="hljs-number">34567</span> <span class="hljs-selector-tag">nice</span>=<span class="hljs-selector-tag">-10</span>
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteConnection</span><span class="hljs-selector-class">.nativeExecute</span>(Native Method)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteConnection</span><span class="hljs-selector-class">.execute</span>(SQLiteConnection.<span class="hljs-attribute">java</span>:<span class="hljs-number">609</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteSession</span><span class="hljs-selector-class">.executeForCursorWindow</span>(SQLiteSession.<span class="hljs-attribute">java</span>:<span class="hljs-number">820</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteQuery</span><span class="hljs-selector-class">.fillWindow</span>(SQLiteQuery.<span class="hljs-attribute">java</span>:<span class="hljs-number">62</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteCursor</span><span class="hljs-selector-class">.fillWindow</span>(SQLiteCursor.<span class="hljs-attribute">java</span>:<span class="hljs-number">144</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.database</span><span class="hljs-selector-class">.sqlite</span><span class="hljs-selector-class">.SQLiteCursor</span><span class="hljs-selector-class">.getCount</span>(SQLiteCursor.<span class="hljs-attribute">java</span>:<span class="hljs-number">134</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.DatabaseHelper</span><span class="hljs-selector-class">.queryAllRecords</span>(DatabaseHelper.<span class="hljs-attribute">java</span>:<span class="hljs-number">150</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.MainActivity</span><span class="hljs-selector-class">.onCreate</span>(MainActivity.<span class="hljs-attribute">java</span>:<span class="hljs-number">50</span>)
  ...
</code></pre>
<p><strong>分析</strong>:</p>
<ul>
<li>主线程在执行SQLite查询</li>
<li><code>getCount()</code>会加载所有数据到Cursor</li>
<li>数据量大时会很慢</li>
</ul>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 原代码</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    <span class="hljs-comment">// 主线程查询数据库</span>
    <span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> mDbHelper.queryAllRecords();
    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> cursor.getCount();  <span class="hljs-comment">// 触发实际查询</span>
    processData(cursor);
}

<span class="hljs-comment">// ✅ 使用AsyncTask(已废弃,仅作示例)</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryTask</span>().execute();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncTask</span>&lt;Void, Void, Cursor&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Cursor <span class="hljs-title function_">doInBackground</span><span class="hljs-params">(Void... voids)</span> {
        <span class="hljs-keyword">return</span> mDbHelper.queryAllRecords();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPostExecute</span><span class="hljs-params">(Cursor cursor)</span> {
        processData(cursor);
    }
}

<span class="hljs-comment">// ✅ 使用Kotlin Coroutines(推荐)</span>
override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)
    setContentView(R.layout.activity_main)

    lifecycleScope.launch {
        <span class="hljs-type">val</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> withContext(Dispatchers.IO) {
            dbHelper.queryAllRecords()
        }
        processData(cursor)
    }
}

<span class="hljs-comment">// ✅ 使用Room + LiveData(最佳实践)</span>
<span class="hljs-meta">@Dao</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RecordDao</span> {
    <span class="hljs-meta">@Query("SELECT * FROM records")</span>
    fun <span class="hljs-title function_">getAllRecords</span><span class="hljs-params">()</span>: LiveData&lt;List&lt;Record&gt;&gt;
}

override fun <span class="hljs-title function_">onCreate</span><span class="hljs-params">(savedInstanceState: Bundle?)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState)
    setContentView(R.layout.activity_main)

    viewModel.records.observe(<span class="hljs-built_in">this</span>) { records -&gt;
        processData(records)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-32">八、ANR的预防和监控</h2>
<p>预防胜于治疗。让我们看看如何在开发阶段就避免ANR,以及如何建立有效的监控体系。</p>
<h3 data-id="heading-33">8.1 开发阶段的预防措施</h3>
<p><strong>1. 使用StrictMode检测主线程违规</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            StrictMode.setThreadPolicy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMode</span>.ThreadPolicy.Builder()
                    .detectDiskReads()    <span class="hljs-comment">// 检测磁盘读取</span>
                    .detectDiskWrites()   <span class="hljs-comment">// 检测磁盘写入</span>
                    .detectNetwork()      <span class="hljs-comment">// 检测网络操作</span>
                    .detectCustomSlowCalls()  <span class="hljs-comment">// 检测自定义慢调用</span>
                    .penaltyLog()         <span class="hljs-comment">// 输出到logcat</span>
                    .penaltyDeath()       <span class="hljs-comment">// 直接crash(开发阶段)</span>
                    .build());

            StrictMode.setVmPolicy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMode</span>.VmPolicy.Builder()
                    .detectLeakedSqlLiteObjects()  <span class="hljs-comment">// 检测数据库泄漏</span>
                    .detectLeakedClosableObjects() <span class="hljs-comment">// 检测未关闭的对象</span>
                    .penaltyLog()
                    .build());
        }
    }
}
</code></pre>
<p><strong>2. 使用BlockCanary检测卡顿</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 初始化BlockCanary</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        BlockCanary.install(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppBlockCanaryContext</span>()).start();
    }
}

<span class="hljs-comment">// 自定义配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppBlockCanaryContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BlockCanaryContext</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">provideBlockThreshold</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">500</span>;  <span class="hljs-comment">// 超过500ms判定为卡顿</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">displayNotification</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> BuildConfig.DEBUG;  <span class="hljs-comment">// 仅debug环境显示通知</span>
    }
}
</code></pre>
<p><strong>3. 使用TraceView分析性能</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在可疑代码前后添加trace</span>
Debug.startMethodTracing(<span class="hljs-string">"my_trace"</span>);
<span class="hljs-comment">// 可疑的代码</span>
suspiciousMethod();
Debug.stopMethodTracing();

<span class="hljs-comment">// 导出trace文件</span>
adb pull /sdcard/Android/data/&lt;<span class="hljs-keyword">package</span>&gt;/files/my_trace.trace .

<span class="hljs-comment">// 使用Android Studio的Profiler分析</span>
</code></pre>
<h3 data-id="heading-34">8.2 线上监控体系</h3>
<p><strong>1. ANR捕获和上报</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ANRWatchDog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mTimeout;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Handler</span> <span class="hljs-variable">mHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(Looper.getMainLooper());

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ANRWatchDog</span><span class="hljs-params">(<span class="hljs-type">int</span> timeout)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"ANR-WatchDog"</span>);
        <span class="hljs-built_in">this</span>.mTimeout = timeout;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!isInterrupted()) {
            <span class="hljs-comment">// 1. 记录当前时间</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">executionTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>();

            <span class="hljs-comment">// 2. 向主线程发送任务</span>
            mHandler.post(() -&gt; {
                executionTime.set(System.currentTimeMillis());
            });

            <span class="hljs-comment">// 3. 等待一段时间</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(mTimeout);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// 4. 检查任务是否执行</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">execTime</span> <span class="hljs-operator">=</span> executionTime.get();
            <span class="hljs-keyword">if</span> (execTime == <span class="hljs-number">0</span> || System.currentTimeMillis() - execTime &gt; mTimeout) {
                <span class="hljs-comment">// 检测到ANR!</span>
                onAnrDetected();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnrDetected</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 收集堆栈信息</span>
        Map&lt;Thread, StackTraceElement[]&gt; stackTraces = Thread.getAllStackTraces();

        <span class="hljs-comment">// 2. 上报到服务器</span>
        ANRReporter.report(stackTraces);
    }
}

<span class="hljs-comment">// 启动监控</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ANRWatchDog</span>(<span class="hljs-number">5000</span>).start();
</code></pre>
<p><strong>2. 使用Bugly等第三方平台</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();

        <span class="hljs-comment">// 初始化Bugly</span>
        CrashReport.initCrashReport(getApplicationContext(), <span class="hljs-string">"YOUR_APP_ID"</span>, BuildConfig.DEBUG);

        <span class="hljs-comment">// 配置ANR监控</span>
        CrashReport.<span class="hljs-type">UserStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CrashReport</span>.UserStrategy(getApplicationContext());
        strategy.setAppReportDelay(<span class="hljs-number">10000</span>);  <span class="hljs-comment">// 延迟上报</span>
        CrashReport.initCrashReport(getApplicationContext(), <span class="hljs-string">"YOUR_APP_ID"</span>, BuildConfig.DEBUG, strategy);
    }
}
</code></pre>
<p><strong>3. 监控关键指标</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
    <span class="hljs-comment">// 监控主线程消息处理时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorMainLooper</span><span class="hljs-params">()</span> {
        Looper.getMainLooper().setMessageLogging(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Printer</span>() {
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">START</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching"</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">END</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished"</span>;

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">println</span><span class="hljs-params">(String msg)</span> {
                <span class="hljs-keyword">if</span> (msg.startsWith(START)) {
                    <span class="hljs-comment">// 消息开始处理</span>
                    mStartTime = System.currentTimeMillis();
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.startsWith(END)) {
                    <span class="hljs-comment">// 消息处理完毕</span>
                    <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - mStartTime;
                    <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">100</span>) {  <span class="hljs-comment">// 超过100ms</span>
                        <span class="hljs-comment">// 记录慢消息</span>
                        logSlowMessage(msg, duration);
                    }
                }
            }
        });
    }

    <span class="hljs-comment">// 监控方法执行时间</span>
    <span class="hljs-meta">@Around("execution(* com.example.app..*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">measureMethod</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">50</span>) {  <span class="hljs-comment">// 超过50ms</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> joinPoint.getSignature().toShortString();
            Log.w(<span class="hljs-string">"Performance"</span>, method + <span class="hljs-string">" took "</span> + duration + <span class="hljs-string">"ms"</span>);
        }

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-35">8.3 ANR优化的最佳实践</h3>
<p><strong>1. 主线程的黄金法则</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">主线程只做三件事:
<span class="hljs-bullet">1.</span> 更新UI
<span class="hljs-bullet">2.</span> 分发事件
<span class="hljs-bullet">3.</span> 启动异步任务

绝对不能做:
<span class="hljs-bullet">1.</span> 磁盘I/O (读写文件、数据库)
<span class="hljs-bullet">2.</span> 网络I/O (HTTP请求、Socket通信)
<span class="hljs-bullet">3.</span> 复杂计算 (大数据处理、加密解密)
<span class="hljs-bullet">4.</span> 同步Binder调用 (ContentProvider、System Service)
<span class="hljs-bullet">5.</span> 等待锁 (synchronized、Lock)
</code></pre>
<p><strong>2. 使用异步机制</strong></p>








































<table><thead><tr><th>场景</th><th>推荐方案</th><th>示例</th></tr></thead><tbody><tr><td>简单异步任务</td><td><code>HandlerThread</code> + <code>Handler</code></td><td>后台数据处理</td></tr><tr><td>生命周期感知</td><td><code>ViewModel</code> + <code>LiveData</code></td><td>UI数据加载</td></tr><tr><td>复杂协程</td><td>Kotlin <code>Coroutines</code></td><td>网络请求+数据库</td></tr><tr><td>定时任务</td><td><code>WorkManager</code></td><td>定期同步</td></tr><tr><td>文件I/O</td><td><code>Executors.newSingleThreadExecutor()</code></td><td>日志写入</td></tr><tr><td>数据库</td><td><code>Room</code> + <code>LiveData</code></td><td>本地数据访问</td></tr></tbody></table>
<p><strong>3. 优化Binder调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 主线程同步调用ContentProvider</span>
<span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> getContentResolver().query(uri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// ✅ 使用ContentProviderOperation批量操作</span>
ArrayList&lt;ContentProviderOperation&gt; ops = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
ops.add(ContentProviderOperation.newInsert(uri).withValues(values1).build());
ops.add(ContentProviderOperation.newInsert(uri).withValues(values2).build());
getContentResolver().applyBatch(AUTHORITY, ops);

<span class="hljs-comment">// ✅ 使用AsyncQueryHandler异步查询</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncQueryHandler</span>(getContentResolver()) {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onQueryComplete</span><span class="hljs-params">(<span class="hljs-type">int</span> token, Object cookie, Cursor cursor)</span> {
        processData(cursor);
    }
}.startQuery(<span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, uri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
</code></pre>
<p><strong>4. 减少锁竞争</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 粗粒度锁</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Data&gt; mCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Data <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> mCache.get(key);
        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
            data = loadFromDisk(key);  <span class="hljs-comment">// 耗时操作在持锁状态!</span>
            mCache.put(key, data);
        }
        <span class="hljs-keyword">return</span> data;
    }
}

<span class="hljs-comment">// ✅ 细粒度锁 + Double-Check</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Data&gt; mCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-keyword">public</span> Data <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">Data</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> mCache.get(key);
        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (mLock) {
                data = mCache.get(key);
                <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
                    data = loadFromDisk(key);  <span class="hljs-comment">// 只有必要时才持锁</span>
                    mCache.put(key, data);
                }
            }
        }
        <span class="hljs-keyword">return</span> data;
    }
}

<span class="hljs-comment">// ✅ 使用Lock + tryLock避免死等</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">mLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-keyword">public</span> Data <span class="hljs-title function_">get</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">if</span> (mLock.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> loadData(key);
            } <span class="hljs-keyword">finally</span> {
                mLock.unlock();
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 获取锁失败,返回默认值或异步加载</span>
            <span class="hljs-keyword">return</span> getDefaultValue();
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-36">九、总结与展望</h2>
<p>让我们回顾一下ANR机制的全貌:</p>
<h3 data-id="heading-37">9.1 核心要点回顾</h3>
<p><strong>ANR的4种类型</strong>:</p>
<ul>
<li><strong>Input ANR</strong>: 5秒无响应,由InputDispatcher检测</li>
<li><strong>Broadcast ANR</strong>: 10秒/60秒,由ActivityManagerService检测</li>
<li><strong>Service ANR</strong>: 20秒/200秒,由ActivityManagerService检测</li>
<li><strong>ContentProvider ANR</strong>: 10秒,由ActivityManagerService检测</li>
</ul>
<p><strong>ANR检测机制</strong>:</p>
<ul>
<li><strong>Input</strong>: 事件入队时记录时间戳,定时检查waitQueue</li>
<li><strong>Broadcast/Service</strong>: 发送延时消息,超时触发Handler回调</li>
</ul>
<p><strong>ANR处理流程</strong>:</p>
<pre><code class="hljs language-scss" lang="scss">检测超时 → 调用<span class="hljs-built_in">appNotResponding</span>() → 收集CPU/内存信息
→ dump线程堆栈 → 生成traces<span class="hljs-selector-class">.txt</span> → 写入DropBox → 弹出Dialog
</code></pre>
<p><strong>traces.txt的关键信息</strong>:</p>
<ul>
<li>线程状态: Blocked/Waiting/Native/Runnable</li>
<li>堆栈信息: 方法调用链</li>
<li>锁信息: waiting to lock / locked</li>
</ul>
<h3 data-id="heading-38">9.2 ANR优化的金字塔</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3e30c9a4a74efeaddc3eae26e4549c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767424897&amp;x-signature=1MwwEhjyYQaL15IFWwUlZYM5dMY%3D" alt="02-04-anr-prevention-priority.png" loading="lazy"/></p>
<h3 data-id="heading-39">9.3 实战建议</h3>
<ol>
<li>
<p><strong>开发阶段</strong>:</p>
<ul>
<li>开启StrictMode</li>
<li>使用BlockCanary</li>
<li>Code Review关注主线程操作</li>
</ul>
</li>
<li>
<p><strong>测试阶段</strong>:</p>
<ul>
<li>压力测试</li>
<li>Monkey测试</li>
<li>性能测试(TraceView、Systrace)</li>
</ul>
</li>
<li>
<p><strong>线上阶段</strong>:</p>
<ul>
<li>接入Bugly等监控平台</li>
<li>定期分析ANR Top榜</li>
<li>建立ANR快速响应机制</li>
</ul>
</li>
</ol>
<h3 data-id="heading-40">9.4 后续文章预告</h3>
<p>ANR机制只是稳定性的一个方面。在后续文章中,我们将继续深入:</p>



































<table><thead><tr><th>文章</th><th>主题</th><th>核心内容</th></tr></thead><tbody><tr><td>第3篇</td><td>ANR问题排查实战</td><td>traces.txt深度解读、Systrace分析、常见ANR案例</td></tr><tr><td>第4篇</td><td>异常日志机制</td><td>Crash处理、Tombstone分析、信号机制</td></tr><tr><td>第5篇</td><td>Native Crash深度分析</td><td>debuggerd、符号化、coredump</td></tr><tr><td>第6篇</td><td>Java异常与JE分析实战</td><td>Java异常的分析实战</td></tr><tr><td>第7篇</td><td>Watchdog机制</td><td>系统看门狗、半死锁检测、System Server保护</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-41">参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Fperformance%2Fvitals%2Fanr" target="_blank" title="https://developer.android.com/topic/performance/vitals/anr" ref="nofollow noopener noreferrer">Android官方文档 - ANR</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fnative%2Fservices%2Finputflinger%2Fdispatcher%2FInputDispatcher.cpp" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/native/services/inputflinger/dispatcher/InputDispatcher.cpp" ref="nofollow noopener noreferrer">AOSP源码 - InputDispatcher.cpp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fam%2FActivityManagerService.java" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java" ref="nofollow noopener noreferrer">AOSP源码 - ActivityManagerService.java</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fam%2FBroadcastQueue.java" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java" ref="nofollow noopener noreferrer">AOSP源码 - BroadcastQueue.java</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fplaylist%3Flist%3DPLWz5rJ2EKKc9CBxr3BVjPTPoDPLdPIFCE" target="_blank" title="https://www.youtube.com/playlist?list=PLWz5rJ2EKKc9CBxr3BVjPTPoDPLdPIFCE" ref="nofollow noopener noreferrer">Android Performance Patterns</a></li>
</ol>
<p><strong>上一篇</strong>：<a href="https://juejin.cn/post/7587776610436497423" target="_blank" title="https://juejin.cn/post/7587776610436497423">稳定性性能系列之一——Android稳定性基础:系统架构与关键机制</a><br/>
<strong>下一篇</strong>：<a href="https://juejin.cn/post/7588004601392906274" target="_blank" title="https://juejin.cn/post/7588004601392906274">稳定性性能系列之三——ANR问题排查实战:日志分析与工具实战</a><br/>
<strong>返回专栏目录</strong>: <a href="https://juejin.cn/post/7587473691170095104" target="_blank" title="https://juejin.cn/post/7587473691170095104">Android稳定性&amp;性能深入理解专栏介绍</a></p>
<hr/>
<blockquote>
<p><strong>作者简介</strong>: 多年Android系统开发经验,专注于系统稳定性与性能优化领域。欢迎关注本系列,一起深入Android系统的精彩世界!</p>
</blockquote>
<hr/>
<h3 data-id="heading-42">🎉 感谢关注,让我们一起深入Android系统的精彩世界!     找到我: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a></h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java的类加载过程]]></title>    <link>https://juejin.cn/post/7588067055481880585</link>    <guid>https://juejin.cn/post/7588067055481880585</guid>    <pubDate>2025-12-27T08:27:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588067055481880585" data-draft-id="7588031908172251145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java的类加载过程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T08:27:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevinzeng"/> <meta itemprop="url" content="https://juejin.cn/user/1964143993949127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java的类加载过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1964143993949127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevinzeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:27:48.000Z" title="Sat Dec 27 2025 08:27:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java 类加载全过程（完整+易懂版，含底层原理）</h2>
<p>Java 类加载是 <strong>JVM 将</strong> <strong><code>.class</code></strong> <strong>字节码文件加载到内存，并对其进行验证、准备、解析、初始化，最终形成可被 JVM 直接使用的 Java 类型</strong> 的全过程。这个过程发生在<strong>程序运行期间（动态加载）</strong> ，而非编译期，是 JVM 实现「跨平台」「动态扩展」的核心基础。</p>
<p>✅ 核心结论：Java 类加载流程遵循 <strong>「加载 → 验证 → 准备 → 解析 → 初始化」</strong> 5个固定阶段，其中「解析」阶段可穿插至「初始化」之后执行，整体严格按顺序推进，缺一不可。</p>
<h3 data-id="heading-1">一、类加载整体生命周期（全流程总览）</h3>
<p>一个 Java 类从被加载到 JVM 内存中，到最终被卸载，完整的生命周期包含 <strong>7个阶段</strong>，其中<strong>前5个是「类加载的核心流程」</strong>，后2个是类加载完成后的运行与销毁阶段，整体流程如下：</p>
<pre><code class="hljs">加载 → 验证 → 准备 → 解析 → 初始化 → 使用 → 卸载
</code></pre>
<p>💡 关键特性：</p>
<ol>
<li>加载、验证、准备、初始化、卸载 <strong>5个阶段的执行顺序是固定的</strong>，必须按序推进；</li>
<li><strong>解析阶段是灵活的</strong>：可以在「准备阶段后」立即执行（静态绑定），也可以延迟到「初始化阶段后」执行（动态绑定/晚期绑定），目的是支持 Java 的多态特性。</li>
</ol>
<h3 data-id="heading-2">二、类加载核心5阶段（逐阶段详解，附底层逻辑）</h3>
<h4 data-id="heading-3">✅ 阶段1：加载（Loading）—— 「找文件、读数据、建对象」</h4>
<p>这是类加载的<strong>第一个阶段</strong>，由 JVM 的「类加载器（ClassLoader）」负责执行，核心完成 <strong>3件核心工作</strong>，缺一不可：</p>
<h5 data-id="heading-4">1. 定位字节码文件</h5>
<p>通过类的<strong>全限定类名</strong>（如 <code>java.lang.String</code>、<code>com.test.User</code>），找到对应的 <code>.class</code> 字节码文件（来源可以是本地磁盘、网络、jar包、动态生成等）。</p>
<h5 data-id="heading-5">2. 读取字节码数据</h5>
<p>将 <code>.class</code> 文件的二进制字节流，读取到 JVM 的<strong>方法区</strong>（JDK8及以后为「元空间 Metaspace」，直接占用堆外内存）中。</p>
<h5 data-id="heading-6">3. 创建Class对象</h5>
<p>在 JVM 的<strong>堆内存</strong>中，创建一个对应类的 <code>java.lang.Class</code> 类型对象 —— 这个对象是程序访问方法区中类元数据的「唯一入口」，后续反射、实例化对象都依赖它。</p>
<p>💡 经典考点：堆中的 <code>Class</code> 对象 ≠ 方法区的类元数据。<code>Class</code> 对象是访问入口，类元数据是类的完整信息（属性、方法、常量池等）。</p>
<h4 data-id="heading-7">✅ 阶段2：验证（Verification）—— 「验合法性、保安全性」</h4>
<p>验证是类加载的<strong>安全屏障</strong>，JVM 会对加载到方法区的字节码数据进行<strong>全方位校验</strong>，确保其<strong>符合Java虚拟机规范、无安全隐患</strong>，防止恶意或错误的字节码文件破坏JVM运行。</p>
<p>该阶段分为 <strong>4个子验证环节</strong>，层层递进：</p>
<ol>
<li><strong>文件格式验证</strong>：校验字节码是否符合 <code>.class</code> 文件的格式规范（如魔数是否为 <code>0xCAFEBABE</code>、版本号是否兼容当前JVM）；</li>
<li><strong>元数据验证</strong>：校验类的元数据是否符合Java语法规范（如是否有父类、是否继承了不可继承的类、方法参数是否合法）；</li>
<li><strong>字节码验证</strong>：校验字节码指令的执行逻辑是否合法（如是否存在栈溢出、类型转换异常、指令执行顺序错误）；</li>
<li><strong>符号引用验证</strong>：校验类中的符号引用（如引用的类、方法、字段）是否真实存在、访问权限是否合法。</li>
</ol>
<p>💡 优化点：若确认字节码文件是安全的（如项目内部类），可通过JVM参数 <code>-Xverify:none</code> 关闭验证，提升类加载效率。</p>
<h4 data-id="heading-8">✅ 阶段3：准备（Preparation）—— 「赋默认值、分配内存」</h4>
<p>准备阶段是<strong>为类的静态变量分配内存，并设置默认初始值</strong>的阶段，核心规则明确且固定，是高频考点：</p>
<h5 data-id="heading-9">✅ 核心规则（必须牢记）</h5>
<ol>
<li><strong>仅处理「静态变量（static修饰）」</strong>：实例变量的内存分配和初始化，要等到<strong>对象实例化</strong>时才在堆中执行，与本阶段无关；</li>
<li><strong>分配内存位置</strong>：静态变量的内存，分配在<strong>方法区</strong>的类元数据中；</li>
<li><strong>赋值规则</strong>：仅设置「JVM默认初始值」，<strong>不会执行程序员自定义的赋值语句</strong>。</li>
</ol>
<h5 data-id="heading-10">✅ 基础数据类型默认值对照表</h5>









































<table><thead><tr><th>数据类型</th><th>默认初始值</th><th>数据类型</th><th>默认初始值</th></tr></thead><tbody><tr><td>byte</td><td>0</td><td>boolean</td><td>false</td></tr><tr><td>short</td><td>0</td><td>char</td><td>'\u0000'</td></tr><tr><td>int</td><td>0</td><td>long</td><td>0L</td></tr><tr><td>float</td><td>0.0f</td><td>double</td><td>0.0d</td></tr><tr><td>引用类型</td><td>null</td><td>-</td><td>-</td></tr></tbody></table>
<h5 data-id="heading-11">✅ 经典示例（理解核心）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-comment">// 静态变量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> num = <span class="hljs-number">10</span>; 
    <span class="hljs-comment">// 实例变量（本阶段不处理）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> name;
}
</code></pre>
<p>👉 准备阶段执行结果：</p>
<ul>
<li>为 <code>num</code> 分配内存，赋值为 <strong>0</strong>（默认值），而非10；</li>
<li>完全不处理 <code>name</code> 变量；</li>
<li>程序员写的 <code>num=10</code> 赋值语句，要等到<strong>初始化阶段</strong>才执行。</li>
</ul>
<h4 data-id="heading-12">✅ 阶段4：解析（Resolution）—— 「符号引用 → 直接引用」</h4>
<p>解析是 JVM 将常量池中的 <strong>符号引用</strong> 替换为 <strong>直接引用</strong> 的过程，是「链接阶段」的最后一步，先明确两个核心概念：</p>
<h5 data-id="heading-13">✅ 核心概念区分（必懂）</h5>
<ol>
<li><strong>符号引用</strong>：用「字符串」描述的引用关系（如类名、方法名、字段名），独立于内存布局，JVM 不知道其真实内存地址。例如 <code>.class</code> 文件中 <code>invokevirtual com/test/User.getName()</code> 就是符号引用；</li>
<li><strong>直接引用</strong>：指向目标的<strong>真实内存地址</strong>（可以是指针、偏移量），JVM 能直接定位到目标位置，与内存布局强相关。</li>
</ol>
<h5 data-id="heading-14">✅ 解析的核心内容</h5>
<p>解析阶段主要处理<strong>4类符号引用</strong>，全部位于类的常量池中：</p>
<ol>
<li><strong>类/接口解析</strong>：将类的全限定名，解析为对应的 <code>Class</code> 对象直接引用；</li>
<li><strong>字段解析</strong>：将字段名，解析为指向方法区中字段内存地址的直接引用；</li>
<li><strong>方法解析</strong>：将方法名，解析为指向方法区中方法内存地址的直接引用；</li>
<li><strong>接口方法解析</strong>：专门处理接口中的方法引用解析。</li>
</ol>
<p>💡 关键特性：解析阶段<strong>支持动态绑定</strong>。比如子类重写父类方法时，JVM 不会在解析阶段确定最终引用，而是延迟到<strong>运行期</strong>（调用方法时）才确定，这是Java实现<strong>多态</strong>的核心基础。</p>
<h4 data-id="heading-15">✅ 阶段5：初始化（Initialization）—— 「执行代码、赋真实值」</h4>
<p>初始化是类加载<strong>5个核心阶段的最后一步</strong>，也是<strong>唯一会执行Java代码的阶段</strong>，核心是「执行静态代码，为静态变量赋予程序员自定义的真实值」，是类加载中最核心、最易考的阶段。</p>
<h5 data-id="heading-16">✅ 核心触发条件（主动使用，7种必背）</h5>
<p>JVM 严格规定：<strong>只有当类被「主动使用」时，才会触发初始化阶段</strong>；被动使用（如仅引用静态常量）不会触发初始化。主动使用的7种场景：</p>
<ol>
<li>创建类的实例（<code>new User()</code>）；</li>
<li>调用类的静态方法（<code>User.testMethod()</code>）；</li>
<li>访问类/接口的<strong>非final</strong>静态变量（<code>User.num</code>）；</li>
<li>反射调用类（<code>Class.forName("com.test.User")</code>）；</li>
<li>初始化子类时，其父类会被优先初始化；</li>
<li>JVM启动时，被指定为「主类」的类（含 <code>main()</code> 方法的类）；</li>
<li>动态语言支持（JDK7+）：调用 <code>java.lang.invoke.MethodHandle</code> 实例，且该实例指向的方法所属类未初始化。</li>
</ol>
<p>✅ 经典反例（被动使用，不初始化）：访问类的 <code>static final</code> 静态常量（<code>public static final int a=10</code>），因为常量在<strong>编译期</strong>就已存入调用类的常量池，无需加载原类。</p>
<h5 data-id="heading-17">✅ 初始化阶段的执行顺序（严格固定，高频考点）</h5>
<p>JVM 会按**「自上而下、先父后子」** 的顺序，执行以下两类代码，且<strong>仅执行一次</strong>（类初始化是线程安全的，JVM会加锁保证）：</p>
<ol>
<li><strong>执行静态变量的显式赋值语句</strong>（如 <code>num=10</code>）；</li>
<li><strong>执行静态代码块（static{}）中的代码</strong>；</li>
<li>若存在父类，<strong>先初始化父类</strong>，再初始化子类。</li>
</ol>
<h5 data-id="heading-18">✅ 经典示例（彻底理解）</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> p = <span class="hljs-number">100</span>;
    <span class="hljs-keyword">static</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"父类静态代码块执行"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title">Son</span> <span class="hljs-title">extends</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> s = <span class="hljs-number">200</span>;
    <span class="hljs-keyword">static</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子类静态代码块执行"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(Son.s);
    }
}
</code></pre>
<p>👉 执行结果（严格遵循初始化顺序）：</p>
<pre><code class="hljs">父类静态代码块执行
子类静态代码块执行
200
</code></pre>
<p>👉 底层逻辑：</p>
<ul>
<li>调用 <code>Son.s</code> 属于「主动使用」，触发Son类初始化；</li>
<li>初始化Son前，先初始化父类Parent；</li>
<li>Parent中：先执行 <code>p=100</code>，再执行静态代码块；</li>
<li>Parent初始化完成后，执行Son的 <code>s=200</code>，再执行Son的静态代码块；</li>
<li>最终返回 <code>s=200</code>。</li>
</ul>
<h3 data-id="heading-19">三、类加载的核心特性（3个，必须掌握）</h3>
<p>Java 类加载机制设计了3个核心特性，保证了加载的高效性、安全性和灵活性，是面试高频考点：</p>
<h4 data-id="heading-20">✅ 特性1：<strong>双亲委派机制</strong>（核心，重中之重）</h4>
<h5 data-id="heading-21">1. 定义</h5>
<p>类加载器在加载类时，<strong>先委托父类加载器加载，父类加载失败后，自己才尝试加载</strong>，是一种「向上委托、向下查找」的加载机制。</p>
<h5 data-id="heading-22">2. 作用</h5>
<p>✅ 保证<strong>核心类的唯一性</strong>：如 <code>java.lang.String</code> 只会被「启动类加载器」加载，避免自定义类篡改核心类；</p>
<p>✅ 保证<strong>类加载的安全性</strong>：防止恶意类冒充核心类，破坏JVM运行。</p>
<h5 data-id="heading-23">3. 类加载器层级（自上而下）</h5>
<ol>
<li><strong>启动类加载器（Bootstrap ClassLoader）</strong> ：C++实现，加载JRE/lib核心类库（如rt.jar）；</li>
<li><strong>扩展类加载器（Extension ClassLoader）</strong> ：Java实现，加载JRE/lib/ext扩展类库；</li>
<li><strong>应用程序类加载器（Application ClassLoader）</strong> ：Java实现，加载项目classpath下的类（我们自己写的类）；</li>
<li><strong>自定义类加载器</strong>：继承 <code>ClassLoader</code>，按需加载自定义来源的类（如网络、加密文件）。</li>
</ol>
<h4 data-id="heading-24">✅ 特性2：<strong>懒加载（延迟加载）</strong></h4>
<p>JVM 不会在程序启动时加载所有类，而是<strong>在类被「主动使用」时才触发加载</strong>，极大节省内存开销，提升程序启动速度。</p>
<ul>
<li>类的加载、验证、准备阶段：随「主动使用」触发；</li>
<li>初始化阶段：严格按「主动使用」条件触发，且仅执行一次。</li>
</ul>
<h4 data-id="heading-25">✅ 特性3：<strong>缓存机制</strong></h4>
<p>类被加载后，JVM 会将其元数据缓存到方法区中，后续再次使用该类时，直接从缓存中获取 <code>Class</code> 对象，<strong>无需重复加载</strong>。</p>
<ul>
<li>缓存有效期：直到JVM退出；</li>
<li>作用：提升类的复用效率，避免重复执行加载、验证等开销。</li>
</ul>
<h3 data-id="heading-26">四、类加载后续阶段（使用+卸载）</h3>
<p>类加载的5个核心阶段完成后，类就进入「可用状态」，最终在满足条件时被卸载，完成完整生命周期：</p>
<h4 data-id="heading-27">✅ 阶段6：使用（Using）</h4>
<p>程序通过两种方式使用已初始化的类：</p>
<ol>
<li><strong>创建类的实例对象</strong>：<code>new User()</code>，调用实例方法、访问实例变量；</li>
<li><strong>调用类的静态成员</strong>：<code>User.staticMethod()</code>、<code>User.staticVar</code>。</li>
</ol>
<h4 data-id="heading-28">✅ 阶段7：卸载（Unloading）</h4>
<p>类的卸载是JVM回收方法区内存的过程，<strong>必须同时满足3个条件</strong>，否则不会被卸载（类的卸载条件极其苛刻）：</p>
<ol>
<li>该类的<strong>所有实例对象</strong>都已被GC回收，堆中无该类的任何实例；</li>
<li>该类的 <code>java.lang.Class</code> 对象，无任何地方被引用（如无反射、无静态变量引用）；</li>
<li>加载该类的<strong>类加载器</strong>已被GC回收。</li>
</ol>
<p>💡 结论：JVM的核心类（如 <code>java.lang.String</code>）永远不会被卸载，因为其被启动类加载器加载，且始终被JVM内部引用。</p>
<h3 data-id="heading-29">五、核心总结（必背，覆盖所有考点）</h3>
<ol>
<li>Java类加载核心流程：<strong>加载 → 验证 → 准备 → 解析 → 初始化</strong>，前4个为「链接阶段」，解析可延迟；</li>
<li>准备阶段：给<strong>静态变量</strong>分配内存，赋<strong>JVM默认值</strong>，不执行自定义赋值；</li>
<li>初始化阶段：执行<strong>静态赋值语句+静态代码块</strong>，仅在「主动使用」时触发，且<strong>先父后子</strong>；</li>
<li>类加载3大特性：<strong>双亲委派、懒加载、缓存机制</strong>，双亲委派是核心；</li>
<li>类卸载3个条件：无实例、无Class对象引用、类加载器被回收；</li>
<li>堆中的 <code>Class</code> 对象是访问方法区类元数据的唯一入口。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python多线程与多进程编程实战指南]]></title>    <link>https://juejin.cn/post/7588073726207918086</link>    <guid>https://juejin.cn/post/7588073726207918086</guid>    <pubDate>2025-12-27T07:20:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588073726207918086" data-draft-id="7588069469516808233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Python多线程与多进程编程实战指南"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-27T07:20:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Python多线程与多进程编程实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T07:20:07.000Z" title="Sat Dec 27 2025 07:20:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：理解并发与并行</h2>
<p>在处理大数据或高并发场景时，我们需要让程序同时做多件事情。Python提供了两种主要方式：多线程（threading）和多进程（multiprocessing）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 一个直观的例子：同步 vs 多线程 vs 多进程</span>
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">task</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""模拟耗时任务"""</span>
    result = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        result += i * i
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 同步执行（一个一个来）</span>
start = time.time()
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
    task(<span class="hljs-number">10000000</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"同步执行耗时: <span class="hljs-subst">{time.time() - start:<span class="hljs-number">.2</span>f}</span>秒"</span>)

<span class="hljs-comment"># 多线程执行（同时开始，但由于GIL限制，实际还是交替执行）</span>
<span class="hljs-comment"># 多进程执行（真正的同时执行）</span>
</code></pre>
<h2 data-id="heading-1">一、多线程编程</h2>
<h3 data-id="heading-2">1.1 创建和启动线程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 多线程基础 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">name, delay</span>):
    <span class="hljs-string">"""工作者函数"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{name}</span>] 开始工作，需要 <span class="hljs-subst">{delay}</span> 秒"</span>)
    time.sleep(delay)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{name}</span>] 工作完成"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>的结果"</span>

<span class="hljs-comment"># 方法1：直接创建线程</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">basic_threads</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"方法1：直接创建线程"</span>)
    
    <span class="hljs-comment"># 创建线程对象</span>
    thread1 = threading.Thread(target=worker, args=(<span class="hljs-string">"工人1"</span>, <span class="hljs-number">2</span>))
    thread2 = threading.Thread(target=worker, args=(<span class="hljs-string">"工人2"</span>, <span class="hljs-number">1</span>))
    thread3 = threading.Thread(target=worker, args=(<span class="hljs-string">"工人3"</span>, <span class="hljs-number">3</span>))
    
    <span class="hljs-comment"># 启动线程</span>
    thread1.start()
    thread2.start()
    thread3.start()
    
    <span class="hljs-comment"># 等待所有线程完成</span>
    thread1.join()
    thread2.join()
    thread3.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有线程工作完成"</span>)

<span class="hljs-comment"># 方法2：继承Thread类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyThread</span>(threading.Thread):
    <span class="hljs-string">"""自定义线程类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, delay</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.name = name
        self.delay = delay
        self.result = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""线程执行的代码"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{self.name}</span>] 开始工作"</span>)
        time.sleep(self.delay)
        self.result = <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>完成任务"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{self.name}</span>] 工作完成"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_result</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取结果"""</span>
        <span class="hljs-keyword">return</span> self.result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">class_based_threads</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n方法2：继承Thread类"</span>)
    
    threads = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        thread = MyThread(<span class="hljs-string">f"线程<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>"</span>, i+<span class="hljs-number">1</span>)
        thread.start()
        threads.append(thread)
    
    <span class="hljs-comment"># 等待并获取结果</span>
    <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
        thread.join()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{thread.get_result()}</span>"</span>)

<span class="hljs-comment"># 运行演示</span>
basic_threads()
class_based_threads()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-3">1.2 线程同步与通信</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> queue
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 线程同步与通信 ==="</span>)

<span class="hljs-comment"># 1. 线程锁 - 防止数据竞争</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span>:
    <span class="hljs-string">"""银行账户（线程安全）"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, balance=<span class="hljs-number">0</span></span>):
        self.balance = balance
        self.lock = threading.Lock()
        self.transactions = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-params">self, amount, thread_name</span>):
        <span class="hljs-string">"""存款"""</span>
        <span class="hljs-keyword">with</span> self.lock:  <span class="hljs-comment"># 自动获取和释放锁</span>
            old_balance = self.balance
            self.balance += amount
            self.transactions.append(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 存款 <span class="hljs-subst">{amount}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 存款 <span class="hljs-subst">{amount}</span>, 余额: <span class="hljs-subst">{old_balance}</span> -&gt; <span class="hljs-subst">{self.balance}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">self, amount, thread_name</span>):
        <span class="hljs-string">"""取款"""</span>
        <span class="hljs-keyword">with</span> self.lock:
            <span class="hljs-keyword">if</span> self.balance &gt;= amount:
                old_balance = self.balance
                self.balance -= amount
                self.transactions.append(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 取款 <span class="hljs-subst">{amount}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 取款 <span class="hljs-subst">{amount}</span>, 余额: <span class="hljs-subst">{old_balance}</span> -&gt; <span class="hljs-subst">{self.balance}</span>"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{thread_name}</span>: 取款失败，余额不足"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_bank_account</span>():
    <span class="hljs-string">"""测试银行账户"""</span>
    account = BankAccount(<span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">customer_operations</span>(<span class="hljs-params">name, operations</span>):
        <span class="hljs-keyword">for</span> op_type, amount <span class="hljs-keyword">in</span> operations:
            <span class="hljs-keyword">if</span> op_type == <span class="hljs-string">"deposit"</span>:
                account.deposit(amount, name)
            <span class="hljs-keyword">else</span>:
                account.withdraw(amount, name)
            time.sleep(<span class="hljs-number">0.1</span>)
    
    <span class="hljs-comment"># 多个客户同时操作账户</span>
    customers = [
        (<span class="hljs-string">"张三"</span>, [(<span class="hljs-string">"deposit"</span>, <span class="hljs-number">200</span>), (<span class="hljs-string">"withdraw"</span>, <span class="hljs-number">300</span>)]),
        (<span class="hljs-string">"李四"</span>, [(<span class="hljs-string">"deposit"</span>, <span class="hljs-number">500</span>), (<span class="hljs-string">"withdraw"</span>, <span class="hljs-number">800</span>)]),
        (<span class="hljs-string">"王五"</span>, [(<span class="hljs-string">"withdraw"</span>, <span class="hljs-number">400</span>), (<span class="hljs-string">"deposit"</span>, <span class="hljs-number">600</span>)])
    ]
    
    threads = []
    <span class="hljs-keyword">for</span> name, operations <span class="hljs-keyword">in</span> customers:
        thread = threading.Thread(target=customer_operations, args=(name, operations))
        thread.start()
        threads.append(thread)
    
    <span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
        thread.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最终余额: <span class="hljs-subst">{account.balance}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"交易记录:"</span>, account.transactions)

<span class="hljs-comment"># 2. 队列 - 线程间安全通信</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">producer_consumer_demo</span>():
    <span class="hljs-string">"""生产者-消费者模式"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n生产者-消费者模式演示"</span>)
    
    q = queue.Queue(maxsize=<span class="hljs-number">5</span>)  <span class="hljs-comment"># 最大容量5</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">name, items</span>):
        <span class="hljs-string">"""生产者"""</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(items):
            item = <span class="hljs-string">f"<span class="hljs-subst">{name}</span>的产品-<span class="hljs-subst">{i}</span>"</span>
            q.put(item)  <span class="hljs-comment"># 如果队列满，会阻塞等待</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[生产者<span class="hljs-subst">{name}</span>] 生产: <span class="hljs-subst">{item}</span>"</span>)
            time.sleep(<span class="hljs-number">0.5</span>)
        q.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 发送结束信号</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">name</span>):
        <span class="hljs-string">"""消费者"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            item = q.get()  <span class="hljs-comment"># 如果队列空，会阻塞等待</span>
            <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                q.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 传递结束信号给其他消费者</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 结束"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 消费: <span class="hljs-subst">{item}</span>"</span>)
            time.sleep(<span class="hljs-number">1</span>)
            q.task_done()
    
    <span class="hljs-comment"># 启动生产者和消费者</span>
    producers = [
        threading.Thread(target=producer, args=(<span class="hljs-string">"A"</span>, <span class="hljs-number">5</span>)),
        threading.Thread(target=producer, args=(<span class="hljs-string">"B"</span>, <span class="hljs-number">3</span>))
    ]
    
    consumers = [
        threading.Thread(target=consumer, args=(<span class="hljs-string">"1"</span>,)),
        threading.Thread(target=consumer, args=(<span class="hljs-string">"2"</span>,))
    ]
    
    <span class="hljs-comment"># 启动所有线程</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> producers:
        p.start()
    
    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> consumers:
        c.start()
    
    <span class="hljs-comment"># 等待生产者完成</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> producers:
        p.join()
    
    <span class="hljs-comment"># 等待队列清空</span>
    q.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有任务完成"</span>)

<span class="hljs-comment"># 运行演示</span>
test_bank_account()
producer_consumer_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-4">1.3 线程池</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 线程池 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">item</span>):
    <span class="hljs-string">"""处理单个项目"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始处理: <span class="hljs-subst">{item}</span>"</span>)
    time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 模拟耗时操作</span>
    result = <span class="hljs-string">f"<span class="hljs-subst">{item}</span>_processed"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理完成: <span class="hljs-subst">{item}</span> -&gt; <span class="hljs-subst">{result}</span>"</span>)
    <span class="hljs-keyword">return</span> result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">thread_pool_demo</span>():
    <span class="hljs-string">"""线程池演示"""</span>
    
    items = [<span class="hljs-string">f"item_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始处理 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(items)}</span> 个项目"</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 使用线程池（最大3个线程）</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> executor:
        <span class="hljs-comment"># 提交所有任务</span>
        future_to_item = {executor.submit(process_item, item): item 
                         <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items}
        
        <span class="hljs-comment"># 收集结果</span>
        results = []
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> future_to_item:
            result = future.result()
            results.append(result)
    
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n所有项目处理完成!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(results)}</span> 个项目"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果样例: <span class="hljs-subst">{results[:<span class="hljs-number">3</span>]}</span>..."</span>)

<span class="hljs-comment"># 高级特性：回调函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">callback_demo</span>():
    <span class="hljs-string">"""回调函数演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n线程池回调函数演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">task</span>(<span class="hljs-params">n</span>):
        <span class="hljs-string">"""任务函数"""</span>
        <span class="hljs-keyword">return</span> n * n
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">callback</span>(<span class="hljs-params">future</span>):
        <span class="hljs-string">"""回调函数"""</span>
        result = future.result()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回调: 任务完成，结果=<span class="hljs-subst">{result}</span>"</span>)
    
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> executor:
        <span class="hljs-comment"># 提交任务并添加回调</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
            future = executor.submit(task, i)
            future.add_done_callback(callback)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有回调执行完成"</span>)

<span class="hljs-comment"># 运行演示</span>
thread_pool_demo()
callback_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-5">二、多进程编程</h2>
<h3 data-id="heading-6">2.1 创建进程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 多进程基础 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_process</span>(<span class="hljs-params">name, delay</span>):
    <span class="hljs-string">"""工作进程函数"""</span>
    pid = os.getpid()  <span class="hljs-comment"># 获取进程ID</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[进程<span class="hljs-subst">{pid}</span>] <span class="hljs-subst">{name}</span> 开始工作，需要 <span class="hljs-subst">{delay}</span> 秒"</span>)
    time.sleep(delay)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[进程<span class="hljs-subst">{pid}</span>] <span class="hljs-subst">{name}</span> 工作完成"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>的结果"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">basic_processes</span>():
    <span class="hljs-string">"""基本进程创建"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"创建多个进程"</span>)
    
    processes = []
    
    <span class="hljs-comment"># 创建进程</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        p = multiprocessing.Process(
            target=worker_process,
            args=(<span class="hljs-string">f"工人<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>"</span>, i+<span class="hljs-number">1</span>)
        )
        processes.append(p)
        p.start()
    
    <span class="hljs-comment"># 等待所有进程完成</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有进程工作完成"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_pool_demo</span>():
    <span class="hljs-string">"""进程池演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用进程池"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cpu_intensive_task</span>(<span class="hljs-params">n</span>):
        <span class="hljs-string">"""CPU密集型任务"""</span>
        result = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
            result += i * i
        pid = os.getpid()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[进程<span class="hljs-subst">{pid}</span>] 完成计算 n=<span class="hljs-subst">{n}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    
    numbers = [<span class="hljs-number">1000000</span>, <span class="hljs-number">2000000</span>, <span class="hljs-number">3000000</span>, <span class="hljs-number">4000000</span>]
    
    start_time = time.time()
    
    <span class="hljs-comment"># 使用进程池</span>
    <span class="hljs-keyword">with</span> multiprocessing.Pool(processes=<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> pool:
        results = pool.<span class="hljs-built_in">map</span>(cpu_intensive_task, numbers)
    
    end_time = time.time()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"计算完成!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{results}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

<span class="hljs-comment"># 运行演示</span>
basic_processes()
process_pool_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-7">2.2 进程间通信</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 进程间通信 ==="</span>)

<span class="hljs-comment"># 1. 队列通信</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_communication</span>():
    <span class="hljs-string">"""使用队列进行进程间通信"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 队列通信演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">queue, items</span>):
        <span class="hljs-string">"""生产者进程"""</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[生产者] 发送: <span class="hljs-subst">{item}</span>"</span>)
            queue.put(item)
            time.sleep(<span class="hljs-number">0.5</span>)
        queue.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 结束信号</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">queue, name</span>):
        <span class="hljs-string">"""消费者进程"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            item = queue.get()
            <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                queue.put(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 传递结束信号</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 结束"</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[消费者<span class="hljs-subst">{name}</span>] 收到: <span class="hljs-subst">{item}</span>"</span>)
            time.sleep(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 创建队列</span>
    q = multiprocessing.Queue(maxsize=<span class="hljs-number">3</span>)
    
    <span class="hljs-comment"># 创建进程</span>
    producer_p = multiprocessing.Process(
        target=producer,
        args=(q, [<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>])
    )
    
    consumer1_p = multiprocessing.Process(
        target=consumer,
        args=(q, <span class="hljs-string">"1"</span>)
    )
    
    consumer2_p = multiprocessing.Process(
        target=consumer,
        args=(q, <span class="hljs-string">"2"</span>)
    )
    
    <span class="hljs-comment"># 启动进程</span>
    producer_p.start()
    consumer1_p.start()
    consumer2_p.start()
    
    <span class="hljs-comment"># 等待完成</span>
    producer_p.join()
    consumer1_p.join()
    consumer2_p.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"队列通信完成"</span>)

<span class="hljs-comment"># 2. 管道通信</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">pipe_communication</span>():
    <span class="hljs-string">"""使用管道进行进程间通信"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. 管道通信演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_a</span>(<span class="hljs-params">conn</span>):
        <span class="hljs-string">"""进程A"""</span>
        conn.send(<span class="hljs-string">"Hello from Process A"</span>)
        data = conn.recv()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Process A] 收到: <span class="hljs-subst">{data}</span>"</span>)
        conn.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_b</span>(<span class="hljs-params">conn</span>):
        <span class="hljs-string">"""进程B"""</span>
        data = conn.recv()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Process B] 收到: <span class="hljs-subst">{data}</span>"</span>)
        conn.send(<span class="hljs-string">"Hello from Process B"</span>)
        conn.close()
    
    <span class="hljs-comment"># 创建管道</span>
    parent_conn, child_conn = multiprocessing.Pipe()
    
    <span class="hljs-comment"># 创建进程</span>
    p1 = multiprocessing.Process(target=process_a, args=(parent_conn,))
    p2 = multiprocessing.Process(target=process_b, args=(child_conn,))
    
    <span class="hljs-comment"># 启动进程</span>
    p1.start()
    p2.start()
    
    <span class="hljs-comment"># 等待完成</span>
    p1.join()
    p2.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"管道通信完成"</span>)

<span class="hljs-comment"># 3. 共享内存</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">shared_memory_demo</span>():
    <span class="hljs-string">"""共享内存演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 共享内存演示"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">shared_value, shared_array, lock, worker_id</span>):
        <span class="hljs-string">"""工作进程"""</span>
        <span class="hljs-keyword">with</span> lock:
            shared_value.value += <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[Worker <span class="hljs-subst">{worker_id}</span>] 共享值: <span class="hljs-subst">{shared_value.value}</span>"</span>)
        
        <span class="hljs-comment"># 修改共享数组</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(shared_array)):
            shared_array[i] = worker_id * <span class="hljs-number">10</span> + i
    
    <span class="hljs-comment"># 创建共享值</span>
    shared_value = multiprocessing.Value(<span class="hljs-string">'i'</span>, <span class="hljs-number">0</span>)  <span class="hljs-comment"># 整数类型</span>
    
    <span class="hljs-comment"># 创建共享数组</span>
    shared_array = multiprocessing.Array(<span class="hljs-string">'i'</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment"># 5个整数的数组</span>
    
    <span class="hljs-comment"># 创建锁</span>
    lock = multiprocessing.Lock()
    
    <span class="hljs-comment"># 创建多个进程</span>
    processes = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
        p = multiprocessing.Process(
            target=worker,
            args=(shared_value, shared_array, lock, i+<span class="hljs-number">1</span>)
        )
        processes.append(p)
        p.start()
    
    <span class="hljs-comment"># 等待所有进程完成</span>
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终共享值: <span class="hljs-subst">{shared_value.value}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"共享数组: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(shared_array)}</span>"</span>)

<span class="hljs-comment"># 运行演示</span>
queue_communication()
pipe_communication()
shared_memory_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-8">三、选择指南：线程 vs 进程</h2>
<h3 data-id="heading-9">3.1 性能对比</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cpu_bound_task</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""CPU密集型任务"""</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        count += i * i
    <span class="hljs-keyword">return</span> count

<span class="hljs-keyword">def</span> <span class="hljs-title function_">io_bound_task</span>(<span class="hljs-params">duration</span>):
    <span class="hljs-string">"""I/O密集型任务"""</span>
    time.sleep(duration)
    <span class="hljs-keyword">return</span> duration

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compare_performance</span>():
    <span class="hljs-string">"""比较线程和进程的性能"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 线程 vs 进程 性能对比 ==="</span>)
    
    <span class="hljs-comment"># 测试配置</span>
    task_count = <span class="hljs-number">4</span>
    cpu_task_size = <span class="hljs-number">10000000</span>
    io_task_duration = <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 1. CPU密集型任务对比</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n1. CPU密集型任务对比:"</span>)
    
    <span class="hljs-comment"># 单线程</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        cpu_bound_task(cpu_task_size)
    single_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  单线程: <span class="hljs-subst">{single_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多线程（由于GIL，可能不会更快）</span>
    start = time.time()
    threads = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        t = threading.Thread(target=cpu_bound_task, args=(cpu_task_size,))
        t.start()
        threads.append(t)
    
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.join()
    thread_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多线程(<span class="hljs-subst">{task_count}</span>线程): <span class="hljs-subst">{thread_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多进程</span>
    start = time.time()
    processes = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        p = multiprocessing.Process(target=cpu_bound_task, args=(cpu_task_size,))
        p.start()
        processes.append(p)
    
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    process_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多进程(<span class="hljs-subst">{task_count}</span>进程): <span class="hljs-subst">{process_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  CPU任务结论: 多进程比多线程快 <span class="hljs-subst">{thread_time/process_time:<span class="hljs-number">.1</span>f}</span>倍"</span>)
    
    <span class="hljs-comment"># 2. I/O密集型任务对比</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. I/O密集型任务对比:"</span>)
    
    <span class="hljs-comment"># 单线程</span>
    start = time.time()
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        io_bound_task(io_task_duration)
    single_io_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  单线程: <span class="hljs-subst">{single_io_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多线程</span>
    start = time.time()
    threads = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        t = threading.Thread(target=io_bound_task, args=(io_task_duration,))
        t.start()
        threads.append(t)
    
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.join()
    thread_io_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多线程(<span class="hljs-subst">{task_count}</span>线程): <span class="hljs-subst">{thread_io_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 多进程</span>
    start = time.time()
    processes = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(task_count):
        p = multiprocessing.Process(target=io_bound_task, args=(io_task_duration,))
        p.start()
        processes.append(p)
    
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
    process_io_time = time.time() - start
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  多进程(<span class="hljs-subst">{task_count}</span>进程): <span class="hljs-subst">{process_io_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  I/O任务结论: 多线程比单线程快 <span class="hljs-subst">{single_io_time/thread_io_time:<span class="hljs-number">.1</span>f}</span>倍"</span>)
    
    <span class="hljs-comment"># 3. 内存使用对比</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 内存使用注意事项:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 线程: 共享内存，内存使用少，但需要处理线程安全问题"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 进程: 独立内存空间，内存使用多，但不需要处理线程安全问题"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 线程创建开销: 小"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - 进程创建开销: 大"</span>)
    
    <span class="hljs-comment"># 4. 选择指南</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n4. 选择指南:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  使用多线程的场景:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ I/O密集型任务（网络请求、文件读写）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 需要共享数据"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 任务执行时间短"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n  使用多进程的场景:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ CPU密集型任务（科学计算、图像处理）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 需要进程隔离（一个进程崩溃不影响其他进程）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    ✓ 需要利用多核CPU"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n  通用建议:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - 优先使用concurrent.futures模块"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - I/O密集型：使用ThreadPoolExecutor"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - CPU密集型：使用ProcessPoolExecutor"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"    - 任务数量多但简单：使用线程池/进程池"</span>)

<span class="hljs-comment"># 运行比较</span>
compare_performance()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-10">3.2 实战案例：并行下载管理器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> concurrent.futures
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelDownloader</span>:
    <span class="hljs-string">"""并行下载管理器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_workers=<span class="hljs-number">5</span>, download_dir=<span class="hljs-string">"downloads"</span></span>):
        self.max_workers = max_workers
        self.download_dir = download_dir
        
        <span class="hljs-comment"># 创建下载目录</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(download_dir):
            os.makedirs(download_dir)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">self, url, filename=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""下载单个文件"""</span>
        <span class="hljs-keyword">if</span> filename <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            filename = url.split(<span class="hljs-string">"/"</span>)[-<span class="hljs-number">1</span>]
        
        filepath = os.path.join(self.download_dir, filename)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载: <span class="hljs-subst">{url}</span>"</span>)
            start_time = time.time()
            
            response = requests.get(url, stream=<span class="hljs-literal">True</span>, timeout=<span class="hljs-number">10</span>)
            response.raise_for_status()
            
            total_size = <span class="hljs-built_in">int</span>(response.headers.get(<span class="hljs-string">'content-length'</span>, <span class="hljs-number">0</span>))
            downloaded = <span class="hljs-number">0</span>
            
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> response.iter_content(chunk_size=<span class="hljs-number">8192</span>):
                    <span class="hljs-keyword">if</span> chunk:
                        f.write(chunk)
                        downloaded += <span class="hljs-built_in">len</span>(chunk)
                        
                        <span class="hljs-comment"># 显示进度</span>
                        <span class="hljs-keyword">if</span> total_size &gt; <span class="hljs-number">0</span>:
                            percent = downloaded * <span class="hljs-number">100</span> / total_size
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{percent:<span class="hljs-number">.1</span>f}</span>%"</span>, end=<span class="hljs-string">'\r'</span>)
            
            end_time = time.time()
            download_time = end_time - start_time
            
            file_size = os.path.getsize(filepath)
            speed = file_size / download_time / <span class="hljs-number">1024</span>  <span class="hljs-comment"># KB/s</span>
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载完成: <span class="hljs-subst">{filename}</span> (<span class="hljs-subst">{file_size/<span class="hljs-number">1024</span>:<span class="hljs-number">.1</span>f}</span>KB, <span class="hljs-subst">{speed:<span class="hljs-number">.1</span>f}</span>KB/s)"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'url'</span>: url,
                <span class="hljs-string">'filename'</span>: filename,
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">'size'</span>: file_size,
                <span class="hljs-string">'time'</span>: download_time,
                <span class="hljs-string">'speed'</span>: speed
            }
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载失败 <span class="hljs-subst">{url}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'url'</span>: url,
                <span class="hljs-string">'filename'</span>: filename,
                <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)
            }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parallel_download</span>(<span class="hljs-params">self, url_list</span>):
        <span class="hljs-string">"""并行下载多个文件"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始并行下载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(url_list)}</span> 个文件"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工作线程数: <span class="hljs-subst">{self.max_workers}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
        
        start_time = time.time()
        results = []
        
        <span class="hljs-comment"># 使用线程池（I/O密集型任务适合用线程）</span>
        <span class="hljs-keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=self.max_workers) <span class="hljs-keyword">as</span> executor:
            <span class="hljs-comment"># 提交所有下载任务</span>
            future_to_url = {}
            <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:
                filename = url.split(<span class="hljs-string">"/"</span>)[-<span class="hljs-number">1</span>]
                future = executor.submit(self.download_file, url, filename)
                future_to_url[future] = url
            
            <span class="hljs-comment"># 收集结果</span>
            <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> concurrent.futures.as_completed(future_to_url):
                url = future_to_url[future]
                <span class="hljs-keyword">try</span>:
                    result = future.result()
                    results.append(result)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务异常 <span class="hljs-subst">{url}</span>: <span class="hljs-subst">{e}</span>"</span>)
                    results.append({
                        <span class="hljs-string">'url'</span>: url,
                        <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>,
                        <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)
                    })
        
        end_time = time.time()
        total_time = end_time - start_time
        
        <span class="hljs-comment"># 统计结果</span>
        successful = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> r[<span class="hljs-string">'success'</span>]]
        failed = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> r[<span class="hljs-string">'success'</span>]]
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"下载完成!"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时: <span class="hljs-subst">{total_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(successful)}</span> 个"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"失败: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(failed)}</span> 个"</span>)
        
        <span class="hljs-keyword">if</span> successful:
            total_size = <span class="hljs-built_in">sum</span>(r[<span class="hljs-string">'size'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> successful)
            avg_speed = <span class="hljs-built_in">sum</span>(r[<span class="hljs-string">'speed'</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> successful) / <span class="hljs-built_in">len</span>(successful)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总大小: <span class="hljs-subst">{total_size/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span>MB"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均速度: <span class="hljs-subst">{avg_speed:<span class="hljs-number">.1</span>f}</span>KB/s"</span>)
        
        <span class="hljs-keyword">if</span> failed:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n失败的文件:"</span>)
            <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> failed:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span>: <span class="hljs-subst">{result.get(<span class="hljs-string">'error'</span>, <span class="hljs-string">'未知错误'</span>)}</span>"</span>)
        
        <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 模拟使用</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_downloader</span>():
    <span class="hljs-string">"""下载管理器演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 并行下载管理器演示 ==="</span>)
    
    <span class="hljs-comment"># 示例URL列表（实际使用时替换为真实URL）</span>
    <span class="hljs-comment"># 注意：这里使用一些公开的测试URL</span>
    test_urls = [
        <span class="hljs-string">"https://httpbin.org/image/jpeg"</span>,  <span class="hljs-comment"># 测试图片</span>
        <span class="hljs-string">"https://httpbin.org/image/png"</span>,
        <span class="hljs-string">"https://httpbin.org/image/svg"</span>,
        <span class="hljs-string">"https://httpbin.org/html"</span>,        <span class="hljs-comment"># 测试HTML</span>
        <span class="hljs-string">"https://httpbin.org/robots.txt"</span>,  <span class="hljs-comment"># 测试文本</span>
        <span class="hljs-string">"https://httpbin.org/xml"</span>          <span class="hljs-comment"># 测试XML</span>
    ]
    
    <span class="hljs-comment"># 创建下载管理器</span>
    downloader = ParallelDownloader(max_workers=<span class="hljs-number">3</span>, download_dir=<span class="hljs-string">"test_downloads"</span>)
    
    <span class="hljs-comment"># 执行并行下载</span>
    results = downloader.parallel_download(test_urls)
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-built_in">print</span>(<span class="hljs-string">"实战案例：并行下载管理器"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"这个管理器可以同时下载多个文件，提高下载效率"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意：演示代码中使用的是测试URL，实际使用时需要替换为真实URL"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-11">总结：最佳实践指南</h2>
<h3 data-id="heading-12">关键决策点：</h3>
<ol>
<li><strong>CPU密集型任务</strong> → 使用多进程</li>
<li><strong>I/O密集型任务</strong> → 使用多线程</li>
<li><strong>需要数据共享</strong> → 多线程或共享内存</li>
<li><strong>需要进程隔离</strong> → 多进程</li>
<li><strong>不确定任务类型</strong> → 先测试，后选择</li>
</ol>
<h3 data-id="heading-13">最佳实践：</h3>
<ol>
<li><strong>使用高层API</strong>：优先使用<code>concurrent.futures</code>模块</li>
<li><strong>控制并发数</strong>：合理设置线程/进程数量</li>
<li><strong>处理异常</strong>：确保异常不会导致程序崩溃</li>
<li><strong>资源清理</strong>：使用with语句确保资源正确释放</li>
<li><strong>性能监控</strong>：记录执行时间和资源使用情况</li>
</ol>
<h3 data-id="heading-14">常见陷阱：</h3>
<ol>
<li><strong>死锁</strong>：多个锁相互等待</li>
<li><strong>竞态条件</strong>：多个线程同时修改共享数据</li>
<li><strong>内存泄漏</strong>：忘记释放资源</li>
<li><strong>过度并发</strong>：创建过多线程/进程导致系统卡顿</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mysql索引影响查询速度的示例demo]]></title>    <link>https://juejin.cn/post/7588034035287392271</link>    <guid>https://juejin.cn/post/7588034035287392271</guid>    <pubDate>2025-12-27T08:56:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035287392271" data-draft-id="7588034035287359503" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mysql索引影响查询速度的示例demo"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-27T08:56:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mysql索引影响查询速度的示例demo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T08:56:15.000Z" title="Sat Dec 27 2025 08:56:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>创建一个完整的索引影响查询速度的示例demo，通过实际对比可以直观感受索引的强大作用。</p>
<h2 data-id="heading-0">一、测试环境准备</h2>
<h3 data-id="heading-1">1. 创建测试数据库和表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建测试数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE index_demo;
USE index_demo;

<span class="hljs-comment">-- 创建用户表（无索引状态）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_no_index (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建用户表（有索引状态）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_with_index (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_age_city (age, city),
    INDEX idx_created_at (created_at)
);
</code></pre>
<h3 data-id="heading-2">2. 插入大量测试数据</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 插入50万条测试数据</span>
DELIMITER $$
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> insert_test_data()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>;
    WHILE i <span class="hljs-operator">&lt;=</span> <span class="hljs-number">500000</span> DO
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users_no_index (username, email, age, city) <span class="hljs-keyword">VALUES</span> (
            CONCAT(<span class="hljs-string">'user'</span>, i),
            CONCAT(<span class="hljs-string">'user'</span>, i, <span class="hljs-string">'@example.com'</span>),
            <span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">18</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">50</span>),
            ELT(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">10</span>), <span class="hljs-string">'北京'</span>, <span class="hljs-string">'上海'</span>, <span class="hljs-string">'广州'</span>, <span class="hljs-string">'深圳'</span>, <span class="hljs-string">'杭州'</span>, <span class="hljs-string">'南京'</span>, <span class="hljs-string">'武汉'</span>, <span class="hljs-string">'成都'</span>, <span class="hljs-string">'西安'</span>, <span class="hljs-string">'重庆'</span>)
        );
        
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users_with_index (username, email, age, city) <span class="hljs-keyword">VALUES</span> (
            CONCAT(<span class="hljs-string">'user'</span>, i),
            CONCAT(<span class="hljs-string">'user'</span>, i, <span class="hljs-string">'@example.com'</span>),
            <span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">18</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">50</span>),
            ELT(<span class="hljs-built_in">FLOOR</span>(<span class="hljs-number">1</span> <span class="hljs-operator">+</span> RAND() <span class="hljs-operator">*</span> <span class="hljs-number">10</span>), <span class="hljs-string">'北京'</span>, <span class="hljs-string">'上海'</span>, <span class="hljs-string">'广州'</span>, <span class="hljs-string">'深圳'</span>, <span class="hljs-string">'杭州'</span>, <span class="hljs-string">'南京'</span>, <span class="hljs-string">'武汉'</span>, <span class="hljs-string">'成都'</span>, <span class="hljs-string">'西安'</span>, <span class="hljs-string">'重庆'</span>)
        );
        
        IF i <span class="hljs-operator">%</span> <span class="hljs-number">10000</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-keyword">SELECT</span> CONCAT(<span class="hljs-string">'已插入 '</span>, i, <span class="hljs-string">' 条数据'</span>) <span class="hljs-keyword">AS</span> progress;
        <span class="hljs-keyword">END</span> IF;
        <span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">END</span> WHILE;
<span class="hljs-keyword">END</span>$$
DELIMITER ;

<span class="hljs-comment">-- 执行数据插入（这可能需要几分钟）</span>
<span class="hljs-keyword">CALL</span> insert_test_data();
</code></pre>
<h2 data-id="heading-3">二、性能对比测试</h2>
<h3 data-id="heading-4">测试1：基本查询对比</h3>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_no_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">36</span> <span class="hljs-operator">|</span> 北京   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.08</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_with_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">66</span> <span class="hljs-operator">|</span> 成都   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)
</code></pre>
<h3 data-id="heading-5">测试2：精确的性能测量</h3>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> profiling <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> 
mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_no_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">36</span> <span class="hljs-operator">|</span> 北京   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.07</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> PROFILE <span class="hljs-keyword">FOR</span> QUERY <span class="hljs-number">1</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> Status                         <span class="hljs-operator">|</span> Duration <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000094</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Executing hook <span class="hljs-keyword">on</span> transaction  <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000034</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> checking permissions           <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Opening tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000034</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> init                           <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">System</span> lock                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> optimizing                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> statistics                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000022</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> preparing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000021</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> executing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.073159</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">end</span>                            <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> query <span class="hljs-keyword">end</span>                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000004</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> waiting <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">commit</span>     <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> closing tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000008</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> freeing items                  <span class="hljs-operator">|</span> <span class="hljs-number">0.000220</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> cleaning up                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000018</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-number">17</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_with_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> id     <span class="hljs-operator">|</span> username   <span class="hljs-operator">|</span> email                  <span class="hljs-operator">|</span> age <span class="hljs-operator">|</span> city   <span class="hljs-operator">|</span> created_at          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">110000</span> <span class="hljs-operator">|</span> user110000 <span class="hljs-operator">|</span> user110000<span class="hljs-variable">@example</span>.com <span class="hljs-operator">|</span>  <span class="hljs-number">66</span> <span class="hljs-operator">|</span> 成都   <span class="hljs-operator">|</span> <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">15</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+------------+------------------------+-----+--------+---------------------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> 
mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> PROFILE <span class="hljs-keyword">FOR</span> QUERY <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> Status                         <span class="hljs-operator">|</span> Duration <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000096</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Executing hook <span class="hljs-keyword">on</span> transaction  <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> starting                       <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> checking permissions           <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> Opening tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> init                           <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">System</span> lock                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> optimizing                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000011</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> statistics                     <span class="hljs-operator">|</span> <span class="hljs-number">0.000089</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> preparing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000040</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> executing                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000051</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">end</span>                            <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> query <span class="hljs-keyword">end</span>                      <span class="hljs-operator">|</span> <span class="hljs-number">0.000005</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> waiting <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">commit</span>     <span class="hljs-operator">|</span> <span class="hljs-number">0.000007</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> closing tables                 <span class="hljs-operator">|</span> <span class="hljs-number">0.000006</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> freeing items                  <span class="hljs-operator">|</span> <span class="hljs-number">0.000168</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> cleaning up                    <span class="hljs-operator">|</span> <span class="hljs-number">0.000012</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------+----------+</span>
<span class="hljs-number">17</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)

mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SHOW</span> PROFILES;
<span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+--------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> Query_ID <span class="hljs-operator">|</span> Duration   <span class="hljs-operator">|</span> Query                                                        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+--------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>        <span class="hljs-number">1</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.07369975</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_no_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span>   <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>        <span class="hljs-number">2</span> <span class="hljs-operator">|</span> <span class="hljs-number">0.00055400</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users_with_index <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'user110000'</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------+------------+--------------------------------------------------------------+</span>
<span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年终醒悟，AI 让我误以为自己很强，未来程序员的转型之路]]></title>    <link>https://juejin.cn/post/7587845752681807935</link>    <guid>https://juejin.cn/post/7587845752681807935</guid>    <pubDate>2025-12-26T06:56:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587845752681807935" data-draft-id="7587825267878363177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T06:56:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年终醒悟，AI  让我误以为自己很强，未来程序员的转型之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:56:11.000Z" title="Fri Dec 26 2025 06:56:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 可以说只要是开发者都绕不过 AI ，<strong>时至今日你说你不用 AI 写代码我是不信的</strong>，但是直到最近我才发现，我似乎已经把 AI 的能力当做自己的能力，这种错觉体现在，昨天我用 AI 五分钟做出这下方这个动画效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3613ce014e91453e94fd1c50e05143b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=V%2FggoLB%2BRrHCDNxj18pG0%2BKeNEk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>不知道有没有人能看出这个动画里的梗。。。。</p>
</blockquote>
<p>自从有了 AI 之后，有问题可以让 AI 解读，有需求可以让 AI 分解，比如我想做上面那个动画的时候，只需要让 AI 先根据我的表述给出数学公式，然后根据公式再让 AI 实现和组合代码，而这个过程我只需要点一点运行，预览下效果符不符合我的要求，然后我就觉得自己强的可怕。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b801a608a3d495ca937d2d310dc418b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4sQwLflLYn2KO2O6JqxXpFkmZiU%3D" alt="image-20251226121839643" loading="lazy"/></p>
<p><strong>这种错觉经常让我陷入以为自己“无所不能”</strong>，在提效的同时，心态似乎也在慢慢的走偏，比如这段时间以来，我通过 AI 复刻和尝试了许多特效，虽然偶尔需要我介入修改问题，但是大多数时候都是在 Vibe Coding ，<strong>而看着这些充满想象力的炫酷动画，那种自以为是的心理就会被 AI 无限放大</strong> 。</p>






























<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a0b6d11b53452aabc66265090bff30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=B4fz6UPLNseq%2BwXTBX5v2pwKfmA%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0652e86bc274bbe848f632b1c9a4de0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=DTitkkZn7FjnWI7tNlmYg6Dw5Nc%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59c367b6756e4943be98af358fbda0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=Pr6BMhu8aVvezQ54%2FAr6Kk2XRaw%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e6a3504cef472aafc13d3dbd1a3231~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=A2xT%2Bo62zuV2YSno8IMzQsBzZuY%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27890d610f0a46c8b03fc3729d950408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=ttJCBUnDlMTHPlcf4t5yp%2BIq88U%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b946921d4ccc4edbb9a1029fdc24ddcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=76PXV6IfJcYGOFboTNrrVWHY4Es%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0922dc78fe5456fac76e2f26777624a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=uuAOJoF5FGq7IhDEStgVaI6oQb0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/704d800576f34e0f8529a09be8951d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=7LLJKuhnAaUJeEkTnKM%2F7jomc1k%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9f9c62e85e74c21a076cd06236976ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=lqxbzv51reLd%2Bum5GesSiHyi59U%3D" alt="" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b801b53c1d0461fbac8c3e136fbd2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=4bKyBdV4vnEg7AkYw%2FJRwR86lm0%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af36b93fae24792aa76ccbaed68dda9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=qhOkHiOw5CYUmcVJ6HNGjhmXl5A%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409a495b57284042bb88798cf8c738c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=24DWwASBfi1wo%2BF%2Bpnly9BlI3%2Fw%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>但是现在想来，你真的理解过这些动画吗？真的有去了解他们的实现原理和实现逻辑吗？就算事后看过，不是你写的东西，过后还有印象吗？也让我想起了  Anthropic 在 <a href="https://juejin.cn/post/7579555970594947113" target="_blank" title="https://juejin.cn/post/7579555970594947113">《How AI Is Transforming Work at Anthropic》</a> 文章里提到过的：</p>
<blockquote>
<p>“我以为我喜欢写代码，其实我只是喜欢代码跑通的结果”。</p>
</blockquote>
<p>这也让我开始怀疑，我究竟是喜欢写代码，还是只是单纯喜欢跑通产品？在这个过程中，AI 带来的短期能力提升，很容易就让人对自己的定位产生误差，实际上这个过程有没有发现你的能力可能正在倒退？</p>
<p>这种<strong>职业认同的危机不只是外部开发者有， Claude 内部开发者也有这个焦虑</strong>，所以未来 AI 对于开发者的影响，还可能会带来新的职业价值观的重构，所以有人感到迷茫：<strong>如果写代码这个动作本身不再重要，那么以后作为软件工程师的身份认同建立在哪里</strong>？</p>
<blockquote>
<p>而在这个过程里，<strong>AI 能显著增加产量并扩展个人可承担任务的范围，但同时带来技能退化风险</strong>。</p>
</blockquote>
<p>如今 AI 越来越强已经是时代必然的浪潮，而 AI 现在的缺陷也会很快被时代所修复，就像 Google 的 <a href="https://juejin.cn/post/7576181242582892607" target="_blank" title="https://juejin.cn/post/7576181242582892607">Nested  Learning</a>  论文介绍的，现在大模型的问题在于<strong>大模型无法在训练后继续学习</strong> ，因为目前的大模型只有<strong>极快且短暂的记忆</strong>（In-Context Learning）和<strong>冻结的长期记忆（Pre-trained Weights）</strong> ，这个问题在于：</p>
<blockquote>
<p>当前模型缺乏将“即时对话”转化为“长期参数”的机制，也就是它们缺乏中间的频谱：<strong>那些应该从短期逐渐变为长期的记忆</strong>。</p>
</blockquote>
<p>但是这个问题已经被他们通过全新的 HOPE 架构攻克，未来<strong>能“吃一堑长一智”的 AI 也许离我们就不远了</strong>，所以编程能力对于程序员来说，未来是一个什么地位？这个职业的核心竞争力又在哪里？</p>
<p>在开发实现过程中 AI 很强，但是我们需要清晰的知道，<strong>AI 的强大的编程能力并不是你的能力，而作为程序员，你竞争力也不再是</strong>：</p>
<ul>
<li>熟练掌握某些框架和 API</li>
<li>精通某个语言和语法</li>
</ul>
<p>在这些方面，人是跑不过机器的，就像 <a href="https://juejin.cn/post/7584729714339250195" target="_blank" title="https://juejin.cn/post/7584729714339250195">《  OpenAI  使用 Codex 在 28 天内构建 Android 版 Sora》</a> 里介绍的：</p>
<blockquote>
<p>在使用 GPT-5.1-Codex 之后，在短短 28 天内，不仅完成了繁重的开发任务，还创造了上线 24 小时生成 100 万视频、99.9% 无崩溃率的应用，在这个过程里AI 可以 24 小时无间断编写代码和自我修复，28 天通过 50 亿 token 完成了正常需要几个月的产品上线。</p>
</blockquote>
<p>所以从这里可以看到，你如果想和 AI 拼编码能力肯定是拼不过的，就像 OpenAI 最后总结的：<strong>未来的开发工程师的能力不再是打字速度或语法 API 记忆，而是对系统的深刻洞察力。</strong></p>
<p>直到看到 OpenAI  和 Anthropic 等模型公司对于程序员未来的思考时，我才明白不能再沉迷于 AI 编程给自己带来的“成就感”，因为那是 AI 的能力而不是你的，<strong>你用 AI 可以做到，那别人用 AI 是不是也能做到，那你的职业竞争力在哪里</strong>？</p>
<blockquote>
<p>未来的开发者，强的可能不是代码能力，而是项目管理和 AI 驯服能力。</p>
</blockquote>
<p>所以未来程序员的职业能力肯定会发现变化，比如 2026 对于开发者来说，<strong>短期的价值会体现在如何驯服 AI</strong> ，因为现在的 AI 还是一批脱缰的野马，他的保证就像是“事前”的承诺，各种言之凿凿让你相信它：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de1b143a7a54428803ad5ddb57b13c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=nLA0hRhAuuidTgf9iibjVAymlAs%3D" alt="" loading="lazy"/></p>
<p>而事后提起裤子，出问题了它可半点不认，所以<strong>如何驯服 AI ，同时如何管理和做好大模型善后工程师，这将是程序员短期内的职业变化</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65b268e5419642d7925522fec6dcf45c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336971&amp;x-signature=RRDXTLPqV9kxqTt7sL%2BcksYg49g%3D" alt="" loading="lazy"/></p>
<p>而如何驯服 AI ，其实也很简单，<strong>那就是不要上来就让 AI 执行需求，而是给 AI 规划好需求和规则</strong>，把 AI 看作是一个“<em>高能力但缺乏背景的资深新员工</em>”，而你负责架构设计、用户体验和最终决策，而 AI 负责写代码、单元测试和需求落地。</p>
<p>因为 AI 的短板在于目前对于需求的理解还不够，也不擅长得深层的架构权衡（经常为了实现功能而把代码写乱），因为它的 Context 有限，所以经常都会比较片面去理解项目，所以作为程序员，你需要做的是：</p>
<ul>
<li><strong>先规划后代码</strong>：先让 AI 理解系统并编写“设计文档”，纠偏后再执行</li>
<li><strong>背景信息驱动</strong>：通过各种文件文档为 AI 提供规范和上下文，比如各种 rule 和模块描述</li>
<li><strong>增加技能支持</strong> :  通过各种技能描述让 AI 能力增加，比如 CC 可以通过 skills 加载各种插件来辅助能力提升</li>
</ul>
<p>举个例子，比如你要用 Flutter 做一个 Wallet App ，而任务是开发一个 <code>TransactionDetail</code> 模块，需求是：</p>
<ul>
<li>必须遵循 Clean Architecture (Domain -&gt; Data -&gt; Presentation)</li>
<li>数据敏感，金额精度（Decimal）、哈希脱敏显示有严格规范</li>
<li>状态管理，强制使用 <code>riverpod_generator</code> + <code>freezed</code></li>
</ul>
<p>那么在 Claude Code 场景，首先接下来你需要做的会是：</p>
<h3 data-id="heading-0">一、增加 Skill</h3>
<p>这里的核心是教 AI <strong>“在这个团队里，如何标准化地生产一个 Feature”</strong> ，例如创建一个 <code>skills/flutter-clean-feature/</code>  ：</p>
<ol>
<li>
<p><strong><code>SKILL.md</code></strong></p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: flutter-clean-feature
description: 能够按 Clean Architecture 标准生成全套 Flutter 功能模块
<span class="hljs-section">usage: "当用户想开发新页面或功能模块时使用"
---</span>

<span class="hljs-section"># 标准工作流 (SOP)</span>
AI 在执行此 Skill 时，必须严格遵守以下顺序：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**Phase 1: 领域建模 (Domain First)**</span>
<span class="hljs-bullet">    -</span> 读取 <span class="hljs-code">`references/domain_rules.md`</span>。
<span class="hljs-bullet">    -</span> 优先定义 Entity 和 Repository 接口。
<span class="hljs-bullet">    -</span> <span class="hljs-emphasis">*Check*</span>: 所有的金额字段必须使用 <span class="hljs-code">`Decimal`</span> 类型，禁止使用 <span class="hljs-code">`double`</span>。

<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**Phase 2: 架构脚手架 (Scaffolding)**</span>
<span class="hljs-bullet">    -</span> 调用 <span class="hljs-code">`scripts/scaffold_module.py`</span> 自动生成文件夹和空文件。
<span class="hljs-bullet">    -</span> 路径结构必须是 <span class="hljs-code">`lib/features/&lt;name&gt;/{data,domain,presentation}`</span>。

<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**Phase 3: 实现与绑定**</span>
<span class="hljs-bullet">    -</span> 实现 Repository 时，必须使用 <span class="hljs-code">`fpdart`</span> 处理 <span class="hljs-code">`Either&lt;Failure, T&gt;`</span>。
<span class="hljs-bullet">    -</span> UI 层必须使用 <span class="hljs-code">`AsyncValue`</span> 处理加载状态。
</code></pre>
</li>
<li>
<p><strong><code>references/domain_rules.md</code> (知识库)</strong></p>
<ul>
<li>包含团队约定的 Clean Architecture 分层图</li>
<li>包含 JSON 解析的通用错误处理模版</li>
</ul>
</li>
<li>
<p><strong><code>assets/repo_template.dart</code> (模版)</strong></p>
<ul>
<li>预置了带有 <code>Either</code> 返回值的 Repository 接口模版</li>
</ul>
</li>
<li>
<p><strong><code>scripts/scaffold_module.py</code> (自动化工具)</strong></p>
<ul>
<li>一个 Python 脚本，接受模块名参数，自动在 <code>lib/features/</code> 下创建标准的文件夹结构和基础文件（解决 AI 有时候懒得创建文件的毛病）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、增加上下文信息</h3>
<p>核心思想就是告诉 AI “这个项目现有的基础设施是什么” ，比如项目维护一个 <code>CLAUDE.md</code>，提供项目级上下文：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># CryptoWallet Project Context</span>

<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> Flutter 3.24
<span class="hljs-bullet">-</span> Riverpod (Annotation mode only)
<span class="hljs-bullet">-</span> Dio (已封装在 <span class="hljs-code">`lib/core/network/dio_client.dart`</span>)
<span class="hljs-bullet">-</span> UI Kit (所有按钮必须使用 <span class="hljs-code">`lib/core/widgets/app_button.dart`</span>)

<span class="hljs-section">## 现有能力</span>
<span class="hljs-bullet">-</span> 格式化工具：<span class="hljs-code">`lib/core/utils/formatters.dart`</span> (包含 hash 截断、货币格式化)
<span class="hljs-bullet">-</span> 路由：GoRouter，路由定义在 <span class="hljs-code">`lib/routes.dart`</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">三、先规划后代码 (Plan)</h3>
<p>可以利用 Claude Code 的交互能力，先加载 Skill 进行规划，审核无误后再由 Skill 中的 Script 自动执行，例如：</p>
<p><strong>1. 启动与规划</strong></p>
<blockquote>
<p>"使用 skill: flutter-clean-feature，我要开发一个 TransactionDetail 模块，输入是 txHash，需要展示交易金额、时间、发送方和接收方。"`</p>
</blockquote>
<blockquote>
<p><strong>Claude (加载 Skill)</strong>: <em>读取 <code>skills/flutter-clean-feature/SKILL.md</code>...</em> <em>读取 <code>CLAUDE.md</code> 获取项目上下文...</em></p>
<p><strong>Claude (输出规划)</strong>: 根据 <strong>Flutter Clean Feature SOP</strong>，我制定了以下计划：</p>
<ol>
<li><strong>Domain</strong>: 定义 <code>TransactionEntity</code> (包含 <code>Decimal amount</code>) 和 <code>ITransactionRepo</code>。</li>
<li><strong>Scaffold</strong>: 运行脚本创建 <code>lib/features/transaction_detail/...</code> 目录。</li>
<li><strong>Data</strong>: 实现 Repo，调用 Context 中提到的 <code>DioClient</code>。</li>
<li><strong>Presentation</strong>: 使用 <code>riverpod_generator</code> 创建 <code>transactionDetailProvider</code>。</li>
</ol>
<p><strong>请确认</strong>：是否需要支持“交易状态（成功/失败）”的枚举？</p>
</blockquote>
<p><strong>2.  Review 优化</strong></p>
<blockquote>
<p><strong>User</strong>: "需要。另外，UI 上金额显示需要调用 <code>formatters.dart</code> 里的方法，不要自己写格式化逻辑。"</p>
</blockquote>
<p><strong>3. 执行</strong></p>
<blockquote>
<p><strong>Claude</strong>: 收到。开始执行。</p>
</blockquote>
<p><em>(Claude 内部触发 Skill 中的 Script)</em> <code>Run script: python skills/flutter-clean-feature/scripts/scaffold_module.py transaction_detail</code> ：</p>
<blockquote>
<p><strong>Terminal Output</strong>:
✅ Created lib/features/transaction_detail/domain
✅ Created lib/features/transaction_detail/data
✅ Created lib/features/transaction_detail/presentation</p>
</blockquote>
<p><em>(Claude 继续编写代码)</em> Claude 根据 <code>assets/repo_template.dart</code> 填充 <code>transaction_repository.dart</code>，并根据 <code>CLAUDE.md</code> 里的规则，引入了 <code>dio_client.dart</code>。</p>
<p>······</p>
<p>是不是觉得很繁琐？是不是觉得一轮整下来我需求都写完了？但是这就是使用 AI 的趋势，只有这样才能控制和管理好 AI 的代码，不至于让 AI 写出一坨屎山，而随着你对工程文档和技能补充的完善，你的开发速度就会越来越快，AI 也能像是你多年的老哥们一样懂你需求，比如 ：</p>
<blockquote>
<p><code>CLAUDE.md</code> 确保了 AI 不会引入 <code>http</code> 库（因为它知道有 <code>Dio</code>），也不会手写丑陋的按钮（因为它知道有 <code>AppButton</code>），它理解了项目的现状，知道有什么技能可用，然后通过规划很你完成确认，这些写出来的代码和项目才是可持续维护的。</p>
</blockquote>
<p>最后，这一年里我出了用 AI 写代码之外，也开始尝试用 AI 去解决和尝试代码之外的事情，因为 AI 所以我敢于尝试一些以前不敢接触的领域，因为过程学习成本太高，而现在 AI 提供了另外一种思路：</p>
<blockquote>
<p><strong>我不需要真的懂，我只需要让 AI 去做就好了，而我只需要提供想法和验证结果</strong>。</p>
</blockquote>
<p>2025 即将结束，而 2026 也会如期而至，而 AI 的浪潮从未停歇，<strong>愿你我都能在新的浪潮下找到自己的位置</strong>~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 5 篇：Pinia 状态管理 - 从混乱代码到优雅架构]]></title>    <link>https://juejin.cn/post/7587738151658881024</link>    <guid>https://juejin.cn/post/7587738151658881024</guid>    <pubDate>2025-12-26T07:12:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587738151658881024" data-draft-id="7587277503947341824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 5 篇：Pinia 状态管理 - 从混乱代码到优雅架构"/> <meta itemprop="keywords" content="前端,Vue.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-26T07:12:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 5 篇：Pinia 状态管理 - 从混乱代码到优雅架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:12:19.000Z" title="Fri Dec 26 2025 07:12:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>状态管理是前端应用的"心脏"，但很多人一提到 Pinia/Vuex 就头疼：Store 该怎么设计？持久化怎么做？登录态怎么维护？这篇文章以<strong>心动恋聊</strong>小程序为例，通过和 AI 的<strong>真实对话</strong>，展示如何从零搭建一个完整的用户状态管理系统。</p>
<p><strong>系列专栏</strong>：<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">【AI 编程实战：TRAE SOLO 全栈开发指南】</a></p>
<p><strong>本篇主题</strong>：Pinia 状态管理 - 从混乱代码到优雅架构</p>
<p><strong>实战项目</strong>：心动恋聊 - AI 恋爱聊天助手</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：状态管理的痛点</h2>
<h3 data-id="heading-1">1.1 没有状态管理时的混乱</h3>
<p>在没有集中式状态管理之前，我的代码是这样的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 页面 A：登录后保存用户信息</span>
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'userInfo'</span>, userData);
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token);
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 页面 B：读取用户信息</span>
<span class="hljs-keyword">const</span> userInfo = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
<span class="hljs-keyword">const</span> isLoggedIn = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>);

<span class="hljs-comment">// 页面 C：更新用户信息</span>
<span class="hljs-keyword">const</span> userInfo = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
userInfo.<span class="hljs-property">avatar</span> = newAvatar;
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'userInfo'</span>, userInfo);

<span class="hljs-comment">// 页面 D：判断登录状态</span>
<span class="hljs-keyword">if</span> (uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>)) {
  <span class="hljs-comment">// 已登录逻辑</span>
}
</code></pre>
<p><strong>问题显而易见</strong>：</p>
<ul>
<li>每个页面都在重复读写 Storage</li>
<li>状态分散在各处，难以追踪</li>
<li>修改一处，容易漏改其他地方</li>
<li>没有响应式，页面不会自动更新</li>
</ul>
<h3 data-id="heading-2">1.2 我需要什么</h3>
<p>我需要一个<strong>集中式的用户状态管理</strong>：</p>
<ul>
<li>统一管理用户信息、登录态</li>
<li>支持持久化（刷新不丢失）</li>
<li>响应式更新（数据变化，页面自动刷新）</li>
<li>多种登录方式支持（微信、手机号）</li>
</ul>
<p>但我对 Pinia 不熟悉，于是开始和 AI 对话。</p>
<h2 data-id="heading-3">二、基础 Store 搭建</h2>
<h3 data-id="heading-4">2.1 我的第一句话</h3>
<pre><code class="hljs language-txt" lang="txt">我：项目需要用户状态管理，用 Pinia 实现。
    要管理用户信息、登录状态，支持登录、退出功能。
</code></pre>
<h3 data-id="heading-5">2.2 AI 先问问题</h3>
<pre><code class="hljs language-txt" lang="txt">AI：好的，我来帮你搭建用户状态管理。先确认几个问题：

🤔 问题：
1. 项目技术栈是什么？（Vue3/UniApp/其他）
2. 用户信息需要哪些字段？
3. 登录方式有哪些？（账号密码/微信/手机号）
4. 需要持久化吗？（刷新页面后保持登录）

请告诉我这些信息，我来设计 Store 结构。
</code></pre>
<h3 data-id="heading-6">2.3 我补充信息</h3>
<pre><code class="hljs language-txt" lang="txt">我：UniApp + Vue3 项目，跑微信小程序。
    用户信息：user_id、username、avatar、gender、phone_number、vip_status 这些。
    登录方式：主要是微信登录，后面可能加手机号登录。
    需要持久化，用户登录后刷新不能退出。
</code></pre>
<h3 data-id="heading-7">2.4 AI 给出执行计划</h3>
<pre><code class="hljs language-txt" lang="txt">AI：明白了，我来设计 Store 结构。

📋 执行计划：

1. 创建 src/store/index.ts - Pinia 入口配置
2. 创建 src/store/user.ts - 用户状态管理
3. 在 main.ts 中注册 Pinia

📐 Store 结构设计：

src/store/
├── index.ts      # Pinia 实例 + 插件配置
└── user.ts       # 用户状态管理
    ├── state     # userInfo, isLoggedIn
    ├── getters   # genderDisplay, isVip
    └── actions   # login, logout, updateUserInfo

🤔 关于语法风格，有两种选择：
1. Options API 风格：state/getters/actions 分开写
2. Setup 风格：用 ref/computed/function，更灵活

你想用哪种风格？
</code></pre>
<pre><code class="hljs language-txt" lang="txt">我：用 Setup 风格吧，看起来更简洁
</code></pre>
<h3 data-id="heading-8">2.5 AI 生成基础代码</h3>
<pre><code class="hljs language-txt" lang="txt">AI：好的，开始生成代码...

✅ 创建 src/store/index.ts
✅ 创建 src/store/user.ts
✅ 修改 main.ts

基础结构已完成，这是核心代码：
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/index.ts</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 用户信息类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfo</span> {
  <span class="hljs-attr">user_id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
  gender?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 1: 男, 2: 女</span>
  phone_number?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">vip_status</span>: <span class="hljs-string">'none'</span> | <span class="hljs-string">'vip'</span> | <span class="hljs-string">'expired'</span>;
}

<span class="hljs-comment">// 初始状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">initialUserInfo</span>: <span class="hljs-title class_">UserInfo</span> = {
  <span class="hljs-attr">user_id</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">avatar</span>: <span class="hljs-string">'/static/images/default-avatar.png'</span>,
  <span class="hljs-attr">gender</span>: <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">phone_number</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">vip_status</span>: <span class="hljs-string">'none'</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// ===== 状态 =====</span>
  <span class="hljs-keyword">const</span> userInfo = ref&lt;<span class="hljs-title class_">UserInfo</span>&gt;({ ...initialUserInfo });
  <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// ===== 计算属性 =====</span>
  <span class="hljs-keyword">const</span> isVip = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">vip_status</span> === <span class="hljs-string">'vip'</span>);

  <span class="hljs-comment">// ===== 方法 =====</span>

  <span class="hljs-comment">/** 设置用户信息 */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setUserInfo</span> = (<span class="hljs-params">info: UserInfo</span>) =&gt; {
    userInfo.<span class="hljs-property">value</span> = { ...initialUserInfo, ...info };
    isLoggedIn.<span class="hljs-property">value</span> = !!info.<span class="hljs-property">user_id</span>;
  };

  <span class="hljs-comment">/** 清除用户信息 */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
    userInfo.<span class="hljs-property">value</span> = { ...initialUserInfo };
    isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  };

  <span class="hljs-comment">/** 退出登录 */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">clearUserInfo</span>();
  };

  <span class="hljs-keyword">return</span> {
    userInfo,
    isLoggedIn,
    isVip,
    setUserInfo,
    clearUserInfo,
    logout,
  };
});
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：基础 Store 已创建。使用方式：

// 在组件中
import { useUserStore } from '@/store'

const userStore = useUserStore()

// 读取状态
console.log(userStore.userInfo.username)
console.log(userStore.isLoggedIn)

// 调用方法
userStore.setUserInfo({ user_id: '123', username: '小明', ... })
userStore.logout()

现在可以测试一下基础功能。
</code></pre>
<h2 data-id="heading-9">三、持久化配置</h2>
<h3 data-id="heading-10">3.1 我发现刷新后状态丢失</h3>
<p>测试后，我发现一个问题：</p>
<pre><code class="hljs language-txt" lang="txt">我：登录后刷新页面，状态丢失了，又变成未登录状态。
    你不是说要支持持久化吗？
</code></pre>
<h3 data-id="heading-11">3.2 AI 解释并修复</h3>
<pre><code class="hljs language-txt" lang="txt">AI：抱歉，我忘了加持久化配置。

🔍 原因：
Pinia 默认不持久化，状态只存在内存中，刷新就没了。

🔧 解决方案：
使用 pinia-plugin-persistedstate 插件，自动将状态同步到 Storage。

⚠️ 小程序注意：
小程序没有 localStorage，需要用 uni.getStorageSync/setStorageSync。

我来修改配置...
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/index.ts（修改后）</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> { createPersistedState } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>;

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createPinia</span>();

<span class="hljs-comment">// 配置持久化插件，适配小程序存储 API</span>
store.<span class="hljs-title function_">use</span>(
  <span class="hljs-title function_">createPersistedState</span>({
    <span class="hljs-attr">storage</span>: {
      <span class="hljs-attr">getItem</span>: uni.<span class="hljs-property">getStorageSync</span>,
      <span class="hljs-attr">setItem</span>: uni.<span class="hljs-property">setStorageSync</span>,
    },
  }),
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加持久化配置）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有代码不变</span>
  },
  {
    <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启持久化</span>
  },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：
✅ 已安装 pinia-plugin-persistedstate
✅ 已修改 src/store/index.ts
✅ 已修改 src/store/user.ts

现在刷新页面，登录状态会保持。

⚠️ 注意：
persist: true 会持久化整个 state。
如果某些状态不想持久化，可以用 paths 指定：

{
  persist: {
    paths: ['userInfo', 'isLoggedIn'],  // 只持久化这些
  },
}
</code></pre>
<h3 data-id="heading-12">3.3 我验证修复成功</h3>
<pre><code class="hljs language-txt" lang="txt">我：好了，刷新后状态保持了。但我还有个问题：
    token 现在是存在 Store 里还是 Storage 里？
</code></pre>
<h3 data-id="heading-13">3.4 AI 解释 Token 存储策略</h3>
<pre><code class="hljs language-txt" lang="txt">AI：好问题！目前 token 没有放在 Store 里。

🤔 关于 Token 存储，有两种策略：

【策略一】Token 放 Store（持久化到 Storage）
优点：统一管理，响应式
缺点：Store 初始化前无法使用

【策略二】Token 单独存 Storage（推荐）
优点：HTTP 拦截器可以直接读取，不依赖 Store 初始化
缺点：需要单独管理

📌 推荐策略二，原因：
HTTP 请求拦截器需要在应用启动最早期就能获取 token，
此时 Store 可能还没初始化完成。

代码示例：
// 登录成功时
uni.setStorageSync('token', response.token)
setUserInfo(response.user)

// HTTP 拦截器中
const token = uni.getStorageSync('token')

你想用哪种策略？
</code></pre>
<pre><code class="hljs language-txt" lang="txt">我：用策略二，Token 单独存
</code></pre>
<h2 data-id="heading-14">四、完善登录流程</h2>
<h3 data-id="heading-15">4.1 我要添加微信登录</h3>
<pre><code class="hljs language-txt" lang="txt">我：现在要加微信登录功能。
    流程是：调用 uni.login 获取 code → 发给后端换 token 和用户信息。
</code></pre>
<h3 data-id="heading-16">4.2 AI 设计登录方法</h3>
<pre><code class="hljs language-txt" lang="txt">AI：明白，我来添加微信登录方法。

📋 执行计划：
1. 添加 wechatLogin 方法到 userStore
2. 处理登录成功：保存 token + 设置用户信息
3. 处理登录失败：提示错误

🤔 问题：
1. 登录 API 接口路径是什么？
2. 登录成功后要不要自动跳转？
3. 需要 loading 和 toast 提示吗？
</code></pre>
<pre><code class="hljs language-txt" lang="txt">我：API 是 /api/auth/wechat-login，参数是 { code }。
    不需要自动跳转，由调用方决定。
    需要 toast 提示成功/失败。
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：好的，添加登录方法：
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加登录方法）</span>
<span class="hljs-keyword">import</span> { toast } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/toast'</span>;
<span class="hljs-keyword">import</span> { loginByWechat } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/auth'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有状态和方法</span>

    <span class="hljs-comment">/**
     * 微信登录
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">wechatLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loginByWechat</span>({ code });

        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> !== <span class="hljs-number">200</span>) {
          toast.<span class="hljs-title function_">error</span>(response.<span class="hljs-property">msg</span> || <span class="hljs-string">'登录失败'</span>);
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(response.<span class="hljs-property">msg</span> || <span class="hljs-string">'登录失败'</span>);
        }

        <span class="hljs-keyword">const</span> { token, user } = response.<span class="hljs-property">data</span>;

        <span class="hljs-comment">// 保存 token（单独存 Storage）</span>
        uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token);

        <span class="hljs-comment">// 设置用户信息</span>
        <span class="hljs-title function_">setUserInfo</span>(user);

        toast.<span class="hljs-title function_">success</span>(<span class="hljs-string">'登录成功'</span>);
        <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'微信登录失败:'</span>, error);
        toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">'登录失败，请稍后再试'</span>);
        <span class="hljs-keyword">throw</span> error;
      }
    };

    <span class="hljs-comment">/**
     * 退出登录（更新）
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">clearUserInfo</span>();
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>); <span class="hljs-comment">// 清除 token</span>
      toast.<span class="hljs-title function_">success</span>(<span class="hljs-string">'已退出登录'</span>);
    };

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// ... 原有导出</span>
      wechatLogin,
      logout,
    };
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：使用方式：

// 页面中调用
const handleWechatLogin = async () =&gt; {
  try {
    // 1. 获取微信 code
    const { code } = await new Promise((resolve, reject) =&gt; {
      uni.login({
        provider: 'weixin',
        success: resolve,
        fail: reject,
      })
    })

    // 2. 调用 Store 登录方法
    await userStore.wechatLogin(code)

    // 3. 登录成功后的操作（由页面决定）
    uni.navigateBack()
  } catch (error) {
    console.error('登录失败:', error)
  }
}
</code></pre>
<h3 data-id="heading-17">4.3 我追问：登录态初始化</h3>
<pre><code class="hljs language-txt" lang="txt">我：还有个问题，应用启动时怎么恢复登录态？
    比如用户之前登录过，打开应用应该自动是登录状态。
</code></pre>
<h3 data-id="heading-18">4.4 AI 添加初始化逻辑</h3>
<pre><code class="hljs language-txt" lang="txt">AI：需要添加一个初始化方法，在应用启动时调用。

🔍 初始化逻辑：
1. 检查本地是否有 token 和 userInfo
2. 如果有，恢复登录状态
3. 异步请求最新用户信息（token 可能过期）
4. 如果 token 过期，清除登录态
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加初始化方法）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有代码</span>

    <span class="hljs-comment">/**
     * 初始化用户状态（应用启动时调用）
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">initializeUserState</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>);
      <span class="hljs-keyword">const</span> savedUserInfo = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
      <span class="hljs-keyword">const</span> savedLoginStatus = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>);

      <span class="hljs-comment">// 检查是否有完整的登录信息</span>
      <span class="hljs-keyword">if</span> (token &amp;&amp; savedUserInfo?.<span class="hljs-property">user_id</span> &amp;&amp; savedLoginStatus) {
        <span class="hljs-comment">// 恢复登录态</span>
        userInfo.<span class="hljs-property">value</span> = savedUserInfo;
        isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 异步获取最新用户信息（校验 token 有效性）</span>
        <span class="hljs-title function_">loadUserInfo</span>();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 清除可能存在的无效数据</span>
        <span class="hljs-title function_">clearUserInfo</span>();
        uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
      }
    };

    <span class="hljs-comment">/**
     * 从服务器加载最新用户信息
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiGetUserInfo</span>();
        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
          <span class="hljs-title function_">setUserInfo</span>(response.<span class="hljs-property">data</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// token 可能已过期</span>
          <span class="hljs-title function_">clearUserInfo</span>();
          uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户信息失败:'</span>, error);
        <span class="hljs-title function_">clearUserInfo</span>();
        uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
      }
    };

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// ... 原有导出</span>
      initializeUserState,
      loadUserInfo,
    };
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：在 App.vue 的 onLaunch 中调用初始化：

// App.vue
&lt;script setup lang="ts"&gt;
import { useUserStore } from '@/store'

const userStore = useUserStore()

onLaunch(() =&gt; {
  userStore.initializeUserState()
})
&lt;/script&gt;

这样应用启动时会自动恢复登录态。
</code></pre>
<h2 data-id="heading-19">五、计算属性与统一更新</h2>
<h3 data-id="heading-20">5.1 我需要显示性别文本</h3>
<pre><code class="hljs language-txt" lang="txt">我：用户信息里 gender 是数字（1=男，2=女），
    但页面上要显示"男生"、"女生"，每次都要写判断很麻烦。
</code></pre>
<h3 data-id="heading-21">5.2 AI 添加计算属性</h3>
<pre><code class="hljs language-txt" lang="txt">AI：用计算属性（computed）解决，在 Store 里统一处理。

这样所有页面都可以直接用 userStore.genderDisplay，不用重复判断。
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加计算属性）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GenderEnum</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ... 原有状态</span>

    <span class="hljs-comment">// ===== 计算属性 =====</span>

    <span class="hljs-comment">/** 性别显示文本 */</span>
    <span class="hljs-keyword">const</span> genderDisplay = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">switch</span> (userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">gender</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">MALE</span>: <span class="hljs-comment">// 1</span>
          <span class="hljs-keyword">return</span> <span class="hljs-string">'男生'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">FEMALE</span>: <span class="hljs-comment">// 2</span>
          <span class="hljs-keyword">return</span> <span class="hljs-string">'女生'</span>;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'未设置'</span>;
      }
    });

    <span class="hljs-comment">/** 是否是 VIP */</span>
    <span class="hljs-keyword">const</span> isVip = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">vip_status</span> === <span class="hljs-string">'vip'</span>);

    <span class="hljs-comment">/** 根据性别获取默认头像 */</span>
    <span class="hljs-keyword">const</span> defaultAvatarByGender = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">switch</span> (userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">gender</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">MALE</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'/static/images/avatar-male.png'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">GenderEnum</span>.<span class="hljs-property">FEMALE</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'/static/images/avatar-female.png'</span>;
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-string">'/static/images/avatar-default.png'</span>;
      }
    });

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 状态</span>
      userInfo,
      isLoggedIn,
      <span class="hljs-comment">// 计算属性</span>
      genderDisplay,
      isVip,
      defaultAvatarByGender,
      <span class="hljs-comment">// 方法</span>
      <span class="hljs-comment">// ...</span>
    };
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：使用方式：

&lt;template&gt;
  &lt;view&gt;
    &lt;text&gt;性别：{{ userStore.genderDisplay }}&lt;/text&gt;
    &lt;image :src="userStore.userInfo.avatar || userStore.defaultAvatarByGender" /&gt;
    &lt;text v-if="userStore.isVip"&gt;VIP 用户&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;

📌 计算属性的好处：
1. 逻辑集中，不用每个页面重复写
2. 响应式，userInfo 变化自动更新
3. 有缓存，多次访问只计算一次
</code></pre>
<h3 data-id="heading-22">5.3 我追问：更新用户信息</h3>
<pre><code class="hljs language-txt" lang="txt">我：用户在"我的"页面可以修改性别、昵称，
    修改后要同步更新 Store 和服务器，怎么做比较好？
</code></pre>
<h3 data-id="heading-23">5.4 AI 添加统一更新方法</h3>
<pre><code class="hljs language-txt" lang="txt">AI：添加一个统一的更新方法，封装 API 调用 + Store 更新 + 提示。

这样所有修改用户信息的地方都调用同一个方法，保证一致性。
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（添加更新方法）</span>
<span class="hljs-keyword">import</span> { updateUserInfo <span class="hljs-keyword">as</span> apiUpdateUserInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/auth'</span>;

<span class="hljs-comment">/**
 * 统一更新用户信息
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">updateData</span> - 要更新的字段
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">successMessage</span> - 成功提示，默认"修改成功"
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  updateData: Partial&lt;Pick&lt;UserInfo, <span class="hljs-string">'gender'</span> | <span class="hljs-string">'username'</span> | <span class="hljs-string">'avatar'</span>&gt;&gt;,
  successMessage = <span class="hljs-string">'修改成功'</span>,
</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 调用 API 更新服务器</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiUpdateUserInfo</span>(updateData);

    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span> &amp;&amp; response.<span class="hljs-property">data</span>) {
      <span class="hljs-comment">// 2. 更新 Store（用服务器返回的最新数据）</span>
      <span class="hljs-title function_">setUserInfo</span>(response.<span class="hljs-property">data</span>);
      <span class="hljs-comment">// 3. 提示成功</span>
      toast.<span class="hljs-title function_">success</span>(successMessage);
    } <span class="hljs-keyword">else</span> {
      toast.<span class="hljs-title function_">error</span>(response.<span class="hljs-property">msg</span> || <span class="hljs-string">'修改失败'</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'更新用户信息失败:'</span>, error);
    toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">'修改失败，请稍后再试'</span>);
  }
};
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：使用方式：

// 修改性别
await userStore.updateUserInfo({ gender: 1 })

// 修改昵称，自定义提示
await userStore.updateUserInfo(
  { username: '新昵称' },
  '昵称修改成功'
)

// 同时修改多个
await userStore.updateUserInfo({
  username: '新昵称',
  avatar: 'https://xxx.com/avatar.png',
})
</code></pre>
<h2 data-id="heading-24">六、跨 Store 通信</h2>
<h3 data-id="heading-25">6.1 我遇到跨 Store 问题</h3>
<pre><code class="hljs language-txt" lang="txt">我：用户退出登录时，除了清除用户信息，还要清除聊天记录。
    聊天记录在另一个 chatSessionStore 里，怎么在 userStore 里调用它？
</code></pre>
<h3 data-id="heading-26">6.2 AI 解释跨 Store 通信</h3>
<pre><code class="hljs language-txt" lang="txt">AI：Pinia 支持在一个 Store 里调用另一个 Store。

⚠️ 注意事项：
1. 必须在 action（方法）内部调用，不能在 Store 定义的顶层调用
2. 这是因为顶层调用时，Pinia 可能还没初始化完成

❌ 错误写法：
const useChatStore = useChatSessionStore()  // 顶层调用，可能报错

✅ 正确写法：
const logout = () =&gt; {
  const chatStore = useChatSessionStore()  // 方法内部调用
  chatStore.reset()
}
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts（跨 Store 调用）</span>
<span class="hljs-keyword">import</span> { useChatSessionStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/chatSession'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(
  <span class="hljs-string">'user'</span>,
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ...</span>

    <span class="hljs-comment">/**
     * 清除用户信息
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
      userInfo.<span class="hljs-property">value</span> = { ...initialUserInfo };
      isLoggedIn.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;

      <span class="hljs-comment">// 清除本地存储</span>
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'userInfo'</span>);
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>);
      uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'isLoggedIn'</span>);

      <span class="hljs-comment">// 【跨 Store】清除聊天记录</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> chatStore = <span class="hljs-title function_">useChatSessionStore</span>();
        chatStore.<span class="hljs-title function_">reset</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'清理聊天记录失败:'</span>, error);
      }
    };

    <span class="hljs-comment">// ...</span>
  },
  { <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span> },
);
</code></pre>
<pre><code class="hljs language-txt" lang="txt">AI：现在退出登录时会自动清除聊天记录。

📌 跨 Store 通信场景：
1. 退出登录 → 清除所有业务数据
2. 登录成功 → 初始化其他 Store
3. VIP 状态变化 → 通知其他模块

如果跨 Store 调用很多，也可以考虑用事件总线解耦。
</code></pre>
<h2 data-id="heading-27">七、核心经验：状态管理的最佳实践</h2>
<h3 data-id="heading-28">7.1 Store 设计原则</h3>






























<table><thead><tr><th>原则</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>单一职责</td><td>一个 Store 管理一个领域</td><td>userStore、chatStore、uiStore</td></tr><tr><td>状态只读</td><td>用 readonly 包装，防止外部直接修改</td><td><code>readonly(userInfo)</code></td></tr><tr><td>方法封装</td><td>修改状态统一通过方法，不要直接赋值</td><td><code>setUserInfo()</code> 而不是 <code>userInfo.value = xxx</code></td></tr><tr><td>计算属性</td><td>派生状态用 computed，避免重复计算</td><td><code>genderDisplay</code>、<code>isVip</code></td></tr></tbody></table>
<h3 data-id="heading-29">7.2 持久化注意事项</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：持久化配置适配小程序</span>
store.<span class="hljs-title function_">use</span>(
  <span class="hljs-title function_">createPersistedState</span>({
    <span class="hljs-attr">storage</span>: {
      <span class="hljs-attr">getItem</span>: uni.<span class="hljs-property">getStorageSync</span>,
      <span class="hljs-attr">setItem</span>: uni.<span class="hljs-property">setStorageSync</span>,
    },
  }),
)

<span class="hljs-comment">// ⚠️ 注意：Token 单独存储</span>
uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token)  <span class="hljs-comment">// 不放 Store</span>

<span class="hljs-comment">// ⚠️ 注意：敏感信息不要持久化</span>
{
  <span class="hljs-attr">persist</span>: {
    <span class="hljs-attr">paths</span>: [<span class="hljs-string">'userInfo'</span>, <span class="hljs-string">'isLoggedIn'</span>],  <span class="hljs-comment">// 明确指定</span>
  },
}
</code></pre>
<h3 data-id="heading-30">7.3 跨 Store 通信规则</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误：在 Store 顶层调用其他 Store</span>
<span class="hljs-keyword">const</span> chatStore = <span class="hljs-title function_">useChatSessionStore</span>(); <span class="hljs-comment">// 可能报错</span>

<span class="hljs-comment">// ✅ 正确：在方法内部调用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> chatStore = <span class="hljs-title function_">useChatSessionStore</span>();
  chatStore.<span class="hljs-title function_">reset</span>();
};
</code></pre>
<h3 data-id="heading-31">7.4 初始化时机</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// App.vue - 应用启动时初始化</span>
<span class="hljs-title function_">onLaunch</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
  userStore.<span class="hljs-title function_">initializeUserState</span>();
});
</code></pre>
<h2 data-id="heading-32">八、总结：对话中学会状态管理</h2>
<h3 data-id="heading-33">8.1 迭代过程回顾</h3>



































<table><thead><tr><th>阶段</th><th>需求</th><th>成果</th></tr></thead><tbody><tr><td>基础搭建</td><td>创建 Store</td><td>状态定义、基础方法</td></tr><tr><td>数据持久化</td><td>刷新保持登录</td><td>pinia-plugin-persistedstate 配置</td></tr><tr><td>登录流程</td><td>微信登录 + 初始化</td><td>wechatLogin、initializeUserState</td></tr><tr><td>体验优化</td><td>派生状态 + 统一更新</td><td>genderDisplay、updateUserInfo</td></tr><tr><td>架构完善</td><td>跨 Store 通信</td><td>clearUserInfo 中调用 chatStore</td></tr></tbody></table>
<h3 data-id="heading-34">8.2 关键收获</h3>
<ol>
<li><strong>不要一次想清楚所有细节</strong>，先搭基础框架，遇到问题再补充</li>
<li><strong>让 AI 解释原理</strong>，比如"为什么 Token 不放 Store"，理解后才能举一反三</li>
<li><strong>注意平台差异</strong>，小程序没有 localStorage，需要用 uni.getStorageSync</li>
<li><strong>状态管理不只是存数据</strong>，计算属性、方法封装、跨 Store 通信都是关键</li>
</ol>
<h3 data-id="heading-35">8.3 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 6 篇：告别复制粘贴 - 设计一个优雅的 HTTP 模块》</strong></p>
<p>下一篇继续对话式协作，教你：</p>
<ul>
<li>如何设计 HTTP 请求/响应拦截器</li>
<li>Token 自动携带和刷新</li>
<li>统一错误处理和 Loading 管理</li>
</ul>
<hr/>
<blockquote>
<p>状态管理的核心不是"用什么库"，而是<strong>如何组织数据和逻辑</strong>。
通过和 AI 对话，你可以快速理清思路，少走弯路。</p>
<p>这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第五篇文章</p>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题]]></title>    <link>https://juejin.cn/post/7587729264184885311</link>    <guid>https://juejin.cn/post/7587729264184885311</guid>    <pubDate>2025-12-26T03:12:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587729264184885311" data-draft-id="7587712328826355748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题"/> <meta itemprop="keywords" content="前端,cesium"/> <meta itemprop="datePublished" content="2025-12-26T03:12:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:12:34.000Z" title="Fri Dec 26 2025 03:12:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">抽丝剥茧，找到真凶</h2>
<p>甲方反馈地图经常出现偶发性加载缓慢的问题</p>
<p>我寻思在我本地开发环境很快啊，上了测试环境也没毛病，咋个部署到正式环境就地图慢了？</p>
<p>经过排查发现每次地图加载缓慢时 <code>endpoint</code> 接口都在报错（控制台也提示 net::ERR_CONNECTION_TIMED_OUT），并且百度也无法访问(甲方项目部署在内网，访问公网不太流畅)</p>
<p>破案了！罪魁祸首就是这两个接口请求在报错（图片无错误是因为我网络好，这里假装它在报错）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36705965fdc243e2b8a4c28090d4d752~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=nTDEe%2BbD3F3sJPSglhtAs2fPlGg%3D" alt="1.png" loading="lazy"/></p>
<p><code>https://api.cesium.com/v1/assets/1/endpoint?access_token="你的token"</code>
<code>https://api.cesium.com/v1/assets/2/endpoint?access_token="你的token"</code></p>
<p>这两个接口请求分别是加载 cesium 默认的地形数据和地图瓦片（其中 assets/1 是地形，assets/2 是瓦片）由于 cesium 服务器在国外，所以网络波动等原因会导致访问不稳定，从而影响地图加载速度</p>
<p>哪怕你是调用了第三方的地图瓦片，比如天地图瓦片服务，如果网络不稳定也会出现此错误，它会阻塞地图的正常加载</p>
<p>要想彻底解决只有将它禁用</p>
<h2 data-id="heading-1">禁用 cesium 默认地图瓦片</h2>
<p>默认地图瓦片默认是启用的，需要手动禁用</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> viewer = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Viewer</span>(<span class="hljs-string">'CesiumViewer'</span>, {
  ...
  imageryProvider: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不加载默认底图</span>
  ...
})
</code></pre>
<p>我们来测试下效果，这里放图片（算了不放了，节约文章空间）</p>
<h2 data-id="heading-2">禁用 cesium 默认地形数据</h2>
<p>地形默认是不启用的，如果你自己启动了，把它注释了就可以了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> viewer = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Viewer</span>(<span class="hljs-string">'CesiumViewer'</span>, {
  ...
  terrain: Cesium.Terrain.<span class="hljs-built_in">fromWorldTerrain</span>(), <span class="hljs-comment">// 使用Cesium官方的地形服务 全球地形数据</span>
  ...
})
</code></pre>
<p>注意：我的 Cesium 版本为 1.128，不同版本的启动地形和加载默认地图方法会不一样，请根据你项目中的版本去官方查找对应的 api 进行修改</p>
<p>刚接触三维地图的朋友可能会问，地形是个什么玩意？开启与关闭有何区别？这里我放两张截图来作对比（采用同样的视角）</p>
<p>这是加载地形的效果：可以看见，山势有明显的高低起伏</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3d6d2e44ec4586afa695499e0d26af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=Qabf4eA3KGOhWKJwyw6KQLNc15g%3D" alt="2.png" loading="lazy"/></p>
<p>这是关闭地形的效果：可以看见，山的高度没了，地图的 3D 立体变成了二维扁平</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b3aa42bf15f48a78e9655827cfe776a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=D5hS5QIht2e%2FZmMeR27urHfqiWg%3D" alt="3.png" loading="lazy"/></p>
<h2 data-id="heading-3">结语</h2>
<p>细心的朋友可能会问，既然地形对于三维地图如此重要，那么把他禁用了那岂不是效果大打折扣吗？是的，那么有什么办法，既能解决网络不好时报错，又能使地形存在呢？</p>
<p>办法是有的，那就是自己部署地形服务并调用，不从 cesium 官方获取地形接口即可</p>
<p>具体如何操作？如果有人感兴趣的话就下次再写吧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同事查日志太慢，我现场教他一套 awk、tail、grep、sed 组合拳]]></title>    <link>https://juejin.cn/post/7587714124856770614</link>    <guid>https://juejin.cn/post/7587714124856770614</guid>    <pubDate>2025-12-26T01:35:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587714124856770614" data-draft-id="7587712328825847844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="同事查日志太慢，我现场教他一套 awk、tail、grep、sed 组合拳"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-26T01:35:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小富"/> <meta itemprop="url" content="https://juejin.cn/user/993614241734270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            同事查日志太慢，我现场教他一套 awk、tail、grep、sed 组合拳
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614241734270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小富
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T01:35:50.000Z" title="Fri Dec 26 2025 01:35:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天临下班，生产环境出现了一个偶发的报错预警。</p>
<p>旁边的同事正~~准备排查，只见他输入命令 <code>cat application.log</code> ，一个 <strong>2GB</strong> 大小文本啊，日志哗哗刷啥也看不清，crtl + c 也停不下来了，最后轻轻的关闭连接，又重新打开了一个～</p>
<p>后端开发来说，熟练掌握 Linux 的日志分析命令是基本功，整理几一些基于 <code>tail</code>、<code>less</code>、<code>grep</code>、<code>sed</code>、<code>awk</code> 的日志查询场景，希望能帮你快速定位问题。</p>
<h3 data-id="heading-0">tail</h3>
<p>很多新手习惯用 <code>cat</code>，但对于大文件，<code>cat</code> 会导致屏幕刷屏，还容易把终端卡死。<code>tail</code> 才是实时监控的神器。</p>
<p><strong>真实场景 A：服务发版启动监控</strong></p>
<p>每次发版重启服务时，我们都需要确认 Spring Boot 是否启动成功，或者有没有初始化报错。</p>
<pre><code class="hljs language-java" lang="java"># -f (follow)：实时追加显示文件尾部内容
tail -f logs/application.log
</code></pre>
<p><strong>真实场景 B：配合测试复现 Bug</strong></p>
<p>测试同学说：我现在点一下按钮，你看看后台有没有报错。</p>
<p>此时不需要看历史日志，只需要盯着最新的输出。</p>
<pre><code class="hljs language-java" lang="java"># 只看最后 <span class="hljs-number">200</span> 行，并保持实时刷新，避免被历史日志干扰
tail -n <span class="hljs-number">200</span> -f logs/application.log
</code></pre>
<h3 data-id="heading-1">less</h3>
<p>如果需要查看之前的日志，推荐使用 <code>less</code>。不同于 <code>vim</code> 会一次性加载整个文件占用大量内存，<code>less</code> 是按需加载，打开几个 G 的文件也极其流畅，且支持向后回溯。</p>
<p><strong>真实场景：追查某笔客诉订单</strong></p>
<p>运营反馈：刚才 10 点左右，订单号 <code>ORD12345678</code> 支付失败了。</p>
<p>你需要从日志末尾开始，往前反向查找这个订单号。</p>
<pre><code class="hljs language-bash" lang="bash">less logs/application.log
</code></pre>
<p><strong>进入界面后的操作流：</strong></p>
<ol>
<li>
<p><code>Shift + G</code> 先跳到日志最末尾（因为报错通常发生在最近）。</p>
</li>
<li>
<p><code>?ORD12345678</code> 输入问号+订单号，<strong>向上反向搜索</strong>。</p>
</li>
<li>
<p><code>n</code>：如果当前这行不是关键信息，按 <code>n</code> 继续向上找上一次出现的位置。</p>
</li>
<li>
<p><code>Shift + F</code> 如果看着看着，日志又更新了，按这个组合键可以让 less 进入类似 <code>tail -f</code> 的实时滚动模式；按 <code>Ctrl + C</code> 退回浏览模式。</p>
</li>
</ol>
<h3 data-id="heading-2">grep</h3>
<p><code>grep</code> 是最常用的搜索命令，但在实际业务中，简单的关键词搜索往往不够用。</p>
<p><strong>真实场景 A：还原报错现场（关键）</strong></p>
<p>只看到 <code>NullPointerException</code> 这一行往往无法定位问题，我们需要知道<strong>报错前</strong>的请求参数是什么，<strong>报错后</strong>的堆栈信息是什么。</p>
<p>此时必须配合 <code>-C</code> (Context) 参数。</p>
<pre><code class="hljs language-java" lang="java"># 搜索异常关键字，并显示该行 <span class="hljs-string">"前后各 20 行"</span>
grep -C <span class="hljs-number">20</span> <span class="hljs-string">"NullPointerException"</span> logs/application.log
</code></pre>
<p><strong>真实场景 B：全链路追踪 TraceId</strong></p>
<p>微服务我们通常会通过 <code>TraceId</code> 串联请求。日志文件可能发生了滚动（Rolling），变成了 <code>app.log</code>、<code>app.log.1</code>、<code>app.log.2</code>。</p>
<p>我们需要在所有日志文件中搜索同一个 TraceId。</p>
<pre><code class="hljs language-java" lang="java"># 搜索当前目录下所有以 app.log 开头的文件
grep <span class="hljs-string">"TraceId-20251219001"</span> logs/app.log*
</code></pre>
<p><strong>真实场景 C：统计异常频次</strong></p>
<p>老板问：“Redis 超时异常今天到底发生了多少次？是偶发还是大规模？”</p>
<p>不需要数数，直接统计行数。</p>
<pre><code class="hljs language-java" lang="java"># -c (count)：只统计匹配的行数
grep -c <span class="hljs-string">"RedisConnectionException"</span> logs/application.log
</code></pre>
<p><strong>真实场景 D：排除干扰噪音</strong></p>
<p>排查问题时，日志里充斥着大量无关的 <code>INFO</code> 心跳日志或健康检查日志，严重干扰视线。</p>
<pre><code class="hljs language-java" lang="java"># -v (invert)：显示不包含 <span class="hljs-string">"HealthCheck"</span> 的所有行
grep -v <span class="hljs-string">"HealthCheck"</span> logs/application.log
</code></pre>
<h3 data-id="heading-3">sed</h3>
<p>有时候日志非常大，例如有 10GB，grep 搜出来的内容依然过多。如果我们明确知道生产事故发生在 <strong>14:00 到 14:05</strong> 之间，该怎么办？</p>
<p>下载整个日志不现实，<code>sed</code> 可以帮我们把这段时间的日志单独<strong>切</strong>出来，保存成一个小文件慢慢分析。</p>
<p><strong>真实场景：导出事故时间窗口的日志</strong></p>
<pre><code class="hljs language-java" lang="java"># 语法：sed -n <span class="hljs-string">'/开始时间/,/结束时间/p'</span> 源文件 &gt; 目标文件
# 注意：时间格式必须和日志里的格式完全一致
sed -n <span class="hljs-string">'/2025-12-19 14:00/,/2025-12-19 14:05/p'</span> logs/application.log &gt; error_segment.log
</code></pre>
<p>这样你就得到了一个只有几 MB 的 <code>error_segment.log</code>，这时候再下载到本地分析，或者发给同事，都非常方便。</p>
<h3 data-id="heading-4">Awk</h3>
<p><code>awk</code> 擅长处理列数据，对于格式规范的日志，如 Nginx 访问日志、Apache 日志，它可以直接在服务器上生成简报。</p>
<p><strong>真实场景 A：遭到攻击，查找恶意 IP</strong></p>
<p>服务突然报警 CPU 飙升，怀疑遭到 CC 攻击或爬虫抓取，我们需要分析 Nginx 日志，找出访问量最高的 IP。</p>
<p>假设日志格式第一列是 IP：</p>
<pre><code class="hljs language-java" lang="java"># <span class="hljs-number">1.</span> awk <span class="hljs-string">'{print $1}'</span>：提取第一列（IP）
# <span class="hljs-number">2.</span> sort：排序，把相同的 IP 排在一起
# <span class="hljs-number">3.</span> uniq -c：去重并统计每个 IP 出现的次数
# <span class="hljs-number">4.</span> sort -nr：按次数(n)倒序(r)排列
# <span class="hljs-number">5.</span> head -n <span class="hljs-number">10</span>：取前 <span class="hljs-number">10</span> 名

awk <span class="hljs-string">'{print $1}'</span> access.log | sort | uniq -c | sort -nr | head -n <span class="hljs-number">10</span>
</code></pre>
<p><strong>真实场景 B：找出响应最慢的接口</strong></p>
<p>Nginx 日志中通常记录了响应时间，假设在最后一列，我们想把响应时间超过 1 秒的请求找出来。</p>
<pre><code class="hljs language-java" lang="java"># $NF 代表最后一列
# 打印所有响应时间大于 <span class="hljs-number">1</span> 秒的 URL（假设 URL 在第 <span class="hljs-number">7</span> 列）
awk <span class="hljs-string">'$NF &gt; 1.000 {print $7, $NF}'</span> access.log
</code></pre>
<h3 data-id="heading-5">总结</h3>
<p>举的例子都是我常用的，建议把这几个命令刻在脑子里或者收藏本文，下次遇到生产问题，对着场景直接复制粘贴就ok了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAxNTM4NzAyNg%3D%3D%26mid%3D2247499835%26idx%3D1%26sn%3Da202a41010813cd6e7496ef796723735%26chksm%3D9b8650c6acf1d9d0002189ed373170a770701fedaaaf2939a6eb041c58f2bbc749020aab728f%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAxNTM4NzAyNg==&amp;mid=2247499835&amp;idx=1&amp;sn=a202a41010813cd6e7496ef796723735&amp;chksm=9b8650c6acf1d9d0002189ed373170a770701fedaaaf2939a6eb041c58f2bbc749020aab728f#rd" ref="nofollow noopener noreferrer">PS：这里送题主和大家一份计算机书籍资源包，基本上是我这些年学习和工作中看过的书籍，本身我是做后端的，像Java、数据结构、操作系统、JVM、SQL调优、面试题、职业规划看的会多花一些），点击下边链接直接获取：</a>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab62123b84f546c193527ec9f7fc63ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767317750&amp;x-signature=Uea%2By9xvTu2bq%2FpMygUVojK542U%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[async/await 到底要不要加 try-catch？异步错误处理最佳实践]]></title>    <link>https://juejin.cn/post/7587675443442024488</link>    <guid>https://juejin.cn/post/7587675443442024488</guid>    <pubDate>2025-12-26T01:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442024488" data-draft-id="7579111646874828851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="async/await 到底要不要加 try-catch？异步错误处理最佳实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T01:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            async/await 到底要不要加 try-catch？异步错误处理最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T01:28:30.000Z" title="Fri Dec 26 2025 01:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周五下午，我正准备下班，产品经理突然跑过来：“用户反馈说提交订单后没反应，是不是又出 bug 了？”</p>
<p>我一查日志，发现接口报了 500 错误，但页面上什么提示都没有。</p>
<p>原来是我写异步请求时忘了加<code>try-catch</code>。用户点完提交就以为成功了，结果订单根本没生成。</p>
<p>那一刻的我才意识到：async/await 错误处理真的不能省。</p>
<hr/>
<h2 data-id="heading-0">先来理解 async/await 是什么</h2>
<p>简单来说，<code>async/await</code>是处理异步操作的语法糖，让异步代码看起来像同步代码一样直观。</p>
<p><strong>没有 async/await 的时代：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 回调地狱</span>
<span class="hljs-title function_">fetchData</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">result1</span>) {
  <span class="hljs-title function_">fetchMoreData</span>(result1, <span class="hljs-keyword">function</span>(<span class="hljs-params">result2</span>) {
    <span class="hljs-title function_">fetchEvenMoreData</span>(result2, <span class="hljs-keyword">function</span>(<span class="hljs-params">result3</span>) {
      <span class="hljs-comment">// 更多嵌套...</span>
    })
  })
})
</code></pre>
<p><strong>有了 async/await 之后：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同步般的写法</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> result1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>()
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchMoreData</span>(result1)
  <span class="hljs-keyword">const</span> result3 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchEvenMoreData</span>(result2)
  <span class="hljs-keyword">return</span> result3
}
</code></pre>
<p>是不是清爽多了？但是，如果 await 后面的 Promise 发生错误（比如网络请求失败），这个错误会直接抛出，如果不捕获，就会导致程序崩溃。</p>
<hr/>
<h2 data-id="heading-1">什么时候必须加 try-catch？</h2>
<h3 data-id="heading-2">1. 需要给用户明确反馈的场景</h3>
<p>举个例子：用户点击提交按钮，如果失败了却没有任何提示，用户会以为提交成功，这体验多差啊！</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"submitOrder"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"loading"</span>&gt;</span>
      {{ loading ? '提交中...' : '提交订单' }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">successMessage</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">errorMessage</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">submitOrder</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 开始加载</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">''</span>
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试提交订单</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/orders'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderData</span>)
        
        <span class="hljs-comment">// 提交成功</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">successMessage</span> = <span class="hljs-string">'订单提交成功！'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/success'</span>) <span class="hljs-comment">// 跳转到成功页面</span>
        
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 根据不同错误类型给用户不同的提示</span>
        <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'请先登录后再提交订单'</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">400</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'订单数据有误，请检查后重试'</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">500</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'服务器繁忙，请稍后重试'</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = <span class="hljs-string">'网络错误，请检查网络连接'</span>
        }
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 无论成功失败，都要取消加载状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>用户操作必须有反馈</li>
<li>不同错误给出不同提示</li>
<li>使用 finally 确保加载状态正确重置</li>
</ul>
<h3 data-id="heading-3">2. 需要继续执行后续逻辑的场景</h3>
<p>有时候，即使某个请求失败了，我们仍然希望继续执行其他操作。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initializePage</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 获取用户基本信息（重要）</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/info'</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户信息失败，但页面仍可正常使用'</span>)
    <span class="hljs-comment">// 即使失败，也继续执行下面的逻辑</span>
  }
  
  <span class="hljs-comment">// 获取用户设置（重要）</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userSettings</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/settings'</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户设置失败'</span>)
    <span class="hljs-comment">// 使用默认设置继续</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userSettings</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSettings</span>
  }
  
  <span class="hljs-comment">// 获取推荐内容（非关键，失败也没关系）</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">recommendations</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/recommendations'</span>)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 静默失败，不影响主要功能</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'推荐内容加载失败'</span>)
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">什么时候可以不加 try-catch？</h2>
<h3 data-id="heading-5">1. 有全局错误拦截器的情况</h3>
<p>如果你的项目配置了全局的 HTTP 拦截器，那么很多错误已经被统一处理了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// http.js - 全局拦截器</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response,
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 全局统一处理错误</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login'</span>)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">500</span>) {
      <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'服务器错误，请稍后重试'</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-comment">// 组件中 - 不需要重复处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 错误已经被全局拦截器处理了</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = data
}
</code></pre>
<h3 data-id="heading-6">2. 错误需要向上抛出的情况</h3>
<p>在编写可复用的函数时，通常不应该在函数内部处理错误，而是让调用方来决定如何处理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// api/user.js - 用户相关的 API 函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userApi = {
  <span class="hljs-comment">// 不处理错误，让调用方决定如何处理</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserProfile</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateUserProfile</span>(<span class="hljs-params">userId, profile</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$http</span>.<span class="hljs-title function_">put</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>, profile)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  }
}

<span class="hljs-comment">// 组件中 - 调用方处理错误</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadUserProfile</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">profile</span> = <span class="hljs-keyword">await</span> userApi.<span class="hljs-title function_">getUserProfile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">userId</span>)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载用户信息失败'</span>)
      }
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-7">让代码更简洁</h2>
<p>每次都写 try-catch 确实有点啰嗦。我们可以封装一个工具函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/safeAsync.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-params">promise</span>) {
  <span class="hljs-keyword">return</span> promise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> [<span class="hljs-literal">null</span>, data])      <span class="hljs-comment">// 成功：[null, 数据]</span>
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> [err, <span class="hljs-literal">null</span>])       <span class="hljs-comment">// 失败：[错误, null]</span>
}
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { safeAsync } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/safeAsync'</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [err, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-title function_">getUserInfo</span>())
  
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败'</span>)
    <span class="hljs-keyword">return</span>
  }
  
  user.<span class="hljs-property">value</span> = data
}
</code></pre>
<p>这看起来更舒服了吧？这种写法来自 Go 语言的错误优先风格，在 JS 社区也很流行。</p>
<hr/>
<h2 data-id="heading-8">多个请求怎么办？先别用 Promise.all</h2>
<p>很多朋友喜欢这样写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 危险！一个失败，全部失败</span>
<span class="hljs-keyword">const</span> [user, orders] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title function_">getUser</span>(),
  <span class="hljs-title function_">getOrders</span>()
])
</code></pre>
<p>但如果 <code>getOrders()</code> 挂了，<code>getUser()</code> 的结果也会丢掉！</p>
<p>正确做法：用 <code>Promise.allSettled</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([<span class="hljs-title function_">getUser</span>(), <span class="hljs-title function_">getOrders</span>()])

<span class="hljs-keyword">const</span> user = results[<span class="hljs-number">0</span>].<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span> ? results[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> : <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> orders = results[<span class="hljs-number">1</span>].<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span> ? results[<span class="hljs-number">1</span>].<span class="hljs-property">value</span> : []

<span class="hljs-comment">// 即使订单加载失败，用户信息还能显示！</span>
</code></pre>
<p>或者用我们上面的 <code>safeAsync</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> [userErr, user] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-title function_">getUser</span>())
<span class="hljs-keyword">const</span> [orderErr, orders] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeAsync</span>(<span class="hljs-title function_">getOrders</span>())

<span class="hljs-keyword">if</span> (userErr) <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">'用户信息加载失败'</span>)
<span class="hljs-keyword">if</span> (orderErr) <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">'订单加载失败'</span>)
</code></pre>
<hr/>
<h2 data-id="heading-9">全局错误兜底</h2>
<p>即使你写了 try-catch，也可能漏掉。所以可以做一些兜底的操作。</p>
<p>比如在全局拦截器处理，或者也可以在 <code>main.js</code> 这样写加个安全网：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 全局 Vue 错误处理器</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">errorHandler</span> = <span class="hljs-function">(<span class="hljs-params">err, instance, info</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Vue 组件错误:'</span>, err, info)
  <span class="hljs-title class_">ElNotification</span>.<span class="hljs-title function_">error</span>({
    <span class="hljs-attr">title</span>: <span class="hljs-string">'系统异常'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'页面出现错误，请刷新重试'</span>
  })
}

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这样，就算你忘了加 try-catch，也不会让用户看到白屏！</p>
<hr/>
<h2 data-id="heading-10">总结</h2>
<ol>
<li><strong>用户需要反馈时</strong>必须加 try-catch</li>
<li><strong>关键业务流程</strong>必须加 try-catch</li>
<li><strong>有全局处理时</strong>可以不加，避免重复</li>
<li><strong>编写可复用函数时</strong>通常不加，让调用方处理</li>
<li><strong>非关键操作</strong>可以不加，或简单处理</li>
</ol>
<p>错误处理不是一刀切的事情，需要根据具体业务场景来决定。好的错误处理能让你的应用更加健壮，用户体验更好。</p>
<p>感谢观看，希望这篇文章能帮你理清思路！</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-11">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F184BGM_pdMFLc0ASrferwQ" target="_blank" title="https://mp.weixin.qq.com/s/184BGM_pdMFLc0ASrferwQ" ref="nofollow noopener noreferrer">《代码里全是 new 对象，真的很 Low 吗？我认真想了一晚》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX-MSa0CHwVW_qgPezbpMUA" target="_blank" title="https://mp.weixin.qq.com/s/X-MSa0CHwVW_qgPezbpMUA" ref="nofollow noopener noreferrer">《这 5 个冷门 HTML 标签，让我直接删了100 行 JS 代码》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FT3ronvigepWew6dRC4uH2g" target="_blank" title="https://mp.weixin.qq.com/s/T3ronvigepWew6dRC4uH2g" ref="nofollow noopener noreferrer">《Vue 组件通信的 8 种最佳实践，你知道几种？》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！]]></title>    <link>https://juejin.cn/post/7587704265054945318</link>    <guid>https://juejin.cn/post/7587704265054945318</guid>    <pubDate>2025-12-26T03:28:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587704265054945318" data-draft-id="7587779957674573875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-26T03:28:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:28:58.000Z" title="Fri Dec 26 2025 03:28:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 协程中，<code>Job.cancel()</code> 和 <code>Scope.cancel()</code> 都用于取消协程，但它们的作用范围和行为有重要区别：</p>
<h2 data-id="heading-0">1. Job.cancel()</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体</span>
}
job.cancel()  <span class="hljs-comment">// 只取消这个特定的 job</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>只取消<strong>单个 Job</strong> 及其子协程</li>
<li>不会影响同一作用域中的其他 Job</li>
<li>Job 被取消后，仍然可以附加新的子协程</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job1 = scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
<span class="hljs-keyword">val</span> job2 = scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

job1.cancel()  <span class="hljs-comment">// 只取消 job1，job2 继续运行</span>
</code></pre>
<h2 data-id="heading-1">2. Scope.cancel()</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">scope.cancel()  <span class="hljs-comment">// 取消整个作用域及其所有协程</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>取消<strong>整个作用域</strong>中的所有协程</li>
<li>作用域被取消后，<strong>不能再启动新的协程</strong></li>
<li>所有子 Job 都会被取消</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.IO)

scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

scope.cancel()  <span class="hljs-comment">// 取消所有任务，且 scope 不能再 launch 新协程</span>
</code></pre>
<h2 data-id="heading-2">3. 关键区别对比</h2>






























<table><thead><tr><th>特性</th><th>Job.cancel()</th><th>Scope.cancel()</th></tr></thead><tbody><tr><td>作用范围</td><td>单个 Job + 其子协程</td><td>整个作用域 + 所有协程</td></tr><tr><td>后续使用</td><td>可继续启动新协程</td><td>作用域已失效，不能启动新协程</td></tr><tr><td>状态影响</td><td>Job 进入 Cancelling 状态</td><td>Scope 和所有 Job 都取消</td></tr><tr><td>典型场景</td><td>取消特定任务</td><td>清理整个界面/组件资源</td></tr></tbody></table>
<h2 data-id="heading-3">4. 实际例子</h2>
<h3 data-id="heading-4">Job.cancel() 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob())

<span class="hljs-keyword">val</span> jobA = scope.launch {
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Job A 完成"</span>)
}

<span class="hljs-keyword">val</span> jobB = scope.launch {
    delay(<span class="hljs-number">2000</span>)
    println(<span class="hljs-string">"Job B 完成"</span>)
}

<span class="hljs-comment">// 只取消 jobA，jobB 继续运行</span>
jobA.cancel()

<span class="hljs-comment">// scope 仍然可用，可以启动新协程</span>
scope.launch { println(<span class="hljs-string">"新协程"</span>) }
</code></pre>
<h3 data-id="heading-5">Scope.cancel() 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob())

scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

<span class="hljs-comment">// 取消整个作用域</span>
scope.cancel()

<span class="hljs-comment">// 这里会抛出异常：Scope is cancelled</span>
scope.launch { println(<span class="hljs-string">"这不会执行"</span>) }
</code></pre>
<h2 data-id="heading-6">5. 重要细节</h2>
<h3 data-id="heading-7">Scope.cancel() 的内部实现</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CoroutineScope 的 cancel() 实际上调用了关联 Job 的 cancel()</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">cancel</span><span class="hljs-params">(cause: <span class="hljs-type">CancellationException</span>? = <span class="hljs-literal">null</span>)</span></span> {
    <span class="hljs-keyword">val</span> job = coroutineContext[Job]
        ?: error(<span class="hljs-string">"Scope cannot be cancelled because it does not have a job"</span>)
    job.cancel(cause)
}
</code></pre>
<h3 data-id="heading-8">结构化并发的体现</h3>
<ul>
<li>在结构化并发中，通常使用 <code>scope.cancel()</code> 来清理资源</li>
<li>ViewModel 销毁时：<code>viewModelScope.cancel()</code></li>
<li>Activity 销毁时：<code>lifecycleScope.cancel()</code></li>
</ul>
<h3 data-id="heading-9">异常处理差异</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Job.cancel() 可以指定原因</span>
job.cancel(<span class="hljs-string">"用户取消操作"</span>)

<span class="hljs-comment">// Scope.cancel() 同样可以</span>
scope.cancel(TimeoutCancellationException(<span class="hljs-string">"超时"</span>))
</code></pre>
<h2 data-id="heading-10">6. 最佳实践建议</h2>
<ol>
<li>
<p><strong>使用 Job.cancel()</strong>  当需要：</p>
<ul>
<li>取消特定的后台任务</li>
<li>实现可取消的单个操作</li>
<li>不影响其他并行任务</li>
</ul>
</li>
<li>
<p><strong>使用 Scope.cancel()</strong>  当需要：</p>
<ul>
<li>组件（Activity/Fragment）销毁时清理资源</li>
<li>取消整个工作流的所有任务</li>
<li>确保没有协程泄露</li>
</ul>
</li>
<li>
<p><strong>在 ViewModel 中</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> customScope = CoroutineScope(SupervisorJob())
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startWork</span><span class="hljs-params">()</span></span> {
        customScope.launch { <span class="hljs-comment">/* 工作 */</span> }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
        customScope.cancel()  <span class="hljs-comment">// 清理自定义作用域</span>
        <span class="hljs-keyword">super</span>.onCleared()
    }
    
    <span class="hljs-comment">// viewModelScope 会自动管理，无需手动取消</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useViewModelScope</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch { <span class="hljs-comment">/* 自动绑定生命周期 */</span> }
    }
}
</code></pre>
<p><strong>核心总结</strong>：<code>Job.cancel()</code> 是<strong>选择性取消</strong>，<code>Scope.cancel()</code> 是<strong>全面清理</strong>。在结构化并发中，通常让作用域管理生命周期，仅在特殊情况下单独取消特定 Job。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android ANR项目实战：Reason: Broadcast { act=android.intent.action.TIME_TICK}]]></title>    <link>https://juejin.cn/post/7587636536898240548</link>    <guid>https://juejin.cn/post/7587636536898240548</guid>    <pubDate>2025-12-26T00:18:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587636536898240548" data-draft-id="7586893663075762186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android  ANR项目实战：Reason: Broadcast { act=android.intent.action.TIME_TICK}"/> <meta itemprop="keywords" content="前端,Android,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T00:18:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏程十八少"/> <meta itemprop="url" content="https://juejin.cn/user/184373685534077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android  ANR项目实战：Reason: Broadcast { act=android.intent.action.TIME_TICK}
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685534077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏程十八少
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T00:18:51.000Z" title="Fri Dec 26 2025 00:18:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同事最近出现一个ANR,又没Trace文件，不知道如何分析，报错信息如下：</p>
<h2 data-id="heading-0">1.报错信息</h2>
<pre><code class="hljs language-12-23" lang="12-23">12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 事件类型: 
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 发生时间: 2025-12-23 15:32:05.537
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 调用耗时: 5001ms
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: === 系统资源状态 ===
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 进程内存: 126MB (PSS)
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: Java堆内存: 39MB
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: Native堆内存: 0MB
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 系统可用内存: 15224MB / 16385MB
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: CPU使用率: 0.0%
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: Binder状态: 统计不可用
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: === 性能分析 ===
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 问题描述: 获取无障碍根节点耗时5001ms，超过正常阈值
12-23 15:32:05.537  1539  1833 W VoiceAccessibilityPerformance: 建议: 检查系统负载，优化无障碍服务逻辑
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-string">ANR</span> <span class="hljs-string">in</span> <span class="hljs-string">com.tencent.carecolauncher</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager: PID:</span> <span class="hljs-number">43162</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager: Reason:</span> <span class="hljs-string">Broadcast</span> <span class="hljs-string">of</span> <span class="hljs-string">Intent</span> { <span class="hljs-string">act=android.intent.action.TIME_TICK</span> <span class="hljs-string">flg=0x50200014</span> <span class="hljs-string">(has</span> <span class="hljs-string">extras)</span> }
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager: Load:</span> <span class="hljs-number">169.8</span> <span class="hljs-string">/</span> <span class="hljs-number">144.63</span> <span class="hljs-string">/</span> <span class="hljs-number">112.13</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-string">CPU</span> <span class="hljs-string">usage</span> <span class="hljs-string">from</span> <span class="hljs-string">0ms</span> <span class="hljs-string">to</span> <span class="hljs-string">7239ms</span> <span class="hljs-string">later</span> <span class="hljs-string">(2025-12-23</span> <span class="hljs-number">15</span><span class="hljs-string">:32:10.006</span> <span class="hljs-string">to</span> <span class="hljs-number">2025-12-23 15:32:17.245</span><span class="hljs-string">):</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">19</span><span class="hljs-string">%</span> <span class="hljs-attr">44555/gzip:</span> <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">6</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">16</span><span class="hljs-string">%</span> <span class="hljs-attr">100/surfaceflinger:</span> <span class="hljs-number">8.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">8.4</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">164</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">14</span><span class="hljs-string">%</span> <span class="hljs-attr">43162/com.tencent.carecolauncher:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.5</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">8324 </span><span class="hljs-string">minor</span> <span class="hljs-number">3</span> <span class="hljs-string">major</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">9.3</span><span class="hljs-string">%</span> <span class="hljs-attr">254/system_server:</span> <span class="hljs-number">3</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">6.3</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">4072 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">8.8</span><span class="hljs-string">%</span> <span class="hljs-attr">2071/com.autonavi.amapauto:</span> <span class="hljs-number">4.9</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">3.8</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">4576 </span><span class="hljs-string">minor</span> <span class="hljs-number">4</span> <span class="hljs-string">major</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">6.7</span><span class="hljs-string">%</span> <span class="hljs-attr">44554/tar_custom:</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">6.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.3</span><span class="hljs-string">%</span> <span class="hljs-attr">43186/com.android.systemui:</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">2327 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">1.3</span><span class="hljs-string">%</span> <span class="hljs-attr">1539/com.tencent.cloudsmartvoice:</span> <span class="hljs-number">0.9</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.4</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">6130 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.8</span><span class="hljs-string">%</span> <span class="hljs-attr">1100/com.android.phone:</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.6</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">680</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">1560/com.tencent.netserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">2003 </span><span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">1081/com.tencent.datatrackclient:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">785</span> <span class="hljs-string">minor</span> <span class="hljs-number">1</span> <span class="hljs-string">major</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.5</span><span class="hljs-string">%</span> <span class="hljs-attr">1060/com.tencent.datatrackservice:</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">730</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">1//init:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">173</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">46/logd:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">18</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">131/tombstoned:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">7</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">137/logcat:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">1</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">47/servicemanager:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">48/hwservicemanager:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">60</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">78/netd:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">45</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">79/zygote64:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">107/cameraserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">50</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">120/media.extractor:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">19</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">122/mediaserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">24</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">1440/com.baidu.input_huawei:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">24</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">1938/com.tencent.settings:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">17</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">2316/com.autonavi.amapauto:locationservice:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.1</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">13</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">44854/audioserver:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">44856/CloudAppEngine:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">44989/media.codec:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">45004/sh:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">45005/sh:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>  <span class="hljs-string">+0%</span> <span class="hljs-attr">45006/tee:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-number">2</span><span class="hljs-string">%</span> <span class="hljs-attr">TOTAL:</span> <span class="hljs-number">1.6</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-string">CPU</span> <span class="hljs-string">usage</span> <span class="hljs-string">from</span> <span class="hljs-string">26ms</span> <span class="hljs-string">to</span> <span class="hljs-string">260ms</span> <span class="hljs-string">later</span> <span class="hljs-string">(2025-12-23</span> <span class="hljs-number">15</span><span class="hljs-string">:32:10.032</span> <span class="hljs-string">to</span> <span class="hljs-number">2025-12-23 15:32:10.266</span><span class="hljs-string">):</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">16</span><span class="hljs-string">%</span> <span class="hljs-attr">254/system_server:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">274</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>     <span class="hljs-number">16</span><span class="hljs-string">%</span> <span class="hljs-attr">268/ActivityManager:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">8.3</span><span class="hljs-string">%</span> <span class="hljs-attr">100/surfaceflinger:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>     <span class="hljs-number">12</span><span class="hljs-string">%</span> <span class="hljs-attr">100/surfaceflinger:</span> <span class="hljs-number">4.1</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">8.3</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">8.8</span><span class="hljs-string">%</span> <span class="hljs-attr">44555/gzip:</span> <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">1659/CloudAppEngine:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">2071/com.autonavi.amapauto:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">3</span> <span class="hljs-string">minor</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>     <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-attr">2262/gnet_proc:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.2</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span>   <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-attr">44554/tar_custom:</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.4</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.270   254   268 E ActivityManager:</span> <span class="hljs-number">0.9</span><span class="hljs-string">%</span> <span class="hljs-attr">TOTAL:</span> <span class="hljs-number">0.6</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">0.2</span><span class="hljs-string">%</span> <span class="hljs-string">kernel</span>
<span class="hljs-attr">12-23 15:32:17.294   254   270 I ActivityManager: Start proc 45028:</span>

</code></pre>
<h2 data-id="heading-1">2.问题概述：</h2>
<p><strong>ANR原因：</strong>  处理广播 <code>android.intent.action.TIME_TICK</code> 时超时</p>
<h2 data-id="heading-2">3.关键问题分析：</h2>
<h3 data-id="heading-3">1. <strong>系统负载极高</strong></h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Load: 169.8 / 144.63 / 112.13</span>
</code></pre>
<ul>
<li>系统1分钟平均负载高达169.8（远超正常值）</li>
<li>这表明系统极度繁忙，CPU资源严重不足</li>
</ul>
<h3 data-id="heading-4">2. <strong>主要CPU占用者</strong></h3>
<ul>
<li><strong>gzip进程 (PID: 44555):</strong>  19% CPU</li>
<li><strong>surfaceflinger:</strong>  16% CPU</li>
<li><strong>问题应用本身:</strong>  14% CPU（且有大量缺页中断）</li>
<li><strong>system_server:</strong>  9.3% CPU</li>
<li><strong>高德地图车机版:</strong>  8.8% CPU</li>
</ul>
<h3 data-id="heading-5">三个数字的含义：</h3>
<h3 data-id="heading-6"><strong>格式：</strong>  1分钟平均 / 5分钟平均 / 15分钟平均</h3>
<ul>
<li><strong>169.8</strong> - 过去1分钟的平均负载</li>
<li><strong>144.63</strong> - 过去5分钟的平均负载</li>
<li><strong>112.13</strong> - 过去15分钟的平均负载</li>
</ul>
<h3 data-id="heading-7">如何理解这些数值：</h3>
<h3 data-id="heading-8"><strong>基准对比：</strong></h3>
<p>通常与<strong>CPU核心数</strong>进行比较：</p>
<ul>
<li>负载值 &lt; CPU核心数：系统相对空闲</li>
<li>负载值 ≈ CPU核心数：系统满负荷运行</li>
<li>负载值 &gt; CPU核心数：系统过载，有进程在等待CPU</li>
</ul>
<h3 data-id="heading-9"><strong>车机系统分析：</strong></h3>
<p>假设这个车机系统有<strong>8个CPU核心</strong>：</p>
<ul>
<li>正常情况：负载应该在8以下</li>
<li><strong>实际负载：169.8</strong>（远超CPU核心数）</li>
</ul>
<p>用命令查看： adb shell uptime
正常情况下的负载参数：<br/>
10:08:11 up 100 days, 15:26,  0 users,  load average: 0.47, 0.42, 0.42</p>
<h4 data-id="heading-10">具体含义：</h4>
<h3 data-id="heading-11"><strong>为什么这么高？</strong></h3>
<ol>
<li>
<p><strong>大量进程在运行队列中等待CPU</strong></p>
<ul>
<li>系统中有平均169个进程在等待执行</li>
<li>包括：可运行状态（R状态）和不可中断睡眠状态（D状态）</li>
</ul>
</li>
<li>
<p><strong>系统严重过载</strong></p>
<ul>
<li>CPU资源极度匮乏</li>
<li>进程需要长时间等待才能获得CPU时间片</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">在ANR问题中的意义：</h4>
<h3 data-id="heading-13"><strong>直接导致ANR的原因：</strong></h3>
<ol>
<li>
<p><strong>Launcher应用无法及时获得CPU时间片</strong></p>
<ul>
<li>系统中有169个进程在排队</li>
<li>Launcher的广播接收器需要等待很长时间才能执行</li>
</ul>
</li>
<li>
<p><strong>TIME_TICK广播处理延迟</strong></p>
<pre><code class="hljs language-ini" lang="ini">Reason: Broadcast of Intent { <span class="hljs-attr">act</span>=android.intent.action.TIME_TICK }
</code></pre>
<ul>
<li>TIME_TICK广播每分钟发送一次</li>
<li>由于系统负载高，Launcher可能延迟了几秒甚至几十秒才处理到这个广播</li>
<li>Android系统检测到广播处理超时（通常5秒），触发ANR</li>
</ul>
</li>
</ol>
<p>代码里面没用注册这个广播：</p>
<p><strong><code>TextClock</code></strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterTextChanged</span>(<span class="hljs-params">Editable s</span>)</span> {
    LogUtil.d(TAG, <span class="hljs-string">"afterTextChanged s: "</span> + s); <span class="hljs-comment">// ← 这行每分钟都打日志！</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"00:00"</span>.<span class="hljs-keyword">equals</span>(s.toString()) || ...) {
        updateDate();
    }
}
</code></pre>
<h3 data-id="heading-14">验证方法：看 <code>traces.txt</code> 主线程堆栈</h3>
<p>如果你能拿到 <code>/data/anr/traces.txt</code>，搜索 <code>main</code> 线程，大概率会看到：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-string">"main"</span> prio<span class="hljs-operator">=</span><span class="hljs-number">5</span> tid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-type">Native</span>
  <span class="hljs-operator">|</span> group<span class="hljs-operator">=</span><span class="hljs-string">"main"</span> sCount<span class="hljs-operator">=</span><span class="hljs-number">1</span> dsCount<span class="hljs-operator">=</span><span class="hljs-number">0</span> flags<span class="hljs-operator">=</span><span class="hljs-number">1</span> obj<span class="hljs-operator">=</span><span class="hljs-number">0x74b0a8a0</span> <span class="hljs-keyword">self</span><span class="hljs-operator">=</span><span class="hljs-number">0xb400007c</span><span class="hljs-operator">...</span>
  at android.os.<span class="hljs-type">BinderProxy</span>.transactNative(<span class="hljs-type">Native</span> method)
  at android.os.<span class="hljs-type">BinderProxy</span>.transact(<span class="hljs-type">Binder</span>.java:<span class="hljs-number">1133</span>)
  at android.app.<span class="hljs-type">IActivityManager</span><span class="hljs-variable">$Stub</span><span class="hljs-variable">$Proxy</span>.broadcastIntent(<span class="hljs-operator">...</span>)
  <span class="hljs-operator">...</span>
  at android.widget.<span class="hljs-type">TextClock</span><span class="hljs-variable">$1</span>.onReceive(<span class="hljs-type">TextClock</span>.java:<span class="hljs-number">123</span>)
  at android.app.<span class="hljs-type">LoadedApk</span><span class="hljs-variable">$ReceiverDispatcher</span><span class="hljs-variable">$Args</span>.lambda<span class="hljs-variable">$getRunnable</span><span class="hljs-variable">$0</span><span class="hljs-variable">$LoadedApk</span><span class="hljs-variable">$ReceiverDispatcher</span><span class="hljs-variable">$Args</span>(<span class="hljs-type">LoadedApk</span>.java:<span class="hljs-number">1550</span>)
  <span class="hljs-operator">...</span>
  at com.gwm.presetcard.vehicle.view.<span class="hljs-type">VehicleSettingsCardView</span><span class="hljs-variable">$1</span>.afterTextChanged(<span class="hljs-type">VehicleSettingsCardView</span>.java:<span class="hljs-type">XX</span>)
</code></pre>
<p>→ 明确显示卡在 <code>TextClock</code> 的广播接收 + 你的 <code>TextWatcher</code></p>
<p>解决方案：</p>
<p><strong>替换为 <code>TextView + Handler</code> 是最稳妥方案</strong>，彻底绕过系统广播机制。</p>
<p><code>private void startClock() { mClockUpdater.run(); } private final Runnable mClockUpdater = new Runnable() { @Override public void run() { mVehicleSettingsClock.setText(new SimpleDateFormat("HH:mm").format(new Date())); long delay = 60_000 - (System.currentTimeMillis() % 60_000); mHandler.postDelayed(this, delay); } };</code></p>
<h3 data-id="heading-15">3. <strong>具体问题表现</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">14</span><span class="hljs-string">%</span> <span class="hljs-attr">43162/com.tencent.carecolauncher:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span> <span class="hljs-string">user</span> <span class="hljs-string">+</span> <span class="hljs-number">4.5</span><span class="hljs-string">%</span> <span class="hljs-attr">kernel / faults:</span> <span class="hljs-number">8324 </span><span class="hljs-string">minor</span> <span class="hljs-number">3</span> <span class="hljs-string">major</span>
</code></pre>
<ul>
<li>应用本身占用14% CPU</li>
<li><strong>8324次minor faults和3次major faults</strong>：表明应用在进行大量内存分配/访问操作</li>
<li>处理TIME_TICK广播时响应超时</li>
</ul>
<h3 data-id="heading-16"><strong>CPU使用部分：</strong></h3>
<ul>
<li><strong>14%</strong>  - 该进程占总CPU时间的14%</li>
<li><strong>10% user</strong> - 在用户态运行占10%（执行应用自己的代码）</li>
<li><strong>4.5% kernel</strong> - 在内核态运行占4.5%（执行系统调用、内核服务）</li>
</ul>
<h3 data-id="heading-17"><strong>缺页中断部分（关键线索）：</strong></h3>
<ul>
<li><strong>8324 minor faults</strong> - 8324次次缺页中断</li>
<li><strong>3 major faults</strong> - 3次主缺页中断</li>
</ul>
<h4 data-id="heading-18">这说明了什么：</h4>
<h3 data-id="heading-19"><strong>1. 应用正在大量分配/访问内存</strong></h3>
<ul>
<li>
<p><strong>Minor faults（次缺页中断）</strong> ：当进程访问的页面在物理内存中但未映射到进程地址空间时发生</p>
<ul>
<li>常见于：堆内存分配、文件映射、动态链接库加载、写时复制等</li>
<li><strong>8324次</strong>在7秒多的时间内，表明应用在进行<strong>非常频繁的内存操作</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-20"><strong>2. 可能的内存密集型操作</strong></h3>
<p>应用可能正在：</p>
<ul>
<li><strong>创建大量对象</strong>（频繁的垃圾回收）</li>
<li><strong>处理大尺寸图片/资源</strong></li>
<li><strong>加载大量数据到内存</strong></li>
<li><strong>进行文件映射操作</strong></li>
<li><strong>执行大量的UI布局/渲染</strong></li>
</ul>
<h3 data-id="heading-21"><strong>3. Major faults的严重性</strong></h3>
<ul>
<li><strong>Major faults（主缺页中断）</strong> ：需要从磁盘读取数据到内存</li>
<li>通常涉及：从存储设备读取文件、内存交换（swap）等</li>
<li><strong>3次major faults</strong>虽然不多，但每次都会导致显著延迟（毫秒级阻塞）</li>
</ul>
<h3 data-id="heading-22"><strong>4. ANR抓取错误了，ANR 日志中的“Reason”是误导性的</strong></h3>
<p>在极端高负载（Load &gt; 160）情况下：</p>
<ul>
<li>系统可能在 <strong>发送 <code>TIME_TICK</code> 时发现你的应用主线程无响应</strong></li>
<li>即使你<strong>根本没注册</strong>，AMS（ActivityManagerService）也可能把“最近一次尝试发送的广播”记为 ANR 原因</li>
<li>实际根本原因是：<strong>你的主线程早已卡死（比如死锁、I/O 阻塞），恰好在 <code>TIME_TICK</code> 到来时被检测到</strong></li>
</ul>
<blockquote>
<p>💡 类比：一个人已经昏迷 5 分钟，救护车（TIME_TICK）来了发现他没反应，就记录“因救护车到来时无反应”，但真正病因是 earlier 的脑梗。</p>
</blockquote>
<h4 data-id="heading-23">可能的原因：</h4>
<h3 data-id="heading-24">主要原因：</h3>
<ol>
<li>
<p><strong>系统级资源竞争</strong></p>
<ul>
<li>gzip进程占用大量CPU（可能是系统压缩/备份操作）</li>
<li>多个车机应用同时高CPU使用，导致Launcher无法及时响应</li>
</ul>
</li>
<li>
<p><strong>Launcher应用问题</strong></p>
<ul>
<li>TIME_TICK广播每分钟一次，可能触发Launcher的时钟更新等操作</li>
<li>广播接收器中可能执行了耗时操作</li>
<li>应用可能在进行大量UI渲染或数据处理</li>
</ul>
</li>
<li>
<p><strong>内存压力</strong></p>
<ul>
<li>大量缺页中断表明内存访问频繁，可能存在内存泄漏或频繁GC</li>
</ul>
</li>
</ol>
<p>3.后面补充了Trace文件，进一步确认了</p>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">RenderThread</span>" <span class="hljs-selector-tag">daemon</span> <span class="hljs-selector-tag">prio</span>=<span class="hljs-number">7</span> <span class="hljs-selector-tag">tid</span>=<span class="hljs-number">26</span> <span class="hljs-selector-tag">Native</span>
  | <span class="hljs-selector-tag">group</span>="<span class="hljs-selector-tag">main</span>" <span class="hljs-selector-tag">sCount</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">dsCount</span>=<span class="hljs-number">0</span> <span class="hljs-selector-tag">flags</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">obj</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x130c0818</span> <span class="hljs-selector-tag">self</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x3ffedf5f7400</span>
  | <span class="hljs-selector-tag">sysTid</span>=<span class="hljs-number">55663</span> <span class="hljs-selector-tag">nice</span>=<span class="hljs-selector-tag">-4</span> <span class="hljs-selector-tag">cgrp</span>=<span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">sched</span>=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> <span class="hljs-selector-tag">handle</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x3ffedcf054f0</span>
  | <span class="hljs-selector-tag">state</span>=<span class="hljs-selector-tag">S</span> <span class="hljs-selector-tag">schedstat</span>=( <span class="hljs-number">31569136200</span> <span class="hljs-number">4107637200</span> <span class="hljs-number">156698</span> ) <span class="hljs-selector-tag">utm</span>=<span class="hljs-number">2105</span> <span class="hljs-selector-tag">stm</span>=<span class="hljs-number">1051</span> <span class="hljs-selector-tag">core</span>=<span class="hljs-number">9</span> <span class="hljs-selector-tag">HZ</span>=<span class="hljs-number">100</span>
  | <span class="hljs-selector-tag">stack</span>=<span class="hljs-number">0</span><span class="hljs-selector-tag">x3ffedce0a000-0x3ffedce0c000</span> <span class="hljs-selector-tag">stackSize</span>=<span class="hljs-number">1009</span><span class="hljs-selector-tag">KB</span>
  | <span class="hljs-selector-tag">held</span> <span class="hljs-selector-tag">mutexes</span>=
  <span class="hljs-selector-tag">kernel</span>: (couldn't read /proc/self/task/<span class="hljs-number">55663</span>/stack)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#00</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000006</span><span class="hljs-selector-tag">e0d8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (__ioctl+<span class="hljs-number">4</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#01</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000029058</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (ioctl+<span class="hljs-number">136</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#02</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000004</span><span class="hljs-selector-tag">dd8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libdrm</span><span class="hljs-selector-class">.so</span> (drmIoctl+<span class="hljs-number">28</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#03</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000004920</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libdrm_amdgpu</span><span class="hljs-selector-class">.so</span> (amdgpu_cs_query_fence_status+<span class="hljs-number">248</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#04</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000002</span><span class="hljs-selector-tag">ba4cc</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">dri</span>/<span class="hljs-selector-tag">gallium_dri</span><span class="hljs-selector-class">.so</span> (amdgpu_fence_wait+<span class="hljs-number">288</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#05</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000025</span><span class="hljs-selector-tag">c8f0</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">dri</span>/<span class="hljs-selector-tag">gallium_dri</span><span class="hljs-selector-class">.so</span> (si_fence_finish+<span class="hljs-number">516</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#06</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000002</span><span class="hljs-selector-tag">c7d68</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">dri</span>/<span class="hljs-selector-tag">gallium_dri</span><span class="hljs-selector-class">.so</span> (dri_flush+<span class="hljs-number">300</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#07</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000016</span><span class="hljs-selector-tag">c84</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">egl</span>/<span class="hljs-selector-tag">libGLES_mesa</span><span class="hljs-selector-class">.so</span> (droid_swap_buffers+<span class="hljs-number">192</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#08</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000149</span><span class="hljs-selector-tag">bc</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">egl</span>/<span class="hljs-selector-tag">libGLES_mesa</span><span class="hljs-selector-class">.so</span> (dri2_swap_buffers_with_damage+<span class="hljs-number">276</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#09</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000000</span><span class="hljs-selector-tag">c6a0</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">vendor</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">egl</span>/<span class="hljs-selector-tag">libGLES_mesa</span><span class="hljs-selector-class">.so</span> (_eglSwapBuffersWithDamageCommon+<span class="hljs-number">248</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#10</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000175</span><span class="hljs-selector-tag">f4</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libEGL</span><span class="hljs-selector-class">.so</span> (eglSwapBuffersWithDamageKHR+<span class="hljs-number">412</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#11</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000047</span><span class="hljs-selector-tag">f6d8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">EglManager</span>::<span class="hljs-built_in">swapBuffers</span>(<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::Frame const&amp;, SkRect const&amp;)+<span class="hljs-number">124</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#12</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000478</span><span class="hljs-selector-tag">cac</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">skiapipeline</span>::<span class="hljs-attribute">SkiaOpenGLPipeline</span>::<span class="hljs-built_in">swapBuffers</span>(<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::Frame const&amp;, bool, SkRect const&amp;, <span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::FrameInfo*, bool*)+<span class="hljs-number">88</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#13</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000106</span><span class="hljs-selector-tag">da4</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">CanvasContext</span>::<span class="hljs-built_in">draw</span>()+<span class="hljs-number">296</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#14</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000047</span><span class="hljs-selector-tag">e124</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (_ZNSt3__110__function6__funcIZN7android10uirenderer12renderthread13DrawFrameTask11postAndWaitEvE3$_0NS_9allocatorIS6_EEFvvEEclEv$c303f2d2360db58ed70a2d0ac7ed911b+<span class="hljs-number">644</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#15</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000434</span><span class="hljs-selector-tag">ab4</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">WorkQueue</span>::<span class="hljs-built_in">process</span>()+<span class="hljs-number">168</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#16</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000113</span><span class="hljs-selector-tag">cd0</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">RenderThread</span>::<span class="hljs-built_in">threadLoop</span>()+<span class="hljs-number">240</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#17</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000000</span><span class="hljs-selector-tag">fa8c</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libutils</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">Thread</span>::<span class="hljs-built_in">_threadLoop</span>(void*)+<span class="hljs-number">280</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#18</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">00000000000818</span><span class="hljs-selector-tag">c8</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (<span class="hljs-built_in">__pthread_start</span>(void*)+<span class="hljs-number">36</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#19</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000023400</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (__start_thread+<span class="hljs-number">68</span>)
  (no managed stack frames)
</code></pre>
<p>这是 <strong>ANR的完整线程转储（Thread Dump）</strong> ，它提供了ANR发生时应用内部所有线程的详细状态。以下是关键问题的深入分析：</p>
<h2 data-id="heading-25"><strong>关键发现：</strong></h2>
<h3 data-id="heading-26"><strong>根本原因</strong></h3>
<pre><code class="hljs language-less" lang="less">"<span class="hljs-selector-tag">main</span>" <span class="hljs-selector-tag">prio</span>=<span class="hljs-number">5</span> <span class="hljs-selector-tag">tid</span>=<span class="hljs-number">1</span> <span class="hljs-selector-tag">Native</span>
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#00</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-selector-tag">f02c</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (syscall+<span class="hljs-number">28</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#01</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000022104</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (__futex_wait_ex)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#02</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">0000000000080</span><span class="hljs-selector-tag">e0c</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libc</span><span class="hljs-selector-class">.so</span> (pthread_cond_wait+<span class="hljs-number">60</span>)
  <span class="hljs-selector-tag">native</span>: <span class="hljs-selector-id">#03</span> <span class="hljs-selector-tag">pc</span> <span class="hljs-number">000000000047</span><span class="hljs-selector-tag">ddfc</span>  /<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">lib64</span>/<span class="hljs-selector-tag">libhwui</span><span class="hljs-selector-class">.so</span> (<span class="hljs-attribute">android</span>::<span class="hljs-attribute">uirenderer</span>::<span class="hljs-attribute">renderthread</span>::<span class="hljs-attribute">DrawFrameTask</span>::<span class="hljs-built_in">postAndWait</span>()+<span class="hljs-number">260</span>)
  
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.ThreadedRenderer</span><span class="hljs-selector-class">.nSyncAndDrawFrame</span>(Native method)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.ThreadedRenderer</span><span class="hljs-selector-class">.draw</span>(ThreadedRenderer.<span class="hljs-attribute">java</span>:<span class="hljs-number">823</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.ViewRootImpl</span><span class="hljs-selector-class">.draw</span>(ViewRootImpl.<span class="hljs-attribute">java</span>:<span class="hljs-number">3318</span>)
  ...
</code></pre>
<p><strong>核心问题：</strong>  主线程在等待渲染线程完成绘制（<code>DrawFrameTask::postAndWait()</code>），但渲染线程被阻塞。</p>
<h3 data-id="heading-27"><strong>2. 渲染线程（RenderThread）被阻塞</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">"RenderThread"</span> <span class="hljs-string">daemon</span> <span class="hljs-string">prio=7</span> <span class="hljs-string">tid=26</span> <span class="hljs-string">Native</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#00 pc 000000000006e0d8  /system/lib64/libc.so (__ioctl+4)</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#01 pc 0000000000029058  /system/lib64/libc.so (ioctl+136)</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#02 pc 0000000000004dd8  /system/vendor/lib64/libdrm.so (drmIoctl+28)</span>
  <span class="hljs-attr">native:</span> <span class="hljs-comment">#03 pc 0000000000004920  /system/vendor/lib64/libdrm_amdgpu.so (amdgpu_cs_query_fence_status+248)</span>
  <span class="hljs-string">...</span>
</code></pre>
<p><strong>关键发现：</strong>  渲染线程在等待GPU的fence状态（<code>amdgpu_cs_query_fence_status</code>），这表明<strong>GPU渲染过慢或被阻塞</strong>。</p>
<h3 data-id="heading-28"><strong>3. 多个渲染相关线程处于等待状态</strong></h3>
<p>线程ID 55553-55564 都是以<code>.carecolauncher</code>命名的线程，它们都在等待条件变量：</p>
<p>text</p>
<pre><code class="hljs language-rust" lang="rust">native: #<span class="hljs-number">03</span> pc <span class="hljs-number">000000000003</span>aa34  /system/lib64/libRS_internal.<span class="hljs-title function_ invoke__">so</span> (android::renderscript::Signal::<span class="hljs-title function_ invoke__">wait</span>()+<span class="hljs-number">84</span>)
</code></pre>
<p>这些是<strong>RenderScript计算线程</strong>，用于图形计算，它们也在等待。</p>
<h2 data-id="heading-29"><strong>问题链分析：</strong></h2>
<h3 data-id="heading-30"><strong>时间线重建：</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. TIME_TICK广播触发 → 
<span class="hljs-number">2</span>. 主线程需要更新UI（可能包括TextClock更新、日期更新等） → 
<span class="hljs-number">3</span>. 主线程调用ThreadedRenderer<span class="hljs-selector-class">.nSyncAndDrawFrame</span>() → 
<span class="hljs-number">4</span>. 主线程等待渲染线程完成绘制（<span class="hljs-built_in">postAndWait</span>()） → 
<span class="hljs-number">5</span>. 渲染线程在GPU层面被阻塞（等待fence状态） → 
<span class="hljs-number">6</span>. 多个RenderScript线程也在等待 → 
<span class="hljs-number">7</span>. 主线程等待超时（<span class="hljs-number">5</span>秒）→ 
<span class="hljs-number">8</span>. ANR发生
</code></pre>
<h3 data-id="heading-31"><strong>GPU问题的可能原因：</strong></h3>
<ol>
<li><strong>GPU过载</strong>：系统中有太多3D渲染任务</li>
<li><strong>GPU驱动程序问题</strong>：amdgpu驱动程序响应慢</li>
<li><strong>显存不足</strong>：GPU显存被占满</li>
<li><strong>渲染任务过重</strong>：需要渲染的UI内容太复杂</li>
</ol>
<h2 data-id="heading-32"><strong>根本原因：三级阻塞导致的渲染链断裂</strong></h2>
<h3 data-id="heading-33"><strong>核心问题链：</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> <span class="hljs-strong">**系统级资源枯竭**</span>（Load: 169.8）
   ↓
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**GPU驱动层阻塞**</span>（amdgpu<span class="hljs-emphasis">_cs_</span>query<span class="hljs-emphasis">_fence_</span>status）
   ↓  
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**渲染线程等待**</span>（RenderThread被阻塞）
   ↓
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**主线程超时**</span>（等待渲染线程完成绘制）
   ↓
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**ANR发生**</span>
</code></pre>
<h3 data-id="heading-34"><strong>详细分解：</strong></h3>
<h4 data-id="heading-35"><strong>1. 根本触发点：TIME_TICK广播</strong></h4>
<ul>
<li><strong>现象</strong>：每分钟一次的TIME_TICK广播</li>
<li><strong>作用</strong>：触发Launcher的UI时间更新</li>
<li><strong>不是根本原因</strong>，只是<strong>触发器</strong></li>
</ul>
<h4 data-id="heading-36"><strong>2. 直接原因：GPU驱动层阻塞</strong></h4>
<pre><code class="hljs language-ini" lang="ini">"RenderThread" daemon <span class="hljs-attr">prio</span>=<span class="hljs-number">7</span> tid=<span class="hljs-number">26</span> Native
  native: <span class="hljs-comment">#03 pc 0000000000004920  /system/vendor/lib64/libdrm_amdgpu.so (amdgpu_cs_query_fence_status+248)</span>
</code></pre>
<ul>
<li><strong>问题</strong>：GPU驱动程序<code>amdgpu</code>在查询fence状态时阻塞</li>
<li><strong>影响</strong>：渲染线程等待GPU完成渲染命令</li>
<li><strong>本质</strong>：GPU硬件或驱动无法及时响应</li>
</ul>
<h4 data-id="heading-37"><strong>3. 传导原因：渲染线程链式阻塞</strong></h4>
<ul>
<li><strong>主线程</strong> → 调用<code>ThreadedRenderer.nSyncAndDrawFrame()</code></li>
<li><strong>主线程</strong> → 等待渲染线程完成（<code>DrawFrameTask::postAndWait()</code>）</li>
<li><strong>渲染线程</strong> → 等待GPU的fence状态</li>
<li><strong>12个RenderScript线程</strong> → 也在等待信号（<code>Signal::wait()</code>）</li>
</ul>
<h4 data-id="heading-38"><strong>4. 放大原因：系统级资源枯竭</strong></h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Load: 169.8 / 144.63 / 112.13</span>
</code></pre>
<ul>
<li><strong>系统有169个进程在等待CPU</strong></li>
<li><strong>CPU调度器无法及时调度所有进程</strong></li>
<li><strong>GPU调度也受影响</strong>（GPU调度依赖CPU）</li>
</ul>
<h4 data-id="heading-39"><strong>5. 加剧因素：应用内存访问频繁</strong></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">faults:</span> <span class="hljs-number">8324 </span><span class="hljs-string">minor</span> <span class="hljs-number">3</span> <span class="hljs-string">major</span>
<span class="hljs-attr">Total GC time:</span> <span class="hljs-number">8.</span><span class="hljs-string">993s</span>
<span class="hljs-attr">Total GC count:</span> <span class="hljs-number">141</span>
</code></pre>
<ul>
<li><strong>频繁的内存分配和GC</strong>消耗CPU时间</li>
<li><strong>进一步加剧了CPU竞争</strong></li>
</ul>
<h3 data-id="heading-40"><strong>根本原因一句话总结：</strong></h3>
<p><strong>车机GPU驱动（amdgpu）在高系统负载（Load 169.8）下无法及时处理渲染命令，导致渲染链断裂，主线程等待渲染线程超时，最终在TIME_TICK广播触发UI更新时发生ANR。</strong></p>
<h3 data-id="heading-41"><strong>各层责任分配：</strong></h3>






























<table><thead><tr><th>层级</th><th>责任</th><th>具体问题</th></tr></thead><tbody><tr><td><strong>硬件/驱动层</strong></td><td><strong>主要责任</strong></td><td>AMD GPU驱动程序响应慢，fence查询阻塞</td></tr><tr><td><strong>系统层</strong></td><td><strong>重要责任</strong></td><td>系统负载极高（169.8），资源调度失效</td></tr><tr><td><strong>应用层</strong></td><td><strong>次要责任</strong></td><td>频繁的内存操作和GC，UI更新时机不当</td></tr><tr><td><strong>广播机制</strong></td><td><strong>触发责任</strong></td><td>TIME_TICK广播在错误的时间触发UI更新</td></tr></tbody></table>
<h2 data-id="heading-42">4.总结：</h2>




























































<table><thead><tr><th><strong>维度</strong></th><th><strong>高系统负载（Load ≈ 170）</strong></th><th><strong>使用 <code>TextClock</code></strong></th></tr></thead><tbody><tr><td><strong>性质</strong></td><td><strong>系统级环境问题</strong>（外部诱因）</td><td><strong>应用级实现问题</strong>（直接导火索）</td></tr><tr><td><strong>表现</strong></td><td><code>Load: 169.8 / 144.63 / 112.13</code> 大量进程排队，CPU/I/O 资源枯竭</td><td>布局中使用 <code>&lt;TextClock&gt;</code>，代码中持有 <code>TextClock</code> 引用</td></tr><tr><td><strong>根本机制</strong></td><td>后台进程（如 <code>gzip</code>、<code>tar_custom</code>）持续占用 CPU + I/O，导致主线程调度延迟</td><td><code>TextClock</code> 内部自动注册 <code>android.intent.action.TIME_TICK</code> 广播，每分钟在主线程响应系统广播</td></tr><tr><td><strong>是否必要条件</strong></td><td>❌ 单独存在通常不会直接导致 ANR（但会造成卡顿）</td><td>❌ 在正常系统中完全安全</td></tr><tr><td><strong>是否充分条件</strong></td><td>❌ 系统可能卡但不一定会 ANR</td><td>❌ 正常负载下无风险</td></tr><tr><td><strong>联合效应</strong></td><td>✅ <strong>两者叠加 → 主线程无法在 10 秒内处理广播 → Broadcast ANR</strong></td><td/></tr><tr><td><strong>排查方式</strong></td><td><code>adb shell cat /proc/loadavg</code> <code>adb shell top</code> 查看 ANR 日志中的 Load 和 CPU 分布</td><td>全局搜索 <code>TextClock</code> 检查布局文件是否包含 <code>&lt;TextClock&gt;</code> 确认是否在大卡片模式启用</td></tr><tr><td><strong>短期修复</strong></td><td>暂无法由应用层解决（需平台配合）</td><td>✅ <strong>替换为 <code>TextView + Handler</code> 定时更新</strong> 彻底绕过系统广播，消除 ANR 风险</td></tr><tr><td><strong>长期优化</strong></td><td>✅ 联系车机平台： - 限制 <code>tar_custom</code>/<code>gzip</code> 的 I/O 频率 - 优化后台任务调度 - 提升存储性能</td><td>✅ 移除所有隐式广播依赖，避免使用自动注册广播的系统控件（如 <code>TextClock</code>, <code>DigitalClock</code>）</td></tr><tr><td><strong>风险等级</strong></td><td>🔴 <strong>极高</strong>（影响整个系统稳定性）</td><td>🟠 <strong>中高</strong>（在高负载环境下极易触发 ANR）</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南]]></title>    <link>https://juejin.cn/post/7587473691170635776</link>    <guid>https://juejin.cn/post/7587473691170635776</guid>    <pubDate>2025-12-26T00:16:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587473691170635776" data-draft-id="7587605704636203042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T00:16:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T00:16:42.000Z" title="Fri Dec 26 2025 00:16:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java 21虚拟线程实战：7个性能翻倍的异步重构案例与避坑指南</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Java 21的发布标志着并发编程的一次重大飞跃，其核心特性之一——虚拟线程（Virtual Threads）为高吞吐量应用带来了革命性的改进。虚拟线程是轻量级的用户态线程，由JVM管理而非操作系统，可以显著降低创建和切换线程的开销。本文将深入探讨如何通过虚拟线程重构传统异步代码，并结合7个真实案例展示性能提升的关键技巧。同时，我们也会揭示实践中常见的陷阱及其规避方法。</p>
<hr/>
<h3 data-id="heading-2">虚拟线程基础</h3>
<p>在深入案例之前，有必要理解虚拟线程的核心机制：</p>
<ol>
<li><strong>轻量级调度</strong>：虚拟线程由JVM调度，无需占用OS线程资源，单个JVM可支持数百万个活跃虚拟线程。</li>
<li><strong>协作式挂起</strong>：通过<code>Continuation</code>机制实现任务主动让出控制权（如I/O阻塞时），避免资源浪费。</li>
<li><strong>兼容性</strong>：基于<code>java.lang.Thread</code> API设计，现有代码只需最小修改即可迁移。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建虚拟线程的两种方式</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">virtualThread</span> <span class="hljs-operator">=</span> Thread.ofVirtual().start(() -&gt; System.out.println(<span class="hljs-string">"Hello"</span>));
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor();
</code></pre>
<hr/>
<h3 data-id="heading-3">案例解析：从传统异步到虚拟线程重构</h3>
<h4 data-id="heading-4">案例1：HTTP服务请求并行化</h4>
<p><strong>原始代码</strong>：使用<code>CompletableFuture</code>实现异步HTTP调用</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; fetchData(url), executor);
</code></pre>
<p><strong>问题</strong>：依赖固定大小线程池，易出现资源耗尽或闲置。</p>
<p><strong>重构方案</strong>：每个请求分配独立虚拟线程</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executor.submit(() -&gt; fetchData(url)).get();
}
</code></pre>
<p><strong>效果</strong>：吞吐量提升300%，延迟降低60%（实测数据）。</p>
<hr/>
<h4 data-id="heading-5">案例2：批量数据库操作优化</h4>
<p><strong>原始代码</strong>：批处理使用同步循环</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">for</span> (Query query : queries) {
    dbClient.execute(query); <span class="hljs-comment">// 阻塞调用</span>
}
</code></pre>
<p><strong>重构方案</strong>：虚拟线程+结构化并发（Java 21新特性）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {
    <span class="hljs-keyword">for</span> (Query query : queries) {
        scope.fork(() -&gt; dbClient.execute(query));
    }
    scope.join();
}
</code></pre>
<p><strong>优势</strong>：所有子任务自动生命周期管理，避免泄漏风险。</p>
<hr/>
<h4 data-id="heading-6">案例3：文件IO密集型任务</h4>
<p>原始同步代码在读取大文件时阻塞工作线程。通过<code>FileChannel</code>+虚拟线程改造：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Path.of(<span class="hljs-string">"largefile.bin"</span>);
<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    executor.submit(() -&gt; Files.readAllBytes(path)); <span class="hljs-comment">// JVM自动挂起优化</span>
}
</code></pre>
<p>实测显示CPU利用率从40%提升至75%。</p>
<hr/>
<h4 data-id="heading-7">案例4-7快速一览：</h4>



































<table><thead><tr><th>案例</th><th>原技术栈</th><th>重构方案</th><th>QPS提升</th></tr></thead><tbody><tr><td>微服务聚合</td><td>Reactive Streams</td><td>Virtual Threads + CompletableFuture</td><td>220%</td></tr><tr><td>日志异步处理</td><td>BlockingQueue</td><td>LinkedBlockingQueue + VTs</td><td>180%</td></tr><tr><td>Websocket推送</td><td>Netty EventLoop</td><td>VirtualThreadPerTaskExecutor</td><td>150%</td></tr><tr><td>CI/CD任务调度</td><td>Quartz Scheduler</td><td>Structured Concurrency</td><td>Reduce GC by 70%</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">避坑指南</h3>
<h4 data-id="heading-9">🚨 <strong>陷阱1：虚假的非阻塞调用</strong></h4>
<p>即使使用虚拟线程，若底层库（如JDBC驱动）未实现真非阻塞IO，仍会导致载体线程（Carrier Thread）阻塞。解决方案：</p>
<ul>
<li>确认驱动支持异步API（如R2DBC）</li>
<li>For CPU-bound tasks, still prefer platform threads</li>
</ul>
<h4 data-id="heading-10">🚨 <strong>陷阱2：过度创建Pin住的虚擬線程</strong></h4>
<p>某些Native操作（如JNI调用）会"pin"住虛擬線程到載體線程。监控工具推薦：</p>
<pre><code class="hljs language-bash" lang="bash">jcmd &lt;pid&gt; Thread.dump_to_file -format=json vthread_dump.json
</code></pre>
<h4 data-id="heading-11">🚨 <strong>陷阱3：忽视结构化并发的取消语义</strong></h4>
<p>未正确处理<code>ShutdownOnFailure()</code>可能导致资源泄漏：</p>
<pre><code class="hljs language-java" lang="java">scope.fork(() -&gt; {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> acquireDbConn()) { <span class="hljs-comment">// AutoCloseable必须!</span>
        <span class="hljs-keyword">return</span> query(connection);
    }
});
</code></pre>
<hr/>
<h3 data-id="heading-12">JVM调优建议</h3>
<ol>
<li><strong>载体線程数配置</strong>:
<pre><code class="hljs language-bash" lang="bash">-Djdk.virtualThreadScheduler.parallelism=CPU核心数*2 
</code></pre>
</li>
<li><strong>内存分配</strong>: Virtual threads have <del>1KB stack vs平台thread's默认</del>1MB</li>
<li><strong>监控</strong>: JDK Flight Recorder新增虛擬線程事件:
<pre><code class="hljs language-ini" lang="ini">jcmd &lt;pid&gt; JFR.start <span class="hljs-attr">settings</span>=profile filename=vthread.jfr
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-13">Conclusion</h3>
<p>Java21的虛擬線程並非銀彈(A silver bullet)，但正確使用時能將同步代碼的簡單性與異步系統的高效性完美結合。本文展示的7個重構模式覆蓋了IO密集、並行計算等典型場景——關鍵在于識別真實阻塞點並結合Structured Concurrency等新特性規避風險。展望未來隨著生態系統對虛擬線程適配完成(如Hibernate6.x已支持)，這項技術或將重塑Java服務端開發範式。</p>
<p>對於現有系統遷移建議採用漸進式策略:從邊緣服務開始驗證→核心無狀態服務→最終擴展至數據層訪問模塊(middle-out migration)。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React使用useLayoutEffect解决操作DOM页面闪烁问题]]></title>    <link>https://juejin.cn/post/7587672626757648403</link>    <guid>https://juejin.cn/post/7587672626757648403</guid>    <pubDate>2025-12-26T00:31:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587672626757648403" data-draft-id="7576470438581272602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React使用useLayoutEffect解决操作DOM页面闪烁问题"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-26T00:31:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React使用useLayoutEffect解决操作DOM页面闪烁问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T00:31:09.000Z" title="Fri Dec 26 2025 00:31:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 概述</h2>
<p><code>useLayoutEffect</code> 是 React 中用于处理副作用的 Hook 之一，它与 <code>useEffect</code> 功能相似，但执行时机有着显著差异。<code>useLayoutEffect</code> 会在所有的 DOM 变更之后同步执行，这一特性使其特别适合用于需要基于最新 DOM 结构进行操作的场景，例如获取元素尺寸、操作 DOM 样式等，能有效避免因异步执行导致的视觉闪烁或布局抖动问题，确保页面渲染的稳定性和一致性。</p>
<h2 data-id="heading-1">2. 基本原理与语法</h2>
<p><code>useLayoutEffect</code> 的原理基于 React 的渲染机制。在 React 进行组件渲染时，会先构建虚拟 DOM，计算出需要更新的部分，然后将这些更新应用到真实 DOM 上。<code>useLayoutEffect</code> 恰好在真实 DOM 更新完成，但浏览器尚未进行绘制之前执行，这就保证了开发者可以在这个阶段安全地访问和操作最新的 DOM 结构。</p>
<p>在语法使用上，<code>useLayoutEffect</code> 需要从 <code>react</code> 库中导入，它接受一个回调函数作为参数，该回调函数中可以编写副作用逻辑。同时，<code>useLayoutEffect</code> 也支持第二个可选参数，即依赖项数组，用于控制副作用的重新执行时机。其语法示例如下：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, useState } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Count is <span class="hljs-subst">${count}</span>`</span>;
  }, [count]);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;Increment<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>在上述代码中，<code>useLayoutEffect</code> 会在每次 <code>count</code> 状态发生变化，且 DOM 已更新后，立即更新页面的标题。依赖项数组 <code>[count]</code> 确保只有当 <code>count</code> 改变时，<code>useLayoutEffect</code> 的回调函数才会重新执行。</p>
<h2 data-id="heading-2">3. 应用场景</h2>
<p>下面是一些实际的应用场景：</p>
<h3 data-id="heading-3">3.1 获取元素尺寸和位置</h3>
<p>在开发图表、拖拽交互等功能时，常常需要获取元素的尺寸和位置信息。例如，在一个动态生成的柱状图组件中，每个柱子的高度需要根据数据动态计算并设置。通过 <code>useLayoutEffect</code>，可以在组件渲染完成后，立即获取容器元素的尺寸，再根据数据计算柱子高度并设置相应的样式，保证图表能够准确渲染，避免因异步计算导致的图表闪烁问题。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, useState, useRef } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">BarChart</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-keyword">const</span> chartRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [barHeights, setBarHeights] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (chartRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">const</span> containerWidth = chartRef.<span class="hljs-property">current</span>.<span class="hljs-property">offsetWidth</span>;
      <span class="hljs-keyword">const</span> newBarHeights = data.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
        <span class="hljs-comment">// 简单计算柱子高度，实际应用中更复杂</span>
        <span class="hljs-keyword">return</span> (value / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...data)) * containerWidth;
      });
      <span class="hljs-title function_">setBarHeights</span>(newBarHeights);
    }
  }, [data]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{chartRef}</span>&gt;</span>
      {data.map((_, index) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">width:</span> '<span class="hljs-attr">20px</span>',
            <span class="hljs-attr">height:</span> `${<span class="hljs-attr">barHeights</span>[<span class="hljs-attr">index</span>]}<span class="hljs-attr">px</span>`,
            <span class="hljs-attr">backgroundColor:</span> '<span class="hljs-attr">blue</span>',
            <span class="hljs-attr">marginRight:</span> '<span class="hljs-attr">5px</span>',
            <span class="hljs-attr">display:</span> '<span class="hljs-attr">inline-block</span>'
          }}
        /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">BarChart</span>;
</code></pre>
<h3 data-id="heading-4">3.2 强制同步更新 DOM 样式</h3>
<p>当需要根据状态变化立即更新 DOM 样式，且不希望出现视觉延迟时，<code>useLayoutEffect</code> 是最佳选择。比如在实现一个主题切换功能时，用户点击切换主题按钮后，页面的整体样式需要立即改变。利用 <code>useLayoutEffect</code>，可以在状态更新后，同步修改 DOM 的样式类名或直接设置内联样式，确保用户能即时看到主题切换效果，不会出现短暂的样式错乱。</p>
<h3 data-id="heading-5">3.3 处理浏览器事件与 DOM 交互</h3>
<p>在绑定和处理一些与 DOM 紧密相关的浏览器事件时，<code>useLayoutEffect</code> 能确保事件绑定在正确的 DOM 结构上。例如，为一个可滚动的列表添加滚动事件监听器，需要在列表渲染完成后进行绑定。使用 <code>useLayoutEffect</code> 可以在 DOM 更新后立即绑定滚动事件，并且在组件卸载时正确移除事件监听器，避免内存泄漏，保证交互功能的稳定性。</p>
<h2 data-id="heading-6">4. 与其他相关Hook的对比</h2>
<p>在 React 的 Hook 体系中，<code>useLayoutEffect</code> 与 <code>useEffect</code> 最为相似，但它们的执行时机决定了不同的应用场景。<code>useEffect</code> 会在浏览器完成绘制后异步执行，适用于不影响页面视觉效果的副作用操作，如数据请求、订阅事件等。例如，从 API 获取数据并更新组件状态，这种操作不需要即时反馈给用户，使用 <code>useEffect</code> 不会影响页面的流畅度。</p>
<p>而 <code>useLayoutEffect</code> 由于同步执行的特性，如果在其回调函数中执行复杂计算或耗时操作，可能会阻塞浏览器的渲染，导致页面卡顿。因此，在选择使用时，开发者需要根据副作用操作是否与 DOM 渲染紧密相关，以及是否对即时性有要求来决定使用 <code>useLayoutEffect</code> 还是 <code>useEffect</code>。</p>
<p>此外，<code>useLayoutEffect</code> 与 <code>useState</code>、<code>useReducer</code> 等状态管理 Hook 也有所不同。<code>useState</code> 和 <code>useReducer</code> 主要用于管理组件的状态，而 <code>useLayoutEffect</code> 专注于处理与状态变化相关的副作用，它们在 React 应用开发中承担着不同的角色，相互配合以实现丰富的功能。</p>
<h2 data-id="heading-7">5. 结合其他Hook使用</h2>
<p><code>useLayoutEffect</code> 可以与其他 Hook 灵活结合使用，以满足更复杂的需求。例如，与 <code>useRef</code> 结合可以更方便地操作 DOM 元素。在一个实现自动聚焦的输入框组件中，通过 <code>useRef</code> 获取输入框元素的引用，再利用 <code>useLayoutEffect</code> 在组件渲染完成后立即将焦点设置到输入框上，实现用户进入页面即可直接输入的效果。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useLayoutEffect, useRef } <span class="hljs-keyword">from</span><span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">AutoFocusInput</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (inputRef.<span class="hljs-property">current</span>) {
      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
    }
  }, []);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">AutoFocusInput</span>;
</code></pre>
<p>同时，<code>useLayoutEffect</code> 也能和 <code>useState</code> 配合，在状态更新后基于最新 DOM 进行操作。比如在一个可折叠面板组件中，当面板展开或收起的状态改变时，<code>useLayoutEffect</code> 可以在 DOM 更新后获取面板的高度等信息，用于实现过渡动画或其他交互效果。</p>
<h2 data-id="heading-8">6. 注意事项</h2>
<ul>
<li>避免在 <code>useLayoutEffect</code> 中执行长时间运行的任务或复杂计算，因为它会阻塞浏览器的渲染线程，导致页面卡顿，影响用户体验。如果有复杂计算需求，尽量将其放在 <code>useEffect</code> 或其他异步操作中进行。</li>
<li>合理使用依赖项数组，确保 <code>useLayoutEffect</code> 的回调函数在正确的时机重新执行。错误设置依赖项数组可能会导致副作用执行次数过多或过少，引发难以排查的问题。</li>
<li>由于 <code>useLayoutEffect</code> 会在 DOM 更新后立即执行，频繁触发可能会带来性能问题。在设计组件逻辑时，要尽量减少不必要的 <code>useLayoutEffect</code> 调用，或者通过优化逻辑减少其执行频率。</li>
<li>当 <code>useLayoutEffect</code> 中包含事件监听器等资源时，一定要在组件卸载时正确清理，避免内存泄漏。通常可以在 <code>useLayoutEffect</code> 返回的清理函数中移除事件监听器或取消订阅等操作。</li>
</ul>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刷新后点赞全变 0？别急着怪 Redis，这八成是 Long 被 JavaScript 偷偷“改号”了（一次线上复盘）]]></title>    <link>https://juejin.cn/post/7587605704636121122</link>    <guid>https://juejin.cn/post/7587605704636121122</guid>    <pubDate>2025-12-25T16:08:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587605704636121122" data-draft-id="7587594077015523362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刷新后点赞全变 0？别急着怪 Redis，这八成是 Long 被 JavaScript 偷偷“改号”了（一次线上复盘）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-25T16:08:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WanderInk"/> <meta itemprop="url" content="https://juejin.cn/user/4440283730679642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刷新后点赞全变 0？别急着怪 Redis，这八成是 Long 被 JavaScript 偷偷“改号”了（一次线上复盘）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4440283730679642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WanderInk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T16:08:44.000Z" title="Thu Dec 25 2025 16:08:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做社区功能的人，多半都经历过这种抓狂时刻：你在帖子上点了个赞，按钮立刻高亮，数字也加一，用户体验看起来很丝滑；可你一刷新页面，点赞数像被人清空了一样，全部回到 0。你打开 Redis 客户端看，计数 key 明明存在，值也不是 0。于是你开始怀疑缓存一致性，怀疑是不是读了另一台 Redis，怀疑线上 jar 没更新，甚至怀疑自己是不是在梦里写代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d082f11fc24aed8b8a6685e17893ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZGVySW5r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767283724&amp;x-signature=MjWhUtKbk4Bj7QcEhxY7HR0wfwU%3D" alt="ChatGPT Image 2025年12月26日 00_06_20.png" loading="lazy"/></p>
<p>我得说，这类问题最阴的地方就在于它特别像缓存问题，实际上却往往跟缓存一点关系都没有。真正的凶手是数据类型边界，准确地说，是 Java 的 long 雪花 id 进了 JavaScript 的 Number 世界以后超过安全整数范围，发生了精度丢失，导致你点赞写入用的是一个“被四舍五入后的 id”，刷新读取用的又是“真实 id”。写入和读取压根不是同一个目标，你换十台 Redis 也救不了。</p>
<p>我当时定位这个问题的切入点很朴素，不靠猜，全靠证据。把浏览器 Network 打开，盯住两处就够了：列表或者详情接口返回的帖子 id，和点赞接口请求路径里带的 id。正常情况下它们应该一模一样，哪怕多一个字符都不行。结果我看到的非常刺眼，点赞请求打的是 <code>.../posts/2003003909205840000/like</code>，列表返回的真实 id 却是 <code>2003003909205839874</code>。你看这俩数字差得不多，甚至肉眼一滑可能以为一样，但在业务上它们就是两个完全不同的帖子。更关键的是，这种“差一点点”的差法特别典型，末尾被抹平，被凑整，被改号，这是 JavaScript 精度丢失的指纹。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c6d3124f7b4c47a57ee7cec033c9b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZGVySW5r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767283724&amp;x-signature=2PaIjWrlNrAs7gFBgtxL5hH4js4%3D" alt="ChatGPT Image 2025年12月26日 00_06_50.png" loading="lazy"/></p>
<p>原因在于 JavaScript 的 Number 是双精度浮点数，安全整数上限是 2^53-1，也就是 9007199254740991。雪花 id 动辄十八十九位，早就远远超过这个范围。超过之后，JS 不是直接报错，它会用一个最接近的可表示值来存，于是你以为你拿到了 2003003909205839874，实际上它在内存里已经变成了另一个相邻但不同的数。前端把这个“变形 id”拼进 URL 发给后端，后端又是强类型世界，收到什么就当什么，于是 Redis 的 key 写成 <code>forum:like:count:1:2003003909205840000</code>，数据库里 target_id 也可能跟着写错。刷新页面时，列表接口从数据库读出真实帖子，再把真实 id 返回给前端，前端用真实 id 去查计数，当然查不到，因为计数全在另一个 id 上，于是你看到的就是“刷新后全是 0”。这不是缓存不一致，这是写错对象了，属于逻辑层面彻底错位。</p>
<p>这种坑之所以容易把人带沟里，是因为点赞当下看起来“生效”。很多实现会在点击后先做乐观更新，UI 先加一，给用户即时反馈。再加上 Redis 里确实有 key 有值，你就更容易误判成“读取链路有问题”。但只要你把写入 id 和读取 id 对齐看一眼，真相就很干净，干净得甚至有点残忍。</p>
<p>修复这类问题，我的经验是别在前端做花活，工程上最稳的路线是后端把所有 Long 统一序列化成字符串，让 id 从一开始就别进 JS 的 Number 世界。只要 JSON 里 id 带引号，前端拿到的就是 string，拼 URL 比较相等都不会丢精度。Spring Boot 里用 Jackson 做全局配置就行，把 Long 和 long 都用 ToStringSerializer 输出，类似这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.meme.generator.config;

<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ser.std.ToStringSerializer;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jackson.Jackson2ObjectMapperBuilderCustomizer;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="hljs-title function_">longToStringCustomizer</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> builder -&gt; {
            builder.serializerByType(Long.class, ToStringSerializer.instance);
            builder.serializerByType(Long.TYPE, ToStringSerializer.instance);
        };
    }
}
</code></pre>
<p>上线之后你会很直观地看到变化，接口返回从 <code>id: 200300...</code> 变成 <code>"id":"200300..."</code>。这一步就是治本，因为你把风险源头掐掉了。前端这边也别犹豫，所有 id 一律当字符串处理，路由参数、请求参数、Map key、对比逻辑都用 string，别手贱去 Number(id)。如果你用 TypeScript，把 DTO 里的 id 类型直接写死成 string，能提前拦住一堆无意的隐式转换。</p>
<p>光把 Long 转字符串还不够，我习惯再加一道保险，防止系统继续被脏请求污染。点赞接口在真正写 Redis 和写 DB 之前，先校验 targetId 必须真实存在。原因很现实，就算你前端全修好了，也总会有人抓包乱打接口，或者旧版本前端还在外面跑，甚至某些数据链路中间又把 id 搞成了 number。你不想 Redis 和点赞表里永远躺着一堆“幽灵帖子”的点赞记录，最好的办法就是入口处把门关死，不存在的帖子或评论直接拒绝，别写入任何东西。这样系统的容错会强很多，你以后做统计、排行、消息通知也不至于被脏数据恶心。</p>
<p>修复上线以后验证也很简单，不需要写什么复杂用例。你打开 Network 看一眼列表接口响应，只要 id 带引号，基本可以确认你已经跨过了 JS 精度这个坑。如果你发现线上还是数字 id，那就别往下测了，说明你压根没部署到新版本或者配置没生效。接着随便点个赞，观察点赞请求路径里的 id 是否和列表返回完全一致，然后刷新页面看 likeCount 是否还能保持一致。如果这三件事都稳了，这个问题就可以宣布结束，属于“永不复发”那一类。</p>
<p>最后别忘了历史脏数据。这个坑一旦发生过，你 Redis 里很可能已经存在一批错误 id 的计数 key，数据库里也可能已经有 target_id 指向不存在目标的点赞记录。新版本不会再产生，但旧的如果不清理，迟早会在某个统计功能里反咬你一口。清理的思路也不复杂，本质上就是删掉所有指向不存在目标的点赞记录。举个常见场景，如果你的点赞表是 forum_like，帖子表是 forum_post，并且 target_type=1 代表帖子，你可以在确认备份和测试之后用类似的 SQL 找并删除“不存在帖子”的点赞记录：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> fl
<span class="hljs-keyword">FROM</span> forum_like fl
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> forum_post fp <span class="hljs-keyword">ON</span> fp.id <span class="hljs-operator">=</span> fl.target_id
<span class="hljs-keyword">WHERE</span> fl.target_type <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">AND</span> fp.id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<p>Redis 清理也建议用 SCAN 去做渐进删除，别在生产上用 KEYS 图省事，Redis 这玩意你真把它阻塞了，后果比点赞错位严重多了。</p>
<p>写到这里你会发现，这次事故真正的教训其实很工程化：跨语言系统里，id 这种一旦出错就会写错对象的字段，永远不要把它当数值去传。尤其是雪花 long，在 Java 世界里再自然不过，到了 JS 世界里就是个随时可能变形的“危险品”。把 Long 输出成字符串不是洁癖，是对线上稳定性的尊重。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec3e298142b4485eaf8b4ec0c9c7bc65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZGVySW5r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767283724&amp;x-signature=cCGWcOwKgJ9aM4Mw551YtDyU3hM%3D" alt="ChatGPT Image 2025年12月26日 00_07_25.png" loading="lazy"/></p>
<p>如果你现在也被“刷新后点赞全是 0”折磨着，我建议你先别急着调 Redis 和部署链路，先做一件最便宜但最有效的事：对比一下列表返回的 id 和点赞请求里的 id 是否完全一致。只要它们差一点点，你就已经抓到凶手了。把 Long 全局转字符串，再把点赞入口加上存在性校验，最后清掉历史脏数据，你会发现这个问题结束得非常干脆，甚至有点爽。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[案例+图解带你一文读懂Svg、Canvas、Css、Js动画🔥🔥（4k+字）]]></title>    <link>https://juejin.cn/post/7587811143109509171</link>    <guid>https://juejin.cn/post/7587811143109509171</guid>    <pubDate>2025-12-26T07:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587811143109509171" data-draft-id="7587903505134878770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="案例+图解带你一文读懂Svg、Canvas、Css、Js动画🔥🔥（4k+字）"/> <meta itemprop="keywords" content="前端,JavaScript,Canvas"/> <meta itemprop="datePublished" content="2025-12-26T07:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lsx_"/> <meta itemprop="url" content="https://juejin.cn/user/1442981392682829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            案例+图解带你一文读懂Svg、Canvas、Css、Js动画🔥🔥（4k+字）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442981392682829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lsx_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T07:43:15.000Z" title="Fri Dec 26 2025 07:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>动画在前端开发中扮演着重要的角色。它不仅可以提升用户体验，还可以使界面更加生动和有趣。在这篇文章中，我们将深入探讨前端动画的各种实现方式，包括 CSS 动画、JavaScript 动画、SVG 动画等。我们还将讨论一些触发动画的方式和动画在用户体验中的最佳实践。</p>
<h2 data-id="heading-1">前端动画分类</h2>
<ul>
<li>
<p><strong><code>CSS 动画</code></strong></p>
<ul>
<li>
<p><strong>CSS Transition</strong><br/>
CSS 过渡，属于<strong>补间动画</strong>，即设置关键帧的初始状态，然后在另一个关键帧改变这个状态，比如大小、颜色、透明度等，浏览器将自动根据二者之间帧的值创建的动画。</p>
</li>
<li>
<p><strong>CSS Animation</strong><br/>
CSS 动画，可以理解是 <code>CSS Transition</code> 的加强版，它既可以实现 <strong>补间动画</strong> 的动画效果，也可以使其以 <strong>逐帧动画</strong> 的方式进行绘制。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>SVG 动画</code></strong></p>
<ul>
<li>SVG 动画用于矢量图形，提供了高质量的动画效果，常用于图标和图形动画。可以使用 SMIL 在SVG中定义动画。同样的也可以使用css或者js来控制svg动画。</li>
</ul>
</li>
<li>
<p><strong><code>Canvas 动画</code></strong></p>
<ul>
<li>
<p>通过结合使用 <code>requestAnimationFrame</code>、路径和变换等技术对画布的元素进行擦除和重新绘制，可以实现复杂的动画效果。另外Canvas还可以用于绘制复杂的背景或静态内容，从而减少每帧的绘制工作量。</p>
</li>
<li>
<p>可以参考我的一篇关于canvas制作动画的文章：<a href="https://juejin.cn/post/7389211334641270793" target="_blank" title="https://juejin.cn/post/7389211334641270793">用Canvas绘制一个高可配置的圆形进度条</a></p>
</li>
</ul>
</li>
<li>
<p><strong><code>JS 动画</code></strong></p>
<ul>
<li>
<p><strong>setTimeout</strong> / <strong>setInterval</strong> / <strong>requestAnimationFrame</strong><br/>
<code>setTimeout</code> 和 <code>setInterval</code> 这两个 API 设定的时间会因为浏览器当前工作负载而有所偏差，而且无法与浏览器的绘制帧保持同步。所以才有了 <strong>与浏览器的绘制帧同步</strong> 的原生 API <code>requestAnimationFrame</code>，以取代 <code>setTimeout</code> 和 <code>setInterval</code> 实现动画。</p>
</li>
<li>
<p><strong>Web Animations API</strong><br/>
浏览器动画 API，通过 JavaScript 操作。这些 API 被设计成 <code>CSS Transition</code> 和 <code>CSS Animation</code> 的接口，很容易通过 JS 的方式实现 CSS 动画，它是对动画化的支持最有效的方式之一。</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">css 动画</h2>
<h3 data-id="heading-3">css过渡动画 <code>transition</code></h3>
<h4 data-id="heading-4">注意</h4>
<p>由于浏览器是根据样式差异化的两帧自动计算并过渡，所以 <code>transition</code> 只支持可识别中间值的属性 (如大小、颜色、位置、透明度等)，而如 display 属性则不支持。</p>
<h4 data-id="heading-5">语法定义</h4>
<ul>
<li>
<p><code>transition-property</code>： 指定哪个或哪些 CSS 属性用于过渡。只有指定的属性才会在过渡中发生动画，其他属性仍如通常那样瞬间变化。</p>
</li>
<li>
<p><code>transition-duration</code>： 指定过渡的时长。你可以为所有属性指定一个值，或者指定多个值，或者为每个属性指定不同的时长。</p>
</li>
<li>
<p><code>transition-timing-function</code>： 指定一个缓动函数，定义属性值怎么变化。常见的缓动函数是一个三次贝塞尔曲线 ( <code>cubic-bezier(&lt;x1&gt;, &lt;y1&gt;, &lt;x2&gt;, &lt;y2&gt;)</code> )。当然也可以选择关键字</p>
<ul>
<li><strong>linear</strong>：<code>cubic-bezier(0.0, 0.0, 1.0, 1.0)</code></li>
<li><strong>ease</strong>：<code>cubic-bezier(0.25, 0.1, 0.25, 1.0)</code></li>
<li><strong>ease-in</strong>：<code>cubic-bezier(0.42, 0.0, 1.0, 1.0)</code></li>
<li><strong>ease-out</strong>：<code>cubic-bezier(0.0, 0.0, 0.58, 1.0)</code></li>
<li><strong>ease-in-out</strong>：<code>cubic-bezier(0.42, 0.0, 0.58, 1.0)</code></li>
</ul>
</li>
<li>
<p><code>transition-delay</code>： 指定延迟，即属性开始变化时与过渡开始发生时之间的时长。</p>
</li>
</ul>
<h4 data-id="heading-6">代码示例</h4>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-comment">/* 单条 简写形式 */</span>
  <span class="hljs-attribute">transition</span>: 
    &lt;property&gt; &lt;duration&gt; &lt;timing-function&gt; &lt;delay&gt;;
  
  
  <span class="hljs-comment">/* 多条 简写形式 */</span>
  <span class="hljs-attribute">transition</span>: 
    &lt;property&gt; &lt;duration&gt; &lt;timing-function&gt; &lt;delay&gt;,
    &lt;property&gt; &lt;duration&gt; &lt;timing-function&gt; &lt;delay&gt;,
    ...;


  <span class="hljs-comment">/* 单条 子属性形式 */</span>
  <span class="hljs-attribute">transition-property</span>: &lt;property-name&gt;;
  <span class="hljs-attribute">transition-duration</span>: &lt;duration-time&gt;;
  <span class="hljs-attribute">transition-timing-function</span>: &lt;timing-function&gt;;
  <span class="hljs-attribute">transition-delay</span>: &lt;duration-time&gt;;
  
  
  <span class="hljs-comment">/* 多条 子属性形式 */</span>
  <span class="hljs-attribute">transition-property</span>: &lt;property-name&gt; [, &lt;property-name&gt;, ...];
  <span class="hljs-attribute">transition-duration</span>: &lt;duration-time&gt; [, &lt;duration-time&gt;, ...];
  <span class="hljs-attribute">transition-timing-function</span>: [, &lt;cubic-bezier&gt;, ...];
  <span class="hljs-attribute">transition-delay</span>: [, &lt;duration-time&gt;, ...];
  
  
  // 如果任意属性值列表的长度比其他属性值列表要短，则其中的值会重复使用以便匹配
  
  // 如果某个属性的值列表长于 `<span class="hljs-attribute">transition-property</span>` 的属性，则将被截短
  

</code></pre>
<h4 data-id="heading-7">css过渡动画 触发方式</h4>
<h5 data-id="heading-8">1. 伪类触发（:hover、:focus、:active等）</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.button</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background-color</span>: red;
}

</code></pre>
<h5 data-id="heading-9">2. 类名切换（通过JS动态切换类名来触发过渡效果）</h5>
<pre><code class="hljs language-js" lang="js">&lt;button id=<span class="hljs-string">"toggleButton"</span>&gt;<span class="hljs-title class_">Toggle</span>&lt;/button&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
  }

  <span class="hljs-selector-class">.box</span><span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">background-color</span>: red;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleButton'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'active'</span>);
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h5 data-id="heading-10">3. 属性变化</h5>
<pre><code class="hljs language-js" lang="js">&lt;button id=<span class="hljs-string">"toggleButton"</span>&gt;<span class="hljs-title class_">Toggle</span>&lt;/button&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'toggleButton'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>);
    box.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> = box.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> === <span class="hljs-string">'red'</span> ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'red'</span>;
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h5 data-id="heading-11">4. 伪元素触发（通过伪元素如<code>::before</code>、<code>::after</code>的状态变化来触发过渡效果。）</h5>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="box"&gt;&lt;/<span class="hljs-selector-tag">div</span>&gt;

&lt;style&gt;
  <span class="hljs-selector-class">.box</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">position</span>: relative;
  }

  <span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">0.3s</span> ease;
  }

  <span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">background-color</span>: red;
  }
&lt;/style&gt;

</code></pre>
<h3 data-id="heading-12">css动画 <code>animation</code></h3>
<h4 data-id="heading-13">注意</h4>
<p>CSS Animation 具备了对 <strong>关键帧和循环次数</strong> 的自定义能力。CSS Animation 在实现像 CSS Transition <strong>补间动画</strong> 效果时，还可以在起始帧和结束帧之间自定义中间帧，使得动画更加平滑过渡的同时，对动画有了更好的控制和自定义能力。</p>
<h4 data-id="heading-14">语法定义</h4>
<p>先创建一个带名称的 <code>@keyframes</code> 规则，以便后续使用 <code>animation-name</code> 属性将动画同其关键帧声明进行匹配。每个规则包含多个关键帧，也就是一段样式块语句，每个关键帧有一个百分比值作为名称，代表在动画进行中，在哪个阶段触发这个帧所包含的样式。</p>
<ul>
<li>
<p><code>animation-name</code>：指定一个或多个 @keyframes 的名称，描述了要应用于元素的动画。多个 @keyframes 以逗号分隔。</p>
</li>
<li>
<p><code>animation-duration</code>：设置动画完成一个动画周期所需的时间，需要指定单位，如 <code>1s</code>、<code>500ms</code>。</p>
</li>
<li>
<p><code>animation-delay</code>：指定执行动画之前的等待时间。动画可以稍后开始、立即从开头开始、立即在动画中途播放 <strong>(如 <code>-1s</code>)</strong> 。其中 <code>-1s</code> 意思是动画立即从 1s 处开始。</p>
</li>
<li>
<p><code>animation-iteration-count</code>：设置动画序列在停止前应播放的次数，有效值 <code>0</code>、正整数、正小数、无限循环 <code>infinite</code>。</p>
</li>
<li>
<p><code>animation-direction</code>：设置动画是正向播放 <code>normal</code>、反向播放 <code>reverse</code>、正向交替播放 <code>alternate</code>、反向交替播放 <code>alternate-reverse</code>。</p>
</li>
<li>
<p><code>animation-play-state</code>：设置动画是运行还是暂停，有效值 <code>running</code>、<code>paused</code>。</p>
</li>
<li>
<p><code>animation-fill-mode</code>：设置 CSS 动画在执行之前和之后如何将样式应用于其目标，有效值如下：</p>
<ul>
<li><code>none</code>：当动画未执行时，动画将不会将任何样式应用于目标，而是已经赋予给该元素的 CSS 规则来显示该元素。这是默认值</li>
<li><code>forwards</code>：目标将保留由执行期间遇到的最后一个关键帧计算值。</li>
<li><code>backwards</code>：动画将在应用于目标时立即应用第一个关键帧中定义的值。
<code>animation-timing-function</code>：设置动画在每个周期的持续时间内如何进行，主要是如下两种函数：</li>
</ul>
</li>
<li>
<p><code>cubic-bezier</code> 三次贝塞尔曲线 ( <code>cubic-bezier(&lt;x1&gt;, &lt;y1&gt;, &lt;x2&gt;, &lt;y2&gt;)</code> )，以实现 <strong>补间动画</strong> 效果。</p>
</li>
<li>
<p><code>steps</code> 是一个分段的阶跃函数，，以实现 <strong>逐帧动画</strong>。n 相当于单次动画的帧数，每帧动画的时间是均等的 (<code>steps(n, &lt;jumpterm&gt;)</code>)，其中 <code>jumpterm (默认值 end)</code> 含义如下：</p>
<ol>
<li>jump-start：在起始位置阶跃，<code>n=2 ⇒ 50% 100%; (100 / 2)</code></li>
<li>jump-end：在结束位置阶跃, <code>n=4 ⇒ 0% 25% 50% 75%; (100 / 4)</code></li>
<li>jump-none：起止位置均无跳跃，<code>n=5 ⇒ 0% 25% 50% 75% 100%; (100 / 4)</code></li>
<li>jump-both：起止位置均有跳跃 <code>n=3 ⇒ 25% 50% 75%; (100 / 4)</code></li>
<li>start：等同 jump-start</li>
<li>end：等同 jump-end</li>
<li>step-start：等同 steps(1, jump-start)</li>
<li>step-end：等同 steps(1, jump-end)</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-comment">/* animation 声明样式顺序 */</span> 
  <span class="hljs-comment">/* animation-duration */</span>
  <span class="hljs-comment">/* animation-easing-function */</span>
  <span class="hljs-comment">/* animation-delay */</span> 
  <span class="hljs-comment">/* animation-iteration-count */</span>
  <span class="hljs-comment">/* animation-direction */</span>
  <span class="hljs-comment">/* animation-fill-mode */</span>
  <span class="hljs-comment">/* animation-play-state */</span>
  <span class="hljs-comment">/* animation-name */</span>
  <span class="hljs-attribute">animation</span>: <span class="hljs-number">3s</span> ease-in <span class="hljs-number">1s</span> <span class="hljs-number">2</span> reverse both paused slidein; 

  
  <span class="hljs-comment">/* animation - duration | easing-function | delay | name */</span>
  <span class="hljs-attribute">animation</span>: <span class="hljs-number">3s</span> linear <span class="hljs-number">1s</span> slidein;
  
  
  <span class="hljs-comment">/* more animations - duration | easing-function | delay | name */</span>
  <span class="hljs-attribute">animation</span>: <span class="hljs-number">3s</span> linear slidein, <span class="hljs-number">3s</span> ease-out <span class="hljs-number">5s</span> slideout;

 
  <span class="hljs-comment">/* animation-name */</span>
  <span class="hljs-attribute">animation-name</span>: none;
  <span class="hljs-attribute">animation-name</span>: animate1;
  <span class="hljs-attribute">animation-name</span>: animate1, animate2;
  
  
  <span class="hljs-comment">/* animation-timing-function */</span>
  <span class="hljs-attribute">animation-timing-function</span>: ease;
  <span class="hljs-attribute">animation-timing-function</span>: step-start;
  <span class="hljs-attribute">animation-timing-function</span>: <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">animation-timing-function</span>: ease, step-start, <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.1</span>);
  

</code></pre>
<h4 data-id="heading-15">css animation 动画触发方式</h4>
<p>和css <code>transition</code> 触发动画方式相似</p>
<p><strong>此外还可以增加一个图层，专门用于制作动画效果。</strong></p>
<p>例如：鼠标在点击按钮时，会有涟漪动画。</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">// 涟漪动画定义</span>
@keyframes ripple {
  <span class="hljs-number">0</span>% {
    <span class="hljs-attr">transform</span>: <span class="hljs-title function_">scale</span>(<span class="hljs-number">0</span>);
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>;
  }

  to {
    <span class="hljs-attr">transform</span>: <span class="hljs-title function_">scale</span>(<span class="hljs-number">4</span>);
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>;
  }
}

<span class="hljs-comment">// 图层动画 css</span>
.<span class="hljs-property">ripple</span> {
  <span class="hljs-attr">position</span>: absolute;
  border-<span class="hljs-attr">radius</span>: <span class="hljs-number">50</span>%;
  <span class="hljs-attr">background</span>: <span class="hljs-title function_">rgba</span>(<span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0.2</span>);
  pointer-<span class="hljs-attr">events</span>: none;

  <span class="hljs-attr">animation</span>: ripple <span class="hljs-number">0.</span>6s linear;
}

<span class="hljs-comment">// 制作动画  这样每次点击按钮 就会生成动画，动画结束便销毁动画元素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">makeAnimate</span> = (<span class="hljs-params">e: React.MouseEvent</span>) =&gt; {
  <span class="hljs-keyword">const</span> dom = e.<span class="hljs-property">currentTarget</span>;
  <span class="hljs-keyword">const</span> rect = dom.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">const</span> x = e.<span class="hljs-property">clientX</span> - rect.<span class="hljs-property">left</span>;
  <span class="hljs-keyword">const</span> y = e.<span class="hljs-property">clientY</span> - rect.<span class="hljs-property">top</span>;
  <span class="hljs-keyword">const</span> size = <span class="hljs-number">100</span>;

  <span class="hljs-keyword">const</span> ripple = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
  ripple.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'ripple'</span>);
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${size}</span>px`</span>;
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${size}</span>px`</span>;
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${x - size / <span class="hljs-number">2</span>}</span>px`</span>;
  ripple.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${y - size / <span class="hljs-number">2</span>}</span>px`</span>;
  dom.<span class="hljs-title function_">appendChild</span>(ripple);

  ripple.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'animationend'</span>, <span class="hljs-function">() =&gt;</span> {
    ripple.<span class="hljs-title function_">remove</span>();
  });
};


</code></pre>
<h2 data-id="heading-16">svg 动画</h2>
<h3 data-id="heading-17">常用的 SMIL 动画元素</h3>
<ul>
<li><code>&lt;animate&gt;</code>：用于动画化单个属性。</li>
<li><code>&lt;animateTransform&gt;</code>：用于动画化变换属性，如旋转、缩放、平移等。</li>
<li><code>&lt;animateMotion&gt;</code>：用于沿着路径动画化元素。（路径动画）</li>
<li><code>&lt;set&gt;</code>：用于在指定时间点设置属性值。</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;svg width=<span class="hljs-string">"100"</span> height=<span class="hljs-string">"100"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">circle</span> <span class="hljs-attr">cx</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">cy</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">r</span>=<span class="hljs-string">"40"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"red"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">animate</span> <span class="hljs-attr">attributeName</span>=<span class="hljs-string">"cx"</span> <span class="hljs-attr">from</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"150"</span> <span class="hljs-attr">dur</span>=<span class="hljs-string">"2s"</span> <span class="hljs-attr">repeatCount</span>=<span class="hljs-string">"indefinite"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">circle</span>&gt;</span></span>
&lt;/svg&gt;

</code></pre>
<h3 data-id="heading-18">svg 描边动画</h3>
<p>SVG动画的路径实现主要依赖属性：<code>stroke</code>（描边）和 <code>fill</code>（填充）。</p>
<ul>
<li><strong>stroke</strong>：定义svg的轮廓线。常用css属性有： <code>stroke-dasharray</code>（描边的样式），<code>stroke-dashoffset</code>（起始位置），<code>stroke-color</code>（描边的颜色），<code>stroke-opacity</code>（描边的透明度），<code>stroke-linecap</code>（描边端点形状）等。</li>
<li><strong>fill</strong>：定义svg内部颜色或图案 ，常用css属性有<code>fill-opacity</code>(定义填充的透明度), <code>fill-rule</code>(定义填充规则)等。</li>
</ul>
<h4 data-id="heading-19">stroke-dasharray （定义虚线的长度和间隔）</h4>
<p>提供一个奇数或偶数数列，其中数与数之间用逗号或空格隔开，用来指定短划线和缺口的长度，并重复。 如果是<code>偶数数列</code>，则一个表示短线长度，一个表示缺口长度。 如果是<code>奇数数列</code>，将奇数数列复制一个变成偶数数列，然后按照短线，缺口的顺序绘制。</p>
<p>(偶数数列) <code>stroke-dasharray="5, 5" x1="10" y1="10" x2="190" y2="10"</code>表示从坐标（10,10）到(200,10)这条水平线上，短划线和缺口都为5个px</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3298ea28b93c4d6b9a6693bbe89e2984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339795&amp;x-signature=u0p86ISTMyua61kJghaqrnV%2F23Y%3D" alt="image.png" loading="lazy"/></p>
<p>（奇数数列） <code>stroke-dasharray="20 10 5" x1="10" y1="10" x2="190" y2="10"</code>表示从坐标（10,10）到(200,10)这条水平线上，短划线和缺口按照20 10 5 20 10 5的顺序排列。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f644bfba2884206af13d69046a6c4b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339795&amp;x-signature=mGga%2Be5%2BvHL5XTFGp%2FJXaFN%2BJhY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-20">stroke-dashoffset （定义虚线的起始位置）</h4>
<p>stroke-dashoffset 属性用于指定路径开始的距离(正值向左偏移，负值向右偏移)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b04bccdcff294be89efd61b13026531c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHN4Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767339795&amp;x-signature=JQOha66p%2BXZULeeSTsOPFCUBhDU%3D" alt="image.png" loading="lazy"/></p>
<p>描边动画示例：</p>
<p><a href="https://code.juejin.cn/pen/7391734513644077082" target="_blank" title="https://code.juejin.cn/pen/7391734513644077082">code.juejin.cn/pen/7391734…</a></p>
<h2 data-id="heading-21">js 动画</h2>
<h3 data-id="heading-22">setTimeout / setInterval API</h3>
<p>设定定时器，通过周期性的触发重复执行绘制动画的函数，来实现 “逐帧动画” 的效果。</p>
<ul>
<li>
<p>优势</p>
<ol>
<li>具有很好的浏览器兼容性</li>
</ol>
</li>
<li>
<p>劣势</p>
<ol>
<li>只能接近设备屏幕刷新率，无法做到和浏览器同步，所以可能会存在卡顿、丢帧、抖动的现象</li>
<li>由于浏览器单线程机制，存在队列中回调函数被阻塞的可能，所以无法保证每一次调用的时间间隔都相同，某次回调可能会被跳过，导致跳帧。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-23">requestAnimationFrame API</h3>
<p>为了弥补 <code>setTimeout / setInterval</code> 在动画方面的不足，浏览器提供了为动画而生的 API，它可以让 DOM 动画、Canvas 动画、 SVG 动画等有一个统一的刷新机制，随着浏览器的屏幕刷新，统一绘制动画帧。</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">let</span> id = <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// 动画函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">draw</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">/* 动画绘制... */</span>
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">start</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">draw</span>()
    <span class="hljs-title function_">cancelAnimationFrame</span>(id)
    id = <span class="hljs-title function_">requestAnimationFrame</span>(start)
  }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">stop</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-title function_">cancelAnimationFrame</span>(id) }
  
</code></pre>
<ul>
<li>
<p>优势</p>
<ol>
<li>由系统来决定回调函数的执行时机, 它能保证回调函数在屏幕每一次的刷新间隔中只被执行一次, 这样就不会引起丢帧现象, 也不会导致动画出现卡顿的问题。</li>
<li>在运行时浏览器会自动优化方法的调用，并且如果页面不是激活状态下的话，动画会自动暂停，有效节省了CPU的开销。</li>
</ol>
</li>
<li>
<p>不足</p>
<ol>
<li>同 setTimeout/setInterval 一样，它是以逐帧动画的方式进行绘制，无法做到像 CSS 动画，让游览器自动根据两帧之间的差异创建插值，以实现补间动画的过渡效果。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-24">Web Animations API</h3>
<ol>
<li><code>requestAnimationFrame</code>、<code>setTimeout/setInterval</code> 都是以逐帧绘制的方式实现动画， 而 <strong>Animations API</strong> 不仅可以 “逐帧动画”，还可以实现 “补间动画” 的效果。</li>
<li>CSS 动画有一定的局限性，需要事先预设动画样式，而且无法与 JS 进行交互。相比之下，<strong>Animations API</strong> 可以随时定义并使用动画，自然是更加灵活方便。</li>
</ol>
<p>参考文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWeb_Animations_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Animations_API" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></p>
<p>语法示例：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"container"</span>);

  <span class="hljs-keyword">const</span> animation = element.<span class="hljs-title function_">animate</span>(
    [
      { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translateY(0%)"</span> },
      { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translateY(100%)"</span> },
    ],
    { <span class="hljs-attr">duration</span>: <span class="hljs-number">3000</span>, <span class="hljs-attr">fill</span>: <span class="hljs-string">"forwards"</span> }
  );
  

</code></pre>
<p>代码示例：</p>
<p><a href="https://code.juejin.cn/pen/7391799461493932069" target="_blank" title="https://code.juejin.cn/pen/7391799461493932069">code.juejin.cn/pen/7391799…</a></p>
<h4 data-id="heading-25">关于Flip动画</h4>
<p>浏览器计算位置很快，绘制可能很慢。利用浏览器强大的计算能力，获取动画的起止状态，接着单独开启一个线程做动画。这样触发布局更新的操作，只会发生在一帧时间内，剩下的动画跑在单独的线程上，会更流畅。</p>
<p>介绍下FLIP 。</p>
<ol>
<li>F 代表 First，也就是动画的开始状态。</li>
<li>L 代表 Last，代表动画结束状态。</li>
<li>I 代表 Invert，也就是状态反转，使用 transform 等属性，创建单独的图层，并将元素状态反转回去。</li>
<li>P 代表 Play，播放动画。</li>
</ol>
<p>示例代码：</p>
<p>其中，在初始帧中，应用逆变换（<code>translate</code> 和 <code>scale</code>），将元素从其最终状态逆变换到初始状态。</p>
<p>最后一帧 <code>transform: "none"</code> 的作用是将元素的变换属性重置为其最终状态。具体来说，<code>transform: "none"</code> 表示不应用任何变换，这意味着元素将恢复到由 CSS 设置的最终位置和大小。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>FLIP Animation Example<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-id">#box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4caf50</span>;
      <span class="hljs-attribute">position</span>: absolute;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"animateButton"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 300px;"</span>&gt;</span>Animate<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>);
    <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'animateButton'</span>);

    button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// First: 记录初始状态</span>
      <span class="hljs-keyword">const</span> first = box.<span class="hljs-title function_">getBoundingClientRect</span>();

      <span class="hljs-comment">// 修改元素的位置</span>
      box.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">300</span>}</span>px`</span>;
      box.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">300</span>}</span>px`</span>;

      <span class="hljs-comment">// Last: 记录最终状态</span>
      <span class="hljs-keyword">const</span> last = box.<span class="hljs-title function_">getBoundingClientRect</span>();

      <span class="hljs-comment">// Invert: 计算初始状态和最终状态之间的变换</span>
      <span class="hljs-keyword">const</span> deltaX = first.<span class="hljs-property">left</span> - last.<span class="hljs-property">left</span>;
      <span class="hljs-keyword">const</span> deltaY = first.<span class="hljs-property">top</span> - last.<span class="hljs-property">top</span>;
      <span class="hljs-keyword">const</span> deltaW = first.<span class="hljs-property">width</span> / last.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> deltaH = first.<span class="hljs-property">height</span> / last.<span class="hljs-property">height</span>;


      <span class="hljs-comment">// 应用 FLIP 动画</span>
      box.<span class="hljs-title function_">animate</span>(
        [
          {
            <span class="hljs-attr">transformOrigin</span>: <span class="hljs-string">"top left"</span>,
            <span class="hljs-attr">transform</span>: <span class="hljs-string">`
            translate(<span class="hljs-subst">${deltaX}</span>px, <span class="hljs-subst">${deltaY}</span>px)
            scale(<span class="hljs-subst">${deltaW}</span>, <span class="hljs-subst">${deltaH}</span>)`</span>,
          },
          {
            <span class="hljs-attr">transformOrigin</span>: <span class="hljs-string">"top left"</span>,
            <span class="hljs-attr">transform</span>: <span class="hljs-string">"none"</span>,
          },
        ],
        {
          <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
          <span class="hljs-attr">easing</span>: <span class="hljs-string">"ease-in-out"</span>,
          <span class="hljs-attr">fill</span>: <span class="hljs-string">"both"</span>,
        }
      );
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>