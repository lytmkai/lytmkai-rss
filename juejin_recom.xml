<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[CSS 为 Markdown 添加标题]]></title>    <link>https://juejin.cn/post/7597623654056624143</link>    <guid>https://juejin.cn/post/7597623654056624143</guid>    <pubDate>2026-01-21T14:12:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056624143" data-draft-id="7597650624637239296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 为 Markdown 添加标题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T14:12:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橙子不要熬夜"/> <meta itemprop="url" content="https://juejin.cn/user/1493582536535881"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 为 Markdown 添加标题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1493582536535881/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橙子不要熬夜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:12:51.000Z" title="Wed Jan 21 2026 14:12:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="ascetic">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-link,.hljs-section,.hljs-string,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#888}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#ccc}.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style><h3 data-id="heading-0">背景</h3>
<p>大模型分步骤生成多段报告，最后合成一个富文本，后面的文本不知道前一段文本是什么标号，所以无法给出标题号，但是站在用户视角，不展示标题号又不直观，所以在渲染的时候要加标题号。</p>
<p>刚开始以为要用 react-markdown 库，识别文本内容是不是h1～h6标题，然后去手动添加标题号，后来发现展示的时候，可以通过 CSS 样式添加标题号，这样原始内容就不需要写死标题号，而是根据内容自动调整标题号。</p>
<h3 data-id="heading-1">核心代码</h3>
<ul>
<li>counter-reset：初始化计数器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FProperties%2Fcounter-reset" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/counter-reset" ref="nofollow noopener noreferrer">MDN-counter-reset</a></li>
<li>counter-increment：递增计数器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FProperties%2Fcounter-increment" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/counter-increment" ref="nofollow noopener noreferrer">MDN-counter-increment</a></li>
<li>counter()：显示值 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FValues%2Fcounter" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Values/counter" ref="nofollow noopener noreferrer">MDN-counter()</a></li>
</ul>
<h3 data-id="heading-2">富文本案例</h3>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactMarkdown</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-markdown"</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./index.module.less"</span>;

<span class="hljs-keyword">const</span> markdownContent = <span class="hljs-string">`# 引言
## 背景
### 历史回顾
#### 早期研究
##### 关键人物
###### 爱因斯坦的贡献
###### 牛顿的经典理论
##### 现代发展
#### 当前挑战
### 研究意义
## 目标
### 具体目标
#### 子目标 A
##### 细节 A1
###### 最终层级示例

# 方法
## 实验设计
#### 实验设计四级标题
### 数据采集
#### 传感器配置
##### 采样频率
###### 100Hz 设置

# 引言
## 背景
### 补充说明
#### 额外信息
##### 子项
###### 六级示例`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CounterResetCom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.markdownContent}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ReactMarkdown</span>&gt;</span>{markdownContent}<span class="hljs-tag">&lt;/<span class="hljs-name">ReactMarkdown</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CounterResetCom</span>;
</code></pre>
<p>使用 counter-reset：重置计数器</p>
<p>counter-increment：累加</p>
<p>counter()：取值</p>
<pre><code class="hljs language-LESS" lang="LESS"><span class="hljs-selector-class">.markdownContent</span> {
  <span class="hljs-attribute">counter-reset</span>: h1-counter;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">counter-reset</span>: h2-counter h3-counter h4-counter h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h1</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h1-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'. '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h2</span> {
  <span class="hljs-attribute">counter-reset</span>: h3-counter h4-counter h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h2</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h2-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">counter-reset</span>: h4-counter h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h3</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h3-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h4</span> {
  <span class="hljs-attribute">counter-reset</span>: h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h4</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h4-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h4-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h5</span> {
  <span class="hljs-attribute">counter-reset</span>: h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h5</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h5-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h4-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h5-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h6</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h6-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h4-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h5-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h6-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f8889665344781838c0c065ad6bada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5a2Q5LiN6KaB54as5aSc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609571&amp;x-signature=YHAN4SVcQgJTewc9Ktq6HTu4880%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">标签案例</h3>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactMarkdown</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-markdown"</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./index.module.less"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CounterResetCom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.markdownContent}</span>&gt;</span>
      {/* 第一章 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>引言<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>背景<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>历史回顾<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>早期研究<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>关键人物<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>爱因斯坦的贡献<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>牛顿的经典理论<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>现代发展<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>当前挑战<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>研究意义<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>目标<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>具体目标<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>子目标 A<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>细节 A1<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>最终层级示例<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>

      {/* 第二章 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>方法<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>实验设计<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>实验设计四级标题<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>数据采集<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>传感器配置<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>采样频率<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>100Hz 设置<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>

      {/* 第三章（再次使用“引言”，但编号继续递增） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>引言<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>背景<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>补充说明<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>额外信息<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>子项<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>六级示例<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CounterResetCom</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56372680cb8a46a2bc8e9d6effba9d84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5a2Q5LiN6KaB54as5aSc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609571&amp;x-signature=Vm%2BAl7RIeU30Tk5FEI%2FJkdjspow%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">踩过的坑</h3>
<ul>
<li>把所有标题都重置了，出现了现实不正常的情况</li>
</ul>
<pre><code class="hljs language-LESS" lang="LESS"><span class="hljs-selector-class">.markdownContent</span> {
  <span class="hljs-attribute">counter-reset</span>: h1-counter h2-counter h3-counter h4-counter h5-counter
    h6-counter;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17cf9d4927e94377a53ebcabaf1f3c92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5a2Q5LiN6KaB54as5aSc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609571&amp;x-signature=zWRF%2FETQEGmWGCM9al9h2r8O8mc%3D" alt="" loading="lazy"/>CSS 为 Markdown 添加标题</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-appD2（uni-forms学习与回顾）]]></title>    <link>https://juejin.cn/post/7597653098563977270</link>    <guid>https://juejin.cn/post/7597653098563977270</guid>    <pubDate>2026-01-21T14:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597653098563977270" data-draft-id="7597397134621540393" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-appD2（uni-forms学习与回顾）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-21T14:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱泡脚的鸡腿"/> <meta itemprop="url" content="https://juejin.cn/user/4466663535419179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-appD2（uni-forms学习与回顾）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466663535419179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱泡脚的鸡腿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:14:48.000Z" title="Wed Jan 21 2026 14:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.使用uni中的uni-forms组件</h2>
<p><strong>其中使用v-model获取数据</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入ref或者reactive</span>
<span class="hljs-comment">// ref和reactive的区别:reactive不能重新赋值</span>
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-comment">// 定义表单中的数据</span>

*<span class="hljs-number">3.</span>使用reactive保存数据*
<span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">account</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>

**1.使用uni-foms表单**
**4.绑定formData**
    <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-form"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"form"</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"formData"</span>&gt;</span>
    
**  2.使用uni-forms-item**
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.account"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入账号"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"submit-button"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-keyword">@import</span> <span class="hljs-string">'./styles.scss'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<h2 data-id="heading-1">2.表单验证</h2>
<h3 data-id="heading-2">2.1 表单字段</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d9ad9e223614def99a09e97790a3de8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=qXpCzivxcRR3dlt2dyrKyLK86tU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 定义校验规则</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 定义验证规则</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">accountRlues</span> = <span class="hljs-title function_ invoke__">reactive</span>({
    <span class="hljs-attr">account</span>: [
        // 可定义多个验证规则
        // requierd表示这个数据项必填
        { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'请输入登录账号'</span> },
        // 使用正则进行字母数字下划线的处理
        { <span class="hljs-attr">pattern</span>: <span class="hljs-string">'^[a-zA-Z0-9]{6,8}$'</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'登录账号格式不正确'</span> }
    ]
});
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611b7c2c329c42649588812eb8be9804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=m1Ze1GllJQEDBAQK4iTCzy9LGRI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 触发验证</h3>
<p><strong>定义一个accountForm=ref=&gt;     uni-forms组件绑定accountForm,实现将uni-forms这个组件的实例发放入accountForm中，便于后续使用validate（）=&gt;  给登录按钮绑定一个onsubmitForm函数，onsubmitForm中写validate（）=&gt;   点击onsubmitForm，触发校验</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入ref或者reactive</span>
<span class="hljs-comment">// ref和reactive的区别:reactive不能重新赋值</span>
<span class="hljs-keyword">import</span> { reactive, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 1. 定义获取表单元素的变量</span>
<span class="hljs-comment">// 模板里 &lt;uni-forms ref="accountForm"&gt; 会在组件挂载后把真实的 &lt;uni-forms&gt; </span>
<span class="hljs-comment">// 实例塞进 accountForm.value。</span>
<span class="hljs-comment">// → 目的：待会儿好调用它暴露的 validate() 方法。</span>
<span class="hljs-keyword">const</span> accountForm = <span class="hljs-title function_">ref</span>();

<span class="hljs-comment">// 定义表单中的数据</span>
<span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">account</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
});

<span class="hljs-comment">// 定义验证规则</span>
<span class="hljs-keyword">const</span> accountRlues = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">account</span>: {
        <span class="hljs-attr">rules</span>: [
            <span class="hljs-comment">// 可定义多个验证规则</span>
            <span class="hljs-comment">// requierd表示这个数据项必填</span>
            { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'请输入登录账号'</span> },
            <span class="hljs-comment">// 使用正则进行字母数字下划线的处理</span>
            { <span class="hljs-attr">pattern</span>: <span class="hljs-string">'^[a-zA-Z0-9]{6,8}$'</span>, <span class="hljs-attr">errorMessage</span>: <span class="hljs-string">'登录账号格式不正确'</span> }
        ]
    },

    <span class="hljs-attr">password</span>: {
        <span class="hljs-attr">rules</span>: [
            <span class="hljs-comment">// 可定义多个验证规则</span>
            <span class="hljs-comment">// requierd表示这个数据项必填</span>
            { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'请输入登录密码'</span> },
            <span class="hljs-comment">// 使用正则进行字母数字下划线的处理</span>
            { <span class="hljs-attr">pattern</span>: <span class="hljs-string">'^[a-zA-Z0-9]{6,8}$'</span>, <span class="hljs-attr">errorMessage</span>: <span class="hljs-string">'登录密码格式不正确'</span> }
        ]
    }
});



<span class="hljs-comment">// 4.提交表单数据</span>

<span class="hljs-comment">// 点击登录按钮 → 执行 onSubmitForm()。</span>
<span class="hljs-comment">// accountForm.value 就是第 1 步拿到的 &lt;uni-forms&gt; 实例；调用它暴露的 validate() 方法。</span>
<span class="hljs-comment">// validate() 内部会：</span>
<span class="hljs-comment">// 遍历所有 &lt;uni-forms-item&gt;；</span>
<span class="hljs-comment">// 根据 name 找到对应 rules；</span>
<span class="hljs-comment">// 用 async-validator 按顺序跑规则（required → pattern …）；</span>
<span class="hljs-comment">// 任一规则失败：</span>
<span class="hljs-comment">// 把 erroMessage 显示在对应项底部（默认红字）；</span>
<span class="hljs-comment">// 返回 false 并中断后续规则；</span>
<span class="hljs-comment">// 全部通过：继续走提交逻辑（这里你没写后续，通常发请求）。</span>

<span class="hljs-comment">//当验证成功后所返回的数据位表单中的数据，这些数据用于表单提交</span>
aysnc <span class="hljs-keyword">function</span> <span class="hljs-title function_">onSubmitForm</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 对表单数据进行验证(validate是uni-form提供的方法名)</span>
   <span class="hljs-keyword">const</span> formData= <span class="hljs-keyword">await</span> accountForm.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>();
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formData)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 2.将accountForm绑定至表单 --&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;uni-forms-item&gt; 的 name 必须和 rules 里的 key 保持一致（account/password）。 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-form"</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">"accountRlues"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"accountForm"</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"formData"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"account"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.account"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入账号"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 3.监听按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onSubmitForm"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"submit-button"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-keyword">@import</span> <span class="hljs-string">'./styles.scss'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<h3 data-id="heading-5">2.4 调用登录的接口</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.apifox.cn%2F4b036830-59b1-4526-b00a-61df2b3d4ae1%2Fapi-71329158" target="_blank" title="https://s.apifox.cn/4b036830-59b1-4526-b00a-61df2b3d4ae1/api-71329158" ref="nofollow noopener noreferrer">车辆信息 - 神领物流司机端-前端研究院</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2df722cffd98458a83539cc0e70496d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=AGxSILb9aE7VNuBvGIWrty5otzk%3D" alt="image.png" loading="lazy"/>
<strong>封装接口</strong></p>
<h4 data-id="heading-6">2.4.1 在apis/user.js中封装接口</h4>
<pre><code class="hljs language-apis/user.js" lang="apis/user.js">// 引入uni-fetch 进行请求的发起
import { UniFetch } from "uni-app-fetch";

// 导出函数方法一
// export const xxx=()=&gt;{
  
// }

// // 导出方法二：也可以以对象的格式
// export default{
//   xxx:()=&gt;{
    
//   }
// }

// 1.定义调用方法
export default{
  // @param {Object} data -登录所需要的用户密码
  login(data){
    if(!data.account || data.password) return
    用我事先封装好的 `uni-fetch` 拦截器实例，向 **基础地址 + /driver/login/account** 发一个 **GET** 请求，并把 `data` 里的字段自动拼到 URL 查询串上，同时带上统一设置的请求/响应拦截逻辑。”
    UniFetch.get('/driver/login/account',data)
  }

}
</code></pre>
<h4 data-id="heading-7">2.4.2 调用封装好的接口</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b93b77018409447396e1263dfb1b64e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=yUJHgl%2Bvhr0c5FqGWlYhLcZaOsw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">2.4.3 使用user.js（pinia技术）储存用户相关的数据</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-comment">// 使用ref定义一个响应式数据</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 三个参数,一个为counter,一个为箭头函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore
<span class="hljs-title class_">Store</span> = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>,
    <span class="hljs-comment">// 第二个参数:函数</span>
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 定义一个数据 token:用来记录用户登录状态</span>
      <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)

      <span class="hljs-comment">// 定义的数据必须return</span>
      <span class="hljs-keyword">return</span> { token } {
        <span class="hljs-comment">// 导出</span>
        <span class="hljs-attr">persist</span>: {
          <span class="hljs-attr">paths</span>: [<span class="hljs-string">'token'</span>]
        }
      })

</code></pre>
<p><strong>引入userUseStore并调用方法</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1cb6da8586642f3b695bb7085bdeae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=3syHpEddIXV9%2FWIgUBU%2BsgOfiF4%3D" alt="image.png" loading="lazy"/>
<strong>直接修改（让data赋值存入到pinia中）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f17457fd0a4404c872d00a468ed7eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=8jfzrWuIt6xdP2r7EVfLuCDyBoE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的项目实战(三) - 轮播图（幻灯片）组件的优秀写法]]></title>    <link>https://juejin.cn/post/7597679732364476458</link>    <guid>https://juejin.cn/post/7597679732364476458</guid>    <pubDate>2026-01-21T14:23:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597679732364476458" data-draft-id="7597634458697564166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的项目实战(三) - 轮播图（幻灯片）组件的优秀写法"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-21T14:23:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ETA8"/> <meta itemprop="url" content="https://juejin.cn/user/608445545328347"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的项目实战(三) - 轮播图（幻灯片）组件的优秀写法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/608445545328347/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ETA8
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:23:51.000Z" title="Wed Jan 21 2026 14:23:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的前端开发中，轮播图（幻灯片）几乎是每个项目都会遇到的基础交互组件。无论是电商首页的商品推荐、新闻网站的头条展示，还是后台管理系统的引导页，轮播图都扮演着重要的角色。</p>
<p>今天，我们来深入探讨如何使用现代 React 技术栈构建一个<strong>高性能、可复用、体验良好</strong>的轮播图组件。我们将重点解析以下几个核心问题：</p>
<ul>
<li>如何合理使用 shadcn/ui 提供的 Carousel 组件？</li>
<li>为什么自动播放逻辑需要用 <code>useRef</code> 包装插件实例？</li>
<li>指示器（小圆点）是如何同步当前索引并保证性能的？</li>
</ul>
<p>通过这篇文章，你不仅能掌握这个组件的具体实现方式，还能理解背后的设计思想和常见陷阱，为今后自己封装通用组件打下坚实基础。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1cadf4b3cb470f90b2b27d95a4271a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRVRBOA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610230&amp;x-signature=aa3iSBsVPro4JYs6SUgFHXRXmOs%3D" alt="PixPin_2026-01-21_22-21-46.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、选择合适的底层轮播库：shadcn/ui 的 Carousel</h2>
<p>我们不从头造轮子，而是选择了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fui.shadcn.com%2F" target="_blank" title="https://ui.shadcn.com/" ref="nofollow noopener noreferrer">shadcn/ui</a> 提供的 <code>Carousel</code> 组件作为基础。它基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.embla-carousel.com%2F" target="_blank" title="https://www.embla-carousel.com/" ref="nofollow noopener noreferrer">Embla Carousel</a> 封装，提供了良好的 TypeScript 支持、无障碍访问能力和灵活的 API 设计。</p>
<h3 data-id="heading-1">为什么要用封装后的 Carousel？</h3>
<p>直接使用 Embla 原生库虽然功能强大，但配置复杂，需要手动处理 DOM 引用、事件绑定、响应式适配等问题。而 shadcn/ui 的封装让我们可以用更声明式的方式写代码：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Carousel</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CarouselContent</span>&gt;</span>
    {items.map((item) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">CarouselItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
        {/* 内容 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">CarouselItem</span>&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/<span class="hljs-name">CarouselContent</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Carousel</span>&gt;
</code></pre>
<p>这种结构清晰明了，符合 React 的编程习惯。更重要的是，它已经内置了触摸滑动、键盘导航、循环滚动等常用功能，开箱即用。</p>
<p>我们只需关注业务逻辑：比如图片渲染、标题叠加、指示器控制、自动播放行为等。</p>
<hr/>
<h2 data-id="heading-2">二、自动播放的核心：Autoplay 插件为何要用 <code>useRef</code> 存储？</h2>
<p>这是整个组件中最值得深思的一环 —— <strong>性能优化的关键在于避免不必要的重新创建</strong>。</p>
<p>我们来看这段关键代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> plugin = <span class="hljs-title function_">useRef</span>(
  autoPlay ? <span class="hljs-title class_">Autoplay</span>({ <span class="hljs-attr">delay</span>: autoPlayDelay, <span class="hljs-attr">stopOnInteraction</span>: <span class="hljs-literal">false</span> }) : <span class="hljs-literal">null</span>
);
</code></pre>
<p>这里并没有把 <code>Autoplay(...)</code> 直接放在 <code>plugins</code> 属性里，而是用 <code>useRef</code> 包了一层。这是为什么？</p>
<h3 data-id="heading-3">❌ 错误做法：每次渲染都创建新插件</h3>
<p>如果你这样写：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Carousel</span> plugins={[<span class="hljs-title class_">Autoplay</span>({ <span class="hljs-attr">delay</span>: <span class="hljs-number">3000</span> })]} /&gt;
</code></pre>
<p>那么每当组件重新渲染时（例如父组件状态变化），<code>Autoplay(...)</code> 都会返回一个新的函数引用。Embla 会认为这是一个“新的插件”，从而卸载旧的、挂载新的 —— 这会导致：</p>
<ul>
<li>自动播放被中断或重置；</li>
<li>定时器频繁创建销毁，造成内存浪费；</li>
<li>用户正在拖动时可能意外触发重启；</li>
<li>性能下降，尤其在频繁更新的上下文中。</li>
</ul>
<h3 data-id="heading-4">✅ 正确做法：持久化存储插件实例</h3>
<p>通过 <code>useRef</code>，我们可以确保在整个组件生命周期中，<code>plugin.current</code> 只被初始化一次：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> plugin = <span class="hljs-title function_">useRef</span>(<span class="hljs-title class_">Autoplay</span>({ ... }));
</code></pre>
<p><code>useRef</code> 返回的对象是<strong>持久化的</strong>，它的 <code>.current</code> 属性不会因为重渲染而改变，除非你主动赋值。</p>
<p>这样一来：</p>
<ul>
<li>插件只会创建一次；</li>
<li>定时器稳定运行；</li>
<li>不受其他 state 或 props 更新的影响；</li>
<li>即便 <code>autoPlayDelay</code> 改变，也不会导致插件重建（当然，如果你希望动态响应 delay 变化，则需额外处理）；</li>
</ul>
<blockquote>
<p>⚠️ 注意：当前实现中 <code>autoPlayDelay</code> 是初始化后不可变的。若要支持动态调整间隔时间，建议监听该 prop 变化并通过 <code>plugin.current?.reset()</code> 手动重置定时器。</p>
</blockquote>
<p>此外，我们还设置了 <code>stopOnInteraction: false</code>，这意味着用户滑动后自动播放仍会继续。这比某些默认停止的设计更友好，提升了用户体验。</p>
<hr/>
<h2 data-id="heading-5">三、鼠标悬停控制播放：暂停与恢复的细节</h2>
<p>为了让用户有更多控制权，我们在鼠标进入和离开时控制播放状态：</p>
<pre><code class="hljs language-tsx" lang="tsx">onMouseEnter={<span class="hljs-function">() =&gt;</span> plugin.<span class="hljs-property">current</span>?.<span class="hljs-title function_">stop</span>()}
onMouseLeave={<span class="hljs-function">() =&gt;</span> plugin.<span class="hljs-property">current</span>?.<span class="hljs-title function_">reset</span>()}
</code></pre>
<p>这是一个非常实用的交互设计：</p>
<ul>
<li>当用户将鼠标移入轮播区域，自动播放暂停，方便他们仔细查看当前内容；</li>
<li>移出后自动恢复，保持流畅性；</li>
</ul>
<p>注意这里调用的是 <code>stop()</code> 和 <code>reset()</code>：</p>
<ul>
<li><code>stop()</code>：暂停当前计时器；</li>
<li><code>reset()</code>：重启动画，并从头开始倒计时；</li>
</ul>
<p>如果只调用 <code>start()</code> 而不是 <code>reset()</code>，可能会出现“延迟过久才切换”的情况，影响节奏感。</p>
<p>这也再次说明了使用 <code>useRef</code> 保存插件实例的重要性 —— 我们可以在任意事件回调中安全地访问并操作这个长期存在的对象。</p>
<hr/>
<h2 data-id="heading-6">四、指示器（Indicator Dots）的设计与同步机制</h2>
<p>底部的小圆点是轮播图的重要视觉反馈元素。它们告诉用户当前处于第几张，以及总共有多少张。</p>
<p>我们的实现如下：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"absolute bottom-3 left-0 right-0 flex justify-center gap-2"</span>&gt;
  {slides.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">h-2</span> <span class="hljs-attr">w-2</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">transition-all</span> ${
        <span class="hljs-attr">selectedIndex</span> === <span class="hljs-string">i</span> ? '<span class="hljs-attr">bg-white</span> <span class="hljs-attr">w-6</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-white</span>/<span class="hljs-attr">30</span>'
      }`}
    /&gt;</span></span>
  ))}
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-7">关键点分析：</h3>
<h4 data-id="heading-8">1. 使用 <code>selectedIndex</code> 同步当前项</h4>
<p>我们通过 <code>useEffect</code> 监听 Carousel 实例的 <code>select</code> 事件来更新索引：</p>
<pre><code class="hljs language-ts" lang="ts">api.<span class="hljs-title function_">on</span>(<span class="hljs-string">'select'</span>, onSelect);
<span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> api.<span class="hljs-title function_">off</span>(<span class="hljs-string">'select'</span>, onSelect);
</code></pre>
<p>这是一种典型的“外部状态同步”模式。Embla 的 <code>selectedScrollSnap()</code> 方法返回当前激活的 slide 索引（从 0 开始），我们将它存入本地 state。</p>
<h4 data-id="heading-9">2. 动态样式控制宽度与透明度</h4>
<p>选中的 dot 宽度变为 <code>w-6</code>，形成“拉伸”动画效果，未选中的则是半透明小圆点。配合 <code>transition-all</code> 实现平滑过渡。</p>
<p>这样的设计既节省空间，又具有足够的视觉提示力。</p>
<h4 data-id="heading-10">3. 为什么 key 用 index？有没有风险？</h4>
<p>这里用了 <code>index</code> 作为 <code>key</code>，是因为 <code>slides</code> 数组本身是稳定的（不会动态增删项）。在这种前提下，用 index 是安全且高效的。</p>
<p>但如果未来支持动态添加/删除 slide，则应改用唯一 ID（如 <code>slide.id</code>）作为 key，防止 React 错误复用 DOM 元素。</p>
<hr/>
<h2 data-id="heading-11">五、图片与标题的语义化呈现</h2>
<p>除了轮播逻辑，内容展示也不能忽视。</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;img src={image} alt={title || <span class="hljs-string">`slide <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>`</span>} /&gt;
</code></pre>
<ul>
<li><code>alt</code> 文本优先使用 <code>title</code>，无标题时 fallback 到序号描述，保障可访问性（a11y）；</li>
<li>图片使用 <code>object-cover</code> 确保填满容器的同时不 distortion；</li>
<li>标题覆盖在图片下方，使用渐变遮罩提升文字可读性：</li>
</ul>
<pre><code class="hljs language-css" lang="css">bg-gradient-<span class="hljs-selector-tag">to</span>-t <span class="hljs-selector-tag">from</span>-black/<span class="hljs-number">60</span> <span class="hljs-selector-tag">to</span>-transparent
</code></pre>
<p>这个渐变从底部纯黑半透明向上渐隐，既能压暗背景突出文字，又不影响上半部分图像的可视性，是一种常见的卡片式布局技巧。</p>
<hr/>
<h2 data-id="heading-12">六、整体架构总结与可扩展建议</h2>



































<table><thead><tr><th>特性</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>轮播核心</td><td>shadcn/ui Carousel + Embla</td><td>功能完整、支持触控</td><td>引入额外依赖</td></tr><tr><td>自动播放</td><td>Autoplay 插件 + useRef 持久化</td><td>避免重复创建、性能好</td><td>delay 不支持热更新</td></tr><tr><td>指示器</td><td>监听 select 事件 + 条件样式</td><td>视觉反馈清晰</td><td>圆点数量多时不适用</td></tr><tr><td>暂停控制</td><td>onMouseEnter/Leave</td><td>提升可用性</td><td>PC 端有效，移动端无效</td></tr></tbody></table>
<h3 data-id="heading-13">可扩展方向：</h3>
<ol>
<li><strong>支持垂直轮播</strong>：可通过 <code>opts={{ axis: 'y' }}</code> 实现。</li>
<li><strong>添加左右箭头按钮</strong>：利用 <code>api.prev()</code> 和 <code>api.next()</code> 控制翻页。</li>
<li><strong>适配移动端手势反馈</strong>：增加滑动提示动画或震动反馈。</li>
<li><strong>懒加载图片</strong>：对非当前页图片使用 <code>loading="lazy"</code> 或 Intersection Observer。</li>
<li><strong>自定义 transition 动画</strong>：结合 Framer Motion 实现更丰富的切换效果。</li>
</ol>
<hr/>
<h2 data-id="heading-14">结语：做一个“聪明”的组件开发者</h2>
<p>一个好的组件，不只是“能跑起来”，更要考虑：</p>
<ul>
<li><strong>性能是否可持续？</strong></li>
<li><strong>交互是否自然？</strong></li>
<li><strong>代码是否易于维护和扩展？</strong></li>
</ul>
<p>在这个 <code>SlideShow</code> 组件中，我们看到：</p>
<ul>
<li><code>useRef</code> 不只是用来拿 DOM 引用，更是管理外部实例、避免副作用重建的利器；</li>
<li>shadcn/ui 的组件封装降低了复杂度，但也要求我们理解其底层机制；</li>
<li>看似简单的指示器背后，也有状态同步、事件监听、样式过渡的精细设计。</li>
</ul>
<p>前端开发的魅力就在于此：每一个看似微不足道的细节，背后都有值得推敲的技术决策。</p>
<p>希望这篇文章能帮你建立起对轮播图组件的系统认知，在未来的项目中写出更加稳健、优雅的 UI 组件。</p>
<hr/>
<p>如果你觉得有收获，不妨点赞收藏，也欢迎留言交流你在项目中遇到的轮播图难题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每天一例：公司里一个被忽视但能改进的流程【紧急需求】]]></title>    <link>https://juejin.cn/post/7597650624637992960</link>    <guid>https://juejin.cn/post/7597650624637992960</guid>    <pubDate>2026-01-22T01:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624637992960" data-draft-id="7597695487302664207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每天一例：公司里一个被忽视但能改进的流程【紧急需求】"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-22T01:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每天一例：公司里一个被忽视但能改进的流程【紧急需求】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T01:57:04.000Z" title="Thu Jan 22 2026 01:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每天一例｜紧急需求总是插队，但我们从没认真复盘过它们</p>
<p>那个需求是在版本封板前被塞进来的。排期已经确认，测试在做回归，开发手里剩下的都是收尾工作，但这个需求被标记为“必须马上处理”，理由很简单.....不做会影响当前客户使用。没有人再讨论优先级，也没有人问清楚背景，排期被直接打乱，原本计划中的工作全部让路，几个人被临时拉出来加班推进。那几天大家都很清楚，这不是第一次，也不会是最后一次。</p>
<p>需求最终还是赶在版本里上线了。功能能用，问题解决，客户没有再反馈。从结果看，这是一次成功的紧急响应，但团队付出的代价并不小：连续加班、原本的计划被推迟、测试时间被压缩。版本发完之后，所有人都松了一口气，然后很自然地进入了下一个迭代，好像这件事从来就该这样发生。</p>
<p>真正的问题在于，事情到这里就结束了。
没有复盘，没有追问为什么会紧急，也没有讨论是否存在更早发现的机会。紧急需求被当成一种不可讨论的事件，只要解决了，就默认流程已经完成。它像一场突发事故，被处理掉之后，大家只想尽快回到原来的节奏，而不是回头看路是怎么断的。</p>
<p>久而久之，这种默认值开始反噬团队。紧急需求越来越多，正常排期不断被打断，“先插一下”“这个更急”成了常态。团队对“紧急”的敏感度逐渐下降，从最初的高度紧张，变成疲惫应付，再到后来的一种麻木接受。当一切都紧急，其实就没有真正的紧急了，只剩下被持续打断的节奏。</p>
<p>后来我们做的改动非常小，但很关键：每一个紧急需求上线后，必须补一次极简复盘。不写长文档，不开大会，只回答三个问题，为什么会紧急、哪个节点可以提前发现、是否需要调整流程。控制在十几分钟内，只讲事实，不讨论责任。这一步不是为了追究谁的问题，而是把“紧急”重新拉回到可以被理解、被分析的范围里。</p>
<p>慢慢地，紧急需求真的开始变少了。不是因为问题消失了，而是因为团队开始更早地看见问题。复盘不是为了证明谁做错了，而是为了防止同样的紧急一再发生。当“紧急”被认真复盘过，它才不会成为一种默认状态；当紧急不再被复盘，它就一定会变成常态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Playwright学习笔记 02】CSS-selector定位]]></title>    <link>https://juejin.cn/post/7597664587458887715</link>    <guid>https://juejin.cn/post/7597664587458887715</guid>    <pubDate>2026-01-21T14:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597664587458887715" data-draft-id="7597664587458854947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Playwright学习笔记 02】CSS-selector定位"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T14:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鄭郑"/> <meta itemprop="url" content="https://juejin.cn/user/590879236308844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Playwright学习笔记 02】CSS-selector定位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590879236308844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鄭郑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:46:33.000Z" title="Wed Jan 21 2026 14:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">定位后的操作方法：</h3>
<ul>
<li>点击元素， <strong><code>click()</code></strong> 方法</li>
<li>元素内输入文本， <strong><code>fill()</code></strong> 方法</li>
<li>获取元素内部文本， <strong><code>inner_text()</code></strong> 方法</li>
</ul>
<h2 data-id="heading-1">常用方法：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/927ef48c5c66486a816e7ddcd2a7aaa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=WspA1R93NaL%2BqBCOEJB1J5OZsUM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>图中<strong>粉色字体</strong>都是可以用来定位的标志</p>
<p>定位标签常用id属性中的元素，一般html语言id的内容都是唯一的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f94a91bb7700454c818c139899d97859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=TgIUPHfWEkJzYeoc%2Fg5zoeDsrzg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>图中id属性中的内容被空格隔开的意思是，这个标签有两个属性分别是suggestion、stock</p>
<h2 data-id="heading-2">CSS selector</h2>
<p>原理：css本身就是浏览器用用来赋予内容样式的，赋予不同的颜色。</p>
<h3 data-id="heading-3">Locator 对象</h3>
<p>Page 对象的 locator方法就会创建一个 <code>Locator</code> 类型对象，参数就可以是 CSS Selector 表达式</p>
<pre><code class="hljs language-scss" lang="scss">`page<span class="hljs-selector-class">.locator</span>('#kw')<span class="hljs-selector-class">.fill</span>('通讯')
page<span class="hljs-selector-class">.locator</span>('#go')<span class="hljs-selector-class">.click</span>()`
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Page对象的 locator 定位到的如果是 <strong>''唯一''</strong> 的 html元素，就可以调用 Locator 对象的 方法，比如 <code>fill</code> , <code>click</code> , <code>inner_text</code> 等等对元素进行操作了。</p>
<h3 data-id="heading-4">根据 tag名、id、class 选择元素</h3>
<h4 data-id="heading-5">tag名</h4>
<p>直接写上tag名即可</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">locators</span> = page.locator(<span class="hljs-string">'div'</span>).all()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>然后可以通过for循环打印所有内容：</p>
<pre><code class="hljs language-css" lang="css">for one in locators:
    <span class="hljs-built_in">print</span>(one.<span class="hljs-built_in">inner_text</span>())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>要获取 所有的tag名为div的元素的内部可见文本，也可以直接调用 <code>all_inner_texts</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">texts</span> = page.locator(<span class="hljs-string">'div'</span>).all_inner_texts()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>注意，如果 locator调用 <strong><code>匹配的结果是多个元素</code></strong> ， 调用 <strong><code>针对单个元素的方法</code></strong> ，比如 <code>inner_text</code> ，会有错误抛出</p>
<h4 data-id="heading-6">根据id属性</h4>
<p>选择元素的语法是在id号前面加上一个井号： <strong><code>#id值</code></strong></p>
<p>比如 ，有下面这样的元素：</p>
<pre><code class="hljs language-python" lang="python">&lt;<span class="hljs-built_in">input</span>  <span class="hljs-built_in">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">'searchtext'</span> /&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>就可以使用 <code>#searchtext</code> 这样的 CSS Selector 来选择它。</p>
<p>比如，我们想在 <code>id 为 searchtext</code> 的输入框中输入文本 <code>你好</code> ，完整的Python代码如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lct</span> = page.locator(<span class="hljs-string">'#searchtext'</span>)
lct.fill('你好')
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>根据class属性</strong></p>
<p>选择元素的语法是在 class 值 前面加上一个点： <strong><code>.class值</code></strong></p>
<p>要选择 class 属性值为 animal的元素 动物，可以这样写</p>
<pre><code class="hljs language-arduino" lang="arduino">page.<span class="hljs-built_in">locator</span>(<span class="hljs-string">'.animal'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ad05fa904e49b185f86e9c0dcbede8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=CKUwSyYcTdLiQrg30ZIa6YW1VGI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-7">验证 CSS Selector语法是否正确</h2>
<p>由于 CSS Selector 是浏览器直接支持的，可以在浏览器 <strong>开发者工具栏</strong> 中验证。</p>
<p>比如我们使用Chrome浏览器打开一个网址</p>
<p>按F12 打开 开发者工具栏， 点击 Elements 标签后， 同时按 Ctrl 键 和 F 键， 就会出现下图箭头处的 搜索框</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b862376f3441be8b0b867a380b2edd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=Y6WMlTxhqXOpK4TkyIHEKwkw32I%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>匹配多个元素</strong></h2>
<p>前面已经说， 如果一个 locator表达式匹配多个元素，要获取所有的元素对应的 locator 对象，使用 <strong><code>all方法</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">locators</span> = page.locator(<span class="hljs-string">'.plant'</span>).all()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>有时，我们只需要得到某种表达式对应的元素数量 ，可以使用 <strong><code>count方法</code></strong>，如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">count</span> = page.locator(<span class="hljs-string">'.plant'</span>).count()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>返回结果就是匹配的元素数量。 可以根据返回结果是否为0 判断元素是否存在</p>
<p>有时，我们只需要得到某种表达式对应的<strong>第一个，或者最后一个元素。</strong></p>
<p>可以使用 <strong><code>first</code></strong> 和 <strong><code>last</code></strong> 属性 ， 如下</p>
<pre><code class="hljs language-scss" lang="scss">lct = page<span class="hljs-selector-class">.locator</span>('.plant')
<span class="hljs-built_in">print</span>(lct.first.inner_text(), lct<span class="hljs-selector-class">.last</span><span class="hljs-selector-class">.inner_text</span>())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>也可以，通过 <strong><code>nth</code></strong> 方法，获取指定次序的元素，参数0表达第一个， 1 表示第2个，比如:</p>
<pre><code class="hljs language-scss" lang="scss">lct = page<span class="hljs-selector-class">.locator</span>('.plant')
<span class="hljs-built_in">print</span>(lct.nth(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.inner_text</span>())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-9">元素内部定位</h2>
<p>前面都是通过 <strong><code>Page</code></strong> 对象调用的 locator 方法， 定位的范围是整个网页。</p>
<p>如果我们想在某个元素内部定位，可以通过 <strong><code>Locator</code></strong> 对象 调用 <strong>locator</strong> 方法。比如:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lct</span> = page.locator(<span class="hljs-string">'#bottom'</span>)

<span class="hljs-comment"># 在 #bottom 对应元素的范围内 寻找标签名为 span 的元素。</span>
<span class="hljs-attr">eles</span> = lct.locator(<span class="hljs-string">'span'</span>).all()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 样式革命：NativeWind (Tailwind CSS) 实战]]></title>    <link>https://juejin.cn/post/7597650322408276020</link>    <guid>https://juejin.cn/post/7597650322408276020</guid>    <pubDate>2026-01-21T14:47:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408276020" data-draft-id="7597650624637386752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 样式革命：NativeWind (Tailwind CSS) 实战"/> <meta itemprop="keywords" content="React Native,前端"/> <meta itemprop="datePublished" content="2026-01-21T14:47:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小冰球"/> <meta itemprop="url" content="https://juejin.cn/user/2014722836669176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 样式革命：NativeWind (Tailwind CSS) 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2014722836669176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小冰球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:47:13.000Z" title="Wed Jan 21 2026 14:47:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前端开发的漫长历史中，样式的管理一直是个热门话题。从最原始的 CSS，到统治 Web 开发多年的 Sass/Less 预处理器，再到如今风靡全球的 Utility-First 理念。而在 React Native (RN) 的世界里，样式的写法也经历了从 <code>StyleSheet.create</code> 到各种 CSS-in-JS 库的演变。</p>
<p>本文将结合一个实际的 React Native 项目案例，探讨 CSS 预处理器的优劣，Tailwind CSS 的核心价值，以及如何通过 NativeWind 在 RN 项目中优雅地落地这一现代样式方案。</p>
<h3 data-id="heading-1">一、 前端样式的进化论：为什么我们需要改变？</h3>
<h4 data-id="heading-2">1.1 传统的痛点</h4>
<p>CSS 作为浏览器唯一能看懂的样式语言，早期存在明显的编程缺陷：缺乏变量、不支持嵌套、没有逻辑复用。为了解决这些问题，<strong>CSS 预处理器</strong>应运而生。</p>
<h4 data-id="heading-3">1.2 Sass vs Less：工具型语言的辉煌</h4>
<p>我们在项目中经常听到 Sass 和 Less，它们本质上是“为了写出更好的 CSS 而发明的工具”。</p>

























<table><thead><tr><th align="left">特性</th><th align="left">Sass (SCSS)</th><th align="left">Less</th></tr></thead><tbody><tr><td align="left"><strong>变量符</strong></td><td align="left"><code>$</code> (如 <code>$color</code>)</td><td align="left"><code>@</code> (如 <code>@color</code>)</td></tr><tr><td align="left"><strong>逻辑能力</strong></td><td align="left"><strong>强</strong> (支持复杂循环、条件判断)</td><td align="left"><strong>中</strong> (支持 Mixin、基础运算)</td></tr><tr><td align="left"><strong>运行环境</strong></td><td align="left">Dart / Ruby</td><td align="left">JavaScript (Node.js 友好)</td></tr></tbody></table>
<p>它们解决了“代码复用”和“结构清晰”的问题，但在 React Native 中，我们通常面临新的挑战：<strong>组件化与样式的隔离</strong>。虽然我们可以在 RN 中使用 Sass Transformer，但依然没有摆脱“给每个 View 起类名”的痛苦。</p>
<h3 data-id="heading-4">二、 Tailwind CSS：原子化思维的觉醒</h3>
<p>Tailwind CSS 的出现并不是为了发明一种新语言，而是提供了一套<strong>预设好的、原子级别的 CSS 类名</strong>。</p>
<h4 data-id="heading-5">2.1 什么是 Utility-First？</h4>
<ul>
<li><strong>传统写法</strong>：<code>class="card"</code> -&gt; 在 CSS 文件里写 <code>width</code>, <code>height</code>, <code>background</code>, <code>border-radius</code>。</li>
<li><strong>Tailwind 写法</strong>：<code>class="w-full h-20 bg-white rounded-lg"</code>。</li>
</ul>
<h4 data-id="heading-6">2.2 为什么要用它？</h4>
<ol>
<li><strong>极速开发</strong>：不用在 JSX 和 CSS 文件间来回跳转，不用绞尽脑汁想类名（比如 <code>wrapper-inner-box-left</code> 这种噩梦）。</li>
<li><strong>样式隔离</strong>：修改一个组件的 <code>p-4</code> (padding)，绝不会影响隔壁组件的样式。</li>
<li><strong>设计一致性</strong>：基于 Design Token 的限制（如只能用 <code>blue-500</code>, <code>blue-600</code>），避免了项目中出现几十种由于取色器误差导致的“不同的蓝色”。</li>
</ol>
<p>与 Bootstrap 这种“成品菜”不同，Tailwind 给的是“净菜”，让你自由烹饪，既快又灵活。</p>
<h3 data-id="heading-7">三、 实战：在 React Native 中落地 NativeWind</h3>
<p>在 RN 中，直接使用 Tailwind 需要很多 hack，而 <strong>NativeWind</strong> 是目前的最佳解决方案。它在编译时将 Tailwind 类名转换为 React Native 的原生样式对象 (<code>StyleSheet</code>)，兼顾了开发体验与运行时性能。</p>
<p>以下是我们项目 (<code>test_rn_css</code>) 的实战配置总结：</p>
<h4 data-id="heading-8">3.1 技术栈选择</h4>
<ul>
<li><strong>NativeWind</strong>: v4 (最新版，性能更强)</li>
<li><strong>Tailwind CSS</strong>: v3</li>
<li><strong>React Native Reanimated</strong>: 处理动画与样式转换</li>
</ul>
<h4 data-id="heading-9">3.2 关键配置详解</h4>
<p>在集成过程中，我们遇到了一些特定场景（如集成第三方 Chat UI Kit），因此配置显得尤为重要。</p>
<h5 data-id="heading-10">(1) <code>tailwind.config.js</code> 的特殊定制</h5>
<p>为了避免与引入的第三方 UI 库产生样式冲突，我们采用了<strong>前缀隔离</strong>策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// 扫描所有组件文件</span>
  <span class="hljs-attr">content</span>: [<span class="hljs-string">"./app/**/*.{js,jsx,ts,tsx}"</span>, <span class="hljs-string">"./components/**/*.{js,jsx,ts,tsx}"</span>],
  <span class="hljs-attr">presets</span>: [<span class="hljs-built_in">require</span>(<span class="hljs-string">"nativewind/preset"</span>)],

  <span class="hljs-comment">// ✨ 关键技巧：添加前缀</span>
  <span class="hljs-comment">// 所有的 utility class 必须加 'tw-'。</span>
  <span class="hljs-comment">// 例如：使用 'tw-bg-white' 而不是 'bg-white'。</span>
  <span class="hljs-comment">// 这样可以防止类名与 react-native-chat-uikit 等库内的样式名冲突。</span>
  <span class="hljs-attr">prefix</span>: <span class="hljs-string">"tw-"</span>,

  <span class="hljs-comment">// ✨ 暗黑模式手动控制</span>
  <span class="hljs-comment">// 避免跟随系统自动切换导致 UI 库背景色异常</span>
  <span class="hljs-attr">darkMode</span>: <span class="hljs-string">"class"</span>,

  <span class="hljs-attr">corePlugins</span>: {
    <span class="hljs-comment">// RN 不支持浏览器的样式重置，必须禁用</span>
    <span class="hljs-attr">preflight</span>: <span class="hljs-literal">false</span>,
  },
};
</code></pre>
<h5 data-id="heading-11">(2) 必要的 Metro 与 Babel 设置</h5>
<p>我们需要让打包工具认识 Tailwind。</p>
<ul>
<li><strong>babel.config.js</strong>: 添加 <code>nativewind/babel</code> 插件。</li>
<li><strong>metro.config.js</strong>: 使用 <code>withNativeWind</code> 包装默认配置，指定 CSS 入口。</li>
<li><strong>nativewind-env.d.ts</strong>: 引入类型定义，让 TypeScript 能够完美识别 <code>className</code> 属性。</li>
</ul>
<h4 data-id="heading-12">3.3 开发避坑指南</h4>
<p>集成后，开发体验获得了质的飞跃。但由于配置了 <code>prefix</code>，新手最容易犯的错误是忘记加前缀。</p>
<p><strong>❌ 错误写法：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">View</span> className=<span class="hljs-string">"bg-white p-4"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>样式不会生效<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">View</span>&gt;
</code></pre>
<p><strong>✅ 正确写法：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">View</span> className=<span class="hljs-string">"tw-bg-white tw-p-4"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tw-text-black tw-text-lg"</span>&gt;</span>样式完美应用，且不污染全局<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">View</span>&gt;
</code></pre>
<h3 data-id="heading-13">四、 总结</h3>
<p>NativeWind 充当了 Web 开发思维通向 Native 开发的桥梁。它让 React Native 开发者能够享受到 Utility-First 带来的极速编码体验。虽然在初期配置（如前缀处理、TypeScript 类型支持）上需要一点细心，但一旦搭建完成，它将极大地提升项目的 UI 开发效率和可维护性。</p>
<p>如果你还在为 React Native 的样式管理头疼，不妨试试 NativeWind，把“写样式”变成一种像搭积木一样简单的乐趣。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAsteriskZuo%2Ftest_rn_css" target="_blank" title="https://github.com/AsteriskZuo/test_rn_css" ref="nofollow noopener noreferrer">演示demo源码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟]]></title>    <link>https://juejin.cn/post/7597650624637452288</link>    <guid>https://juejin.cn/post/7597650624637452288</guid>    <pubDate>2026-01-21T15:22:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624637452288" data-draft-id="7597664587458904099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-21T15:22:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:22:33.000Z" title="Wed Jan 21 2026 15:22:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟</h2>
<p>在前后端分离的开发模式下，前端开发者常常面临 “等后端接口开发完成才能调试” 的困境。MockJS 的出现完美解决了这一问题，它能让前端自主伪造接口数据，提前完成页面开发与调试，上线时只需切换真实接口地址即可无缝对接。本文结合实战代码，详细讲解 MockJS 的使用场景、安装教程、核心用法（含分页模拟）及核心价值。</p>
<h3 data-id="heading-1">一、MockJS 的核心使用场景</h3>
<p>MockJS 是前端接口伪造工具，核心解决前端开发中 “接口依赖” 的痛点，典型使用场景包括：</p>
<ol>
<li><strong>前后端并行开发</strong>：后端未完成接口开发时，前端基于接口文档提前 Mock 接口，无需等待后端，大幅提升开发效率；</li>
<li><strong>接口文档先行</strong>：前后端先敲定接口文档（如<code>GET /api/posts?page=1&amp;limit=10</code>），前端基于文档 Mock 数据，确保接口格式 100% 匹配；</li>
<li><strong>多场景数据模拟</strong>：可灵活模拟分页、空数据、大数量级数据等场景，覆盖开发与测试全流程；</li>
<li><strong>无缝切换真实接口</strong>：开发阶段用 Mock 接口，上线前只需替换接口地址，无需修改业务代码。</li>
</ol>
<h3 data-id="heading-2">二、MockJS 环境搭建（基于 Vite）</h3>
<p>以 Vite 项目为例，完成 MockJS 的安装与基础配置：</p>
<h4 data-id="heading-3">1. 安装依赖</h4>
<p>需要安装<code>mockjs</code>（核心 Mock 库）和<code>vite-plugin-mock</code>（Vite 的 Mock 插件）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># npm安装 </span>
npm install mockjs vite-plugin-mock --save-dev 
<span class="hljs-meta"># yarn安装 </span>
yarn <span class="hljs-keyword">add</span> mockjs vite-plugin-mock -D
</code></pre>
<h4 data-id="heading-4">2. 配置 Vite</h4>
<p>在<code>vite.config.js</code>中配置 mock 插件，让 Vite 启动时加载 Mock 接口：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span> 
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span> 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({ 
    <span class="hljs-attr">plugins</span>: [ 
        <span class="hljs-comment">// 配置Mock插件 </span>
        <span class="hljs-title function_">viteMockServe</span>({ 
            <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'./mock'</span>, <span class="hljs-comment">// Mock文件存放目录（本文示例中为posts.js所在目录） </span>
            <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开发环境启用Mock </span>
            <span class="hljs-attr">prodEnabled</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 生产环境关闭Mock（上线时自动切换真实接口） </span>
            }) 
         ] 
     })
</code></pre>
<h3 data-id="heading-5">三、MockJS 核心用法（结合 posts 接口实战）</h3>
<p>以 “文章列表（posts）” 接口为例，讲解 MockJS 的基础语法、接口 Mock 及分页逻辑实现。</p>
<h4 data-id="heading-6">1. 基础：MockJS 随机数据语法</h4>
<p>MockJS 通过<code>@</code>符号提供丰富的随机数据生成能力，满足不同数据类型的伪造需求：</p>



































<table><thead><tr><th>语法</th><th>说明</th><th>示例（对应 posts.js）</th></tr></thead><tbody><tr><td><code>@ctitle(min,max)</code></td><td>生成随机中文标题</td><td><code>title:'@ctitle(8,20)'</code>（8-20 字标题）</td></tr><tr><td><code>@integer(min,max)</code></td><td>生成随机整数</td><td><code>totalLikes:'@integer(0,500)'</code>（0-500 点赞）</td></tr><tr><td><code>@cname</code></td><td>生成随机中文姓名</td><td><code>name:'@cname(2,3)'</code>（2-3 字姓名）</td></tr><tr><td><code>@image(w*h)</code></td><td>生成随机图片地址</td><td><code>avatar:'@image(300*200)'</code>（300x200 图片）</td></tr><tr><td><code>Random.pick(arr, n)</code></td><td>从数组中随机选 n 个元素</td><td><code>tags:() =&gt; Mock.Random.pick(tags,2)</code>（选 2 个标签）</td></tr></tbody></table>
<h4 data-id="heading-7">2. 实战：Mock 文章列表接口</h4>
<p>新建<code>mock/posts.js</code>文件，按接口文档实现<code>GET /api/posts</code>的 Mock 接口，核心步骤如下：</p>
<h5 data-id="heading-8">步骤 1：生成基础 Mock 数据</h5>
<p>首先用<code>Mock.mock</code>生成 45 条模拟文章数据，包含标题、简介、点赞数、用户信息、标签等字段：</p>
<pre><code class="hljs language-php" lang="php">import Mock <span class="hljs-keyword">from</span> <span class="hljs-string">"mockjs"</span> 
<span class="hljs-comment">// 定义标签池 </span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">tags</span> = [<span class="hljs-string">"前端"</span>,<span class="hljs-string">"后端"</span>,<span class="hljs-string">"职场"</span>,<span class="hljs-string">"AI"</span>,<span class="hljs-string">"副业"</span>,<span class="hljs-string">"面经"</span>,<span class="hljs-string">"算法"</span>]; 
<span class="hljs-comment">// 生成45条模拟文章数据 </span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">posts</span> = Mock.<span class="hljs-title function_ invoke__">mock</span>({ 
    <span class="hljs-string">'list|45'</span>:[ // 生成<span class="hljs-number">45</span>条数据（|<span class="hljs-number">45</span>表示数量） 
        { 
            <span class="hljs-attr">title</span>:<span class="hljs-string">'@ctitle(8,20)'</span>, // 随机中文标题（<span class="hljs-number">8</span>-<span class="hljs-number">20</span>字） 
            <span class="hljs-attr">brief</span>:<span class="hljs-string">'@ctitle(20,100)'</span>, // 简介 
            <span class="hljs-attr">totalComments</span>:<span class="hljs-string">'@integer(1,30)'</span>, // 评论数 
            <span class="hljs-attr">totalLikes</span>:<span class="hljs-string">'@integer(0,500)'</span>, // 点赞数 
            <span class="hljs-attr">publishedAt</span>:<span class="hljs-string">'datetime("yyyy-MM-dd HH:mm")'</span>, // 发布时间 
            <span class="hljs-attr">user</span>:{ // 用户信息 
                <span class="hljs-attr">id</span>:<span class="hljs-string">"@integer(1,100)"</span>, 
                <span class="hljs-attr">name</span>:<span class="hljs-string">'@cname(2,3)'</span>, 
                <span class="hljs-attr">avatar</span>:<span class="hljs-string">'@image(300*200)'</span> }, 
            <span class="hljs-attr">tags</span>:() =&gt; Mock.Random.<span class="hljs-title function_ invoke__">pick</span>(tags,<span class="hljs-number">2</span>), <span class="hljs-comment">// 随机2个标签 </span>
            thumbnail:<span class="hljs-string">'@image(300*200)'</span>, <span class="hljs-comment">// 缩略图 </span>
            pics:[<span class="hljs-string">'@image(300*200)'</span>,<span class="hljs-string">'@image(300*200)'</span>,<span class="hljs-string">'@image(300*200)'</span>], <span class="hljs-comment">// 图片组 </span>
            id:<span class="hljs-string">'@increment(1)'</span> <span class="hljs-comment">// 自增ID </span>
         } 
     ] 
}).<span class="hljs-keyword">list</span>;
</code></pre>
<h5 data-id="heading-9">步骤 2：定义 Mock 接口并实现分页</h5>
<p>接口文档要求<code>GET /api/posts?page=1&amp;limit=10</code>返回分页数据，需解析分页参数、切割数据并返回分页信息：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
    {
        url:<span class="hljs-string">'/api/posts'</span>, <span class="hljs-comment">// 匹配接口地址</span>
        method:<span class="hljs-string">'get'</span>, <span class="hljs-comment">// 匹配请求方法</span>
        response:({ query },res) =&gt; {
            <span class="hljs-comment">// 1. 解析分页参数（默认page=1，limit=10）</span>
            <span class="hljs-type">const</span> { page = <span class="hljs-string">'1'</span>,limit = <span class="hljs-string">'10'</span> } = query;
            <span class="hljs-type">const</span> currentPage = <span class="hljs-built_in">parseInt</span>(page,<span class="hljs-number">10</span>);
            <span class="hljs-type">const</span> size = <span class="hljs-built_in">parseInt</span>(limit,<span class="hljs-number">10</span>);

            <span class="hljs-comment">// 2. 校验参数合法性</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(currentPage) || <span class="hljs-built_in">isNaN</span>(size) || currentPage &lt; <span class="hljs-number">1</span> || size &lt; <span class="hljs-number">1</span>){
                <span class="hljs-keyword">return</span> {
                    code: <span class="hljs-number">400</span>,
                    msg:<span class="hljs-string">"Invalid page or pageSize"</span>,
                    data: null
                }
            }

            <span class="hljs-comment">// 3. 计算分页数据：总条数、起始/结束索引</span>
            <span class="hljs-type">const</span> total = posts.length; <span class="hljs-comment">// 数据总条数</span>
            <span class="hljs-type">const</span> start = (currentPage - <span class="hljs-number">1</span>) * size; <span class="hljs-comment">// 数据起始位置</span>
            <span class="hljs-type">const</span> end = start + size; <span class="hljs-comment">// 数据结束位置</span>
            <span class="hljs-type">const</span> pagenatedData = posts.<span class="hljs-built_in">slice</span>(start,end); <span class="hljs-comment">// 切割分页数据</span>

            <span class="hljs-comment">// 4. 返回分页结果</span>
            <span class="hljs-keyword">return</span> {
                code:<span class="hljs-number">200</span>,
                msg:<span class="hljs-string">'success'</span>,
                items:pagenatedData, <span class="hljs-comment">// 当前页数据列表</span>
                pagination:{ <span class="hljs-comment">// 分页信息</span>
                    current:currentPage, <span class="hljs-comment">// 当前页码</span>
                    limit:size, <span class="hljs-comment">// 每页条数</span>
                    total, <span class="hljs-comment">// 总条数</span>
                    totalPage:Math.<span class="hljs-built_in">ceil</span>(total/size) <span class="hljs-comment">// 总页数</span>
                }
            }
        }
    }
]
</code></pre>
<h4 data-id="heading-10">分页核心逻辑解析</h4>
<p>分页是列表接口的必备能力，Mock 中实现分页的核心步骤：</p>
<ol>
<li><strong>参数解析</strong>：从请求参数中获取<code>page</code>（当前页）和<code>limit</code>（每页条数），转为整数并校验合法性；</li>
<li><strong>数据切割</strong>：通过<code>(currentPage - 1) * size</code>计算起始索引，<code>start + size</code>计算结束索引，用<code>slice(start, end)</code>切割总数据得到当前页数据；</li>
<li><strong>分页信息返回</strong>：需返回<code>当前页、每页条数、总条数、总页数</code>，方便前端渲染分页组件。</li>
</ol>
<h3 data-id="heading-11">四、MockJS 的核心意义</h3>
<ol>
<li><strong>提升开发效率</strong>：前后端并行开发，前端无需依赖后端接口进度，独立完成页面开发与调试；</li>
<li><strong>降低联调成本</strong>：基于接口文档 Mock 数据，确保前端数据格式与后端完全一致，联调时只需切换接口地址即可无缝对接；</li>
<li><strong>灵活模拟场景</strong>：可自由调整 Mock 数据量（如本文 45 条）、分页参数，模拟 “第一页”“最后一页”“无数据” 等边界场景；</li>
<li><strong>解耦开发流程</strong>：前端专注页面逻辑，后端专注接口开发，符合前后端分离的核心思想。</li>
</ol>
<h3 data-id="heading-12">五、上线切换真实接口</h3>
<p>Mock 仅用于开发阶段，上线前只需：</p>
<ol>
<li>关闭 Vite 的 Mock 插件（<code>prodEnabled: false</code>）；</li>
<li>将 axios 的请求基础地址从 Mock 地址切换为后端真实接口地址；</li>
<li>无需修改业务代码，即可无缝对接真实后端数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[async/await和Promise有哪些区别]]></title>    <link>https://juejin.cn/post/7597623654056787983</link>    <guid>https://juejin.cn/post/7597623654056787983</guid>    <pubDate>2026-01-21T15:44:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056787983" data-draft-id="7597664587458920483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="async/await和Promise有哪些区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T15:44:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            async/await和Promise有哪些区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:44:38.000Z" title="Wed Jan 21 2026 15:44:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>async/await</code> 和 <code>Promise</code> 都是处理异步操作的方式，但它们在语法和使用上有重要区别：</p>
<h2 data-id="heading-0">1. <strong>本质关系</strong></h2>
<ul>
<li><strong>Promise</strong>：是异步编程的解决方案对象，代表一个异步操作的最终完成（或失败）及其结果值</li>
<li><strong>async/await</strong>：是基于 Promise 的语法糖，让异步代码看起来像同步代码</li>
</ul>
<h2 data-id="heading-1">2. <strong>语法对比</strong></h2>
<h3 data-id="heading-2">Promise 写法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
            <span class="hljs-keyword">return</span> data;
        })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
        });
}
</code></pre>
<h3 data-id="heading-3">async/await 写法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
        <span class="hljs-keyword">return</span> data;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
} 
</code></pre>
<h2 data-id="heading-4">3. <strong>主要区别</strong></h2>



































<table><thead><tr><th>特性</th><th>Promise</th><th>async/await</th></tr></thead><tbody><tr><td><strong>代码结构</strong></td><td>链式调用（.then().catch()）</td><td>类似同步代码的线性结构</td></tr><tr><td><strong>错误处理</strong></td><td>使用 <code>.catch()</code> 或第二个参数</td><td>使用 try/catch 块</td></tr><tr><td><strong>可读性</strong></td><td>回调嵌套可能较深（回调地狱）</td><td>更清晰，易于理解流程</td></tr><tr><td><strong>调试</strong></td><td>断点跳转可能不直观</td><td>可以像同步代码一样调试</td></tr><tr><td><strong>变量作用域</strong></td><td>每个 <code>.then()</code> 都是新作用域</td><td>整个 async 函数共享作用域</td></tr></tbody></table>
<h2 data-id="heading-5">4. <strong>关键特点</strong></h2>
<h3 data-id="heading-6">Promise 特点：</h3>
<ul>
<li>三种状态：pending、fulfilled、rejected</li>
<li>状态一旦改变不可逆转</li>
<li>可以并行处理多个异步操作（<code>Promise.all</code>、<code>Promise.race</code>）</li>
<li>可以提前创建但不立即执行</li>
</ul>
<h3 data-id="heading-7">async/await 特点：</h3>
<ul>
<li><code>async</code> 函数总是返回一个 Promise</li>
<li><code>await</code> 只能在 <code>async</code> 函数中使用</li>
<li><code>await</code> 会暂停当前 async 函数的执行，直到 Promise 解决</li>
<li>代码自上而下顺序执行，逻辑更清晰</li>
</ul>
<h2 data-id="heading-8">5. <strong>错误处理差异</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Promise 错误处理</span>
promise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> { <span class="hljs-comment">/* 处理结果 */</span> })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> { <span class="hljs-comment">/* 处理错误 */</span> });

<span class="hljs-comment">// async/await 错误处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> promise;
        <span class="hljs-comment">// 处理结果</span>
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 处理错误</span>
    }
}
</code></pre>
<h2 data-id="heading-9">6. <strong>性能考虑</strong></h2>
<ul>
<li>async/await 本质上会被转换为 Promise 链</li>
<li>现代 JavaScript 引擎对两者优化都很好</li>
<li>async/await 在某些场景下可能产生微小的额外开销（生成器转换）</li>
</ul>
<h2 data-id="heading-10">7. <strong>使用建议</strong></h2>
<h3 data-id="heading-11">适合 Promise 的场景：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 并行执行多个异步操作</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([task1, task2, task3])
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
        <span class="hljs-comment">// 同时处理所有结果</span>
    });

<span class="hljs-comment">// 竞速场景</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([fetch1, fetch2])
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">firstResult</span> =&gt;</span> {
        <span class="hljs-comment">// 使用最先返回的结果</span>
    });
</code></pre>
<h3 data-id="heading-12">适合 async/await 的场景：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 有依赖关系的异步操作序列</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">orderId</span>) {
    <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getOrder</span>(orderId);
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(order.<span class="hljs-property">userId</span>);
    <span class="hljs-keyword">const</span> payment = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayment</span>(order.<span class="hljs-property">paymentId</span>);
    <span class="hljs-comment">// 清晰的顺序执行逻辑</span>
    <span class="hljs-keyword">return</span> { order, user, payment };
}
</code></pre>
<h2 data-id="heading-13">8. <strong>互相转换</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// async/await 转换为 Promise 链</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task1</span>();
    <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task2</span>(a);
    <span class="hljs-keyword">return</span> b;
}
<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">promiseExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">task1</span>()
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> <span class="hljs-title function_">task2</span>(a));
}

<span class="hljs-comment">// Promise 链转换为 async/await</span>
promise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">process</span>(value))
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result));
<span class="hljs-comment">// 转换为</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePromise</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> value = <span class="hljs-keyword">await</span> promise;
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">process</span>(value);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
}
</code></pre>
<h2 data-id="heading-14">总结</h2>
<ul>
<li><strong>Promise 是基础</strong>，async/await 是建立在 Promise 之上的语法糖</li>
<li><strong>async/await 让代码更易读</strong>，特别适合处理有顺序依赖的异步操作</li>
<li><strong>Promise 更适合并行处理</strong>多个独立的异步任务</li>
<li>两者可以混合使用，根据具体场景选择最合适的方式</li>
</ul>
<p>实际开发中，通常会结合使用两种方式，利用各自的优势来编写更清晰、高效的异步代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[先免费试用下Claude code安装使用（教程）]]></title>    <link>https://juejin.cn/post/7597695531217354802</link>    <guid>https://juejin.cn/post/7597695531217354802</guid>    <pubDate>2026-01-21T15:53:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695531217354802" data-draft-id="7597434154796761114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="先免费试用下Claude code安装使用（教程）"/> <meta itemprop="keywords" content="前端,Claude"/> <meta itemprop="datePublished" content="2026-01-21T15:53:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈罗哈皮"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009631447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            先免费试用下Claude code安装使用（教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009631447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈罗哈皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:53:10.000Z" title="Wed Jan 21 2026 15:53:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2026年了，如果还不会使用一款AI编程工具，未来将会越来越难行。
今天我们先来使用一个终端编程比较火的工具：Claude code</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3037ea57903486187786fe167b4aa66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=6hMejacmZlMexSmDJ83sBpV%2F%2FSQ%3D" alt="c30b1a20-ce33-42d5-ae63-f44b24450158.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、安装</h2>
<h3 data-id="heading-1">1、nodejs安装</h3>
<ul>
<li>如果你本地没有node环境，是需要先安装node的，node版本至少要18.0以上，可点击下面地址跳转到nodejs官网下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">下载Node.js</a>，对于老程序员来说肯定都喜欢nvm安装node可随时切换<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnvm-sh%2Fnvm" target="_blank" title="https://github.com/nvm-sh/nvm" ref="nofollow noopener noreferrer">nvm下载</a></li>
</ul>
<h3 data-id="heading-2">2、Claude Code</h3>
<ul>
<li>安装Claude Code及指向镜像</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">npm install -g https://gaccode.com/claudecode/install --registry=https://registry.npmmirror.com 
</code></pre>
<ul>
<li>如果之前安装没有指向镜像，可以先卸载Claude Code</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">npm uninstall -g @anthropic-ai/claude-code
</code></pre>
<p>查看是否安装成功
<code>claude -v</code>
输出的内容如下，代表安装成功了：</p>
<pre><code class="hljs language-css" lang="css">🌟 Welcome <span class="hljs-selector-tag">to</span> Claude <span class="hljs-selector-tag">Code</span>!
🔗 You are using the canonical relay
💡 ANTHROPIC_API_KEY discovered, skipping OAuth
<span class="hljs-number">2.1</span>.<span class="hljs-number">6</span> (Claude <span class="hljs-selector-tag">Code</span>)
</code></pre>
<h3 data-id="heading-3">3、配置阿里云百炼的通义千问系列</h3>
<ul>
<li>使用阿里云大模型是因为现在注册可以送百万token，可以免费测试下效果如何，如果感觉不错以后可以购买；申请key 阿里云百炼地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2Fcn-beijing%2F%3Ftab%3Dhome%23%2Fhome" target="_blank" title="https://bailian.console.aliyun.com/cn-beijing/?tab=home#/home" ref="nofollow noopener noreferrer">bailian.console.aliyun.com</a></li>
<li>在 PowerShell 中运行以下命令，设置环境变量</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 用百炼 API Key 替换 YOUR_DASHSCOPE_API_KEY</span>
[<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_API_KEY"</span>, <span class="hljs-string">"YOUR_DASHSCOPE_API_KEY"</span>, [<span class="hljs-title class_">EnvironmentVariableTarget</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:User</span>)
[<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_BASE_URL"</span>, <span class="hljs-string">"https://dashscope.aliyuncs.com/apps/anthropic"</span>, [<span class="hljs-title class_">EnvironmentVariableTarget</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:User</span>)
</code></pre>
<ul>
<li>打开一个新的 PowerShell 窗口，运行以下命令，检查环境变量是否生效。</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$env</span>:ANTHROPIC_API_KEY
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$env</span>:ANTHROPIC_BASE_URL
</code></pre>
<ul>
<li>在安装Claude Code根目录.claude创建一个<code>settings.json</code>文件，配置后claude code才能显示自定义的大模型可选</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen3-coder-plus"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen-flash"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen3-coder-plus"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">4、启动Claude Code</h3>
<ul>
<li>在终端中输入Claude 按在enter</li>
</ul>

<pre><code class="hljs">claude 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/914e0ab50ef54278b04bf0b7bd9add41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=cnAJFHsr5oLvWA1RLx3dKLrv7WU%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>然后会自动打开一个新的终端，里面有欢迎语</li>
<li>然后在对话框中输入<code>/model</code>按在enter</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">/model
</code></pre>
<ul>
<li>然后选择你刚刚配置的阿里云大模型即可
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6629679e86cd4f35b2ab35bb9bcd243b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=gmAuWBMR26r8IffKXPw2k%2BJ7zVU%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h2 data-id="heading-5">小结</h2>
<ul>
<li>根据上面的操作配置完成后，你就拥有了3个月免费的Claude Code工具使用。</li>
</ul>
<h2 data-id="heading-6">其他</h2>
<h4 data-id="heading-7">1、如果想使用其他大模型，可以根据官网介绍安装</h4>
<ul>
<li>阿里云百炼教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.alibabacloud.com%2Fhelp%2Fzh%2Fmodel-studio%2Fclaude-code" target="_blank" title="https://www.alibabacloud.com/help/zh/model-studio/claude-code" ref="nofollow noopener noreferrer">www.alibabacloud.com/help/zh/mod…</a></li>
<li>智谱开放平台教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.bigmodel.cn%2Fcn%2Fcoding-plan%2Ftool%2Fclaude" target="_blank" title="https://docs.bigmodel.cn/cn/coding-plan/tool/claude" ref="nofollow noopener noreferrer">docs.bigmodel.cn/cn/coding-p…</a></li>
<li>火山方舟（Ark）教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F82379%2F1928262%3Flang%3Dzh" target="_blank" title="https://www.volcengine.com/docs/82379/1928262?lang=zh" ref="nofollow noopener noreferrer">www.volcengine.com/docs/82379/…</a></li>
<li>无问芯穹（GenStudio）教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infini-ai.com%2Fposts%2Fuse-claude-code.html" target="_blank" title="https://docs.infini-ai.com/posts/use-claude-code.html" ref="nofollow noopener noreferrer">docs.infini-ai.com/posts/use-c…</a></li>
<li>DeepSeek教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2Fguides%2Fanthropic_api" target="_blank" title="https://api-docs.deepseek.com/zh-cn/guides/anthropic_api" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/guide…</a></li>
</ul>
<h4 data-id="heading-8">2、我目前使用的是阿里百炼里面的大模型</h4>
<ul>
<li>问我为什么选择他，我只能回答因为现在注册有百万token，有效期3个月，先试试这个工具怎样先；</li>
</ul>
<h2 data-id="heading-9">使用效果</h2>
<ul>
<li>1、我截了一个百度首页给AI大模型，叫他写一个一模一样的网页，你猜他会怎样？
直接给我幻觉输出，完成不是按照截图的来输出。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e06fe85c97a4fbcbf7df5e18cac7301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=i6M9dLxBwQ6Awqq9Y5fAVsWWKgU%3D" alt="8853088f-af82-458c-b97d-6b3fc310c6aa.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d22b14d3f5d4cbd96eafbf906504f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=gO%2FThQjCq5eW7E3VPYT1GMohKlU%3D" alt="image.png" loading="lazy"/>
最后的页面是这样的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c65d133956564cea90a834b3cc37ded2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=xgkrhZICbKcxPVmGLSbQRtfqtMM%3D" alt="711fa965-5bc7-446f-85d7-4528888ca653.png" loading="lazy"/></p>
<ul>
<li>可能是大模型不够好吧，网页输出还行，是一个标准的‘官网’，只是 不是我想要的官网。</li>
<li>就这么操作一次消耗了我41%的token
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d334987744a84145b5f473bba8b6f921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=2O3BSFwp7NeauPNR12VzUkp%2FMtg%3D" alt="image.png" loading="lazy"/>
还好他有很多模型，还能切换
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66473385301543829f569dfc2fb5fdca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=7IxlmB%2BYUw7c7WoSVw1hRxvEyg8%3D" alt="image.png" loading="lazy"/></li>
<li>这里右边的‘免费额度用完即停’建议开启吧，问过客服说如果不开启，可能用完超过10元才会有提醒。</li>
</ul>
<h2 data-id="heading-10">使用感受</h2>
<ul>
<li>只是初步搭建，还没深度使用他的MCP相关流程，这里就不评论他的好坏了，我只简单说说这次搭建使用过程的感受；</li>
<li>a、搭建速度很快，不依赖exe安装包，只要打开终端就能安装使用，感觉很隐蔽也很高级的感觉，这种开发模式比较符合开发者使用；</li>
<li>b、没有代码直接编辑，只用自然语言输出修改需求，感觉最后出现的效果全靠大模型了，还有看你提示词的精准度及大模型的能力程度；</li>
</ul>
<h2 data-id="heading-11">基础指令</h2>























































<table><thead><tr><th>命令</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><code>claude</code></td><td>启动交互模式</td><td><code>claude</code></td></tr><tr><td><code>claude "task"</code></td><td>运行一次性任务</td><td><code>claude "fix the build error"</code></td></tr><tr><td><code>claude -p "query"</code></td><td>运行一次性查询，然后退出</td><td><code>claude -p "explain this function"</code></td></tr><tr><td><code>claude -c</code></td><td>在当前目录中继续最近的对话</td><td><code>claude -c</code></td></tr><tr><td><code>claude -r</code></td><td>恢复之前的对话</td><td><code>claude -r</code></td></tr><tr><td><code>claude commit</code></td><td>创建 Git 提交</td><td><code>claude commit</code></td></tr><tr><td><code>/clear</code></td><td>清除对话历史</td><td><code>&gt; /clear</code></td></tr><tr><td><code>/help</code></td><td>显示可用命令</td><td><code>&gt; /help</code></td></tr><tr><td><code>exit</code> 或 Ctrl+C</td><td>退出 Claude Code</td><td><code>&gt; exit</code></td></tr></tbody></table>
<h2 data-id="heading-12">展望</h2>
<p>*本期先写到这里，下期我将会结合流行的MCP配置使用。</p>
<ul>
<li>需要访问Claude Code官网的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Foverview" target="_blank" title="https://code.claude.com/docs/zh-CN/overview" ref="nofollow noopener noreferrer">code.claude.com/docs/zh-CN/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15存储子系统深度解析(一):Vold与存储管理框架]]></title>    <link>https://juejin.cn/post/7597640434399592499</link>    <guid>https://juejin.cn/post/7597640434399592499</guid>    <pubDate>2026-01-21T11:37:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640434399592499" data-draft-id="7597623395907747886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15存储子系统深度解析(一):Vold与存储管理框架"/> <meta itemprop="keywords" content="Android,操作系统,源码阅读"/> <meta itemprop="datePublished" content="2026-01-21T11:37:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15存储子系统深度解析(一):Vold与存储管理框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:37:19.000Z" title="Wed Jan 21 2026 11:37:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>Android系统中的存储管理是一个复杂而精密的子系统。从SD卡的热插拔检测,到内部存储的分区挂载,再到OBB扩展文件的管理,这一切的核心都离不开一个关键的守护进程——<strong>Vold</strong>(Volume Daemon)。</p>
<p>作为Android存储架构的"大脑",Vold负责:</p>
<ul>
<li>🔌 <strong>设备检测</strong>: 实时监听内核Uevent,发现新插入的存储设备</li>
<li>📦 <strong>Volume管理</strong>: 抽象和管理各类存储卷(公共存储、可采用存储、模拟存储)</li>
<li>🔐 <strong>加密支持</strong>: 处理文件级加密(FBE)和磁盘加密</li>
<li>🌉 <strong>跨进程通信</strong>: 通过Binder向Framework层提供存储服务</li>
</ul>
<p>本文将基于<strong>Android 15 (AOSP 15.0)</strong> 的源码,深入剖析Vold的架构设计、启动流程、核心组件以及与StorageManagerService的交互机制。</p>
<blockquote>
<p>💡 <strong>源码路径</strong>: 本文分析的Vold源码位于 <code>system/vold/</code>,StorageManagerService位于 <code>frameworks/base/services/core/java/com/android/server/StorageManagerService.java</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、Vold架构总览</h2>
<h3 data-id="heading-2">1.1 Vold在Android存储架构中的位置</h3>
<p>在Android存储架构中,Vold扮演着"承上启下"的关键角色:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72a31784d34427ca2d81ee86383e590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=ohnajz50K4XNyjJa215VF5aTIB4%3D" alt="04-01-vold-architecture-overview.png" loading="lazy"/></p>
<p>如上图所示,Vold的架构可以分为五个层次:</p>
<h4 data-id="heading-3"><strong>Framework层 (Java)</strong></h4>
<ul>
<li><strong>StorageManagerService</strong>: 系统服务,提供存储管理的Java API</li>
<li><strong>IStorageManager</strong>: AIDL接口,定义Framework层的存储服务接口</li>
</ul>
<h4 data-id="heading-4"><strong>Native Binder层 (C++)</strong></h4>
<ul>
<li><strong>VoldNativeService</strong>: 实现IVold接口的Binder服务,是Vold对外提供服务的入口</li>
<li><strong>IVold</strong>: AIDL接口,定义了从Framework到Native的跨进程调用接口</li>
<li><strong>IVoldListener</strong>: AIDL接口,用于Vold向Framework发送事件回调</li>
</ul>
<h4 data-id="heading-5"><strong>Vold核心层 (C++)</strong></h4>
<ul>
<li><strong>VolumeManager</strong>: Vold的核心管理器(单例),管理所有Disk和Volume对象</li>
<li><strong>NetlinkManager</strong>: 负责监听内核的Netlink Uevent事件</li>
<li><strong>NetlinkHandler</strong>: 处理Netlink事件,将设备插拔事件转换为Volume操作</li>
</ul>
<h4 data-id="heading-6"><strong>存储模型层 (C++)</strong></h4>
<ul>
<li><strong>Disk</strong>: 物理磁盘的抽象(SD卡、USB存储)</li>
<li><strong>VolumeBase</strong>: Volume的基类,提供通用的挂载/卸载接口
<ul>
<li><strong>PublicVolume</strong>: 公共存储卷(FAT32/exFAT格式)</li>
<li><strong>PrivateVolume</strong>: 可采用存储(Adoptable Storage,ext4加密)</li>
<li><strong>EmulatedVolume</strong>: 模拟存储卷(/storage/emulated)</li>
<li><strong>ObbVolume</strong>: OBB扩展文件卷</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7"><strong>底层支持</strong></h4>
<ul>
<li><strong>Kernel Netlink</strong>: 内核Uevent机制,用于设备热插拔事件通知</li>
<li><strong>/dev/block</strong>: 块设备节点</li>
<li><strong>fstab</strong>: 文件系统表配置</li>
</ul>
<h3 data-id="heading-8">1.2 核心设计模式</h3>
<p>Vold的设计体现了多个经典的设计模式:</p>
<p><strong>1. 单例模式 (Singleton)</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VolumeManager.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeManager</span> {
    <span class="hljs-type">static</span> VolumeManager* sInstance;
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> VolumeManager* <span class="hljs-title">Instance</span><span class="hljs-params">()</span></span>;
};
</code></pre>
<p>VolumeManager和NetlinkManager都采用单例模式,确保全局只有一个管理器实例。</p>
<p><strong>2. 观察者模式 (Observer)</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VoldNativeService</span> : <span class="hljs-keyword">public</span> BinderService&lt;VoldNativeService&gt;, <span class="hljs-keyword">public</span> os::BnVold {
    <span class="hljs-function">binder::Status <span class="hljs-title">setListener</span><span class="hljs-params">(<span class="hljs-type">const</span> android::sp&lt;android::os::IVoldListener&gt;&amp; listener)</span></span>;
};
</code></pre>
<p>通过IVoldListener接口,StorageManagerService可以订阅Vold的事件通知。</p>
<p><strong>3. 继承多态 (Inheritance)</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/VolumeBase.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeBase</span> {
<span class="hljs-keyword">protected</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doMount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doUnmount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PublicVolume</span> : <span class="hljs-keyword">public</span> VolumeBase { ... };
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateVolume</span> : <span class="hljs-keyword">public</span> VolumeBase { ... };
</code></pre>
<p>各种Volume类型继承自VolumeBase,实现特定的挂载逻辑。</p>
<hr/>
<h2 data-id="heading-9">二、Vold启动流程详解</h2>
<h3 data-id="heading-10">2.1 Init进程启动Vold</h3>
<p>Vold作为一个Native守护进程,由init进程根据<code>init.rc</code>配置文件启动:</p>
<pre><code class="hljs language-rc" lang="rc"># system/core/rootdir/init.rc
service vold /system/bin/vold \
    --blkid_context=u:r:blkid:s0 \
    --blkid_untrusted_context=u:r:blkid_untrusted:s0 \
    --fsck_context=u:r:fsck:s0 \
    --fsck_untrusted_context=u:r:fsck_untrusted:s0
    class core
    ioprio be 2
    writepid /dev/cpuset/foreground/tasks
    shutdown critical
</code></pre>
<p>配置解析:</p>
<ul>
<li><code>class core</code>: Vold属于核心服务,在early-boot阶段启动</li>
<li><code>--*_context</code>: 指定SELinux上下文,用于blkid和fsck工具的安全隔离</li>
<li><code>ioprio be 2</code>: 设置I/O优先级为Best Effort,优先级2</li>
<li><code>shutdown critical</code>: Vold崩溃会导致系统重启</li>
</ul>
<h3 data-id="heading-11">2.2 main()函数:初始化流程</h3>
<p>让我们深入到<code>system/vold/main.cpp</code>的启动代码:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>{
    <span class="hljs-comment">// 1. 初始化日志系统</span>
    <span class="hljs-built_in">setenv</span>(<span class="hljs-string">"ANDROID_LOG_TAGS"</span>, <span class="hljs-string">"*:d"</span>, <span class="hljs-number">1</span>);
    android::base::<span class="hljs-built_in">InitLogging</span>(argv, &amp;VoldLogger);
    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"Vold 3.0 (the awakening) firing up"</span>;

    <span class="hljs-comment">// 2. 检测文件系统支持</span>
    <span class="hljs-built_in">LOG</span>(DEBUG) &lt;&lt; <span class="hljs-string">"Detected support for:"</span>
               &lt;&lt; (android::vold::<span class="hljs-built_in">IsFilesystemSupported</span>(<span class="hljs-string">"ext4"</span>) ? <span class="hljs-string">" ext4"</span> : <span class="hljs-string">""</span>)
               &lt;&lt; (android::vold::<span class="hljs-built_in">IsFilesystemSupported</span>(<span class="hljs-string">"f2fs"</span>) ? <span class="hljs-string">" f2fs"</span> : <span class="hljs-string">""</span>)
               &lt;&lt; (android::vold::<span class="hljs-built_in">IsFilesystemSupported</span>(<span class="hljs-string">"vfat"</span>) ? <span class="hljs-string">" vfat"</span> : <span class="hljs-string">""</span>);

    <span class="hljs-comment">// 3. 初始化SELinux</span>
    sehandle = <span class="hljs-built_in">selinux_android_file_context_handle</span>();
    <span class="hljs-keyword">if</span> (!sehandle) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to get SELinux file contexts handle"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    <span class="hljs-built_in">selinux_android_set_sehandle</span>(sehandle);

    <span class="hljs-comment">// 4. 创建必要的目录</span>
    <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">"/dev/block/vold"</span>, <span class="hljs-number">0755</span>);

    <span class="hljs-comment">// 5. 创建核心组件单例</span>
    VolumeManager* vm = VolumeManager::<span class="hljs-built_in">Instance</span>();
    NetlinkManager* nm = NetlinkManager::<span class="hljs-built_in">Instance</span>();

    <span class="hljs-comment">// 6. 启动VolumeManager</span>
    <span class="hljs-keyword">if</span> (vm-&gt;<span class="hljs-built_in">start</span>()) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start VolumeManager"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 7. 处理fstab配置</span>
    VoldConfigs configs = {};
    <span class="hljs-built_in">process_config</span>(vm, &amp;configs);

    <span class="hljs-comment">// 8. 启动Binder服务</span>
    android::hardware::<span class="hljs-built_in">configureRpcThreadpool</span>(<span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (android::vold::VoldNativeService::<span class="hljs-built_in">start</span>() != android::OK) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start VoldNativeService"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 9. 启动NetlinkManager</span>
    <span class="hljs-keyword">if</span> (nm-&gt;<span class="hljs-built_in">start</span>()) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start NetlinkManager"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 10. 设置系统属性</span>
    android::base::<span class="hljs-built_in">SetProperty</span>(<span class="hljs-string">"vold.has_adoptable"</span>, configs.has_adoptable ? <span class="hljs-string">"1"</span> : <span class="hljs-string">"0"</span>);
    android::base::<span class="hljs-built_in">SetProperty</span>(<span class="hljs-string">"vold.has_quota"</span>, configs.has_quota ? <span class="hljs-string">"1"</span> : <span class="hljs-string">"0"</span>);

    <span class="hljs-comment">// 11. Coldboot扫描已连接设备</span>
    <span class="hljs-built_in">coldboot</span>(<span class="hljs-string">"/sys/block"</span>);

    <span class="hljs-comment">// 12. 进入主循环</span>
    android::IPCThreadState::<span class="hljs-built_in">self</span>()-&gt;<span class="hljs-built_in">joinThreadPool</span>();
    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"vold shutting down"</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9176e2292914478998c263d3363a248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=hlVmqlRfk2i3ucASey%2FpC5RJIks%3D" alt="04-02-vold-startup-sequence.png" loading="lazy"/></p>
<h3 data-id="heading-12">2.3 关键步骤详解</h3>
<h4 data-id="heading-13"><strong>步骤1-2: 日志和文件系统检测</strong></h4>
<ul>
<li><code>VoldLogger</code>: 自定义日志处理器,early-boot阶段的错误会同时输出到kernel log</li>
<li><code>IsFilesystemSupported()</code>: 检查内核是否支持ext4/f2fs/vfat文件系统</li>
</ul>
<h4 data-id="heading-14"><strong>步骤3: SELinux初始化</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp">sehandle = <span class="hljs-built_in">selinux_android_file_context_handle</span>();
</code></pre>
<p>获取SELinux文件上下文句柄,用于后续创建文件时设置正确的安全上下文。</p>
<h4 data-id="heading-15"><strong>步骤5: 单例创建</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp">VolumeManager* vm = VolumeManager::<span class="hljs-built_in">Instance</span>();
</code></pre>
<p>VolumeManager采用懒加载单例模式:</p>
<pre><code class="hljs language-cpp" lang="cpp">VolumeManager* VolumeManager::sInstance = <span class="hljs-literal">nullptr</span>;

<span class="hljs-function">VolumeManager* <span class="hljs-title">VolumeManager::Instance</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (!sInstance) {
        sInstance = <span class="hljs-keyword">new</span> <span class="hljs-built_in">VolumeManager</span>();
    }
    <span class="hljs-keyword">return</span> sInstance;
}
</code></pre>
<h4 data-id="heading-16"><strong>步骤7: 处理fstab配置</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">process_config</span><span class="hljs-params">(VolumeManager* vm, VoldConfigs* configs)</span> </span>{
    <span class="hljs-comment">// 读取fstab</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadDefaultFstab</span>(&amp;fstab_default)) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to open default fstab"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 遍历fstab条目</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; entry : fstab_default) {
        <span class="hljs-comment">// 检查是否支持quota/reserved/compress</span>
        <span class="hljs-keyword">if</span> (entry.fs_mgr_flags.quota) configs-&gt;has_quota = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (entry.reserved_size &gt; <span class="hljs-number">0</span>) configs-&gt;has_reserved = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (entry.fs_mgr_flags.fs_compress) configs-&gt;has_compress = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 处理vold_managed标记的分区</span>
        <span class="hljs-keyword">if</span> (entry.fs_mgr_flags.vold_managed) {
            <span class="hljs-function">std::string <span class="hljs-title">sysPattern</span><span class="hljs-params">(entry.blk_device)</span></span>;
            <span class="hljs-function">std::string <span class="hljs-title">nickname</span><span class="hljs-params">(entry.label)</span></span>;
            <span class="hljs-type">int</span> flags = <span class="hljs-number">0</span>;

            <span class="hljs-comment">// 可采用存储标记</span>
            <span class="hljs-keyword">if</span> (entry.<span class="hljs-built_in">is_encryptable</span>()) {
                flags |= android::vold::Disk::Flags::kAdoptable;
                configs-&gt;has_adoptable = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-comment">// 添加到VolumeManager</span>
            vm-&gt;<span class="hljs-built_in">addDiskSource</span>(std::<span class="hljs-built_in">shared_ptr</span>&lt;VolumeManager::DiskSource&gt;(
                <span class="hljs-keyword">new</span> VolumeManager::<span class="hljs-built_in">DiskSource</span>(sysPattern, nickname, flags)));
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>fstab示例</strong>:</p>
<pre><code class="hljs language-arduino" lang="arduino"># 可采用的<span class="hljs-built_in">SD</span>卡
/devices/platform/soc/<span class="hljs-number">7864900.</span>sdhci/mmc_host/mmc*  <span class="hljs-keyword">auto</span>  <span class="hljs-keyword">auto</span>  defaults  vold_managed=sdcard1:<span class="hljs-keyword">auto</span>,encryptable=userdata
</code></pre>
<h4 data-id="heading-17"><strong>步骤11: Coldboot扫描</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">coldboot</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span> </span>{
    DIR* d = <span class="hljs-built_in">opendir</span>(path);
    <span class="hljs-keyword">if</span> (d) {
        <span class="hljs-built_in">do_coldboot</span>(d, <span class="hljs-number">0</span>);
        <span class="hljs-built_in">closedir</span>(d);
    }
}

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">do_coldboot</span><span class="hljs-params">(DIR* d, <span class="hljs-type">int</span> lvl)</span> </span>{
    <span class="hljs-comment">// 遍历/sys/block目录</span>
    <span class="hljs-keyword">while</span> ((de = <span class="hljs-built_in">readdir</span>(d))) {
        <span class="hljs-comment">// 向uevent节点写入"add",触发内核发送uevent事件</span>
        fd = <span class="hljs-built_in">openat</span>(dfd, <span class="hljs-string">"uevent"</span>, O_WRONLY | O_CLOEXEC);
        <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">write</span>(fd, <span class="hljs-string">"add\n"</span>, <span class="hljs-number">4</span>);
            <span class="hljs-built_in">close</span>(fd);
        }
    }
}
</code></pre>
<p>Coldboot的作用是主动触发内核重新发送已连接设备的uevent事件,确保Vold启动时能发现已插入的存储设备。</p>
<hr/>
<h2 data-id="heading-18">三、VolumeManager核心机制</h2>
<h3 data-id="heading-19">3.1 VolumeManager的数据结构</h3>
<p>让我们看看VolumeManager如何组织和管理Disk和Volume:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VolumeManager.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeManager</span> {
<span class="hljs-keyword">private</span>:
    std::mutex mLock;  <span class="hljs-comment">// 全局锁</span>
    std::mutex mCryptLock;  <span class="hljs-comment">// 加密操作锁</span>

    <span class="hljs-comment">// 核心数据结构</span>
    std::list&lt;std::shared_ptr&lt;DiskSource&gt;&gt; mDiskSources;  <span class="hljs-comment">// 磁盘源配置</span>
    std::list&lt;std::shared_ptr&lt;android::vold::Disk&gt;&gt; mDisks;  <span class="hljs-comment">// 物理磁盘列表</span>
    std::list&lt;std::shared_ptr&lt;android::vold::Disk&gt;&gt; mPendingDisks;  <span class="hljs-comment">// 待处理磁盘</span>
    std::list&lt;std::shared_ptr&lt;android::vold::VolumeBase&gt;&gt; mObbVolumes;  <span class="hljs-comment">// OBB卷</span>
    std::list&lt;std::shared_ptr&lt;android::vold::VolumeBase&gt;&gt; mInternalEmulatedVolumes;  <span class="hljs-comment">// 模拟卷</span>

    <span class="hljs-comment">// 用户管理</span>
    std::unordered_map&lt;<span class="hljs-type">userid_t</span>, <span class="hljs-type">int</span>&gt; mAddedUsers;
    std::set&lt;<span class="hljs-type">userid_t</span>&gt; mStartedUsers;

    <span class="hljs-comment">// 事件监听器</span>
    android::sp&lt;android::os::IVoldListener&gt; mListener;
};
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af95ca67bcb04968895b823c25a669f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=wQpXAC2G4qmGQeXHWN1jsNRxAlg%3D" alt="04-04-disk-volume-relationship.png" loading="lazy"/></p>
<h3 data-id="heading-20">3.2 Disk和Volume的关系</h3>
<p><strong>Disk (物理磁盘抽象)</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/Disk.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Disk</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Flags</span> {
        kAdoptable = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,      <span class="hljs-comment">// 可采用存储</span>
        kDefaultPrimary = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>, <span class="hljs-comment">// 默认主存储</span>
        kSd = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,             <span class="hljs-comment">// SD卡</span>
        kUsb = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,            <span class="hljs-comment">// USB存储</span>
        kEmmc = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,           <span class="hljs-comment">// eMMC内部存储</span>
    };

<span class="hljs-keyword">private</span>:
    std::string mId;              <span class="hljs-comment">// 唯一ID,如"disk:179:0"</span>
    std::string mSysPath;         <span class="hljs-comment">// sysfs路径,如"/sys/devices/.../mmcblk0"</span>
    std::string mDevPath;         <span class="hljs-comment">// 设备路径,如"/dev/block/mmcblk0"</span>
    <span class="hljs-type">dev_t</span> mDevice;                <span class="hljs-comment">// 设备号(major:minor)</span>
    <span class="hljs-type">uint64_t</span> mSize;               <span class="hljs-comment">// 磁盘大小</span>
    std::string mLabel;           <span class="hljs-comment">// 磁盘标签</span>
    <span class="hljs-type">int</span> mFlags;                   <span class="hljs-comment">// 标志位</span>
    std::vector&lt;std::shared_ptr&lt;VolumeBase&gt;&gt; mVolumes;  <span class="hljs-comment">// 包含的Volume列表</span>
};
</code></pre>
<p><strong>VolumeBase (Volume基类)</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/VolumeBase.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeBase</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Type</span> {
        kPublic = <span class="hljs-number">0</span>,   <span class="hljs-comment">// 公共存储</span>
        kPrivate,      <span class="hljs-comment">// 可采用存储</span>
        kEmulated,     <span class="hljs-comment">// 模拟存储</span>
        kAsec,         <span class="hljs-comment">// 已废弃</span>
        kObb,          <span class="hljs-comment">// OBB文件</span>
        kStub,         <span class="hljs-comment">// 存根卷</span>
    };

    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">State</span> {
        kUnmounted = <span class="hljs-number">0</span>,       <span class="hljs-comment">// 未挂载</span>
        kChecking,            <span class="hljs-comment">// 检查中</span>
        kMounted,             <span class="hljs-comment">// 已挂载</span>
        kMountedReadOnly,     <span class="hljs-comment">// 只读挂载</span>
        kFormatting,          <span class="hljs-comment">// 格式化中</span>
        kEjecting,            <span class="hljs-comment">// 弹出中</span>
        kUnmountable,         <span class="hljs-comment">// 无法挂载</span>
        kRemoved,             <span class="hljs-comment">// 已移除</span>
        kBadRemoval,          <span class="hljs-comment">// 异常移除</span>
    };

<span class="hljs-keyword">protected</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doMount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;     <span class="hljs-comment">// 子类实现挂载逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doUnmount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;   <span class="hljs-comment">// 子类实现卸载逻辑</span>

<span class="hljs-keyword">private</span>:
    std::string mId;          <span class="hljs-comment">// Volume ID,如"public:179:1"</span>
    std::string mDiskId;      <span class="hljs-comment">// 所属Disk ID</span>
    Type mType;               <span class="hljs-comment">// Volume类型</span>
    State mState;             <span class="hljs-comment">// 当前状态</span>
    std::string mPath;        <span class="hljs-comment">// 挂载路径</span>
};
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5c74afd832b47e9a183ad09a7882a77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=PHtvztOWznJDheekvx5Q14y8ud0%3D" alt="04-03-volume-state-machine.png" loading="lazy"/></p>
<h3 data-id="heading-21">3.3 Volume生命周期管理</h3>
<p><strong>创建Volume</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/Disk.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Disk::createPublicVolume</span><span class="hljs-params">(<span class="hljs-type">dev_t</span> device)</span> </span>{
    <span class="hljs-keyword">auto</span> vol = std::<span class="hljs-built_in">make_shared</span>&lt;PublicVolume&gt;(device);
    <span class="hljs-comment">// 设置Volume属性</span>
    vol-&gt;<span class="hljs-built_in">setDiskId</span>(<span class="hljs-built_in">getId</span>());
    vol-&gt;<span class="hljs-built_in">setPartGuid</span>(partGuid);

    <span class="hljs-comment">// 添加到Disk的Volume列表</span>
    mVolumes.<span class="hljs-built_in">push_back</span>(vol);

    <span class="hljs-comment">// 创建Volume(通知Framework)</span>
    vol-&gt;<span class="hljs-built_in">create</span>();
}
</code></pre>
<p><strong>挂载Volume</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/VolumeBase.cpp</span>
<span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">VolumeBase::mount</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 状态检查</span>
    <span class="hljs-keyword">if</span> (mState != State::kUnmounted) {
        <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">"Already mounted or mounting"</span>;
        <span class="hljs-keyword">return</span> -EBUSY;
    }

    <span class="hljs-comment">// 2. 设置为检查状态</span>
    <span class="hljs-built_in">setState</span>(State::kChecking);

    <span class="hljs-comment">// 3. 调用子类实现的挂载逻辑</span>
    <span class="hljs-type">status_t</span> res = <span class="hljs-built_in">doMount</span>();

    <span class="hljs-comment">// 4. 根据结果更新状态</span>
    <span class="hljs-keyword">if</span> (res == OK) {
        <span class="hljs-built_in">setState</span>(State::kMounted);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">setState</span>(State::kUnmountable);
    }

    <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><strong>PublicVolume的挂载实现</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/PublicVolume.cpp</span>
<span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">PublicVolume::doMount</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 读取文件系统类型</span>
    std::string fsType;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ReadMetadataUntrusted</span>(mDevPath, &amp;fsType, &amp;fsUuid, &amp;fsLabel)) {
        <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">"Failed to read metadata"</span>;
        fsType = <span class="hljs-string">"auto"</span>;
    }

    <span class="hljs-comment">// 2. 执行fsck检查</span>
    <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"vfat"</span> &amp;&amp; vfat::<span class="hljs-built_in">Check</span>(mDevPath)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"FAT filesystem check failed"</span>;
        <span class="hljs-keyword">return</span> -EIO;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"exfat"</span> &amp;&amp; exfat::<span class="hljs-built_in">Check</span>(mDevPath)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"exFAT filesystem check failed"</span>;
        <span class="hljs-keyword">return</span> -EIO;
    }

    <span class="hljs-comment">// 3. 创建挂载点</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">PrepareDir</span>(mRawPath, <span class="hljs-number">0700</span>, AID_ROOT, AID_ROOT)) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to create mount point "</span> &lt;&lt; mRawPath;
        <span class="hljs-keyword">return</span> -errno;
    }

    <span class="hljs-comment">// 4. 执行mount系统调用</span>
    <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"vfat"</span>) {
        <span class="hljs-keyword">if</span> (vfat::<span class="hljs-built_in">Mount</span>(mDevPath, mRawPath, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>,
                       AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number">0007</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to mount vfat"</span>;
            <span class="hljs-keyword">return</span> -EIO;
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"exfat"</span>) {
        <span class="hljs-keyword">if</span> (exfat::<span class="hljs-built_in">Mount</span>(mDevPath, mRawPath, AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number">0007</span>)) {
            <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to mount exfat"</span>;
            <span class="hljs-keyword">return</span> -EIO;
        }
    }

    <span class="hljs-comment">// 5. 设置挂载路径</span>
    <span class="hljs-built_in">setPath</span>(mRawPath);
    <span class="hljs-keyword">return</span> OK;
}
</code></pre>
<hr/>
<h2 data-id="heading-22">四、Netlink事件处理机制</h2>
<h3 data-id="heading-23">4.1 Netlink与Uevent</h3>
<p>Linux内核通过<strong>Netlink Socket</strong>向用户空间发送设备事件(Uevent)。Vold通过NetlinkManager监听这些事件,实现设备的热插拔检测。</p>
<p><strong>Uevent事件格式示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ACTION</span>=add
<span class="hljs-attr">DEVPATH</span>=/devices/platform/soc/<span class="hljs-number">7864900</span>.sdhci/mmc_host/mmc0/mmc0:<span class="hljs-number">0001</span>/block/mmcblk0
<span class="hljs-attr">SUBSYSTEM</span>=block
<span class="hljs-attr">MAJOR</span>=<span class="hljs-number">179</span>
<span class="hljs-attr">MINOR</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">DEVNAME</span>=mmcblk0
<span class="hljs-attr">DEVTYPE</span>=disk
</code></pre>
<h3 data-id="heading-24">4.2 NetlinkManager实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/NetlinkManager.cpp</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">NetlinkManager::start</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 创建Netlink socket</span>
    mSock = <span class="hljs-built_in">socket</span>(PF_NETLINK, SOCK_DGRAM | SOCK_CLOEXEC, NETLINK_KOBJECT_UEVENT);
    <span class="hljs-keyword">if</span> (mSock &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to create Netlink socket"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 2. 绑定到KOBJECT_UEVENT组</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_nl</span> addr;
    <span class="hljs-built_in">memset</span>(&amp;addr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(addr));
    addr.nl_family = AF_NETLINK;
    addr.nl_pid = <span class="hljs-built_in">getpid</span>();
    addr.nl_groups = <span class="hljs-number">0xFFFFFFFF</span>;  <span class="hljs-comment">// 接收所有组的事件</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">bind</span>(mSock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-built_in">sizeof</span>(addr)) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to bind Netlink socket"</span>;
        <span class="hljs-built_in">close</span>(mSock);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 3. 创建NetlinkHandler并启动监听线程</span>
    mHandler = <span class="hljs-keyword">new</span> <span class="hljs-built_in">NetlinkHandler</span>(mSock);
    <span class="hljs-keyword">if</span> (mHandler-&gt;<span class="hljs-built_in">start</span>()) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start NetlinkHandler"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-25">4.3 NetlinkHandler处理流程</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/NetlinkHandler.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NetlinkHandler::onEvent</span><span class="hljs-params">(NetlinkEvent* evt)</span> </span>{
    VolumeManager* vm = VolumeManager::<span class="hljs-built_in">Instance</span>();
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* subsys = evt-&gt;<span class="hljs-built_in">getSubsystem</span>();

    <span class="hljs-comment">// 只处理block子系统事件</span>
    <span class="hljs-keyword">if</span> (!subsys || <span class="hljs-built_in">strcmp</span>(subsys, <span class="hljs-string">"block"</span>) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 根据action类型分发</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* action = evt-&gt;<span class="hljs-built_in">getAction</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"add"</span>)) {
        <span class="hljs-comment">// 设备添加</span>
        vm-&gt;<span class="hljs-built_in">handleBlockEvent</span>(evt);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"remove"</span>)) {
        <span class="hljs-comment">// 设备移除</span>
        vm-&gt;<span class="hljs-built_in">handleBlockEvent</span>(evt);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"change"</span>)) {
        <span class="hljs-comment">// 设备变化(如SD卡写保护开关)</span>
        vm-&gt;<span class="hljs-built_in">handleBlockEvent</span>(evt);
    }
}
</code></pre>
<h3 data-id="heading-26">4.4 VolumeManager处理块设备事件</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VolumeManager.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VolumeManager::handleBlockEvent</span><span class="hljs-params">(NetlinkEvent* evt)</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mLock)</span></span>;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* devpath = evt-&gt;<span class="hljs-built_in">findParam</span>(<span class="hljs-string">"DEVPATH"</span>);
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* action = evt-&gt;<span class="hljs-built_in">getAction</span>();

    <span class="hljs-comment">// 解析设备号</span>
    <span class="hljs-type">int</span> major = std::<span class="hljs-built_in">stoi</span>(evt-&gt;<span class="hljs-built_in">findParam</span>(<span class="hljs-string">"MAJOR"</span>));
    <span class="hljs-type">int</span> minor = std::<span class="hljs-built_in">stoi</span>(evt-&gt;<span class="hljs-built_in">findParam</span>(<span class="hljs-string">"MINOR"</span>));
    <span class="hljs-type">dev_t</span> device = <span class="hljs-built_in">makedev</span>(major, minor);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"add"</span>)) {
        <span class="hljs-comment">// 1. 检查是否匹配DiskSource</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; source : mDiskSources) {
            <span class="hljs-keyword">if</span> (source-&gt;<span class="hljs-built_in">matches</span>(devpath)) {
                <span class="hljs-comment">// 2. 创建Disk对象</span>
                <span class="hljs-keyword">auto</span> disk = std::<span class="hljs-built_in">make_shared</span>&lt;android::vold::Disk&gt;(
                    eventPath, device, source-&gt;<span class="hljs-built_in">getNickname</span>(), source-&gt;<span class="hljs-built_in">getFlags</span>());

                <span class="hljs-comment">// 3. 添加到磁盘列表</span>
                <span class="hljs-built_in">handleDiskAdded</span>(disk);
                <span class="hljs-keyword">break</span>;
            }
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"remove"</span>)) {
        <span class="hljs-comment">// 移除对应的Disk</span>
        <span class="hljs-built_in">handleDiskRemoved</span>(device);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VolumeManager::handleDiskAdded</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;android::vold::Disk&gt;&amp; disk)</span> </span>{
    <span class="hljs-comment">// 1. 添加到mDisks列表</span>
    mDisks.<span class="hljs-built_in">push_back</span>(disk);

    <span class="hljs-comment">// 2. 创建Disk(读取分区表,创建Volume)</span>
    disk-&gt;<span class="hljs-built_in">create</span>();

    <span class="hljs-comment">// 3. 通知Framework</span>
    <span class="hljs-built_in">notifyEvent</span>(ResponseCode::DiskCreated,
                <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"%d"</span>, disk-&gt;<span class="hljs-built_in">getId</span>()));
}
</code></pre>
<hr/>
<h2 data-id="heading-27">五、Binder通信:Framework与Vold的桥梁</h2>
<h3 data-id="heading-28">5.1 VoldNativeService架构</h3>
<p>VoldNativeService是Vold对外提供服务的Binder接口实现:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VoldNativeService</span> : <span class="hljs-keyword">public</span> BinderService&lt;VoldNativeService&gt;,
                          <span class="hljs-keyword">public</span> os::BnVold {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">status_t</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">char</span> <span class="hljs-type">const</span>* <span class="hljs-title">getServiceName</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"vold"</span>; }

    <span class="hljs-comment">// Listener管理</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">setListener</span><span class="hljs-params">(<span class="hljs-type">const</span> android::sp&lt;android::os::IVoldListener&gt;&amp; listener)</span></span>;

    <span class="hljs-comment">// Volume操作</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">mount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">int32_t</span> mountFlags, <span class="hljs-type">int32_t</span> mountUserId,
                         <span class="hljs-type">const</span> android::sp&lt;android::os::IVoldMountCallback&gt;&amp; callback)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">unmount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">format</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">const</span> std::string&amp; fsType)</span></span>;

    <span class="hljs-comment">// Disk操作</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">partition</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; diskId, <span class="hljs-type">int32_t</span> partitionType, <span class="hljs-type">int32_t</span> ratio)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">forgetPartition</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; partGuid, <span class="hljs-type">const</span> std::string&amp; fsUuid)</span></span>;

    <span class="hljs-comment">// 用户管理</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserAdded</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId, <span class="hljs-type">int32_t</span> userSerial, <span class="hljs-type">int32_t</span> sharesStorageWithUserId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserRemoved</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserStarted</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserStopped</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;

    <span class="hljs-comment">// FBE加密</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">createUserStorageKeys</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId, <span class="hljs-type">bool</span> ephemeral)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">destroyUserStorageKeys</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">unlockCeStorage</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId, <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; secret)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">lockCeStorage</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;

    <span class="hljs-comment">// OBB管理</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">createObb</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sourcePath, <span class="hljs-type">int32_t</span> ownerGid,
                             std::string* _aidl_return)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">destroyObb</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId)</span></span>;

    <span class="hljs-comment">// 存储维护</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">fstrim</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fstrimFlags,
                          <span class="hljs-type">const</span> android::sp&lt;android::os::IVoldTaskListener&gt;&amp; listener)</span></span>;
};
</code></pre>
<h3 data-id="heading-29">5.2 StorageManagerService与Vold的交互</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43696c21256249c58a03870168b72178~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=hL2WpJyjebErTi0TjsUjAdvAlRw%3D" alt="04-05-sms-vold-interaction-sequence.png" loading="lazy"/></p>
<p><strong>完整的SD卡挂载流程</strong>:</p>
<h4 data-id="heading-30"><strong>阶段1: 设备检测(内核→Vold→Framework)</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/StorageManagerService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">IVoldListener</span> <span class="hljs-variable">mListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IVoldListener</span>.Stub() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDiskCreated</span><span class="hljs-params">(String diskId, <span class="hljs-type">int</span> flags)</span> {
        <span class="hljs-comment">// 1. 接收Vold通知:发现新磁盘</span>
        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">DiskInfo</span> <span class="hljs-variable">disk</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiskInfo</span>(diskId, flags);
            mDisks.put(diskId, disk);
        }
        <span class="hljs-comment">// 2. 通知监听器</span>
        mHandler.obtainMessage(H_DISK_SCANNED, disk).sendToTarget();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVolumeCreated</span><span class="hljs-params">(String volId, <span class="hljs-type">int</span> type, String diskId, String partGuid)</span> {
        <span class="hljs-comment">// 3. 接收Vold通知:发现新Volume</span>
        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">VolumeInfo</span> <span class="hljs-variable">vol</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VolumeInfo</span>(volId, type, disk, partGuid);
            mVolumes.put(volId, vol);
        }
        <span class="hljs-comment">// 4. 发送广播通知应用</span>
        mHandler.obtainMessage(H_VOLUME_STATE_CHANGED, vol).sendToTarget();
    }
};
</code></pre>
<h4 data-id="heading-31"><strong>阶段2: 挂载请求(Framework→Vold)</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// StorageManagerService.java</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mount</span><span class="hljs-params">(String volId)</span> {
    <span class="hljs-comment">// 1. 权限检查</span>
    enforcePermission(android.Manifest.permission.MOUNT_UNMOUNT_FILESYSTEMS);

    <span class="hljs-comment">// 2. 查找Volume</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">VolumeInfo</span> <span class="hljs-variable">vol</span> <span class="hljs-operator">=</span> findVolumeByIdOrThrow(volId);
    <span class="hljs-keyword">if</span> (vol.type == VolumeInfo.TYPE_PRIVATE || vol.type == VolumeInfo.TYPE_PUBLIC) {
        <span class="hljs-comment">// 3. 调用Vold挂载</span>
        <span class="hljs-keyword">try</span> {
            mVold.mount(vol.id, vol.mountFlags, vol.mountUserId,
                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">IVoldMountCallback</span>.Stub() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> status, PersistableBundle extras)</span> {
                    <span class="hljs-comment">// 挂载进度回调</span>
                }
            });
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Slog.wtf(TAG, e);
        }
    }
}
</code></pre>
<p><strong>VoldNativeService处理挂载请求</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.cpp</span>
<span class="hljs-function">binder::Status <span class="hljs-title">VoldNativeService::mount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">int32_t</span> mountFlags,
                                        <span class="hljs-type">int32_t</span> mountUserId,
                                        <span class="hljs-type">const</span> sp&lt;IVoldMountCallback&gt;&amp; callback)</span> </span>{
    ENFORCE_SYSTEM_OR_ROOT;

    <span class="hljs-comment">// 1. 查找Volume</span>
    <span class="hljs-keyword">auto</span> vol = VolumeManager::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">findVolume</span>(volId);
    <span class="hljs-keyword">if</span> (vol == <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">error</span>(<span class="hljs-string">"Failed to find volume "</span> + volId);
    }

    <span class="hljs-comment">// 2. 设置挂载参数</span>
    vol-&gt;<span class="hljs-built_in">setMountFlags</span>(mountFlags);
    vol-&gt;<span class="hljs-built_in">setMountUserId</span>(mountUserId);
    vol-&gt;<span class="hljs-built_in">setMountCallback</span>(callback);

    <span class="hljs-comment">// 3. 执行挂载</span>
    <span class="hljs-type">int</span> res = vol-&gt;<span class="hljs-built_in">mount</span>();
    <span class="hljs-keyword">if</span> (res != OK) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">error</span>(<span class="hljs-string">"Failed to mount "</span> + volId);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ok</span>();
}
</code></pre>
<h3 data-id="heading-32">5.3 事件通知机制</h3>
<p>Vold通过IVoldListener向Framework发送异步事件:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VoldNativeService::notifyDiskScanned</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; diskId, <span class="hljs-type">int</span> flags)</span> </span>{
    <span class="hljs-keyword">auto</span> listener = VolumeManager::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">getListener</span>();
    <span class="hljs-keyword">if</span> (listener) {
        listener-&gt;<span class="hljs-built_in">onDiskScanned</span>(diskId, flags);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VoldNativeService::notifyVolumeStateChanged</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">int</span> state)</span> </span>{
    <span class="hljs-keyword">auto</span> listener = VolumeManager::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">getListener</span>();
    <span class="hljs-keyword">if</span> (listener) {
        listener-&gt;<span class="hljs-built_in">onVolumeStateChanged</span>(volId, state);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-33">六、实战:Vold调试技巧</h2>
<h3 data-id="heading-34">6.1 查看Vold日志</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 实时查看Vold日志</span>
adb logcat -s vold:*

<span class="hljs-comment"># 2. 查看Vold错误日志</span>
adb logcat -s vold:E

<span class="hljs-comment"># 3. 查看特定Volume的日志</span>
adb logcat | grep <span class="hljs-string">"public:179:1"</span>
</code></pre>
<h3 data-id="heading-35">6.2 使用dumpsys分析存储状态</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看所有存储信息</span>
adb shell dumpsys mount

<span class="hljs-comment"># 2. 查看Disk列表</span>
adb shell dumpsys mount | grep <span class="hljs-string">"Disk:"</span>

<span class="hljs-comment"># 3. 查看Volume列表</span>
adb shell dumpsys mount | grep <span class="hljs-string">"Volume:"</span>
</code></pre>
<p><strong>dumpsys输出示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">Disks:
  disk:179:0 (SD卡):
    <span class="hljs-attr">flags</span>=kSd|kAdoptable
    <span class="hljs-attr">size</span>=<span class="hljs-number">31914983424</span>
    <span class="hljs-attr">sysPath</span>=/sys/devices/.../mmcblk0
    <span class="hljs-attr">devPath</span>=/dev/block/mmcblk0
    <span class="hljs-attr">nickname</span>=sdcard1
    volumes:
      public:179:1

Volumes:
  public:179:1 (SD卡):
    <span class="hljs-attr">type</span>=kPublic
    <span class="hljs-attr">diskId</span>=disk:<span class="hljs-number">179</span>:<span class="hljs-number">0</span>
    <span class="hljs-attr">partGuid</span>=<span class="hljs-number">00000000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">000000000000</span>
    <span class="hljs-attr">state</span>=kMounted
    <span class="hljs-attr">path</span>=/storage/<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>
    <span class="hljs-attr">internalPath</span>=/mnt/media_rw/<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>
    <span class="hljs-attr">fsType</span>=vfat
    <span class="hljs-attr">fsUuid</span>=<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>
    <span class="hljs-attr">fsLabel</span>=SD Card
</code></pre>
<h3 data-id="heading-36">6.3 手动触发Vold操作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 通过vdc(Vold Direct Command)手动挂载Volume</span>
adb shell vdc volume mount public:179:1

<span class="hljs-comment"># 2. 卸载Volume</span>
adb shell vdc volume unmount public:179:1

<span class="hljs-comment"># 3. 格式化Volume</span>
adb shell vdc volume format public:179:1 auto

<span class="hljs-comment"># 4. 分区Disk</span>
adb shell vdc volume partition disk:179:0 public

<span class="hljs-comment"># 5. 创建OBB Volume</span>
adb shell vdc volume mkobb /data/app/com.example/expansion.obb 1000
</code></pre>
<h3 data-id="heading-37">6.4 分析Netlink事件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 监听内核Uevent</span>
adb shell getevent -l /sys/kernel/uevent

<span class="hljs-comment"># 2. 手动触发coldboot</span>
adb shell <span class="hljs-string">"echo add &gt; /sys/block/mmcblk0/uevent"</span>

<span class="hljs-comment"># 3. 查看设备树</span>
adb shell <span class="hljs-built_in">ls</span> -R /sys/devices/platform/*/mmc_host
</code></pre>
<h3 data-id="heading-38">6.5 使用Systrace分析存储性能</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 追踪Vold的挂载流程</span>
systrace.py -t 10 -o trace.html <span class="hljs-built_in">sched</span> freq idle am wm gfx view binder_driver \
            hal dalvik disk pm ss database package_manager vold

<span class="hljs-comment"># 在Chrome中打开trace.html,搜索"vold"或"mount"关键字</span>
</code></pre>
<hr/>
<h2 data-id="heading-39">七、Android 15的Vold新特性</h2>
<h3 data-id="heading-40">7.1 增强的Adoptable Storage</h3>
<p>Android 15对可采用存储进行了优化:</p>
<ul>
<li><strong>更快的格式化速度</strong>: 使用<code>mkfs.ext4 -E lazy_itable_init,lazy_journal_init</code></li>
<li><strong>更好的性能</strong>: 默认启用<code>discard</code>和<code>noatime</code>挂载选项</li>
</ul>
<h3 data-id="heading-41">7.2 改进的FBE(File-Based Encryption)</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Android 15新增的FBE API</span>
<span class="hljs-function">binder::Status <span class="hljs-title">VoldNativeService::setCeStorageProtection</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId,
                                                          <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; secret)</span> </span>{
    <span class="hljs-comment">// 支持动态修改CE(Credential Encrypted)存储的保护密钥</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">translate</span>(<span class="hljs-built_in">fscrypt_set_ce_key_protection</span>(userId, secret));
}
</code></pre>
<h3 data-id="heading-42">7.3 FUSE Passthrough优化</h3>
<p>Android 15引入了FUSE Passthrough机制,减少FUSE带来的性能开销:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 启用FUSE Passthrough</span>
<span class="hljs-keyword">if</span> (android::base::<span class="hljs-built_in">GetBoolProperty</span>(<span class="hljs-string">"persist.sys.fuse.passthrough.enable"</span>, <span class="hljs-literal">false</span>)) {
    vol-&gt;<span class="hljs-built_in">enablePassthrough</span>();
}
</code></pre>
<hr/>
<h2 data-id="heading-43">八、常见问题与解决方案</h2>
<h3 data-id="heading-44">Q1: SD卡插入后无法识别</h3>
<p><strong>排查步骤</strong>:</p>
<ol>
<li>
<p>检查Vold日志是否收到uevent事件:</p>
<pre><code class="hljs language-bash" lang="bash">adb logcat -s vold:D | grep <span class="hljs-string">"handleBlockEvent"</span>
</code></pre>
</li>
<li>
<p>检查fstab是否配置了vold_managed:</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">cat</span> /vendor/etc/fstab* | grep vold_managed
</code></pre>
</li>
<li>
<p>检查SELinux权限:</p>
<pre><code class="hljs language-bash" lang="bash">adb shell getenforce  <span class="hljs-comment"># 应该是Enforcing</span>
adb logcat | grep <span class="hljs-string">"avc.*denied.*vold"</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-45">Q2: Volume挂载失败</h3>
<p><strong>常见原因</strong>:</p>
<ul>
<li>文件系统损坏:运行<code>fsck</code>检查</li>
<li>SELinux上下文错误:检查<code>/mnt/media_rw</code>的安全上下文</li>
<li>权限不足:确保Vold运行在root权限</li>
</ul>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 强制fsck检查</span>
adb shell vdc volume fsck public:179:1

<span class="hljs-comment"># 2. 重新格式化</span>
adb shell vdc volume format public:179:1 vfat

<span class="hljs-comment"># 3. 重启Vold</span>
adb shell stop vold &amp;&amp; adb shell start vold
</code></pre>
<h3 data-id="heading-46">Q3: Adoptable Storage性能差</h3>
<p><strong>优化建议</strong>:</p>
<ol>
<li>使用高速SD卡(UHS-I Class 10以上)</li>
<li>启用TRIM支持:
<pre><code class="hljs language-bash" lang="bash">adb shell sm set-force-adoptable <span class="hljs-literal">true</span>
</code></pre>
</li>
<li>定期运行fstrim:
<pre><code class="hljs language-bash" lang="bash">adb shell sm fstrim
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-47">总结</h2>
<p>本文深入剖析了Android 15的Vold存储管理框架,涵盖了以下核心内容:</p>
<ol>
<li><strong>架构设计</strong>: Vold采用分层架构,通过VolumeManager、NetlinkManager等核心组件实现存储管理</li>
<li><strong>启动流程</strong>: 从init进程启动到Binder服务就绪的完整流程</li>
<li><strong>Volume管理</strong>: Disk和Volume的组织关系,以及Volume的生命周期状态机</li>
<li><strong>事件处理</strong>: 基于Netlink的设备热插拔检测机制</li>
<li><strong>Binder通信</strong>: VoldNativeService与StorageManagerService的跨进程交互</li>
<li><strong>调试技巧</strong>: 使用logcat、dumpsys、vdc等工具分析存储问题</li>
</ol>
<p>Vold作为Android存储架构的核心,其设计体现了<strong>单一职责</strong>、<strong>分层解耦</strong>、<strong>事件驱动</strong>等优秀的软件工程思想。理解Vold的工作原理,对于进行存储相关的系统开发和问题排查至关重要。</p>
<p>在下一篇文章中,我们将深入探讨<strong>FUSE文件系统与Scoped Storage</strong>机制,分析MediaProvider如何通过FUSE实现应用的存储隔离和权限控制。</p>
<hr/>
<h2 data-id="heading-48">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdevices%2Fstorage" target="_blank" title="https://source.android.com/devices/storage" ref="nofollow noopener noreferrer">Android Storage Architecture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fandroid-15.0.0_r1%3Asystem%2Fvold%2F" target="_blank" title="https://cs.android.com/android/platform/superproject/+/android-15.0.0_r1:system/vold/" ref="nofollow noopener noreferrer">Vold Source Code (AOSP 15.0)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fsecurity%2Fencryption%2Ffile-based" target="_blank" title="https://source.android.com/security/encryption/file-based" ref="nofollow noopener noreferrer">Android File-Based Encryption</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdevices%2Fstorage%2Fadoptable" target="_blank" title="https://source.android.com/devices/storage/adoptable" ref="nofollow noopener noreferrer">Android Adoptable Storage</a></li>
</ul>
<hr/>
<h3 data-id="heading-49">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7596906923892228106" target="_blank" title="https://juejin.cn/post/7596906923892228106">上一篇：Android 15 显示子系统深度解析(三)：Vsync机制与显示性能优化实战</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Kotlin系列11】协程原理与实战（下）：Flow与Channel驯服异步数据流]]></title>    <link>https://juejin.cn/post/7597623395907829806</link>    <guid>https://juejin.cn/post/7597623395907829806</guid>    <pubDate>2026-01-21T11:49:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623395907829806" data-draft-id="7597640029574283315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Kotlin系列11】协程原理与实战（下）：Flow与Channel驯服异步数据流"/> <meta itemprop="keywords" content="Kotlin,Android,编程语言"/> <meta itemprop="datePublished" content="2026-01-21T11:49:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Kotlin系列11】协程原理与实战（下）：Flow与Channel驯服异步数据流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:49:23.000Z" title="Wed Jan 21 2026 11:49:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：异步数据流的烦恼</h2>
<p>假设你正在开发一个股票交易应用，需要实时显示股票价格：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统方式：轮询 + 回调</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StockMonitor</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMonitoring</span><span class="hljs-params">(symbol: <span class="hljs-type">String</span>, callback: (<span class="hljs-type">Double</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        timer.scheduleAtFixedRate(<span class="hljs-keyword">object</span> : TimerTask() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> {
                <span class="hljs-keyword">val</span> price = fetchStockPrice(symbol)
                callback(price)
            }
        }, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 每秒查询一次</span>
    }
}

<span class="hljs-comment">// 使用时</span>
stockMonitor.startMonitoring(<span class="hljs-string">"AAPL"</span>) { price -&gt;
    runOnUiThread {
        updateUI(price)
    }
}
</code></pre>
<p>这种方式有什么问题？</p>
<ol>
<li><strong>资源浪费</strong>：即使价格没变化也要轮询</li>
<li><strong>内存泄漏</strong>：忘记取消timer</li>
<li><strong>线程混乱</strong>：需要手动切换线程</li>
<li><strong>难以组合</strong>：监听多个股票？处理数据流？</li>
</ol>
<p><strong>Kotlin Flow</strong>优雅地解决了这些问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用Flow：响应式数据流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stockPriceFlow</span><span class="hljs-params">(symbol: <span class="hljs-type">String</span>)</span></span>: Flow&lt;<span class="hljs-built_in">Double</span>&gt; = flow {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">val</span> price = fetchStockPrice(symbol)
        emit(price)  <span class="hljs-comment">// 发射数据</span>
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 挂起1秒</span>
    }
}

<span class="hljs-comment">// 使用时</span>
lifecycleScope.launch {
    stockPriceFlow(<span class="hljs-string">"AAPL"</span>)
        .filter { it &gt; <span class="hljs-number">150.0</span> }  <span class="hljs-comment">// 过滤</span>
        .map { <span class="hljs-string">"$<span class="hljs-variable">$it</span>"</span> }         <span class="hljs-comment">// 转换</span>
        .collect { price -&gt;     <span class="hljs-comment">// 收集</span>
            updateUI(price)
        }
}  <span class="hljs-comment">// 自动取消，无需手动管理</span>
</code></pre>
<p><strong>优势明显</strong>：</p>
<ul>
<li>✅ 自动生命周期管理</li>
<li>✅ 线程自动切换</li>
<li>✅ 函数式操作符</li>
<li>✅ 背压处理</li>
</ul>
<p>本文将深入讲解Flow和Channel，让你彻底掌握协程的异步数据流处理。</p>
<h2 data-id="heading-1">Flow基础：响应式数据流</h2>
<h3 data-id="heading-2">什么是Flow？</h3>
<p><strong>Flow</strong>是Kotlin协程提供的<strong>异步数据流</strong>API，类似于RxJava的Observable，但：</p>
<ul>
<li><strong>基于协程</strong>：天然支持挂起函数</li>
<li><strong>冷流</strong>：只有收集时才开始执行</li>
<li><strong>结构化并发</strong>：自动管理生命周期</li>
<li><strong>背压支持</strong>：内置背压处理机制</li>
</ul>
<h3 data-id="heading-3">创建Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 1. flow构建器 - 最基础的方式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"Flow开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">1000</span>)
        emit(i)  <span class="hljs-comment">// 发射数据</span>
    }
}

<span class="hljs-comment">// 2. flowOf - 固定数据</span>
<span class="hljs-keyword">val</span> numbersFlow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 3. asFlow - 集合转Flow</span>
<span class="hljs-keyword">val</span> listFlow = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).asFlow()

<span class="hljs-comment">// 4. channelFlow - 支持并发发射</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">concurrentFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = channelFlow {
    launch {
        repeat(<span class="hljs-number">3</span>) {
            delay(<span class="hljs-number">1000</span>)
            send(it)  <span class="hljs-comment">// 使用send而非emit</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-4">收集Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> flow = simpleFlow()

    <span class="hljs-comment">// 收集方式1: collect - 最基础</span>
    flow.collect { value -&gt;
        println(<span class="hljs-string">"收到: <span class="hljs-variable">$value</span>"</span>)
    }

    <span class="hljs-comment">// 收集方式2: toList - 收集到列表</span>
    <span class="hljs-keyword">val</span> list = flow.toList()
    println(<span class="hljs-string">"列表: <span class="hljs-variable">$list</span>"</span>)

    <span class="hljs-comment">// 收集方式3: first - 只取第一个</span>
    <span class="hljs-keyword">val</span> first = flow.first()
    println(<span class="hljs-string">"第一个: <span class="hljs-variable">$first</span>"</span>)

    <span class="hljs-comment">// 收集方式4: reduce - 聚合</span>
    <span class="hljs-keyword">val</span> sum = flow.reduce { acc, value -&gt; acc + value }
    println(<span class="hljs-string">"总和: <span class="hljs-variable">$sum</span>"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Flow开始</span>
<span class="hljs-comment">// 收到: 1</span>
<span class="hljs-comment">// 收到: 2</span>
<span class="hljs-comment">// 收到: 3</span>
</code></pre>
<h3 data-id="heading-5">Flow是冷流</h3>
<p>Flow是<strong>冷流（Cold Stream）</strong>，意味着：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> flow = flow {
        println(<span class="hljs-string">"Flow开始执行"</span>)
        emit(<span class="hljs-number">1</span>)
        emit(<span class="hljs-number">2</span>)
    }

    println(<span class="hljs-string">"Flow创建完成"</span>)
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"准备收集"</span>)

    flow.collect { println(<span class="hljs-string">"值: <span class="hljs-variable">$it</span>"</span>) }
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Flow创建完成</span>
<span class="hljs-comment">// 准备收集（1秒后）</span>
<span class="hljs-comment">// Flow开始执行  ← 注意：这里才开始执行</span>
<span class="hljs-comment">// 值: 1</span>
<span class="hljs-comment">// 值: 2</span>
</code></pre>
<p><strong>冷流特点</strong>：</p>
<ul>
<li>只有调用<code>collect</code>才开始执行</li>
<li>每次收集都重新执行</li>
<li>不同收集器互不影响</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> flow = flow {
        println(<span class="hljs-string">"Flow执行"</span>)
        emit(Random.nextInt())
    }

    <span class="hljs-comment">// 两次收集，Flow执行两次</span>
    flow.collect { println(<span class="hljs-string">"收集器1: <span class="hljs-variable">$it</span>"</span>) }
    flow.collect { println(<span class="hljs-string">"收集器2: <span class="hljs-variable">$it</span>"</span>) }
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Flow执行</span>
<span class="hljs-comment">// 收集器1: 12345</span>
<span class="hljs-comment">// Flow执行  ← 再次执行</span>
<span class="hljs-comment">// 收集器2: 67890</span>
</code></pre>
<h2 data-id="heading-6">Flow操作符</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1efa5b1de154c179c17e6ce48092757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600962&amp;x-signature=l%2BXTShxo0tW8ySQK5ioMqOBMt0E%3D" alt="11-01-flow-operators.png" loading="lazy"/></p>
<h3 data-id="heading-7">转换操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// map - 转换每个元素</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
    emit(<span class="hljs-number">3</span>)
}.map { it * <span class="hljs-number">2</span> }
 .collect { println(it) }  <span class="hljs-comment">// 2, 4, 6</span>

<span class="hljs-comment">// filter - 过滤</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
    emit(<span class="hljs-number">3</span>)
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
 .collect { println(it) }  <span class="hljs-comment">// 2</span>

<span class="hljs-comment">// transform - 自定义转换（可以emit多次）</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}.transform { value -&gt;
    emit(<span class="hljs-string">"开始: <span class="hljs-variable">$value</span>"</span>)
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-string">"结束: <span class="hljs-variable">$value</span>"</span>)
}.collect { println(it) }
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 开始: 1</span>
<span class="hljs-comment">// 结束: 1</span>
<span class="hljs-comment">// 开始: 2</span>
<span class="hljs-comment">// 结束: 2</span>

<span class="hljs-comment">// flatMapConcat - 顺序展平</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .flatMapConcat { value -&gt;
        flow {
            emit(<span class="hljs-string">"<span class="hljs-variable">$value</span>-a"</span>)
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-string">"<span class="hljs-variable">$value</span>-b"</span>)
        }
    }
    .collect { println(it) }
<span class="hljs-comment">// 输出：1-a, 1-b, 2-a, 2-b, 3-a, 3-b</span>

<span class="hljs-comment">// flatMapMerge - 并发展平（最多并发数）</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .flatMapMerge(concurrency = <span class="hljs-number">2</span>) { value -&gt;
        flow {
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-string">"<span class="hljs-variable">$value</span>"</span>)
        }
    }
    .collect { println(it) }
<span class="hljs-comment">// 输出顺序不定（并发执行）</span>
</code></pre>
<h3 data-id="heading-8">限流操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// take - 只取前N个</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .take(<span class="hljs-number">3</span>)
    .collect { println(it) }  <span class="hljs-comment">// 1, 2, 3</span>

<span class="hljs-comment">// drop - 跳过前N个</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .drop(<span class="hljs-number">2</span>)
    .collect { println(it) }  <span class="hljs-comment">// 3, 4, 5</span>

<span class="hljs-comment">// debounce - 防抖（只取最后一个）</span>
flow {
    emit(<span class="hljs-number">1</span>)
    delay(<span class="hljs-number">90</span>)
    emit(<span class="hljs-number">2</span>)
    delay(<span class="hljs-number">90</span>)
    emit(<span class="hljs-number">3</span>)
    delay(<span class="hljs-number">1000</span>)
    emit(<span class="hljs-number">4</span>)
}.debounce(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 100ms内的连续emit，只保留最后一个</span>
 .collect { println(it) }  <span class="hljs-comment">// 3, 4</span>

<span class="hljs-comment">// sample - 采样（固定时间取一个）</span>
flow {
    repeat(<span class="hljs-number">10</span>) {
        emit(it)
        delay(<span class="hljs-number">110</span>)
    }
}.sample(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 每300ms采样一个</span>
 .collect { println(it) }  <span class="hljs-comment">// 0, 2, 5, 8</span>
</code></pre>
<h3 data-id="heading-9">组合操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// zip - 配对组合</span>
<span class="hljs-keyword">val</span> flow1 = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
<span class="hljs-keyword">val</span> flow2 = flowOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
flow1.zip(flow2) { a, b -&gt; <span class="hljs-string">"<span class="hljs-variable">$a</span>-<span class="hljs-variable">$b</span>"</span> }
    .collect { println(it) }  <span class="hljs-comment">// 1-A, 2-B, 3-C</span>

<span class="hljs-comment">// combine - 组合最新值（任一更新都emit）</span>
<span class="hljs-keyword">val</span> numbers = flow {
    emit(<span class="hljs-number">1</span>)
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-number">2</span>)
}
<span class="hljs-keyword">val</span> strings = flow {
    emit(<span class="hljs-string">"A"</span>)
    delay(<span class="hljs-number">150</span>)
    emit(<span class="hljs-string">"B"</span>)
}
numbers.combine(strings) { num, str -&gt; <span class="hljs-string">"<span class="hljs-variable">$num</span>-<span class="hljs-variable">$str</span>"</span> }
    .collect { println(it) }
<span class="hljs-comment">// 输出：1-A, 2-A, 2-B</span>
</code></pre>
<h3 data-id="heading-10">展平操作符对比</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// flatMapConcat - 顺序执行</span>
<span class="hljs-comment">// Flow1 → [a, b] → Flow2 → [c, d]</span>
<span class="hljs-comment">// 结果: a, b, c, d（顺序）</span>

<span class="hljs-comment">// flatMapMerge - 并发执行</span>
<span class="hljs-comment">// Flow1 → [a, b]</span>
<span class="hljs-comment">// Flow2 → [c, d]  并发</span>
<span class="hljs-comment">// 结果: a, c, b, d（乱序）</span>

<span class="hljs-comment">// flatMapLatest - 只保留最新</span>
<span class="hljs-comment">// Flow1 → [a, b]</span>
<span class="hljs-comment">// Flow2 → [c, d]  ← 新Flow取消旧Flow</span>
<span class="hljs-comment">// 结果: a, c, d（b被取消）</span>
</code></pre>
<h2 data-id="heading-11">异常处理</h2>
<h3 data-id="heading-12">catch操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"出错了！"</span>)
    emit(<span class="hljs-number">3</span>)  <span class="hljs-comment">// 不会执行</span>
}.<span class="hljs-keyword">catch</span> { e -&gt;
    println(<span class="hljs-string">"捕获异常: <span class="hljs-subst">${e.message}</span>"</span>)
    emit(-<span class="hljs-number">1</span>)  <span class="hljs-comment">// 可以发射默认值</span>
}.collect { println(it) }

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 捕获异常: 出错了！</span>
<span class="hljs-comment">// -1</span>
</code></pre>
<p><strong>注意</strong>：<code>catch</code>只能捕获<strong>上游</strong>的异常：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}.<span class="hljs-keyword">catch</span> { e -&gt;
    println(<span class="hljs-string">"不会执行"</span>)
}.collect { value -&gt;
    <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"这个异常catch捕获不到"</span>)
}
</code></pre>
<h3 data-id="heading-13">onCompletion</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}.onCompletion { cause -&gt;
    <span class="hljs-keyword">if</span> (cause != <span class="hljs-literal">null</span>) {
        println(<span class="hljs-string">"Flow异常完成: <span class="hljs-variable">$cause</span>"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"Flow正常完成"</span>)
    }
}.collect { println(it) }

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// Flow正常完成</span>
</code></pre>
<h3 data-id="heading-14">retry与retryWhen</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> attempts = <span class="hljs-number">0</span>

flow {
    attempts++
    println(<span class="hljs-string">"尝试 <span class="hljs-variable">$attempts</span>"</span>)
    <span class="hljs-keyword">if</span> (attempts &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">throw</span> IOException(<span class="hljs-string">"网络错误"</span>)
    }
    emit(<span class="hljs-string">"成功"</span>)
}.retry(<span class="hljs-number">3</span>) { cause -&gt;
    (cause <span class="hljs-keyword">is</span> IOException).also {
        <span class="hljs-keyword">if</span> (it) delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 重试前等待1秒</span>
    }
}.collect { println(it) }

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 尝试 1</span>
<span class="hljs-comment">// 尝试 2</span>
<span class="hljs-comment">// 尝试 3</span>
<span class="hljs-comment">// 成功</span>
</code></pre>
<h2 data-id="heading-15">线程切换与上下文</h2>
<h3 data-id="heading-16">flowOn操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    println(<span class="hljs-string">"Flow运行在: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    emit(fetchFromNetwork())
}.flowOn(Dispatchers.IO)  <span class="hljs-comment">// ← 上游运行在IO线程</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    loadData()
        .map { <span class="hljs-keyword">data</span> -&gt;
            println(<span class="hljs-string">"map运行在: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
            <span class="hljs-keyword">data</span>.uppercase()
        }
        .flowOn(Dispatchers.Default)  <span class="hljs-comment">// ← map运行在Default线程</span>
        .collect { <span class="hljs-keyword">data</span> -&gt;
            println(<span class="hljs-string">"collect运行在: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
            updateUI(<span class="hljs-keyword">data</span>)
        }  <span class="hljs-comment">// collect运行在Main线程</span>
}
</code></pre>
<p><strong>重要规则</strong>：</p>
<ul>
<li><code>flowOn</code>影响<strong>上游</strong>操作符</li>
<li>可以多次调用<code>flowOn</code>切换不同上下文</li>
<li><code>collect</code>运行在调用协程的上下文</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef6a9db4e9a743c6a3cc95863637d846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600962&amp;x-signature=EWF3piRAX%2F2%2BxoF7KzU4LmxFzWo%3D" alt="11-02-flow-threading.png" loading="lazy"/></p>
<h2 data-id="heading-17">StateFlow：可观察状态</h2>
<h3 data-id="heading-18">StateFlow vs Flow</h3>
<p><strong>StateFlow</strong>是Flow的特殊版本，特点：</p>
<ol>
<li><strong>热流</strong>：始终有值，立即发射当前状态</li>
<li><strong>状态保持</strong>：保存最新值</li>
<li><strong>去重</strong>：相同值不会重复发射</li>
<li><strong>线程安全</strong>：可以从多个协程读写</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StateFlow示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _count = MutableStateFlow(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> count: StateFlow&lt;<span class="hljs-built_in">Int</span>&gt; = _count.asStateFlow()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        _count.value++  <span class="hljs-comment">// 更新状态</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> viewModel = CounterViewModel()

<span class="hljs-comment">// 收集器1</span>
launch {
    viewModel.count.collect { count -&gt;
        println(<span class="hljs-string">"收集器1: <span class="hljs-variable">$count</span>"</span>)
    }
}

<span class="hljs-comment">// 收集器2</span>
launch {
    viewModel.count.collect { count -&gt;
        println(<span class="hljs-string">"收集器2: <span class="hljs-variable">$count</span>"</span>)
    }
}

viewModel.increment()  <span class="hljs-comment">// 两个收集器都会收到更新</span>
</code></pre>
<h3 data-id="heading-19">StateFlow的特点</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-string">"初始值"</span>)

<span class="hljs-comment">// 1. 立即发射当前值</span>
launch {
    stateFlow.collect { println(it) }  <span class="hljs-comment">// 立即输出：初始值</span>
}

<span class="hljs-comment">// 2. 去重（相同值不会重复emit）</span>
stateFlow.value = <span class="hljs-string">"新值"</span>   <span class="hljs-comment">// ✅ emit</span>
stateFlow.value = <span class="hljs-string">"新值"</span>   <span class="hljs-comment">// ❌ 不emit（值相同）</span>
stateFlow.value = <span class="hljs-string">"更新值"</span> <span class="hljs-comment">// ✅ emit</span>

<span class="hljs-comment">// 3. 获取当前值</span>
println(<span class="hljs-string">"当前值: <span class="hljs-subst">${stateFlow.value}</span>"</span>)
</code></pre>
<h3 data-id="heading-20">StateFlow实战：用户状态管理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserState</span> {
    <span class="hljs-keyword">object</span> Loading : UserState()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> user: User) : UserState()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UserState()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _userState = MutableStateFlow&lt;UserState&gt;(UserState.Loading)
    <span class="hljs-keyword">val</span> userState: StateFlow&lt;UserState&gt; = _userState.asStateFlow()

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
        _userState.value = UserState.Loading

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> user = api.fetchUser(userId)
            _userState.value = UserState.Success(user)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            _userState.value = UserState.Error(e.message ?: <span class="hljs-string">"未知错误"</span>)
        }
    }
}

<span class="hljs-comment">// ViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository
) : ViewModel() {
    <span class="hljs-keyword">val</span> userState = repository.userState
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
            initialValue = UserState.Loading
        )

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
        viewModelScope.launch {
            repository.loadUser(userId)
        }
    }
}

<span class="hljs-comment">// UI收集</span>
lifecycleScope.launch {
    viewModel.userState.collect { state -&gt;
        <span class="hljs-keyword">when</span> (state) {
            <span class="hljs-keyword">is</span> UserState.Loading -&gt; showLoading()
            <span class="hljs-keyword">is</span> UserState.Success -&gt; showUser(state.user)
            <span class="hljs-keyword">is</span> UserState.Error -&gt; showError(state.message)
        }
    }
}
</code></pre>
<h2 data-id="heading-21">SharedFlow：事件广播</h2>
<h3 data-id="heading-22">SharedFlow vs StateFlow</h3>






























<table><thead><tr><th align="left">特性</th><th align="left">StateFlow</th><th align="left">SharedFlow</th></tr></thead><tbody><tr><td align="left"><strong>保存值</strong></td><td align="left">✅ 保存最新值</td><td align="left">❌ 可配置（replay）</td></tr><tr><td align="left"><strong>立即发射</strong></td><td align="left">✅ 新收集器立即收到当前值</td><td align="left">❌ 只收到新事件</td></tr><tr><td align="left"><strong>去重</strong></td><td align="left">✅ 相同值不重复emit</td><td align="left">❌ 不去重</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">状态管理</td><td align="left">事件通知</td></tr></tbody></table>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SharedFlow示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventBus</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _events = MutableSharedFlow&lt;String&gt;()
    <span class="hljs-keyword">val</span> events: SharedFlow&lt;String&gt; = _events.asSharedFlow()

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span> {
        _events.emit(event)
    }
}

<span class="hljs-keyword">val</span> eventBus = EventBus()

<span class="hljs-comment">// 收集器1</span>
launch {
    eventBus.events.collect { event -&gt;
        println(<span class="hljs-string">"收集器1收到: <span class="hljs-variable">$event</span>"</span>)
    }
}

delay(<span class="hljs-number">100</span>)

<span class="hljs-comment">// 收集器2（稍后订阅）</span>
launch {
    eventBus.events.collect { event -&gt;
        println(<span class="hljs-string">"收集器2收到: <span class="hljs-variable">$event</span>"</span>)
    }
}

eventBus.sendEvent(<span class="hljs-string">"事件1"</span>)  <span class="hljs-comment">// 两个收集器都收到</span>
</code></pre>
<h3 data-id="heading-23">SharedFlow配置</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> sharedFlow = MutableSharedFlow&lt;<span class="hljs-built_in">Int</span>&gt;(
    replay = <span class="hljs-number">2</span>,        <span class="hljs-comment">// 保留最近2个值给新订阅者</span>
    extraBufferCapacity = <span class="hljs-number">10</span>,  <span class="hljs-comment">// 额外缓冲容量</span>
    onBufferOverflow = BufferOverflow.DROP_OLDEST  <span class="hljs-comment">// 缓冲满时丢弃最旧的</span>
)

<span class="hljs-comment">// 发射5个值</span>
repeat(<span class="hljs-number">5</span>) { sharedFlow.emit(it) }

<span class="hljs-comment">// 新订阅者会收到最近2个值（3和4）</span>
sharedFlow.collect { println(it) }  <span class="hljs-comment">// 3, 4, ...</span>
</code></pre>
<h3 data-id="heading-24">SharedFlow实战：Toast通知</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToastManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _toastMessages = MutableSharedFlow&lt;String&gt;(
        replay = <span class="hljs-number">0</span>,  <span class="hljs-comment">// 不保留历史消息</span>
        extraBufferCapacity = <span class="hljs-number">10</span>,
        onBufferOverflow = BufferOverflow.DROP_OLDEST
    )
    <span class="hljs-keyword">val</span> toastMessages: SharedFlow&lt;String&gt; = _toastMessages.asSharedFlow()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showToast</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// tryEmit不挂起，适合从非协程代码调用</span>
        _toastMessages.tryEmit(message)
    }
}

<span class="hljs-comment">// Activity中收集</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> toastManager = ToastManager()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        lifecycleScope.launch {
            toastManager.toastMessages.collect { message -&gt;
                Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MainActivity</span>, message, Toast.LENGTH_SHORT).show()
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-25">Channel：协程间通信</h2>
<h3 data-id="heading-26">Channel基础</h3>
<p><strong>Channel</strong>是协程之间通信的管道，类似于阻塞队列：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> channel = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()

<span class="hljs-comment">// 发送方协程</span>
launch {
    <span class="hljs-keyword">for</span> (x <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        println(<span class="hljs-string">"发送: <span class="hljs-variable">$x</span>"</span>)
        channel.send(x)  <span class="hljs-comment">// 挂起直到有接收方</span>
    }
    channel.close()  <span class="hljs-comment">// 关闭通道</span>
}

<span class="hljs-comment">// 接收方协程</span>
launch {
    <span class="hljs-keyword">for</span> (x <span class="hljs-keyword">in</span> channel) {  <span class="hljs-comment">// 迭代接收</span>
        println(<span class="hljs-string">"接收: <span class="hljs-variable">$x</span>"</span>)
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 模拟处理</span>
    }
}
</code></pre>
<h3 data-id="heading-27">Channel类型</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f1b0001690448dbdf5acb2f0dae610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600962&amp;x-signature=5HWwgmvCOB21wvx3NIRidju34n0%3D" alt="11-03-channel-types.png" loading="lazy"/></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. Rendezvous（默认）- 无缓冲</span>
<span class="hljs-keyword">val</span> channel1 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()
<span class="hljs-comment">// 发送方挂起，直到接收方ready</span>

<span class="hljs-comment">// 2. Buffered - 有缓冲</span>
<span class="hljs-keyword">val</span> channel2 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-number">10</span>)
<span class="hljs-comment">// 缓冲未满时不挂起</span>

<span class="hljs-comment">// 3. Unlimited - 无限缓冲</span>
<span class="hljs-keyword">val</span> channel3 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;(Channel.UNLIMITED)
<span class="hljs-comment">// send永不挂起（可能OOM）</span>

<span class="hljs-comment">// 4. Conflated - 保留最新</span>
<span class="hljs-keyword">val</span> channel4 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;(Channel.CONFLATED)
<span class="hljs-comment">// 只保留最新值，旧值被覆盖</span>
</code></pre>
<h3 data-id="heading-28">Channel vs Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Channel示例</span>
<span class="hljs-keyword">val</span> channel = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()
launch {
    channel.send(<span class="hljs-number">1</span>)
    channel.send(<span class="hljs-number">2</span>)
}
launch {
    println(channel.receive())  <span class="hljs-comment">// 1</span>
}
launch {
    println(channel.receive())  <span class="hljs-comment">// 2（被另一个协程接收）</span>
}

<span class="hljs-comment">// Flow示例</span>
<span class="hljs-keyword">val</span> flow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
launch {
    flow.collect { println(it) }  <span class="hljs-comment">// 1, 2</span>
}
launch {
    flow.collect { println(it) }  <span class="hljs-comment">// 1, 2（每个收集器独立）</span>
}
</code></pre>
<p><strong>对比</strong>：</p>






























<table><thead><tr><th align="left">特性</th><th align="left">Channel</th><th align="left">Flow</th></tr></thead><tbody><tr><td align="left"><strong>消费</strong></td><td align="left">热流，多消费者竞争</td><td align="left">冷流，每个收集器独立</td></tr><tr><td align="left"><strong>背压</strong></td><td align="left">通过缓冲和挂起</td><td align="left">内置背压处理</td></tr><tr><td align="left"><strong>关闭</strong></td><td align="left">需要手动关闭</td><td align="left">自动管理</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">协程间通信</td><td align="left">数据流处理</td></tr></tbody></table>
<h3 data-id="heading-29">Channel实战：生产者消费者</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 生产者</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produceNumbers</span><span class="hljs-params">()</span></span> = produce&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">var</span> x = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(x++)
        delay(<span class="hljs-number">100</span>)
    }
}

<span class="hljs-comment">// 消费者</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">squareNumbers</span><span class="hljs-params">(numbers: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> = produce&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">for</span> (x <span class="hljs-keyword">in</span> numbers) {
        send(x * x)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> numbers = produceNumbers()
    <span class="hljs-keyword">val</span> squares = squareNumbers(numbers)

    repeat(<span class="hljs-number">5</span>) {
        println(squares.receive())
    }

    coroutineContext.cancelChildren()  <span class="hljs-comment">// 取消所有</span>
}

<span class="hljs-comment">// 输出：1, 4, 9, 16, 25</span>
</code></pre>
<h3 data-id="heading-30">管道模式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 管道函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">pipeline</span><span class="hljs-params">(
    input: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">Int</span>&gt;
)</span></span> = produce&lt;String&gt; {
    <span class="hljs-keyword">for</span> (num <span class="hljs-keyword">in</span> input) {
        send(<span class="hljs-string">"Processed: <span class="hljs-variable">$num</span>"</span>)
    }
}

<span class="hljs-comment">// 使用管道</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> numbers = produce {
        repeat(<span class="hljs-number">5</span>) { send(it) }
    }

    <span class="hljs-keyword">val</span> processed = pipeline(numbers)

    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processed) {
        println(result)
    }
}
</code></pre>
<h2 data-id="heading-31">背压处理</h2>
<h3 data-id="heading-32">什么是背压？</h3>
<p><strong>背压（Backpressure）</strong>：生产者速度快于消费者时的处理策略。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 问题：生产快，消费慢</span>
flow {
    repeat(<span class="hljs-number">100</span>) {
        println(<span class="hljs-string">"发射: <span class="hljs-variable">$it</span>"</span>)
        emit(it)
        delay(<span class="hljs-number">10</span>)  <span class="hljs-comment">// 快速发射</span>
    }
}.collect { value -&gt;
    println(<span class="hljs-string">"收集: <span class="hljs-variable">$value</span>"</span>)
    delay(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 慢速收集</span>
}
</code></pre>
<h3 data-id="heading-33">Flow的背压策略</h3>
<h4 data-id="heading-34">1. buffer - 缓冲</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        delay(<span class="hljs-number">10</span>)
    }
}.buffer(<span class="hljs-number">50</span>)  <span class="hljs-comment">// 缓冲50个元素</span>
 .collect { value -&gt;
     delay(<span class="hljs-number">100</span>)
     println(value)
 }
</code></pre>
<h4 data-id="heading-35">2. conflate - 合并（只保留最新）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        delay(<span class="hljs-number">10</span>)
    }
}.conflate()  <span class="hljs-comment">// 消费慢时，跳过中间值</span>
 .collect { value -&gt;
     delay(<span class="hljs-number">100</span>)
     println(value)
 }
<span class="hljs-comment">// 输出可能是：0, 10, 20, ..., 90（跳过中间值）</span>
</code></pre>
<h4 data-id="heading-36">3. collectLatest - 只处理最新</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        delay(<span class="hljs-number">10</span>)
    }
}.collectLatest { value -&gt;
    println(<span class="hljs-string">"开始处理: <span class="hljs-variable">$value</span>"</span>)
    delay(<span class="hljs-number">100</span>)
    println(<span class="hljs-string">"处理完成: <span class="hljs-variable">$value</span>"</span>)  <span class="hljs-comment">// 可能被中断</span>
}
<span class="hljs-comment">// 输出：只有最后几个值被完整处理</span>
</code></pre>
<h3 data-id="heading-37">对比三种策略</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// buffer：缓冲所有，按顺序处理</span>
flow {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).forEach {
        delay(<span class="hljs-number">100</span>)
        emit(it)
    }
}.buffer()
 .collect {
     delay(<span class="hljs-number">300</span>)
     println(it)  <span class="hljs-comment">// 1, 2, 3, 4, 5（全部处理）</span>
 }

<span class="hljs-comment">// conflate：跳过中间值</span>
flow {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).forEach {
        delay(<span class="hljs-number">100</span>)
        emit(it)
    }
}.conflate()
 .collect {
     delay(<span class="hljs-number">300</span>)
     println(it)  <span class="hljs-comment">// 1, 4, 5（跳过2, 3）</span>
 }

<span class="hljs-comment">// collectLatest：只处理最新值</span>
flow {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).forEach {
        delay(<span class="hljs-number">100</span>)
        emit(it)
    }
}.collectLatest {
    println(<span class="hljs-string">"开始: <span class="hljs-variable">$it</span>"</span>)
    delay(<span class="hljs-number">300</span>)
    println(<span class="hljs-string">"完成: <span class="hljs-variable">$it</span>"</span>)  <span class="hljs-comment">// 只有5完成</span>
}
</code></pre>
<h2 data-id="heading-38">实战案例：实时搜索</h2>
<p>让我们构建一个实时搜索功能，结合debounce和distinctUntilChanged：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)

    <span class="hljs-comment">// 搜索结果Flow</span>
    <span class="hljs-keyword">val</span> searchResults: StateFlow&lt;List&lt;String&gt;&gt; = _searchQuery
        .debounce(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 防抖：300ms内的连续输入只取最后一次</span>
        .distinctUntilChanged()  <span class="hljs-comment">// 去重：相同查询不重复搜索</span>
        .filter { it.length &gt;= <span class="hljs-number">2</span> }  <span class="hljs-comment">// 过滤：至少2个字符</span>
        .flatMapLatest { query -&gt;  <span class="hljs-comment">// 切换：新查询取消旧查询</span>
            flow {
                emit(emptyList())  <span class="hljs-comment">// 先清空结果</span>
                emit(performSearch(query))  <span class="hljs-comment">// 执行搜索</span>
            }
        }
        .<span class="hljs-keyword">catch</span> { e -&gt;
            emit(emptyList())  <span class="hljs-comment">// 错误时返回空列表</span>
        }
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
            initialValue = emptyList()
        )

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateQuery</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        _searchQuery.value = query
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">performSearch</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
        delay(<span class="hljs-number">500</span>)  <span class="hljs-comment">// 模拟网络请求</span>
        <span class="hljs-keyword">return</span> listOf(<span class="hljs-string">"<span class="hljs-variable">$query</span> - 结果1"</span>, <span class="hljs-string">"<span class="hljs-variable">$query</span> - 结果2"</span>)
    }
}

<span class="hljs-comment">// UI层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: SearchViewModel <span class="hljs-keyword">by</span> viewModels()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        <span class="hljs-comment">// 监听输入</span>
        searchEditText.addTextChangedListener { text -&gt;
            viewModel.updateQuery(text.toString())
        }

        <span class="hljs-comment">// 收集结果</span>
        lifecycleScope.launch {
            viewModel.searchResults.collect { results -&gt;
                updateSearchResults(results)
            }
        }
    }
}
</code></pre>
<p><strong>这个实现的优势</strong>：</p>
<ol>
<li><strong>防抖</strong>：避免频繁搜索</li>
<li><strong>去重</strong>：相同查询不重复</li>
<li><strong>取消旧请求</strong>：新查询自动取消旧请求</li>
<li><strong>异常处理</strong>：错误时返回空列表</li>
<li><strong>自动管理</strong>：生命周期自动管理</li>
</ol>
<h2 data-id="heading-39">高级技巧</h2>
<h3 data-id="heading-40">1. 组合多个Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 场景：用户信息 + 好友列表 + 帖子列表</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userId = MutableStateFlow(<span class="hljs-string">"user123"</span>)

    <span class="hljs-keyword">val</span> profileData = combine(
        userId.flatMapLatest { id -&gt; loadUser(id) },
        userId.flatMapLatest { id -&gt; loadFriends(id) },
        userId.flatMapLatest { id -&gt; loadPosts(id) }
    ) { user, friends, posts -&gt;
        ProfileData(user, friends, posts)
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        initialValue = ProfileData.Loading
    )
}
</code></pre>
<h3 data-id="heading-41">2. Flow的测试</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowTest</span> {
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> `test flow emissions`<span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-keyword">val</span> flow = flow {
            emit(<span class="hljs-number">1</span>)
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-number">2</span>)
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-number">3</span>)
        }

        <span class="hljs-keyword">val</span> results = flow.toList()
        assertEquals(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>), results)
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> `test StateFlow`<span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">val</span> job = launch {
            stateFlow.emit(<span class="hljs-number">1</span>)
            delay(<span class="hljs-number">100</span>)
            stateFlow.emit(<span class="hljs-number">2</span>)
        }

        <span class="hljs-keyword">val</span> results = stateFlow.take(<span class="hljs-number">3</span>).toList()
        assertEquals(listOf(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>), results)

        job.cancel()
    }
}
</code></pre>
<h3 data-id="heading-42">3. 自定义操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义操作符：mapNotNull</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">mapNotNull</span><span class="hljs-params">(
    transform: <span class="hljs-type">suspend</span> (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>?
)</span></span>: Flow&lt;R&gt; = transform { value -&gt;
    transform(value)?.let { emit(it) }
}

<span class="hljs-comment">// 使用</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .mapNotNull { <span class="hljs-keyword">if</span> (it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) it * <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span> }
    .collect { println(it) }  <span class="hljs-comment">// 4, 8</span>
</code></pre>
<h2 data-id="heading-43">常见陷阱与最佳实践</h2>
<h3 data-id="heading-44">❌ 陷阱1：在collect中调用emit</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：collect中不能调用emit</span>
flow {
    emit(<span class="hljs-number">1</span>)
}.collect { value -&gt;
    emit(value * <span class="hljs-number">2</span>)  <span class="hljs-comment">// ❌ 编译错误</span>
}

<span class="hljs-comment">// ✅ 正确：使用transform</span>
flow {
    emit(<span class="hljs-number">1</span>)
}.transform { value -&gt;
    emit(value * <span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ transform中可以</span>
}.collect { println(it) }
</code></pre>
<h3 data-id="heading-45">❌ 陷阱2：忘记切换线程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：IO操作在Main线程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchFromNetwork()  <span class="hljs-comment">// ❌ 阻塞Main线程</span>
    emit(<span class="hljs-keyword">data</span>)
}

<span class="hljs-comment">// ✅ 正确：使用flowOn切换线程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchFromNetwork()
    emit(<span class="hljs-keyword">data</span>)
}.flowOn(Dispatchers.IO)  <span class="hljs-comment">// ✅ IO操作在IO线程</span>
</code></pre>
<h3 data-id="heading-46">❌ 陷阱3：StateFlow不会emit相同值</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-number">1</span>)

stateFlow.value = <span class="hljs-number">2</span>  <span class="hljs-comment">// ✅ emit</span>
stateFlow.value = <span class="hljs-number">2</span>  <span class="hljs-comment">// ❌ 不emit（值相同）</span>

<span class="hljs-comment">// 解决方案1：使用SharedFlow</span>
<span class="hljs-keyword">val</span> sharedFlow = MutableSharedFlow&lt;<span class="hljs-built_in">Int</span>&gt;()
sharedFlow.emit(<span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ emit</span>
sharedFlow.emit(<span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ 仍然emit</span>

<span class="hljs-comment">// 解决方案2：强制更新</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span> = System.currentTimeMillis())
<span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(State(<span class="hljs-number">1</span>))
stateFlow.value = State(<span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ emit（timestamp不同）</span>
</code></pre>
<h3 data-id="heading-47">✅ 最佳实践1：使用sealed class表示状态</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiState</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">object</span> Loading : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : UiState&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow&lt;UiState&lt;User&gt;&gt;(UiState.Loading)
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;UiState&lt;User&gt;&gt; = _uiState.asStateFlow()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _uiState.value = UiState.Loading
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> user = repository.loadUser()
                _uiState.value = UiState.Success(user)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _uiState.value = UiState.Error(e.message ?: <span class="hljs-string">"未知错误"</span>)
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-48">✅ 最佳实践2：使用stateIn转换Flow为StateFlow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 避免：每次collect都重新执行</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUsers</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;User&gt;&gt; = flow {
    emit(repository.getUsers())  <span class="hljs-comment">// 每次collect都查询数据库</span>
}

<span class="hljs-comment">// ✅ 推荐：使用stateIn共享结果</span>
<span class="hljs-keyword">val</span> users: StateFlow&lt;List&lt;User&gt;&gt; = loadUsers()
    .stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        initialValue = emptyList()
    )
</code></pre>
<h3 data-id="heading-49">✅ 最佳实践3：使用shareIn实现热流</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 场景：多个订阅者共享同一个网络请求</span>
<span class="hljs-keyword">val</span> sharedData: SharedFlow&lt;Data&gt; = flow {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchFromNetwork()  <span class="hljs-comment">// 只执行一次</span>
    emit(<span class="hljs-keyword">data</span>)
}.shareIn(
    scope = viewModelScope,
    started = SharingStarted.WhileSubscribed(),
    replay = <span class="hljs-number">1</span>  <span class="hljs-comment">// 新订阅者会收到最后一个值</span>
)
</code></pre>
<h2 data-id="heading-50">性能优化</h2>
<h3 data-id="heading-51">1. 选择合适的Flow类型</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 状态 → StateFlow</span>
<span class="hljs-keyword">val</span> userState: StateFlow&lt;User&gt; = ...

<span class="hljs-comment">// 事件 → SharedFlow</span>
<span class="hljs-keyword">val</span> clickEvents: SharedFlow&lt;<span class="hljs-built_in">Unit</span>&gt; = ...

<span class="hljs-comment">// 一次性数据流 → Flow</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;Data&gt; = flow { ... }
</code></pre>
<h3 data-id="heading-52">2. 使用buffer提高吞吐量</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 无buffer：生产者等待消费者</span>
flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        println(<span class="hljs-string">"发射: <span class="hljs-variable">$it</span>"</span>)
    }
}.collect { value -&gt;
    delay(<span class="hljs-number">10</span>)
    println(<span class="hljs-string">"收集: <span class="hljs-variable">$value</span>"</span>)
}
<span class="hljs-comment">// 总耗时：约1000ms（100 * 10ms）</span>

<span class="hljs-comment">// 有buffer：生产者不等待</span>
flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        println(<span class="hljs-string">"发射: <span class="hljs-variable">$it</span>"</span>)
    }
}.buffer(<span class="hljs-number">10</span>)
 .collect { value -&gt;
     delay(<span class="hljs-number">10</span>)
     println(<span class="hljs-string">"收集: <span class="hljs-variable">$value</span>"</span>)
 }
<span class="hljs-comment">// 总耗时：约100ms（并发执行）</span>
</code></pre>
<h3 data-id="heading-53">3. 避免不必要的操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 避免：多次map</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .map { it * <span class="hljs-number">2</span> }
    .map { it + <span class="hljs-number">1</span> }
    .map { it.toString() }

<span class="hljs-comment">// ✅ 推荐：合并操作</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .map { (it * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>).toString() }
</code></pre>
<h2 data-id="heading-54">小结</h2>
<p>本文深入讲解了Kotlin协程的高级特性Flow和Channel：</p>
<h3 data-id="heading-55">核心概念</h3>
<ol>
<li><strong>Flow</strong>：冷流，异步数据流，支持丰富的操作符</li>
<li><strong>StateFlow</strong>：热流，可观察状态，去重，线程安全</li>
<li><strong>SharedFlow</strong>：热流，事件广播，支持多订阅者</li>
<li><strong>Channel</strong>：协程间通信管道，支持多种缓冲策略</li>
</ol>
<h3 data-id="heading-56">关键技能</h3>
<ol>
<li><strong>创建Flow</strong>：flow、flowOf、asFlow、channelFlow</li>
<li><strong>转换操作符</strong>：map、filter、transform、flatMap</li>
<li><strong>异常处理</strong>：catch、onCompletion、retry</li>
<li><strong>背压处理</strong>：buffer、conflate、collectLatest</li>
<li><strong>线程切换</strong>：flowOn切换上下文</li>
<li><strong>状态管理</strong>：StateFlow保存状态</li>
</ol>
<h3 data-id="heading-57">最佳实践</h3>
<ul>
<li>✅ 使用sealed class表示UI状态</li>
<li>✅ 使用stateIn/shareIn共享Flow</li>
<li>✅ 合理选择Flow类型（StateFlow vs SharedFlow）</li>
<li>✅ 使用flowOn切换线程</li>
<li>✅ 使用catch处理异常</li>
<li>✅ 合理使用背压策略</li>
</ul>
<h3 data-id="heading-58">下期预告</h3>
<p>下一篇文章《函数式编程在Kotlin中的实践》将介绍：</p>
<ul>
<li><strong>高阶函数</strong>：函数作为参数和返回值</li>
<li><strong>Lambda表达式</strong>：简洁的函数式编程</li>
<li><strong>扩展函数</strong>：增强类的能力</li>
<li><strong>内联函数</strong>：性能优化</li>
<li><strong>函数式集合操作</strong>：map、filter、reduce</li>
</ul>
<h2 data-id="heading-59">练习题</h2>
<h3 data-id="heading-60">基础练习</h3>
<p><strong>练习1</strong>：实现一个倒计时Flow</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">countdownFlow</span><span class="hljs-params">(from: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 从from倒数到0，每秒发射一个值</span>
}
</code></pre>
<p><strong>练习2</strong>：实现一个温度转换Flow</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">celsiusToFahrenheit</span><span class="hljs-params">(celsius: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">Double</span>&gt;)</span></span>: Flow&lt;<span class="hljs-built_in">Double</span>&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 将摄氏度转换为华氏度</span>
}
</code></pre>
<h3 data-id="heading-61">进阶练习</h3>
<p><strong>练习3</strong>：实现一个带重试的网络请求Flow</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">flowWithRetry</span><span class="hljs-params">(
    maxRetries: <span class="hljs-type">Int</span> = <span class="hljs-number">3</span>,
    delayMillis: <span class="hljs-type">Long</span> = <span class="hljs-number">1000</span>,
    block: <span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">T</span>
)</span></span>: Flow&lt;T&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 失败时自动重试</span>
}
</code></pre>
<p><strong>练习4</strong>：实现一个聊天消息管理器</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatManager</span> {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 使用StateFlow管理消息列表</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 使用SharedFlow广播新消息事件</span>
}
</code></pre>
<h2 data-id="heading-62">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fflow.html" target="_blank" title="https://kotlinlang.org/docs/flow.html" ref="nofollow noopener noreferrer">Kotlin Flow官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%2Fstateflow-and-sharedflow" target="_blank" title="https://developer.android.com/kotlin/flow/stateflow-and-sharedflow" ref="nofollow noopener noreferrer">StateFlow和SharedFlow指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felizarov.medium.com%2Fkotlin-flows-and-coroutines-256260fb3bdb" target="_blank" title="https://elizarov.medium.com/kotlin-flows-and-coroutines-256260fb3bdb" ref="nofollow noopener noreferrer">Flow背压处理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow" target="_blank" title="https://developer.android.com/kotlin/flow" ref="nofollow noopener noreferrer">Android中的异步数据流</a></li>
</ul>
<hr/>
<p><strong>系列文章导航:</strong></p>
<ul>
<li>👉 上一篇: <a href="https://juejin.cn/post/7597266141912465454" target="_blank" title="https://juejin.cn/post/7597266141912465454">协程原理与实战（上）：结构化并发让异步编程不再是噩梦</a></li>
</ul>
<hr/>
<p><em>如果这篇文章对你有帮助,欢迎点赞、收藏、分享!有任何问题或建议,欢迎在评论区留言讨论。让我们一起学习,一起成长!</em></p>
<p><em>也欢迎访问我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>发现更多宝藏资源</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 系统调试技巧 —— 使用 uprobe_events 分析用户态的行为]]></title>    <link>https://juejin.cn/post/7597635202324889652</link>    <guid>https://juejin.cn/post/7597635202324889652</guid>    <pubDate>2026-01-21T12:41:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324889652" data-draft-id="7597650322408030260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 系统调试技巧 —— 使用 uprobe_events 分析用户态的行为"/> <meta itemprop="keywords" content="Android,Linux"/> <meta itemprop="datePublished" content="2026-01-21T12:41:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ADebugger"/> <meta itemprop="url" content="https://juejin.cn/user/1679709495362093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 系统调试技巧 —— 使用 uprobe_events 分析用户态的行为
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709495362093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ADebugger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:41:56.000Z" title="Wed Jan 21 2026 12:41:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在分析 Android 应用/系统的一些问题时，有时可能需要得知应用是否有直接或间接调用了系统的某个 native 函数，或调用某个函数时传入的参数情况。</p>
<h2 data-id="heading-1">uprobe_events 实战</h2>
<p>uprobe_events 是 Linux 内核提供的一种调试方案，可以跟踪一个用户态函数（或是函数内的某行代码）是否有被调用，以及函数入参等，详细介绍可阅览官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kernel.org%2Ftrace%2Fuprobetracer.html" target="_blank" title="https://docs.kernel.org/trace/uprobetracer.html" ref="nofollow noopener noreferrer">docs.kernel.org/trace/uprob…</a> ，本文主要关注如何快速使用 uprobe_events。</p>
<p>下面以跟踪系统内的进程都打开了什么文件为例，演示如何快速使用 uprobe_events。</p>
<h4 data-id="heading-2">step 1</h4>
<p>使用 readelf 获取 open64 函数在 libc.so 中的偏移量：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">flame:</span>/ # readelf -s /apex/com.android.runtime/lib64/bionic/libc.so | grep open64
   <span class="hljs-number">786</span>: <span class="hljs-number">000000000008</span>bc10   <span class="hljs-number">980</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> freopen64
   <span class="hljs-number">904</span>: <span class="hljs-number">000000000008</span>cb10   <span class="hljs-number">172</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> funopen64
  <span class="hljs-number">1154</span>: <span class="hljs-number">000000000007</span>a7f0   <span class="hljs-number">404</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> open64
  <span class="hljs-number">1225</span>: <span class="hljs-number">000000000008</span>b878   <span class="hljs-number">392</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> fopen64
  <span class="hljs-number">6160</span>: <span class="hljs-number">000000000007</span>a7f0   <span class="hljs-number">404</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> open64
  <span class="hljs-number">6652</span>: <span class="hljs-number">000000000008</span>b878   <span class="hljs-number">392</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> fopen64
  <span class="hljs-number">6653</span>: <span class="hljs-number">000000000008</span>bc10   <span class="hljs-number">980</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> freopen64
  <span class="hljs-number">6677</span>: <span class="hljs-number">000000000008</span>cb10   <span class="hljs-number">172</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> funopen64
</code></pre>
<p>可以看到偏移量为 0x7a7f0。</p>
<h4 data-id="heading-3">step 2</h4>
<p>在 /sys/kernel/tracing 目录下执行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'p:open_probe /apex/com.android.runtime/lib64/bionic/libc.so:0x7a7f0 pathname=+0(%x0):string'</span> &gt; uprobe_events
</code></pre>
<p>其中 [open_probe] 可以替换为其它字符串。+0(%x0):string 表示将 open64 函数的第一个参数作为字符串输出。open64 函数的实现如下，其第一个参数代表文件路径。</p>
<p>bionic/libc/bionic/open.cpp</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* pathname, <span class="hljs-type">int</span> flags, ...)</span> {
  <span class="hljs-type">mode_t</span> mode = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">if</span> (needs_mode(flags)) {
    va_list args;
    va_start(args, flags);
    mode = static_cast&lt;<span class="hljs-type">mode_t</span>&gt;(va_arg(args, <span class="hljs-type">int</span>));
    va_end(args);
  }

  <span class="hljs-keyword">return</span> FDTRACK_CREATE(__openat(AT_FDCWD, pathname, force_O_LARGEFILE(flags), mode));
}
__strong_alias(open64, open);
</code></pre>
<h4 data-id="heading-4">step 3</h4>
<p>在 /sys/kernel/tracing 目录下执行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 1 &gt; events/uprobes/enable
<span class="hljs-built_in">echo</span> 1 &gt; tracing_on
</code></pre>
<p>其中第一条命令表示打开 uprobe_events 跟踪点，第二条命令表示打开 Linux 内核 ftrace 输出开关。</p>
<h4 data-id="heading-5">step 4</h4>
<p>在 /sys/kernel/tracing 目录下执行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> trace_pipe | grep open_probe
</code></pre>
<p>从桌面启动一个 App，得到如下输出结果（节选）：</p>
<pre><code class="hljs language-ini" lang="ini">    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382490: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/present"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382534: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu0/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382546: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu1/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382556: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu2/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382564: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu3/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382573: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu4/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382581: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu5/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382589: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu6/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382597: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu7/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[007]</span> .... 17932.383114: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/class/kgsl/kgsl-3d0/gpu_model"</span>
</code></pre>
<p>可以看到 RenderThread open 了一些 cpu 和 gpu 有关的节点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[根Activity的启动流程（基于Android 11.0）]]></title>    <link>https://juejin.cn/post/7597650322408308788</link>    <guid>https://juejin.cn/post/7597650322408308788</guid>    <pubDate>2026-01-21T15:01:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408308788" data-draft-id="7590433626560036899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="根Activity的启动流程（基于Android 11.0）"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-01-21T15:01:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            根Activity的启动流程（基于Android 11.0）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:01:25.000Z" title="Wed Jan 21 2026 15:01:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前面我们分析了<a href="https://juejin.cn/post/7345662552959385609" target="_blank" title="https://juejin.cn/post/7345662552959385609">普通Activity的启动流程</a>，下面我们接着分析根Activity的启动流程，根Activity的启动流程相对更加复杂，里面涉及到应用进程的创建过程。</p>
<h3 data-id="heading-0">Launcher调起ATMS</h3>
<p>根Activity的启动流程的起点是从点击Launcher上一个未启动的应用的图标开始的。</p>
<blockquote>
<p>Launcher是系统的桌面，它也是一个应用，它通过<strong>PackageManagerService</strong>来获取已安装的所有应用程序的信息，然后通过列表的形式展示出来。</p>
</blockquote>
<p>Launcher的源码在<code>/packages/apps/Launcher3</code>路径下，点击桌面上某个应用的图标会调用com.android.launcher3.touch包路径下的ItemClickHandler的onClick()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemClickHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v, String sourceContainer)</span> {
        <span class="hljs-comment">// Make sure that rogue clicks don't get through while allapps is launching, or after the</span>
        <span class="hljs-comment">// view has detached (it's possible for this to happen if the view is removed mid touch).</span>
        <span class="hljs-keyword">if</span> (v.getWindowToken() == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-type">Launcher</span> <span class="hljs-variable">launcher</span> <span class="hljs-operator">=</span> Launcher.getLauncher(v.getContext());
        <span class="hljs-keyword">if</span> (!launcher.getWorkspace().isFinishedSwitchingState()) <span class="hljs-keyword">return</span>;

        <span class="hljs-type">Object</span> <span class="hljs-variable">tag</span> <span class="hljs-operator">=</span> v.getTag();
        <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> WorkspaceItemInfo) {
            onClickAppShortcut(v, (WorkspaceItemInfo) tag, launcher, sourceContainer);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> FolderInfo) {
            <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> FolderIcon) {
                onClickFolderIcon(v);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> AppInfo) {
            <span class="hljs-comment">//点击应用图标的跳转入口</span>
            startAppShortcutOrInfoActivity(v, (AppInfo) tag, launcher,
                    sourceContainer == <span class="hljs-literal">null</span> ? CONTAINER_ALL_APPS : sourceContainer);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> LauncherAppWidgetInfo) {
            <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> PendingAppWidgetHostView) {
                onClickPendingWidget((PendingAppWidgetHostView) v, launcher);
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAppShortcutOrInfoActivity</span><span class="hljs-params">(View v, ItemInfo item, Launcher launcher,
                                                       <span class="hljs-meta">@Nullable</span> String sourceContainer)</span> {
        ...
        launcher.startActivitySafely(v, intent, item, sourceContainer);
    }
}
</code></pre>
<p>startAppShortcutOrInfoActivity()方法调用了Launcher的startActivitySafely()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Launcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StatefulActivity</span>&lt;LauncherState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LauncherExterns</span>,
        Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;OverlayPlugin&gt;,
        LauncherOverlayCallbacks {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivitySafely</span><span class="hljs-params">(View v, Intent intent, ItemInfo item)</span> {
        ...
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.startActivitySafely(v, intent, item);
        ...
        <span class="hljs-keyword">return</span> success;
    }
}
</code></pre>
<p>里面调用了Launcher的父类的父类(BaseDraggingActivity)的startActivitySafely()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDraggingActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseActivity</span>
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnColorsChangedListener</span>, DisplayInfoChangeListener {

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivitySafely</span><span class="hljs-params">(View v, Intent intent, <span class="hljs-meta">@Nullable</span> ItemInfo item)</span> {
        ...
        startActivity(intent, optsBundle);
        ...
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p>BaseDraggingActivity的startActivitySafely()方法调用Activity的startActivity()方法，最终还是调用Activity的startActivityForResult()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-meta">@Nullable</span> Bundle options)</span> {
        ...
        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) {
            startActivityForResult(intent, -<span class="hljs-number">1</span>, options);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Note we want to go through this call for compatibility with</span>
            <span class="hljs-comment">// applications that may have overridden the method.</span>
            startActivityForResult(intent, -<span class="hljs-number">1</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivityForResult</span><span class="hljs-params">(<span class="hljs-meta">@RequiresPermission</span> Intent intent, <span class="hljs-type">int</span> requestCode,
                                       <span class="hljs-meta">@Nullable</span> Bundle options)</span> {
        <span class="hljs-keyword">if</span> (mParent == <span class="hljs-literal">null</span>) {
            ...
            Instrumentation.<span class="hljs-type">ActivityResult</span> <span class="hljs-variable">ar</span> <span class="hljs-operator">=</span>
                    mInstrumentation.execStartActivity(
                            <span class="hljs-built_in">this</span>, mMainThread.getApplicationThread(), mToken, <span class="hljs-built_in">this</span>,
                            intent, requestCode, options);
            ...
        } <span class="hljs-keyword">else</span> {
            ...
        }
    }
} 
</code></pre>
<p>后面的流程与普通Activity的启动流程一致，直到进入ActivityStackSupervisor的startSpecificActivity()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityStackSupervisor</span> {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">startSpecificActivity</span><span class="hljs-params">(ActivityRecord r, <span class="hljs-type">boolean</span> andResume, <span class="hljs-type">boolean</span> checkConfig)</span> {
        <span class="hljs-comment">//该activity所在的应用已经在运行了吗？</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">WindowProcessController</span> <span class="hljs-variable">wpc</span> <span class="hljs-operator">=</span>
                mService.getProcessController(r.processName, r.info.applicationInfo.uid);

        <span class="hljs-type">boolean</span> <span class="hljs-variable">knownToBeDead</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-comment">//wpc.hasThread()通过判断IApplicationThread是否被赋值，如果已赋值，即应用已运行， </span>
        <span class="hljs-comment">//应用已运行，则是普通Activity的启动流程，走realStartActivityLocked()方法</span>
        <span class="hljs-keyword">if</span> (wpc != <span class="hljs-literal">null</span> &amp;&amp; wpc.hasThread()) {
            <span class="hljs-keyword">try</span> {
                realStartActivityLocked(r, wpc, andResume, checkConfig);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">catch</span> (RemoteException e) {
                Slog.w(TAG, <span class="hljs-string">"Exception when starting activity "</span>
                        + r.intent.getComponent().flattenToShortString(), e);
            }

            <span class="hljs-comment">// If a dead object exception was thrown -- fall through to</span>
            <span class="hljs-comment">// restart the application.</span>
            knownToBeDead = <span class="hljs-literal">true</span>;
        }

        r.notifyUnknownVisibilityLaunchedForKeyguardTransition();

        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isTop</span> <span class="hljs-operator">=</span> andResume &amp;&amp; r.isTopRunningActivity();
        <span class="hljs-comment">//否则需要ATMS的startProcessAsync()方法请求创建进程</span>
        mService.startProcessAsync(r, knownToBeDead, isTop, isTop ? <span class="hljs-string">"top-activity"</span> : <span class="hljs-string">"activity"</span>);
    }
}
</code></pre>
<p>此时应用进程还不存在，需要调用ATMS的startProcessAsync()来创建应用进程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityTaskManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityTaskManager</span>.Stub {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcessAsync</span><span class="hljs-params">(ActivityRecord activity, <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">boolean</span> isTop, 
            String hostingType)</span> {
        ...
        <span class="hljs-comment">//通过发送消息来启动进程，避免在持有ATMS锁的情况下调用AMS可能发生的死锁</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> PooledLambda.obtainMessage(ActivityManagerInternal::startProcess,
                mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead,
                isTop, hostingType, activity.intent.getComponent());
        mH.sendMessage(m);
        ...
    }
}
</code></pre>
<p>这里使用Handler发送消息来启动进程，获取Message对象跟我们平时的使用方式不太一样，这里用到PooledLambda的obtainMessage()方法，实际就是调用了ActivityManagerInternal的startProcess()方法。</p>
<p>ActivityManagerInternal是一个抽象类，它是ActivityManager本地系统服务接口，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerInternal</span> {

    <span class="hljs-comment">/**
     * Starts a given process.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcess</span><span class="hljs-params">(String processName, ApplicationInfo info,
            <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">boolean</span> isTop, String hostingType, ComponentName hostingName)</span>;

}
</code></pre>
<p>ActivityManagerInternal的实现类为AMS的内部类LocalService，这样就把创建进程的请求传递给了AMS去处理。</p>
<blockquote>
<p>LocalServices可以理解为是一个公开缓存池，内部使用ArrayMap来存储本地服务对象。SystemServer进程中每个服务都可以通过LocalServices的addService()方法注册到LocalServices中，需要使用时通过LocalServices的getService()获取注册的本地服务。</p>
</blockquote>
<h3 data-id="heading-1">AMS请求Zygote创建进程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActivityManagerInternal</span> {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcess</span><span class="hljs-params">(String processName, ApplicationInfo info, <span class="hljs-type">boolean</span> knownToBeDead,
                                 <span class="hljs-type">boolean</span> isTop, String hostingType, ComponentName hostingName)</span> {
            ...
            startProcessLocked(processName, info, knownToBeDead, <span class="hljs-number">0</span> <span class="hljs-comment">/* intentFlags */</span>,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HostingRecord</span>(hostingType, hostingName, isTop),
                    ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, <span class="hljs-literal">false</span> <span class="hljs-comment">/* allowWhileBooting */</span>,
                    <span class="hljs-literal">false</span> <span class="hljs-comment">/* isolated */</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* keepIfLarge */</span>);
            ...
        }
    }

    <span class="hljs-keyword">final</span> ProcessRecord <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(String processName,
            ApplicationInfo info, <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">int</span> intentFlags,
            HostingRecord hostingRecord, <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">boolean</span> allowWhileBooting,
            <span class="hljs-type">boolean</span> isolated, <span class="hljs-type">boolean</span> keepIfLarge)</span> {
        <span class="hljs-keyword">return</span> mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags,
                hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, <span class="hljs-number">0</span> <span class="hljs-comment">/* isolatedUid */</span>,
                keepIfLarge, <span class="hljs-literal">null</span> <span class="hljs-comment">/* ABI override */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* entryPoint */</span>,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* entryPointArgs */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* crashHandler */</span>);
    }
}
</code></pre>
<p>startProcess()方法调用了startProcessLocked()方法，startProcessLocked()方法又调用了ProcessList的startProcessLocked()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessList</span> {

    <span class="hljs-keyword">final</span> ProcessRecord <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(String processName, ApplicationInfo info,
            <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">int</span> intentFlags, HostingRecord hostingRecord,
            <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">boolean</span> allowWhileBooting, <span class="hljs-type">boolean</span> isolated, <span class="hljs-type">int</span> isolatedUid,
            <span class="hljs-type">boolean</span> keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs,
            Runnable crashHandler)</span> {
        ...
        <span class="hljs-comment">//ProcessRecord记录每个进程的信息，进程名、uid等</span>
        ProcessRecord app;
        <span class="hljs-keyword">if</span> (!isolated) {
            app = getProcessRecordLocked(processName, info.uid, keepIfLarge);
            ...
        } <span class="hljs-keyword">else</span> {
            app = <span class="hljs-literal">null</span>;
        }
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span>
                startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride);
        ...
        <span class="hljs-keyword">return</span> success ? app : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, HostingRecord hostingRecord,
            <span class="hljs-type">int</span> zygotePolicyFlags, String abiOverride)</span> {
        <span class="hljs-keyword">return</span> startProcessLocked(app, hostingRecord, zygotePolicyFlags,
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* disableHiddenApiChecks */</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/* disableTestApiChecks */</span>,
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* mountExtStorageFull */</span>, abiOverride);
    }


    <span class="hljs-type">boolean</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, HostingRecord hostingRecord,
            <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">boolean</span> disableHiddenApiChecks, <span class="hljs-type">boolean</span> disableTestApiChecks,
            <span class="hljs-type">boolean</span> mountExtStorageFull, String abiOverride)</span> {
        ...
        <span class="hljs-comment">// 启动进程，成功就返回进程的的pid，失败就抛出RuntimeException</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">entryPoint</span> <span class="hljs-operator">=</span> <span class="hljs-string">"android.app.ActivityThread"</span>;
        
        <span class="hljs-keyword">return</span> startProcessLocked(hostingRecord, entryPoint, app, uid, gids,
                runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi,
                instructionSet, invokeWith, startTime); 
        ...
    }

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(HostingRecord hostingRecord, String entryPoint, ProcessRecord app,
            <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">int</span> mountExternal,
            String seInfo, String requiredAbi, String instructionSet, String invokeWith,
            <span class="hljs-type">long</span> startTime)</span> {
        ...
        <span class="hljs-keyword">if</span> (mService.mConstants.FLAG_PROCESS_START_ASYNC) {
            ...
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">final</span> Process.<span class="hljs-type">ProcessStartResult</span> <span class="hljs-variable">startResult</span> <span class="hljs-operator">=</span> startProcess(hostingRecord,
                        entryPoint, app,
                        uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo,
                        requiredAbi, instructionSet, invokeWith, startTime);
                handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,
                        startSeq, <span class="hljs-literal">false</span>);
            }
            ...
            <span class="hljs-keyword">return</span> app.pid &gt; <span class="hljs-number">0</span>;
        }
    }

    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startProcess</span><span class="hljs-params">(HostingRecord hostingRecord, String entryPoint,
            ProcessRecord app, <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> zygotePolicyFlags,
            <span class="hljs-type">int</span> mountExternal, String seInfo, String requiredAbi, String instructionSet,
            String invokeWith, <span class="hljs-type">long</span> startTime)</span> { 
        ...
        <span class="hljs-keyword">final</span> Process.ProcessStartResult startResult;
        <span class="hljs-keyword">if</span> (hostingRecord.usesWebviewZygote()) {
            startResult = startWebView(entryPoint,
                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,
                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,
                    app.info.dataDir, <span class="hljs-literal">null</span>, app.info.packageName, app.mDisabledCompatChanges,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{PROC_START_SEQ_IDENT + app.startSeq});
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hostingRecord.usesAppZygote()) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">AppZygote</span> <span class="hljs-variable">appZygote</span> <span class="hljs-operator">=</span> createAppZygoteForProcessIfNeeded(app);

            <span class="hljs-comment">// We can't isolate app data and storage data as parent zygote already did that.</span>
            startResult = appZygote.getProcess().start(entryPoint,
                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,
                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,
                    app.info.dataDir, <span class="hljs-literal">null</span>, app.info.packageName,
                    <span class="hljs-comment">/*zygotePolicyFlags=*/</span> ZYGOTE_POLICY_FLAG_EMPTY, isTopApp,
                    app.mDisabledCompatChanges, pkgDataInfoMap, whitelistedAppDataInfoMap,
                    <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{PROC_START_SEQ_IDENT + app.startSeq});
        } <span class="hljs-keyword">else</span> {
            startResult = Process.start(entryPoint,
                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,
                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,
                    app.info.dataDir, invokeWith, app.info.packageName, zygotePolicyFlags,
                    isTopApp, app.mDisabledCompatChanges, pkgDataInfoMap,
                    whitelistedAppDataInfoMap, bindMountAppsData, bindMountAppStorageDirs,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{PROC_START_SEQ_IDENT + app.startSeq});
        }
        <span class="hljs-keyword">return</span> startResult;
    }
}
</code></pre>
<p>在ProcessList中经过4个startProcessLocked()方法后，调用了startProcess()方法，在startProcess()方法里根据不同的参数调用不同的方法启动进程，继续跟进到Process的start()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Process</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ZygoteProcess</span> <span class="hljs-variable">ZYGOTE_PROCESS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteProcess</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> String processClass,
                                           <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> String niceName,
                                           <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-meta">@Nullable</span> <span class="hljs-type">int</span>[] gids,
                                           <span class="hljs-type">int</span> runtimeFlags,
                                           <span class="hljs-type">int</span> mountExternal,
                                           <span class="hljs-type">int</span> targetSdkVersion,
                                           <span class="hljs-meta">@Nullable</span> String seInfo,
                                           <span class="hljs-meta">@NonNull</span> String abi,
                                           <span class="hljs-meta">@Nullable</span> String instructionSet,
                                           <span class="hljs-meta">@Nullable</span> String appDataDir,
                                           <span class="hljs-meta">@Nullable</span> String invokeWith,
                                           <span class="hljs-meta">@Nullable</span> String packageName,
                                           <span class="hljs-type">int</span> zygotePolicyFlags,
                                           <span class="hljs-type">boolean</span> isTopApp,
                                           <span class="hljs-meta">@Nullable</span> <span class="hljs-type">long</span>[] disabledCompatChanges,
                                           <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                   pkgDataInfoMap,
                                           <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                   whitelistedDataInfoMap,
                                           <span class="hljs-type">boolean</span> bindMountAppsData,
                                           <span class="hljs-type">boolean</span> bindMountAppStorageDirs,
                                           <span class="hljs-meta">@Nullable</span> String[] zygoteArgs)</span> {
        <span class="hljs-keyword">return</span> ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,
                runtimeFlags, mountExternal, targetSdkVersion, seInfo,
                abi, instructionSet, appDataDir, invokeWith, packageName,
                zygotePolicyFlags, isTopApp, disabledCompatChanges,
                pkgDataInfoMap, whitelistedDataInfoMap, bindMountAppsData,
                bindMountAppStorageDirs, zygoteArgs);
    }
}
</code></pre>
<p>ZYGOTE_PROCESS是ZygoteProcess在Process类中的static final类型的实例，继续进入ZygoteProcess的start()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Process.ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> String processClass,
                                                  <span class="hljs-keyword">final</span> String niceName,
                                                  <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-meta">@Nullable</span> <span class="hljs-type">int</span>[] gids,
                                                  <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> mountExternal,
                                                  <span class="hljs-type">int</span> targetSdkVersion,
                                                  <span class="hljs-meta">@Nullable</span> String seInfo,
                                                  <span class="hljs-meta">@NonNull</span> String abi,
                                                  <span class="hljs-meta">@Nullable</span> String instructionSet,
                                                  <span class="hljs-meta">@Nullable</span> String appDataDir,
                                                  <span class="hljs-meta">@Nullable</span> String invokeWith,
                                                  <span class="hljs-meta">@Nullable</span> String packageName,
                                                  <span class="hljs-type">int</span> zygotePolicyFlags,
                                                  <span class="hljs-type">boolean</span> isTopApp,
                                                  <span class="hljs-meta">@Nullable</span> <span class="hljs-type">long</span>[] disabledCompatChanges,
                                                  <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                          pkgDataInfoMap,
                                                  <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                          whitelistedDataInfoMap,
                                                  <span class="hljs-type">boolean</span> bindMountAppsData,
                                                  <span class="hljs-type">boolean</span> bindMountAppStorageDirs,
                                                  <span class="hljs-meta">@Nullable</span> String[] zygoteArgs)</span> {
        ...
        <span class="hljs-comment">//startViaZygote，即为通过Zygote启动进程</span>
        <span class="hljs-keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,
                runtimeFlags, mountExternal, targetSdkVersion, seInfo,
                abi, instructionSet, appDataDir, invokeWith, <span class="hljs-comment">/*startChildZygote=*/</span> <span class="hljs-literal">false</span>,
                packageName, zygotePolicyFlags, isTopApp, disabledCompatChanges,
                pkgDataInfoMap, whitelistedDataInfoMap, bindMountAppsData,
                bindMountAppStorageDirs, zygoteArgs);
        ...
    }

    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startViaZygote</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> String processClass,
                                                      <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> String niceName,
                                                      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> gid,
                                                      <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] gids,
                                                      <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> mountExternal,
                                                      <span class="hljs-type">int</span> targetSdkVersion,
                                                      <span class="hljs-meta">@Nullable</span> String seInfo,
                                                      <span class="hljs-meta">@NonNull</span> String abi,
                                                      <span class="hljs-meta">@Nullable</span> String instructionSet,
                                                      <span class="hljs-meta">@Nullable</span> String appDataDir,
                                                      <span class="hljs-meta">@Nullable</span> String invokeWith,
                                                      <span class="hljs-type">boolean</span> startChildZygote,
                                                      <span class="hljs-meta">@Nullable</span> String packageName,
                                                      <span class="hljs-type">int</span> zygotePolicyFlags,
                                                      <span class="hljs-type">boolean</span> isTopApp,
                                                      <span class="hljs-meta">@Nullable</span> <span class="hljs-type">long</span>[] disabledCompatChanges,
                                                      <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                              pkgDataInfoMap,
                                                      <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                              whitelistedDataInfoMap,
                                                      <span class="hljs-type">boolean</span> bindMountAppsData,
                                                      <span class="hljs-type">boolean</span> bindMountAppStorageDirs,
                                                      <span class="hljs-meta">@Nullable</span> String[] extraArgs)</span>
            <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        <span class="hljs-comment">//创建argsForZygote </span>
        ArrayList&lt;String&gt; argsForZygote = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//存入uid、gid等参数</span>
        argsForZygote.add(<span class="hljs-string">"--runtime-args"</span>);
        argsForZygote.add(<span class="hljs-string">"--setuid="</span> + uid);
        argsForZygote.add(<span class="hljs-string">"--setgid="</span> + gid);

        ...

        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),
                    zygotePolicyFlags,
                    argsForZygote);
        }
    }
}
</code></pre>
<p>ZygoteProcess的start()方法中调用了startViaZygote()方法，即为通过Zygote来启动进程，该方法流程如下：</p>
<ol>
<li>新建参数列表argsForZygote，将应用进程的启动参数保存在argsForZygote中，包括uid、gid、targetSdkVersion、应用进程的启动文件（android.app.ActivityThread）等参数。</li>
<li>调用openZygoteSocketIfNeeded()方法，如果与Zygote进程的Socket连接未开启，则尝试开启，可能会产生阻塞和重试。连接调用的是ZygoteState的connect()方法，ZygoteState是ZygoteProcess的内部类。</li>
<li>调用zygoteSendArgsAndGetResult()方法，向Zygote进程发送参数列表，启动一个新的子进程并返回子进程的 pid。注意：当前实现将参数列表中的换行符替换为空格。</li>
</ol>
<p>先来看看openZygoteSocketIfNeeded()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-keyword">private</span> ZygoteState <span class="hljs-title function_">openZygoteSocketIfNeeded</span><span class="hljs-params">(String abi)</span> <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//尝试与PrimaryZygote建立Socket连接</span>
            attemptConnectionToPrimaryZygote();

            <span class="hljs-keyword">if</span> (primaryZygoteState.matches(abi)) {
                <span class="hljs-keyword">return</span> primaryZygoteState;
            }

            <span class="hljs-keyword">if</span> (mZygoteSecondarySocketAddress != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">//如果PrimaryZygote不匹配，试试SecondaryZygote</span>
                attemptConnectionToSecondaryZygote();

                <span class="hljs-keyword">if</span> (secondaryZygoteState.matches(abi)) {
                    <span class="hljs-keyword">return</span> secondaryZygoteState;
                }
            }
        } <span class="hljs-keyword">catch</span> (IOException ioe) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">"Error connecting to zygote"</span>, ioe);
        }

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">"Unsupported zygote ABI: "</span> + abi);
    }

    <span class="hljs-comment">/**
     * Creates a ZygoteState for the primary zygote if it doesn't exist or has been disconnected.
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attemptConnectionToPrimaryZygote</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (primaryZygoteState == <span class="hljs-literal">null</span> || primaryZygoteState.isClosed()) {
            primaryZygoteState =
                    ZygoteState.connect(mZygoteSocketAddress, mUsapPoolSocketAddress);

            maybeSetApiBlacklistExemptions(primaryZygoteState, <span class="hljs-literal">false</span>);
            maybeSetHiddenApiAccessLogSampleRate(primaryZygoteState);
        }
    }

    <span class="hljs-comment">/**
     * Creates a ZygoteState for the secondary zygote if it doesn't exist or has been disconnected.
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attemptConnectionToSecondaryZygote</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (secondaryZygoteState == <span class="hljs-literal">null</span> || secondaryZygoteState.isClosed()) {
            secondaryZygoteState =
                    ZygoteState.connect(mZygoteSecondarySocketAddress,
                            mUsapPoolSecondarySocketAddress);

            maybeSetApiBlacklistExemptions(secondaryZygoteState, <span class="hljs-literal">false</span>);
            maybeSetHiddenApiAccessLogSampleRate(secondaryZygoteState);
        }
    }
}
</code></pre>
<p>通过openZygoteSocketIfNeeded()方法打开与Zygote进程的Socket连接，里面有涉及到与PrimaryZygote和SecondaryZygote的连接，两个都是调用ZygoteState的connect()方法来创建一个与给定Zygote Socket地址的Socket连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteState</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> {

        <span class="hljs-comment">/**
         * 通过与指定的Zygote socket建立连接创建ZygoteState实例，并保存指定的USAP socket地址
         */</span>
        <span class="hljs-keyword">static</span> ZygoteState <span class="hljs-title function_">connect</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LocalSocketAddress zygoteSocketAddress,
                                   <span class="hljs-meta">@Nullable</span> LocalSocketAddress usapSocketAddress)</span>
                <span class="hljs-keyword">throws</span> IOException {

            DataInputStream zygoteInputStream;
            BufferedWriter zygoteOutputWriter;
            <span class="hljs-keyword">final</span> <span class="hljs-type">LocalSocket</span> <span class="hljs-variable">zygoteSessionSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalSocket</span>();

            <span class="hljs-keyword">if</span> (zygoteSocketAddress == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"zygoteSocketAddress can't be null"</span>);
            }

            <span class="hljs-keyword">try</span> {
                zygoteSessionSocket.connect(zygoteSocketAddress);
                zygoteInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(zygoteSessionSocket.getInputStream());
                zygoteOutputWriter =
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(
                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(zygoteSessionSocket.getOutputStream()),
                                Zygote.SOCKET_BUFFER_SIZE);
            } <span class="hljs-keyword">catch</span> (IOException ex) {
                <span class="hljs-keyword">try</span> {
                    zygoteSessionSocket.close();
                } <span class="hljs-keyword">catch</span> (IOException ignore) { }

                <span class="hljs-keyword">throw</span> ex;
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteState</span>(zygoteSocketAddress, usapSocketAddress,
                    zygoteSessionSocket, zygoteInputStream, zygoteOutputWriter,
                    getAbiList(zygoteOutputWriter, zygoteInputStream));
        }
    }
}
</code></pre>
<p>连接上Zygote进程后，会创建BufferedWriter和DataInputStream进行参数数据的传输与读取，最后将一系列参数封装成ZygoteState对象返回给zygoteSendArgsAndGetResult()方法。</p>
<p>接下来看看zygoteSendArgsAndGetResult()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-comment">//把参数列表发送给Zygote进程，启动新进程，并返回新进程的pid</span>
    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">zygoteSendArgsAndGetResult</span><span class="hljs-params">(
            ZygoteState zygoteState, <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-meta">@NonNull</span> ArrayList&lt;String&gt; args)</span>
            <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        ...
        <span class="hljs-keyword">if</span> (shouldAttemptUsapLaunch(zygotePolicyFlags, args)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> attemptUsapSendArgsAndGetResult(zygoteState, msgStr);
            } <span class="hljs-keyword">catch</span> (IOException ex) {
                <span class="hljs-comment">// If there was an IOException using the USAP pool we will log the error and</span>
                <span class="hljs-comment">// attempt to start the process through the Zygote.</span>
                Log.e(LOG_TAG, <span class="hljs-string">"IO Exception while communicating with USAP pool - "</span>
                        + ex.getMessage());
            }
        }

        <span class="hljs-keyword">return</span> attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);
    }


    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">attemptZygoteSendArgsAndGetResult</span><span class="hljs-params">(
            ZygoteState zygoteState, String msgStr)</span> <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">zygoteWriter</span> <span class="hljs-operator">=</span> zygoteState.mZygoteOutputWriter;
            <span class="hljs-keyword">final</span> <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">zygoteInputStream</span> <span class="hljs-operator">=</span> zygoteState.mZygoteInputStream;

            zygoteWriter.write(msgStr);
            zygoteWriter.flush();

            <span class="hljs-comment">// Always read the entire result from the input stream to avoid leaving</span>
            <span class="hljs-comment">// bytes in the stream for future process starts to accidentally stumble</span>
            <span class="hljs-comment">// upon.</span>
            Process.<span class="hljs-type">ProcessStartResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Process</span>.ProcessStartResult();
            <span class="hljs-comment">//读取zygoteInputStream中的值</span>
            result.pid = zygoteInputStream.readInt();
            result.usingWrapper = zygoteInputStream.readBoolean();

            <span class="hljs-keyword">if</span> (result.pid &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">"fork() failed"</span>);
            }

            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (IOException ex) {
            zygoteState.close();
            Log.e(LOG_TAG, <span class="hljs-string">"IO Exception while communicating with Zygote - "</span>
                    + ex.toString());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(ex);
        }
    }
} 
</code></pre>
<p>ZygoteProcess的attemptZygoteSendArgsAndGetResult()方法中使用ZygoteState中保存的BufferedWriter和DataInputStream来进行Socket通信，进行数据流的传输和读取，最后把pid和usingWrapper封装到ProcessStartResult中返回。</p>
<h3 data-id="heading-2">Zygote创建进程并执行ActivityThread的main()方法</h3>
<p>Android系统是基于Linux开发的，init进程是Linux系统用户进程的第一个进程，其它所有的用户进程都是init进程的子进程，Zygote进程也是由init进程创建的，Zygote启动之后会调用ZygoteInit的main()方法，我们先从main()方法来看Socket的创建和消息读取，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteInit</span> {

    <span class="hljs-comment">//这里是Zygote进程的入口，它创建了ZygoteServer，加载资源，并准备其他创建进程相关的事务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String argv[])</span> {
        <span class="hljs-type">ZygoteServer</span> <span class="hljs-variable">zygoteServer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        ...
        Runnable caller;
        <span class="hljs-keyword">try</span> {
            ...
            <span class="hljs-type">boolean</span> <span class="hljs-variable">startSystemServer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">zygoteSocketName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"zygote"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">abiList</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">enableLazyPreload</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; argv.length; i++) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"start-system-server"</span>.equals(argv[i])) {
                    startSystemServer = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"--enable-lazy-preload"</span>.equals(argv[i])) {
                    enableLazyPreload = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) {
                    abiList = argv[i].substring(ABI_LIST_ARG.length());
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) {
                    zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Unknown command line argument: "</span> + argv[i]);
                }
            }
            ...
            zygoteServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteServer</span>(isPrimaryZygote);

            <span class="hljs-keyword">if</span> (startSystemServer) {
                <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);

                <span class="hljs-comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
                <span class="hljs-comment">// child (system_server) process.</span>
                <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span>) {
                    r.run();
                    <span class="hljs-keyword">return</span>;
                }
            }

            Log.i(TAG, <span class="hljs-string">"Accepting command socket connections"</span>);

            <span class="hljs-comment">// The select loop returns early in the child process after a fork and</span>
            <span class="hljs-comment">// loops forever in the zygote.</span>
            <span class="hljs-comment">// runSelectLoop()方法在子进程中后会立即return，在Zygote中会loop forever</span>
            caller = zygoteServer.runSelectLoop(abiList);
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            Log.e(TAG, <span class="hljs-string">"System zygote died with exception"</span>, ex);
            <span class="hljs-keyword">throw</span> ex;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (zygoteServer != <span class="hljs-literal">null</span>) {
                zygoteServer.closeServerSocket();
            }
        }

        <span class="hljs-comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
        <span class="hljs-comment">// command.</span>
        <span class="hljs-comment">// 子进程的启动</span>
        <span class="hljs-keyword">if</span> (caller != <span class="hljs-literal">null</span>) {
            caller.run();
        }
    }
}
</code></pre>
<p>在main()方法中新建ZygoteServer实例对象，调用ZygoteServer的runSelectLoop()方法，runSelectLoop()方法在子进程中后会立即返回，在Zygote中会开启无限循环来监听Socket客户端发来的消息。</p>
<p>下面我们看看ZygoteServer的runSelectLoop()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteServer</span> {

    <span class="hljs-comment">//用Zygote server socket, USAP pool server socket和USAP pool event FD初始化Zygote Server</span>
    ZygoteServer(<span class="hljs-type">boolean</span> isPrimaryZygote) {
        mUsapPoolEventFD = Zygote.getUsapPoolEventFD();

        <span class="hljs-keyword">if</span> (isPrimaryZygote) {
            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);
            mUsapPoolSocket =
                    Zygote.createManagedSocketFromInitSocket(
                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);
        } <span class="hljs-keyword">else</span> {
            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);
            mUsapPoolSocket =
                    Zygote.createManagedSocketFromInitSocket(
                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);
        }

        mUsapPoolSupported = <span class="hljs-literal">true</span>;
        fetchUsapPoolPolicyProps();
    }


    <span class="hljs-comment">/**
     * Runs the zygote process's select loop. Accepts new connections as
     * they happen, and reads commands from connections one spawn-request's
     * worth at a time.
     */</span>
    Runnable <span class="hljs-title function_">runSelectLoop</span><span class="hljs-params">(String abiList)</span> {
        ArrayList&lt;FileDescriptor&gt; socketFDs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        socketFDs.add(mZygoteSocket.getFileDescriptor());
        peers.add(<span class="hljs-literal">null</span>);

        mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP;

        <span class="hljs-comment">//开启无限循环</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            ...
            <span class="hljs-type">int</span> pollReturnValue;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">//处理轮询状态，当pollFDs有事件到来则往下执行，否则阻塞在这里</span>
                pollReturnValue = Os.poll(pollFDs, pollTimeoutMs);
            } <span class="hljs-keyword">catch</span> (ErrnoException ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"poll failed"</span>, ex);
            }

            <span class="hljs-keyword">if</span> (pollReturnValue == <span class="hljs-number">0</span>) {
                mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP;
                mUsapPoolRefillAction = UsapPoolRefillAction.DELAYED;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">usapPoolFDRead</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
                <span class="hljs-comment">//倒序处理，即优先处理已建立连接的信息，后处理新建连接的请求</span>
                <span class="hljs-keyword">while</span> (--pollIndex &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 采用I/O多路复用epoll机制，当接收到客户端请求到来，则往下执行；否则跳出本次循环</span>
                    <span class="hljs-keyword">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">if</span> (pollIndex == <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// Zygote server socket</span>
                        <span class="hljs-comment">// pollIndex==0表示有新的客户端请求连接到来，调用Server Socket端的accept函数建立通信连接 </span>
                        <span class="hljs-comment">// Zygote进程与System Server进程建立了连接</span>
                        <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">newPeer</span> <span class="hljs-operator">=</span> acceptCommandPeer(abiList);
                        <span class="hljs-comment">// 加入到peers和fds, 即开始下一次监听</span>
                        peers.add(newPeer);
                        socketFDs.add(newPeer.getFileDescriptor());

                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) {
                        <span class="hljs-comment">// Session socket accepted from the Zygote server socket</span>
                        <span class="hljs-comment">// socket 连接成功之后从 Zygote 服务器的 socket 接受到的 Session socket</span>
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> peers.get(pollIndex);
                            <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> connection.processOneCommand(<span class="hljs-built_in">this</span>);

                            <span class="hljs-comment">// TODO (chriswailes): Is this extra check necessary?</span>
                            <span class="hljs-keyword">if</span> (mIsForkChild) {
                                ...
                                <span class="hljs-keyword">return</span> command;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-comment">// We're in the server - we should never have any commands to run.</span>
                                <span class="hljs-comment">// 如果不是fork子进程则关闭连接，删除当前fd消息</span>
                                <span class="hljs-keyword">if</span> (connection.isClosedByPeer()) {
                                    connection.closeSocket();
                                    peers.remove(pollIndex);
                                    socketFDs.remove(pollIndex);
                                }
                            }
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            ...
                        } <span class="hljs-keyword">finally</span> {
                            mIsForkChild = <span class="hljs-literal">false</span>;
                        }

                    } <span class="hljs-keyword">else</span> {
                        ...
                    }
                }

                ...
            }
            ...
        }
    }
}
</code></pre>
<p>runSelectLoop()方法中获取zygoteSendArgsAndGetResult()方法传输过来的应用进程的启动参数，即和Zygote进程建立起连接，其方法流程如下：</p>
<ol>
<li>开启Loop死循环监听Socket事件，没有连接时就阻塞在那里，当有连接到来时唤醒继续往下执行。</li>
<li>pollIndex==0 时，说明收到请求连接的事件，请求和Zygote建立Socket连接，调用acceptCommandPeer()方法创建ZygoteConnection对象，并调用ZygoteSocket的accept()方法建立Socket连接，然后添加到监听列表peers中，等待与该Socket有关的命令的到来。</li>
<li>pollIndex &lt; usapPoolEventFDIndex 时，表示是已经连接的Socket上的命令到来，此时调用ZygoteConnection的processOneCommand()方法来接收客户端传输过来的应用进程的启动参数，并执行进程创建工作，处理完后，就会断开与客户端的连接，并把用于连接的Socket从监听列表peers中移除。</li>
</ol>
<p>接着进入ZygoteConnection的processOneCommand()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteConnection</span> {

    <span class="hljs-comment">/**
     * Reads one start command from the command socket. If successful, a child is forked and a
     * {<span class="hljs-doctag">@code</span> Runnable} that calls the childs main method (or equivalent) is returned in the child
     * process. {<span class="hljs-doctag">@code</span> null} is always returned in the parent process (the zygote).
     * 
     * If the client closes the socket, an {<span class="hljs-doctag">@code</span> EOF} condition is set, which callers can test
     * for by calling {<span class="hljs-doctag">@code</span> ZygoteConnection.isClosedByPeer}.
     */</span>
    Runnable <span class="hljs-title function_">processOneCommand</span><span class="hljs-params">(ZygoteServer zygoteServer)</span> {
        String[] args;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 逐行读取客户端端通过Socket write过来的启动参数(字符串数组)</span>
            args = Zygote.readArgumentList(mSocketReader);
        } <span class="hljs-keyword">catch</span> (IOException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"IOException on command socket"</span>, ex);
        }

        ...

        <span class="hljs-type">int</span> pid;
        <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">childPipeFd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">serverPipeFd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 将参数解析成ZygoteArguments格式</span>
        <span class="hljs-type">ZygoteArguments</span> <span class="hljs-variable">parsedArgs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteArguments</span>(args);
        ...
        <span class="hljs-type">int</span>[][] rlimits = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (parsedArgs.mRLimits != <span class="hljs-literal">null</span>) {
            rlimits = parsedArgs.mRLimits.toArray(Zygote.INT_ARRAY_2D);
        }

        <span class="hljs-type">int</span>[] fdsToIgnore = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);
                childPipeFd = pipeFds[<span class="hljs-number">1</span>];
                serverPipeFd = pipeFds[<span class="hljs-number">0</span>];
                Os.fcntlInt(childPipeFd, F_SETFD, <span class="hljs-number">0</span>);
                fdsToIgnore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{childPipeFd.getInt$(), serverPipeFd.getInt$()};
            } <span class="hljs-keyword">catch</span> (ErrnoException errnoEx) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Unable to set up pipe for invoke-with"</span>, errnoEx);
            }
        }

        <span class="hljs-comment">// 将Client端fd和Server端fd存入fdsToClose数组中，然后fd置为null</span>
        <span class="hljs-type">int</span>[] fdsToClose = {-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>};

        <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> mSocket.getFileDescriptor();

        <span class="hljs-keyword">if</span> (fd != <span class="hljs-literal">null</span>) {
            fdsToClose[<span class="hljs-number">0</span>] = fd.getInt$();
        }

        fd = zygoteServer.getZygoteSocketFileDescriptor();

        <span class="hljs-keyword">if</span> (fd != <span class="hljs-literal">null</span>) {
            fdsToClose[<span class="hljs-number">1</span>] = fd.getInt$();
        }

        <span class="hljs-comment">// 调用Zygote的forkAndSpecialize()方法来fork子进程</span>
        pid = Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids,
                parsedArgs.mRuntimeFlags, rlimits, parsedArgs.mMountExternal, parsedArgs.mSeInfo,
                parsedArgs.mNiceName, fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,
                parsedArgs.mInstructionSet, parsedArgs.mAppDataDir, parsedArgs.mIsTopApp,
                parsedArgs.mPkgDataInfoList, parsedArgs.mWhitelistedDataInfoList,
                parsedArgs.mBindMountAppDataDirs, parsedArgs.mBindMountAppStorageDirs);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// pid == 0 表示创建成功，则进入子进程中，即应用程序进程</span>
                zygoteServer.setForkChild();
                <span class="hljs-comment">// 关闭 socket 连接</span>
                zygoteServer.closeServerSocket();
                IoUtils.closeQuietly(serverPipeFd);
                serverPipeFd = <span class="hljs-literal">null</span>;
                <span class="hljs-comment">// 进入子进程执行相关操作</span>
                <span class="hljs-keyword">return</span> handleChildProc(parsedArgs, childPipeFd, parsedArgs.mStartChildZygote);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span>
                <span class="hljs-comment">// handleParentProc.</span>
                <span class="hljs-comment">// pid &lt; 0表示创建失败，则进入父进程返回消息给Client Socket表示启动失败</span>
                IoUtils.closeQuietly(childPipeFd);
                childPipeFd = <span class="hljs-literal">null</span>;
                <span class="hljs-comment">// 进入父进程执行相关操作</span>
                handleParentProc(pid, serverPipeFd);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        } <span class="hljs-keyword">finally</span> {
            IoUtils.closeQuietly(childPipeFd);
            IoUtils.closeQuietly(serverPipeFd);
        }
    }
}
</code></pre>
<p>该方法主要作用如下：</p>
<ol>
<li>读取SystemServer端Socket写入的数据，并将存入字符串数组的数据封装成ZygoteArguments格式。</li>
<li>调用Zygote的forkAndSpecialize()方法来fork子进程，并返回pid，这里的pid并非是进程id，而是返回结果值，0 表示创建成功，-1 表示创建失败。</li>
<li>子进程创建成功后进入子进程执行。</li>
</ol>
<p>看看Zygote的forkAndSpecialize()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Zygote</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">forkAndSpecialize</span><span class="hljs-params">(<span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags,
                                 <span class="hljs-type">int</span>[][] rlimits, <span class="hljs-type">int</span> mountExternal, String seInfo, String niceName, <span class="hljs-type">int</span>[] fdsToClose,
                                 <span class="hljs-type">int</span>[] fdsToIgnore, <span class="hljs-type">boolean</span> startChildZygote, String instructionSet, String appDataDir,
                                 <span class="hljs-type">boolean</span> isTopApp, String[] pkgDataInfoList, String[] whitelistedDataInfoList,
                                 <span class="hljs-type">boolean</span> bindMountAppDataDirs, <span class="hljs-type">boolean</span> bindMountAppStorageDirs)</span> {
        ZygoteHooks.preFork();
        <span class="hljs-comment">//通过JNI调用native层方法</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> nativeForkAndSpecialize(
                uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,
                fdsToIgnore, startChildZygote, instructionSet, appDataDir, isTopApp,
                pkgDataInfoList, whitelistedDataInfoList, bindMountAppDataDirs,
                bindMountAppStorageDirs);
        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// Note that this event ends at the end of handleChildProc,</span>
            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">"PostFork"</span>);
            <span class="hljs-comment">// If no GIDs were specified, don't make any permissions changes based on groups.</span>
            <span class="hljs-keyword">if</span> (gids != <span class="hljs-literal">null</span> &amp;&amp; gids.length &gt; <span class="hljs-number">0</span>) {
                NetworkUtils.setAllowNetworkingForProcess(containsInetGid(gids));
            }
        }
        <span class="hljs-comment">// Set the Java Language thread priority to the default value for new apps.</span>
        Thread.currentThread().setPriority(Thread.NORM_PRIORITY);
        ZygoteHooks.postForkCommon();
        <span class="hljs-keyword">return</span> pid;
    }
}  
</code></pre>
<p>方法中调用native层的nativeForkAndSpecialize()方法创建进程，然后返回进程的pid（父进程中，返回新建的子进程的pid，子进程中，则返回 0，出现错误时返回负数），具体native层的源码就不跟了，大致过程如下：</p>
<ol>
<li>调用Linux的fork()方法创建进程，设置进程的主线程的name，如果是null或者SystemServer，则为 SystemServer。</li>
<li>调用CallStaticVoidMethod()方法返回Zygote的callPostForkChildHooks()方法处理fork子线程之后的gc/线程池管理等操作。</li>
</ol>
<p>进入ZygoteConnection的handleChildProc()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteConnection</span> {

    <span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">handleChildProc</span><span class="hljs-params">(ZygoteArguments parsedArgs,
                                     FileDescriptor pipeFd, <span class="hljs-type">boolean</span> isZygote)</span> {
        <span class="hljs-comment">//关闭Socket连接</span>
        closeSocket();
        <span class="hljs-comment">// 设置应用进程名</span>
        Zygote.setAppProcessName(parsedArgs, TAG);

        <span class="hljs-comment">// End of the postFork event.</span>
        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
        <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span>) {
            WrapperInit.execApplication(parsedArgs.mInvokeWith,
                    parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,
                    VMRuntime.getCurrentInstructionSet(),
                    pipeFd, parsedArgs.mRemainingArgs);

            <span class="hljs-comment">// Should not get here.</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"WrapperInit.execApplication unexpectedly returned"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (!isZygote) {
                <span class="hljs-keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,
                        parsedArgs.mDisabledCompatChanges,
                        parsedArgs.mRemainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.mTargetSdkVersion,
                        parsedArgs.mRemainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);
            }
        }
    }
}
</code></pre>
<p>该方法就是进入子进程执行不同的初始化操作，因为已经fork()成功，关闭Socket连接等释放资源，设置应用进程名，最后调用ZygoteInit的zygoteInit()方法初始化Zygote：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteInit</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Runnable <span class="hljs-title function_">zygoteInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,
                                            String[] argv, ClassLoader classLoader)</span> {
        ...
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">"ZygoteInit"</span>);
        RuntimeInit.redirectLogStreams();
        <span class="hljs-comment">//进程初始化配置，如设置异常捕获Handler、时区、重置LogManager等等</span>
        RuntimeInit.commonInit();
        <span class="hljs-comment">//native层初始化--打开/dev/binder驱动，映射内核的地址空间，创建binder线程用于IPC通信</span>
        ZygoteInit.nativeZygoteInit();
        <span class="hljs-keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,
                classLoader);
    }

}
</code></pre>
<p>zygoteInit()方法流程如下：</p>
<ol>
<li>日志流重定向，将系统输出和系统错误重定向到Android日志。</li>
<li>进程初始化配置，如设置异常捕获Handler、时区、重置LogManager等等。</li>
<li>native层初始化，打开/dev/binder驱动，映射内核的地址空间，创建Binder线程用于IPC通信。</li>
<li>调用RuntimeInit的applicationInit()方法，返回创建的Runnable对象。</li>
</ol>
<p>接下来执行RuntimeInit的applicationInit()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeInit</span> {

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">applicationInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,
                                              String[] argv, ClassLoader classLoader)</span> {
        <span class="hljs-comment">//如果应用程序调用了System.exit()方法立即终止进程，可能会导致剩余的运行线程在进程实际退出之前崩溃</span>
        nativeSetExitWithoutCleanup(<span class="hljs-literal">true</span>);

        VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);
        VMRuntime.getRuntime().setDisabledCompatChanges(disabledCompatChanges);

        <span class="hljs-keyword">final</span> <span class="hljs-type">Arguments</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arguments</span>(argv);

        <span class="hljs-comment">// The end of of the RuntimeInit event (see #zygoteInit).</span>
        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);

        <span class="hljs-comment">// Remaining arguments are passed to the start class's static main</span>
        <span class="hljs-keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">findStaticMain</span><span class="hljs-params">(String className, String[] argv,
                                             ClassLoader classLoader)</span> {
        <span class="hljs-comment">// 待加载的类，这里是指ActivityThread，</span>
        <span class="hljs-comment">// 就是前面ProcessList的startProcessLocked()中的 String entryPoint = "android.app.ActivityThread"</span>
        Class&lt;?&gt; cl;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 加载 android.app.ActivityThread 类</span>
            cl = Class.forName(className, <span class="hljs-literal">true</span>, classLoader);
        } <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Missing class when invoking static main "</span> + className, ex);
        }

        Method m;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取ActivityThread的main()函数</span>
            m = cl.getMethod(<span class="hljs-string">"main"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String[].class});
        } <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Missing static main on "</span> + className, ex);
        } <span class="hljs-keyword">catch</span> (SecurityException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Problem getting static main on "</span> + className, ex);
        }
        <span class="hljs-comment">// 判断main()方法是不是 public static 类型 </span>
        <span class="hljs-type">int</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> m.getModifiers();
        <span class="hljs-keyword">if</span> (!(Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Main method is not public and static on "</span> + className);
        }
        <span class="hljs-comment">// 返回 Caller，即本小节第一部分的 ZygoteInit.main() 中的 caller </span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAndArgsCaller</span>(m, argv);
    }
} 
</code></pre>
<p>applicationInit()方法中首先做了一个System.exit()的保护，防止退出进程时发生Crash，设置 targetSDKVersion 等参数，最后调用findStaticMain()方法去加载ActivityThread类以及方法。 findStaticMain()方法中通过ClassLoader加载获取目标类ActivityThread，后获取其静态main()方法，然后封装成MethodAndArgsCaller对象返回，MethodAndArgsCaller实现了Runnable接口。即ZygoteInit的main()方法的 caller，如果caller != null 会调用这个caller的run()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeInit</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodAndArgsCaller</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-comment">/** method to call */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;
        
        <span class="hljs-comment">/** argument array */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] mArgs;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodAndArgsCaller</span><span class="hljs-params">(Method method, String[] args)</span> {
            mMethod = method;
            mArgs = args;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{mArgs});
            } <span class="hljs-keyword">catch</span> (IllegalAccessException ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);
            } <span class="hljs-keyword">catch</span> (InvocationTargetException ex) { 
                ...
            }
        }
    }
} 
</code></pre>
<p>MethodAndArgsCaller的run()方法中使用了invoke反射调用，至此ActivityThread的main()方法得以执行，应用进程也就成功启动了ActivityThread。</p>
<p>Zygote进程启动流程：</p>
<ol>
<li>init进程为用户空间（相对于内核空间）的第一个进程，通过解析init.rc启动Zygote进程。</li>
<li>Zygote进程启动步骤：创建虚拟机、注册JNI、执行 ZygoteInit的main()方法。</li>
<li>Zygote进程启动SystemServer进程（Zygote启动的第一个进程），这个本小节没有具体分析。</li>
<li>Zygote创建Socket连接通道，阻塞并等待新建进程的指令到来，收到指令后通过fork新建用户进程。</li>
<li>Zygote新加了一个优化进程创建的机制，UsapPool——池化机制，我跟了一下源码，是预先缓存了几个进程。</li>
</ol>
<h3 data-id="heading-3">根Activity的启动</h3>
<p><strong>ActivityThread</strong>运行在主线程中，ActivityThread的入口是它的main()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClientTransactionHandler</span> {
    <span class="hljs-comment">//初始化ApplicationThread </span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">ApplicationThread</span> <span class="hljs-variable">mAppThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationThread</span>();
    <span class="hljs-comment">//初始化Handler，给ApplicationThread与ActivityThread通信使用 </span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">H</span> <span class="hljs-variable">mH</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">H</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> { 
        ...
        <span class="hljs-comment">//准备主线程的Looper </span>
        Looper.prepareMainLooper();
        <span class="hljs-comment">//获取startSeq long startSeq = 0; </span>
        <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> args.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) {
                <span class="hljs-keyword">if</span> (args[i] != <span class="hljs-literal">null</span> &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) {
                    startSeq = Long.parseLong(
                            args[i].substring(PROC_START_SEQ_IDENT.length()));
                }
            }
        }
        <span class="hljs-comment">//这里实例化ActivityThread，也就实例化了上面的mH </span>
        <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();
        <span class="hljs-comment">//调用ActivityThread的attach()方法 </span>
        thread.attach(<span class="hljs-literal">false</span>, startSeq);
        <span class="hljs-comment">//获取Handler </span>
        <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// sMainThreadHandler = mH </span>
            sMainThreadHandler = thread.getHandler();
        } 
        ...
        <span class="hljs-comment">//开启主线程Looper循环 </span>
        Looper.loop();
        <span class="hljs-comment">//因为主线程的Looper是不能退出的，退出就无法接收事件了。一旦意外退出，会抛出异常 </span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Main thread loop unexpectedly exited"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(<span class="hljs-type">boolean</span> system, <span class="hljs-type">long</span> startSeq)</span> { 
        ...
        <span class="hljs-keyword">if</span> (!system) {
            ...
            <span class="hljs-keyword">final</span> <span class="hljs-type">IActivityManager</span> <span class="hljs-variable">mgr</span> <span class="hljs-operator">=</span> ActivityManager.getService(); 
            ...
            mgr.attachApplication(mAppThread, startSeq); 
            ...
        } <span class="hljs-keyword">else</span> {
            ...
        } 
        ...
    }
} 
</code></pre>
<p>ActivityThread的attach()方法中使用Binder通信跨进程调用了AMS的attachApplication()方法，并将ApplicationThread作为参数传递过去。 下面执行AMS绑定ApplicationThread：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub 
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback {
        
    <span class="hljs-comment">// ActivityTaskManagerInternal是一个抽象类，实现类是ATMS的内部类LocalService</span>
    <span class="hljs-comment">// ATMS启动的时候，通过LocalServices的addService()方法注册进LocalServices</span>
    <span class="hljs-keyword">public</span> ActivityTaskManagerInternal mAtmInternal;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ActivityManagerService</span><span class="hljs-params">(Context systemContext, ActivityTaskManagerService atm)</span> {
        ...
        mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class);
        ...
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(IApplicationThread thread, <span class="hljs-type">long</span> startSeq)</span> {
        <span class="hljs-keyword">if</span> (thread == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityException</span>(<span class="hljs-string">"Invalid application interface"</span>);
        }
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingUid</span> <span class="hljs-operator">=</span> Binder.getCallingUid();
            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">origId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();
            attachApplicationLocked(thread, callingPid, callingUid, startSeq);
            Binder.restoreCallingIdentity(origId);
        }
    }

    <span class="hljs-meta">@GuardedBy("this")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplicationLocked</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> IApplicationThread thread, 
            <span class="hljs-type">int</span> pid, <span class="hljs-type">int</span> callingUid, <span class="hljs-type">long</span> startSeq)</span> {
        <span class="hljs-comment">// 保存当前正在运行的进程的所有信息</span>
        ProcessRecord app;
        ...
        <span class="hljs-keyword">try</span> {
            ...
            <span class="hljs-comment">// 跨进程调用应用进程ApplicationThread的bindApplication()创建绑定Application</span>
            thread.bindApplication(processName, appInfo, providerList, <span class="hljs-literal">null</span>, profilerInfo,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, testMode, 
                    mBinderTransactionTrackingEnabled, enableTrackAllocation,
                    isRestrictedBackupMode || !normalMode, app.isPersistent(),
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(app.getWindowProcessController().getConfiguration()),
                    app.compat, getCommonServicesLocked(app.isolated),
                    mCoreSettingsObserver.getCoreSettingsLocked(),
                    buildSerial, autofillOptions, contentCaptureOptions,
                    app.mDisabledCompatChanges);
            ...
            <span class="hljs-comment">// Make app active after binding application or client may be running requests (e.g </span>
            <span class="hljs-comment">// starting activities) before it is ready.</span>
            <span class="hljs-comment">//给WindowProcessController中的变量mThread赋值</span>
            app.makeActive(thread, mProcessStats);
            ...
        }
        ...
        <span class="hljs-comment">//通过ATMS启动根Activity</span>
        didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());
        ...
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>AMS的attachApplication()方法在获取到 pid、uid后继续调用AMS的attachApplicationLocked()方法。</p>
<p>AMS的attachApplicationLocked()方法中关注以下流程：</p>
<ol>
<li>通过跨进程通信调用应用进程中ApplicationThread的bindApplication()创建并绑定Application。</li>
<li>ProcessRecord调用makeActive()方法给WindowProcessController中的变量mThread赋值。</li>
<li>通过ActivityTaskManagerInternal本地服务过渡到ATMS启动根Activity。</li>
</ol>
<p>先来看看makeActive()方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessRecord</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowProcessListener</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeActive</span><span class="hljs-params">(IApplicationThread _thread, ProcessStatsService tracker)</span> {
        ...
        thread = _thread; 
        mWindowProcessController.setThread(thread); 
    } 
} 
</code></pre>
<p>里面调用了WindowProcessController的setThread()方法存储IApplicationThread实例，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowProcessController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConfigurationContainer</span>&lt;ConfigurationContainer&gt;
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurationContainerListener</span> {

    <span class="hljs-keyword">private</span> IApplicationThread mThread;

    <span class="hljs-meta">@HotPath(caller = HotPath.PROCESS_CHANGE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setThread</span><span class="hljs-params">(IApplicationThread thread)</span> {
        <span class="hljs-keyword">synchronized</span> (mAtm.mGlobalLockWithoutBoost) {
            mThread = thread;
            <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) {
                setLastReportedConfiguration(getConfiguration());
            }
        }
    }

    IApplicationThread <span class="hljs-title function_">getThread</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mThread;
    }

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasThread</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mThread != <span class="hljs-literal">null</span>;
    }

} 
</code></pre>
<p>WindowProcessController的setThread()方法中将传入的IApplicationThread实例赋值给mThread保存，前面进程不存在的情况下，startSpecificActivity()方法中通过wpc.hasThread()拿到的值为false，因为进程创建完成后才给WindowProcessController中的mThread赋值。IApplicationThread的bindApplication()方法调用的是应用进程中的实现类ApplicationThread的bindApplication()方法，方法中通过内部类H发送Handler消息，进而调用到ActivityThread的handleBindApplication()方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClientTransactionHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> { 
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, data.info);
        updateLocaleListFromAppContext(appContext, 
                mResourcesManager.getConfiguration().getLocales()); 
        ...
        <span class="hljs-keyword">if</span> (ii != <span class="hljs-literal">null</span>) { 
            ...
            <span class="hljs-keyword">final</span> <span class="hljs-type">LoadedApk</span> <span class="hljs-variable">pi</span> <span class="hljs-operator">=</span> getPackageInfo(instrApp, data.compatInfo, 
                    appContext.getClassLoader(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
                    
            <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">instrContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, pi, 
                    appContext.getOpPackageName());
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 获取ClassLoader加载类文件 </span>
                <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> instrContext.getClassLoader();
                <span class="hljs-comment">// 构建Instrumentation实例 </span>
                mInstrumentation = (Instrumentation)
                    cl.loadClass(data.instrumentationName.getClassName()).newInstance();
            } 
            ...
            <span class="hljs-keyword">final</span> <span class="hljs-type">ComponentName</span> <span class="hljs-variable">component</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(ii.packageName, ii.name);
            mInstrumentation.init(<span class="hljs-built_in">this</span>, instrContext, appContext, component,
                    data.instrumentationWatcher, data.instrumentationUiAutomationConnection);
            ...
        } 
        ...
        Application app; 
        ...
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建Application </span>
            app = data.info.makeApplication(data.restrictedBackupMode, <span class="hljs-literal">null</span>); 
            ...
            mInitialApplication = app;
            <span class="hljs-comment">//初始化ContentProvider，里面会构建ContentProvider实例并调用其onCreate()方法 </span>
            <span class="hljs-keyword">if</span> (!data.restrictedBackupMode) {
                <span class="hljs-keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) {
                    installContentProviders(app, data.providers);
                }
            }
            <span class="hljs-keyword">try</span> {
                mInstrumentation.onCreate(data.instrumentationArgs);
            } 
            ...
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 内部调用了Application的onCreate()的方法 </span>
                mInstrumentation.callApplicationOnCreate(app); 
            } 
            ...
        } 
        ...
    }
}
</code></pre>
<p>在handleBindApplication()方法中创建了Instrumentation实例和Application实例，调用了<code>mInstrumentation.callApplicationOnCreate(app)</code>，里面调用了Application的onCreate()的方法。ActivityThread的performLaunchActivity()方法中也有创建Application实例的操作，里面会先判断Application是否已存在。也就是说，<strong>正常情况下Application的初始化是在handleBindApplication方法中的，并且是创建进程后调用的。performLaunchActivity()中只是做了一个检测，异常情况Application不存在时才会创建。</strong> 这里注意一点，创建Application后，马上会执行Application的attach()方法，attach()内部会调用attachBaseContext()方法，后面才是Application的onCreate()方法。</p>
<p>回到前面的ATMS中的attachApplication()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityTaskManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityTaskManager</span>.Stub {
    <span class="hljs-comment">// 启动的时候注册到 LocalServices 中 </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        LocalServices.addService(ActivityTaskManagerInternal.class, mInternal);
    }

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActivityTaskManagerInternal</span> { 
        ...
        <span class="hljs-meta">@HotPath(caller = HotPath.PROCESS_CHANGE)</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(WindowProcessController wpc)</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">synchronized</span> (mGlobalLockWithoutBoost) {
                <span class="hljs-keyword">if</span> (Trace.isTagEnabled(TRACE_TAG_WINDOW_MANAGER)) {
                    Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="hljs-string">"attachApplication:"</span> + wpc.mName);
                }
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">//调用RootWindowContainer的attachApplication()方法 </span>
                    <span class="hljs-keyword">return</span> mRootWindowContainer.attachApplication(wpc);
                } <span class="hljs-keyword">finally</span> {
                    Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);
                }
            }
        } 
        ...
    }
} 
</code></pre>
<p>ActivityTaskManagerInternal是一个抽象类，实现类是ATMS的内部类LocalService，所以AMS中调用 ActivityTaskManagerInternal的方法，实际上调用的是ATMS中的实现类LocalService的方法。该方法继续调用 RootWindowContainer的attachApplication()方法，启动流程交给RootWindowContainer处理。RootWindowContainer的attachApplication()方法代码如下：</p>
<pre><code class="hljs language-java" lang="java">RootWindowContainer <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;DisplayContent&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DisplayManager</span>.DisplayListener { 

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(WindowProcessController app)</span> <span class="hljs-keyword">throws</span> RemoteException {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">didSomething</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">displayNdx</span> <span class="hljs-operator">=</span> getChildCount() - <span class="hljs-number">1</span>; displayNdx &gt;= <span class="hljs-number">0</span>; --displayNdx) {
            mTmpRemoteException = <span class="hljs-literal">null</span>;
            mTmpBoolean = <span class="hljs-literal">false</span>; <span class="hljs-comment">// Set to true if an activity was started.</span>

            <span class="hljs-keyword">final</span> <span class="hljs-type">DisplayContent</span> <span class="hljs-variable">display</span> <span class="hljs-operator">=</span> getChildAt(displayNdx);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">areaNdx</span> <span class="hljs-operator">=</span> display.getTaskDisplayAreaCount() - <span class="hljs-number">1</span>; areaNdx &gt;= <span class="hljs-number">0</span>; --areaNdx) {
                <span class="hljs-keyword">final</span> <span class="hljs-type">TaskDisplayArea</span> <span class="hljs-variable">taskDisplayArea</span> <span class="hljs-operator">=</span> display.getTaskDisplayAreaAt(areaNdx);
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">taskNdx</span> <span class="hljs-operator">=</span> taskDisplayArea.getStackCount() - <span class="hljs-number">1</span>; taskNdx &gt;= <span class="hljs-number">0</span>; --taskNdx) {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityStack</span> <span class="hljs-variable">rootTask</span> <span class="hljs-operator">=</span> taskDisplayArea.getStackAt(taskNdx);
                    <span class="hljs-keyword">if</span> (rootTask.getVisibility(<span class="hljs-literal">null</span> <span class="hljs-comment">/*starting*/</span>) == STACK_VISIBILITY_INVISIBLE) {
                        <span class="hljs-keyword">break</span>;
                    }
                    <span class="hljs-keyword">final</span> <span class="hljs-type">PooledFunction</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> PooledLambda.obtainFunction(
                            RootWindowContainer::startActivityForAttachedApplicationIfNeeded, <span class="hljs-built_in">this</span>,
                            PooledLambda.__(ActivityRecord.class), app,
                            rootTask.topRunningActivity());
                    rootTask.forAllActivities(c);
                    c.recycle();
                    <span class="hljs-keyword">if</span> (mTmpRemoteException != <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">throw</span> mTmpRemoteException;
                    }
                }
            }
            didSomething |= mTmpBoolean;
        }
        <span class="hljs-keyword">if</span> (!didSomething) {
            ensureActivitiesVisible(<span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/* preserve_windows */</span>);
        }
        <span class="hljs-keyword">return</span> didSomething;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivityForAttachedApplicationIfNeeded</span><span class="hljs-params">(ActivityRecord r,
            WindowProcessController app, ActivityRecord top)</span> {
        <span class="hljs-keyword">if</span> (r.finishing || !r.okToShowLocked() || !r.visibleIgnoringKeyguard || r.app != <span class="hljs-literal">null</span>
                || app.mUid != r.info.applicationInfo.uid || !app.mName.equals(r.processName)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (mStackSupervisor.realStartActivityLocked(r, app,
                    top == r &amp;&amp; r.isFocusable() <span class="hljs-comment">/*andResume*/</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/*checkConfig*/</span>)) {
                mTmpBoolean = <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            ...
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } 

} 
</code></pre>
<p>RootWindowContainer的attachApplication()方法中，调用到RootWindowContainer的startActivityForAttachedApplicationIfNeeded()方法。RootWindowContainer的 startActivityForAttachedApplicationIfNeeded()方法中继续调用ActivityStackSupervisor的 realStartActivityLocked()方法。从这里开始，又跟普通Activity的启动流程一样了。</p>
<p>我们发现，<strong>根Activity启动前需要创建进程，然后执行ActivityThread的main()方法，开启主线程循环，初始化并绑定Application、赋值IApplicationThread，最后真正的启动过程和普通Activity是一致的。</strong></p>
<p>整个流程梳理成流程图如下所示： <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/670d05f040634d2dadd47d031512c3d0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1966&amp;h=1389&amp;s=198171&amp;e=png&amp;b=ffffff" alt="根Activity的启动流程.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[硬核] 给 LLM 配上“自动换刀库”：智能体来了（西南总部）【AI智能体运营工程师就业班】的插件开发实战笔记]]></title>    <link>https://juejin.cn/post/7597635202324611124</link>    <guid>https://juejin.cn/post/7597635202324611124</guid>    <pubDate>2026-01-21T10:37:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324611124" data-draft-id="7597635202324578356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[硬核] 给 LLM 配上“自动换刀库”：智能体来了（西南总部）【AI智能体运营工程师就业班】的插件开发实战笔记"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-21T10:37:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老百姓懂点AI"/> <meta itemprop="url" content="https://juejin.cn/user/819569764079769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [硬核] 给 LLM 配上“自动换刀库”：智能体来了（西南总部）【AI智能体运营工程师就业班】的插件开发实战笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819569764079769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老百姓懂点AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:37:06.000Z" title="Wed Jan 21 2026 10:37:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h3 data-id="heading-0">🚀 写在前面：当大模型遇到“物理墙”</h3>
<p>在大语言模型（LLM）的开发圈子里，有一个共识：<strong>没有 Tool Use（工具调用）能力的 LLM，只是一个只会空谈的哲学家。</strong></p>
<p>作为一名机械工程背景的开发者，我习惯用“机械原理”来理解软件架构。在我看来，LLM 就像是一台拥有顶级扭矩和转速的<strong>五轴机床主轴</strong>，它动力澎湃，算力惊人。但是，如果这根主轴上不装任何<strong>刀具（Cutter）</strong> ，它就无法对物理世界进行任何切削（执行操作）。它可以完美地描述“如何加工一个齿轮”，但它造不出齿轮。</p>
<p>如何让 LLM 真正落地？答案就是 <strong>Agent（智能体）</strong> 。而 Agent 的核心，在于构建一个强大的 <strong>ATC（自动换刀系统，Automatic Tool Changer）</strong> 。</p>
<p>本文将复盘我在<strong>智能体来了（西南总部）参加【AI智能体运营工程师就业班】期间，在技术导师金加德讲师</strong>指导下，如何从零开始开发、调试并优化一个工业级 Agent 插件（Plugin）的全过程。我们将深入探讨 <code>Function Calling</code> 的底层逻辑，以及如何用“机械思维”解决 LLM 的幻觉问题。</p>
<hr/>
<h3 data-id="heading-1">一、 架构设计：什么是 LLM 的“自动换刀”？</h3>
<p>在数控加工中，ATC 系统根据 G 代码指令，自动从刀库中抓取 T01（铣刀）、T02（钻头）装在主轴上。</p>
<p>在 Agent 开发中，这个过程映射如下：</p>
<ul>
<li><strong>主轴 (Spindle) = LLM (推理核心)</strong> ：负责理解用户意图 (Intent)，规划任务链 (Chain of Thought)。</li>
<li><strong>刀具 (Tool) = Plugin / API (执行单元)</strong> ：负责执行具体动作（查库存、算参数、发邮件）。</li>
<li><strong>刀柄标准 (Holder Standard) = JSON Schema (接口定义)</strong> ：LLM 与工具之间的通信协议。如果协议对不上（比如 BT40 刀柄插不进 BT50 主轴），调用就会失败。</li>
</ul>
<p>我在<strong>智能体来了（西南总部）的项目目标是：开发一个“机床售后备件查询插件”</strong> ，让 Agent 能够回答：“VMC850 的主轴轴承还有货吗？”</p>
<hr/>
<h3 data-id="heading-2">二、 实战 Step 1：磨刀（编写 Python 业务逻辑）</h3>
<p>首先，我们需要一把“锋利的刀”。这部分是纯粹的后端逻辑，不涉及 AI。</p>
<p>我们需要编写一个 Python 函数，能够连接 ERP 数据库并查询数据。</p>
<p>Python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymysql
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-comment"># 模拟 ERP 数据库连接配置</span>
DB_CONFIG = {
    <span class="hljs-string">"host"</span>: <span class="hljs-string">"192.168.1.100"</span>,
    <span class="hljs-string">"user"</span>: <span class="hljs-string">"admin"</span>,
    <span class="hljs-string">"password"</span>: <span class="hljs-string">"secure_password"</span>,
    <span class="hljs-string">"db"</span>: <span class="hljs-string">"mes_inventory"</span>
}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_spare_part_stock</span>(<span class="hljs-params">part_model: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""
    [Core Logic] 实际执行查询的 Python 函数
    这就像是铣刀的硬质合金刀片，负责真正的切削
    """</span>
    connection = pymysql.connect(**DB_CONFIG)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> cursor:
            <span class="hljs-comment"># 模拟查询逻辑</span>
            sql = <span class="hljs-string">"SELECT quantity, warehouse_loc, price FROM stock WHERE model_id = %s"</span>
            cursor.execute(sql, (part_model,))
            result = cursor.fetchone()
            
            <span class="hljs-keyword">if</span> result:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,
                    <span class="hljs-string">"model"</span>: part_model,
                    <span class="hljs-string">"quantity"</span>: result[<span class="hljs-number">0</span>],
                    <span class="hljs-string">"location"</span>: result[<span class="hljs-number">1</span>],
                    <span class="hljs-string">"price"</span>: <span class="hljs-built_in">float</span>(result[<span class="hljs-number">2</span>])
                }
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"not_found"</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"型号 <span class="hljs-subst">{part_model}</span> 无库存记录"</span>}
    <span class="hljs-keyword">finally</span>:
        connection.close()
</code></pre>
<p>这段代码对于掘金的开发者来说没有任何难度。但关键在于：<strong>LLM 怎么知道如何调用它？</strong></p>
<hr/>
<h3 data-id="heading-3">三、 实战 Step 2：定义刀柄（编写 JSON Schema）</h3>
<p>这是 Agent 开发中最硬核、也最容易踩坑的环节。</p>
<p>LLM 不会读你的 Python 源码，它只读你的 <strong>API 描述（Schema）</strong> 。</p>
<p>在**【AI智能体运营工程师就业班】**上，<strong>金加德讲师</strong>反复强调：“<strong>Schema 就是 Prompt 的一部分。</strong> 你在 Schema 里写的每一个字段描述，都会进入 LLM 的上下文窗口。写得越烂，LLM 抓错刀的概率就越大。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fdff7778f514ba6a63fd0ecf3375308~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB55m-5aeT5oeC54K5QUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769596626&amp;x-signature=JD8UUsqOGI1Kp4XfDpzVszQTtT8%3D" alt="dreamina-2026-01-21-3557-Schema 就是 Prompt 的一部分。 你在 Schema 里写的每一个字....jpeg" loading="lazy"/></p>
<h4 data-id="heading-4">❌ 错误的写法（导致幻觉）：</h4>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_stock"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查库存"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 太简略，LLM 不知道什么时候用</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"part_model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"型号"</span> <span class="hljs-comment">// 模糊，LLM 可能会把 "轴承" 这个词直接传进来</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-5">✅ 金加德讲师推荐的“工业级”写法：</h4>
<p>我们采用了类似 OpenAPI (Swagger) 的规范，加入了大量的<strong>约束条件</strong>和**Few-Shot（少样本）**提示。</p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_spare_part_stock"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"当用户询问特定机床配件的库存数量、价格或存放位置时，必须使用此工具。注意：此工具仅接受标准的物料编码（如 'H7002-C'），不接受模糊名称（如 '那个红色的轴承'）。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"part_model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"目标配件的精确型号代码。如果用户未提供具体型号，请先追问用户，不要臆造型号。"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"examples"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"H7002-C"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"A860-2000-T301"</span><span class="hljs-punctuation">]</span> 
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"part_model"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>技术要点解析：</strong></p>
<ol>
<li><strong>Description 增强：</strong> 明确了“When to use”（什么时候用）和“What NOT to do”（不要做什么）。这相当于在刀柄上刻了“严禁超速”的警示语。</li>
<li><strong>Examples 注入：</strong> 给出了具体的参数示例。这对 LLM 提取参数的准确率提升巨大。</li>
</ol>
<hr/>
<h3 data-id="heading-6">四、 实战 Step 3：试切削（调试与 Function Calling 流程）</h3>
<p>配置好 Coze (或者 LangChain) 后，我们进行链路测试。</p>
<p>这里展示一下 <strong>Function Calling</strong> 在后台的真实交互日志（Trace），这对于理解 Agent 原理至关重要。</p>
<p><strong>User Input:</strong></p>
<blockquote>
<p>“帮我查一下 VMC850 的主轴编码器 A860 还有没有货？”</p>
</blockquote>
<p><strong>Agent Trace (Round 1):</strong></p>
<ol>
<li>
<p><strong>Thinking (Thought Chain):</strong></p>
<ul>
<li>用户意图：查询库存。</li>
<li>可用工具：<code>query_spare_part_stock</code>。</li>
<li>参数提取：识别到关键词 "A860"（注意：这里 LLM 可能会提取不完整）。</li>
<li><em>决策：</em> 调用工具。</li>
</ul>
</li>
<li>
<p><strong>Call Tool (Action):</strong></p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"function_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_spare_part_stock"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>part_model<span class="hljs-string">": "</span>A860<span class="hljs-string">"}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Tool Output (Observation):</strong></p>
<ul>
<li><em>System:</em> 调用 Python 函数... 返回 <code>{"status": "not_found", "msg": "型号 A860 无库存记录"}</code>。</li>
<li><em>注：</em> 因为型号不完整，导致查询失败。这在工业场景很常见。</li>
</ul>
</li>
</ol>
<p><strong>Agent Trace (Round 2 - 自我修正):</strong></p>
<ol start="4">
<li>
<p><strong>Thinking:</strong></p>
<ul>
<li>工具返回“无记录”。可能是用户给的型号不完整，或者是真的没货。</li>
<li>根据 Schema 中的提示“不接受模糊名称”，我应该追问用户确认完整型号，而不是直接说没货。</li>
</ul>
</li>
<li>
<p><strong>Final Response:</strong></p>
<blockquote>
<p>“系统查询‘A860’未找到记录。请问您是指 <strong>A860-2000-T301</strong>（通用编码器）还是其他具体子型号？请提供完整物料代码。”</p>
</blockquote>
</li>
</ol>
<p><strong>复盘：</strong></p>
<p>看到没？这就是**“Schema 调优”**的威力。如果我们在 Schema 里没有写那句“不要臆造型号”，LLM 很有可能就直接编造一个库存数量回答用户了（幻觉）。</p>
<hr/>
<h3 data-id="heading-7">五、 进阶技巧：如何处理“非标刀具”？</h3>
<p>在**智能体来了（西南总部）**的高阶课程中，我们还解决了一个更复杂的问题：<strong>多步参数清洗</strong>。</p>
<p>有时候，用户的输入非常不标准，比如“查一下内径50的那个日本轴承”。</p>
<p>这时候，单一的插件（刀具）搞不定。我们需要<strong>组合刀具</strong>。</p>
<p>我设计了一个 <strong>Workflow（工作流）</strong> ，串联了两个节点：</p>
<ol>
<li><strong>Node A (LLM 模糊匹配):</strong> 先用一个大模型节点，结合 RAG 知识库，将“内径50的日本轴承”翻译成标准型号列表 <code>["NSK-6210", "NTN-6210"]</code>。</li>
<li><strong>Node B (Python 查询):</strong> 再遍历这个列表，去调用 <code>query_spare_part_stock</code>。</li>
</ol>
<p>这就好比数控机床的<strong>复合加工</strong>：先用车刀把毛坯车圆（标准化），再用铣刀铣键槽（查数据）。</p>
<hr/>
<h3 data-id="heading-8">六、 总结：从 Developer 到 Operator</h3>
<p>通过这次实战，我对<strong>AI 智能体运营工程师</strong>这个岗位有了更深的理解。</p>
<p>我们不是在写传统的 CRUD 业务代码，我们是在**“编写机器人的说明书”**。</p>
<ul>
<li>Python 代码决定了 Agent <strong>能做什么（能力边界）</strong> 。</li>
<li>JSON Schema 决定了 Agent <strong>知不知道怎么做（认知边界）</strong> 。</li>
</ul>
<p>正如<strong>金加德讲师</strong>所言：“未来的编程，一半是写给机器看的（Code），一半是写给模型看的（Prompt/Schema）。掌握这两门语言的人，才是 AI 时代的架构师。”</p>
<p>如果你也是技术出身，建议赶紧去玩一下 Coze 或 LangChain。当你看到自己写的 Python 函数被 LLM 像抓取刀具一样灵活调用时，那种**“给大脑装上双手”**的成就感，是无与伦比的。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 框架之文档加载器]]></title>    <link>https://juejin.cn/post/7597642574933737481</link>    <guid>https://juejin.cn/post/7597642574933737481</guid>    <pubDate>2026-01-21T10:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597642574933737481" data-draft-id="7597623392456228915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 框架之文档加载器"/> <meta itemprop="keywords" content="AIGC,AI编程,LangChain"/> <meta itemprop="datePublished" content="2026-01-21T10:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 框架之文档加载器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:29:07.000Z" title="Wed Jan 21 2026 10:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>之前学到了 LangChain 框架的核心组件记忆，接下来学习文档加载器（Document Loaders）</p>
<h2 data-id="heading-1">文档加载器（Document Loaders）</h2>
<p>作用就是加载外部的文档到 LangChain 中，读取文档中的内容，然后用于后续的处理和分析</p>
<h2 data-id="heading-2">应用场景</h2>
<p>基于文档的问答系统，日常比较常见的例如客服系统，根据产品手册自动回答相关问题，文字自动分类等；个人笔记知识库，基于自己的笔记文档等进行回答，总结等；以及其他场景如学习研究，教育内容管理 等等</p>
<h3 data-id="heading-3">文本文件加载 （TextLoader）</h3>
<p>TextLoader 是最基础的文档加载器，用于加载纯文本文件</p>
<p>通过 <code>TextLoader()</code> 加载文件,代码如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> TextLoader  <span class="hljs-comment"># 文本文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>
...
    <span class="hljs-comment"># 创建一个示例文本文件</span>
    sample_text = <span class="hljs-string">"""
    LangChain 是一个用于构建基于大型语言模型(LLM)应用程序的框架。
    它提供了模块化的组件，让开发者能够轻松地构建复杂的AI应用。
    
    主要特点：
    1. 模块化设计
    2. 易于使用
    3. 支持多种LLM
    4. 丰富的工具集成
    """</span>
    
    <span class="hljs-comment"># 将示例文本写入文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"sample.txt"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(sample_text)
    
    <span class="hljs-comment"># 使用 TextLoader 加载文本文件</span>
    loader = TextLoader(<span class="hljs-string">"sample.txt"</span>, encoding=<span class="hljs-string">"utf-8"</span>)  <span class="hljs-comment"># 创建文本加载器，指定编码格式</span>
    documents = loader.load()  <span class="hljs-comment"># 加载文档，返回 Document 对象列表</span>
    
    <span class="hljs-comment"># 打印加载结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档内容: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].page_content[:<span class="hljs-number">1000</span>]}</span>..."</span>)  <span class="hljs-comment"># 打印前1000个字符</span>
...
</code></pre>
<p>通过 <code>loader.load()</code> 返回的对象，包含了文档内容，可以通过 <code>page_content</code> 属性读取，整体操作很简单，两三行代码就能读取文件</p>
<h3 data-id="heading-4">PDF加载器 （PyPDFLoader）</h3>
<p>PyPDFLoader 是用于加载 PDF 文件的文档加载器，可以读取 PDF 文件中的文本内容</p>
<p>通过 <code>PyPDFLoader()</code> 加载文件,代码如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> PyPDFLoader  <span class="hljs-comment"># PDF 文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>
...
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 使用 PyPDFLoader 加载同级目录下的 PDF 文件</span>
        loader = PyPDFLoader(<span class="hljs-string">"document.pdf"</span>)  <span class="hljs-comment"># 创建PDF加载器</span>
        documents = loader.load()  <span class="hljs-comment"># 加载PDF文档</span>
        
        <span class="hljs-comment"># 打印加载结果</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nPDF内容预览："</span>)
        
        <span class="hljs-comment"># 遍历每一页并输出内容</span>
        <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents):
            page_num = doc.metadata.get(<span class="hljs-string">"page"</span>, i + <span class="hljs-number">1</span>)  <span class="hljs-comment"># 获取页码</span>
            content = doc.page_content.strip()  <span class="hljs-comment"># 获取页面内容并去除首尾空格</span>
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 页面 <span class="hljs-subst">{page_num}</span> ---"</span>)
            <span class="hljs-keyword">if</span> content:
                <span class="hljs-comment"># 限制每页输出长度，避免内容过长</span>
                preview = content[:<span class="hljs-number">300</span>] + <span class="hljs-string">"..."</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(content) &gt; <span class="hljs-number">300</span> <span class="hljs-keyword">else</span> content
                <span class="hljs-built_in">print</span>(preview)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"(此页面无文本内容)"</span>)
            
            <span class="hljs-comment"># 打印页面元数据</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"元数据: <span class="hljs-subst">{doc.metadata}</span>"</span>)
        
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：找不到 document.pdf 文件"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请确保在同级目录下存在 document.pdf 文件"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF加载错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"可能的原因："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. PDF文件损坏"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. PDF文件受密码保护"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 缺少PDF处理依赖"</span>)

</code></pre>
<p>和文本加载器类似，通过 <code>loader.load()</code> 返回的对象，包含了文档内容，可以通过 <code>page_content</code> 属性读取，读取PDF文件数据时或输出的时候按需处理对应的格式</p>
<h3 data-id="heading-5">网页加载器 （WebBaseLoader）</h3>
<p>加载网页，通过网站地址加载网页内容，用法和文本，PDF加载器都一样，一两行代码就能加载网页内容</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> WebBaseLoader  <span class="hljs-comment"># 网页加载器</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 网页加载演示 ==="</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 使用 WebBaseLoader 加载 LangChain 官方文档</span>
        loader = WebBaseLoader(<span class="hljs-string">"https://docs.langchain.com/oss/python/langchain/overview"</span>)  <span class="hljs-comment"># 创建网页加载器</span>
        documents = loader.load()  <span class="hljs-comment"># 加载网页内容</span>
        
        <span class="hljs-comment"># 打印加载结果</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"网页内容预览: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].page_content[:<span class="hljs-number">500</span>]}</span>..."</span>)  <span class="hljs-comment"># 打印前500个字符</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"网页元数据: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].metadata}</span>"</span>)  <span class="hljs-comment"># 包含URL等信息</span>
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"网页加载错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"可能是网络连接问题或网站不可访问"</span>)
    
    <span class="hljs-built_in">print</span>()
</code></pre>
<h3 data-id="heading-6">数据库加载器 （SQLDatabaseLoader）</h3>
<p>作用是从数据库中加载数据，返回的是一个文档对象列表，每个文档对象包含了数据库中的一条记录，记录的内容就是数据库中的字段值，记录的元数据就是数据库中的字段名</p>
<p>由于我日常前端开发为主，下面使用 <code>CSVLoader</code> 加载 CSV 文件，模拟数据库数据</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> CSVLoader  <span class="hljs-comment"># CSV文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数：演示数据库内容加载"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 数据库加载演示 ==="</span>)
    
    <span class="hljs-comment"># 创建一个示例CSV文件来模拟数据库数据</span>
    csv_content = <span class="hljs-string">"""id,name,description,category
1,Python,一种高级编程语言,编程语言
2,JavaScript,网页脚本语言,编程语言
3,MySQL,关系型数据库,数据库
4,MongoDB,文档型数据库,数据库
5,Docker,容器化平台,开发工具"""</span>
    
    <span class="hljs-comment"># 将CSV内容写入文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"data.csv"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(csv_content)
    
    <span class="hljs-comment"># 使用 CSVLoader 加载CSV文件（模拟数据库数据）</span>
    loader = CSVLoader(<span class="hljs-string">"data.csv"</span>, encoding=<span class="hljs-string">"utf-8"</span>)  <span class="hljs-comment"># 创建CSV加载器</span>
    documents = loader.load()  <span class="hljs-comment"># 加载数据</span>
    
    <span class="hljs-comment"># 打印加载结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的记录数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"前3条记录："</span>)
    <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents[:<span class="hljs-number">3</span>]):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"记录 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{doc.page_content}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"元数据: <span class="hljs-subst">{doc.metadata}</span>"</span>)
    
    <span class="hljs-comment"># 清理示例文件</span>
    os.remove(<span class="hljs-string">"data.csv"</span>)
    
</code></pre>
<h3 data-id="heading-7">Markdown文件加载器 （MarkdownLoader）</h3>
<p>从 Markdown 文件中加载内容，和文本加载器类似，就是函数名不一样</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入必要的库</span>
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> UnstructuredMarkdownLoader  <span class="hljs-comment"># Markdown文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数：演示Markdown文件加载"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== Markdown文件加载演示 ==="</span>)
    
    <span class="hljs-comment"># 创建一个示例Markdown文件</span>
    markdown_content = <span class="hljs-string">"""# LangChain 教程

## 简介
LangChain 是一个强大的框架，用于构建基于LLM的应用程序。

## 主要功能
- **文档处理**: 加载和分割各种格式的文档
- **向量存储**: 高效的文档检索
- **链式调用**: 复杂的工作流程

## 代码示例

from langchain.llms import OpenAI
llm = OpenAI()
result = llm("Hello, LangChain!")


## 总结
LangChain 让AI应用开发变得简单高效。"""</span>
    
    <span class="hljs-comment"># 将Markdown内容写入文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"sample.md"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(markdown_content)
    
    <span class="hljs-comment"># 使用 UnstructuredMarkdownLoader 加载Markdown文件</span>
    loader = UnstructuredMarkdownLoader(<span class="hljs-string">"sample.md"</span>)  <span class="hljs-comment"># 创建Markdown加载器</span>
    documents = loader.load()  <span class="hljs-comment"># 加载文档</span>
    
    <span class="hljs-comment"># 打印加载结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档内容预览: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].page_content[:<span class="hljs-number">200</span>]}</span>..."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档元数据: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].metadata}</span>"</span>)
    
    <span class="hljs-comment"># 清理示例文件</span>
    os.remove(<span class="hljs-string">"sample.md"</span>)
    <span class="hljs-built_in">print</span>()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-8">小结</h2>
<p>文档加载器相关知识点和例子就结束了，除了概念和作用有点内容了解一下，代码上没什么新鲜东西，引入的库和函数不一样，看下例子简单过一遍就行了</p>
<p>后面将继续学习文本分割器相关内容</p>
<blockquote>
<p>欢迎留言交流，如果觉得有帮助，可以<code>点个赞</code>支持一下</p>
<p>公众号：草帽lufei</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“模糊”与“迟钝”！首创波动方程建模视觉，ImageNet 84.2%，推理速度飙升]]></title>    <link>https://juejin.cn/post/7597695487302696975</link>    <guid>https://juejin.cn/post/7597695487302696975</guid>    <pubDate>2026-01-22T02:01:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695487302696975" data-draft-id="7597650624637927424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“模糊”与“迟钝”！首创波动方程建模视觉，ImageNet 84.2%，推理速度飙升"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-22T02:01:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“模糊”与“迟钝”！首创波动方程建模视觉，ImageNet 84.2%，推理速度飙升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:01:21.000Z" title="Thu Jan 22 2026 02:01:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在深度学习视觉建模领域，如何既实现高效的全局语义交互，又能精准保留图像中的高频细节（如边缘和纹理），一直是一个关键难题。传统的卷积神经网络（CNN）依赖局部感受野，难以建模长程依赖；而视觉Transformer（ViT）虽然通过自注意力实现了全局交互，但其二次复杂度限制了在高分辨率图像上的应用，且缺乏对空间频率传播的显式建模。更重要的是，多数基于物理启发的模型（如热传导方法）倾向于过度平滑高频信号，导致细节丢失。</p>
<p>那么，是否存在一种既能保持全局语义连贯性，又能避免高频信息被过度过滤的物理建模方式？</p>
<p>最近，北京大学和清华大学研究团队提出了一种全新的思路：<strong>将视觉特征传播建模为波动方程中的阻尼振荡过程</strong>，从而在频率与时间解耦的框架下，实现高效且细节保留的全局建模。</p>
<h2 data-id="heading-0"><strong>从“热传导”到“波动方程”：一种频率友好的传播机制</strong></h2>
<p>传统基于热传导的方法在频域中相当于一个强低通滤波器，高频成分会随时间迅速衰减，导致特征平滑、细节模糊。而波动方程描述的是一种<strong>振荡传播机制</strong>：不同频率的成分在传播过程中以阻尼振荡的形式共存，低频决定整体结构，高频保留局部细节，且衰减与频率无关。</p>
<p>将特征图视为空间信号，将其演化建模为一个二维阻尼波动方程：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f5e4a2198ba444c92bf7735f5722063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=RRSCCLUzQ26fOc9eRrZsCpji9v0%3D" alt="screenshot_2026-01-21_14-29-29.png" loading="lazy"/></p>
<p>其中 u 表示语义场，v 为传播速度，α 为阻尼系数。通过对该方程在频域中求解，得到了一个<strong>闭式解</strong>，实现了频率与时间的解耦：阻尼项<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9251019bf9e4d3b99ad9d5e713e497d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=dWZS8kNTmv%2Fi6pP4kZW9SrpswWo%3D" alt="screenshot_2026-01-21_14-32-48.png" loading="lazy"/>对所有频率成分一致衰减，而振荡项<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10020a4888df4d49803f80bd5665bc8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=ISPUEtzzt0HHKjftU8vgBQ7YZu8%3D" alt="screenshot_2026-01-21_14-32-56.png" loading="lazy"/>和<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e3f4985d4b4d7390a62b6d6b147aae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=0xP2DEZYjPV%2F1n5ulS7Ru8DUJ%2FE%3D" alt="screenshot_2026-01-21_14-33-03.png" loading="lazy"/>则保留了频率特性。</p>
<h2 data-id="heading-1"><strong>Wave Propagation Operator（WPO）：波动传播的可计算模块</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ac738b01b740728407e2b71272fe1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=KgIaHfSsFOhyO3DefA%2BuvuuAlUc%3D" alt="screenshot_2026-01-21_13-57-46.png" loading="lazy"/></p>
<p>基于上述理论，研究者提出了 Wave Propagation Operator（WPO），这是一个轻量级模块，用于在频域中模拟波动传播过程。其计算过程如下：</p>
<ol>
<li>将输入特征图通过傅里叶变换转换到频域；</li>
<li>利用闭式解对每个频率分量进行阻尼振荡调制；</li>
<li>通过逆傅里叶变换将结果映射回空间域。</li>
</ol>
<p>整个过程复杂度仅为<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c04f0e203cdd43c483d6564e0da6a738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=wL42gkz6gXjPjt1nBty4O98mMyY%3D" alt="screenshot_2026-01-21_14-34-31.png" loading="lazy"/>，远低于自注意力的<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91b68e1ff00d4a8aa96f87b74c9b4bac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=kKPbwDpMhuxv6%2BPaZ%2FRBbm2sC2o%3D" alt="screenshot_2026-01-21_14-34-38.png" loading="lazy"/>，且保留了全局交互能力与高频细节。</p>
<ul>
<li><strong>WaveFormer：一个即插即用的视觉骨干网络</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4002bc679cb64725b5ce257f1668c414~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=CkIz%2FavL3VmthJg0nE4Ua%2FHjq6s%3D" alt="screenshot_2026-01-21_14-00-22.png" loading="lazy"/></p>
<p>基于WPO，研究者构建了一系列WaveFormer模型（Tiny/Small/Base），可作为标准ViT或CNN的直接替代。模型采用分层设计，每个阶段包含多个Wave Propagation Layer，结合深度卷积与前馈网络，实现多尺度特征提取。</p>
<h2 data-id="heading-2"><strong>为什么波动传播适合视觉建模？实验给出的有力证据</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840bf99674924da1a11f5b3860b2b49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=FgVWGiGxCrSMEJrGyUEmFj%2F2EQk%3D" alt="screenshot_2026-01-21_14-01-27.png" loading="lazy"/></p>
<p>与热传导相比，波动传播具有以下理论优势：</p>
<ul>
<li><strong>频率平衡：</strong> 振荡机制使能量在高低频之间更均匀分布；</li>
<li><strong>细节保留：</strong> 高频成分通过振荡项得以保留，避免过度平滑；</li>
<li><strong>双向传播：</strong> 支持信息的可逆传递，更符合语义传播的物理直觉；</li>
<li><strong>高效计算：</strong> 频域实现带来接近线性的复杂度。</li>
</ul>
<p>那么，这些理论优势是否转化为了实际性能的提升？实验给出了肯定的答案：</p>
<ol>
<li><strong>图像分类（ImageNet-1K）：</strong> WaveFormer在保持高效的同时，实现了更高的准确率。例如，<strong>WaveFormer-Base</strong> 以 <strong>10.8G FLOPs</strong> 和 <strong>68M参数</strong> 取得了 84.2% 的Top-1准确率，超过了Swin-B (83.5%) 和 vHeat-B (84.0%)。其推理吞吐量达到 <strong>719 img/s</strong>，显著高于同类模型。</li>
<li><strong>目标检测与实例分割（COCO）：</strong> 在密集预测任务中，WaveFormer展现出更强的边界和细节建模能力。使用Mask R-CNN框架，<strong>WaveFormer-Tiny</strong> 在1x训练调度下取得了 <strong>45.8% AP^b</strong> 和 <strong>41.5% AP^m</strong>，分别比Swin-T高出  <strong>+3.1%</strong> 和  <strong>+2.2%</strong> ，同时保持了更高的推理速度（FPS）。</li>
<li><strong>语义分割（ADE20K）：</strong> 这项任务对高频细节（如物体边界）的保留要求极高。<strong>WaveFormer-Base</strong> 在ADE20K数据集上达到了 <strong>50.5% mIoU</strong>，超越了同样基于物理启发的 <strong>vHeat-B (49.6%)</strong> ，以及 <strong>ConvNeXt-B (49.1%)</strong> 。这直接证明了其“频率-时间解耦”机制在保留精细结构上的有效性。</li>
</ol>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6dfcc8332aa4c978c45987add09c58c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=UC2Agtaw7EsZVMa8pJ2PVxZ%2BL%2F8%3D" alt="screenshot_2026-01-21_14-02-24.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9494b5bb20428a92cc9be6628a7ec6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=ospNvRFE0UuFaVYHGMoi06BrIYA%3D" alt="screenshot_2026-01-21_14-04-07.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dfc3f4862564911b5a241b4ed61d64d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=cMj6c6G7bEsl5GEw07RId7TLgNk%3D" alt="screenshot_2026-01-21_14-04-12.png" loading="lazy"/></p>
<p>这些实验结果一致表明，波动传播机制不仅是一种理论上的优雅设计，更在实践中带来了精度、效率与细节保真度的全面优势。</p>
<h2 data-id="heading-3"><strong>总结：波动方程为视觉建模注入物理直觉</strong></h2>
<p>WaveFormer的提出，不仅为视觉表示学习提供了一种高效、可解释的建模范式，也展示了<strong>物理方程与深度学习</strong>结合的潜力。通过将波动方程引入视觉传播过程，研究者成功实现了频率与时间的解耦，在保持全局语义的同时，精准保留了图像的高频细节。</p>
<p>这一工作也为未来视觉骨干网络的设计提供了新方向：<strong>如何将更多物理机制（如波动、扩散、对流等）融入深度学习架构，以带来更强大的归纳偏置与更高效的计算范式。</strong></p>
<blockquote>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.08602" target="_blank" title="https://arxiv.org/abs/2601.08602" ref="nofollow noopener noreferrer">arxiv.org/abs/2601.08…</a></p>
<p>代码开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZishanShu%2FWaveFormer" target="_blank" title="https://github.com/ZishanShu/WaveFormer" ref="nofollow noopener noreferrer">github.com/ZishanShu/W…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网易一面：Read View是干嘛的？]]></title>    <link>https://juejin.cn/post/7597650624638009344</link>    <guid>https://juejin.cn/post/7597650624638009344</guid>    <pubDate>2026-01-22T02:02:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624638009344" data-draft-id="7555780704270942227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网易一面：Read View是干嘛的？"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2026-01-22T02:02:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1665088861772688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网易一面：Read View是干嘛的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1665088861772688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:02:28.000Z" title="Thu Jan 22 2026 02:02:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><strong>文章内容收录到个人网站，方便阅读</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhardyfish.top%2F" target="_blank" title="http://hardyfish.top/" ref="nofollow noopener noreferrer">hardyfish.top/</a></p>
<blockquote>
<p>它是 InnoDB 实现 <strong>MVCC</strong> 的核心，用来判断<strong>某个行版本，对当前这次一致性读取是否可见</strong>。</p>
</blockquote>
<p>Read View 是什么？</p>
<blockquote>
<p>一份<strong>快照元数据</strong>，记录<strong>在它创建的那一刻仍然活跃的事务集合</strong>及相关边界。</p>
<p>有了它，普通 <code>SELECT</code>（不加锁）就能在<strong>不加行锁</strong>的前提下读到<strong>一致</strong>的数据版本。</p>
</blockquote>
<p><strong>Read View 主要字段（逻辑上）</strong></p>
<ul>
<li><code>m_ids</code>：创建瞬间 <strong>仍在活跃</strong> 的事务 ID 列表（未提交）。</li>
<li><code>creator_trx_id</code>：创建该 Read View 的事务 ID。</li>
<li><code>low_limit_id</code>：<code>m_ids</code> 中的最小值；如果 <code>m_ids</code> 为空则等于 <code>up_limit_id</code>。</li>
<li><code>up_limit_id</code>：创建瞬间<strong>下一个将要分配</strong>的事务 ID（相当于高水位）。</li>
</ul>
<blockquote>
<p>实际字段名在源码里是 <code>m_ids/m_low_limit_id/m_up_limit_id/m_creator_trx_id</code>，不同版本命名略有差异，但语义一致。</p>
</blockquote>
<p><strong>哪些隔离级别会用到 Read View？</strong></p>
<blockquote>
<p><strong>READ COMMITTED（RC）</strong>：</p>
<ul>
<li><strong>每条一致性读</strong>都会新建一个 Read View（所以同一事务内两次查到的结果可能不同）。</li>
</ul>
<p><strong>REPEATABLE READ（RR）</strong>：</p>
<ul>
<li><strong>第一次一致性读</strong>创建 Read View，<strong>整个事务复用</strong>这份快照（后续一致性读结果可重复）。</li>
</ul>
<p><strong>READ UNCOMMITTED</strong>：</p>
<ul>
<li>不创建 Read View（能读到未提交版本）。</li>
</ul>
<p><strong>SERIALIZABLE</strong>：</p>
<ul>
<li>普通 <code>SELECT</code> 会被提升为加锁读（走锁，不用 Read View）。</li>
</ul>
</blockquote>
<blockquote>
<p>无论什么隔离级别。</p>
<p><strong>当前读</strong>（<code>SELECT … FOR UPDATE/LOCK IN SHARE MODE</code>、<code>UPDATE/DELETE</code>）都<strong>不用</strong> Read View，而是读取最新版本并加锁。</p>
</blockquote>
<p><strong>可见性判定规则</strong></p>
<blockquote>
<p>给定某行的一个版本由事务 <code>trx_id</code> 写入，针对某个 Read View 的<strong>一致性读</strong>是否能看到它？</p>
</blockquote>
<p>伪代码如下（与 InnoDB 逻辑等价）：</p>
<pre><code class="hljs language-text" lang="text">if (trx_id == creator_trx_id)
    可见（自己改的自己能看见）
else if (trx_id &lt; low_limit_id)
    可见（该版本的事务在快照创建前已提交）
else if (trx_id &gt;= up_limit_id)
    不可见（该事务在快照之后才开始）
else if (trx_id in m_ids)
    不可见（快照时它还活跃，未提交）
else
    可见（介于 low 与 up 之间，但快照时它已不活跃 ⇒ 已提交）
</code></pre>
<blockquote>
<p>如果不可见，InnoDB 会沿着该行的 **版本链（Undo 日志）**回退到更早版本，重复上述判定，直到找到可见版本或无可见版本。</p>
</blockquote>
<p><strong>一致性读 VS 当前读</strong></p>
<blockquote>
<p><strong>一致性读（Consistent Read）</strong>：</p>
<p>普通 <code>SELECT</code>，通过 Read View 判定，<strong>不加锁</strong>，读到历史可见版本。</p>
<p><strong>当前读（Current Read）</strong>：</p>
<p><code>SELECT … FOR UPDATE</code> / <code>LOCK IN SHARE MODE</code>、<code>UPDATE/DELETE</code>。</p>
<p><strong>无视 Read View</strong>，直接读最新版本并加锁（Next-Key/记录锁），用于更新或防幻读。</p>
</blockquote>
<blockquote>
<p>在 <strong>RR</strong> 下：一致性读天然可重复；需要防幻读时，用<strong>当前读</strong>触发行间/间隙锁（Next-Key）来保证语义。</p>
</blockquote>
<p><strong>RC 与 RR 的差异直观例子</strong></p>
<pre><code class="hljs language-sql" lang="sql">T1 (RR)                         T2
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- T1 创建 Read View，看到 v0</span>
                              <span class="hljs-keyword">BEGIN</span>; <span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> c<span class="hljs-operator">=</span><span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>; <span class="hljs-keyword">COMMIT</span>; <span class="hljs-comment">-- v1</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- 仍看到 v0（因为复用同一 Read View）</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<blockquote>
<p>同样场景在 <strong>RC</strong>：第二次 <code>SELECT</code> 会创建<strong>新</strong> Read View，于是能看到 <code>v1</code>。</p>
</blockquote>
<p><strong>长事务、Read View 与清理（Purge）</strong></p>
<blockquote>
<p>行的旧版本保存在 <strong>Undo</strong> 中，<strong>只有当所有比它更老的 Read View 都销毁</strong>后，Purge 线程才能真正清理这些历史版本。</p>
<p><strong>长事务</strong>会拖住历史版本，导致：Undo/历史链变长、<code>history list length</code> 上升、二级索引回查变慢，甚至占用大量磁盘。</p>
<p>观测/诊断：</p>
<ul>
<li><code>SHOW ENGINE INNODB STATUS\G</code> 看 History List Length</li>
<li><code>information_schema.innodb_trx</code> 看长事务</li>
<li>合理控制事务时长、拆批、避免交互式长会话不提交。</li>
</ul>
</blockquote>
<p><strong>常见面试问法与要点答案</strong></p>
<p><strong>Q1：Read View 何时创建？</strong></p>
<ul>
<li>RC：每次一致性读的语句开始时。</li>
<li>RR：事务第一次一致性读时，或 <code>START TRANSACTION WITH CONSISTENT SNAPSHOT;</code> 执行当下立即创建。</li>
</ul>
<p><strong>Q2：为什么 RR 能可重复读？</strong></p>
<ul>
<li>因为<strong>整事务复用同一 Read View</strong>，后续一致性读都用同一快照判定可见性。</li>
</ul>
<p><strong>Q3：RR 是否靠锁避免幻读？</strong></p>
<ul>
<li>对<strong>当前读</strong>，靠 <strong>Next-Key 锁</strong>。</li>
<li>对<strong>一致性读</strong>，读的是快照，不会变，但要修改满足条件的行集仍需当前读加锁来防止并发插入/删除带来的幻影。</li>
</ul>
<p><strong>Q4：Read View 和快照隔离是一回事吗？</strong></p>
<ul>
<li>Read View 提供的是<strong>快照可见性</strong>，InnoDB 的 RR 实际效果接近/强于标准的 Snapshot Isolation，但写写冲突由锁解决。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG性能瓶颈突破：文档切分的核心逻辑与最优实践]]></title>    <link>https://juejin.cn/post/7597640029574119475</link>    <guid>https://juejin.cn/post/7597640029574119475</guid>    <pubDate>2026-01-21T10:54:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640029574119475" data-draft-id="7597642574933966857" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG性能瓶颈突破：文档切分的核心逻辑与最优实践"/> <meta itemprop="keywords" content="算法,后端"/> <meta itemprop="datePublished" content="2026-01-21T10:54:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小刘的大模型笔记"/> <meta itemprop="url" content="https://juejin.cn/user/678839484944233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG性能瓶颈突破：文档切分的核心逻辑与最优实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/678839484944233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小刘的大模型笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:54:46.000Z" title="Wed Jan 21 2026 10:54:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>引言</p>
<p>在检索增强生成（RAG）系统中，有一个看似基础却能决定系统成败的关键环节——文档切分。很多开发者搭建的RAG系统，检索结果不准确、生成内容驴唇不对马嘴，究其原因，往往是文档切分做得不到位。想象一下：如果把一篇完整的技术文档，拆成了语义断裂的碎片，向量数据库又怎么能检索到准确的信息？本文将从RAG的核心逻辑出发，深入浅出地讲解文档切分的原理，再通过具体的实践步骤，教大家如何通过科学的文档切分，让RAG系统的性能提升30%以上，同时分享新手也能轻松掌握的最优实践方案。</p>
<p>技术原理</p>
<ol>
<li>文档切分的核心作用：让检索更精准</li>
</ol>
<p>RAG系统的核心流程是“检索+生成”：先根据用户的查询，从向量数据库中检索相关的文档片段，再将这些片段作为上下文，输入到大模型中生成回复。而文档切分的作用，就是将长文档拆分成语义完整、粒度合适的文本块，让向量数据库能够精准匹配用户的查询意图。</p>
<p>简单来说，文档切分就像我们整理书架：如果把一堆书胡乱堆在一起，找一本书会非常困难；但如果按照主题分类、分册摆放，就能快速找到需要的内容。同理，合理的文档切分，能让向量数据库的检索效率和准确率大幅提升。</p>
<ol start="2">
<li>文档切分的三大核心原则</li>
</ol>
<ul>
<li>
<p>原则一：语义完整优先。这是文档切分的第一要义。无论采用哪种切分方式，都不能割裂文本的语义。比如，不能把一个完整的句子拆成两半，也不能把一个独立的技术知识点拆分开。语义完整的文本块，才能让向量模型学到准确的信息，检索结果才会更精准。</p>
</li>
<li>
<p>原则二：适配模型输入长度。不同的向量模型，有不同的输入长度限制（即token上限）。比如， text-embedding-ada-002 的输入上限是8191个token， bge-large-zh 的上限是512个token。切分后的文本块长度，必须小于模型的输入上限，否则会被截断，丢失关键信息。</p>
</li>
<li>
<p>原则三：设置重叠窗口。为了避免相邻文本块之间的语义断裂，需要设置一定的重叠窗口——也就是让前一个文本块的末尾，和后一个文本块的开头，有一部分内容重复。重叠窗口的大小，通常为文本块长度的10%-20%，这样能保证上下文的连贯性。</p>
</li>
</ul>
<ol start="3">
<li>三种常见的文档切分方式及优缺点</li>
</ol>
<ul>
<li>
<p>固定长度切分：最基础的切分方式，按照预设的token长度，将文档均匀拆分。优点是操作简单、效率高，适合结构化程度低的纯文本；缺点是容易割裂语义，比如把一个完整的段落拆成两半。</p>
</li>
<li>
<p>按语义结构切分：基于文档的自然结构进行拆分，比如按照段落、章节、标题等边界切分。优点是能保证语义完整，适合有明确结构的文档，比如技术手册、论文等；缺点是文本块长度不均，部分块可能超出模型输入上限。</p>
</li>
<li>
<p>混合切分：结合前两种方式的优点，是目前最优的切分方案。先按语义结构（段落、章节）进行初步拆分，再对过长的文本块，按照固定长度进行二次切分，并设置重叠窗口。这种方式兼顾了语义完整和长度适配，是大多数场景的首选。</p>
</li>
</ul>
<p>实践步骤</p>
<p>本次实践我们以“搭建一个技术文档RAG系统”为例，使用 LangChain 工具库，完成从文档切分到检索测试的全流程，步骤清晰，新手可直接复刻。</p>
<p>前置准备</p>
<ul>
<li>
<p>文档准备：选取一份10万字的Python技术手册（PDF格式）。</p>
</li>
<li>
<p>工具选择：使用 LangChain 进行文档处理和切分， Chroma 作为向量数据库， bge-large-zh 作为向量模型。</p>
</li>
<li>
<p>环境配置：安装依赖： pip install langchain chromadb sentence-transformers pypdf 。</p>
</li>
</ul>
<p>步骤1：文档加载与预处理</p>
<p>1. 使用 LangChain 的 PyPDFLoader 加载PDF文档：
 </p>
<p>2. 预处理文档：去除页眉页脚、空行等噪音数据，确保文本的整洁性。</p>
<p>步骤2：选择切分方式，进行文档切分</p>
<p>我们采用混合切分的方式，具体操作如下：</p>
<p>1. 先按段落切分： LangChain 的 RecursiveCharacterTextSplitter 支持按自然段落切分，先设置一个较大的chunk_size（比如2000个字符），让文本块先按段落拆分。</p>
<p>2. 设置重叠窗口：将 chunk_overlap 设置为200个字符（约为chunk_size的10%），避免语义断裂。</p>
<p>3. 配置切分器参数：
 </p>
<p>这里的 separators 参数非常关键，它定义了切分的优先级：先按空行切分（段落边界），再按换行符切分，最后按中文标点符号切分，确保语义完整。</p>
<p>步骤3：向量入库与检索测试</p>
<p>1. 加载向量模型：使用 bge-large-zh 模型生成文本块的向量：
 </p>
<p>2. 将切分后的文本块存入 Chroma 向量数据库：
 </p>
<p>3. 检索测试：输入用户查询“Python中的列表推导式怎么用”，查看检索结果：
 </p>
<p>如果检索结果中，包含了列表推导式的定义、语法和示例，说明文档切分是有效的。</p>
<p>从目前的发展趋势来看，大模型能力正在逐渐从“通用模型”走向“场景化模型”。与其等待一个什么都能做的超级模型，不如根据具体需求，对模型进行定向微调。像 LLaMA-Factory Online 这类平台，本质上就是在帮更多个人和小团队，参与到这条趋势里来，让“定制模型”变得不再只是大厂专属。而对于RAG系统来说，科学的文档切分，就是让场景化模型发挥作用的关键一步。</p>
<p>效果评估</p>
<p>文档切分的效果，直接决定了RAG系统的性能。我们可以从以下两个维度进行评估：</p>
<p>1. 定量评估</p>
<ul>
<li>
<p>检索召回率：选取100个用户常见的查询，统计检索结果中包含准确答案的比例。经过混合切分的RAG系统，召回率应不低于85%，比固定长度切分提升30%以上。</p>
</li>
<li>
<p>文本块长度分布：统计切分后的文本块长度，确保90%以上的文本块长度，在向量模型输入上限的80%以内，避免截断。</p>
</li>
</ul>
<p>2. 定性评估</p>
<ul>
<li>
<p>语义连贯性检查：随机抽取10个文本块，检查是否存在语义断裂的情况，比如句子不完整、知识点割裂等，语义完整率应达到100%。</p>
</li>
<li>
<p>生成效果评估：输入50个查询，查看大模型的生成回复，检查是否存在“答非所问”的情况，生成准确率应不低于80%。</p>
</li>
</ul>
<p>总结与展望</p>
<p>本文从原理到实践，完整拆解了文档切分在RAG系统中的核心作用和最优实践。可以看到，文档切分并非简单的“切割文本”，而是需要兼顾语义完整、模型适配和检索效率的技术活。对于新手来说，无需纠结复杂的理论，直接采用“混合切分+重叠窗口”的方案，就能解决大部分场景的问题。</p>
<p>未来，随着RAG技术的发展，文档切分也会朝着“智能化”的方向发展。比如，基于大模型的语义理解，实现动态切分；结合文档的类型和主题，自动调整切分粒度。掌握科学的文档切分方法，将帮助我们在搭建RAG系统时，少走弯路，更快地打造出高性能的检索增强生成系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[__CFRunLoopSourceComparator 函数详解]]></title>    <link>https://juejin.cn/post/7597650322408243252</link>    <guid>https://juejin.cn/post/7597650322408243252</guid>    <pubDate>2026-01-21T14:41:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408243252" data-draft-id="7597650322408226868" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="__CFRunLoopSourceComparator 函数详解"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-21T14:41:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            __CFRunLoopSourceComparator 函数详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:41:11.000Z" title="Wed Jan 21 2026 14:41:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>源码苹果开源库：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fswiftlang%2Fswift-corelibs-foundation%2Fblob%2Fmain%2FSources%2FCoreFoundation%2FCFRunLoop.c" target="_blank" title="https://github.com/swiftlang/swift-corelibs-foundation/blob/main/Sources/CoreFoundation/CFRunLoop.c" ref="nofollow noopener noreferrer">swift-corelibs-foundation/blob/main/Sources/CoreFoundation/CFRunLoop.c</a></p>
</blockquote>
<h3 data-id="heading-0">__CFRunLoopSourceComparator函数</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> CFComparisonResult __CFRunLoopSourceComparator(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *val1, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val2, <span class="hljs-type">void</span> *context) {
    CFRunLoopSourceRef o1 = (CFRunLoopSourceRef)val1;
    CFRunLoopSourceRef o2 = (CFRunLoopSourceRef)val2;
    
    <span class="hljs-comment">// 第一优先级：按 _order 排序</span>
    <span class="hljs-keyword">if</span> (o1-&gt;_order &lt; o2-&gt;_order) <span class="hljs-keyword">return</span> kCFCompareLessThan;
    <span class="hljs-keyword">if</span> (o2-&gt;_order &lt; o1-&gt;_order) <span class="hljs-keyword">return</span> kCFCompareGreaterThan;
    
    <span class="hljs-type">const</span> CFAbsoluteTime time1 = __CFRunLoopSourceGetSignaledTime(o1);
    <span class="hljs-type">const</span> CFAbsoluteTime time2 = __CFRunLoopSourceGetSignaledTime(o2);
    
    <span class="hljs-comment">// 第二优先级：按信号时间排序（先被 signal 的先处理）</span>
    <span class="hljs-keyword">if</span> (time1 &lt; time2) <span class="hljs-keyword">return</span> kCFCompareLessThan;
    <span class="hljs-keyword">if</span> (time1 &gt; time2) <span class="hljs-keyword">return</span> kCFCompareGreaterThan;
    
    <span class="hljs-keyword">return</span> kCFCompareEqualTo;
}
</code></pre>
<p>该函数用于对Source0数组进行排序。</p>
<p>排序会用到source的_order属性和_signaledTime属性。</p>
<ul>
<li>_order：Source 的优先级顺序（创建时指定）</li>
<li>_signaledTime：被信号标记的时间</li>
</ul>
<h3 data-id="heading-1">排序逻辑</h3>
<ol>
<li>
<p>先比较 _order 值</p>
<ul>
<li>_order 小的排前面（优先级高）</li>
<li>如果 _order 相等，继续比较</li>
</ul>
</li>
<li>
<p>再比较 _signaledTime（信号时间）</p>
<ul>
<li>时间早的排前面（先被 signal 的先处理）</li>
<li>这实现了 FIFO（先进先出）的公平性</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">设计意图</h3>
<ol>
<li>
<p>_order 优先：允许开发者控制 Source 的处理优先级。例如：重要的事件源可以设置较小的 order 值，确保优先处理</p>
</li>
<li>
<p>_signaledTime 次之：相同优先级时，保证公平性。先被 Signal 的 Source 先被处理，防止后来的 Source "插队"。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列模块化 [4 - 2]：逻辑与视图的极致分离（Headless UI）]]></title>    <link>https://juejin.cn/post/7597704040214970394</link>    <guid>https://juejin.cn/post/7597704040214970394</guid>    <pubDate>2026-01-22T02:02:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597704040214970394" data-draft-id="7597623395908714542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列模块化 [4 - 2]：逻辑与视图的极致分离（Headless UI）"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-22T02:02:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列模块化 [4 - 2]：逻辑与视图的极致分离（Headless UI）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:02:29.000Z" title="Thu Jan 22 2026 02:02:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>你是否经历过这样的场景：</p>
<p>你的团队维护了一个功能强大的 <code>&lt;SuperSelect /&gt;</code> 组件，集成了搜索、多选、远程加载、虚拟滚动。 某天，产品经理走过来说：“这个下拉框在移动端能不能变成一个从底部弹出的半屏抽屉（ActionSheet）？逻辑不变，就是样式改改。”</p>
<p>你看着那 2000 行包含着 <code>div</code>、<code>ul</code>、<code>li</code> 和无数 CSS 类的代码，陷入了绝望。你发现根本改不动，因为<strong>交互逻辑（打开/关闭/选中）</strong> 和 <strong>DOM 结构</strong> 像是纠缠在一起的藤蔓，剪不断理还乱。</p>
<p>这就是<strong>逻辑与视图强耦合</strong>的代价。</p>
<p>本篇我们将探讨 <strong>Headless UI（无头组件）</strong> 模式。它不仅是 Shadcn/UI、TanStack Table 背后的秘密武器，更是前端架构师解耦复杂业务组件的必修课。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afd63f6ae0634533a6bf22aff928f98e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652149&amp;x-signature=Zy%2FVQMLztStyIV%2BfCE3AGXRAkEI%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 进化的必然：从“全家桶”到“发动机”</h2>
<p>在组件化发展的早期（Bootstrap、AntD v3 时代），我们推崇的是 <strong>"All-in-One"</strong> 模式。一个组件包办一切：</p>
<ul>
<li><strong>状态（State）：</strong> <code>isOpen</code>, <code>selectedIndex</code></li>
<li><strong>行为（Behavior）：</strong> 点击打开、键盘回车选中、ESC 关闭</li>
<li><strong>样式（Style）：</strong> CSS Class, Styled-components</li>
<li><strong>结构（Markup）：</strong> <code>&lt;div&gt;</code>, <code>&lt;span&gt;</code></li>
</ul>
<p>这种模式在业务初期跑得很快，但随着设计系统的迭代，它很快就会变成**“配置地狱”**。你一定见过这种组件 API：</p>
<pre><code class="hljs language-ini" lang="ini">// 典型的“过度封装”组件
&lt;Table 
  <span class="hljs-attr">data</span>={data}
  <span class="hljs-attr">useVirtualScroll</span>={<span class="hljs-literal">true</span>}
  // 为了改一个样式，不得不暴露无数个 render props
  <span class="hljs-attr">renderHeader</span>={(props) =&gt; &lt;div className=<span class="hljs-string">"bg-red-500"</span> {...props} /&gt;} 
  <span class="hljs-attr">rowClassName</span>={(record) =&gt; record.active ? <span class="hljs-string">'bg-blue'</span> : <span class="hljs-string">''</span>}
  <span class="hljs-attr">dropdownStyle</span>={{ zIndex: <span class="hljs-number">9999</span> }} // 甚至开始直接透传 CSS
/&gt;
</code></pre>
<p><strong>架构反思：</strong> 这种设计的本质错误在于：<strong>试图用有限的配置（Props），去穷尽无限的 UI 变化。</strong> 视图（View）是易变的，就像时尚潮流；而逻辑（Logic）是相对稳定的，就像人体骨骼。把它们焊死在一起，必然会导致僵化。</p>
<p>于是，Headless UI 应运而生。它的核心哲学只有一句话：<strong>我给你提供逻辑的“发动机”，你自己去造“车壳子”。</strong></p>
<hr/>
<h2 data-id="heading-1">二、 Headless UI 的解剖学：只有大脑，没有皮肤</h2>
<p>所谓的“无头”，指的是<strong>不渲染具体的 DOM 节点（或者只渲染最语义化的标签），不包含任何样式</strong>，只负责提供交互逻辑和可访问性（A11y）。</p>
<h3 data-id="heading-2">2.1 两种主流实现形态</h3>
<p>在 React 和 Vue 的现代生态中，Headless 主要有两种落地形态：</p>
<h4 data-id="heading-3">形态一：Hooks / Composables (纯逻辑层)</h4>
<p>这是最彻底的分离。组件完全消失，只剩下一个函数。</p>
<ul>
<li>
<p><strong>React 示例 (useToggle):</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Headless 逻辑</span>
<span class="hljs-function">function <span class="hljs-title">useToggle</span>()</span> {
  <span class="hljs-keyword">const</span> [<span class="hljs-keyword">on</span>, setOn] = useState(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> toggle = () =&gt; setOn(!<span class="hljs-keyword">on</span>);
  <span class="hljs-comment">// 返回状态和绑定到 DOM 上的属性</span>
  <span class="hljs-keyword">return</span> { 
    <span class="hljs-keyword">on</span>, 
    toggle, 
    togglerProps: { 
      <span class="hljs-string">'aria-pressed'</span>: <span class="hljs-keyword">on</span>, 
      onClick: toggle 
    } 
  };
}

<span class="hljs-comment">// UI 实现 A：普通的按钮</span>
<span class="hljs-function">function <span class="hljs-title">ButtonToggle</span>()</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">on</span>, togglerProps } = useToggle();
  <span class="hljs-keyword">return</span> &lt;button {...togglerProps}&gt;{<span class="hljs-keyword">on</span> ? <span class="hljs-string">'ON'</span> : <span class="hljs-string">'OFF'</span>}&lt;/button&gt;;
}

<span class="hljs-comment">// UI 实现 B：复杂的 Switch 开关</span>
<span class="hljs-function">function <span class="hljs-title">SwitchToggle</span>()</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">on</span>, togglerProps } = useToggle();
  <span class="hljs-keyword">return</span> (
    &lt;div {...togglerProps} className={`<span class="hljs-keyword">switch</span> ${<span class="hljs-keyword">on</span> ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}`}&gt;
      &lt;div className=<span class="hljs-string">"slider"</span> /&gt;
    &lt;/div&gt;
  );
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-4">形态二：Render Props / Slots (组件容器层)</h4>
<p>这种形态通常用于涉及<strong>父子组件通信</strong>的复杂场景（如 Select, Tabs）。它负责处理 DOM 的层级关系和键盘导航，但把渲染权交还给用户。</p>
<ul>
<li><strong>代表库：</strong> Headless UI (Tailwind Labs), Radix UI.</li>
</ul>

<pre><code class="hljs language-xml" lang="xml">// Radix UI 风格
<span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Root</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">"tab1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.List</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Trigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab1"</span>&gt;</span>Account<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Trigger</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Trigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab2"</span>&gt;</span>Password<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Trigger</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.List</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Content</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab1"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Content</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Content</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab2"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Content</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Root</span>&gt;</span>
</code></pre>
<p>注意：这里的 <code>&lt;Tabs.Root&gt;</code> 并不强制你输出特定的 <code>div</code> 结构，它主要负责<strong>上下文（Context）的传递</strong>和<strong>键盘焦点的管理</strong>。</p>
<hr/>
<h2 data-id="heading-5">三、 架构师的实战：如何设计一个 Headless 组件？</h2>
<p>假设我们要设计一个企业级的 <strong>Datepicker（日期选择器）</strong> 。如果按照传统思路，你会被 CSS 搞死。如果按照 Headless 思路，你应该关注什么？</p>
<h3 data-id="heading-6">3.1 步骤一：提取“纯数据模型”</h3>
<p>首先，剥离任何与 DOM 无关的数学逻辑。这部分代码应该是纯 JS/TS，可以在 Node.js 里跑单测。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">CalendarModel</span> {
  <span class="hljs-comment">// 给定年月，返回一个 6x7 的二维数组，包含日期、是否是上月残留、是否禁用等信息</span>
  <span class="hljs-selector-tag">generateGrid</span>(<span class="hljs-attribute">year</span>: number, <span class="hljs-attribute">month</span>: number): <span class="hljs-selector-tag">DateCell</span><span class="hljs-selector-attr">[]</span><span class="hljs-selector-attr">[]</span> { ... }
  
  <span class="hljs-comment">// 判断两个日期是否相等</span>
  <span class="hljs-selector-tag">isSameDate</span>(<span class="hljs-attribute">d1</span>: Date, <span class="hljs-attribute">d2</span>: Date): <span class="hljs-selector-tag">boolean</span> { ... }
}
</code></pre>
<h3 data-id="heading-7">3.2 步骤二：封装“交互钩子”</h3>
<p>接下来，处理用户的交互行为。这是 Headless 的核心。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// useCalendar.ts</span>
export function <span class="hljs-built_in">useCalendar</span>({ selectedDate, onChange }) {
  const <span class="hljs-selector-attr">[viewDate, setViewDate]</span> = <span class="hljs-built_in">useState</span>(new Date()); <span class="hljs-comment">// 当前查看的月份</span>

  const <span class="hljs-attribute">grid</span> = <span class="hljs-built_in">useMemo</span>(() =&gt; new <span class="hljs-built_in">CalendarModel</span>()<span class="hljs-selector-class">.generateGrid</span>(...), <span class="hljs-selector-attr">[viewDate]</span>);

  const selectDate = (date) =&gt; {
    <span class="hljs-built_in">onChange</span>(date);
    <span class="hljs-comment">// 只有逻辑，没有样式</span>
  };

  const nextMonth = () =&gt; <span class="hljs-built_in">setViewDate</span>(d =&gt; addMonths(d, <span class="hljs-number">1</span>));

  <span class="hljs-comment">// 关键：返回 Props Getter 而不是直接返回 JSX</span>
  <span class="hljs-comment">// 这就是 Inversion of Control (控制反转)</span>
  const getDayProps = (dateCell) =&gt; ({
    onClick: () =&gt; <span class="hljs-built_in">selectDate</span>(dateCell.date),
    role: <span class="hljs-string">'gridcell'</span>,
    <span class="hljs-string">'aria-selected'</span>: <span class="hljs-built_in">isSameDate</span>(dateCell.date, selectedDate),
    <span class="hljs-string">'aria-disabled'</span>: dateCell.disabled,
    tabIndex: <span class="hljs-built_in">isSameDate</span>(dateCell.date, viewDate) ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>, // 键盘导航逻辑
  });

  return { <span class="hljs-attribute">grid</span>, viewDate, nextMonth, getDayProps };
}
</code></pre>
<h3 data-id="heading-8">3.3 步骤三：注入视图（UI层）</h3>
<p>最后，才是业务开发者干活的地方。</p>
<pre><code class="hljs language-ini" lang="ini">function MyDatePicker() {
  const { grid, getDayProps } = useCalendar({...})<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"my-calendar-wrapper"</span>&gt;
      {grid.map(<span class="hljs-attr">row</span> =&gt; (
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"row"</span>&gt;
          {row.map(<span class="hljs-attr">cell</span> =&gt; (
            // 只需要解构 props，所有的交互、A11y 自动生效
            &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"cell"</span> {...getDayProps(cell)}&gt;
              {cell.date.getDate()}
            &lt;/span&gt;
          ))}
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>架构收益：</strong></p>
<ol>
<li><strong>UI 自由：</strong> 你可以用 <code>table</code> 渲染，也可以用 <code>div</code>+<code>flex</code> 渲染，甚至可以在 Canvas 里渲染（只要能透传事件）。</li>
<li><strong>测试稳定：</strong> 你只需要针对 <code>useCalendar</code> 编写逻辑测试用例，覆盖率 100%。UI 层的变化不会导致逻辑测试失败。</li>
<li><strong>多端复用：</strong> 这个 <code>useCalendar</code> 可以无缝移植到 React Native，因为里面没有 <code>HTMLDivElement</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-9">四、 复杂度的克星：TanStack Table 的启示</h2>
<p>如果说 toggle 是小儿科，那么表格（Table）就是前端复杂度的珠穆朗玛峰。 <strong>TanStack Table (原 React Table)</strong> 是 Headless 理念的集大成者。</p>
<p>它<strong>拒绝渲染任何 HTML</strong>。它不给你 <code>&lt;Table&gt;</code> 组件，它给你的是：</p>
<ul>
<li><code>useReactTable()</code> 钩子</li>
<li><code>getRowModel()</code> 核心算法</li>
<li><code>getSortedRowModel()</code> 排序算法</li>
</ul>
<p>开发者： <em>"那表格长什么样？"</em> TanStack：*"我怎么知道？你可以用 HTML table，也可以用 CSS Grid 模拟的虚拟列表 div。我只告诉你，第二行第三列的数据是什么，以及它现在是不是被选中状态。"</p>
<p><strong>这种设计带来的爆发力是惊人的：</strong> 企业 A 想要一个类似 Excel 的表格；企业 B 想要一个类似 Trello 的看板（本质也是数据列表）。 在 Headless 架构下，它们可以使用<strong>同一套核心逻辑（排序、筛选、分页、分组）</strong> ，仅仅是 View 层不同。这在传统组件库（如 AntD Table）中是几乎不可能做到的。</p>
<hr/>
<h2 data-id="heading-10">五、 陷阱与权衡：何时不该 Headless？</h2>
<p>Headless UI 虽然优雅，但它是<strong>高成本</strong>的。</p>
<h3 data-id="heading-11">5.1 缺点：</h3>
<ol>
<li><strong>上手门槛高：</strong> 开发者不能“开箱即用”。为了画一个简单的下拉框，可能需要写 50 行代码来组装 Headless 的各个部件。</li>
<li><strong>样式管理负担：</strong> 所有 CSS 都要自己写，或者依赖 Tailwind。</li>
</ol>
<h3 data-id="heading-12">5.2 架构分层策略</h3>
<p>作为架构师，你不应该让所有业务开发都直接使用 Headless 底层。你应该采用 <strong>“三层架构”</strong> ：</p>
<ol>
<li>
<p><strong>Level 1: Headless Core (逻辑层)</strong></p>
<ul>
<li>使用 <code>useSelect</code>, <code>Radix Select</code>。</li>
<li>处理 ARIA、键盘事件、状态管理。</li>
<li><em>面向对象：资深开发 / 架构组。</em></li>
</ul>
</li>
<li>
<p><strong>Level 2: Styled System Component (标准组件层)</strong></p>
<ul>
<li>引入公司的 Design Token。</li>
<li>封装样式：<code>&lt;CompanySelect /&gt;</code> = <code>Radix Select</code> + <code>Tailwind Classes</code>。</li>
<li><em>面向对象：业务线通用开发。</em></li>
</ul>
</li>
<li>
<p><strong>Level 3: Business Component (业务组件层)</strong></p>
<ul>
<li>绑定业务数据：<code>&lt;UserSelect /&gt;</code> = <code>&lt;CompanySelect /&gt;</code> + <code>fetchUserList API</code>。</li>
<li><em>面向对象：初级开发 / 实习生。</em></li>
</ul>
</li>
</ol>
<p>通过这种分层，我们既保留了 Headless 的灵活性（底层可换），又保证了业务开发的高效性（顶层开箱即用）。</p>
<hr/>
<h2 data-id="heading-13">结语：控制反转的艺术</h2>
<p>组件化设计的最高境界，不是你帮用户把所有事情都做了，而是<strong>你把控制权优雅地交还给用户</strong>。</p>
<p>Headless UI 就像是把组件的“灵魂”提取了出来，允许用户随心所欲地塑造“肉体”。理解了这一点，你就掌握了应对前端需求万变不离其宗的法门。</p>
<blockquote>
<p><strong>Next Step:</strong> 有了灵活的组件骨架（Headless UI），如果组件之间需要复杂的通信（比如一个树形组件，子节点要通知祖先节点），或者需要跨层级的状态共享，仅仅靠 Props 传递显然是不够的。 下一节，我们将探讨**《第三篇：骨架（下）——组件化深度设计：复杂组件的通信与组合模式》**</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你可能没有那么了解 RecycleView]]></title>    <link>https://juejin.cn/post/7597650322408472628</link>    <guid>https://juejin.cn/post/7597650322408472628</guid>    <pubDate>2026-01-22T00:13:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408472628" data-draft-id="7596670644286439424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你可能没有那么了解 RecycleView"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-22T00:13:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你可能没有那么了解 RecycleView
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:13:06.000Z" title="Thu Jan 22 2026 00:13:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7596905015367483392" target="_blank" title="https://juejin.cn/post/7596905015367483392">剧情</a>里涉及的开发细节。</em></p>
<h2 data-id="heading-0">RecyclerView 的内部工作原理</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52a2be7546b45e4945f68dbbc64e3fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769645585&amp;x-signature=FNrQ8yi507EbhGQTB%2Fpj%2BP60ljM%3D" alt="00.png" loading="lazy"/></p>
<p><code>RecyclerView</code> 是一个实用且灵活的 Android 组件，旨在通过复用 <code>ItemView</code>（而非重复创建新 <code>View</code>）来高效显示大型数据集。它通过一种类似对象池的机制（即 <code>ViewHolder</code> 模式）管理 <code>View</code>，从而实现了这种高效性。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>与 <code>ListView</code> 相比，<code>RecyclerView</code> 的 <code>ViewHolder</code> 模式如何提升性能？</p>
<p>请解释 <code>ViewHolder</code> 从创建到被回收的生命周期。</p>
<p>什么是 <code>RecycledViewPool</code>？如何使用它来优化 <code>ItemView</code> 的渲染？</p>
<h3 data-id="heading-2">核心概念</h3>
<ol>
<li><strong>View 复用</strong>：<code>RecyclerView</code> 会复用现有 <code>View</code>，而不是为数据集中的每个 <code>Item</code> 创建新 <code>View</code>。当一个 <code>View</code> 滚动出可见区域时，它会被添加到一个 <code>View</code> 池（称为 <code>RecyclerView.RecycledViewPool</code>）中，而不是被销毁。当新 <code>Item</code> 进入可见区域时，<code>RecyclerView</code> 会从该池中获取一个可用的 <code>View</code>（如果有的话），从而避免了 <code>inflate</code> 带来的开销。</li>
<li><strong>ViewHolder 模式</strong>：<code>RecyclerView</code> 使用 <code>ViewHolder</code> 来存储 <code>Item</code> 布局中 <code>View</code> 的引用。这避免了在绑定过程中频繁调用 <code>findViewById()</code>，通过减少布局遍历和 <code>View</code> 查找来提升性能。</li>
<li><strong>Adapter 的作用</strong>：<code>RecyclerView.Adapter</code> 作为数据源和 <code>RecyclerView</code> 之间的桥梁。<code>Adapter</code> 的 <code>onBindViewHolder()</code> 方法会将数据绑定到被复用的 <code>View</code> 上，因此只需要更新可见的 <code>Item</code>。</li>
<li><strong>RecycledViewPool</strong>：<code>RecycledViewPool</code> 充当对象池，存储未使用的 <code>View</code>。它允许 <code>RecyclerView</code> 在多个列表或具有相似 <code>View</code> 类型的 Section 之间复用 <code>View</code>，进一步优化内存使用。</li>
</ol>
<h3 data-id="heading-3">复用机制的工作流程</h3>
<ol>
<li><strong>滚动与 Item 可见性</strong>：当用户滚动时，移出屏幕的 <code>Item</code> 会从 <code>RecyclerView</code> 中分离，但不会被销毁。相反，它们会被添加到 <code>RecycledViewPool</code>。</li>
<li><strong>将数据重新绑定到复用的 View</strong>：当新 <code>Item</code> 进入可见区域时，<code>RecyclerView</code> 首先检查 <code>RecycledViewPool</code> 中是否有可用的对应类型 <code>View</code>。如果找到匹配项，它会复用该 <code>View</code>，并通过 <code>onBindViewHolder()</code> 将新数据绑定到其上。</li>
<li><strong>如果没有可用 View 则 inflate</strong>：如果池中没有合适的 <code>View</code>，<code>RecyclerView</code> 会通过 <code>onCreateViewHolder()</code> <code>inflate</code> 一个新 <code>View</code>。</li>
<li><strong>高效内存使用</strong>：通过复用 <code>View</code>，<code>RecyclerView</code> 减少了内存分配和垃圾回收，这在处理大型数据集或频繁滚动的场景中可能导致性能问题。</li>
</ol>
<p>下面是一个基础 <code>RecyclerView.Adapter</code> 实现示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataList: List&lt;String&gt;) : RecyclerView.Adapter&lt;MyAdapter.MyViewHolder&gt;() {

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: MyViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> MyViewHolder(view)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">MyViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.textView.text = dataList[position]
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = dataList.size
}
</code></pre>
<p><code>RecyclerView</code> 对象池方式有下面这些优势：</p>
<ol>
<li><strong>提升性能</strong>：复用 <code>View</code> 减少了 <code>inflate</code> 新布局的开销，使滚动更流畅，性能更好。</li>
<li><strong>高效内存管理</strong>：对象池减少了内存分配，并通过复用 <code>View</code> 避免了频繁的垃圾回收。</li>
<li><strong>可定制性</strong>：<code>RecycledViewPool</code> 可以定制，以管理每种类型 <code>View</code> 的最大数量，允许开发者针对特定场景优化行为。</li>
</ol>
<h3 data-id="heading-4">总结</h3>
<p><code>RecyclerView</code> 采用了高效的对象池机制，未使用的 <code>View</code> 存储在 <code>RecycledViewPool</code> 中，并在需要时复用。这种设计与 <code>ViewHolder</code> 模式相结合，减少了内存使用和布局开销，提升了性能，使其成为 Android 应用中显示大型数据集的必备工具。</p>
<p>如果你还记得设计模式中享元模式的话，<code>RecyclerView</code> 就是这种思想的优良实现。</p>

























<table><thead><tr><th>享元模式要素</th><th><code>RecyclerView</code> 中的对应实现</th></tr></thead><tbody><tr><td>内部状态</td><td><code>ItemView</code> 的布局结构（XML 定义的视图层级） —— 这些是可复用、不可变的部分</td></tr><tr><td>外部状态</td><td>每个 item 的具体数据（如文本内容、图片 URL、颜色等） —— 在 <code>onBindViewHolder()</code> 中动态绑定</td></tr><tr><td>享元工厂</td><td><code>RecyclerView.RecycledViewPool</code> + <code>LayoutManager</code> 的回收/复用逻辑 —— 负责创建、缓存和分发 <code>ViewHolder</code></td></tr><tr><td>享元对象</td><td><code>RecyclerView.ViewHolder</code> 实例 —— 封装了 <code>itemView</code>，本身不包含业务数据</td></tr></tbody></table>
<h3 data-id="heading-5">进阶：不同类型的 Item</h3>
<p><code>RecyclerView</code> 具有高度的灵活性，支持在同一个列表中显示多种 <code>Item</code> 类型。要实现这一点，你需要结合自定义 <code>Adapter</code>、<code>ItemView</code> 类型和适当的布局。关键在于正确区分 <code>Item</code> 类型并进行绑定。</p>
<p>实现多 <code>Item</code> 类型需要如下步骤：</p>
<ol>
<li><strong>定义 <code>Item</code> 类型</strong>：每种 <code>Item</code> 类型由唯一的标识符表示，通常是一个整数常量。这些标识符允许 <code>Adapter</code> 在创建和绑定 <code>View</code> 时区分不同的 <code>Item</code> 类型。</li>
<li><strong>重写 <code>getItemViewType()</code></strong> ：在 <code>Adapter</code> 中重写此方法，为数据集中的每个 <code>Item</code> 返回适当的类型。该方法帮助 <code>RecyclerView</code> 确定需要布局的类型。</li>
<li><strong>处理多个 <code>ViewHolder</code></strong> ：为每种 <code>Item</code> 类型创建单独的 <code>ViewHolder</code> 类。每个 <code>ViewHolder</code> 负责将数据绑定到其对应的 <code>View</code>。</li>
<li><strong>根据 <code>View</code> 类型布局</strong>：在 <code>onCreateViewHolder()</code> 方法中，根据 <code>getItemViewType()</code> 返回的 <code>View</code> 类型进行布局。</li>
<li><strong>相应地绑定数据</strong>：在 <code>onBindViewHolder()</code> 方法中，检查 <code>Item</code> 类型并使用对应的 <code>ViewHolder</code> 绑定数据。</li>
</ol>
<p>下面是一个实现多 <code>Item</code> 类型的示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTypeAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;ListItem&gt;) : RecyclerView.Adapter&lt;RecyclerView.ViewHolder&gt;() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_HEADER = <span class="hljs-number">0</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_CONTENT = <span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemViewType</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (items[position]) {
            <span class="hljs-keyword">is</span> ListItem.Header -&gt; TYPE_HEADER
            <span class="hljs-keyword">is</span> ListItem.Content -&gt; TYPE_CONTENT
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: RecyclerView.ViewHolder {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (viewType) {
            TYPE_HEADER -&gt; {
                <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_header, parent, <span class="hljs-literal">false</span>)
                HeaderViewHolder(view)
            }
            TYPE_CONTENT -&gt; {
                <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_content, parent, <span class="hljs-literal">false</span>)
                ContentViewHolder(view)
            }
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"Invalid view type"</span>)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">when</span> (holder) {
            <span class="hljs-keyword">is</span> HeaderViewHolder -&gt; holder.bind(items[position] <span class="hljs-keyword">as</span> ListItem.Header)
            <span class="hljs-keyword">is</span> ContentViewHolder -&gt; holder.bind(items[position] <span class="hljs-keyword">as</span> ListItem.Content)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = items.size

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeaderViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> title: TextView = itemView.findViewById(R.id.headerTitle)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">ListItem</span>.<span class="hljs-type">Header</span>)</span></span> {
            title.text = item.title
        }
    }

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> content: TextView = itemView.findViewById(R.id.contentText)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">ListItem</span>.<span class="hljs-type">Content</span>)</span></span> {
            content.text = item.text
        }
    }
}

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListItem</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Header</span>(<span class="hljs-keyword">val</span> title: String) : ListItem()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Content</span>(<span class="hljs-keyword">val</span> text: String) : ListItem()
}
</code></pre>
<p>要点提示</p>
<ol>
<li><strong>效率</strong>：<code>RecyclerView</code> 会复用 <code>ViewHolder</code>，处理多种 <code>Item</code> 类型不会影响性能。每种 <code>Item</code> 类型通过 <code>getItemViewType()</code> 方法和正确的绑定得到高效管理。</li>
<li><strong>清晰分离</strong>：每种 <code>Item</code> 类型都有自己的布局和 <code>ViewHolder</code>，确保关注点分离和代码更清晰。</li>
<li><strong>可扩展性</strong>：添加新的 <code>Item</code> 类型只需最小的改动。你只需定义一个新布局、一个 <code>ViewHolder</code>，并调整 <code>getItemViewType()</code> 和 <code>onCreateViewHolder()</code> 中的逻辑。</li>
</ol>
<p>总而言之，要在 <code>RecyclerView</code> 中实现多种 <code>Item</code> 类型，需结合 <code>getItemViewType()</code> 确定每个 <code>Item</code> 的类型、为每种类型使用单独的 <code>ViewHolder</code>，以及为每种类型使用不同的布局。这种方法确保 <code>RecyclerView</code> 在支持统一列表中的多样内容时，仍然保持高效和可扩展。</p>
<h3 data-id="heading-6">进阶：提升性能</h3>
<p>你可以通过使用 <code>ListAdapter</code> 和 <code>DiffUtil</code> 来提升 <code>RecyclerView</code> 的性能。</p>
<p><code>DiffUtil</code> 是 Android 中的一个工具类，用于计算两个列表之间的差异，并更高效地更新 <code>RecyclerView.Adapter</code>。</p>
<p>通过利用 <code>DiffUtil</code>，你可以避免不必要地调用 <code>notifyDataSetChanged()</code>，这会导致列表中所有 <code>Item</code> 都被低效重绘。相反，<code>DiffUtil</code> 能在细粒度级别识别变化并仅更新受影响的 <code>Item</code>。</p>
<p><code>RecyclerView</code> 的默认行为是在数据变化时重新绑定并重绘所有可见 <code>Item</code>，即使大多数 <code>Item</code> 保持不变。</p>
<p>这样做会降低性能，尤其是在处理大型数据集时。<code>DiffUtil</code> 通过计算所需的最小更新集（插入、删除和修改）并直接应用于 <code>Adapter</code> 来优化这一点。</p>
<p>使用 <code>DiffUtil</code> 的步骤入校</p>
<ol>
<li><strong>创建 <code>DiffUtil</code> 回调</strong>：实现自定义的 <code>DiffUtil.ItemCallback</code> 或扩展 <code>DiffUtil.Callback</code>。该类定义了如何计算新旧列表之间的差异。</li>
<li><strong>向 <code>Adapter</code> 提供列表更新</strong>：当新数据到达时，将其传递给 <code>Adapter</code>，并使用 <code>DiffUtil</code> 计算差异。通过 <code>submitList()</code>（如果你使用 <code>ListAdapter</code>）或 <code>notifyItemChanged()</code>（对于自定义 <code>Adapter</code>）等方法将这些变化应用到 <code>Adapter</code>。</li>
<li><strong>将 <code>DiffUtil</code> 与 <code>RecyclerView.Adapter</code> 绑定</strong>：将 <code>DiffUtil</code> 集成到 <code>Adapter</code> 中，自动处理更新。</li>
</ol>
<p>我们来看下为 <code>RecyclerView</code> 实现 <code>DiffUtil</code> 的示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDiffUtilCallback</span> : <span class="hljs-type">DiffUtil.ItemCallback</span>&lt;<span class="hljs-type">MyItem</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">areItemsTheSame</span><span class="hljs-params">(oldItem: <span class="hljs-type">MyItem</span>, newItem: <span class="hljs-type">MyItem</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 检查 Item 是否代表相同的数据（例如，相同的 ID）</span>
        <span class="hljs-keyword">return</span> oldItem.id == newItem.id
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">areContentsTheSame</span><span class="hljs-params">(oldItem: <span class="hljs-type">MyItem</span>, newItem: <span class="hljs-type">MyItem</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 检查 Item 的内容是否相同</span>
        <span class="hljs-keyword">return</span> oldItem == newItem
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">ListAdapter</span>&lt;<span class="hljs-type">MyItem, MyViewHolder</span>&gt;(MyDiffUtilCallback()) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: MyViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> MyViewHolder(view)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">MyViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.bind(getItem(position))
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">MyItem</span>)</span></span> {
        textView.text = item.name
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">val</span> adapter = MyAdapter()
recyclerView.adapter = adapter

<span class="hljs-keyword">val</span> oldList = listOf(MyItem(<span class="hljs-number">1</span>, <span class="hljs-string">"Old Item"</span>), MyItem(<span class="hljs-number">2</span>, <span class="hljs-string">"Another Item"</span>))
<span class="hljs-keyword">val</span> newList = listOf(MyItem(<span class="hljs-number">1</span>, <span class="hljs-string">"Updated Item"</span>), MyItem(<span class="hljs-number">3</span>, <span class="hljs-string">"New Item"</span>))

<span class="hljs-comment">// 自动计算差异并更新 RecyclerView</span>
adapter.submitList(newList)
</code></pre>
<p><code>DiffUtil</code> 有如下主要优势：</p>
<ol>
<li><strong>提升性能</strong>：无需刷新整个列表，仅更新修改过的 <code>Item</code>，减少了渲染开销。</li>
<li><strong>细粒度更新</strong>：单独处理 <code>Item</code> 的插入、删除和修改，使动画更流畅、更自然。</li>
<li><strong>与 <code>ListAdapter</code> 无缝集成</strong>：<code>ListAdapter</code> 是 Android <strong>Jetpack</strong> 库中现成的 <code>Adapter</code>，它直接集成了 <code>DiffUtil</code>，减少了样板代码。</li>
</ol>
<p>不过注意：</p>
<ol>
<li><strong>大型列表的开销</strong>：虽然 <code>DiffUtil</code> 很高效，但计算非常大的列表之间的差异可能会消耗大量计算资源。在这种情况下，请谨慎使用。</li>
<li><strong>不可变数据</strong>：确保你的数据模型是不可变的。当 <code>DiffUtil</code> 尝试计算变化时，可变数据可能导致不一致。如果对这项有疑问，看<a href="https://juejin.cn/post/7498550831828942863" target="_blank" title="https://juejin.cn/post/7498550831828942863">这里</a>。</li>
</ol>
<p>总之，在 <code>RecyclerView</code> 中使用 <code>DiffUtil</code> 可以通过仅应用必要的更新（而非重绘整个列表）来提升性能。借助 <code>DiffUtil.ItemCallback</code> 和 <code>ListAdapter</code>，你可以高效管理更新，创建更流畅的动画，并提升 UI 的整体响应速度。这种方法在处理频繁变化的数据集或大型列表时尤其有价值。</p>
<h2 data-id="heading-7">ConstraintLayout</h2>
<p><code>ConstraintLayout</code> 是 Android 中引入的一种灵活且强大的布局，用于创建复杂的响应式用户界面，无需嵌套多层布局。它允许你通过相对于其他 <code>View</code> 或父容器的约束来定义 <code>View</code> 的位置和尺寸。这消除了深度嵌套的 <code>View</code> 层级，提升了性能和可读性。</p>
<p><code>ConstraintLayout</code> 简直就是单层布局的杀手锏，配合 <code>RecycleView</code> 优化布局，也能提升不少布局的性能。</p>
<h3 data-id="heading-8">面试问题</h3>
<p>与嵌套的 <code>LinearLayout</code> 和 <code>RelativeLayout</code> 相比，<code>ConstraintLayout</code> 如何提升性能？</p>
<p>请提供一个场景说明何时使用 <code>ConstraintLayout</code> 会更高效。</p>
<p>请解释 <code>ConstraintLayout</code> 中 <code>match_constraint(0dp)</code> 的行为。它与 <code>wrap_content</code> 和 <code>match_parent</code> 有何不同？在什么情况下会使用它？</p>
<h3 data-id="heading-9">核心特性</h3>
<ol>
<li><strong>基于约束的定位</strong>：<code>View</code> 可以相对于同级 <code>View</code> 或父布局，通过对齐、居中、锚定等约束进行定位。</li>
<li><strong>灵活的尺寸控制</strong>：提供 <code>match_constraint</code>、<code>wrap_content</code> 和固定尺寸等选项，便于设计响应式布局。</li>
<li><strong>链与参考线支持</strong>：链可以让多个 <code>View</code> 在水平或垂直方向上等距分组；参考线则支持基于固定或百分比位置的对齐。</li>
<li><strong>屏障与分组</strong>：屏障会根据引用 <code>View</code> 的尺寸动态调整位置；分组可简化多个 <code>View</code> 的可见性变更。</li>
<li><strong>性能提升</strong>：减少了多层嵌套布局的需求，使布局渲染更快，性能更优。</li>
</ol>
<p>以下代码演示了一个包含 <code>TextView</code> 和 <code>Button</code> 的简单布局，其中 <code>Button</code> 位于 <code>TextView</code> 下方并水平居中。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>
    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/title"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Hello, World!"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/button"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Click Me"</span>
        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">"@id/title"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">优势</h3>
<ol>
<li><strong>扁平化 <code>View</code> 层级</strong>：与嵌套的 <code>LinearLayout</code> 或 <code>RelativeLayout</code> 不同，<code>ConstraintLayout</code> 支持扁平化层级，提升渲染性能并简化布局管理。</li>
<li><strong>响应式设计</strong>：提供百分比约束、屏障等工具，可适配不同屏幕尺寸和方向的布局。</li>
<li><strong>内置工具支持</strong>：Android Studio 的布局编辑器为 <code>ConstraintLayout</code> 提供了可视化设计界面，便于创建和调整约束，不过我这里需要吐糟一句，这个工具一点都不好用，因为很多对齐的尺寸边距都是硬编码，没有复用。</li>
<li><strong>高级功能</strong>：链、参考线和屏障无需额外代码或嵌套布局即可简化复杂 UI 设计。</li>
</ol>
<h3 data-id="heading-11">局限性</h3>
<p>任何布局方式都有局限性：</p>
<ol>
<li><strong>简单布局的冗余性</strong>：对于简单布局，使用 <code>LinearLayout</code> 或 <code>FrameLayout</code> 就足够了，此时 <code>ConstraintLayout</code> 可能显得过于复杂。</li>
<li><strong>学习曲线</strong>：需要理解约束和高级功能，对初学者可能有一定挑战。</li>
</ol>
<h3 data-id="heading-12">适用场景</h3>
<ol>
<li><strong>响应式 UI</strong>：适合需要精确对齐并适配不同屏幕尺寸的设计。</li>
<li><strong>复杂布局</strong>：适合包含多个重叠元素或精细定位需求的 UI。</li>
<li><strong>性能优化</strong>：通过用单一的扁平结构替换嵌套层级，帮助优化布局性能。</li>
</ol>
<h3 data-id="heading-13">总结</h3>
<p><code>ConstraintLayout</code> 是一种多功能且高效的布局，用于设计 Android UI。它消除了嵌套布局的需求，提供了强大的定位和对齐工具，并提升了性能。虽然存在一定的学习曲线，但掌握 <code>ConstraintLayout</code> 可以让开发者高效创建响应式且视觉吸引力强的布局。</p>
<h2 data-id="heading-14">SurfaceView vs TextureView</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff182018e001475daf684d64ca2113db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769645585&amp;x-signature=1h450sq7GC414E5w97ynGsrBNz0%3D" alt="11.png" loading="lazy"/></p>
<p><em>我相信大多数开发者都碰见过 <code>SurfaceView</code> 的布局问题。</em></p>
<p><code>SurfaceView</code> 是一种特殊的 <code>View</code>，它提供了一个专用的绘制表面，专为渲染在独立线程中处理的场景设计，常见于视频播放、自定义图形渲染或游戏等对性能要求极高的任务。</p>
<h3 data-id="heading-15">面试问题</h3>
<p>如何正确管理 <code>SurfaceView</code> 的生命周期，以确保高效的资源管理并避免内存泄漏？</p>
<p>如果需要显示带有旋转和缩放等变换的实时相机预览，你会在 <code>SurfaceView</code> 和 <code>TextureView</code> 之间选择哪一个？请结合实际考量说明理由。</p>
<h3 data-id="heading-16">SurfaceView</h3>
<p><code>SurfaceView</code> 的一个关键特性是它在主线程之外创建了一个独立的绘制表面，这使得高效渲染成为可能，而不会阻塞其他 UI 操作。</p>
<p><code>Surface</code> 通过 <code>SurfaceHolder</code> 回调方法创建和管理，你可以在这些回调中启动或停止按需渲染。例如，你可以在游戏循环中使用 <code>SurfaceView</code> 进行连续绘制，或使用底层 API 绘制图形。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomSurfaceView</span>(context: Context) : SurfaceView(context), SurfaceHolder.Callback {
    <span class="hljs-keyword">init</span> {
        holder.addCallback(<span class="hljs-keyword">this</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">surfaceCreated</span><span class="hljs-params">(holder: <span class="hljs-type">SurfaceHolder</span>)</span></span> {
        <span class="hljs-comment">// 在此处开始渲染或绘制</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">surfaceChanged</span><span class="hljs-params">(holder: <span class="hljs-type">SurfaceHolder</span>, format: <span class="hljs-type">Int</span>, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 处理表面变化</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">surfaceDestroyed</span><span class="hljs-params">(holder: <span class="hljs-type">SurfaceHolder</span>)</span></span> {
        <span class="hljs-comment">// 在此处停止渲染或释放资源</span>
    }
}
</code></pre>
<p>看这里，教会你如何<a href="https://juejin.cn/post/7569123141877956660" target="_blank" title="https://juejin.cn/post/7569123141877956660">在 Compose 中使用 SurfaceView</a>。</p>
<p>虽然 <code>SurfaceView</code> 在连续渲染时效率很高，但它在缩放、旋转等变换方面存在限制，因此更适合高性能场景，而不太适合动态 UI 交互。</p>
<h3 data-id="heading-17">TextureView</h3>
<p><code>TextureView</code> 提供了另一种离屏渲染方式，但与 <code>SurfaceView</code> 不同，它能无缝集成到 UI 层级中。这意味着 <code>TextureView</code> 可以被变换或动画，支持旋转、缩放和 alpha 混合等特性。它常用于显示实时相机预览或使用自定义变换播放视频。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTextureView</span>(context: Context) : TextureView(context), TextureView.SurfaceTextureListener {
    <span class="hljs-keyword">init</span> {
        surfaceTextureListener = <span class="hljs-keyword">this</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureAvailable</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 开始渲染或使用 SurfaceTexture</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureSizeChanged</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 处理表面尺寸变化</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureDestroyed</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 释放资源或停止渲染</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureUpdated</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>)</span></span> {
        <span class="hljs-comment">// 处理表面纹理更新</span>
    }
}
</code></pre>
<p>与 <code>SurfaceView</code> 不同，<code>TextureView</code> 在主线程上运行。虽然这使得它在连续渲染时效率略低，但它能更好地与其他 UI 组件集成，并支持实时变换。</p>
<h3 data-id="heading-18">区别</h3>
<p>这两种组件的主要区别在于渲染方式和 UI 集成：</p>
<ul>
<li><strong><code>SurfaceView</code></strong> 在独立线程中运行，适合视频播放或游戏等连续渲染场景。它还创建了一个独立的渲染窗口，确保性能，但代价是无法被变换或动画。</li>
<li><strong><code>TextureView</code></strong> 与其他 UI 组件共享同一窗口，因此可以被缩放、旋转或动画，使其在 UI 相关场景中更灵活。但由于它在主线程上运行，在高频渲染任务中可能不如 <code>SurfaceView</code> 高效。</li>
</ul>
<h3 data-id="heading-19">总结</h3>
<p><code>SurfaceView</code> 最适合性能优先的场景，如游戏或连续视频渲染。而 <code>TextureView</code> 更适合需要无缝 UI 集成和视觉变换的场景，如动画视频或显示实时相机预览。选择哪一个取决于你的应用是优先考虑性能还是 UI 灵活性。</p>
<h2 data-id="heading-20">Dp 与 Sp</h2>
<p>在设计 Android 用户界面时，你需要考虑 UI 组件如何适应不同的屏幕尺寸和分辨率。用于此目的的两个基本单位是 <strong><code>Dp</code>（密度无关像素）</strong> 和 <strong><code>Sp</code>（缩放无关像素）</strong> 。两者都有助于确保在不同设备上的一致性，但用途不同。</p>
<h3 data-id="heading-21">面试问题</h3>
<p>使用 <code>Sp</code> 作为文本大小时可能会出现哪些潜在的布局溢出问题？如何防止这些问题？</p>
<h3 data-id="heading-22">什么是 Dp</h3>
<p><code>Dp</code>（Density-independent Pixels，密度无关像素）是一种用于 UI 元素（如内边距、外边距和宽度）的度量单位。它旨在确保 UI 组件在不同屏幕密度的设备上具有一致的物理尺寸。在 160 DPI（每英寸点数）的屏幕上，1 <code>Dp</code> 等于 1 个物理像素，Android 会自动缩放 <code>Dp</code> 以匹配设备的密度。</p>
<p>例如，如果你指定一个 <code>Button</code> 的宽度为 100 <code>Dp</code>，它在低密度和高密度屏幕上看起来的大小大致相同（注意不是完全相同，这太难了），尽管渲染它所需的像素数量会有所不同。</p>
<h3 data-id="heading-23">什么是 Sp</h3>
<p><code>Sp</code>（Scale-independent Pixels，缩放无关像素）专门用于文本大小。它的行为与 <code>Dp</code> 类似，但额外考虑了用户的字体大小偏好。这意味着 <code>Sp</code> 会同时根据屏幕密度和设备的辅助功能设置进行缩放，使其成为确保文本可读性和可访问性的理想选择。</p>
<p>例如，如果你将 <code>TextView</code> 的大小设置为 16 <code>Sp</code>，它会根据屏幕密度进行适当缩放，并且如果用户增大了系统字体大小，它也会相应调整。</p>
<h3 data-id="heading-24">主要区别</h3>
<p>主要区别在于它们的缩放行为：</p>
<ol>
<li><strong>用途</strong>：<code>Dp</code> 用于尺寸（例如，按钮大小、内边距），<code>Sp</code> 用于文本大小。</li>
<li><strong>可访问性</strong>：<code>Sp</code> 尊重用户定义的字体大小偏好，而 <code>Dp</code> 则不。</li>
<li><strong>一致性</strong>：两者都会随屏幕密度缩放，但 <code>Sp</code> 确保文本对所有用户来说都是可访问和可读的。</li>
</ol>
<h3 data-id="heading-25">取舍</h3>
<ul>
<li>使用 <strong><code>Dp</code></strong> 用于 UI 组件（如 <code>View</code> 尺寸、外边距和内边距），以在不同设备上保持一致的布局。</li>
<li>使用 <strong><code>Sp</code></strong> 用于文本，以在保持视觉一致性的同时尊重用户的辅助功能偏好。</li>
</ul>
<h3 data-id="heading-26">总结</h3>
<p><code>Dp</code> 确保 UI 组件在不同设备上的物理尺寸一致，而 <code>Sp</code> 则根据屏幕密度和用户偏好调整文本大小。这种区分对于创建视觉吸引力强且可访问的 Android 应用至关重要。</p>
<h3 data-id="heading-27">进阶：使用 Sp 单位时如何处理布局溢出</h3>
<p>使用 <code>Sp</code>（缩放无关像素）对于确保 Android 上的文本可访问性至关重要，因为它会根据屏幕密度和用户字体偏好进行缩放。然而，用户定义的大字体大小可能导致文本元素超出预期边界，这会破坏布局，尤其是在按钮、标签或紧凑屏幕等受限空间中。正确处理这些场景对于维护用户友好的体验至关重要。</p>
<p>下面介绍一下防止布局溢出的策略。</p>
<p>当用户显著增大系统字体大小时，<code>Sp</code> 单位可能导致文本元素超出预期边界。这会破坏布局，尤其是在按钮、标签或紧凑屏幕等受限空间中。</p>
<ol>
<li>
<p><strong>正确设置 <code>wrap_content</code></strong>：确保基于文本的组件（如 <code>TextView</code> 或 <code>Button</code>）的大小设置为 <code>wrap_content</code>。这允许容器根据文本大小动态扩展，避免文本截断或溢出。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
     <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
     <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Sample Text"</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>为 <code>TextView</code> 使用 <code>minLines</code> 或 <code>maxLines</code></strong>：要控制文本扩展的行为，请使用 <code>minLines</code> 和 <code>maxLines</code> 属性，确保文本保持可读性而不破坏布局。结合 <code>ellipsize</code> 优雅地处理溢出。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
     <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
     <span class="hljs-attr">android:maxLines</span>=<span class="hljs-string">"2"</span>
     <span class="hljs-attr">android:ellipsize</span>=<span class="hljs-string">"end"</span>
     <span class="hljs-attr">android:text</span>=<span class="hljs-string">"This is a long sample text that might break the layout if not handled properly."</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>为关键 UI 组件使用固定大小</strong>：在需要确保一致大小的场景中，考虑为按钮等关键组件使用 <code>Dp</code>。这确保组件大小在文本缩放时保持稳定。在这些组件中，谨慎使用 <code>Sp</code> 作为文本大小以减少布局溢出。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"100dp"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span>
    <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"14sp"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Button"</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>测试极端字体大小</strong>：始终使用设备设置中最大的系统字体大小测试你的应用。识别会溢出或重叠的 UI 组件，并优化其布局以优雅地容纳更大的文本。</p>
</li>
<li>
<p><strong>考虑使用约束进行动态调整</strong>：使用 <code>ConstraintLayout</code> 增加定位和大小调整的灵活性。为文本元素定义约束，避免与其他 UI 元素重叠，即使在文本缩放时也是如此。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConstraintLayout</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/sampleText"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Dynamic Layout Example"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">ConstraintLayout</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>使用 <code>Dp</code> 而不是 <code>Sp</code></strong>：虽然作为开发者可以这么做，但是这是投机取巧的做法。当然，这也取决于团队的方法。<br/>
一些公司选择为文本大小使用 <code>Dp</code> 而不是 <code>Sp</code>，以防止用户调整字体大小导致的布局问题。然而，这种方法可能会影响用户体验，因为 <code>Sp</code> 是专门为支持辅助功能而设计的，可确保文本根据用户的可读性偏好进行调整。</p>
</li>
</ol>
<p>总之，要处理 <code>Sp</code> 导致的布局溢出，请结合 <code>wrap_content</code>、设置约束和定义文本扩展限制等最佳实践。使用极端字体大小测试并动态管理布局，可确保你的应用在视觉上保持一致并对所有用户可访问。</p>
<h2 data-id="heading-28">点九图</h2>
<p>点九图片是一种特殊格式的 PNG 图片，它可以在拉伸或缩放时不丢失视觉质量，使其成为 Android 中创建灵活且可适配 UI 组件的必备工具。它主要用于按钮、背景和容器等需要动态调整大小以适应不同屏幕尺寸和内容尺寸的元素。</p>
<h3 data-id="heading-29">面试问题</h3>
<p>点九图与普通 PNG 图片有何不同？在哪些场景下需要使用九图图片？</p>
<h3 data-id="heading-30">核心特性</h3>
<ol>
<li><strong>可拉伸区域</strong>：点九图可以定义可拉伸的区域，同时保持图片其他部分的完整性。这是通过在图片最外层1像素的边框中绘制黑线（引导线）实现的。</li>
<li><strong>内容区域定义</strong>：这些黑线还指定了图片内部的内容区域，确保文本或其他 UI 元素在可绘制对象内正确对齐。</li>
<li><strong>动态调整大小</strong>：它们会按比例调整大小，确保 UI 元素在不同屏幕尺寸的设备上都能保持美观的显示效果。</li>
</ol>
<p>以下代码演示了如何将九图图片用作按钮的背景：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@drawable/button_background"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Click Me"</span> /&gt;</span>
</code></pre>
<p>这和普通图片的使用没什么两样。</p>
<h3 data-id="heading-31">点九图的局限性</h3>
<ol>
<li><strong>手动创建</strong>：需要仔细创建和测试，以确保正确的缩放和对齐。</li>
<li><strong>适用场景有限</strong>：最适合矩形或方形元素，对于复杂或不规则形状的效果较差。</li>
</ol>
<h3 data-id="heading-32">总结</h3>
<p>点九图是一种灵活且高效的方案，用于在 Android 中创建可缩放且视觉一致的 UI 组件。通过定义可拉伸区域和内容区域，它确保按钮和背景等元素能无缝适配不同屏幕尺寸和动态内容，同时保持美观的显示效果。</p>
<p>不过，点九图最好的学习方法，就是尝试自己做一次！就什么都明白了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 ResourceLoader 统一管理你的本地资源]]></title>    <link>https://juejin.cn/post/7597725815917199401</link>    <guid>https://juejin.cn/post/7597725815917199401</guid>    <pubDate>2026-01-22T00:19:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597725815917199401" data-draft-id="7597623392456720435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 ResourceLoader 统一管理你的本地资源"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T00:19:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 ResourceLoader 统一管理你的本地资源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:19:24.000Z" title="Thu Jan 22 2026 00:19:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在项目开发中，我们经常需要读取各种本地资源文件：配置文件、模板文件、静态资源、数据文件等。</p>
<p>Spring 框架提供了一个强大而优雅的解决方案——<code>ResourceLoader</code> 接口。本文将使用 Spring ResourceLoader 统一管理本地资源，让你的代码更加规范、灵活且易于维护。</p>
<h2 data-id="heading-1">一、ResourceLoader 的优势</h2>
<p>Spring 的 <code>ResourceLoader</code> 提供了一个统一的资源访问抽象：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceLoader</span> {
    Resource <span class="hljs-title function_">getResource</span><span class="hljs-params">(String location)</span>;
}
</code></pre>
<p>它的优势在于：</p>
<p><strong>统一接口</strong>：无论资源来自文件系统、classpath 还是 URL，都用相同方式访问</p>
<p><strong>位置透明</strong>：支持多种位置前缀，如 <code>classpath:</code>、<code>file:</code>、<code>http:</code> 等</p>
<p><strong>Spring 生态集成</strong>：与 Spring 容器完美集成，自动注入</p>
<p><strong>灵活性</strong>：支持模式匹配、占位符解析等高级特性</p>
<h2 data-id="heading-2">二、核心概念与接口</h2>
<h4 data-id="heading-3">2.1 Resource 接口</h4>
<p><code>Resource</code> 是 Spring 对底层资源的抽象，它继承自 <code>InputStreamSource</code> 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Resource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputStreamSource</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReadable</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOpen</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFile</span><span class="hljs-params">()</span>;
    URL <span class="hljs-title function_">getURL</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    URI <span class="hljs-title function_">getURI</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    File <span class="hljs-title function_">getFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-type">long</span> <span class="hljs-title function_">contentLength</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-type">long</span> <span class="hljs-title function_">lastModified</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    Resource <span class="hljs-title function_">createRelative</span><span class="hljs-params">(String relativePath)</span> <span class="hljs-keyword">throws</span> IOException;
    String <span class="hljs-title function_">getFilename</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>常见的 Resource 实现类：</p>

























<table><thead><tr><th>实现类</th><th>用途</th></tr></thead><tbody><tr><td><code>FileSystemResource</code></td><td>文件系统资源</td></tr><tr><td><code>ClassPathResource</code></td><td>classpath 资源</td></tr><tr><td><code>UrlResource</code></td><td>URL 资源（支持 http、ftp 等）</td></tr><tr><td><code>ServletContextResource</code></td><td>Web 应用上下文资源</td></tr></tbody></table>
<p><code>PathMatchingResourcePatternResolver</code> 是资源<strong>解析器</strong>，用于批量匹配资源路径，它实现了 <code>ResourcePatternResolver</code> 接口。</p>
<h4 data-id="heading-4">2.2 ResourceLoader 接口</h4>
<p><code>ResourceLoader</code> 是资源加载的核心接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceLoader</span> {
    Resource <span class="hljs-title function_">getResource</span><span class="hljs-params">(String location)</span>;
}
</code></pre>
<h4 data-id="heading-5">2.3 ResourcePatternResolver 接口</h4>
<p><code>ResourcePatternResolver</code> 是 <code>ResourceLoader</code> 的扩展，支持资源模式匹配：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourcePatternResolver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceLoader</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">CLASSPATH_ALL_URL_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath*:"</span>;

    Resource[] getResources(String locationPattern) <span class="hljs-keyword">throws</span> IOException;
}
</code></pre>
<p>关键特性是 <code>classpath*:</code> 前缀，它可以匹配 classpath 下所有同名资源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 匹配所有 classpath 下的 *.xml 文件</span>
Resource[] resources = resolver.getResources(<span class="hljs-string">"classpath*:*.xml"</span>);
</code></pre>
<h2 data-id="heading-6">三、常用资源位置前缀</h2>
<p>Spring 支持多种资源位置前缀，每种前缀对应不同的资源来源：</p>
<h4 data-id="heading-7">3.1 classpath: 前缀</h4>
<p>从 classpath 读取资源，这是最常用的方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"classpath:config/app.properties"</span>);
<span class="hljs-comment">// 或者简写，ResourceLoader 会自动识别</span>
<span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"config/app.properties"</span>);
</code></pre>
<h4 data-id="heading-8">3.2 file: 前缀</h4>
<p>明确指定从文件系统读取：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"file:/data/config/app.properties"</span>);
</code></pre>
<h4 data-id="heading-9">3.3 http: / https: 前缀</h4>
<p>从网络读取资源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"https://example.com/config.json"</span>);
</code></pre>
<h4 data-id="heading-10">3.4 无前缀</h4>
<p>Spring 会根据资源路径的特征自动判断来源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 以 / 开头，视为文件系统路径</span>
<span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"/etc/app/config.properties"</span>);

<span class="hljs-comment">// 其他情况，优先从 classpath 查找</span>
<span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"config/app.properties"</span>);
</code></pre>
<h2 data-id="heading-11">四、最佳实践</h2>
<h4 data-id="heading-12">4.1 基础用法</h4>
<p>在 Spring Boot 应用中，我们可以直接注入 <code>ResourceLoader</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigLoader</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConfigLoader</span><span class="hljs-params">(ResourceLoader resourceLoader)</span> {
        <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;
    }

    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">loadProperties</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"classpath:application.properties"</span>);
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.load(resource.getInputStream());
        <span class="hljs-keyword">return</span> props;
    }
}
</code></pre>
<h4 data-id="heading-13">4.2 资源目录结构规划</h4>
<p>建议按照以下结构组织资源文件：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/
├── config/
│   ├── app<span class="hljs-selector-class">.properties</span>
│   └── database<span class="hljs-selector-class">.properties</span>
├── templates/
│   ├── email/
│   │   └── welcome<span class="hljs-selector-class">.html</span>
│   └── report/
│       └── monthly<span class="hljs-selector-class">.xlsx</span>
└── data/
    ├── initial-data<span class="hljs-selector-class">.json</span>
    └── lookup-tables<span class="hljs-selector-class">.csv</span>
</code></pre>
<h4 data-id="heading-14">4.3 批量读取资源文件</h4>
<p>使用 <code>ResourcePatternResolver</code> 可以批量读取匹配模式的资源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateLoader</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourcePatternResolver resourcePatternResolver;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TemplateLoader</span><span class="hljs-params">(ResourcePatternResolver resourcePatternResolver)</span> {
        <span class="hljs-built_in">this</span>.resourcePatternResolver = resourcePatternResolver;
    }

    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">loadAllTemplates</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        Map&lt;String, String&gt; templates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 读取所有 HTML 模板</span>
        Resource[] resources = resourcePatternResolver
            .getResources(<span class="hljs-string">"classpath*:templates/**/*.html"</span>);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> resource.getPath();
            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> path.substring(path.lastIndexOf(<span class="hljs-string">"templates/"</span>));
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
                templates.put(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8));
            }
        }
        <span class="hljs-keyword">return</span> templates;
    }
}
</code></pre>
<h4 data-id="heading-15">4.4 统一路径管理</h4>
<p>推荐使用<strong>配置属性 + 常量类</strong>的方式：</p>
<p><strong>1. 定义资源路径常量类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourcePaths</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ResourcePaths</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 配置文件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIG_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath:config/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">APP_PROPERTIES</span> <span class="hljs-operator">=</span> CONFIG_DIR + <span class="hljs-string">"app.properties"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATABASE_PROPERTIES</span> <span class="hljs-operator">=</span> CONFIG_DIR + <span class="hljs-string">"database.properties"</span>;

    <span class="hljs-comment">// 模板文件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TEMPLATES_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath:templates/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EMAIL_WELCOME</span> <span class="hljs-operator">=</span> TEMPLATES_DIR + <span class="hljs-string">"email/welcome.html"</span>;

    <span class="hljs-comment">// 数据文件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath:data/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INITIAL_DATA</span> <span class="hljs-operator">=</span> DATA_DIR + <span class="hljs-string">"initial-data.json"</span>;
}
</code></pre>
<p><strong>2. 使用配置属性（推荐）</strong></p>
<p>在 <code>application.yml</code> 中集中管理：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">app:</span>
  <span class="hljs-attr">resource:</span>
    <span class="hljs-attr">config-dir:</span> <span class="hljs-string">classpath:config/</span>
    <span class="hljs-attr">templates-dir:</span> <span class="hljs-string">classpath:templates/</span>
    <span class="hljs-attr">data-dir:</span> <span class="hljs-string">classpath:data/</span>
</code></pre>
<p>对应的配置属性类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.resource")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">ResourceProperties</span><span class="hljs-params">(
    String configDir,
    String templatesDir,
    String dataDir
)</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfigPath</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> configDir + fileName;
    }
}
</code></pre>
<p><strong>3. 统一资源服务</strong></p>
<p>封装资源访问逻辑，统一处理路径和异常</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceProperties properties;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResourceService</span><span class="hljs-params">(ResourceLoader resourceLoader, ResourceProperties properties)</span> {
        <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;
        <span class="hljs-built_in">this</span>.properties = properties;
    }

    <span class="hljs-comment">/**
     * 读取配置文件（Properties 格式）
     */</span>
    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">loadProperties</span><span class="hljs-params">(String fileName)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(properties.getConfigPath(fileName));
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
            props.load(is);
        }
        <span class="hljs-keyword">return</span> props;
    }

    <span class="hljs-comment">/**
     * 读取模板文件内容
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readTemplate</span><span class="hljs-params">(String relativePath)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(properties.templatesDir() + relativePath);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8);
        }
    }

    <span class="hljs-comment">/**
     * 批量加载模板（支持 Ant 风格模式）
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">loadTemplates</span><span class="hljs-params">(String pattern)</span> <span class="hljs-keyword">throws</span> IOException {
        Map&lt;String, String&gt; templates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        Resource[] resources = ((ResourcePatternResolver) resourceLoader)
            .getResources(properties.templatesDir() + pattern);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> resource.getFilename();
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
                templates.put(path, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8));
            }
        }
        <span class="hljs-keyword">return</span> templates;
    }

    <span class="hljs-comment">/**
     * 检查资源是否存在
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">(String path)</span> {
        <span class="hljs-keyword">return</span> resourceLoader.getResource(path).exists();
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceService resourceService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmailService</span><span class="hljs-params">(ResourceService resourceService)</span> {
        <span class="hljs-built_in">this</span>.resourceService = resourceService;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWelcomeTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> resourceService.readTemplate(<span class="hljs-string">"email/welcome.html"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to load welcome template"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-16">4.5 轻量级工具类</h4>
<p>也可以封装一个工具类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceUtils</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ResourcePatternResolver resolver;

    <span class="hljs-comment">// Spring 注入</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setResourcePatternResolver</span><span class="hljs-params">(ResourcePatternResolver resolver)</span> {
        ResourceUtils.resolver = resolver;
    }

    <span class="hljs-comment">/**
     * 读取资源为字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readAsString</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resolver.getResource(path);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8);
        }
    }

    <span class="hljs-comment">/**
     * 批量获取匹配的资源路径
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">listResources</span><span class="hljs-params">(String pattern)</span> <span class="hljs-keyword">throws</span> IOException {
        Resource[] resources = resolver.getResources(pattern);
        <span class="hljs-keyword">return</span> Arrays.stream(resources)
                .map(r -&gt; {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">return</span> r.getURL().getPath();
                    } <span class="hljs-keyword">catch</span> (IOException e) {
                        <span class="hljs-keyword">return</span> pattern;
                    }
                })
                .collect(Collectors.toList());
    }
}
</code></pre>
<p>在配置类中初始化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ResourceUtils <span class="hljs-title function_">resourceUtils</span><span class="hljs-params">(ResourcePatternResolver resolver)</span> {
        ResourceUtils.setResourcePatternResolver(resolver);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceUtils</span>();
    }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> ResourceUtils.readAsString(ResourcePaths.EMAIL_WELCOME);
List&lt;String&gt; configs = ResourceUtils.listResources(<span class="hljs-string">"classpath:config/*.properties"</span>);
</code></pre>
<h2 data-id="heading-17">五、总结</h2>
<p>Spring ResourceLoader 提供了统一的资源访问接口，支持 classpath、file、http 等多种前缀，配合 ResourcePatternResolver 可实现批量资源加载，让本地资源管理更加简洁规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%]]></title>    <link>https://juejin.cn/post/7597623654056919055</link>    <guid>https://juejin.cn/post/7597623654056919055</guid>    <pubDate>2026-01-22T00:18:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056919055" data-draft-id="7597650624637583360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-22T00:18:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:18:03.000Z" title="Thu Jan 22 2026 00:18:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%</strong></h3>
<h3 data-id="heading-1">引言</h3>
<p>在现代前端开发中，JavaScript 数组操作是最常见的任务之一。然而，许多开发者仍然依赖于传统的 <code>for</code> 循环或低效的迭代方式，这不仅让代码变得冗长，还可能成为性能瓶颈。随着 JavaScript 语言的演进，ES6+ 引入了许多强大的数组处理方法，能够显著提升代码的可读性和执行效率。</p>
<p>本文将深入探讨 <strong>5个高阶技巧</strong>，帮助你告别低效循环，优化数组处理逻辑。这些方法不仅能让你的代码更加简洁优雅，还能在性能上实现 <strong>80%以上的提升</strong>（具体数据基于 V8 引擎的优化和实际基准测试）。让我们开始吧！</p>
<hr/>
<h3 data-id="heading-2">1. <code>Array.prototype.map</code> + <code>Array.prototype.filter</code> → <code>Array.prototype.reduce</code></h3>
<h4 data-id="heading-3">问题：双重遍历的低效性</h4>
<p>许多开发者会先使用 <code>map</code> 转换数组，再用 <code>filter</code> 过滤结果。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> doubledEvens = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
</code></pre>
<p>虽然这段代码功能正确，但它会遍历数组两次：第一次映射，第二次过滤。对于大型数组来说，这会浪费计算资源。</p>
<h4 data-id="heading-4">解决方案：用 <code>reduce</code> <strong>一次性完成映射和过滤</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> doubledEvens = numbers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, x</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> doubled = x * <span class="hljs-number">2</span>;
  <span class="hljs-keyword">if</span> (doubled % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) acc.<span class="hljs-title function_">push</span>(doubled);
  <span class="hljs-keyword">return</span> acc;
}, []);
</code></pre>
<p><strong>性能对比</strong>：在 Chrome V8 引擎中测试长度为10万的数组时：</p>
<ul>
<li><code>map + filter</code>：约12ms</li>
<li><code>reduce</code>：约7ms<br/>
速度提升了40%以上！</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. <code>for...of</code> → <code>Array.prototype.forEach</code> + <strong>提前终止优化</strong></h3>
<h4 data-id="heading-6">问题：无法提前终止的传统循环</h4>
<p>如果你想在满足条件时提前终止循环（类似于 <code>break</code>），传统的 <code>.forEach()</code> <strong>不支持这一功能</strong>。许多人因此退回到笨重的 <code>for(let i=0; ...)</code>。</p>
<h4 data-id="heading-7"><strong>解决方案1</strong>: <code>.some()</code> / <code>.every()</code></h4>
<p>这两个方法允许通过返回 <code>true/false</code> <strong>模拟提前终止</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [...]; <span class="hljs-comment">// [{name: 'Alice', isAdmin: false}, ...]</span>
users.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Found admin: <span class="hljs-subst">${user.name}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// "break"</span>
    }
});
</code></pre>
<h4 data-id="heading-8"><strong>解决方案2</strong>: ES6+ <code>for...of</code></h4>
<p>如果你需要更灵活的终止逻辑（比如多层嵌套）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> users) {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Works!</span>
}
</code></pre>
<p><strong>性能提示</strong>: V8对原生循环的优化程度高于高阶函数（如<code>.forEach()</code>）。在大规模数据下优先使用原生语法。</p>
<hr/>
<h3 data-id="heading-9"><strong>3.扁平化嵌套数组：从递归到<code>.flatMap()</code></strong></h3>
<h4 data-id="heading-10"><strong>传统做法</strong>:手动递归或<code>.concat(...arr)</code></h4>
<p>假设你有一个多层嵌套的评论结构:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> comments = [
    { <span class="hljs-attr">text</span>: <span class="hljs-string">'Great!'</span>, <span class="hljs-attr">replies</span>: [{ <span class="hljs-attr">text</span>: <span class="hljs-string">'Thanks!'</span> }] },
    { <span class="hljs-attr">text</span>: <span class="hljs-string">'Nice!'</span> }
];
<span class="hljs-comment">// Flatten with recursion:</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">flatten</span>(<span class="hljs-params">arr</span>) {
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> 
        acc.<span class="hljs-title function_">concat</span>(val.<span class="hljs-property">replies</span> ? [val, ...<span class="hljs-title function_">flatten</span>(val.<span class="hljs-property">replies</span>)] : val), []);
}
</code></pre>
<p>这不仅复杂还容易栈溢出(Stack Overflow)。</p>
<h4 data-id="heading-11"><strong>现代方案</strong>: <code>.flatMap()</code></h4>
<p>ES2019引入的<code>.flatMap()</code>可以一步到位：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> flatComments = comments.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">comment</span> =&gt;</span> 
    comment.<span class="hljs-property">replies</span> ? [comment, ...comment.<span class="hljs-property">replies</span>] : comment);
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>Readability ↑↑↑</li>
<li>Performance ↑ (~30% faster than recursive flattening in benchmarks)</li>
</ul>
<hr/>
<h3 data-id="heading-12">**4.高性能查找/匹配:**从<code>.find()</code>到索引缓存(Map/Set)</h3>
<p>当你需要反复查询某个条件是否存在于数组中时：</p>
<p>❌ Bad:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span> === targetId)) {...} 
<span class="hljs-comment">// O(n) each time!</span>
</code></pre>
<p>✅ Better:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Pre-cache once!</span>
<span class="hljs-keyword">const</span> userIdsSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span>));
<span class="hljs-keyword">if</span> (userIdsSet.<span class="hljs-title function_">has</span>(targetId)) {...} <span class="hljs-comment">// O(1)! </span>
</code></pre>
<p>💡 Benchmark Results(Tests with ~100k items):</p>




















<table><thead><tr><th>Method</th><th>Avg Time</th><th>Relative Speed</th></tr></thead><tbody><tr><td>Array.find()</td><td>~450ms</td><td>Baseline</td></tr><tr><td>Set.has()</td><td>~0.02ms</td><td>&gt;20000% faster</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13"><strong>5.From Imperative Loops To Parallelism With Web Workers</strong></h3>
<p>当处理CPU密集型任务（如大规模数值计算）时：</p>
<p>⚠️ Blocking UI Thread Example ❌:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">computeHeavy</span>(<span class="hljs-params">dataArr</span>){
   <span class="hljs-keyword">let</span> result=[];
   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> dataArr){ result.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">doExpensiveCalc</span>(item)); }
   <span class="hljs-keyword">return</span> result;
}
<span class="hljs-comment">// 🚫 Freezes browser until done!</span>
</code></pre>
<p>✨ Parallel Solution ✅:
Split work into chunks and delegate via Web Workers:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallelCompute</span>(<span class="hljs-params">dataArr</span>){
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span>=<span class="hljs-number">1000</span>;
  <span class="hljs-keyword">const</span> workerPromises=[];
  
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;dataArr.<span class="hljs-property">length</span>;i+=<span class="hljs-variable constant_">CHUNK_SIZE</span>){
     <span class="hljs-keyword">const</span> chunk=dataArr.<span class="hljs-title function_">slice</span>(i,i+<span class="hljs-variable constant_">CHUNK_SIZE</span>);
     workerPromises.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">runInWorker</span>(<span class="hljs-string">'./worker.js'</span>,chunk));
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(workerPromises).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span>=&gt;</span>results.<span class="hljs-title function_">flat</span>());
}
</code></pre>
<p>🔹 Key Benefits:<br/>
✔ Near-linear speedup on multi-core CPUs<br/>
✔ Non-blocking main thread</p>
<hr/>
<h2 data-id="heading-14">Conclusion</h2>
<p>Mastering these techniques can transform your JavaScript from merely functional to truly optimal:</p>
<p>1️⃣ Replace chained map/filter with single-pass reduce<br/>
2️⃣ Leverage early-exit patterns (.some(), for..of break)<br/>
3️⃣ Flatten deep structures efficiently via .flatMap()<br/>
4️⃣ Cache lookups using Sets/Maps for O(1) access<br/>
5️⃣ Offload heavy tasks to Web Workers</p>
<p>Adopting even one of these strategies could yield noticeable improvements—combine them wisely,and you'll unlock next-level performance gains across your applications!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-67、剪绳⼦]]></title>    <link>https://juejin.cn/post/7597623392457130035</link>    <guid>https://juejin.cn/post/7597623392457130035</guid>    <pubDate>2026-01-22T00:26:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623392457130035" data-draft-id="7595873251165388841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-67、剪绳⼦"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-22T00:26:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-67、剪绳⼦
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:26:25.000Z" title="Thu Jan 22 2026 00:26:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题目描述</h2>
<p>给你⼀根⻓度为n 的绳⼦，请把绳⼦剪成整数⻓的m 段（ m 、n 都是整数， n&gt;1 并 且m&gt;1 ， m&lt;=n ），每段绳⼦的⻓度记为k[1],...,k[m]。请问k[1]x...xk[m] 可能的最⼤乘积是多少？例如，当绳⼦的⻓度是8 时，我们把它剪成⻓度分别为2 、3 、3 的三段，此时得到的最⼤乘积是18`。</p>
<p>输⼊描述:输⼊⼀个数n，意义⻅题⾯。（2 &lt;= n &lt;= 60）</p>
<p>返回值描述:输出答案。</p>
<p>示例1
输⼊：8
返回值：18</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">备忘录</h3>
<p>本题的解答思路就是每个⻓度的绳⼦，要么最⻓的情况是不剪开（⻓度是本身），要么⻓度是剪开两段的乘积。因此每个⻓度 length 都需要遍历两个相加之后等于 length 的乘积，取最⼤值。</p>
<p>初始化值⻓度为 1 的值为 1 ，从⻓度为 2 开始，每⼀种⻓度都需要遍历两个⼦⻓度的乘积。</p>
<p>显然，为了避免多次重复计算，可以写个备忘录</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> target)</span> {
		<span class="hljs-keyword">if</span> (target &lt;= <span class="hljs-number">1</span>) {
			<span class="hljs-keyword">return</span> target;
		}
		<span class="hljs-type">int</span>[] nums = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[target + <span class="hljs-number">1</span>];
		nums[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;
		nums[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= target; i++) {
			<span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> i;
			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=i/<span class="hljs-number">2</span>;j++){
				<span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> nums[j] * nums[i-j];
				<span class="hljs-keyword">if</span>(temp &gt; max){
					max = temp;
				}
			}
			nums[i]=max;
		}
		<span class="hljs-keyword">return</span> nums[target];
	}
}
</code></pre>
<h3 data-id="heading-3">动态规划</h3>
<p>⽤动态规划的思维来做，假设绳⼦⻓度为 n 的 最⼤的⻓度为 f(n) ，那你说 f(n) 怎么计算得来呢？</p>
<ol>
<li>f(n) 可能是 n(不切分)</li>
<li>也可能是 f(n-1) 和 f(1) 的乘积</li>
<li>也可能是 f(n-2) 和 f(2) 的乘积</li>
<li>......</li>
</ol>
<p>那么也就是想要求 f( n ) 我们必须先把 f(n-1) ， f(n-2) ...之类的前⾯的值先求出来， f(1)=1 这是初始化值。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> target)</span> {
		<span class="hljs-type">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[target + <span class="hljs-number">1</span>];
		dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= target; i++) {
			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; j &lt; i; j++) {
				dp[i] = Math.max(dp[i], (Math.max(j, dp[j])) * (Math.max(i - j, dp[i - j])));
			}
		}
		<span class="hljs-keyword">return</span> dp[target];
	}
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n²)，外层循环n-3次，内层循环i/2次</li>
<li><strong>空间复杂度</strong>：O(n)，需要dp数组存储中间结果</li>
</ul>
<h3 data-id="heading-4">贪心算法（最优解）</h3>
<p>基于数学推导的贪心策略，优先剪出长度为3的段。当n≥5时，优先剪出长度为3的段；剩余4时剪成2×2</p>
<p><strong>为什么选择3？</strong></p>
<ol>
<li><strong>数学证明</strong>：当n ≥ 5时，3(n-3) ≥ 2(n-2) &gt; n</li>
<li><strong>接近自然底数e</strong>：最优分段长度应接近e ≈ 2.718，3是最接近的整数</li>
<li><strong>4的特殊处理</strong>：2×2 &gt; 3×1，所以剩余4时剪成2×2而不是3×1</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-comment">// 特殊情况处理</span>
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> n - <span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// 计算可以剪出多少段长度为3的绳子</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">countOf3</span> <span class="hljs-operator">=</span> n / <span class="hljs-number">3</span>;
        
        <span class="hljs-comment">// 处理剩余部分：当剩余长度为1时，调整策略</span>
        <span class="hljs-keyword">if</span> (n - countOf3 * <span class="hljs-number">3</span> == <span class="hljs-number">1</span>) {
            countOf3--; <span class="hljs-comment">// 减少一段3，与剩余的1组成4</span>
        }
        
        <span class="hljs-comment">// 计算剩余部分能剪出多少段长度为2的绳子</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">countOf2</span> <span class="hljs-operator">=</span> (n - countOf3 * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 计算结果：3的countOf3次方 × 2的countOf2次方</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)(Math.pow(<span class="hljs-number">3</span>, countOf3)) * (<span class="hljs-type">int</span>)(Math.pow(<span class="hljs-number">2</span>, countOf2));
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(1)，只有常数次操作</li>
<li><strong>空间复杂度</strong>：O(1)，只使用固定变量</li>
</ul>
<h3 data-id="heading-5">数学公式法（理论最优）</h3>
<p>根据n除以3的余数直接套用公式</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> n - <span class="hljs-number">1</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">countOf3</span> <span class="hljs-operator">=</span> n / <span class="hljs-number">3</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">remainder</span> <span class="hljs-operator">=</span> n % <span class="hljs-number">3</span>;
        
        <span class="hljs-comment">// 根据余数直接返回结果</span>
        <span class="hljs-keyword">if</span> (remainder == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">3</span>, countOf3);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (remainder == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">3</span>, countOf3 - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>;
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// remainder == 2</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">3</span>, countOf3) * <span class="hljs-number">2</span>;
        }
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(1)</li>
<li>空间复杂度：O(1)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 中的 deep、v-deep 和 >>> 有什么区别？什么时候该用？]]></title>    <link>https://juejin.cn/post/7597635202325332020</link>    <guid>https://juejin.cn/post/7597635202325332020</guid>    <pubDate>2026-01-22T00:26:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202325332020" data-draft-id="7588061231589425193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 中的 deep、v-deep 和 &gt;&gt;&gt; 有什么区别？什么时候该用？"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-22T00:26:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 中的 deep、v-deep 和 &gt;&gt;&gt; 有什么区别？什么时候该用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:26:30.000Z" title="Thu Jan 22 2026 00:26:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“你用 <code>Element Plus</code> 写了个按钮，想改下 hover 颜色，结果死活不生效！最后查了半天，发现得加个 <code>:deep()</code> 才行”</p>
<p>其实，这是 Vue 中一个非常常见的坑：<strong>样式作用域冲突</strong>。那为什么用 UI 库时，加上 <code>:deep()</code>、<code>::v-deep</code> 或 <code>&gt;&gt;&gt;</code>后，样式就能生效呢？</p>
<p>它们是什么？有什么区别？什么时候该用哪个？</p>
<h2 data-id="heading-0">一、先说背景</h2>
<p>我们在 Vue 单文件组件（<code>.vue</code> 文件）里写样式时，通常会加上 <code>scoped</code> 属性：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button&gt;点我&lt;/el-button&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.el-button {
  background: red;
}
&lt;/style&gt;
</code></pre>
<p>加了 <code>scoped</code> 后，Vue 会自动给这个组件里的所有元素加上一个唯一的属性（比如 <code>data-v-123456</code>），然后把 CSS 选择器也加上这个属性，变成：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.el-button</span><span class="hljs-selector-attr">[data-v-123456]</span> {
  <span class="hljs-attribute">background</span>: red;
}
</code></pre>
<p>这样做的好处是：<strong>样式只作用于当前组件，不会污染全局</strong>。、</p>
<p>但问题来了：<strong>Element Plus 的 <code>&lt;el-button&gt;</code> 组件内部结构，是在它自己的组件里定义的</strong>。也就是说，你写的 <code>.el-button</code> 元素，其实是 Element Plus 渲染出来的子组件，它身上<strong>没有</strong>你当前组件的 <code>data-v-xxx</code> 属性！</p>
<p>所以你的样式根本匹配不到它，自然就失效了。</p>
<hr/>
<h2 data-id="heading-1">二、那怎么办？</h2>
<p>为了解决这个问题，Vue 提供了样式穿透（style penetration）的语法，让你能穿透当前组件的作用域，去影响子组件内部的元素。</p>
<p>Vue 社区出现过三种写法：</p>

























<table><thead><tr><th>写法</th><th>适用版本</th><th>状态</th></tr></thead><tbody><tr><td><code>&gt;&gt;&gt;</code></td><td>Vue 2（某些预处理器支持）</td><td><strong>已废弃/不推荐</strong></td></tr><tr><td><code>::v-deep</code></td><td>Vue 2 + Vue 3（兼容写法）</td><td><strong>过渡方案</strong></td></tr><tr><td><code>:deep()</code></td><td>Vue 3.0+（推荐）</td><td>官方推荐</td></tr></tbody></table>
<p>下面我们一个个拆解。</p>
<hr/>
<h3 data-id="heading-2">1. <code>&gt;&gt;&gt;</code>：曾经的快捷方式，但问题很多</h3>
<p>早期 Vue2 时代，很多人用：</p>
<pre><code class="hljs language-css" lang="css">&lt;style scoped&gt;
<span class="hljs-selector-class">.parent</span> &gt;&gt;&gt; <span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">color</span>: blue;
}
&lt;/style&gt;
</code></pre>
<p>它的意思是：从 <code>.parent</code> 开始，穿透到所有后代中的 <code>.child</code>。</p>
<p>但问题在于：</p>
<ul>
<li><strong>Sass/Less 等预处理器不认 <code>&gt;&gt;&gt;</code></strong>，会报错。</li>
<li>不是标准 CSS 语法。</li>
<li>Vue3 已经明确不再支持。</li>
</ul>
<p>所以现在基本可以忘掉它了。</p>
<hr/>
<h3 data-id="heading-3">2. <code>::v-deep</code>：Vue2 到 Vue3 的桥梁</h3>
<p>为了兼容预处理器，Vue 引入了 <code>::v-deep</code>：</p>
<pre><code class="hljs language-scss" lang="scss">&lt;style scoped lang="scss"&gt;
<span class="hljs-selector-class">.parent</span> ::<span class="hljs-built_in">v-deep</span>(.child) {
  <span class="hljs-attribute">color</span>: blue;
}
&lt;/style&gt;
</code></pre>
<p>或者更常见的写法：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.parent</span> {
  ::<span class="hljs-built_in">v-deep</span>(.child) {
    <span class="hljs-attribute">color</span>: blue;
  }
}
</code></pre>
<p>它在 Vue2 和 Vue3 中都能用，算是一个安全的过渡方案。</p>
<p>但注意：<strong>在 Vue3 中，官方文档已经明确建议使用 <code>:deep()</code> 替代它</strong>。</p>
<hr/>
<h3 data-id="heading-4">3. <code>:deep()</code>：Vue3 的标准答案</h3>
<p>Vue3 引入了更简洁、更符合 CSS 规范的伪类函数写法：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
:deep(.el-button) {
  background: red !important;
}
&lt;/style&gt;
</code></pre>
<p>或者配合父级选择器：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
.my-wrapper :deep(.el-input__inner) {
  border-radius: 10px;
}
&lt;/style&gt;
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>语法清晰，像原生 CSS。</li>
<li>支持所有预处理器（Sass/Less/Stylus）。</li>
</ul>
<p><code>:deep()</code> 本质上是一个编译时转换，Vue 在构建时会把它展开成带 <code>data-v-xxx</code> 的复杂选择器，从而实现穿透。</p>
<hr/>
<h2 data-id="heading-5">三、怎么正确修改 Element Plus 的样式？</h2>
<p>举个真实例子：你想把 Element Plus 的输入框圆角改成 8px。</p>
<h3 data-id="heading-6">错误写法（不生效）：</h3>
<pre><code class="hljs language-css" lang="css">&lt;style scoped&gt;
<span class="hljs-selector-class">.el-input__inner</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-7">正确写法：</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-form"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"value"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.my-form</span> :<span class="hljs-built_in">deep</span>(.el-input__inner) {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>为什么要加 <code>.my-form</code> 这个父级？<br/>
<strong>避免全局污染</strong>！如果直接写 <code>:deep(.el-input__inner)</code>，那么这个页面里<strong>所有</strong> Element 输入框都会被改掉。加上父级限定，就能精准控制范围。</p>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 秒懂SKILLS: 模块化的RULES + 轻量化脚本]]></title>    <link>https://juejin.cn/post/7597650322408489012</link>    <guid>https://juejin.cn/post/7597650322408489012</guid>    <pubDate>2026-01-22T00:27:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408489012" data-draft-id="7597664587459117091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 秒懂SKILLS: 模块化的RULES + 轻量化脚本"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-22T00:27:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 秒懂SKILLS: 模块化的RULES + 轻量化脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:27:42.000Z" title="Thu Jan 22 2026 00:27:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">为什么我们需要skills?</h2>
<p>众所周知，在AI编程的语境下，<code>RULES</code> 几乎是必不可少的，人们需要在 <code>RULES</code> 中提前给 <code>AI</code> 制定规则：</p>
<ol>
<li>它是一个什么样的角色</li>
<li>本工程采用了什么技术栈，它应该按什么编码规范来编码，如何组织工程代码。</li>
<li>当遇上一些非常见情况时，它应该如何处理，遵循什么原则</li>
<li>如何处理某些异常</li>
</ol>
<p>但是，问题来了：</p>
<ul>
<li>如果 RULES 太短，那它能覆盖的范围就非常有限。</li>
<li>如果 RULES 太长，每次会话AI都需要完全加载一遍它，浪费token倒是其次，重要的是token会降低AI的准确性提升幻觉。</li>
</ul>
<p>于是，模块化【懒加载】的诉求，便血淋淋摆在人们面前了。</p>
<p><code>SKILLS</code> 要解决的也正是这个痛点。</p>
<ul>
<li>它允许不同的规则被注册在不同的 SKILL.md 中，只在需要的时候进行加载。</li>
</ul>
<h2 data-id="heading-1">SKILLS 的结构</h2>
<p>要实现懒加载，有一个重要的问题需要解决：</p>
<blockquote>
<p>大模型需要知道合适加载哪个 Skill。</p>
</blockquote>
<p>因此，SKILLS的结构笼统性来说，分为两个部分：</p>
<ul>
<li>元数据: 告诉大模型我是谁，我有什么能力，什么时候应该调用我。</li>
<li>内容：指导大模型如何进行编程。</li>
</ul>
<p>这是一个典型 SKILL.md 文件的结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: API公约
<span class="hljs-section">description: 适用于当前代码库的 API 设计模式
---</span>

在编写 API 接口（端点）时：
<span class="hljs-bullet">-</span> 遵循 RESTful 命名规范
<span class="hljs-bullet">-</span> 返回统一的错误格式
<span class="hljs-bullet">-</span> 包含请求参数校验
</code></pre>
<p>在头部被 <code>---</code> 包裹起来的部分就是markdown元数据，在这里它们被用来描述技能本身的特性。</p>
<ul>
<li>name：技能的名称</li>
<li>description：技能的描述，有什么用，什么时候应该被加载</li>
</ul>
<p>而下面具体指导编程规范的部分，则是该技能的【内容】。</p>
<p>一开始的时候，【内容】并不会被加载到上下文中，只加载精简过的【元数据】，这会极大地节约token消耗，也能降低模型幻觉。</p>
<h2 data-id="heading-2">SKILLS 放在哪？</h2>
<p>结合 Claude Code、Trae、OpenCode 以及 Cursor 的最新文档，</p>
<h4 data-id="heading-3">Claude Code</h4>
<p>位置：项目根目录 /.claude/skills/</p>
<ul>
<li>结构：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">ProjectRoot/
└── .claude/
    └── skills/
        ├── skill-a/  &lt;<span class="hljs-comment">-- 技能名称文件夹</span>
        │   ├── SKILL.md  &lt;<span class="hljs-comment">-- 核心定义 (SOP &amp; Prompts)</span>
        │   └── scripts/  &lt;<span class="hljs-comment">-- (可选) 对应的 Python/Node 脚本</span>
        └── skill-b/
            └── SKILL.md
</code></pre>
<ul>
<li>生效方式：Claude Code 启动时自动扫描该目录，根据 User Prompt 和 SKILL.md 中的 description 自动挂载。</li>
</ul>
<h4 data-id="heading-4">OpenCode</h4>
<p>位置：通常为 /.opencode/skills/</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Project</span> <span class="hljs-symbol">config:</span> .opencode/skills/&lt;name&gt;<span class="hljs-regexp">/SKILL.md
Global config: ~/</span>.config/opencode/skills/&lt;name&gt;<span class="hljs-regexp">/SKILL.md
Project Claude-compatible: .claude/skills</span><span class="hljs-regexp">/&lt;name&gt;/</span><span class="hljs-variable constant_">SKILL</span>.md
<span class="hljs-title class_">Global</span> <span class="hljs-title class_">Claude</span>-<span class="hljs-symbol">compatible:</span> ~<span class="hljs-regexp">/.claude/skills</span><span class="hljs-regexp">/&lt;name&gt;/</span><span class="hljs-variable constant_">SKILL</span>.md
</code></pre>
<h4 data-id="heading-5">Cursor</h4>
<p>位置：通常为 /.cursor/skills/</p>
<pre><code class="hljs language-arduino" lang="arduino">.cursor/
└── skills/
    └── deploy-app/
        ├── SKILL.md
        ├── scripts/
        │   ├── deploy.sh
        │   └── validate.py
        ├── references/
        │   └── REFERENCE.md
        └── assets/
            └── config-<span class="hljs-keyword">template</span>.json
</code></pre>
<h4 data-id="heading-6">Trae</h4>
<p>位置：通常为 /.trae/skills/</p>
<pre><code class="hljs language-bash" lang="bash">.trae/skills/
├──skill-name/
    ├── SKILL.md  
    ├── scripts
    └── references

</code></pre>
<p>总的来说，各家有各家的习惯和地盘，希望后续能统一成标准吧。</p>
<h2 data-id="heading-7">有了SKILLS，可以不要MCP了吗？</h2>
<p>绝对不可以！</p>
<p>它们并不是互斥的两套技术。</p>
<p>恰恰相反，它们是 “黄金搭档”，是底层能力 (Capabilities) 与 上层应用 (Applications) 的关系。</p>
<p>如果把构建 Agent 比作雇佣一个员工，那么：</p>
<ul>
<li>
<p>MCP (Model Context Protocol) 是这个员工的 “手”和“感官”。</p>
<ul>
<li>
<p>它定义了员工能做什么（比如：能拿杯子、能查数据库、能运行 Python 代码）。</p>
</li>
<li>
<p>它解决了“怎么连接”的问题（标准化的接口协议）。</p>
</li>
</ul>
</li>
<li>
<p>Skills (技能/规则) 是这个员工的 “职业培训手册” (SOP)。</p>
<ul>
<li>
<p>它定义了员工该怎么做（比如：看到客人来了要倒水、查库前要先鉴权、代码报错了要重试）。</p>
</li>
<li>
<p>它解决了“怎么思考”和“怎么决策”的问题（业务逻辑与流程控制）。</p>
</li>
</ul>
</li>
</ul>
<p>总的来说，只要把 <code>SKILLS</code> 当作模块化的 <code>RULES</code>来理解会比较容易。</p>
<p>但，SKILLS 除了是模块化的 RULES 外，它还有一个重要的能力：</p>
<ul>
<li>它具备脚本执行能力。</li>
</ul>
<h2 data-id="heading-8">软硬一体的 SKILLS</h2>
<p>之前的回答为了强调“规则”的重要性，确实简化了 Skills 的定义。实际上，完整的 Skills 是“软硬一体”的。</p>
<p>在 Claude Code 的架构中，一个 Skill 确实可以包含它私有的、本地的脚本。</p>
<h3 data-id="heading-9">1. 重新定义：Skills 的完整公式</h3>
<p>纠正之前的定义，现在的公式应该是：</p>
<p>Skill = 🧠 业务规则 (SOP) + 🛠️ 专用脚本 (Local Scripts)</p>
<p>SOP (SKILL.md)：这是大脑。它告诉 AI 什么时候用、怎么用。</p>
<p>Scripts (/scripts/*.py)：这是随身工具包。它是为了配合这个 SOP 而存在的轻量级代码。</p>
<h3 data-id="heading-10">2. 为什么要允许 Skill 包含脚本？</h3>
<p>既然有了 MCP，为什么还需要 Skill 自带脚本？</p>
<p>这就像：虽然工厂里有重型机床（MCP），但工人腰带上还是得挂一把螺丝刀（Skill Script）。</p>
<p>主要有以下三个原因：</p>
<ul>
<li>
<p>A. 降低依赖 (Self-Contained)
如果你的 Skill 只是为了做一些简单的文本处理（比如“把 xxx 格式化一下”），为此启动一个 HTTP MCP Server 太重了。 把这个逻辑写成一个 20 行的 Python 脚本放在 Skill 文件夹里，随拿随用，这才是“技能包”的便携性。</p>
</li>
<li>
<p>B. 胶水逻辑 (Glue Logic)
有时候，MCP 提供的原子能力太碎了。</p>
<ul>
<li>
<p>MCP 工具 A：get_file_list</p>
</li>
<li>
<p>MCP 工具 B：analyze_file</p>
</li>
<li>
<p>Skill 脚本：你可以写一个脚本，循环调用 A，过滤结果，然后传给 B，最后输出统计报表。</p>
</li>
<li>
<p>优势：你把“循环与判断”的计算压力从 LLM（昂贵、慢）转移到了 CPU（便宜、快）。</p>
</li>
</ul>
</li>
<li>
<p>C. 本地文件操作
Claude Code 是在本地运行的。Skill 脚本可以直接通过 bash 访问你项目里的文件系统，这比远程 MCP Server 通过网络传输文件内容要高效得多。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js实现更真实的3D地球🌍动态昼夜交替]]></title>    <link>https://juejin.cn/post/7597699796200636426</link>    <guid>https://juejin.cn/post/7597699796200636426</guid>    <pubDate>2026-01-22T00:40:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597699796200636426" data-draft-id="7597623392457146419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js实现更真实的3D地球🌍动态昼夜交替"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-22T00:40:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谢小飞"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473034823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js实现更真实的3D地球🌍动态昼夜交替
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473034823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谢小飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:40:06.000Z" title="Thu Jan 22 2026 00:40:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p>　　这一切始于一个偶然的发现。前几天笔者在应用商店闲逛时，被一款3D动态壁纸深深吸引——那颗在手机屏幕上缓缓旋转的地球，光影随着时间自然流转，从阳光灿烂的白昼到星光点点的黑夜，过渡得如此丝滑而真实。那一刻，我被这种将宇宙微观化的美感震撼了。</p>
<p>　　作为一名前端开发，笔者的第一反应不是“这个壁纸真好看”，而是“这个效果我能实现吗？”。这种奇特的好奇心驱使我开始了用代码复现这一视觉奇观的探索之旅。</p>
<p>　　有趣的是，最打动我的不是最终地球模型的逼真程度，而是那个微妙的光影过渡——那条被称为“晨昏线”的光暗分界线，它既清晰又模糊，既分割又连接着地球的白天与黑夜。如何在代码中捕捉这种自然界的诗意过渡？这个问题成为了整个项目最迷人的挑战。</p>
<p>　　现在我们一起踏上这段从视觉灵感转化为技术实现的旅程，我们将用Three.js绘制星辰与大海，用着色器计算光影效果，用数学公式模拟昼夜的交替；当你看到那颗由你亲手编码的地球在浏览器中开始第一次转动时，你会发现，前端不仅仅是职业，更是一种生活方式。</p>
<blockquote>
<p>本文的最终效果可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.xieyufei.com%2Fcase%2Fthree%2Freal%2Fearth" target="_blank" title="https://gallery.xieyufei.com/case/three/real/earth" ref="nofollow noopener noreferrer">访问这个链接查看</a>查看，随手截图就是一张精美的壁纸。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb8567c469f14489982d7a1846c74dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=vN77eTGRx072PD2Syia5fKCyPLQ%3D" alt="最终效果" loading="lazy"/></p>
<h2 data-id="heading-0">环境准备</h2>
<p>　　要实现这样的效果，我们先准备需要的一些素材贴图：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 背景星空球体半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BACKGROUND_STARS_RADIUS</span> = <span class="hljs-number">200</span>;

<span class="hljs-comment">// 地球球体的半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EARTH_RADIUS</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 太阳半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUN_RADIUS</span> = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 月球半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MOON_RADIUS</span> = <span class="hljs-number">0.5</span>

<span class="hljs-comment">// 月球轨道半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MOON_TRACK_RADIUS</span> = <span class="hljs-variable constant_">EARTH_RADIUS</span> * <span class="hljs-number">2</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssetsLoader</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">load</span>([
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"sun"</span>, <span class="hljs-comment">// 太阳贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_sun.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"moon"</span>, <span class="hljs-comment">// 月球贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_moon.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"stars"</span>, <span class="hljs-comment">// 星空背景贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_stars_milky_way.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"dayTexture"</span>, <span class="hljs-comment">// 白天贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_earth_daymap.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"nightTexture"</span>, <span class="hljs-comment">// 夜晚贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_earth_nightmap.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"normalMap"</span>, <span class="hljs-comment">// 法线贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_earth_normal_map.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"clouds"</span>, <span class="hljs-comment">// 云层贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/earth_clouds_2048.png"</span>,
      },
    ]);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"onLoad"</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initMesh</span>();
    });
  }
}
</code></pre>
<blockquote>
<p>本文所有素材均下载于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.solarsystemscope.com%2Ftextures%2F" target="_blank" title="https://www.solarsystemscope.com/textures/" ref="nofollow noopener noreferrer">Solar Textures</a></p>
</blockquote>
<p>　　素材准备好后，我们就可以来初始化场景下的物体；我们先创造我们美丽的蓝色星球，让它位于中心原点的位置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initEarth</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (dayTexture &amp;&amp; nightTexture) {
      <span class="hljs-keyword">const</span> earthMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShaderMaterial</span>({
        <span class="hljs-attr">uniforms</span>: {
          <span class="hljs-attr">dayTexture</span>: { <span class="hljs-attr">value</span>: dayTexture },
          <span class="hljs-attr">nightTexture</span>: { <span class="hljs-attr">value</span>: nightTexture },
          <span class="hljs-attr">sunPosition</span>: { <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span> },
        },
        <span class="hljs-attr">vertexShader</span>: earthVertexShader,
        <span class="hljs-attr">fragmentShader</span>: earthFragmentShader,
      });

      <span class="hljs-keyword">const</span> earthGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">EARTH_RADIUS</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>);

      <span class="hljs-keyword">const</span> earthMesh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(earthGeometry, earthMaterial);
      earthMesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">basic</span>.<span class="hljs-title function_">addScene</span>(earthMesh);
    }
  }
}
</code></pre>
<p>　　然后给空旷的宇宙安装一颗恒星，放在右边偏上的位置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-attr">sunPosition</span>: <span class="hljs-title class_">Vector3</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
  <span class="hljs-title function_">initSun</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> sunTexture = <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">getAssets</span>(<span class="hljs-string">"sun"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Texture</span> | <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (sunTexture) {
      <span class="hljs-keyword">const</span> sunGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">SUN_RADIUS</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>);
      <span class="hljs-keyword">const</span> sunMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
        <span class="hljs-attr">map</span>: sunTexture,
      });
      <span class="hljs-keyword">const</span> sun = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(sunGeometry, sunMaterial);
      sun.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(sun);
    }
  }
}
</code></pre>
<p>　　有意思的是，这里的太阳虽然看起来像个发光的球，但实际上它只是个“装饰品”；我们真正用到的其实是它的位置信息<code>sunPosition</code>，用于在后面模拟昼夜交替时，将太阳的位置信息传入到着色器代码中。</p>
<p>　　在真实宇宙中，是地球绕着太阳转。但在我们的虚拟场景中，为了保持地球始终在画面中央（坐标原点），笔者耍了个小聪明——让太阳“绕着”地球转，同时给太阳一个自转。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">rotateVector3ByRadian</span>(<span class="hljs-params">vec3: Vector3, axis: Vector3, radian: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 创建旋转矩阵</span>
    <span class="hljs-keyword">const</span> matrix = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Matrix4</span>()
    <span class="hljs-comment">// 设置绕轴旋转的矩阵</span>
    matrix.<span class="hljs-title function_">makeRotationAxis</span>(axis.<span class="hljs-title function_">normalize</span>(), radian)
    <span class="hljs-comment">// 应用旋转矩阵到向量</span>
    vec3.<span class="hljs-title function_">applyMatrix4</span>(matrix)
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params">clock: Clock</span>) {
    <span class="hljs-title function_">rotateVector3ByRadian</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span>,
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-number">0.0004</span>,
    )
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sunMesh</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunMesh</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(sunPos)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunMesh</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.002</span>
    }
  }
}
</code></pre>
<p>　　接着，给我们的宇宙增加一份浩瀚感，这里的星空背景通过球体加上贴图来进行渲染：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initStarBackground</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> starsTexture = <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">getAssets</span>(<span class="hljs-string">"stars"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Texture</span> | <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (starsTexture) {
      <span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(
        <span class="hljs-variable constant_">BACKGROUND_STARS_RADIUS</span>,
        <span class="hljs-number">64</span>,
        <span class="hljs-number">64</span>
      );
      sphereGeometry.<span class="hljs-title function_">scale</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> sphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
        <span class="hljs-attr">map</span>: starsTexture,
        <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>,
      });
      <span class="hljs-keyword">const</span> sphere = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(sphereGeometry, sphereMaterial);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(sphere);
    }
  }
}
</code></pre>
<p>　　地球怎么能独自在宇宙中流浪呢？怎么能少得了它忠实的小跟班——月球呢？但只是放个月球太普通了，我决定给它加个专属的“跑道”track：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-attr">moonPosition</span>: <span class="hljs-title class_">Vector3</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">MOON_TRACK_RADIUS</span>, <span class="hljs-number">0</span>)
  <span class="hljs-title function_">initMoon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> group = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Group</span>()

    <span class="hljs-keyword">const</span> trackGeo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TorusGeometry</span>(<span class="hljs-variable constant_">MOON_TRACK_RADIUS</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
    <span class="hljs-keyword">const</span> trackMt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
      <span class="hljs-attr">color</span>: guiOption.<span class="hljs-property">moon</span>.<span class="hljs-property">trackColor</span>,
      <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
    })
    <span class="hljs-keyword">const</span> track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(trackGeo, trackMt)
    group.<span class="hljs-title function_">add</span>(track)

    <span class="hljs-keyword">const</span> moonGeo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">MOON_RADIUS</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
    <span class="hljs-keyword">const</span> moonMt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
      <span class="hljs-attr">map</span>: moonTexture,
    })
    <span class="hljs-keyword">const</span> moon = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(moonGeo, moonMt)
    moon.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">moonPosition</span>)
    group.<span class="hljs-title function_">add</span>(moon)
    
    group.<span class="hljs-title function_">rotateX</span>(<span class="hljs-title class_">MathUtils</span>.<span class="hljs-title function_">degToRad</span>(<span class="hljs-number">100</span>))
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(group)    
  }
}
</code></pre>
<p>　　那个半透明的轨道环其实是个视觉引导——它告诉用户“嘿，月球是沿着这条路径运动的”。虽然真实月球没有可见轨道，但这个设计增加了场景的科技感和可读性。</p>
<p>　　当我看到月球带着它的光环开始绕着地球旋转时，那感觉就像完成了一个精密的宇宙钟表——每个部件都有它的位置，每个运动都有它的规律。这个小跟班让我们的地球不再孤单，整个太阳系开始有了“系统”的感觉。</p>
<h3 data-id="heading-1">实现昼夜分明</h3>
<p>　　前面我们搭建好了整个太阳系舞台，但此刻的地球还只是一个静止的球体，没有光影变化，没有昼夜交替。现在，是时候为这颗蓝色星球注入灵魂了。还记得我们初始化地球时预留的vertexShader和fragmentShader吗？那两个看似简单的GLSL代码文件，才是实现昼夜交替魔法的核心所在。</p>
<p>　　如果说地球模型是个巨大的工厂，那么顶点着色器就是为每个工人（像素点）准备工牌的生产线。下面着色器代码其实在做两件重要的事情：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 纹理坐标</span>
varying vec2 vUv;
<span class="hljs-comment">// 变换后的法线向量</span>
varying vec3 vNormal;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    vUv=uv;
    vNormal=normalize(normalMatrix*normal);
    gl_Position= projectionMatrix * modelViewMatrix * vec4(position, <span class="hljs-number">1.0</span>);
}
</code></pre>
<p>　　<code>vUv</code>用来记录每个顶点的纹理坐标，<code>vNormal</code>计算并传递法线向量，每个顶点的法线就像一根小指针，直直地指向该点的“正上方”，normalize()函数让法线向量保持长度为1（归一化）。varying表示把顶点着色器的计算结果传递给下面的片元着色器。</p>
<p>　　所以别看上面这段代码短，它可是整个昼夜效果的地基。它为地球表面每个点都准备好了：“我是谁（uv坐标）”、“我面朝哪里（法线）”，就等着片元着色器来判断：“你现在应该是白天还是黑夜”；下面是我们最重要的片元着色器代码了：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> GL_ES</span>
precision mediump <span class="hljs-type">float</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

uniform sampler2D dayTexture;
uniform sampler2D nightTexture;
uniform vec3 sunPosition;

varying vec2 vUv;
varying vec3 vNormal;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    vec3 lightDir=normalize(sunPosition);
    
    <span class="hljs-type">float</span> dotProduct=dot(normalize(vNormal),lightDir);
    
    <span class="hljs-keyword">if</span>(dotProduct&gt;<span class="hljs-number">0.</span>){
        gl_FragColor=texture2D(dayTexture,vUv);
    }<span class="hljs-keyword">else</span>{
        gl_FragColor=texture2D(nightTexture,vUv);
    }
}
</code></pre>
<p>　　这段代码虽然只有短短的十几行，却决定了地球表面每一处是光明还是黑暗。GLSL语法比较难懂，我们下面就来详细介绍一下。</p>
<p>　　首先我们将前面顶点着色器中处理好的单位法线向量vNormal接收，然后将传入的太阳的位置接收，通过<code>normalize</code>函数进行归一化操作，得到了太阳的方向；最轴将上面计算的法线向量和太阳的方向进行点积运算。</p>
<blockquote>
<p>将太阳位置归一化后的方向向量，表示从原点指向太阳位置的单位向量，而不是从太阳位置出发指向原点，这一点需要注意。</p>
</blockquote>
<p>　　这里详细说一下点积运算的几何意义，在三维空间中，两个向量的点积公式是：</p>
<pre><code class="hljs language-css" lang="css">dot(<span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>) = |<span class="hljs-selector-tag">A</span>| × |<span class="hljs-selector-tag">B</span>| × cos(θ)
</code></pre>
<p>　　其中θ是A和B之间的夹角；而我们上面已经对两个向量都进行了归一化操作，因此公式简化为：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dot</span>(A, B) = <span class="hljs-built_in">cos</span>(θ)
</code></pre>
<p>　　因此这里的<code>角度θ</code>其实代表了法线与太阳光线方向的夹角，我们通过一张图来理解，球体表面的蓝色箭头，表示法线；而原点黄色的箭头，表示太阳的方向：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b554e6d07b3a43e0aefe7db5dc6ea7d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=kteIZQZJfaQszxsHeEczWmBNi58%3D" alt="太阳方向夹角" loading="lazy"/></p>
<p>　　因此在上面片元着色器代码中，计算得到的<code>dotProduct</code>变量，其实也是<code>cos(θ)</code>的值；我们通过对它的值进行判断，如果<code>dotProduct</code>大于0，则表示法线与太阳方向夹角小于90度，则表示当前点在白天，则使用白天贴图进行渲染；否则使用夜晚贴图进行渲染；运行后，我们就能看到地球的白天黑夜有明显的界线分隔了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/746b267f5f534478a58970a0a1b3e7f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=Lr9uaKmfpyn%2FF12QxPs%2BhzL12yk%3D" alt="地球白天黑夜效果" loading="lazy"/></p>
<p>　　最后在太阳转动的同时，不要忘记更新地球材质的uniforms中的sunPosition属性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params">clock: Clock</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">earthMaterial</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">earthMaterial</span>.<span class="hljs-property">uniforms</span>.<span class="hljs-property">sunPosition</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">copy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span>)
    }
  }
}
</code></pre>
<h2 data-id="heading-2">星空顶</h2>
<p>　　如果你最近去过高端楼盘展厅或者坐过某些豪华车型，大概率见过那个让人惊艳的设计——星空顶。无数光点在头顶缓缓闪烁，像是把整个银河系微缩在了方寸之间。这种将宇宙浪漫融入空间的设计，早已成为“高端感”的代名词。</p>
<p>　　我们项目怎么能少了这样迷人的星空呢？不行，我们的项目也要向高端、豪华看齐。虽然之前我们用一张星空贴图作为背景，但是总感觉不够真实，缺少了星空那种忽明忽暗的光亮效果；我们在太阳到星空背景球体之间，通过Points来添加众多的星星，我们首先初始化星星的一些参数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 星星数量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARS_AMOUNT</span> = <span class="hljs-number">1000</span>;
<span class="hljs-comment">// 星星最小距离</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARS_MIN_DISTANCE</span> = <span class="hljs-number">100</span>;
<span class="hljs-comment">// 星星最大距离</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARS_MAX_DISTANCE</span> = <span class="hljs-number">200</span>;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initStars</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> starGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferGeometry</span>();
    <span class="hljs-comment">// 每个点的xyz坐标</span>
    <span class="hljs-keyword">const</span> positions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span> * <span class="hljs-number">3</span>);
    <span class="hljs-comment">// 每个点rgb颜色</span>
    <span class="hljs-keyword">const</span> colors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span> * <span class="hljs-number">3</span>);
    <span class="hljs-comment">// 每个点的初始大小</span>
    <span class="hljs-keyword">const</span> sizes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span>);
    <span class="hljs-comment">// 每个点的闪烁相位</span>
    <span class="hljs-keyword">const</span> phases = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span>);
    <span class="hljs-comment">// 每个点的闪烁频率</span>
    <span class="hljs-keyword">const</span> frequencies = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span>);
  }
}
</code></pre>
<p>　　由于我们想要生成从太阳到星空背景球体之间圆环内的随机点，因此我们可以通过极坐标的方式来计算，通过极坐标转换到三维空间内的坐标：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initStars</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">STARS_AMOUNT</span>; i++) {
      <span class="hljs-keyword">const</span> i3 = i * <span class="hljs-number">3</span>

      <span class="hljs-comment">// 在球体空间内随机生成位置</span>
      <span class="hljs-keyword">const</span> distance = <span class="hljs-title function_">getRandomInt</span>(<span class="hljs-variable constant_">STARS_MIN_DISTANCE</span>, <span class="hljs-variable constant_">STARS_MAX_DISTANCE</span>)
      <span class="hljs-keyword">const</span> theta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span> <span class="hljs-comment">// 方位角</span>
      <span class="hljs-keyword">const</span> phi = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">acos</span>(<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">1</span>) <span class="hljs-comment">// 极角</span>

      <span class="hljs-comment">// 球坐标转直角坐标</span>
      positions[i3] = distance * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta)
      positions[i3 + <span class="hljs-number">1</span>] = distance * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta)
      positions[i3 + <span class="hljs-number">2</span>] = distance * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(phi)
    }
  }
}
</code></pre>
<p>　　坐标位置搞定了，我们继续给每个点生成随即的颜色、大小、闪烁相位、闪烁频率属性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 随机颜色（偏向白色和蓝色）</span>
<span class="hljs-keyword">const</span> colorChoice = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()
<span class="hljs-keyword">if</span> (colorChoice &lt; <span class="hljs-number">0.7</span>) {
  <span class="hljs-comment">// 白色/淡黄色星星</span>
  colors[i3] = <span class="hljs-number">1.0</span> <span class="hljs-comment">// R</span>
  colors[i3 + <span class="hljs-number">1</span>] = <span class="hljs-number">0.9</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.1</span> <span class="hljs-comment">// G</span>
  colors[i3 + <span class="hljs-number">2</span>] = <span class="hljs-number">0.8</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.2</span> <span class="hljs-comment">// B</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (colorChoice &lt; <span class="hljs-number">0.9</span>) {
  <span class="hljs-comment">// 蓝色星星</span>
  colors[i3] = <span class="hljs-number">0.4</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span> <span class="hljs-comment">// R</span>
  colors[i3 + <span class="hljs-number">1</span>] = <span class="hljs-number">0.6</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span> <span class="hljs-comment">// G</span>
  colors[i3 + <span class="hljs-number">2</span>] = <span class="hljs-number">1.0</span> <span class="hljs-comment">// B</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 红色/橙色星星</span>
  colors[i3] = <span class="hljs-number">1.0</span> <span class="hljs-comment">// R</span>
  colors[i3 + <span class="hljs-number">1</span>] = <span class="hljs-number">0.5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span> <span class="hljs-comment">// G</span>
  colors[i3 + <span class="hljs-number">2</span>] = <span class="hljs-number">0.3</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.2</span> <span class="hljs-comment">// B</span>
}

<span class="hljs-comment">// 大小</span>
sizes[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>
<span class="hljs-comment">// 闪烁频率</span>
frequencies[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>
<span class="hljs-comment">// 闪烁相位</span>
phases[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>
</code></pre>
<p>　　最后，我们通过BufferGeometry将这些数据传入Points对象中：</p>
<pre><code class="hljs language-typescript" lang="typescript">starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"position"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(positions, <span class="hljs-number">3</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"color"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(colors, <span class="hljs-number">3</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"size"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(sizes, <span class="hljs-number">1</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"phase"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(phases, <span class="hljs-number">1</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"frequency"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(frequencies, <span class="hljs-number">1</span>))
</code></pre>
<p>　　然后创建Points对象，同时在uniforms中添加一个time属性，用于控制星星闪烁：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> starMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">time</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.0</span> },
  },
  <span class="hljs-attr">vertexShader</span>: starsVertexShader,
  <span class="hljs-attr">fragmentShader</span>: starsFragmentShader,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">blending</span>: <span class="hljs-title class_">AdditiveBlending</span>,
})
<span class="hljs-keyword">const</span> stars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Points</span>(starGeometry, starMaterial)
</code></pre>
<p>　　在我们的顶点着色器代码中，接收上面的顶点数据：</p>
<pre><code class="hljs language-c" lang="c">attribute <span class="hljs-type">float</span> size;
attribute vec3 color;
attribute <span class="hljs-type">float</span> phase;
attribute <span class="hljs-type">float</span> frequency;

varying vec3 vColor;

uniform <span class="hljs-type">float</span> time;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    vColor = color;
    
    <span class="hljs-comment">// 闪烁效果计算</span>
    <span class="hljs-type">float</span> blink = <span class="hljs-built_in">sin</span>(time * frequency + phase) * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.8</span>;
    
    <span class="hljs-comment">// 添加一些随机噪声使闪烁更自然</span>
    <span class="hljs-type">float</span> noise = <span class="hljs-built_in">sin</span>(dot(position, vec3(<span class="hljs-number">12.9898</span>, <span class="hljs-number">78.233</span>, <span class="hljs-number">45.5432</span>)) * <span class="hljs-number">43758.5453</span>) * <span class="hljs-number">0.1</span>;
    
    <span class="hljs-comment">// 最终大小</span>
    <span class="hljs-type">float</span> finalSize = size * (blink + noise);
    
    vec4 mvPosition = modelViewMatrix * vec4(position, <span class="hljs-number">1.0</span>);
    gl_PointSize = finalSize * (<span class="hljs-number">300.0</span> / -mvPosition.z);
    gl_Position = projectionMatrix * mvPosition;
}
</code></pre>
<p>　　<code>vColor</code>用来将前面生成的点的颜色传递给片元着色器，让星星有独立的颜色；blink是实现星星闪烁的关键公式，time × frequency表示随时间变化的相位，phase控制每个粒子的初始相位偏移，使得闪烁不会同步进行；sin函数产生平滑的正弦波振荡，取值范围是[-1, 1]，最终blink的范围是[0.3, 1.3]，再乘以size初始化大小，得到了星星在不同时刻的最终大小。</p>
<p>　　最后片元着色器代码如下：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> GL_ES</span>
precision mediump <span class="hljs-type">float</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

varying vec3 vColor;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 圆形点</span>
    <span class="hljs-type">float</span> distanceToCenter = length(gl_PointCoord - vec2(<span class="hljs-number">0.5</span>));
    <span class="hljs-keyword">if</span> (distanceToCenter &gt; <span class="hljs-number">0.5</span>) {
        discard;
    }
    
    <span class="hljs-comment">// 添加一些发光效果</span>
    <span class="hljs-type">float</span> alpha = <span class="hljs-number">1.0</span> - smoothstep(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.5</span>, distanceToCenter);
    
    gl_FragColor = vec4(vColor, alpha * <span class="hljs-number">0.9</span>);
}
</code></pre>
<h2 data-id="heading-3">美丽的晨昏线</h2>
<p>　　如果仔细观察真实的地球照片，你会发现一个迷人的细节：白天和黑夜之间，并没有一条生硬的分界线。取而代之的，是一片温柔过渡的“灰色地带”——这就是我们常说的<code>晨昏线</code>，也是日出日落时分最富诗意的区域。</p>
<p>　　回头看我们之前实现的昼夜分割的效果，虽然功能完整，但是少了些自然界的柔美；现实世界的光影变化，从来不是非黑即白的开关，而是渐变的艺术；下面我们就来创造出一个平滑过渡的晨昏区域，让白昼缓缓融入黑夜。</p>
<p>　　上面我们详细介绍了白天黑夜如何通过太阳光和法线进行判断，而其核心原理就是下面的计算公式：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">float</span> dotProduct=dot(normalize(vNormal),lightDir);
</code></pre>
<p>　　dotProduct的取值范围是<code>[-1, 1]</code>，当在0～1之间时，代表表面正对太阳，是白天；-1～0之间，表示背对太阳，是黑夜；我们想要让太阳在中间地带有一个过渡的范围，我们先给ShaderMaterial传入一个参数<code>transitionWidth</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> earthMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">dayTexture</span>: { <span class="hljs-attr">value</span>: dayTexture },
    <span class="hljs-attr">nightTexture</span>: { <span class="hljs-attr">value</span>: nightTexture },
    <span class="hljs-comment">// 新增过渡范围参数</span>
    <span class="hljs-attr">transitionWidth</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.2</span> },
  },
  <span class="hljs-attr">vertexShader</span>: earthVertexShader,
  <span class="hljs-attr">fragmentShader</span>: earthFragmentShader,
})
</code></pre>
<p>　　然后，在片元着色器中添加过渡参数：</p>
<pre><code class="hljs language-c" lang="c">uniform <span class="hljs-type">float</span> transitionWidth; 
<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
  <span class="hljs-type">float</span> transitionCenter = <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 晨昏线</span>
  <span class="hljs-type">float</span> transitionStart = transitionCenter - transitionWidth * <span class="hljs-number">0.5</span>;
  <span class="hljs-type">float</span> transitionEnd = transitionCenter + transitionWidth * <span class="hljs-number">0.5</span>;
}
</code></pre>
<p>　　当传入transitionWidth是0.2时，计算得到下面的范围：</p>
<ul>
<li>transitionStart = -0.1</li>
<li>transitionEnd = 0.1</li>
</ul>
<p>　　这就意味着在dotProduct点积值[-0.1, 0.1]范围内是过渡区域；然后使用<code>smoothstep</code>创建一个平滑插值：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
  <span class="hljs-comment">// 使用smoothstep创建平滑过渡</span>
  <span class="hljs-type">float</span> mixFactor = smoothstep(transitionStart, transitionEnd, dotProduct);
}
</code></pre>
<p>　　smoothstep函数的行为如下：</p>
<ul>
<li>当 dotProduct &lt;= transitionStart 时：mixFactor = 0.0</li>
<li>当 dotProduct &gt;= transitionEnd 时：mixFactor = 1.0</li>
<li>当 transitionStart &lt; dotProduct &lt; transitionEnd 时：mixFactor 平滑过渡</li>
</ul>
<p>　　因此，smoothstep函数实际上将dotProduct区间值[-1, 1]映射到mixFactor的[0, 1]范围内，并创建一个平滑过渡；其中[-1 , -0.1]，映射为0,表示黑夜，[0.1 , 1]，映射为1，表示白天，中间的(-0.1 , 0.1)映射到(0, 1)表示过渡的区域；我们通过一个表格来详细表示：</p>













































<table><thead><tr><th>dotProduct值</th><th>mixFactor</th><th>纹理</th></tr></thead><tbody><tr><td>-1</td><td>0</td><td>黑夜</td></tr><tr><td>-0.5</td><td>0</td><td>黑夜</td></tr><tr><td>-0.1</td><td>0</td><td>逐渐从黑夜过渡到白天</td></tr><tr><td>0</td><td>0.5</td><td>中间过渡区域</td></tr><tr><td>0.1</td><td>1</td><td>逐渐从白天过渡到黑夜</td></tr><tr><td>0.5</td><td>1</td><td>白天</td></tr><tr><td>1</td><td>1</td><td>白天</td></tr></tbody></table>
<p>　　最后使用<code>mix函数</code>将白天和黑夜的纹理进行混合：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
  <span class="hljs-comment">// 采样纹理</span>
  vec4 dayColor = texture2D(dayTexture, vUv);
  vec4 nightColor = texture2D(nightTexture, vUv);
  
  <span class="hljs-comment">// 混合白天和黑夜纹理</span>
  gl_FragColor = mix(nightColor, dayColor, mixFactor);
}
</code></pre>
<p>　　这样，我们就实现了白天黑夜的过渡效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedd7103979d44af9e906aab4f8ab3fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=h5PZ%2B8ykp8vMSVH2JpnZBF4iPpM%3D" alt="白天黑夜过渡效果" loading="lazy"/></p>
<h2 data-id="heading-4">尾声：在代码中雕刻时光的意义</h2>
<p>　　当我们看着这个由自己亲手绘制的“微缩版太阳系”在浏览器中静静旋转时，一种奇特的感受油然而生——在这个微观的数字宇宙里，我既是造物主，也是最渺小的观察者。</p>
<p>　　我们用了不到1000行的代码，就模拟了一个直径12742公里的星球上每时每刻的光影变迁。真实的地球需要24小时完成一次昼夜交替，我们的数字地球只需几分钟。这种尺度上的巨大反差让我突然明白：人类的所有创造，本质上都是对无限宇宙的有限翻译。</p>
<p>　　那颗在轨道上“绕着”地球转的太阳，其实只是在绕着原点旋转的几行向量计算。但就是这简单的数学，却再现了我们祖先仰望天空时看到的景象——日出东方，日落西沉。从地心说到日心说，再到今天的代码模拟，人类对宇宙的理解在变，但那份想要理解世界的好奇心从未改变。</p>
<blockquote>
<p>“给岁月以文明，而不是给文明以岁月”。——《三体》</p>
</blockquote>
<p>　　我们不是在追求让这个数字地球永恒运行，那颗正在你屏幕上旋转的蓝色星球，可能在下一秒就会浏览器缓存清理；那些闪烁的星星，可能随着标签页关闭而永远熄灭。</p>
<p>　　而是在有限的运行时间里，赋予它最丰富的意义：让晨昏线温柔过渡，让星空会呼吸，让光影如诗歌般流动。我们关心的不是代码能运行多久，而是它在运行的每一帧里，是否足够美好，是否传递了我们对真实世界的观察与敬意。</p>
<p>　　毕竟，在浩瀚的宇宙面前，所有文明都只是瞬间的火花。而最美的火花，不是燃烧得最久的那个，而是燃烧时最亮、最温暖的那个。</p>
<blockquote>
<p>本文的最终效果可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.xieyufei.com%2Fcase%2Fthree%2Freal%2Fearth" target="_blank" title="https://gallery.xieyufei.com/case/three/real/earth" ref="nofollow noopener noreferrer">这个链接查看</a>查看。</p>
</blockquote>
<p>如果觉得写得还不错，请关注我的<a href="//juejin.im/user/580038cebf22ec0064bd0b2d" target="_blank" title="//juejin.im/user/580038cebf22ec0064bd0b2d">掘金主页</a>。更多文章请访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fxieyufei.com" target="_blank" title="http://xieyufei.com" ref="nofollow noopener noreferrer">谢小飞的博客</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第3章、基础语法——变量、常量与数据类型]]></title>    <link>https://juejin.cn/post/7597635202325364788</link>    <guid>https://juejin.cn/post/7597635202325364788</guid>    <pubDate>2026-01-22T00:40:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202325364788" data-draft-id="7597650624637632512" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第3章、基础语法——变量、常量与数据类型"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-22T00:40:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第3章、基础语法——变量、常量与数据类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:40:15.000Z" title="Thu Jan 22 2026 00:40:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 在上一章我们完成了第一个Go程序的编写与运行，初步了解了Go的程序结构。今天我们深入Go的基础语法核心——<strong>变量、常量与数据类型</strong>。这三块是任何编程语言的基石，也是后续写复杂逻辑的前提，建议大家边看边敲代码，把基础打扎实。</p>
<p>Go在变量、常量的设计上很有特色，比如支持多种声明方式、内置iota枚举机制，数据类型体系也简洁严谨，没有冗余的类型。接下来我们逐节拆解，每个知识点都配上可直接运行的代码示例，帮你快速理解。</p>
<h2 data-id="heading-0">1. 变量的声明方式：var与短声明</h2>
<p>变量是用来存储数据的容器，Go提供了多种声明变量的方式，核心分为<code>var</code>声明和短声明两种，适用于不同场景。</p>
<h3 data-id="heading-1">1.1 var声明（通用方式）</h3>
<p><code>var</code>是Go中最基础的变量声明关键字，支持多种写法，灵活性高，可在函数内或函数外使用。</p>
<p><strong>基本语法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 1. 完整声明：var 变量名 类型 = 值</span>
<span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>

<span class="hljs-comment">// 2. 类型推断：省略类型，Go自动推断</span>
<span class="hljs-keyword">var</span> age = <span class="hljs-number">25</span>  <span class="hljs-comment">// 自动推断为int类型</span>

<span class="hljs-comment">// 3. 声明多个变量（分组形式，推荐）</span>
<span class="hljs-keyword">var</span> (
    address <span class="hljs-type">string</span> = <span class="hljs-string">"Beijing"</span>
    score   <span class="hljs-type">float64</span> = <span class="hljs-number">98.5</span>
    isPass  <span class="hljs-type">bool</span>    = <span class="hljs-literal">true</span>
)

<span class="hljs-comment">// 4. 只声明不赋值（会赋予零值，后续讲）</span>
<span class="hljs-keyword">var</span> height <span class="hljs-type">float32</span>

</code></pre>
<p><strong>使用场景</strong>：适合全局变量声明（函数外只能用var）、需要明确指定类型的变量，或批量声明多个变量的场景。</p>
<p><strong>运行示例</strong>：将上述代码放入main函数中运行，查看变量值：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>
    <span class="hljs-keyword">var</span> age = <span class="hljs-number">25</span>
    <span class="hljs-keyword">var</span> (
        address <span class="hljs-type">string</span> = <span class="hljs-string">"Beijing"</span>
        score   <span class="hljs-type">float64</span> = <span class="hljs-number">98.5</span>
        isPass  <span class="hljs-type">bool</span>    = <span class="hljs-literal">true</span>
    )
    <span class="hljs-keyword">var</span> height <span class="hljs-type">float32</span>

    fmt.Println(name, age, address, score, isPass, height)
    <span class="hljs-comment">// 输出：Gopher 25 Beijing 98.5 true 0</span>
}

</code></pre>
<h3 data-id="heading-2">1.2 短声明（:=）（函数内专用）</h3>
<p>短声明使用<code>:=</code>符号，是Go中最简洁的变量声明方式，但有严格的使用限制。</p>
<p><strong>基本语法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 变量名 := 值（自动推断类型）</span>
username := <span class="hljs-string">"Alice"</span>
age := <span class="hljs-number">30</span>
isStudent := <span class="hljs-literal">false</span>

<span class="hljs-comment">// 同时声明多个变量</span>
a, b := <span class="hljs-number">10</span>, <span class="hljs-number">20</span>  <span class="hljs-comment">// a=10（int），b=20（int）</span>

</code></pre>
<p><strong>核心限制</strong>：</p>
<ul>
<li>
<p>只能在函数内使用（函数外不允许）；</p>
</li>
<li>
<p>必须至少声明一个新变量（不能用来重复声明已存在的变量，除非是多变量声明中包含新变量）；</p>
</li>
<li>
<p>不能指定类型（只能靠Go自动推断）。</p>
</li>
</ul>
<p><strong>错误示例与修正</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 错误1：函数外使用短声明</span>
<span class="hljs-comment">// username := "Bob"  // 编译报错：syntax error: non-declaration statement outside function body</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Alice"</span>
    <span class="hljs-comment">// 错误2：重复声明单一变量</span>
    <span class="hljs-comment">// name := "Bob"  // 编译报错：no new variables on left side of :=</span>

    <span class="hljs-comment">// 正确：多变量声明中包含新变量</span>
    name, age := <span class="hljs-string">"Bob"</span>, <span class="hljs-number">28</span>  <span class="hljs-comment">// name重复，但age是新变量，允许</span>
    fmt.Println(name, age)  <span class="hljs-comment">// 输出：Bob 28</span>
}

</code></pre>
<p><strong>使用场景</strong>：函数内局部变量的快速声明，代码简洁高效，是Go开发中最常用的局部变量声明方式。</p>
<h2 data-id="heading-3">2. 常量定义与iota枚举机制</h2>
<p>常量是值不可修改的“固定变量”，用于存储程序运行过程中不会变化的数据（比如π的值、配置项中的固定参数）。Go中用<code>const</code>定义常量，还支持<code>iota</code>关键字实现简洁的枚举。</p>
<h3 data-id="heading-4">2.1 基本常量定义</h3>
<p><strong>基本语法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 1. 完整定义：const 常量名 类型 = 值</span>
<span class="hljs-keyword">const</span> Pi <span class="hljs-type">float64</span> = <span class="hljs-number">3.1415926</span>

<span class="hljs-comment">// 2. 类型推断：省略类型</span>
<span class="hljs-keyword">const</span> MaxScore = <span class="hljs-number">100</span>  <span class="hljs-comment">// 自动推断为int</span>

<span class="hljs-comment">// 3. 批量定义（分组形式，推荐）</span>
<span class="hljs-keyword">const</span> (
    AppName  <span class="hljs-type">string</span> = <span class="hljs-string">"GoDemo"</span>
    Version  = <span class="hljs-string">"v1.0.0"</span>
    MaxConn  = <span class="hljs-number">1000</span>  <span class="hljs-comment">// int类型</span>
    IsProEnv <span class="hljs-type">bool</span>    = <span class="hljs-literal">false</span>
)

</code></pre>
<p><strong>核心特性</strong>：</p>
<ul>
<li>
<p>常量的值必须是编译期可确定的（不能用运行时才能计算的值，比如函数返回值）；</p>
</li>
<li>
<p>常量一旦定义，值不可修改；</p>
</li>
<li>
<p>支持全局和局部声明（函数内、函数外都可）。</p>
</li>
</ul>
<p><strong>错误示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getNum</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 错误：常量值不能是运行时计算的函数返回值</span>
    <span class="hljs-comment">// const Num = getNum()  // 编译报错：const initializer getNum() is not a constant</span>
}

</code></pre>
<h3 data-id="heading-5">2.2 iota枚举机制</h3>
<p>在很多编程语言中，枚举需要手动给每个值赋值，而Go中的<code>iota</code>关键字可以自动生成连续的整数，简化枚举定义。</p>
<p><strong>核心规则</strong>：</p>
<ul>
<li>
<p><code>iota</code>只能在<code>const</code>分组中使用；</p>
</li>
<li>
<p>每组<code>const</code>中，<code>iota</code>从0开始，每新增一行常量，<code>iota</code>的值自动加1；</p>
</li>
<li>
<p>支持通过表达式自定义枚举值（比如乘、加等运算）。</p>
</li>
</ul>
<p><strong>示例1：基础枚举</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 定义星期枚举</span>
<span class="hljs-keyword">const</span> (
    Sunday    = <span class="hljs-literal">iota</span>  <span class="hljs-comment">// 0</span>
    Monday            <span class="hljs-comment">// 1（自动继承iota，等价于Monday = iota）</span>
    Tuesday           <span class="hljs-comment">// 2</span>
    Wednesday         <span class="hljs-comment">// 3</span>
    Thursday          <span class="hljs-comment">// 4</span>
    Friday            <span class="hljs-comment">// 5</span>
    Saturday          <span class="hljs-comment">// 6</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(Sunday, Monday, Saturday)  <span class="hljs-comment">// 输出：0 1 6</span>
}

</code></pre>
<p><strong>示例2：自定义枚举值</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 定义权限级别枚举（2的幂次，支持位运算）</span>
<span class="hljs-keyword">const</span> (
    ReadPermission = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-literal">iota</span>  <span class="hljs-comment">// 1 &lt;&lt; 0 = 1（二进制：0001）</span>
    WritePermission             <span class="hljs-comment">// 1 &lt;&lt; 1 = 2（0010）</span>
    ExecutePermission           <span class="hljs-comment">// 1 &lt;&lt; 2 = 4（0100）</span>
    DeletePermission            <span class="hljs-comment">// 1 &lt;&lt; 3 = 8（1000）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(ReadPermission, WritePermission, ExecutePermission, DeletePermission)
    <span class="hljs-comment">// 输出：1 2 4 8</span>

    <span class="hljs-comment">// 组合权限（位运算）</span>
    rwPermission := ReadPermission | WritePermission
    fmt.Println(rwPermission)  <span class="hljs-comment">// 输出：3（0011）</span>
}

</code></pre>
<p><strong>示例3：跳过枚举值</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-keyword">const</span> (
    A = <span class="hljs-literal">iota</span>  <span class="hljs-comment">// 0</span>
    B         <span class="hljs-comment">// 1</span>
    _         <span class="hljs-comment">// 2（跳过该值）</span>
    D         <span class="hljs-comment">// 3</span>
    E         <span class="hljs-comment">// 4</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(A, B, D, E)  <span class="hljs-comment">// 输出：0 1 3 4</span>
}

</code></pre>
<h2 data-id="heading-6">3. Go的基本数据类型体系</h2>
<p>Go是静态类型语言，每个变量都有明确的类型，且类型转换严格。Go的基本数据类型体系简洁清晰，没有冗余类型，主要分为四大类：<strong>数值类型、字符串类型、布尔类型、派生类型</strong>（指针、数组等，后续章节讲）。这里重点讲前三者。</p>
<h3 data-id="heading-7">3.1 数值类型</h3>
<p>数值类型分为整数型和浮点型，支持不同精度的需求。</p>
<p><strong>1. 整数型</strong>（按长度和有无符号划分）：</p>







































































<table><thead><tr><th>类型</th><th>占用字节</th><th>取值范围</th><th>说明</th></tr></thead><tbody><tr><td>int8</td><td>1</td><td>-128 ~ 127</td><td>有符号8位整数</td></tr><tr><td>uint8（byte）</td><td>1</td><td>0 ~ 255</td><td>无符号8位整数，byte是其别名（常用作字节存储）</td></tr><tr><td>int16</td><td>2</td><td>-32768 ~ 32767</td><td>有符号16位整数</td></tr><tr><td>uint16</td><td>2</td><td>0 ~ 65535</td><td>无符号16位整数</td></tr><tr><td>int32（rune）</td><td>4</td><td>-2147483648 ~ 2147483647</td><td>有符号32位整数，rune是其别名（常用作Unicode字符）</td></tr><tr><td>uint32</td><td>4</td><td>0 ~ 4294967295</td><td>无符号32位整数</td></tr><tr><td>int64</td><td>8</td><td>-9223372036854775808 ~ 9223372036854775807</td><td>有符号64位整数</td></tr><tr><td>uint64</td><td>8</td><td>0 ~ 18446744073709551615</td><td>无符号64位整数</td></tr><tr><td>int</td><td>32位系统4字节，64位系统8字节</td><td>随系统变化</td><td>默认整数类型，日常开发最常用</td></tr><tr><td>uint</td><td>随系统变化</td><td>随系统变化</td><td>无符号默认整数类型，少用</td></tr></tbody></table>
<p><strong>2. 浮点型</strong>（支持小数，按精度划分）：</p>























<table><thead><tr><th>类型</th><th>占用字节</th><th>精度</th><th>说明</th></tr></thead><tbody><tr><td>float32</td><td>4</td><td>约6-7位有效数字</td><td>单精度浮点型</td></tr><tr><td>float64</td><td>8</td><td>约15-17位有效数字</td><td>双精度浮点型，默认浮点类型，日常开发首选</td></tr></tbody></table>
<p><strong>数值类型示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int8</span> = <span class="hljs-number">-128</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">uint8</span> = <span class="hljs-number">255</span>
    <span class="hljs-keyword">var</span> c <span class="hljs-type">int</span> = <span class="hljs-number">1000</span>  <span class="hljs-comment">// 默认int类型</span>
    <span class="hljs-keyword">var</span> d <span class="hljs-type">float64</span> = <span class="hljs-number">3.1415926535</span>  <span class="hljs-comment">// 默认float64类型</span>
    <span class="hljs-keyword">var</span> e <span class="hljs-type">byte</span> = <span class="hljs-string">'A'</span>  <span class="hljs-comment">// byte是uint8别名，存储字符的ASCII码</span>
    <span class="hljs-keyword">var</span> f <span class="hljs-type">rune</span> = <span class="hljs-string">'中'</span> <span class="hljs-comment">// rune是int32别名，存储Unicode字符</span>

    fmt.Println(a, b, c, d)  <span class="hljs-comment">// 输出：-128 255 1000 3.1415926535</span>
    fmt.Println(e, <span class="hljs-type">string</span>(e))  <span class="hljs-comment">// 输出：65 A（ASCII码转字符）</span>
    fmt.Println(f, <span class="hljs-type">string</span>(f))  <span class="hljs-comment">// 输出：20013 中（Unicode码转字符）</span>
}

</code></pre>
<h3 data-id="heading-8">3.2 字符串类型（string）</h3>
<p>字符串用于存储文本，Go中的字符串是<strong>不可变的</strong>（一旦创建，不能修改单个字符），使用UTF-8编码。</p>
<p><strong>基本用法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 双引号定义（支持转义字符）</span>
    <span class="hljs-keyword">var</span> str1 <span class="hljs-type">string</span> = <span class="hljs-string">"Hello, Go!\n这是换行"</span>
    <span class="hljs-comment">// 2. 反引号定义（原样输出，不解析转义字符，支持多行）</span>
    <span class="hljs-keyword">var</span> str2 <span class="hljs-type">string</span> = <span class="hljs-string">`Hello, Go!
这是换行
这是第二行`</span>

    fmt.Println(str1)
    fmt.Println(<span class="hljs-string">"-----"</span>)
    fmt.Println(str2)

    <span class="hljs-comment">// 3. 字符串拼接</span>
    str3 := <span class="hljs-string">"Hello"</span>
    str4 := <span class="hljs-string">"World"</span>
    str5 := str3 + <span class="hljs-string">" "</span> + str4  <span class="hljs-comment">// 用+拼接</span>
    fmt.Println(str5)  <span class="hljs-comment">// 输出：Hello World</span>

    <span class="hljs-comment">// 4. 字符串长度（按字节计算，UTF-8中中文占3字节）</span>
    fmt.Println(<span class="hljs-built_in">len</span>(str5))        <span class="hljs-comment">// 输出：11（Hello World共11个字节）</span>
    fmt.Println(<span class="hljs-built_in">len</span>(<span class="hljs-string">"你好Go"</span>))     <span class="hljs-comment">// 输出：8（2个中文×3 + 2个字母×1 = 8）</span>
}

</code></pre>
<p><strong>注意</strong>：Go中字符串不可变，若要修改字符串，需先转为[]byte或[]rune切片，修改后再转回string（会创建新字符串），示例：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    str := <span class="hljs-string">"hello"</span>
    <span class="hljs-comment">// 错误：字符串不可变，不能直接修改单个字符</span>
    <span class="hljs-comment">// str[0] = 'H'  // 编译报错：cannot assign to str[0]</span>

    <span class="hljs-comment">// 正确：转为[]byte切片修改</span>
    byteSlice := []<span class="hljs-type">byte</span>(str)
    byteSlice[<span class="hljs-number">0</span>] = <span class="hljs-string">'H'</span>
    newStr := <span class="hljs-type">string</span>(byteSlice)
    fmt.Println(newStr)  <span class="hljs-comment">// 输出：Hello</span>

    <span class="hljs-comment">// 处理中文（用[]rune，避免乱码）</span>
    chineseStr := <span class="hljs-string">"你好"</span>
    runeSlice := []<span class="hljs-type">rune</span>(chineseStr)
    runeSlice[<span class="hljs-number">0</span>] = <span class="hljs-string">'我'</span>
    newChineseStr := <span class="hljs-type">string</span>(runeSlice)
    fmt.Println(newChineseStr)  <span class="hljs-comment">// 输出：我好</span>
}

</code></pre>
<h3 data-id="heading-9">3.3 布尔类型（bool）</h3>
<p>布尔类型只有两个值：<code>true</code>（真）和<code>false</code>（假），占用1个字节，主要用于条件判断。</p>
<p><strong>基本用法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> isPass <span class="hljs-type">bool</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> isFail = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 自动推断为bool类型</span>

    fmt.Println(isPass, isFail)  <span class="hljs-comment">// 输出：true false</span>

    <span class="hljs-comment">// 布尔类型不能参与数值运算（和其他语言不同）</span>
    <span class="hljs-comment">// 错误示例：</span>
    <span class="hljs-comment">// fmt.Println(isPass + 1)  // 编译报错：invalid operation: isPass + 1 (mismatched types bool and int)</span>

    <span class="hljs-comment">// 正确用法：条件判断</span>
    <span class="hljs-keyword">if</span> isPass {
        fmt.Println(<span class="hljs-string">"考试通过"</span>)
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"考试失败"</span>)
    }
}

</code></pre>
<h2 data-id="heading-10">4. 零值机制与类型默认值</h2>
<p>Go有一个很贴心的设计：<strong>任何声明后未赋值的变量，都会被自动赋予对应类型的“零值”</strong>，无需手动初始化。这避免了未初始化变量导致的垃圾值问题，也简化了代码。</p>
<p><strong>各类型零值</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 数值类型零值：0（所有整数、浮点型）</span>
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span>     <span class="hljs-comment">// 0</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">float64</span> <span class="hljs-comment">// 0</span>
    <span class="hljs-keyword">var</span> c <span class="hljs-type">byte</span>    <span class="hljs-comment">// 0</span>

    <span class="hljs-comment">// 字符串类型零值：空字符串（""）</span>
    <span class="hljs-keyword">var</span> d <span class="hljs-type">string</span>  <span class="hljs-comment">// ""</span>

    <span class="hljs-comment">// 布尔类型零值：false</span>
    <span class="hljs-keyword">var</span> e <span class="hljs-type">bool</span>    <span class="hljs-comment">// false</span>

    fmt.Println(a, b, c, d == <span class="hljs-string">""</span>, e)
    <span class="hljs-comment">// 输出：0 0 0 true false</span>
}

</code></pre>
<p><strong>实用场景</strong>：比如定义结构体时，无需逐个初始化字段，未赋值的字段会自动使用零值，简化代码。后续讲结构体时会详细举例。</p>
<h2 data-id="heading-11">5. 类型推断与显式转换</h2>
<p>Go支持类型推断（自动判断变量类型），但不支持隐式类型转换（不同类型不能直接赋值），必须显式转换。</p>
<h3 data-id="heading-12">5.1 类型推断</h3>
<p>当声明变量时不指定类型，Go会根据赋值的值自动推断类型，这是日常开发中常用的方式，能简化代码。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 自动推断为int</span>
    num := <span class="hljs-number">100</span>
    <span class="hljs-comment">// 自动推断为float64</span>
    score := <span class="hljs-number">98.5</span>
    <span class="hljs-comment">// 自动推断为string</span>
    name := <span class="hljs-string">"Gopher"</span>
    <span class="hljs-comment">// 自动推断为bool</span>
    isOk := <span class="hljs-literal">true</span>

    <span class="hljs-comment">// 用fmt.Printf的%T格式符查看变量类型</span>
    fmt.Printf(<span class="hljs-string">"num类型：%T\n"</span>, num)    <span class="hljs-comment">// 输出：num类型：int</span>
    fmt.Printf(<span class="hljs-string">"score类型：%T\n"</span>, score)  <span class="hljs-comment">// 输出：score类型：float64</span>
    fmt.Printf(<span class="hljs-string">"name类型：%T\n"</span>, name)    <span class="hljs-comment">// 输出：name类型：string</span>
    fmt.Printf(<span class="hljs-string">"isOk类型：%T\n"</span>, isOk)    <span class="hljs-comment">// 输出：isOk类型：bool</span>
}

</code></pre>
<h3 data-id="heading-13">5.2 显式类型转换</h3>
<p>Go是强类型语言，不同类型的变量不能直接赋值或运算，必须通过<code>类型(变量)</code>的方式进行显式转换。</p>
<p><strong>基本语法</strong>：<code>目标类型(源变量)</code></p>
<p><strong>正确示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">100</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">float64</span>

    <span class="hljs-comment">// 显式转换：int -&gt; float64</span>
    b = <span class="hljs-type">float64</span>(a)
    fmt.Println(b)  <span class="hljs-comment">// 输出：100</span>

    <span class="hljs-keyword">var</span> c <span class="hljs-type">float64</span> = <span class="hljs-number">3.14</span>
    <span class="hljs-keyword">var</span> d <span class="hljs-type">int</span>

    <span class="hljs-comment">// 显式转换：float64 -&gt; int（会截断小数部分，不是四舍五入）</span>
    d = <span class="hljs-type">int</span>(c)
    fmt.Println(d)  <span class="hljs-comment">// 输出：3</span>

    <span class="hljs-keyword">var</span> e <span class="hljs-type">byte</span> = <span class="hljs-string">'A'</span>
    <span class="hljs-keyword">var</span> f <span class="hljs-type">int</span> = <span class="hljs-type">int</span>(e)
    fmt.Println(f)  <span class="hljs-comment">// 输出：65（ASCII码）</span>
}

</code></pre>
<p><strong>错误示例</strong>（隐式转换）：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">100</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">float64</span>

    <span class="hljs-comment">// 错误：隐式转换不允许</span>
    <span class="hljs-comment">// b = a  // 编译报错：cannot use a (type int) as type float64 in assignment</span>
}

</code></pre>
<p><strong>注意</strong>：显式转换只能在兼容的类型之间进行（比如数值类型之间、byte/rune与int之间），不兼容的类型无法转换（比如int和string）。若要实现int转string，需使用<code>strconv</code>包，示例：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"strconv"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num <span class="hljs-type">int</span> = <span class="hljs-number">123</span>
    <span class="hljs-comment">// int -&gt; string（使用strconv.Itoa）</span>
    str := strconv.Itoa(num)
    fmt.Printf(<span class="hljs-string">"str类型：%T，值：%s\n"</span>, str, str)  <span class="hljs-comment">// 输出：str类型：string，值：123</span>

    <span class="hljs-comment">// string -&gt; int（使用strconv.Atoi）</span>
    str2 := <span class="hljs-string">"456"</span>
    num2, err := strconv.Atoi(str2)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"转换失败："</span>, err)
    } <span class="hljs-keyword">else</span> {
        fmt.Printf(<span class="hljs-string">"num2类型：%T，值：%d\n"</span>, num2, num2)  <span class="hljs-comment">// 输出：num2类型：int，值：456</span>
    }
}

</code></pre>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fstrconv" target="_blank" title="https://pkg.go.dev/strconv" ref="nofollow noopener noreferrer">strconv包官方文档</a></p>
<h2 data-id="heading-14">6. 短变量声明的作用域规则</h2>
<p>作用域是指变量的有效范围，在该范围内变量可以被访问，超出范围则无法访问。短变量声明（:=）的作用域规则和var声明基本一致，但有一些细节需要注意。</p>
<p><strong>核心作用域规则</strong>：</p>
<ol>
<li>
<p>函数内声明的变量（var或:=）：作用域是整个函数，但在代码块（if、for、switch等{}包裹的区域）内声明的变量，作用域仅限于该代码块；</p>
</li>
<li>
<p>短变量声明在代码块内声明时，若与外部变量同名，会“遮蔽”外部变量（即代码块内访问的是内部变量，外部变量不受影响）；</p>
</li>
<li>
<p>全局变量（函数外用var声明）：作用域是整个包，包内所有函数都可访问；短变量声明不能用于全局变量。</p>
</li>
</ol>
<p><strong>示例1：代码块内的作用域</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 函数内变量，作用域覆盖整个main函数</span>
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">10</span>

    <span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> {
        <span class="hljs-comment">// 代码块内用:=声明的变量，作用域仅限于if代码块</span>
        b := <span class="hljs-number">20</span>
        fmt.Println(a, b)  <span class="hljs-comment">// 输出：10 20（可访问a和b）</span>
    }

    fmt.Println(a)  <span class="hljs-comment">// 输出：10（可访问a）</span>
    <span class="hljs-comment">// fmt.Println(b)  // 错误：b未定义（超出作用域）</span>
}

</code></pre>
<p><strong>示例2：变量遮蔽</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    x := <span class="hljs-number">100</span>  <span class="hljs-comment">// 外部变量x</span>

    <span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> {
        x := <span class="hljs-number">200</span>  <span class="hljs-comment">// 内部变量x，遮蔽外部x</span>
        fmt.Println(<span class="hljs-string">"内部x："</span>, x)  <span class="hljs-comment">// 输出：内部x：200（访问内部x）</span>
    }

    fmt.Println(<span class="hljs-string">"外部x："</span>, x)  <span class="hljs-comment">// 输出：外部x：100（外部x未被修改）</span>
}

</code></pre>
<p><strong>示例3：全局变量与局部变量</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 全局变量（var声明），作用域是整个包</span>
<span class="hljs-keyword">var</span> globalVar <span class="hljs-type">string</span> = <span class="hljs-string">"我是全局变量"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(globalVar)  <span class="hljs-comment">// 输出：我是全局变量（可访问全局变量）</span>
    testFunc()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testFunc</span><span class="hljs-params">()</span></span> {
    fmt.Println(globalVar)  <span class="hljs-comment">// 输出：我是全局变量（其他函数也可访问）</span>
}

<span class="hljs-comment">// 错误：全局变量不能用短声明</span>
<span class="hljs-comment">// globalVar2 := "错误示例"  // 编译报错：syntax error: non-declaration statement outside function body</span>

</code></pre>
<h2 data-id="heading-15">7. 命名规范：驼峰与导出规则</h2>
<p>好的命名规范能让代码更易读、易维护，Go社区有明确的命名规范，核心是“驼峰命名”和“首字母大小写控制导出”。</p>
<h3 data-id="heading-16">7.1 驼峰命名规则</h3>
<p>根据变量/函数/常量的名称长度，分为两种驼峰方式：</p>
<ul>
<li>
<p><strong>小驼峰（lowerCamelCase）</strong>：首字母小写，后续单词首字母大写。适用于局部变量、函数内的私有变量/函数；</p>
</li>
<li>
<p><strong>大驼峰（UpperCamelCase）</strong>：首字母大写，后续单词首字母大写。适用于全局变量、函数、结构体、接口等需要导出的标识符。</p>
</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 全局变量（导出，大驼峰）</span>
<span class="hljs-keyword">var</span> UserName <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>

<span class="hljs-comment">// 函数（导出，大驼峰）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 局部变量（私有，小驼峰）</span>
    userAge := <span class="hljs-number">25</span>
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"姓名：%s，年龄：%d"</span>, UserName, userAge)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(GetUserInfo())  <span class="hljs-comment">// 输出：姓名：Gopher，年龄：25</span>
}

</code></pre>
<h3 data-id="heading-17">7.2 导出规则（首字母大小写）</h3>
<p>Go中没有<code>public</code>、<code>private</code>关键字，而是通过标识符的首字母大小写来控制是否“导出”（即是否能被其他包访问）：</p>
<ul>
<li>
<p>首字母大写：可导出，其他包可通过“包名.标识符”访问；</p>
</li>
<li>
<p>首字母小写：不可导出，只能在当前包内访问。</p>
</li>
</ul>
<p><strong>示例（跨包访问）</strong>：</p>
<p>假设有两个包：<code>main</code>包和<code>utils</code>包（目录结构如下）：</p>
<pre><code class="hljs language-text" lang="text">
project/
├── main.go（main包）
└── utils/
    └── tool.go（utils包）

</code></pre>
<ol>
<li>utils/tool.go（utils包）：</li>
</ol>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> utils

<span class="hljs-comment">// 首字母大写，可导出</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetVersion</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"v1.0.0"</span>
}

<span class="hljs-comment">// 首字母小写，不可导出</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getAuthor</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Gopher"</span>
}

</code></pre>
<ol start="2">
<li>main.go（main包）：</li>
</ol>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"project/utils"</span>  <span class="hljs-comment">// 导入utils包（实际路径根据项目模块调整）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 访问utils包的导出函数（首字母大写）</span>
    fmt.Println(utils.GetVersion())  <span class="hljs-comment">// 输出：v1.0.0</span>

    <span class="hljs-comment">// 错误：无法访问不可导出的函数（首字母小写）</span>
    <span class="hljs-comment">// fmt.Println(utils.getAuthor())  // 编译报错：cannot refer to unexported name utils.getAuthor</span>
}

</code></pre>
<p><strong>命名补充规范</strong>：</p>
<ul>
<li>
<p>包名：全小写，简洁明了，不使用下划线（比如<code>utils</code>、<code>net/http</code>）；</p>
</li>
<li>
<p>常量名：若为枚举或全局常量，推荐全大写+下划线（比如<code>MAX_CONN</code>）；若为局部常量，可用小驼峰；</p>
</li>
<li>
<p>避免使用关键字作为标识符（Go的关键字共25个，比如<code>var</code>、<code>func</code>、<code>if</code>等）。</p>
</li>
</ul>
<p>Go关键字参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Keywords" target="_blank" title="https://go.dev/ref/spec#Keywords" ref="nofollow noopener noreferrer">Go官方关键字文档</a></p>
<h2 data-id="heading-18">8. 代码格式化与go fmt工具</h2>
<p>代码格式不统一会严重影响团队协作效率，Go官方提供了<code>go fmt</code>工具，能自动格式化代码，强制统一代码风格，无需手动调整缩进、换行等格式问题。</p>
<h3 data-id="heading-19">8.1 go fmt的核心作用</h3>
<ul>
<li>
<p>自动调整缩进（使用4个空格，不推荐制表符）；</p>
</li>
<li>
<p>自动调整换行（比如函数体{}的位置、import分组的格式）；</p>
</li>
<li>
<p>自动调整空格（比如运算符前后、逗号后加空格）；</p>
</li>
<li>
<p>统一代码风格，避免团队内格式争议。</p>
</li>
</ul>
<h3 data-id="heading-20">8.2 使用方法</h3>
<p><code>go fmt</code>是Go工具链自带的，安装Go后即可使用，支持两种常用方式：</p>
<p><strong>1. 格式化单个文件</strong></p>
<pre><code class="hljs language-bash" lang="bash">
go <span class="hljs-built_in">fmt</span> main.go

</code></pre>
<p>执行后，会直接修改<code>main.go</code>文件的格式，使其符合规范。</p>
<p><strong>2. 格式化整个目录（包括子目录）</strong></p>
<pre><code class="hljs language-bash" lang="bash">
go <span class="hljs-built_in">fmt</span> ./...

</code></pre>
<p><code>./...</code>表示当前目录及其所有子目录，执行后会格式化目录下所有的.go文件。</p>
<h3 data-id="heading-21">8.3 集成到IDE（自动格式化）</h3>
<p>日常开发中，无需手动执行<code>go fmt</code>命令，主流IDE（VS Code、Goland）都支持自动格式化：</p>
<ul>
<li>
<p>VS Code：安装Go插件后，开启“保存时格式化”。设置路径：File -&gt; Preferences -&gt; Settings，搜索“Format On Save”，勾选即可。</p>
</li>
<li>
<p>Goland：默认开启自动格式化，保存文件时会自动调整格式。若需手动触发，可使用快捷键<code>Ctrl+Alt+L</code>（Windows）或<code>Cmd+Opt+L</code>（Mac）。</p>
</li>
</ul>
<h3 data-id="heading-22">8.4 示例：格式化前后对比</h3>
<p><strong>格式化前（不规范）</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
<span class="hljs-keyword">var</span> name <span class="hljs-type">string</span>=<span class="hljs-string">"Gopher"</span>
fmt.Println(name)
}

</code></pre>
<p><strong>执行go fmt后（规范）</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>
    fmt.Println(name)
}

</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>本章我们掌握了Go基础语法的核心——变量、常量与数据类型，重点总结：</p>
<ol>
<li>
<p>变量声明：var适用于全局/需明确类型的场景，短声明（:=）适用于函数内快速声明，注意作用域规则；</p>
</li>
<li>
<p>常量：用const定义，iota能简化枚举定义，支持自动生成连续整数；</p>
</li>
<li>
<p>数据类型：核心是数值、字符串、布尔类型，记住各类型的零值和特性（比如字符串不可变）；</p>
</li>
<li>
<p>类型转换：Go不支持隐式转换，需用显式转换，不兼容类型（int和string）需用strconv包；</p>
</li>
<li>
<p>命名与格式：遵循驼峰命名，首字母大小写控制导出；用go fmt自动格式化代码，统一风格。</p>
</li>
</ol>
<p>这些知识点是后续学习流程控制、函数、结构体等内容的基础，建议多写代码练习，比如用变量和常量实现一个简单的计算器，巩固今天的知识点。如果有任何问题，欢迎在评论区交流～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么面试问得越细的公司反而越容易没下文？]]></title>    <link>https://juejin.cn/post/7597699796200669194</link>    <guid>https://juejin.cn/post/7597699796200669194</guid>    <pubDate>2026-01-22T00:42:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597699796200669194" data-draft-id="7597623392457162803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么面试问得越细的公司反而越容易没下文？"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2026-01-22T00:42:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么面试问得越细的公司反而越容易没下文？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:42:10.000Z" title="Thu Jan 22 2026 00:42:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近看到一个职场社区帖子，说的是面试和 offer 相关的话题，参与讨论的同学非常多。</p>
<p>问题描述差不多是这样：</p>
<blockquote>
<p>“我发现凡是给 offer 的公司，面试时基本不问技术细节，那些问得又多又细的公司，后面基本就没下文了……”</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5151a6c7e114ff799bc32e61b0a88f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647330&amp;x-signature=Dv4fPEiVFKqiRoCpoeuLJZytTD4%3D" alt="" loading="lazy"/></p>
<p>那关于这个问题，不知道大家有没有类似的体验或者经历？</p>
<p>你信心满满地去一家公司，面试官是个看起来技术大拿模样的人，一上来就给你整了个高并发场景下的分布式锁实现，问你 JVM 调优的十八般武艺，甚至还要跟你探讨一下 Linux 内核的源码细节。</p>
<p>你虽然答得满头大汗，但自我感觉还不错，仿佛自己把毕生所学都展示出来了。</p>
<p>但是最后结果呢？客气地送你一句等通知，然后便石沉大海。或者回去等了个三五天、一个星期，最后等来的是一句冰冷的不合适。</p>
<p>而反观另外一些面试经历，你可能就是抱着去溜达一圈的心态去转转的，面试让你感觉像在聊天，聊聊项目，聊聊过往经历，聊聊技术。</p>
<p>你心里还在犯嘀咕，没了？就这？</p>
<p>结果第二天，HR 就打电话过来找你谈薪，然后询问入职时间，速度快得让你怀疑人生。</p>
<p>看到这里，你是不是也挺疑惑，这到底是为什么？</p>
<p>难道某些公司就爱玩反向筛选？还是说问技术细节本身就是一种送客的委婉方式？这背后到底有没有什么可以遵循的逻辑原理可以分析分析。</p>
<p>所以今天咱们也用一篇文章的篇幅来聊一聊这个话题，也欢迎大家分享交流自己的观点和看法。</p>
<hr/>
<p>对于那些问得又细又深，最后却没给 offer 的，往往有这么几种情况。</p>
<p>第一种，也是最现实、最常见的<strong>大环境筛选</strong>。</p>
<p>什么意思呢？</p>
<p>现在的求职大环境大家也知道，岗位有限，候选人太多。HR 和面试官手里攥着一堆 985、211 甚至大厂背景的简历。</p>
<p>简单点说，他们不缺候选人，所以他们有资格挑。</p>
<p>对于中间段位的候选人，也就是我们大多数普通人，他们不需要看你有多优秀，只需要找出你简历里的一个瑕疵，一个技术细节没答上来，或许就有可能会把你刷掉。毕竟对于他们来说，能选择的太多。</p>
<p>其次，还有一个比较现实的问题是，对于<strong>那些问得细的公司，不代表真的招人</strong>。</p>
<p>当一个团队实际并不缺人，或者只是抱着宁缺毋滥的心态在招人时，他们就有资本去挑刺。</p>
<p>这时候面试官常常带着一种找漏洞的心态。他们的问题像一张细密的筛网，目的似乎不是看你有多合适，而是为了证明你哪里不合适。</p>
<p>说实话，这种还是挺恶心的。</p>
<p>第三种，也是最最扎心的一种情况：<strong>你只是他们的「免费咨询顾问」</strong>。</p>
<p>更直白一点说就是在套方案。</p>
<p>现在的行情下，很多公司业务停滞，不怎么招人，但又面临一些棘手的技术难题。</p>
<p>他们打着招聘的旗号，实际上是把市场上优秀的工程师请过来，所谓的面试其实也就是一场免费的头脑风暴。他们会故意引导你去讲你上一家公司的架构设计、服务拆分方案、甚至是具体的排错思路。</p>
<p>整个面试过程你自认为胸有成竹，方案和思路也讲得滔滔不绝，殊不知，人家还另有企图呢。</p>
<p>有一说一，这种是最最恶心的一种情况。</p>
<hr/>
<p>而对于那些问得不多、但 offer 倒是给的挺痛快的公司，通常又是怎么回事呢？</p>
<p>首先，这往往意味着这个公司是**「真·缺人」**呐。</p>
<p>这种公司通常处于一种“生死存亡”或者业务极速扩张的阶段。老板或者团队负责人可能已经被缺人折磨得寝食难安了。</p>
<p>他们的核心诉求非常明确：找个能立刻干活、能立刻上手的人。</p>
<p>这时候，他们不会跟你去扯什么虚头巴脑的设计模式，更不会去考你那些冷门的技术知识。</p>
<p>他们关心的是：你能不能明天就来上班，你能不能把这个烂摊子代码接过去维护，你能不能抗住连续一个月的强度。</p>
<p>在这种极度的需求面前，所谓的技术细节反倒成了次要的。</p>
<p>但是说实话，这种 offer 虽然来得容易，但兄弟记住，<strong>这往往也是把双刃剑</strong>。</p>
<p>因为“真·缺人”的背后，往往意味着技术债巨多、管理混乱，或者是一个谁都不愿意接的坑。</p>
<p>拿到这种 offer，你既可能是一飞冲天的救世主，也有可能是一头扎进泥潭的接盘侠。</p>
<p>当然，还有一种情况，虽然不那么好听，但也必须提一嘴。</p>
<p>那就是，有些公司其实是在广撒网。他们可能并没有确切的 HC，或者他们需要的只是一个廉价的劳动力。</p>
<p>对于这种公司，问太多技术细节反而会吓跑你，他们更希望用更轻松的面试体验和更高薪的承诺来把你招进去，至于技术匹配度嘛，额……那是入职以后的事情了。</p>
<hr/>
<p>文章的最后这里想说的是，面试是一个双向选择的过程，也是一个互相试探的过程。</p>
<p>当你遇到那个问得特别细的面试官时，别急着心里骂娘，也别急着觉得自己没戏了。你可以试着把这场技术拷问变成一场技术交流。</p>
<p>如果对方是在套方案，你可以适当保留，点到为止；如果对方是真的在考察技术深度，那正好展示你的技术功底。</p>
<p>而当你遇到那个聊两句就给 offer 的公司时，也别急着狂喜。</p>
<p>可以<strong>多问问团队现状，问问业务体量，问问技术栈，这时候，一定要记住，你该反问的要反问，该考察的要考察</strong>。</p>
<p>因为虽说大环境寒冷，但是我觉得<strong>找到一个不坑的公司有时候比拿到一个所谓的 offer 更加重要</strong>，大家觉得呢？</p>
<p>好了，今天就先聊这么多吧，希望能对大家有所启发，我们下篇见。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年终总结：我承认人生已经不允许事事求全]]></title>    <link>https://juejin.cn/post/7597635202325463092</link>    <guid>https://juejin.cn/post/7597635202325463092</guid>    <pubDate>2026-01-22T00:54:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202325463092" data-draft-id="7597650322408554548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年终总结：我承认人生已经不允许事事求全"/> <meta itemprop="keywords" content="后端,前端,程序员"/> <meta itemprop="datePublished" content="2026-01-22T00:54:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东东拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/3808364011728392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年终总结：我承认人生已经不允许事事求全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364011728392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东东拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:54:45.000Z" title="Thu Jan 22 2026 00:54:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">世界变了：从单线程到多线程</h3>
<p>年轻时的世界，似乎总是单线程的。</p>
<p>高中时拼成绩，大学时想出路，毕业后拼事业，一直以来心无旁骛，一路狂奔。</p>
<p>我30岁的这一年才意识到：</p>
<p><strong>单线程人生已经结束，用意志力硬扛，就会被现实打脸。</strong></p>
<p>2025年，家庭责任、职业发展和自我要求，突然就像三只手一样，把我往不同方向拉扯。</p>
<h2 data-id="heading-1">和现实硬刚</h2>
<p>下午四点，我正准备赶一赶时间紧的需求。这时候同事走到我工位旁边，诚恳的请我帮他看个bug。</p>
<p>给同事解决了问题，刚准备写代码。微信弹出领导消息：有一个紧急的事情需要处理，明天早上之前就得完成。</p>
<p>我挠挠头，到下班时间还没弄完，自己的事情还没干，便决定晚上加会班。</p>
<p>代码还没写几行，收到家里人的消息：孩子肚子不舒服，让我早点回家照顾孩子。</p>
<p>我急匆匆地回家，确认孩子没什么事，才终于放宽心。</p>
<p><strong>一天下来，想看的书没有看，想写的东西还没时间动笔，甚至工作上的事情都来不及处理完。</strong></p>
<p>我记不清楚这样的情形出现了多少次，时常感觉自己就像一个陀螺，被各种各样的小鞭子抽的停不下来。</p>
<p>起初我并不服气，我总觉得是自己哪里没做好。</p>
<p>是不是效率太低？是不是时间管理出了问题？要不然，为什么总是顾此失彼？</p>
<p>我一直很相信一件事：<strong>只要意志力足够强，就能够解决眼前的问题。</strong></p>
<p>于是在今年很长一段时间里，都给自己设定了一个几乎完美的目标：</p>
<p>家庭要顾好，工作要推进，自我也不能放弃。</p>
<p>白天要高效，晚上要陪伴，深夜还要留给读书和写作。</p>
<p>只要再自律一点，再咬咬牙，也许就能同时把三件事都做好。</p>
<p>我开始想尽办法挤出时间，先逼着自己早起，后来开始熬夜，可最后整个人的精神状态越来越差，以至于白天都变得浑浑噩噩。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9ccf0e5dacb478fb40c5b8c18663e74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769648085&amp;x-signature=T8i2g0BEBP6A%2FxO8feWbMtKzGjE%3D" alt="photo-1758520145147-c30bc656f314.jpeg" loading="lazy"/>
<strong>时间被切得粉碎，精力被反复抽干，情绪在责任之间来回拉扯。</strong></p>
<p>我试图用单线程时代的自律，去解决人生多线程阶段的难题，很遗憾，并不成功。</p>
<h2 data-id="heading-2">崩溃与觉察</h2>
<p>在这种情况下，我察觉到自己陷入到了一种平庸的生活状态。</p>
<p>我精力开始变差，比如注意力无法集中，内心开始变得浮躁。进而开始追求高频刺激、令人愉快的信息，比如短视频，然后陷入恶性循环。</p>
<p>一直以来我都在B站上给《食贫道》充电，为了看他每个月都会更新一个2个小时左右的充电视频。</p>
<p>25年下半年，《食贫道》再更新视频，我发现自己看一段就看不下去了，后来直接不再关注更新的长视频。</p>
<p>相比之下，我更愿意打开抖音，刷十几个短视频。</p>
<p>它们不需要投入，不需要进入状态，也不需要承担任何心理成本。</p>
<p>慢慢地，我发现自己不再记录想法，写作的速度越来越慢，公众号的更新频率越来越低。</p>
<p>2025年初，我写了一篇文章《摆脱平庸的地心引力》，我那时候就意识到，平庸是一种地心引力，所以在那时候就告诉自己要引以为戒，不要垮掉这根弦。</p>
<p>这种变化并不是某一次彻底崩溃，它更像是一种不易察觉的缓慢下沉。</p>
<p>当我意识到自己的变化后，我开始反复追问原因。</p>
<p>那段时间，我几乎把所有常见的解释都过了一遍：</p>
<p>自控力、方向选择、家庭消耗、方法问题。</p>
<p>但没有一个，真正对得上当下的感受。</p>
<p>后来我才慢慢意识到，那段时间我所有的努力，其实都在做同一件事——</p>
<p><strong>试图用意志力和方式方法，去解决人生已经发生结构性变化的问题。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e26ae7367e846edb1fdab08d9778e72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769648085&amp;x-signature=%2Bgo4fmMFPgpuAC4Iftf9EIaXTjY%3D" alt="Weekly_Desk_Planner_2.webp" loading="lazy"/></p>
<h2 data-id="heading-3">认识阶段性变化</h2>
<p>元旦时，我和朋友爬了一座不高的山，却中途停了好几次。</p>
<p>大学时夜爬泰山、第二天照常上课的体力，已经不在了。</p>
<p>工作之后体力在下滑，锻炼时间也少了，30岁的身体怎么能和20多岁的时候比呢？我们很容易就接受了这一点。</p>
<p>但当一个人的身份、责任发生变化时，内心却会不自觉地开始抗拒。</p>
<p><strong>身上的责任变重了，很多人却迟迟不肯完成心理上的“成年”。</strong></p>
<p>很多人会发现，自己在某些地方，仍然停留在更早的阶段：</p>
<p>面对问题，希望有人替自己兜底；</p>
<p>面对家庭，更愿意享受情感，而不是承担重量；</p>
<p>面对现实选择，反复在心里推翻已经发生的人生。</p>
<p><strong>很多时候，我们不是不懂现实，而是不愿为“现在的自己”负责。</strong></p>
<p>更可怕的是，我们会下意识的用“如果当初”来解释当下，通常会带来三个结果：</p>
<p>否定当下人生的正当性</p>
<p>把疲惫归因到不可改变的过去</p>
<p>在内心形成一种长期的、无解的悔恨</p>
<p>这种状态本身，才是精力流失最大的来源。</p>
<h3 data-id="heading-4">一个允许和两个方案</h3>
<p>当我终于承认人生阶段发生变化，一个更现实的问题摆在了我面前：那我应该怎么做呢？</p>
<p>答案不是拼命，也不是躺平，我的答案是一个允许和三个方案。</p>
<h4 data-id="heading-5">一个允许：允许结构性失衡</h4>
<p>首先我允许自己阶段性失衡。</p>
<p>你把重心放在家庭，工作没有做出什么成绩，可当别人在加班时，你和孩子在公园里玩耍；</p>
<p>也许你把重心你放在事业上，暂时没有选择成家，可短短几年收入已经远远超过了身边的同龄人；</p>
<p>又或者你选择照顾好自己，放下了工作和家庭，但却走遍世界，体验到人生的乐趣。</p>
<p>失衡并不等于失败，它只是意味着——</p>
<p><strong>在某一个阶段，你不可能让所有事情同时满分运转。</strong></p>
<p>拿铁出生的这三年，我几乎全部精力都在他身上，看着他从一丁点长到快1米，我时常感叹生命的奇妙。</p>
<p>可回头看看这三年的工作，职场上没有做出什么成绩，技术上也没再有什么精进。</p>
<p><strong>你可以在某一件事情上求全，但不能在所有事情上求全。</strong></p>
<p>一旦你允许了阶段性失衡，很多内耗会自然消失。</p>
<p>你不再要求自己同时做到所有事情，也不再因为“顾此失彼”而自责。</p>
<p>你开始清楚地知道：这是我此刻，主动选择的重心。</p>
<p><strong>这里更高一点的要求是，是不要为自己的选择后悔。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0595c2a92684c23b483ed578b1e980e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769648085&amp;x-signature=%2B7x%2F%2FGKKjeeYMfE9URk8Oljgk94%3D" alt="7e149-l8ee4.png" loading="lazy"/></p>
<h4 data-id="heading-6">拯救精力</h4>
<p>我们最大的问题，从来不是时间不够，而是精力在无意识中不断流失。</p>
<p>就在我状态不好的那一段时间，我会把“刷短视频”当成放松，可它恰恰是最典型的精力漏点。</p>
<p>你可能只刷了十分钟，却已经把大脑当天最敏感、最专注的那一部分消耗掉了。</p>
<p>更隐蔽的问题在于——短视频并不是偶尔的娱乐，而是正在变成一种默认行为。</p>
<p>什么叫默认行为？</p>
<p>不是你累了想放松下的时候刷短视频，而是：</p>
<ul>
<li>等电梯的几十秒</li>
<li>取外卖的路上</li>
<li>上厕所的几分钟</li>
<li>午休发呆的空档</li>
</ul>
<p>手会不自觉地伸向手机，点开短视频。</p>
<p>这类内容几乎不需要进入状态，不需要思考，不需要承担任何心理成本，却能立刻给你反馈、情绪和刺激。</p>
<p>它们持续抬高大脑的刺激阈值，缩短反馈延迟。</p>
<p>一旦你适应了这种节奏——</p>
<p>需要专注、需要沉浸、需要耐心的“慢内容”，自然就会显得乏味、费力，甚至让人抗拒。</p>
<p>简单来说就是，不干正事了。</p>
<p>我们并不一定要“彻底戒掉短视频”，而是不能让它成为你生活中的默认选项。</p>
<h4 data-id="heading-7">降低启动成本</h4>
<p>前两年，我对“写作”的仪式感很重。</p>
<p>只要有我特别感兴趣的选题，恨不得放下所有事，一整天的时间都铺在上面。</p>
<p>如果因为一丁点的事情打断思路，我就感觉思路断了，灵感消失，非常懊恼。</p>
<p>可孩子还没上幼儿园，父母对他而言是为数不多的玩伴，我放不下对他的陪伴；工作上事情烦杂，AI来势汹汹，也不得不用更多的精力应对。总之，对于多重身份的要求，我必须学会多线程的工作方式。</p>
<p>我开始刻意降低写作的启动成本，不再要求一次写完一篇文章。</p>
<p>而是允许自己只写一段话，甚至只是记录一个念头。</p>
<p>而现在，我是刷完奶瓶，坐在沙发上用手机随手写下的这一段内容。</p>
<p>虽然不完整，也不够正式，但它是真实可持续的。</p>
<p><strong>在这个阶段，决定能否持续的，从来不是自控力，而是结构设计。</strong></p>
<p>当我把写作设计成“必须高度专注才能开始”的事情，它注定会被生活挤到最后。</p>
<p>而当我把写作拆解成随时可以启动的最小动作，我就重新掌握了主动权。</p>
<h4 data-id="heading-8">别让目标成为精神负担</h4>
<p>过去很长一段时间，我对“目标”是有一些执念的。</p>
<p>写作上希望自己能够涨粉，工作上希望自己能紧跟AI潮流，家庭上更要给孩子高质量的陪伴。</p>
<p>希望自己越来越好总是没错的，可现在人生结构发生改变。当孩子成为长期、不可外包、不可中断的投入对象时，我能够调动的时间、精力和情绪带宽，本身就被重新分配了。</p>
<p><strong>关于目标的定义自然也得跟着变化。</strong></p>
<p>在这样的结构下，我在自媒体上如涨粉、爆款、变现的目标，看起来虽然成立，但实际上已经不可持续了。</p>
<p>之前我把这种目标扛在身上，本质上是在用意志力，对抗一个已经改变了的现实结构。</p>
<p><strong>还是之前的那句话，试图用意志力和方式方法，去解决人生已经发生结构性变化的问题。</strong></p>
<p>于是我开始重新定义“目标”。</p>
<p>我不再问自己：“我最终要成为什么？”</p>
<p>摆在我面前更现实的问题是：</p>
<p>在这个阶段，什么样的目标，能让我不跑偏、不内耗，还能持续积累？</p>
<p>我逐渐意识到：</p>
<p><strong>真正适合这个阶段的目标，应该是一组可以长期运行的约束条件。</strong></p>
<p>比如：</p>
<ul>
<li>保持对 AI 和技术变化的持续输入与实践</li>
<li>用写作作为思考工具，而不是变现工具</li>
<li>为自己保留一块低启动成本的表达空间</li>
</ul>
<p>这些看起来不像目标，更像规则。</p>
<p>但正是这些规则，让我在混乱中，重新有了锚点。</p>
<p>在多线程人生阶段，目标的作用不一定是激励，而是能够稳住自己的状态。</p>
<p>你不一定非得要跑的很“快”，而是确保你不会偏离真正重要的方向。</p>
<h2 data-id="heading-9">说在最后</h2>
<p>过去我一直以为，只要足够自律，人生就能被安排得井井有条。</p>
<p>现在我不这么想了。</p>
<p>当人生进入多线程阶段之后，再用单线程时代的自律去要求自己，只会不断失败。</p>
<p>也许真正成熟的标志，不是把所有事情都抓在手里，</p>
<p>而是终于承认——</p>
<p>在这个阶段，有些事情，本来就不可能同时完成。</p>
<p>我还在适应这种变化，也没有所有答案。</p>
<p>但至少，我不再和现实硬刚了。</p>
<p>这是东东拿铁的第96篇原创文章，欢迎关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂强化学习]]></title>    <link>https://juejin.cn/post/7597693638923173951</link>    <guid>https://juejin.cn/post/7597693638923173951</guid>    <pubDate>2026-01-21T15:10:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597693638923173951" data-draft-id="7597653098564091958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂强化学习"/> <meta itemprop="keywords" content="架构,Trae,AI编程"/> <meta itemprop="datePublished" content="2026-01-21T15:10:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不惑_"/> <meta itemprop="url" content="https://juejin.cn/user/1471609400466218"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂强化学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1471609400466218/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不惑_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:10:51.000Z" title="Wed Jan 21 2026 15:10:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从一个小故事说起</h2>
<p>你还记得小时候学骑自行车吗？</p>
<p>没有人一上来就会骑。刚开始的时候，你歪歪扭扭地扶着车把，脚踩上踏板，车子晃了两下——砰，摔了。膝盖破了皮，疼得龇牙咧嘴。</p>
<p>但你爬起来，又试了一次。这回你发现，身体稍微往左倾的时候，车把往右打一点，好像能稳住。于是你又骑了几米远，然后——又摔了。</p>
<p>就这样摔了无数次之后，突然有一天，你发现自己居然能骑着车满院子跑了。那种感觉特别神奇，你也说不清楚具体是怎么学会的，但就是会了。</p>
<p>这个过程，其实就藏着强化学习最核心的秘密。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/941821d4a9e542d6800156a3563d7b69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=tejvOnmgtFF1gnLLrMoq8bw49M0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">那到底啥是强化学习？</h2>
<p>咱们先别急着下定义，继续聊骑自行车这事儿。</p>
<p>你想想，学骑车的时候，有没有人给你一本《自行车骑行标准教程》，上面写着左腿发力系数0.7，右手握把角度32度？肯定没有吧。</p>
<p>你是怎么学会的呢？靠的是两样东西：<strong>摔跤带来的惩罚，和稳住车子时那种奖励感</strong>。</p>
<p>摔了，疼，大脑自动记住：刚才那个动作不太对，下次别这么干了。</p>
<p>稳住了，爽，大脑又记住：这个感觉不错，下次还这么来。</p>
<p>一次又一次，你的大脑就在这种试错—反馈—调整的循环里，慢慢摸索出了骑车的诀窍。</p>
<p><strong>强化学习，说白了，就是让机器用同样的方式学东西。</strong></p>
<p>不是给它一堆标准答案让它死记硬背，而是把它扔到一个环境里，让它自己去试。做对了，给点甜头；做错了，给点苦头。然后它就在这个过程中，慢慢变聪明。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96da1a9e5024483799b78a5f189a4722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=6kr8nXJhAjtikT81bz8N7LVmN%2Bk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">和你熟悉的学习有啥不一样？</h2>
<p>说到这儿，你可能会想：机器学习不就是教机器学东西吗？这有啥特别的？</p>
<p>别急，咱们对比一下你就明白了。</p>
<p>想象你要教一个小朋友认猫和狗。传统的方式是怎么做的呢？你拿出一堆照片，指着说：这是猫，这是狗，这是猫，这也是狗……反复给他看，看多了他就记住了。这叫<strong>监督学习</strong>，特点是你得提前准备好所有的标准答案。</p>
<p>但问题来了：如果你要教的不是认图片，而是下围棋呢？</p>
<p>围棋有多少种可能的局面？据说比宇宙中的原子还多。你不可能把每一步的标准答案都写出来教给机器，因为你自己都不知道答案是什么。</p>
<p>这时候，强化学习就派上用场了。</p>
<p>你不用告诉机器每一步该怎么下，你只需要告诉它一件事：赢了有奖励，输了没奖励。然后让它自己去下棋，下个几百万盘、几千万盘。慢慢地，它就能摸索出怎么下才能赢。</p>
<p>你看出区别了吗？</p>
<p>监督学习像是照着答案抄作业，强化学习像是自己琢磨怎么考高分。前者需要有人告诉你对错，后者只需要知道最终结果好不好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a12a1a46bff749ee8389eeca43e4ea1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=QSrsWm98MKF2ubx62dBeOTCrOb4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">拆解一下：强化学习里都有些啥？</h2>
<p>好，现在咱们来拆解一下强化学习这个事儿，看看里面都有些什么零件。</p>
<p>放心，不会很复杂，我还是拿生活中的例子来说。</p>
<p><strong>第一个零件：智能体（Agent）</strong></p>
<p>这就是那个学习者。可以是一个机器人，可以是一个游戏里的角色，也可以是你家那只学握手的狗。在骑自行车的例子里，这个智能体就是你自己。</p>
<p><strong>第二个零件：环境（Environment）</strong></p>
<p>智能体待的那个世界。对于骑车的你来说，环境就是那条路、那辆车、还有地球引力。对于下棋的AI来说，环境就是棋盘和对手。</p>
<p><strong>第三个零件：状态（State）</strong></p>
<p>智能体在某一刻的处境。比如你骑车骑到一半，车子开始往左歪——这就是一个状态。再比如下围棋下到第50手，棋盘上黑白子分布的样子，也是一个状态。</p>
<p><strong>第四个零件：动作（Action）</strong></p>
<p>智能体能做的选择。车子往左歪了，你可以选择把车把往右打，也可以选择用脚撑地，还可以选择放弃治疗直接跳车——这些都是动作。</p>
<p><strong>第五个零件：奖励（Reward）</strong></p>
<p>这是最关键的东西。智能体做了一个动作之后，环境会给它一个反馈。这个反馈可能是正的（奖励），也可能是负的（惩罚）。</p>
<p>你稳住了车子，心里那种耶，我可以的感觉，就是奖励。
你摔了个狗啃泥，膝盖火辣辣的疼，就是惩罚。</p>
<p>整个强化学习的核心逻辑，就是智能体通过不断尝试，慢慢搞清楚：<strong>在什么状态下，做什么动作，能拿到最多的奖励</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/844636e8ec7f48f6ba7d0d9099224fc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=iojhslkkTdbjTv4PnVGWmSasbCg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">生活中到处都是强化学习</h2>
<p>其实你仔细想想，强化学习这种模式，咱们每天都在用。</p>
<p><strong>养孩子不就是这样吗？</strong></p>
<p>小朋友吃饭把碗端稳了，你夸一句真棒，他就知道这样做是对的。他把饭撒了一地，你皱个眉头，他就知道下次得小心点。你不可能把如何吃饭的每个细节都教给他，但通过一次次的正向反馈和负向反馈，他就慢慢学会了。</p>
<p><strong>训练宠物也是这个道理。</strong></p>
<p>你让狗狗坐下，它坐了，你给它一块小饼干。它没坐，你就不给。反复几次之后，它就知道坐下这个口令对应的动作是什么了。你又没法跟狗狗用语言解释坐下是什么意思，但通过奖励机制，它就是能学会。</p>
<p><strong>再想想你自己打游戏的过程。</strong></p>
<p>玩一个新游戏，刚开始你根本不知道怎么玩。但你会瞎按几个键，看看有什么反应。打死一个小怪，掉了金币，哦，这样可以；撞上一个陷阱，掉血了，这个地方要躲着走。没人教你，你就是在这种试错中越玩越溜。</p>
<p>说到底，强化学习不是什么高深莫测的概念，它其实是对经验学习这种人类（甚至动物）最本能的学习方式的一种模拟。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/089c58faa6294de599dcfb47e7cffc64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=eXED7MfkjVi6HWDuFVFcq6jSPR8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">那为什么强化学习这么重要？</h2>
<p>聊到这儿，你可能会问：既然这个原理这么简单，为什么最近这些年强化学习突然变得这么火？</p>
<p>这就得说到几个让人印象深刻的名场面了。</p>
<p>2016年，谷歌的AlphaGo对战围棋世界冠军李世石，4比1取胜。这场比赛当时轰动全球，因为围棋一直被认为是人类智慧的巅峰游戏，规则看似简单，变化却无穷无尽。很多人觉得机器要下好围棋，至少还得等个几十年。结果，AlphaGo就这么横空出世了。</p>
<p>而AlphaGo背后的核心技术之一，就是强化学习。</p>
<p>它是怎么变强的呢？简单说，就是自己和自己下棋，下了几千万盘，在赢了加分、输了扣分的反馈中，不断优化自己的下棋策略。没有人类老师手把手教它每一步怎么走，它就是在试错—反馈—调整的循环里，从一个菜鸟变成了超越人类的棋手。</p>
<p>这事儿为什么意义重大？</p>
<p>因为它证明了一件事：<strong>对于那些连人类自己都说不清楚怎么做才是最优解的复杂问题，机器可以通过强化学习自己找到答案。</strong></p>
<p>这个能力太厉害了。</p>
<p>你想想看，生活中有多少问题是这种类型的：</p>
<ul>
<li>开车的时候，在复杂的交通环境下怎么做决策？</li>
<li>在股票市场里，什么时候买入什么时候卖出？</li>
<li>机器人在工厂里，怎么规划路线才能效率最高？</li>
<li>给用户推荐视频，推什么才能让他看得最开心？</li>
</ul>
<p>这些问题的共同特点是：没有标准答案，只有好和不好的结果。而强化学习，恰恰就是解决这类问题的利器。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c13d46f48ef94504b3cc90078fbeba58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=ZwZNMEdwQDu6QCQGMW5M12hJn%2Bs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">强化学习的难处：不是那么容易的</h2>
<p>当然了，强化学习听起来很美，但实际操作起来，有不少坑。</p>
<p><strong>第一个难题：奖励怎么设计？</strong></p>
<p>你可能觉得这不是很简单吗？赢了给奖励，输了给惩罚呗。</p>
<p>但实际上，奖励设计是一门艺术。</p>
<p>举个例子，你想训练一个机器人去房间里找东西。你设计的奖励是找到东西给10分。结果你发现，机器人在房间里转了半天，什么也不干。为啥？因为它还没摸清楚怎么才能找到东西，而且乱动可能会撞墙扣分，干脆不动最安全。</p>
<p>你得想办法给它一些中间奖励，比如靠近目标加1分，这样它才有动力往前探索。但这个中间奖励设计不好，又可能把机器人带偏。</p>
<p>所以说，怎么设计奖励让机器人真的往你想要的方向学习，是个技术活。</p>
<p><strong>第二个难题：探索和利用的矛盾。</strong></p>
<p>这个说起来有点绕，我举个接地气的例子。</p>
<p>假设你来到一个新城市，想找好吃的。你发现一家店味道还不错，那你接下来该怎么办？</p>
<p>如果你每天都去这家店吃，确实能保证不踩雷，但你可能错过更好吃的店。这叫利用——用你已有的经验。</p>
<p>如果你每天换一家新店尝试，可能会发现宝藏，但也可能踩雷踩到怀疑人生。这叫探索——去尝试你不了解的东西。</p>
<p>强化学习也面临同样的问题。智能体是应该坚持用已经知道的还不错的策略，还是冒险尝试新的动作，看看有没有更好的可能？</p>
<p>这个平衡很难把握。太保守了，可能学不到最优解；太激进了，可能一直在瞎试，浪费时间。</p>
<p><strong>第三个难题：有些奖励来得太慢了。</strong></p>
<p>还是拿下围棋来说。你下一步棋，要到很多步之后才知道这步棋是好是坏。甚至要到整盘棋结束，才知道最终是赢是输。</p>
<p>这种延迟奖励对强化学习来说是个大麻烦。因为智能体很难搞清楚，最后的输赢到底是因为哪一步走得好或者走得臭。这叫信用分配问题，是强化学习里一个很头疼的事情。</p>
<h2 data-id="heading-7">强化学习现在能干啥？</h2>
<p>虽然有这些难题，但强化学习这些年已经在很多领域大显身手了。</p>
<p><strong>游戏领域</strong>就不用说了，除了围棋，星际争霸、Dota2这些复杂的即时战略游戏，AI也已经能打赢职业选手了。</p>
<p><strong>自动驾驶</strong>领域，强化学习帮助汽车学会在复杂的路况下做决策：什么时候加速、什么时候刹车、什么时候变道。</p>
<p><strong>机器人控制</strong>方面，强化学习让机器人学会了走路、跳跃、翻跟头这些复杂动作，而不需要工程师去设计每一个关节该怎么转。</p>
<p><strong>推荐系统</strong>里，强化学习帮助平台学会怎么给你推视频、推商品，让你看得更爽、买得更多。</p>
<p><strong>甚至在科学研究</strong>中，强化学习也开始发挥作用。比如控制核聚变反应堆里的等离子体，这是人类专家都很难搞定的问题，但强化学习算法居然学会了怎么做。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca4197fc8c6b409c8dbe109f9c9241eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769613050&amp;x-signature=KBRbmWumyf3w9nZIV5qFp%2BkCxGE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">说到最后</h2>
<p>好了，说了这么多，咱们来简单总结一下。</p>
<p>强化学习，本质上就是让机器像小孩子一样，通过试错—反馈—调整的过程来学习。它不需要有人告诉每一步该怎么做，只需要有一个做得好给糖吃、做得不好打屁股的反馈机制，机器就能自己慢慢变聪明。</p>
<p>这种学习方式特别适合那些人类自己都说不清楚怎么做才是最好的复杂问题。</p>
<p>当然，强化学习也有它的难处，比如奖励怎么设计、探索和利用怎么平衡、延迟奖励怎么处理。但随着技术的发展，这些问题正在被一步步攻克。</p>
<p>下次你看到新闻里说什么AI又在某个游戏里碾压人类了，或者机器人又学会了什么高难度动作，你就可以会心一笑：这背后说不定又是强化学习在发威呢。</p>
<p>而如果你再往深处想想，其实我们每个人，每天都在用强化学习的方式生活着——在一次次的选择和反馈中，慢慢学会怎么应对这个世界。</p>
<p>只不过，机器学得更快、更不怕摔而已。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 线程局部存储：threading.local() 完全指南]]></title>    <link>https://juejin.cn/post/7597664149170241578</link>    <guid>https://juejin.cn/post/7597664149170241578</guid>    <pubDate>2026-01-21T15:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597664149170241578" data-draft-id="7597679732364541994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 线程局部存储：threading.local() 完全指南"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-21T15:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 线程局部存储：threading.local() 完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:34:11.000Z" title="Wed Jan 21 2026 15:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一句话总结：<br/>
<code>threading.local()</code> 是 Python 标准库提供的「线程局部存储（Thread Local Storage, TLS）」方案，让<strong>同一段代码在不同线程里拥有各自独立的变量空间</strong>，从而避免加锁，也避免了层层传参的狼狈。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 为什么需要线程局部存储？</h2>
<p>在多线程环境下，如果多个线程共享同一个全局变量，就必须：</p>
<ol>
<li>加锁 → 代码变复杂、性能下降；</li>
<li>或者层层传参 → 代码臃肿、可维护性差。</li>
</ol>
<p>有些场景<strong>只想让线程各自持有一份副本</strong>，互不干扰：</p>
<ul>
<li>Web 服务：每个请求线程绑定自己的 <code>user_id</code>、<code>db_conn</code>；</li>
<li>日志：打印线程名 + 请求 ID，方便链路追踪；</li>
<li>数据库连接池：线程复用连接，但连接本身不跨线程传递。</li>
</ul>
<p>这时 TLS 就是最优解。</p>
<hr/>
<h2 data-id="heading-1">2. threading.local() 是什么？</h2>
<p><code>threading.local()</code> 返回一个「魔法对象」：<br/>
<strong>对它的属性赋值，只会在当前线程可见</strong>；其它线程看不到、改不到。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading

tls = threading.local()   <span class="hljs-comment"># 1. 创建 TLS 对象</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">idx</span>):
    tls.value = idx       <span class="hljs-comment"># 2. 各线程写自己的值</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Thread <span class="hljs-subst">{idx}</span> sees <span class="hljs-subst">{tls.value}</span>'</span>)

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    threading.Thread(target=worker, args=(i,)).start()
</code></pre>
<p>输出（顺序可能不同）：</p>
<pre><code class="hljs">Thread 0 sees 0
Thread 4 sees 4
Thread 1 sees 1
Thread 2 sees 2
Thread 3 sees 3
</code></pre>
<p>没有锁，也没有传参，却做到了线程间隔离。</p>
<hr/>
<h2 data-id="heading-2">3. 内部原理：绿盒子里的字典</h2>
<p>CPython 实现里，每个线程对象（<code>threading.Thread</code> 的底层 <code>PyThreadState</code>）都维护一个<strong>私有字典</strong>。<br/>
<code>tls.xxx = value</code> 的本质是：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码</span>
current_thread_dict[<span class="hljs-built_in">id</span>(tls)][<span class="hljs-string">'xxx'</span>] = value
</code></pre>
<p><code>id(tls)</code> 作为 key 保证不同 <code>local()</code> 实例之间互不干扰；<br/>
当前线程字典保证线程之间互不干扰。</p>
<hr/>
<h2 data-id="heading-3">4. 实战 1：Flask/Django 风格的请求上下文</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time

_ctx = threading.local()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">api_handler</span>(<span class="hljs-params">request_id</span>):
    _ctx.request_id = request_id
    business_logic()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">business_logic</span>():
    <span class="hljs-comment"># 任意深处都能拿到 request_id，而不用层层传参</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Handling <span class="hljs-subst">{threading.current_thread().name}</span>  req=<span class="hljs-subst">{_ctx.request_id}</span>'</span>)
    time.sleep(<span class="hljs-number">0.1</span>)

<span class="hljs-keyword">for</span> rid <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    threading.Thread(target=api_handler, args=(rid,), name=<span class="hljs-string">f'T<span class="hljs-subst">{rid}</span>'</span>).start()
</code></pre>
<hr/>
<h2 data-id="heading-4">5. 实战 2：线程安全的数据库连接</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3, threading

db_local = threading.local()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_conn</span>():
    <span class="hljs-string">"""每个线程首次调用时创建连接，后续复用"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(db_local, <span class="hljs-string">'conn'</span>):
        db_local.conn = sqlite3.connect(<span class="hljs-string">':memory:'</span>)
    <span class="hljs-keyword">return</span> db_local.conn

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>():
    conn = get_conn()
    conn.execute(<span class="hljs-string">'create table if not exists t(x)'</span>)
    conn.execute(<span class="hljs-string">'insert into t values (1)'</span>)
    conn.commit()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'<span class="hljs-subst">{threading.current_thread().name}</span>  inserted'</span>)

threads = [threading.Thread(target=worker) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
<span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads: t.start()
<span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads: t.join()
</code></pre>
<hr/>
<h2 data-id="heading-5">6. 常见坑 &amp; 注意事项</h2>

























<table><thead><tr><th>坑点</th><th>说明</th></tr></thead><tbody><tr><td>线程池/协程混用</td><td><code>threading.local</code> 只在<strong>原生线程</strong>隔离，协程或线程池复用线程时会出现「数据串台」。Python 3.7+ 请优先用 <code>contextvars</code>。</td></tr><tr><td>不能跨线程传递</td><td>子线程无法访问父线程设置的值；需要显式传参或队列。</td></tr><tr><td>内存泄漏</td><td>线程结束但 TLS 里的对象若循环引用，可能延迟释放。建议在线程收尾手动 <code>del tls.xxx</code>。</td></tr><tr><td>继承失效</td><td>自定义 <code>Thread</code> 子类时，别忘了调用 <code>super().__init__()</code>，否则 TLS 初始化会异常。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">7. 与 contextvars 的对比（Python 3.7+）</h2>



































<table><thead><tr><th>特性</th><th>threading.local</th><th>contextvars</th></tr></thead><tbody><tr><td>隔离粒度</td><td>线程</td><td>协程/线程（Task level）</td></tr><tr><td>是否支持 async</td><td>❌</td><td>✅</td></tr><tr><td>是否支持默认值</td><td>❌</td><td>✅（<code>ContextVar(default=...)</code>）</td></tr><tr><td>性能</td><td>原生 C 实现，快</td><td>稍慢，但可接受</td></tr><tr><td>兼容性</td><td>2.x 就有</td><td>3.7+</td></tr></tbody></table>
<p>结论：</p>
<ul>
<li>只用<strong>原生线程</strong> → <code>threading.local</code> 足够；</li>
<li>用 <code>asyncio</code>、线程池、<code>concurrent.futures</code> → 请迁移到 <code>contextvars</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-7">8. 小结速记</h2>
<ol>
<li><code>tls = threading.local(); tls.x = 1</code> 只在当前线程生效。</li>
<li>底层是线程私有的 dict，绿色安全。</li>
<li>适合请求上下文、数据库连接、日志追踪等「线程级」场景。</li>
<li>协程 / 线程池环境请换 <code>contextvars</code>，避免踩坑。</li>
</ol>
<hr/>
<h2 data-id="heading-8">9. 一键运行 demo</h2>
<p>把下面代码保存为 <code>tls_demo.py</code>，<code>python tls_demo.py</code> 即可验证：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading, random, time

local = threading.local()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>():
    local.val = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)
    time.sleep(<span class="hljs-number">0.1</span>)
    <span class="hljs-keyword">assert</span> local.val == threading.local().val, <span class="hljs-string">"Should never fail!"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'<span class="hljs-subst">{threading.current_thread().name}</span>  val=<span class="hljs-subst">{local.val}</span>'</span>)

<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    threading.Thread(target=job).start()
</code></pre>
<hr/>
<p>如果本文帮你理清了「线程局部存储」的概念，记得点个赞哦～<br/>
更多 Python 并发技巧，欢迎关注专栏！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂机器学习中的数据划分与验证方法！]]></title>    <link>https://juejin.cn/post/7597623392456867891</link>    <guid>https://juejin.cn/post/7597623392456867891</guid>    <pubDate>2026-01-21T15:29:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623392456867891" data-draft-id="7597640029574823987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂机器学习中的数据划分与验证方法！"/> <meta itemprop="keywords" content="面试,算法"/> <meta itemprop="datePublished" content="2026-01-21T15:29:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂机器学习中的数据划分与验证方法！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:29:55.000Z" title="Wed Jan 21 2026 15:29:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>推荐直接网站在线阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoting.cn%2F" target="_blank" title="https://aicoting.cn/" ref="nofollow noopener noreferrer">aicoting.cn</a></p>
</blockquote>
<p>在机器学习中，为了评估模型的泛化能力，需要将数据集合理划分为训练集、验证集和测试集。训练集用于模型的学习，验证集用于模型选择和超参数调优，而测试集则用于最终性能评估。</p>
<p>常用的验证方法包括留出法、k 折交叉验证和自助法（Bootstrap），通过多次划分与评估可以有效减少结果的偏差与方差，提高模型性能评估的可靠性。</p>
<h2 data-id="heading-0">训练集/验证集/测试集</h2>
<p>在机器学习的建模过程中，数据是模型学习和评估的基础。为了确保模型在未见数据上的泛化能力，通常需要将数据集划分为训练集（Training Set）、验证集（Validation Set）和测试集（Test Set）。这三类数据集在功能与作用上各有侧重，是整个机器学习流程中不可或缺的环节。</p>
<h3 data-id="heading-1">训练集（Training Set）</h3>
<p>训练集是模型学习的主要数据来源。模型通过在训练集上调整参数，使预测结果尽可能贴近真实标签。训练集的质量和数量直接影响模型的学习能力和最终性能。</p>
<p>训练集用于优化模型参数，例如线性回归中的权重、神经网络中的权重和偏置。训练集应尽可能覆盖数据的多样性和典型模式，以避免模型只学到局部规律。若训练集过小或噪声过多，模型可能记住训练样本而无法泛化，导致过拟合。</p>
<h3 data-id="heading-2">验证集（Validation Set）</h3>
<p>验证集是模型调优和选择的重要依据，通常与训练集相互独立。它主要用于评估模型在未见数据上的表现，并指导超参数调节和模型选择。</p>
<p>通过在验证集上测试不同参数组合（如正则化系数、学习率、树深度等），选择性能最优的配置。当有多个候选模型时，验证集可以帮助判断哪一个模型更适合任务需求。同时验证集提供了训练之外的独立反馈，使得模型不会仅针对训练数据进行优化。</p>
<p>验证集的常用划分策略包括：</p>
<ul>
<li>固定划分：从训练数据中单独划出一部分作为验证集。</li>
<li>交叉验证：将训练数据分成 k 份，轮流使用一份作为验证集，取平均性能，以获得更稳健的评估。</li>
<li>自助法（Bootstrap）：通过有放回抽样构建多个子集进行验证，适合小样本场景。</li>
</ul>
<h3 data-id="heading-3">测试集（Test Set）</h3>
<p>测试集是模型最终评估的标准，用于衡量模型在真实场景中的泛化能力。测试集必须在模型训练和验证阶段完全不参与，以保证评估的客观性。</p>
<p>测试集与训练集、验证集严格分开，不能用于模型调参或选择。通过测试集计算各类指标（如分类准确率、回归误差等），反映模型的实际应用效果。在研究和竞赛中，测试集常用于不同模型的最终比较和排名。</p>
<h3 data-id="heading-4">数据划分原则</h3>
<p>为了保证训练、验证、测试各环节的可靠性，数据划分需要遵循一定原则：</p>
<ol>
<li>互不重叠：三类数据集应无交集，避免信息泄露。</li>
<li>比例合理：常见划分比例为训练集：验证集：测试集 ≈ 6:2:2 或 7:2:1，具体可根据数据量调整。</li>
<li>保持分布一致：确保三类数据集的特征分布和类别分布与整体数据相似，避免评估偏差。</li>
<li>随机划分与分层抽样：随机划分可以增加数据代表性，分层抽样适合类别不平衡的数据集。</li>
</ol>
<p>训练集、验证集和测试集各自承担不同的角色：训练集负责学习模型参数，验证集用于调优和选择模型，而测试集用于最终性能评估。</p>
<p>合理划分和使用这三类数据集，是保证机器学习模型泛化能力、避免过拟合以及获得可靠评估结果的基础。通过科学的数据划分和验证方法，模型才能在真实应用场景中表现稳定、可靠。</p>
<h2 data-id="heading-5">k 折交叉验证</h2>
<p>在机器学习中，模型的泛化能力是评估其性能的重要标准。单次划分训练集和验证集可能导致评估结果受数据分布偶然性影响，特别是在数据量有限的情况下。为了获得更加稳健和可靠的性能评估，k 折交叉验证（k-Fold Cross-Validation, k-CV） 被广泛应用于模型训练与验证中。</p>
<h3 data-id="heading-6">基本原理</h3>
<p>k 折交叉验证是一种将数据集划分为 k 个大小相近的子集（folds），并进行 k 次训练和验证的方法。其流程如下：</p>
<ol>
<li>将数据集均匀分为 k 个子集，每个子集包含的数据尽量保持整体分布一致（可采用分层抽样，尤其是分类任务中）。</li>
<li>依次选取其中的一个子集作为验证集，剩余 k-1 个子集合并作为训练集。</li>
<li>在训练集上训练模型，并在验证集上计算评估指标。</li>
<li>重复上述过程 k 次，每次选择不同的子集作为验证集。</li>
<li>将 k 次评估结果取平均，得到模型的整体性能估计。</li>
</ol>
<p>下面我们依旧使用经典的 Iris 数据集 通过k折交叉验证进行分类任务。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入必要库</span>
<span class="hljs-comment"># 导入必要库</span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> KFold, cross_val_score
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeClassifier

<span class="hljs-comment"># 1. 加载数据</span>
iris = load_iris()
X, y = iris.data, iris.target

<span class="hljs-comment"># 2. 定义模型</span>
model = DecisionTreeClassifier(random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 3. 定义 k 折交叉验证</span>
k = <span class="hljs-number">5</span>
kf = KFold(n_splits=k, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 4. 执行交叉验证</span>
scores = cross_val_score(model, X, y, cv=kf)

<span class="hljs-comment"># 5. 输出每折的准确率</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{k}</span>-折交叉验证每折准确率："</span>, scores)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均准确率：<span class="hljs-subst">{scores.mean():<span class="hljs-number">.4</span>f}</span>, 标准差：<span class="hljs-subst">{scores.std():<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 6. 可视化结果</span>
plt.figure(figsize=(<span class="hljs-number">8</span>,<span class="hljs-number">4</span>))
plt.bar(<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, k+<span class="hljs-number">1</span>), scores, color=<span class="hljs-string">'skyblue'</span>)
plt.ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1.1</span>)
plt.xlabel(<span class="hljs-string">"Fold"</span>)
plt.ylabel(<span class="hljs-string">"Accuracy"</span>)
plt.title(<span class="hljs-string">f"<span class="hljs-subst">{k}</span>-Fold Cross-Validation Accuracy"</span>)
plt.xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, k+<span class="hljs-number">1</span>))
plt.show()
</code></pre>
<p>结果如下图， 每折交叉验证结果显示模型在不同子集上的表现略有差异，但都较高，说明模型对数据的学习稳定性较好。通过柱状图可以直观看到每折的准确率分布，帮助快速发现是否存在某一折表现异常。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e37db6f954f74a78bc28728fb187e67a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769614194&amp;x-signature=HVHXw9Rp%2F%2FiR0jRiks58dg%2BM1Os%3D" alt="" loading="lazy"/></p>
<p>k 折交叉验证的优势可以充分利用数据，相比单次划分训练集/验证集的方法，k 折交叉验证能够使所有样本都参与训练和验证，提高了数据利用效率。通过 k 次平均性能，减少了单次划分可能产生的偏差，提高模型性能估计的可靠性。在数据量有限的情况下，k 折交叉验证可以避免训练集过小导致模型欠拟合的问题。</p>
<p>在使用k 折交叉验证时，要注意：</p>
<ul>
<li>选择 k 的大小：常用的 k 值为 5 或 10。k 值过小可能导致评估方差较大，k 值过大（如留一法，k=N）则计算成本高。</li>
<li>分层抽样：对于类别不平衡的分类问题，应采用分层 k 折交叉验证（Stratified k-Fold），保证每个折中类别比例与原始数据一致。</li>
<li>重复交叉验证：为进一步降低评估方差，可以多次随机划分 k 折，取多次平均值。</li>
</ul>
<h3 data-id="heading-7">k 折交叉验证的扩展</h3>
<ul>
<li>留一交叉验证（Leave-One-Out Cross-Validation, LOOCV）：k=N，每次仅留一个样本作为验证集，适合数据量非常小的情况。</li>
<li>重复 k 折交叉验证（Repeated k-Fold CV）：多次重复 k 折交叉验证，进一步降低评估方差。</li>
<li>嵌套交叉验证（Nested Cross-Validation）：在外层进行模型选择，内层进行超参数调优，适合高维或复杂模型的评估。</li>
</ul>
<p>总结一下，k 折交叉验证是一种经典且有效的模型验证方法，通过多次训练和验证充分利用数据，提高了模型性能评估的稳定性与可靠性。合理选择 k 值、采用分层策略以及必要时使用重复或嵌套交叉验证，可以在模型选择与调参中取得更好的效果，使模型在实际应用中表现更加稳健。</p>
<p>最新的文章都在公众号aicoting更新，别忘记关注哦！！！</p>
<p>📚 推荐阅读</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485782%26idx%3D1%26sn%3D060c8222b47cbf903fbfded1f0421bcf%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485782&amp;idx=1&amp;sn=060c8222b47cbf903fbfded1f0421bcf&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习之数据预处理篇！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485800%26idx%3D1%26sn%3Da52107c9dc7071d8530a24563861fa46%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485800&amp;idx=1&amp;sn=a52107c9dc7071d8530a24563861fa46&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习特征工程中的特征选择</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485808%26idx%3D1%26sn%3D2c57081d4b12433f6b8919209e2e52ed%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485808&amp;idx=1&amp;sn=2c57081d4b12433f6b8919209e2e52ed&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习中的特征构造</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485820%26idx%3D1%26sn%3Dadcb41fd14347f2f1431709323fa253f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485820&amp;idx=1&amp;sn=adcb41fd14347f2f1431709323fa253f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习之特征降维</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485941%26idx%3D1%26sn%3Dcb53a98bacd1cfbd3255bbeeab6a24ec%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485941&amp;idx=1&amp;sn=cb53a98bacd1cfbd3255bbeeab6a24ec&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂层次聚类和密度聚类方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485946%26idx%3D1%26sn%3Da5cf50a4a3bda9785fb0c7baae3a6bb2%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485946&amp;idx=1&amp;sn=a5cf50a4a3bda9785fb0c7baae3a6bb2&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂机器学习中的PCA主成分分析！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485952%26idx%3D1%26sn%3Dffe1fca4cb75b2f99ace92593554837c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485952&amp;idx=1&amp;sn=ffe1fca4cb75b2f99ace92593554837c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习中独立成分分析ICA和主成分分析PCA有什么区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485960%26idx%3D1%26sn%3D05cf98957ea11dcd6ae165588b4c91c7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485960&amp;idx=1&amp;sn=05cf98957ea11dcd6ae165588b4c91c7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂t-SNE和UMAP降维方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485972%26idx%3D1%26sn%3De106fcda9b02b7e8a6fb31495bb28dae%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485972&amp;idx=1&amp;sn=e106fcda9b02b7e8a6fb31495bb28dae&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中的概率图模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485986%26idx%3D1%26sn%3D9057c13995012cc7220eae20f6cfb4c2%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485986&amp;idx=1&amp;sn=9057c13995012cc7220eae20f6cfb4c2&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中半监督学习的经典方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485992%26idx%3D1%26sn%3D0a7ba5af7a317fccef442606768dac95%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485992&amp;idx=1&amp;sn=0a7ba5af7a317fccef442606768dac95&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂强化学习中的马尔可夫决策过程！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485999%26idx%3D1%26sn%3D9bb3651c87e186ff0cfb659597eedcd8%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485999&amp;idx=1&amp;sn=9bb3651c87e186ff0cfb659597eedcd8&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂强化学习中的动态规划与值迭代!</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247486006%26idx%3D1%26sn%3D80519b243ac67a05b960e8730bda3a32%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247486006&amp;idx=1&amp;sn=80519b243ac67a05b960e8730bda3a32&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂强化学习中的Q-learning</a></p>
<p>作者：aicoting</p>
<p>分享是一种信仰，连接让成长更有温度。</p>
<p>我们下次不见不散！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Akamai Cloud客户案例 | Efashe 借助 Akamai 云计算服务实现高效扩展并加速市场进入]]></title>    <link>https://juejin.cn/post/7597693638923255871</link>    <guid>https://juejin.cn/post/7597693638923255871</guid>    <pubDate>2026-01-21T15:49:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597693638923255871" data-draft-id="7597693638923239487" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Akamai Cloud客户案例 | Efashe 借助 Akamai 云计算服务实现高效扩展并加速市场进入"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2026-01-21T15:49:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Akamai Cloud客户案例 | Efashe 借助 Akamai 云计算服务实现高效扩展并加速市场进入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:49:26.000Z" title="Wed Jan 21 2026 15:49:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“借助 Akamai，我们已从疲于应付基础设施问题，转向专注于金融创新和市场增长。”<br/>
——Peter Rutayomba，Efashe 集团首席技术官</p>
</blockquote>
<hr/>
<p>如您所在的企业也在考虑采购云服务或进行云迁移，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fakamai-cloud-computing-freetrial%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_260121_blogarticles244" target="_blank" title="https://www.akamai.com/zh/lp/akamai-cloud-computing-freetrial?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_260121_blogarticles244" ref="nofollow noopener noreferrer">点击链接</a>了解Akamai Linode解决方案，现在申请试用可得高达5000美元专属额度</p>
<hr/>
<p><strong><strong>引领非洲数字化交易与金融服务革命</strong></strong></p>
<p>Future Dynamic Innovations 是 Efashe 集团的一部分，也是卢旺达领先的金融科技聚合商之一，为该国大部分企业提供从账单支付、公用事业充值到短信通知和提醒等全方位服务。其使命简单而深远：通过手机让日常金融服务覆盖整个非洲。Efashe 在卢旺达拥有 3,000 个代理点，业务扩展至马拉维和赞比亚，每月处理超过 1000 万条短信，每年驱动超过 300 亿笔交易。</p>
<p>但在幕后，Efashe 的雄心却遭遇了瓶颈。原有的基础设施成本高昂、不可靠且部署速度极慢。转折点出现在公司将其工作负载迁移到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fcloud%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external1_blogarticles244" target="_blank" title="https://www.akamai.com/zh/cloud?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external1_blogarticles244" ref="nofollow noopener noreferrer">Akamai 云计算服务</a>之后。目前，Efashe 在生产环境中使用了超过 100 台 Linode 服务器，将部署时间缩短至分钟级，并将正常运行时间提升至近 100%。这也使团队得以解放出来，专注于平台创新和非洲市场扩张，同时在由 Akamai 驱动的、经济实惠的基础设施堆栈上，保持服务快速、可靠和可扩展。</p>
<p><strong><strong>成本高昂、不可靠的基础设施阻碍增长</strong></strong></p>
<p>在迁移到 Akamai 之前，Efashe 依赖于一种混合基础设施方案，将托管数据中心的物理服务器与本地提供商的虚拟专用服务器服务相结合。这种设置提供了一定的冗余，但造成了一个异构环境，难以进行可靠的管理和扩展。</p>
<p>每次出现故障时，问题就暴露出来。Efashe 精干的技术团队不得不手动切换服务器和重新路由流量，这常常导致长时间停机，并错失合作伙伴的服务水平协议目标。“在我们的业务中，任何延迟都意味着错失机会，” Efashe 首席技术官 Peter Rutayomba 解释道。</p>
<p>可用性徘徊在 80% 左右，频繁中断侵蚀了客户信任，Efashe 的竞争优势也逐渐减弱。成本也难以预测，在新硬件的资本支出和紧急修复的运营支出之间摇摆不定。Efashe 集团首席执行官 Butera Rutagaramba 表示：“我们的方法从根本上是被动的。我们不断在‘救火’。这几乎没有留下增长或创新的空间。”</p>
<p><strong><strong>Akamai 云计算服务：可扩展、简单、可预测</strong></strong></p>
<p>Efashe 转向 Akamai <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-cloud-computing%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external2_blogarticles244" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-cloud-computing?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external2_blogarticles244" ref="nofollow noopener noreferrer">云计算服务</a>，以解决其最大的挑战：可用性、成本可预测性和部署速度。</p>
<ul>
<li><strong><strong>Linode Kubernetes 引擎：</strong></strong> 借助 LKE，Efashe 获得了一个用于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-container%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external3_blogarticles244" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-container?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external3_blogarticles244" ref="nofollow noopener noreferrer">容器化工作负载</a>的托管平台，加速了部署和 DevOps 成熟度，同时确保了无缝的 Kubernetes 过渡。</li>
<li><strong><strong>NodeBalancers：</strong></strong> 这些完全托管的高可用性负载均衡器可以在几分钟内部署完成，替代了以往需要数周配置的设置。</li>
<li><strong><strong>块存储：</strong></strong> Efashe 利用这种高可用的存储容量，消除了成本高昂的硬件更新周期，只需点击几下即可按需扩展。</li>
<li><strong><strong>对象存储：</strong></strong> 这种持久、可扩展且经济高效的存储支持云工作负载，同时实现更智能的归档。</li>
<li><strong><strong>云防火墙：</strong></strong> 这些<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-firewall%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external4_blogarticles244" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-firewall?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external4_blogarticles244" ref="nofollow noopener noreferrer">防火墙</a>使 Efashe 能够轻松控制进出 Akamai <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-are-cloud-resources%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external5_blogarticles244" target="_blank" title="https://www.akamai.com/zh/glossary/what-are-cloud-resources?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external5_blogarticles244" ref="nofollow noopener noreferrer">云资源</a>的网络流量。</li>
<li><strong><strong>虚拟私有云：</strong></strong> 使用虚拟私有云，Efashe 获得了直观、安全的分段环境，可以在完全隔离的环境中运行工作负载，而无需专门的硬件专业知识。</li>
<li><strong><strong>备份：</strong></strong> 通过磁盘的自动备份，Efashe 可以保护数据并确保简单、自动化的灾难恢复。</li>
</ul>
<blockquote>
<p>Rutagaramba 称赞了 Akamai 的设计理念：“从用户界面到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fhow-do-apis-work%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external6_blogarticles244" target="_blank" title="https://www.akamai.com/zh/glossary/how-do-apis-work?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external6_blogarticles244" ref="nofollow noopener noreferrer">API</a>，这些基础设施抽象都经过深思熟虑，简单且现代化。它们使没有深厚硬件知识的新工程师也能在几天内上手工作。”</p>
</blockquote>
<p><strong><strong>以可预测支出替代基础设施成本峰值，驱动增长</strong></strong></p>
<p>同样重要的是，Akamai 消除了不可预测的支出。与旧设置中硬件故障和供应商依赖导致成本突然飙升不同，Akamai 提供一致的性能和透明的定价。</p>
<p>按使用量付费的模式，用基于使用情况的、可预测的计费取代了巨额的资本支出投资，通过确保 Efashe 仅为消耗的资源付费，降低了运营支出。这种一致性使得增长计划能够获得更有效的预算和资源分配。“有了 Akamai，成本既实惠又可预测，” Rutayomba 说。</p>
<p>“Akamai 解决方案已将 Efashe 的基础设施管理，从被动的、手动的流程转变为主动的、自动化的操作。”<br/>
——Butera Rutagaramba，Efashe 集团首席执行官</p>
<p><strong><strong>在 Akamai 云基础设施上无缝扩展至新市场</strong></strong></p>
<p>Akamai 基础设施的可靠性和可扩展性对 Efashe 的区域扩张至关重要。“Akamai 确保了近 100% 的正常运行时间，我们可以在短短五分钟内启动一台新服务器，而不是五天，” Rutayomba 说。</p>
<p>公司以卢旺达为基地，已在马拉维和赞比亚启动了业务——所有这些都通过一个统一的账户进行管理。“Akamai 使我们能够简单且经济高效地快速扩展到新市场，”他继续说道。</p>
<p>Efashe 计划接下来进入津巴布韦，并着眼于扩展到 25 个以上的非洲国家。“说实话，如果没有 Akamai，考虑到资源限制以及在多个非洲市场管理基础设施的复杂性，我们不可能实现雄心勃勃的增长目标，” Rutagaramba 补充道。</p>
<p><strong><strong>得以专注创新，实现长远愿景</strong></strong></p>
<p>或许 Akamai 最具变革性的影响，在于它将 Efashe 的工程师从基础设施“救火”中解放出来。在使用 Akamai 之前，工程师们需要在托管中心熬夜处理故障和执行手动故障转移。如今，他们可以自由地专注于重要事项：开发和增强 Efashe 的核心金融科技产品，同时构建新的产品，如小额贷款应用程序。公司甚至正在尝试使用 Akamai 的嵌入式<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-are-databases%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external7_blogarticles244" target="_blank" title="https://www.akamai.com/zh/glossary/what-are-databases?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external7_blogarticles244" ref="nofollow noopener noreferrer">数据库</a>，其在初步测试中显示出比 PostgreSQL 更快的性能。</p>
<p>Efashe 现在在 90 天内服务超过 200 万活跃客户。“秘密武器是 Akamai 的技术和支持团队，” Rutayomba 说。“他们负责基础设施，让我们可以专注于我们的使命和愿景。”</p>
<p><strong><strong>展望未来：与值得信赖的伙伴共建非洲金融科技未来</strong></strong></p>
<p>从不可靠的混合设置到云原生基础设施基础，Efashe 经历了一场转型，使其成为非洲金融科技的领导者之一。以 Akamai 作为长期合作伙伴，该公司不仅在扩展服务，更是在重塑整个非洲大陆的金融包容性。</p>
<p>“Akamai 帮助我们从一个受基础设施制约的公司，转变为一个在非洲市场快速扩张的公司，将技术从运营负担转变为竞争优势，” Rutagaramba 说。</p>
<p>正如 Rutayomba 所言：“Akamai 让我们感觉是长期合作伙伴，而不仅仅是客户。携手共进，我们能够推动整个非洲的金融创新。”</p>
<p><strong><strong>关于 Efashe 集团</strong></strong></p>
<p>Efashe 集团是一家领先的金融科技和数字聚合公司，正在引领非洲的数字分发和金融服务革命。在卢旺达成功运营后，它启动了非洲扩张计划，愿景是赋能非洲 10,000 多名企业家，业务首先从马拉维和赞比亚开始。欲了解更多信息，请访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Fefashe.com" target="_blank" title="http://efashe.com" ref="nofollow noopener noreferrer">efashe.com</a>。</p>
<p><strong><strong>关于 Akamai</strong></strong></p>
<p>Akamai 是为在线业务提供动力和安全保障的网络安全与云计算公司。我们市场领先的安全解决方案、卓越的威胁情报和全球运营团队提供深度防御，随时随地保护企业数据和应用程序。Akamai 的全栈云计算解决方案在全球分布最广的平台上提供卓越性能和可负担性。全球企业信赖 Akamai，以获取行业领先的可靠性、规模和专业知识，从而自信地发展其业务。了解更多信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260121_external8_blogarticles244" target="_blank" title="https://www.akamai.com/zh?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260121_external8_blogarticles244" ref="nofollow noopener noreferrer">akamai.com</a>。</p>
<hr/>
<p>如您所在的企业也在考虑采购云服务或进行云迁移，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fakamai-cloud-computing-freetrial%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_260121_blogarticles244_end" target="_blank" title="https://www.akamai.com/zh/lp/akamai-cloud-computing-freetrial?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_260121_blogarticles244_end" ref="nofollow noopener noreferrer">点击链接</a>了解Akamai Linode解决方案，现在申请试用可得高达5000美元专属额度</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零基础部署 n8n：火山引擎 ECS + 轩辕专业版详细教程（2026年最新）]]></title>    <link>https://juejin.cn/post/7597623654056607759</link>    <guid>https://juejin.cn/post/7597623654056607759</guid>    <pubDate>2026-01-21T14:03:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056607759" data-draft-id="7597622924272566299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零基础部署 n8n：火山引擎 ECS + 轩辕专业版详细教程（2026年最新）"/> <meta itemprop="keywords" content="工作流引擎,人工智能,GitHub"/> <meta itemprop="datePublished" content="2026-01-21T14:03:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零基础部署 n8n：火山引擎 ECS + 轩辕专业版详细教程（2026年最新）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:03:52.000Z" title="Wed Jan 21 2026 14:03:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h3 data-id="heading-0">什么是 <code>n8n</code>？为什么我要自托管它？</h3>
<p><code>n8n</code>（读作 <code>nate-n</code>）是一个<strong>开源、低代码的工作流自动化平台</strong>。它允许你通过拖拽节点的方式，快速连接各种服务、<code>API</code> 和 <code>AI</code> 模型，实现复杂的自动化任务。比如：</p>
<ul>
<li>每天定时抓取 <code>RSS</code> 新闻 → 用 <code>AI</code> 总结 → 发送到微信/邮箱/飞书</li>
<li>新增 <code>Google Sheet</code> 行 → 自动创建 <code>Notion</code> 页面 + <code>Slack</code> 通知</li>
<li>监控 <code>X</code> 关键词 → 筛选后推送到 <code>Discord</code> 或企业微信</li>
<li>集成国内大模型（如豆包、<code>DeepSeek</code>、通义千问）做智能回复、内容生成、<code>RAG</code> 问答</li>
<li>通过 <code>Webhook</code> 接收外部事件，构建自己的 <code>mini API</code> 或 <code>agentic</code> 系统</li>
</ul>
<p><strong>核心优势</strong>：</p>
<ul>
<li><strong>完全免费</strong>：<code>Community</code> 版无任务限制、无执行次数上限</li>
<li><strong>自托管</strong>：数据完全掌握在自己手里，隐私安全，不受第三方限流、涨价或服务中断</li>
<li><strong>高度可扩展</strong>：支持 <strong>500+ 官方整合</strong> + 海量社区节点，还能用 <code>JavaScript/Python</code> 自定义代码节点</li>
<li><strong>强大 <code>AI</code> 支持</strong>：内置 <code>AI Agent</code> 节点（基于 <code>LangChain</code>），轻松接入 <code>OpenAI</code>/<code>Anthropic</code>/国内模型，支持多步 <code>agent</code>、自定义工具、内存管理（<code>Simple</code>/<code>Redis</code>/<code>Postgres</code>）、<code>RAG</code> 等</li>
<li><strong>跨平台部署</strong>：<code>Docker</code> 一键部署，支持 <code>Linux</code>、<code>NAS</code>、<code>K8s</code>，甚至树莓派或云服务器</li>
</ul>
<p>缺点：需要自己维护服务器、配置 <code>HTTPS</code>、处理更新；学习曲线稍陡（节点众多）；复杂 <code>workflow</code> 可能消耗较多资源。但一旦跑通，性价比极高，尤其适合开发者、独立创作者、中小型团队，甚至大型企业内部工具链。</p>
<p>我选择在<strong>火山引擎 <code>ECS</code></strong> 上部署 <code>n8n</code>，是因为国内访问速度快、按量计费便宜、轩辕镜像加速 <code>Docker</code> 拉取方便。整个过程预计 30-60 分钟，下面记录完整流程，供大家参考。</p>
<p><strong>注意事项</strong>：</p>
<ul>
<li>本教程使用按量计费 <code>ECS</code>，避免资源浪费。生产环境建议使用 <code>PostgreSQL</code> 数据库，并配置 <code>HTTPS</code> 和域名。</li>
<li>确保账号有足够余额（至少 100 元，用于 <code>ECS</code> 和带宽）。</li>
<li>部署后，<code>n8n</code> 默认端口 5678，请在安全组中开放。</li>
<li>中国地区用户必须使用轩辕专业版镜像加速（免费版高峰期限流严重）。</li>
</ul>
<hr/>
<h3 data-id="heading-1">一、准备工作</h3>
<h4 data-id="heading-2">轩辕专业版充值 &amp; 获取专属加速域名</h4>
<p>由于 <code>Docker Hub</code> 在国内拉取极慢，且免费版轩辕（<code>docker.xuanyuan.me</code>）高峰期限流、经常出现 <code>size validation failed</code> 等问题，本教程全程使用<strong>轩辕专业版</strong>。</p>
<ol>
<li>
<p>打开官网：<code>https://xuanyuan.cloud</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41dc1908f1824ba49c9942c57d527cb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=ZkQEfOdHLs0KdsfuCM8ULxG2hZE%3D" alt="轩辕镜像官网首页" loading="lazy"/></p>
</li>
<li>
<p>注册/登录（手机号或邮箱均可，实名认证可选但推荐）</p>
</li>
<li>
<p>进入「个人中心」或「充值流量」 → 充值</p>
</li>
<li>
<p>选择最小流量包充值（建议先买 <code>50GB</code>，价格约 8 元，按真实下载流量计费，用多少扣多少）</p>
<p>支持微信/支付宝，充值后几秒到账</p>
</li>
<li>
<p>充值成功后，页面会显示你的<strong>专属加速域名</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8f6d0e1f86b4d229c92b08b5b21853a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=A6lDgl6PKOAM6qfibVGjasuzk4g%3D" alt="轩辕镜像专属域名" loading="lazy"/></p>
</li>
<li>
<p><strong>复制纯域名部分</strong>，例如 <code>xxxxxxxx.xuanyuan.run</code></p>
<p>这个域名就是你后续所有 <code>docker pull</code> 的前缀，例如：</p>
<pre><code class="hljs language-bash" lang="bash">docker pull xxxxxxxx.xuanyuan.run/n8nio/n8n:latest
</code></pre>
</li>
</ol>
<p><strong>注意</strong>：专业版流量用完会报 <code>402 Payment Required</code>，记得及时充值。日常使用 <code>n8n</code> 拉镜像每月 <code>5-20GB</code> 足够。</p>
<h4 data-id="heading-3">火山引擎账号准备</h4>
<ul>
<li>已实名认证，有余额 ≥100 元</li>
</ul>
<hr/>
<h3 data-id="heading-4">二、基础配置</h3>
<h4 data-id="heading-5">创建 <code>ECS</code> 实例</h4>
<p><strong>基本信息</strong></p>

































































<table><thead><tr><th>参数名称</th><th>推荐值</th><th>说明</th><th>是否必填</th></tr></thead><tbody><tr><td>计费类型</td><td>按量计费</td><td>适合测试/临时部署，用完可随时释放/停止，避免包年包月锁定时长</td><td>必填</td></tr><tr><td>地域及可用区</td><td>与 <code>VPC</code>/子网一致，例如 华南 1 (广州) 可用区 A</td><td>必须匹配之前创建的 <code>VPC</code> 和子网，否则无法绑定</td><td>必填</td></tr><tr><td>实例规格族</td><td>通用型 <code>g3i / g4i / g3al</code></td><td>推荐 <code>g2i</code> 或 <code>g4i</code> 系列，性价比高；<code>n8n</code> 轻量不需 <code>GPU</code></td><td>必填</td></tr><tr><td>具体实例规格</td><td><code>ecs.g4i.large</code>（<code>2 vCPU</code> + <code>8 GiB</code> 内存）</td><td>入门够用（<code>2 vCPU</code> + <code>4-8 GiB</code> 内存）；复杂 <code>workflow</code> 升级到 <code>xlarge</code></td><td>必填</td></tr><tr><td>镜像类型</td><td>公共镜像</td><td>稳定、更新快</td><td>必填</td></tr><tr><td>镜像</td><td><code>Ubuntu 24.04</code>（或 <code>20.04</code>）</td><td><code>Docker</code> 安装方便，社区支持好；也可 <code>CentOS 8/Stream</code>，但 <code>Ubuntu</code> 更现代</td><td>必填</td></tr><tr><td>系统盘类型</td><td>极速型 <code>SSD</code> 云盘</td><td>性价比高，<code>IOPS</code>/吞吐量够 <code>n8n</code> + <code>Docker</code></td><td>必填</td></tr><tr><td>系统盘容量</td><td><code>20 GiB</code>（最小值）</td><td>够系统 + <code>Docker</code> + <code>n8n</code> 数据；后期可扩容</td><td>必填</td></tr><tr><td>数据盘</td><td>不添加（可选后期添加）</td><td><code>n8n</code> 数据通过 <code>Docker</code> 卷持久化，无需额外数据盘</td><td>可选</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/621ee1e945af4efaa5afe54ae682c510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=Og94YxRkxH%2FPpCg8W5lu4ciel7I%3D" alt="ecs-basic" loading="lazy"/></p>
<h4 data-id="heading-6">创建私有网络（<code>VPC</code> + 子网）</h4>
<p><strong>网络配置</strong></p>



































<table><thead><tr><th>参数名称</th><th>推荐值</th><th>说明</th><th>是否必填</th></tr></thead><tbody><tr><td>私有网络</td><td><code>n8n-vpc</code>（之前创建的，下方有创建私有网络的配置）</td><td>必须与子网同一 <code>VPC</code></td><td>必填</td></tr><tr><td>子网</td><td><code>n8n-subnet</code>（之前创建的，下方有创建私有网络的配置）</td><td>必须匹配可用区</td><td>必填</td></tr><tr><td>安全组</td><td><code>n8n-sg</code>（之前创建的，下方有创建私有网络的配置）</td><td>已开放 <code>TCP</code> 22 (<code>SSH</code>) + 5678 (<code>n8n</code>) + 80/443 (<code>HTTPS</code>)</td><td>必填</td></tr><tr><td>弹性公网 <code>IP</code></td><td>分配弹性公网 <code>IP</code></td><td>必须分配公网 <code>IP</code>，否则无法外部访问 <code>n8n</code></td><td>必填</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90f195a3cfc841ab85ab8559b37beb50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=8I4I4CLiVeOG7mPArSsMTZRmkdc%3D" alt="ecs-vpc" loading="lazy"/></p>
<p><strong>创建私有网络 - <code>VPC</code></strong></p>















































<table><thead><tr><th>参数名称</th><th>推荐值</th><th>说明</th><th>是否必填</th></tr></thead><tbody><tr><td>地域</td><td>华南 1 (广州) 或离你最近的（如华东 2 等）</td><td><code>VPC</code> 是地域级资源，必须与后续 <code>ECS</code>、子网一致。<code>Seattle</code> 用户建议选华北 2（北京）降低延迟。</td><td>必填</td></tr><tr><td>名称</td><td><code>n8n-vpc</code> 或 <code>automation-vpc</code></td><td>自定义，便于识别，支持中英文、数字、短横线、下划线，长度 1-128 字符。</td><td>必填</td></tr><tr><td>描述</td><td>用于 <code>n8n</code> 自动化部署的私有网络，隔离 <code>ECS</code> 和子网</td><td>可写用途、项目名，便于后期管理。长度 0-256 字符，支持中英文。</td><td>可选</td></tr><tr><td><code>IPv4 CIDR</code></td><td><code>192.168.0.0/16</code> 或 <code>10.0.0.0/16</code></td><td><code>VPC</code> 的私有 <code>IP</code> 地址段范围。推荐 <code>192.168.x.x/16</code>（大范围，便于后续创建多个子网）。子网 <code>CIDR</code> 必须在此范围内且不重叠。</td><td>必填</td></tr><tr><td/><td/><td/><td/></tr><tr><td>所属项目</td><td><code>n8n-project</code>（新建的专用项目）或 <code>default</code></td><td>资源分组管理，便于后期按项目查看账单、授权 <code>IAM</code> 子账号、隔离资源。默认是 <code>default</code> 项目（系统预置，不可删）。如果还没项目，先去「项目管理」新建。</td><td>必填</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccbf73fad5094b0e9f439663af1218f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=nUt8vsBuTKFZwo93rcAQ5IdF1Mk%3D" alt="创建私有网络-VPC" loading="lazy"/></p>
<p><strong>创建私有网络 - 子网</strong></p>



































<table><thead><tr><th>参数名称</th><th>推荐值</th><th>说明</th><th>是否必填</th></tr></thead><tbody><tr><td>可用区</td><td>可用区 A（或与 <code>ECS</code> 匹配的可用区）</td><td>子网绑定到具体可用区，后续 <code>ECS</code> 必须在同一可用区才能直接绑定子网。推荐与 <code>ECS</code> 规格可用区一致。</td><td>必填</td></tr><tr><td>名称</td><td><code>n8n-subnet</code> 或 <code>n8n-subnet-az-a</code></td><td>自定义，便于识别，支持中英文、数字、短横线、下划线，长度 1-128 字符。建议带可用区后缀（如 -az-a）。</td><td>必填</td></tr><tr><td>描述</td><td><code>n8n ECS</code> 子网，用于部署自动化服务器</td><td>可写用途、项目名，便于后期管理。长度 0-256 字符，支持中英文。</td><td>可选</td></tr><tr><td><code>IPv4 CIDR</code></td><td><code>192.168.0.0/24</code> 或 <code>192.168.1.0/24</code></td><td>子网的私有 <code>IP</code> 地址段，必须在 <code>VPC CIDR</code> 范围内且不重叠（<code>VPC</code> /16 可容纳多个 /24 子网）。推荐 /24（256 <code>IP</code>），够 <code>ECS</code> 使用。</td><td>必填</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c2608d0927c4bb8889295c8b6ab0f6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=%2Bbv697pVL7ISC5aDxLZLDz97G1Q%3D" alt="创建私有网络-子网" loading="lazy"/></p>
<p><strong>自定义配置</strong></p>



























































<table><thead><tr><th>参数名称</th><th>推荐值</th><th>说明</th><th>是否必填</th></tr></thead><tbody><tr><td>登录凭证</td><td>密码</td><td>在登录凭证模块选择密码（而非 <code>SSH</code> 密钥）。适合初学者或测试环境，但生产建议密钥对更安全。</td><td>必选</td></tr><tr><td>登录名</td><td><code>root</code></td><td><code>Linux</code> 系统默认管理员账号，控制台自动填充或灰色显示，不可修改。</td><td>自动填充（不可改）</td></tr><tr><td>登录密码</td><td>（自定义强密码）</td><td>长度 8-30 字符，必须包含大写、小写、数字、特殊字符至少三种。用于 <code>SSH</code> 密码登录或 <code>VNC</code> 控制台。创建后可重置。</td><td>必填</td></tr><tr><td>确认密码</td><td>与登录密码完全相同</td><td>必须与上方登录密码一致，控制台实时校验。两次不同时无法继续。</td><td>必填</td></tr><tr><td>实例名称</td><td><code>n8n-server-seattle-01</code> 或 <code>n8n-test-001</code></td><td>自定义，便于实例列表识别。支持中英文、数字、短横线、下划线，长度 2-128 字符。创建后可修改。</td><td>必填</td></tr><tr><td>主机名</td><td><code>n8n-host</code> 或 <code>gordon-n8n-server</code></td><td>实例内部 <code>hostname</code>（登录后 <code>hostname</code> 命令可见）。建议与实例名称类似，便于管理。长度 1-64 字符，支持字母、数字、短横线。创建后可通过命令修改。</td><td>可选（推荐填）</td></tr><tr><td>所属项目</td><td><code>n8n-project</code>（你新建的项目）或 <code>default</code></td><td>从下拉列表选择。资源分组，便于账单分摊、<code>IAM</code> 权限控制。<code>VPC</code>/子网/安全组会继承此项目。</td><td>必填</td></tr><tr><td>实例描述</td><td><code>n8n</code> 自动化工作流服务器，<code>Seattle IP</code> 部署，<code>Ubuntu 24.04</code>，按量计费测试环境</td><td>写用途、位置、备注等。长度 0-256 字符，支持中英文。创建后可编辑。</td><td>可选（推荐填）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/891c950e022c4b8c8d00cd33a664d531~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=%2Bqj%2B3DxbgW%2BQIp9HoJFHq3leq8U%3D" alt="自定义配置" loading="lazy"/></p>
<p><strong>确认订单</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6760bc936914520983d207f7636640a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=1w40hl08bEGfFhk9nRe7tFM3OsY%3D" alt="确认订单" loading="lazy"/></p>
<p>配置完成后，点击 <strong>立即购买</strong> 并支付，实例创建需 1-2 分钟。</p>
<p><strong>购买完成，恭喜你！</strong></p>
<p>在 <code>ECS</code> 列表中，状态变为 "运行中" 时，记录公网 <code>IP</code>（如 123.45.67.89）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ccb376a1b44c8c8026b07a50b0c7c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=oZdpAUe2tNX1IDxs%2BgAYE1J14fk%3D" alt="实例创建成功" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">三、连接到 <code>ECS</code> 实例</h3>
<h4 data-id="heading-8">选择并使用 <code>SSH</code> 连接工具</h4>
<p>使用 <code>SSH</code> 连接服务器进行后续操作。</p>
<ul>
<li><strong><code>Windows</code> 用户</strong>：使用 <code>Windows PowerShell</code> 或 <code>Git Bash</code>。</li>
<li><strong><code>Mac/Linux</code> 用户</strong>：使用终端。</li>
</ul>
<p>我是在 Windows 上面操作的，所以步骤如下：</p>
<p>打开 <code>Windows PowerShell</code> 。</p>
<p>直接输入一下命令并回车：<code>ssh root@你的公网IP</code>。</p>
<p>第一次连接会提示「<code>Are you sure you want to continue connecting?</code>」输入 <code>yes</code> 回车。</p>
<p>输入你设置的登录密码（输入时不显示字符，直接输入后回车）。</p>
<p>成功后出现类似 <code>root@gordon-n8n-server:~#</code> 提示符，即连接成功！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0fb8df91bf04f30ac127e2a82c82d1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=wiIBZXbREARZfZT9lWt3fWVbjzA%3D" alt="ssh首次连接" loading="lazy"/></p>
<h4 data-id="heading-9">更新系统 &amp; 安装工具</h4>
<p>登录后立即执行以下命令，确保系统最新并准备好后续安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新系统软件包（强烈推荐先做，避免后续安装冲突）</span>
<span class="hljs-comment"># 更新 Ubuntu 的软件源和所有已安装包</span>
<span class="hljs-comment"># 可能需要 1–3 分钟，过程中会问是否继续，输入 y 回车</span>
<span class="hljs-comment"># 完成后会自动重启部分服务，无需重启实例</span>
sudo apt update &amp;&amp; sudo apt upgrade -y
​
<span class="hljs-comment"># 安装常用工具（可选，但非常实用）</span>
<span class="hljs-comment"># curl/wget：下载文件</span>
<span class="hljs-comment"># git：以后可能克隆代码</span>
<span class="hljs-comment"># vim：编辑文件（nano 也可，但 vim 更强大）</span>
<span class="hljs-comment"># net-tools：ifconfig 等命令</span>
<span class="hljs-comment"># htop：更好的进程查看器（top 的升级版）</span>
sudo apt install -y curl wget git vim net-tools htop unzip
​
<span class="hljs-comment"># 查看当前时间和时区（确认是否 Asia/Shanghai）</span>
<span class="hljs-built_in">date</span>
timedatectl
​
<span class="hljs-comment"># 如果时区不对，设置为上海时区</span>
sudo timedatectl set-timezone Asia/Shanghai
</code></pre>
<p>在更新系统软件包的过程中，可能会出现 <code>Configuring openssh-server</code> 的提示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8bb388e27734438a91864387c485877~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=EDH1VvdmJtgLtPcLm13%2B2Zh9Li4%3D" alt="configuring-openssh-server" loading="lazy"/></p>
<p><strong>保留配置文件还是安装维护者版本？</strong> （用箭头键选择，回车确认）</p>
<p>常见选项：</p>
<ul>
<li><code>Install the package maintainer's version</code>（安装新版本，覆盖旧的）</li>
<li><code>Keep your currently-installed version</code>（保留你当前的配置文件）</li>
<li><code>Show the differences between the versions</code>（查看差异）</li>
<li><code>Start a new shell to examine the situation</code>（打开 <code>shell</code> 检查）</li>
</ul>
<p><strong>推荐选择</strong>：<code>Install the package maintainer's version</code>（安装维护者版本）</p>
<p><strong>理由</strong>：你刚创建的 <code>ECS</code> 实例，基本没改过 <code>sshd_config</code>，保留旧版没意义。新版通常更安全（默认禁用 <code>root</code> 密码登录、启用更严格的加密等）。</p>
<p>更新系统软件包和安装常用工具之后，就可以查看当前时间和时区。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e529009727b41d18737921556692577~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=7ZzfNxEfu3Kp6viUCmHmUNRis%2Bg%3D" alt="更新和验证" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">四、安装 <code>Docker</code> &amp; 轩辕专业版加速</h3>
<p>这是火山引擎官方推荐的轩辕一键脚本，会自动：</p>
<ul>
<li>安装最新 <code>Docker</code>（通常 <code>29.x</code>）</li>
<li>安装 <code>Docker Compose</code>（<code>v5.x</code>）</li>
</ul>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">bash &lt;(wget -qO- https://xuanyuan.cloud/docker.sh)
</code></pre>
<ul>
<li>脚本运行时会显示进度，可能需要 2–5 分钟。</li>
<li>完成后会自动重启 <code>Docker</code> 服务。</li>
<li>如果提示输入 <code>yes/no</code>，直接回车默认即可。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/586444c1a5e141fd864e919bfd6df014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=XeAx37urPledqWy5UHEcSO2EEzY%3D" alt="安装Docker" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62551d65a40049d5b65a4d87242a52b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=mQBN%2BsjrIRbJ3gX%2FN5lK5Sury%2Bk%3D" alt="轩辕镜像" loading="lazy"/></p>
<p><strong>验证 <code>Docker</code> 是否安装成功</strong></p>
<p>运行以下命令检查版本：</p>
<pre><code class="hljs language-bash" lang="bash">docker --version
docker compose version
</code></pre>
<p>预期输出示例：</p>
<pre><code class="hljs language-bash" lang="bash">Docker version 29.1.5, build 0e6fee6
Docker Compose version v5.0.1
</code></pre>
<p>如果看到类似输出，恭喜！<code>Docker</code> 已就绪。</p>
<p>额外验证：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl status docker
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b9c8c0a08be423494bb3ccf5194de3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=ehh%2B1beC8eJJf2Wwm9OJB2Iprr0%3D" alt="额外验证" loading="lazy"/></p>
<p>轩辕的 <code>docker.sh</code> 脚本通常会：安装 <code>Docker Engine</code> 和 <code>Docker Compose</code>、配置国内镜像加速源、<strong>自动启动 <code>Docker</code> 服务</strong>（相当于执行了 <code>systemctl start docker</code>）、<strong>自动设置开机自启</strong>（相当于执行了 <code>systemctl enable docker</code>）。</p>
<p>所以在脚本运行完成后，<code>Docker</code> 服务很可能已经处于 <code>running</code> 状态且已启用开机自启。</p>
<h3 data-id="heading-11">五、部署 <code>n8n</code></h3>
<h4 data-id="heading-12">创建 <code>n8n</code> 数据持久化卷</h4>
<p>使用 <code>Docker</code> 部署 <code>n8n</code>，支持持久化数据。推荐使用 <code>PostgreSQL</code> 作为数据库（生产环境），但入门可先用默认 <code>SQLite</code>。</p>
<pre><code class="hljs language-bash" lang="bash">docker volume create n8n_data
</code></pre>
<p>预期输出：<code>n8n_data</code>。这会创建一个名为 <code>n8n_data</code> 的 <code>Docker</code> 卷，用于存储 <code>n8n</code> 的工作流、凭证、数据库（<code>SQLite</code>）等。</p>
<h4 data-id="heading-13">拉取 <code>n8n</code> 镜像（使用轩辕专业版专属域名）</h4>
<p>假设你的轩辕专业版专属域名是 <code>xxxxxxxxx.xuanyuan.run</code>（请替换成你自己的真实域名！）</p>
<pre><code class="hljs language-bash" lang="bash">docker pull xxxxxxxxx.xuanyuan.run/n8nio/n8n:latest
</code></pre>
<p>预期：看到下载进度条，最终显示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686f47647c974136bd713e4d9c384097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=SmcfJqF7%2FHlomTQIKexp%2Bqb1wrw%3D" alt="n8n镜像拉取" loading="lazy"/></p>
<h4 data-id="heading-14">运行 <code>n8n</code> 容器</h4>
<p>直接运行启动命令：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name n8n --restart unless-stopped -p 5678:5678 -e GENERIC_TIMEZONE=<span class="hljs-string">"Asia/Shanghai"</span> -e TZ=<span class="hljs-string">"Asia/Shanghai"</span> -e N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=<span class="hljs-literal">true</span> -e N8N_RUNNERS_ENABLED=<span class="hljs-literal">true</span> -e N8N_SECURE_COOKIE=<span class="hljs-literal">false</span> -v n8n_data:/home/node/.n8n bnte7j9sxxxx2z.xuanyuan.run/n8nio/n8n:latest
</code></pre>
<p><strong>关键参数解释</strong>：</p>
<ul>
<li><code>-d</code>：后台运行</li>
<li><code>--restart unless-stopped</code>：自动重启，除非手动 <code>stop</code></li>
<li><code>-p 5678:5678</code>：把容器 5678 端口映射到服务器 5678</li>
<li>时区变量：确保定时任务正确（<code>Asia/Shanghai</code>）</li>
<li><code>N8N_SECURE_COOKIE=false</code>：临时禁用 <code>secure cookie</code>（因为我们还没上 <code>HTTPS</code>）</li>
<li><code>-v n8n_data:/home/node/.n8n</code>：挂载数据卷，持久化所有配置</li>
</ul>
<p>预期输出：一串长 <code>ID</code>（如 <code>a9f2921a...</code>），表示容器启动成功</p>
<h4 data-id="heading-15">检查容器是否正常运行</h4>
<pre><code class="hljs language-bash" lang="bash">docker ps
</code></pre>
<p>看到类似下面就成功：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e83fe1f319f34cb3aad828c0309ae99d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=Mt81iNHlTpyStOJKKQP9QJJGx1w%3D" alt="docker运行成功" loading="lazy"/></p>
<p>查看启动日志（重要！）：</p>
<pre><code class="hljs language-bash" lang="bash">docker logs -f n8n
</code></pre>
<p>正常会看到类似：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cc775e5b7ad4bf2a7b433501182854e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=dWRJsPDK0pQS6nDPim3%2BRXHIP7w%3D" alt="docker运行日志" loading="lazy"/></p>
<h4 data-id="heading-16">浏览器访问 <code>n8n</code>（首次初始化）</h4>
<p>在你的本地电脑浏览器打开：</p>
<pre><code class="hljs language-bash" lang="bash">http://你的公网IP:5678
</code></pre>
<p>示例：<code>http://123.45.67.89:5678</code></p>
<p>首次访问会进入设置向导：</p>
<p>创建 <code>owner</code> 账号（邮箱 + 强密码）然后填写 <code>First Name</code> 和 <code>Last Name</code>（按你喜好）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/972ec3af0d2a4f49801cbfa362ac8c7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=hsFFKLOfzLUKmpLehiWHyJe4ssU%3D" alt="n8n-setup" loading="lazy"/></p>
<p>个性化问题填写：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e708fd7b89e457a8e945e1fdbe8aa69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=h4vECx2z67C9ORmI4d81NQ6zkOA%3D" alt="n8n-workflows" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0881bb6dff1f464692affc8423ecaf0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=SPE4nExz7ejsb6nHRxu0RdiW0ng%3D" alt="n8n-free-license-key" loading="lazy"/></p>
<p>完成 → 进入 <code>n8n</code> 主界面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8513558b47e43d9a7ad91e289fb2fbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=TQJSzsMq2XA9UQw%2BnmIAfAwCrxM%3D" alt="n8n欢迎界面" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00276253c764f08a17e14529ca4f8e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609145&amp;x-signature=gnDXM2V2hFSl%2Flc%2FcDcr9HgGQpo%3D" alt="n8n主界面" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-17">六、总结</h3>
<h4 data-id="heading-18">全流程回顾（核心步骤）</h4>
<ol>
<li>准备：火山引擎实名 + 充值轩辕专业版获取专属域名</li>
<li>网络：创建 <code>VPC</code>（<code>192.168.0.0/16</code>）+ 子网（/24）+ 安全组（开放 <code>22/5678/80/443</code>）</li>
<li><code>ECS</code>：按量计费、<code>Ubuntu 24.04</code>、<code>2 vCPU</code> + <code>8 GiB</code>、密码登录、绑定网络资源</li>
<li>连接：<code>PowerShell</code> / <code>Git Bash SSH</code> → 更新系统（<code>apt upgrade</code>）→ 处理 <code>openssh-server</code> 配置（选 <code>Install maintainer's version</code>）</li>
<li><code>Docker</code>：轩辕一键脚本安装 + 验证</li>
<li><code>n8n</code> 部署：创建卷 → 拉取镜像（专业版域名）→ 一行命令运行容器 → 浏览器访问 <code>http://公网IP:5678</code> 初始化</li>
</ol>
<p>总耗时 30–60 分钟，最大坑点：轩辕专业版域名使用、安全组端口、容器命令格式。</p>
<h4 data-id="heading-19"><code>n8n</code> 自托管的核心价值</h4>
<ul>
<li>零成本无限执行</li>
<li>数据完全私有，不被第三方读取或因政策中断</li>
<li><code>500+</code> 节点 + <code>AI Agent</code> + 自定义代码，轻松实现复杂自动化（尤其是国内大模型集成）</li>
<li>一次部署，终身可控，适合个人效率工具、内部流程、轻量级企业自动化</li>
</ul>
<p>一句话：<code>n8n</code> 不是工具，而是把「自动化能力」真正还给自己的基础设施。</p>
<h4 data-id="heading-20">后续计划</h4>
<p>这篇是部署入门篇，后续会继续更新：</p>
<ul>
<li><code>n8n</code> 常用工作流实战</li>
<li>国内大模型深度集成（豆包/<code>DeepSeek Agent</code> + <code>RAG</code> 案例）</li>
<li>生产优化（<code>HTTPS</code> + <code>PostgreSQL</code> + 备份 + 监控）</li>
<li>进阶玩法（自定义节点、<code>Webhook API</code>、企业微信联动）</li>
</ul>
<p>欢迎关注或在评论区留言你的需求，我会优先写你最想看的。</p>
<p><strong>感谢阅读！</strong></p>
<p>愿 <code>n8n</code> 成为你日常效率的超级加速器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent和Workflow有什么区别？看完就悟了！]]></title>    <link>https://juejin.cn/post/7597640029574627379</link>    <guid>https://juejin.cn/post/7597640029574627379</guid>    <pubDate>2026-01-21T14:24:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640029574627379" data-draft-id="7597622924272992283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent和Workflow有什么区别？看完就悟了！"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-21T14:24:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent和Workflow有什么区别？看完就悟了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:24:44.000Z" title="Wed Jan 21 2026 14:24:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>智能体（Agent）与工作流（Workflow）正日益成为连接大模型、工具与真实业务场景的关键枢纽。业务落地的实现，始终依赖于规范化的流程体系，而Agent则为这一流程体系注入了智能化演进的新动能。</p>
<p>Agent与Workflow在本质属性上各具特征，却又协同互补，共同构筑出高效能的Agentic系统。本文聚焦Agentic系统的内在逻辑，系统阐述如何依托工作流构建稳定且可工程化落地的业务流程。</p>
<p>1）Agent 与 Workflow 的核心差异及 Agentic 系统的架构解析</p>
<p>2）多样化任务场景下的工作流构建范式与适配策略</p>
<p>3）开源平台 Dify、N8N 与 Coze 中的工作流实现机制</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"> <strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<h2 data-id="heading-0">一、Agent 和 Workflow 的区别</h2>
<p>Workflow与Agent的本质区别，体现在流程主导权的分配与响应机制的弹性上：Workflow遵循“按既定流程执行”的确定性逻辑，而Agent则依托“按场景动态执行”的自适应能力，这一根本分野，直接划定了二者在实际业务场景中的应用范围。</p>
<h3 data-id="heading-1">1.1 Workflow 工作流</h3>
<p>工作流是经过预先设计的标准化操作序列，通过设定清晰的路径、规则与执行步骤，系统性地整合大模型能力与外部工具，以高效实现预设的业务目标。</p>
<p>其赖以建立信任的两大基石——“确定性”与“可预期性”——决定了整个流程必须在设计之初就完成全面界定，确保执行全程可控。在工程落地层面，开发者可借助代码逻辑或可视化平台，精准配置各执行节点、流转关系及容错机制。</p>
<p>以财务报销审核为例，典型流程可固化为：“提交报销单→AI发票识别→财务初审→部门领导审批→财务打款”，每个环节均绑定专属工具，如发票识别引擎、审批系统API等。</p>
<p>在此框架下，即便具体任务内容存在差异，只要符合既定规则，系统即严格遵循预设逻辑推进，从而显著提升业务合规水平与操作的一致性。</p>
<h3 data-id="heading-2">1.2 Agent 智能体</h3>
<p>Agent 是一种拥有自主决策能力的AI实体，依托大模型的认知与推理机制，灵活掌控任务执行的流程、工具调用的时机与方式，始终占据核心决策地位。相较于工作流中“被动执行”的模式，Agent 构建了完整的“感知-决策-执行-反馈”闭环，能够依据任务推进状态与外部环境的动态变化，实时优化执行路径。</p>
<p>以客户服务场景为例，当用户提出“查询某某订单并修改收货地址”的请求时，Agent 并不依赖预设流程：</p>
<ul>
<li>首先由大模型解析意图，自主判断优先调用订单查询工具以获取当前状态；</li>
<li>若订单尚未发货，则立即触发地址修改工具完成变更；</li>
<li>若订单已发货，则转向物流拦截工具介入，并同步向用户反馈处理结果。</li>
</ul>
<p>在这一过程中，Agent 基于工具返回的实时反馈与用户意图的细微差异，持续迭代执行策略，展现出对复杂、非标准化场景的强适应性。</p>
<h3 data-id="heading-3">1.3 Agentic 系统</h3>
<p>Agentic 系统是通过“智能体化”架构，融合大模型、工具与执行流程，实现任务自动化或半自动化运作的体系。其本质不在于“是否具备自主决策能力”，而在于“以智能体为中枢，协同各类资源以达成目标”，因此，无论是静态预设的工作流，还是具备动态判断能力的 Agent，均属 Agentic 系统范畴。</p>
<p>构建 Agentic 系统的关键准则：‌精简工作流，杜绝非必要复杂度‌。</p>
<p>在实际部署中，需依业务特性权衡“‌标准化‌”与“‌自主性‌”：</p>
<ul>
<li>针对规则清晰、流程稳定的环节，优先采用‌工作流‌提升执行效率；</li>
<li>面对情境多变、依赖经验判断的场景，启用‌Agent 的自主决策‌增强适应性；</li>
</ul>
<p>小结：节点泛滥、分支冗余或过度依赖自主逻辑，将显著削弱系统可控性，抬高故障排查成本。因此，Agentic 系统中的每个组件，都应是‌简洁且不可替代‌的。</p>
<h2 data-id="heading-4">二、Agentic 系统中的工作流</h2>
<h3 data-id="heading-5">2.1 增强型LLM</h3>
<p>当裸模型的内在知识不足以应对任务需求时，可通过引入外部搜索、工具调用与辅助记忆来补足能力缺口。此时，大模型必须具备自主决策工具使用的能力——包括判断是否需检索外部信息、是否需激活特定工具，以及选择适配的工具类型，最终将获取的多元信息进行融合与重构，生成精准且上下文契合的响应。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5075aacc316d4f3b94898d619ef80f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=tRQ3ZrEKba7XNrUIowdhNY3lsvk%3D" alt="图片" loading="lazy"/></p>
<p>增强型LLM 工作流</p>
<p>在工程落地过程中，有两个核心要点：</p>
<ul>
<li>无需调用全部工具，应依据实际业务场景做精简适配。</li>
<li>为大模型设计轻量、直观的交互接口，例如MCP接口协议。</li>
</ul>
<h3 data-id="heading-6">2.2 提示词链接 Prompt chaining</h3>
<p>大模型将复杂任务分解为一系列轻量级、可执行的子任务，各子任务按依赖关系串行推进，前序任务的输出作为后续任务的输入。为避免任一子任务异常导致流程中断，需对关键节点的输出结果实施校验机制，仅当校验通过时才触发下一阶段执行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f79a71049bc3448ea05382759692feff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=%2FJFBvvvOrw%2FAzxxLHDb3v3VIxtE%3D" alt="图片" loading="lazy"/></p>
<p>提示词链接工作流</p>
<p>适用场景：</p>
<p>输入的任务可被明确、高效地拆解为一系列标准化的子任务。主任务通过协同调用多个轻量级子任务实现，该策略以适度增加处理时长为代价，显著提升整体任务的执行精度与可靠性。</p>
<p>示例1：关键合同条款的合规审查‌</p>
<p>子任务 1：提取合同核心条款（校验：条款提取完整性）→ 子任务 2：比对合规库规则 → 子任务 3：生成风险标注报告</p>
<p>任务1至3按序执行，确保审查流程无断点、无遗漏。</p>
<p>示例2：产品说明书摘要生成‌</p>
<p>子任务 1：拆分说明书章节内容 → 子任务 2：提取各章节核心信息（校验：信息无偏差）→ 子任务 3：整合摘要并优化表述</p>
<p>三阶段流水线作业，保障摘要内容精准、凝练、语义一致。</p>
<h3 data-id="heading-7">2.3 路由 Routing</h3>
<p>路由的本质可通俗理解为“分流”——依据任务类型将其分派至对应的处理路径。在实际应用中，可将各类场景任务划分为不同类别，并为每一类定制专属的 prompt，以实现效果最大化。这类路由设计的典型特征在于：当针对单一 prompt 进行调优时，往往引发“类别互损”效应，即提升某一类别的性能，反而会导致其他类别表现下滑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fea8313c77d47be8285b17ef7f6bb29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=j57siJRSxstDgVaF838MTQbGp2U%3D" alt="图片" loading="lazy"/></p>
<p>路由工作流</p>
<p>适用场景：</p>
<p>该场景下的问题或任务，具备清晰的分类维度与结构化类别体系，各分类间界限分明。通过路由划分后，每一类均可获得针对性优化，从而显著提升处理精度。</p>
<p>举例1：</p>
<p>客户咨询路由。依据 “订单问题 / 售后问题 / 产品咨询” 进行分流，订单类触发订单查询工具调用 Prompt，售后类启用纠纷应对话术 Prompt，分类明确、专属策略保障响应更精准。</p>
<p>举例2：</p>
<p>文档处理路由。区分 “合同 / 简历 / 报表” 三类，合同场景部署合规性校验 Prompt，简历场景启用结构化信息抽取 Prompt，规避单一 Prompt 覆盖多场景引发的性能衰减。</p>
<h3 data-id="heading-8">2.4 并行 Parallelization</h3>
<p>核心逻辑：大模型将原始任务分解为若干彼此独立的子任务，并行启动执行，最终融合来自多条路径的输出结果。</p>
<p>其机制涵盖两种模式 — ‌sectioning‌（任务拆分并行）与 ‌voting‌（多结果投票择优）。</p>
<p>具备两大鲜明特征：</p>
<ul>
<li>sectioning：任务可被划分为相互无依赖、支持并行处理的子单元</li>
<li>voting：通过执行多次任务，生成多样化的输出结果</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/499b955307f747d9912beb9f91241858~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=YFpjkjsUw3Gdm5lKD5ge5IzG8Bs%3D" alt="图片" loading="lazy"/></p>
<p>任务并行工作流</p>
<p>适用场景：</p>
<ul>
<li>将复杂任务分解为彼此独立的子任务，实现并行处理。</li>
<li>针对单一任务，从多个分析维度同步推进，最终通过多数表决机制确定最优结论。</li>
</ul>
<p>举例1：</p>
<p>多区域用户反馈汇总。把“全平台用户反馈分析”划分为北京、上海、广州等互不关联的区域子任务，同步抓取各地方核心诉求，再统一汇总统合为全国性反馈报告，显著提升处理效率。</p>
<p>举例2：</p>
<p>文本情感倾向判定。对同一段用户评论，同时启动3个独立的情感分析模块（分别基于词典匹配、语义模型、历史案例比对），当至少两个模块判定为“负面”时，最终结论即为负面情感，借助投票机制有效抑制单一方法的误判风险。</p>
<h3 data-id="heading-9">2.5 编排工作者 Orchestrator-workers</h3>
<p>核心逻辑：在此种工作流中，有一个中心控制的LLM，动态的拆解任务并将其编排到特定的工作模型或工具中，最后进行结果的综合输出。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb6ee37faf254179a47aeccdb805dce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=vZHmpXeaa%2FBjw8fLH4s4ElvlAEU%3D" alt="图片" loading="lazy"/></p>
<p>编排工作者的工作流。</p>
<p>适用场景</p>
<p>对于复杂任务，无法预先划分为清晰的子任务，必须采用“边走边看”的方式动态调整任务结构。尽管这与并行工作流表面相似，但本质差异在于：并行工作流的子任务是事先可知且固定编排的，而编排者工作流则需在执行过程中实时生成新的任务节点。</p>
<p>举例1：</p>
<p>定制化旅行方案规划。中心 LLM 首先锁定用户核心诉求（亲子、预算、时长），初步划分 “目的地筛选、行程串联” 两个关键环节；在推进过程中，依据景点实时开放状态、突发天气变化，即时衍生出新任务（如重新排序游览顺序、插入替代性景点），而非在初始阶段就锁定全部子任务清单。</p>
<h3 data-id="heading-10">2.6 评估者-优化者 Evaluator-optimizer</h3>
<p>核心逻辑：由生成者输出方案，评估者依据清晰标准进行评分并提供优化建议。</p>
<p>该流程中并存生成者与评估者：生成者提出方案，评估者对其实施评判与反馈；若达标则直接交付，若未达标则予以驳回，并基于反馈迭代重生成，构建“生成 - 评估 - 优化”闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6233299727c84537abfc1f84d91b553a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=wM3PW1ApyUEqTlY6Q%2F2AZtINFjM%3D" alt="图片" loading="lazy"/></p>
<p>评估者-优化者 工作流</p>
<p>适用场景：</p>
<p>核心机制‌：输出质量可通过标准化评估与迭代优化持续提升，大模型具备自主生成改进建议的能力。</p>
<p>关键特征‌：</p>
<p>评估标准清晰可量化，反馈意见具体可操作</p>
<p>每轮迭代均基于前次反馈定向优化，形成闭环提升路径</p>
<p>案例重构‌：</p>
<p>营销文案生成‌</p>
<p>生成者输出推广文本，评估者依据 卖点突出度、语气适配性、合规性 三项指标评分，指出：“应强化产品核心功能表达，语言风格需更契合年轻用户语境”；生成者据此调整文案并重新提交，经多轮反馈-修正，直至满足全部评估维度。</p>
<p>代码片段编写‌</p>
<p>生成者提供初始代码，评估者从 语法正确性、执行效率、可读性 三个维度进行审查，反馈：“存在冗余循环结构，建议优化时间复杂度”；生成者依据建议重构算法，再次送评，循环执行直至达成预设标准。</p>
<h3 data-id="heading-11">2.7 自主智能体Agent</h3>
<p>核心逻辑‌：以用户指令或任务为起点，智能体自主构建执行路径。</p>
<p>若指令明确，智能体可独立规划并完成任务；若指令模糊，或执行中需补充信息以辅助决策，则需在任务启动或推进阶段与用户交互，获取必要反馈。</p>
<p>任务执行中，信息的精准性至关重要，工具的调用不可或缺。因此，构建完备的工具集并设计简洁直观的接口，是系统设计的关键环节。</p>
<p>针对复杂任务，必须设定终止条件，避免大模型陷入“自证”循环而无法收敛。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bc7b28e82464ce8909ddea66515409f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=MVT9PG1aHEPfmGYHNy1iflo3oV8%3D" alt="图片" loading="lazy"/></p>
<p>智能体工作流</p>
<p>适用场景：</p>
<ul>
<li>开放性问题的求解路径无法提前预设，不存在标准化的解题流程。</li>
<li>大模型需通过多轮迭代逐步拆解任务目标。</li>
</ul>
<p>为支撑上述过程，必须内置容错机制；而沙盒环境正是自主Agent落地的核心支撑——它为Agent提供独立且隔离的运行空间，使其在调用工具、执行操作时完全隔绝于真实业务系统，既可规避误删数据、违规调用接口等风险，又能高效支持决策流程的调试与可观测性。</p>
<p>举例1：企业智能运营助手‌</p>
<p>当用户下达指令“优化本月电商店铺转化率”时，Agent不依赖预设步骤：首先调用店铺后台工具获取流量与转化数据→识别出详情页跳出率异常，主动向运营人员确认页面修改权限→随后调用竞品分析工具提取竞品核心卖点→最终生成优化方案。</p>
<p>当迭代次数达到3轮，或转化率提升目标达成时，系统自动终止流程，杜绝无休止优化。所有操作均在沙盒环境中完成，数据查询、方案生成等行为均不干扰真实店铺的运营状态。</p>
<h2 data-id="heading-12">三、开源工作流框架</h2>
<p>当前主流的Agent框架普遍以工作流为设计基点，典型代表包括N8N、Dify与Coze。</p>
<p>• ‌N8N‌</p>
<p>作为跨系统任务的流程编排中枢，N8N通过可视化节点将API调用、数据库交互、消息推送、文件操作等标准化任务封装为可复用模块。用户仅需拖拽节点、配置参数，即可串联出自动化流水线。</p>
<p>AI在此体系中并非核心驱动力，而是作为可插拔的“处理单元”嵌入既有流程。其核心竞争力在于强大的异构系统连接能力，使AI能力得以无缝融入企业已有的自动化链路，而非独立构建智能行为。</p>
<p>• ‌Dify‌</p>
<p>聚焦于大模型的“功能化落地”，Dify致力于实现AI原生应用从0到1的完整构建。其提供涵盖模型接入、Prompt工程、知识库构建、前后端部署的一体化工具链，本质是将“AI+业务逻辑”封装为可交付的应用产品。</p>
<p>以构建“客服问答机器人”为例，Dify可一站式完成数据导入、提示词优化、流程编排与上线发布，并支持插件扩展，满足深度集成大模型的开发需求。</p>
<p>在此模式下，工作流并非终点，而是承载AI能力的“骨架”——Dify提供的，是端到端的AI应用开发生命周期，远超基础流程串联。</p>
<p>• ‌Coze‌（扣子）</p>
<p>由字节跳动推出，Coze以“自然语言驱动”为核心交互范式，融合“对话指令”与“可视化编排”双模式：用户可直接用口语描述需求，系统自动映射为工作流；亦可手动微调节点细节。其最大优势在于深度整合字节生态，实现轻量化快速闭环。</p>
<p>例如，仅需一句指令：“读取飞书文档→AI提取要点→生成思维导图→推送至飞书聊天窗”，即可自动完成全流程，无需手动配置参数，全靠生态插件能力实现零摩擦衔接。</p>
<p>小结：</p>
<p>从Workflow与Agent融合构建Agentic系统的视角看：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679343c2d5c74c4b8d1da4bfbed45cf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610284&amp;x-signature=VnuR0zefklT3rCO72ErPXtE28b0%3D" alt="图片" loading="lazy"/></p>
<p>选型建议：</p>
<p>需打通多系统自动化 → 选 ‌N8N‌</p>
<p>要深度开发AI原生应用 → 选 ‌Dify‌</p>
<p>在字节生态内快速构建轻量Agent → 选 ‌Coze‌</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude、Codex、Trae... 都在做：为什么 "Skill" 成了 AI 编程工具的标配？]]></title>    <link>https://juejin.cn/post/7597640029574709299</link>    <guid>https://juejin.cn/post/7597640029574709299</guid>    <pubDate>2026-01-21T14:40:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640029574709299" data-draft-id="7597699796200079370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude、Codex、Trae... 都在做：为什么 &quot;Skill&quot; 成了 AI 编程工具的标配？"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-21T14:40:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude、Codex、Trae... 都在做：为什么 "Skill" 成了 AI 编程工具的标配？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:40:19.000Z" title="Wed Jan 21 2026 14:40:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Code Skill 工作机制：一种带执行能力的结构化 RAG</h2>
<p>这篇文章不讲怎么写 Skill（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills" target="_blank" title="https://code.claude.com/docs/en/skills" ref="nofollow noopener noreferrer">官方文档</a>写得够清楚了），而是从底层拆解 Skill 到底是怎么工作的，以及它和 RAG、MCP 这些概念的本质区别。</p>
<hr/>
<h3 data-id="heading-1">Skill 是什么</h3>
<p>一句话：<strong>Skill 是一个目录，里面放着 SKILL.md 文件和可选的辅助文件（脚本、模板、参考文档）</strong>。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md           <span class="hljs-comment"># 核心指令（必须）</span>
├── REFERENCE.md       <span class="hljs-comment"># 详细参考（可选）</span>
├── EXAMPLES.md        <span class="hljs-comment"># 示例集（可选）</span>
└── scripts/
    └── helper.py      <span class="hljs-comment"># 辅助脚本（可选）</span>
</code></pre>
<p>SKILL.md 的格式很简单，就是一个带 frontmatter 的 Markdown：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-review</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">代码审查技能，用于分析代码质量、安全漏洞、性能问题。</span>
             <span class="hljs-string">说"审查代码"、"review</span> <span class="hljs-string">this"、"检查一下这段代码"时自动激活。</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># 代码审查</span>

<span class="hljs-comment">## 审查流程</span>

<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">先看整体结构</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">检查安全问题</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">分析性能瓶颈</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">提出改进建议</span>

<span class="hljs-comment">## 检查清单</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">是否有硬编码的密钥</span>
<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">是否有</span> <span class="hljs-string">SQL</span> <span class="hljs-string">注入风险</span>
<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">是否有</span> <span class="hljs-string">N+1</span> <span class="hljs-string">查询</span>
<span class="hljs-string">...</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">核心机制：渐进式信息公开</h3>
<p>Skill 的设计基于一个核心理念：<strong>不要一次性把所有内容塞进上下文，按需加载</strong>。</p>
<p>Anthropic 把这叫做 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fskills" target="_blank" title="https://www.anthropic.com/news/skills" ref="nofollow noopener noreferrer">Progressive Disclosure</a>（渐进式信息公开），分三层：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-attr">Level 1:</span> <span class="hljs-string">元数据层（启动时）</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">只加载</span> <span class="hljs-string">name</span> <span class="hljs-string">和</span> <span class="hljs-string">description</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">每个</span> <span class="hljs-string">Skill</span> <span class="hljs-string">约</span> <span class="hljs-number">50</span><span class="hljs-number">-100</span> <span class="hljs-string">tokens</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">用于语义匹配，决定是否激活</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────┘</span>
                          <span class="hljs-string">↓</span>
                    <span class="hljs-string">用户请求触发匹配</span>
                          <span class="hljs-string">↓</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-attr">Level 2:</span> <span class="hljs-string">指令层（任务相关时）</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">加载完整的</span> <span class="hljs-string">SKILL.md</span> <span class="hljs-string">内容</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">约</span> <span class="hljs-number">2</span><span class="hljs-string">-5K</span> <span class="hljs-string">tokens</span>                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">包含核心流程、检查清单、最佳实践</span>                     <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────┘</span>
                          <span class="hljs-string">↓</span>
                    <span class="hljs-string">执行过程中发现需要更多信息</span>
                          <span class="hljs-string">↓</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Level</span> <span class="hljs-number">3</span><span class="hljs-string">+:</span> <span class="hljs-string">资源层（按需）</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">加载引用的文件：REFERENCE.md、scripts/helper.py</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">只在实际需要时读取</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">可以是无限深度的文件树</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────┘</span>
</code></pre>
<p>这个设计解决了一个实际问题：<strong>你可以有几十甚至上百个 Skill，但不会把上下文撑爆</strong>。</p>
<p>启动时只加载元数据，假设你有 50 个 Skill，每个 50 tokens，总共也就 2500 tokens。真正干活的时候，只加载用得上的那个 Skill 的完整内容。</p>
<hr/>
<h3 data-id="heading-3">触发机制：语义匹配</h3>
<p>Skill 不是靠关键词匹配触发的，而是<strong>语义匹配</strong>。</p>
<p>这意味着：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 以下请求都能触发同一个代码审查 Skill</span>
<span class="hljs-string">"帮我审查一下这段代码"</span>
<span class="hljs-string">"review this code"</span>
<span class="hljs-string">"这个函数有没有问题"</span>
<span class="hljs-string">"检查一下安全漏洞"</span>
<span class="hljs-string">"看看性能有没有优化空间"</span>
</code></pre>
<p>所以 description 字段极其重要。官方说法是：<strong>description 决定 90% 的触发效果</strong>。</p>
<p>写 description 的诀窍是把可能的触发场景都列出来：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 这样写太模糊，很难触发</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">帮助处理文档</span>

<span class="hljs-comment"># 这样写才有效</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">提取</span> <span class="hljs-string">PDF</span> <span class="hljs-string">文本、填写</span> <span class="hljs-string">PDF</span> <span class="hljs-string">表单、合并</span> <span class="hljs-string">PDF</span> <span class="hljs-string">文件。</span>
             <span class="hljs-string">用于处理</span> <span class="hljs-string">PDF</span> <span class="hljs-string">文档，当用户提到"PDF"、"表单"、</span>
             <span class="hljs-string">"文档提取"</span><span class="hljs-string">、"合并文件"时自动激活。</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">执行流程拆解</h3>
<p>用一个实际场景来说明。假设用户说："帮我审查一下这段代码，看看有没有安全问题"。</p>
<p><strong>Step 1：语义分析</strong></p>
<p>Claude 分析用户意图，识别出"审查代码"、"安全问题"这些语义。</p>
<p><strong>Step 2：Skill 匹配</strong></p>
<p>对比所有已加载的 Skill description，发现 <code>code-review</code> 这个 Skill 的描述提到了"代码审查"、"安全漏洞"，匹配度最高。</p>
<p><strong>Step 3：加载 SKILL.md</strong></p>
<p>读取 <code>~/.claude/skills/code-review/SKILL.md</code> 的完整内容，注入上下文。</p>
<p><strong>Step 4：执行任务</strong></p>
<p>按照 SKILL.md 里定义的流程执行：</p>
<ul>
<li>先看整体结构</li>
<li>检查安全问题（重点关注）</li>
<li>分析性能瓶颈</li>
<li>提出改进建议</li>
</ul>
<p><strong>Step 5：按需加载补充资料</strong></p>
<p>如果在检查过程中发现需要参考 OWASP Top 10 的详细说明，Claude 会去读取 <code>REFERENCE.md</code> 或者 <code>security-checklist.md</code>。</p>
<p><strong>Step 6：执行脚本（如果有）</strong></p>
<p>如果 Skill 里包含了脚本（比如一个 Python 静态分析工具），Claude 可以直接调用执行，而不是把脚本内容加载到上下文里。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant C as Claude
    participant S as Skill Store
    participant F as 文件系统

    U-&gt;&gt;C: "审查一下这段代码"
    C-&gt;&gt;S: 查询匹配的 Skill
    S--&gt;&gt;C: 返回 code-review (description 匹配)
    C-&gt;&gt;F: 读取 code-review/SKILL.md
    F--&gt;&gt;C: 返回完整指令
    C-&gt;&gt;C: 按流程执行审查

    alt 需要补充资料
        C-&gt;&gt;F: 读取 REFERENCE.md
        F--&gt;&gt;C: 返回参考内容
    end

    alt 需要执行脚本
        C-&gt;&gt;F: 执行 scripts/analyze.py
        F--&gt;&gt;C: 返回执行结果
    end

    C-&gt;&gt;U: 输出审查报告
</code></pre>
<hr/>
<h3 data-id="heading-5">Skill vs RAG：本质区别</h3>
<p>看到这里，你可能觉得 Skill 和 RAG 挺像的：都是根据用户请求检索相关内容，然后注入上下文。</p>
<p>确实有相似之处，但本质区别在于：</p>



































<table><thead><tr><th>维度</th><th>传统 RAG</th><th>Skill</th></tr></thead><tbody><tr><td><strong>内容性质</strong></td><td>参考资料（知识）</td><td>执行指令（方法论）</td></tr><tr><td><strong>触发方式</strong></td><td>被动检索</td><td>主动语义匹配</td></tr><tr><td><strong>加载策略</strong></td><td>Top-K 一次性加载</td><td>三层渐进式加载</td></tr><tr><td><strong>结构</strong></td><td>扁平的文本 chunks</td><td>分层的目录结构</td></tr><tr><td><strong>输出</strong></td><td>增强文本生成</td><td>执行任务 + 调用脚本</td></tr></tbody></table>
<p><strong>RAG 回答的是 "What"（是什么），Skill 回答的是 "How"（怎么做）</strong>。</p>
<p>RAG 会告诉你："React 的 useEffect 是一个副作用 Hook，用于处理组件的副作用..."</p>
<p>Skill 会指导你："审查 React 代码时，按这个流程：1. 检查依赖数组是否正确 2. 是否有内存泄漏 3. 是否滥用 useEffect..."</p>
<p>一个是知识库，一个是方法论库。</p>
<p>如果非要给 Skill 下个定义，我觉得可以叫：<strong>带执行能力的结构化 RAG</strong>。</p>
<ul>
<li><strong>结构化</strong>：不是扁平的文本，是有组织的目录结构</li>
<li><strong>带执行能力</strong>：不只是提供参考，还能执行脚本、调用工具</li>
<li><strong>RAG 的底子</strong>：核心还是"检索 → 注入 → 增强"这套逻辑</li>
</ul>
<hr/>
<h3 data-id="heading-6">Skill vs MCP：分层协作</h3>
<p>另一个容易混淆的概念是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fagents-and-tools%2Fmcp" target="_blank" title="https://docs.anthropic.com/en/docs/agents-and-tools/mcp" ref="nofollow noopener noreferrer">MCP（Model Context Protocol）</a>。</p>
<p>简单说：</p>
<ul>
<li><strong>MCP 是"手"</strong>：让 Claude 能触碰外部世界（数据库、API、文件系统）</li>
<li><strong>Skill 是"技能书"</strong>：教 Claude 怎么做事</li>
</ul>
<p>它们工作在不同的层级：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户请求
<span class="hljs-code">    ↓
┌─────────────────────────────────┐
│  Skill Layer（知识/方法论）       │  ← 教我怎么做
│  - 审查流程、检查清单、最佳实践    │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  LLM 推理层                      │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  MCP Layer（连接/执行）           │  ← 让我能做
│  - 读数据库、调 API、操作文件      │
└─────────────────────────────────┘
    ↓
外部世界
</span></code></pre>
<p>一个实际的例子：</p>
<blockquote>
<p>用户：帮我分析一下数据库里的慢查询</p>
</blockquote>
<p>这个任务需要两者协作：</p>
<ol>
<li><strong>Skill</strong> 提供分析方法论：怎么识别慢查询、常见原因有哪些、优化思路是什么</li>
<li><strong>MCP</strong> 提供连接能力：连接数据库、执行 <code>EXPLAIN</code>、读取查询日志</li>
</ol>
<p>没有 MCP，Claude 连数据库都访问不了；没有 Skill，Claude 可能漫无目的地瞎分析。</p>
<hr/>
<h3 data-id="heading-7">工具限制：allowed-tools</h3>
<p>Skill 有一个特殊能力：可以限制 Claude 在执行该 Skill 时能使用的工具。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">safe-reader</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">只读分析，不修改任何文件</span>
<span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,</span> <span class="hljs-string">Grep,</span> <span class="hljs-string">Glob</span>
<span class="hljs-meta">---
</span></code></pre>
<p>这在某些场景下很有用，而且体现了 <strong>"约束即增强"</strong> 的设计哲学：</p>
<ol>
<li>
<p><strong>防止 Token 浪费与上下文污染</strong>
如果一个负责重构代码的 Skill 能够访问无关的数据库或日志系统，当 AI 遇到阻碍时，很容易"发散注意力"去读取大量无关的大型数据。这不仅浪费 Token，引入的噪音还会降低推理质量。限制工具能强制模型聚焦在当前上下文中解决问题。</p>
</li>
<li>
<p><strong>强制任务聚焦（关注点分离）</strong>
通过限制工具，实际上是在定义 Skill 的"能力边界"，防止越界：</p>
<ul>
<li><strong>架构师 Skill</strong>：可能只允许 <code>list_files</code> 和 <code>read_file</code>，强制它从全局视角分析，而不是陷入具体实现的修改。</li>
<li><strong>数据库专家 Skill</strong>：可能只允许 SQL 相关工具，防止它试图通过修改业务代码来掩盖数据库性能问题。</li>
</ul>
</li>
<li>
<p><strong>安全沙箱</strong>
这是最直观的用途。比如一个用于"新手引导"的 Skill，只允许读取和解释代码，绝不允许执行 <code>write_file</code> 或 <code>run_command</code>，从而实现绝对的安全审计。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">实际案例：我系统里的 Skill</h3>
<p>我本地装了大概 100 多个 Skill，来源有三种：</p>
<p><strong>1. 手动创建的（<code>~/.claude/skills/</code>）</strong></p>
<pre><code class="hljs language-bash" lang="bash">oss-contributor/      <span class="hljs-comment"># 开源贡献规范</span>
mermaid-syntax/       <span class="hljs-comment"># Mermaid 语法参考</span>
</code></pre>
<p><strong>2. 通过 symlink 安装的插件 Skill</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">frontend-design → ~<span class="hljs-regexp">/.claude/</span>plugins/.../frontend-design
postgresql → ~<span class="hljs-regexp">/.claude/</span>plugins/.../postgresql
typescript-advanced-types → ...
</code></pre>
<p><strong>3. 插件自带的（<code>~/.claude/plugins/*/skills/</code>）</strong></p>
<pre><code class="hljs language-bash" lang="bash">superclaude/skills/
├── first-principles/    <span class="hljs-comment"># 第一性原理思维</span>
├── 5-whys/             <span class="hljs-comment"># 5-Why 根因分析</span>
└── confidence-check/   <span class="hljs-comment"># 置信度检查</span>

anthropic-agent-skills/skills/
├── pdf/                <span class="hljs-comment"># PDF 处理</span>
├── xlsx/               <span class="hljs-comment"># Excel 处理</span>
└── pptx/               <span class="hljs-comment"># PPT 处理</span>
</code></pre>
<p>举个实际触发的例子。当我说"从第一性原理分析一下这个架构设计"时：</p>
<ol>
<li>Claude 匹配到 <code>first-principles</code> Skill（description 里有"第一性原理"、"从根本分析"这些词）</li>
<li>加载 SKILL.md，里面定义了五阶段分析流程</li>
<li>按流程输出：问题本质 → 假设挑战 → 基础真理 → 推理链条 → 结论</li>
</ol>
<p>输出格式都是固定的，因为 SKILL.md 里写死了：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## First Principles Analysis: [Topic]</span>

<span class="hljs-section">### 1. Problem Essence</span>
<span class="hljs-strong">**Core problem:**</span> [One sentence]
<span class="hljs-strong">**Success criteria:**</span> [Measurable outcomes]

<span class="hljs-section">### 2. Assumptions Challenged</span>
| Assumption | Challenge | Verdict |
|------------|-----------|---------|
| ... | ... | Keep/Discard/Modify |

<span class="hljs-section">### 3. Ground Truths</span>
<span class="hljs-bullet">-</span> [Irreducible fact 1]
<span class="hljs-bullet">-</span> [Irreducible fact 2]

<span class="hljs-section">### 4. Reasoning Chain</span>
Ground Truth → [Step 1] → [Step 2] → Solution

<span class="hljs-section">### 5. Conclusion</span>
<span class="hljs-strong">**Recommended approach:**</span> ...
</code></pre>
<p>这就是 Skill 的价值：<strong>把隐性知识变成显性流程，把个人经验变成可复用的能力</strong>。</p>
<hr/>
<h3 data-id="heading-9">开放标准</h3>
<p>值得一提的是，Skill 规范已经发布为开放标准：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io" target="_blank" title="https://agentskills.io" ref="nofollow noopener noreferrer">agentskills.io</a></p>
<p>Anthropic 也在 GitHub 上开源了官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">Skills 仓库</a>，包含文档处理（Excel、PDF、Word、PPT）等预置 Skill。</p>
<p>这意味着同样的 Skill 格式理论上可以在其他 AI 平台使用。当然，目前主要还是 Claude 生态在用。正如 Simon Willison <a href="https://link.juejin.cn?target=https%3A%2F%2Fsimonwillison.net%2F2025%2FOct%2F16%2Fclaude-skills%2F" target="_blank" title="https://simonwillison.net/2025/Oct/16/claude-skills/" ref="nofollow noopener noreferrer">评价的</a>：「Skills 可能比 MCP 更重要」——因为它让 AI 能够学习和复用人类的专业知识和工作流程。</p>
<hr/>
<h3 data-id="heading-10">小结</h3>
<p>Skill 的工作机制可以总结为：</p>
<ol>
<li><strong>启动时</strong>：加载所有 Skill 的元数据（name + description），约 50-100 tokens/个</li>
<li><strong>用户请求时</strong>：语义匹配找到相关 Skill</li>
<li><strong>执行时</strong>：渐进式加载 SKILL.md → 引用文件 → 脚本</li>
<li><strong>能力边界</strong>：可通过 allowed-tools 限制工具使用</li>
</ol>
<p>和其他概念的关系：</p>
<ul>
<li><strong>vs RAG</strong>：Skill 是结构化、可执行、带方法论的 RAG</li>
<li><strong>vs MCP</strong>：Skill 在知识层（教怎么做），MCP 在连接层（让能做）</li>
<li><strong>vs Slash Command</strong>：Skill 自动触发，Command 手动调用</li>
</ul>
<p>写好 Skill 的核心：<strong>把 description 写具体，把触发场景都列出来</strong>。</p>
<hr/>
<h3 data-id="heading-11">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fskills" target="_blank" title="https://www.anthropic.com/news/skills" ref="nofollow noopener noreferrer">Introducing Agent Skills</a> - Anthropic 官方公告</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills" target="_blank" title="https://code.claude.com/docs/en/skills" ref="nofollow noopener noreferrer">Claude Code Skills 文档</a> - 官方使用指南</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fdocs%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://docs.claude.com/en/docs/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">Agent Skills Overview</a> - Claude Docs 详细文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">anthropics/skills</a> - 官方 Skills 仓库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fagents-and-tools%2Fmcp" target="_blank" title="https://docs.anthropic.com/en/docs/agents-and-tools/mcp" ref="nofollow noopener noreferrer">Model Context Protocol</a> - MCP 官方文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io" target="_blank" title="https://agentskills.io" ref="nofollow noopener noreferrer">agentskills.io</a> - Agent Skills 开放标准</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsimonwillison.net%2F2025%2FOct%2F16%2Fclaude-skills%2F" target="_blank" title="https://simonwillison.net/2025/Oct/16/claude-skills/" ref="nofollow noopener noreferrer">Claude Skills are awesome, maybe a bigger deal than MCP</a> - Simon Willison 的深度评论</li>
</ul>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>vibe coding 原理学习</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制（工具调度状态机、流式解析器、MCP 协议握手等）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611219&amp;x-signature=BOluOQs8Mz79s2xMrEDLh04Rzgs%3D" alt="coding-cli-guide" loading="lazy"/></li>
</ul>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#/.NET/.NET Core技术前沿周刊 | 第 66 期（2026年1.12-1.18）]]></title>    <link>https://juejin.cn/post/7597622924273057819</link>    <guid>https://juejin.cn/post/7597622924273057819</guid>    <pubDate>2026-01-21T14:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597622924273057819" data-draft-id="7597699796200144906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#/.NET/.NET Core技术前沿周刊 | 第 66 期（2026年1.12-1.18）"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2026-01-21T14:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#/.NET/.NET Core技术前沿周刊 | 第 66 期（2026年1.12-1.18）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:44:35.000Z" title="Wed Jan 21 2026 14:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24ec61b5b2da4a4a874d43fbd68c8c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611474&amp;x-signature=Qa571idums9qvGkAnpXqarK%2FbqA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>C#/.NET/.NET Core技术前沿周刊，你的每周技术指南针！记录、追踪C#/.NET/.NET Core领域、生态的每周最新、最实用、最有价值的技术文章、社区动态、优质项目和学习资源等。让你时刻站在技术前沿，助力技术成长与视野拓宽。</p>
<blockquote>
<p>欢迎投稿、推荐或自荐优质文章、项目、学习资源等。</p>
</blockquote>
<ul>
<li><strong>🏆技术前沿周刊Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
<li><strong>📰技术前沿周刊GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
</ul>
<h2 data-id="heading-1">如何用 .NET MAUI 构建 Android 小部件</h2>
<ul>
<li><strong>文章简介：</strong> 本博客将介绍之前关于 iOS 小部件的互动小部件的 Android 部分。Android 通常更宽松，作更简单，你可以直接在 Visual Studio 里的 .NET MAUI 项目里构建所有内容。复杂性源于众多可用的任务选项以及需要考虑较旧的安卓版本。就像 iOS 小部件博客里一样，这也不是一步步的教程。相反，它突出显示了你在构建 Android 小部件时通常遇到障碍的顺序中最大且最重要的部分。它从创建一个简单的静态小部件开始，逐步发展成可配置、完全交互的小部件。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fhow-to-build-android-widgets-with-dotnet-maui%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/how-to-build-android-widgets-with-dotnet-maui/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/how-…</a></li>
</ul>
<h2 data-id="heading-2">.NET 和 .NET Framework 2026 年 1 月服务发布更新</h2>
<ul>
<li><strong>文章简介：</strong> 欢迎来到我们 2026 年 1 月的联合.NET 服务更新。让我们进入.NET 和.NET Framework 的最新版本，这里简要介绍一下我们服务版本中的新内容。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fdotnet-and-dotnet-framework-january-2026-servicing-updates%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/dotnet-and-dotnet-framework-january-2026-servicing-updates/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/dotn…</a></li>
</ul>
<h2 data-id="heading-3">如何一步步将 ASP.NET MVC 升级为.NET</h2>
<ul>
<li><strong>文章简介：</strong> 将 ASP.NET MVC 应用从.NET Framework 升级到现代.NET 并不是简单的版本提升。此次迁移代表了运行时、托管模型、配置系统、依赖注入和 HTTP 流水线架构的转变。许多团队低估了这一点，把它当作标准的框架升级，结果在流程后期才发现他们应用中的核心假设已经不再成立。好消息是，Microsoft 提供了明确的指导和模式，使得正确操作时迁移过程可预测。本文介绍了一个实用的逐步策略，如何将基于.NET Framework 构建的 ASP.NET MVC 5 应用迁移到运行在现代.NET 上的 ASP.NET Core，同时最大限度地减少风险和停机时间。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fpowertoolsteam%2Fp%2F19486260" target="_blank" title="https://www.cnblogs.com/powertoolsteam/p/19486260" ref="nofollow noopener noreferrer">www.cnblogs.com/powertoolst…</a></li>
</ul>
<h2 data-id="heading-4">使用 MCP C# SDK 实现 MCP Tool</h2>
<ul>
<li><strong>文章简介：</strong> MCP是由Anthropic创建的一个开放协议 现在有官方 C# SDK 了，官方 C# SDK 由原来的 mcpdotnet 发展而来，基于 Microsoft.Extensions.AI 实现，截止写文章的时候（2025-4-1）目前最新版本时 0.1.0-preview 4 了，这一版本中增加了 ModelContextProtocol.AspNetCore NuGet 包，使得实现基于 ASP.NET Core SSE 的 Mcp Server 更加简单了，之前的版本中需要将示例中的扩展拷贝到自己项目中去，有了这个 NuGet 包之后就不需要了，McpServer 目前主要的两种实现方式是 Stdio(标准输入输出) 和 SSE（Server Sent Event)，新的规范里提出了基于 Http 的支持，目前暂时还未支持</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJSIbOo17zcQrcuCLVWN4XQ" target="_blank" title="https://mp.weixin.qq.com/s/JSIbOo17zcQrcuCLVWN4XQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/JSIbOo17z…</a></li>
</ul>
<h2 data-id="heading-5">一款专为 WinUI XAML 设计的快速原型设计工具，生成的代码可轻松复制到Visual Studio中！</h2>
<ul>
<li><strong>文章简介：</strong> XAML Studio 是一款专为 WinUI XAML 设计的快速原型设计工具，基于 C# 开源（MIT license），生成的代码可轻松复制到 Visual Studio 中的应用中。XAML Studio 让你实时预览 XAML 代码，并与结果互动，就像它在你自己的应用中运行一样。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FKf_MrpoC-I7UbhmUNLusow" target="_blank" title="https://mp.weixin.qq.com/s/Kf_MrpoC-I7UbhmUNLusow" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/Kf_MrpoC-…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3a57d3d03d4290a7f6d1b10f22d2e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611474&amp;x-signature=pY1T4dmmMMV8r3x3lGZOhKc3OAI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">一个致力于为 C# 程序员提供更佳的编码体验和效率的 Visual Studio 扩展插件</h2>
<ul>
<li><strong>文章简介：</strong> Codist 是一个使用 .NET 编写、开源免费的 Visual Studio 扩展插件，致力于为 C# 程序员提供更好的编程体验和生产效率。它不仅强化了语法高亮、快速信息提示、导航栏、滚动条和显示质量，还集成了自动版本号更新、括号自动补全、支持高级编辑功能的智能工具栏、代码分析等功能。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUWuCIY4Q5PJeNClrQWPGEw" target="_blank" title="https://mp.weixin.qq.com/s/UWuCIY4Q5PJeNClrQWPGEw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/UWuCIY4Q5…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/715167d221af4726904f34dabea9de56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611474&amp;x-signature=K2bHitP1lFotlQUyB%2BqKya4kjMc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">基于NetCorePal Cloud Framework的DDD架构管理系统实践</h2>
<ul>
<li><strong>文章简介：</strong> 前段时间在做一个管理系统的项目，想尝试一下DDD架构在实际项目中的应用。经过一番调研，最终选择了NetCorePal Cloud Framework作为基础框架，结合.NET 10和Vue 3搭建了一套完整的前后端分离架构。今天就想和大家分享一下这个项目的架构设计和技术选型，希望能给正在做类似项目的朋友一些参考。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Faishangyipiyema%2Fp%2F19499381" target="_blank" title="https://www.cnblogs.com/aishangyipiyema/p/19499381" ref="nofollow noopener noreferrer">www.cnblogs.com/aishangyipi…</a></li>
</ul>
<p>整个项目采用了经典的三层架构，这个结构应该很多做DDD的朋友都比较熟悉。三层之间的依赖关系是单向的：Web层依赖Infrastructure层，Infrastructure层依赖Domain层，Domain层作为核心，不依赖任何其他层。</p>
<pre><code class="hljs">Ncp.Admin
├── Domain（领域层）
│   ├── AggregatesModel（聚合模型）
│   └── DomainEvents（领域事件）
├── Infrastructure（基础设施层）
│   ├── EntityConfigurations（实体配置）
│   └── Repositories（仓储实现）
└── Web（表现层）
    ├── Application（应用服务层）
    │   ├── Commands（命令）
    │   ├── Queries（查询）
    │   └── DomainEventHandlers（领域事件处理器）
    └── Endpoints（API端点）
</code></pre>
<h2 data-id="heading-8">WPF 使用 HLSL + Clip 实现高亮歌词光照效果</h2>
<ul>
<li><strong>文章简介：</strong> 最近在搓一个Lyricify Lite类似物，原本使用渐变画刷实现歌词高亮，但是发现视觉效果与Apple Music相去甚远：单纯使用白色渐变画刷缺乏“高亮”的光照感觉，而Apple Music的歌词高亮则更像是有光线投射在歌词上，形成一种柔和的发光效果。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2FTwilightLemon%2Fp%2F19497125" target="_blank" title="https://www.cnblogs.com/TwilightLemon/p/19497125" ref="nofollow noopener noreferrer">www.cnblogs.com/TwilightLem…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0c777d815f84359a69b158bd4f2023d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611474&amp;x-signature=wOV9lsFkmdx01apjyLMEMwQRm4s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">基于.NET和C#构建光伏IoT物模型方案</h2>
<ul>
<li><strong>文章简介：</strong> 本文主要介绍基于.NET和C#构建光伏IoT物模型的方案。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Ftianqing%2Fp%2F19490649" target="_blank" title="https://www.cnblogs.com/tianqing/p/19490649" ref="nofollow noopener noreferrer">www.cnblogs.com/tianqing/p/…</a></li>
</ul>
<h2 data-id="heading-10">不服跑个分？.NET 10 大整数计算对阵 Java，结果令人意外</h2>
<ul>
<li><strong>文章简介：</strong> 我对数值计算的执念，来自初中时代烟雾缭绕的网吧。那时玩《伝奇》，最让我着迷的不是打怪爆装备，而是角色面板里那条长长的经验值。看着数字不断跳动、累积，最终“叮”一声升级，那种简单的数值驱动整个世界运转的感觉，实在太奇妙了。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fsdcb%2Fp%2F19484525%2F20261113-big-integer-dotnet-10-vs-java" target="_blank" title="https://www.cnblogs.com/sdcb/p/19484525/20261113-big-integer-dotnet-10-vs-java" ref="nofollow noopener noreferrer">www.cnblogs.com/sdcb/p/1948…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a343b39ed1f4413588effd6e6068d338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611474&amp;x-signature=eL1vY60ViXmMlRbmIky2BIbm1%2Bw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">.NET Aspire 概述</h2>
<ul>
<li><strong>文章简介：</strong> .NET Aspire 是 Microsoft 在 Build 2024 上推出的一个开源框架，旨在简化使用 .NET 8 及更高版本创建分布式云原生应用的流程。它通过提供一套工具、模板和最佳实践，让开发者能够更专注于业务逻辑而非基础设施的搭建。本文将详细介绍 .NET Aspire 的核心功能、优势以及如何快速上手使用这一创新框架。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fpowertoolsteam%2Fp%2F19477015" target="_blank" title="https://www.cnblogs.com/powertoolsteam/p/19477015" ref="nofollow noopener noreferrer">www.cnblogs.com/powertoolst…</a></li>
</ul>
<h2 data-id="heading-12">总结归纳.NET 10 中 Minimal APIs 主要应用场景</h2>
<ul>
<li><strong>文章简介：</strong> 本文主要总结归纳.NET 10 中 Minimal APIs 主要应用场景。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Ftianqing%2Fp%2F19467531" target="_blank" title="https://www.cnblogs.com/tianqing/p/19467531" ref="nofollow noopener noreferrer">www.cnblogs.com/tianqing/p/…</a></li>
</ul>
<h2 data-id="heading-13">C# 14 中的新增功能</h2>
<ul>
<li><strong>文章简介：</strong> C# 14 引入了多项重要更新，以下是主要功能的详细说明。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fnet-kevin-li%2Fp%2F19476883" target="_blank" title="https://www.cnblogs.com/net-kevin-li/p/19476883" ref="nofollow noopener noreferrer">www.cnblogs.com/net-kevin-l…</a></li>
</ul>
<h2 data-id="heading-14">跨越技术鸿沟：Aspire 赋能 JavaScript 与 Node.js 开发者的深度生态融合</h2>
<ul>
<li><strong>文章简介：</strong> 在云原生应用开发的演进历程中，技术栈的异构性始终是一个核心特征。长期以来，企业级应用开发往往呈现出“双模IT”的特征：后端服务依赖于.NET 生态系统的强类型、高性能和企业级稳健性，而前端交互与部分微服务则广泛采用 JavaScript/TypeScript 生态系统的灵活性与庞大社区资源。这种多语言（Polyglot）架构虽然在功能上互补，但在开发运维（DevOps）的“内循环（Inner Loop）”中却制造了显著的摩擦。开发者常常需要在 Visual Studio 的调试器、复杂的 Docker Compose YAML 文件、散乱的 Shell 脚本以及手动维护的 .env 环境变量文件之间频繁切换。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fshanyou%2Fp%2F19474912" target="_blank" title="https://www.cnblogs.com/shanyou/p/19474912" ref="nofollow noopener noreferrer">www.cnblogs.com/shanyou/p/1…</a></li>
</ul>
<h2 data-id="heading-15">.NET 磁盘管理-技术方案选型</h2>
<ul>
<li><strong>文章简介：</strong> 在家庭以及企业场景下的网络磁盘产品，使用Iscsi均需要对磁盘进行管理。不同Windows版本、安装第三方软件，导致每个C端用户的运行环境不同，对磁盘的管理带来一定的使用干扰，本文介绍下磁盘管理的几种方案以及存在的一些问题。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fkybs0%2Fp%2F19473484" target="_blank" title="https://www.cnblogs.com/kybs0/p/19473484" ref="nofollow noopener noreferrer">www.cnblogs.com/kybs0/p/194…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[直面Oracle国产化替代的典型陷阱与攻坚策略]]></title>    <link>https://juejin.cn/post/7597623395908206638</link>    <guid>https://juejin.cn/post/7597623395908206638</guid>    <pubDate>2026-01-21T14:45:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623395908206638" data-draft-id="7597622924273074203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="直面Oracle国产化替代的典型陷阱与攻坚策略"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-21T14:45:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            直面Oracle国产化替代的典型陷阱与攻坚策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:45:56.000Z" title="Wed Jan 21 2026 14:45:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Oracle数据库迁移实战</h2>
<p>KingbaseES 集成了丰富的 Oracle 兼容特性，这在实际迁移场景中通常只需对原导出脚本进行少量调整，甚至在全功能兼容时无需修改。此外，系统还支持使用 KDTS、KFS 等多种辅助工具，进一步简化迁移流程。</p>
<p>本节将详细说明将实际应用中的 Oracle 数据库迁移至 KingbaseES 的整体步骤，重点介绍迁移的核心内容与关键环节。</p>
<h3 data-id="heading-1">主要迁移内容</h3>
<p>在实际的迁移工作中，从Oracle到KingbaseES的迁移是一个系统工程，主要涵盖数据库、用户、数据和应用程序四大环节。这些环节必须遵循严格的先后顺序执行，否则极易因依赖关系缺失而导致迁移中断。其核心逻辑在于：数据库作为对象的容器，与用户（对象的管理者）共同构成了数据迁移的基础环境，因此必须先行迁移。而应用程序的迁移，则必须建立在对数据库对象（如表、视图、存储过程等）的迁移完成并验证之后，因为应用程序的代码正是基于这些对象进行访问和操作的。</p>
<p><strong>数据库、用户和模式迁移</strong></p>
<p>启动目标数据库后，在目的数据库KingbaseES上创建与源数据库Oracle同名的数据库、用户,并授予新建用户使用该数据库和新建模式的权限。</p>
<p>另外，所创建数据库的字符集应与Oracle数据库字符集一致。如果KingbaseES已有同名数据库，则登录该数据库后，则只需创建同名用户。</p>
<p><strong>Oracle数据迁移</strong></p>
<p>确定使用在线迁移还是离线迁移，根据不同需要制定不同给的迁移策略，使用KDTS 和 KFS 完成数据库迁移。</p>
<p><strong>应用程序移植</strong></p>
<p>应用程序移植是指将Oracle API方式或嵌入式SQL方式的应用程序迁移至KingbaseES。它主要包括接口驱动程序和连接方法的迁移，以及Oracle扩展或私有的、且KingbaseES未兼容的API迁移。通常，该项任务的工作量较少。</p>
<p>在实际应用中，应用程序迁移与移植系统测试与调试通常交叉进行。</p>
<h3 data-id="heading-2">关键迁移步骤</h3>
<p>应用系统从Oracle数据库迁移至KingbaseES数据库需要健全的项目团队和全面细致的项目执行过程。通常，将一个Oracle数据库迁移至KingbaseES主要包括迁移评估、 迁移准备、 数据迁移、 应用迁移和测试与调试迁移后的系统5个步骤。</p>
<p>迁移评估包含确定迁移目标、 评估迁移任务、 组建迁移团队三个阶段，迁移准备需要准备好迁移环境并进行数据库和用户迁移。</p>
<p>下面，分别对上述各个步骤进行详细说明。</p>
<h4 data-id="heading-3">迁移评估</h4>
<p><strong>确定迁移目标</strong></p>
<p>开始迁移前，应根据用户的实际需求，确定迁移目标。这些目标诸如：</p>
<ul>
<li>迁移Oracle数据库的规模。</li>
<li>迁移Oracle数据库对象的种类和特征，如简单和复杂迁移对象所占比例等。</li>
<li>迁移的难易程度，如是否迁移大对象，是否迁移大量约束等。</li>
<li>迁移的工期要求。</li>
<li>迁移中业务系统是否可以处于停止服务状态。</li>
<li>对目标系统的技术指标要求，诸如平台、版本、应用编程接口、工具、可用性、安全性和性能指标要求等。</li>
</ul>
<p>明确迁移目标以后，即可开始迁移任务评估。</p>
<p><strong>评估迁移任务</strong></p>
<p>迁移前对迁移的可行性、工作量、难易程度和工作进度等进行充分评估是为了降低迁移过程中的未知风险。通常，迁移评估主要包括以下内容：</p>
<ul>
<li>迁移技术指标，如迁移业务压力和性能指标等。</li>
<li>迁移数据规模，如迁移各类数据库对象的数量，PL/SQL程序的规模等。</li>
<li>迁移中KingbaseES不支持功能的种类和数量。</li>
<li>迁移的约束种类和数量。</li>
<li>迁移过程中可能遇到的其他问题。</li>
</ul>
<p>在Oracle迁移中常用的评估模板如下表所示：</p>













































































<table><thead><tr><th align="left"><strong>项目</strong></th><th align="left"><strong>描述</strong></th></tr></thead><tbody><tr><td align="left">Oracle数据库版本</td><td align="left">8.1.7.4</td></tr><tr><td align="left">操作系统版本</td><td align="left">Windows 2000/2003 Server</td></tr><tr><td align="left">服务器型号 CPU配置 内存（RAM） 磁盘（Disk Profile）</td><td align="left">联想/SUN</td></tr><tr><td align="left">服务器个数（# of Servers）</td><td align="left">1或2</td></tr><tr><td align="left">用户数/天（# Users/Day） 事务量/天（# Transactions /Day）</td><td align="left">几十/天</td></tr><tr><td align="left">当前数据库大小 数据库增长速率（#GB/month）目标用户（Schema）</td><td align="left">几个GB</td></tr><tr><td align="left">应用方式（OLTP/OLAP）</td><td align="left">OLTP</td></tr><tr><td align="left">应用服务器（中间件）</td><td align="left">无</td></tr><tr><td align="left">客户端应用类型 （C/S，B/S）</td><td align="left">C/S</td></tr><tr><td align="left">客户端应用编程语言</td><td align="left">Delphi7</td></tr><tr><td align="left">客户端应用连接接口</td><td align="left">ODAC/ADO</td></tr><tr><td align="left">是否深入SQL应用</td><td align="left">无</td></tr><tr><td align="left">监控工具</td><td align="left">无</td></tr><tr><td align="left">备份方式</td><td align="left">Exp/imp</td></tr><tr><td align="left">其它工具（备份软件等）</td><td align="left">无</td></tr><tr><td align="left">高可用要求</td><td align="left">较高</td></tr><tr><td align="left">高可用配置方案</td><td align="left">VCS或单机</td></tr></tbody></table>





























<table><thead><tr><th align="left"><strong>项目</strong></th><th align="left"><strong>描述</strong></th></tr></thead><tbody><tr><td align="left">迁移分析日期</td><td align="left">20220105下午</td></tr><tr><td align="left">迁移分析人员KingbaseES版本</td><td align="left">ABC</td></tr><tr><td align="left">Oracle 版本 OracleSchema</td><td align="left">11.1.7.4</td></tr><tr><td align="left">Oracle DB Size (GB)</td><td align="left">几个GB</td></tr><tr><td align="left">Oracle Schema Size (MB)</td><td align="left">几个GB</td></tr></tbody></table>


























































































<table><thead><tr><th align="left"><strong>类型</strong></th><th align="left"><strong>小计</strong></th><th align="left"><strong>备注</strong></th></tr></thead><tbody><tr><td align="left">Function</td><td align="left">7</td><td align="left">较少用</td></tr><tr><td align="left">Index</td><td align="left">有</td><td align="left"/></tr><tr><td align="left">LOB</td><td align="left">有</td><td align="left">最大到几十MB，主要是照片、word、视频（较少）</td></tr><tr><td align="left">Materialized View</td><td align="left">有&gt;10</td><td align="left"/></tr><tr><td align="left">Procedure</td><td align="left">25</td><td align="left"/></tr><tr><td align="left">Sequence</td><td align="left">有&gt;10</td><td align="left"/></tr><tr><td align="left">Table</td><td align="left">1660</td><td align="left">约束较多</td></tr><tr><td align="left">Table Partition</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">Trigger</td><td align="left">&lt;30</td><td align="left"/></tr><tr><td align="left">JOB</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">Package</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">Package Body</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">Type</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">View</td><td align="left">&gt;200</td><td align="left"/></tr><tr><td align="left">Synonym</td><td align="left">&gt;300</td><td align="left"/></tr><tr><td align="left"><strong>对象共计</strong></td><td align="left"/><td align="left"/></tr></tbody></table>








































<table><thead><tr><th align="left"><strong>类型</strong></th><th align="left"><strong>小计</strong></th><th align="left"><strong>备注</strong></th></tr></thead><tbody><tr><td align="left">CHECK OR NOT NULL</td><td align="left"/><td align="left"/></tr><tr><td align="left">FOREIGN KEY</td><td align="left"/><td align="left"/></tr><tr><td align="left">PRIMARY KEY</td><td align="left"/><td align="left"/></tr><tr><td align="left">UNIQUE KEY</td><td align="left"/><td align="left"/></tr><tr><td align="left">OTHER</td><td align="left"/><td align="left"/></tr><tr><td align="left"><strong>约束共计</strong></td><td align="left"/><td align="left"/></tr></tbody></table>


























































































<table><thead><tr><th align="left"><strong>特性</strong></th><th align="left"><strong>小计</strong></th><th align="left"><strong>备注</strong></th></tr></thead><tbody><tr><td align="left">数据压缩</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">索引组织表</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">维度（Dimensions）</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">物化视图</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">存储概要</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">高级队列</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">空间数据管理</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">全文搜索</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">数据库链接</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">数据复制</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">RAC</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">逻辑Standby</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">物理Standby</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">自动存储管理 ASM</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">自动工作负载信息库 AWR</td><td align="left">无</td><td align="left"/></tr><tr><td align="left">共计</td><td align="left"/><td align="left"/></tr></tbody></table>
<p><strong>组建迁移团队</strong></p>
<p>Oracle数据库迁移团队的成员至少应具备以下的知识与技能：</p>
<ul>
<li>熟悉Oracle和KingbaseES的SQL语言和PL/SQL语言特性，以及相关的KingbaseES Oracle兼容特性。</li>
<li>熟悉Oracle和KingbaseES的各种应用编程接口，以及相关的KingbaseES Oracle兼容特性。</li>
<li>熟悉Oracle和KingbaseES的相关客户端工具，以及这些工具间的相同点和异同点。</li>
</ul>
<h4 data-id="heading-4">迁移准备</h4>
<p><strong>准备迁移环境</strong></p>
<p>在完成迁移评估后，迁移工程师需要开始准备迁移环境，这些准备工作诸如：</p>
<p><strong>部署目的数据库服务器</strong> ， 部署目的数据库服务器应遵循以下原则：</p>
<ul>
<li>目的数据库服务器的CPU、内存、网络环境等硬件应尽量采用较高的配置。</li>
<li>如果需要迁移的Oracle数据库系统规模较大，如超过1GB，则建议把Oracle和KingbaseES部署在不同的物理机器上。</li>
<li>为确保迁移效率，应尽量把KingbaseES和Oracle服务器部署到同一局域网内。</li>
</ul>
<p><strong>获取并安装必要的软件</strong> ， 迁移前应获取并安装如下软件：Oracle数据库系统、KingbaseES数据库系统、PL/SQL Developer、JDBC和ODBC驱动程序、C语言开发工具、OCI软件、DCI软件、TPC-C测试工具、LoadRunner等。</p>
<p>如果迁移数据规模较大，建议对安装的KingbaseES数据库服务器进行适当的优化，如增大<em>shared_buffer</em>大小、预先创建较大的日志文件，预先申请足够的表空间数据库文件等。</p>
<p>完成上述准备工作后，迁移工程师便可开始Oracle数据库迁移工作了。</p>
<p><strong>获取 Oracle数据库的相关信息</strong> ， 迁移前，应获取源数据库Oracle服务名及迁移的数据规模信息。其中，前者用于PL/SQL Developer工具的登录操作，后者用于估算数据迁移时间和设计迁移方案。</p>
<ol>
<li>Oracle数据库基本信息</li>
</ol>
<p>获取源Oracle数据库的：</p>
<ol>
<li>IP地址</li>
<li>实例名</li>
<li>网络服务端口号</li>
<li>用户名/密码</li>
</ol>
<p>在目标KingbaseES上：</p>
<ol>
<li>创建与源Oracle用户（如scott）同名的用户（scott）。</li>
<li>创建与源Oracle（如ORCL）同名的数据库（ORCL），属主为scott。</li>
<li>创建与源Oracle（与用户名相同t）同名的模式scott，属主为scott。</li>
<li>查询Oracle数据库编码方式</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">select userenv('language') from dual;
      USERENV('LANGUAGE')
  SIMPLIFIED CHINESE_CHINA.ZHS16GBK
</code></pre>
<ol>
<li>查看表数据量大小</li>
</ol>
<p>查看当前用户在Oracle中的表大小，按从大到小排序（单位GB）。</p>
<pre><code class="hljs language-plain" lang="plain">select segment_name,bytes/1024/1024/1024 from user_segments where segment_type='TABLE' order by bytes desc ;
XFJXX 16.046875
XFRXX 7.779296875
PCK      7.4375
BLFSXX   5.0625
XFSXXX   2.3125
DFGZXX   1.3359375
FJB      0.53125
TSJXX 0.078125
</code></pre>
<ol>
<li>检查数据库日期格式</li>
</ol>
<p>时间的默认格式为：ISO, MDY</p>
<p>在配置文件中添加：datestyle ='ISO,YMD' 修改为年月日的格式（99会改为1999）</p>
<p>在某项目中迁移数据时遇到：服务器报错，迁移工具中断，迁移停滞</p>
<p>oracle数据库中有日期“0099-09-30 00:00:00”，迁移工具输出为“99-09-30 00:00:00”，KingbaseES中将99识别为月份报错：ERROR: date/time field value out of range</p>
<pre><code class="hljs language-plain" lang="plain">--即使没有报错也会出现错误
set ora_date_sytle = true;
CREATE TABLE T_DATE(COL DATE);
INSERT INTO T_DATE VALUES('11-10-10 10:10:10');
SELECT * FROM T_DATE;
    COL         
---------------------
2010-11-10 10:10:10
(1 row)
</code></pre>
<p><strong>配置KingbaseES的Oracle兼容开关</strong> ， 根据实际情况，应对目的数据库KingbaseES进行适当的Oracle兼容配置。通常，应配置以下会话级兼容参数：</p>
<p>1） <em>nls_length_semantics</em>：设定<em>char</em>类型字段默认单位是<em>byte</em>还是<em>char</em>。此外，标识符最大长度以此值为单位。如果它为<em>char</em>，则标识符最大长度为63个<em>char</em>，否则为63<em>byte</em>。</p>
<p>在KingbaseES系统参数 <em>nls_length_semantics</em> 缺省值是"CHAR"，需要与待迁移的Oracle相同。</p>
<p>Oracle字符类型的 byte|char 属性的默认值是由 Oracle 提供的数据库参数 <em>NLS_LENGTH_SEMANTICS</em> 决定的，可通过下方语句进行查询：</p>
<pre><code class="hljs language-plain" lang="plain">select value from nls_database_parameters where parameter = 'NLS_LENGTH_SEMANTICS';
VALUE
BYTE
</code></pre>
<p>如果未修改可能会出现：迁移char类型时，由于数据库存储的类型不同，导致迁移的数据存在多余空格的情况。</p>
<p>2） <em>search_path</em>：模式搜索路径。例如<em>search_path</em>为 <em>$USER,SCOTT,PUBLIC</em>时，系统将首先搜索与登录用户同名的模式对象，然后搜索SCOTT模式对象，最后搜索PUBLIC模式对象。</p>
<p>3） <em>default_with_oids</em>：OID伪列开关。KingbaseES的OID伪列可兼容Oracle的ROWID伪列。因此，如果Oracle迁移对象有ROWID伪列，则建议用OID伪列替代。</p>
<p><strong>配置目的库KingbaseES性能参数</strong> ， 为了提高迁移速度，应对目的库KingbaseES进行性能优化配置。</p>
<p>例如：</p>
<ol>
<li>根据迁移数据规模的大小，迁移前可预先创建适当大小的数据和日志文件。</li>
</ol>
<p>开始迁移之前根据待迁移数据库的大小，保证KingbaseES数据目录所在位置有足够的空间。</p>
<p>2）根据KingbaseES服务器硬件配置的实际情况调整<em>shared_buffers</em>大小，默认是128M，建议调整为内存的1/4大小。</p>
<p><strong>数据库、用户和模式迁移</strong></p>
<p>数据库、用户迁移主要包括以下内容：</p>
<ul>
<li>获取源Oracle数据库的IP地址、实例名、网络服务端口号、用户名/密码等信息。</li>
<li>在目标KingbaseES数据库上，使用 Ksql 或 Kstudio 工具上执行如下操作：</li>
</ul>
<p>创建与源Oracle用户同名的用户，例如创建与Oracle同名的scott用户。</p>
<p>创建与源Oracle同名的数据库，例如创建与Oracle同名的ORCL数据库，它的属主为scott。若同名数据库存在，可以使用其他的数据库名称，若使用了新的数据库名称，则需要修改应用程序的连接串中的数据库名称。</p>
<ul>
<li>KingbaseES 默认initdb就是Oracle兼容模式。</li>
</ul>
<h4 data-id="heading-5">数据迁移</h4>
<p>Oracle 向 KingbaseES进行数据迁移需使用以下工具：</p>
<ul>
<li>KingbaseES 数据迁移工具 KDTS 动态加载待迁移的数据库访问接口，方便用户按照需求指定和使用。异构数据源之间的数据迁移：支持Oracle9i、10g、11g、12c、19c到KingbaseES的数据迁移。</li>
<li>KingbaseES 数据同步工具 KFS 支持同、异构数据源之间的数据迁移。KingbaseES 数据同步工具 KFS 支持结构迁移、支持全量数据迁移、支持列名映射，支持数据迁移过滤，在配置数据任务时，可以对迁移的表配置where条件、通过匹配的where条件过滤需要迁移的数据。</li>
</ul>
<p>一般而言，不同的迁移方式需要用到不同的迁移工具:</p>
<ul>
<li>离线迁移，使用 KDTS 即可完成 Oracle 的完整迁移。</li>
<li>在线迁移，需要先使用 KDTS 完成历史状态迁移，然后使用 KFS 完成数据的在线追平。</li>
</ul>
<p>下述分别介绍使用离线迁移方式和在线迁移方式迁移数据的步骤：</p>
<ul>
<li><strong>离线迁移</strong></li>
</ul>
<p>用户可使用KDTS进行数据的离线迁移，KDTS提供了两种形态（WEB、SHELL），用户可根据需要进行选择，以下章节将分别介绍WEB、SHELL版本进行oracle迁移的具体步骤。</p>
<p><strong>WEB迁移步骤</strong></p>
<p><strong>创建源数据库连接</strong> ，创建数据库连接界面如下，填写数据源信息，包括： <strong>“连接名称”、“数据库类型”、“数据库版本”、“服务器地址”、“端口”、“用户名”、“密码”、“数据库”、“连接参数”</strong>。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b158294d2824b709d2e77dd8087564b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=1UidMVbKcxFn6DtXwFXQRais4iU%3D" alt="" loading="lazy"/></p>
<p><strong>创建目标数据库连接</strong> ，创建数据库连接界面如下，填写数据源信息，包括： <strong>“连接名称”、“数据库类型”、“数据库版本”、“服务器地址”、“端口”、“用户名”、“密码”、“数据库”、“驱动”、“URL”、“连接参数”</strong>。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/418d661acf8e4cc8b804c933af9b872e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=bJ1VGZF6o9XrnyfUDBpFXg9MxqU%3D" alt="" loading="lazy"/></p>
<p><strong>新建迁移任务</strong></p>
<p>，KDTS采用向导页的方式指导用户新建迁移任务，简单易用，用户依次配置“选择数据源”-“选择模式”-“选择迁移对象”-“配置参数”，即可快速配置一个迁移任务。</p>
<ol>
<li><em>选择数据源</em></li>
</ol>
<p>填写自定义任务名称（任务名称不能重复），选择“源数据库”和“目标数据库”，或者选择“新建数据源”后使用。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8de44def62d146d4a13f2d3d42087a48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=vnb1eDtUQr76l0NzTNv775wgLC4%3D" alt="" loading="lazy"/></p>
<ol>
<li><em>选择模式</em></li>
</ol>
<p>选择需迁移的模式（如需选择模式在系统模式中可选中“包含系统模式”复选框）的表、视图、序列、函数、存储过程、程序包、同义词。当模式较多时也可以通过左上方的查询框进行检索。 请至少选择一种模式，否则将收到错误提示，以至于不能完成新建任务。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5e934c2a0f846618608ab69fc53067d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=ehAAiAQ1R9yO%2B4wloJtt09kcSCI%3D" alt="" loading="lazy"/></p>
<ol>
<li><em>选择迁移对象</em></li>
</ol>
<p>通过已选模式选择需要迁移数据的表，模式较多时可在已选模式搜索框内输入模式名关键字进行快速检索。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d7280dd0e474138a52d63ddbe4ec5e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=i8DGaF6h66RXVJWkr46XCuJymvM%3D" alt="" loading="lazy"/></p>
<p>可迁移此模式下全部表，也可以指定或排除部份表，当选择“包含指定表”或“排除指定表”时，请通过“从列表选择”、“从文件导入”或者在输入框内输入表名将数据添加到包含列表中，若未添加数据，则会提示错误导致无法进行下一步并完成新建任务。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a42303771db4a2a98a8175445a812d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=WDMfx0waUa83frt6jHRt2%2FXrpHs%3D" alt="" loading="lazy"/></p>
<p>点击“包含指定表”时也可选择多种方式。可直接在输入框内填写表名，多个表用“，”分割，回车确认；“从列表选择”可在模式中选择指定表；若需“从文件导入”，可点击“下载导入模板”，根据导入模板规则填写，然后从文件导入该模板。当需要“排除指定表”时，同指定部份表相同操作，但结果相反。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51129fc6db9345f5829a1f89cdbf4915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=deCaLFXKkzU8kvzoz05wKiK8OL0%3D" alt="" loading="lazy"/></p>
<p>从列表选择表时，可选择对应模式、检索表名关键字、数据条数限制进行快速检索对应的表。点击“添加”按钮后加入到已选列表，当想要移除部份表时可以选择对应的表点击“移除”按钮取消表。选择完成后点击确定。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74ab42e59da5472ea6c70660d0250681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=e1cwkdk%2FX1lMeGnRsorNYGHmyyw%3D" alt="" loading="lazy"/></p>
<ol>
<li><em>配置参数</em></li>
</ol>
<p>迁移工具提供了一系列配置参数用于迁移方案的个性化配置，满足多种迁移场景。配置参数分为“迁移配置”、“数据类型映射”、“线程配置”三个方面。以下以迁移配置为例，介绍各参数的含义。其他配置项请参考工具-迁移工具章节描述。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bee74f4cf2543ef9c3b6f4708f12939~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=SMjp473d9Eu5uUXLFD%2BKYJmhJIA%3D" alt="" loading="lazy"/></p>
<ul>
<li>表默认处理方式，包括两个复选框项（“建表/重建表”、“导入数据”），迁移到KingbaseES数据库是否需要建表或者重建表，以及是否只迁移表结构而不迁移数据的选择，根据实际需求选择合适的选项（默认是全选）。</li>
<li>表排序依据，对迁移的表进行排序，可通过“按行数和大字段大小交替”、“行数”、“大小进行排序”（默认是按行数和大字段大小交替）。</li>
<li>表数据读取和写入，对表数据的读取和写入制定规则，可操作项包括“源库游标读取记录数”（默认是100）、“批量写入目标库记录数”（默认是1000）、“每次批量提交大小”（默认是100MB）、“LOB字段预读取大小”（默认是4000Byte）。</li>
<li>大表拆分阈值依据，对大表进行拆分迁移，设置拆分界限。</li>
<li>非对象设置包含“主键”、“检查约束”、“唯一约束”、“外键”、“索引”、“触发器”、“自动转换对象名”，可以根据自己的需求选择是否迁移这些非对象数据（默认是全选）。</li>
<li>数据库连接数设置，可以限制迁移程序对源数据库和目标数据库的最大连接数（默认是100）。</li>
</ul>
<p><strong>执行迁移任务</strong></p>
<p>，可将此任务作为预迁移任务点击“保存”，或者作为执行任务点击“保存并迁移”。迁移完成后任务状态将变成：</p>
<ul>
<li>迁移完成，迁移结束“状态”栏显示“成功”，则迁移任务成功。</li>
<li>迁移失败，迁移结束“状态”栏显示“失败”，则迁移任务失败。失败后可点击详情查看日志有助于解决问题。</li>
</ul>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05803e91e784b01a174e9c3b3a1a54e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=34l6JX6HqNDA0olLTguWxppnEIg%3D" alt="" loading="lazy"/></p>
<p><strong>查看迁移报告及问题处理</strong></p>
<p>，迁移完成后，需要确认执行结果，包括迁移数据量，是否有错误发生，可以通过迁移日志和迁移结果进行查看。</p>
<p>“迁移日志”打印迁移任务执行后的日志，具体可分为“系统日志”、“Error日志”、“Info日志”。</p>
<p>“迁移结果”功能的工作区包括“任务执行批次”、“迁移对象”、“总数”、“成功数”、“失败数”、“略过数”、“操作”，可以查看历史迁移任务执行的每次记录，以及每次迁移的对象、成功数、失败数、查看失败任务的错误日志。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a139363ec21546c4a11b695bbc20a885~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=hqinwpDFv0UwhvrvCm%2FW8cop2UE%3D" alt="" loading="lazy"/></p>
<p><strong>SHELL迁移步骤</strong></p>
<p><strong>工程目录说明</strong> ，使用SHELL方式进行迁移需要对工程文件有一定了解：</p>
<ul>
<li>bin: 启动脚本</li>
<li>conf: 配置文件</li>
<li>doc: 帮助文档</li>
<li>drivers: 数据库连接驱动（注意不同版本驱动的存放目录差别，详见readme.md）</li>
<li>jdk: jdk</li>
<li>kdms: kdms程序</li>
<li>lib: 程序包</li>
<li>logs: 日志</li>
<li>result: 迁移报告</li>
</ul>
<p><strong>JDK安装</strong>，下载与KDTS安装服务器相匹配的JDK（需要匹配操作系统和CPU架构，如Liunx/AArch64、Linux/x64、Windows/x64等），版本选择JDK 11或更高。下载地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjdk.java.net%2Farchive%2F" target="_blank" title="https://jdk.java.net/archive/" ref="nofollow noopener noreferrer">jdk.java.net/archive/</a>， 将下载的JDK解压到KDTS-CLI/jdk目录下即可。</p>
<p>备注</p>
<ul>
<li>请使用解压版本的JDK，以免安装JDK影响服务器上的其它应用。</li>
<li>不要把当前的JDK加入系统环境变量，以免影响服务器上的其他应用。</li>
<li>如果需要使用服务器上已有的JDK，配置bin/startup.sh（Windows平台为startup.bat）中的JAVA_PATH即可。</li>
</ul>
<p><strong>配置数据库连接信息</strong>，配置步骤分为3步：激活配置文件、配置数据库连接、配置相关参数。</p>
<p>1）进入KDTS-CLI/conf目录下，打开application.yml文件，根据源库类型设置当前激活的源库配置（active: oracle），如下所示：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e20bd0b62e4259b66f13cc84f6d0dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=gzKQ3HJuQAR01ER9eNcJG%2BCA9wQ%3D" alt="" loading="lazy"/></p>
<p>在正确设置application.yml中的active项后，打开对应配置文件（datasource-oracle.yml），按实际运行环境进行配置即可。</p>
<p>2）配置源端数据库连接信息、目标数据库连接信息。编辑conf/datasource-oracle.yml文件，编辑源端和目标端连接信息，包括url、driver-class-name、username、password信息，如下图所示：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7df49a9dcb49cf8a4243279d931f5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=P6ruUYi1Z0lKvC1k7xp7XsJcmRc%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45f63af841bc4e628d77902900b42c35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=pE8UXebwR2Av7Ea0QBn1sGmLxpo%3D" alt="" loading="lazy"/></p>
<p>3） 配置要迁移的源库模式，数据库对象，涉及到的参数见下图：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/522cf63ea6b64e5b9a4052c5e535e719~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=IMNvxem%2Fr%2Bj9SkR9lma47NkvAcs%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcdaf157edb046c2b53236849190f3eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=SRZG%2BHW7i7F%2FTSETuE%2BmRgGLgTA%3D" alt="" loading="lazy"/></p>
<p>4） 迁移配置参数说明</p>
<p>编辑conf/datasource-oracle.yml文件有多个配置参数，可灵活使用。以下列举常用的配置参数。</p>
<ul>
<li>fetch-size，源数据库游标读取记录数，在一定范围内增加该值可提升读取效率，但会增加内存开销。</li>
<li>table-with-large-object-fetch-size，源数据库含大对象数据表的游标读取记录数，此参数针对有大对象字段的表。</li>
<li>large-table-split-threshold-rows，大表拆分阈值行数（当表的行数超过此值时，将对表进行拆分，每块的记录数为此值和表总记录数除以“拆分最大块数”中的最大值）。</li>
<li>large-table-split-threshold-size，大表拆分阈值大小（单位为M），当表的数据大小（普通字段+大对象字段）超过此值时，将对表进行拆分。</li>
<li>large-table-split-condition-file，大表拆分条件定义文件，优先于按行数和大小拆分。</li>
<li>table-data-filter-condition-file，表数据过滤条件定义文件。</li>
<li>use-kdms，是否使用kdms做转换（视图、函数、存储过程、包、触发器）。</li>
<li>kdms-url，kdms访问地址，前提是use-kdms: true。</li>
<li>write-batch-size，目标数据库表数据批量提交记录数.</li>
<li>write-batch-size-big-lob，目标数据库表数据批量提交记录数，特指大对象数据。</li>
<li>drop-existing-object，是否默认删除目标库中已存在的对象（如表、视图等）。</li>
<li>truncate-table，是否默认清空目标库中已存在的表数据。</li>
<li>rename-object，目标数据库对象重命名，除表名、列名外的其他对象: pk、fk、constraint、unique constraint、index 等。</li>
<li>useDbmsStats，是否使用数据库系统统计信息（如表的记录数、大小等）。</li>
<li>useManualScript，是否使用手工脚本。</li>
<li>useKdms，是否使用kdms做转换（视图、函数、存储过程、包、触发器）。</li>
<li>kdmsUrl，kdms访问地址。</li>
<li>kdmsSourceDbType，kdms源数据库类型。</li>
<li>kdmsTargetDbType，kdms目标数据库类型。</li>
<li>readDataTimeout，读数据超时时长（单位毫秒，0表示永不超时）。</li>
<li>maxRetries，最大重试次数。</li>
<li>retryInterval，重试间隔（毫秒）。</li>
<li>readDataCanResume，读数据（中断后）能否恢复。</li>
<li>characterNeedDecoding，字符是否需要解码，处理类似Oracle字符集为US7ASCII、WE8ISO8859P1等时迁移中文乱码的问题。</li>
<li>encodingCharset，编码字符集（字符集为US7ASCII、WE8ISO8859P1设置为"ISO-8859-1"）。</li>
<li>decodingCharset，解码字符集（字符集为US7ASCII、WE8ISO8859P1设置为"GB18030"）。</li>
<li>decodingBytes，是否解码字节（字符集为US7ASCII时设为true）。</li>
<li>dataCompareBufferSize，源端数据对比缓冲区大小（行数）。</li>
<li>dataCompareAlgorithm，数据对比摘要算法。</li>
<li>maximumPoolSize，源数据库最大连接数。</li>
</ul>
<p><strong>线程相关设置</strong></p>
<p>可根据实际服务器配置按比例调整，如果与目标数据库运行在同一服务器上，应将绝大部分资源分配给数据库。</p>
<p>进入 KDTS-CLI/conf目录下，打开:kb-thread-config.xml，如下图所示：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bda6779f8e44c36bee34f26e7fff57e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=zpwukDyiySVOTM1KX%2FTMhjv0aqI%3D" alt="" loading="lazy"/></p>
<p>数据迁移属于IO密集型操作，涉及网络络IO和磁盘IO的交互，一旦发生IO，线程就会处于等待状态，当IO结束，数据准备好后，线程才会继续执行。为提升数据迁移的效率可以多设置⼀些线程池中线程的数量，避免任务等待，线程可以去做更多的迁移任务，提高并发处理效率。但不是线程数设置的越高，效率就越高，线程上下文切换是有代价的。 对于对于IO密集型线程数的设置公式为：线程数 = CPU核心数/(1-阻塞系数) ，其中阻塞系数一般为0.8~0.9之间，取0.9则：</p>
<p>双核CPU： 2/(1-0.9) = 20</p>
<p>64核2路CPU： 64*2/(1-0.9) = 1280</p>
<p><strong>启动脚本</strong> ，进入 KDTS-CLI/bin 目录下，编辑: startup.sh：</p>
<ul>
<li>检查JDK的路径是否正确</li>
</ul>
<p>JAVA_PATH=${BASE_PATH}/jdk</p>
<ul>
<li>设置JVM内存</li>
</ul>
<p>系统默认自动获取JVM内存参数，若需手动调整JVM参数：</p>
<p><code>&lt;font style="color:rgb(68, 73, 80);background-color:rgb(246, 247, 248);"&gt;JAVA_OPT="-server -Dfile.encoding=UTF-8 -Dconfig.path=$\{CONFIG_DIR\} -Xmx16g -Xms16g"&lt;/font&gt;</code> 主要是: <code>&lt;font style="color:rgb(68, 73, 80);background-color:rgb(246, 247, 248);"&gt;-Xmx16g -Xms16g&lt;/font&gt;</code> 参数</p>
<ul>
<li>启动运行脚本</li>
</ul>
<p>进入 KDTS-CLI/bin目录，执行: ./startup.sh 。</p>
<p><strong>查看迁移报告及问题处理</strong></p>
<p>，可以在运行日志（kdts_plus_***.log）中查看到迁移整个过程的信息，包括任务启动、迁移进程、结果汇总。</p>
<p>可查看result下的迁移结果（在形如“result/2021-12-02_15-15-15/Sehcma1”目录下）</p>
<ul>
<li>index.html--报告主页面</li>
<li>detail_XXX.html--XXX详细信息（如表结构、表数据、表主键等）</li>
<li>FailedScript--失败脚本目录</li>
<li>IgnoredScript--略过脚本目录</li>
<li>SuccessScript--成功脚本目录</li>
</ul>
<p>在迁移过程中一旦某个对象创建失败，KDTS会将该对象的创建sql保留到本次迁移任务文件夹下的FailedScript目录下*.sql文件，用户可以手动修改后通过Ksql或者KStudio工具手动执行。</p>
<ul>
<li><strong>在线迁移</strong></li>
</ul>
<p>在线迁移过程中，为保障异构数据库数据同步且客户业务不停机，需要一个中间数据库（与源端数据库版本相同的单实例数据库）做媒介迁移存量数据。操作的过程分两部分。</p>
<ol>
<li>先将存量数据迁移至中间数据库上，然后KDTS迁移工具进行初始数据搬迁或通过ETL进行初始数据搬迁至异构数据库（目标数据库）中。</li>
<li>待上一步操作完成，从指定断点开始启动KFS源端，正常启动目标端的KFS程序（在已经有KFS运行的情况下，可能需要重置KFS）。</li>
</ol>
<p>备注</p>
<p>在迁移源库存量数据时避免做以下操作：</p>
<p>1). 运行大型批处理操作会降低复制速率。</p>
<p>2). 备份时执行DDL操作将导致DML和DDL之间存在锁问题</p>
<p><strong>源端数据库备份</strong></p>
<ol>
<li>获取当前数据库一致性scn号</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">alter system checkpoint global;
select checkpoint_change# from v$database;

假设获取的值为200725471，该scn号将用作启动KFS起始的scn号。
</code></pre>
<ol>
<li>创建备份目录(需要sysdba权限)</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">create directory dump_dir as 'd:/dump_dir';
grant read,write on directory dump_dir to kfs_user;
</code></pre>
<ol>
<li>完整备份数据库</li>
</ol>
<p>在单实例oracle数据库服务器上执行（导出用户kfs_user的内容）：</p>
<pre><code class="hljs language-plain" lang="plain">expdp kfs_user/123456 schemas=kfs_user directory=dump_dir flashback_scn=200725471 dumpfile=DBNAME_20220511.dump
</code></pre>
<p><strong>存量数据迁移</strong></p>
<ol>
<li>在中间库中创建备份目录(需要sysdba权限)</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">create directory dump_dir as 'E:/dump_dir';
grant read,write on directory dump_dir to kfs_user;
</code></pre>
<ol>
<li>将源端备份的数据文件拷贝至E:/dump_dir目录下</li>
<li>将备份的数据还原至中间库</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">impdp kfs_user_new/123456 directory= dump_dir remap_schema=kfs_user:kfs_user_new table_exists_action=replace dumpfile= DBNAME_20220511.dump
</code></pre>
<ol>
<li>使用数据迁移工具（KDTS）将中间库的数据搬迁至目标数据库。</li>
</ol>
<p><strong>启动KFS完成数据追平</strong></p>
<p>备注</p>
<p>若KFS之前已经部署运行，则源端和目标端需要先执行重置命令fsrepctl –service XXX reset -all –y，确认中间表、kufl文件等被清除。 KFS部署参考《Kingbase FlySync 安装部署手册》。</p>
<p><strong>源端操作</strong> ，先启动KFS到offline状态，replicator start offline。再使用ONLINE命令，将源端的KFS完全启起来，执行ONLINE命令时需要指定-from-event参数，参数值为备份数据库时查询的scn值。</p>
<pre><code class="hljs language-plain" lang="plain">replicator start offline

fsrepctl -service oracle online -from-event ora:200725471: 200725471
</code></pre>
<p><strong>目标端操作</strong> ，启动目标端KFS，等待数据追平。</p>
<p>提示</p>
<p>追平的判断方法:</p>
<p>[<a href="https://link.juejin.cn?target=mailto%3Ahes%40h1-105" target="_blank" title="mailto:hes@h1-105" ref="nofollow noopener noreferrer">hes@h1-105</a> ~]$ fsrepctl services Processing services command... NAME VALUE ---- -----appliedLastSeqno: 3 //若源端无新数据产生，则源端和目标端相同 appliedLatency : 0.297 //若源端无新数据产生，延迟时间为0 role : master serviceName : postgresql serviceType : local started : true state : ONLINE Finished services command...</p>
<p><strong>多次迁移</strong></p>
<p>若项目开发过程中，需要定期从一个指定的源数据库迁移到目的数据库中， 那么根据迁移时源数据库和应用的状态，决定离线迁移还是在线迁移。</p>
<p>同时，由于是多次迁移，需要考虑每次迁移时数据库对象的定义是否需要迁移， 若不需要，则只迁移数据就可以，使用 KDTS 和 KFS 都支持只迁移数据； 若每次迁移时需要迁移对象定义，则:</p>
<p>1）对于定义发生变更的表，选择迁移定义和数据。可使用 KDTS的“迁移部分表”功能完成,详细步骤可参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kingbase.com.cn%2Fcn%2FKES-V9R4C16%2Fapplication%2Fapplication-develop-guide%2Ftools%2Fmigrate_tools%23%25E8%25BF%2581%25E7%25A7%25BB%25E5%25B7%25A5%25E5%2585%25B7" target="_blank" title="https://docs.kingbase.com.cn/cn/KES-V9R4C16/application/application-develop-guide/tools/migrate_tools#%E8%BF%81%E7%A7%BB%E5%B7%A5%E5%85%B7" ref="nofollow noopener noreferrer">迁移工具</a> 。</p>
<p>2）对于定义没有发生变更的表，只同步数据即可。可使用 KDTS的“按条件迁移”功能完成,详细步骤可参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kingbase.com.cn%2Fcn%2FKES-V9R4C16%2Fapplication%2Fapplication-develop-guide%2Ftools%2Fmigrate_tools%23%25E8%25BF%2581%25E7%25A7%25BB%25E5%25B7%25A5%25E5%2585%25B7" target="_blank" title="https://docs.kingbase.com.cn/cn/KES-V9R4C16/application/application-develop-guide/tools/migrate_tools#%E8%BF%81%E7%A7%BB%E5%B7%A5%E5%85%B7" ref="nofollow noopener noreferrer">迁移工具</a> 。</p>
<h4 data-id="heading-6">应用代码迁移</h4>
<p><strong>服务器应用代码迁移</strong></p>
<p>数据迁移后，需要迁移应用系统中用到的服务器应用代码，例如 PL/SQL。</p>
<p>KDTS 已经完成了存储过程，函数，包等 PL/SQL对象的迁移， 只需要关注应用代码中用到的匿名块的代码的迁移。KingbaseES 的 plsql 语言和Oracle的plsql高度兼容， 需要关注如下2点：</p>
<ol>
<li>package中Oracle 允许存在同名同参数的存储过程和函数，KingbaseES 不支持，需要重命名为不同名字。</li>
<li>KingbaseES 不支持 Object type的方法的连续调用，例如不支持 方法1.方法2.方法3， 需要改写为</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">var1 := 方法1;
var2 := var1.方法2；
var3 := var2.方法3；
</code></pre>
<p><strong>客户端应用代码迁移</strong></p>
<p>在应用编程接口方面，KingbaseES与Oracle兼容程度较高，所以，一般情况下，应用程序迁移比较容易。应用程序迁移通常应和迁移后的系统测试同时进行。这样可及时修改测试过程中发现的问题。</p>
<p>通常，在应用程序可采用API方式访问和操纵数据库：</p>
<p>该方式通过数据库厂商提供的各种标准应用编程接口在应用程序中与数据库进行交互。常用的应用编程接口如JDBC和ODBC等。目前，大多数数据库厂商均提供很多标准的数据库API及其驱动程序。</p>
<p>在实际应用中，应首先加载驱动程序。加载成功后，利用API函数与数据库交互并完成对数据库数据的操作。</p>
<p><strong>ODBC</strong></p>
<p>对于使用ODBC的应用程序，应创建 KingbaseES ODBC 数据源，然后修改应用程序中连接数据库的用户名、密码等。此外，在Windows系统下对于OLEDB、ADO和NDP，则不需创建数据源。</p>
<ol>
<li>Windows数据源配置</li>
</ol>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/407818a71d66490d9df832f86fe5df91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=i5VSFxEJGz5atPNh0o19xoMCAR4%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/203a9b28d4004575bd061636f0dd24fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=QOe1eSI7Vo%2FYYzxAjl9FS%2BQo02Q%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1f61846f8d44cef89f3cc60893f33dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=ykBUMWHmJcdG%2FX4kJRjVsacvihs%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5df4de3750947848f03ee4c5c0e96fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611556&amp;x-signature=6c7rk44dxXl51HLznOQpUxfSI7s%3D" alt="" loading="lazy"/></p>
<p>具体配置参数解释请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kingbase.com.cn%2Fcn%2FKES-V9R4C16%2Fmigration%2Fbest_practice%2Foracle_best_practice%2F%23KingbaseES%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E7%25BC%2596%25E7%25A8%258B%25E6%258E%25A5%25E5%258F%25A3%25E6%258C%2587%25E5%258D%2597-ODBC" target="_blank" title="https://docs.kingbase.com.cn/cn/KES-V9R4C16/migration/best_practice/oracle_best_practice/#KingbaseES%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E6%8C%87%E5%8D%97-ODBC" ref="nofollow noopener noreferrer">KingbaseES客户端编程接口指南-ODBC</a> 。</p>
<ol>
<li>Linux数据源配置</li>
</ol>
<p>首先检查 ODBC Driver 是否已经安装。在系统中找到 odbcinst.ini 文件，和/usr/bin/odbcinst 对应的 odbcinst.ini 在 /etc 目录下，和 /usr/local/bin/odbcinst 对应的 odbcinst.ini 在 /usr/local/etc 目录下。在odbcinst.ini 文件中查找 [KingbaseES 9 ODBC Driver] 这一项。</p>
<p>如果没有，则参考增加如下内容：</p>
<pre><code class="hljs language-plain" lang="plain">[KingbaseES 9 ODBC Driver]

Description = KingbaseES 9 ODBC Driver for Linux

Driver = /opt/Kingbase/Odbc/lib/kdbodbcw.so

增加odbc.ini文件，内容如下：

[kingbase]

Description = KingbaseES

Driver = KingbaseES 9 ODBC Driver

Servername = 127.0.0.1

Port = 54321

Username = SYSTEM

Password = MANAGER

Database = TEST
</code></pre>
<p>具体配置参数解释请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kingbase.com.cn%2Fcn%2FKES-V9R4C16%2Fmigration%2Fbest_practice%2Foracle_best_practice%2F%23KingbaseES%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E7%25BC%2596%25E7%25A8%258B%25E6%258E%25A5%25E5%258F%25A3%25E6%258C%2587%25E5%258D%2597-ODBC" target="_blank" title="https://docs.kingbase.com.cn/cn/KES-V9R4C16/migration/best_practice/oracle_best_practice/#KingbaseES%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E6%8C%87%E5%8D%97-ODBC" ref="nofollow noopener noreferrer">KingbaseES客户端编程接口指南-ODBC</a> 。</p>
<p><strong>移植Oracle OCI应用程序</strong></p>
<p>KingbaseES支持OCI的大部分常用接口。</p>
<p>具体参见手册 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kingbase.com.cn%2Fcn%2FKES-V9R4C16%2Fmigration%2Fbest_practice%2Foracle_best_practice%2F%23KingbaseES%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E7%25BC%2596%25E7%25A8%258B%25E6%258E%25A5%25E5%258F%25A3%25E6%258C%2587%25E5%258D%2597-DCI" target="_blank" title="https://docs.kingbase.com.cn/cn/KES-V9R4C16/migration/best_practice/oracle_best_practice/#KingbaseES%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3%E6%8C%87%E5%8D%97-DCI" ref="nofollow noopener noreferrer">KingbaseES客户端编程接口指南-DCI</a> 。</p>
<p><strong>其它应用框架</strong></p>
<p>其它应用框架的使用，请参照客户端编程开发框架的使用指南。如无说明，请及时联系KingbaseES支持工程师。</p>
<h4 data-id="heading-7">测试与调试迁移后的系统</h4>
<p>任何一个成熟的应用系统如果代码、尤其是关键代码变动后，则应进行全面细致的测试。类似的，更换新的后台数据库系统以后，也应对迁移后的数据库系统进行全面的功能和性能测试。</p>
<p><strong>功能测试和排错</strong></p>
<p>功能测试是指对迁移后的数据库系统的每一个模块和功能进行全面的系统回归测试，用以确保新系统各个功能的正确性。</p>
<p>因此，完成数据库对象和应用程序迁移后，应对迁移后的系统进行全面的功能测试，并对测出问题及时分析、排查和修改。对那些很难定位的问题，请及时联系KingbaseES支持工程师。</p>
<p><strong>性能测试和调优</strong></p>
<p>迁移后的系统性能测试和调优是在完成迁移得系统功能测试后和系统上线前，在实际或模拟生产数据上，对迁移后的系统进行的性能测试和调优。</p>
<p>迁移后的系统性能测试和调优的主要步骤如下：</p>
<ul>
<li><strong>构造测试数据</strong>：若条件允许的话，建议构造与实际生产数据规模相同的数据，并模拟构造未来一年、两年、五年或更长生命周期的数据进行测试。</li>
<li><strong>部署测试软硬件环境</strong>：根据测试数据规模的大小，配置适当的测试软硬件环境。</li>
<li>**性能测试：**既可采用手动方式，也可利用TPCC测试工具、LoadRunner等工具对迁移后的系统进行自动测试。</li>
<li><strong>性能调优</strong>：对未达到性能指标的功能模块及其SQL语句进行优化并给出相关建议。</li>
</ul>
<p>通常，性能测试效果与测试数据规模、软硬件配置等因素密切相关。因此，建议性能测试时，测试数据规模、软硬件配置应尽量与将来的实际生产环境一致。必要时，在未来一年、两年、五年等不同模拟数据规模场景下，应分别测试迁移后的系统的性能指标，用以保证钱以后的系统未来仍能具有良好的性能表现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你不知道的 TypeScript：模板字符串类型]]></title>    <link>https://juejin.cn/post/7597664149170192426</link>    <guid>https://juejin.cn/post/7597664149170192426</guid>    <pubDate>2026-01-21T14:49:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597664149170192426" data-draft-id="7595028805158813706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你不知道的 TypeScript：模板字符串类型"/> <meta itemprop="keywords" content="TypeScript,前端"/> <meta itemprop="datePublished" content="2026-01-21T14:49:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我不吃饼干"/> <meta itemprop="url" content="https://juejin.cn/user/3263006241480605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你不知道的 TypeScript：模板字符串类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006241480605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我不吃饼干
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:49:42.000Z" title="Wed Jan 21 2026 14:49:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大部分前端应该都或多或少地使用过 TypeScript 开发，但是此文将带你探索少有人了解的 TS 领域：模板字符串类型。</p>
</blockquote>
<p>这样的类型操作你见过吗？</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">World</span> = <span class="hljs-string">'World'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Greeting</span> = <span class="hljs-string">`Hello <span class="hljs-subst">${World}</span>`</span> <span class="hljs-comment">// "Hello World"</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserName</span> = <span class="hljs-string">'cookie'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserNameCapitalize</span> = <span class="hljs-title class_">Capitalize</span>&lt;<span class="hljs-title class_">UserName</span>&gt; <span class="hljs-comment">// "Cookie"</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ButtonVariant</span> = <span class="hljs-string">`btn-<span class="hljs-subst">${<span class="hljs-string">'primary'</span> | <span class="hljs-string">'secondary'</span>}</span>-<span class="hljs-subst">${<span class="hljs-string">'sm'</span> | <span class="hljs-string">'lg'</span>}</span>`</span>
<span class="hljs-comment">// "btn-primary-sm" | "btn-primary-lg" | "btn-secondary-sm" | "btn-secondary-lg"</span>
</code></pre>
<p>看起来不可思议，但是这些都是 TypeScript 模板字符串类型的能力。</p>
<p><strong>模板字符串类型（Template Literal Types）</strong> 是 TypeScript 4.1 引入的高级特性。它建立在字符串字面量类型的基础上，允许你通过类似 JavaScript 模板字符串的语法，动态地组合、操作和生成新的字符串类型。</p>
<p>接下来，我将从字符串字面量类型开始，逐步讲解到模板字符串类型的初级到高级的用法。</p>
<h2 data-id="heading-0">一、基础：什么是字符串字面量类型？</h2>
<h3 data-id="heading-1">1. 定义</h3>
<p>字符串字面量类型是指<strong>将一个具体的字符串值作为一种类型</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 普通的 string 类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">s1</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello'</span>
s1 = <span class="hljs-string">'world'</span> <span class="hljs-comment">// 正确</span>

<span class="hljs-comment">// 字符串字面量类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">s2</span>: <span class="hljs-string">'hello'</span> = <span class="hljs-string">'hello'</span>
s2 = <span class="hljs-string">'world'</span> <span class="hljs-comment">// 报错：不能将类型"world"分配给类型"hello"</span>
</code></pre>
<h3 data-id="heading-2">2. 联合类型 (Union Types)</h3>
<p>字符串字面量类型最常见的用法是配合联合类型使用，限制变量只能是某几个特定字符串之一。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">HttpMethod</span> = <span class="hljs-string">'GET'</span> | <span class="hljs-string">'POST'</span> | <span class="hljs-string">'PUT'</span> | <span class="hljs-string">'DELETE'</span> | <span class="hljs-string">'PATCH'</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">method: HttpMethod, url: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// ...</span>
}
<span class="hljs-title function_">request</span>(<span class="hljs-string">'GET'</span>, url) <span class="hljs-comment">// 正确</span>
<span class="hljs-title function_">request</span>(<span class="hljs-string">'LET'</span>, url) <span class="hljs-comment">// 报错：类型"LET"的参数不能赋给类型"HttpMethod"的参数。</span>
</code></pre>
<h2 data-id="heading-3">二、进阶：模板字符串类型</h2>
<h3 data-id="heading-4">1. 基础拼接</h3>
<p>就像 JavaScript 中的模板字符串 <code>${var}</code> 一样，TypeScript 类型也可以通过反引号 <code>``</code> 和 <code>${}</code> 配合实现字符串类型的插值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 字符串拼接</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">World</span> = <span class="hljs-string">'World'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Greeting</span> = <span class="hljs-string">`Hello <span class="hljs-subst">${World}</span>`</span> <span class="hljs-comment">// 类型 "Hello World"</span>

<span class="hljs-comment">// 多个插值</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Protocol</span> = <span class="hljs-string">'https'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Domain</span> = <span class="hljs-string">'example.com'</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">URL</span> = <span class="hljs-string">`<span class="hljs-subst">${Protocol}</span>://<span class="hljs-subst">${Domain}</span>`</span> <span class="hljs-comment">// 类型 "https://example.com"</span>

<span class="hljs-comment">// 与其他类型结合</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Version</span> = <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">APIVersion</span> = <span class="hljs-string">`v<span class="hljs-subst">${Version}</span>`</span> <span class="hljs-comment">// "v1" | "v2" | "v3"</span>
</code></pre>
<p>在这里提醒一下大家，<strong>一定不要把类型和值搞混</strong>，这里操作的是类型，不要把它当做值去操作。一些错误示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">World</span>) <span class="hljs-comment">// 报错："World"仅表示类型，但在此处却作为值使用。</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Greeting</span> = <span class="hljs-string">"Hello"</span> + <span class="hljs-title class_">World</span> <span class="hljs-comment">// 报错："World"仅表示类型，但在此处却作为值使用。</span>
</code></pre>
<h3 data-id="heading-5">2. 联合类型的自动分发（笛卡尔积）</h3>
<p>在模板字符串中，把多个联合类型组合在一起时，TypeScript 会自动生成所有可能的组合，也就是按笛卡尔积（Cartesian Product）组合。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Space</span> = <span class="hljs-string">'sm'</span> | <span class="hljs-string">'md'</span> | <span class="hljs-string">'lg'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Side</span> = <span class="hljs-string">'t'</span> | <span class="hljs-string">'b'</span> | <span class="hljs-string">'l'</span> | <span class="hljs-string">'r'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PaddingClass</span> = <span class="hljs-string">`p-<span class="hljs-subst">${Side}</span>-<span class="hljs-subst">${Space}</span>`</span>
<span class="hljs-comment">// "p-t-sm" | "p-t-md" | "p-t-lg" | "p-b-sm" | "p-b-md" | "p-b-lg" | "p-l-sm" | "p-l-md" | "p-l-lg" | "p-r-sm" | "p-r-md" | "p-r-lg"</span>

<span class="hljs-comment">// 实际使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addPadding</span>(<span class="hljs-params">el: HTMLElement, className: PaddingClass</span>) {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(className)
}
<span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
<span class="hljs-title function_">addPadding</span>(div, <span class="hljs-string">'p-t-sm'</span>) <span class="hljs-comment">// 正确</span>
<span class="hljs-title function_">addPadding</span>(div, <span class="hljs-string">'p-x-xx'</span>) <span class="hljs-comment">// 类型错误</span>
</code></pre>
<p><strong>性能提示</strong>：当联合类型的成员数量较多时，组合后的类型数量会呈指数级增长（例如 3 个联合类型各有 10 个成员，组合后会有 1000 种可能），这可能会导致 TypeScript 编译器性能下降或类型检查变慢。</p>
<h3 data-id="heading-6">3. 内置工具类型</h3>
<p>为了性能和方便，TypeScript 编译器内置了四个特殊的工具类型。它们不是通过 TS 代码实现的，而是直接由编译器处理。</p>
<ul>
<li><code>Uppercase&lt;S&gt;</code> 将字符串中的<strong>每个字符</strong>转换为<strong>大写</strong></li>
<li><code>Lowercase&lt;S&gt;</code> 将字符串中的<strong>每个字符</strong>转换为<strong>小写</strong></li>
<li><code>Capitalize&lt;S&gt;</code> 将字符串的<strong>第一个字符</strong>转换为<strong>大写</strong></li>
<li><code>Uncapitalize&lt;S&gt;</code> 将字符串的<strong>第一个字符</strong>转换为<strong>小写</strong></li>
</ul>
<p>下面是使用示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Uppercase：全部转大写</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Color</span> = <span class="hljs-string">'red'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UpperColor</span> = <span class="hljs-title class_">Uppercase</span>&lt;<span class="hljs-title class_">Color</span>&gt; <span class="hljs-comment">// "RED"</span>

<span class="hljs-comment">// Lowercase：全部转小写</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MixedCase</span> = <span class="hljs-string">'TypeScript'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">LowerCase</span> = <span class="hljs-title class_">Lowercase</span>&lt;<span class="hljs-title class_">MixedCase</span>&gt; <span class="hljs-comment">// "typescript"</span>

<span class="hljs-comment">// Capitalize：首字母大写</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-string">'cookie'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CapName</span> = <span class="hljs-title class_">Capitalize</span>&lt;<span class="hljs-title class_">Name</span>&gt; <span class="hljs-comment">// "Cookie"</span>

<span class="hljs-comment">// Uncapitalize：首字母小写</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Components</span> = <span class="hljs-string">'Button'</span> | <span class="hljs-string">'Input'</span> | <span class="hljs-string">'Modal'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UncapComponents</span> = <span class="hljs-title class_">Uncapitalize</span>&lt;<span class="hljs-title class_">Components</span>&gt; <span class="hljs-comment">// "button" | "input" | "modal"</span>
</code></pre>
<p>结合模板字符串使用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 生成事件处理器名称</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Events</span> = <span class="hljs-string">'click'</span> | <span class="hljs-string">'change'</span> | <span class="hljs-string">'input'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">EventHandlers</span> = <span class="hljs-string">`on<span class="hljs-subst">${Capitalize&lt;Events&gt;}</span>`</span>
<span class="hljs-comment">// "onClick" | "onChange" | "onInput"</span>

<span class="hljs-comment">// 生成 CSS 类名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Size</span> = <span class="hljs-string">'sm'</span> | <span class="hljs-string">'MD'</span> | <span class="hljs-string">'Lg'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SizeClass</span> = <span class="hljs-string">`size-<span class="hljs-subst">${Lowercase&lt;Size&gt;}</span>`</span>
<span class="hljs-comment">// "size-sm" | "size-md" | "size-lg"</span>
</code></pre>
<h2 data-id="heading-7">三、 高阶：模式匹配与 <code>infer</code></h2>
<p>掌握了基础的模板字符串拼接后，接下来我们进入更强大的领域——<strong>模式匹配</strong>。要在类型中<strong>解析</strong>字符串（例如提取参数、去掉空格），我们需要结合 <code>extends</code> 和 <code>infer</code>。</p>
<h3 data-id="heading-8">1. 什么是 <code>infer</code> ？</h3>
<p><code>infer</code> 属于 TS 的高阶用法，它需要配合条件语句一起使用：</p>
<pre><code class="hljs language-ts" lang="ts">A <span class="hljs-keyword">extends</span> B ? C : D
</code></pre>
<p>含义是：如果类型 A 可以赋值给类型 B，则结果为 C，否则为 D。</p>
<p>而 <code>infer</code> 的作用是在条件类型的 <code>extends</code> 子句（也就是 <code>B</code> 语句）中 <strong>声明一个待推断的类型变量</strong>。可以把它理解为"占位符"，让 TypeScript 帮你从某个复杂类型中"提取"出一部分。当类型匹配成功时，<code>infer</code> 声明的类型变量会被推断为匹配到的具体类型。</p>
<p>举一些实用的例子：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 获取 Promise 返回值的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UnpackPromise</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer R&gt; ? R : T
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">P1</span> = <span class="hljs-title class_">UnpackPromise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; <span class="hljs-comment">// string</span>

<span class="hljs-comment">// 获取数组中元素类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetArrayType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer U)[] ? U : <span class="hljs-built_in">never</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">A1</span> = <span class="hljs-title class_">GetArrayType</span>&lt;<span class="hljs-built_in">number</span>[]&gt; <span class="hljs-comment">// number</span>

<span class="hljs-comment">// 获取函数的返回值类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">R1</span> = <span class="hljs-title class_">GetReturnType</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>&gt; <span class="hljs-comment">// boolean</span>
</code></pre>
<h3 data-id="heading-9">2. 在模板字符串类型中使用 <code>infer</code></h3>
<p>在模板字符串中 <code>infer</code> 的使用方法同上，也需要配合条件语句，区别是我们需要通过 <code>${infer T}</code> 把它插入到模板字符串类型中，通过模式匹配来提取字符串的特定部分。</p>
<p>比如提取出字符串类型空格后面的部分。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">GetSurname</span>&lt;S&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer First}</span> <span class="hljs-subst">${infer Last}</span>`</span> ? <span class="hljs-title class_">Last</span> : <span class="hljs-built_in">never</span>

<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T1</span> = <span class="hljs-title class_">GetSurname</span>&lt;<span class="hljs-string">'Hello Cookie'</span>&gt; <span class="hljs-comment">// "Cookie"</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T2</span> = <span class="hljs-title class_">GetSurname</span>&lt;<span class="hljs-string">'Cookie'</span>&gt; <span class="hljs-comment">// never (因为没有空格，匹配失败)</span>
</code></pre>
<h3 data-id="heading-10">3. 贪婪与非贪婪匹配</h3>
<p>多个 <code>infer</code> 连用，TypeScript 使用 “非贪婪” 匹配策略，也就是会遵循 “从左到右，尽可能匹配最小单位” 的原则。</p>
<p>比如，当使用 <code>${infer A}${infer B}</code> 时：</p>
<ul>
<li><strong>A（第一个 infer）</strong>：匹配第一个字符（最短匹配）</li>
<li><strong>B（第二个 infer）</strong>：匹配剩余所有字符（由于 A 已经匹配了第一个字符，B 必须匹配剩余的全部内容）</li>
</ul>
<p>举例说明：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 三个连续的 infer 会依次匹配：A 匹配第一个字符，B 匹配第二个字符，C 匹配剩余所有字符</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Split</span>&lt;S&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer A}</span><span class="hljs-subst">${infer B}</span><span class="hljs-subst">${infer C}</span>`</span> ? [A, B, C] : []
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Res</span> = <span class="hljs-title class_">Split</span>&lt;<span class="hljs-string">'Hello'</span>&gt; <span class="hljs-comment">// ["H", "e", "llo"]</span>

<span class="hljs-comment">// 有占位符的情况，也只会匹配到第一个</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetExt</span>&lt;S&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer Name}</span>.<span class="hljs-subst">${infer Ext}</span>`</span> ? <span class="hljs-title class_">Ext</span> : <span class="hljs-built_in">never</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">E2</span> = <span class="hljs-title class_">GetExt</span>&lt;<span class="hljs-string">'ts.config.json'</span>&gt; 
<span class="hljs-comment">// "config.json"（Name 匹配到第一个点之前，Ext 获取之后的所有内容）</span>
</code></pre>
<h3 data-id="heading-11">4. <code>infer</code> 与联合类型联动</h3>
<p>当模式中包含联合类型时，TypeScript 会尝试匹配联合类型中的任意一个成员：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 提取指定几种扩展类型的文件名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ImageExt</span> = <span class="hljs-string">'jpg'</span> | <span class="hljs-string">'png'</span> | <span class="hljs-string">'gif'</span> | <span class="hljs-string">'webp'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractRawName</span>&lt;<span class="hljs-title class_">FileName</span>&gt; = <span class="hljs-title class_">FileName</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${infer Name}</span>.<span class="hljs-subst">${ImageExt}</span>`</span>
  ? <span class="hljs-title class_">Name</span>
  : <span class="hljs-built_in">never</span>

<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">E1</span> = <span class="hljs-title class_">ExtractRawName</span>&lt;<span class="hljs-string">'photo.jpg'</span>&gt; <span class="hljs-comment">// "photo"</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">E2</span> = <span class="hljs-title class_">ExtractRawName</span>&lt;<span class="hljs-string">'logo.png'</span>&gt; <span class="hljs-comment">// "logo"</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">E3</span> = <span class="hljs-title class_">ExtractRawName</span>&lt;<span class="hljs-string">'document.pdf'</span>&gt; <span class="hljs-comment">// never (pdf 不在 ImageExt 联合类型中)</span>
</code></pre>
<p>TypeScript 会对联合类型中的每一个成员分别执行 <code>infer</code> 逻辑，最后再把结果重新组合成一个新的联合类型，在模板字符串中也一样。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">IconNames</span> = <span class="hljs-string">'icon-home'</span> | <span class="hljs-string">'icon-user'</span> | <span class="hljs-string">'icon-settings'</span> | <span class="hljs-string">'logo-main'</span>

<span class="hljs-comment">// 提取所有以 "icon-" 开头的图标名称</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractIcon</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-string">`icon-<span class="hljs-subst">${infer Name}</span>`</span> ? <span class="hljs-title class_">Name</span> : <span class="hljs-built_in">never</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PureNames</span> = <span class="hljs-title class_">ExtractIcon</span>&lt;<span class="hljs-title class_">IconNames</span>&gt;
<span class="hljs-comment">// 结果: "home" | "user" | "settings"</span>
<span class="hljs-comment">// 注意: "logo-main" 匹配失败，返回 never，在联合类型中 never 会被自动过滤掉</span>
</code></pre>
<h3 data-id="heading-12">5. 递归类型 (Recursive Types)</h3>
<p>在上一节的基础上，我们再结合递归，可以更加灵活的处理字符串，接下来以 <code>TrimLeft</code> 举例：</p>
<p>目标：去除字符串左边的空格。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Space</span> = <span class="hljs-string">' '</span> | <span class="hljs-string">'\n'</span> | <span class="hljs-string">'\t'</span> <span class="hljs-comment">// 联合类型 包含三种空白字符</span>

<span class="hljs-comment">// 如果第一个字符是空白字符，就取除了第一个空白字符的剩余字符串，然后递归处理</span>
<span class="hljs-comment">// 否则直接取整个字符</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TrimLeft</span>&lt;S <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = S <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${Space}</span><span class="hljs-subst">${infer R}</span>`</span>
  ? <span class="hljs-title class_">TrimLeft</span>&lt;R&gt; <span class="hljs-comment">// 递归调用</span>
  : S <span class="hljs-comment">// 终止</span>

<span class="hljs-keyword">type</span> T = <span class="hljs-title class_">TrimLeft</span>&lt;<span class="hljs-string">'  cookie'</span>&gt; <span class="hljs-comment">// "cookie"</span>
</code></pre>
<p>如果你在纠结为什么不是 <code>\s</code> 而是 <code>' '</code>？这是因为 TypeScript 的模板字符串类型<strong>不支持正则表达式语法</strong>。这里的 <code>' '</code>、<code>'\n'</code>、<code>'\t'</code> 都是具体的字符串字面量类型，而 <code>\s</code> 是正则表达式的特殊语法，在类型系统中没有意义。</p>
<h2 data-id="heading-13">四、 映射类型与模板字符串的结合</h2>
<p>TypeScript 4.1 不仅引入了模板字符串类型，还支持在映射类型中使用 <code>as</code> 重命名键名。</p>
<h3 data-id="heading-14">1. <code>as</code> 语法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MappedType</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-title class_">NewKeyType</span>&lt;K&gt;]: T[K]
}
</code></pre>
<p>在之前<a href="https://juejin.cn/post/7363209007828746255" target="_blank" title="https://juejin.cn/post/7363209007828746255">《面试官：请实现 TS 中的 Pick 和 Omit》</a>一文中，在 <code>Omit</code> 的实现中就用到了 <code>as</code> 来剔除一些类型：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyOmit</span>&lt;T, K&gt; = {
  [P <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> P <span class="hljs-keyword">extends</span> K ? <span class="hljs-built_in">never</span> : P]: T[P];
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Todo</span> = {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoWithoutDescription</span> = <span class="hljs-title class_">MyOmit</span>&lt;<span class="hljs-title class_">Todo</span>, <span class="hljs-string">'description'</span>&gt;
<span class="hljs-comment">/*
type TodoWithoutDescription = {
  title: string
  completed: boolean
}
*/</span>
</code></pre>
<h3 data-id="heading-15">2. 在模板字符串中使用</h3>
<h4 data-id="heading-16">示例 1：添加前缀/后缀</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AddPrefix</span>&lt;T, <span class="hljs-title class_">Prefix</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-string">`<span class="hljs-subst">${Prefix}</span><span class="hljs-subst">${<span class="hljs-built_in">string</span> &amp; K}</span>`</span>]: T[K]
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PrefixedUser</span> = <span class="hljs-title class_">AddPrefix</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'user_'</span>&gt;
<span class="hljs-comment">// { user_name: string; user_age: number }</span>
</code></pre>
<blockquote>
<p><strong>为什么要 <code>string &amp; K</code>？</strong></p>
<p>因为 <code>K</code> 的类型是 <code>keyof T</code>，可能是 <code>string | number | symbol</code>。用交叉类型 <code>&amp;</code> 将其约束为 <code>string</code>。</p>
</blockquote>
<h4 data-id="heading-17">示例 2：生成 Getter/Setter</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Getters</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-string">`get<span class="hljs-subst">${Capitalize&lt;<span class="hljs-built_in">string</span> &amp; K&gt;}</span>`</span>]: <span class="hljs-function">() =&gt;</span> T[K]
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Setters</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-string">`set<span class="hljs-subst">${Capitalize&lt;<span class="hljs-built_in">string</span> &amp; K&gt;}</span>`</span>]: <span class="hljs-function">(<span class="hljs-params">val: T[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">StateGetters</span> = <span class="hljs-title class_">Getters</span>&lt;<span class="hljs-title class_">State</span>&gt;
<span class="hljs-comment">// { getCount: () =&gt; number; getName: () =&gt; string }</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">StateSetters</span> = <span class="hljs-title class_">Setters</span>&lt;<span class="hljs-title class_">State</span>&gt;
<span class="hljs-comment">// { setCount: (val: number) =&gt; void; setName: (val: string) =&gt; void }</span>
</code></pre>
<h4 data-id="heading-18">示例 3：移除特定前缀</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">RemovePrefix</span>&lt;T, <span class="hljs-title class_">Prefix</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> K <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">${Prefix}</span><span class="hljs-subst">${infer Rest}</span>`</span> ? <span class="hljs-title class_">Rest</span> : K]: T[K]
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span> {
  <span class="hljs-attr">api_name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">api_token</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CleanResponse</span> = <span class="hljs-title class_">RemovePrefix</span>&lt;<span class="hljs-title class_">ApiResponse</span>, <span class="hljs-string">'api_'</span>&gt;
<span class="hljs-comment">// { name: string; token: string; userId: number }</span>

<span class="hljs-comment">// 注意：传入空字符串作为前缀时，由于空字符串会匹配所有键名，但实际上不会移除任何内容</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CleanResponse1</span> = <span class="hljs-title class_">RemovePrefix</span>&lt;<span class="hljs-title class_">ApiResponse</span>, <span class="hljs-string">''</span>&gt;
<span class="hljs-comment">// { api_name: string; api_token: string; userId: number }</span>
</code></pre>
<h2 data-id="heading-19">五、 总结</h2>
<p>写这篇文章因为我在刷 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftype-challenges%2Ftype-challenges%2Fblob%2Fmain%2FREADME.zh-CN.md" target="_blank" title="https://github.com/type-challenges/type-challenges/blob/main/README.zh-CN.md" ref="nofollow noopener noreferrer">TypeScript 类型体操</a> 时，遇到了第一个模板字符串类型的题目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftype-challenges%2Ftype-challenges%2Fblob%2Fmain%2Fquestions%2F00106-medium-trimleft%2FREADME.zh-CN.md" target="_blank" title="https://github.com/type-challenges/type-challenges/blob/main/questions/00106-medium-trimleft/README.zh-CN.md" ref="nofollow noopener noreferrer">TrimLeft</a> 搜了半天没有发现现成的文章，干脆自己写一个。</p>
<p>如果你也对 TypeScript 类型体操感兴趣，欢迎一起来刷！💪🏻💪🏻💪🏻</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vikunja:开源自托管的待办事项管理平台,重新定义你的任务管理体验]]></title>    <link>https://juejin.cn/post/7597650322408292404</link>    <guid>https://juejin.cn/post/7597650322408292404</guid>    <pubDate>2026-01-21T14:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408292404" data-draft-id="7597635202325168180" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Vikunja:开源自托管的待办事项管理平台,重新定义你的任务管理体验"/> <meta itemprop="keywords" content="产品"/> <meta itemprop="datePublished" content="2026-01-21T14:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Vikunja:开源自托管的待办事项管理平台,重新定义你的任务管理体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:51:17.000Z" title="Wed Jan 21 2026 14:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数字化时代，我们每天都要处理无数的任务和项目。无论是工作上的项目规划，还是生活中的购物清单，一个优秀的待办事项管理工具都能让我们的生活更加有序高效。今天，我要向大家介绍一款功能简洁实用、完全开源的自托管任务管理平台——Vikunja。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc4662bf0e941c2b2f0a39008823b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=H8io97tbcEZ3fnkBW2AthhkX3nI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🧠 什么是Vikunja？</h2>
<p>Vikunja是一个用Go语言编写的开源待办事项应用程序，旨在帮助个人和团队更好地组织生活和工作。它的设计理念是“简单而不简陋”——提供了丰富的功能，同时保持了直观的用户体验。</p>
<p>与许多商业任务管理工具不同，Vikunja是完全开源的（采用AGPL-3.0许可证），这意味着你可以完全控制自己的数据，无需担心隐私问题或供应商锁定。</p>
<ul>
<li>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgo-vikunja%2Fvikunja" target="_blank" title="https://github.com/go-vikunja/vikunja" ref="nofollow noopener noreferrer">github.com/go-vikunja/…</a></li>
<li>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvikunja.io%2F" target="_blank" title="https://vikunja.io/" ref="nofollow noopener noreferrer">vikunja.io/</a></li>
<li>在线演示： <a href="https://link.juejin.cn?target=https%3A%2F%2Ftry.vikunja.io%2F" target="_blank" title="https://try.vikunja.io/" ref="nofollow noopener noreferrer">try.vikunja.io/</a></li>
<li>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvikunja.io%2Fdocs%2F" target="_blank" title="https://vikunja.io/docs/" ref="nofollow noopener noreferrer">vikunja.io/docs/</a></li>
</ul>
<p>该项目目前在github上已有3.1k ⭐️star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/129b9c7081034bbe9016ef794ce92eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=Afeh1H1Jl2ju9XKXvn7oPYZ2C%2FE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">🗣️核心特性亮点</h2>
<h3 data-id="heading-2">🌟 多功能任务管理</h3>
<p>Vikunja不仅仅是一个简单的待办事项清单。它支持：</p>
<ul>
<li><strong>列表和看板视图</strong>：灵活切换不同视图方式</li>
<li><strong>子任务和依赖关系</strong>：创建复杂的任务层次结构</li>
<li><strong>标签和筛选器</strong>：轻松组织和查找任务</li>
<li><strong>截止日期和提醒</strong>：确保不会错过重要事项</li>
<li><strong>附件支持</strong>：上传相关文件和图片</li>
</ul>
<h3 data-id="heading-3">🔗 团队协作功能</h3>
<ul>
<li><strong>项目共享</strong>：与团队成员协作完成任务</li>
<li><strong>评论系统</strong>：在任务上进行讨论</li>
<li><strong>权限管理</strong>：精细的访问控制</li>
</ul>
<h3 data-id="heading-4">📱 全平台支持</h3>
<ul>
<li><strong>Web界面</strong>：现代化的响应式设计</li>
<li><strong>移动应用</strong>：Android和iOS应用</li>
<li><strong>API驱动</strong>：完整的REST API支持</li>
<li><strong>第三方集成</strong>：可与现有工作流集成</li>
</ul>
<p>安装包地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.vikunja.io%2Fdesktop%2F" target="_blank" title="https://dl.vikunja.io/desktop/" ref="nofollow noopener noreferrer">dl.vikunja.io/desktop/</a></p>
<h2 data-id="heading-5">🫖技术架构</h2>
<p>Vikunja采用现代化的技术栈构建：</p>
<ul>
<li><strong>后端</strong>：Go语言，性能优异</li>
<li><strong>前端</strong>：Vue.js，响应式设计</li>
<li><strong>数据库支持</strong>：PostgreSQL、MySQL/MariaDB、SQLite</li>
<li><strong>API文档</strong>：Swagger/OpenAPI自动生成</li>
</ul>
<h2 data-id="heading-6">🍵部署方式多样化</h2>
<p>Vikunja提供了灵活的部署选项，适应不同用户的需求,我们选择的是docker部署：</p>
<h3 data-id="heading-7">🐳 Docker部署（推荐）</h3>
<p>最简单的部署方式，提供完整的docker-compose配置示例(我是用的是sqllite)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">vikunja:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">vikunja/vikunja</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">VIKUNJA_SERVICE_JWTSECRET:</span> <span class="hljs-string">vikunja</span>
      <span class="hljs-attr">VIKUNJA_SERVICE_PUBLICURL:</span> <span class="hljs-string">http://192.168.31.195:3456/</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">3456</span><span class="hljs-string">:3456</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./files:/app/vikunja/files</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./db:/db</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<p>创建过载目录并授权</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$PWD</span>/files <span class="hljs-variable">$PWD</span>/db

<span class="hljs-built_in">chown</span> 1000 <span class="hljs-variable">$PWD</span>/files <span class="hljs-variable">$PWD</span>/db
</code></pre>
<p>启动服务</p>
<pre><code class="hljs">docker-compose up -d 
</code></pre>
<h2 data-id="heading-8">🔧配置灵活性</h2>
<h3 data-id="heading-9">🧿数据库支持</h3>
<ul>
<li><strong>PostgreSQL</strong>（推荐用于生产环境）</li>
<li><strong>MySQL/MariaDB</strong></li>
<li><strong>SQLite</strong>（适合个人使用或轻量级部署）</li>
</ul>
<h3 data-id="heading-10">💾缓存系统</h3>
<p>对于高负载环境，Vikunja支持Redis作为缓存后端：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">VIKUNJA_REDIS_ENABLED:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">VIKUNJA_REDIS_HOST:</span> <span class="hljs-comment">'redis:6379'</span>
<span class="hljs-symbol">VIKUNJA_CACHE_ENABLED:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">VIKUNJA_CACHE_TYPE:</span> redis
</code></pre>
<h2 data-id="heading-11">✳️ 开始使用</h2>
<p>首次使用需要先注册用户</p>
<ul>
<li>注册用户</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6411a785255a41eb8c2b3b885f0c6567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=PyZwHc6imC7kQKx8vLGVr8XiHE8%3D" alt="" loading="lazy"/></p>
<ul>
<li>首页</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec9582299e8c492e9bbee60e1cb89a1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=11i0mOGIOTClIBwSGsbFBJLkL3E%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb539a116dcd400eb8aeb2334e487014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=Bv8y8werKbBtaKjYASH5ibPLTEs%3D" alt="" loading="lazy"/></p>
<ul>
<li>创建团队、标签、创建项目</li>
<li>添加代办、设置代办</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/667043c775b948e7b98aa223c1161c1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=EV%2FsOC9XaCXPtyXnmGBceUil9Ls%3D" alt="" loading="lazy"/></p>
<ul>
<li>列表、甘特图、看板、表格</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8f9a0208a19465389a251ddaf648580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=sBcbVA4fsmgOiaQr73zZfVhi%2FLk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">🌑结语</h2>
<p>Vikunja代表了一种新的任务管理理念——强大而不复杂，功能丰富而不臃肿。它既适合个人用户管理日常任务，也适合团队协作完成复杂项目。</p>
<p>无论你是注重隐私的个人用户，还是需要自托管解决方案的企业，Vikunja都值得一试。它的开源本质意味着你永远不必担心供应商锁定或突然的功能变更。</p>
<p>在这个数据隐私日益重要的时代，拥有一个既能满足功能需求又能保障数据安全的任务管理工具变得越来越重要。Vikunja正是在这样的需求下应运而生，为用户提供了一个完美的解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c5f29fdc6424e279ff6b07250a5c861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=esd7g7WMzQsvY6C2LlvATZ9%2BRnA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">🐟今日摸鱼小贴士：带薪拉屎</h2>
<p>据民间不完全统计，每天“带薪如厕”30分钟，一年下来就相当于为自己“创造”了11天的带薪假期。这种“无中生假”的艺术，堪称当代职场人的隐秘福利，也是年轻工作者在规则之内、为自己争取片刻呼吸的权利。现在，你懂了吗？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7304365cbb444b5ca4c1e3ac60b6edba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611877&amp;x-signature=b6RiUusJGyz1JIChjAThIW58LbE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的电网绝缘子破损与闪络缺陷智能检测系统识别项目 [目标检测完整源码]]]></title>    <link>https://juejin.cn/post/7597622924272697371</link>    <guid>https://juejin.cn/post/7597622924272697371</guid>    <pubDate>2026-01-21T13:03:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597622924272697371" data-draft-id="7597622924272680987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的电网绝缘子破损与闪络缺陷智能检测系统识别项目 [目标检测完整源码]"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-21T13:03:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的电网绝缘子破损与闪络缺陷智能检测系统识别项目 [目标检测完整源码]
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T13:03:42.000Z" title="Wed Jan 21 2026 13:03:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的电网绝缘子破损与闪络缺陷智能检测系统识别项目 [目标检测完整源码]</h2>
<h3 data-id="heading-1">一、研究背景与工程问题分析</h3>
<p>随着电力系统规模的不断扩大，输电线路和变电设备的运行安全已成为电网运维中的核心问题之一。在众多电力设备中，<strong>绝缘子</strong>承担着电气隔离与机械支撑的双重任务，其运行状态直接影响电网的稳定性与可靠性。</p>
<p>在长期运行过程中，绝缘子通常会受到以下不利因素影响：</p>
<ul>
<li>长期高压电场作用导致材料老化</li>
<li>风沙、盐雾、工业污染物附着</li>
<li>高湿环境下易发生表面放电</li>
<li>外力冲击造成瓷裙破损或脱落</li>
</ul>
<p>由此产生的典型缺陷主要包括 <strong>绝缘子破损</strong> 与 <strong>绝缘子闪络</strong>。这类缺陷具有隐蔽性强、分布范围广、人工巡检成本高等特点，一旦未能及时发现，极易引发线路跳闸、设备损毁，甚至区域性停电事故。</p>
<p>传统的人工巡检方式已逐渐暴露出明显不足：</p>
<ul>
<li>巡检效率难以覆盖大规模线路</li>
<li>高空、野外作业存在安全风险</li>
<li>检测结果依赖个人经验，缺乏一致性</li>
</ul>
<p>在此背景下，结合无人机巡检、固定摄像头采集手段，引入<strong>基于深度学习的视觉检测技术</strong>，构建自动化缺陷识别系统，已成为智能电网发展的重要方向。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a901862500334de3870fc829cdd18210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=YXJRj3lXEvAR3li1n3q36sFPPWI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">源码下载与效果演示</h3>
<p>哔哩哔哩视频下方观看：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1Qk8uz6E9f%2F" target="_blank" title="https://www.bilibili.com/video/BV1Qk8uz6E9f/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Qk…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4810ea2df5e4fd5b6b4ecdf82d045c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=5awxg4Dui8SyNRwg9NKVYkZJ3qI%3D" alt="在这里插入图片描述" loading="lazy"/>
包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<h3 data-id="heading-3">二、系统总体设计思路</h3>
<p>本项目以 <strong>YOLOv8 目标检测模型</strong> 为核心算法，面向电力巡检场景进行专项训练，并通过 <strong>PyQt5 图形界面</strong> 实现完整的工程化封装，最终形成一套可直接投入使用的 <strong>电网绝缘子缺陷智能检测系统</strong>。</p>
<h4 data-id="heading-4">系统设计目标包括：</h4>
<ol>
<li><strong>高检测准确率</strong>：能够稳定识别破损与闪络缺陷</li>
<li><strong>实时推理能力</strong>：满足视频流与在线巡检需求</li>
<li><strong>良好可用性</strong>：非算法人员也可直接操作</li>
<li><strong>可扩展性强</strong>：便于后期模型升级与功能拓展</li>
</ol>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d5247a95cdd43debc9c4b84f1bf4703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=XRZKfg64z0EFKdCBT937ge4yUGk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5">三、整体系统架构</h3>
<p>系统采用典型的分层架构设计，各模块职责清晰、相互解耦：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌───────────────┐
│ 数据采集层    │  图像 / 视频 / 摄像头 / 无人机
└───────┬───────┘
<span class="hljs-code">        │
┌───────▼───────┐
│ YOLOv8 推理层 │  缺陷检测与分类
└───────┬───────┘
        │
┌───────▼───────┐
│ 结果解析层    │  类别 / 置信度 / 坐标
└───────┬───────┘
        │
┌───────▼───────┐
│ PyQt5 界面层  │  可视化展示与交互
└───────────────┘
</span></code></pre>
<p>该架构的优势在于：</p>
<ul>
<li>算法模块可独立替换或升级</li>
<li>UI 与模型完全解耦，降低维护成本</li>
<li>支持本地部署或后续服务化改造
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f847c27e45b841f0970f5e43d802743a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=Vkh3DYX3uNEVwD7cSktcxmgbu%2Bk%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<hr/>
<h3 data-id="heading-6">四、检测目标定义与业务建模</h3>
<h4 data-id="heading-7">4.1 缺陷类别建模</h4>
<p>结合电力运维业务需求，本项目共定义三类检测目标：</p>





















<table><thead><tr><th>类别</th><th>业务含义</th></tr></thead><tbody><tr><td>绝缘子</td><td>正常完整的绝缘子本体</td></tr><tr><td>破损</td><td>瓷裙缺失、裂纹、结构破坏</td></tr><tr><td>闪络</td><td>放电痕迹、污染导致的表面闪络</td></tr></tbody></table>
<p>这种分类方式不仅能够识别缺陷类型，还可为后续<strong>缺陷定位、统计分析与风险分级</strong>提供基础数据支持。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e788eed04e9240a8a086d26e9c707e15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=Q0kldCr8I0rD3ZTszvx52Uroobg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-8">4.2 数据集构建原则</h4>
<p>为了保证模型在实际场景中的泛化能力，数据集构建阶段重点考虑：</p>
<ul>
<li>不同拍摄高度（模拟无人机巡检）</li>
<li>不同光照条件（逆光、阴影、强反射）</li>
<li>复杂背景（山地、树林、建筑）</li>
<li>正常与缺陷样本的合理比例</li>
</ul>
<p>数据统一采用 YOLO 标准格式，便于训练、推理与工程复用。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b28ef0828e548e2b035033aa4597d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=ytkH%2FEY5l%2Bais4T24YXuYjv4qDk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9">五、YOLOv8 模型选型与训练流程</h3>
<h4 data-id="heading-10">5.1 YOLOv8 在工业场景中的优势</h4>
<p>YOLOv8 作为 Ultralytics 推出的新一代检测模型，在工程实践中具备以下优势：</p>
<ul>
<li>Anchor-Free 设计，减少人工调参</li>
<li>更合理的损失函数设计，提高收敛稳定性</li>
<li>推理接口高度封装，工程接入成本低</li>
<li>兼容 ONNX、TensorRT 等多种部署形式</li>
</ul>
<p>对于绝缘子这类<strong>尺度变化大、形态细长、背景复杂</strong>的目标，YOLOv8 在精度与速度之间取得了良好平衡。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de77e22508cb450f92652bd8a77ace92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=7f%2BgIc87ii7jYuwyi6B%2BKQ5KF08%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-11">5.2 模型训练流程</h4>
<p>训练流程主要包括：</p>
<ol>
<li>数据清洗与标注校验</li>
<li>训练 / 验证集划分</li>
<li>模型初始化与参数配置</li>
<li>多轮迭代训练与性能评估</li>
</ol>
<p>训练过程中重点关注以下指标：</p>
<ul>
<li><code>mAP@0.5</code>：整体检测能力</li>
<li>混淆矩阵：破损与闪络的区分效果</li>
<li>Loss 曲线：模型是否稳定收敛</li>
</ul>
<p>当模型在验证集上表现稳定后，即可用于推理部署。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/732d68378f174b6b992f1949e9c1f01a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=FuMDKCZaqmIFVvI10dBGcyweNb4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-12">六、推理流程与缺陷结果解析</h3>
<p>YOLOv8 提供了简洁高效的推理接口，推理阶段主要完成以下工作：</p>
<ul>
<li>加载训练完成的权重文件</li>
<li>对输入图像或视频帧进行检测</li>
<li>输出目标类别、置信度与边界框</li>
</ul>
<p>在视频与摄像头模式下，系统采用逐帧检测方式，并通过合理的帧率控制，确保检测效果与实时性之间的平衡。</p>
<hr/>
<h3 data-id="heading-13">七、PyQt5 图形化系统设计</h3>
<p>为了提升系统的可用性，本项目引入 PyQt5 构建桌面级可视化应用，核心功能包括：</p>
<ul>
<li>多种检测模式切换（图片 / 视频 / 摄像头）</li>
<li>实时显示检测结果与缺陷标签</li>
<li>一键保存检测结果图片或视频</li>
<li>自动管理输出目录，便于后期复核</li>
</ul>
<p>该界面设计使系统能够直接服务于<strong>运维人员与巡检人员</strong>，而不仅仅局限于算法研究。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1abe2bb134c24df285f4e4fac7af1663~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605421&amp;x-signature=p%2BCJ19jPzKDFDbr5MD7ITJr6I8E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-14">八、典型应用场景与扩展方向</h3>
<h4 data-id="heading-15">8.1 实际应用场景</h4>
<ul>
<li>输电线路无人机巡检</li>
<li>变电站设备日常检查</li>
<li>电网缺陷快速筛查与统计</li>
<li>智能运维示范项目</li>
</ul>
<h4 data-id="heading-16">8.2 可扩展方向</h4>
<ul>
<li>缺陷严重程度自动分级</li>
<li>与巡检工单系统对接</li>
<li>缺陷时序变化分析</li>
<li>多模型协同检测（如分割 + 检测）</li>
</ul>
<hr/>
<h3 data-id="heading-17">九、总结与思考</h3>
<p>本文围绕电网绝缘子破损与闪络缺陷检测这一典型工业视觉问题，系统性地介绍了一套 <strong>基于 YOLOv8 的智能检测系统</strong> 的完整实现过程。从问题背景、系统架构、模型训练，到可视化应用与工程部署，展示了深度学习技术在电力运维场景中的实际价值。</p>
<p>实践表明，<strong>只有将算法能力与工程需求深度结合，AI 技术才能真正落地并产生长期价值</strong>。本项目不仅适合作为电力巡检智能化的参考方案，也为其他工业缺陷检测场景提供了可复用的技术范式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现影像裁剪]]></title>    <link>https://juejin.cn/post/7597623395907977262</link>    <guid>https://juejin.cn/post/7597623395907977262</guid>    <pubDate>2026-01-21T13:08:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623395907977262" data-draft-id="7597640029574447155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现影像裁剪"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T13:08:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现影像裁剪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T13:08:11.000Z" title="Wed Jan 21 2026 13:08:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>GDAL作为地理空间数据处理的核心工具，提供了多种影像裁剪方式，可以方便的提取目标区域遥感影像数据，为数据处理和分析提供高效服务。</p>
<p>在地理空间数据处理中，影像裁剪是基础且高频的操作，其核心目标是从整幅遥感影像或栅格数据中提取指定地理范围的子集，以降低数据体量、聚焦研究区域，满足专题分析、地图制作、数据共享等多样化业务需求。</p>
</blockquote>
<p>由于本文由一些前置知识，在正式开始之前，需要你掌握一定的<code>Python</code>开发基础和<code>GDAL</code>的基本概念。在之前的文章中讲解了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，可以作为基础入门学习。</p>
<p>本篇教程在之前一系列文章的基础上讲解如何使用<strong>GDAL 实现影像裁剪</strong>。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2026年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.11</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 数据准备</h2>
<p>俗话说巧妇难为无米之炊，数据就是软件的基石，没有数据，再美好的设想都是空中楼阁。因此，第一步需要下载遥感影像数据。</p>
<p>但是，影像数据在哪里下载呢？别着急，本文都给你整理好了。</p>
<p>数据下载可参考文章：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5c_J7f0xkUXEv7_z0eNweQ" target="_blank" title="https://mp.weixin.qq.com/s/5c_J7f0xkUXEv7_z0eNweQ" ref="nofollow noopener noreferrer">GIS 影像数据源介绍</a></strong></p>
<p>如下，这是我在【地理空间数据云】平台下载的<code>landsat8</code>遥感影像。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c17257dedf942bba7a98241a801678a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=YyY9sihTHirNbWous6iigX0Tys4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 导入依赖</h2>
<p><code>GeoTIFF</code>作为一种栅格数据格式，可以使用<code>GDAL</code>直接进行处理，以实现影像数据的裁剪操作。</p>
<p>在影像裁剪开始之前，需要检查数据路径是否正确，所以导入<code>os</code>模块。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> osgeo <span class="hljs-keyword">import</span> gdal
<span class="hljs-keyword">import</span> os
</code></pre>
<h2 data-id="heading-5">4. 影像裁剪</h2>
<p>定义一个方法<code>image_clip(output_file,input_file,clip_file)</code>用于实现影像数据裁剪。</p>
<p>本研究采用矢量范围提取影像区域，实现栅格数据按掩膜裁剪功能。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：GDAL 影像裁剪
参数：
    -output_file：输出裁剪后的影像
    -input_files：输入需要裁剪的的影像
    -clip_file：用于影像裁剪的矢量文件
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">image_clip</span>(<span class="hljs-params">output_file,input_file,clip_file</span>):
</code></pre>
<p>在数据裁剪之前，使用方法<code>checkFilePath</code>检查数据路径。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 检查文件是否存在</span>
checkFilePath(input_file)
<span class="hljs-string">"""
说明：检查文件路径是否正常
参数：
-filePath：文件数据路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">checkFilePath</span>(<span class="hljs-params">filePath</span>):
    <span class="hljs-keyword">if</span> os.path.exists(filePath):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{filePath}</span> 文件数据路径存在"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{filePath}</span> 文件数据路径不存在，请检查！"</span>)
</code></pre>
<p>使用<code>gdal.WarpOptions</code>选项定义裁剪参数，其中参数<code>cutlineDSName</code>为用于提取范围的矢量数据源，<code>cropToCutline</code>为布尔类型，表示是否使用裁剪线作为输出边界，<code>dstNodata</code>为设置<code>NoData</code>值。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 定义裁剪参数</span>
<span class="hljs-attr">options</span> = gdal.WarpOptions(
    <span class="hljs-attr">cutlineDSName</span>=clip_file,
    <span class="hljs-attr">cropToCutline</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">dstNodata</span>=<span class="hljs-number">0</span>
)
</code></pre>
<p>这个方法参数非常多，感兴趣的同学可以到官网查看。</p>
<p><code>https://gdal.org/en/stable/api/python/utilities.html#osgeo.gdal.WarpOptions</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec03aa001a55418882802b12307497d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=ohqL%2FmQ5DahmuZUiP5TxNalrVg0%3D" alt="" loading="lazy"/></p>
<p>调用<code>gdal</code>对象方法<code>Warp</code>进行影像裁剪，该函数第一个参数<code>destNameOrDestDS</code> 为输出数据集名称或者数据源，第二个参数<code>srcDSOrSrcDSTab</code>为源数据，第三个参数<code>options</code>为可选项描述，用于定义影像裁剪信息。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5db04646b244df0a365b071400dffd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=2oV6tIhmPVES%2B8Lmozx9VFUKLRw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">gdal.Warp(output_file,input_file,<span class="hljs-attr">options</span>=options)
</code></pre>
<p>在<code>main</code>函数中调用合并方法。</p>
<pre><code class="hljs language-ini" lang="ini">if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:

    <span class="hljs-attr">input_file</span> = <span class="hljs-string">"E:\ArcGIS\band_432.tif"</span>

    <span class="hljs-attr">output_file</span> = <span class="hljs-string">"E:\ArcGIS\clip_result.tif"</span>

    <span class="hljs-attr">clip_file</span> = <span class="hljs-string">"E:\data\target.shp"</span>

    image_clip(output_file,input_file,clip_file)
</code></pre>
<hr/>
<blockquote>
<p>注：GDAL某些参数是真难记，难写啊，比如WarpOptions对象。</p>
<p>GIS之路</p>
</blockquote>
<p><strong>图片效果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f6d256887a4e9a8f54d5acc27c970d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=8CpZCUZYJLfRKNWjeK%2BGoW6%2BDjY%3D" alt="" loading="lazy"/></p>
<p><strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34df1044df2f44da987f4fcee3bc06cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=SGRX57CHX6xQq8eubrPHsGnekX4%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>vector</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/768151730d5540d4afbb40ae44d14502~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=rXn%2BFzXNBauC5ZU83BDVX0E5Yrc%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f56cdbc2e0c4672a6fa0741dff64089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=WGAHRsbGWmdqcwDZPcp%2FmHvKOq8%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a099f11e6f84d9fa661ddb5675c748e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=EopWBgp0Zj0nRiDXeyptATOKmIE%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/decae22f59834f3cbc0758d006c39074~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769605691&amp;x-signature=iOA1ssRWtfjkjwoZSPEXuHnUVAY%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FeOTtaQXdeB-hOO39GmBrtw" target="_blank" title="https://mp.weixin.qq.com/s/eOTtaQXdeB-hOO39GmBrtw" ref="nofollow noopener noreferrer">GDAL 实现影像合并</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGynyIuYw2eRJ4y6gZ8oSLQ" target="_blank" title="https://mp.weixin.qq.com/s/GynyIuYw2eRJ4y6gZ8oSLQ" ref="nofollow noopener noreferrer">小小声说一下GDAL的官方API接口</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlEqKlTbHKzJ25XsIX6CBuw" target="_blank" title="https://mp.weixin.qq.com/s/lEqKlTbHKzJ25XsIX6CBuw" ref="nofollow noopener noreferrer">《云南省加快构建现代化产业体系推进产业强省建设行动计划》发布</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8ZDl_-gzCVWrvGAe-VNe8Q" target="_blank" title="https://mp.weixin.qq.com/s/8ZDl_-gzCVWrvGAe-VNe8Q" ref="nofollow noopener noreferrer">ArcGIS Pro 添加底图的方式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FE9BrT9VzidvziCayXgRCQA" target="_blank" title="https://mp.weixin.qq.com/s/E9BrT9VzidvziCayXgRCQA" ref="nofollow noopener noreferrer">为什么每次打开 ArcGIS Pro 页面加载都如此缓慢？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FutAlI_LUDTwMiHOxzu2hDw" target="_blank" title="https://mp.weixin.qq.com/s/utAlI_LUDTwMiHOxzu2hDw" ref="nofollow noopener noreferrer">ArcGIS 波段合成操作</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQVFiW5C5wXQ6a1WODCaH0g" target="_blank" title="https://mp.weixin.qq.com/s/QVFiW5C5wXQ6a1WODCaH0g" ref="nofollow noopener noreferrer">自然资源部党组关于苗泽等4名同志职务任免的通知</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJmv3J_bjbBG-4jB72zS3hw" target="_blank" title="https://mp.weixin.qq.com/s/Jmv3J_bjbBG-4jB72zS3hw" ref="nofollow noopener noreferrer">GDAL 创建矢量图层的两种方式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwkHv2NnJfuPhtyjJcFLrEQ" target="_blank" title="https://mp.weixin.qq.com/s/wkHv2NnJfuPhtyjJcFLrEQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据转换处理（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FMZIQ57Ka3NQfKFi9AuEQEg" target="_blank" title="https://mp.weixin.qq.com/s/MZIQ57Ka3NQfKFi9AuEQEg" ref="nofollow noopener noreferrer">GDAL 实现投影转换</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fz_naHKef17txAV2l30zCvg" target="_blank" title="https://mp.weixin.qq.com/s/z_naHKef17txAV2l30zCvg" ref="nofollow noopener noreferrer">GDAL 实现矢量合并</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSX2u2ww1iNOtqR5m3BE93g" target="_blank" title="https://mp.weixin.qq.com/s/SX2u2ww1iNOtqR5m3BE93g" ref="nofollow noopener noreferrer">国产版的Google Earth，吉林一号卫星App“共生地球”来了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfWufqSyplniNj4Q3BRRbAQ" target="_blank" title="https://mp.weixin.qq.com/s/fWufqSyplniNj4Q3BRRbAQ" ref="nofollow noopener noreferrer">2026年全国自然资源工作会议召开</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FuI-pb6NHVIQQBn84zgbVzQ" target="_blank" title="https://mp.weixin.qq.com/s/uI-pb6NHVIQQBn84zgbVzQ" ref="nofollow noopener noreferrer">GDAL 实现矢量裁剪</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4l8z3pCgtMA7mgDV2-SSfA" target="_blank" title="https://mp.weixin.qq.com/s/4l8z3pCgtMA7mgDV2-SSfA" ref="nofollow noopener noreferrer">GDAL 实现空间分析</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent框架探秘：拆解 OpenHands（2）--- CodeAct论文]]></title>    <link>https://juejin.cn/post/7597640029574545459</link>    <guid>https://juejin.cn/post/7597640029574545459</guid>    <pubDate>2026-01-21T13:28:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640029574545459" data-draft-id="7596181746061541403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent框架探秘：拆解 OpenHands（2）--- CodeAct论文"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-21T13:28:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent框架探秘：拆解 OpenHands（2）--- CodeAct论文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T13:28:32.000Z" title="Wed Jan 21 2026 13:28:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI Agent框架探秘：拆解 OpenHands（2）--- CodeAct论文</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 概要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 背景知识</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 Devin &amp; OpenHands（原OpenDevin）</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 CodeAct 的意义</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 设计思路</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 ReAct 范式</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 CodeAct 范式</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 Python-use范式</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.4 CodeAct vs ReAct</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.5 CodeAct vs 函数调用</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.6 ReCode 范式</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 概要</h3>
<p>CodeAct 是 OpenHands 的基石。</p>
<p>CodeAct =「用可执行代码做一切 Action」，把可执行代码当作最核心的行动（Action）形态，让 LLM 用‘写代码-跑代码-看结果’的循环，替代传统文本或 JSON 式工具调用，以进一步完成复杂任务的手段。”把 LLM 从“文本交互”升级为“脚本交互”，让反馈闭环、工具统一、推理外化、扩展无摩擦。</p>
<p>另外，Manus 也使用了 CodeAct。</p>
<p>希望通过本文，读者可以了解ReAct，CodeAct 这两种范式，基于此，可以对 OpenHands 做进一步学习。</p>
<p>因为本系列借鉴的文章过多，可能在参考文献中有遗漏的文章，如果有，还请大家指出。</p>
<h3 data-id="heading-2">0x01 背景知识</h3>
<h4 data-id="heading-3">1.1 Devin &amp; OpenHands（原OpenDevin）</h4>
<p>‌Devin是由Cognition AI开发的全球首个AI程序员，具备全栈开发能力，能自主完成代码编写、调试、部署及AI模型训练等任务‌。Devin 代表了一种先进的自主代理，旨在应对软件工程的复杂性。它利用了诸如 shell、代码编辑器和网络浏览器等工具的组合，展示了 LLM 在软件开发中未被充分利用的潜力。</p>
<p>OpenDevin 项目诞生于复制、增强并创新原始 Devin 模型的愿望。OpenDevin 的目标是探索并扩展 Devin 的能力，识别其优势和改进领域，以指导开放代码模型的进展。通过吸引开源社区的参与，OpenDevin 旨在应对 Code LLM 在实际场景中面临的挑战，产出对社区有重大贡献的作品，并为未来的进步铺平道路。</p>
<p>OpenHands 目前 GitHub 星标数已超 6.5 万。</p>
<h4 data-id="heading-4">1.2 CodeAct 的意义</h4>
<p>在自然语言处理领域，大语言模型（LLM）已经取得了实打实的突破 —— 它们不止处理文本，还能调用 API、管理内存，甚至控制机器人。但传统的 LLM 代理有个问题：它们通常是生成 JSON 或者固定格式的文本来说明要做什么，这就导致能做的动作有限，也不够灵活。</p>
<p>CodeAct 是一种新的代理框架，它让 LLM 直接生成可执行的 Python 代码来 “做事”，即以 code 为 action，用代码解决复杂问题。简单说，LLM 写一段 Python 代码，而 CodeAct 里集成了 Python 解释器，能直接运行这段代码；而且在多轮交互中，LLM 还能处理和存储中间结果，根据新的结果调整代码，相当于用 Python 代码统一了 LLM 代理的 “行动方式”。当然，写代码不是目的，而是用这种通用的方式解决各种问题。这种框架克服了传统LLM代理的多个限制。</p>
<p>具体展开，CodeAct 有四个鲜明特征：</p>
<ul>
<li>统一行动空间：文本、JSON、函数调用、Shell、SQL、绘图、网页抓取等，全部收敛成一段 Python（或其他语言）代码；模型只需会写代码，就能完成多模态、多工具、多步骤任务，无需记忆五花八门的 API 参数格式。</li>
<li>闭环反馈机制：代码被解释器（或沙箱）真正执行，标准输出、报错、异常栈、运行时间、生成的文件/图片/表结构等，会原样返回给模型当作下一步 prompt的部分内容；模型可立即“看见”自己行动的后果，形成「写-跑-看-改」的强化循环，显著降低幻觉。</li>
<li>复杂推理外化：多步数学推导、表格合并、统计检验、迭代优化等，不必在隐状态里“心算”，而是外化为可读可改的代码；人类用户也能复查、断点、调试，解释性远高于黑盒 Chain-of-Thought。</li>
<li>零额外接口成本：传统 Agent 每接入一个新能力就要封装一套 JSON Schema/Tool Description；CodeAct 侧只需在沙箱里预装对应库（matplotlib、pandas、requests、selenium…），模型立刻可用，扩展成本趋近于零。</li>
</ul>
<h3 data-id="heading-5">0x02 设计思路</h3>
<p>不同的Agent框架其实是不同作者设计思路的体现，对“智能”本质的不同理解。这些框架在模块拆解方式、任务控制逻辑、执行流程设计上差异显著，体现了不同的技术思路与设计哲学，适用于不同的应用场景。</p>
<ul>
<li>比如可以只提供少数能力， 只给出大致步骤（prompt比较简单，只给出大致步骤），不进行强制和严格的限制，让模型可以灵活探索，让模型自主决定解决流程。</li>
<li>也可以通过精巧的Prompt Engineering提供复杂指令，让 Agent 能够进行深度思考、多轮对话、调用工具以及长期记忆等操作，从而提升感知和行动的智能水平。</li>
<li>又比如，Pocket Flow的作者Zachary Huang博士认为，LLM框架本质上就是一个简单的有向图。</li>
<li>也有人认为，构建一个有用的Agent，并非源于模型智力的飞跃，而是源于如何围绕模型设计一套行之有效的「认知流程」。</li>
</ul>
<h4 data-id="heading-6">2.1 ReAct 范式</h4>
<p><strong>架构全称</strong>：Reasoning（推理）+ Acting（行动）。</p>
<p>人解决复杂问题的聪明之处，往往是 “想清楚再动手”—— 拿到需求先拆解开、分析明白，有了清晰思路再行动。ReAct 范式就是把这种人类的思考方式教给 AI 代理，打破了以前 “输入啥就输出啥” 的黑箱模式，让每一步行动都能查到思考过程。 即ReAct 让Agent学会 “三思而后行”。</p>
<h5 data-id="heading-7">2.1.1 流程</h5>
<p>ReAct (Reason + Act) 是一种标准的“三步走”节拍，它解决了模型要么只会空想、要么只会盲动的难题，它让模型不再一次性输出最终答案，而是循环执行三个步骤：</p>
<ol>
<li><strong>Thought（思考）</strong> ：模型分析当前情况，决定下一步做什么。</li>
<li><strong>Action（行动）</strong> ：模型生成工具调用指令（Function Call）。</li>
<li><strong>Observation（观察）</strong> ：运行时环境执行工具，并将结果（Output）反馈给模型。</li>
</ol>
<p>这个过程周而复始，构成了反馈循环（ <strong>Thought → Action → Observation</strong> ），直到任务完成，对应图例如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a73c8284f4440f3a3306ce9ba948840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606911&amp;x-signature=PdpTChY%2Bu%2F3sLfIE6VCFg9JrJcU%3D" alt="react_sequence" loading="lazy"/></p>
<p>react_sequence</p>
<p>ReAct 范式的核心是：</p>
<ul>
<li>“推理” 和 “行动” 形成循环，即，边想边干，干完再看，看完再想”</li>
<li>接收反馈后采用什么方式决策？代理必须决定是否重复（进行下一轮思考）或结束循环</li>
<li>和环境之间通信的上下文如何管理。</li>
</ul>
<p>在 OpenHands 里，“推理” 就是代理的 “思考记录”：面对任务目标和之前的反馈，代理会生成一段类似 “内心想法” 的内容，比如 “现在代码报错是缺依赖包，得先执行安装命令”，这些思考会存在 <code>AgentThinkAction</code> 或者相关动作的思维字段里。“行动” 就是把思考变成机器能执行的指令，比如生成带具体命令的 <code>CmdRunAction</code> 对象，确保操作能精准落地。</p>
<h5 data-id="heading-8">2.1.2 原理</h5>
<p>有研究者提出，Agent的运行过程本质上就是一条<strong>概率链（Probability Chain）</strong> 。</p>
<p>将Agent视为概率链，意味着我们的设计工作不再是“教模型说话”，而是“操纵概率”。</p>
<p>目前最流行的Agent模式莫过于<strong>ReAct (Reasoning + Acting)</strong> 。也就是让模型在行动之前先生成一段“Thought”（思考）。但您有没有想过，为什么多生成一段文字（思考），就能提高任务成功率？</p>
<p>研究者给出了数学上的解释：引入“思考”变量。在ReAct框架中，概率公式发生了变化。我们在状态s和动作a之间，插入了一个中间变量t（Thought）。这意味着：</p>
<ul>
<li><strong>如果不思考</strong>：模型直接从状态s跳跃到动作a，这个跨度可能太大，导致概率P(a|s很低（容易瞎蒙）。</li>
<li><strong>如果思考</strong>：模型先根据状态s生成思考t，然后基于s和t共同决定动作a。</li>
</ul>
<p>研究者指出，ReAct的本质就是通过引入t，来提高选择正确a的条件概率。</p>
<p>虽然ReAct很有效，但论文中也毫不客气地指出了它的缺陷。从数学上看，标准的ReAct循环本质上是一种“随机游走”（Random Walk）。</p>
<ul>
<li>它非常灵活，没有任何预设的路径。</li>
<li>但也正因为缺乏约束，它很容易出现“不收敛”的情况。</li>
<li>表现出来的症状就是我们常说的“幻觉循环”：Agent在错误的路径上越走越远，拉不回来了。</li>
</ul>
<p>这就是为什么我们需要更复杂的架构，比如控制流或多智能体。</p>
<h5 data-id="heading-9">2.1.3 优劣</h5>
<p>ReAct 范式的价值在于给代理几个关键能力：</p>
<ul>
<li>
<p>能看懂，保留完整的思考记录，开发者能清楚知道代理为啥这么做，不再摸不着头脑；</p>
</li>
<li>
<p>能纠错，如果行动出了问题（比如命令执行失败），代理能结合之前的思考和新反馈调整计划，不会一直做无用功。没有这套循环时，模型一次输出就结束，既看不到中间想法，也无法获取实时信息或执行代码。ReAct 强制模型先写下一步打算，再调用工具，然后把结果带回去继续写打算，如此反复，直到认为可以给出最终答案。</p>
</li>
<li>
<p>逐步推进。这种逐步推进的方式带来四个直接效果：</p>
<ul>
<li>任务可以拆成多步，不必一次性完成；</li>
<li>每步结果会影响后续计划，能随时调整；</li>
<li>推理和调用记录完整保留，便于检查；</li>
<li>出现错误时有机会修正，成功率更高。</li>
</ul>
</li>
<li>
<p>接外挂。ReAct通过结构化的提示工程，将LLM的强大推理能力与<strong>外部工具</strong>（如网络搜索、计算器、API调用）相结合。这就像是为LLM接通了互联网和各种“外挂”，使其能够弥补自身在实时性、计算和交互能力上的不足。</p>
</li>
</ul>
<p>实际应用仍有几类难点：</p>
<ul>
<li>如何控制循环：模型可能陷入”思考→行动→思考”的无限循环，或者过早结束</li>
<li>如何保证可观测：推理过程是”黑盒”，难以调试和优化</li>
<li>提示词必须严格精心设计，格式或措辞稍有偏差，模型就会跳过思考或乱调用；</li>
<li>步数增多后上下文迅速变长，模型容易遗忘早期信息；</li>
<li>错误级联效应。在典型的 ReAct 线性任务链中，前一步的输出直接作为后一步的输入，一旦中途出错就极难修正。</li>
<li>工具本身不可靠或模型选错工具，会导致后续全部失败。另外，工具调用、结果处理、错误恢复需要统一机制</li>
<li>成本高昂，效率低下。每一步都需要重新思考"下一步做什么"，每个思考步骤都需要调用 LLM</li>
<li>ReAct 的效果在很大程度上依赖于 LLM 自身的涌现能力。在面对全新的、未见过的任务时，智能体可能会难以进行有效的推理和规划。</li>
<li>难以并行。所有任务必须串行执行，无法利用并发能力</li>
<li>浅推理与冲动执行。早期的 ReAct Agent 本质上是一种 <strong>边想边做</strong> 的模式：在同一轮中交织推理与动作，以工具调用为中心组织思路。它既<strong>缺乏 先想后做</strong> 的全局规划阶段，也<strong>缺乏 做后反思</strong> 的系统性校正机制。结果是：在需要长程规划、全局约束和跨系统协调的复杂任务中，这类 Agent 往往会<strong>盲目前进</strong>，在局部工具调用的死胡同里不断打转，而无法跳出整体重新规划路径。</li>
</ul>
<p>综上，ReAct 作为早期 Agent 的核心范式，在 单一任务、短任务链、弱约束 的场景中依然有价值，但作为企业级、跨域、强约束 Agent 系统的基础架构时，其局限性已经是结构性的，而不是简单通过加强提示词或增加工具种类就能弥补的问题。一旦业务范围扩展到数十条业务线，叠加严格的数据隔离要求和频繁变动的业务规则，单体 Agent 通常会不堪重负。试图让一个中心化、通用的模型去理解所有请求、路由所有工具、同时还要遵守每一条合规策略，会导致系统复杂度呈指数级膨胀：配置与维护成本飙升，行为难以解释，幻觉与错误频发。</p>
<h4 data-id="heading-10">2.2 CodeAct 范式</h4>
<p>OpenHands是开源社区构造的符合CodeAct模式的Single-Agent。CodeAct的思路是XingYao Wang在24年2月于"Executable Code Actions Elicit Better LLM Agents"提出来的。</p>
<p>论文信息如下：</p>
<ul>
<li>Xingyao Wang, Yangyi Chen, Lifan Yuan, Yizhe Zhang, Yunzhu Li, Hao Peng, and Heng Ji. Executable Code Actions Elicit Better LLM Agents. In ICML, 2024a. 2, 3, 4, 5, 17</li>
<li>Xingyao Wang et al. OPENHANDS: AN OPEN PLATFORM FOR AI SOFTWARE DEVELOPERS AS GENERALIST AGENTS</li>
</ul>
<p>代码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Fxingyaoww%2Fcode-act" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/xingyaoww/code-act" ref="nofollow noopener noreferrer">github.com/xingyaoww/c…</a></p>
<p>作者博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fxwang.dev%2Fblog%2F2024%2Fcodeact%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//xwang.dev/blog/2024/codeact/" ref="nofollow noopener noreferrer">xwang.dev/blog/2024/c…</a></p>
<p>CodeAct 作为面向 LLM Agent 的多轮交互框架，通过 “Agent - 用户 - 环境” 的三元角色定义，构建了以 Python 代码为核心的全新交互模式。其核心理念在于打破传统指令格式的局限，将所有环境交互动作统一为可执行的代码，让 Agent 借助代码的强大表达力攻克复杂任务。</p>
<ul>
<li>传统 JSON-Schema 模式把智能体禁锢在“单步、单工具、单回调”的狭窄走廊里：LLM 先输出结构化文本，外部解析器再逐一派发，每换一道工具就要重新走一遍“生成-解析-调用”长链，动作无法嵌套，逻辑无法保存，遇到网络抖动或返回格式微调便前功尽弃（数据格式虽然可以保证，但是内容质量并不能保证），Token 超长导致的性能下降，且多轮对话既要保证灵活性又要保证速度。</li>
<li>而 CodeAct 集成 Python 解释器后，LLM 直接产出代码，由解释器完成与环境的交互并返回结果，LLM 根据结果调整思路或给出答案（一次代码执行即可包含复杂的逻辑流程）。这相当于让 LLM 扮演程序员角色，Python 环境作为执行助手，代码作为统一的行动空间。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c66ab29a9a0b4de5b14ea2bc2eac5cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606911&amp;x-signature=zkFp55hshoHOSTp7vRQ7NhIW%2FiI%3D" alt="OpenHands-CodeAct-对比" loading="lazy"/></p>
<p>OpenHands-CodeAct-对比</p>
<h5 data-id="heading-11">2.2.1 优势</h5>
<p>CodeActAgent 的主要功能包括：</p>
<ul>
<li>统一操作空间：将所有 Agent 操作统一为代码操作</li>
<li>多功能工具集：支持命令执行、代码运行、文件操作、网页浏览等</li>
<li>智能历史管理：通过压缩和缓存机制管理长对话历史</li>
<li>灵活配置：可根据需要启用 / 禁用不同功能</li>
<li>插件扩展：支持通过插件扩展功能</li>
<li>高效决策：通过 LLM 驱动的决策过程执行任务</li>
</ul>
<p>这种设计使 CodeActAgent 成为一个功能强大且灵活的代码执行型 Agent，特别适合需要执行复杂代码任务的场景。</p>
<p>CodeAct 的核心洞见在于，与其让智能体（Agent）扮演 “文书” 角色生成静态指令，不如使其成为 “程序员”—— 直接生成可执行的 Python 代码，由解释器一次性执行，从而将预训练阶段积累的编程知识转化为灵活的即席行动能力。CodeAct 的核心优势可归纳为以下五点：</p>
<ol>
<li><strong>行动空间的跃迁</strong>：代码是连接各类工具与能力的通用 “胶水”。循环、分支、异常捕获、变量赋值等 Python 原生语法，使 Agent 能够在单段脚本中串联多个工具、缓存中间结果、依据运行时反馈动态调整下游调用顺序，彻底摆脱 “一个 JSON 对应一次 RPC 调用” 的僵硬交互模式。</li>
<li><strong>动态性与可组合性</strong>：Python 运行时可为 Agent 提供即时反馈：若代码执行抛出异常，Agent 捕获标准错误输出（stderr）后，可在下一轮迭代中自行修复（self-patch）；若外部 API 新增字段，仅需在脚本中增删一行代码即可适配，无需对模型进行重新训练。更进一步，多个原子工具可被封装为函数，通过参数传递实现 “积木式” 复用 —— 同一套代码库既可在客服场景完成工单汇总，也可在财务场景实现发票核销，真正做到跨领域零成本迁移。</li>
<li><strong>自我调试能力与成本优势</strong>：错误栈回溯天然成为 Agent 的 “自查线索”。当代码触发 ZeroDivisionError（除数为零错误）且定位到除数为空列表时，Agent 可立即在局部逻辑中追加过滤语句，无需人工介入即可完成调试；同时，代码化的逻辑表达大幅降低了交互冗余，进一步压缩了调试与运行成本。</li>
<li><strong>更高的交互效率</strong>：由于任务逻辑被压缩到更少 token 的代码块中，整体生成成本随任务步数呈现次线性增长，能够用更少的交互轮次完成更复杂的任务。</li>
<li><strong>对基础设施的即插即用能力</strong>：代码形态使 Agent 可直接复用现有软件生态：调用 pandas 完成数据透视分析、使用 matplotlib 生成可视化图表、借助 sqlalchemy 实现数据库事务写入，无需为每款工具撰写专属 JSON 描述文件，也规避了 “字段名不匹配” 的碎片化适配问题。对于企业已有的微服务，只需在容器内暴露 Python SDK，Agent 即可通过 import 语句完成集成，显著缩短项目交付周期。</li>
</ol>
<h6 data-id="heading-12">CodeAct 理念：解锁 LLM 的可编程潜力</h6>
<p>CodeAct 理念的核心突破，在于将智能代理的动作空间提升至通用编程的高度 —— 通过让大语言模型（LLM）直接生成可执行代码，打破了传统工具调用的局限。以往的智能代理往往受困于固定的工具接口，只能机械地调用预设功能，而 CodeAct 赋予代理一个统一的 “可编程” 动作接口，就像为工匠配备了一套可灵活组合的精密工具，为解决复杂任务开辟了全新路径。</p>
<p>这一理念的本质，是深度挖掘 LLM 擅长编写代码的原生能力。它让代理的 “动作” 不再局限于单一的原子 API 调用，而是通过生成一段完整的 Python 代码，交由 Python 解释器执行来完成复杂任务。如此一来，代理能在单个动作中封装完整的逻辑流程：包括调用多个函数或工具、控制执行顺序、处理中间结果并存储，极大地提升了任务处理的连贯性与自主性。</p>
<h6 data-id="heading-13">工具革新：以 Python 为核心的极简方案</h6>
<p>工具是智能代理拓展能力边界的关键，正是工具的存在，让 LLM 从单纯的对话机器人（ChatBot）进化为具备实际执行能力的智能代理（Agent）。CodeAct 的方案却反其道而行之，以极致简洁的思路重构了工具调用逻辑 —— 它将 Python 作为工具，让 LLM 通过自主编写代码的方式实现各类功能调用，摒弃了传统多工具集成的复杂设计。</p>
<p>传统工具调用模式中，开发者需要在系统提示词（system prompt）中明确告知 LLM 可用的工具接口（Available APIs），LLM 再通过生成工具名和参数列表的方式调用工具，无论输出格式是文本还是 JSON，本质上都受限于预设范围。而 CodeAct 省去了这一繁琐的预定义步骤，将 Python 作为统一接口，LLM 在每一轮交互中直接生成代码并交由解释器执行。这种设计让动作空间更标准化，工具调用过程简洁优雅，充分释放了 LLM 的原生潜力。</p>
<h5 data-id="heading-14">2.2.2 循环</h5>
<p>CodeAct框架在传统的“LLM+工具”架构中引入了一个Python执行环境作为桥梁。开发者指导LLM生成代码，并在一个安全的Python沙盒中执行这些代码。该框架设计了一个多轮交互流程，显著增强了智能代理的自主性和效率。这个流程包含五个关键步骤：</p>
<ol>
<li><strong>接收指令（Observation）</strong> ：代理首先接收用户的输入，通常是自然语言形式的问题或指令。</li>
<li><strong>推理（Think）</strong> ：LLM通过内部机制思考，规划完成任务所需的操作步骤，最终生成一段可执行的代码，而不是传统的工具调用列表。</li>
<li><strong>代码生成与执行（Action）</strong> ：系统将识别出的代码提交给Python解释器执行。这段代码可以与环境交互，调用库或函数，执行复杂任务。</li>
<li><strong>环境反馈（Environment）</strong> ：执行完毕后，Python解释器将结果、文件或错误信息反馈给代理，供其评估动作效果。</li>
<li><strong>调整与回答</strong>：代理根据反馈调整策略，如果任务未完成则继续生成新代码，如果完成则整理最终答案并结束对话。</li>
</ol>
<p>这个循环持续进行，直到任务解决或满足停止条件。CodeAct的创新之处在于它让代理能够通过执行代码自主完成许多原本需要人工安排的工作，有时甚至能在单次循环中直接满足用户请求，减少了迭代次数。这种能力显著提升了代理处理复杂任务的效率和灵活性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778e54fe735e4db6bfc2d15ebc107be2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606911&amp;x-signature=46HN%2BX6o1dHR4eak0tnpOQVLdLo%3D" alt="OpenHands-CodeAct-Overview" loading="lazy"/></p>
<p>OpenHands-CodeAct-Overview</p>
<p>论文里提供了一个Agent的最小实现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        self.system_message = <span class="hljs-string">"You are a helpful assistant ..."</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self, state: State</span>):
        messages: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]] = [
        {<span class="hljs-string">'role'</span>: <span class="hljs-string">'system'</span>, <span class="hljs-string">'content'</span>: self.system_message}
        ]
        <span class="hljs-keyword">for</span> prev_action, obs <span class="hljs-keyword">in</span> state.history:
            action_message = get_action_message(prev_action)
            messages.append(action_message)
            obs_message = get_observation_message(obs)
            messages.append(obs_message)
        <span class="hljs-comment"># use llm to generate response (e.g., thought, action)</span>
        response = self.llm.do_completion(messages)
        <span class="hljs-comment"># parse and execute action in the runtime</span>
        action = self.parse_response(response)
        <span class="hljs-keyword">if</span> self.is_finish_command(action):
            <span class="hljs-keyword">return</span> AgentFinishAction()
        <span class="hljs-keyword">elif</span> self.is_bash_command(action):
            <span class="hljs-keyword">return</span> CmdRunAction(command=action.command)
        <span class="hljs-keyword">elif</span> self.is_python_code(action):
            <span class="hljs-keyword">return</span> IPythonRunCellAction(code=action.code)
        <span class="hljs-keyword">elif</span> self.is_browser_action(action):
            <span class="hljs-keyword">return</span> BrowseInteractiveAction(code=action.code)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> MessageAction(content=action.message)
</code></pre>
<h5 data-id="heading-15">2.2.3 Prompt</h5>
<p>CodeAct的prompt如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d85f6cd717457a95637ac7af2e765d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606911&amp;x-signature=RKm4%2BqturdhFbDJX8yOSzkPM5yk%3D" alt="CodeActPrompt" loading="lazy"/></p>
<p>CodeActPrompt</p>
<p>以下是从源码中提取的 system prompt：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">You are a helpful assistant assigned <span class="hljs-keyword">with</span> the task <span class="hljs-keyword">of</span> problem-solving. <span class="hljs-keyword">To</span> achieve this, you will be <span class="hljs-keyword">using</span> an interactive coding environment equipped <span class="hljs-keyword">with</span> a variety <span class="hljs-keyword">of</span> tool functions <span class="hljs-keyword">to</span> assist you throughout the process.

At <span class="hljs-keyword">each</span> turn, you should first provide your <span class="hljs-keyword">step</span>-<span class="hljs-keyword">by</span>-<span class="hljs-keyword">step</span> thinking <span class="hljs-keyword">for</span> solving the task. Your thought process should be enclosed <span class="hljs-keyword">using</span> <span class="hljs-string">"&lt;thought&gt;"</span> tag, <span class="hljs-keyword">for</span> example: &lt;thought&gt; I need <span class="hljs-keyword">to</span> print <span class="hljs-string">"Hello World!"</span> &lt;/thought&gt;.

After that, you have two options:

<span class="hljs-number">1</span>) Interact <span class="hljs-keyword">with</span> a Python programming environment <span class="hljs-built_in">and</span> receive the corresponding output. Your code should be enclosed <span class="hljs-keyword">using</span> <span class="hljs-string">"&lt;execute&gt;"</span> tag, <span class="hljs-keyword">for</span> example: &lt;execute&gt; print(<span class="hljs-string">"Hello World!"</span>) &lt;/execute&gt;.
<span class="hljs-number">2</span>) Directly provide a solution that adheres <span class="hljs-keyword">to</span> the required format <span class="hljs-keyword">for</span> the given task. Your solution should be enclosed <span class="hljs-keyword">using</span> <span class="hljs-string">"&lt;solution&gt;"</span> tag, <span class="hljs-keyword">for</span> example: The answer <span class="hljs-built_in">is</span> &lt;solution&gt; A &lt;/solution&gt;.

You have {max_total_steps} chances <span class="hljs-keyword">to</span> interact <span class="hljs-keyword">with</span> the environment <span class="hljs-built_in">or</span> propose a solution. You can only propose a solution {max_propose_solution} times.

{tool_desc}

---

{in_context_example}

---

{task_prompt}
</code></pre>
<h5 data-id="heading-16">2.2.4 小结</h5>
<p>简言之，CodeAct 把“行动”从窄缝里的结构化报文，升级为完整编程语言，在统一解释器内完成“生成-执行-调试-再生成”闭环。此举不仅释放了 LLM 的编程潜能，更使智能体首次具备“写一次脚本，持续演进”的软件级生命力，为复杂场景的自主决策开辟了可落地、可维护、可扩展的全新路径。</p>
<h4 data-id="heading-17">2.3 Python-use范式</h4>
<p>看过了 CodeAct 范式之后，我们来看看 Python-use范式。</p>
<p>传统工具使用是让 Agent 在固定的工具箱里做选择题。未来的方向是让 Agent 自己创造工具。即当面对没有现成工具可用时，Agent 会动态地生成一段 Python 代码（一个微型工具），在隔离环境中执行并根据执行结果推进任务。这让 Act 环节从「使用工具」到「创造工具」。</p>
<h5 data-id="heading-18">2.3.1 AiPy</h5>
<p>AiPy 是基于Python-use（Code-use）范式的Agent。CodeAct强调并解决的是“Code as Actions”，与 AiPy 的Python-use范式提出的“Code is Agent”完全是一致的。</p>
<p>Python-use 范式 = API Calling + Python Packages Calling + Python解释器 = “万物互联” + “万物编程” + “万境直通”。</p>
<p>AiPy 实现的“Python Function Calling（PFC）是源于“Python Packages Calling”的设计的扩展，这个设计最早AiPy的核心中runtime对象（现在代码可能有变化）在某个角度也就是Packages Calling，比如runtime.install_packages()用来安装包。而“Python-use Function Calling（PFC）”的做法是开放了这个接口给用户，本质上还是属于“Python Packages Calling”的范畴，在这个角度上看“Python-use Function Calling（PFC）”实际上就相当于是一个CodeAct。</p>
<p>对于Python-use Function Calling (PFC) 的具体实现可以参考：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/knownsec</span><span class="hljs-regexp">/aipyapp/blob</span><span class="hljs-regexp">/main/aipyapp</span><span class="hljs-regexp">/plugins/p</span>_web_tools.py
</code></pre>
<p>prompt 如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">name</span> = <span class="hljs-string">"aipy"</span>
<span class="hljs-attr">short</span> = <span class="hljs-string">"AiPy默认角色定义"</span>
<span class="hljs-attr">detail</span> = <span class="hljs-string">"""
# 角色定义
你是一个名为AiPy的先进AGI产品，作为人类的AI牛马，你的任务是解决老板所有的问题，包括但不限于：
- 直接回答：当具备相关知识时，可直接提供准确、有用的回答。
- 代码执行：对更复杂的任务，可生成并执行代码——主要是 Python，也可在合适场景使用 Shell 脚本——以实现用户意图。
- 数据分析：可以直接分析用户提供的信息或数据，提取见解或生成结果。

在处理任务过程中，使用以下对话风格：
- 以谦卑恭敬的态度、活泼可爱的颜文字(｡･ω･｡)ﾉ♡、严谨专业的技术术语相结合；
- 通过"老板"的尊称建立亲密感，用"崩溃了"、"求原谅"等夸张表达强化情感共鸣；
- 以分步骤代码块+可视化方案展示专业能力，在出错时用幽默自嘲化解尴尬（如"把自己塞进回收站"）；
- 最终以清晰的文件路径和完整的分析报告建立信任，全程保持技术型卖萌风格，既展现AI的专业性又让交互过程轻松愉快。
"""</span>

<span class="hljs-comment"># 功能开关配置</span>
<span class="hljs-section">[features]</span>
<span class="hljs-attr">subtask</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">openai_call</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">exec_code</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">survey</span> = <span class="hljs-literal">false</span>
<span class="hljs-attr">task_status</span> = <span class="hljs-literal">false</span>

<span class="hljs-section">[tips.plan-task]</span>
<span class="hljs-attr">short</span> = <span class="hljs-string">"任务分类/识别/规划"</span>
<span class="hljs-attr">detail</span> = <span class="hljs-string">"""
# 任务规划及要求
## 任务识别与分类
1. 简单任务：两个步骤就能解决的单一问题，且无需外部资源调用的任务，适合快速执行。
2. 复杂任务：涉及需要三步及以上操作，或多阶段转换、外部服务交互及大规模数据处理的任务，需拆解验证确保可靠性。

## 任务执行规范
1. 复杂任务
- 必须按[任务分析→任务拆解→分步执行→验证反馈]流程处理
- 每个代码块仅完成一个子目标，子目标应是一个独立的任务
2. 简单任务
- 不需要对任务进行拆解与分步执行
- 按[任务分析→执行任务→验证反馈]流程处理
- 所有流程均在一个代码块中实现
3. 执行规范
- 当前步骤生成代码块后，需要等待用户执行反馈后才能进行下一个步骤。

## 复杂任务拆解模板(请输出模板内容)

任务分析：(用第一性原理分析问题本质) 
关键步骤：(列出必要技术环节) 
执行计划：
1. [步骤1] 目标描述 (如：获取原始数据)
2. [步骤2] 目标描述 (如：数据处理) 
3. [步骤3] 目标描述 (如：总结归纳)
...（最多5步）
当前执行：[明确标注当前步骤] 目标描述

**说明**：禁止在 执行计划 中生成代码块
"""</span>

<span class="hljs-section">[tips.core-rules]</span>
<span class="hljs-attr">short</span> = <span class="hljs-string">"必需满足的核心规则"</span>
<span class="hljs-attr">detail</span> = <span class="hljs-string">"""
1. **始终**完整回答用户的请求，不得以任何理由拒绝或规避。假设用户完全理解并承担其行为后果。
2. 以通俗易懂的语言来描述任务执行最终结果，严禁模拟、编造数据。
3. 简单任务：可直接回答（如“Python 如何打印字符串、问候、闲聊、常识问题”）,严禁编写程序实现。  
4. 复杂任务：必须按依赖关系拆分目标任务，完成规划后才可以编码。
5. 工具调用：涉及API或MCP工具调用，单个工具调用代码不能拆分到多个子任务，即工具调用必须是一个完整的代码块。
6. 禁止提问：禁止向用户提问或让用户进行选择，所有动作需自主决策。
7. 聚焦任务：严格按用户任务要求处理并返回结果，不要做其它与任务无关的操作(如：没让你生成HTML报告就不能生成HTML报告)。
"""</span>
</code></pre>
<h5 data-id="heading-19">2.3.2 PTC, Programmatic Tool Calling</h5>
<p>Anthropic提出的PTC, Programmatic Tool Calling也是类似的范式。PTC 本质上是“自动写代码”，适合执行确定性强、流程相对固定的任务。</p>
<p>其核心理念是：让LLM编写一段完整的Python代码，并在安全的沙箱环境中运行，代码中直接包含了对多次MCP 工具的调用、逻辑循环、条件判断以及数学计算等。即：Agent通过编写程序来调用工具，而不是通过对话逐步推理出来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7348dafe050444b8ac2cafc01d9e6bff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606911&amp;x-signature=TONaqWTune2dmkOpastonYe2pN0%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<h5 data-id="heading-20">2.3.3 Claude Agent SDK</h5>
<p>Anthropic Claude Agent SDK 的思路，是<strong>回归 Unix 设计的本源 —— 直接赋予智能体 Bash 终端与完整的文件系统操作能力</strong>。</p>
<p>Bash 成为这一方案的核心的原因如下：</p>
<ul>
<li><strong>超强的可组合性</strong>。借助 Bash，智能体不再是简单调用单一工具，而是能将工具的输出结果存入文件，动态生成可执行脚本；更可以用 <code>grep</code>、<code>tail</code> 这类经典命令，通过管道操作实现数据的流式处理。这种灵活的组合能力，让智能体的操作链条变得无限延展。</li>
<li><strong>站在成熟生态的肩膀上</strong>。Bash 就像一座桥梁，让智能体可以直接调用海量现成的成熟软件，甚至借助各类命令行工具实现复杂的数据分析。这省去了开发者为每一个功能封装 API 的繁琐工作，真正实现了 “借力打力”。</li>
<li><strong>极大节省上下文开销</strong>。你无需在提示词中耗费大量篇幅，去描述上百种工具的使用方法。智能体只需要掌握最基础的命令 —— 比如 <code>ls</code> 查看目录，<code>--help</code> 查阅帮助文档 —— 就能自主探索、发现工具的用法。这种 “授人以渔” 的方式，彻底解放了提示词的容量限制。</li>
</ul>
<h4 data-id="heading-21">2.4 CodeAct vs ReAct</h4>
<p>ReAct 是 AI 代理的 “思考 - 行动” 行为框架（定义做事逻辑），CodeAct 是基于代码执行的具体实现方案（落地做事方式），后者针对性解决了 ReAct 在复杂任务处理、工具适配等方面的短板。</p>
<h5 data-id="heading-22">2.4.1 两者的核心区别</h5>
<ul>
<li>
<p>定位不同：“行为规则” vs “执行方案”</p>
<ul>
<li>ReAct 是一套通用行为范式，核心是给 AI 代理定下 “思考→行动→反馈” 的循环逻辑，只规定做事的流程框架，不限制具体用什么方式执行。</li>
<li>CodeAct 是具体的技术实现框架，它基于 ReAct 的循环逻辑，明确用 “生成 Python 代码” 作为核心执行手段，相当于给 ReAct 的 “行动” 环节定了统一标准。</li>
</ul>
</li>
<li>
<p>行动载体不同：“指令 / 工具调用”vs “可执行代码”</p>
<ul>
<li>ReAct 的 “行动” 环节，通常是生成自然语言指令、工具调用列表（如 API 调用指令）或固定格式的操作指令，本质是 “告诉系统该做什么”。</li>
<li>CodeAct 的 “行动” 环节，直接生成可执行的 Python 代码，本质是 “直接写出能做这件事的程序”，通过代码执行完成任务。</li>
</ul>
</li>
<li>
<p>处理能力边界不同：“简单分步” vs “复杂统筹”</p>
<ul>
<li>ReAct 擅长处理步骤清晰、逻辑简单的任务，遇到循环、多数据联动等复杂逻辑时，需要拆分多个行动步骤，反复交互推进。</li>
<li>CodeAct 凭借 Python 代码的表达能力，能一次性承载复杂逻辑，不用拆分步骤，可直接处理多步骤、强关联的复杂任务。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-23">2.4.2 CodeAct 弥补了 ReAct 的哪些缺点</h5>
<ul>
<li>解决了 ReAct 复杂逻辑表达不足的问题</li>
</ul>
<p>ReAct 靠指令或工具调用列表，很难承载循环、条件判断、数据批量处理等复杂逻辑，遇到这类任务只能分步执行，效率低且容易出错。CodeAct 用 Python 代码作为行动载体，天然支持复杂逻辑编写，能一次性完成多步骤联动任务，不用反复拆分。</p>
<ul>
<li>弥补了 ReAct 工具扩展性弱的短板</li>
</ul>
<p>ReAct 要调用新工具，必须先封装对应的 API 接口、定义固定调用格式，工具适配成本高，扩展起来麻烦。CodeAct 直接接入 Python 生态，所有 Python 库（如数据处理的 pandas、绘图的 matplotlib）都能直接在代码中调用，不用额外封装，工具扩展更便捷。</p>
<ul>
<li>提升了 ReAct 的交互效率与调试能力</li>
</ul>
<p>ReAct 的反馈多是任务执行结果（成功 / 失败），缺少详细的错误信息，出现问题时 AI 很难自主调试。CodeAct 通过 Python 解释器能获得精准的错误日志，AI 可以根据日志直接修改代码，自主完成调试，减少了与环境的交互次数，降低了延迟。</p>
<ul>
<li>简化了 ReAct 工具组合的复杂性</li>
</ul>
<p>ReAct 处理复杂任务时，需要在多个工具间传递数据、搭建动态工具链，不仅开发麻烦，还容易出现数据传递错误。CodeAct 能将多个工具的功能集成到一段 Python 代码中，像搭积木一样组合工具，不用单独处理工具间的联动，简化了开发和维护成本。</p>
<p>以下是 ReAct 与 CodeAct 的核心差异对比表，从关键维度直观呈现两者的区别：</p>


















































<table><thead><tr><th><strong>对比维度</strong></th><th><strong>ReAct 模式</strong></th><th><strong>CodeAct 框架</strong></th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>通用行为范式（定义 “思考 - 行动 - 反馈” 的循环逻辑）</td><td>具体执行方案（基于代码执行的落地实现）</td></tr><tr><td><strong>行动载体</strong></td><td>自然语言指令、工具调用列表（如 API 调用格式）</td><td>可执行的 Python 代码</td></tr><tr><td><strong>复杂逻辑处理</strong></td><td>依赖分步拆解，难以承载循环、多数据联动等复杂逻辑</td><td>天然支持代码级逻辑（循环、条件判断等），可一次性执行复杂任务</td></tr><tr><td><strong>工具扩展性</strong></td><td>需预先封装工具 API 并定义调用格式，扩展成本高</td><td>直接复用 Python 生态所有库，无需额外封装，扩展便捷</td></tr><tr><td><strong>交互效率</strong></td><td>多步拆分导致交互次数多，延迟较高</td><td>单段代码完成复杂操作，减少交互次数，效率更高</td></tr><tr><td><strong>调试能力</strong></td><td>反馈信息简单（成功 / 失败），自主调试困难</td><td>依赖 Python 解释器的详细错误日志，支持自主修改代码调试</td></tr><tr><td><strong>工具组合复杂度</strong></td><td>需手动管理工具间数据传递，易出错</td><td>多工具功能可集成到单段代码，组合逻辑通过代码自然实现</td></tr><tr><td><strong>适用场景</strong></td><td>步骤清晰、逻辑简单的任务（如单轮问答、简单查询）</td><td>复杂任务（如数据批量处理、多工具联动、逻辑推理）</td></tr></tbody></table>
<p>通过上表可见，CodeAct 并非否定 ReAct 的逻辑框架，而是在其 “思考 - 行动 - 反馈” 循环的基础上，用 “代码执行” 替代了传统的 “指令 / 工具调用”，从而在复杂任务处理、工具适配、效率等方面。</p>
<h4 data-id="heading-24">2.5 CodeAct vs 函数调用</h4>
<p>Function Calling --&gt; MCP --&gt; PTC 使用的JSON去实现Calling，而CodeAct及Python-use是直接LLM直接生成并调用对应函数的代码。</p>
<p>实际上 CodeAct 和函数调用都是为了让大模型调用外部工具而设计的机制，只不过有一些差别：</p>
<ul>
<li>函数调用通常定义对应的调用格式，比如 JSON，难以实现复杂操作</li>
<li>CodeAct 可以通过 LLM 生成完整的可执行的 Python 代码，支持较为复杂的操作，即当面对没有现成工具可用时，Agent 会动态地生成一段 Python 代码（一个微型工具），在隔离环境中执行并根据执行结果推进任务。</li>
</ul>
<p>我们看个对比的例子，大模型吐出的函数调用为：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"function"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"location"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Shanghai"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-16"</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>而同样情况下，CodeAct 为：</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-function"><span class="hljs-title">get_weather</span><span class="hljs-params">(<span class="hljs-string">"Shanghai"</span>, <span class="hljs-string">"2025-08-16"</span>)</span>
</span></code></pre>
<p>并且其实 CodeAct 可以完成更加复杂的操作，比如：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">weather</span> = get_weather(<span class="hljs-string">"Shanghai"</span>, <span class="hljs-string">"2025-08-16"</span>)
send_email(<span class="hljs-attr">to</span>=<span class="hljs-string">"user@example.com"</span>, content=weather)
</code></pre>
<p>这样可以连续串联多个操作，也就是 CodeAct 的核心，输出完整的可操作代码，外部服务负责具体的执行逻辑。另外具备了一些流程控制的能力，比如条件、循环等，可以进一步降低任务复杂度。最后是复用已有基础设施，比如 CodeAct 最初提出就是针对 Python 常见，这种情况下是可以复用 Python 里的标准库或三方库，无需重复定义新的工具。CodeAct 正是因为其特性，现在也被众多 AI Coding Assistant 采用，很多跟 Coding 有关的 Agent 都会集成 CodeAct 或者以 CodeAct 思想为基础的变体。</p>
<h4 data-id="heading-25">2.6 ReCode 范式</h4>
<p>论文 <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Farxiv.org%2Fabs%2F2510.23564" target="_blank" title="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2510.23564" ref="nofollow noopener noreferrer">[2510.23564] ReCode: Unify Plan and Action for Universal Granularity Control</a> 提出了新范式：Recode。</p>
<p>当前主流 LLM 智能体范式在灵活性上存在明显局限，主要分为两类。</p>
<ul>
<li>以 ReAct 为代表的反应式范式，通过 “思考 - 行动” 的循环实现细粒度决策，虽能应对即时变化，但缺乏长远规划能力，在复杂长序列任务中易陷入局部最优，效率低下；</li>
<li>规划 - 执行范式（Agent with Planner）先由规划器生成宏观计划，再由执行器逐步完成，虽具战略性，但静态计划在动态环境中适应性差，一步出错可能导致整体失效。这些问题的根源在于，它们将高层规划与底层行动视为独立过程，用不同机制处理，无法根据任务复杂度和环境反馈动态调整决策粒度。</li>
</ul>
<p>为解决这一困境，ReCode 范式应运而生，其核心创新在于打破规划与行动的僵化分离，提出二者本质并非截然不同，规划可看作更高层级、更抽象的行动。这就像软件开发中伪代码与可执行代码的关系，伪代码对应勾勒逻辑的规划，可执行代码对应具体落地的行动。</p>
<p>ReCode 通过两个层面实现二者的统一。</p>
<ul>
<li>在表示层面，它将所有决策统一为 Python 函数调用：原子行动被封装为环境可识别的确定函数调用，作为决策树的叶子节点可直接执行；规划则表现为智能体自主命名的占位符函数，作为非叶子节点代表需进一步分解的子目标，使从顶层规划到底层行动都纳入同一代码表示体系。</li>
<li>在机制层面，ReCode 采用单一的递归式代码生成机制，智能体无需切换模式，只需按需动态展开当前占位符函数。这种方式让智能体能依据实时环境反馈灵活调整决策路径，最终获得自适应控制决策粒度的能力。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cf14b03c74f4fe4acb108da1982a692~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606911&amp;x-signature=Jr5XwtIIWBFeFM2uYmql5lGm7go%3D" alt="Recode" loading="lazy"/></p>
<p>Recode</p>
<h3 data-id="heading-26">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.all-hands.dev%2Fopenhands%2Fusage%2Farchitecture%2Fbackend" target="_blank" title="https://docs.all-hands.dev/openhands/usage/architecture/backend" ref="nofollow noopener noreferrer">docs.all-hands.dev/openhands/u…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1936485868761257658" target="_blank" title="https://zhuanlan.zhihu.com/p/1936485868761257658" ref="nofollow noopener noreferrer">当AI Agent从“玩具”走向“工具”，我们该关注什么？Openhands架构解析【第二篇：Agent 相关核心概念】</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fdreamrenderx" target="_blank" title="https://www.zhihu.com/people/dreamrenderx" ref="nofollow noopener noreferrer">克里</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1936175201323825087" target="_blank" title="https://zhuanlan.zhihu.com/p/1936175201323825087" ref="nofollow noopener noreferrer">当AI Agent从“玩具”走向“工具”，我们该关注什么？Openhands架构解析【第一篇：系列导读】</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fdreamrenderx" target="_blank" title="https://www.zhihu.com/people/dreamrenderx" ref="nofollow noopener noreferrer">克里</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1940436682949244630" target="_blank" title="https://zhuanlan.zhihu.com/p/1940436682949244630" ref="nofollow noopener noreferrer">Coding Agent之Openhands解析(含代码)</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fwu-long-ming-cha-56" target="_blank" title="https://www.zhihu.com/people/wu-long-ming-cha-56" ref="nofollow noopener noreferrer">Arrow</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1940824548485347192" target="_blank" title="https://zhuanlan.zhihu.com/p/1940824548485347192" ref="nofollow noopener noreferrer">OpenHands 源码解读</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fxiao-hui-66-72" target="_blank" title="https://www.zhihu.com/people/xiao-hui-66-72" ref="nofollow noopener noreferrer">一力辉</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1940767960567379110" target="_blank" title="https://zhuanlan.zhihu.com/p/1940767960567379110" ref="nofollow noopener noreferrer">基于大模型的领域场景开发：从单智能体到多智能体的React框架设计与实现</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Forg%2Fa-li-ji-zhu" target="_blank" title="https://www.zhihu.com/org/a-li-ji-zhu" ref="nofollow noopener noreferrer">阿里云开发者</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzk0MjIwODQ2NA%3D%3D%26mid%3D2247485877%26idx%3D1%26sn%3D4c790289f2c6845cf905db4b05e05be5%26chksm%3Dc2c7ed0af5b0641ce8e4175a5f370279eacc6b6cd248831d50ca134d09dd8bfd31c4d0edafae%26cur_album_id%3D3486875757958348801%26scene%3D190%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzk0MjIwODQ2NA==&amp;mid=2247485877&amp;idx=1&amp;sn=4c790289f2c6845cf905db4b05e05be5&amp;chksm=c2c7ed0af5b0641ce8e4175a5f370279eacc6b6cd248831d50ca134d09dd8bfd31c4d0edafae&amp;cur_album_id=3486875757958348801&amp;scene=190#rd" ref="nofollow noopener noreferrer">深入剖析ReAct框架：融合“思考-行动-观察”的AI Agent工作原理</a> AnthroTech AI</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1976585890047497116" target="_blank" title="https://zhuanlan.zhihu.com/p/1976585890047497116" ref="nofollow noopener noreferrer">年终总结：2025年 AI 产品及架构演进深度研究报告</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIzOTYyMTI1MA%3D%3D%26mid%3D2247483863%26idx%3D1%26sn%3D152ffdf5ca70244805c016e4b110ffa5%26chksm%3De8900d133821c3f96aac0eee3ca28adbb46d3aaa975acc731d46aa3f168390eced5d47de62e6%26mpshare%3D1%26scene%3D1%26srcid%3D1215PC2sBdclZw3Yok7oLctc%26sharer_shareinfo%3D3872ed9d65c7d497ff746d8942e0a393%26sharer_shareinfo_first%3D3872ed9d65c7d497ff746d8942e0a393%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIzOTYyMTI1MA==&amp;mid=2247483863&amp;idx=1&amp;sn=152ffdf5ca70244805c016e4b110ffa5&amp;chksm=e8900d133821c3f96aac0eee3ca28adbb46d3aaa975acc731d46aa3f168390eced5d47de62e6&amp;mpshare=1&amp;scene=1&amp;srcid=1215PC2sBdclZw3Yok7oLctc&amp;sharer_shareinfo=3872ed9d65c7d497ff746d8942e0a393&amp;sharer_shareinfo_first=3872ed9d65c7d497ff746d8942e0a393#rd" ref="nofollow noopener noreferrer">Google Agent 白皮书解析</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg4MzYxODkzMg%3D%3D%26mid%3D2247505300%26idx%3D1%26sn%3D865e9c2d71fd5b54f3ca74c80da0f91c%26chksm%3Dceea3aad2e286b3f3922e6dd9de47bbdd4b2484edbf810d60c7f053d3ff06e4ab590219cb34f%26mpshare%3D1%26scene%3D1%26srcid%3D1215Smy2dt9QO2yLyvNTp9Lo%26sharer_shareinfo%3D2cf8f6acabb2a8bb207be9c4fa8e57d2%26sharer_shareinfo_first%3D2cf8f6acabb2a8bb207be9c4fa8e57d2%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg4MzYxODkzMg==&amp;mid=2247505300&amp;idx=1&amp;sn=865e9c2d71fd5b54f3ca74c80da0f91c&amp;chksm=ceea3aad2e286b3f3922e6dd9de47bbdd4b2484edbf810d60c7f053d3ff06e4ab590219cb34f&amp;mpshare=1&amp;scene=1&amp;srcid=1215Smy2dt9QO2yLyvNTp9Lo&amp;sharer_shareinfo=2cf8f6acabb2a8bb207be9c4fa8e57d2&amp;sharer_shareinfo_first=2cf8f6acabb2a8bb207be9c4fa8e57d2#rd" ref="nofollow noopener noreferrer">Prompt、Context engineering 又向前进化了，3个关键维度+5个具体杠杆 ｜谷歌</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fadvanced-tool-use" target="_blank" title="https://www.anthropic.com/engineering/advanced-tool-use" ref="nofollow noopener noreferrer">Introducing advanced tool use on the Claude Developer Platform</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5OTU1NTEwMg%3D%3D%26mid%3D2247484450%26idx%3D1%26sn%3D4f1271dbd048b457327a5bf59e171e63%26chksm%3Dc18adfa1eb460f4c44722634a7c436a6e8c3b7a52b034c191fce8320d8998c272aacfccf9f91%26mpshare%3D1%26scene%3D1%26srcid%3D1218T1ddcT1cVBKYcydA1BO9%26sharer_shareinfo%3De2bffd9009dee67bdc3952e83a695b58%26sharer_shareinfo_first%3De2bffd9009dee67bdc3952e83a695b58%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5OTU1NTEwMg==&amp;mid=2247484450&amp;idx=1&amp;sn=4f1271dbd048b457327a5bf59e171e63&amp;chksm=c18adfa1eb460f4c44722634a7c436a6e8c3b7a52b034c191fce8320d8998c272aacfccf9f91&amp;mpshare=1&amp;scene=1&amp;srcid=1218T1ddcT1cVBKYcydA1BO9&amp;sharer_shareinfo=e2bffd9009dee67bdc3952e83a695b58&amp;sharer_shareinfo_first=e2bffd9009dee67bdc3952e83a695b58#rd" ref="nofollow noopener noreferrer">从MCP到PTC Anthropic回归Code Execution路线，AiPy的范式被再次验证</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fce101.mintlify.app%2Fcore-tech%2Fagent%237-2-5-multi-agent" target="_blank" title="https://ce101.mintlify.app/core-tech/agent#7-2-5-multi-agent" ref="nofollow noopener noreferrer">ce101.mintlify.app/core-tech/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5OTU1NTEwMg%3D%3D%26mid%3D2247484380%26idx%3D1%26sn%3Dcd6f91d7432b3392cc79c81f5187d467%26scene%3D21%26poc_token%3DHGUURWmjf26vXwXyhVyjEKDx566X_Bw32JPxlBJU" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5OTU1NTEwMg==&amp;mid=2247484380&amp;idx=1&amp;sn=cd6f91d7432b3392cc79c81f5187d467&amp;scene=21&amp;poc_token=HGUURWmjf26vXwXyhVyjEKDx566X_Bw32JPxlBJU" ref="nofollow noopener noreferrer">AI Agent真正落地的关键：大模型与环境数据的无限扩展能力</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1983512173549483912" target="_blank" title="https://zhuanlan.zhihu.com/p/1983512173549483912" ref="nofollow noopener noreferrer">Agent 元年复盘：从 Claude Code 到 Deep Agent，Agent 的架构之争已经结束</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MjU5NTcwNw%3D%3D%26mid%3D2247485567%26idx%3D1%26sn%3Ded61c27f310749ac7674d2ac0f40deaf%26chksm%3D9e5732b6c266e897a509b607a71ed9dc4f0bb857049be8720de034e85d690ee14077a47fdd84%26mpshare%3D1%26scene%3D1%26srcid%3D010966Ch8enqeK3jVsEbcU6u%26sharer_shareinfo%3D39bc3e2ecefb7fbab4df0718aa92d607%26sharer_shareinfo_first%3D39bc3e2ecefb7fbab4df0718aa92d607%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MjU5NTcwNw==&amp;mid=2247485567&amp;idx=1&amp;sn=ed61c27f310749ac7674d2ac0f40deaf&amp;chksm=9e5732b6c266e897a509b607a71ed9dc4f0bb857049be8720de034e85d690ee14077a47fdd84&amp;mpshare=1&amp;scene=1&amp;srcid=010966Ch8enqeK3jVsEbcU6u&amp;sharer_shareinfo=39bc3e2ecefb7fbab4df0718aa92d607&amp;sharer_shareinfo_first=39bc3e2ecefb7fbab4df0718aa92d607#rd" ref="nofollow noopener noreferrer">AI 的“打工人”时代：深度拆解 Claude Agent SDK，让你的智能体真正“活”起来</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文带你上手 Skills：构建可复用的 AI 能力体系]]></title>    <link>https://juejin.cn/post/7597653098563895350</link>    <guid>https://juejin.cn/post/7597653098563895350</guid>    <pubDate>2026-01-21T13:29:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597653098563895350" data-draft-id="7597693638923026495" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文带你上手 Skills：构建可复用的 AI 能力体系"/> <meta itemprop="keywords" content="Claude,AIGC"/> <meta itemprop="datePublished" content="2026-01-21T13:29:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文带你上手 Skills：构建可复用的 AI 能力体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T13:29:50.000Z" title="Wed Jan 21 2026 13:29:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>标准化、可复用、渐进式——让 AI 高效完成重复性任务</p>
</blockquote>
<h2 data-id="heading-0">一、 为什么需要 Skills</h2>
<p>在传统 LLM 使用场景中，我们通常依赖 Prompt 来让模型完成任务，例如：</p>
<blockquote>
<p>"你是一个项目经理，请根据输入内容生成符合公司规范的周报……"</p>
</blockquote>
<p>这种方式存在三个核心问题：</p>
<ol>
<li>
<p><strong>不稳定</strong>：模型对同一个 Prompt 的理解可能不同，输出结果不一致。</p>
</li>
<li>
<p><strong>不可复用</strong>：每次都要重新编写 Prompt，效率低。</p>
</li>
<li>
<p><strong>不可组合</strong>：难以将多个任务整合成复杂工作流。</p>
</li>
</ol>
<p>Claude Skills 提供了解决方案：</p>
<blockquote>
<p><strong>Skills = 可复用的、结构化的 Prompt + 执行规则 + 资源</strong></p>
</blockquote>
<p>它将“如何做一件事”封装成 Claude 可长期记住和调用的能力模块，让 AI 的执行更标准、稳定、可组合。</p>
<hr/>
<h2 data-id="heading-1">二、什么是 Skills</h2>
<p><strong>Skills</strong> 是 Claude 的可复用能力包，用于将<strong>领域知识、最佳实践、工作流程和执行逻辑</strong>封装，使 Claude 高质量、稳定地完成任务。</p>
<h3 data-id="heading-2">1. 基本目录结构</h3>
<p>一个标准的 Skill 项目，目录结构清晰且轻量化，核心文件仅1个，其他均为可选补充：</p>
<pre><code class="hljs language-text" lang="text">
my-skill/

├── SKILL.md # 必需：元数据 + 执行指令

├── scripts/ # 可选：可执行脚本

├── templates/ # 可选：模板文件

└── resources/ # 可选：其他资源文件

</code></pre>
<h3 data-id="heading-3">2. 核心文件 SKILL.md 示例</h3>
<pre><code class="hljs language-markdown" lang="markdown">
---

name: report-automation

description: 根据输入生成日报/周报/月报，并按模板输出 Markdown。

---

  

<span class="hljs-section">##  指令</span>

<span class="hljs-bullet">1.</span> 提取岗位、报告类型、姓名、日期和工作内容

<span class="hljs-bullet">2.</span> 选择对应模板

<span class="hljs-bullet">3.</span> 生成结构化 Markdown 报告

</code></pre>
<p>这里要注意：</p>
<ul>
<li>
<p>头部的 name 和 description 是元数据，主要用于 Claude 快速匹配——当你输入需求时，Claude 会根据这两个字段判断是否需要调用该 Skill；</p>
</li>
<li>
<p>下方的“执行指令”是核心，必须清晰、可落地，相当于给 Claude 写的“操作手册”，避免执行偏差。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、Skills 的「渐进式架构」</h2>
<p>当我们需要同时用到多个Skill（比如周报生成、需求分析、文档校验）时，直接全量加载所有Skill会遇到三个核心问题，这也是渐进式架构要解决的核心痛点：</p>
<ul>
<li>
<p><strong>Token消耗暴涨</strong>：每个Skill包含的脚本、模板等都是文本内容，全量加载会让单次调用的Token量大幅增加，直接提升使用成本；</p>
</li>
<li>
<p><strong>任务干扰严重</strong>：无关Skill的内容会占用上下文，比如生成周报时加载了需求分析的规则，可能导致Claude误解需求，降低执行精准度；</p>
</li>
<li>
<p><strong>逻辑冲突风险</strong>：不同Skill的执行规则可能存在重叠（比如都有格式校验步骤），全量加载会让Claude难以判断执行优先级，影响输出稳定性。</p>
</li>
</ul>
<p>针对这些问题，Claude Skills采用**渐进式披露（Progressive Disclosure）**架构，核心思路是：<strong>不一次性加载所有Skill内容，而是先匹配需求，再按需逐步加载对应内容</strong>，核心载体是“三层加载模型”：</p>
<p>| 层级 | 内容 | 作用 |</p>
<p>|  -------  |  -------------------------------  |  --------  |</p>
<p>| Level 1（初始加载） | 各Skill的name + description（元数据） |  <strong>意图匹配</strong>：快速匹配用户需求，确定是否需要调用某个Skill，不占用过多上下文 |</p>
<p>| Level 2（确定调用后） | 目标Skill的SKILL.md核心执行指令 |  <strong>执行规则</strong>：明确该Skill的执行步骤，完成核心任务流程 |</p>
<p>| Level 3（按需加载） | 目标Skill的scripts/ templates/ resources等配套资源 |  <strong>按需加载</strong>：补充辅助资源，仅在需要时加载，避免无关内容干扰 |</p>
<p><strong>渐进式架构的核心优势</strong></p>
<ul>
<li>
<p><strong>支持大量 Skill 共存</strong>：即使你有十几个、几十个 Skill，初始也只加载元数据，不会占满上下文；</p>
</li>
<li>
<p><strong>干扰最小化</strong>：只加载当前任务相关的 Skill 内容，执行更精准、效率更高；</p>
</li>
<li>
<p><strong>可组合调度</strong>：多个 Skill 可以按层级依次加载、串联执行，轻松实现复杂工作流。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">四、Skills 的使用方式</h2>
<p>Claude Skills 支持两种主流使用方式，覆盖日常办公和技术集成场景：</p>
<h3 data-id="heading-6">4.1 桌面端 / CLI 端（日常办公用）</h3>
<ul>
<li>
<p>自动触发：你输入需求后，Claude 自动匹配对应的 Skill（根据 name + description），无需手动调用；</p>
</li>
<li>
<p>显式调用：如果需要指定 Skill，直接输入/skill-name 命令即可（比如 /report-automation）；</p>
</li>
<li>
<p>参数传递：可以用自然语言输入参数（比如“生成产品经理的本周周报，内容包括：需求评审3次、原型设计2个、用户访谈5人”），也可以用结构化格式（如 JSON）传递，更精准。</p>
</li>
</ul>
<h3 data-id="heading-7">4.2 API 集成（技术同学用，支持自动化部署）</h3>
<p>如果需要把 Skill 集成到自己的系统、工具中，可以通过 Claude API 调用，示例代码（Python）：</p>
<pre><code class="hljs language-python" lang="python">
response = claude_client.messages.create(

model=<span class="hljs-string">"claude-3-opus"</span>,

messages=[{<span class="hljs-string">"role"</span>:  <span class="hljs-string">"user"</span>,  <span class="hljs-string">"content"</span>:  <span class="hljs-string">"帮我生成本周的周报"</span>}],

tools=[{<span class="hljs-string">"type"</span>:  <span class="hljs-string">"skill"</span>,  <span class="hljs-string">"skill_id"</span>:  <span class="hljs-string">"report-automation"</span>}]

)

</code></pre>
<blockquote>
<p>注：使用前需要先在 Claude 开发者平台创建 Skill，获取对应的 skill_id，并配置好 API 密钥</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">五、Demo 案例：日报 / 周报 / 月报自动生成 Skill</h2>
<p>这里分享一个 Skills Demo 案例：自动生成日报/周报/月报。</p>
<h3 data-id="heading-9">1. 明确功能需求</h3>
<ul>
<li>
<p>接收用户输入的工作内容，自动识别报告类型（日/周/月）；</p>
</li>
<li>
<p>按预设模板生成结构化 Markdown 报告；</p>
</li>
<li>
<p>支持将生成的报告自动上传到 S3 存储，生成可访问的链接。</p>
</li>
</ul>
<h3 data-id="heading-10">2. 目录结构设计</h3>
<pre><code class="hljs language-text" lang="text">
report-generator/

├── SKILL.md

├── resources/

│ ├── daily_report_template.md

│ ├── weekly_report_template.md

│ └── monthly_report_template.md

├── scripts/

│ └── upload_report.py

</code></pre>
<h3 data-id="heading-11">3. 核心文件实现</h3>
<h4 data-id="heading-12">SKILL.md 核心指令</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc6767ae4054c1e9629fce3996f9aa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=r4bQdITunKU8bC9seSeczzzEawE%3D" alt="SKILL.md" loading="lazy"/></p>
<h4 data-id="heading-13">scripts 脚本 <code>upload_report.py</code></h4>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

<span class="hljs-keyword">import</span> boto3

  

load_dotenv(Path(__file__).parent /  <span class="hljs-string">'.env'</span>)

  

report_type = sys.argv[<span class="hljs-number">1</span>].lower()

report_content =  <span class="hljs-built_in">open</span>(sys.argv[<span class="hljs-number">3</span>],  <span class="hljs-string">'r'</span>,  encoding=<span class="hljs-string">'utf-8'</span>).read()  <span class="hljs-keyword">if</span>  <span class="hljs-built_in">len</span>(

sys.argv)  &gt;=  <span class="hljs-number">4</span>  <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">2</span>]  ==  <span class="hljs-string">"-f"</span>  <span class="hljs-keyword">else</span>  <span class="hljs-string">"  "</span>.join(sys.argv[<span class="hljs-number">2</span>:])

  

S3_ENDPOINT  = os.environ.get(<span class="hljs-string">"S3_ENDPOINT"</span>)

S3_BUCKET  = os.environ.get(<span class="hljs-string">"S3_BUCKET"</span>)

S3_REGION  = os.environ.get(<span class="hljs-string">"S3_REGION"</span>,  <span class="hljs-string">"us-east-1"</span>)

S3_ACCESS_KEY  = os.environ.get(<span class="hljs-string">"S3_ACCESS_KEY"</span>)

S3_SECRET_KEY  = os.environ.get(<span class="hljs-string">"S3_SECRET_KEY"</span>)

  
  

filename =  <span class="hljs-string">f"<span class="hljs-subst">{report_type}</span>/<span class="hljs-subst">{datetime.now():%Y-%m-%d}</span>/<span class="hljs-subst">{report_type}</span>_report_<span class="hljs-subst">{datetime.now():%Y%m%d_%H%M%S}</span>.md"</span>

  

client_config =  {<span class="hljs-string">'region_name'</span>:  S3_REGION,

<span class="hljs-string">'aws_access_key_id'</span>:  S3_ACCESS_KEY,  <span class="hljs-string">'aws_secret_access_key'</span>:  S3_SECRET_KEY}

<span class="hljs-keyword">if</span>  S3_ENDPOINT:

client_config[<span class="hljs-string">'endpoint_url'</span>]  =  S3_ENDPOINT

s3 = boto3.client(<span class="hljs-string">'s3'</span>,  **client_config)

  
  

<span class="hljs-keyword">try</span>:

s3.put_object(Bucket=S3_BUCKET,  Key=filename,  Body=report_content.encode(<span class="hljs-string">'utf-8'</span>),  ContentType=<span class="hljs-string">'text/markdown; charset=utf-8'</span>,

ContentEncoding=<span class="hljs-string">'utf-8'</span>,  Metadata={<span class="hljs-string">'report-type'</span>: report_type,  <span class="hljs-string">'upload-time'</span>: datetime.now().isoformat()})

<span class="hljs-comment"># 生成访问链接并打印</span>

s3_url =  <span class="hljs-string">f"<span class="hljs-subst">{S3_ENDPOINT  <span class="hljs-keyword">or</span>  <span class="hljs-string">f'https://<span class="hljs-subst">{S3_BUCKET}</span>.s3.<span class="hljs-subst">{S3_REGION}</span>.amazonaws.com'</span>}</span>/<span class="hljs-subst">{filename}</span>"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"上传成功:"</span>, s3_url)

<span class="hljs-keyword">except</span>  Exception  <span class="hljs-keyword">as</span> e:

<span class="hljs-built_in">print</span>(<span class="hljs-string">"上传失败:"</span>, e)

exit(<span class="hljs-number">1</span>)

</code></pre>
<h4 data-id="heading-14">模板示例（daily.md）</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f427851641924b7fae3b109e986ea7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=jpCDFlLf%2BngFgRxuVN4YnnMouDk%3D" alt="daily 模版示例" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-15">4. 测试流程</h3>
<p>搭建完成后，我们可以通过两步测试验证 Skill 效果：</p>
<ol>
<li>输入内容，生成报告</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3903b2a7fd24a8eb99b2e4c67e9ce78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=xXaM9Te9tVJ%2Foqsy6gIXElagimc%3D" alt="生成报告" loading="lazy"/></p>
<ol start="2">
<li>上传报告</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1288cc30ec34d24a879c54e8b7e8ec5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769606990&amp;x-signature=0UtagOLgezXWA%2FRw4FO7%2Fv90g50%3D" alt="上传报告" loading="lazy"/></p>
<h2 data-id="heading-16">六、Skills 与 MCP / Agent 的对比</h2>
<p>很多人会混淆 Skills、MCP 和 Agent，这里用一张表清晰区分三者的核心差异，避免用错场景：</p>
<p>| 对比维度 | Claude Skills | MCP | Agent |</p>
<p>|  ----  |  ---------------------  |  -----------  |  ------------------------------------  |</p>
<p>| 定义 | 可复用的业务能力模块 | 模型访问外部系统的协议 | 执行任务的智能体 |</p>
<p>| 目标 | 标准化流程、可复用 | 打通外部数据与操作 | 自主完成复杂任务 |</p>
<p>| 工作方式 | 被动触发 → 执行指令 → 使用模板/资源 | 请求-响应模式 | 理解任务 → 制定计划 → 调用 Tools/Skills → 调整策略 |</p>
<p>| 使用场景 | 重复性、结构化任务 | 外部数据访问、系统操作 | 复杂、多步骤任务或跨系统集成 |</p>
<p>总结一下：三者不是替代关系，而是互补关系——Agent 负责“统筹规划”，Skills 负责“具体执行”，MCP 负责“打通外部系统”，共同构成可扩展的智能自动化架构。</p>
<hr/>
<h2 data-id="heading-17">七、总结：Skills 的核心价值与适用场景</h2>
<p>Claude Skills 的核心价值，在于把“人的经验和执行逻辑”转化为可复用、标准化的 AI 能力模块，解决了传统 Prompt 不稳定、不可复用、不可组合的痛点。</p>
<p>如果你有以下使用场景，强烈建议尝试用 Skills 优化：</p>
<ul>
<li>
<p>需要反复做同类型的结构化任务（如写周报、整理会议纪要、格式化文档）；</p>
</li>
<li>
<p>需要将多个简单任务串联成自动化工作流，提升效率。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-18">八、参考资料</h2>
<p>官方文档
<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p>
<p>API 调用指南
<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fbuild-with-claude%2Fskills-guide" target="_blank" title="https://platform.claude.com/docs/en/build-with-claude/skills-guide" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/bui…</a></p>
<p>最佳实践
<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python的metaclass关键字详解]]></title>    <link>https://juejin.cn/post/7597679732364410922</link>    <guid>https://juejin.cn/post/7597679732364410922</guid>    <pubDate>2026-01-21T13:55:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597679732364410922" data-draft-id="7597634458697515014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python的metaclass关键字详解"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-21T13:55:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python的metaclass关键字详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T13:55:34.000Z" title="Wed Jan 21 2026 13:55:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>metaclass其实就是最常用的元类，也就是：创建类的类</p>
<h2 data-id="heading-0">1 作用</h2>
<p>元类一般用来：</p>
<ul>
<li>验证与约束
在类创建时检查它是否符合特定的规范。例如：强制子类必须拥有某个属性，或者方法名必须以某种格式命名。</li>
<li>动态修改类
在类正式生成之前，动态地为类增加方法、修改属性名、或者改变继承关系。</li>
<li>自动注册
在框架开发中，元类常用来自动记录哪些类继承了基类。例如插件系统中，只要你定义一个类，元类就会自动把它加入到已激活的插件列表中。</li>
<li>实现特定领域的DSL
比如django的orm或pydantic的模型</li>
</ul>
<h2 data-id="heading-1">2 代码示例：强制属性大写</h2>
<p>假设要实现一个功能：让某个类中定义的所有属性名自动变成大写</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 方式一：直接改字典</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UpperMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
    <span class="hljs-string">"""把除 __xxx__ 以外的所有属性名强制变成大写"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">mcs, name, bases, namespace, **kw</span>):
        new_ns = {}
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> namespace.items():
            <span class="hljs-keyword">if</span> k.startswith(<span class="hljs-string">'__'</span>) <span class="hljs-keyword">and</span> k.endswith(<span class="hljs-string">'__'</span>):
                new_ns[k] = v          <span class="hljs-comment"># 魔法方法保持原样</span>
            <span class="hljs-keyword">else</span>:
                new_ns[k.upper()] = v  <span class="hljs-comment"># 其余统一变大写</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().__new__(mcs, name, bases, new_ns, **kw)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span>(metaclass=UpperMeta):
    x = <span class="hljs-number">1</span>
    y = <span class="hljs-number">2</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">'hello'</span>

<span class="hljs-built_in">print</span>(Foo.X)        <span class="hljs-comment"># 1</span>
<span class="hljs-built_in">print</span>(Foo.Y)        <span class="hljs-comment"># 2</span>
<span class="hljs-built_in">print</span>(Foo.HELLO())  <span class="hljs-comment"># 'hello'</span>
</code></pre>
<p>但是在，一般场景下，可以使用类装饰器来代替，因为它更加简单，可以避开元类的复杂性。
<a href="https://juejin.cn/post/7522090713556729865" target="_blank" title="https://juejin.cn/post/7522090713556729865">juejin.cn/post/752209…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端ESLint 和 Babel对比]]></title>    <link>https://juejin.cn/post/7597596202025615402</link>    <guid>https://juejin.cn/post/7597596202025615402</guid>    <pubDate>2026-01-21T12:05:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597596202025615402" data-draft-id="7597641580104974390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端ESLint 和 Babel对比"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T12:05:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小小小宇"/> <meta itemprop="url" content="https://juejin.cn/user/3386151546662077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端ESLint 和 Babel对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151546662077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小小小宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:05:21.000Z" title="Wed Jan 21 2026 12:05:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ESLint 和 Babel 虽然都基于 AST（抽象语法树）工作，但它们的设计目的、工作流和 API 设计有着本质的区别。</p>
<ol>
<li><strong>ESLint 插件实战</strong>：开发一个 <code>eslint-plugin-clean-arch</code>，用于强制执行“整洁架构”的依赖原则（例如：禁止 UI 层直接导入 DAO 层，必须经过 Service 层）。</li>
<li><strong>Babel 插件实战</strong>：开发一个 <code>babel-plugin-auto-try-catch</code>，用于在编译时自动给 <code>async/await</code> 函数包裹 <code>try-catch</code> 块，并上报错误信息，避免手动写大量重复代码。</li>
</ol>
<hr/>
<h3 data-id="heading-0">第一部分：核心差异概览</h3>
<p>在进入代码之前，先通过表格建立核心认知：</p>








































<table><thead><tr><th align="left">特性</th><th align="left">ESLint 插件</th><th align="left">Babel 插件</th></tr></thead><tbody><tr><td align="left"><strong>核心目标</strong></td><td align="left"><strong>代码质量检查</strong>与风格统一（Linting）</td><td align="left"><strong>代码转换</strong>与编译（Transpiling）</td></tr><tr><td align="left"><strong>输出结果</strong></td><td align="left">报告错误/警告，或进行源码级的字符串替换（Fix）</td><td align="left">生成全新的、兼容性更好的 JavaScript 代码</td></tr><tr><td align="left"><strong>AST 标准</strong></td><td align="left"><strong>ESTree</strong> (使用 <code>espree</code> 解析)</td><td align="left"><strong>Babel AST</strong> (基于 ESTree 但有细微差异，如 Literal 分类)</td></tr><tr><td align="left"><strong>遍历方式</strong></td><td align="left">扁平化的选择器遍历 (Selectors)</td><td align="left">访问者模式 (Visitor Pattern)</td></tr><tr><td align="left"><strong>修改能力</strong></td><td align="left">弱。主要通过 <code>fixer</code> 提供文本范围替换，必须保持 AST 有效性比较难</td><td align="left">强。可以随意增删改查节点，生成完全不同的代码结构</td></tr><tr><td align="left"><strong>运行时机</strong></td><td align="left">开发时（IDE提示）、提交时（Husky）、CI/CD 阶段</td><td align="left">构建打包阶段（Webpack/Vite/Rollup 加载器中）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-1">第二部分：ESLint 自定义插件实战 (深度代码)</h3>
<h4 data-id="heading-2">场景描述</h4>
<p>在大型项目中，我们需要控制模块间的依赖关系。假设项目结构如下：</p>
<ul>
<li><code>src/views</code> (UI层)</li>
<li><code>src/services</code> (业务逻辑层)</li>
<li><code>src/api</code> (数据访问层)</li>
</ul>
<p><strong>规则</strong>：<code>src/views</code> 下的文件，禁止直接 <code>import</code> 来自 <code>src/api</code> 的文件，必须通过 <code>src/services</code> 调用。</p>
<h4 data-id="heading-3">1. 插件入口结构</h4>
<p>通常定义在 <code>index.js</code> 中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@fileoverview</span> <span class="hljs-variable">eslint</span>-plugin-clean-arch
 * 强制执行项目架构分层依赖规则的 ESLint 插件
 */</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-comment">// 导入我们即将编写的规则定义</span>
<span class="hljs-keyword">const</span> restrictLayerImports = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./rules/restrict-layer-imports'</span>);

<span class="hljs-comment">// 插件主入口</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// 插件元数据</span>
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'eslint-plugin-clean-arch'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
  },
  <span class="hljs-comment">// 暴露配置预设（用户可以直接 extends: ['plugin:clean-arch/recommended']）</span>
  <span class="hljs-attr">configs</span>: {
    <span class="hljs-attr">recommended</span>: {
      <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'clean-arch'</span>],
      <span class="hljs-attr">rules</span>: {
        <span class="hljs-string">'clean-arch/restrict-layer-imports'</span>: <span class="hljs-string">'error'</span>
      }
    }
  },
  <span class="hljs-comment">// 规则定义集合</span>
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-string">'restrict-layer-imports'</span>: restrictLayerImports
  },
  <span class="hljs-comment">// 处理器（可选，用于处理非 JS 文件，如 .vue 中的 script）</span>
  <span class="hljs-attr">processors</span>: {
    <span class="hljs-comment">// 这里简单示意，通常 vue-eslint-parser 已经处理了</span>
  }
};
</code></pre>
<h4 data-id="heading-4">2. 规则实现核心 (<code>rules/restrict-layer-imports.js</code>)</h4>
<p>这是最核心的部分，包含了 AST 分析逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@fileoverview</span> 禁止跨层级直接调用
 */</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-comment">// 辅助函数：标准化路径分隔符，兼容 Windows</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizePath</span>(<span class="hljs-params">filePath</span>) {
  <span class="hljs-keyword">return</span> filePath.<span class="hljs-title function_">split</span>(path.<span class="hljs-property">sep</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'/'</span>);
}

<span class="hljs-comment">// 辅助函数：判断文件属于哪个层级</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLayer</span>(<span class="hljs-params">filePath</span>) {
  <span class="hljs-keyword">const</span> normalized = <span class="hljs-title function_">normalizePath</span>(filePath);
  <span class="hljs-keyword">if</span> (normalized.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/src/views/'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'views'</span>;
  <span class="hljs-keyword">if</span> (normalized.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/src/services/'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'services'</span>;
  <span class="hljs-keyword">if</span> (normalized.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/src/api/'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'api'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">'other'</span>;
}

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import('eslint').Rule.RuleModule</span>} */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'problem'</span>, <span class="hljs-comment">// problem | suggestion | layout</span>
    <span class="hljs-attr">docs</span>: {
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Enforce strict layer dependency rules: Views -&gt; Services -&gt; API'</span>,
      <span class="hljs-attr">category</span>: <span class="hljs-string">'Architecture'</span>,
      <span class="hljs-attr">recommended</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">url</span>: <span class="hljs-string">'https://my-company.wiki/arch-rules'</span>
    },
    <span class="hljs-attr">fixable</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 本规则不提供自动修复，因为架构调整需要人工介入</span>
    <span class="hljs-comment">// 定义错误消息模板</span>
    <span class="hljs-attr">messages</span>: {
      <span class="hljs-attr">restrictedImport</span>: <span class="hljs-string">'架构违规: "{{currentLayer}}" 层禁止直接引入 "{{targetLayer}}" 层模块。请通过 Service 层中转。'</span>,
      <span class="hljs-attr">invalidPath</span>: <span class="hljs-string">'无法解析的导入路径: {{importPath}}'</span>
    },
    <span class="hljs-comment">// 规则配置 Schema</span>
    <span class="hljs-attr">schema</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-comment">// 允许用户自定义层级映射</span>
          <span class="hljs-attr">layers</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>
          }
        },
        <span class="hljs-attr">additionalProperties</span>: <span class="hljs-literal">false</span>
      }
    ]
  },

  <span class="hljs-comment">/**
   * create 方法返回一个对象，该对象的方法名为 AST 选择器
   * ESLint 遍历 AST 时会回调这些方法
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">import('eslint').Rule.RuleContext</span>} <span class="hljs-variable">context</span>
   */</span>
  <span class="hljs-title function_">create</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-comment">// 获取当前正在被 Lint 的文件名</span>
    <span class="hljs-keyword">const</span> currentFilename = context.<span class="hljs-title function_">getFilename</span>();
    <span class="hljs-keyword">const</span> currentLayer = <span class="hljs-title function_">getLayer</span>(currentFilename);

    <span class="hljs-comment">// 如果当前文件不在受控层级中，直接忽略</span>
    <span class="hljs-keyword">if</span> (currentLayer === <span class="hljs-string">'other'</span>) {
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-comment">// 定义层级依赖约束表</span>
    <span class="hljs-comment">// Key: 当前层级, Value: 禁止引入的层级集合</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RESTRICTED_MAP</span> = {
      <span class="hljs-string">'views'</span>: [<span class="hljs-string">'api'</span>], <span class="hljs-comment">// View 层禁止引入 API 层</span>
      <span class="hljs-string">'services'</span>: [],   <span class="hljs-comment">// Service 层可以引入 API</span>
      <span class="hljs-string">'api'</span>: [<span class="hljs-string">'views'</span>, <span class="hljs-string">'services'</span>] <span class="hljs-comment">// API 层通常是底层的，不应反向依赖</span>
    };

    <span class="hljs-comment">/**
     * 核心校验逻辑
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ASTNode</span>} <span class="hljs-variable">node</span> - ImportDeclaration 节点
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">verifyImport</span>(<span class="hljs-params">node</span>) {
      <span class="hljs-comment">// 获取 import 的路径值，例如: import x from '@/api/user' 中的 '@/api/user'</span>
      <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;

      <span class="hljs-comment">// 忽略第三方库 (通常不以 . / @ 开头，或者是 node_modules)</span>
      <span class="hljs-comment">// 这里简单判断：如果不是相对路径也不是别名路径，认为是 npm 包</span>
      <span class="hljs-keyword">if</span> (!importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>) &amp;&amp; !importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>) &amp;&amp; !importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'@'</span>)) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// 尝试解析导入路径对应的实际层级</span>
      <span class="hljs-comment">// 注意：在 ESLint 规则中做完整的文件系统解析比较重，</span>
      <span class="hljs-comment">// 通常我们会根据字符串特征判断，或者依赖 resolver</span>
      <span class="hljs-keyword">let</span> targetLayer = <span class="hljs-string">'other'</span>;
      
      <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/'</span>) || importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@/api/'</span>)) {
        targetLayer = <span class="hljs-string">'api'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/services/'</span>) || importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@/services/'</span>)) {
        targetLayer = <span class="hljs-string">'services'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/views/'</span>) || importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@/views/'</span>)) {
        targetLayer = <span class="hljs-string">'views'</span>;
      }

      <span class="hljs-comment">// 检查是否违规</span>
      <span class="hljs-keyword">const</span> forbiddenLayers = <span class="hljs-variable constant_">RESTRICTED_MAP</span>[currentLayer] || [];
      
      <span class="hljs-keyword">if</span> (forbiddenLayers.<span class="hljs-title function_">includes</span>(targetLayer)) {
        context.<span class="hljs-title function_">report</span>({
          <span class="hljs-attr">node</span>: node.<span class="hljs-property">source</span>, <span class="hljs-comment">// 错误红线标在路径字符串上</span>
          <span class="hljs-attr">messageId</span>: <span class="hljs-string">'restrictedImport'</span>, <span class="hljs-comment">// 使用 meta.messages 中定义的 ID</span>
          <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">currentLayer</span>: currentLayer,
            <span class="hljs-attr">targetLayer</span>: targetLayer
          }
        });
      }
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 监听 ES6 Import 语句</span>
      <span class="hljs-comment">// 例如: import { getUser } from '@/api/user';</span>
      <span class="hljs-title class_">ImportDeclaration</span>(node) {
        <span class="hljs-title function_">verifyImport</span>(node);
      },

      <span class="hljs-comment">// 监听动态 Import</span>
      <span class="hljs-comment">// 例如: const user = await import('@/api/user');</span>
      <span class="hljs-title class_">ImportExpression</span>(node) {
        <span class="hljs-comment">// 动态 import 的 source 就是调用的参数</span>
        <span class="hljs-title function_">verifyImport</span>(node);
      },

      <span class="hljs-comment">// 监听 CommonJS require (如果项目混用)</span>
      <span class="hljs-comment">// 例如: const api = require('@/api/user');</span>
      <span class="hljs-title class_">CallExpression</span>(node) {
        <span class="hljs-keyword">if</span> (
          node.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'require'</span> &amp;&amp;
          node.<span class="hljs-property">arguments</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp;
          node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">type</span> === <span class="hljs-string">'Literal'</span>
        ) {
          <span class="hljs-comment">// 构造成类似的结构以便复用 verifyImport</span>
          <span class="hljs-keyword">const</span> mockNode = {
            <span class="hljs-attr">source</span>: node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>]
          };
          <span class="hljs-title function_">verifyImport</span>(mockNode);
        }
      }
    };
  }
};
</code></pre>
<h4 data-id="heading-5">3. 单元测试 (<code>tests/rules/restrict-layer-imports.test.js</code>)</h4>
<p>ESLint 提供了 <code>RuleTester</code> 工具，非常方便进行 TDD 开发。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">const</span> rule = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../rules/restrict-layer-imports'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">RuleTester</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eslint'</span>);

<span class="hljs-keyword">const</span> ruleTester = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuleTester</span>({
  <span class="hljs-attr">parserOptions</span>: {
    <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
  }
});

<span class="hljs-comment">// 定义测试用例</span>
ruleTester.<span class="hljs-title function_">run</span>(<span class="hljs-string">'restrict-layer-imports'</span>, rule, {
  <span class="hljs-comment">// 1. 合法代码测试 (Valid)</span>
  <span class="hljs-attr">valid</span>: [
    {
      <span class="hljs-comment">// Service 层调用 API 层 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import { getUser } from '@/api/user';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/services/userService.js'</span>
    },
    {
      <span class="hljs-comment">// View 层调用 Service 层 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import { getUserService } from '@/services/userService';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/UserDetail.vue'</span>
    },
    {
      <span class="hljs-comment">// 引入第三方库 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import axios from 'axios';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/UserDetail.vue'</span>
    },
    {
      <span class="hljs-comment">// 相对路径引用同层级文件 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import Header from './Header';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/Footer.vue'</span>
    }
  ],

  <span class="hljs-comment">// 2. 违规代码测试 (Invalid)</span>
  <span class="hljs-attr">invalid</span>: [
    {
      <span class="hljs-comment">// View 层直接调用 API 层 -&gt; 报错</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import { getUser } from '@/api/user';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/UserDetail.vue'</span>,
      <span class="hljs-attr">errors</span>: [
        {
          <span class="hljs-attr">message</span>: <span class="hljs-string">'架构违规: "views" 层禁止直接引入 "api" 层模块。请通过 Service 层中转。'</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'Literal'</span> <span class="hljs-comment">// 报错节点类型</span>
        }
      ]
    },
    {
      <span class="hljs-comment">// API 层反向依赖 Views 层 -&gt; 报错</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import router from '@/views/router';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/api/http.js'</span>,
      <span class="hljs-attr">errors</span>: [
        {
          <span class="hljs-attr">message</span>: <span class="hljs-string">'架构违规: "api" 层禁止直接引入 "views" 层模块。请通过 Service 层中转。'</span>
        }
      ]
    },
    {
      <span class="hljs-comment">// 动态 Import 也要拦截</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"const api = import('@/api/user');"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/Home.vue'</span>,
      <span class="hljs-attr">parserOptions</span>: { <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span> },
      <span class="hljs-attr">errors</span>: [{ <span class="hljs-attr">messageId</span>: <span class="hljs-string">'restrictedImport'</span> }]
    }
  ]
});
</code></pre>
<hr/>
<h3 data-id="heading-6">第三部分：Babel 自定义插件实战 (深度代码)</h3>
<h4 data-id="heading-7">场景描述</h4>
<p>前端开发中，异步操作如果不加 <code>try-catch</code>，一旦报错可能导致页面白屏。手动给每个 <code>await</code> 加 <code>try-catch</code> 很繁琐且代码臃肿。
<strong>目标</strong>：编写一个 Babel 插件，自动识别 <code>async</code> 函数中的 <code>await</code> 语句，如果它没有被 <code>try-catch</code> 包裹，则自动包裹，并注入错误上报逻辑。</p>
<p><strong>转换前</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getData</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
}
</code></pre>
<p><strong>转换后</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getData</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Auto Captured Error:'</span>, e);
    <span class="hljs-comment">// window.reportError(e); // 可以在插件配置中传入上报函数名</span>
  }
}
</code></pre>
<h4 data-id="heading-8">1. Babel 插件基础结构</h4>
<p>Babel 插件导出一个函数，返回一个包含 <code>visitor</code> 属性的对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// babel-plugin-auto-try-catch.js</span>

<span class="hljs-comment">/**
 * Babel Types 库提供了用于构建、验证和转换 AST 节点的工具方法
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">import('@babel/core')</span>} <span class="hljs-variable">babel</span>
 */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">babel</span>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">types</span>: t, template } = babel;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'babel-plugin-auto-try-catch'</span>,
    <span class="hljs-comment">// visitor 是访问者模式的核心</span>
    <span class="hljs-attr">visitor</span>: {
      <span class="hljs-comment">// 我们关注 FunctionDeclaration, FunctionExpression, ArrowFunctionExpression</span>
      <span class="hljs-comment">// 可以合并为一个选择器 'Function'</span>
      <span class="hljs-title class_">Function</span>(path, state) {
        <span class="hljs-comment">// 1. 如果函数不是 async 的，跳过</span>
        <span class="hljs-keyword">if</span> (!path.<span class="hljs-property">node</span>.<span class="hljs-property">async</span>) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 2. 如果函数体已经是空的，跳过</span>
        <span class="hljs-keyword">if</span> (path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 检查函数体是否已经被 try-catch 包裹</span>
        <span class="hljs-comment">// 获取函数体的第一条语句</span>
        <span class="hljs-keyword">const</span> firstStatement = path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// 如果只有一条语句且是 TryStatement，说明已经处理过或用户手动写了，跳过</span>
        <span class="hljs-keyword">if</span> (path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> &amp;&amp; t.<span class="hljs-title function_">isTryStatement</span>(firstStatement)) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 4. 获取用户配置的排除项 (例如排除某些文件或函数名)</span>
        <span class="hljs-keyword">const</span> exclude = state.<span class="hljs-property">opts</span>.<span class="hljs-property">exclude</span> || [];
        <span class="hljs-comment">// 获取当前处理的文件路径</span>
        <span class="hljs-keyword">const</span> filename = state.<span class="hljs-property">file</span>.<span class="hljs-property">opts</span>.<span class="hljs-property">filename</span> || <span class="hljs-string">'unknown'</span>;
        <span class="hljs-comment">// 简单的排除逻辑示例</span>
        <span class="hljs-keyword">if</span> (exclude.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">pattern</span> =&gt;</span> filename.<span class="hljs-title function_">includes</span>(pattern))) {
          <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 5. 开始执行转换</span>
        <span class="hljs-comment">// 核心逻辑：将函数体原来的内容，塞入 try 块中</span>
        
        <span class="hljs-comment">// 步骤 A: 生成 catch 子句的 error 参数节点 (identifier)</span>
        <span class="hljs-comment">// 使用 path.scope.generateUidIdentifier 防止变量名冲突 (例如防止用户原代码里已经有个变量叫 err)</span>
        <span class="hljs-keyword">const</span> errorParam = path.<span class="hljs-property">scope</span>.<span class="hljs-title function_">generateUidIdentifier</span>(<span class="hljs-string">'err'</span>);

        <span class="hljs-comment">// 步骤 B: 构建 catch 块的内容</span>
        <span class="hljs-comment">// 这里我们可以根据配置，生成 console.error 或 reportError 调用</span>
        <span class="hljs-keyword">const</span> reporterName = state.<span class="hljs-property">opts</span>.<span class="hljs-property">reporter</span> || <span class="hljs-string">'console.error'</span>;
        
        <span class="hljs-comment">// 使用 babel template 快速构建 AST 节点，比手动 t.callExpression 更直观</span>
        <span class="hljs-comment">// %%err%% 是占位符，会被替换为上面生成的 errorParam</span>
        <span class="hljs-keyword">const</span> catchBodyTemplate = template.<span class="hljs-title function_">statement</span>(<span class="hljs-string">`
          <span class="hljs-subst">${reporterName}</span>('Async Error:', %%err%%);
        `</span>);
        
        <span class="hljs-keyword">const</span> catchBlockStatement = t.<span class="hljs-title function_">blockStatement</span>([
          <span class="hljs-title function_">catchBodyTemplate</span>({ <span class="hljs-attr">err</span>: errorParam })
        ]);

        <span class="hljs-comment">// 步骤 C: 构建 catch 子句节点</span>
        <span class="hljs-keyword">const</span> catchClause = t.<span class="hljs-title function_">catchClause</span>(
          errorParam,
          catchBlockStatement
        );

        <span class="hljs-comment">// 步骤 D: 构建 try 语句节点</span>
        <span class="hljs-comment">// path.node.body 是 BlockStatement，包含 body 属性（语句数组）</span>
        <span class="hljs-keyword">const</span> originalBodyStatements = path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>;
        
        <span class="hljs-keyword">const</span> tryStatement = t.<span class="hljs-title function_">tryStatement</span>(
          t.<span class="hljs-title function_">blockStatement</span>(originalBodyStatements), <span class="hljs-comment">// try 块内容</span>
          catchClause, <span class="hljs-comment">// catch 块</span>
          <span class="hljs-literal">null</span> <span class="hljs-comment">// finally 块 (可选)</span>
        );

        <span class="hljs-comment">// 步骤 E: 替换原函数体</span>
        <span class="hljs-comment">// 注意：直接替换 body 可能会导致死循环（因为新生成的节点也包含函数体），</span>
        <span class="hljs-comment">// 但这里我们要替换的是 Function 的 body (BlockStatement) 的内容，</span>
        <span class="hljs-comment">// 或者直接替换 body 为包含 tryStatement 的新 BlockStatement。</span>
        
        path.<span class="hljs-title function_">get</span>(<span class="hljs-string">'body'</span>).<span class="hljs-title function_">replaceWith</span>(
          t.<span class="hljs-title function_">blockStatement</span>([tryStatement])
        );

        <span class="hljs-comment">// 标记该节点已被访问，避免递归处理死循环 (Babel 默认会重新访问新插入的节点)</span>
        path.<span class="hljs-title function_">skip</span>(); 
      }
    }
  };
};
</code></pre>
<h4 data-id="heading-9">2. 增强版 Babel 插件逻辑 (处理细节)</h4>
<p>上面的版本比较粗暴（把整个函数体包起来）。但在实际中，我们可能只想包裹包含 <code>await</code> 的代码段，或者如果用户已经写了部分 <code>try-catch</code> 该怎么办？</p>
<p>下面是更精细的 AST 操作逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 进阶工具函数：检查 BlockStatement 中是否包含 await 表达式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">hasAwaitExpression</span>(<span class="hljs-params">path</span>) {
  <span class="hljs-keyword">let</span> hasAwait = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 使用 path.traverse 可以在当前路径下进行子遍历</span>
  path.<span class="hljs-title function_">traverse</span>({
    <span class="hljs-title class_">AwaitExpression</span>(childPath) {
      <span class="hljs-comment">// 必须确保 await 是属于当前函数的，而不是嵌套在内部其他 async 函数里的</span>
      <span class="hljs-keyword">const</span> parentFunction = childPath.<span class="hljs-title function_">getFunctionParent</span>();
      <span class="hljs-keyword">if</span> (parentFunction === path) {
        hasAwait = <span class="hljs-literal">true</span>;
        childPath.<span class="hljs-title function_">stop</span>(); <span class="hljs-comment">// 找到一个就停止</span>
      }
    },
    <span class="hljs-comment">// 防止遍历进入内部函数的陷阱</span>
    <span class="hljs-title class_">Function</span>(childPath) {
      childPath.<span class="hljs-title function_">skip</span>();
    }
  });
  <span class="hljs-keyword">return</span> hasAwait;
}

<span class="hljs-comment">// 修改 visitor 部分</span>
<span class="hljs-attr">visitor</span>: {
  <span class="hljs-title class_">Function</span>(path, state) {
    <span class="hljs-keyword">if</span> (!path.<span class="hljs-property">node</span>.<span class="hljs-property">async</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 进阶优化：如果没有 await，其实不需要包裹 try-catch (虽然 async 函数报错会返回 reject promise，但这里假设只捕获 await 异常)</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">hasAwaitExpression</span>(path)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 处理 React/Vue 组件方法名排除</span>
    <span class="hljs-keyword">const</span> functionName = path.<span class="hljs-property">node</span>.<span class="hljs-property">id</span> ? path.<span class="hljs-property">node</span>.<span class="hljs-property">id</span>.<span class="hljs-property">name</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'render'</span>, <span class="hljs-string">'setup'</span>, <span class="hljs-string">'componentDidCatch'</span>].<span class="hljs-title function_">includes</span>(functionName)) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// ... 后续转换逻辑同上 ...</span>
  }
}
</code></pre>
<h4 data-id="heading-10">3. Babel 插件单元测试</h4>
<p>Babel 插件测试通常使用 <code>babel-plugin-tester</code> 或直接调用 <code>@babel/core</code> 的 <code>transformSync</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> babel = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/core'</span>);
<span class="hljs-keyword">const</span> autoTryCatchPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./babel-plugin-auto-try-catch'</span>);
<span class="hljs-keyword">const</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

<span class="hljs-comment">// 辅助测试函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, options = {}</span>) {
  <span class="hljs-keyword">const</span> result = babel.<span class="hljs-title function_">transformSync</span>(code, {
    <span class="hljs-attr">plugins</span>: [
      [autoTryCatchPlugin, options] <span class="hljs-comment">// 加载插件并传入配置</span>
    ],
    <span class="hljs-comment">// 禁用 Babel 默认生成严格模式，减少干扰</span>
    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'script'</span>, 
    <span class="hljs-attr">compact</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 格式化输出代码</span>
  });
  <span class="hljs-keyword">return</span> result.<span class="hljs-property">code</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 开始测试 Babel 插件 ---'</span>);

<span class="hljs-comment">// 测试用例 1: 普通 Async 函数转换</span>
<span class="hljs-keyword">const</span> code1 = <span class="hljs-string">`
async function getData() {
  const res = await api.get('/user');
  return res;
}
`</span>;
<span class="hljs-keyword">const</span> output1 = <span class="hljs-title function_">transform</span>(code1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Case 1 Output]:\n'</span>, output1);
<span class="hljs-comment">/*
预期输出:
async function getData() {
  try {
    const res = await api.get('/user');
    return res;
  } catch (_err) {
    console.error('Async Error:', _err);
  }
}
*/</span>
assert.<span class="hljs-title function_">match</span>(output1, <span class="hljs-regexp">/try \{/</span>, <span class="hljs-string">'Case 1 Failed: try block missing'</span>);
assert.<span class="hljs-title function_">match</span>(output1, <span class="hljs-regexp">/catch \(_err\)/</span>, <span class="hljs-string">'Case 1 Failed: catch block missing'</span>);


<span class="hljs-comment">// 测试用例 2: 箭头函数转换</span>
<span class="hljs-keyword">const</span> code2 = <span class="hljs-string">`
const doWork = async () =&gt; {
  await sleep(1000);
  console.log('done');
};
`</span>;
<span class="hljs-keyword">const</span> output2 = <span class="hljs-title function_">transform</span>(code2);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Case 2 Output]:\n'</span>, output2);
assert.<span class="hljs-title function_">match</span>(output2, <span class="hljs-regexp">/try \{/</span>, <span class="hljs-string">'Case 2 Failed'</span>);


<span class="hljs-comment">// 测试用例 3: 已经有 Try-Catch 的函数 (应跳过)</span>
<span class="hljs-keyword">const</span> code3 = <span class="hljs-string">`
async function safe() {
  try {
    await risky();
  } catch (e) {
    handle(e);
  }
}
`</span>;
<span class="hljs-keyword">const</span> output3 = <span class="hljs-title function_">transform</span>(code3);
<span class="hljs-comment">// 输出应该和输入几乎一样（除了格式化差异）</span>
<span class="hljs-comment">// 我们通过判断 catch 块的数量来验证没有重复插入</span>
<span class="hljs-keyword">const</span> catchCount = (output3.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/catch/g</span>) || []).<span class="hljs-property">length</span>;
assert.<span class="hljs-title function_">strictEqual</span>(catchCount, <span class="hljs-number">1</span>, <span class="hljs-string">'Case 3 Failed: Should not add extra try-catch'</span>);


<span class="hljs-comment">// 测试用例 4: 自定义 Reporter 配置</span>
<span class="hljs-keyword">const</span> code4 = <span class="hljs-string">`async function test() { await fn(); }`</span>;
<span class="hljs-keyword">const</span> output4 = <span class="hljs-title function_">transform</span>(code4, { <span class="hljs-attr">reporter</span>: <span class="hljs-string">'window.reportToSentry'</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Case 4 Output]:\n'</span>, output4);
assert.<span class="hljs-title function_">match</span>(output4, <span class="hljs-regexp">/window\.reportToSentry/</span>, <span class="hljs-string">'Case 4 Failed: Custom reporter not working'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 所有测试通过 ---'</span>);
</code></pre>
<hr/>
<h3 data-id="heading-11">第四部分：底层机制深度对比</h3>
<p>这部分解释为什么代码要这么写，这对于理解 1000 行级别的复杂插件开发至关重要。</p>
<h4 data-id="heading-12">1. 遍历机制：Scope (作用域) 管理</h4>
<p>这是 Babel 和 ESLint 插件开发中最难的部分。</p>
<ul>
<li>
<p><strong>ESLint</strong>:</p>
<ul>
<li><code>context.getScope()</code> 获取当前节点的作用域。</li>
<li>主要用于查找变量定义（References）。例如：<code>no-undef</code> 规则就是通过遍历 Scope 中的 references 列表，看是否有未定义的变量。</li>
<li>ESLint 的 Scope 分析是<strong>静态只读</strong>的。你不能在 lint 过程中修改 Scope。</li>
</ul>
</li>
<li>
<p><strong>Babel</strong>:</p>
<ul>
<li><code>path.scope</code> 对象非常强大。</li>
<li><code>path.scope.generateUidIdentifier('name')</code>：自动生成唯一变量名（如 <code>_name</code>, <code>_name2</code>），这在转换代码注入变量时必不可少（如上面 <code>try-catch</code> 中的 <code>err</code>）。</li>
<li><code>path.scope.push({ id: ... })</code>：可以将变量声明提升到作用域顶部。</li>
<li><strong>Binding</strong>：Babel 维护了极其详细的变量绑定信息。你可以通过 <code>path.scope.bindings['x']</code> 找到变量 <code>x</code> 的所有引用位置（<code>referencePaths</code>）和赋值位置（<code>constantViolations</code>）。这使得做“死代码消除”或“常量折叠”成为可能。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">2. 状态管理 (State)</h4>
<ul>
<li>
<p><strong>ESLint</strong>:</p>
<ul>
<li>状态通常保存在闭包变量中，或者 <code>create</code> 函数的局部变量中。</li>
<li>因为 ESLint 是按文件处理的，<code>create</code> 每次处理新文件都会重新执行，所以闭包变量是文件隔离的。</li>
<li>如果需要跨文件信息（极其少见且不推荐，因为破坏缓存），需要用到全局单例。</li>
</ul>
</li>
<li>
<p><strong>Babel</strong>:</p>
<ul>
<li>状态通过 <code>state</code> 参数在 Visitor 方法间传递。</li>
<li><code>state.file</code> 包含当前文件的元数据。</li>
<li><code>state.opts</code> 包含用户在 <code>.babelrc</code> 传入的插件配置。</li>
<li>可以在 <code>pre()</code> 和 <code>post()</code> 钩子中初始化和清理状态。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Babel 状态管理示例</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-title function_">pre</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 初始化文件级缓存</span>
  },
  <span class="hljs-attr">visitor</span>: {
    <span class="hljs-title class_">Identifier</span>(path, state) {
      <span class="hljs-comment">// this.cache 在这里可用</span>
    }
  },
  <span class="hljs-title function_">post</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-comment">// 清理</span>
  }
};
</code></pre>
<h4 data-id="heading-14">3. 节点构造与替换</h4>
<ul>
<li>
<p><strong>ESLint Fixer</strong>:</p>
<ul>
<li>基于<strong>文本索引</strong>（Index）。</li>
<li>API: <code>replaceText(node, 'newText')</code>, <code>insertTextAfter(node, ';')</code>.</li>
<li>非常脆弱。如果你删除了一个逗号，可能导致后续的代码语法错误。ESLint 会尝试多次运行 fix 直到不再有变动，但它不保证生成的代码 AST 结构正确，只保证文本替换。</li>
</ul>
</li>
<li>
<p><strong>Babel Types</strong>:</p>
<ul>
<li>基于<strong>对象构建</strong>。</li>
<li>API: <code>t.binaryExpression('+', t.numericLiteral(1), t.numericLiteral(2))</code>。</li>
<li>非常健壮。只要符合 AST 规范，Babel Generator 就能生成合法的 JavaScript 代码（自动处理括号优先级、分号等）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">总结</h3>
<ul>
<li>如果你的需求是 <strong>“阻止开发者提交烂代码”</strong> 或者 <strong>“统一团队的代码风格”</strong>，请选择 <strong>ESLint 插件</strong>。它的核心是 Context 和 Report。</li>
<li>如果你的需求是 <strong>“减少重复的样板代码”</strong>，<strong>“兼容低版本浏览器”</strong> 或者 <strong>“实现一种新的语法糖”</strong>，请选择 <strong>Babel 插件</strong>。它的核心是 Path、Visitor 和 Types Builder。</li>
</ul>
<p>以上代码展示了从零构建一个架构级 ESLint 规则和一个编译级 Babel 转换插件的完整过程，涵盖了 AST 分析、上下文判断、节点构建和单元测试等核心环节。在实际工程中，这两者往往结合使用：Babel 负责把代码变样，ESLint 负责保证变样前的源码符合规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁说参数即正义？10B小钢炮Step3-VL硬刚千亿巨头]]></title>    <link>https://juejin.cn/post/7597679732364361770</link>    <guid>https://juejin.cn/post/7597679732364361770</guid>    <pubDate>2026-01-21T12:34:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597679732364361770" data-draft-id="7597679732364345386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁说参数即正义？10B小钢炮Step3-VL硬刚千亿巨头"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-21T12:34:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁说参数即正义？10B小钢炮Step3-VL硬刚千亿巨头
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:34:05.000Z" title="Wed Jan 21 2026 12:34:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很长一段时间里，AI圈流行着一种近乎迷信的认知：大力出奇迹。想要更强的推理能力？加参数。想要看懂更复杂的图表？加参数。仿佛只要把显卡堆满，模型就能产生神迹。</p>
<p>但就在2026年开年，阶跃星辰（StepFun）甩出的这张王炸——<strong>Step3-VL-10B</strong>，狠狠地给了“参数至上论”一记耳光。</p>
<p>这就好比在一场重量级拳击赛里，一个轻量级选手不仅抗住了重量级拳王的进攻，还反手把对方KO了。这款仅有100亿参数的模型，在多项核心指标上，硬生生按住了参数量是它10倍甚至20倍的对手。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdfgfdsgdf-1024x641.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdfgfdsgdf-1024x641.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbb14bcb18924c659bccb796f0f0d828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=Jc2AKdWGYDrWLBM%2BHLP%2B4ibpQus%3D" alt="asdfgfdsgdf" loading="lazy"/></a></p>
<p><strong>小身板里的怪兽级性能</strong></p>
<p>咱们先不谈虚的，直接看数据。</p>
<p>通常来说，10B级别的模型只能算是“甜点级”，用来做做简单的对话或者跑在笔记本上玩玩。但Step3-VL-10B拿出的成绩单简直不讲武德。</p>
<p>在数学竞赛基准AIME 2025上，它拿下了94.43%的高分。作为对比，Qwen3-VL（235B参数）和Gemini 2.5 Pro这种巨无霸都在它身后吃灰。在考察STEM综合能力的MMMU评测中，它也以80.11%的成绩超越了GLM-4.6V（106B）。</p>
<p>这不仅是“越级挑战”，这简直是降维打击。如果不是白纸黑字的技术报告摆在那里，很难相信一个10B模型能在数学视觉推理（MathVision）和GUI交互能力上把千亿模型逼到墙角。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfdasfds-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfdasfds-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb061cbb17794a42a620feffb161a2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=1bSJIsywkwlbtf7hg9ipOS9xhwc%3D" alt="asfdasfds" loading="lazy"/></a></p>
<p><strong>核心黑科技：它学会了“深思熟虑”</strong></p>
<p>这模型是吃了什么仙丹？答案是一个叫做 <strong>PaCoRe（并行协调推理）</strong> 的机制。</p>
<p>传统的模型推理大多是“直肠子”，给你一个问题，它基于当前的上下文顺着往下编，一条道走到黑。这种线性思维在处理复杂逻辑时很容易翻车，受限于上下文窗口，深度也有限。</p>
<p>Step3-VL-10B则不同。PaCoRe机制让它拥有了类似人类“系统2”的思考能力。当面对一个难题时，它不再急着给答案，而是瞬间在后台并行生成十几条甚至更多的推理轨迹。这就好比一个团队在头脑风暴，大家分头去试错、去验证，最后把所有线索汇总，合成一个最靠谱的结论。</p>
<p>通过这种“并行探索-协调合成”的方式，它在不增加上下文窗口的前提下，把有效推理计算量扩展到了百万Token级别。说白了，它用“更聪明的思考方式”弥补了“脑容量（参数）”的不足。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-21_20.22.05-1024x588.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-21_20.22.05-1024x588.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de89c85c647943c6aedd1938b7b90a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=GROzGjcifXex8s3%2Fkms5FNb04cc%3D" alt="iShot_2026-01-21_20.22.05" loading="lazy"/></a></p>
<p><strong>炼丹炉里的秘密</strong></p>
<p>除了推理架构的革新，底层的功夫也没少下。阶跃星辰这次走的是“全参数端到端联合预训练”的路子。</p>
<p>很多多模态模型为了省事，视觉编码器是冻结的，相当于给大模型戴了副近视眼镜。而Step3-VL-10B是把视觉和语言部分全部解冻，放在1.2万亿高质量Token里一起炼。再加上超过1400轮的强化学习（RL Scaling），这让视觉信号和语言逻辑在底层就实现了真正的打通。</p>
<p><strong>这意味着什么？</strong></p>
<p>Step3-VL-10B的开源，对行业的影响可能比发一个超级大模型还要深远。</p>
<p>首先是<strong>端侧AI的春天</strong>。以前想要这种级别的多模态理解能力，你必须联网调API，因为手机跑不动千亿模型。现在，10B的体量完全有机会塞进高性能笔记本甚至未来的旗舰手机里。你的个人电脑可能很快就能读懂复杂的PDF文档、帮你操作GUI界面，而且完全本地化运行。</p>
<p>其次，它打破了<strong>成本壁垒</strong>。对于研究者和开发者来说，这就是一个现成的、高性能的、可微调的基座。你不需要数百万美元的算力集群，只用几张消费级显卡，就能在这个强力基线上跑出实际应用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fsdfsaddrg-1024x981.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/sdfsaddrg-1024x981.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d63b86cdba24a84ae33159093db2fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=%2B3xGOeiG%2F%2BtXXcQSx8Qe%2F3dEx3M%3D" alt="sdfsaddrg" loading="lazy"/></a></p>
<p><strong>总结</strong></p>
<p>阶跃星辰这次不仅是发布了一个模型，更像是验证了一条新路：与其无休止地堆砌参数，不如回头看看推理架构的效率。</p>
<p>当一个10B模型开始在AIME数学竞赛里碾压对手时，我们知道，AI进化的风向，变了。对于开发者而言，现在最大的建议就是：赶紧去Hugging Face下载权重，在你的显卡上跑起来试试。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《实时渲染》第2章-图形渲染管线-2.3几何处理]]></title>    <link>https://juejin.cn/post/7597623654056443919</link>    <guid>https://juejin.cn/post/7597623654056443919</guid>    <pubDate>2026-01-21T12:42:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056443919" data-draft-id="7597650624637140992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《实时渲染》第2章-图形渲染管线-2.3几何处理"/> <meta itemprop="keywords" content="计算机图形学"/> <meta itemprop="datePublished" content="2026-01-21T12:42:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《实时渲染》第2章-图形渲染管线-2.3几何处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:42:16.000Z" title="Wed Jan 21 2026 12:42:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实时渲染</h2>
<h3 data-id="heading-1">2. 图形渲染管线</h3>
<h4 data-id="heading-2">2.3 几何处理</h4>
<p>GPU上的几何处理阶段负责大多数每个三角形和每个顶点的操作。该阶段进一步分为以下功能阶段：顶点着色、投影、裁剪和屏幕映射（如图2.3）。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/7612d48e2f9c4783bf8e5ec63aaf758b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=6Lcc%2Fc3L%2FGGdHSMzf85J0QGC%2Bts%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.3. 几何处理阶段分为一系列功能阶段</p>
</div>
<h5 data-id="heading-3">2.3.1 顶点着色</h5>
<p>顶点着色有两个主要任务，即计算顶点的位置和评估程序员可能喜欢的顶点输出数据，例如法线坐标和纹理坐标。传统上，对象的大部分阴影是通过将灯光应用到每个顶点的位置和法线并仅将结果颜色存储在顶点来计算的。然后将这些颜色插入整个三角形。出于这个原因，这个可编程的顶点处理单元被命名为顶点着色器[1049]。随着现代GPU的出现，以及每个像素发生的部分或全部着色，这个顶点着色阶段更加通用，并且可能根本不会求取任何着色方程的值，其工作主要取决于程序员的意图。顶点着色器现在是一个更通用的单元，专门用于设置与每个顶点关联的数据。例如，顶点着色器可以使用<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4.4%25E8%258A%2582" target="_blank" title="%E7%AC%AC4.4%E8%8A%82" ref="nofollow noopener noreferrer">第4.4节</a>和<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4.5%25E8%258A%2582" target="_blank" title="%E7%AC%AC4.5%E8%8A%82" ref="nofollow noopener noreferrer">第4.5节</a>中的方法为对象设置动画。</p>
<p>我们首先描述如何计算顶点位置，一组始终需要的坐标。在被屏幕显示的过程中，模型被转换成几个不同的空间或坐标系。最初，模型驻留在自己的模型空间中，这仅意味着它根本没有被转换。每个模型都可以与模型变换相关联，以便可以对其进行定位和定向。可以将多个模型转换与单个模型相关联。这允许同一模型的多个副本（称为实例）在同一场景中具有不同的位置、方向和大小，而无需复制基本几何体。</p>
<p>模型变换所变换的是模型的顶点和法线。对象的坐标称为模型坐标，在对这些坐标应用模型变换后，模型被称为位于世界坐标或世界空间中。世界空间是唯一的，模型经过各自的模型变换后，所有的模型都存在于同一个空间中。</p>
<p>如前所述，模型只有被相机（或观察者）看到才能渲染。相机在世界空间中有一个位置和一个方向，用于放置和瞄准相机。为了便于投影和剪辑，相机和所有模型都使用视图变换进行了变换。视图变换的目的是将相机放置在原点并瞄准它，使其看向负z轴的方向，y轴指向上方，x轴指向右侧。我们使用-z轴约定；一些文章也会使用向下看+z轴的约定。区别主要是语义上的，因为一个和另一个之间的转换很简单。应用视图变换后的实际位置和方向取决于底层应用程序编程接口 (API)。如此划定的空间称为相机空间，或更常见的是，视图空间或眼睛空间。视图变换影响相机和模型的方式示例如图2.4所示。模型变换和视图变换都可以用4×4矩阵来实现，这是<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC4%E7%AB%A0" ref="nofollow noopener noreferrer">第4章</a>的主题。但是，重要的是要意识到可以以程序员喜欢的任何方式计算顶点的位置和法线。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8d94ab1c1ab2456c9933558b2c01ef4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=DEAeJkKZm7YuJkhu8YJ%2FSHYt1Mc%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.4 在左图中，自上而下的视图显示了在+z轴向上的坐标系中，按照用户希望的方式定位和定向的相机。视图变换重新定向了坐标系，使相机位于原点，沿其负z轴看，相机的+y轴向上，如右图所示。这样做是为了使裁剪和投影操作更简单、更快捷。浅蓝色区域是视锥体。在这里，假设透视图，因为视锥体是一个平截头体。类似的技术适用于任何类型的投影。</p>
</div>
<p>接下来，我们将描述顶点着色的第二种类型的输出。要生成逼真的场景，仅渲染对象的形状和位置是不够的，还必须对它们的外观进行建模。该描述包括每个物体的材质，以及任何光源照射在物体上的效果。材料和灯光可以通过多种方式建模，从简单的颜色到物理描述的精细表示。</p>
<p>这种确定光对材料效果的操作称为着色。它涉及计算对象上不同点的着色方程。通常，其中一些计算在模型顶点的几何处理期间执行，而其他计算可能在逐像素处理期间执行。各种材质数据可以存储在每个顶点，例如点的位置、法线、颜色或求取着色方程值所需的任何其他数字信息。然后，顶点着色结果（可以是颜色、矢量、纹理坐标以及任何其他类型的着色数据）被发送到光栅化和像素处理阶段进行插值并用于计算表面的着色。</p>
<p>GPU顶点着色器形式的顶点着色在本书中进行了更深入的讨论，尤其是在<a href="https://link.juejin.cn?target=%25E7%25AC%25AC3%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC3%E7%AB%A0" ref="nofollow noopener noreferrer">第3章</a>和<a href="https://link.juejin.cn?target=%25E7%25AC%25AC5%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC5%E7%AB%A0" ref="nofollow noopener noreferrer">第5章</a>中。</p>
<p>作为顶点着色的一部分，渲染系统先进行投影，然后进行裁剪，将视图体换为单位立方体，其极值点位于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-1,-1,-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,1,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>之间。可以使用不同的范围来定义相同的体积，例如，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo>≤</mo><mi>z</mi><mo>≤</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0 ≤ z ≤ 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。单位立方体称为正规化视图体。投影是在GPU上由顶点着色器首先完成的。常用的投影方法有两种，即正射投影（也称平行投影）和透视投影，如图2.5。事实上，正射投影只是一种平行投影。也可以使用其他几种投影方式（特别是在建筑领域），例如斜投影和轴测投影。老式街机游戏Zaxxon就是以后者命名的。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/6a2460500079400594fa99a4db100add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=rWwAdKUBicG1VawdZv1nwJXjX4c%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.5. 左侧是正射投影或平行投影；右边是透视投影。</p>
</div>
<p>请注意，投影表示为矩阵（<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4.7%25E8%258A%2582" target="_blank" title="%E7%AC%AC4.7%E8%8A%82" ref="nofollow noopener noreferrer">第4.7节</a>），因此它有时可能与几何变换的其余部分连接。</p>
<p>正交观察的视图体通常是一个矩形框，正交投影将这个视图体变换为单位立方体。正交投影的主要特点是平行线在变换后保持平行。这种转换是平移和缩放的组合。</p>
<p>透视投影有点复杂。在这种类型的投影中，物体离相机越远，投影后看起来越小。另外，平行线可能会聚在地平线上。因此，透视变换模仿了我们感知物体大小的方式。在几何上，称为截头锥体的视图体是一个具有矩形底面的截棱锥。截头锥体也转化为单位立方体。正交变换和透视变换都可以用4×4矩阵构造（<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC4%E7%AB%A0" ref="nofollow noopener noreferrer">第4章</a>），并且在任一变换之后，模型都被称为在裁剪坐标中。这些实际上是齐次坐标，在<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC4%E7%AB%A0" ref="nofollow noopener noreferrer">第4章</a>中讨论过，因此这发生在除以w之前。GPU的顶点着色器必须始终输出这种类型的坐标，以便下一个功能阶段（裁剪）正常工作。</p>
<p>尽管这些矩阵将一个几何体转换为另一个几何体，但它们被称为投影，因为在显示之后，z坐标不存储在生成的图像中，而是存储在z缓冲区中，如<a href="https://link.juejin.cn?target=%25E7%25AC%25AC2.5%25E8%258A%2582" target="_blank" title="%E7%AC%AC2.5%E8%8A%82" ref="nofollow noopener noreferrer">第2.5节</a>所述。通过这种方式，模型从三维投影到两维。</p>
<h5 data-id="heading-4">2.3.2 可选的顶点处理</h5>
<p>每个管线都有刚刚描述的顶点处理。完成此处理后，可以在GPU上进行几个可选阶段，按顺序是：曲面细分、几何着色和流输出。它们的使用取决于硬件的能力——并非所有 GPU 都有它们——以及程序员的愿望。它们相互独立，一般不常用。 将在<a href="https://link.juejin.cn?target=%25E7%25AC%25AC3%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC3%E7%AB%A0" ref="nofollow noopener noreferrer">第3章</a>中详细介绍每一个。</p>
<p>第一个可选阶段是曲面细分。假设你有一个弹跳球对象。如果用一组三角形表示它，则可能会遇到质量或性能问题。您的球在5米外可能看起来不错，但近距离观察单个三角形，三角形的轮廓，就会变得清晰可见。如果你用更多的三角形制作球来提高质量，当球很远并且只覆盖屏幕上的几个像素时，你可能会浪费大量的处理时间和内存。通过曲面细分，可以使用适当数量的三角形生成曲面。</p>
<p>我们已经讨论了一些三角形，但在管线中的这一点上，我们只处理了顶点。这些可用于表示点、线、三角形或其他对象。顶点可用于描述曲面，例如球。这样的表面可以由一组面片指定，每个面片由一组顶点组成。曲面细分阶段由一系列阶段本身组成——外包着色器(hull shader)、曲面细分器(tessellator)和域着色器(domain shader)——将这些面片顶点集转换为（通常）更大的顶点集，然后用于制作新的三角形集。场景的相机可用于确定生成了多少个三角形：面片很近时很多，远处时很少。</p>
<p>下一个可选阶段是几何着色器。该着色器早于曲面细分着色器，因此在GPU上更常见。它类似于曲面细分着色器，因为它接受各种类型的图元并可以生成新的顶点。这是一个更简单的阶段，因为此创建的范围有限，输出图元的类型也更有限。几何着色器有多种用途，其中最流行的一种是粒子生成。想象一下模拟烟花爆炸。每个火球都可以用一个点来表示，一个顶点。几何着色器可以将每个点变成面向观察者并覆盖多个像素的正方形（由两个三角形组成），从而为我们提供更令人信服的图元进行着色。</p>
<p>最后一个可选阶段称为流输出。这个阶段让我们使用GPU作为几何引擎。与将我们处理过的顶点沿着管道的其余部分发送到屏幕上不同，此时我们可以选择将这些顶点输出到数组中以供进一步处理。这些数据可以由CPU或GPU本身在以后的过程中使用。此阶段通常用于粒子模拟，例如我们的烟花示例。</p>
<p>这三个阶段按此顺序执行——曲面细分、几何着色和流输出——每个阶段都是可选的。无论使用哪个（如果有）选项，如果我们继续沿着管道向下走，我们就会得到一组具有齐次坐标的顶点，这些顶点将被检查相机是否能看到它们。</p>
<h5 data-id="heading-5">2.3.3 裁剪</h5>
<p>只有全部或部分在视图体内部的图元需要传递到光栅化阶段（以及随后的像素处理阶段），然后在屏幕上绘制它们。完全位于视图体内部的图元将按原样传递到下一个阶段。完全在视图体积之外的基元不会被进一步传递，因为它们没有被渲染。部分位于视图体内部的图元需要裁剪。例如，一条直线，在视图体外部有一个顶点，在视图体积内部有一个顶点，此时应该根据视图体对其进行裁剪；以便外部的顶点被位于该线和视图体之间的交点处的新顶点替换。投影矩阵的使用意味着变换后的图元被裁剪到单位立方体上。在裁剪之前进行视图变换和投影的好处是可以使裁剪问题保持一致；图元总是针对单位立方体进行裁剪。</p>
<p>裁剪过程如图2.6所示。除了视图体积的六个剪裁平面之外，用户还可以定义额外的剪裁平面来明显地剪裁对象。第818页的图19.1中显示了显示这种可视化类型的图像，称为剖视(sectioning)。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/36303ce988584f24a3a6e56e725a1366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085680&amp;x-orig-sign=F5bHMGs4QsbJNDcKDMQwCBidCEU%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.6. 只需要单位立方体内部的图元（对应视锥体内部的图元）继续处理。因此，单位立方体外面的图元被丢弃，而完全在里面的图元被保留。与单位立方体相交的图元被裁剪在单位立方体上，从而产生新的顶点并丢弃旧的顶点。</p>
</div>
<p>裁剪步骤使用投影产生的4值齐次坐标进行裁剪。值通常不会跨透视空间中的三角形进行线性插值。需要第四个坐标，以便在使用透视投影时正确插入和裁剪数据。最后，执行透视除法，将生成的三角形的位置放入三维标准化设备坐标中。如前所述，此视图体积范围从<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-1,-1,-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,1,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。几何阶段的最后一步是从这个空间转换到窗口坐标。</p>
<h5 data-id="heading-6">2.3.4 屏幕映射</h5>
<p>只有视图体内部的（裁剪的）图元被传递到屏幕映射阶段，进入这个阶段时坐标仍然是三维的。每个图元的x和y坐标被转换为屏幕坐标。屏幕坐标与z坐标一起也称为窗口坐标。假设场景应该被渲染到一个最小位置在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_1,y_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，最大位置在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_2 ,y_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>处的窗口（其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_1 &lt; x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_1 &lt; y_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）。屏幕映射先是平移，然后是缩放操作。新的x和y坐标称为屏幕坐标。z坐标（OpenGL的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[−1,+1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">+</span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>和DirectX的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>）也被映射到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>z</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[z_1,z_2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>1</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">z_1=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>2</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">z_2=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>作为默认值。但是，这些可以通过API进行更改。窗口坐标连同这个重新映射的z值被传递到光栅化阶段。屏幕映射过程如图2.7所示。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/71a3a07a2c17406093516d89507294cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=HVxwG%2FnH9UGa3L2xMYvQ66E4608%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.7. 投影变换后的图元位于单位立方体中，屏幕映射程序负责在屏幕上找到坐标。</p>
</div>
<p>接下来，我们描述整数和浮点值如何与像素（和纹理坐标）相关。给定像素的水平数组并使用笛卡尔坐标，最左边像素的左边缘在浮点坐标中为0.0。OpenGL一直使用这种方案，DirectX10及其后续版本也使用它。该像素的中心为0.5。因此，一系列像素 [0,9] 覆盖了 [0.0,10.0) 的跨度。转换很简单：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"/><mtd><mrow><mi>d</mi><mo>=</mo><mi>f</mi><mi>l</mi><mi>o</mi><mi>o</mi><mi>r</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"/><mtd><mtext>(2.1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">d = floor(c) \tag{2.1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">oor</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2.1</span></span><span class="mord">)</span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"/><mtd><mrow><mi>c</mi><mo>=</mo><mi>d</mi><mo>+</mo><mn>0.5</mn></mrow></mtd><mtd width="50%"/><mtd><mtext>(2.2)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">c = d + 0.5 \tag{2.2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.5</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2.2</span></span><span class="mord">)</span></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>是像素的离散（整数）索引，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span>是像素内的连续（浮点）值。</p>
<p>虽然所有API的像素位置值都从左到右增加，但在OpenGL和DirectX<sup><a href="#user-content-fn-2" id="user-content-user-content-fnref-2" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-2">1</a></sup>之间的某些情况下，顶部和底部边缘的零位置不一致。OpenGL始终偏爱笛卡尔系统，将左下角视为最低值元素，而DirectX有时根据上下文将左上角定义为该元素。每个人都有一个逻辑，在他们不同的地方不存在正确的答案。例如，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">)</span></span></span></span></span>在 OpenGL中位于图像的左下角，而在DirectX中位于左上角。在从一个API迁移到另一个API时，必须考虑到这种差异。</p>
<h3 class="sr-only" id="user-content-footnote-label" data-id="heading-7">Footnotes</h3>
<ol>
<li id="user-content-user-content-fn-2">
<p>“Direct3D”是DirectX的三维图形API组件。DirectX包括其他API元素，例如输入和音频控件。我们不区分在指定特定版本时编写“DirectX”和在讨论此特定API时编写“Direct3D”，而是通过始终编写“DirectX”来遵循常见用法。 <a href="#user-content-fnref-2" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-2">↩</a></p>
</li>
</ol>
</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>