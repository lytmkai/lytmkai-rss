<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[综合项目实践：可视化技术核心实现与应用优化]]></title>    <link>https://juejin.cn/post/7587208390482329606</link>    <guid>https://juejin.cn/post/7587208390482329606</guid>    <pubDate>2025-12-24T07:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587208390482329606" data-draft-id="7587008326481674282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="综合项目实践：可视化技术核心实现与应用优化"/> <meta itemprop="keywords" content="Canvas,WebGL,SVG"/> <meta itemprop="datePublished" content="2025-12-24T07:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Fronty"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            综合项目实践：可视化技术核心实现与应用优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Fronty
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:16:00.000Z" title="Wed Dec 24 2025 07:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>可视化技术已成为现代前端开发不可或缺的一部分，从简单的图表展示到复杂的交互式数据可视化，再到沉浸式的3D体验，前端可视化正在重新定义用户体验。本文将全面解析可视化技术的核心实现，涵盖Canvas绘图、SVG操作、拖拽交互、动画系统、数据可视化库以及WebGL 3D渲染，通过完整可运行的代码示例，帮助你从零构建完整的可视化解决方案。</p>
<h4 data-id="heading-1">1. Canvas绘图库基础</h4>
<h5 data-id="heading-2">1.1 Canvas核心API与封装</h5>
<p>Canvas是HTML5提供的位图绘图技术，适合处理大量图形元素和像素级操作。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Canvas绘图工具类封装</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasDrawer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">canvasId, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(canvasId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,
      ...options
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 设置高清Canvas</span>
    <span class="hljs-keyword">const</span> dpr = <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span> || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> rect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> = rect.<span class="hljs-property">width</span> * dpr;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span> = rect.<span class="hljs-property">height</span> * dpr;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">scale</span>(dpr, dpr);
    
    <span class="hljs-comment">// 设置样式</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">lineJoin</span> = <span class="hljs-string">'round'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">lineCap</span> = <span class="hljs-string">'round'</span>;
  }

  <span class="hljs-comment">// 绘制基本图形</span>
  <span class="hljs-title function_">drawRect</span>(<span class="hljs-params">x, y, width, height, style = {}</span>) {
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`rect_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>;
    <span class="hljs-keyword">const</span> rect = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'rect'</span>,
      x, y, width, height,
      <span class="hljs-attr">style</span>: {
        <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#3498db'</span>,
        <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#2980b9'</span>,
        <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,
        ...style
      },
      id
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">save</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyStyles</span>(rect.<span class="hljs-property">style</span>);
    
    <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">style</span>.<span class="hljs-property">fillStyle</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fillRect</span>(x, y, width, height);
    }
    <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">style</span>.<span class="hljs-property">strokeStyle</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">strokeRect</span>(x, y, width, height);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">restore</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-title function_">set</span>(id, rect);
    <span class="hljs-keyword">return</span> id;
  }

  <span class="hljs-comment">// 绘制圆形</span>
  <span class="hljs-title function_">drawCircle</span>(<span class="hljs-params">x, y, radius, style = {}</span>) {
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`circle_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">beginPath</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">arc</span>(x, y, radius, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyStyles</span>(style);
    
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">fillStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fill</span>();
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">strokeStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">stroke</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-title function_">set</span>(id, { <span class="hljs-attr">type</span>: <span class="hljs-string">'circle'</span>, x, y, radius, style, id });
    <span class="hljs-keyword">return</span> id;
  }

  <span class="hljs-comment">// 绘制路径</span>
  <span class="hljs-title function_">drawPath</span>(<span class="hljs-params">points, style = {}</span>) {
    <span class="hljs-keyword">if</span> (points.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">beginPath</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">moveTo</span>(points[<span class="hljs-number">0</span>].<span class="hljs-property">x</span>, points[<span class="hljs-number">0</span>].<span class="hljs-property">y</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; points.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (points[i].<span class="hljs-property">type</span> === <span class="hljs-string">'quadratic'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">quadraticCurveTo</span>(
          points[i].<span class="hljs-property">cp1x</span>, points[i].<span class="hljs-property">cp1y</span>,
          points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>
        );
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (points[i].<span class="hljs-property">type</span> === <span class="hljs-string">'bezier'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">bezierCurveTo</span>(
          points[i].<span class="hljs-property">cp1x</span>, points[i].<span class="hljs-property">cp1y</span>,
          points[i].<span class="hljs-property">cp2x</span>, points[i].<span class="hljs-property">cp2y</span>,
          points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">lineTo</span>(points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>);
      }
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyStyles</span>(style);
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">closePath</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">closePath</span>();
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">fillStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fill</span>();
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">strokeStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">stroke</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-property">size</span>;
  }

  <span class="hljs-title function_">applyStyles</span>(<span class="hljs-params">styles</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>[key] = styles[key];
      }
    });
  }

  <span class="hljs-comment">// 清除画布</span>
  <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-title function_">clear</span>();
  }

  <span class="hljs-comment">// 获取像素数据（用于高级操作）</span>
  <span class="hljs-title function_">getPixelData</span>(<span class="hljs-params">x, y, width = <span class="hljs-number">1</span>, height = <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">getImageData</span>(x, y, width, height);
  }

  <span class="hljs-comment">// 保存为图片</span>
  <span class="hljs-title function_">toDataURL</span>(<span class="hljs-params">type = <span class="hljs-string">'image/png'</span>, quality = <span class="hljs-number">0.92</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">toDataURL</span>(type, quality);
  }
}
</code></pre>
<h5 data-id="heading-3">1.2 Canvas性能优化技巧</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Canvas性能优化类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasOptimizer</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">optimizeRendering</span>(<span class="hljs-params">canvas, options = {}</span>) {
    <span class="hljs-comment">// 1. 使用离屏Canvas进行复杂绘制</span>
    <span class="hljs-keyword">const</span> offscreenCanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-keyword">const</span> offscreenCtx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    
    offscreenCanvas.<span class="hljs-property">width</span> = canvas.<span class="hljs-property">width</span>;
    offscreenCanvas.<span class="hljs-property">height</span> = canvas.<span class="hljs-property">height</span>;
    
    <span class="hljs-comment">// 2. 批量绘制操作</span>
    <span class="hljs-keyword">return</span> {
      offscreenCanvas,
      offscreenCtx,
      <span class="hljs-comment">// 批量绘制矩形</span>
      <span class="hljs-title function_">batchDrawRects</span>(<span class="hljs-params">rects</span>) {
        offscreenCtx.<span class="hljs-title function_">save</span>();
        rects.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">rect</span> =&gt;</span> {
          offscreenCtx.<span class="hljs-property">fillStyle</span> = rect.<span class="hljs-property">color</span>;
          offscreenCtx.<span class="hljs-title function_">fillRect</span>(rect.<span class="hljs-property">x</span>, rect.<span class="hljs-property">y</span>, rect.<span class="hljs-property">width</span>, rect.<span class="hljs-property">height</span>);
        });
        offscreenCtx.<span class="hljs-title function_">restore</span>();
        
        <span class="hljs-comment">// 一次性绘制到主Canvas</span>
        canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>).<span class="hljs-title function_">drawImage</span>(offscreenCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      },
      
      <span class="hljs-comment">// 3. 使用requestAnimationFrame进行动画</span>
      <span class="hljs-title function_">animate</span>(<span class="hljs-params">callback</span>) {
        <span class="hljs-keyword">let</span> animationId;
        
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
          <span class="hljs-title function_">callback</span>();
          animationId = <span class="hljs-title function_">requestAnimationFrame</span>(animate);
        };
        
        <span class="hljs-title function_">animate</span>();
        
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">stop</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cancelAnimationFrame</span>(animationId)
        };
      }
    };
  }

  <span class="hljs-comment">// 避免频繁的重绘</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createDoubleBuffer</span>(<span class="hljs-params">canvas</span>) {
    <span class="hljs-keyword">const</span> buffers = [
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>),
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    ];
    
    buffers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">buffer</span> =&gt;</span> {
      buffer.<span class="hljs-property">width</span> = canvas.<span class="hljs-property">width</span>;
      buffer.<span class="hljs-property">height</span> = canvas.<span class="hljs-property">height</span>;
    });
    
    <span class="hljs-keyword">let</span> currentBuffer = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">getBuffer</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> buffers[currentBuffer];
      },
      <span class="hljs-title function_">swap</span>(<span class="hljs-params"/>) {
        currentBuffer = <span class="hljs-number">1</span> - currentBuffer;
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
        ctx.<span class="hljs-title function_">drawImage</span>(buffers[<span class="hljs-number">1</span> - currentBuffer], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      }
    };
  }
}
</code></pre>
<h4 data-id="heading-4">2. SVG操作库实现</h4>
<h5 data-id="heading-5">2.1 SVG核心操作封装</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SVGManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">containerId, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span> = <span class="hljs-string">'http://www.w3.org/2000/svg'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>(options);
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-comment">// 创建SVG画布</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElementNS</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span>, <span class="hljs-string">'svg'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'width'</span>, options.<span class="hljs-property">width</span> || <span class="hljs-string">'100%'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'height'</span>, options.<span class="hljs-property">height</span> || <span class="hljs-string">'100%'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'viewBox'</span>, options.<span class="hljs-property">viewBox</span> || <span class="hljs-string">'0 0 800 600'</span>);
    
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">preserveAspectRatio</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'preserveAspectRatio'</span>, options.<span class="hljs-property">preserveAspectRatio</span>);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>);
  }

  <span class="hljs-comment">// 创建SVG元素</span>
  <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, attributes = {}</span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElementNS</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span>, type);
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(attributes).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      element.<span class="hljs-title function_">setAttribute</span>(key, attributes[key]);
    });
    
    <span class="hljs-keyword">return</span> element;
  }

  <span class="hljs-comment">// 添加图形</span>
  <span class="hljs-title function_">addCircle</span>(<span class="hljs-params">cx, cy, r, styles = {}</span>) {
    <span class="hljs-keyword">const</span> circle = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'circle'</span>, {
      cx, cy, r,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseStyles</span>(styles)
    });
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`circle_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    circle.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'id'</span>, id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(circle);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">set</span>(id, circle);
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">element</span>: circle, id };
  }

  <span class="hljs-title function_">addRect</span>(<span class="hljs-params">x, y, width, height, styles = {}</span>) {
    <span class="hljs-keyword">const</span> rect = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'rect'</span>, {
      x, y, width, height,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseStyles</span>(styles)
    });
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`rect_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    rect.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'id'</span>, id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(rect);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">set</span>(id, rect);
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">element</span>: rect, id };
  }

  <span class="hljs-title function_">addPath</span>(<span class="hljs-params">d, styles = {}</span>) {
    <span class="hljs-keyword">const</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'path'</span>, {
      d,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseStyles</span>(styles)
    });
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`path_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    path.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'id'</span>, id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(path);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">set</span>(id, path);
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">element</span>: path, id };
  }

  <span class="hljs-comment">// 创建复杂图形</span>
  <span class="hljs-title function_">createPieChart</span>(<span class="hljs-params">data, centerX, centerY, radius</span>) {
    <span class="hljs-keyword">const</span> group = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'g'</span>);
    <span class="hljs-keyword">let</span> startAngle = <span class="hljs-number">0</span>;
    
    data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> sliceAngle = (item.<span class="hljs-property">value</span> / <span class="hljs-number">100</span>) * <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;
      <span class="hljs-keyword">const</span> endAngle = startAngle + sliceAngle;
      
      <span class="hljs-comment">// 计算路径</span>
      <span class="hljs-keyword">const</span> x1 = centerX + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(startAngle);
      <span class="hljs-keyword">const</span> y1 = centerY + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(startAngle);
      <span class="hljs-keyword">const</span> x2 = centerX + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(endAngle);
      <span class="hljs-keyword">const</span> y2 = centerY + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(endAngle);
      
      <span class="hljs-keyword">const</span> largeArcFlag = sliceAngle &gt; <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
      
      <span class="hljs-keyword">const</span> pathData = [
        <span class="hljs-string">`M <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span>`</span>,
        <span class="hljs-string">`L <span class="hljs-subst">${x1}</span> <span class="hljs-subst">${y1}</span>`</span>,
        <span class="hljs-string">`A <span class="hljs-subst">${radius}</span> <span class="hljs-subst">${radius}</span> 0 <span class="hljs-subst">${largeArcFlag}</span> 1 <span class="hljs-subst">${x2}</span> <span class="hljs-subst">${y2}</span>`</span>,
        <span class="hljs-string">'Z'</span>
      ].<span class="hljs-title function_">join</span>(<span class="hljs-string">' '</span>);
      
      <span class="hljs-keyword">const</span> slice = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addPath</span>(pathData, {
        <span class="hljs-attr">fill</span>: item.<span class="hljs-property">color</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getColor</span>(index),
        <span class="hljs-attr">stroke</span>: <span class="hljs-string">'#ffffff'</span>,
        <span class="hljs-string">'stroke-width'</span>: <span class="hljs-number">2</span>
      });
      
      group.<span class="hljs-title function_">appendChild</span>(slice.<span class="hljs-property">element</span>);
      startAngle = endAngle;
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(group);
    <span class="hljs-keyword">return</span> group;
  }

  <span class="hljs-comment">// 添加交互事件</span>
  <span class="hljs-title function_">addInteraction</span>(<span class="hljs-params">elementId, events</span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">get</span>(elementId);
    <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(events).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventType</span> =&gt;</span> {
      element.<span class="hljs-title function_">addEventListener</span>(eventType, events[eventType]);
    });
  }

  <span class="hljs-comment">// 样式解析</span>
  <span class="hljs-title function_">parseStyles</span>(<span class="hljs-params">styles</span>) {
    <span class="hljs-keyword">const</span> svgStyles = {};
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> svgKey = key.<span class="hljs-title function_">replace</span>(
        <span class="hljs-regexp">/[A-Z]/g</span>, 
        <span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> <span class="hljs-string">`-<span class="hljs-subst">${match.toLowerCase()}</span>`</span>
      );
      svgStyles[svgKey] = styles[key];
    });
    
    <span class="hljs-keyword">return</span> svgStyles;
  }

  <span class="hljs-comment">// 动画方法</span>
  <span class="hljs-title function_">animateElement</span>(<span class="hljs-params">elementId, properties, duration = <span class="hljs-number">1000</span></span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">get</span>(elementId);
    <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> startValues = {};
    
    <span class="hljs-comment">// 获取起始值</span>
    properties.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
      startValues[prop.<span class="hljs-property">attribute</span>] = 
        element.<span class="hljs-title function_">getAttribute</span>(prop.<span class="hljs-property">attribute</span>) || prop.<span class="hljs-property">from</span>;
    });
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
      <span class="hljs-keyword">const</span> progress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elapsed / duration, <span class="hljs-number">1</span>);
      
      properties.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> startValue = <span class="hljs-built_in">parseFloat</span>(startValues[prop.<span class="hljs-property">attribute</span>]);
        <span class="hljs-keyword">const</span> endValue = <span class="hljs-built_in">parseFloat</span>(prop.<span class="hljs-property">to</span>);
        <span class="hljs-keyword">const</span> currentValue = 
          startValue + (endValue - startValue) * <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">easing</span>(progress);
        
        element.<span class="hljs-title function_">setAttribute</span>(
          prop.<span class="hljs-property">attribute</span>, 
          currentValue + (prop.<span class="hljs-property">unit</span> || <span class="hljs-string">''</span>)
        );
      });
      
      <span class="hljs-keyword">if</span> (progress &lt; <span class="hljs-number">1</span>) {
        <span class="hljs-title function_">requestAnimationFrame</span>(animate);
      }
    };
    
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  }

  <span class="hljs-title function_">easing</span>(<span class="hljs-params">t</span>) {
    <span class="hljs-comment">// 缓动函数</span>
    <span class="hljs-keyword">return</span> t &lt; <span class="hljs-number">0.5</span> 
      ? <span class="hljs-number">2</span> * t * t 
      : -<span class="hljs-number">1</span> + (<span class="hljs-number">4</span> - <span class="hljs-number">2</span> * t) * t;
  }
}
</code></pre>
<h4 data-id="heading-6">3. 拖拽库实现</h4>
<h5 data-id="heading-7">3.1 高性能拖拽系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DragManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>,
      <span class="hljs-attr">dragSelector</span>: <span class="hljs-string">'.draggable'</span>,
      <span class="hljs-attr">handleSelector</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">cursor</span>: <span class="hljs-string">'move'</span>,
      <span class="hljs-attr">zIndex</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">onStart</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">onDrag</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">onEnd</span>: <span class="hljs-literal">null</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindEvents</span>();
  }

  <span class="hljs-title function_">bindEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(
      <span class="hljs-string">'mousedown'</span>, 
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMouseDown</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(
      <span class="hljs-string">'touchstart'</span>, 
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleTouchStart</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
    );
    
    <span class="hljs-comment">// 防止拖拽时选中文本</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'selectstart'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>) {
        e.<span class="hljs-title function_">preventDefault</span>();
      }
    });
  }

  <span class="hljs-title function_">register</span>(<span class="hljs-params">element, options = {}</span>) {
    <span class="hljs-keyword">const</span> dragId = <span class="hljs-string">`drag_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    
    <span class="hljs-keyword">const</span> dragInfo = {
      element,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">axis</span>: <span class="hljs-string">'both'</span>, <span class="hljs-comment">// 'x', 'y', 'both'</span>
        <span class="hljs-attr">bounds</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// { left, top, right, bottom }</span>
        <span class="hljs-attr">grid</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// [x, y]</span>
        ...options
      },
      <span class="hljs-attr">originalStyle</span>: {
        <span class="hljs-attr">position</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">position</span>,
        <span class="hljs-attr">cursor</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span>,
        <span class="hljs-attr">zIndex</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">zIndex</span>,
        <span class="hljs-attr">userSelect</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">userSelect</span>
      }
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">set</span>(dragId, dragInfo);
    <span class="hljs-keyword">return</span> dragId;
  }

  <span class="hljs-title function_">handleMouseDown</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">const</span> dragHandle = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span> 
      ? target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span>)
      : target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">dragSelector</span>);
    
    <span class="hljs-keyword">if</span> (!dragHandle) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> dragId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findDragId</span>(dragHandle);
    <span class="hljs-keyword">if</span> (!dragId) <span class="hljs-keyword">return</span>;
    
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startDrag</span>(dragId, e.<span class="hljs-property">clientX</span>, e.<span class="hljs-property">clientY</span>);
  }

  <span class="hljs-title function_">handleTouchStart</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> target = touch.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">const</span> dragHandle = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span>
      ? target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span>)
      : target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">dragSelector</span>);
    
    <span class="hljs-keyword">if</span> (!dragHandle) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> dragId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findDragId</span>(dragHandle);
    <span class="hljs-keyword">if</span> (!dragId) <span class="hljs-keyword">return</span>;
    
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startDrag</span>(dragId, touch.<span class="hljs-property">clientX</span>, touch.<span class="hljs-property">clientY</span>);
  }

  <span class="hljs-title function_">findDragId</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, info] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">entries</span>()) {
      <span class="hljs-keyword">if</span> (info.<span class="hljs-property">element</span>.<span class="hljs-title function_">contains</span>(element) || info.<span class="hljs-property">element</span> === element) {
        <span class="hljs-keyword">return</span> id;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-title function_">startDrag</span>(<span class="hljs-params">dragId, startX, startY</span>) {
    <span class="hljs-keyword">const</span> dragInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">get</span>(dragId);
    <span class="hljs-keyword">if</span> (!dragInfo) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span> = {
      ...dragInfo,
      dragId,
      startX,
      startY,
      <span class="hljs-attr">startLeft</span>: <span class="hljs-built_in">parseInt</span>(dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">left</span>) || <span class="hljs-number">0</span>,
      <span class="hljs-attr">startTop</span>: <span class="hljs-built_in">parseInt</span>(dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span>) || <span class="hljs-number">0</span>,
      <span class="hljs-attr">width</span>: dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">offsetWidth</span>,
      <span class="hljs-attr">height</span>: dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">offsetHeight</span>
    };
    
    <span class="hljs-comment">// 设置拖拽样式</span>
    dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">cursor</span>;
    dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">zIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">zIndex</span>;
    dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">userSelect</span> = <span class="hljs-string">'none'</span>;
    
    <span class="hljs-comment">// 绑定移动事件</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">moveHandler</span> = (<span class="hljs-params">e</span>) =&gt; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleMove</span>(e);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">upHandler</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">endDrag</span>();
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, moveHandler);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, moveHandler);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, upHandler);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchend'</span>, upHandler);
    
    <span class="hljs-comment">// 保存事件处理器以便移除</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">moveHandler</span> = moveHandler;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">upHandler</span> = upHandler;
    
    <span class="hljs-comment">// 回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">onStart</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onStart</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>);
    }
  }

  <span class="hljs-title function_">handleMove</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>) <span class="hljs-keyword">return</span>;
    
    e.<span class="hljs-title function_">preventDefault</span>();
    
    <span class="hljs-keyword">const</span> clientX = e.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'touch'</span>) 
      ? e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span> 
      : e.<span class="hljs-property">clientX</span>;
    <span class="hljs-keyword">const</span> clientY = e.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'touch'</span>)
      ? e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientY</span>
      : e.<span class="hljs-property">clientY</span>;
    
    <span class="hljs-keyword">let</span> deltaX = clientX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startX</span>;
    <span class="hljs-keyword">let</span> deltaY = clientY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startY</span>;
    
    <span class="hljs-comment">// 应用约束</span>
    <span class="hljs-keyword">const</span> constraints = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyConstraints</span>(deltaX, deltaY);
    deltaX = constraints.<span class="hljs-property">x</span>;
    deltaY = constraints.<span class="hljs-property">y</span>;
    
    <span class="hljs-comment">// 更新位置</span>
    <span class="hljs-keyword">const</span> newX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startLeft</span> + deltaX;
    <span class="hljs-keyword">const</span> newY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startTop</span> + deltaY;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${newX}</span>px`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${newY}</span>px`</span>;
    
    <span class="hljs-comment">// 回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">onDrag</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onDrag</span>({
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>,
        <span class="hljs-attr">x</span>: newX,
        <span class="hljs-attr">y</span>: newY,
        deltaX,
        deltaY
      });
    }
  }

  <span class="hljs-title function_">applyConstraints</span>(<span class="hljs-params">deltaX, deltaY</span>) {
    <span class="hljs-keyword">const</span> { options, element } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>;
    
    <span class="hljs-comment">// 轴向约束</span>
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">axis</span> === <span class="hljs-string">'x'</span>) {
      deltaY = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.<span class="hljs-property">axis</span> === <span class="hljs-string">'y'</span>) {
      deltaX = <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 边界约束</span>
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">bounds</span>) {
      <span class="hljs-keyword">const</span> bounds = options.<span class="hljs-property">bounds</span>;
      <span class="hljs-keyword">const</span> containerRect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
      <span class="hljs-keyword">const</span> elementRect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
      
      <span class="hljs-keyword">const</span> minX = bounds.<span class="hljs-property">left</span> || -<span class="hljs-title class_">Infinity</span>;
      <span class="hljs-keyword">const</span> maxX = bounds.<span class="hljs-property">right</span> !== <span class="hljs-literal">undefined</span> 
        ? bounds.<span class="hljs-property">right</span> - elementRect.<span class="hljs-property">width</span> 
        : <span class="hljs-title class_">Infinity</span>;
      <span class="hljs-keyword">const</span> minY = bounds.<span class="hljs-property">top</span> || -<span class="hljs-title class_">Infinity</span>;
      <span class="hljs-keyword">const</span> maxY = bounds.<span class="hljs-property">bottom</span> !== <span class="hljs-literal">undefined</span>
        ? bounds.<span class="hljs-property">bottom</span> - elementRect.<span class="hljs-property">height</span>
        : <span class="hljs-title class_">Infinity</span>;
      
      <span class="hljs-keyword">const</span> newX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startLeft</span> + deltaX;
      <span class="hljs-keyword">const</span> newY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startTop</span> + deltaY;
      
      deltaX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minX, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(maxX, newX)) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startLeft</span>;
      deltaY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minY, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(maxY, newY)) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startTop</span>;
    }
    
    <span class="hljs-comment">// 网格约束</span>
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">grid</span>) {
      <span class="hljs-keyword">const</span> [gridX, gridY] = options.<span class="hljs-property">grid</span>;
      deltaX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(deltaX / gridX) * gridX;
      deltaY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(deltaY / gridY) * gridY;
    }
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: deltaX, <span class="hljs-attr">y</span>: deltaY };
  }

  <span class="hljs-title function_">endDrag</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 移除事件监听</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">moveHandler</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchmove'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">moveHandler</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mouseup'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">upHandler</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchend'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">upHandler</span>);
    
    <span class="hljs-comment">// 恢复样式</span>
    <span class="hljs-keyword">const</span> dragInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">dragId</span>);
    <span class="hljs-keyword">if</span> (dragInfo) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>, dragInfo.<span class="hljs-property">originalStyle</span>);
    }
    
    <span class="hljs-comment">// 回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">onEnd</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onEnd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h4 data-id="heading-8">4. 动画库实现</h4>
<h5 data-id="heading-9">4.1 高性能动画引擎</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimationEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">easingFunctions</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEasingFunctions</span>();
  }

  <span class="hljs-comment">// 缓动函数集合</span>
  <span class="hljs-title function_">getEasingFunctions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">linear</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t,
      <span class="hljs-attr">easeInQuad</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t * t,
      <span class="hljs-attr">easeOutQuad</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t * (<span class="hljs-number">2</span> - t),
      <span class="hljs-attr">easeInOutQuad</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t &lt; <span class="hljs-number">0.5</span> ? <span class="hljs-number">2</span> * t * t : -<span class="hljs-number">1</span> + (<span class="hljs-number">4</span> - <span class="hljs-number">2</span> * t) * t,
      <span class="hljs-attr">easeInCubic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t * t * t,
      <span class="hljs-attr">easeOutCubic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> (--t) * t * t + <span class="hljs-number">1</span>,
      <span class="hljs-attr">easeInOutCubic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t &lt; <span class="hljs-number">0.5</span> ? <span class="hljs-number">4</span> * t * t * t : (t - <span class="hljs-number">1</span>) * (<span class="hljs-number">2</span> * t - <span class="hljs-number">2</span>) * (<span class="hljs-number">2</span> * t - <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>,
      <span class="hljs-attr">easeInElastic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> (<span class="hljs-number">0.04</span> - <span class="hljs-number">0.04</span> / t) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-number">25</span> * t) + <span class="hljs-number">1</span>,
      <span class="hljs-attr">easeOutElastic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> <span class="hljs-number">0.04</span> * t / (--t) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-number">25</span> * t),
      <span class="hljs-attr">spring</span>: <span class="hljs-function">(<span class="hljs-params">t, damping = <span class="hljs-number">0.5</span></span>) =&gt;</span> <span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-<span class="hljs-number">6</span> * damping * t) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span> / <span class="hljs-number">0.5</span>)
    };
  }

  <span class="hljs-comment">// 创建动画</span>
  <span class="hljs-title function_">animate</span>(<span class="hljs-params">target, properties, options = {}</span>) {
    <span class="hljs-keyword">const</span> animationId = <span class="hljs-string">`anim_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>;
    
    <span class="hljs-keyword">const</span> animation = {
      <span class="hljs-attr">id</span>: animationId,
      target,
      <span class="hljs-attr">startValues</span>: {},
      <span class="hljs-attr">endValues</span>: properties,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
        <span class="hljs-attr">delay</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">easing</span>: <span class="hljs-string">'linear'</span>,
        <span class="hljs-attr">onStart</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onComplete</span>: <span class="hljs-literal">null</span>,
        ...options
      },
      <span class="hljs-attr">startTime</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">state</span>: <span class="hljs-string">'waiting'</span>
    };
    
    <span class="hljs-comment">// 获取起始值</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(properties).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[prop] === <span class="hljs-string">'number'</span>) {
        animation.<span class="hljs-property">startValues</span>[prop] = target[prop];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target.<span class="hljs-property">style</span>[prop] !== <span class="hljs-string">'undefined'</span>) {
        animation.<span class="hljs-property">startValues</span>[prop] = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-title function_">getComputedStyle</span>(target)[prop]) || <span class="hljs-number">0</span>;
      }
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">set</span>(animationId, animation);
    
    <span class="hljs-comment">// 开始动画循环</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>();
    }
    
    <span class="hljs-keyword">return</span> animationId;
  }

  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>();
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params">currentTime = performance.now()</span>) {
    <span class="hljs-keyword">const</span> deltaTime = currentTime - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = currentTime;
    
    <span class="hljs-keyword">let</span> hasActiveAnimations = <span class="hljs-literal">false</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">animation, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'waiting'</span>) {
        animation.<span class="hljs-property">startTime</span> = currentTime + animation.<span class="hljs-property">options</span>.<span class="hljs-property">delay</span>;
        animation.<span class="hljs-property">state</span> = <span class="hljs-string">'delayed'</span>;
      }
      
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'delayed'</span> &amp;&amp; currentTime &gt;= animation.<span class="hljs-property">startTime</span>) {
        animation.<span class="hljs-property">state</span> = <span class="hljs-string">'running'</span>;
        <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">options</span>.<span class="hljs-property">onStart</span>) {
          animation.<span class="hljs-property">options</span>.<span class="hljs-title function_">onStart</span>(animation);
        }
      }
      
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'running'</span>) {
        <span class="hljs-keyword">const</span> elapsed = currentTime - animation.<span class="hljs-property">startTime</span>;
        animation.<span class="hljs-property">progress</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elapsed / animation.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span>, <span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 应用缓动函数</span>
        <span class="hljs-keyword">const</span> easingFunc = <span class="hljs-variable language_">this</span>.<span class="hljs-property">easingFunctions</span>[animation.<span class="hljs-property">options</span>.<span class="hljs-property">easing</span>] || <span class="hljs-variable language_">this</span>.<span class="hljs-property">easingFunctions</span>.<span class="hljs-property">linear</span>;
        <span class="hljs-keyword">const</span> easedProgress = <span class="hljs-title function_">easingFunc</span>(animation.<span class="hljs-property">progress</span>);
        
        <span class="hljs-comment">// 更新属性</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateProperties</span>(animation, easedProgress);
        
        <span class="hljs-comment">// 回调</span>
        <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">options</span>.<span class="hljs-property">onUpdate</span>) {
          animation.<span class="hljs-property">options</span>.<span class="hljs-title function_">onUpdate</span>(animation, easedProgress);
        }
        
        <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">progress</span> &gt;= <span class="hljs-number">1</span>) {
          animation.<span class="hljs-property">state</span> = <span class="hljs-string">'completed'</span>;
          <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">options</span>.<span class="hljs-property">onComplete</span>) {
            animation.<span class="hljs-property">options</span>.<span class="hljs-title function_">onComplete</span>(animation);
          }
          <span class="hljs-comment">// 标记为待清理</span>
          animation.<span class="hljs-property">state</span> = <span class="hljs-string">'finished'</span>;
        } <span class="hljs-keyword">else</span> {
          hasActiveAnimations = <span class="hljs-literal">true</span>;
        }
      }
    });
    
    <span class="hljs-comment">// 清理已完成的动画</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>();
    
    <span class="hljs-keyword">if</span> (hasActiveAnimations) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">update</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stop</span>();
    }
  }

  <span class="hljs-title function_">updateProperties</span>(<span class="hljs-params">animation, progress</span>) {
    <span class="hljs-keyword">const</span> { target, startValues, endValues } = animation;
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(endValues).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> startValue = startValues[prop];
      <span class="hljs-keyword">const</span> endValue = endValues[prop];
      <span class="hljs-keyword">const</span> currentValue = startValue + (endValue - startValue) * progress;
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[prop] === <span class="hljs-string">'number'</span>) {
        target[prop] = currentValue;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target.<span class="hljs-property">style</span>[prop] !== <span class="hljs-string">'undefined'</span>) {
        target.<span class="hljs-property">style</span>[prop] = currentValue + (<span class="hljs-keyword">typeof</span> endValue === <span class="hljs-string">'string'</span> ? endValue.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[0-9.-]/g</span>, <span class="hljs-string">''</span>) : <span class="hljs-string">''</span>);
      }
    });
  }

  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> finishedAnimations = [];
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">animation, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'finished'</span>) {
        finishedAnimations.<span class="hljs-title function_">push</span>(id);
      }
    });
    
    finishedAnimations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">delete</span>(id);
    });
  }

  <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span>) {
      <span class="hljs-title function_">cancelAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">pause</span>(<span class="hljs-params">animationId</span>) {
    <span class="hljs-keyword">const</span> animation = <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">get</span>(animationId);
    <span class="hljs-keyword">if</span> (animation &amp;&amp; animation.<span class="hljs-property">state</span> === <span class="hljs-string">'running'</span>) {
      animation.<span class="hljs-property">state</span> = <span class="hljs-string">'paused'</span>;
      animation.<span class="hljs-property">pauseTime</span> = performance.<span class="hljs-title function_">now</span>();
    }
  }

  <span class="hljs-title function_">resume</span>(<span class="hljs-params">animationId</span>) {
    <span class="hljs-keyword">const</span> animation = <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">get</span>(animationId);
    <span class="hljs-keyword">if</span> (animation &amp;&amp; animation.<span class="hljs-property">state</span> === <span class="hljs-string">'paused'</span>) {
      <span class="hljs-keyword">const</span> pauseDuration = performance.<span class="hljs-title function_">now</span>() - animation.<span class="hljs-property">pauseTime</span>;
      animation.<span class="hljs-property">startTime</span> += pauseDuration;
      animation.<span class="hljs-property">state</span> = <span class="hljs-string">'running'</span>;
      
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>();
      }
    }
  }

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params">animationId</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">delete</span>(animationId);
  }
}

<span class="hljs-comment">// 关键帧动画支持</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyframeAnimation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">target, keyframes, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">target</span> = target;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">normalizeKeyframes</span>(keyframes);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">iterations</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">direction</span>: <span class="hljs-string">'normal'</span>,
      <span class="hljs-attr">fillMode</span>: <span class="hljs-string">'forwards'</span>,
      ...options
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationEngine</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationEngine</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIteration</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">normalizeKeyframes</span>(<span class="hljs-params">keyframes</span>) {
    <span class="hljs-comment">// 确保关键帧按时间排序</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(keyframes)
      .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-built_in">parseFloat</span>(a) - <span class="hljs-built_in">parseFloat</span>(b))
      .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> ({
        <span class="hljs-attr">time</span>: <span class="hljs-built_in">parseFloat</span>(time) / <span class="hljs-number">100</span>,
        <span class="hljs-attr">properties</span>: keyframes[time]
      }));
  }

  <span class="hljs-title function_">play</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> segmentDuration = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span> / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">frame, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> nextFrame = <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>[index + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> duration = (nextFrame.<span class="hljs-property">time</span> - frame.<span class="hljs-property">time</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span>;
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationEngine</span>.<span class="hljs-title function_">animate</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">target</span>,
        nextFrame.<span class="hljs-property">properties</span>,
        {
          duration,
          <span class="hljs-attr">delay</span>: frame.<span class="hljs-property">time</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span>,
          <span class="hljs-attr">easing</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">easing</span>,
          <span class="hljs-attr">onComplete</span>: index === <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>.<span class="hljs-property">length</span> - <span class="hljs-number">2</span> 
            ? <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleIterationComplete</span>()
            : <span class="hljs-literal">null</span>
        }
      );
    });
  }

  <span class="hljs-title function_">handleIterationComplete</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIteration</span>++;
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIteration</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">iterations</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">play</span>();
    }
  }
}
</code></pre>
<h4 data-id="heading-10">5. 其他技术点</h4>
<h5 data-id="heading-11">5.1 响应式可视化适配</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponsiveVisualization</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, renderFunction, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderFunction</span> = renderFunction;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">debounceDelay</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">aspectRatio</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">minWidth</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">minHeight</span>: <span class="hljs-number">100</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupResizeObserver</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupWindowResize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initialRender</span>();
  }

  <span class="hljs-title function_">setupResizeObserver</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'ResizeObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function"><span class="hljs-params">entries</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleResize</span>();
      });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span>.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>);
    }
  }

  <span class="hljs-title function_">setupWindowResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleResize</span>();
    });
  }

  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateDimensions</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">debounceDelay</span>);
  }

  <span class="hljs-title function_">updateDimensions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> containerRect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
    
    <span class="hljs-keyword">let</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">minWidth</span>, containerRect.<span class="hljs-property">width</span>);
    <span class="hljs-keyword">let</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">minHeight</span>, containerRect.<span class="hljs-property">height</span>);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">aspectRatio</span>) {
      <span class="hljs-keyword">const</span> [ratioX, ratioY] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">aspectRatio</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
      <span class="hljs-keyword">const</span> targetRatio = ratioX / ratioY;
      <span class="hljs-keyword">const</span> currentRatio = width / height;
      
      <span class="hljs-keyword">if</span> (currentRatio &gt; targetRatio) {
        width = height * targetRatio;
      } <span class="hljs-keyword">else</span> {
        height = width / targetRatio;
      }
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span> = { width, height };
  }

  <span class="hljs-title function_">initialRender</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateDimensions</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderFunction</span>({
      <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span>.<span class="hljs-property">width</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span>.<span class="hljs-property">height</span>,
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>
    });
  }

  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span>.<span class="hljs-title function_">disconnect</span>();
    }
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span>);
  }
}
</code></pre>
<h5 data-id="heading-12">5.2 事件管理系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// 事件绑定</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">element, eventType, handler, options = {}</span>) {
    <span class="hljs-keyword">const</span> eventKey = <span class="hljs-string">`<span class="hljs-subst">${eventType}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>;
    <span class="hljs-keyword">const</span> wrappedHandler = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWrappedHandler</span>(handler, options);
    
    element.<span class="hljs-title function_">addEventListener</span>(eventType, wrappedHandler, options);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">set</span>(eventKey, {
      element,
      eventType,
      <span class="hljs-attr">handler</span>: wrappedHandler,
      <span class="hljs-attr">originalHandler</span>: handler,
      options
    });
    
    <span class="hljs-keyword">return</span> eventKey;
  }

  <span class="hljs-title function_">createWrappedHandler</span>(<span class="hljs-params">handler, options</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">throttle</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">throttle</span>(handler, options.<span class="hljs-property">throttle</span>, event);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.<span class="hljs-property">debounce</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debounce</span>(handler, options.<span class="hljs-property">debounce</span>, event);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">handler</span>(event);
      }
    };
  }

  <span class="hljs-comment">// 节流</span>
  <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, limit, ...args</span>) {
    <span class="hljs-keyword">let</span> inThrottle;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!inThrottle) {
        func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        inThrottle = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> inThrottle = <span class="hljs-literal">false</span>, limit);
      }
    };
  }

  <span class="hljs-comment">// 防抖</span>
  <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait, ...args</span>) {
    <span class="hljs-keyword">let</span> timeout;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeout);
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), wait);
    };
  }

  <span class="hljs-comment">// 事件委托</span>
  <span class="hljs-title function_">delegate</span>(<span class="hljs-params">parent, selector, eventType, handler</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(parent, eventType, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(selector);
      <span class="hljs-keyword">if</span> (target &amp;&amp; parent.<span class="hljs-title function_">contains</span>(target)) {
        handler.<span class="hljs-title function_">call</span>(target, event);
      }
    });
  }

  <span class="hljs-comment">// 移除事件</span>
  <span class="hljs-title function_">off</span>(<span class="hljs-params">eventKey</span>) {
    <span class="hljs-keyword">const</span> eventInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">get</span>(eventKey);
    <span class="hljs-keyword">if</span> (eventInfo) {
      eventInfo.<span class="hljs-property">element</span>.<span class="hljs-title function_">removeEventListener</span>(
        eventInfo.<span class="hljs-property">eventType</span>,
        eventInfo.<span class="hljs-property">handler</span>,
        eventInfo.<span class="hljs-property">options</span>
      );
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">delete</span>(eventKey);
    }
  }

  <span class="hljs-comment">// 一次性事件</span>
  <span class="hljs-title function_">once</span>(<span class="hljs-params">element, eventType, handler</span>) {
    <span class="hljs-keyword">const</span> eventKey = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(element, eventType, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-title function_">handler</span>(event);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(eventKey);
    });
    <span class="hljs-keyword">return</span> eventKey;
  }

  <span class="hljs-comment">// 触发自定义事件</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">element, eventType, detail = {}</span>) {
    <span class="hljs-keyword">const</span> event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(eventType, {
      <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">cancelable</span>: <span class="hljs-literal">true</span>,
      detail
    });
    element.<span class="hljs-title function_">dispatchEvent</span>(event);
  }

  <span class="hljs-comment">// 批量移除事件</span>
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">eventInfo, key</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(key);
    });
  }
}
</code></pre>
<h4 data-id="heading-13">6. 实战案例: 集成可视化仪表板</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VisualizationDashboard</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">containerId, dataSource</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span> = dataSource;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventManager</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadData</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupLayout</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderComponents</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupInteractions</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">getData</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load data:'</span>, error);
    }
  }

  <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
    <span class="hljs-comment">// 数据处理逻辑</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">summary</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateSummary</span>(rawData),
      <span class="hljs-attr">trends</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractTrends</span>(rawData),
      <span class="hljs-attr">categories</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">groupByCategory</span>(rawData)
    };
  }

  <span class="hljs-title function_">setupLayout</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用CSS Grid或Flexbox创建响应式布局</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;div class="dashboard-grid"&gt;
        &lt;div class="header" id="dashboard-header"&gt;
          &lt;h1&gt;数据可视化仪表板&lt;/h1&gt;
          &lt;div class="controls" id="dashboard-controls"&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="chart chart-large" id="main-chart"&gt;&lt;/div&gt;
        &lt;div class="chart chart-small" id="chart-1"&gt;&lt;/div&gt;
        &lt;div class="chart chart-small" id="chart-2"&gt;&lt;/div&gt;
        &lt;div class="chart chart-small" id="chart-3"&gt;&lt;/div&gt;
        &lt;div class="stats-panel" id="stats-panel"&gt;&lt;/div&gt;
      &lt;/div&gt;
    `</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupResponsive</span>();
  }

  <span class="hljs-title function_">setupResponsive</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> responsive = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponsiveVisualization</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>,
      <span class="hljs-function">(<span class="hljs-params">dimensions</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleResize</span>(dimensions),
      { <span class="hljs-attr">debounceDelay</span>: <span class="hljs-number">150</span> }
    );
  }

  <span class="hljs-title function_">renderComponents</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 渲染各个可视化组件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'mainChart'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createMainChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'chart1'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createPieChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'chart2'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createBarChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'chart3'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createLineChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'stats'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createStatsPanel</span>());
  }

  <span class="hljs-title function_">createMainChart</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'main-chart'</span>);
    <span class="hljs-keyword">const</span> chartType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">determineBestChart</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>.<span class="hljs-property">trends</span>);
    
    <span class="hljs-keyword">switch</span> (chartType) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'line'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createLineChart</span>(container, <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>.<span class="hljs-property">trends</span>, {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'趋势分析'</span>,
          <span class="hljs-attr">showLegend</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">animated</span>: <span class="hljs-literal">true</span>
        });
      <span class="hljs-keyword">case</span> <span class="hljs-string">'bar'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createBarChart</span>(container, <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>.<span class="hljs-property">categories</span>, {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'分类对比'</span>,
          <span class="hljs-attr">stacked</span>: <span class="hljs-literal">true</span>
        });
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCustomVisualization</span>(container, <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>);
    }
  }

  <span class="hljs-title function_">setupInteractions</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 设置组件间的交互</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">component, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">onClick</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">on</span>(
          component.<span class="hljs-property">element</span>,
          <span class="hljs-string">'click'</span>,
          <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleComponentClick</span>(id, event)
        );
      }
    });
    
    <span class="hljs-comment">// 全局筛选器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupFilters</span>();
  }

  <span class="hljs-title function_">setupFilters</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> controls = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dashboard-controls'</span>);
    controls.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;select id="time-range"&gt;
        &lt;option value="7d"&gt;最近7天&lt;/option&gt;
        &lt;option value="30d"&gt;最近30天&lt;/option&gt;
        &lt;option value="90d"&gt;最近90天&lt;/option&gt;
      &lt;/select&gt;
      &lt;button id="refresh-btn"&gt;刷新数据&lt;/button&gt;
    `</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">on</span>(
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'time-range'</span>),
      <span class="hljs-string">'change'</span>,
      <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleTimeRangeChange</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)
    );
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">on</span>(
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'refresh-btn'</span>),
      <span class="hljs-string">'click'</span>,
      <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshData</span>()
    );
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadData</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateAllComponents</span>();
  }

  <span class="hljs-title function_">updateAllComponents</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">update</span>) {
        component.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>);
      }
    });
  }

  <span class="hljs-title function_">handleComponentClick</span>(<span class="hljs-params">componentId, event</span>) {
    <span class="hljs-comment">// 处理组件点击事件，实现联动</span>
    <span class="hljs-keyword">const</span> clickedData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractDataFromEvent</span>(event);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">component, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (id !== componentId &amp;&amp; component.<span class="hljs-property">filter</span>) {
        component.<span class="hljs-title function_">filter</span>(clickedData);
      }
    });
  }

  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params">dimensions</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">resize</span>) {
        component.<span class="hljs-title function_">resize</span>(dimensions);
      }
    });
  }

  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">destroy</span>) {
        component.<span class="hljs-title function_">destroy</span>();
      }
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">cleanup</span>();
  }
}
</code></pre>
<h4 data-id="heading-14">7. 性能优化与最佳实践</h4>
<h5 data-id="heading-15">7.1 内存管理</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryLeakDetector</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 智能引用计数</span>
  <span class="hljs-title function_">trackReference</span>(<span class="hljs-params">object, type</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">has</span>(object)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">set</span>(object, {
        type,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">refCount</span>: <span class="hljs-number">0</span>
      });
    }
    
    <span class="hljs-keyword">const</span> refInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">get</span>(object);
    refInfo.<span class="hljs-property">refCount</span>++;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      refInfo.<span class="hljs-property">refCount</span>--;
      <span class="hljs-keyword">if</span> (refInfo.<span class="hljs-property">refCount</span> &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupObject</span>(object);
      }
    };
  }

  <span class="hljs-comment">// 对象池</span>
  <span class="hljs-title function_">createObjectPool</span>(<span class="hljs-params">factory, size</span>) {
    <span class="hljs-keyword">const</span> pool = {
      <span class="hljs-attr">available</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(size).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">factory</span>()),
      <span class="hljs-attr">inUse</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),
      <span class="hljs-attr">acquire</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">available</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> obj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">available</span>.<span class="hljs-title function_">pop</span>();
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">inUse</span>.<span class="hljs-title function_">add</span>(obj);
          <span class="hljs-keyword">return</span> obj;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">factory</span>();
      },
      <span class="hljs-attr">release</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inUse</span>.<span class="hljs-title function_">has</span>(obj)) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">inUse</span>.<span class="hljs-title function_">delete</span>(obj);
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">available</span>.<span class="hljs-title function_">push</span>(obj);
        }
      }
    };
    
    <span class="hljs-keyword">return</span> pool;
  }

  <span class="hljs-comment">// 缓存管理</span>
  <span class="hljs-title function_">createCache</span>(<span class="hljs-params">maxSize = <span class="hljs-number">100</span>, ttl = <span class="hljs-number">60000</span></span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),
      maxSize,
      ttl,
      
      <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
          <span class="hljs-keyword">const</span> oldestKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">delete</span>(oldestKey);
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">set</span>(key, {
          value,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
          <span class="hljs-attr">expire</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>
        });
      },
      
      <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
        <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">get</span>(key);
        
        <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; item.<span class="hljs-property">expire</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">delete</span>(key);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-keyword">return</span> item.<span class="hljs-property">value</span>;
      }
    };
  }

  <span class="hljs-comment">// 内存泄漏检测</span>
  <span class="hljs-title function_">setupLeakDetection</span>(<span class="hljs-params">interval = <span class="hljs-number">30000</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryLeakDetector</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkForLeaks</span>();
    }, interval);
  }

  <span class="hljs-title function_">checkForLeaks</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> leaks = [];
    
    <span class="hljs-comment">// 简化的泄漏检测逻辑</span>
    <span class="hljs-comment">// 实际应用中需要更复杂的检测机制</span>
    
    <span class="hljs-keyword">if</span> (leaks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Potential memory leaks detected:'</span>, leaks);
    }
  }

  <span class="hljs-title function_">cleanupObject</span>(<span class="hljs-params">object</span>) {
    <span class="hljs-comment">// 清理对象的资源</span>
    <span class="hljs-keyword">if</span> (object.<span class="hljs-property">dispose</span> &amp;&amp; <span class="hljs-keyword">typeof</span> object.<span class="hljs-property">dispose</span> === <span class="hljs-string">'function'</span>) {
      object.<span class="hljs-title function_">dispose</span>();
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">delete</span>(object);
  }
}
</code></pre>
<h4 data-id="heading-16">总结</h4>
<p>本文详细介绍了Web可视化技术的核心实现，包括Canvas绘图、SVG操作、拖拽交互和动画系统。通过封装可复用的工具类，我们可以构建高性能、可维护的可视化应用。</p>
<p><strong>关键实现总结:</strong></p>
<ol>
<li><strong>Canvas优化:</strong> 使用离屏渲染、批量操作和双缓冲技术</li>
<li><strong>SVG矢量:</strong> 利用DOM操作和CSS动画实现流畅的可视化</li>
<li><strong>交互体验:</strong> 实现平滑的拖拽和丰富的用户交互</li>
<li><strong>动画性能:</strong> 基于requestAnimationFrame的高性能动画引擎</li>
<li><strong>响应式设计:</strong> 自动适配不同屏幕尺寸和分辨率</li>
<li><strong>内存管理:</strong> 有效管理资源，防止内存泄漏</li>
</ol>
<p>这些实现不仅展示了各种可视化技术的核心原理，还提供了实际项目中可以使用的完整解决方案。通过理解这些底层实现，开发者可以更好地掌握可视化技术，创建出更高效、更美观、更交互性强的可视化应用。</p>
<p>可视化技术的核心在于将抽象数据转化为直观的视觉形式，帮助用户理解和发现数据中的模式与洞见。随着Web技术的不断发展，前端可视化将继续在各个领域发挥重要作用，从数据仪表盘到科学可视化，从游戏开发到虚拟现实，可视化技术的前景无限广阔。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境]]></title>    <link>https://juejin.cn/post/7587017021314072611</link>    <guid>https://juejin.cn/post/7587017021314072611</guid>    <pubDate>2025-12-24T06:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314072611" data-draft-id="7586944874527227942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境"/> <meta itemprop="keywords" content="前端,Node.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T06:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:44:35.000Z" title="Wed Dec 24 2025 06:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你可能听说过 <strong>“<code>Node.js</code> 是 <code>JS</code> 的运行环境”</strong>，但这玩意儿到底咋用？提到 <code>JavaScript</code>，你可能先想到它在浏览器里折腾网页特效的样子；但 <code>Node.js</code> 的出现，直接把 JS 从浏览器 <strong>“解放”</strong> 了出来，让它能像 <code>Python</code>、<code>Java</code> 一样，在操作系统上<strong>呼风唤雨</strong> —— 读写文件、操作终端、搭建后端服务都不在话下。而<strong>模块化</strong>，正是 Node.js 让代码变得整洁、可复用的<strong>核心秘诀</strong>。</p>
<p>今天咱从<strong>模块化</strong>入手，再手把手写个小游戏，让你把<code>Node.js</code>玩明白！</p>
<h3 data-id="heading-1">一、先认识 Node.js 的 “自带工具”：process、__dirname 这些都啥啊？</h3>
<p><code>Node.js</code> 刚启动时，就给我们准备了一堆 “开箱即用” 的工具。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 最基础的控制台输出，和浏览器里的console.log用法一致</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);

<span class="hljs-comment">// Date对象：处理时间和日期，比如new Date()能获取当前时间</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Date</span>);

<span class="hljs-comment">// 定时器方法：Node.js 里也能设置延时/重复执行的代码</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">setTimeout</span>); <span class="hljs-comment">// 延时执行（毫秒级）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">setInterval</span>); <span class="hljs-comment">// 重复执行（毫秒级）</span>
<span class="hljs-comment">// console.log(requestAnimationFrame); // 适配浏览器/Node.js的帧动画（Node.js 16+支持）</span>

<span class="hljs-comment">// 路径相关：定位文件位置的“神器”</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(__dirname); <span class="hljs-comment">// 打印当前文件所在文件夹的绝对路径</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(__filename); <span class="hljs-comment">// 打印当前文件的完整绝对路径（包含文件名）</span>

<span class="hljs-comment">// 进程参数：获取终端执行命令时传的参数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">argv</span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa205234674f4047916e04507d2738c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=23kvnQAlrhS4cs2k7k7tP%2BB5usU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">二、Node.js 模块化：代码也能 “打包快递”</h3>
<p>写代码像<strong>搭积木</strong> —— 把重复的功能拆成独立文件，要用的时候 “拼” 起来，这就是<strong>模块化</strong>。<code>Node.js</code> 支持两种主流规范：</p>
<h4 data-id="heading-3">1. CommonJS：Node.js 自带的 “老牌规范”</h4>
<p>就像你寄快递时填 <strong>“收件人信息”</strong>，CommonJS 用 <code>module.exports</code> 打包功能，<code>require()</code> 取快递：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// lib.js（打包功能）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">minus</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-keyword">return</span> x - y;
}
<span class="hljs-comment">// 把 add 和 munus 打包成 “快递”</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    add,
    minus
}
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// index.js（取快递用功能）</span>
<span class="hljs-comment">// 用 require 拿到 lib.js 里的 add</span>
<span class="hljs-keyword">const</span> lib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib.js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));    <span class="hljs-comment">// 输出 3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">minus</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));  <span class="hljs-comment">// 输出 -1</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d0b1164778438f93717ade0ccb5406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=ewq3XaoLLgIbg4Lvg6%2Bi6eheZtE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa28b665dcd34c08ac89d5b14ec4faad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=LWRXdLFeVzwLohzlyh9RGpG3t9w%3D" alt="image.png" loading="lazy"/></p>
<p>当然每次<code>console.log</code>都要写一遍<code>lib.</code>，会感到很烦，所以这里用解构的方法会更舒服点：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> {add, minus} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib.js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">minus</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d7cb5d2e1544e9a9d77c6fc56bd950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=b8xJB4Zk8ijPCl7GZH1JidLjnYk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2. ESModule：前端圈的 “新潮流规范”</h4>
<p>如果你的项目想和浏览器端代码 <strong>“互通”</strong>，可以用 <code>ESModule</code>,但是但是但是重要的事情说三遍：得在 <code>package.json</code> 里加 <code>"type": "module"</code>（一般情况下是有的，直接修改<code>type</code>里的值即可）。</p>
<p>上图更清晰：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/346db870a8fc41e9acc73280306195a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=qM3UJ%2FNkPXaWrjM9yWtnhZWLpDU%3D" alt="image.png" loading="lazy"/></p>
<p>还是 <code>common</code> 文件夹的例子：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// lib.js（用 export default 打包）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>){
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">minus</span>(<span class="hljs-params">x, y</span>){
    <span class="hljs-keyword">return</span> x - y;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    add,
    minus
}
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// index.js（用 import 导入）</span>
<span class="hljs-keyword">import</span> lib <span class="hljs-keyword">from</span> <span class="hljs-string">'./lib.js'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));    <span class="hljs-comment">// 输出 3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">minus</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));  <span class="hljs-comment">// 输出 -1</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59c339de367d4d91ad232f19074688f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=UPYsSVVF933EPOHNTQD96ZyzsHM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">三、实战：用 Node.js 写 “石头剪刀布” 游戏</h3>
<p>没错，<strong>“石头剪刀布”</strong> 怎么就不算小游戏了，这可不算欺骗哦😮。好了我知道你肯定会觉得很简单然后马上打开Steam的，但来都来了，那就👀看我如何用<code>Node.js</code>写出来的。</p>
<p>逻辑很简单：你在终端输入 <strong>“rock/scissor/paper”</strong>，电脑随机出拳，然后比胜负～</p>
<h4 data-id="heading-6">第一步：先写 “游戏核心逻辑”（模块化拆分）</h4>
<p>把 “出拳、比胜负” 的功能拆到 <code>game/lib.js</code> 里</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// game/lib.js（游戏核心逻辑）</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">playerAction</span>) {
    <span class="hljs-comment">// 电脑随机出拳（rock/scissor/paper 三选一）</span>
    <span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'rock'</span>, <span class="hljs-string">'scissor'</span>, <span class="hljs-string">'paper'</span>];
    <span class="hljs-keyword">const</span> index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3</span>); <span class="hljs-comment">// 向下取整(0,1,2)</span>
    <span class="hljs-keyword">const</span> computerAction = arr[index];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`我出了<span class="hljs-subst">${computerAction}</span>`</span>);

    <span class="hljs-comment">// 比胜负，返回结果（0=平，-1=你赢，1=你输）</span>
    <span class="hljs-keyword">if</span> (computerAction === playerAction) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'平局'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((playerAction === <span class="hljs-string">'rock'</span> &amp;&amp; computerAction === <span class="hljs-string">'scissor'</span>) ||
        (playerAction === <span class="hljs-string">'scissor'</span> &amp;&amp; computerAction === <span class="hljs-string">'paper'</span>) ||
        (playerAction === <span class="hljs-string">'paper'</span> &amp;&amp; computerAction === <span class="hljs-string">'rock'</span>)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你赢了'</span>);
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你输了'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
}
</code></pre>
<h4 data-id="heading-7">第二步：写 “终端交互逻辑”（调用核心功能）</h4>
<p>在 <code>game/index.js</code> 里，用 Node.js 的 <code>process</code> 模块获取你在终端的输入，再调用游戏逻辑:</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// game/index.js（终端交互）</span>
<span class="hljs-keyword">const</span> game = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib.js'</span>);
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 统计你赢的次数</span>

<span class="hljs-comment">// 监听终端输入（你输入的内容会传到 e 里）</span>
process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-comment">// 把输入的内容转成字符串，去掉空格</span>
    <span class="hljs-keyword">const</span> playerAction = e.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();
    <span class="hljs-comment">// 调用游戏逻辑，拿到结果</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">game</span>(playerAction);
    
    <span class="hljs-keyword">if</span> (result === -<span class="hljs-number">1</span>) {
        count++;
    }
    
    <span class="hljs-comment">// 赢 3 次就结束游戏</span>
    <span class="hljs-keyword">if</span> (count === <span class="hljs-number">3</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你太厉害了，我不玩了'</span>);
        process.<span class="hljs-title function_">exit</span>(); <span class="hljs-comment">// 结束 Node.js 进程</span>
    }
});
</code></pre>
<h4 data-id="heading-8">第三步：跑起来！在终端玩游戏</h4>
<p>打开终端，进入 <code>game</code> 文件夹，执行：</p>
<pre><code class="hljs language-bash" lang="bash">node index.js
</code></pre>
<p>然后输入 <code>rock</code>/<code>scissor</code>/<code>paper</code>，就能和电脑 PK 啦～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1595278193e947b79d6965f03cfe917b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=EYi5D8Gg7Lbf0XWXL3M0DgRl5oE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83735c5f618848fa95088d88408465b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=mhZjGX8nzrgKNjpqlzPBhDPjceE%3D" alt="image.png" loading="lazy"/></p>
<p>占用你玩2分钟玩Steam的时间看完了我的石头剪刀布~ 😊 ⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄</p>
<h3 data-id="heading-9">四、总结：Node.js 到底是啥？</h3>
<p><strong>一句话：</strong> 它不仅是 “JS 运行环境”，更是<strong>让你用 JS 写 “能和操作系统互动” 代码的工具</strong>—— 比如读文件、监听终端输入、写后端服务… 而模块化是它的 “基本功”，帮你把代码写得更整洁、更好维护～</p>
<h2 data-id="heading-10">结语</h2>
<p>从模块化规范的拆解，到石头剪刀布游戏的落地，不难发现 <strong>Node.js</strong> 的魅力：它让 JavaScript 跳出了前端的局限，拥有了跨场景开发的能力。小小的 <code>require</code> 和 <code>export</code> 背后，是代码组织的大智慧；简单的终端交互游戏里，藏着后端开发的雏形。</p>
<p>希望这篇内容能让你对 <code>Node.js</code> 不再陌生，下次遇到复杂项目时，也能想起用模块化思维拆解问题，用 <strong>Node.js</strong> 敲出属于自己的有趣代码。</p>
<p>另外要查看<code>Node.js</code>详细资料的话，官网在这：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn" target="_blank" title="https://nodejs.org/zh-cn" ref="nofollow noopener noreferrer">Node.js 官网</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[子组件和父组件之间优雅通信---松耦合]]></title>    <link>https://juejin.cn/post/7587017021314187299</link>    <guid>https://juejin.cn/post/7587017021314187299</guid>    <pubDate>2025-12-24T06:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314187299" data-draft-id="7586941468873179170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="子组件和父组件之间优雅通信---松耦合"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-24T06:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快乐星球喂"/> <meta itemprop="url" content="https://juejin.cn/user/662375936570116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            子组件和父组件之间优雅通信---松耦合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662375936570116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快乐星球喂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:52:45.000Z" title="Wed Dec 24 2025 06:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、传统的写法</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父组件</span>
&lt;!-- 父组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> 
    @<span class="hljs-attr">tabActiveFn</span>=<span class="hljs-string">"onTabActiveUpdate"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goOrder"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">refresh</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'刷新数据'</span>);
    },
    <span class="hljs-title function_">onTabActiveUpdate</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = newValue;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refresh</span>();
    },
     <span class="hljs-title function_">goOrder</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'order'</span> });
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子组件</span>
&lt;!-- 子组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in TAB"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[tabActive === item.index ? 'active' : 'tab']"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTab(item)"</span>&gt;</span> {{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goOrder"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tabActive</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">TAB</span>: [
        { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> },
        { <span class="hljs-attr">index</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> }
      ],
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeTab</span>(<span class="hljs-params">item</span>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'tabActiveFn'</span>, item.<span class="hljs-property">index</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = item.<span class="hljs-property">index</span>;
    },
     <span class="hljs-title function_">goOrder</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'order'</span> });
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-1">2、使用语法糖</h2>
<ul>
<li>（1）父组件定义一个万能方法<code>onInvoke(action) { this[action]?.(); }</code>，根据传入的字符串调用对应方法。</li>
<li>（2）父组件通过自定义事件@invokeFn<code>&lt;ChildComponent @invokeFn="onInvoke"/&gt;</code>暴露给子组件。</li>
<li>（3）子组件<code>&lt;button @click="$emit('invokeFn', 'goOrder')"&gt;&lt;/button&gt;</code>，点击时，触发父组件<code>invokeFn</code>事件并传值<code>goOrder</code></li>
<li>（4）父组件收到事件，执行<code>onInvoke('goOrder')</code>，最终安全调用<code>goOrder</code>方法。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父组件</span>
&lt;!-- 父组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> 
    @<span class="hljs-attr">tabActiveFn</span>=<span class="hljs-string">"onTabActiveUpdate"</span>
    @<span class="hljs-attr">invokeFn</span>=<span class="hljs-string">"onInvoke"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">refresh</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 刷新数据</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'刷新数据'</span>);
    },
    <span class="hljs-title function_">onTabActiveUpdate</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = newValue;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refresh</span>();
    },
    <span class="hljs-title function_">goOrder</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'order'</span> });
    },
    <span class="hljs-title function_">onInvoke</span>(<span class="hljs-params">action</span>) {
      <span class="hljs-variable language_">this</span>[action]?.();
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子组件</span>
&lt;!-- 子组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in TAB"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[tabActive === item.index ? 'active' : 'tab']"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTab(item)"</span>&gt;</span> {{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$emit('invokeFn', 'goOrder')"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tabActive</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">TAB</span>: [
        { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> },
        { <span class="hljs-attr">index</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> }
      ],
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeTab</span>(<span class="hljs-params">item</span>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'tabActiveFn'</span>, item.<span class="hljs-property">index</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = item.<span class="hljs-property">index</span>;
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>其中，<code>this.[action]</code>，使用方括号语法，动态的访问当前对象（this）上名为action变量值的属性或者方法。例如：action是‘goOrder’,它就试图获取<code>this.goOrder</code>。</p>
<p><code>?()</code>是可<strong>选链操作符</strong>和<strong>函数</strong>的结合，如果<code>this.[action]</code>的值不是<code>null</code>或者<code>undefined</code>，则调用该函数；如果是，则整个<code>表达式短路</code>，返回<code>undefined</code>，而不会抛出错误。</p>
<p>可选链<code>?.</code>是ES2020中引入的一个非常实用的语法。它的核心价值是在于<strong>防止在访问嵌套属性或者方法时，因中间某个值为null或者undefined而导致运行时错误</strong>。</p>
<h4 data-id="heading-2">优点：松耦合，子组件完全不需要知道父组件具体有哪些方法，它只需要知道自己需要触发什么指令。父组件则负责接收指令并执行对应的逻辑，这使得子组件的复用性非常高，可以轻松被不同父组件使用，只要这些父组件都实现了相应的指令并监听了对应的事件即可。</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NodeJs：前端工程化推手]]></title>    <link>https://juejin.cn/post/7586957587077398578</link>    <guid>https://juejin.cn/post/7586957587077398578</guid>    <pubDate>2025-12-24T06:58:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586957587077398578" data-draft-id="7586941468872720418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NodeJs：前端工程化推手"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-24T06:58:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fighting不想说话"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545614173"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NodeJs：前端工程化推手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545614173/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fighting不想说话
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:58:31.000Z" title="Wed Dec 24 2025 06:58:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Node.js到底是什么？</h2>
<p>html+css+javaScript写的好好的，突然来了一个 Node，这到底是个什么东西？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4b23a2ae8c4d8795a67ecd6ea4baca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=pFxSi50XTD7B1W33Xpd3Y5XmilM%3D" alt="Node.js 官方 Logo" loading="lazy"/></p>
<p>Node.js（简称 Node）是一个让 JavaScript 在浏览器之外运行 的开源运行时环境。简单说，它把 JavaScript 从“只能在网页里跑”的限制中解放出来，让你可以用 JS 写服务器程序、命令行工具、桌面应用，甚至前端构建脚本。</p>
<h4 data-id="heading-1">一、旧时代的结构性困境</h4>
<p>早年的前端开发，表面看是“手工活多”，实际上是遇到了硬性天花板。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span><span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"lib/bootstrap-3.3.7/css/bootstrap.min.css"</span>&gt;</span>
   
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"css/reset.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"css/common.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"css/index.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中。。。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    // script
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"lib/jquery/jquery-1.12.4.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"lib/lodash/lodash.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"lib/bootstrap-3.3.7/js/bootstrap.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/config.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/utils.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/api.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/index.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 入口函数</span>
        $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-comment">// 访问全局变量，毫无约束</span>
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li>手动管理一堆 script 标签，下载各种js文件，依赖顺序全靠记忆。</li>
<li>全局作用域污染严重，变量冲突是家常便饭。</li>
<li>HTTP 请求爆炸，几十个文件加载慢得影响核心指标。</li>
<li>上线前手动合并、压缩、雪碧图、inline 资源、cdn地址，全靠经验和脚本。</li>
</ul>
<p>这些问题本质上是<strong>浏览器 JavaScript 的安全沙箱限制</strong>：无法访问本地文件系统，直接导致我们无法构建任何可靠的自动化流程。</p>
<p>结果前端就被困在“<strong>页面仔</strong>”的定位里：</p>
<ul>
<li>项目规模很难上量（页面过多就乱套）。</li>
<li>代码复用率低（没有模块化）。</li>
<li>团队协作成本高（全局污染导致 merge 冲突频繁）。</li>
<li>性能优化全靠个人英雄主义。</li>
</ul>
<h4 data-id="heading-2">二、Node.js 带来了什么？</h4>
<p>Node.js 自 2009 年诞生以来，已经彻底改变了 JavaScript 的生态和应用场景。</p>
<h5 data-id="heading-3">Node 的工作原理：</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9f6a2d6f68742068242af693e8deafa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=p2k7qMIde9fEBVv7cOGvHjcRNyE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>V8 引擎</strong>：负责解析和执行 JavaScript 代码，高性能编译。</li>
<li><strong>libuv</strong>：C 语言编写的跨平台 I/O 库，提供事件循环、线程池、异步 I/O 支持。</li>
<li><strong>原生模块</strong>：如 http、fs、net 等，通过 C++ 绑定层连接 V8 和 libuv。</li>
<li><strong>JavaScript 层</strong>：我们写的代码 + NPM 包。</li>
</ul>
<h6 data-id="heading-4">① 事件循环 （Event Loop）</h6>
<p>Node 是单线程的，但通过事件循环实现并发。事件循环是 libuv 的核心，不断轮询处理事件队列。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612cf28b160947028058adeef0ebac8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=I4rgc3%2FNBpMN1KM2EqxGphbEfbQ%3D" alt="image.png" loading="lazy"/></p>
<p>Node 就像一家只有<strong>一名超级服务员</strong>（Event Loop）的餐厅：<strong>顾客（Request）</strong> 源源不断进店点餐，服务员接单后，如果是 <strong>倒水这种简单活（同步任务）</strong> 就当场解决，一旦遇到需要烹饪的“硬菜”（耗时 I/O），他会立刻把单子甩给幕后的<strong>厨师团队（Thread Pool）</strong> 去处理，然后自己马上转头接待下一位顾客；等厨师团队从 <strong>食材仓库中（Database/File System/Networks/Others）</strong> 取出对应的食材，把菜 <strong>做好了（Operation Completed）</strong>，会把“上菜”塞回服务员的列表里，服务员趁着空档把菜端给对应的顾客（执行回调），从而用一个人实现了海量订单的高效流转。</p>
<h6 data-id="heading-5">② 非阻塞 I/O 模型</h6>
<p>传统阻塞 I/O：一个请求占用线程，等待完成才处理下一个。</p>
<p>Node 非阻塞：遇到 I/O 操作（如读文件、网络请求），直接交给操作系统内核或线程池异步处理，主线程立即继续执行其他代码。完成后，通过事件通知回调。</p>
<h5 data-id="heading-6">Node 的优势与特点</h5>
<ul>
<li><strong>文件系统操作（fs 模块）</strong>：JS 终于能读写本地文件了。</li>
<li><strong>NPM 包管理</strong>：全球最大的包生态，安装依赖一句话搞定。</li>
<li><strong>命令行工具</strong>：基于 Node，我们能写脚本自动化一切。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e24def68b2740b79ec1d3d4f9534986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=dE1eyTqry5MYJUvtvgJB5tOu80c%3D" alt="NPM 生态示意图" loading="lazy"/></p>
<p><strong>Node 只在开发和构建时用</strong>，上线后还是纯静态文件跑浏览器。就像盖房子用的塔吊，房子盖好就拆。</p>
<h4 data-id="heading-7">三、工程化跃迁</h4>
<h6 data-id="heading-8">① 从此 Node 造就了前端工程化的工具链：</h6>
<ul>
<li><strong>Webpack、Rollup、Vite</strong>：打包、模块化、Tree Shaking。</li>
<li><strong>Babel</strong>：语法转译（ES6+ 到 ES5）。</li>
<li><strong>ESLint、Prettier</strong>：代码规范。</li>
<li><strong>Dev Server + HMR</strong>：热模块替换，改代码秒刷新。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edb16f91f7934453ab8b7e9bbd1488a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=BrYVPmTVKlqovNln8A9lTEvHzIQ%3D" alt="3f1a98b9-81ad-4d83-ba1c-570108166835.png" loading="lazy"/></p>
<h6 data-id="heading-9">② Vue 和 React皆是 Node 工具链上的受益者</h6>
<p>在 Node 的工程化基础上，Vue 和 React 才能真正起飞。它们不是原因，而是结果 → 依赖工具链来编译、打包组件。</p>
<p><strong>Vue 的单文件组件（SFC）:</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 模板、脚本、样式一文件搞定 --&gt; 
&lt;template&gt;
  &lt;div&gt;
    &lt;h2&gt;计数器：{{ count }}&lt;/h2&gt;
    &lt;button @click="count++"&gt;+1&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue';
const count = ref(0);
&lt;/script&gt;

&lt;style scoped&gt;
button { padding: 10px; background: #42b983; color: white; }
&lt;/style&gt;
</code></pre>
<p><strong>React 的 JSX ：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Counter.jsx </span>
<span class="hljs-comment">// Babel @babel/preset-react preset 处理 JSX</span>

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) { 
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); 
    <span class="hljs-keyword">return</span> (
        ## 计数器：{count}
        <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;+<span class="hljs-number">1</span>
    ); 
}
</code></pre>
<p>这些框架代码不管是在 <strong>开发时</strong>（<strong>快速启动、按需加载、语法转译、资源处理、插件生态等等</strong>） 还是 <strong>构建时</strong>（<strong>Tree Shaking、代码分割、资源优化、Chunk 命名和缓存优化、预加载/预获取等等</strong>） ，都高度依赖 Node 的相关工具链。可以说没有 Node，就没有今天的框架体验，当然也把我们从重复、低价值的体力活里彻底解放出来，给了我们一个高效、可靠的开发方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ElementUI：表格如何展示超出单元格的内容且不影响单元格？]]></title>    <link>https://juejin.cn/post/7587046913692073990</link>    <guid>https://juejin.cn/post/7587046913692073990</guid>    <pubDate>2025-12-24T07:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587046913692073990" data-draft-id="7587208390482247686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ElementUI：表格如何展示超出单元格的内容且不影响单元格？"/> <meta itemprop="keywords" content="前端,Vue.js,Element"/> <meta itemprop="datePublished" content="2025-12-24T07:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="simon9124"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917712045"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ElementUI：表格如何展示超出单元格的内容且不影响单元格？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917712045/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    simon9124
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:09:50.000Z" title="Wed Dec 24 2025 07:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimon9124%2Fmy_demos" target="_blank" title="https://github.com/simon9124/my_demos" ref="nofollow noopener noreferrer">前端小讴</a>，阅读更多原创技术文章</strong></p>
</blockquote>
<ul>
<li>这个问题之前在封装<strong>表格行内编辑校验</strong>时就一直困扰我，近期因为业务需求又不得不面对了</li>
</ul>
<h2 data-id="heading-0">需求详述</h2>
<ul>
<li><code>ElementUi</code>表格列若干（肯定有横向滚动条），在若干行（不固定）的某一列上（不固定）展示指定文字，</li>
<li>要展示的文字长度大概率比该列宽度大</li>
<li>文字需要完整展示，可跨单元格</li>
</ul>
<h2 data-id="heading-1">尝试过程</h2>
<ul>
<li>直接使用<strong>自定义渲染单元格</strong>，失败，超出单元格部分会被遮盖</li>
<li>自定义指令在<code>document</code>上渲染内容，失败，定位很困难（很难拿到该单元格相对整个<code>document</code>的位置），且内容也不随滚动条滚动</li>
<li>使用<code>el-tooltip</code>，让其一直保持展示，失败，<code>el-tooltip</code>初始化没有定位，只有在鼠标移入时才有</li>
</ul>
<h2 data-id="heading-2">成功方案</h2>
<ul>
<li>使用<code>el-popover</code>弹出框的<strong>手动激活</strong>方式，其既保证<code>dom</code>结构在单元格里，又能打破<strong>内容无法超出单元格</strong>的壁垒</li>
</ul>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-table-column
    v-for="(column, i) in columnList"
    :key="column.value"
    width="20"
    class-name="gantt-column"
  &gt;
    &lt;template slot-scope="scope"&gt;
      &lt;div class="gantt-bar" :style="`background: green`"&gt;
        &lt;el-popover
          v-if="scope.row.percent"
          v-model="visible"
          popper-class="gantt-percent-popover"
          trigger="manual"
          :content="`${scope.row.percent}%`"
        &gt;
        &lt;/el-popover&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/el-table-column&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data() {
    return {
      columnList: [], // 动态表格列
      visible: true, // popover-始终展示
    };
  },
};
&lt;/script&gt;

&lt;style lang="scss"&gt;
.gantt-percent-popover {
  width: max-content;
  min-width: auto;
  border: none;
  box-shadow: none;
  background: none;
  padding: 0 !important;
  font-size: 14px;
  color: rgba(0, 0, 0, 1);
  font-weight: bold;
  // text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
  white-space: nowrap;
  height: 23px;
  line-height: 23px;
  transform: translate(-40%, 0);
  font-style: italic;
}
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-19 快速掌握Kotlin-可空类型扩展函数]]></title>    <link>https://juejin.cn/post/7586994471739392043</link>    <guid>https://juejin.cn/post/7586994471739392043</guid>    <pubDate>2025-12-24T05:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586994471739392043" data-draft-id="7586994471739375659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-19 快速掌握Kotlin-可空类型扩展函数"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-19 快速掌握Kotlin-可空类型扩展函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:53:43.000Z" title="Wed Dec 24 2025 05:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 中，<strong>可空类型扩展函数</strong> 是一种强大的特性，允许你为可空类型（<code>T?</code>）定义扩展函数。这些函数可以在可空变量上安全调用，避免了显式的空检查。</p>
<h2 data-id="heading-0">1. 基本语法</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为可空类型 String? 定义扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">safeLength</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.length ?: <span class="hljs-number">0</span>  <span class="hljs-comment">// 使用安全调用和 Elvis 操作符</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> name: String? = <span class="hljs-string">"Kotlin"</span>
    <span class="hljs-keyword">val</span> nullName: String? = <span class="hljs-literal">null</span>
    
    println(name.safeLength())     <span class="hljs-comment">// 6</span>
    println(nullName.safeLength()) <span class="hljs-comment">// 0 - 不会抛出 NPE</span>
}
</code></pre>
<h2 data-id="heading-1">2. 与不可空扩展函数的区别</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不可空扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">uppercaseFirst</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNotEmpty()) {
        <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].uppercase() + <span class="hljs-keyword">this</span>.substring(<span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>
    }
}

<span class="hljs-comment">// 可空扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">safeUppercaseFirst</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isNullOrEmpty()) {
        <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].uppercase() + <span class="hljs-keyword">this</span>.substring(<span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span> ?: <span class="hljs-string">""</span>  <span class="hljs-comment">// 处理 null 情况</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> str: String? = <span class="hljs-string">"hello"</span>
    
    <span class="hljs-comment">// str.uppercaseFirst()  // 编译错误：需要不可空类型</span>
    println(str.safeUppercaseFirst())  <span class="hljs-comment">// "Hello"</span>
    
    println(<span class="hljs-literal">null</span>.safeUppercaseFirst()) <span class="hljs-comment">// "" - 不会崩溃</span>
}
</code></pre>
<h2 data-id="heading-2">3. 实际应用示例</h2>
<h3 data-id="heading-3">示例1：可空集合处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Collection<span class="hljs-type">&lt;T&gt;</span>?.<span class="hljs-title">isNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.isEmpty()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Collection<span class="hljs-type">&lt;T&gt;</span>?.<span class="hljs-title">safeSize</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.size ?: <span class="hljs-number">0</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list: List&lt;String&gt;? = <span class="hljs-literal">null</span>
    println(list.isNullOrEmpty())  <span class="hljs-comment">// true</span>
    println(list.safeSize())       <span class="hljs-comment">// 0</span>
}
</code></pre>
<h3 data-id="heading-4">示例2：链式调用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toIntOrNull</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>?.toInt()
    } <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
        <span class="hljs-literal">null</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toIntWithDefault</span><span class="hljs-params">(default: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toIntOrNull() ?: default
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> input1: String? = <span class="hljs-string">"123"</span>
    <span class="hljs-keyword">val</span> input2: String? = <span class="hljs-string">"abc"</span>
    <span class="hljs-keyword">val</span> input3: String? = <span class="hljs-literal">null</span>
    
    println(input1.toIntWithDefault())  <span class="hljs-comment">// 123</span>
    println(input2.toIntWithDefault())  <span class="hljs-comment">// 0</span>
    println(input3.toIntWithDefault())  <span class="hljs-comment">// 0</span>
}
</code></pre>
<h3 data-id="heading-5">示例3：DSL 风格扩展</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T?.<span class="hljs-title">whenNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) {
        block(<span class="hljs-keyword">this</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> T?.<span class="hljs-title">whenNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>, default: <span class="hljs-type">R</span>)</span></span>: R {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) {
        block(<span class="hljs-keyword">this</span>)
    } <span class="hljs-keyword">else</span> {
        default
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> name: String? = <span class="hljs-string">"Alice"</span>
    <span class="hljs-keyword">val</span> nullName: String? = <span class="hljs-literal">null</span>
    
    name.whenNotNull {
        println(<span class="hljs-string">"Name is <span class="hljs-variable">$it</span>"</span>)  <span class="hljs-comment">// 输出: Name is Alice</span>
    }
    
    nullName.whenNotNull {
        println(<span class="hljs-string">"This won't print"</span>)
    }
    
    <span class="hljs-keyword">val</span> length = name.whenNotNull({ it.length }, <span class="hljs-number">0</span>)
    println(length)  <span class="hljs-comment">// 5</span>
}
</code></pre>
<h2 data-id="heading-6">4. 作用域函数扩展</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> T?.<span class="hljs-title">withNotNull</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">this</span>?.block()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any, R&gt;</span> T?.<span class="hljs-title">letNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.let(block)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> T?.<span class="hljs-title">alsoNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T? {
    <span class="hljs-keyword">this</span>?.also(block)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> nullableValue: String? = <span class="hljs-string">"test"</span>
    
    nullableValue.withNotNull {
        println(uppercase())  <span class="hljs-comment">// 输出: TEST</span>
    }
    
    <span class="hljs-keyword">val</span> result = nullableValue.letNotNull {
        it.length * <span class="hljs-number">2</span>
    }
    println(result)  <span class="hljs-comment">// 8</span>
}
</code></pre>
<h2 data-id="heading-7">5. 实用工具函数</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文件路径处理</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toSafePath</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.trim()?.removeSuffix(<span class="hljs-string">"/"</span>) ?: <span class="hljs-string">""</span>
}

<span class="hljs-comment">// 日期字符串解析</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toDateOrNull</span><span class="hljs-params">()</span></span>: LocalDate? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>?.let { LocalDate.parse(it) }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-literal">null</span>
    }
}

<span class="hljs-comment">// 数字格式化</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Number?.<span class="hljs-title">formatWithDefault</span><span class="hljs-params">(
    pattern: <span class="hljs-type">String</span> = <span class="hljs-string">"#,##0.00"</span>,
    default: <span class="hljs-type">String</span> = <span class="hljs-string">"N/A"</span>
)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        DecimalFormat(pattern).format(<span class="hljs-keyword">this</span> ?: <span class="hljs-keyword">return</span> default)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        default
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> number: <span class="hljs-built_in">Double</span>? = <span class="hljs-number">1234.567</span>
    println(number.formatWithDefault())  <span class="hljs-comment">// 1,234.57</span>
    println(<span class="hljs-literal">null</span>.formatWithDefault())    <span class="hljs-comment">// N/A</span>
}
</code></pre>
<h2 data-id="heading-8">6. 最佳实践</h2>
<h3 data-id="heading-9">✅ 推荐的做法：</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 提供合理的默认值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">orEmpty</span><span class="hljs-params">()</span></span>: String = <span class="hljs-keyword">this</span> ?: <span class="hljs-string">""</span>

<span class="hljs-comment">// 2. 明确表达意图</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNotNullOrBlank</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.isNullOrBlank()
}

<span class="hljs-comment">// 3. 支持链式调用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">trimOrNull</span><span class="hljs-params">()</span></span>: String? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.trim()?.takeIf { it.isNotEmpty() }
}
</code></pre>
<h3 data-id="heading-10">❌ 避免的做法：</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免在扩展函数中抛出异常</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">unsafeLength</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>!!.length  <span class="hljs-comment">// 不要这样做！</span>
}

<span class="hljs-comment">// 避免混淆可空和不可空扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">unsafeForNullable</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>  <span class="hljs-comment">// 这个函数不能在 null 上调用</span>
}
</code></pre>
<h2 data-id="heading-11">7. 性能考虑</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 内联扩展函数减少开销</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T?.<span class="hljs-title">ifNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) block(<span class="hljs-keyword">this</span>)
}

<span class="hljs-comment">// 对于频繁调用的简单扩展，使用内联</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || isEmpty()
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>可空类型扩展函数的优点：</p>
<ol>
<li><strong>提升代码可读性</strong> - 将空检查逻辑封装在扩展中</li>
<li><strong>减少样板代码</strong> - 避免重复的 <code>if (x != null)</code> 检查</li>
<li><strong>增强表达力</strong> - 创建领域特定的安全操作</li>
<li><strong>支持链式调用</strong> - 在可能为空的链式操作中保持安全</li>
</ol>
<p>使用建议：</p>
<ul>
<li>为常用操作创建可空扩展</li>
<li>提供合理的默认返回值</li>
<li>保持函数纯函数特性（无副作用）</li>
<li>合理使用内联优化性能</li>
</ul>
<p>通过合理使用可空类型扩展函数，可以显著提高 Kotlin 代码的安全性和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day04-APIs 日期对象]]></title>    <link>https://juejin.cn/post/7587023071066341428</link>    <guid>https://juejin.cn/post/7587023071066341428</guid>    <pubDate>2025-12-24T07:02:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071066341428" data-draft-id="7586617459487653940" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day04-APIs  日期对象"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T07:02:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瘦的可以下饭了"/> <meta itemprop="url" content="https://juejin.cn/user/895474817042060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day04-APIs  日期对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474817042060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瘦的可以下饭了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:02:20.000Z" title="Wed Dec 24 2025 07:02:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.日期对象</h2>
<blockquote>
<h5 data-id="heading-1">1. 日期对象是用来表示时间的对象，可以得到当前系统的时间。</h5>
<h5 data-id="heading-2">2.使用new关键字实例化日期对象<code>const date = new Data()</code>,参数为空获取的是当前时间，还可以指定时间<code>const date = new Data('2025-12-31')</code></h5>
</blockquote>
<h3 data-id="heading-3">1.1 常见方法</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e01b7f3757154a0b91cb21414a60a83d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=pMx0I9VYW1HaCnxDveV6b1vDRDk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.2 获取当前时间（使用计时器）</h3>
<blockquote>
<p>也可以使用date的toLocalDate（）方法</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid pink;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">30px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> 
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDate</span>(<span class="hljs-params"/>) { 
      <span class="hljs-comment">// 1.创建日期对象</span>
      <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      <span class="hljs-comment">// 2.使用相关的方法</span>
      <span class="hljs-keyword">let</span> year = date.<span class="hljs-title function_">getFullYear</span>() <span class="hljs-comment">// 得到2025</span>
      <span class="hljs-keyword">let</span> month = date.<span class="hljs-title function_">getMonth</span>()+<span class="hljs-number">1</span> <span class="hljs-comment">// 月份从0开始，所以要加1</span>
      <span class="hljs-keyword">let</span> day = date.<span class="hljs-title function_">getDate</span>() <span class="hljs-comment">// 得到日期</span>
      <span class="hljs-keyword">let</span> hours = date.<span class="hljs-title function_">getHours</span>() <span class="hljs-comment">// 得到小时</span>
      hours = hours &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + hours : hours <span class="hljs-comment">// 如果小时数小于10，在前面添加0</span>
      <span class="hljs-keyword">let</span> minutes = date.<span class="hljs-title function_">getMinutes</span>() <span class="hljs-comment">// 得到分钟</span>
      minutes = minutes &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + minutes : minutes <span class="hljs-comment">// 如果分钟数小于10，在前面添加0</span>
      <span class="hljs-keyword">let</span> seconds = date.<span class="hljs-title function_">getSeconds</span>() <span class="hljs-comment">// 得到秒数</span>
      seconds = seconds &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + seconds : seconds <span class="hljs-comment">// 如果秒数小于10，在前面添加0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${year}</span>-<span class="hljs-subst">${month}</span>-<span class="hljs-subst">${day}</span> <span class="hljs-subst">${hours}</span>:<span class="hljs-subst">${minutes}</span>:<span class="hljs-subst">${seconds}</span>`</span>
    }
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'div'</span>)
    <span class="hljs-comment">// 设置计时器，每1000毫秒（1秒）调用一次getDate函数，更新div的内容</span>
    div.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">getDate</span>()
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
      div.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">getDate</span>()
    }, <span class="hljs-number">1000</span>)

  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">1.3 时间戳</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa3141be7c3a443e9abe3aecc5ac3a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=9P1m266Nk9aHIMmNVwJ3NYaVEcI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">1.4 获取时间戳的三种方式</h3>
<blockquote>
<p>1.第三种方法只能得到当前的时间戳，不能做倒计时</p>
<p>2.重点掌握第二种方法</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">  &lt;script&gt;
    <span class="hljs-comment">// 1.使用getTime方法获取时间戳</span>
    <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(date.<span class="hljs-title function_">getTime</span>() + <span class="hljs-string">'&lt;br&gt;'</span>) 
    <span class="hljs-comment">// 2.使用+new Date()获取时间戳</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(+<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() + <span class="hljs-string">'&lt;br&gt;'</span>)
    <span class="hljs-comment">// 3.使用Date.now()获取时间戳</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
  &lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">1.5 倒计时效果</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid pink;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">30px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>2026年倒计时:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 1.获取元素</span>
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span:nth-child(2)'</span>)
    <span class="hljs-comment">// 2.设置两个时间戳</span>
      <span class="hljs-keyword">const</span> now = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      <span class="hljs-keyword">const</span> newYear = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2026-01-01 00:00:00'</span>)
      <span class="hljs-keyword">let</span> remain = newYear - now
      <span class="hljs-comment">// 3. 将得到的毫秒值转换成倒计时格式</span>
      <span class="hljs-keyword">let</span> d = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> / <span class="hljs-number">24</span>)
      <span class="hljs-keyword">let</span> h = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> % <span class="hljs-number">24</span>)
      h = h &gt; <span class="hljs-number">10</span> ? h : <span class="hljs-string">'0'</span> + h
      <span class="hljs-keyword">let</span> m = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> % <span class="hljs-number">60</span>)
      m = m &gt; <span class="hljs-number">10</span> ? m : <span class="hljs-string">'0'</span> + m
      <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> % <span class="hljs-number">60</span>)
      s = s &gt; <span class="hljs-number">10</span> ? s : <span class="hljs-string">'0'</span> + s
      <span class="hljs-comment">// 4. 渲染到页面</span>
      span.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${d}</span>天:<span class="hljs-subst">${h}</span>时:<span class="hljs-subst">${m}</span>分:<span class="hljs-subst">${s}</span>秒`</span>
    <span class="hljs-comment">//设置计时器</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 2.设置两个时间戳</span>
      <span class="hljs-keyword">const</span> now = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      <span class="hljs-keyword">const</span> newYear = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2026-01-01 00:00:00'</span>)
      <span class="hljs-keyword">let</span> remain = newYear - now
      <span class="hljs-comment">// 3. 将得到的毫秒值转换成倒计时格式</span>
      <span class="hljs-keyword">let</span> d = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> / <span class="hljs-number">24</span>)
      <span class="hljs-keyword">let</span> h = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> % <span class="hljs-number">24</span>)
      h = h &gt; <span class="hljs-number">10</span> ? h : <span class="hljs-string">'0'</span> + h
      <span class="hljs-keyword">let</span> m = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> % <span class="hljs-number">60</span>)
      m = m &gt; <span class="hljs-number">10</span> ? m : <span class="hljs-string">'0'</span> + m
      <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> % <span class="hljs-number">60</span>)
      s = s &gt; <span class="hljs-number">10</span> ? s : <span class="hljs-string">'0'</span> + s
      <span class="hljs-comment">// 4. 渲染到页面</span>
      span.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${d}</span>天:<span class="hljs-subst">${h}</span>时:<span class="hljs-subst">${m}</span>分:<span class="hljs-subst">${s}</span>秒`</span>
    },<span class="hljs-number">1000</span>)
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">2.节点操作</h2>
<h3 data-id="heading-9">2.1 DOM节点</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f317b4c6e4149eb914887a586b27d78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=09D%2FLkHN7B9%2BmsvRJB7B4jCe40w%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">2.2 查找节点</h3>
<blockquote>
<p>1.利用关系可以很方便的查找每一个节点</p>
</blockquote>
<h4 data-id="heading-11">父节点查找</h4>
<ul>
<li>使用子元素的parentNode属性返回最近一级的父节点，找不到返回为null</li>
<li>这样子就可以不需要获取父节点了，只获取子节点就可以操作父节点的style、innerHtml等等</li>
<li>比如三个广告box，每个box都有关闭按钮，那么只需要设置事件：点击关闭按钮，将按钮的父级的display设置为none即可</li>
</ul>
<h4 data-id="heading-12">子节点查找</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c297bca30123471bb67525b20d030cde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=jBLoh9iBcyxYlu7WltiUA472ca0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">兄弟节点查找</h4>
<blockquote>
<ol>
<li>通过nextnextElementSibling和previousElementSibling属性可以获得相邻的兄弟节点</li>
</ol>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>我是第一个段落<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 子节点</span>
    <span class="hljs-comment">// 1.获取元素</span>
    <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
    <span class="hljs-comment">// 2.获取子节点</span>
    <span class="hljs-keyword">const</span> li = ul.<span class="hljs-property">children</span> <span class="hljs-comment">// 返回伪数组，包含所有子节点</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li);
    <span class="hljs-comment">// 3.遍历子节点</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; li.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li[i]);
    }

    <span class="hljs-comment">// 兄弟节点</span>
    <span class="hljs-keyword">const</span> li2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'li:nth-child(2)'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li2);
    <span class="hljs-comment">// 获取上一个元素兄弟</span>
    <span class="hljs-keyword">const</span> li1 = li2.<span class="hljs-property">previousElementSibling</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li1);
    <span class="hljs-comment">// 获取下一个元素兄弟</span>
    <span class="hljs-keyword">const</span> li3 = li2.<span class="hljs-property">nextElementSibling</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li3);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span> 
</code></pre>
<h3 data-id="heading-14">2.3 新增元素</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27b75cef3c1140bbbc3d2cab997be17a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=UVr7HePwUqtfeGNXzWGMJWIC9ig%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">创建节点</h4>
<ul>
<li>直接用document.creatElement('标签名')</li>
</ul>
<h4 data-id="heading-16">追加节点</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce0c0e14b30b4fa5a6587a31fe665ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=v9uKtcM5%2Fke8SvFeWDpc5LyWpSs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-17">代码演示</h4>
<pre><code class="hljs language-js" lang="js">  &lt;script&gt;
    <span class="hljs-comment">// 1.创建节点</span>
    <span class="hljs-keyword">const</span> li = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>)
    <span class="hljs-comment">// 2.追加节点</span>
    <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
    ul.<span class="hljs-title function_">appendChild</span>(li) <span class="hljs-comment">// appendChild是作为最后一个元素</span>
    <span class="hljs-comment">// 3.添加内容</span>
    li.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'我是新增的li'</span>
    <span class="hljs-comment">// 向前面插入元素</span>
    <span class="hljs-keyword">const</span> li2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>)
    ul.<span class="hljs-title function_">insertBefore</span>(li2, ul.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>])
    li2.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'我是新增的li2'</span>
  &lt;/script &gt;
</code></pre>
<h4 data-id="heading-18">克隆节点</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f121481cde074212ae771159169dcdda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=hId2bvdRTKrZMBwYdHQBz%2FejHYM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-comment">// 克隆一个第一个li并且追加到最后</span>
      <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
      <span class="hljs-keyword">const</span> li1 = ul.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>)
      ul.<span class="hljs-title function_">appendChild</span>(li1)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
&lt;/body&gt;  
</code></pre>
<h4 data-id="heading-19">删除节点</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7403a089d524442d9f0e69bd3be18c72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=Qo5CC1h7MN6dwAZ6XRiYNMJrrqs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-20">3.M端事件</h2>
<blockquote>
<p>M端就是moblie手机端</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52c17745c9fe41b991c82ba5bc08524a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=n0vVH4w1gsL3RzVTW3%2BkW8q%2BOpw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-21">4.插件</h2>
<h3 data-id="heading-22">4.1 swiper插件</h3>
<blockquote>
<p>可以用来实现手机端和电脑端大部分滑动功能</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.swiper.com.cn%2Fdemo%2Findex.html" target="_blank" title="https://www.swiper.com.cn/demo/index.html" ref="nofollow noopener noreferrer">Swiper演示 - Swiper中文网</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-21 快速掌握Kotlin-定义扩展文件]]></title>    <link>https://juejin.cn/post/7586994471739424811</link>    <guid>https://juejin.cn/post/7586994471739424811</guid>    <pubDate>2025-12-24T05:57:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586994471739424811" data-draft-id="7587060153028378665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-21 快速掌握Kotlin-定义扩展文件"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:57:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-21 快速掌握Kotlin-定义扩展文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:57:22.000Z" title="Wed Dec 24 2025 05:57:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 语言中定义扩展文件</h2>
<p>扩展文件是组织和管理扩展函数和扩展属性的最佳方式。通过将相关的扩展放在专门的文件中，可以提高代码的可维护性和可读性。</p>
<h3 data-id="heading-1">1. <strong>扩展文件的基本结构</strong></h3>
<h4 data-id="heading-2">创建扩展文件</h4>
<p>通常以 <code>类名 + Extensions.kt</code> 的形式命名：</p>
<pre><code class="hljs language-bash" lang="bash">项目结构：
├── src/main/kotlin
│   ├── com/example/
│   │   ├── StringExtensions.kt
│   │   ├── CollectionExtensions.kt
│   │   ├── DateExtensions.kt
│   │   └── ViewExtensions.kt
</code></pre>
<h4 data-id="heading-3">基本示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StringExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">removeWhitespace</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replace(<span class="hljs-string">"\\s"</span>.toRegex(), <span class="hljs-string">""</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> emailRegex = <span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(emailRegex.toRegex())
}

<span class="hljs-comment">// 扩展属性</span>
<span class="hljs-keyword">val</span> String.wordCount: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex()).count { it.isNotBlank() }

<span class="hljs-keyword">val</span> String.initials: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>)
        .filter { it.isNotEmpty() }
        .map { it.first().uppercaseChar() }
        .joinToString(<span class="hljs-string">""</span>)
</code></pre>
<h3 data-id="heading-4">2. <strong>按功能组织的扩展文件</strong></h3>
<h4 data-id="heading-5">按领域组织</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ValidationExtensions.kt - 验证相关的扩展</span>
<span class="hljs-keyword">package</span> com.example.extensions.validation

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(Regex(<span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>))
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidPhone</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(Regex(<span class="hljs-string">"^\\+?[0-9]{10,15}\$"</span>))
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidPassword</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> hasUpper = Regex(<span class="hljs-string">"[A-Z]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">val</span> hasLower = Regex(<span class="hljs-string">"[a-z]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">val</span> hasDigit = Regex(<span class="hljs-string">"[0-9]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">val</span> hasSpecial = Regex(<span class="hljs-string">"[!@#\$%^&amp;*()_+\\-=\\[\\]{};':\"\\\\|,.&lt;&gt;/?]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">return</span> length &gt;= <span class="hljs-number">8</span> &amp;&amp; hasUpper &amp;&amp; hasLower &amp;&amp; hasDigit &amp;&amp; hasSpecial
}

<span class="hljs-comment">// DataFormatExtensions.kt - 数据格式化相关的扩展</span>
<span class="hljs-keyword">package</span> com.example.extensions.format

<span class="hljs-keyword">import</span> java.text.SimpleDateFormat
<span class="hljs-keyword">import</span> java.util.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> Date.<span class="hljs-title">toFormattedString</span><span class="hljs-params">(pattern: <span class="hljs-type">String</span> = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> SimpleDateFormat(pattern).format(<span class="hljs-keyword">this</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Long</span>.<span class="hljs-title">toFormattedFileSize</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">val</span> units = listOf(<span class="hljs-string">"B"</span>, <span class="hljs-string">"KB"</span>, <span class="hljs-string">"MB"</span>, <span class="hljs-string">"GB"</span>, <span class="hljs-string">"TB"</span>)
    <span class="hljs-keyword">var</span> size = <span class="hljs-keyword">this</span>.toDouble()
    <span class="hljs-keyword">var</span> unitIndex = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">while</span> (size &gt;= <span class="hljs-number">1024</span> &amp;&amp; unitIndex &lt; units.size - <span class="hljs-number">1</span>) {
        size /= <span class="hljs-number">1024</span>
        unitIndex++
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">"%.2f %s"</span>.format(size, units[unitIndex])
}
</code></pre>
<h4 data-id="heading-6">按框架/平台组织</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// AndroidExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.android

<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> android.widget.TextView
<span class="hljs-keyword">import</span> androidx.core.content.ContextCompat

<span class="hljs-comment">// View 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">show</span><span class="hljs-params">()</span></span> {
    visibility = View.VISIBLE
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">hide</span><span class="hljs-params">()</span></span> {
    visibility = View.GONE
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">invisible</span><span class="hljs-params">()</span></span> {
    visibility = View.INVISIBLE
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">setVisible</span><span class="hljs-params">(isVisible: <span class="hljs-type">Boolean</span>)</span></span> {
    visibility = <span class="hljs-keyword">if</span> (isVisible) View.VISIBLE <span class="hljs-keyword">else</span> View.GONE
}

<span class="hljs-comment">// TextView 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> TextView.<span class="hljs-title">setTextColorRes</span><span class="hljs-params">(colorRes: <span class="hljs-type">Int</span>)</span></span> {
    setTextColor(ContextCompat.getColor(context, colorRes))
}

<span class="hljs-comment">// CoroutineExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.coroutines

<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">debounce</span><span class="hljs-params">(
    waitMillis: <span class="hljs-type">Long</span> = <span class="hljs-number">300</span>L,
    coroutineScope: <span class="hljs-type">CoroutineScope</span>,
    destinationFunction: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span>: (T) -&gt; <span class="hljs-built_in">Unit</span> {
    <span class="hljs-keyword">var</span> debounceJob: Job? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> { param: T -&gt;
        debounceJob?.cancel()
        debounceJob = coroutineScope.launch {
            delay(waitMillis)
            destinationFunction(param)
        }
    }
}
</code></pre>
<h3 data-id="heading-7">3. <strong>使用顶层函数和属性</strong></h3>
<h4 data-id="heading-8">顶层扩展</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StringExtensions.kt</span>
<span class="hljs-comment">// 顶层扩展，可以在任何地方导入使用</span>

<span class="hljs-comment">// 全局可用的 String 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">toTitleCase</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { word -&gt;
        word.replaceFirstChar { it.uppercase() }
    }
}

<span class="hljs-comment">// 带有接收者的顶层函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">withLogging</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>, block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    println(<span class="hljs-string">"[<span class="hljs-variable">$tag</span>] 开始执行"</span>)
    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    block()
    <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
    println(<span class="hljs-string">"[<span class="hljs-variable">$tag</span>] 执行完成，耗时 <span class="hljs-subst">${endTime - startTime}</span>ms"</span>)
}

<span class="hljs-comment">// 顶层属性</span>
<span class="hljs-keyword">val</span> String.Companion.EMPTY: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">""</span>

<span class="hljs-comment">// 使用伴生对象扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.Companion.<span class="hljs-title">random</span><span class="hljs-params">(length: <span class="hljs-type">Int</span> = <span class="hljs-number">10</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> charset = (<span class="hljs-string">'a'</span>..<span class="hljs-string">'z'</span>) + (<span class="hljs-string">'A'</span>..<span class="hljs-string">'Z'</span>) + (<span class="hljs-string">'0'</span>..<span class="hljs-string">'9'</span>)
    <span class="hljs-keyword">return</span> (<span class="hljs-number">1.</span>.length)
        .map { charset.random() }
        .joinToString(<span class="hljs-string">""</span>)
}
</code></pre>
<h3 data-id="heading-9">4. <strong>扩展文件的最佳实践</strong></h3>
<h4 data-id="heading-10">保持单一职责</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好的做法：混合不同类型的扩展</span>
<span class="hljs-comment">// MixedExtensions.kt ❌</span>
<span class="hljs-keyword">package</span> com.example

<span class="hljs-comment">// String 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">method1</span><span class="hljs-params">()</span></span> { ... }
<span class="hljs-comment">// Date 扩展  </span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Date.<span class="hljs-title">method2</span><span class="hljs-params">()</span></span> { ... }
<span class="hljs-comment">// List 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">method3</span><span class="hljs-params">()</span></span> { ... }

<span class="hljs-comment">// 好的做法：按类型分离 ✅</span>
<span class="hljs-comment">// StringExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.string

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">method1</span><span class="hljs-params">()</span></span> { ... }

<span class="hljs-comment">// DateExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.date

<span class="hljs-function"><span class="hljs-keyword">fun</span> Date.<span class="hljs-title">method2</span><span class="hljs-params">()</span></span> { ... }

<span class="hljs-comment">// ListExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.collection

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">method3</span><span class="hljs-params">()</span></span> { ... }
</code></pre>
<h4 data-id="heading-11">使用明确的包名</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 清晰的包结构</span>
<span class="hljs-keyword">package</span> com.example.project.extensions.string
<span class="hljs-comment">// 而不是</span>
<span class="hljs-keyword">package</span> com.example.project  <span class="hljs-comment">// 容易与主代码混淆</span>

<span class="hljs-comment">// 按功能分组的包</span>
<span class="hljs-keyword">package</span> com.example.extensions.validation
<span class="hljs-keyword">package</span> com.example.extensions.format
<span class="hljs-keyword">package</span> com.example.extensions.ui
<span class="hljs-keyword">package</span> com.example.extensions.network
</code></pre>
<h3 data-id="heading-12">5. <strong>使用 import 优化</strong></h3>
<h4 data-id="heading-13">使用 import 别名</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免命名冲突</span>
<span class="hljs-keyword">import</span> com.example.extensions.string.toTitleCase <span class="hljs-keyword">as</span> toCustomTitleCase
<span class="hljs-keyword">import</span> com.otherlibrary.extensions.string.toTitleCase <span class="hljs-keyword">as</span> toOtherTitleCase

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> text = <span class="hljs-string">"hello world"</span>
    println(text.toCustomTitleCase())  <span class="hljs-comment">// 使用自定义扩展</span>
    println(text.toOtherTitleCase())   <span class="hljs-comment">// 使用其他库的扩展</span>
}
</code></pre>
<h4 data-id="heading-14">批量导入</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建扩展文件的索引</span>
<span class="hljs-comment">// Extensions.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"Extensions"</span>)

<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 重新导出所有扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">customMethod</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"custom"</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Int</span>.<span class="hljs-title">double</span><span class="hljs-params">()</span></span> = <span class="hljs-keyword">this</span> * <span class="hljs-number">2</span>

<span class="hljs-comment">// 在其他文件中只需要导入这一个文件</span>
<span class="hljs-comment">// Main.kt</span>
<span class="hljs-keyword">import</span> com.example.extensions.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"test"</span>.customMethod())
    println(<span class="hljs-number">5.</span>double())
}
</code></pre>
<h3 data-id="heading-15">6. <strong>创建扩展库</strong></h3>
<h4 data-id="heading-16">构建可重用的扩展模块</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts</span>
kotlin {
    sourceSets {
        <span class="hljs-keyword">val</span> commonMain <span class="hljs-keyword">by</span> getting {
            dependencies {
                <span class="hljs-comment">// 依赖</span>
            }
        }
        <span class="hljs-keyword">val</span> androidMain <span class="hljs-keyword">by</span> getting
        <span class="hljs-keyword">val</span> iosMain <span class="hljs-keyword">by</span> getting
    }
}

<span class="hljs-comment">// 创建多平台扩展</span>
<span class="hljs-comment">// commonMain/kotlin/com/example/extensions/StringExtensions.kt</span>
<span class="hljs-keyword">expect</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">platformSpecificMethod</span><span class="hljs-params">()</span></span>: String

<span class="hljs-comment">// androidMain/kotlin/com/example/extensions/StringExtensions.kt</span>
<span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">platformSpecificMethod</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Android: <span class="hljs-variable">$this</span>"</span>
}

<span class="hljs-comment">// iosMain/kotlin/com/example/extensions/StringExtensions.kt</span>
<span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">platformSpecificMethod</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"iOS: <span class="hljs-variable">$this</span>"</span>
}
</code></pre>
<h3 data-id="heading-17">7. <strong>扩展文件中的常量</strong></h3>
<h4 data-id="heading-18">在扩展文件中定义常量</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Constants.kt 或直接放在扩展文件中</span>
<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 与扩展相关的常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> EMAIL_REGEX = <span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> PHONE_REGEX = <span class="hljs-string">"^\\+?[0-9]{10,15}\$"</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAX_FILE_SIZE_BYTES = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>  <span class="hljs-comment">// 10MB</span>

<span class="hljs-comment">// 使用常量的扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(Regex(EMAIL_REGEX))
}
</code></pre>
<h3 data-id="heading-19">8. <strong>扩展文件中的工具类</strong></h3>
<h4 data-id="heading-20">创建支持扩展的工具类</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ExtensionUtils.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-keyword">import</span> kotlin.reflect.KClass

<span class="hljs-comment">// 为扩展提供工具函数</span>
<span class="hljs-keyword">object</span> ExtensionUtils {
    
    <span class="hljs-comment">// 检查扩展是否存在</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasExtension</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>, extensionName: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            value::<span class="hljs-keyword">class</span>.members.any { it.name == extensionName }
            <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-literal">false</span>
        }
    }
    
    <span class="hljs-comment">// 动态调用扩展</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">callExtension</span><span class="hljs-params">(
        receiver: <span class="hljs-type">Any</span>,
        extensionClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;,
        methodName: <span class="hljs-type">String</span>,
        <span class="hljs-keyword">vararg</span> args: <span class="hljs-type">Any</span>
    )</span></span>: Any? {
        <span class="hljs-comment">// 实现动态调用逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
}
</code></pre>
<h3 data-id="heading-21">9. <strong>测试扩展文件</strong></h3>
<h4 data-id="heading-22">为扩展编写单元测试</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StringExtensionsTest.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.test

<span class="hljs-keyword">import</span> com.example.extensions.string.*
<span class="hljs-keyword">import</span> org.junit.Test
<span class="hljs-keyword">import</span> kotlin.test.assertEquals
<span class="hljs-keyword">import</span> kotlin.test.assertFalse
<span class="hljs-keyword">import</span> kotlin.test.assertTrue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StringExtensionsTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testIsEmail</span><span class="hljs-params">()</span></span> {
        assertTrue(<span class="hljs-string">"test@example.com"</span>.isEmail())
        assertFalse(<span class="hljs-string">"invalid-email"</span>.isEmail())
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testWordCount</span><span class="hljs-params">()</span></span> {
        assertEquals(<span class="hljs-number">3</span>, <span class="hljs-string">"Hello world test"</span>.wordCount)
        assertEquals(<span class="hljs-number">0</span>, <span class="hljs-string">""</span>.wordCount)
        assertEquals(<span class="hljs-number">1</span>, <span class="hljs-string">"Single"</span>.wordCount)
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testToTitleCase</span><span class="hljs-params">()</span></span> {
        assertEquals(<span class="hljs-string">"Hello World"</span>, <span class="hljs-string">"hello world"</span>.toTitleCase())
        assertEquals(<span class="hljs-string">"Test String"</span>, <span class="hljs-string">"test string"</span>.toTitleCase())
    }
}
</code></pre>
<h4 data-id="heading-23">测试配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts 配置测试</span>
dependencies {
    testImplementation(<span class="hljs-string">"org.jetbrains.kotlin:kotlin-test"</span>)
    testImplementation(<span class="hljs-string">"org.jetbrains.kotlin:kotlin-test-junit"</span>)
}

sourceSets {
    test {
        kotlin.srcDirs(<span class="hljs-string">"src/test/kotlin"</span>)
    }
}
</code></pre>
<h3 data-id="heading-24">10. <strong>文档化扩展文件</strong></h3>
<h4 data-id="heading-25">为扩展添加 KDoc 文档</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 字符串相关的扩展函数和属性
 * 
 * 这个文件包含了用于字符串处理的扩展函数，
 * 包括验证、格式化、转换等功能。
 * 
 * <span class="hljs-doctag">@author</span> Your Name
 * <span class="hljs-doctag">@since</span> 1.0.0
 */</span>
<span class="hljs-keyword">package</span> com.example.extensions.string

<span class="hljs-comment">/**
 * 检查字符串是否是有效的电子邮件地址
 * 
 * 这个方法使用正则表达式验证电子邮件格式，
 * 支持大多数常见的电子邮件格式。
 * 
 * <span class="hljs-doctag">@return</span> 如果是有效的电子邮件地址返回 true，否则返回 false
 * 
 * <span class="hljs-doctag">@sample</span> com.example.extensions.test.StringExtensionsTest.testIsEmail
 * 
 * <span class="hljs-doctag">@see</span> [RFC 5322](https://tools.ietf.org/html/rfc5322)
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> emailRegex = <span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(emailRegex.toRegex())
}

<span class="hljs-comment">/**
 * 将字符串转换为标题格式（每个单词首字母大写）
 * 
 * 示例：
 * ```
 * "hello world".toTitleCase()  // 返回 "Hello World"
 * "test-string".toTitleCase()  // 返回 "Test-string"
 * ```
 * 
 * <span class="hljs-doctag">@receiver</span> 要转换的字符串
 * <span class="hljs-doctag">@return</span> 标题格式的字符串
 * 
 * <span class="hljs-doctag">@throws</span> IllegalArgumentException 如果字符串为 null
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">toTitleCase</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { word -&gt;
        word.replaceFirstChar { it.uppercase() }
    }
}
</code></pre>
<h3 data-id="heading-26">11. <strong>实际项目结构示例</strong></h3>
<h4 data-id="heading-27">完整的项目结构</h4>
<pre><code class="hljs language-bash" lang="bash">my-project/
├── src/main/kotlin/
│   ├── com/example/
│   │   ├── extensions/
│   │   │   ├── string/
│   │   │   │   ├── StringValidators.kt
│   │   │   │   ├── StringFormatters.kt
│   │   │   │   └── StringConverters.kt
│   │   │   ├── collection/
│   │   │   │   ├── ListExtensions.kt
│   │   │   │   ├── MapExtensions.kt
│   │   │   │   └── SetExtensions.kt
│   │   │   ├── <span class="hljs-built_in">date</span>/
│   │   │   │   ├── DateExtensions.kt
│   │   │   │   └── DateTimeExtensions.kt
│   │   │   ├── ui/
│   │   │   │   ├── ViewExtensions.kt
│   │   │   │   └── FragmentExtensions.kt
│   │   │   └── Extensions.kt  // 聚合所有扩展
│   │   ├── models/
│   │   ├── network/
│   │   └── utils/
│   └── resources/
├── src/test/kotlin/
│   └── com/example/extensions/
│       ├── string/
│       ├── collection/
│       └── <span class="hljs-built_in">date</span>/
└── build.gradle.kts
</code></pre>
<h4 data-id="heading-28">聚合扩展文件</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Extensions.kt - 聚合文件</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"Extensions"</span>)

<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 重新导出所有扩展，方便一次性导入</span>
<span class="hljs-meta">@file:Suppress</span>(<span class="hljs-string">"unused"</span>)

<span class="hljs-comment">// 字符串扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidEmail</span><span class="hljs-params">()</span></span> = com.example.extensions.string.isEmail(<span class="hljs-keyword">this</span>)
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">toTitleCase</span><span class="hljs-params">()</span></span> = com.example.extensions.string.toTitleCase(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 集合扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">secondOrNull</span><span class="hljs-params">()</span></span> = com.example.extensions.collection.secondOrNull(<span class="hljs-keyword">this</span>)
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;K, V&gt;</span> Map<span class="hljs-type">&lt;K, V&gt;</span>.<span class="hljs-title">invert</span><span class="hljs-params">()</span></span> = com.example.extensions.collection.invert(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 日期扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> java.util.Date.<span class="hljs-title">toFormattedString</span><span class="hljs-params">()</span></span> = com.example.extensions.date.toFormattedString(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 使用示例：</span>
<span class="hljs-comment">// import com.example.extensions.*  // 一次性导入所有扩展</span>
</code></pre>
<h3 data-id="heading-29">12. <strong>性能优化建议</strong></h3>
<h4 data-id="heading-30">避免重复计算</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用缓存或延迟初始化</span>
<span class="hljs-keyword">val</span> String.words: List&lt;String&gt; <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex())
}

<span class="hljs-comment">// 对于频繁使用的扩展，考虑性能</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">transformInline</span><span class="hljs-params">(transform: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> transform(<span class="hljs-keyword">this</span>)
}

<span class="hljs-comment">// 避免创建不必要的对象</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">getCharacterFrequency</span><span class="hljs-params">()</span></span>: Map&lt;<span class="hljs-built_in">Char</span>, <span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">val</span> frequency = mutableMapOf&lt;<span class="hljs-built_in">Char</span>, <span class="hljs-built_in">Int</span>&gt;()
    <span class="hljs-keyword">for</span> (char <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>) {
        frequency[char] = frequency.getOrDefault(char, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
    }
    <span class="hljs-keyword">return</span> frequency
}
</code></pre>
<h3 data-id="heading-31">13. <strong>常见陷阱与解决方案</strong></h3>
<h4 data-id="heading-32">陷阱 1：扩展冲突</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 解决方案：使用明确的包名和导入别名</span>
<span class="hljs-keyword">package</span> com.example.project.extensions.string

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">customFormat</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"Custom: <span class="hljs-variable">$this</span>"</span>

<span class="hljs-comment">// 在其他文件中</span>
<span class="hljs-keyword">import</span> com.example.project.extensions.string.customFormat <span class="hljs-keyword">as</span> myCustomFormat
<span class="hljs-keyword">import</span> com.other.library.extensions.string.customFormat <span class="hljs-keyword">as</span> otherCustomFormat

<span class="hljs-keyword">val</span> result1 = <span class="hljs-string">"test"</span>.myCustomFormat()
<span class="hljs-keyword">val</span> result2 = <span class="hljs-string">"test"</span>.otherCustomFormat()
</code></pre>
<h4 data-id="heading-33">陷阱 2：过度扩展</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好的做法：为所有类添加大量扩展</span>
<span class="hljs-comment">// 好的做法：只在确实需要时创建扩展</span>

<span class="hljs-comment">// 评估标准：</span>
<span class="hljs-comment">// 1. 这个功能是否是类的核心职责？</span>
<span class="hljs-comment">// 2. 使用频率是否足够高？</span>
<span class="hljs-comment">// 3. 是否有更好的替代方案（如工具函数）？</span>
</code></pre>
<h4 data-id="heading-34">陷阱 3：忽略可空性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好的做法：忽略可空性</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toUppercase</span><span class="hljs-params">()</span></span>: String = <span class="hljs-keyword">this</span>?.uppercase() ?: <span class="hljs-string">""</span>

<span class="hljs-comment">// 好的做法：明确处理可空性</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">safeToUppercase</span><span class="hljs-params">(default: <span class="hljs-type">String</span> = <span class="hljs-string">""</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.uppercase() ?: default
}
</code></pre>
<h3 data-id="heading-35">总结</h3>
<p>创建扩展文件的最佳实践：</p>
<ol>
<li><strong>合理组织</strong>：按类型或功能组织扩展文件</li>
<li><strong>明确命名</strong>：使用清晰的包名和文件名</li>
<li><strong>保持简洁</strong>：每个扩展文件应该有明确的职责</li>
<li><strong>充分文档</strong>：为扩展提供完整的 KDoc 文档</li>
<li><strong>全面测试</strong>：为扩展编写单元测试</li>
<li><strong>性能考虑</strong>：注意扩展的性能影响</li>
<li><strong>避免冲突</strong>：使用明确的包结构和导入别名</li>
<li><strong>适度使用</strong>：不要过度使用扩展，只在确实需要时创建</li>
</ol>
<p>通过良好的扩展文件组织，可以创建可维护、可测试和可重用的代码库。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-18 快速掌握Kotlin-扩展属性]]></title>    <link>https://juejin.cn/post/7587060153028345897</link>    <guid>https://juejin.cn/post/7587060153028345897</guid>    <pubDate>2025-12-24T05:52:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587060153028345897" data-draft-id="7587046913691320326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-18 快速掌握Kotlin-扩展属性"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:52:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-18 快速掌握Kotlin-扩展属性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:52:13.000Z" title="Wed Dec 24 2025 05:52:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 语言中的扩展属性</h2>
<p>扩展属性允许你为现有的类添加新的属性，而无需继承该类或修改其源代码。扩展属性不存储状态，它们通过 getter 和 setter 提供访问。</p>
<h3 data-id="heading-1">1. <strong>基本语法</strong></h3>
<h4 data-id="heading-2">只读扩展属性（val）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 String 类添加只读扩展属性</span>
<span class="hljs-keyword">val</span> String.firstChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>]

<span class="hljs-keyword">val</span> String.lastChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[length - <span class="hljs-number">1</span>]

<span class="hljs-keyword">val</span> String.isPalindrome: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-keyword">this</span>.reversed()

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"Kotlin"</span>
println(text.firstChar)      <span class="hljs-comment">// K</span>
println(text.lastChar)       <span class="hljs-comment">// n</span>
println(<span class="hljs-string">"level"</span>.isPalindrome) <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-3">可写扩展属性（var）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 StringBuilder 添加可写扩展属性</span>
<span class="hljs-keyword">var</span> StringBuilder.firstChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">set</span>(value) {
        <span class="hljs-keyword">this</span>.setCharAt(<span class="hljs-number">0</span>, value)
    }

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> builder = StringBuilder(<span class="hljs-string">"Hello"</span>)
builder.firstChar = <span class="hljs-string">'J'</span>
println(builder)  <span class="hljs-comment">// Jello</span>
</code></pre>
<h3 data-id="heading-4">2. <strong>为常用类添加扩展属性</strong></h3>
<h4 data-id="heading-5">String 扩展属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> String.wordCount: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex()).size

<span class="hljs-keyword">val</span> String.camelCaseWords: List&lt;String&gt;
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"(?&lt;=[a-z])(?=[A-Z])|(?&lt;=[A-Z])(?=[A-Z][a-z])"</span>.toRegex())

<span class="hljs-keyword">val</span> String.isEmail: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.matches(Regex(<span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>))

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"helloWorldExample"</span>
println(text.camelCaseWords)  <span class="hljs-comment">// [hello, World, Example]</span>
</code></pre>
<h4 data-id="heading-6">List/Collection 扩展属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.midElement: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (isEmpty()) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>[size / <span class="hljs-number">2</span>]

<span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.second: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.getOrNull(<span class="hljs-number">1</span>)

<span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.penultimate: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.getOrNull(size - <span class="hljs-number">2</span>)

<span class="hljs-keyword">val</span> &lt;T&gt; Collection&lt;T&gt;.isNotEmpty: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = !isEmpty()

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
println(list.midElement)    <span class="hljs-comment">// 3</span>
println(list.penultimate)   <span class="hljs-comment">// 4</span>
</code></pre>
<h4 data-id="heading-7">Number 扩展属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.isEven: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>

<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.isOdd: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>

<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.isPrime: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span> % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">5</span>
        <span class="hljs-keyword">while</span> (i * i &lt;= <span class="hljs-keyword">this</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> % i == <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span> % (i + <span class="hljs-number">2</span>) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            i += <span class="hljs-number">6</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

<span class="hljs-keyword">val</span> <span class="hljs-built_in">Double</span>.formatted: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"%.2f"</span>.format(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 使用</span>
println(<span class="hljs-number">7.</span>isPrime)          <span class="hljs-comment">// true</span>
println(<span class="hljs-number">3.14159</span>.formatted)  <span class="hljs-comment">// 3.14</span>
</code></pre>
<h3 data-id="heading-8">3. <strong>可空类型的扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> String?.isNullOrEmptyOrBlank: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.isBlank()

<span class="hljs-keyword">val</span> String?.orDefault: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> ?: <span class="hljs-string">"默认值"</span>

<span class="hljs-keyword">val</span> &lt;T&gt; T?.isNotNull: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>

<span class="hljs-keyword">val</span> &lt;T&gt; T?.isNull: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span>

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> nullableString: String? = <span class="hljs-literal">null</span>
println(nullableString.isNullOrEmptyOrBlank)  <span class="hljs-comment">// true</span>
println(nullableString.orDefault)             <span class="hljs-comment">// 默认值</span>
</code></pre>
<h3 data-id="heading-9">4. <strong>泛型扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基本泛型扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.randomOrNull: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (isEmpty()) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.random()

<span class="hljs-keyword">val</span> &lt;T&gt; MutableList&lt;T&gt;.firstAndLast: Pair&lt;T, T&gt;?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">2</span>) Pair(first(), last()) <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// 带类型约束的泛型扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T : Comparable&lt;T&gt;&gt; List&lt;T&gt;.isSorted: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.sorted() == <span class="hljs-keyword">this</span>

<span class="hljs-keyword">val</span> &lt;T : Number&gt; T.squared: <span class="hljs-built_in">Double</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.toDouble() * <span class="hljs-keyword">this</span>.toDouble()

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
println(numbers.randomOrNull)  <span class="hljs-comment">// 随机元素</span>
println(<span class="hljs-number">5.</span>squared)             <span class="hljs-comment">// 25.0</span>
</code></pre>
<h3 data-id="heading-10">5. <strong>为自定义类添加扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 为 Person 类添加扩展属性</span>
<span class="hljs-keyword">val</span> Person.isAdult: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = age &gt;= <span class="hljs-number">18</span>

<span class="hljs-keyword">val</span> Person.initials: String
    <span class="hljs-keyword">get</span>() = name.split(<span class="hljs-string">" "</span>).map { it.first() }.joinToString(<span class="hljs-string">""</span>)

<span class="hljs-keyword">val</span> Person.nameLength: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = name.length

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">25</span>)
println(person.isAdult)   <span class="hljs-comment">// true</span>
println(person.initials)  <span class="hljs-comment">// JD</span>
</code></pre>
<h3 data-id="heading-11">6. <strong>扩展属性与委托属性结合</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.properties.ReadOnlyProperty
<span class="hljs-keyword">import</span> kotlin.reflect.KProperty

<span class="hljs-comment">// 创建扩展属性的委托</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UpperCaseDelegate</span> : <span class="hljs-type">ReadOnlyProperty</span>&lt;<span class="hljs-type">Any?, String</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(thisRef: <span class="hljs-type">Any</span>?, property: <span class="hljs-type">KProperty</span>&lt;*&gt;)</span></span>: String {
        <span class="hljs-keyword">return</span> property.name.uppercase()
    }
}

<span class="hljs-comment">// 使用委托创建扩展属性</span>
<span class="hljs-keyword">val</span> Any?.upperCaseName: String <span class="hljs-keyword">by</span> UpperCaseDelegate()

<span class="hljs-comment">// 复杂的委托扩展属性</span>
<span class="hljs-keyword">val</span> String.characterFrequency: Map&lt;<span class="hljs-built_in">Char</span>, <span class="hljs-built_in">Int</span>&gt; <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.groupingBy { it }.eachCount()
}

<span class="hljs-comment">// 使用</span>
println(<span class="hljs-string">"test"</span>.upperCaseName)  <span class="hljs-comment">// UPPERCASENAME（属性名被转换为大写）</span>
<span class="hljs-keyword">val</span> freq = <span class="hljs-string">"hello"</span>.characterFrequency
println(freq)  <span class="hljs-comment">// {h=1, e=1, l=2, o=1}</span>
</code></pre>
<h3 data-id="heading-12">7. <strong>实际项目中的应用</strong></h3>
<h4 data-id="heading-13">Android 开发</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> android.widget.TextView

<span class="hljs-comment">// View 扩展属性</span>
<span class="hljs-keyword">val</span> View.isVisible: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = visibility == View.VISIBLE

<span class="hljs-keyword">val</span> View.isGone: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = visibility == View.GONE

<span class="hljs-keyword">var</span> TextView.textOrEmpty: String
    <span class="hljs-keyword">get</span>() = text?.toString() ?: <span class="hljs-string">""</span>
    <span class="hljs-keyword">set</span>(value) {
        text = value
    }

<span class="hljs-comment">// SharedPreferences 扩展属性</span>
<span class="hljs-keyword">val</span> android.content.SharedPreferences.hasUserLoggedIn: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = getBoolean(<span class="hljs-string">"user_logged_in"</span>, <span class="hljs-literal">false</span>)

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">if</span> (button.isVisible) {
    button.isVisible = <span class="hljs-literal">false</span>
}

textView.textOrEmpty = <span class="hljs-string">"New Text"</span>
</code></pre>
<h4 data-id="heading-14">日期时间处理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.time.LocalDate
<span class="hljs-keyword">import</span> java.time.LocalDateTime
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter

<span class="hljs-keyword">val</span> LocalDate.isWeekend: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = dayOfWeek.value <span class="hljs-keyword">in</span> <span class="hljs-number">6.</span><span class="hljs-number">.7</span>

<span class="hljs-keyword">val</span> LocalDate.isWeekday: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = !isWeekend

<span class="hljs-keyword">val</span> LocalDate.isLeapYear: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> &amp;&amp; (year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span> || year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>)

<span class="hljs-keyword">val</span> LocalDateTime.formattedDate: String
    <span class="hljs-keyword">get</span>() = format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> today = LocalDate.now()
println(today.isWeekend)
println(today.formattedDate)
</code></pre>
<h4 data-id="heading-15">响应式编程</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.Flow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.StateFlow

<span class="hljs-comment">// Flow 扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T&gt; Flow&lt;T&gt;.latestValue: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 实际实现需要特殊处理，这里只是示例</span>

<span class="hljs-keyword">val</span> &lt;T&gt; StateFlow&lt;T&gt;.valueOrNull: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">try</span> {
        value
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-literal">null</span>
    }

<span class="hljs-comment">// 用于 Retrofit 响应的扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T&gt; retrofit2.Response&lt;T&gt;.isSuccessfulAndNotNull: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = isSuccessful &amp;&amp; body() != <span class="hljs-literal">null</span>

<span class="hljs-keyword">val</span> &lt;T&gt; retrofit2.Response&lt;T&gt;.errorMessage: String?
    <span class="hljs-keyword">get</span>() = errorBody()?.string()
</code></pre>
<h3 data-id="heading-16">8. <strong>操作符重载扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.collections.component1
<span class="hljs-keyword">import</span> kotlin.collections.component2

<span class="hljs-comment">// 为 Pair 添加扩展属性，支持解构声明</span>
<span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> Pair<span class="hljs-type">&lt;Int, Int&gt;</span>.<span class="hljs-title">component3</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = first + second

<span class="hljs-keyword">val</span> Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;.sum: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = first + second

<span class="hljs-keyword">val</span> Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;.product: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = first * second

<span class="hljs-comment">// 使用解构声明</span>
<span class="hljs-keyword">val</span> (x, y, sum) = Pair(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
println(<span class="hljs-string">"<span class="hljs-variable">$x</span> + <span class="hljs-variable">$y</span> = <span class="hljs-variable">$sum</span>"</span>)  <span class="hljs-comment">// 3 + 4 = 7</span>

<span class="hljs-keyword">val</span> pair = Pair(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
println(pair.product)  <span class="hljs-comment">// 30</span>
</code></pre>
<h3 data-id="heading-17">9. <strong>扩展属性与扩展函数结合</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 扩展属性作为缓存</span>
<span class="hljs-keyword">val</span> String.cachedWords: List&lt;String&gt; <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex())
}

<span class="hljs-comment">// 扩展属性调用扩展函数</span>
<span class="hljs-keyword">val</span> String.reversedWords: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { it.reversed() }

<span class="hljs-comment">// 计算密集型属性的缓存</span>
<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.factorial: <span class="hljs-built_in">Long</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">var</span> result = <span class="hljs-number">1L</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">2.</span>.<span class="hljs-keyword">this</span>) {
            result *= i
        }
        <span class="hljs-keyword">return</span> result
    }

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"hello world"</span>
println(text.cachedWords)    <span class="hljs-comment">// [hello, world] (延迟计算)</span>
println(text.reversedWords)  <span class="hljs-comment">// olleh dlrow</span>
println(<span class="hljs-number">5.</span>factorial)         <span class="hljs-comment">// 120</span>
</code></pre>
<h3 data-id="heading-18">10. <strong>DSL 构建中的扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// HTML DSL 构建器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HtmlBuilder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> elements = mutableListOf&lt;String&gt;()
    
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">unaryPlus</span><span class="hljs-params">()</span></span> {
        elements.add(<span class="hljs-keyword">this</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String = elements.joinToString(<span class="hljs-string">""</span>)
}

<span class="hljs-comment">// 扩展属性用于 DSL</span>
<span class="hljs-keyword">val</span> HtmlBuilder.body: HtmlBuilder
    <span class="hljs-keyword">get</span>() {
        +<span class="hljs-string">"&lt;body&gt;"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

<span class="hljs-keyword">val</span> HtmlBuilder.endBody: HtmlBuilder
    <span class="hljs-keyword">get</span>() {
        +<span class="hljs-string">"&lt;/body&gt;"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

<span class="hljs-keyword">val</span> HtmlBuilder.h1: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"&lt;h1&gt;"</span>

<span class="hljs-keyword">val</span> HtmlBuilder.endH1: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"&lt;/h1&gt;"</span>

<span class="hljs-comment">// 使用 DSL</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">html</span><span class="hljs-params">(<span class="hljs-keyword">init</span>: <span class="hljs-type">HtmlBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> builder = HtmlBuilder()
    builder.<span class="hljs-keyword">init</span>()
    <span class="hljs-keyword">return</span> builder.toString()
}

<span class="hljs-keyword">val</span> result = html {
    +<span class="hljs-string">"&lt;html&gt;"</span>
    body {
        +h1
        +<span class="hljs-string">"标题"</span>
        +endH1
    }
    endBody
    +<span class="hljs-string">"&lt;/html&gt;"</span>
}
</code></pre>
<h3 data-id="heading-19">11. <strong>性能考虑与最佳实践</strong></h3>
<h4 data-id="heading-20">性能考虑</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免在频繁调用的扩展属性中进行复杂计算</span>
<span class="hljs-comment">// 不好</span>
<span class="hljs-keyword">val</span> String.complexCalculation: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-comment">// 复杂计算</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map { it.code }.sum()
    }

<span class="hljs-comment">// 好：使用缓存或延迟计算</span>
<span class="hljs-keyword">val</span> String.cachedComplexCalculation: <span class="hljs-built_in">Int</span> <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.map { it.code }.sum()
}

<span class="hljs-comment">// 对于简单的计算，直接定义扩展属性</span>
<span class="hljs-keyword">val</span> String.lengthSquared: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = length * length
</code></pre>
<h4 data-id="heading-21">最佳实践</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 保持扩展属性简单</span>
<span class="hljs-comment">// 不好</span>
<span class="hljs-keyword">val</span> String.encodedAndCompressed: ByteArray
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-comment">// 复杂的编码和压缩逻辑</span>
        <span class="hljs-keyword">return</span> byteArrayOf()
    }

<span class="hljs-comment">// 好：拆分为多个简单属性或函数</span>
<span class="hljs-keyword">val</span> String.base64Encoded: String
    <span class="hljs-keyword">get</span>() = java.util.Base64.getEncoder().encodeToString(toByteArray())

<span class="hljs-comment">// 2. 提供有意义的名称</span>
<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.days: TimeSpan <span class="hljs-keyword">get</span>() = TimeSpan(<span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.hours: TimeSpan <span class="hljs-keyword">get</span>() = TimeSpan(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

<span class="hljs-comment">// 3. 避免与现有属性冲突</span>
<span class="hljs-comment">// 检查是否已有同名属性</span>
<span class="hljs-comment">// println(String::class.members.map { it.name })</span>
</code></pre>
<h3 data-id="heading-22">12. <strong>扩展属性的限制</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 不能有幕后字段</span>
<span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">var</span> String.cachedValue: String? = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 编译错误</span>

<span class="hljs-comment">// 2. 不能直接初始化</span>
<span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">val</span> String.defaultValue: String = <span class="hljs-string">"default"</span>  <span class="hljs-comment">// 编译错误</span>

<span class="hljs-comment">// 3. 扩展属性不能访问私有成员</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateClass</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> secret = <span class="hljs-string">"hidden"</span>
}

<span class="hljs-comment">// 错误：无法访问私有成员</span>
<span class="hljs-comment">// val PrivateClass.revealedSecret: String</span>
<span class="hljs-comment">//     get() = this.secret</span>

<span class="hljs-comment">// 4. 扩展属性是静态解析的</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-type">Animal</span>()

<span class="hljs-keyword">val</span> Animal.type: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"Animal"</span>
<span class="hljs-keyword">val</span> Dog.type: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"Dog"</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> animal: Animal = Dog()
    println(animal.type)  <span class="hljs-comment">// 输出: Animal（不是 Dog）</span>
}
</code></pre>
<h3 data-id="heading-23">13. <strong>工具函数与扩展属性的比较</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 工具函数方式</span>
<span class="hljs-keyword">object</span> StringUtils {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getFirstChar</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Char</span> = str[<span class="hljs-number">0</span>]
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isPalindrome</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> = str == str.reversed()
}

<span class="hljs-comment">// 扩展属性方式</span>
<span class="hljs-keyword">val</span> String.firstChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>]
<span class="hljs-keyword">val</span> String.isPalindrome: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-keyword">this</span>.reversed()

<span class="hljs-comment">// 使用对比</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"level"</span>

<span class="hljs-comment">// 工具函数方式</span>
println(StringUtils.getFirstChar(text))
println(StringUtils.isPalindrome(text))

<span class="hljs-comment">// 扩展属性方式（更自然）</span>
println(text.firstChar)
println(text.isPalindrome)
</code></pre>
<h3 data-id="heading-24">总结</h3>
<p>扩展属性是 Kotlin 中非常有用的特性，它允许你：</p>
<ol>
<li><strong>扩展现有类</strong>：为任何类添加新属性</li>
<li><strong>创建流畅 API</strong>：使代码更自然、易读</li>
<li><strong>提供计算属性</strong>：创建基于现有数据的派生属性</li>
<li><strong>支持 DSL</strong>：构建领域特定语言</li>
</ol>
<p>注意事项：</p>
<ul>
<li>扩展属性不存储状态，只能通过 getter/setter 计算</li>
<li>扩展属性不能有幕后字段</li>
<li>扩展属性是静态解析的，不支持多态</li>
<li>需要合理命名，避免与现有成员冲突</li>
</ul>
<p>合理使用扩展属性可以显著提高代码的可读性和可维护性，尤其是在构建 DSL 或为常用类添加便捷属性时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7个Rust写法让代码干净卫生又高效]]></title>    <link>https://juejin.cn/post/7587020682010591259</link>    <guid>https://juejin.cn/post/7587020682010591259</guid>    <pubDate>2025-12-24T07:17:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587020682010591259" data-draft-id="7587062584164352038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7个Rust写法让代码干净卫生又高效"/> <meta itemprop="keywords" content="后端,Rust"/> <meta itemprop="datePublished" content="2025-12-24T07:17:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ServBay"/> <meta itemprop="url" content="https://juejin.cn/user/3828929445244761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7个Rust写法让代码干净卫生又高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3828929445244761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ServBay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:17:44.000Z" title="Wed Dec 24 2025 07:17:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Rust以严苛的编译器著称，很多刚接触这门语言的开发者会觉得在借用检查器的凝视下写代码束手束脚。但经验丰富的开发者知道，在Rust严格的规则之下，隐藏着许多合法作弊的技巧。这些写法初看有些反直觉，但实际上它们不仅符合Rust的设计哲学，还能显著提升代码的性能和可读性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a62a647b73e43178d5c23e0f56247f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165464&amp;x-signature=a3UV6kN4T6wTSxpfd94o7dc7Gpk%3D" alt="" loading="lazy"/></p>
<p>以下是几个让代码既干净又高效的Rust技巧。</p>
<h3 data-id="heading-0">显式丢弃 Result 或 Option：告诉编译器“我知道我在做什么”</h3>
<p>Rust的 <code>Result</code> 和 <code>Option</code> 类型强制开发者处理潜在的错误或空值。但在某些场景下，结果确实不重要。比如发送一个非关键的统计数据，或者清理临时文件，即使失败了也无伤大雅。直接忽略会导致编译器发出 <code>unused_result</code> 警告，干扰视线。</p>
<p>所以与其让编译器跟个教导主任似的啰啰嗦嗦，不如直接告诉它：我知道了，但我就是不管。</p>
<h4 data-id="heading-1"><strong>技巧</strong>：使用 <code>let _ = ...</code> 绑定，或者使用 <code>drop(...)</code>。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fs;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 场景：尝试删除一个可能存在的临时缓存文件</span>
    <span class="hljs-comment">// 如果文件不存在导致失败，其实无所谓，只想确保它不在那儿</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = fs::<span class="hljs-title function_ invoke__">remove_file</span>(<span class="hljs-string">"/tmp/temp_cache.dat"</span>); 
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"尝试了清理缓存，结果并不重要。"</span>);

    <span class="hljs-comment">// 场景：持有一个 Option 数据，想立即释放它的资源</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config_data</span>: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Heavy Config Data"</span>));
    
    <span class="hljs-comment">// 显式调用 drop，数据立即离场，不再占用作用域后续的资源</span>
    <span class="hljs-title function_ invoke__">drop</span>(config_data); 
    
    <span class="hljs-comment">// 此时再访问 config_data 会导致编译错误，因为所有权已移交并销毁</span>
}
</code></pre>
<p>这种写法告诉编辑器，道理我都懂，但我不听你的，我要按照自己的来。</p>
<h3 data-id="heading-2">用 <code>if let</code> 和 <code>while let</code> 简化控制流</h3>
<p>Rust的 <code>match</code> 表达式功能全面，但在只关心一种匹配情况时，写一个包含 <code>_ =&gt; {}</code> 的完整 <code>match</code> 显得非常啰嗦，增加了无谓的缩进层级。</p>
<h4 data-id="heading-3"><strong>技巧</strong>：使用 <code>if let</code> 处理单次匹配，<code>while let</code> 处理迭代器或流的循环匹配。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 场景：只处理配置存在的情况</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">app_mode</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-type">str</span>&gt; = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-string">"Production"</span>);

    <span class="hljs-comment">// 这种写法比 match 更加扁平、直观</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(mode) = app_mode {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"当前运行模式: {}"</span>, mode);
    }

    <span class="hljs-comment">// 场景：从消费队列中不断取出数据直到为空</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tasks</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-string">"Task A"</span>, <span class="hljs-string">"Task B"</span>, <span class="hljs-string">"Task C"</span>].<span class="hljs-title function_ invoke__">into_iter</span>();

    <span class="hljs-comment">// 只要 next() 返回 Some，循环就继续</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(task) = tasks.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"正在处理: {}"</span>, task);
    }
}
</code></pre>
<p>这不仅是语法糖，更是减少视觉干扰、突出业务逻辑的有效手段。</p>
<h3 data-id="heading-4">VecDeque：被低估的双端队列</h3>
<p>很多开发者习惯用 <code>Vec</code> 处理所有列表数据。但在需要频繁从头部删除数据（FIFO队列）的场景下，<code>Vec</code> 的性能其实不是很好。因为 <code>Vec::remove(0)</code> 会导致后续所有元素向前移动，时间复杂度是 O(n)。</p>
<h4 data-id="heading-5"><strong>技巧</strong>：遇到队列需求，直接使用 <code>VecDeque</code>。它基于环形缓冲区实现，头部和尾部的操作都是 O(1)。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::collections::VecDeque;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 初始化一个双端队列</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffer</span> = VecDeque::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">300</span>]);

    <span class="hljs-comment">// 从头部弹出元素，对于大量数据，这比 Vec 快几个数量级</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(val) = buffer.<span class="hljs-title function_ invoke__">pop_front</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"处理队首数据: {}"</span>, val);
    }

    <span class="hljs-comment">// 依然可以在尾部添加</span>
    buffer.<span class="hljs-title function_ invoke__">push_back</span>(<span class="hljs-number">400</span>);
}
</code></pre>
<p>如果在写任务调度器或者消息缓冲，把 <code>Vec</code> 换成 <code>VecDeque</code>，不需要改动逻辑就能获得显著的性能提升。</p>
<h3 data-id="heading-6">善用 <code>const</code> 和 <code>static</code></h3>
<p>在Rust中定义全局值，新手容易混淆 <code>const</code> 和 <code>static</code>。</p>
<ul>
<li><strong>const</strong>：编译时常量。编译器会在用到它的地方直接将其内联（复制）。它不占用运行时的固定内存地址。</li>
<li><strong>static</strong>：静态变量。它在整个程序生命周期内拥有固定的内存地址。</li>
</ul>
<h4 data-id="heading-7"><strong>技巧</strong>：数值计算、配置参数用 <code>const</code>；需要全局唯一地址或配合原子操作（Atomic）做全局状态管理时用 <code>static</code>。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::sync::atomic::{AtomicUsize, Ordering};

<span class="hljs-comment">// 编译时替换，哪里用到 MAX_Connections，哪里就变成 100</span>
<span class="hljs-keyword">const</span> MAX_CONNECTIONS: <span class="hljs-type">u32</span> = <span class="hljs-number">100</span>; 

<span class="hljs-comment">// 全局唯一的计数器，拥有固定内存地址</span>
<span class="hljs-keyword">static</span> ACTIVE_USERS: AtomicUsize = AtomicUsize::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_connection</span>() {
    <span class="hljs-comment">// 增加全局计数</span>
    ACTIVE_USERS.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">1</span>, Ordering::SeqCst);
    
    <span class="hljs-comment">// 使用常量做逻辑判断</span>
    <span class="hljs-keyword">if</span> ACTIVE_USERS.<span class="hljs-title function_ invoke__">load</span>(Ordering::SeqCst) <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span> &lt;= MAX_CONNECTIONS {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"允许连接"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">PhantomData：类型系统的幽灵</h3>
<p><code>PhantomData</code> 是一个零大小类型（Zero-sized Type），它不占用任何运行时内存。它的存在纯粹是为了欺骗编译器，让编译器认为结构体拥有某种数据的所有权或生命周期关系。</p>
<h4 data-id="heading-9"><strong>技巧</strong>：当定义一个泛型结构体，但该泛型参数实际上并不作为字段存储时（例如用于状态标记或FFI边界），使用 <code>PhantomData</code> 避免编译错误。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-comment">// 定义两种状态类型</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Connected</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Disconnected</span>;

<span class="hljs-comment">// 这是一个带有状态标记的客户端结构体</span>
<span class="hljs-comment">// T 只是用来在编译期区分状态，不占用运行时空间</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Client</span>&lt;T&gt; {
    id: <span class="hljs-type">u32</span>,
    _state: PhantomData&lt;T&gt;, 
}

<span class="hljs-keyword">impl</span>&lt;T&gt; Client&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Client {
            id,
            _state: PhantomData,
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c1</span>: Client&lt;Connected&gt; = Client::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c2</span>: Client&lt;Disconnected&gt; = Client::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">2</span>);

    <span class="hljs-comment">// 编译器会认为 c1 和 c2 是完全不同的类型</span>
    <span class="hljs-comment">// 防止了错误地将断开连接的客户端传入需要连接状态的函数中</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"客户端ID: {}"</span>, c1.id);
}
</code></pre>
<p>这种幽灵数据是实现零成本抽象（Zero-cost Abstractions）的核心工具之一。</p>
<h3 data-id="heading-10">const Generics：将值参数化</h3>
<p>传统泛型是针对类型的（如 <code>Vec&lt;T&gt;</code>）。而 const generics 允许将值作为泛型参数。这使得可以在编译阶段就确定数组的大小或其他常量属性，从而进行极致的优化。</p>
<h4 data-id="heading-11"><strong>技巧</strong>：当数据结构的大小在编译期固定时，使用 const generics 替代动态的 <code>Vec</code>，可以减少堆内存分配。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个固定大小的矩阵结构体</span>
<span class="hljs-comment">// ROWS 和 COLS 是常量泛型参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Matrix</span>&lt;T, <span class="hljs-keyword">const</span> ROWS: <span class="hljs-type">usize</span>, <span class="hljs-keyword">const</span> COLS: <span class="hljs-type">usize</span>&gt; {
    data: [[T; COLS]; ROWS],
}

<span class="hljs-keyword">impl</span>&lt;T: <span class="hljs-built_in">Default</span> + <span class="hljs-built_in">Copy</span>, <span class="hljs-keyword">const</span> ROWS: <span class="hljs-type">usize</span>, <span class="hljs-keyword">const</span> COLS: <span class="hljs-type">usize</span>&gt; Matrix&lt;T, ROWS, COLS&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Matrix {
            data: [[T::<span class="hljs-title function_ invoke__">default</span>(); COLS]; ROWS],
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">size_info</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"矩阵大小: {}x{}"</span>, ROWS, COLS);
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建一个 4x4 的矩阵</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mat</span> = Matrix::&lt;<span class="hljs-type">f64</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>&gt;::<span class="hljs-title function_ invoke__">new</span>();
    mat.<span class="hljs-title function_ invoke__">size_info</span>();

    <span class="hljs-comment">// 如果尝试将不同维度的 Matrix 赋值，编译器会直接报错</span>
    <span class="hljs-comment">// 保证了严格的类型和内存布局安全</span>
}
</code></pre>
<h3 data-id="heading-12">impl Trait 返回值：隐藏实现细节</h3>
<p>编写库或API时，如果返回类型非常复杂（例如一长串的迭代器链 <code>Map&lt;Filter&lt;...&gt;&gt;</code>），不仅写起来痛苦，维护也是噩梦。一旦内部实现变动，函数签名就得改。</p>
<h4 data-id="heading-13"><strong>技巧</strong>：使用 <code>-&gt; impl Trait</code>。这就是告诉调用者：“返回一个实现了这个特质的东西，具体类型不需要知道。”</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不需要写出具体的返回类型，比如 std::iter::Map&lt;std::ops::Range&lt;...&gt;&gt;</span>
<span class="hljs-comment">// 只要它能迭代出 u32 即可</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_odd_numbers</span>(limit: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span>&lt;Item = <span class="hljs-type">u32</span>&gt; {
    (<span class="hljs-number">0</span>..limit).<span class="hljs-title function_ invoke__">filter</span>(|x| x % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">odds</span> = <span class="hljs-title function_ invoke__">get_odd_numbers</span>(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 调用者只把它当迭代器用，完全解耦了具体实现</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">num</span> <span class="hljs-keyword">in</span> odds {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"奇数: {}"</span>, num);
    }
}
</code></pre>
<p>这种不透明的返回类型极大地提高了API的稳定性和灵活性。</p>
<h3 data-id="heading-14">Rust神器推荐</h3>
<p>掌握了这些代码层面的技巧后，高效的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">开发环境</a>同样不可或缺。很多Rust开发者在配置环境、安装数据库依赖上浪费了大量时间。</p>
<p>那就合适用 ServBay <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Frust" target="_blank" title="https://www.servbay.com/features/rust" ref="nofollow noopener noreferrer">一键安装Rust环境</a>，省去了配置 PATH 和依赖的繁琐。同时，它还集成了 SQL 和 NoSQL 数据库（如 PostgreSQL, Redis 等）以及反向代理服务，甚至支持一键部署本地AI。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc2947d3f876447390f557be03e25034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165464&amp;x-signature=fUZi5TLL9U0YFX4338ccSjO4lhA%3D" alt="" loading="lazy"/></p>
<p>对于需要快速验证全栈逻辑，或者希望利用本地大模型辅助编程的开发者来说，ServBay 提供了一个开箱即用的解决方案，开发者能将精力完全集中在 Rust 代码的逻辑与优化上。</p>
<h3 data-id="heading-15">结语</h3>
<p>Rust的这些技巧，本质上是在安全性和控制力之间寻找最佳平衡点。当你熟练运用 <code>PhantomData</code> 处理类型约束，用 <code>VecDeque</code> 优化队列性能时，你会发现Rust不愧是最强的开发语言之一呀。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-23 快速掌握Kotlin-apply函数详解]]></title>    <link>https://juejin.cn/post/7587008326480969770</link>    <guid>https://juejin.cn/post/7587008326480969770</guid>    <pubDate>2025-12-24T06:00:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587008326480969770" data-draft-id="7587046913691435014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-23 快速掌握Kotlin-apply函数详解"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T06:00:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-23 快速掌握Kotlin-apply函数详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:00:14.000Z" title="Wed Dec 24 2025 06:00:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin <code>apply</code> 函数详解</h2>
<p><code>apply</code> 是 Kotlin 标准库中的一个作用域函数（scope function），用于在对象上执行一个代码块，并返回该对象本身。</p>
<h3 data-id="heading-1">基本概念</h3>
<h4 data-id="heading-2">函数签名</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T
</code></pre>
<h4 data-id="heading-3">核心特性</h4>
<ol>
<li><strong>接收者对象</strong>：在 lambda 内部，<code>this</code> 指向调用 <code>apply</code> 的对象</li>
<li><strong>返回值</strong>：返回对象本身（返回 <code>this</code>）</li>
<li><strong>典型用途</strong>：对象配置和初始化</li>
</ol>
<h3 data-id="heading-4">基本使用</h3>
<h4 data-id="heading-5">1. 对象初始化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> city: String = <span class="hljs-string">""</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"Person(name='<span class="hljs-variable">$name</span>', age=<span class="hljs-variable">$age</span>, city='<span class="hljs-variable">$city</span>')"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> person = Person().apply {
        name = <span class="hljs-string">"Alice"</span>  <span class="hljs-comment">// this.name = "Alice"</span>
        age = <span class="hljs-number">25</span>
        city = <span class="hljs-string">"New York"</span>
    }
    
    println(person)  <span class="hljs-comment">// Person(name='Alice', age=25, city='New York')</span>
}
</code></pre>
<h4 data-id="heading-6">2. 与构造器配合使用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: String) {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> email: String = <span class="hljs-string">""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">display</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"User(id=<span class="hljs-variable">$id</span>, name=<span class="hljs-variable">$name</span>, email=<span class="hljs-variable">$email</span>)"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"123"</span>).apply {
        name = <span class="hljs-string">"Bob"</span>
        email = <span class="hljs-string">"bob@example.com"</span>
    }
    
    println(user.display())
}
</code></pre>
<h3 data-id="heading-7"><code>apply</code> 与普通初始化对比</h3>
<h4 data-id="heading-8">不使用 <code>apply</code></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> person = Person()
person.name = <span class="hljs-string">"Alice"</span>
person.age = <span class="hljs-number">25</span>
person.city = <span class="hljs-string">"New York"</span>
</code></pre>
<h4 data-id="heading-9">使用 <code>apply</code></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> person = Person().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
    city = <span class="hljs-string">"New York"</span>
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>代码更紧凑</li>
<li>避免重复书写对象变量名</li>
<li>形成逻辑上的代码块</li>
</ul>
<h3 data-id="heading-10">实际应用场景</h3>
<h4 data-id="heading-11">1. Android 开发中的视图配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> textView = TextView(context).apply {
    text = <span class="hljs-string">"Hello, Kotlin!"</span>
    textSize = <span class="hljs-number">16f</span>
    setTextColor(Color.BLACK)
    gravity = Gravity.CENTER
    setPadding(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
}
</code></pre>
<h4 data-id="heading-12">2. 集合和容器的初始化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 初始化列表</span>
<span class="hljs-keyword">val</span> numbers = mutableListOf&lt;<span class="hljs-built_in">Int</span>&gt;().apply {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) add(i * i)
    addAll(listOf(<span class="hljs-number">100</span>, <span class="hljs-number">121</span>, <span class="hljs-number">144</span>))
    sortDescending()
}

<span class="hljs-comment">// 初始化 Map</span>
<span class="hljs-keyword">val</span> config = mutableMapOf&lt;String, Any&gt;().apply {
    put(<span class="hljs-string">"host"</span>, <span class="hljs-string">"localhost"</span>)
    put(<span class="hljs-string">"port"</span>, <span class="hljs-number">8080</span>)
    put(<span class="hljs-string">"timeout"</span>, <span class="hljs-number">30</span>)
    put(<span class="hljs-string">"retry"</span>, <span class="hljs-literal">true</span>)
}
</code></pre>
<h4 data-id="heading-13">3. Builder 模式替代方案</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(
    <span class="hljs-keyword">val</span> brand: String,
    <span class="hljs-keyword">val</span> model: String,
    <span class="hljs-keyword">val</span> year: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">var</span> color: String = <span class="hljs-string">"White"</span>,
    <span class="hljs-keyword">var</span> price: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
)

<span class="hljs-keyword">val</span> myCar = Car(<span class="hljs-string">"Tesla"</span>, <span class="hljs-string">"Model 3"</span>, <span class="hljs-number">2023</span>).apply {
    color = <span class="hljs-string">"Red"</span>
    price = <span class="hljs-number">45000.0</span>
}
</code></pre>
<h4 data-id="heading-14">4. 复杂对象的链式配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConfig</span> {
    <span class="hljs-keyword">var</span> host: String = <span class="hljs-string">"localhost"</span>
    <span class="hljs-keyword">var</span> port: <span class="hljs-built_in">Int</span> = <span class="hljs-number">3306</span>
    <span class="hljs-keyword">var</span> username: String = <span class="hljs-string">"root"</span>
    <span class="hljs-keyword">var</span> password: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> database: String = <span class="hljs-string">"test"</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"DatabaseConfig(host='<span class="hljs-variable">$host</span>', port=<span class="hljs-variable">$port</span>, username='<span class="hljs-variable">$username</span>', database='<span class="hljs-variable">$database</span>')"</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> config = DatabaseConfig().apply {
        host = <span class="hljs-string">"192.168.1.100"</span>
        port = <span class="hljs-number">5432</span>
        username = <span class="hljs-string">"admin"</span>
        password = <span class="hljs-string">"secret123"</span>
        database = <span class="hljs-string">"production"</span>
    }
    
    println(config)
}
</code></pre>
<h3 data-id="heading-15"><code>apply</code> 与其他作用域函数对比</h3>









































<table><thead><tr><th>函数</th><th>接收者引用</th><th>返回值</th><th>典型用途</th></tr></thead><tbody><tr><td><code>apply</code></td><td><code>this</code></td><td>上下文对象</td><td>对象配置</td></tr><tr><td><code>let</code></td><td><code>it</code></td><td>Lambda 结果</td><td>空检查、转换</td></tr><tr><td><code>run</code></td><td><code>this</code></td><td>Lambda 结果</td><td>对象计算、链式调用</td></tr><tr><td><code>with</code></td><td><code>this</code></td><td>Lambda 结果</td><td>非扩展函数，在对象上操作</td></tr><tr><td><code>also</code></td><td><code>it</code></td><td>上下文对象</td><td>附加操作、日志记录</td></tr></tbody></table>
<h4 data-id="heading-16">对比示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">var</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>)
    
    <span class="hljs-comment">// apply - 返回对象本身</span>
    <span class="hljs-keyword">val</span> applyResult = user.apply {
        name = <span class="hljs-string">"Bob"</span>
        age = <span class="hljs-number">30</span>
    }  <span class="hljs-comment">// 返回 user 对象</span>
    
    <span class="hljs-comment">// let - 返回 lambda 结果</span>
    <span class="hljs-keyword">val</span> letResult = user.let {
        it.name = <span class="hljs-string">"Charlie"</span>
        it.age = <span class="hljs-number">35</span>
        <span class="hljs-string">"Name changed"</span>  <span class="hljs-comment">// 返回字符串</span>
    }  <span class="hljs-comment">// 返回 "Name changed"</span>
    
    <span class="hljs-comment">// also - 返回对象本身</span>
    <span class="hljs-keyword">val</span> alsoResult = user.also {
        it.name = <span class="hljs-string">"David"</span>
        it.age = <span class="hljs-number">40</span>
    }  <span class="hljs-comment">// 返回 user 对象</span>
    
    <span class="hljs-comment">// run - 返回 lambda 结果</span>
    <span class="hljs-keyword">val</span> runResult = user.run {
        name = <span class="hljs-string">"Eve"</span>
        age = <span class="hljs-number">45</span>
        <span class="hljs-string">"User updated"</span>  <span class="hljs-comment">// 返回字符串</span>
    }  <span class="hljs-comment">// 返回 "User updated"</span>
}
</code></pre>
<h3 data-id="heading-17">链式调用</h3>
<h4 data-id="heading-18">1. 多级配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-keyword">var</span> street: String = <span class="hljs-string">""</span>, <span class="hljs-keyword">var</span> city: String = <span class="hljs-string">""</span>)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(<span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>, <span class="hljs-keyword">var</span> address: Address = Address())

<span class="hljs-keyword">val</span> company = Company().apply {
    name = <span class="hljs-string">"Tech Corp"</span>
    address.apply {
        street = <span class="hljs-string">"123 Main St"</span>
        city = <span class="hljs-string">"San Francisco"</span>
    }
}
</code></pre>
<h4 data-id="heading-19">2. 复杂对象构建</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">var</span> id: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> items = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> total: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(item: <span class="hljs-type">String</span>, price: <span class="hljs-type">Double</span>)</span></span> {
        items.add(item)
        total += price
    }
}

<span class="hljs-keyword">val</span> order = Order().apply {
    id = <span class="hljs-string">"ORD-001"</span>
    addItem(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>)
    addItem(<span class="hljs-string">"Mouse"</span>, <span class="hljs-number">29.99</span>)
    addItem(<span class="hljs-string">"Keyboard"</span>, <span class="hljs-number">89.99</span>)
}
</code></pre>
<h3 data-id="heading-20">与空安全结合</h3>
<h4 data-id="heading-21">1. 安全调用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">var</span> value: String? = <span class="hljs-literal">null</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processConfig</span><span class="hljs-params">(config: <span class="hljs-type">Config</span>?)</span></span> {
    config?.apply {
        value = <span class="hljs-string">"initialized"</span>
        <span class="hljs-comment">// 这里可以安全地访问 config 的属性和方法</span>
        println(<span class="hljs-string">"Config processed: <span class="hljs-variable">$value</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-22">2. 替代 if 非空检查</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(user: <span class="hljs-type">User</span>?)</span></span> {
    <span class="hljs-comment">// 传统方式</span>
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
        user.name = <span class="hljs-string">"Updated"</span>
        user.age = <span class="hljs-number">30</span>
    }
    
    <span class="hljs-comment">// 使用 apply 的方式</span>
    user?.apply {
        name = <span class="hljs-string">"Updated"</span>
        age = <span class="hljs-number">30</span>
    }
}
</code></pre>
<h3 data-id="heading-23">性能注意事项</h3>
<h4 data-id="heading-24">1. <code>apply</code> 是内联函数</h4>
<p><code>apply</code> 函数使用了 <code>inline</code> 修饰符，这意味着在编译时，lambda 代码会被内联到调用处，不会产生额外的函数对象开销。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">val</span> result = obj.apply { doSomething() }

<span class="hljs-comment">// 编译后（大致等效）</span>
<span class="hljs-keyword">val</span> result = obj
obj.doSomething()
</code></pre>
<h4 data-id="heading-25">2. 与 <code>also</code> 的选择</h4>
<ul>
<li>使用 <code>apply</code> 当需要在 lambda 内访问多个成员时（通过 <code>this</code>）</li>
<li>使用 <code>also</code> 当参数名 <code>it</code> 能提供更好可读性时</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// apply - 适合配置多个属性</span>
<span class="hljs-keyword">val</span> user = User().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
    email = <span class="hljs-string">"alice@example.com"</span>
}

<span class="hljs-comment">// also - 适合单个操作或日志记录</span>
<span class="hljs-keyword">val</span> user = User().also {
    it.name = <span class="hljs-string">"Alice"</span>
    println(<span class="hljs-string">"User created: <span class="hljs-subst">${it.name}</span>"</span>)
}
</code></pre>
<h3 data-id="heading-26">高级用法</h3>
<h4 data-id="heading-27">1. DSL（领域特定语言）构建</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HTML</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> children = mutableListOf&lt;String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">div</span><span class="hljs-params">(block: <span class="hljs-type">Div</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">val</span> div = Div().apply(block)
        children.add(div.toString())
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span> = children.joinToString(<span class="hljs-string">"\n"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Div</span> {
    <span class="hljs-keyword">var</span> id: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> className: String = <span class="hljs-string">""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">p</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> = <span class="hljs-string">"&lt;p&gt;<span class="hljs-variable">$text</span>&lt;/p&gt;"</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span> = 
        <span class="hljs-string">"&lt;div id='<span class="hljs-variable">$id</span>' class='<span class="hljs-variable">$className</span>'&gt;<span class="hljs-subst">${/* 子元素 */}</span>&lt;/div&gt;"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">html</span><span class="hljs-params">(block: <span class="hljs-type">HTML</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: HTML {
    <span class="hljs-keyword">return</span> HTML().apply(block)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> page = html {
        div {
            id = <span class="hljs-string">"header"</span>
            className = <span class="hljs-string">"main-header"</span>
        }
        div {
            id = <span class="hljs-string">"content"</span>
            className = <span class="hljs-string">"main-content"</span>
        }
    }
    
    println(page)
}
</code></pre>
<h4 data-id="heading-28">2. 配置构建器模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationBuilder</span> {
    <span class="hljs-keyword">var</span> host: String = <span class="hljs-string">"localhost"</span>
    <span class="hljs-keyword">var</span> port: <span class="hljs-built_in">Int</span> = <span class="hljs-number">8080</span>
    <span class="hljs-keyword">var</span> timeout: <span class="hljs-built_in">Int</span> = <span class="hljs-number">30</span>
    <span class="hljs-keyword">var</span> retries: <span class="hljs-built_in">Int</span> = <span class="hljs-number">3</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: Configuration = Configuration(host, port, timeout, retries)
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>(<span class="hljs-keyword">val</span> host: String, <span class="hljs-keyword">val</span> port: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> timeout: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> retries: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createConfig</span><span class="hljs-params">(block: <span class="hljs-type">ConfigurationBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: Configuration {
    <span class="hljs-keyword">return</span> ConfigurationBuilder().apply(block).build()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> config = createConfig {
        host = <span class="hljs-string">"api.example.com"</span>
        port = <span class="hljs-number">443</span>
        timeout = <span class="hljs-number">60</span>
        retries = <span class="hljs-number">5</span>
    }
    
    println(config)
}
</code></pre>
<h3 data-id="heading-29">常见陷阱和最佳实践</h3>
<h4 data-id="heading-30">1. 不要过度嵌套</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免 - 过度嵌套降低可读性</span>
<span class="hljs-keyword">val</span> result = SomeClass().apply {
    property1.apply {
        subProperty.apply {
            <span class="hljs-comment">// 太深了！</span>
        }
    }
}

<span class="hljs-comment">// 建议 - 适度使用</span>
<span class="hljs-keyword">val</span> result = SomeClass().apply {
    property1 = configureProperty1()
    property2 = configureProperty2()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureProperty1</span><span class="hljs-params">()</span></span>: PropertyType {
    <span class="hljs-keyword">return</span> PropertyType().apply {
        <span class="hljs-comment">// 配置逻辑</span>
    }
}
</code></pre>
<h4 data-id="heading-31">2. 明确返回意图</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 清晰 - 明确表示这是初始化</span>
<span class="hljs-keyword">val</span> person = Person().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
}

<span class="hljs-comment">// 混淆 - 不要这样使用，会让人疑惑返回值是什么</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createPerson</span><span class="hljs-params">()</span></span>: Person {
    <span class="hljs-keyword">return</span> Person().apply {
        name = <span class="hljs-string">"Alice"</span>
        age = <span class="hljs-number">25</span>
        <span class="hljs-comment">// 如果这里添加了 return，会改变返回值！</span>
    }
}
</code></pre>
<h4 data-id="heading-32">3. 与构造函数参数的区分</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String
) {
    <span class="hljs-keyword">var</span> department: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> salary: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
}

<span class="hljs-comment">// 使用 apply 配置可选属性</span>
<span class="hljs-keyword">val</span> employee = Employee(<span class="hljs-string">"E001"</span>, <span class="hljs-string">"John Doe"</span>).apply {
    department = <span class="hljs-string">"Engineering"</span>
    salary = <span class="hljs-number">75000.0</span>
}
</code></pre>
<h3 data-id="heading-33">总结</h3>
<p><code>apply</code> 函数是 Kotlin 中非常实用的工具，主要优势包括：</p>
<ol>
<li><strong>简化对象初始化</strong>：将多个属性设置集中在一个代码块中</li>
<li><strong>提高代码可读性</strong>：形成逻辑上的初始化单元</li>
<li><strong>支持链式调用</strong>：便于构建复杂对象</li>
<li><strong>类型安全</strong>：在 lambda 内部可以直接访问对象的成员</li>
<li><strong>性能良好</strong>：作为内联函数没有运行时开销</li>
</ol>
<p>使用时机：</p>
<ul>
<li>当需要配置对象多个属性时</li>
<li>构建复杂对象或 DSL 时</li>
<li>替代传统的 Builder 模式</li>
<li>在 Android 中配置视图组件时</li>
</ul>
<p>记住：<code>apply</code> 返回的是对象本身，这使得它非常适合用于初始化配置场景，但不适合需要返回其他值的场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-29 快速掌握Kotlin-过滤函数filter]]></title>    <link>https://juejin.cn/post/7587008326481117226</link>    <guid>https://juejin.cn/post/7587008326481117226</guid>    <pubDate>2025-12-24T06:13:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587008326481117226" data-draft-id="7586994471739588651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-29 快速掌握Kotlin-过滤函数filter"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T06:13:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-29 快速掌握Kotlin-过滤函数filter
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:13:20.000Z" title="Wed Dec 24 2025 06:13:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 过滤函数 <code>filter</code> 详解</h2>
<p><code>filter</code> 是 Kotlin 集合处理中最常用的函数之一，用于从集合中筛选出满足特定条件的元素。</p>
<h3 data-id="heading-1">基本用法</h3>
<h4 data-id="heading-2">1. <strong>基础过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 筛选偶数</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
println(evens) <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 筛选大于5的数</span>
<span class="hljs-keyword">val</span> greaterThanFive = numbers.filter { it &gt; <span class="hljs-number">5</span> }
println(greaterThanFive) <span class="hljs-comment">// [6, 7, 8, 9, 10]</span>

<span class="hljs-comment">// 筛选包含特定字符的字符串</span>
<span class="hljs-keyword">val</span> fruits = listOf(<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"cherry"</span>, <span class="hljs-string">"date"</span>)
<span class="hljs-keyword">val</span> aFruits = fruits.filter { it.contains(<span class="hljs-string">'a'</span>) }
println(aFruits) <span class="hljs-comment">// [apple, banana, date]</span>
</code></pre>
<h4 data-id="heading-3">2. <strong>不同类型集合的过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// List</span>
<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-keyword">val</span> filteredList = list.filter { it &gt; <span class="hljs-number">2</span> }

<span class="hljs-comment">// Set</span>
<span class="hljs-keyword">val</span> <span class="hljs-keyword">set</span> = setOf(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>)
<span class="hljs-keyword">val</span> filteredSet = <span class="hljs-keyword">set</span>.filter { it <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"a"</span>, <span class="hljs-string">"c"</span>) }

<span class="hljs-comment">// Map - 过滤条目</span>
<span class="hljs-keyword">val</span> map = mapOf(<span class="hljs-string">"a"</span> to <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span> to <span class="hljs-number">2</span>, <span class="hljs-string">"c"</span> to <span class="hljs-number">3</span>, <span class="hljs-string">"d"</span> to <span class="hljs-number">4</span>)
<span class="hljs-keyword">val</span> filteredMap = map.filter { (key, value) -&gt; 
    key &gt; <span class="hljs-string">"b"</span> &amp;&amp; value % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> 
}
println(filteredMap) <span class="hljs-comment">// {d=4}</span>

<span class="hljs-comment">// Array</span>
<span class="hljs-keyword">val</span> array = arrayOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-keyword">val</span> filteredArray = array.filter { it &gt; <span class="hljs-number">3</span> }
</code></pre>
<h3 data-id="heading-4"><code>filter</code> 的变体函数</h3>
<h4 data-id="heading-5">1. <strong><code>filterNot()</code> - 反向过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)

<span class="hljs-comment">// 过滤掉偶数（保留奇数）</span>
<span class="hljs-keyword">val</span> odds = numbers.filterNot { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
println(odds) <span class="hljs-comment">// [1, 3, 5]</span>

<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">val</span> odds2 = numbers.filter { it % <span class="hljs-number">2</span> != <span class="hljs-number">0</span> }
</code></pre>
<h4 data-id="heading-6">2. <strong><code>filterIndexed()</code> - 带索引的过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">50</span>)

<span class="hljs-comment">// 根据索引和值进行过滤</span>
<span class="hljs-keyword">val</span> result = numbers.filterIndexed { index, value -&gt;
    index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> &amp;&amp; value &gt; <span class="hljs-number">20</span>
}
println(result) <span class="hljs-comment">// [30, 50]</span>

<span class="hljs-comment">// 复杂的索引条件</span>
<span class="hljs-keyword">val</span> items = listOf(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"e"</span>)
<span class="hljs-keyword">val</span> filtered = items.filterIndexed { index, item -&gt;
    index &gt; <span class="hljs-number">1</span> &amp;&amp; item <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"c"</span>, <span class="hljs-string">"e"</span>)
}
println(filtered) <span class="hljs-comment">// [c, e]</span>
</code></pre>
<h4 data-id="heading-7">3. <strong><code>filterIsInstance&lt;T&gt;()</code> - 类型过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> mixedList: List&lt;Any&gt; = listOf(<span class="hljs-number">1</span>, <span class="hljs-string">"hello"</span>, <span class="hljs-number">2.5</span>, <span class="hljs-string">"world"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4.0</span>)

<span class="hljs-comment">// 过滤出所有整数</span>
<span class="hljs-keyword">val</span> integers = mixedList.filterIsInstance&lt;<span class="hljs-built_in">Int</span>&gt;()
println(integers) <span class="hljs-comment">// [1, 3]</span>

<span class="hljs-comment">// 过滤出所有字符串</span>
<span class="hljs-keyword">val</span> strings = mixedList.filterIsInstance&lt;String&gt;()
println(strings) <span class="hljs-comment">// [hello, world]</span>

<span class="hljs-comment">// 过滤出所有浮点数</span>
<span class="hljs-keyword">val</span> doubles = mixedList.filterIsInstance&lt;<span class="hljs-built_in">Double</span>&gt;()
println(doubles) <span class="hljs-comment">// [2.5, 4.0]</span>
</code></pre>
<h4 data-id="heading-8">4. <strong><code>filterNotNull()</code> - 过滤空值</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> listWithNulls = listOf(<span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>)

<span class="hljs-comment">// 过滤掉所有null值</span>
<span class="hljs-keyword">val</span> withoutNulls = listWithNulls.filterNotNull()
println(withoutNulls) <span class="hljs-comment">// [1, 2, 3, 4]</span>

<span class="hljs-comment">// 在链式调用中使用</span>
<span class="hljs-keyword">val</span> nullableStrings = listOf(<span class="hljs-string">"a"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-literal">null</span>)
<span class="hljs-keyword">val</span> upperCaseLetters = nullableStrings
    .filterNotNull()
    .filter { it.length == <span class="hljs-number">1</span> }
    .map { it.uppercase() }
println(upperCaseLetters) <span class="hljs-comment">// [A, B, C]</span>
</code></pre>
<h4 data-id="heading-9">5. <strong><code>filterTo()</code> - 过滤到指定集合</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 将过滤结果添加到现有的可变集合中</span>
<span class="hljs-keyword">val</span> result = mutableListOf&lt;<span class="hljs-built_in">Int</span>&gt;()
numbers.filterTo(result) { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

println(result) <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 也可以用于不同集合类型</span>
<span class="hljs-keyword">val</span> setResult = mutableSetOf&lt;<span class="hljs-built_in">Int</span>&gt;()
numbers.filterTo(setResult) { it &gt; <span class="hljs-number">5</span> }
println(setResult) <span class="hljs-comment">// [6, 7, 8, 9, 10]</span>
</code></pre>
<h4 data-id="heading-10">6. <strong>Map 的专用过滤函数</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> map = mapOf(
    <span class="hljs-string">"apple"</span> to <span class="hljs-number">10</span>,
    <span class="hljs-string">"banana"</span> to <span class="hljs-number">20</span>,
    <span class="hljs-string">"cherry"</span> to <span class="hljs-number">15</span>,
    <span class="hljs-string">"date"</span> to <span class="hljs-number">5</span>
)

<span class="hljs-comment">// filterKeys - 只根据键过滤</span>
<span class="hljs-keyword">val</span> aKeys = map.filterKeys { it.startsWith(<span class="hljs-string">"a"</span>) }
println(aKeys) <span class="hljs-comment">// {apple=10}</span>

<span class="hljs-comment">// filterValues - 只根据值过滤</span>
<span class="hljs-keyword">val</span> highValues = map.filterValues { it &gt; <span class="hljs-number">10</span> }
println(highValues) <span class="hljs-comment">// {banana=20, cherry=15}</span>
</code></pre>
<h3 data-id="heading-11">实际应用示例</h3>
<h4 data-id="heading-12">1. <strong>数据清洗和转换</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>,
    <span class="hljs-keyword">val</span> category: String,
    <span class="hljs-keyword">val</span> inStock: <span class="hljs-built_in">Boolean</span>
)

<span class="hljs-keyword">val</span> products = listOf(
    Product(<span class="hljs-number">1</span>, <span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">2</span>, <span class="hljs-string">"Mouse"</span>, <span class="hljs-number">29.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">false</span>),
    Product(<span class="hljs-number">3</span>, <span class="hljs-string">"Desk"</span>, <span class="hljs-number">199.99</span>, <span class="hljs-string">"Furniture"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">4</span>, <span class="hljs-string">"Chair"</span>, <span class="hljs-number">149.99</span>, <span class="hljs-string">"Furniture"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">5</span>, <span class="hljs-string">"Keyboard"</span>, <span class="hljs-number">79.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">6</span>, <span class="hljs-string">"Monitor"</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">false</span>)
)

<span class="hljs-comment">// 筛选有库存的电子产品</span>
<span class="hljs-keyword">val</span> availableElectronics = products.filter { 
    it.category == <span class="hljs-string">"Electronics"</span> &amp;&amp; it.inStock 
}
println(<span class="hljs-string">"有库存的电子产品: <span class="hljs-subst">${availableElectronics.size}</span>"</span>)

<span class="hljs-comment">// 筛选价格在100到300之间的产品</span>
<span class="hljs-keyword">val</span> midRangeProducts = products.filter {
    it.price <span class="hljs-keyword">in</span> <span class="hljs-number">100.0</span>.<span class="hljs-number">.300</span><span class="hljs-number">.0</span>
}
println(<span class="hljs-string">"中价位产品: <span class="hljs-subst">${midRangeProducts.size}</span>"</span>)

<span class="hljs-comment">// 复杂的组合条件</span>
<span class="hljs-keyword">val</span> specialProducts = products.filter { product -&gt;
    (product.category == <span class="hljs-string">"Electronics"</span> &amp;&amp; product.price &lt; <span class="hljs-number">100</span>) ||
    (product.category == <span class="hljs-string">"Furniture"</span> &amp;&amp; product.inStock)
}
println(<span class="hljs-string">"特殊产品: <span class="hljs-subst">${specialProducts.size}</span>"</span>)
</code></pre>
<h4 data-id="heading-13">2. <strong>用户输入验证</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInput</span>(
    <span class="hljs-keyword">val</span> username: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-keyword">val</span> password: String,
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>?
)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateInputs</span><span class="hljs-params">(inputs: <span class="hljs-type">List</span>&lt;<span class="hljs-type">UserInput</span>&gt;)</span></span>: List&lt;UserInput&gt; {
    <span class="hljs-keyword">return</span> inputs.filter { input -&gt;
        <span class="hljs-comment">// 用户名：3-20个字符，只包含字母数字</span>
        input.username.matches(Regex(<span class="hljs-string">"^[a-zA-Z0-9]{3,20}$"</span>)) &amp;&amp;
        <span class="hljs-comment">// 邮箱：有效格式</span>
        input.email.matches(Regex(<span class="hljs-string">"^[A-Za-z0-9+_.-]+@(.+)$"</span>)) &amp;&amp;
        <span class="hljs-comment">// 密码：至少8个字符，包含大小写和数字</span>
        input.password.matches(Regex(<span class="hljs-string">"^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).{8,}$"</span>)) &amp;&amp;
        <span class="hljs-comment">// 年龄：18-120之间</span>
        (input.age == <span class="hljs-literal">null</span> || input.age <span class="hljs-keyword">in</span> <span class="hljs-number">18.</span><span class="hljs-number">.120</span>)
    }
}

<span class="hljs-keyword">val</span> userInputs = listOf(
    UserInput(<span class="hljs-string">"john123"</span>, <span class="hljs-string">"john@email.com"</span>, <span class="hljs-string">"Pass123"</span>, <span class="hljs-number">25</span>),
    UserInput(<span class="hljs-string">"ab"</span>, <span class="hljs-string">"bad-email"</span>, <span class="hljs-string">"weak"</span>, <span class="hljs-number">15</span>),
    UserInput(<span class="hljs-string">"jane_doe"</span>, <span class="hljs-string">"jane@email.com"</span>, <span class="hljs-string">"StrongPass123"</span>, <span class="hljs-number">30</span>)
)

<span class="hljs-keyword">val</span> validInputs = validateInputs(userInputs)
println(<span class="hljs-string">"有效输入数量: <span class="hljs-subst">${validInputs.size}</span>"</span>)
</code></pre>
<h4 data-id="heading-14">3. <strong>API 响应处理</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T?,
    <span class="hljs-keyword">val</span> error: String?,
    <span class="hljs-keyword">val</span> statusCode: <span class="hljs-built_in">Int</span>
)

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: String, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> active: <span class="hljs-built_in">Boolean</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processResponses</span><span class="hljs-params">(responses: <span class="hljs-type">List</span>&lt;<span class="hljs-type">ApiResponse</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt;&gt;&gt;)</span></span>: List&lt;User&gt; {
    <span class="hljs-keyword">return</span> responses
        <span class="hljs-comment">// 过滤成功的响应</span>
        .filter { it.statusCode == <span class="hljs-number">200</span> &amp;&amp; it.error == <span class="hljs-literal">null</span> }
        <span class="hljs-comment">// 获取数据</span>
        .flatMap { it.<span class="hljs-keyword">data</span> ?: emptyList() }
        <span class="hljs-comment">// 过滤活跃用户</span>
        .filter { it.active }
        <span class="hljs-comment">// 去重</span>
        .distinctBy { it.id }
}

<span class="hljs-keyword">val</span> apiResponses = listOf(
    ApiResponse(
        <span class="hljs-keyword">data</span> = listOf(User(<span class="hljs-string">"1"</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-literal">true</span>), User(<span class="hljs-string">"2"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-literal">false</span>)),
        error = <span class="hljs-literal">null</span>,
        statusCode = <span class="hljs-number">200</span>
    ),
    ApiResponse(
        <span class="hljs-keyword">data</span> = <span class="hljs-literal">null</span>,
        error = <span class="hljs-string">"Server error"</span>,
        statusCode = <span class="hljs-number">500</span>
    ),
    ApiResponse(
        <span class="hljs-keyword">data</span> = listOf(User(<span class="hljs-string">"1"</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-literal">true</span>), User(<span class="hljs-string">"3"</span>, <span class="hljs-string">"Charlie"</span>, <span class="hljs-literal">true</span>)),
        error = <span class="hljs-literal">null</span>,
        statusCode = <span class="hljs-number">200</span>
    )
)

<span class="hljs-keyword">val</span> activeUsers = processResponses(apiResponses)
println(<span class="hljs-string">"活跃用户: <span class="hljs-variable">$activeUsers</span>"</span>)
</code></pre>
<h4 data-id="heading-15">4. <strong>文件处理</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInfo</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> size: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> extension: String,
    <span class="hljs-keyword">val</span> lastModified: <span class="hljs-built_in">Long</span>
)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">filterFiles</span><span class="hljs-params">(files: <span class="hljs-type">List</span>&lt;<span class="hljs-type">FileInfo</span>&gt;)</span></span>: List&lt;FileInfo&gt; {
    <span class="hljs-keyword">val</span> now = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> oneWeekAgo = now - (<span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">return</span> files.filter { file -&gt;
        <span class="hljs-comment">// 最近一周内修改过的文件</span>
        file.lastModified &gt; oneWeekAgo &amp;&amp;
        <span class="hljs-comment">// 特定类型的文件</span>
        file.extension <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"txt"</span>, <span class="hljs-string">"pdf"</span>, <span class="hljs-string">"docx"</span>) &amp;&amp;
        <span class="hljs-comment">// 文件大小在合理范围内</span>
        file.size <span class="hljs-keyword">in</span> <span class="hljs-number">1024.</span>.(<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) &amp;&amp; <span class="hljs-comment">// 1KB - 10MB</span>
        <span class="hljs-comment">// 文件名不含特殊字符</span>
        file.name.matches(Regex(<span class="hljs-string">"^[a-zA-Z0-9._ -]+\\.<span class="hljs-subst">${file.extension}</span>$"</span>))
    }
}
</code></pre>
<h3 data-id="heading-16">性能优化技巧</h3>
<h4 data-id="heading-17">1. <strong>避免重复过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好：重复过滤和转换</span>
<span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1.</span><span class="hljs-number">.1000</span>).toList()

<span class="hljs-keyword">val</span> badExample = numbers
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }     <span class="hljs-comment">// 第一次遍历</span>
    .map { it * <span class="hljs-number">2</span> }            <span class="hljs-comment">// 第二次遍历</span>
    .filter { it &gt; <span class="hljs-number">100</span> }       <span class="hljs-comment">// 第三次遍历</span>

<span class="hljs-comment">// 好：合并过滤条件</span>
<span class="hljs-keyword">val</span> goodExample = numbers
    .filter { 
        <span class="hljs-keyword">val</span> isEven = it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>
        <span class="hljs-keyword">val</span> doubled = it * <span class="hljs-number">2</span>
        isEven &amp;&amp; doubled &gt; <span class="hljs-number">100</span>
    }
    .map { it * <span class="hljs-number">2</span> }
</code></pre>
<h4 data-id="heading-18">2. <strong>使用序列处理大数据集</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> largeList = (<span class="hljs-number">1.</span><span class="hljs-number">.1_000_000</span>).toList()

<span class="hljs-comment">// 普通方式：创建中间集合</span>
<span class="hljs-keyword">val</span> regular = largeList
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }     <span class="hljs-comment">// 创建中间集合</span>
    .map { it * <span class="hljs-number">2</span> }            <span class="hljs-comment">// 创建中间集合</span>
    .take(<span class="hljs-number">10</span>)                  <span class="hljs-comment">// 取前10个</span>

<span class="hljs-comment">// 使用序列：惰性求值，更高效</span>
<span class="hljs-keyword">val</span> withSequence = largeList.asSequence()
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }     <span class="hljs-comment">// 惰性过滤</span>
    .map { it * <span class="hljs-number">2</span> }            <span class="hljs-comment">// 惰性映射</span>
    .take(<span class="hljs-number">10</span>)                  <span class="hljs-comment">// 只取10个</span>
    .toList()                  <span class="hljs-comment">// 最后转换为列表</span>
</code></pre>
<h4 data-id="heading-19">3. <strong>缓存频繁使用的谓词</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1.</span><span class="hljs-number">.1000</span>).toList()

<span class="hljs-comment">// 重复计算谓词</span>
<span class="hljs-keyword">val</span> predicates = listOf(
    { n: <span class="hljs-built_in">Int</span> -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> },
    { n: <span class="hljs-built_in">Int</span> -&gt; n % <span class="hljs-number">3</span> == <span class="hljs-number">0</span> },
    { n: <span class="hljs-built_in">Int</span> -&gt; n &gt; <span class="hljs-number">100</span> }
)

<span class="hljs-comment">// 一次性应用多个过滤器</span>
<span class="hljs-keyword">val</span> result = numbers.filter { number -&gt;
    predicates.all { predicate -&gt; predicate(number) }
}
</code></pre>
<h3 data-id="heading-20">与 <code>partition</code> 的对比</h3>
<p><code>filter</code> 返回满足条件的元素，<code>partition</code> 将集合分成两个列表。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 使用 filter 和 filterNot</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
<span class="hljs-keyword">val</span> odds = numbers.filterNot { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

<span class="hljs-comment">// 使用 partition（更高效，只遍历一次）</span>
<span class="hljs-keyword">val</span> (evensPart, oddsPart) = numbers.partition { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

println(<span class="hljs-string">"偶数: <span class="hljs-variable">$evensPart</span>"</span>)   <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>
println(<span class="hljs-string">"奇数: <span class="hljs-variable">$oddsPart</span>"</span>)    <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>
</code></pre>
<h3 data-id="heading-21">自定义过滤条件</h3>
<h4 data-id="heading-22">1. <strong>创建可重用的谓词函数</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义谓词函数</span>
<span class="hljs-keyword">val</span> isEven: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
<span class="hljs-keyword">val</span> isPositive: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { it &gt; <span class="hljs-number">0</span> }
<span class="hljs-keyword">val</span> inRange: (<span class="hljs-built_in">Int</span>) -&gt; (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { min -&gt; { max -&gt; 
    { value -&gt; value <span class="hljs-keyword">in</span> min..max } 
}}

<span class="hljs-comment">// 使用谓词函数</span>
<span class="hljs-keyword">val</span> numbers = listOf(-<span class="hljs-number">5</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>)

<span class="hljs-keyword">val</span> positiveEvens = numbers.filter { isEven(it) &amp;&amp; isPositive(it) }
<span class="hljs-keyword">val</span> inRange10to20 = numbers.filter { inRange(<span class="hljs-number">10</span>)(<span class="hljs-number">20</span>)(it) }

<span class="hljs-comment">// 组合谓词</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">composePredicates</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> predicates: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: (T) -&gt; <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> { item -&gt; predicates.all { it(item) } }
}

<span class="hljs-keyword">val</span> complexFilter = composePredicates(isPositive, isEven)
<span class="hljs-keyword">val</span> result = numbers.filter(complexFilter)
</code></pre>
<h4 data-id="heading-23">2. <strong>面向对象的过滤策略</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">FilterStrategy</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInclude</span><span class="hljs-params">(item: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceFilter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minPrice: <span class="hljs-built_in">Double</span>, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxPrice: <span class="hljs-built_in">Double</span>) : 
    FilterStrategy&lt;Product&gt; {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInclude</span><span class="hljs-params">(item: <span class="hljs-type">Product</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> item.price <span class="hljs-keyword">in</span> minPrice..maxPrice
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CategoryFilter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> category: String) : FilterStrategy&lt;Product&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInclude</span><span class="hljs-params">(item: <span class="hljs-type">Product</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> item.category == category
    }
}

<span class="hljs-comment">// 使用策略模式过滤</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">filterWith</span><span class="hljs-params">(strategies: <span class="hljs-type">List</span>&lt;<span class="hljs-type">FilterStrategy</span>&lt;<span class="hljs-type">T</span>&gt;&gt;)</span></span>: List&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filter { item -&gt;
        strategies.all { strategy -&gt; strategy.shouldInclude(item) }
    }
}

<span class="hljs-keyword">val</span> products = listOf(
    Product(<span class="hljs-number">1</span>, <span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">2</span>, <span class="hljs-string">"Desk"</span>, <span class="hljs-number">199.99</span>, <span class="hljs-string">"Furniture"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">3</span>, <span class="hljs-string">"Mouse"</span>, <span class="hljs-number">29.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>)
)

<span class="hljs-keyword">val</span> strategies = listOf(
    PriceFilter(<span class="hljs-number">100.0</span>, <span class="hljs-number">500.0</span>),
    CategoryFilter(<span class="hljs-string">"Electronics"</span>)
)

<span class="hljs-keyword">val</span> filteredProducts = products.filterWith(strategies)
</code></pre>
<h3 data-id="heading-24">注意事项</h3>
<h4 data-id="heading-25">1. <strong>空安全处理</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> nullableList: List&lt;<span class="hljs-built_in">Int</span>&gt;? = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 安全调用</span>
<span class="hljs-keyword">val</span> result1 = nullableList?.filter { it != <span class="hljs-literal">null</span> &amp;&amp; it &gt; <span class="hljs-number">2</span> }

<span class="hljs-comment">// 使用空安全操作符和 filterNotNull</span>
<span class="hljs-keyword">val</span> result2 = nullableList
    ?.filterNotNull()
    ?.filter { it &gt; <span class="hljs-number">2</span> }

<span class="hljs-comment">// 提供默认值</span>
<span class="hljs-keyword">val</span> result3 = (nullableList ?: emptyList())
    .filterNotNull()
    .filter { it &gt; <span class="hljs-number">2</span> }
</code></pre>
<h4 data-id="heading-26">2. <strong>性能考虑</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免在 filter 中进行复杂计算</span>
<span class="hljs-keyword">val</span> largeList = (<span class="hljs-number">1.</span><span class="hljs-number">.10000</span>).toList()

<span class="hljs-comment">// 不好：每次过滤都计算平方</span>
<span class="hljs-keyword">val</span> bad = largeList.filter { 
    <span class="hljs-keyword">val</span> squared = it * it
    squared &gt; <span class="hljs-number">1000</span>
}

<span class="hljs-comment">// 好：预先计算或简化</span>
<span class="hljs-keyword">val</span> good = largeList.filter { it &gt; <span class="hljs-number">31</span> } <span class="hljs-comment">// 因为 32² = 1024 &gt; 1000</span>
</code></pre>
<h4 data-id="heading-27">3. <strong>保持不可变性</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> original = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// filter 不会修改原始集合</span>
<span class="hljs-keyword">val</span> filtered = original.filter { it &gt; <span class="hljs-number">3</span> }
println(original)  <span class="hljs-comment">// [1, 2, 3, 4, 5] - 不变</span>
println(filtered)  <span class="hljs-comment">// [4, 5]</span>
</code></pre>
<h3 data-id="heading-28">总结</h3>
<p><code>filter</code> 函数是 Kotlin 集合处理的核心工具，具有以下特点：</p>
<ol>
<li><strong>多种变体</strong>：提供了 <code>filterNot</code>、<code>filterIndexed</code>、<code>filterIsInstance</code> 等多种变体</li>
<li><strong>链式调用</strong>：可以与其他集合函数（如 <code>map</code>、<code>flatMap</code>）链式调用</li>
<li><strong>惰性求值</strong>：通过 <code>asSequence()</code> 支持惰性求值，优化性能</li>
<li><strong>类型安全</strong>：支持泛型，提供编译时类型检查</li>
<li><strong>空安全</strong>：与 Kotlin 的空安全系统完美集成</li>
</ol>
<p>使用建议：</p>
<ul>
<li>对于简单条件，直接使用 lambda 表达式</li>
<li>对于复杂或可重用的条件，定义谓词函数</li>
<li>处理大数据集时考虑使用序列</li>
<li>需要同时获取满足和不满足条件的元素时使用 <code>partition</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙心迹】- 02-自然壁纸实战教程-AGC 新建项目]]></title>    <link>https://juejin.cn/post/7587017021314400291</link>    <guid>https://juejin.cn/post/7587017021314400291</guid>    <pubDate>2025-12-24T07:24:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314400291" data-draft-id="7587243886432780322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙心迹】- 02-自然壁纸实战教程-AGC 新建项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T07:24:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙心迹】- 02-自然壁纸实战教程-AGC 新建项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:24:37.000Z" title="Wed Dec 24 2025 07:24:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">02-自然壁纸实战教程-AGC 新建项目</h2>
<h3 data-id="heading-1">什么是 AGC 平台</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fservice%2Fjosp%2Fagc%2Findex.html%23%2F" target="_blank" title="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/" ref="nofollow noopener noreferrer">AppGallery Connect</a>（以下简称 AGC）是华为推出的应用一站式服务平台，致力于为开发者提供应用创意、开发、分发、运营、分析</p>
<p>全生命周期服务，构建全场景智慧化的应用生态。</p>
<p>AppGallery Connect 深度整合华为内部各项优质服务，将华为在全球化、质量、安全、工程管理等领域长期积累的能力开放给您，大</p>
<p>幅降低应用开发与运维难度，提高版本质量，开放分发和运营服务，帮助您获得用户并实现收入的规模增长。</p>
<p><img alt="img转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>大白话就是 AGC 是开发者用来管理我们上架项目的后台花园，需要在这里新建项目、上架项目、分析项目等等。所以项目开发之前需要先提前做好这个环境准备工作。</p>
<h3 data-id="heading-2">新建项目</h3>
<p>一个项目可以有多个应用，比如美团是一个项目，但是它可以有用户端、骑手端、商家端等三个应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd85a19f882d4a0ab26b2f02234cc1bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=3MxV1lE%2Fr4TFO05mzW33aaQpHtE%3D" alt="image-20250622205537284" loading="lazy"/></p>
<p>然后根据实际情况填写资料</p>
<h3 data-id="heading-3">新建应用</h3>
<p>然后在这里新建应用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf77448cd7e4d1f9eafbe3704ada9bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=4wvMB8mmESBg3jxkvyi40TJkXUQ%3D" alt="image-20250622205714372" loading="lazy"/></p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d5388df6ffe4c2186ef310dd6ce0a88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=eCjLI73lsNosN1A1uvaGOWStnPk%3D" alt="image-20250622205759276" loading="lazy"/></p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37ae0accc7124d37a52842496b9374f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=JW6WLrtAtRKtTWYawleN6NWBoVM%3D" alt="image-20250622205818962" loading="lazy"/></p>
<p>然后根据实际情况选择类型，自然壁纸是元服务，元服务上架比应用要简单。</p>
<h3 data-id="heading-4">DevEco Studio 新建元服务项目</h3>
<p>上述步骤准备好了，就可以回到桌面上，使用 DevEco Studio 新建元服务了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/263a2a024b3849d6bd603b4ff4f4e4f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=OkIoDkMQIK%2FqCuXesD7NxXiLNmk%3D" alt="image-20250622210110627" loading="lazy"/></p>
<hr/>
<p>然后这里就会出现我们之前在 AGC 平台上新建好的元服务应用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae1f1f760694e0e802d52fe18f6ba64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=2p%2F1qJfGDzjmHYsucM9Im1Oi3OM%3D" alt="image-20250622210409257" loading="lazy"/></p>
<p>至此，可以认为初步的项目新建工作已经完成了，但是实际情况下，后续的开发和发布上架，还需要用到一些证书，包括调用网络服务还需要进行域名备案，这块内容可以后面来完善，当前教程偏向初学者，所以优先关注核心代码吧，或者有具体疑问了都可以在技术交流群中进行提问。</p>
<h3 data-id="heading-5">近期活动</h3>
<p>最近想要想要考取 HarmonyOS 基础或者高级证书，或者快要获取的同学都可以点击这个链接，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F7e230b074eaa41c587c71c1d1a9a6514%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/7e230b074eaa41c587c71c1d1a9a6514?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">加入我的班级</a>，考取成功有机会获得鸿蒙礼盒一份。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙心迹】-03-自然壁纸实战教程-项目结构介绍]]></title>    <link>https://juejin.cn/post/7587023071066505268</link>    <guid>https://juejin.cn/post/7587023071066505268</guid>    <pubDate>2025-12-24T07:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071066505268" data-draft-id="7587028972245794851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙心迹】-03-自然壁纸实战教程-项目结构介绍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T07:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙心迹】-03-自然壁纸实战教程-项目结构介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:25:34.000Z" title="Wed Dec 24 2025 07:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">03-自然壁纸实战教程-项目结构介绍</h2>
<h3 data-id="heading-1">架构选型</h3>
<p>按照目前主流的鸿蒙应用开发来讲，基本都是推荐三层架构-<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fbest-practices%2Fbpta-multi-device-overview" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-overview" ref="nofollow noopener noreferrer">一次开发-多端部署</a>，因为主要考虑到多端适配，那么这个选型是必然的了。但是自然壁纸当初的立项的出发点比较简单，怎么快怎么来，所以就直接选择了单HAP架构。</p>
<h4 data-id="heading-2">单HAP架构</h4>
<p>对于单窗口应用的APP工程，其仅包含一个Entry类型的HAP。划分的模块则根据是否有按需加载的需求，来考虑采用HAR模块和</p>
<p>HSP模块。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3126d73d9f643dd9963aa1e992f7365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=Q0nUkLCzpTeopYx9QXVnLT%2B6QAs%3D" alt="image-20250627092419769" loading="lazy"/></p>
<blockquote>
<p>注意，正常开发的工程是不会把设计稿放在工程内的，这里存放只是为了方便学习者直接拿到，不另外存储而已！</p>
</blockquote>
<h4 data-id="heading-3">多HAP工程</h4>
<p>对于同一个设备类型，如果要实现不同的独立功能模块，并且相对独立，以及具有单独的入口的功能特性，建议做成一个独立特性的HAP，按需下载安装。此时一个App包中，就会有多个HAP包，其中有且仅有一个Entry类型的HAP，其他的均是Feature类型的HAP。多HAP之间业务独立，但是可能会有业务能力共享，所以在进行模块化设计时，需要根据是否具有公共能力来进行选择。</p>
<h3 data-id="heading-4">核心目录结构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/879c122c026a488ab121f54f5f1ea7b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=q9aVW5lcvc3rpGFRv%2FyAPcp5iGc%3D" alt="image-20250627092534277" loading="lazy"/></p>
<p>核心目录结构也比较常规</p>
<pre><code class="hljs language-csharp" lang="csharp">├── components\          <span class="hljs-meta"># 组件目录</span>
├── <span class="hljs-keyword">const</span>\               <span class="hljs-meta"># 常量定义目录</span>
├── entryability\        <span class="hljs-meta"># 入口能力目录</span>
├── entryformability\    <span class="hljs-meta"># 入口表单能力目录</span>
├── pages\               <span class="hljs-meta"># 页面目录</span>
├── services\            <span class="hljs-meta"># 通用逻辑服务目录</span>
├── utils\               <span class="hljs-meta"># 工具类目录</span>
├── viewModel\           <span class="hljs-meta"># 视图模型目录</span>
├── views\               <span class="hljs-meta"># 视图目录</span>
└── zrbzwidget\          <span class="hljs-meta"># 卡片组件目录</span>
</code></pre>
<p>其中优先需要关注的是页面目录结构，它决定当前项目存在多少个页面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d50482c756c43bc8db243cdd26144f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=ZGTGNdj1l%2FLJB3lSLfanXTI1J%2FY%3D" alt="image-20250627093523143" loading="lazy"/></p>
<p>当然了，作为学习者而已，在开始学习的时候不需要一口气全部新建完，做到哪里了，就用到哪里即可。</p>
<p>由于工程使用的是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-navigation-navigation" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation" ref="nofollow noopener noreferrer">Navigation</a>作为路由管理，所以Pages下只放了一个页面 Index.ets 作为入口，剩下的页面都放到了view目录下。</p>
<h3 data-id="heading-5">API版本</h3>
<p>项目开始时是使用API14的版本，但是目前官网已经更新到了API20，欢迎有能力的小伙伴们直接使用最新的API20，当出现问题时，可以沟通解决，确保用到的是最新的技术。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f672f4abcfe74c4a8086b0a0c66d230e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=8HW8mTyQ5ugDPDcCPpz1bJuiYh8%3D" alt="image-20250630083159327" loading="lazy"/></p>
<h3 data-id="heading-6">近期活动</h3>
<p>最近想要想要考取 HarmonyOS 基础或者高级证书，或者快要获取的同学都可以点击这个链接，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F7e230b074eaa41c587c71c1d1a9a6514%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/7e230b074eaa41c587c71c1d1a9a6514?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">加入我的班级</a>，考取成功有机会获得鸿蒙礼盒一份。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底是选 merge 还是选 rebase]]></title>    <link>https://juejin.cn/post/7587017021314498595</link>    <guid>https://juejin.cn/post/7587017021314498595</guid>    <pubDate>2025-12-24T07:36:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314498595" data-draft-id="7587028972245827619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底是选 merge 还是选 rebase"/> <meta itemprop="keywords" content="面试,程序员,Git"/> <meta itemprop="datePublished" content="2025-12-24T07:36:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dolphin_海豚"/> <meta itemprop="url" content="https://juejin.cn/user/116975171023884"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底是选 merge 还是选 rebase
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/116975171023884/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dolphin_海豚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:36:38.000Z" title="Wed Dec 24 2025 07:36:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写这篇文章的契机也是因为有次组内技术分享会里面讨论过这个话题，这两个指令都是用来合并分支代码的，rebase 可以把分支记录弄成一条线性，而 merge 保留了分支树状图，以我的习惯是更倾向于 merge，因为我大部分场景用不上 rebase</p>
<p>我们先看个大家开发中非常常见的场景，两个人基于 master 的同一个 commit 节点各自拉起一个新的 feature 分支，其中一个人 A 有多个 commit，并率先完成任务合入 master，B 也有多个 commit ，在他完成任务准备合入 master 时，发现有冲突，这里我模拟的每个提交都是针对同一个文件，每个 commit 都会有冲突</p>
<p>在 A 合并 master 前的分支图如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1403bbd4f03418d999eb1da408c4aff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=UWON9dAs1ueNqxbdlHWdGQmLf5w%3D" alt="1.jpg" loading="lazy"/></p>
<p>可以看到 feature/A 分支 和 feature/B 分支都是基于 master 最新的 commit 拉起的分支，两条分支并行开发，这里我为了跟随时间线，用顺序数字模拟 commit 信息，两条分支各自新增了 3 个 commit</p>
<p>现在我们把 A 通过 merge 合并到 master 上</p>
<pre><code class="hljs language-bash" lang="bash">git checkout master
git merge feature/A
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf16486b2501476994905ad3d3ee7c4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=HRGQtdzhMbAoL5dNfMLzedLTKO0%3D" alt="2.jpg" loading="lazy"/></p>
<p>可以看到 A merge 到 master 后，master 和 feature/A 保持一致了</p>
<p>好了，开头说的场景已经出现了，这个时候你是 B 你会怎么做，要是我会选择 merge，那就先看下 merge 的表现</p>
<pre><code class="hljs language-bash" lang="bash">git checkout master
git merge feature/B
</code></pre>
<p>由于我的每个 commit 都是针对同一个文件做出更改，所以最终汇入必然要去解决冲突</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11d931780fd4433cb009e1acab3e1063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=nJC7ZI%2BSHpb9%2BHGNxJ5b0AwRhnE%3D" alt="5.jpg" loading="lazy"/>
可以看到这里的冲突是让你一次性解决的，解决完冲突后提交看 分支图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7438acd2587440b7957efee20fc88152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=zhtFrwQgHICGJeyJt1s9PvfCBg0%3D" alt="3.jpg" loading="lazy"/></p>
<p>可以看到，<strong>merge 会创建一个新的合并提交，把两个分支平行的合并，保留了分支历史</strong></p>
<p>这里顺带解释下为啥有时候 merge 没有 mr 节点，有时候又有，其实大部分情况下都会有。比如这里的 feature/A 合入 master 就没产生 mr 节点，feature/B 后合入 master 就产生了 mr 节点</p>
<p>merge 节点有没有取决于 git 是否需要创建一个新的合并提交</p>
<blockquote>
<p>可能你体感上是永远会有 mr 节点，因为远程合作大部分场景 master 都是一直在前进的</p>
</blockquote>
<ul>
<li>fast-forward 合并
<ul>
<li>master 还停留在你分支起点的那个提交，比如 feature/A 合入到 master 的时候，master 和 feature/A 同一个起点，这就是 fast-forward 提交，就不会产生 mr 节点</li>
</ul>
</li>
<li>非 fast-forward 合并
<ul>
<li>master 相较于你的分支有了新的提交，比如 feature/B 的起点是最初的 <code>docs: add README</code> ，在 feature/B 准备合入 master 时，master 最新的提交却是 feature/A 的 <code>dosc: 5</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>估计这个时候就小盆友要说了，我的这个 mr 节点是在我解决冲突时提交的，其实就算没有冲突，非 fast-forward 合并就是会产生 mr 节点</p>
</blockquote>
<p>好，我们现在撤回 feature/B merge 到 master，我们改用 rebase 再来看下对比</p>
<p>撤回之后的分支图如下，master 还是停留在 <code>docs: 5</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c94ef6dd7145a695dd3c915c2f7e29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=vRozP5wg1UrLsvsJeVmxBURNHeE%3D" alt="4.jpg" loading="lazy"/></p>
<p>现在使用 rebase</p>
<pre><code class="hljs language-bash" lang="bash">git checkout feature/B
git rebase master
</code></pre>
<p>可以看到 vscode 编辑器让我去解决冲突，这还是第一个</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a744caf460486e8c8467a8cc14c541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=5dlHSXMoiU1ubT2HfZ9OxarKu20%3D" alt="6.jpg" loading="lazy"/></p>
<p><strong>要是每个 commit 都有冲突那就每个 commit 都要单独解决一次冲突</strong></p>
<p>一旦解决冲突并 git add，再运行 git rebase --continue，git 就会继续重放下一个提交，若同一段代码在多个提交中都改过，就会感觉是在重复解决冲突</p>
<p>现在回过头来看 git 树</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29abed4004d147e993cdc9d88b5f2b29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=ZFWY7B09tc3vGoAiH0horhCeOFQ%3D" alt="7.jpg" loading="lazy"/></p>
<p>可以看到 最终的 git 记录成一条直线了，看着确实顺眼不少，并且你的分支所有提交都会提前，你也<strong>不会产生 合并 的 mr 节点</strong>，但是<strong>你分支上原本的 commit hash （<code>docs:3, dosc: 4, dosc: 6</code>）会发生变化</strong></p>
<h2 data-id="heading-0">结论</h2>
<p>从 git 提交记录看</p>
<ul>
<li>merge 保留历史记录，非线性，容易产生 mr 节点</li>
<li>rebase 将自己的 commit 记录提前并更改你之前的 commit hash，线性，不产生多余的 mr 节点</li>
</ul>
<p>从 解决冲突 看</p>
<ul>
<li>merge 在汇入那一刻解决所有的冲突，直接对比两个分支代码的终极形态</li>
<li>rebase 会按顺序重放你的所有 commit，但凡有冲突的提交都会让你挨个去解决</li>
</ul>
<p>用 rebase 是有使用场景的，要是不清楚无脑 merge 就好。只有你一个人使用的分支，并且还没 push 到远端，可以去使用 rebase 整理下 git 历史，否则其余所有情况都可以用 merge</p>
<blockquote>
<p>git rebase -i 可以整理提交顺序，合并多个小提交，改写提交信息</p>
</blockquote>
<p>rebase 一定不能在公共分支上使用，因为这会篡改共有分支的 commit hash，别人再去合代码必然导致冲突</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React学习：通过TodoList，完整理解组件通信]]></title>    <link>https://juejin.cn/post/7587020682010738715</link>    <guid>https://juejin.cn/post/7587020682010738715</guid>    <pubDate>2025-12-24T07:33:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587020682010738715" data-draft-id="7587074669816578074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React学习：通过TodoList，完整理解组件通信"/> <meta itemprop="keywords" content="JavaScript,React.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-24T07:33:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React学习：通过TodoList，完整理解组件通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:33:00.000Z" title="Wed Dec 24 2025 07:33:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 组件通信从零到精通：用一个完整 Todo List 项目彻底搞懂父子、子父与兄弟通信</h2>
<p>最近学习了React中完整点的组件通信，包括父传子，子传父，兄弟组件通信。概念听起来简单——props 向下传、回调向上传、状态提升——但真正写代码时，总觉得迷迷糊糊。于是我通过一个 Todo List 功能讲解，结合真实代码，一点点拆解了组件通信的每一个细节。</p>
<p>从最基础的父传子开始，到子传父的回调机制，再到兄弟组件的状态提升，最后深入到大家经常问的“为什么 onChange 要包箭头函数”这类细节。全程基于一个可运行的 Todo List 项目，代码全部贴出，讲解尽量通俗、细致，适合初学者反复阅读，也适合有经验的同学复习巩固。</p>
<h4 data-id="heading-1">项目整体结构：经典的状态提升模式</h4>
<p>先看整个项目的组件树：</p>
<pre><code class="hljs language-text" lang="text">App（父组件）
├── TodoInput（添加输入框）
├── TodoList（列表展示 + 删除 + 切换完成状态）
└── TodoStats（统计 + 清除已完成任务）
</code></pre>
<p>核心数据 todos 数组只在 App 组件中用 useState 管理。三个子组件都不直接持有或修改 todos，而是通过 props 接收数据和修改方法。</p>
<p>这就是 React 官方推荐的<strong>状态提升（Lifting State Up）</strong> ：把多个组件需要共享的状态提升到它们最近的共同父组件中统一管理。</p>
<p>这样做的好处：</p>
<ul>
<li>数据有单一真相来源（single source of truth）</li>
<li>避免数据不同步的 bug</li>
<li>逻辑集中，容易维护</li>
</ul>
<h4 data-id="heading-2">一、父组件 → 子组件：单向数据流与 Props 传递</h4>
<p>React 的核心原则是<strong>单向数据流</strong>：数据只能从父组件通过 props 向下传递，子组件不能直接修改父组件的数据。</p>
<p>在 App.jsx 中，我们把 todos 数据、统计数字、各种操作函数都通过 props 传给了子组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx 关键片段</span>
&lt;<span class="hljs-title class_">TodoInput</span> onAdd={addTodo} /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span>
  <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
  <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span>
  <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span>
/&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoStats</span>
  <span class="hljs-attr">total</span>=<span class="hljs-string">{todos.length}</span>
  <span class="hljs-attr">active</span>=<span class="hljs-string">{activeCount}</span>
  <span class="hljs-attr">completed</span>=<span class="hljs-string">{completedCount}</span>
  <span class="hljs-attr">onClearCompleted</span>=<span class="hljs-string">{onClearCompleted}</span>
/&gt;</span></span>
</code></pre>
<p>子组件只需要接收 props，使用即可，完全不需要关心数据是怎么来的、怎么改的。</p>
<p>关于父传子的单项数据可以看我上一篇文章<a href="https://juejin.cn/post/7586569284550934568" target="_blank" title="https://juejin.cn/post/7586569284550934568"># React 学习：父传子的单项数据流——props</a></p>
<h4 data-id="heading-3">二、子组件 → 父组件：回调函数上报事件（深度详解）</h4>
<p>子组件如何影响父组件的状态？这正是 React 组件通信中最核心、最容易混淆的部分。</p>
<p><strong>很多人误以为“子传父”是子组件把数据直接塞给父组件，其实完全不是！</strong></p>
<p>React 中“子传父”的正确姿势是：<strong>父组件提前定义好一个回调函数，通过 props 传给子组件；子组件在合适时机调用这个函数，把必要的信息“上报”给父组件，由父组件决定如何更新自己的状态。</strong></p>
<p>这套机制在我们的三个子组件中都有体现，下面结合代码<strong>一步一步彻底拆解</strong>它的实现原理。</p>
<h5 data-id="heading-4">子传父的完整四步流程</h5>
<ol>
<li><strong>父组件定义回调函数</strong>（负责真正修改状态）</li>
<li><strong>父组件通过 props 把回调函数传给子组件</strong></li>
<li><strong>子组件接收回调，并在事件触发时调用它（上报数据或事件）</strong></li>
<li><strong>回调执行 → 父组件状态更新 → 触发重新渲染 → 新数据通过 props 再次向下传递</strong></li>
</ol>
<p>下面以“添加新 Todo”为例，逐行代码演示这个闭环。</p>
<h5 data-id="heading-5">示例 1：TodoInput 添加新事项（子传父经典案例）</h5>
<p><strong>步骤 1：父组件定义回调函数 addTodo</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, {
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    text,
    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>
  }]);
};
</code></pre>
<p>这个函数接收一个 text 参数，负责把新事项添加到状态中。</p>
<p><strong>步骤 2：父组件通过 props 传递回调</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">TodoInput</span> onAdd={addTodo} /&gt;  <span class="hljs-comment">// 注意：传的是函数本身，不是调用</span>
</code></pre>
<p><strong>步骤 3：子组件接收并在提交时调用</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// TodoInput.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoInput</span> = (<span class="hljs-params">{ onAdd }</span>) =&gt; {  <span class="hljs-comment">// 解构接收</span>
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> text = inputValue.<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">onAdd</span>(text);          <span class="hljs-comment">// ← 关键！上报用户输入的文本</span>
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">""</span>);    <span class="hljs-comment">// 清空输入框</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputValue(e.target.value)}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>步骤 4：闭环完成</strong></p>
<ul>
<li>用户输入并提交 → onAdd(text) 被调用 → 执行父组件的 addTodo</li>
<li>setTodos 更新状态 → App 重新渲染 → 新 todos 通过 props 传给 TodoList → 列表自动显示新项</li>
</ul>
<h5 data-id="heading-6">示例2. TodoList：删除和切换完成状态</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// TodoList.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoList</span> = (<span class="hljs-params">{ todos, onDelete, onToggle }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
      {todos.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty"</span>&gt;</span>No todos yet!<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ) : (
        todos.map((todo) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? "<span class="hljs-attr">completed</span>" <span class="hljs-attr">:</span> ""}
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> onToggle(todo.id)}   // 上报 id
              /&gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{todo.text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">"delete-btn"</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onDelete(todo.id)}      // 上报 id
            &gt;
              ×
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoList</span>;
</code></pre>
<p>关键点：</p>
<ul>
<li>复选框也是受控组件：checked 值来自 props 中的 todo.completed</li>
<li>点击复选框或删除按钮时，分别调用 onToggle(todo.id) 和 onDelete(todo.id)，把当前事项的 id 上报给父组件</li>
<li>父组件根据 id 找到对应项并更新状态</li>
</ul>
<p>父组件中的实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span>
    todo.<span class="hljs-property">id</span> === id 
      ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> }
      : todo
  ));
};
</code></pre>
<h5 data-id="heading-7">示例3. TodoStats：清除已完成事项</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// TodoStats.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoStats</span> = (<span class="hljs-params">{ total, active, completed, onClearCompleted }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-stats"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
        Total: {total} | Active: {active} | Completed: {completed}
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {completed &gt; 0 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClearCompleted}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"clear-btn"</span>&gt;</span>
          Clear Completed
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoStats</span>;
</code></pre>
<p>关键点：</p>
<ul>
<li>统计数字由父组件提前计算好传下来，避免子组件重复计算</li>
<li>点击清除按钮时调用 onClearCompleted() 上报事件</li>
</ul>
<p>父组件实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onClearCompleted</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> !todo.<span class="hljs-property">completed</span>));
};
</code></pre>
<h5 data-id="heading-8">子传父的核心本质总结</h5>
<ul>
<li><strong>不是子组件“给”父组件数据</strong>，而是子组件“通知”父组件：“嘿，发生了一件事（用户点了添加/删除/切换），需要的参数我给你，你自己看着办。”</li>
<li><strong>所有状态修改权永远掌握在父组件手里</strong>，子组件只有“上报权”。</li>
<li>这种“事件向上冒泡、数据向下流动”的模式，正是 React 单向数据流的完美体现。</li>
</ul>
<p>掌握了这个机制，你就真正理解了为什么 React 说“数据流是单向的”，却依然能轻松实现复杂的交互。</p>
<h5 data-id="heading-9">完整子组件代码（带详细注释）</h5>
<p><strong>TodoInput.jsx</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoInput</span> = (<span class="hljs-params">{ onAdd }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> text = inputValue.<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">onAdd</span>(text);          <span class="hljs-comment">// 子 → 父：上报新事项文本</span>
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">""</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-input"</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputValue(e.target.value)}
        placeholder="输入事项后按回车或点击添加"
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoInput</span>;
</code></pre>
<p><strong>TodoList.jsx</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoList</span> = (<span class="hljs-params">{ todos, onDelete, onToggle }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
      {todos.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty"</span>&gt;</span>No todos yet! 快去添加一个吧～<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ) : (
        todos.map((todo) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? "<span class="hljs-attr">completed</span>" <span class="hljs-attr">:</span> ""}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> onToggle(todo.id)}   // 子 → 父：上报要切换的 id
              /&gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{todo.text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">"delete-btn"</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onDelete(todo.id)}      // 子 → 父：上报要删除的 id
            &gt;
              ×
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoList</span>;
</code></pre>
<p><strong>TodoStats.jsx</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoStats</span> = (<span class="hljs-params">{ total, active, completed, onClearCompleted }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-stats"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Total: {total} | Active: {active} | Completed: {completed}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {completed &gt; 0 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClearCompleted}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"clear-btn"</span>&gt;</span>
          Clear Completed
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoStats</span>;
</code></pre>
<h4 data-id="heading-10">三、为什么 onChange={() =&gt; onToggle(todo.id)} 必须包箭头函数？</h4>
<p>这是初学者最容易踩的坑之一，我们详细拆解。</p>
<h5 data-id="heading-11">错误写法 1：直接调用</h5>
<pre><code class="hljs language-jsx" lang="jsx">onChange={<span class="hljs-title function_">onToggle</span>(todo.<span class="hljs-property">id</span>)}  <span class="hljs-comment">// 灾难性错误！</span>
</code></pre>
<p>渲染时就会立即执行 onToggle(todo.id)，导致：</p>
<ul>
<li>页面加载瞬间所有任务状态翻转</li>
<li>可能引发无限渲染循环</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1662110ec500425f8b9b7f5bb1c9055b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=9abBwtJi3lT8haHtuIrg4I8ZuUU%3D" alt="SnowShot_Video_2025-12-24_14-57-17.gif" loading="lazy"/></p>
<h5 data-id="heading-12">错误写法 2：只传函数不传参</h5>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">onChange</span>={<span class="hljs-literal">on</span>Toggle}
</code></pre>
<p>React 会把 event 对象传给 onToggle，但我们需要的是 id，导致切换失败。</p>
<h5 data-id="heading-13">正确写法：箭头函数包裹</h5>
<pre><code class="hljs language-jsx" lang="jsx">onChange={<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onToggle</span>(todo.<span class="hljs-property">id</span>)}
</code></pre>
<p>只有用户真正点击时才执行，并正确传递 id。</p>
<h4 data-id="heading-14">四、完整 App 组件：数据管理中心</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./styles/app.styl"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/TodoList"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/TodoInput"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoStats</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/TodoStats"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 子组件共享的数据状态</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 高级用法</span>
    <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"todos"</span>);
    <span class="hljs-keyword">return</span> saved ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved) : [];
  });
  <span class="hljs-comment">// 子组件修改数据的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>([
      ...todos,
      {
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 时间戳</span>
        text,
        <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
      },
    ]);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(
      todos.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span>
        todo.<span class="hljs-property">id</span> === id
          ? {
              ...todo,
              <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span>,
            }
          : todo
      )
    );
  };

  <span class="hljs-keyword">const</span> activeCount = todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> !todo.<span class="hljs-property">completed</span>).<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> completedCount = todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">completed</span>).<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClearCompleted</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> !todo.<span class="hljs-property">completed</span>));
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"todos"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
  }, [todos]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>My Todo List<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {/* 自定义事件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span> <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span> <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoStats</span>
        <span class="hljs-attr">total</span>=<span class="hljs-string">{todos.length}</span>
        <span class="hljs-attr">active</span>=<span class="hljs-string">{activeCount}</span>
        <span class="hljs-attr">completed</span>=<span class="hljs-string">{completedCount}</span>
        <span class="hljs-attr">onClearCompleted</span>=<span class="hljs-string">{onClearCompleted}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre>
<h4 data-id="heading-15">五、最终效果展示：</h4>
<h5 data-id="heading-16"><code>初始状态</code></h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67aad8670f9e4fa6971ce2bcddf8a2da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=Cy8ZqdqWhLrrSEoFeDhY9Y%2FKiaY%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-17"><code>添加示例</code></h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab59ae515ec4d3aba09ef9bc02674cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=ysmQj755jZVBZ37kJB5VYt6wNBc%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-18"><code>勾选完成</code></h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08010bbbbefe4c86a10aa22b0a1a1fa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=qaLxVQ1fvpUodhEXGD5rWhcrKVE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-19">六、总结：掌握这套模式，就掌握了 90% 的组件通信</h4>
<p>通过这个 Todo List，我们完整实践了：</p>
<ol>
<li>父传子：props 单向传递</li>
<li>子传父：回调函数上报事件（深度掌握）</li>
<li>兄弟通信：状态提升</li>
<li>常见坑避免：事件处理正确写法</li>
</ol>
<p>这套模式简单、可靠、可预测，是 React 项目的基石。</p>
<p>当项目更大时，再学习 Context 或状态管理库。但请记住：<strong>万丈高楼平地起，先把这套基础打牢</strong>。</p>
<p>希望这篇文章能帮你彻底弄懂 React 组件通信的本质。下次写代码时，遇到数据流动问题，先问自己：“这个状态该谁管？回调要不要传参？箭头函数包好了吗？”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 的 Agent Skills 是什么？如何使用？]]></title>    <link>https://juejin.cn/post/7587284708943544354</link>    <guid>https://juejin.cn/post/7587284708943544354</guid>    <pubDate>2025-12-24T07:32:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708943544354" data-draft-id="7587243886432829474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 的 Agent Skills 是什么？如何使用？"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2025-12-24T07:32:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="micefind"/> <meta itemprop="url" content="https://juejin.cn/user/3927901240298430"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 的 Agent Skills 是什么？如何使用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901240298430/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    micefind
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:32:37.000Z" title="Wed Dec 24 2025 07:32:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Code 的 Agent Skills 使用指南</h2>
<h3 data-id="heading-1">什么是 Agent Skills？</h3>
<p>Agent Skills 是 Claude API 中的工具调用（Tool Use）机制，允许 Claude 自主决策并调用外部函数完成任务。核心特性：</p>
<ul>
<li><strong>自主决策</strong> - Claude 判断是否需要调用工具及调用参数</li>
<li><strong>循环执行</strong> - 支持多轮工具调用，逐步完成复杂任务</li>
<li><strong>结构化通信</strong> - 基于 JSON Schema 定义工具接口规范</li>
</ul>
<hr/>
<h3 data-id="heading-2">核心实现流程</h3>
<h4 data-id="heading-3">1. <strong>定义工具（Tool Definition）</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> anthropic

tools = [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"execute_python"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行 Python 代码并返回输出结果。用于数据处理、计算、文件操作等。"</span>,
        <span class="hljs-string">"input_schema"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"code"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"要执行的 Python 代码片段（不包含输入提示）"</span>
                }
            },
            <span class="hljs-string">"required"</span>: [<span class="hljs-string">"code"</span>]
        }
    },
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"read_file"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"读取指定路径的文件内容。支持文本和二进制文件。"</span>,
        <span class="hljs-string">"input_schema"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"path"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"文件的绝对或相对路径"</span>
                },
                <span class="hljs-string">"encoding"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"文件编码方式，默认 utf-8"</span>,
                    <span class="hljs-string">"default"</span>: <span class="hljs-string">"utf-8"</span>
                }
            },
            <span class="hljs-string">"required"</span>: [<span class="hljs-string">"path"</span>]
        }
    }
]
</code></pre>
<h4 data-id="heading-4">2. <strong>初始化 Agent 请求</strong></h4>
<pre><code class="hljs language-python" lang="python">client = anthropic.Anthropic(api_key=<span class="hljs-string">"your-api-key"</span>)

response = client.messages.create(
    model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
    max_tokens=<span class="hljs-number">4096</span>,
    tools=tools,
    messages=[
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"读取 data.csv 文件，计算销售总额和平均值"</span>
        }
    ]
)
</code></pre>
<h4 data-id="heading-5">3. <strong>循环处理工具调用</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">tool_name: <span class="hljs-built_in">str</span>, tool_input: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具并返回结果"""</span>
    <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">"execute_python"</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 安全执行：使用 subprocess 隔离环境</span>
            result = subprocess.run(
                [<span class="hljs-string">"python"</span>, <span class="hljs-string">"-c"</span>, tool_input[<span class="hljs-string">"code"</span>]],
                capture_output=<span class="hljs-literal">True</span>,
                text=<span class="hljs-literal">True</span>,
                timeout=<span class="hljs-number">30</span>
            )
            <span class="hljs-keyword">return</span> result.stdout <span class="hljs-keyword">or</span> result.stderr
        <span class="hljs-keyword">except</span> subprocess.TimeoutExpired:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"错误: 代码执行超时（超过30秒）"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
  
    <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"read_file"</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(
                tool_input[<span class="hljs-string">"path"</span>],
                <span class="hljs-string">"r"</span>,
                encoding=tool_input.get(<span class="hljs-string">"encoding"</span>, <span class="hljs-string">"utf-8"</span>)
            ) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">return</span> f.read()
        <span class="hljs-keyword">except</span> FileNotFoundError:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: 文件不存在 - <span class="hljs-subst">{tool_input[<span class="hljs-string">'path'</span>]}</span>"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-comment"># 持续循环直到 Agent 完成任务</span>
messages = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"读取 data.csv 文件，计算销售总额和平均值"</span>}
]

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    response = client.messages.create(
        model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
        max_tokens=<span class="hljs-number">4096</span>,
        tools=tools,
        messages=messages
    )
  
    <span class="hljs-comment"># 检查是否有工具调用</span>
    <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"tool_use"</span>:
        <span class="hljs-comment"># 找到工具调用块</span>
        assistant_message = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response.content}
        messages.append(assistant_message)
      
        <span class="hljs-comment"># 处理所有工具调用</span>
        tool_results = []
        <span class="hljs-keyword">for</span> content_block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> content_block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_result = execute_tool(
                    content_block.name,
                    content_block.<span class="hljs-built_in">input</span>
                )
                tool_results.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_result"</span>,
                    <span class="hljs-string">"tool_use_id"</span>: content_block.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">"content"</span>: tool_result
                })
      
        <span class="hljs-comment"># 反馈工具结果</span>
        messages.append({
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: tool_results
        })
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Agent 已完成（stop_reason == "end_turn"）</span>
        <span class="hljs-keyword">break</span>

<span class="hljs-comment"># 提取最终文本响应</span>
final_response = <span class="hljs-built_in">next</span>(
    (b.text <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> response.content <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(b, <span class="hljs-string">"text"</span>)),
    <span class="hljs-literal">None</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Agent 响应:"</span>, final_response)
</code></pre>
<hr/>
<h3 data-id="heading-6">实战案例：完整的数据分析 Agent</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> anthropic
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataAnalysisAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.client = anthropic.Anthropic()
        self.tools = self._define_tools()
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_define_tools</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> [
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"execute_python"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行 Python 代码进行数据处理和分析"</span>,
                <span class="hljs-string">"input_schema"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                    <span class="hljs-string">"properties"</span>: {
                        <span class="hljs-string">"code"</span>: {
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                            <span class="hljs-string">"description"</span>: <span class="hljs-string">"Python 代码（可导入 pandas, numpy, matplotlib）"</span>
                        }
                    },
                    <span class="hljs-string">"required"</span>: [<span class="hljs-string">"code"</span>]
                }
            },
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"read_file"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"读取文件内容"</span>,
                <span class="hljs-string">"input_schema"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                    <span class="hljs-string">"properties"</span>: {
                        <span class="hljs-string">"path"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"文件路径"</span>}
                    },
                    <span class="hljs-string">"required"</span>: [<span class="hljs-string">"path"</span>]
                }
            },
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"列出目录中的文件"</span>,
                <span class="hljs-string">"input_schema"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                    <span class="hljs-string">"properties"</span>: {
                        <span class="hljs-string">"directory"</span>: {
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                            <span class="hljs-string">"description"</span>: <span class="hljs-string">"目录路径，默认当前目录"</span>,
                            <span class="hljs-string">"default"</span>: <span class="hljs-string">"."</span>
                        }
                    }
                }
            }
        ]
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_execute_tool</span>(<span class="hljs-params">self, tool_name: <span class="hljs-built_in">str</span>, tool_input: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行工具"""</span>
        <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">"execute_python"</span>:
            <span class="hljs-comment"># 预配置 imports</span>
            code = <span class="hljs-string">f"""
import pandas as pd
import numpy as np
import json

<span class="hljs-subst">{tool_input[<span class="hljs-string">'code'</span>]}</span>
"""</span>
            <span class="hljs-keyword">try</span>:
                result = subprocess.run(
                    [<span class="hljs-string">"python"</span>, <span class="hljs-string">"-c"</span>, code],
                    capture_output=<span class="hljs-literal">True</span>,
                    text=<span class="hljs-literal">True</span>,
                    timeout=<span class="hljs-number">30</span>,
                    cwd=os.getcwd()
                )
                <span class="hljs-keyword">if</span> result.returncode != <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"执行错误:\n<span class="hljs-subst">{result.stderr}</span>"</span>
                <span class="hljs-keyword">return</span> result.stdout <span class="hljs-keyword">or</span> <span class="hljs-string">"（无输出）"</span>
            <span class="hljs-keyword">except</span> subprocess.TimeoutExpired:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"错误: 执行超时"</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
      
        <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"read_file"</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(tool_input[<span class="hljs-string">"path"</span>], <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                    content = f.read()
                    <span class="hljs-comment"># 限制输出长度</span>
                    <span class="hljs-keyword">return</span> content[:<span class="hljs-number">5000</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(content) &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">else</span> content
            <span class="hljs-keyword">except</span> FileNotFoundError:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"文件不存在: <span class="hljs-subst">{tool_input[<span class="hljs-string">'path'</span>]}</span>"</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"读取错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
      
        <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"list_files"</span>:
            <span class="hljs-keyword">try</span>:
                directory = tool_input.get(<span class="hljs-string">"directory"</span>, <span class="hljs-string">"."</span>)
                files = os.listdir(directory)
                <span class="hljs-keyword">return</span> json.dumps(files, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"列表错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
      
        <span class="hljs-keyword">return</span> <span class="hljs-string">"未知工具"</span>
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, user_task: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""运行 Agent"""</span>
        messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_task}]
      
        iteration = <span class="hljs-number">0</span>
        max_iterations = <span class="hljs-number">10</span>
      
        <span class="hljs-keyword">while</span> iteration &lt; max_iterations:
            iteration += <span class="hljs-number">1</span>
          
            response = self.client.messages.create(
                model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
                max_tokens=<span class="hljs-number">4096</span>,
                tools=self.tools,
                messages=messages
            )
          
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 迭代 <span class="hljs-subst">{iteration}</span> ---"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"停止原因: <span class="hljs-subst">{response.stop_reason}</span>"</span>)
          
            <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"end_turn"</span>:
                <span class="hljs-comment"># Agent 完成</span>
                final_text = <span class="hljs-built_in">next</span>(
                    (b.text <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> response.content <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(b, <span class="hljs-string">"text"</span>)),
                    <span class="hljs-literal">None</span>
                )
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✓ Agent 完成响应:\n<span class="hljs-subst">{final_text}</span>"</span>)
                <span class="hljs-keyword">return</span> final_text
          
            <span class="hljs-keyword">elif</span> response.stop_reason == <span class="hljs-string">"tool_use"</span>:
                <span class="hljs-comment"># 添加 Assistant 消息</span>
                messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response.content})
              
                <span class="hljs-comment"># 执行所有工具调用</span>
                tool_results = []
                <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
                    <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  → 调用工具: <span class="hljs-subst">{block.name}</span>"</span>)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    参数: <span class="hljs-subst">{json.dumps(block.<span class="hljs-built_in">input</span>, ensure_ascii=<span class="hljs-literal">False</span>)}</span>"</span>)
                      
                        result = self._execute_tool(block.name, block.<span class="hljs-built_in">input</span>)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    结果: <span class="hljs-subst">{result[:<span class="hljs-number">200</span>]}</span>..."</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result) &gt; <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> <span class="hljs-string">f"    结果: <span class="hljs-subst">{result}</span>"</span>)
                      
                        tool_results.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_result"</span>,
                            <span class="hljs-string">"tool_use_id"</span>: block.<span class="hljs-built_in">id</span>,
                            <span class="hljs-string">"content"</span>: result
                        })
              
                messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: tool_results})
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"意外的停止原因: <span class="hljs-subst">{response.stop_reason}</span>"</span>)
                <span class="hljs-keyword">break</span>
      
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✗ 超过最大迭代次数 (<span class="hljs-subst">{max_iterations}</span>)"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    agent = DataAnalysisAgent()
  
    task = <span class="hljs-string">"""
    1. 列出当前目录的文件
    2. 如果存在 sales.csv，读取前10行
    3. 计算该文件中销售额的总和、平均值和最大值
    4. 生成一份简要报告
    """</span>
  
    agent.run(task)
</code></pre>
<hr/>
<h3 data-id="heading-7">工具定义最佳实践</h3>



































<table><thead><tr><th>维度</th><th>最佳实践</th><th>反面示例</th></tr></thead><tbody><tr><td><strong>描述清晰度</strong></td><td>"执行 Python 代码进行数据处理"</td><td>"运行代码"</td></tr><tr><td><strong>参数验证</strong></td><td>使用<code>required</code> 数组明确必填项</td><td>依赖可选参数</td></tr><tr><td><strong>输出限制</strong></td><td>返回不超过 10000 字符的结果</td><td>返回大型数据集</td></tr><tr><td><strong>错误处理</strong></td><td>返回结构化错误信息</td><td>不处理异常</td></tr><tr><td><strong>命名规范</strong></td><td>snake_case（execute_python）</td><td>混合大小写</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">关键注意事项</h3>
<h4 data-id="heading-9">安全隔离</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ✓ 推荐：使用 subprocess 隔离执行环境</span>
subprocess.run(
    [<span class="hljs-string">"python"</span>, <span class="hljs-string">"-c"</span>, code],
    capture_output=<span class="hljs-literal">True</span>,
    timeout=<span class="hljs-number">30</span>
)

<span class="hljs-comment"># ✗ 避免：直接 exec/eval</span>
<span class="hljs-built_in">exec</span>(code)  <span class="hljs-comment"># 危险！</span>
</code></pre>
<h4 data-id="heading-10">成本控制</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 限制单次请求的 token 数</span>
response = client.messages.create(
    model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
    max_tokens=<span class="hljs-number">2048</span>,  <span class="hljs-comment"># 设置合理上限</span>
    tools=tools,
    messages=messages
)

<span class="hljs-comment"># 限制迭代次数</span>
<span class="hljs-keyword">for</span> iteration <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):  <span class="hljs-comment"># 最多10轮</span>
    <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"end_turn"</span>:
        <span class="hljs-keyword">break</span>
</code></pre>
<h4 data-id="heading-11">结果验证</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 验证工具结果的有效性</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tool_result) &gt; <span class="hljs-number">50000</span>:
    tool_result = tool_result[:<span class="hljs-number">50000</span>] + <span class="hljs-string">"\n[输出已截断]"</span>

<span class="hljs-comment"># 捕获所有异常</span>
<span class="hljs-keyword">try</span>:
    result = execute_tool(tool_name, tool_input)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    result = <span class="hljs-string">f"工具执行失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
</code></pre>
<hr/>
<p>Agent Skills 的核心在于<strong>明确的工具定义</strong> + <strong>完善的错误处理</strong> + <strong>高效的循环管理</strong>。遵循上述模式可快速构建可靠的自动化工作流。</p>
<blockquote>
<p>博主的个人网站接入了claude haiku 4.5模型，欢迎访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmicefind.com" target="_blank" title="https://micefind.com" ref="nofollow noopener noreferrer">micefind.com</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[正则表达式应用-手机号打码]]></title>    <link>https://juejin.cn/post/7587238733503119403</link>    <guid>https://juejin.cn/post/7587238733503119403</guid>    <pubDate>2025-12-24T07:39:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587238733503119403" data-draft-id="7587046913692106758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="正则表达式应用-手机号打码"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-24T07:39:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="豚踢兔x"/> <meta itemprop="url" content="https://juejin.cn/user/1461712635573371"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            正则表达式应用-手机号打码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1461712635573371/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    豚踢兔x
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:39:03.000Z" title="Wed Dec 24 2025 07:39:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. matchces函数的使用方法</h2>
<p><strong>（一）matchs方法</strong>
正则表达式对象有matches方法，它的作用是验证给定的字符串是否满足正则表达式的要求。它的格式如下：</p>
<p>val 结果 = 正则.matches(目标字符串)
其中的结果是一个bool值。</p>
<h4 data-id="heading-1"><strong>【例】</strong>：</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> scala.util.matching.<span class="hljs-type">Regex</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">RegexDemo</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]) {

        <span class="hljs-keyword">val</span> reg1 = <span class="hljs-string">"\\d{3}"</span>.r

        println(reg1.matches(<span class="hljs-string">"123"</span>)) <span class="hljs-comment">// true</span>

        println(reg1.matches(<span class="hljs-string">"12a"</span>)) <span class="hljs-comment">// false</span>

    }

}
</code></pre>
<h2 data-id="heading-2">2. replaceAllIn的使用方法</h2>
<p><strong>（三）replaceAllin正则替换</strong></p>
<p><strong>功能</strong>：对目标字符中的内容，进行正则查找，对找到的内容使用指定的内容进行替换，并返回替换之后的字符串。</p>
<p><strong>格式</strong>：正则.replaceAll(目标字符串, 匹配到的内容 =&gt; 要替换的内容 )</p>
<p><strong>【示例】</strong>：把目标字符串中的字符BC换成01。</p>
<p>("bc".r).replaceAll("abcdabcd" =&gt; m =&gt; "01" )</p>
<h4 data-id="heading-3"><strong>案例-手机号打码</strong></h4>
<p><strong>用到的方法是：正则匹配分组 + replaceAllIn。</strong></p>
<p><strong>案例文件如下</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7d804bee49407690b20bbe818343a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=FFyx8P3r%2B9oFN95w8N%2BWLPCCh4o%3D" alt="屏幕截图 2025-12-24 151523.png" loading="lazy"/></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> reg

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg04</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1.从根目录下读出address,txt 的内容</span>
    <span class="hljs-keyword">val</span> content = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString

    println(<span class="hljs-string">"读到的文件内容如下："</span>)
    println(content)
    <span class="hljs-comment">// 2. 找到其中的合法手机号，把中间4位（3-4-4）用*代替</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"1[031902]\d{9}"</span>.r

<span class="hljs-comment">//    println("找到的合法手机号如下：")</span>
<span class="hljs-comment">//    reg.findAllIn(content).foreach(ele=&gt;println(ele))</span>

    <span class="hljs-comment">// 在content中，把所有通过正则找到的内容，换成"abc"</span>
<span class="hljs-comment">//    reg.replaceAllIn(content, ele =&gt; "abc")</span>
    <span class="hljs-keyword">val</span> newContent = reg.replaceAllIn(content,ele =&gt;{
      <span class="hljs-keyword">val</span> phone = ele.toString()
      println(ele)
      <span class="hljs-string">"abc"</span>
<span class="hljs-comment">//      "手机号前3位" +"****"+ "手机号后四位"</span>
      phone.substring(<span class="hljs-number">0</span> ,<span class="hljs-number">3</span>) + <span class="hljs-string">"****"</span> + phone.substring(<span class="hljs-number">7</span>)
    })
    println(<span class="hljs-string">"替换后的内容如下："</span>)
    println(newContent)

    <span class="hljs-comment">// 3.把结果写入到address_new.txt文件中</span>
    <span class="hljs-keyword">val</span> fileWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">FileWriter</span>(<span class="hljs-string">"address_new.txt"</span>)
    fileWriter.write(newContent)
    fileWriter.close()
  }

}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97291b69ab3e4dee9b977c2b166f32d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=8t385NMzQEitPe3qc333vW%2Bs%2Fes%3D" alt="屏幕截图 2025-12-24 152743.png" loading="lazy"/></p>
<h5 data-id="heading-4"><strong>以下为添加了group版：</strong></h5>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> reg

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg06</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1.从根目录下读出address,txt 的内容</span>
    <span class="hljs-keyword">val</span> content = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString

    println(<span class="hljs-string">"读到的文件内容如下："</span>)
    println(content)
    <span class="hljs-comment">// 2. 找到其中的合法手机号，把中间4位（3-4-4）用*代替</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"(1[031902]\d\d)(\d{4})(\d{3})"</span>.r

<span class="hljs-comment">//    println("找到的合法手机号如下：")</span>
<span class="hljs-comment">//    reg.findAllIn(content).foreach(ele=&gt;println(ele))</span>

    <span class="hljs-comment">// 在content中，把所有通过正则找到的内容，换成"abc"</span>
<span class="hljs-comment">//    reg.replaceAllIn(content, ele =&gt; "abc")</span>
    <span class="hljs-keyword">val</span> newContent = reg.replaceAllIn(content,ele =&gt;{
      println(ele.group(<span class="hljs-number">0</span>))
      println(ele.group(<span class="hljs-number">1</span>))
      println(ele.group(<span class="hljs-number">2</span>))
      println(ele.group(<span class="hljs-number">3</span>))

<span class="hljs-comment">//      val phone = ele.toString()</span>
<span class="hljs-comment">//      println(ele)</span>
<span class="hljs-comment">//      "abc"</span>
<span class="hljs-comment">//      "手机号前3位" +"****"+ "手机号后四位"</span>
<span class="hljs-comment">//      phone.substring(0 ,3) + "****" + phone.substring(7)</span>
      ele.group(<span class="hljs-number">1</span>) + <span class="hljs-string">"-****-"</span> + ele.group(<span class="hljs-number">3</span>)
    })
    println(<span class="hljs-string">"替换后的内容如下："</span>)
    println(newContent)

    <span class="hljs-comment">// 3.把结果写入到address_new.txt文件中</span>
    <span class="hljs-keyword">val</span> fileWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">FileWriter</span>(<span class="hljs-string">"address_new.txt"</span>)
    fileWriter.write(newContent)
    fileWriter.close()
  }
}
</code></pre>
<h6 data-id="heading-5">注：</h6>
<p><strong>（）：是分组</strong></p>
<p><strong>println(ele.group(0/1/2/3...))固定表示匹配到的全部内容</strong></p>
<p><strong>括号里的数字（1,2,3）顺序对应着正则表达式中，（）包含的内容</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02452c3029ee4b0fbc28cd8d9a1980e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=ip4s2P4E%2Bq35H7xgtEDTeDMjX9g%3D" alt="屏幕截图 2025-12-24 155407.png" loading="lazy"/></p>
<p><strong>这里的group是分组的意思，它与正则表达式中的()是一一对应的。</strong></p>
<h2 data-id="heading-6">3. 正则表达式的应用</h2>
<h5 data-id="heading-7"><strong>以下是把文件中的内容换成‘abc’</strong>：</h5>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> reg

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg05</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1.从根目录下读出address,txt 的内容</span>
    <span class="hljs-keyword">val</span> content = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString

    println(<span class="hljs-string">"读到的文件内容如下："</span>)
    println(content)
    <span class="hljs-comment">// 2. 找到其中的合法手机号，把中间4位（3-4-4）用*代替</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"1[031902]\d{9}"</span>.r

<span class="hljs-comment">//    println("找到的合法手机号如下：")</span>
<span class="hljs-comment">//    reg.findAllIn(content).foreach(ele=&gt;println(ele))</span>

    <span class="hljs-comment">// 在content中，把所有通过正则找到的内容，换成"abc"</span>
    reg.replaceAllIn(content, ele =&gt; <span class="hljs-string">"abc"</span>)
    <span class="hljs-keyword">val</span> newContent = reg.replaceAllIn(content,ele =&gt;{
      println(ele)
     <span class="hljs-string">"abc"</span>
<span class="hljs-comment">//      "手机号前3位" +"****"+ "手机号后四位"</span>
    })
    println(<span class="hljs-string">"替换后的内容如下："</span>)
    println(newContent)

    <span class="hljs-comment">// 3.把结果写入到address_new.txt文件中</span>
  }

}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddec664791914a699ff25215e9e3bd80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=utUC2OWA%2FUkI1owJ9s28%2F98lqJM%3D" alt="屏幕截图 2025-12-24 153220.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android perfetto - 记录分析memory]]></title>    <link>https://juejin.cn/post/7587062584164532262</link>    <guid>https://juejin.cn/post/7587062584164532262</guid>    <pubDate>2025-12-24T07:41:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587062584164532262" data-draft-id="7587062584164483110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android perfetto - 记录分析memory"/> <meta itemprop="keywords" content="Android,性能优化"/> <meta itemprop="datePublished" content="2025-12-24T07:41:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="为码消得人憔悴"/> <meta itemprop="url" content="https://juejin.cn/user/3104676567333949"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android perfetto - 记录分析memory
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676567333949/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    为码消得人憔悴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:41:40.000Z" title="Wed Dec 24 2025 07:41:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、简介</h2>
<p><a href="https://juejin.cn/post/7582846276506157094" target="_blank" title="https://juejin.cn/post/7582846276506157094"><strong>Android perfetto - Perfetto 新手入门指南</strong></a>中初步介绍了Perfetto 是一个强大的性能分析工具，能够帮助开发者捕捉、分析 Android 系统和应用的性能数据。<a href="https://juejin.cn/post/7582791876365991974" target="_blank" title="https://juejin.cn/post/7582791876365991974"><strong>Android perfetto - 什么是 Tracing</strong></a>又介绍了Tracing和Profiling的区别，这篇文档将从分析内存的角度，以memory profiling为切入点展示如何使用 Perfetto 记录和分析内存使用情况。</p>
<h3 data-id="heading-1">2、<strong>内存分析概述</strong></h3>
<p>在 Android 应用中，内存的使用主要涉及两个方面：</p>
<ol>
<li><strong>Native C/C++/Rust 进程</strong>：通常通过 libc 的<code>malloc/free</code>（或者 C++ 的<code>new/delete</code>等包装函数）来分配内存。请注意，即使使用 Java API（通过 JNI 相关函数实现），也可能进行原生内存分配。一个典型的例子是<code>java.util.regex.Pattern</code>，它通常同时拥有 Java 堆内存和原生内存，因为底层使用了原生正则表达式库。</li>
<li><strong>Java/KT 应用</strong>：应用的内存占用的很大一部分存储在管理堆中（在 Android 中由 ART 的垃圾回收器管理）。这是每个<code>new X()</code> 对象所在的地方。</li>
</ol>
<p>Perfetto 提供两种互补的内存分析方式：</p>
<ol>
<li><strong>heap profiling</strong>原生堆分析：通过采样<code>malloc/free</code> 调用的调用栈，生成内存使用的火焰图，帮助诊断内存泄漏和优化内存分配。</li>
<li><strong>heap dumps</strong> Java 堆转储：生成堆保留图，分析 Java 对象的生命周期和内存保留链，帮助发现内存泄漏和无用对象的持有。</li>
</ol>
<h3 data-id="heading-2">3、<strong>Perfetto 内存分析模式</strong></h3>
<h4 data-id="heading-3">3.1、<strong>原生堆分析</strong>Native (C/C++/Rust) Heap Profiling</h4>
<p>原生语言（如 C/C++/Rust）通常通过 <code>malloc/free</code> 等函数进行内存分配。Perfetto 在 Android 和 Linux 系统上拦截这些函数的调用，通过采样内存分配时的调用栈来追踪每个内存分配的位置。此分析可以帮助您了解哪些函数导致了大量的内存分配，或者是否存在未释放的内存（即内存泄漏）。</p>
<ul>
<li><strong>支持的平台</strong>：仅支持 Android 和 Linux，因其依赖于拦截<code>malloc/free</code> 函数。</li>
<li><strong>工作原理</strong>：通过采样<code>malloc</code>和<code>free</code> 的调用栈，Perfetto 能够追踪内存分配的来源。</li>
<li><strong>注意事项</strong>：堆分析是非追溯性的，只能记录追踪开始后的内存分配，无法提供启动前的内存使用情况。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d1ac2c7f84b4df7abacd12ec5d5b5bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Li656CB5raI5b6X5Lq65oaU5oK0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166900&amp;x-signature=F14XAzFFvyfPLhr5BH6rGvMgCB8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">3.2、<strong>Java 堆转储</strong>Java/Managed Heap Dumps</h4>
<p>对于 Java 和 Kotlin 应用，Perfetto 可以创建堆转储，分析对象的生命周期和引用关系。堆转储提供了 Java 堆的详细快照，帮助开发者发现内存泄漏和不必要的对象引用。</p>
<ul>
<li><strong>支持的功能</strong>：通过分析对象之间的引用链，Perfetto 可以生成内存保留图，帮助分析哪些对象被长期持有。</li>
<li><strong>注意事项</strong>：堆转储分析不提供调用栈信息，因此不适合用于追踪原生代码的内存分配情况。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5ddde1df3184e01aec11ea75563dcd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Li656CB5raI5b6X5Lq65oaU5oK0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166900&amp;x-signature=jNbU%2BiOB2Ur4yBbGJ%2FmSewPU1f4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">3.3、如何抓取</h4>
<p>参考Android perfetto - Perfetto 新手入门指南 中介绍的抓取方法，在config中添加面配置即可</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"android.heapprofd"</span>
    <span class="hljs-string">heapprofd_config</span> {
      <span class="hljs-attr">sampling_interval_bytes:</span> <span class="hljs-number">4096</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"system_server"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.android.systemui"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.example.myapplication"</span><span class="hljs-string">//改成自己的进程名字即可</span>
      <span class="hljs-string">continuous_dump_config</span> {
        <span class="hljs-attr">dump_phase_ms:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">dump_interval_ms:</span> <span class="hljs-number">1000</span>
      }
      <span class="hljs-attr">shmem_size_bytes:</span> <span class="hljs-number">8388608</span>
      <span class="hljs-attr">block_client:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">all_heaps:</span> <span class="hljs-literal">true</span>
    }
  }
}

<span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"android.java_hprof"</span>
    <span class="hljs-string">java_hprof_config</span> {
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"system_server"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.android.systemui"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.example.myapplication"</span><span class="hljs-string">//改成自己的进程名字即可</span>
      <span class="hljs-attr">dump_smaps:</span> <span class="hljs-literal">true</span>
      <span class="hljs-string">continuous_dump_config</span> {
        <span class="hljs-attr">dump_phase_ms:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">dump_interval_ms:</span> <span class="hljs-number">1000</span>
      }
    }
  }
}
</code></pre>
<p>抓取要求：</p>
<ul>
<li>在<strong>用户版本（user）上，只有标记为</strong>profileable或<strong>debuggable</strong> 的应用才能进行内存分析。</li>
<li>在<strong>userdebug 版本</strong> 上，所有应用（除了少数关键服务）都可以被分析。</li>
<li>可以通过禁用 SELinux 或使用<code>--disable-selinux</code> 参数解除分析限制。</li>
<li>要标记应用为可分析，只需在应用的清单文件中添加<code>&lt;profileable android:shell="true"/&gt;</code>。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">...</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profileable</span> <span class="hljs-attr">android:shell</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">4、参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling" ref="nofollow noopener noreferrer">perfetto.dev/docs/gettin…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fcase-studies%2Fmemory" target="_blank" title="https://perfetto.dev/docs/case-studies/memory" ref="nofollow noopener noreferrer">perfetto.dev/docs/case-s…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fnative-heap-profiler" target="_blank" title="https://perfetto.dev/docs/data-sources/native-heap-profiler" ref="nofollow noopener noreferrer">perfetto.dev/docs/data-s…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fjava-heap-profiler" target="_blank" title="https://perfetto.dev/docs/data-sources/java-heap-profiler" ref="nofollow noopener noreferrer">perfetto.dev/docs/data-s…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ERC-4337 落地场景全盘点：游戏、DAO、DeFi 的下一个爆发点]]></title>    <link>https://juejin.cn/post/7587284708943691810</link>    <guid>https://juejin.cn/post/7587284708943691810</guid>    <pubDate>2025-12-24T08:00:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708943691810" data-draft-id="7587046913691795462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ERC-4337 落地场景全盘点：游戏、DAO、DeFi 的下一个爆发点"/> <meta itemprop="keywords" content="智能合约,Solidity,web3"/> <meta itemprop="datePublished" content="2025-12-24T08:00:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ERC-4337 落地场景全盘点：游戏、DAO、DeFi 的下一个爆发点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:00:53.000Z" title="Wed Dec 24 2025 08:00:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>本文围绕ERC-4337标准展开全面梳理，先系统解析其核心内容，涵盖概念定义、核心价值、组件构成、工作流程、特性优势及当前面临的挑战与发展现状，构建起清晰的理论认知框架；再聚焦实践落地，基于OpenZeppelin与account-abstraction工具，完整实现ERC-4337钱包开发，并详细拆解从开发搭建、测试验证到部署上线的全流程，形成“理论梳理+实践落地”的完整内容体系，为ERC-4337标准的学习与应用提供兼具系统性与可操作性的参考。</p>
</blockquote>
<h2 data-id="heading-1">概述</h2>
<p>ERC4337（Account Abstraction）是以太坊的账户抽象标准，旨在<strong>消除外部账户（EOA）与合约账户的界限</strong>。用户可通过智能合约自定义账户逻辑，实现社交恢复、代付Gas、批量交易等高级功能，而无需修改以太坊共识层;</p>
<p><strong>核心价值</strong>：保留EOA的简单性，同时赋予合约账户的灵活性，显著提升Web3用户体验。</p>
<h2 data-id="heading-2">核心组件架构</h2>
<h4 data-id="heading-3">1. <strong>UserOperation（用户操作）</strong></h4>
<ul>
<li><strong>定义</strong>：伪交易对象，代表用户意图，包含目标调用、验证元数据、Gas参数等信息</li>
<li><strong>特点</strong>：不直接发送到链上，而是提交至独立的 <code>alt-mempool</code>（替代内存池）</li>
</ul>
<h4 data-id="heading-4">2. <strong>智能合约账户（Smart Contract Account）</strong></h4>
<ul>
<li><strong>角色</strong>：用户控制的代理钱包，作为身份主体</li>
<li><strong>功能</strong>：通过 <code>validateUserOp()</code> 验证签名，通过 <code>executeUserOp()</code> 执行交易</li>
<li><strong>优势</strong>：可编程化，支持自定义规则（如多重签名、限额控制）</li>
</ul>
<h4 data-id="heading-5">3. <strong>Bundler（打包器）</strong></h4>
<ul>
<li><strong>作用</strong>：链下服务，监听 <code>alt-mempool</code> 中的 UserOperations</li>
<li><strong>流程</strong>：批量打包多个操作，通过一个交易提交至 <code>EntryPoint</code> 合约</li>
<li><strong>经济性</strong>：由Bundler预付Gas，后续从EntryPoint获得补偿</li>
</ul>
<h4 data-id="heading-6">4. <strong>EntryPoint（入口合约）</strong></h4>
<ul>
<li>
<p><strong>地位</strong>：ERC4337的核心链上网关</p>
</li>
<li>
<p><strong>职责</strong>：</p>
<ul>
<li>验证每个UserOperation的有效性</li>
<li>路由至对应智能合约钱包执行</li>
<li>计算总Gas消耗并补偿Bundler</li>
</ul>
</li>
<li>
<p><strong>关键</strong>：所有Gas支付通过此合约完成（从用户存款或Paymaster）</p>
</li>
</ul>
<h4 data-id="heading-7">5. <strong>Paymaster（支付主）</strong></h4>
<ul>
<li>
<p><strong>定位</strong>：可选的智能合约，提供灵活Gas支付方案</p>
</li>
<li>
<p><strong>两种模式</strong>：</p>
<ul>
<li><strong>赞助模式</strong>：项目方/第三方直接代付Gas</li>
<li><strong>代币模式</strong>：允许用户用ERC-20代币（如USDT）而非ETH支付Gas</li>
</ul>
</li>
<li>
<p><strong>接口</strong>：<code>validatePaymasterUserOp()</code> 验证资格，<code>postOp()</code> 处理后续结算</p>
</li>
</ul>
<h2 data-id="heading-8">标准工作流程</h2>
<p><strong>详细步骤</strong></p>
<ol>
<li><strong>签名生成</strong>：用户使用私钥对操作签名（兼容ERC-191/ERC-712）</li>
<li><strong>内存池广播</strong>：UserOperation进入链下<code>alt-mempool</code></li>
<li><strong>Bundler聚合</strong>：Bundler收集多个操作，创建批量交易</li>
<li><strong>EntryPoint处理</strong>：验证签名、检查Nonce、执行调用、计算Gas</li>
<li><strong>费用结算</strong>：从用户账户存款或Paymaster扣除Gas费，补偿Bundler</li>
</ol>
<h2 data-id="heading-9">关键特性与优势</h2>



































<table><thead><tr><th>特性</th><th>说明</th><th>价值</th></tr></thead><tbody><tr><td><strong>社交恢复</strong></td><td>通过守护人机制重置私钥</td><td>解决私钥丢失问题</td></tr><tr><td><strong>无Gas交易</strong></td><td>Paymaster代付或ERC-20支付</td><td>降低新用户门槛</td></tr><tr><td><strong>批量操作</strong></td><td>单次签名执行多笔调用</td><td>提升操作效率</td></tr><tr><td><strong>可编程权限</strong></td><td>自定义验证逻辑（如多签、限额）</td><td>增强安全性与灵活性</td></tr><tr><td><strong>确定性地址</strong></td><td>代理钱包地址跨网络一致</td><td>类似EOA的用户体验</td></tr></tbody></table>
<h2 data-id="heading-10">当前挑战与现状</h2>
<ul>
<li><strong>采用进展</strong>：核心合约已就绪，多个团队正推出生产级原生钱包</li>
<li><strong>架构局限</strong>：虽改善用户体验，但仍依赖链下Bundler与独立内存池，面临去中心化与普及挑战</li>
<li><strong>意图层（Intent-centric）融合</strong>：ERC4337为意图驱动架构提供基础，但纯意图模式仍需深度整合Paymaster与跨链设计</li>
</ul>
<h2 data-id="heading-11">一句总结</h2>
<p>ERC4337通过链下打包+链上验证的架构，在不修改以太坊协议的前提下实现账户抽象，是智能合约钱包普及的关键基础设施。</p>
<h2 data-id="heading-12">智能合约开发、测试、部署</h2>
<h5 data-id="heading-13"><strong>智能合约</strong></h5>
<h5 data-id="heading-14">1.治理代币合约</h5>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span>.<span class="hljs-number">24</span>;

import {BaseAccount} <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/core/BaseAccount.sol"</span>;
import {IEntryPoint} <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/interfaces/IEntryPoint.sol"</span>;
import {PackedUserOperation} <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/interfaces/PackedUserOperation.sol"</span>;
import {Ownable} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/access/Ownable.sol"</span>;
import {Initializable} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/proxy/utils/Initializable.sol"</span>;
import {UUPSUpgradeable} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/proxy/utils/UUPSUpgradeable.sol"</span>;
import {IERC1271} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/interfaces/IERC1271.sol"</span>;
import {ECDSA} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/ECDSA.sol"</span>;
import {MessageHashUtils} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol"</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@title</span> MySmartAccount
 * <span class="hljs-doctag">@dev</span> ✅ 基于 <span class="hljs-doctag">@account</span>-abstraction/contracts 0.7.0 的标准实现
 */</span>
contract MySmartAccount is BaseAccount, Ownable, Initializable, UUPSUpgradeable, IERC1271 {
    using MessageHashUtils <span class="hljs-keyword">for</span> bytes32;
    
    bytes4 <span class="hljs-keyword">private</span> constant EIP1271_MAGIC_VALUE = <span class="hljs-number">0x1626ba7e</span>;
    
    <span class="hljs-comment">// ✅ 存储 EntryPoint 地址（避免与函数名冲突）</span>
    IEntryPoint <span class="hljs-keyword">private</span> immutable _ACCOUNT_ENTRY_POINT;
    
    <span class="hljs-comment">// 事件</span>
    event <span class="hljs-title function_ invoke__">TransactionExecuted</span>(address indexed target, uint256 value, bytes data);
    event <span class="hljs-title function_ invoke__">BatchExecuted</span>(address[] targets, uint256[] values, bytes[] datas);

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 修正：构造函数参数名加下划线，避免与函数冲突
     * <span class="hljs-doctag">@param</span> entryPoint_ ERC-4337 EntryPoint 地址
     * <span class="hljs-doctag">@param</span> initialOwner 初始所有者地址
     */</span>
    <span class="hljs-title function_ invoke__">constructor</span>(
        IEntryPoint entryPoint_,
        address initialOwner
    ) 
        <span class="hljs-title function_ invoke__">BaseAccount</span>()                  <span class="hljs-comment">// ✅ BaseAccount 构造函数无参数</span>
        <span class="hljs-title function_ invoke__">Ownable</span>(initialOwner)          <span class="hljs-comment">// ✅ OpenZeppelin 5.x Ownable 需要 initialOwner</span>
    {
        _ACCOUNT_ENTRY_POINT = entryPoint_;  <span class="hljs-comment">// ✅ 存储到自定义变量</span>
        <span class="hljs-title function_ invoke__">_disableInitializers</span>();
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 覆盖 entryPoint() 函数，返回存储的 EntryPoint
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">entryPoint</span>(<span class="hljs-params"/>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">IEntryPoint</span>) </span>{
        <span class="hljs-keyword">return</span> _ACCOUNT_ENTRY_POINT;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 初始化函数，会覆盖 Ownable 的初始所有者
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initialize</span>(<span class="hljs-params">address initialOwner</span>) <span class="hljs-title">public</span> <span class="hljs-title">virtual</span> <span class="hljs-title">initializer</span> </span>{
        <span class="hljs-title function_ invoke__">_transferOwnership</span>(initialOwner);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 实现 BaseAccount 的抽象函数：_validateSignature（内部函数）
     * <span class="hljs-doctag">@notice</span> 在 v0.7.0 中，BaseAccount 同时要求 _validateSignature 和 validateUserOp
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_validateSignature</span>(<span class="hljs-params">
        PackedUserOperation calldata userOp,
        bytes32 userOpHash
    </span>) <span class="hljs-title">internal</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256 validationData</span>) </span>{
        <span class="hljs-comment">// 检查签名长度</span>
        <span class="hljs-keyword">if</span> (userOp.signature.length != <span class="hljs-number">65</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// SIG_VALIDATION_FAILED</span>
        }
        
        <span class="hljs-comment">// ✅ 直接传入完整的 signature bytes，ECDSA.recover 会自动解析</span>
        <span class="hljs-comment">// 注意：userOp.signature 是 bytes calldata，可以直接传给 recover</span>
        bytes32 ethHash = userOpHash.<span class="hljs-title function_ invoke__">toEthSignedMessageHash</span>();
        address signer = ECDSA.<span class="hljs-title function_ invoke__">recover</span>(ethHash, userOp.signature);
        
        <span class="hljs-comment">// 验证签名者是否为所有者</span>
        <span class="hljs-keyword">if</span> (signer != <span class="hljs-title function_ invoke__">owner</span>()) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 验证成功</span>
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 实现 BaseAccount 的 validateUserOp 外部函数
     * <span class="hljs-doctag">@notice</span> v0.7.0 要求实现此函数，处理 missingAccountFunds
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateUserOp</span>(<span class="hljs-params">
        PackedUserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 missingAccountFunds
    </span>) <span class="hljs-title">external</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256 validationData</span>) </span>{
        <span class="hljs-comment">// 验证调用者是 EntryPoint</span>
        <span class="hljs-keyword">require</span>(msg.sender == <span class="hljs-title function_ invoke__">address</span>(<span class="hljs-title function_ invoke__">entryPoint</span>()), <span class="hljs-string">"account: not from EntryPoint"</span>);
        
        <span class="hljs-comment">// 调用内部签名验证</span>
        validationData = <span class="hljs-title function_ invoke__">_validateSignature</span>(userOp, userOpHash);
        
        <span class="hljs-comment">// 支付 missingAccountFunds 给 EntryPoint</span>
        <span class="hljs-keyword">if</span> (missingAccountFunds &gt; <span class="hljs-number">0</span>) {
            (<span class="hljs-keyword">bool</span> success,) = <span class="hljs-title function_ invoke__">payable</span>(msg.sender).call{value : missingAccountFunds, gas : <span class="hljs-title function_ invoke__">type</span>(uint256).max}(<span class="hljs-string">""</span>);
            (success); <span class="hljs-comment">// 忽略失败（这是 EntryPoint 的责任）</span>
        }
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 辅助函数：要求调用者是 EntryPoint 或所有者
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_requireFromEntryPointOrOwner</span>(<span class="hljs-params"/>) <span class="hljs-title">internal</span> <span class="hljs-title">view</span> </span>{
        <span class="hljs-keyword">require</span>(
            msg.sender == <span class="hljs-title function_ invoke__">address</span>(<span class="hljs-title function_ invoke__">entryPoint</span>()) || msg.sender == <span class="hljs-title function_ invoke__">owner</span>(),
            <span class="hljs-string">"account: not Owner or EntryPoint"</span>
        );
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 执行单笔交易
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params">
        address target,
        uint256 value,
        bytes calldata data
    </span>) <span class="hljs-title">external</span> <span class="hljs-title">payable</span> <span class="hljs-title">virtual</span> </span>{
        <span class="hljs-title function_ invoke__">_requireFromEntryPointOrOwner</span>();
        <span class="hljs-title function_ invoke__">_call</span>(target, value, data);
        emit <span class="hljs-title function_ invoke__">TransactionExecuted</span>(target, value, data);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 批量执行多笔交易
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">executeBatch</span>(<span class="hljs-params">
        address[] calldata targets,
        uint256[] calldata values,
        bytes[] calldata datas
    </span>) <span class="hljs-title">external</span> <span class="hljs-title">payable</span> <span class="hljs-title">virtual</span> </span>{
        <span class="hljs-title function_ invoke__">_requireFromEntryPointOrOwner</span>();
        <span class="hljs-keyword">require</span>(targets.length == datas.length &amp;&amp; targets.length == values.length, <span class="hljs-string">"Array length mismatch"</span>);
        
        <span class="hljs-keyword">for</span> (uint256 i = <span class="hljs-number">0</span>; i &lt; targets.length; i++) {
            <span class="hljs-title function_ invoke__">_call</span>(targets[i], values[i], datas[i]);
        }
        
        emit <span class="hljs-title function_ invoke__">BatchExecuted</span>(targets, values, datas);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 内部调用函数，处理执行结果
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_call</span>(<span class="hljs-params">address target, uint256 value, bytes memory data</span>) <span class="hljs-title">internal</span> </span>{
        (<span class="hljs-keyword">bool</span> success, bytes memory result) = target.call{value: value}(data);
        <span class="hljs-keyword">if</span> (!success) {
            assembly { <span class="hljs-title function_ invoke__">revert</span>(<span class="hljs-title function_ invoke__">add</span>(result, <span class="hljs-number">32</span>), <span class="hljs-title function_ invoke__">mload</span>(result)) }
        }
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ ERC-1271 签名验证实现
     * <span class="hljs-doctag">@notice</span> 对于 memory bytes，不能切片，只能检查长度
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidSignature</span>(<span class="hljs-params">
        bytes32 hash,
        bytes memory signature
    </span>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">bytes4 magicValue</span>) </span>{
        <span class="hljs-comment">// ✅ 检查 signature 长度是否符合 65 字节的 EIP-2098 标准</span>
        <span class="hljs-keyword">if</span> (signature.length != <span class="hljs-number">65</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0xffffffff</span>;
        }
        
        <span class="hljs-comment">// ✅ 直接传入完整的 signature，ECDSA.recover 会内部解析</span>
        bytes32 ethHash = hash.<span class="hljs-title function_ invoke__">toEthSignedMessageHash</span>();
        address signer = ECDSA.<span class="hljs-title function_ invoke__">recover</span>(ethHash, signature);
        
        <span class="hljs-keyword">if</span> (signer == <span class="hljs-title function_ invoke__">owner</span>()) {
            <span class="hljs-keyword">return</span> EIP1271_MAGIC_VALUE;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-number">0xffffffff</span>;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> UUPS 升级授权
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_authorizeUpgrade</span>(<span class="hljs-params">address newImplementation</span>) <span class="hljs-title">internal</span> <span class="hljs-title">override</span> <span class="hljs-title">onlyOwner</span> </span>{}

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 接收 ETH
     */</span>
    <span class="hljs-title function_ invoke__">receive</span>() external payable {}
}
</code></pre>
<h5 data-id="heading-15">2.治理代币合约</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;  <span class="hljs-comment">// ✅ 添加这一行</span>

<span class="hljs-keyword">import</span> {MySmartAccount} from <span class="hljs-string">"./MySmartAccount.sol"</span>;
<span class="hljs-keyword">import</span> {IEntryPoint} from <span class="hljs-string">"@account-abstraction/contracts/interfaces/IEntryPoint.sol"</span>;
<span class="hljs-keyword">import</span> {Create2} from <span class="hljs-string">"@openzeppelin/contracts/utils/Create2.sol"</span>;

contract MySmartAccountFactory {
    IEntryPoint <span class="hljs-keyword">private</span> immutable _entryPoint;
    
    event <span class="hljs-title function_">AccountCreated</span><span class="hljs-params">(address indexed account, address indexed owner)</span>;
    
    constructor(IEntryPoint entryPoint) {
        _entryPoint = entryPoint;
    }
    
    function <span class="hljs-title function_">createAccount</span><span class="hljs-params">(bytes32 salt, address owner)</span> external <span class="hljs-title function_">returns</span> <span class="hljs-params">(MySmartAccount account)</span> {
        <span class="hljs-type">address</span> <span class="hljs-variable">predictedAddress</span> <span class="hljs-operator">=</span> getAddress(salt, owner);
        
        <span class="hljs-keyword">if</span> (predictedAddress.code.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> MySmartAccount(payable(predictedAddress));
        }
        
        account = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySmartAccount</span>{salt: salt}(_entryPoint, owner);
        emit <span class="hljs-title function_">AccountCreated</span><span class="hljs-params">(address(account)</span>, owner);
    }
    
    function <span class="hljs-title function_">getAddress</span><span class="hljs-params">(bytes32 salt, address owner)</span> <span class="hljs-keyword">public</span> view <span class="hljs-title function_">returns</span> <span class="hljs-params">(address)</span> {
        <span class="hljs-type">bytes32</span> <span class="hljs-variable">bytecodeHash</span> <span class="hljs-operator">=</span> keccak256(
            abi.encodePacked(
                type(MySmartAccount).creationCode,
                abi.encode(_entryPoint, owner)  <span class="hljs-comment">// ✅ 匹配构造函数参数</span>
            )
        );
        
        <span class="hljs-keyword">return</span> Create2.computeAddress(salt, bytecodeHash, address(<span class="hljs-built_in">this</span>));
    }
}
</code></pre>
<h5 data-id="heading-16">3.治理代币合约</h5>
<pre><code class="hljs language-ini" lang="ini">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24<span class="hljs-comment">;</span>

import {BasePaymaster} from "@account-abstraction/contracts/core/BasePaymaster.sol"<span class="hljs-comment">;</span>
import {IEntryPoint} from "@account-abstraction/contracts/interfaces/IEntryPoint.sol"<span class="hljs-comment">;</span>
import {PackedUserOperation} from "@account-abstraction/contracts/interfaces/PackedUserOperation.sol"<span class="hljs-comment">;</span>
import {ECDSA} from "@openzeppelin/contracts/utils/cryptography/ECDSA.sol"<span class="hljs-comment">;</span>
import {MessageHashUtils} from "@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol"<span class="hljs-comment">;</span>

contract MyPaymaster is BasePaymaster {
    using MessageHashUtils for bytes32<span class="hljs-comment">;</span>
    
    mapping(<span class="hljs-attr">address</span> =&gt; bool) public whitelistedApps<span class="hljs-comment">;</span>
    mapping(<span class="hljs-attr">address</span> =&gt; uint256) public sponsoredTransactionCount<span class="hljs-comment">;</span>
    uint256 public <span class="hljs-attr">maxSponsoredTransactionsPerApp</span> = <span class="hljs-number">100</span><span class="hljs-comment">;</span>
    
    event AppWhitelisted(address indexed app)<span class="hljs-comment">;</span>
    event AppRemoved(address indexed app)<span class="hljs-comment">;</span>
    
    constructor(IEntryPoint entryPoint) BasePaymaster(entryPoint) {}
    
    function _validatePaymasterUserOp(
        PackedUserOperation calldata userOp,
        bytes32 userOpHash,
         uint256 /*maxCost*/
    ) internal override returns (bytes memory context, uint256 validationData) {
        address <span class="hljs-attr">targetApp</span> = address(bytes20(userOp.callData[<span class="hljs-number">16</span>:<span class="hljs-number">36</span>]))<span class="hljs-comment">;</span>
        require(whitelistedApps<span class="hljs-section">[targetApp]</span>, "App not whitelisted")<span class="hljs-comment">;</span>
        
        require(
            sponsoredTransactionCount<span class="hljs-section">[targetApp]</span> &lt; maxSponsoredTransactionsPerApp,
            "Sponsored transaction limit reached"
        )<span class="hljs-comment">;</span>
        
        if (userOp.paymasterAndData.length &gt; 20) {
            bytes memory <span class="hljs-attr">signature</span> = userOp.paymasterAndData[<span class="hljs-number">20</span>:]<span class="hljs-comment">;</span>
            bytes32 <span class="hljs-attr">hash</span> = userOpHash.toEthSignedMessageHash()<span class="hljs-comment">;</span>
            address <span class="hljs-attr">signer</span> = ECDSA.recover(hash, signature)<span class="hljs-comment">;</span>
            require(<span class="hljs-attr">signer</span> == owner(), <span class="hljs-string">"Invalid paymaster signature"</span>)<span class="hljs-comment">;</span>
        }
        
        sponsoredTransactionCount<span class="hljs-section">[targetApp]</span>++<span class="hljs-comment">;</span>
        return ("", 0)<span class="hljs-comment">;</span>
    }
    
    // ✅ 修正：移除 _postOp 覆盖，使用父类默认实现
    // 如果确实需要后处理，确保正确导入类型
    
    function whitelistApp(address app) external onlyOwner {
        whitelistedApps<span class="hljs-section">[app]</span> = true<span class="hljs-comment">;</span>
        emit AppWhitelisted(app)<span class="hljs-comment">;</span>
    }
    
    function removeApp(address app) external onlyOwner {
        whitelistedApps<span class="hljs-section">[app]</span> = false<span class="hljs-comment">;</span>
        emit AppRemoved(app)<span class="hljs-comment">;</span>
    }
    
    function resetSponsoredCount(address app) external onlyOwner {
        sponsoredTransactionCount<span class="hljs-section">[app]</span> = 0<span class="hljs-comment">;</span>
    }
    
    function setMaxSponsoredTransactions(uint256 maxCount) external onlyOwner {
        <span class="hljs-attr">maxSponsoredTransactionsPerApp</span> = maxCount<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-17">编译指令</h5>
<pre><code class="hljs language-python" lang="python">npx hardhat <span class="hljs-built_in">compile</span>
</code></pre>
<h5 data-id="heading-18"><strong>智能合约部署</strong></h5>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// scripts/deploy.ts</span>
import { network, artifacts } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
import {parseEther} <span class="hljs-keyword">from</span> <span class="hljs-string">"viem"</span>
import EntryPointArtifact <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/artifacts/EntryPoint.json"</span>;
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"/>) </span>{
   <span class="hljs-comment">// 连接网络</span>
  <span class="hljs-keyword">const</span> { viem } = await network.<span class="hljs-title function_ invoke__">connect</span>({ <span class="hljs-attr">network</span>: network.name });<span class="hljs-comment">//指定网络进行链接</span>
  <span class="hljs-comment">// 获取客户端</span>
  <span class="hljs-keyword">const</span> [deployer] = await viem.<span class="hljs-title function_ invoke__">getWalletClients</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">publicClient</span> = await viem.<span class="hljs-title function_ invoke__">getPublicClient</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entryPointHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({
    <span class="hljs-attr">abi</span>: EntryPointArtifact.abi,
    <span class="hljs-attr">bytecode</span>: EntryPointArtifact.bytecode,
    <span class="hljs-attr">args</span>: [], // EntryPoint 构造函数不需要参数
  });
  
  <span class="hljs-comment">// 等待确认并获取合约地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entryPointReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">waitForTransactionReceipt</span>({ 
    <span class="hljs-attr">hash</span>: entryPointHash 
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entryPointAddress</span> = entryPointReceipt.contractAddress;
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"✅ EntryPoint 合约地址:"</span>, entryPointAddress);
  <span class="hljs-comment">// 部署智能合约MySmartAccount</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountRegistry</span> = await artifacts.<span class="hljs-title function_ invoke__">readArtifact</span>(<span class="hljs-string">"MySmartAccount"</span>);
  <span class="hljs-comment">// 部署（构造函数参数：recipient, initialOwner）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountRegistryHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({
    <span class="hljs-attr">abi</span>: MySmartAccountRegistry.abi,//获取abi
    <span class="hljs-attr">bytecode</span>: MySmartAccountRegistry.bytecode,//硬编码
    <span class="hljs-attr">args</span>: [entryPointAddress,deployer.account.address],//process.env.RECIPIENT, process.env.OWNER
  });
  <span class="hljs-comment">// 等待确认并打印合约地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">getTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: MySmartAccountRegistryHash });
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"MySmartAccount合约地址:"</span>, MySmartAccountReceipt.contractAddress);
  <span class="hljs-comment">// 部署工厂合约</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountFactory</span> = await  artifacts.<span class="hljs-title function_ invoke__">readArtifact</span>(<span class="hljs-string">"MySmartAccountFactory"</span>); 

  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountFactoryHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({
    <span class="hljs-attr">abi</span>: MySmartAccountFactory.abi,//获取abi
    <span class="hljs-attr">bytecode</span>: MySmartAccountFactory.bytecode,//硬编码
    <span class="hljs-attr">args</span>: [entryPointAddress],//process.env.RECIPIENT, process.env.OWNER
  });
    <span class="hljs-comment">// 等待确认并打印合约地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountFactoryReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">getTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: MySmartAccountFactoryHash });
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"MySmartAccountFactory合约地址:"</span>, await MySmartAccountFactoryReceipt.contractAddress);

  <span class="hljs-comment">// 部署支付合约MyPaymaster</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyPaymaster</span> = await artifacts.<span class="hljs-title function_ invoke__">readArtifact</span>(<span class="hljs-string">"MyPaymaster"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyPaymasterHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({  // ← 使用 deployContract
    <span class="hljs-attr">abi</span>: MyPaymaster.abi,
    <span class="hljs-attr">bytecode</span>: MyPaymaster.bytecode,
    <span class="hljs-attr">args</span>: [entryPointAddress],
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyPaymasterReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">waitForTransactionReceipt</span>({ 
    <span class="hljs-attr">hash</span>: MyPaymasterHash 
  });
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"MyPaymaster合约地址:"</span>, MyPaymasterReceipt.contractAddress);
  
}

<span class="hljs-title function_ invoke__">main</span>().<span class="hljs-keyword">catch</span>((error) =&gt; {
  console.<span class="hljs-title function_ invoke__">error</span>(error);
  process.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);
});
</code></pre>
<h5 data-id="heading-19">特殊说明：关于本地部署EntryPoint合约问题</h5>
<p><code>本地开发直接在安装包中获取编译后的@account-abstraction/contracts/artifacts/EntryPoint.json 进行部署，如果是测试网或主网中直接使用在线的合约地址即可</code></p>
<h5 data-id="heading-20">部署指令</h5>
<pre><code class="hljs language-arduino" lang="arduino">npx hardhat run ./scripts/xxx.ts
</code></pre>
<h5 data-id="heading-21"><strong>智能合约测试</strong></h5>
<pre><code class="hljs language-ini" lang="ini">// test/ERC4337Wallet.ts
import assert from "node:assert/strict"<span class="hljs-comment">;</span>
import { describe, it, beforeEach } from "node:test"<span class="hljs-comment">;</span>
import { parseEther, toHex, hashMessage } from "viem"<span class="hljs-comment">;</span>
import { network } from "hardhat"<span class="hljs-comment">;</span>
import EntryPointArtifact from "@account-abstraction/contracts/artifacts/EntryPoint.json"<span class="hljs-comment">;</span>

describe("ERC4337钱包核心功能测试", async function () {
  let viem: any<span class="hljs-comment">;</span>
  let publicClient: any<span class="hljs-comment">;</span>
  let deployer: any, owner: any, user1: any<span class="hljs-comment">;</span>
  let entryPointAddress: string<span class="hljs-comment">;</span>
  let mySmartAccountFactory: any<span class="hljs-comment">;</span>
  let myPaymaster: any<span class="hljs-comment">;</span>

  beforeEach(async function () {
    const <span class="hljs-attr">networkData</span> = await network.connect()<span class="hljs-comment">;</span>
    <span class="hljs-attr">viem</span> = networkData.viem<span class="hljs-comment">;</span>
    
    <span class="hljs-section">[deployer, owner, user1]</span> = await viem.getWalletClients()<span class="hljs-comment">;</span>
    <span class="hljs-attr">publicClient</span> = await viem.getPublicClient()<span class="hljs-comment">;</span>

    // 部署 EntryPoint
    console.log("🚀 部署 EntryPoint...")<span class="hljs-comment">;</span>
    const <span class="hljs-attr">entryPointHash</span> = await deployer.deployContract({
      abi: EntryPointArtifact.abi,
      bytecode: EntryPointArtifact.bytecode,
      args: <span class="hljs-section">[]</span>,
    })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">entryPointReceipt</span> = await publicClient.waitForTransactionReceipt({ 
      hash: entryPointHash 
    })<span class="hljs-comment">;</span>
    <span class="hljs-attr">entryPointAddress</span> = entryPointReceipt.contractAddress!<span class="hljs-comment">;</span>
    console.log("✅ EntryPoint:", entryPointAddress)<span class="hljs-comment">;</span>

    // 部署工厂和 Paymaster
    <span class="hljs-attr">mySmartAccountFactory</span> = await viem.deployContract(<span class="hljs-string">"MySmartAccountFactory"</span>, [entryPointAddress])<span class="hljs-comment">;</span>
    console.log("✅ Factory:", mySmartAccountFactory.address)<span class="hljs-comment">;</span>

    <span class="hljs-attr">myPaymaster</span> = await viem.deployContract(<span class="hljs-string">"MyPaymaster"</span>, [entryPointAddress])<span class="hljs-comment">;</span>
    // await myPaymaster.write.deposit()<span class="hljs-comment">;</span>
    console.log("✅ Paymaster:", myPaymaster.address)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应创建智能账户并验证所有权", async function () {
    const <span class="hljs-attr">salt</span> = toHex(<span class="hljs-string">"test-salt"</span>, { size: <span class="hljs-number">32</span> })<span class="hljs-comment">;</span>
    
    // 1. 创建账户
    const <span class="hljs-attr">createTx</span> = await mySmartAccountFactory.write.createAccount([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    await publicClient.waitForTransactionReceipt({ hash: createTx })<span class="hljs-comment">;</span>
    
    // 2. 获取新创建的账户地址（关键！）
    const <span class="hljs-attr">accountAddress</span> = await mySmartAccountFactory.read.getAddress([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    
    // 3. 验证地址是合约
    const <span class="hljs-attr">code</span> = await publicClient.getCode({ address: accountAddress })<span class="hljs-comment">;</span>
    assert.ok(code &amp;&amp; code.length &gt; 2, "账户未成功部署")<span class="hljs-comment">;</span>
    
    // 4. 使用新账户地址创建实例
    const <span class="hljs-attr">mySmartAccount</span> = await viem.getContractAt(<span class="hljs-string">"MySmartAccount"</span>, accountAddress)<span class="hljs-comment">;</span>
    
    // 5. 验证所有权（这会成功，因为账户已初始化）
    const <span class="hljs-attr">actualOwner</span> = await mySmartAccount.read.owner()<span class="hljs-comment">;</span>
    assert.equal(actualOwner.toLowerCase(), owner.account.address.toLowerCase())<span class="hljs-comment">;</span>
    
    console.log("✅ 账户地址:", accountAddress)<span class="hljs-comment">;</span>
    console.log("✅ 所有者:", actualOwner)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应验证 ERC-1271 签名", async function () {
   const <span class="hljs-attr">walletClient</span> = (await viem.getWalletClients())[<span class="hljs-number">0</span>]<span class="hljs-comment">; </span>
    const <span class="hljs-attr">salt</span> = toHex(<span class="hljs-string">"test-salt-1271"</span>, { size: <span class="hljs-number">32</span> })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">createTx</span> = await mySmartAccountFactory.write.createAccount([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    await publicClient.waitForTransactionReceipt({ hash: createTx })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">accountAddress</span> = await mySmartAccountFactory.read.getAddress([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    const <span class="hljs-attr">mySmartAccount</span> = await viem.getContractAt(<span class="hljs-string">"MySmartAccount"</span>, accountAddress)<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">message</span> = <span class="hljs-string">"Hello ERC-1271"</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">messageHash</span> = hashMessage({ raw:message })<span class="hljs-comment">;</span>
    const <span class="hljs-attr">signature</span> = await walletClient.signMessage({
      account: owner.account,
      message
    })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">result</span> = await mySmartAccount.read.isValidSignature([messageHash, signature])<span class="hljs-comment">;</span>
    console.log("✅ 验证结果:", result)<span class="hljs-comment">;</span>
    // assert.equal(result, "0x1626ba7e")<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应允许所有者执行交易", async function () {
    const <span class="hljs-attr">salt</span> = toHex(<span class="hljs-string">"test-salt-exec"</span>, { size: <span class="hljs-number">32</span> })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">createTx</span> = await mySmartAccountFactory.write.createAccount([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    await publicClient.waitForTransactionReceipt({ hash: createTx })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">accountAddress</span> = await mySmartAccountFactory.read.getAddress([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    const <span class="hljs-attr">mySmartAccount</span> = await viem.getContractAt(<span class="hljs-string">"MySmartAccount"</span>, accountAddress)<span class="hljs-comment">;</span>
    
    // 存入 ETH
    await deployer.sendTransaction({
      to: accountAddress,
      value: parseEther("1")
    })<span class="hljs-comment">;</span>
    
    // 执行转账
    const <span class="hljs-attr">executeTx</span> = await mySmartAccount.write.execute([
      user1.account.address,
      parseEther(<span class="hljs-string">"0.5"</span>),
      <span class="hljs-string">"0x"</span>
    ], { account: owner.account })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">receipt</span> = await publicClient.waitForTransactionReceipt({ hash: executeTx })<span class="hljs-comment">;</span>
    assert.equal(receipt.status, "success")<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应管理 Paymaster 白名单", async function () {
    const <span class="hljs-attr">app</span> = user1.account.address<span class="hljs-comment">;</span>
    
    // 初始不在白名单
    const <span class="hljs-attr">isWhitelistedBefore</span> = await myPaymaster.read.whitelistedApps([app])<span class="hljs-comment">;</span>
    assert.equal(isWhitelistedBefore, false)<span class="hljs-comment">;</span>
    
    // 添加白名单
    await myPaymaster.write.whitelistApp(<span class="hljs-section">[app]</span>, { account: deployer.account })<span class="hljs-comment">;</span>
    const <span class="hljs-attr">isWhitelistedAfter</span> = await myPaymaster.read.whitelistedApps([app])<span class="hljs-comment">;</span>
    assert.equal(isWhitelistedAfter, true)<span class="hljs-comment">;</span>
    console.log("✅ 已添加白名单:", app)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h5 data-id="heading-22"><strong>测试指令</strong></h5>
<pre><code class="hljs language-bash" lang="bash">npx hardhat <span class="hljs-built_in">test</span> ./test/xxx.ts
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>以上内容完成了对 ERC-4337 标准的全面知识梳理，同时涵盖了其相关智能合约的完整实现流程。从核心知识解析到合约开发、测试验证，再到部署上线，每个环节均提供了详细的操作指引与逻辑说明，形成了 “理论梳理 + 实践落地” 的完整闭环，为开发者掌握 ERC-4337 标准应用与合约开发提供了清晰且可落地的参考框架</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发编程高级技巧：运行时检测死锁，告别死锁焦虑]]></title>    <link>https://juejin.cn/post/7586504691845234697</link>    <guid>https://juejin.cn/post/7586504691845234697</guid>    <pubDate>2025-12-22T11:18:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586504691845234697" data-draft-id="7586498198148792371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发编程高级技巧：运行时检测死锁，告别死锁焦虑"/> <meta itemprop="keywords" content="后端,性能优化,Java"/> <meta itemprop="datePublished" content="2025-12-22T11:18:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发编程高级技巧：运行时检测死锁，告别死锁焦虑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:18:18.000Z" title="Mon Dec 22 2025 11:18:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好,我是桦说编程。</p>
<blockquote>
<p>死锁是多线程编程的噩梦，一旦发生程序就会挂起。本文介绍 Guava 的 <code>CycleDetectingLockFactory</code>，让你在开发阶段就能发现潜在死锁，而不是等到生产环境暴雷。</p>
</blockquote>
<h2 data-id="heading-0">问题背景：死锁焦虑</h2>
<p>使用 <code>ReentrantLock</code> 或 <code>synchronized</code> 时，最担心的就是死锁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1：先锁A，再锁B</span>
lockA.lock();
lockB.lock();

<span class="hljs-comment">// 线程2：先锁B，再锁A</span>
lockB.lock();
lockA.lock();
</code></pre>
<p>这种代码在单元测试中可能运行正常，但在生产环境高并发时突然死锁，程序挂起，只能重启。</p>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>死锁难以复现，测试阶段很难发现</li>
<li>一旦发生，只能强制重启</li>
<li>排查需要线程 dump 分析，耗时耗力</li>
</ul>
<h2 data-id="heading-1">CycleDetectingLockFactory：运行时死锁检测</h2>
<p>Guava 提供的 <code>CycleDetectingLockFactory</code> 通过<strong>构建锁的依赖图</strong>，在获取锁时实时检测是否会形成环路（死锁）。</p>
<h3 data-id="heading-2">核心原理</h3>
<ol>
<li><strong>锁依赖图</strong>：记录每个线程获取锁的顺序</li>
<li><strong>环路检测</strong>：尝试获取新锁时，检查是否会形成环路</li>
<li><strong>即时失败</strong>：检测到潜在死锁时，立即抛出 <code>PotentialDeadlockException</code></li>
</ol>
<h3 data-id="heading-3">三种检测策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. THROW - 抛出异常（推荐用于开发/测试环境）</span>
CycleDetectingLockFactory.newInstance(Policies.THROW);

<span class="hljs-comment">// 2. WARN - 打印警告日志（适合生产环境）</span>
CycleDetectingLockFactory.newInstance(Policies.WARN);

<span class="hljs-comment">// 3. DISABLED - 禁用检测（性能敏感场景）</span>
CycleDetectingLockFactory.newInstance(Policies.DISABLED);
</code></pre>
<h2 data-id="heading-4">对比演示：死锁 vs 死锁检测</h2>
<h3 data-id="heading-5">场景：转账系统</h3>
<p>两个账户相互转账，线程1从A转到B，线程2从B转到A。</p>
<h3 data-id="heading-6">死锁版本（ReentrantLock）</h3>
<p>使用普通 <code>ReentrantLock</code>，程序会挂起：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
        lock.lock();  <span class="hljs-comment">// 先锁自己</span>
        <span class="hljs-keyword">try</span> {
            target.lock.lock();  <span class="hljs-comment">// 再锁对方 - 可能死锁!</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 转账逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                target.lock.unlock();
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-number">1</span> 获取了 账户<span class="hljs-selector-tag">A</span> 的锁
线程<span class="hljs-number">2</span> 获取了 账户<span class="hljs-selector-tag">B</span> 的锁
=== <span class="hljs-number">3</span>秒后程序仍未结束，发生死锁 ===
线程<span class="hljs-number">1</span>状态: WAITING
线程<span class="hljs-number">2</span>状态: WAITING
</code></pre>
<h3 data-id="heading-7">死锁检测版本（CycleDetectingLockFactory）</h3>
<p>替换为 <code>CycleDetectingLockFactory</code>，死锁会被立即检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.THROW);

<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> balance)</span> {
        <span class="hljs-built_in">this</span>.lock = lockFactory.newReentrantLock(name);  <span class="hljs-comment">// 使用工厂创建锁</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            target.lock.lock();  <span class="hljs-comment">// 检测到死锁会抛出异常</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 转账逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                target.lock.unlock();
            }
        } <span class="hljs-keyword">catch</span> (PotentialDeadlockException e) {
            System.err.println(<span class="hljs-string">"检测到潜在死锁: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-number">1</span> 获取了 账户<span class="hljs-selector-tag">A</span> 的锁
线程<span class="hljs-number">2</span> 获取了 账户<span class="hljs-selector-tag">B</span> 的锁
线程<span class="hljs-number">2</span> 检测到潜在死锁!
死锁信息: Potential Deadlock from LockGraphNode{账户<span class="hljs-selector-tag">B</span>} <span class="hljs-selector-tag">to</span> LockGraphNode{账户<span class="hljs-selector-tag">A</span>}
=== 程序正常结束，未发生死锁挂起 ===
</code></pre>
<h2 data-id="heading-8">实战建议</h2>
<h3 data-id="heading-9">1. 开发/测试环境使用 THROW 策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在测试环境配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.THROW);
</code></pre>
<p><strong>好处</strong>：单元测试、集成测试中自动发现死锁问题，快速失败。</p>
<h3 data-id="heading-10">2. 生产环境使用 WARN 策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在生产环境配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.WARN);
</code></pre>
<p><strong>好处</strong>：记录告警日志，但不中断业务，便于后续优化。</p>
<h3 data-id="heading-11">3. 性能敏感场景可以禁用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能优先场景</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.DISABLED);
</code></pre>
<p><strong>注意</strong>：只有在确认没有死锁风险，且性能测试证明检测有明显开销时才禁用。</p>
<h3 data-id="heading-12">4. 更好的方案：固定加锁顺序</h3>
<p>死锁检测只是兜底手段，根本解决方案是<strong>避免环路依赖</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 按照固定顺序加锁，避免死锁</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeTransfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    <span class="hljs-type">Account</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> System.identityHashCode(from) &lt; System.identityHashCode(to) ? from : to;
    <span class="hljs-type">Account</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> first == from ? to : from;

    first.lock.lock();
    <span class="hljs-keyword">try</span> {
        second.lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 转账逻辑</span>
        } <span class="hljs-keyword">finally</span> {
            second.lock.unlock();
        }
    } <span class="hljs-keyword">finally</span> {
        first.lock.unlock();
    }
}
</code></pre>
<h2 data-id="heading-13">完整示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * CycleDetectingLockFactory 死锁检测演示
 *
 * &lt;p&gt;与 DeadlockDemo 相同的转账场景，但使用 CycleDetectingLockFactory
 * &lt;p&gt;当检测到潜在死锁时，会立即抛出 PotentialDeadlockException，而不是挂起程序
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CycleDetectingLockDemo</span> {

    <span class="hljs-comment">// 创建锁工厂，THROW 策略会在检测到死锁时抛出异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
            CycleDetectingLockFactory.newInstance(CycleDetectingLockFactory.Policies.THROW);

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> balance;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> balance)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.balance = balance;
            <span class="hljs-comment">// 使用 CycleDetectingLockFactory 创建锁</span>
            <span class="hljs-comment">// 每个锁都有一个唯一的标识，用于构建锁的依赖图</span>
            <span class="hljs-built_in">this</span>.lock = lockFactory.newReentrantLock(name);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 先锁定自己的账户</span>
                lock.lock();
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() +
                            <span class="hljs-string">" 获取了 "</span> + name + <span class="hljs-string">" 的锁"</span>);

                    <span class="hljs-comment">// 模拟业务处理耗时</span>
                    Thread.sleep(<span class="hljs-number">100</span>);

                    <span class="hljs-comment">// 尝试锁定目标账户</span>
                    <span class="hljs-comment">// 如果会形成循环依赖（死锁），这里会立即抛出 PotentialDeadlockException</span>
                    target.lock.lock();
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 获取了 "</span> + target.name + <span class="hljs-string">" 的锁"</span>);

                        <span class="hljs-built_in">this</span>.balance -= amount;
                        target.balance += amount;

                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 完成转账: "</span> + name + <span class="hljs-string">" -&gt; "</span> + target.name + <span class="hljs-string">" ¥"</span> + amount);
                    } <span class="hljs-keyword">finally</span> {
                        target.lock.unlock();
                    }
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock();
                }
            } <span class="hljs-keyword">catch</span> (CycleDetectingLockFactory.PotentialDeadlockException e) {
                <span class="hljs-comment">// 检测到潜在死锁，立即抛出异常</span>
                System.err.println(Thread.currentThread().getName() +
                        <span class="hljs-string">" 检测到潜在死锁!"</span>);
                System.err.println(<span class="hljs-string">"死锁信息: "</span> + e.getMessage());
                <span class="hljs-comment">// 打印完整的锁依赖链</span>
                e.printStackTrace();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> name + <span class="hljs-string">": ¥"</span> + balance;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Account</span> <span class="hljs-variable">accountA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户A"</span>, <span class="hljs-number">1000</span>);
        <span class="hljs-type">Account</span> <span class="hljs-variable">accountB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户B"</span>, <span class="hljs-number">1000</span>);

        System.out.println(<span class="hljs-string">"=== CycleDetectingLockFactory 死锁检测演示 ==="</span>);
        System.out.println(<span class="hljs-string">"初始状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        System.out.println();

        <span class="hljs-comment">// 线程1: A -&gt; B 转账</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            accountA.transfer(accountB, <span class="hljs-number">200</span>);
        }, <span class="hljs-string">"线程1"</span>);

        <span class="hljs-comment">// 线程2: B -&gt; A 转账</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            accountB.transfer(accountA, <span class="hljs-number">300</span>);
        }, <span class="hljs-string">"线程2"</span>);

        thread1.start();
        thread2.start();

        <span class="hljs-comment">// 等待线程结束</span>
        thread1.join(<span class="hljs-number">5000</span>);
        thread2.join(<span class="hljs-number">5000</span>);

        System.out.println();
        System.out.println(<span class="hljs-string">"=== 程序正常结束，未发生死锁挂起 ==="</span>);
        System.out.println(<span class="hljs-string">"最终状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        System.out.println(<span class="hljs-string">"线程1状态: "</span> + thread1.getState());
        System.out.println(<span class="hljs-string">"线程2状态: "</span> + thread2.getState());
    }

    <span class="hljs-comment">/**
     * 演示正确的锁顺序 - 避免死锁
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeTransferDemo</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
            <span class="hljs-type">Account</span> <span class="hljs-variable">accountA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户A"</span>, <span class="hljs-number">1000</span>);
            <span class="hljs-type">Account</span> <span class="hljs-variable">accountB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户B"</span>, <span class="hljs-number">1000</span>);

            System.out.println(<span class="hljs-string">"=== 安全转账演示（按固定顺序加锁）==="</span>);
            System.out.println(<span class="hljs-string">"初始状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
            System.out.println();

            <span class="hljs-comment">// 两个线程都按照相同的顺序加锁：先 A 后 B</span>
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                safeTransfer(accountA, accountB, <span class="hljs-number">200</span>);
            }, <span class="hljs-string">"线程1"</span>);

            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                safeTransfer(accountB, accountA, <span class="hljs-number">300</span>);
            }, <span class="hljs-string">"线程2"</span>);

            thread1.start();
            thread2.start();

            thread1.join();
            thread2.join();

            System.out.println();
            System.out.println(<span class="hljs-string">"=== 安全转账完成 ==="</span>);
            System.out.println(<span class="hljs-string">"最终状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeTransfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
            <span class="hljs-comment">// 按照固定顺序加锁：使用 hashCode 或其他标识符确定顺序</span>
            <span class="hljs-type">Account</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> System.identityHashCode(from) &lt; System.identityHashCode(to) ? from : to;
            <span class="hljs-type">Account</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> first == from ? to : from;

            <span class="hljs-keyword">try</span> {
                first.lock.lock();
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() +
                            <span class="hljs-string">" 获取了 "</span> + first.name + <span class="hljs-string">" 的锁"</span>);

                    Thread.sleep(<span class="hljs-number">100</span>);

                    second.lock.lock();
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 获取了 "</span> + second.name + <span class="hljs-string">" 的锁"</span>);

                        from.balance -= amount;
                        to.balance += amount;

                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 完成转账: "</span> + from.name + <span class="hljs-string">" -&gt; "</span> + to.name + <span class="hljs-string">" ¥"</span> + amount);
                    } <span class="hljs-keyword">finally</span> {
                        second.lock.unlock();
                    }
                } <span class="hljs-keyword">finally</span> {
                    first.lock.unlock();
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">核心要点</h2>
<h3 data-id="heading-15">CycleDetectingLockFactory 的优势</h3>
<ol>
<li><strong>即时反馈</strong>：开发阶段就能发现潜在死锁</li>
<li><strong>零侵入</strong>：只需替换锁的创建方式，业务代码不变</li>
<li><strong>可配置</strong>：根据环境选择不同策略（抛异常/告警/禁用）</li>
<li><strong>清晰诊断</strong>：异常信息包含完整的锁依赖链</li>
</ol>
<h3 data-id="heading-16">使用场景</h3>
<ul>
<li><strong>推荐使用</strong>：多个锁、加锁顺序不确定的场景</li>
<li><strong>测试环境</strong>：全局使用 THROW 策略，自动化测试发现问题</li>
<li><strong>生产环境</strong>：使用 WARN 策略作为监控手段</li>
<li><strong>不推荐</strong>：单锁场景、加锁顺序固定的场景（无必要）</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<ul>
<li><strong>死锁难以复现</strong>，生产环境暴露成本高，<code>CycleDetectingLockFactory</code> 让问题前移</li>
<li><strong>THROW 策略</strong>用于测试环境，<strong>WARN 策略</strong>用于生产环境</li>
<li><strong>死锁检测是兜底</strong>，根本方案是设计合理的加锁顺序</li>
<li><strong>零侵入改造</strong>，只需替换锁的创建方式，立即获得死锁检测能力</li>
<li><strong>检测开销</strong>：需要维护锁依赖图，有轻微性能损耗</li>
</ul>
<p>使用 <code>CycleDetectingLockFactory</code> 可以让你摆脱死锁焦虑，在开发阶段就发现问题，而不是等到生产环境暴雷后手忙脚乱。</p>
<hr/>
<p>如果这篇文章对你有帮助，欢迎关注我，持续分享高质量技术干货，助你更快提升编程能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[于钉钉投诉的申诉与思考：行业观察的价值，在于敢说真实的问题]]></title>    <link>https://juejin.cn/post/7587060153028689961</link>    <guid>https://juejin.cn/post/7587060153028689961</guid>    <pubDate>2025-12-24T06:11:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587060153028689961" data-draft-id="7587060153028673577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="于钉钉投诉的申诉与思考：行业观察的价值，在于敢说真实的问题"/> <meta itemprop="keywords" content="人工智能,产品经理,阿里巴巴"/> <meta itemprop="datePublished" content="2025-12-24T06:11:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            于钉钉投诉的申诉与思考：行业观察的价值，在于敢说真实的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:11:07.000Z" title="Wed Dec 24 2025 06:11:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>收到钉钉方面以 “刻意挑起矛盾、贬低品牌” 为由的投诉时，我正在整理近期企业服务 AI 赛道的案例 —— 作为长期扎根这个领域的观察者，我始终认为，对产品战略的理性分析、对行业生态的客观审视，从来不是 “抹黑”，而是推动行业进步的必要声音。今天写下这篇文字，既是对投诉的正式回应，也是想和关注这个赛道的朋友聊聊：我们究竟需要怎样的行业讨论？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d9be61f9f994e9cbf362ab02aa3fbb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161467&amp;x-signature=8CAJWkJ%2FZf7XgWTaX%2FyOuPqbgcM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">一、先谈初衷：我从未想过 “贬低”，只希望 “说透”</h2>
<p>在《如何评价钉钉 AI1.1 新品发布会》一文中，我的核心诉求很明确：从战略逻辑、生态可行性、竞争隐忧三个维度，拆解钉钉 “行业垂直 AI” 战略背后的真实挑战。这些分析绝非主观臆断，而是基于公开信息与行业常识：</p>
<ul>
<li>关于 “钉钉与 Qoder 的左右分野”，我始终强调二者 “均为阿里旗下独立产品”—— 这是公开的业务定位，而非我刻意制造的对立。我分析 “资源内耗”，依据的是国内 AI 人才缺口达 500 万、复合型人才稀缺的行业现状：当一家企业同时在通用编程（Qoder）与垂直行业（钉钉）两条赛道发力时，有限的人才与技术资源如何分配？这是所有大型企业多业务线布局都会面临的问题，怎么就成了 “挑起矛盾”？</li>
<li>关于 “垂直模型的现实支撑”，我质疑的不是 “垂直化” 本身，而是钉钉发布会中未明确的细节：医疗数据的隐私壁垒如何突破？“90.2% 准确率” 的测试样本量、场景复杂度为何未披露？这些疑问源于行业对 “AI 落地真实性” 的基本要求 —— 如果连数据合规性、技术指标可验证性都不能谈，那 AI 产品的 “商业交付能力” 又该如何评判？</li>
<li>我甚至在文中明确提到：“钉钉押注垂直战略，有其在通用 AI 赛道竞争劣势的无奈”—— 这恰恰是对其战略选择的客观理解，而非 “贬低”。我反对的从来不是 “做垂直 AI”，而是 “未夯实基础就急于跳级” 的冒进：连 “制造钉识别订单延迟”“AI 听记无法多语言翻译” 这类通用办公基础问题都没解决，却宣称能攻克 “临床精准决策” 这类高难度场景，这样的逻辑漏洞，难道不该被指出？</li>
</ul>
<h2 data-id="heading-1">二、再谈 “品牌形象”：真正的品牌价值，从正视问题开始</h2>
<p>钉钉投诉中提到 “对品牌形象造成损伤”，但在我看来，一个企业的品牌形象，从来不是靠 “屏蔽不同声音” 建立的，而是靠 “解决真实问题” 赢得的。我承认，钉钉 AI1.1 的发布有其突破性 —— 比如 Agent OS 试图搭建 “AI Agent 生态底座” 的思路，DingTalk Real 针对企业数据安全的硬件尝试，这些都是值得肯定的探索。但 “有亮点” 不代表 “无问题”：</p>
<ul>
<li>当钉钉承诺 “支持 1000 个生态伙伴打造专属模型” 时，行业更关心的是 “中小企业如何承担 500 万起的硬件投入 + 20% 年维护成本”？我提出 “成本门槛拦住中小企业”，不是为了否定生态计划，而是希望钉钉能给出更具体的普惠方案 —— 毕竟，企业服务赛道的核心价值，从来不是 “服务头部企业”，而是 “让更多中小企业用得起 AI”。</li>
<li>当钉钉说 “要覆盖医疗、制造、办公等全场景” 时，我担忧的是 “2 亿月活的市场支配地位是否会挤压中小开发者”？这不是我个人的猜测，而是平台经济的普遍规律：当头部平台凭借流量优势全面介入垂直领域时，第三方开发者的流量曝光、资源支持如何保障？钉钉生态中 “80% 头部服务被阿里系垄断” 的行业观察，难道不该被拿出来讨论，以推动更公平的竞争环境？</li>
</ul>
<p>这些疑问，本质上是 “希望钉钉的战略能走得更稳”，而非 “要损害其品牌”。如果说 “指出问题” 就是 “贬低”，那行业里岂不是只剩下赞歌？可没有批评的监督，AI 产品如何避免 “概念炒作”，真正落地到企业的真实需求里？</p>
<h2 data-id="heading-2">三、最后谈 “言论自由”：行业观察者的责任，是敢说真话</h2>
<p>钉钉投诉中未提及，但我必须强调的一点是：“讨论行业垄断” 是业内人士的基本言论自由，更是对市场健康的责任。企业服务 AI 赛道正处于关键期，无论是钉钉、飞书还是其他玩家，都在探索未来的方向。这个过程中，必然会有战略失误、生态漏洞 —— 而观察者的价值，就是把这些 “看不见的问题” 摆到台面上，让行业在讨论中找到更优解。我从未否认钉钉在协同办公领域的贡献，也期待它能在垂直 AI 赛道做出成绩。但我更希望，钉钉能把 “投诉” 的精力，放在回应这些真实问题上：比如如何解决高质量行业数据的供给难题？如何降低中小企业的 AI 使用成本？如何给第三方开发者更公平的生态位置？这些问题的答案，远比一份投诉函更能提升品牌形象，也更能推动整个赛道的进步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d91d2b5c07f041e19c05d8aa40232f4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161467&amp;x-signature=fsyh3XOflzavhph54TbNJZexYnc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-3">尾声：期待一场理性的对话，而非对抗</h2>
<p>写下这些话，不是为了和钉钉 “争对错”，而是想传递一个态度：行业的发展需要多元声音，既需要企业的创新探索，也需要观察者的理性监督。如果钉钉愿意，我很乐意就 “垂直 AI 战略” 的细节展开更深入的交流 —— 比如一起探讨医疗数据合规的路径，一起测算中小企业的 AI 使用成本模型。毕竟，我们的目标是一致的：让 AI 真正帮到企业，让这个赛道变得更好。也想对关注这篇文章的朋友说：未来我依然会保持客观的立场，分析更多企业服务 AI 的案例。因为我相信，敢说真实的问题，才是对这个行业最大的尊重。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：路由与中间件]]></title>    <link>https://juejin.cn/post/7585888537642418191</link>    <guid>https://juejin.cn/post/7585888537642418191</guid>    <pubDate>2025-12-22T03:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585888537642418191" data-draft-id="7585888537642401807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：路由与中间件"/> <meta itemprop="keywords" content="后端,Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：路由与中间件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:02:41.000Z" title="Mon Dec 22 2025 03:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js Web 开发中，路由与中间件是构建应用的两大核心机制。路由负责将请求分发到具体的业务处理逻辑，而中间件则负责在请求处理过程中执行通用操作。二者相互配合，构成了 Express 等框架的运行基础。</p>
</blockquote>
<p>理解路由匹配规则和中间件执行顺序，是写好 Node.js 服务端代码的关键。</p>
<hr/>
<h2 data-id="heading-0">一、什么是路由</h2>
<p>路由用于描述请求路径与处理函数之间的映射关系。一个完整的路由通常由请求方法、路径和回调函数组成。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});
</code></pre>
<p>当客户端以 GET 方法访问 <code>/users</code> 时，Express 会执行对应的处理函数。</p>
<hr/>
<h2 data-id="heading-1">二、路由匹配规则</h2>
<p>Express 的路由是按<strong>定义顺序</strong>进行匹配的。一旦匹配成功，后续路由将不会再被执行。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);
});
</code></pre>
<p>动态路由可以通过参数的形式获取路径中的变量，这在资源型接口设计中非常常见。</p>
<hr/>
<h2 data-id="heading-2">三、路由拆分与模块化</h2>
<p>在项目规模扩大后，将所有路由写在一个文件中会导致代码难以维护。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();

router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;
</code></pre>
<p>通过路由模块化，可以让项目结构更加清晰，职责更加明确。</p>
<hr/>
<h2 data-id="heading-3">四、中间件的基本概念</h2>
<p>中间件本质上是一个函数，用于在请求进入路由之前或响应返回之前执行逻辑。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>中间件可以访问请求对象、响应对象，并决定是否继续传递请求。</p>
<hr/>
<h2 data-id="heading-4">五、中间件的执行顺序</h2>
<p>中间件按照<strong>注册顺序</strong>执行。</p>
<ul>
<li>全局中间件优先执行</li>
<li>路由级中间件按顺序执行</li>
<li>错误处理中间件最后执行</li>
</ul>
<p>一旦中间件没有调用 <code>next</code>，请求链将被中断。</p>
<hr/>
<h2 data-id="heading-5">六、常见中间件使用场景</h2>
<p>中间件通常用于处理通用逻辑，例如：</p>
<ul>
<li>请求日志记录</li>
<li>参数校验</li>
<li>用户认证与权限控制</li>
<li>请求体解析</li>
<li>跨域处理</li>
</ul>
<p>将这些逻辑从业务代码中抽离，可以显著提升代码可读性。</p>
<hr/>
<h2 data-id="heading-6">七、路由级中间件</h2>
<p>除了全局中间件，还可以为特定路由添加中间件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">auth</span> = (<span class="hljs-params">req, res, next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'unauthorized'</span>);
  }
  <span class="hljs-title function_">next</span>();
};

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/profile'</span>, auth, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'profile'</span>);
});
</code></pre>
<p>这种方式可以实现精细化的权限控制。</p>
<hr/>
<h2 data-id="heading-7">八、错误处理中间件</h2>
<p>Express 提供了专门的错误处理中间件形式。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'server error'</span>);
});
</code></pre>
<p>集中处理异常，有助于统一错误返回结构。</p>
<hr/>
<h2 data-id="heading-8">九、next 的使用注意事项</h2>
<p><code>next</code> 用于将控制权交给下一个中间件或路由。</p>
<p>需要注意：</p>
<ul>
<li>不调用 <code>next</code>，请求将被阻塞</li>
<li>调用 <code>next(err)</code> 会直接进入错误处理中间件</li>
<li>避免重复调用 <code>next</code></li>
</ul>
<p>合理使用 <code>next</code> 是中间件设计的核心。</p>
<hr/>
<h2 data-id="heading-9">十、路由与中间件的协作模式</h2>
<p>在实际项目中，常见的协作方式是：</p>
<ul>
<li>中间件负责通用逻辑</li>
<li>路由负责业务分发</li>
<li>控制器负责业务实现</li>
</ul>
<p>这种分层设计有助于项目长期维护和扩展。</p>
<hr/>
<h2 data-id="heading-10">十一、总结</h2>
<p>路由和中间件是 Node.js Web 框架中最重要的基础设施。路由决定请求走向，中间件决定请求如何被处理。只有真正理解它们的执行机制和设计思路，才能写出结构清晰、易维护的服务端代码。</p>
<p>在项目初期建立合理的路由和中间件体系，将为后续功能扩展打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨端RN 与 浏览器Web 的 长渲染性能 差异 与 底层 揭秘]]></title>    <link>https://juejin.cn/post/7587008326481166378</link>    <guid>https://juejin.cn/post/7587008326481166378</guid>    <pubDate>2025-12-24T06:13:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587008326481166378" data-draft-id="7586939930155057195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨端RN 与 浏览器Web 的 长渲染性能 差异 与 底层 揭秘"/> <meta itemprop="keywords" content="前端,WebGL,React Native"/> <meta itemprop="datePublished" content="2025-12-24T06:13:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="July_lly"/> <meta itemprop="url" content="https://juejin.cn/user/2975757420726467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨端RN 与 浏览器Web 的 长渲染性能 差异 与 底层 揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975757420726467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    July_lly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:13:52.000Z" title="Wed Dec 24 2025 06:13:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">背景</h2>
<p>从入职以来，我一直在参与一个跨端项目的开发，主要技术栈是 <strong>React Native</strong>。在这期间，也不可避免地接触了一些原生能力，比如陀螺仪、手势、生命周期等。</p>
<p>最近，我们开始调研一个问题：<br/>
<strong>在 App 中，如何实现“持续长时间的动态渲染”？</strong></p>
<p>这里说的“持续长渲染”，并不是指一次性的动画效果，而是类似以下场景：</p>
<ul>
<li>Keep 中的跑步轨迹持续绘制</li>
<li>导航 App 中路线与视角的实时跟随</li>
<li>地图、雷达、3D 角色、桌面宠物等长时间存在、持续运动的画面</li>
</ul>
<p>这些场景的共同点是：</p>
<blockquote>
<p><strong>画面会在很长时间内持续更新，并且帧与帧之间存在状态延续。</strong></p>
</blockquote>
<p>一开始我并没有理解这个“状态延续”的原理，只是单纯觉得：<br/>
<strong>不就是一直画吗？</strong></p>
<hr/>
<h2 data-id="heading-1">Skia</h2>
<p>既然我们本身是 RN 项目，又不想引入 WebView，那最自然的选择就是找“原生渲染能力”。</p>
<p>在 RN 社区里，第一个跳出来的就是 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fskia.org%2F" target="_blank" title="https://skia.org/" ref="nofollow noopener noreferrer">Skia</a></strong>。</p>
<p>Skia 是一个由 Google 主导的开源图形渲染库，主要用于 <strong>高性能 2D 图形绘制</strong>，底层使用 C++ 实现，被广泛应用在 Chrome、Flutter、Android 系统组件中。</p>
<p>在 RN 中，我们通常会通过引入 <code>@shopify/react-native-skia</code> 来使用它。</p>
<h4 data-id="heading-2">为什么一开始觉得它很合适？</h4>
<p>说实话，<a href="https://link.juejin.cn?target=https%3A%2F%2Fskia.org%2F" target="_blank" title="https://skia.org/" ref="nofollow noopener noreferrer">Skia </a>看起来几乎是“标准答案”：</p>
<ul>
<li>原生级性能</li>
<li>GPU 加速</li>
<li>不走 WebView</li>
<li>API 类似 Canvas</li>
</ul>
<p>而且它的优化十分到位会把<strong>把绘制这件事直接下沉到 C++</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47a62f9ca1c4865af554869957e5d02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=xeOf7YgOEKhHTIX1GfcEj%2FLffEM%3D" alt="image.png" loading="lazy"/></p>
<p>在最开始的设想中，我甚至觉得：</p>
<blockquote>
<p>“只要把动画逻辑写好，Skia 负责画，应该就很稳了。”</p>
</blockquote>
<p>但真正开始往“长时间动态场景”上靠的时候，问题慢慢暴露了。</p>
<h4 data-id="heading-3">问题并不是性能，是匹配度</h4>
<p>Skia 本质上是一个以 <strong>2D 图形管线为核心设计的渲染引擎</strong>。<br/>
它非常擅长一件事：<strong>把你给它的东西画出来，而且画得很快</strong>。</p>
<p>但它并不负责：</p>
<ul>
<li>场景管理</li>
<li>相机系统</li>
<li>空间关系</li>
<li>世界状态的持续演进</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><strong>Skia 的核心能力是“绘制”，而不是“场景”。</strong></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2763d5a8561845cb8a334ce43433185b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=Xfi%2Fgs8r%2F8nhhyR1bV%2BxdtS8dlg%3D" alt="Adobe Express - skia1.gif" loading="lazy"/></p>
<p>当画面开始需要「持续运动」「围绕轨道旋转」「跟随某个路径」时：</p>
<ul>
<li>每一帧的位置要 JS 算</li>
<li>每一帧的变化要 JS 推</li>
<li>每一帧的绘制触发，还是 JS</li>
</ul>
<p>只要 JS 线程被打断——<br/>
比如 RN 正在处理手势、列表滚动、setState——<br/>
画面就会立刻卡住。</p>
<p>到这里我才意识到：<br/>
<strong>Skia 并不是慢，它只是不解决我现在遇到的这个问题。</strong></p>
<hr/>
<h3 data-id="heading-4">Expo GLView + Three.js</h3>
<p>既然 Skia 偏 2D，那自然就会往 3D 方向走。</p>
<p>在 RN 生态里，最常见、也是最“官方”的 3D 组合基本就是：</p>
<ul>
<li><code>expo-gl</code>（GLView）</li>
<li><code>expo-three</code></li>
<li><code>three.js</code></li>
</ul>
<h4 data-id="heading-5">这个方案是怎么工作的？</h4>
<p>Three.js 在 Web 端已经非常成熟了。但真正梳理它的执行流程时，会发现它在expo的工作其实是这样的：</p>
<pre><code class="hljs language-scss" lang="scss">JS 创建 GLView  
⬇️  
JS 初始化 Three<span class="hljs-selector-class">.js</span> Scene / Camera / Mesh  
⬇️  
JS 启动 requestAnimationFrame  
⬇️  
每一帧：  
JS 计算动画  
→ renderer<span class="hljs-selector-class">.render</span>  
→ 手动调用 gl<span class="hljs-selector-class">.endFrameEXP</span>()
</code></pre>
<p>如果只是让 GLB 模型在场景中做位移、绕轨道运动，在刻意降低帧率（比如 10～20fps）的情况下，整体是“能看”的，甚至看起来还算流畅。
这类运动有一个共同点：
<strong>每一帧只是“位置在变”，模型本身并没有发生结构或尺度上的变化。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72cf1184c2da49c2b5f1f9982494bb97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=1W87mgjyxKmsn0GRFsamvXBhiqQ%3D" alt="GLBs.gif" loading="lazy"/></p>
<p>但当我尝试对 <strong>同一个 GLB 模型直接做缩放（scale）动画</strong> 时，情况立刻变了。哪怕动画逻辑非常简单，只是不断放大 / 缩小，画面会出现非常明显的：抖动，掉帧，“一卡一卡”的感觉。而且这种卡顿，并不是偶发的，而是<strong>稳定复现的</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9e03f77cc9342dea1438a211b24a834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=dOMk0VZvrO2ir%2FZJttk%2BzLI59VE%3D" alt="Adobe Express - GLB.gif" loading="lazy"/></p>
<h4 data-id="heading-6">什么原因导致这样的</h4>
<p>后面我想都是一样的使用 RN + GLView + threeJS，认为交互的问题，或者是GLB文件的特性</p>
<h5 data-id="heading-7">位移动画为什么还算流畅？</h5>
<p>模型位移时：</p>
<ul>
<li>只是更新 <code>position</code></li>
<li>变换矩阵相对简单</li>
<li>Three.js 内部状态变化较少</li>
<li>JS 每一帧传递的数据也很有限</li>
</ul>
<p>在 <strong>低帧率 + 匀速运动</strong> 的情况下，人眼会帮我们“脑补连续性”，<br/>
于是看起来还算顺。</p>
<h5 data-id="heading-8">scale 动画为什么这么容易卡？</h5>
<p>scale 动画在 Three / GLView 这一套里，成本要高得多：</p>
<ul>
<li>每一帧都要重新计算变换矩阵</li>
<li>scale 会影响子节点、包围盒、裁剪判断</li>
<li>渲染管线状态变化更频繁</li>
<li><strong>JS → GL 的同步压力明显变大</strong></li>
</ul>
<p>这些变化都只能由 JS 在每一帧明确告诉底层怎么去渲染。只要 JS 线程被 RN 抢走一瞬间：手势
，setState，Layout，Bridge调度在这一帧就丢失了。</p>
<p>因此这并不是交互本身的问题，也不是 GLB 模型复杂度导致的性能瓶颈。<br/>
本质原因在于 <strong>在 RN + GLView 架构下，动画状态的更新与帧的推进完全依赖 JS 线程驱动</strong>。<br/>
一旦 JS 线程被其他任务占用，渲染帧就无法按时推进，画面便会直接卡顿。</p>
<h2 data-id="heading-9">为什么 Web 中的 scale 看起来这么轻松？</h2>
<p>回答问题前我们先分别看一下web上的位移动画和Scale动画效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c9e7fd9d8d421982c46a5e9dd32edc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=bUZrUQw7imxEin1FGHzllZxxTek%3D" alt="webGLB1.gif" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18e48d940bfe48c490c6ec645a671bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=DfvyA9OoHUojj%2FF98AcNXb9dhg8%3D" alt="webGLB2.gif" loading="lazy"/></p>
<p>差距有点大......都是 GL+threeJS的背景，那为什么造成了这个原因呢？</p>
<h3 data-id="heading-10">浏览器的优化</h3>
<p>上面我们看到，在 RN 的跨端框架中：</p>
<blockquote>
<p><strong>渲染是否发生、何时发生、以及下一帧画什么，几乎完全依赖 JS 线程逐帧驱动。</strong></p>
</blockquote>
<p>而在 Web 环境中，即使我们使用的是 <code>WebGL + Three.js</code>，<strong>渲染帧的推进并不完全依赖 JS 线程</strong>。
换句话说：浏览器并不是“每一帧都等 JS 算完再画”，而是“只在必要时才叫 JS 介入”。</p>
<p>当一个动画被启动后：</p>
<ul>
<li>Three.js 将物体的变换参数（position / scale / rotation）</li>
<li>以及对应的矩阵更新逻辑</li>
<li>提交给浏览器的渲染管线</li>
</ul>
<p><strong>只要动画逻辑本身是“连续的”</strong> （例如匀速位移、缩放、插值动画），</p>
<blockquote>
<p><strong>帧调度与合成始终由浏览器主导，JS 只是参与者，而不是驱动者。</strong></p>
</blockquote>
<ul>
<li>JS 线程只负责 <strong>初始状态与关键参数变更</strong></li>
<li>帧调度、vsync 对齐、GPU 提交由浏览器统一完成</li>
</ul>
<p>因此即便 JS 出现短暂阻塞，画面也不会立刻停住</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWindow%2FrequestAnimationFrame" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame" ref="nofollow noopener noreferrer">RAF MDN地址</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FPerformance%2FGuides%2FCritical_rendering_path" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Performance/Guides/Critical_rendering_path" ref="nofollow noopener noreferrer">Rendering pipeline</a>
这里面可以看到web中的RAF是由浏览器去调度的，即使 JS 线程短暂阻塞，浏览器仍可能复用上一帧的状态让 GPU 进行合成。</p>
<h2 data-id="heading-11">结尾</h2>
<p>在 Web 环境中，即便动画是匀速移动或连续旋转，GPU 并不需要每一帧都等 JS 计算完成才能渲染下一帧。只要 JS 在动画开始时提供了<strong>初始状态、速度、旋转轴等信息</strong>，浏览器的渲染管线就能利用这些已有状态持续推进动画。换句话说：</p>
<ul>
<li><strong>Web / Three.js + WebGL</strong><br/>
JS 负责一次性设置参数 → GPU 自行渲染 → 即使 JS 暂时阻塞，动画也不会瞬间停住，而是继续使用已有状态进行渲染。就像导演指挥好演员动作后，摄影机自己拍摄电影。</li>
<li><strong>RN / Expo GLView + Three.js</strong><br/>
GPU 并没有独立推进动画的能力，每一帧都需要 JS 告诉它物体的新位置和旋转。JS 线程一旦阻塞或计算过重，画面就会卡住或掉帧。像导演必须每一帧都手把手指挥演员，任何停顿都会影响拍摄。</li>
</ul>
<blockquote>
<p><strong>核心差异</strong>：Web 的 GPU 可以“复用上一帧状态继续播放”，而 RN 的 GPU 渲染完全依赖 JS 线程逐帧驱动。</p>
</blockquote>
<p>这一点也解释了为什么同样的 GLB 模型、同样的 Three.js 代码，在浏览器里顺滑，但在 RN 里高 FPS 动画很容易卡顿。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(7)---MemScheduler 细节]]></title>    <link>https://juejin.cn/post/7586479864272093190</link>    <guid>https://juejin.cn/post/7586479864272093190</guid>    <pubDate>2025-12-22T12:27:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864272093190" data-draft-id="7586491717873270803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(7)---MemScheduler 细节"/> <meta itemprop="keywords" content="算法,人工智能,机器学习"/> <meta itemprop="datePublished" content="2025-12-22T12:27:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(7)---MemScheduler 细节
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:27:13.000Z" title="Mon Dec 22 2025 12:27:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(7)---MemScheduler 细节</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 摘要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 组件关系</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 实现</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 GeneralScheduler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 SchedulerDispatcher</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 SchedulerRetriever</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 关联</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 SchedulerDispatcher 和 GeneralScheduler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 GeneralScheduler 和 TreeTextMemory</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.3 总结</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.4 MosCore</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>记忆调度就像大脑的注意力机制，动态决定在合适的时刻调用合适的记忆。</p>
<p>在 MemOS 中，<strong>记忆调度（Memory Scheduling）</strong> 通过对【不同使用效率（参数&gt;激活&gt;工作&gt;其他明文）的记忆】的相互调度，让模型能更高效、准确地获取用户所需的记忆。在对话和任务进行时，通过预测用户后续对话所需记忆并提前调入高效率记忆类型如激活记忆工作记忆，加速推理链路。</p>
<p>记忆调度的具体实现就是MemScheduler ，这是一个与 MemOS 系统并行运行的并发记忆管理系统，它协调 AI 系统中工作记忆、长时记忆和激活记忆之间的记忆操作。它通过事件驱动调度处理记忆检索、更新和压缩。该系统特别适合需要动态记忆管理的对话代理和推理系统。</p>
<p>备注：本文基于MemOS的文档和源码进行学习，似乎其文档并没有跟上源码更新的速度，而且也有部分功能未实现或者未开源。</p>
<p>前一篇介绍了 MemScheduler 的总体概念，本篇来看看实现细节。</p>
<h3 data-id="heading-2">0x01 组件关系</h3>
<p>最核心的几个组件关系如下：</p>
<ul>
<li>GeneralScheduler 是整个调度系统的核心组件，继承自 BaseScheduler，负责处理不同类型的消息（查询、回答、添加等），并协调其他组件完成具体任务。</li>
<li>SchedulerDispatcher 是消息分发器，负责将不同类型的消息分发给对应的processor，支持并行处理（可选）。</li>
<li>SchedulerRetriever 是记忆检索器，负责从记忆库中搜索、重排序和过滤记忆项，提供智能记忆管理功能。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb95ef5952641588c8a4a6f509f27c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=YBjKu%2BcIbu8HAkKtkVLsesWCWTE%3D" alt="MemScheduler-7-1" loading="lazy"/></p>
<p>MemScheduler-7-1</p>
<p>MemOS-main\src\memos\templates\mem_scheduler_prompts.py 中可以看到使用的prompt。</p>
<pre><code class="hljs language-makefile" lang="makefile">PROMPT_MAPPING = {
    <span class="hljs-string">"intent_recognizing"</span>: INTENT_RECOGNIZING_PROMPT,
    <span class="hljs-string">"memory_reranking"</span>: MEMORY_RERANKING_PROMPT,
    <span class="hljs-string">"query_keywords_extraction"</span>: QUERY_KEYWORDS_EXTRACTION_PROMPT,
    <span class="hljs-string">"memory_filtering"</span>: MEMORY_FILTERING_PROMPT,
    <span class="hljs-string">"memory_redundancy_filtering"</span>: MEMORY_REDUNDANCY_FILTERING_PROMPT,
    <span class="hljs-string">"memory_combined_filtering"</span>: MEMORY_COMBINED_FILTERING_PROMPT,
    <span class="hljs-string">"memory_answer_ability_evaluation"</span>: MEMORY_ANSWER_ABILITY_EVALUATION_PROMPT,
}
</code></pre>
<h3 data-id="heading-3">0x02 实现</h3>
<h4 data-id="heading-4">2.1 GeneralScheduler</h4>
<p>BaseScheduler是基类，而GeneralScheduler才是真正起作用的派生类。</p>
<p>GeneralScheduler采用生产者-消费者模型进行工作，是基于消息队列的内存调度器。</p>
<ul>
<li>
<p>该类是 MemOS 中基于<code>BaseScheduler</code>的具体调度器实现，专注于处理查询、回答和添加内存等核心任务。核心组件架构：</p>
<ul>
<li>消息队列：使用 memos_message_queue 来存储待处理的消息。</li>
<li>消费者线程：使用 _message_consumer 方法持续轮询队列并处理消息。</li>
<li>分发器：SchedulerDispatcher 负责将消息路由到对应的processor。</li>
<li>处理器：针对不同消息类型的具体processor。</li>
</ul>
</li>
<li>
<p>核心功能包括：</p>
<ul>
<li>注册消息类型（查询 / 回答 / 添加）注册对应的processor，实现任务的定向分发；</li>
<li>处理查询消息时，提取关键词、更新查询监控、执行内存检索与重排序，并支持激活内存的周期性更新；</li>
<li>处理添加内存消息时，记录新增内存日志并同步到监控系统；</li>
<li>基于会话对话轮次逻辑，根据意图检测和时间触发机制决定决定是否执行内存检索，确保工作内存的时效性和相关性。</li>
</ul>
</li>
<li>
<p>特色是基于消息类型的模块化处理机制，结合意图识别和时间触发的混合调度策略，支持按用户和内存立方体分组处理消息，保证多用户场景下的内存隔离和处理效率。</p>
</li>
</ul>
<h5 data-id="heading-5">2.1.1 消息处理</h5>
<p>SchedulerDispatcher将消息路由到适当的处理器。</p>
<h6 data-id="heading-6">消息类型与processor注册</h6>
<p>初始化时注册了三种消息processor。</p>
<pre><code class="hljs language-objectivec" lang="objectivec">        <span class="hljs-meta"># register handlers</span>
        handlers = {
            QUERY_LABEL: <span class="hljs-keyword">self</span>._query_message_consumer,
            ANSWER_LABEL: <span class="hljs-keyword">self</span>._answer_message_consumer,
            ADD_LABEL: <span class="hljs-keyword">self</span>._add_message_consumer,
        }
        <span class="hljs-keyword">self</span>.dispatcher.register_handlers(handlers)
</code></pre>
<ul>
<li>_query_message_consumer：处理用户查询 QUERY_LABEL，触发记忆检索和重排序</li>
<li>_answer_message_consumer：处理系统回答 ANSWER_LABEL。</li>
<li>_add_message_consumer：处理新增记忆请求 ADD_LABEL。</li>
</ul>
<p>QUERY_LABEL在memos/mem_scheduler/schemas/general_schemas.py文件中定义为一个常量：</p>
<ul>
<li>QUERY_LABEL="query"</li>
<li>ANSWER_LABEL ="anSwer"</li>
<li>ADD_LABEL = "add"</li>
</ul>
<p>这是一个预定义的字符串常量，值为"query"。</p>
<h6 data-id="heading-7">消息分发过程</h6>
<ul>
<li>消息提交：通过submit_messages 将ScheduleMessageItem放入消息队列。</li>
<li>消息消费：_message_consumer 线程定期从队列中取出所有消息。</li>
<li>消息分发：调用self.dispatcher.dispatch(messages)按消息标签分发到对应的processor。</li>
</ul>
<h5 data-id="heading-8">2.1.2 流程</h5>
<p>GeneralScheduler的流程如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70ce41552c344929865d4182468c0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=IVKNM%2F5tc3S%2FrtVy2984pstGgeM%3D" alt="MemScheduler-7-2" loading="lazy"/></p>
<p>MemScheduler-7-2</p>
<h5 data-id="heading-9">2.1.3 完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneralScheduler</span>(<span class="hljs-title class_ inherited__">BaseScheduler</span>):
    <span class="hljs-string">"""通用调度器，实现查询、回答和添加内存等具体任务的处理逻辑"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: GeneralSchedulerConfig</span>):
        <span class="hljs-string">"""使用给定定配置初始化通用调度器"""</span>
        <span class="hljs-built_in">super</span>().__init__(config)

        <span class="hljs-comment"># 查询关键词数量限制（从配置获取，默认20）</span>
        self.query_key_words_limit = self.config.get(<span class="hljs-string">"query_key_words_limit"</span>, <span class="hljs-number">20</span>)

        <span class="hljs-comment"># 注册消息processor（按消息标签绑定对应的处理方法）</span>
        handlers = {
            QUERY_LABEL: self._query_message_consumer,  <span class="hljs-comment"># 处理查询消息</span>
            ANSWER_LABEL: self._answer_message_consumer,  <span class="hljs-comment"># 处理回答消息</span>
            ADD_LABEL: self._add_message_consumer,  <span class="hljs-comment"># 处理添加内存消息</span>
        }
        self.dispatcher.register_handlers(handlers)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_query_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理和响应队列中的查询触发消息

        参数:
            messages: 要处理的查询消息列表
        """</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性（确保标签与消息类型匹配）</span>
        self.validate_schedule_messages(messages=messages, label=QUERY_LABEL)

        <span class="hljs-comment"># 遍历分组消息，按用户和内存立方体处理</span>
        <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
            <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                messages = grouped_messages[user_id][mem_cube_id]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span>

                <span class="hljs-comment"># 获取当前内存立方体实例</span>
                mem_cube = messages[<span class="hljs-number">0</span>].mem_cube

                <span class="hljs-comment"># 从消息更新当前上下文（线程安全）</span>
                self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

                <span class="hljs-comment"># 更新查询监控器（为每个消息注册查询记录）</span>
                <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
                    <span class="hljs-comment"># 若监控器不存在则创建</span>
                    self.monitor.register_query_monitor_if_not_exists(
                        user_id=user_id, mem_cube_id=mem_cube_id
                    )

                    <span class="hljs-comment"># 提取查询内容和关键词</span>
                    query = msg.content
                    query_keywords = self.monitor.extract_query_keywords(query=query)

                    <span class="hljs-comment"># 关键词提取失败时的 fallback 逻辑</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(query_keywords) == <span class="hljs-number">0</span>:
                        stripped_query = query.strip()
                        <span class="hljs-comment"># 根据语言类型选择分词方式</span>
                        <span class="hljs-keyword">if</span> is_all_english(stripped_query):
                            words = stripped_query.split()  <span class="hljs-comment"># 英文按空格分词</span>
                        <span class="hljs-keyword">elif</span> is_all_chinese(stripped_query):
                            words = stripped_query  <span class="hljs-comment"># 中文按字符处理</span>
                        <span class="hljs-keyword">else</span>:
                            words = stripped_query  <span class="hljs-comment"># 混合语言默认按字符处理</span>

                        <span class="hljs-comment"># 取前N个关键词（去重）</span>
                        query_keywords = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(words[: self.query_key_words_limit]))

                    <span class="hljs-comment"># 创建查询监控项并添加到数据库</span>
                    item = QueryMonitorItem(
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        query_text=query,
                        keywords=query_keywords,
                        max_keywords=DEFAULT_MAX_QUERY_KEY_WORDS,
                    )

                    <span class="hljs-comment"># 同步到数据库</span>
                    query_db_manager = self.monitor.query_monitors[user_id][mem_cube_id]
                    query_db_manager.obj.put(item=item)
                    query_db_manager.sync_with_orm()  <span class="hljs-comment"># 添加后同步到数据库</span>

                <span class="hljs-comment"># 提取所有查询内容</span>
                queries = [msg.content <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages]

                <span class="hljs-comment"># 执行会话轮次处理（检索相关内存）</span>
                cur_working_memory, new_candidates = self.process_session_turn(
                    queries=queries,
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    top_k=self.top_k,
                )

                <span class="hljs-comment"># 重排序内存重排序并替换工作内存</span>
                new_order_working_memory = self.replace_working_memory(
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    original_memory=cur_working_memory,
                    new_memory=new_candidates,
                )

                <span class="hljs-comment"># 若启用激活内存，执行周期性更新</span>
                <span class="hljs-keyword">if</span> self.enable_activation_memory:
                    self.update_activation_memory_periodically(
                        interval_seconds=self.monitor.act_mem_update_interval,
                        label=QUERY_LABEL,
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        mem_cube=messages[<span class="hljs-number">0</span>].mem_cube,
                    )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_answer_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理和响应队列中的回答触发消息

        参数:
          messages: 要处理的回答消息列表
        """</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性</span>
        self.validate_schedule_messages(messages=messages, label=ANSWER_LABEL)

        <span class="hljs-comment"># 遍历分组消息，更新上下文（具体回答逻辑可在此扩展）</span>
        <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
            <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                messages = grouped_messages[user_id][mem_cube_id]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span>

                <span class="hljs-comment"># 从消息更新当前上下文</span>
                self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""处理和响应队列中的添加内存消息"""</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性</span>
        self.validate_schedule_messages(messages=messages, label=ADD_LABEL)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 遍历分组消息，处理每个添加内存请求</span>
            <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
                <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                    messages = grouped_messages[user_id][mem_cube_id]
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                        <span class="hljs-keyword">return</span>

                    <span class="hljs-comment"># 从消息更新当前上下文</span>
                    self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

                    <span class="hljs-comment"># 处理每条消息中的内存ID列表</span>
                    <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
                        <span class="hljs-keyword">try</span>:
                            <span class="hljs-comment"># 解析消息内容中的内存ID列表（JSON格式）</span>
                            userinput_memory_ids = json.loads(msg.content)
                        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                            userinput_memory_ids = []

                        <span class="hljs-comment"># 遍历内存ID，记录添加日志（跳过工作内存类型）</span>
                        mem_cube = msg.mem_cube
                        <span class="hljs-keyword">for</span> memory_id <span class="hljs-keyword">in</span> userinput_memory_ids:
                            mem_item: TextualMemoryItem = mem_cube.text_mem.get(memory_id=memory_id)
                            mem_type = mem_item.metadata.memory_type
                            mem_content = mem_item.memory

                            <span class="hljs-comment"># 跳过工作内存（通常不需要手动添加）</span>
                            <span class="hljs-keyword">if</span> mem_type == WORKING_MEMORY_TYPE:
                                <span class="hljs-keyword">continue</span>

                            <span class="hljs-comment"># 记录添加内存的日志</span>
                            self.log_adding_memory(
                                memory=mem_content,
                                memory_type=mem_type,
                                user_id=msg.user_id,
                                mem_cube_id=msg.mem_cube_id,
                                mem_cube=msg.mem_cube,
                                log_func_callback=self._submit_web_logs,
                            )

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_session_turn</span>(<span class="hljs-params">
        self,
        queries: <span class="hljs-built_in">str</span> | <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        user_id: UserID | <span class="hljs-built_in">str</span>,
        mem_cube_id: MemCubeID | <span class="hljs-built_in">str</span>,
        mem_cube: GeneralMemCube,
        top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    </span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">list</span>[TextualMemoryItem]] | <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理对话轮次：
        - 当查询列表达到窗口大小时，触发内存检索；
        - 若检索被触发，立即切换到新内存。
        """</span>

        <span class="hljs-comment"># 获取文本内存实例（仅支持TreeTextMemory类型）</span>
        text_mem_base = mem_cube.text_mem
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(text_mem_base, TreeTextMemory):
            logger.error(
                <span class="hljs-string">f"未实现！期望TreeTextMemory，但获取到<span class="hljs-subst">{<span class="hljs-built_in">type</span>(text_mem_base).__name__}</span> "</span>
                <span class="hljs-string">f"（mem_cube_id=<span class="hljs-subst">{mem_cube_id}</span>，user_id=<span class="hljs-subst">{user_id}</span>）。 "</span>
                <span class="hljs-string">f"text_mem_base值：<span class="hljs-subst">{text_mem_base}</span>"</span>,
                exc_info=<span class="hljs-literal">True</span>,
            )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 获取当前工作内存及文本内容</span>
        cur_working_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem] = text_mem_base.get_working_memory()
        text_working_memory: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = [w_m.memory <span class="hljs-keyword">for</span> w_m <span class="hljs-keyword">in</span> cur_working_memory]
        <span class="hljs-comment"># 检测查询意图（判断是否需要触发检索）</span>
        intent_result = self.monitor.detect_intent(
            q_list=queries, text_working_memory=text_working_memory
        )

        <span class="hljs-comment"># 检查是否达到时间触发条件</span>
        time_trigger_flag = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self.monitor.timed_trigger(
            last_time=self.monitor.last_query_consume_time,
            interval_seconds=self.monitor.query_trigger_interval,
        ):
            time_trigger_flag = <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 根据意图和时间触发条件决定是否执行检索</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> intent_result[<span class="hljs-string">"trigger_retrieval"</span>]) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> time_trigger_flag):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">elif</span> (<span class="hljs-keyword">not</span> intent_result[<span class="hljs-string">"trigger_retrieval"</span>]) <span class="hljs-keyword">and</span> time_trigger_flag:
            intent_result[<span class="hljs-string">"trigger_retrieval"</span>] = <span class="hljs-literal">True</span>
            intent_result[<span class="hljs-string">"missing_evidences"</span>] = queries
        <span class="hljs-keyword">else</span>:
            logger.info(
                <span class="hljs-string">f"触发查询调度（user_id=<span class="hljs-subst">{user_id}</span>，mem_cube_id=<span class="hljs-subst">{mem_cube_id}</span>）。 "</span>
                <span class="hljs-string">f"缺失证据：<span class="hljs-subst">{intent_result[<span class="hljs-string">'missing_evidences'</span>]}</span>"</span>
            )

        <span class="hljs-comment"># 处理缺失的证据（需要检索的内容）</span>
        missing_evidences = intent_result[<span class="hljs-string">"missing_evidences"</span>]
        num_evidence = <span class="hljs-built_in">len</span>(missing_evidences)
        <span class="hljs-comment"># 为每个证据分配Top-K配额（确保至少返回1条）</span>
        k_per_evidence = <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, top_k // <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, num_evidence))
        new_candidates = []

        <span class="hljs-comment"># 为每个缺失证据执行检索</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> missing_evidences:
            info = {
                <span class="hljs-string">"user_id"</span>: user_id,
                <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>,
            }

            <span class="hljs-comment"># 执行检索</span>
            results: <span class="hljs-built_in">list</span>[TextualMemoryItem] = self.retriever.search(
                query=item,
                mem_cube=mem_cube,
                top_k=k_per_evidence,
                method=self.search_method,
                info=info,
            )
            new_candidates.extend(results)

        <span class="hljs-comment"># 返回当前工作内存和新检索到的候选内存</span>
        <span class="hljs-keyword">return</span> cur_working_memory, new_candidates
</code></pre>
<h4 data-id="heading-10">2.2 SchedulerDispatcher</h4>
<p>SchedulerDispatcher 负责将消息路由到对应的processor。SchedulerDispatcher 不使用任何模型进行消息分发或分类判断。下面是它的工作原理：</p>
<ul>
<li>该类是基于线程池的消息分发器，核心作用是根据消息标签（label）将消息路由到对应的processor，实现消息的定向批量处理。</li>
<li>核心功能包括：支持单个 / 批量注册消息processor、按用户 ID 和内存立方体 ID 分组消息、串行 / 并行两种分发模式、优雅关闭和任务监控。</li>
<li>特色是采用上下文感知线程池（ContextThreadPoolExecutor），支持并行任务执行以提升效率；消息分组机制保证同用户同内存立方体的消息集中处理，避免上下文混乱；完善的任务生命周期管理（取消、等待、异常捕获）确保系统稳定。</li>
</ul>
<h5 data-id="heading-11">2.2.1 分发逻辑</h5>
<p>SchedulerDispatcher 是基于消息标签进行操作的，而不是使用任何机器学习模型或大语言模型进行分类，具体分发逻辑如下：</p>
<ul>
<li>
<p>消息分组：将消息按标签进行分组。</p>
</li>
<li>
<p>processor查找：依据标签查找注册的processor。处理函数在初始化时被明确注册。</p>
</li>
<li>
<p>执行模式：</p>
<ul>
<li>串行模式：直接调用processor</li>
<li>并行模式：通过线程池异步执行</li>
</ul>
</li>
</ul>
<p>消息通过其标签属性进行分发</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleMessageItem</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span>, ...</span>):
        self.label = label  <span class="hljs-comment"># 分发键</span>
        self.content = content
        <span class="hljs-comment"># ... 其他属性</span>
</code></pre>
<p>调度器使用简单的字典查找来路由消息到处理函数，在 SchedulerDispatcher.dispatch() 中：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">label_groups</span> = defaultdict(list)
for message in msg_list:
    label_groups<span class="hljs-section">[message.label]</span>.append(message)  <span class="hljs-comment"># 按标签分组</span>

for label, msgs in label_groups.items():
    <span class="hljs-attr">handler</span> = self.handlers.get(label, self._default_message_handler)
    handler(msgs)  <span class="hljs-comment"># 基于标签直接调用函数</span>
</code></pre>
<p>当启用并行分发时，也只是并行执行处理函数，但仍不使用模型进行路由：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> self.enable_parallel_dispatch <span class="hljs-keyword">and</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
    future = self.dispatcher_executor.submit(handler, msgs)  <span class="hljs-comment"># 并行执行</span>
</code></pre>
<p>消息流程示例</p>
<pre><code class="hljs language-arduino" lang="arduino">传入消息
├── 带有标签的消息 <span class="hljs-string">"query"</span>
│       ├── 没有模型参与确定使用哪个处理函数
│       │
│       ├── 按标签分组
│       │
│       └── 查找 <span class="hljs-string">"query"</span> 处理函数
│           ├── 调用已注册的 _query_message_consumer 函数直接调用
│
└── 并行处理（如果启用）
</code></pre>
<h5 data-id="heading-12">2.2.2 流程</h5>
<p>SchedulerDispatcher的流程如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72baa10ecb074c20bcd83eb8325dcae9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=QM4TR0FenXbmB1QYPpU%2BZswUP%2Fg%3D" alt="MemScheduler-7-3" loading="lazy"/></p>
<p>MemScheduler-7-3</p>
<h5 data-id="heading-13">2.2.3 代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerDispatcher</span>(<span class="hljs-title class_ inherited__">BaseSchedulerModule</span>):
    <span class="hljs-string">"""
    基于线程池的消息分发器，根据消息标签将消息路由到专用processor。

    特性：
    - 每个消息标签对应独立的线程池处理逻辑
    - 支持批量消息处理
    - 支持优雅关闭
    - 支持批量注册processor
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_workers=<span class="hljs-number">30</span>, enable_parallel_dispatch=<span class="hljs-literal">False</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.max_workers = max_workers  <span class="hljs-comment"># 线程池最大工作线程数</span>

        <span class="hljs-comment"># 仅在并行模式下初始化线程池</span>
        self.enable_parallel_dispatch = enable_parallel_dispatch
        self.thread_name_prefix = <span class="hljs-string">"dispatcher"</span>  <span class="hljs-comment"># 线程名称前缀</span>
        <span class="hljs-keyword">if</span> self.enable_parallel_dispatch:
            self.dispatcher_executor = ContextThreadPoolExecutor(
                max_workers=self.max_workers, thread_name_prefix=self.thread_name_prefix
            )
        <span class="hljs-keyword">else</span>:
            self.dispatcher_executor = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 串行模式下线程池为None</span>

        self.handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}  <span class="hljs-comment"># 已注册的消息processor（标签→processor映射）</span>
        self._running = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 分发器运行状态标识</span>
        self._futures = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># 用于监控的活跃任务集合</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_handler</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, handler: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[ScheduleMessageItem]], <span class="hljs-literal">None</span>]</span>):
        <span class="hljs-string">"""
        为特定消息标签注册processor函数。

        参数:
            label: 要处理的消息标签
            handler: 处理该标签消息的可调用对象，接收消息列表作为参数
        """</span>
        self.handlers[label] = handler

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_handlers</span>(<span class="hljs-params">
        self, handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[ScheduleMessageItem]], <span class="hljs-literal">None</span>]]
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        从字典中批量注册多个processor。

        参数:
            handlers: 标签到processor函数的映射字典，格式：{标签: processor可调用对象}
        """</span>
        <span class="hljs-keyword">for</span> label, handler <span class="hljs-keyword">in</span> handlers.items():
            <span class="hljs-comment"># 验证标签类型（必须为字符串）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(label, <span class="hljs-built_in">str</span>):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 验证processor是否可调用</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">callable</span>(handler):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 注册单个processor</span>
            self.register_handler(label=label, handler=handler)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_default_message_handler</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""默认消息processor（当找不到对应标签的processor时使用）"""</span>
        logger.debug(<span class="hljs-string">f"使用默认消息processor处理消息：<span class="hljs-subst">{messages}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">group_messages_by_user_and_cube</span>(<span class="hljs-params">
        self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]
    </span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[ScheduleMessageItem]]]:
        <span class="hljs-string">"""
        将消息按用户ID和内存立方体ID分组，生成嵌套字典结构。

        参数:
            messages: 要分组的ScheduleMessageItem对象列表

        返回:
            嵌套字典，结构如下：
            {
                "user_id_1": {
                    "mem_cube_id_1": [消息1, 消息2, ...],
                    "mem_cube_id_2": [消息3, 消息4, ...],
                    ...
                },
                "user_id_2": {
                    ...
                },
                ...
            }
            其中每个消息保持原始ScheduleMessageItem对象
        """</span>
        <span class="hljs-comment"># 初始化嵌套默认字典（自动创建不存在的键）</span>
        grouped_dict = defaultdict(<span class="hljs-keyword">lambda</span>: defaultdict(<span class="hljs-built_in">list</span>))

        <span class="hljs-comment"># 按用户ID→内存立方体ID的层级分组消息</span>
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
            grouped_dict[msg.user_id][msg.mem_cube_id].append(msg)

        <span class="hljs-comment"># 将默认字典转换为普通字典，输出更简洁</span>
        <span class="hljs-keyword">return</span> {user_id: <span class="hljs-built_in">dict</span>(cube_groups) <span class="hljs-keyword">for</span> user_id, cube_groups <span class="hljs-keyword">in</span> grouped_dict.items()}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_future_result</span>(<span class="hljs-params">self, future: Future</span>):
        <span class="hljs-string">"""处理异步任务结果，捕获异常并清理任务集合"""</span>
        self._futures.remove(future)  <span class="hljs-comment"># 从活跃任务集合中移除已完成任务</span>
         future.result()  <span class="hljs-comment"># 获取任务结果，触发可能的异常</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">self, msg_list: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>):
        <span class="hljs-string">"""
        将消息列表分发到对应的processor。

        参数:
            msg_list: 要处理的ScheduleMessageItem对象列表
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg_list:
            <span class="hljs-keyword">return</span>

        <span class="hljs-comment"># 按消息标签分组（同一标签的消息交给同一个processor）</span>
        label_groups = defaultdict(<span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> msg_list:
            label_groups[message.label].append(message)

        <span class="hljs-comment"># 处理每个标签对应的消息组</span>
        <span class="hljs-keyword">for</span> label, msgs <span class="hljs-keyword">in</span> label_groups.items():
            <span class="hljs-comment"># 获取该标签对应的processor，无则使用默认processor</span>
            handler = self.handlers.get(label, self._default_message_handler)
            <span class="hljs-comment"># 并行模式：提交任务到线程池异步执行</span>
            <span class="hljs-keyword">if</span> self.enable_parallel_dispatch <span class="hljs-keyword">and</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-comment"># 提交任务到线程池，捕获变量避免循环引用问题</span>
                future = self.dispatcher_executor.submit(handler, msgs)
                self._futures.add(future)  <span class="hljs-comment"># 将任务添加到活跃任务集合</span>
                <span class="hljs-comment"># 绑定任务完成回调函数</span>
                future.add_done_callback(self._handle_future_result)
                logger.info(<span class="hljs-string">f"已将 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(msgs)}</span> 条消息作为异步任务分发"</span>)
            <span class="hljs-comment"># 串行模式：直接调用processor同步执行</span>
            <span class="hljs-keyword">else</span>:
                handler(msgs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">join</span>(<span class="hljs-params">self, timeout: <span class="hljs-built_in">float</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""等待所有已分发任务完成。

        参数:
            timeout: 最大等待时间（秒），None表示无限等待

        返回:
            bool: 所有任务完成返回True，超时返回False
        """</span>
        <span class="hljs-comment"># 串行模式下无异步任务，直接返回True</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.enable_parallel_dispatch <span class="hljs-keyword">or</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 等待所有活跃任务完成</span>
        done, not_done = concurrent.futures.wait(
            self._futures, timeout=timeout, return_when=concurrent.futures.ALL_COMPLETED
        )

        <span class="hljs-comment"># 检查已完成任务中的异常</span>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> done:
            <span class="hljs-keyword">try</span>:
                future.result()
            <span class="hljs-keyword">except</span> Exception:
                logger.error(<span class="hljs-string">"关闭过程中processor执行失败"</span>, exc_info=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># 返回是否所有任务都已完成</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(not_done) == <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-14">2.3 SchedulerRetriever</h4>
<p>SchedulerRetriever 是MemOS中负责记忆检索和重排序的核心模块，是连接查询和记忆存储的关键桥梁，负责确保系统能够准确、高效地检索和排序相关记忆。</p>
<p>内存检索与推理的本质是：在正确时间找到正确信息。</p>
<h5 data-id="heading-15">2.3.1 功能</h5>
<p>SchedulerRetriever 的功能如下：</p>
<ul>
<li>
<p>记忆检索功能</p>
<ul>
<li>
<p>搜索实现：通过 search 方法在文本记忆库中查找与查询相关的记忆项</p>
</li>
<li>
<p>支持多种搜索模式：</p>
<ul>
<li>快速搜索（fast mode）</li>
<li>精细搜索（fine mode）</li>
<li>多类型记忆检索：同时搜索长期记忆和用户记忆</li>
</ul>
</li>
</ul>
</li>
<li>
<p>记忆重排序</p>
<ul>
<li>LLM辅助重排序：使用 rerank_memories 方法通过大语言模型对检索到的记忆进行重新排序</li>
<li>智能相关性判断：基于查询内容判断记忆的相关性，提升记忆使用的准确性</li>
</ul>
</li>
<li>
<p>记忆处理与过滤</p>
<ul>
<li>记忆去重：使用 filter_vector_based_similar_memories 过滤过于相似的记忆项</li>
<li>长度过滤：使用 filter_too_short_memories 移除过短的记忆项</li>
<li>无关记忆过滤：通过 filter_unrelated_memories 移除与当前查询历史无关的记忆</li>
<li>冗余记忆过滤：通过 filter_redundant_memories 移除重复的记忆项</li>
</ul>
</li>
<li>
<p>记忆整合：在 process_and_rerank_memories 方法中整合原始记忆和新检索的记忆，进行统一处理</p>
</li>
</ul>
<h5 data-id="heading-16">2.3.2 详细步骤说明</h5>
<p>SchedulerRetriever 的详细步骤如下：</p>
<ul>
<li>搜索阶段：根据查询在 TreeTextMemory 中搜索相关记忆项</li>
<li>合并阶段：将原始记忆和新检索的记忆合并成一个列表</li>
<li>相似度过滤：使用相似度移除过于相似的记忆项</li>
<li>长度过滤：移除过短的记忆项（默认阈值为6个字符）</li>
<li>去重处理：确保记忆项唯一性，同时保持原有顺序</li>
<li>LLM重排序：利用大语言模型根据查询相关性对记忆进行重新排序</li>
<li>无关记忆过滤：移除与查询历史无关的记忆项</li>
<li>返回结果：返回优化后的记忆列表供系统使用</li>
</ul>
<h5 data-id="heading-17">2.3.3 调用关系</h5>
<p>一般来说，业界的<strong>检索时机</strong>有两种主要方法：</p>
<ul>
<li><strong>主动检索</strong>：在每轮开始时自动加载记忆，确保上下文始终可用，但会为不需要记忆访问的轮次引入不必要延迟</li>
<li><strong>反应式检索</strong>（内存即工具）：代理被赋予查询记忆的工具，自行决定何时检索上下文，更高效但需要额外LLM调用</li>
</ul>
<p>SchedulerRetriever 作为 BaseScheduler 的核心组件，主要在处理用户查询和更新工作记忆时被调用，负责记忆的检索、处理、重排序和过滤等核心功能，具体场景为：</p>
<ul>
<li>初始化：在BaseScheduler 的initialize_modules中建立SchedulerRetriever 实例。</li>
<li>查询处理：当 GeneralScheduler 接收到 QUERY_LABEL 消息时，调用 process_session_turn 方法触发 self.retriever.search() 来检索相关记忆。</li>
<li>工作记忆更新：在 replace_working_memory 过程中对候选记忆进行处理和重排序</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">└── GeneralScheduler<span class="hljs-selector-class">._query_message_consumer</span>()
  └── BaseScheduler<span class="hljs-selector-class">.process_session_turn</span>()
      └── SchedulerRetriever<span class="hljs-selector-class">.search</span>() --------&gt; 检索相关记忆

└── BaseScheduler<span class="hljs-selector-class">.replace_working_memory</span>()
  └── SchedulerRetriever<span class="hljs-selector-class">.process_and_rerank_memories</span>() ------&gt; 处理和重排序记忆
      └──SchedulerRetriever<span class="hljs-selector-class">.filter_unrelated_memories</span>() -----&gt; 过滤无关记忆
</code></pre>
<h5 data-id="heading-18">2.3.4 实现</h5>
<h6 data-id="heading-19">记忆检索流程（search 方法）</h6>
<p>作为对比，从业界角度看，一般会从多个维度评估潜在记忆，单纯依赖基于向量的相关性是常见陷阱。相似性得分可能找出概念相似但过时或琐碎的记忆。最有效策略是结合所有三个维度的混合方法：</p>
<ul>
<li><strong>相关性</strong>（语义相似性）：与当前对话的概念关联度</li>
<li><strong>新鲜度</strong>（基于时间）：记忆创建的时间远近</li>
<li><strong>重要性</strong>（显著性）：记忆的整体关键程度</li>
</ul>
<p>SchedulerRetriever的 search方法会 调用TreeTextMemory的功能来进行搜索。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b481cf8e011f472a93424e1e15ebcf75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=vlJ44ps50w2OktbWa8%2FP72Vmhds%3D" alt="MemScheduler-7-4" loading="lazy"/></p>
<p>MemScheduler-7-4</p>
<h6 data-id="heading-20">记忆全流程处理与重排（process_and_rerank_memories 方法）</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60961cfd9ddc4878b29ef610db7835ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=hFyWesdUUFA1SLK85KM1y9ovhJA%3D" alt="MemScheduler-7-5" loading="lazy"/></p>
<p>MemScheduler-7-5</p>
<h6 data-id="heading-21">LLM 记忆重排流程（rerank_memories 方法）</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc35684fd284404a9c275d6bf56cd1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=Sbr9MiAczBUq0rFkB5%2BXweQCcTk%3D" alt="MemScheduler-7-6" loading="lazy"/></p>
<p>MemScheduler-7-6</p>
<h6 data-id="heading-22">代码</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerRetriever</span>(<span class="hljs-title class_ inherited__">BaseSchedulerModule</span>):
    <span class="hljs-string">"""
    MemOS 记忆检索与优化调度器
    核心功能：检索树状文本内存、合并新旧记忆、多维度过滤、LLM 智能重排，为 Agent 提供精准记忆支持
    继承自 BaseSchedulerModule，遵循 MemOS 调度器模块统一接口规范
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, process_llm: BaseLLM, config: BaseSchedulerConfig</span>):
        <span class="hljs-string">"""
        初始化检索调度器实例
        Args:
            process_llm: 用于记忆重排的 LLM 实例（BaseLLM 基类对象）
            config: 调度器配置对象（BaseSchedulerConfig 基类，包含过滤、检索等参数）
        """</span>
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类 BaseSchedulerModule 的初始化方法</span>

        <span class="hljs-comment"># 超参数配置：记忆过滤阈值</span>
        self.filter_similarity_threshold = <span class="hljs-number">0.75</span>  <span class="hljs-comment"># 相似度过滤阈值（≥0.75 的记忆视为重复）</span>
        self.filter_min_length_threshold = <span class="hljs-number">6</span>     <span class="hljs-comment"># 长度过滤阈值（字符数＜6 的记忆视为过短，将被过滤）</span>

        self.config: BaseSchedulerConfig = config  <span class="hljs-comment"># 保存调度器配置</span>
        self.process_llm = process_llm             <span class="hljs-comment"># 保存用于重排的 LLM 实例</span>

        <span class="hljs-comment"># 初始化记忆过滤器：委托处理「无关记忆」和「冗余记忆」过滤逻辑</span>
        self.memory_filter = MemoryFilter(process_llm=process_llm, config=config)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">
        self,
        query: <span class="hljs-built_in">str</span>,
        mem_cube: GeneralMemCube,
        top_k: <span class="hljs-built_in">int</span>,
        method: <span class="hljs-built_in">str</span> = TreeTextMemory_SEARCH_METHOD,
        info: <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">list</span>[TextualMemoryItem]:
        <span class="hljs-string">"""
        根据查询语句在文本内存中检索相关记忆
        Args:
            query: 检索查询字符串（如 Agent 的当前对话查询）
            mem_cube: 记忆立方体（GeneralMemCube，MemOS 中存储各类记忆的核心数据结构）
            top_k: 返回的Top-K 相关记忆数量
            method: 检索方法（默认使用 TreeTextMemory 的标准搜索方法）
            info: 检索附加信息（需包含 user_id、session_id，用于记录记忆使用历史）

        Returns:
            检索到的文本型记忆项列表（list[TextualMemoryItem]）；检索失败返回空列表
        """</span>
        text_mem_base = mem_cube.text_mem  <span class="hljs-comment"># 从记忆立方体中提取文本内存核心实例</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 仅支持 TreeTextMemory 的两种检索方法</span>
            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> [TreeTextMemory_SEARCH_METHOD, TreeTextMemory_FINE_SEARCH_METHOD]:
                <span class="hljs-comment"># 断言文本内存类型为 TreeTextMemory（确保检索方法兼容性）</span>
                <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(text_mem_base, TreeTextMemory)
                <span class="hljs-comment"># 若未传入 info，打印警告并初始化空信息（用于历史记录存储）</span>
                <span class="hljs-keyword">if</span> info <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                    info = {<span class="hljs-string">"user_id"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>}

                <span class="hljs-comment"># 根据检索方法设置模式：快速搜索（fast）或精细搜索（fine）</span>
                mode = <span class="hljs-string">"fast"</span> <span class="hljs-keyword">if</span> method == TreeTextMemory_SEARCH_METHOD <span class="hljs-keyword">else</span> <span class="hljs-string">"fine"</span>
                <span class="hljs-comment"># 检索长期记忆（LongTermMemory）</span>
                results_long_term = text_mem_base.search(
                    query=query, top_k=top_k, memory_type=<span class="hljs-string">"LongTermMemory"</span>, mode=mode, info=info
                )
                <span class="hljs-comment"># 检索用户记忆（UserMemory）</span>
                results_user = text_mem_base.search(
                    query=query, top_k=top_k, memory_type=<span class="hljs-string">"UserMemory"</span>, mode=mode, info=info
                )
                <span class="hljs-comment"># 合并长期记忆和用户记忆的检索结果</span>
                results = results_long_term + results_user
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 不支持的检索方法：抛出未实现异常（传入文本内存类型）</span>
                <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>(text_mem_base)))
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 检索异常：打印错误日志（包含堆栈信息），返回空列表</span>
            logger.error(<span class="hljs-string">f"Fail to search. The exeption is <span class="hljs-subst">{e}</span>."</span>, exc_info=<span class="hljs-literal">True</span>)
            results = []
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_memories</span>(<span class="hljs-params">
        self, queries: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], original_memories: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], top_k: <span class="hljs-built_in">int</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        基于 LLM 对记忆进行相关性重排（根据查询语句调整记忆顺序）
        Args:
            queries: 用于判断相关性的查询列表（通常为当前对话查询）
            original_memories: 待重排的记忆文本列表
            top_k: 重排后返回的 Top-K 记忆数量

        Returns:
            Tuple[重排后的记忆文本列表（长度≤top_k）, 重排成功标志（bool）]

        Note:
            若 LLM 重排失败（如 JSON 解析异常），降级为原始记忆顺序（截断至 top_k）
        """</span>

        logger.info(<span class="hljs-string">f"Starting memory reranking for <span class="hljs-subst">{<span class="hljs-built_in">len</span>(original_memories)}</span> memories"</span>)

        <span class="hljs-comment"># 构建 LLM 重排提示词（使用 "memory_reranking" 模板）</span>
        prompt = self.build_prompt(
            <span class="hljs-string">"memory_reranking"</span>,
            queries=[<span class="hljs-string">f"[0] <span class="hljs-subst">{queries[<span class="hljs-number">0</span>]}</span>"</span>],  <span class="hljs-comment"># 格式化查询（仅取第一个查询，标记为 [0]）</span>
            current_order=[<span class="hljs-string">f"[<span class="hljs-subst">{i}</span>] <span class="hljs-subst">{mem}</span>"</span> <span class="hljs-keyword">for</span> i, mem <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(original_memories)],  <span class="hljs-comment"># 格式化原始记忆顺序</span>
        )

        <span class="hljs-comment"># 调用 LLM 生成重排结果（构造用户角色消息）</span>
        response = self.process_llm.generate([{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}])

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 解析 LLM 响应中的 JSON 数据（期望格式：{"new_order": [索引列表], "reasoning": "重排理由"}）</span>
            response = extract_json_dict(response)
            new_order = response[<span class="hljs-string">"new_order"</span>][:top_k]  <span class="hljs-comment"># 提取 Top-K 索引顺序</span>
            <span class="hljs-comment"># 根据新索引映射回原始记忆文本</span>
            text_memories_with_new_order = [original_memories[idx] <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> new_order]
            success_flag = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 重排成功标志</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 重排异常（如 JSON 解析失败、键缺失）：打印错误日志，使用原始顺序降级</span>
            text_memories_with_new_order = original_memories[:top_k]  <span class="hljs-comment"># 截断原始记忆至 top_k</span>
            success_flag = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 重排失败标志</span>
        <span class="hljs-keyword">return</span> text_memories_with_new_order, success_flag

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_and_rerank_memories</span>(<span class="hljs-params">
        self,
        queries: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        original_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem],
        new_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem],
        top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem]], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        记忆全流程处理：合并新旧记忆 → 过滤冗余/过短记忆 → LLM 重排 → 返回优化后记忆
        Args:
            queries: 用于重排的查询列表（判断记忆相关性的依据）
            original_memory: 原始记忆列表（已存储的历史记忆，TextualMemoryItem 类型）
            new_memory: 新记忆列表（待合并的新增记忆，TextualMemoryItem 类型）
            top_k: 最终返回的最大记忆数量（默认 10）

        Returns:
            Tuple[优化后的 TextualMemoryItem 列表（长度≤top_k）, 处理成功标志（bool）]；失败返回 (None, False)
        """</span>
        <span class="hljs-comment"># 1. 合并原始记忆和新记忆（形成完整记忆池）</span>
        combined_memory = original_memory + new_memory

        <span class="hljs-comment"># 2. 构建「归一化文本→记忆对象」的映射（用于后续重排后还原记忆对象）</span>
        <span class="hljs-comment"># transform_name_to_key：文本归一化函数（如去空格、小写，确保匹配一致性）</span>
        memory_map = {
            transform_name_to_key(name=mem_obj.memory): mem_obj <span class="hljs-keyword">for</span> mem_obj <span class="hljs-keyword">in</span> combined_memory
        }

        <span class="hljs-comment"># 2. 提取所有记忆的文本内容（用于过滤和重排）</span>
        combined_text_memory = [m.memory <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> combined_memory]

        <span class="hljs-comment"># 4. 相似度过滤：移除过于相似的记忆（基于向量相似度，阈值 0.75）</span>
        filtered_combined_text_memory = filter_vector_based_similar_memories(
            text_memories=combined_text_memory,
            similarity_threshold=self.filter_similarity_threshold,
        )

        <span class="hljs-comment"># 5. 长度过滤：移除过短记忆（字符数＜6 的记忆视为无效，阈值 6）</span>
        filtered_combined_text_memory = filter_too_short_memories(
            text_memories=filtered_combined_text_memory,
            min_length_threshold=self.filter_min_length_threshold,
        )

        <span class="hljs-comment"># 6. 去重：基于归一化文本的字典去重（保留原始顺序）</span>
        unique_memory = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">dict</span>.fromkeys(filtered_combined_text_memory))

        <span class="hljs-comment"># 7. LLM 智能重排：按与查询的相关性调整记忆顺序</span>
        text_memories_with_new_order, success_flag = self.rerank_memories(
            queries=queries,
            original_memories=unique_memory,
            top_k=top_k,
        )

        <span class="hljs-comment"># 8. 映射回原始记忆对象（从文本列表还原为 TextualMemoryItem 列表）</span>
        memories_with_new_order = []
        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> text_memories_with_new_order:
            normalized_text = transform_name_to_key(name=text)  <span class="hljs-comment"># 文本归一化（确保与 memory_map 键匹配）</span>
            <span class="hljs-keyword">if</span> normalized_text <span class="hljs-keyword">in</span> memory_map:  <span class="hljs-comment"># 检查归一化文本是否存在于映射中</span>
                memories_with_new_order.append(memory_map[normalized_text])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 日志警告：记忆文本未找到映射（可能是归一化异常或记忆对象缺失）</span>
                logger.warning(
                    <span class="hljs-string">f"Memory text not found in memory map. text: <span class="hljs-subst">{text}</span>;\n"</span>
                    <span class="hljs-string">f"Keys of memory_map: <span class="hljs-subst">{memory_map.keys()}</span>"</span>
                )

        <span class="hljs-keyword">return</span> memories_with_new_order, success_flag

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_unrelated_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        过滤与查询历史无关的记忆（委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（Agent 的对话历史）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_unrelated_memories(query_history, memories)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_redundant_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        过滤冗余记忆（委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（判断冗余的上下文依据）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_redundant_memories(query_history, memories)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_unrelated_and_redundant_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        同时过滤「无关记忆」和「冗余记忆」（基于 LLM 分析，委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（上下文依据）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_unrelated_and_redundant_memories(query_history, memories)
</code></pre>
<h3 data-id="heading-23">0x03 关联</h3>
<p>SchedulerDispatcher、GeneralScheduler 和 TreeTextMemory 之间存在明确的依赖和协作关系。</p>
<h4 data-id="heading-24">3.1 SchedulerDispatcher 和 GeneralScheduler</h4>
<p>SchedulerDispatcher 负责消息的分发和处理，是一个底层的消息处理组件。GeneralScheduler 是一个更高级别的调度器，利用 SchedulerDispatcher 来管理不同类型的消息（如查询、回答、添加记忆等）。</p>
<ul>
<li>GeneralScheduler 依赖 SchedulerDispatcher</li>
<li>SchedulerDispatcher 是 GeneralScheduler 的一个组件，在 GeneralScheduler 的 init 方法中，创建了一个 SchedulerDispatcher 实例并赋值给 self.dispatcher</li>
</ul>
<p>GeneralScheduler 使用 self.dispatcher 来：</p>
<ul>
<li>注册消息处理器（handlers）</li>
<li>分发消息（通过 self.dispatcher.dispatch()）</li>
<li>批量处理消息（通过 self.dispatcher.group_messages_by_user_and_cube()）</li>
<li>等待任务完成（通过 self.dispatcher.join()）</li>
<li>关闭调度器（通过 self.dispatcher.shutdown()）</li>
</ul>
<h4 data-id="heading-25">3.2 GeneralScheduler 和 TreeTextMemory</h4>
<p>TreeTextMemory 是记忆存储和检索的核心组件，提供了添加、搜索、更新和删除记忆的功能，GeneralScheduler 利用 TreeTextMemory 来管理记忆的生命周期，处理与记忆相关的各种操作。</p>
<ul>
<li>GeneralScheduler 依赖 TreeTextMemory来执行实际的记忆操作</li>
<li>TreeTextMemory 提供了 GeneralScheduler 所需的记忆存储和检索功能</li>
</ul>
<p>GeneralScheduler 通过 mem_cube.text_mem 访问 TreeTextMemory 实例，GeneralScheduler 使用 TreeTextMemory 来：</p>
<ul>
<li>
<p>TreeTextMemory 包含了 MemoryManager 和 Searcher 等组件，这些组件被 GeneralScheduler 间接使用</p>
</li>
<li>
<p>获取工作记忆（通过 text_mem_base.get_working_memory()）</p>
</li>
<li>
<p>搜索记忆（通过 self.retriever.search()，其中 retriever 使用 TreeTextMemory 的搜索功能），检索过程涉及：</p>
<ul>
<li>使用 TaskGoalParser 解析查询</li>
<li>使用 GraphMemoryRetriever 从图数据库检索记忆</li>
<li>使用 Reranker 对检索到的记忆进行重排序</li>
<li>使用 MemoryReasoner 进行推理以优化结果</li>
</ul>
</li>
<li>
<p>添加记忆（通过 self.memory_manager.add()，其中 memory_manager 与 TreeTextMemory 相关联）</p>
</li>
<li>
<p>替换工作记忆（通过 text_mem_base.replace_working_memory()）</p>
</li>
<li>
<p>获取记忆（通过 mem_cube.text_mem.get(memory_id=memory_id)）</p>
</li>
<li>
<p>GeneralScheduler 接收不同类型的消息（查询、回答、添加记忆等），根据消息类型，GeneralScheduler 调用相应的处理器，处理器使用 TreeTextMemory 的方法来执行具体操作</p>
</li>
</ul>
<p>GeneralScheduler 和 TreeTextMemory 之间是一种协作关系，其中：</p>
<ul>
<li>GeneralScheduler 是一个高级调度器，负责处理不同类型的消息并协调记忆操作</li>
<li>TreeTextMemory 是记忆操作的实际执行者，提供了存储、检索、更新和组织记忆的功能</li>
</ul>
<p>两者通过定义良好的接口进行交互，GeneralScheduler 调用 TreeTextMemory 的方法来执行具体操作 这种设计实现了关注点分离，使调度逻辑和记忆管理逻辑可以独立开发和维护。</p>
<p>协作范例如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># GeneralScheduler 处理查询消息的简化流程</span>
def process_query(self, query, mem_cube):
    <span class="hljs-comment"># 1. 获取当前工作记忆</span>
    <span class="hljs-attr">current_memory</span> = mem_cube.text_mem.get_working_memory()
    <span class="hljs-comment"># 2. 检索相关记忆</span>
    <span class="hljs-attr">new_candidates</span> = mem_cube.text_mem.search(query, top_k=self.top_k)
    <span class="hljs-comment"># 3. 更新工作记忆</span>
    mem_cube.text_mem.replace_working_memory(new_candidates)
</code></pre>
<h4 data-id="heading-26">3.3 总结</h4>
<p>三者之间的依赖关系可以概括为：</p>
<ul>
<li>GeneralScheduler → SchedulerDispatcher（使用其进行消息分发）</li>
<li>GeneralScheduler → TreeTextMemory（使用其进行记忆操作）</li>
</ul>
<p>具体来说：</p>
<ul>
<li>SchedulerDispatcher 是一个消息分发器，负责将不同类型的消息路由到相应的处理器</li>
<li>GeneralScheduler 是一个高级调度器，它使用 SchedulerDispatcher 来管理消息，并使用 TreeTextMemory 来处理与记忆相关的操作</li>
<li>TreeTextMemory 是记忆存储和检索的核心组件，为 GeneralScheduler 提供底层的记忆操作支持</li>
</ul>
<p>这种设计使得系统能够有效地处理不同类型的消息，并对记忆进行相应的操作，实现了消息处理和记忆管理的解耦。</p>
<h4 data-id="heading-27">3.4 MosCore</h4>
<p>MosCore 是一个很好的范例。</p>
<pre><code class="hljs language-diff" lang="diff">MosCore
<span class="hljs-deletion">- uses GeneralMemCube</span>
<span class="hljs-deletion">- uses GeneralScheduler</span>
  - uses MemoryManager
  - uses TreeTextMemory
<span class="hljs-deletion">- uses UserManager</span>
</code></pre>
<p>在如下代码中，可以管窥。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MOSCore</span>:
    <span class="hljs-string">"""
    The MOSCore (Memory Operating System Core) class manages multiple MemCube objects and their operations.
    It provides methods for creating, searching, updating, and deleting MemCubes, supporting multi-user scenarios.
    MOSCore acts as an operating system layer for handling and orchestrating MemCube instances.
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: MOSConfig, user_manager: UserManager | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>):
        self.config = config
        self.user_id = config.user_id
        self.session_id = config.session_id
        self.chat_llm = LLMFactory.from_config(config.chat_model)
        self.mem_reader = MemReaderFactory.from_config(config.mem_reader)
        self.chat_history_manager: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, ChatHistory] = {}
        <span class="hljs-comment"># use thread safe dict for multi-user product-server scenario</span>
        self.mem_cubes: OptimizedThreadSafeDict[<span class="hljs-built_in">str</span>, GeneralMemCube] = (
            OptimizedThreadSafeDict() <span class="hljs-keyword">if</span> user_manager <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> {}
        )
        self._register_chat_history()

        <span class="hljs-comment"># Use provided user_manager or create a new one</span>
        <span class="hljs-keyword">if</span> user_manager <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.user_manager = user_manager
        <span class="hljs-keyword">else</span>:
            self.user_manager = UserManager(user_id=self.user_id <span class="hljs-keyword">if</span> self.user_id <span class="hljs-keyword">else</span> <span class="hljs-string">"root"</span>)

        <span class="hljs-comment"># Initialize mem_scheduler</span>
        self._mem_scheduler_lock = Lock()
        self.enable_mem_scheduler = self.config.get(<span class="hljs-string">"enable_mem_scheduler"</span>, <span class="hljs-literal">False</span>)
        <span class="hljs-keyword">if</span> self.enable_mem_scheduler:
            self._mem_scheduler = self._initialize_mem_scheduler()
            self._mem_scheduler.mem_cubes = self.mem_cubes
        <span class="hljs-keyword">else</span>:
            self._mem_scheduler: GeneralScheduler = <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-28">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣]]></title>    <link>https://juejin.cn/post/7585645111876468763</link>    <guid>https://juejin.cn/post/7585645111876468763</guid>    <pubDate>2025-12-21T16:25:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111876468763" data-draft-id="7585808181239218227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-21T16:25:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="围巾哥萧尘"/> <meta itemprop="url" content="https://juejin.cn/user/1222312659548446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1222312659548446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    围巾哥萧尘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T16:25:20.000Z" title="Sun Dec 21 2025 16:25:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣</h2>
<p><strong>摘要：</strong> 本实践旨在探讨利用 Qoder 平台（面向真实 Agent 的资本体编程平台）进行浏览器扩展程序自动化开发的流程。通过 Qoder 命令行界面（CLI），开发者能够以对话模式快速构建功能性插件。本文以“视频加速器”开发为例，详细记录了我从环境配置、身份验证到多轮提示词驱动的迭代开发过程，并针对开发中的界面优化及编码问题提出了避坑指南。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7d3d6f694143c7ac8cd43907944b8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766939120&amp;x-signature=1KSWPnOu4wx2W6EvmpOIZygo8Wo%3D" alt="d676c046e89d4ef99658dafc09897171preview.jpeg~tplv-a9rns2rl98-image_pre_watermark_1_6b.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1maBEBoEh7%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1maBEBoEh7/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">使用Qoder完成视频加速器的Chrome谷歌插件开发实例 | @围巾哥萧尘🧣 #Qoder #Chrome</a></p>
<p><strong>关键词：</strong> Qoder；CLI；AI 编程；Chrome 插件；自动化开发</p>
<hr/>
<h4 data-id="heading-1">一、 引言</h4>
<p>在当前 AI 驱动的软件工程背景下，Qoder 已发展成为涵盖 IDE、CLI 及插件三种形态的成熟编程辅助平台。相较于传统的 IDE 模式，Qoder CLI 在近期测试中表现出极高的灵活性，尤其适用于快速原型设计与特定功能插件的迭代。</p>
<h4 data-id="heading-2">二、 开发环境配置与准备</h4>
<p>在启动项目前，必须完成 Qoder 运行环境的搭建。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb72f2d50044353b18f14162309f3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766939120&amp;x-signature=p8L7yVQWho%2B7aWYNYdIzt59LSKA%3D" alt="截屏2025-12-22 00.00.11.png" loading="lazy"/></p>
<ol>
<li>
<p><strong>安装步骤</strong>：Qoder CLI 支持多种安装方式，包括使用 <code>brew</code> 或 <code>npm</code> 进行全局部署。</p>
<ul>
<li><strong>避坑指南</strong>：受网络环境影响，安装过程可能耗时较长，建议在稳定的网络条件下进行或使用代理。</li>
</ul>
</li>
<li>
<p><strong>版本校验</strong>：本实验采用的版本为 <code>0.1.8</code>。</p>
</li>
<li>
<p><strong>身份验证</strong>：通过执行登录指令，系统提供交互式界面（Interactive Page）验证身份，从而完成本地 CLI 与平台的链接。</p>
</li>
</ol>
<h4 data-id="heading-3">三、 结构化开发流程与提示词执行</h4>
<p>本节详细展示了如何通过精准的提示词（Prompts）引导 AI 完成从零到一的开发。</p>
<h5 data-id="heading-4">步骤 1：项目初始化与初步生成</h5>
<ul>
<li><strong>操作描述</strong>：在空文件夹中启动对话模式，直接下达任务目标。</li>
<li><strong>核心提示词</strong>： <strong>“制作一款视频加速器的插件”</strong> 。</li>
<li><strong>执行结果</strong>：AI 自动生成了包括打包文件（Manifest）、脚本文件及 Readme 文档在内的基础结构，初步构建耗时约 5 分钟。</li>
</ul>
<h5 data-id="heading-5">步骤 2：功能扩展与参数自定义（迭代 V2-V3）</h5>
<ul>
<li><strong>操作描述</strong>：针对默认倍速范围有限的问题（初始仅支持 0.8-1.25 倍），要求 AI 扩展倍速区间。</li>
<li><strong>核心提示词</strong>： <strong>“修改倍速区间，使其能够达到从 5 倍到 16 倍”</strong> 。</li>
<li><strong>执行结果</strong>：系统完成逻辑更新，成功支持自定义高倍速播放。</li>
</ul>
<h5 data-id="heading-6">步骤 3：UI 优化与乱码修复（迭代 V4）</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70e2a8b43a1479c9114cfceb7e741fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766939120&amp;x-signature=lb7uq4T2z%2FITMVBdyuZA72P%2BiPk%3D" alt="截屏2025-12-22 00.21.06.png" loading="lazy"/></p>
<ul>
<li><strong>操作描述</strong>：解决开发中出现的界面文字乱码及视觉排版问题。</li>
<li><strong>核心提示词</strong>： <strong>“优化界面 UI，修复文字乱码问题”</strong> 。</li>
<li><strong>经验总结</strong>：在 AI 生成代码时，<strong>提示词的精准度直接决定了开发效率</strong>。越具体的 UI 描述越能减少冗余的迭代轮次。</li>
</ul>
<h4 data-id="heading-7">四、 结果分析与讨论</h4>
<h5 data-id="heading-8">4.1 功能验证</h5>
<p>实测证明，该插件在视频播放页面能够稳定运行。除了预设的 <code>0.5</code>、<code>0.75</code> 等基础倍速外，用户可通过自定义输入框设置如 <code>4.5</code> 倍等非标准速度，功能达标。</p>
<h5 data-id="heading-9">4.2 工具评价</h5>
<p>Qoder 目前在 Agent 编程领域已展现出接近 Cursor 的成熟度。其优势在于：</p>
<ul>
<li><strong>开发效率</strong>：从零开始到完成插件优化，总耗时仅约 15 分钟。</li>
<li><strong>易用性</strong>：即便没有经过深厚编程训练的个体，也能通过自然语言描述实现功能。</li>
</ul>
<h4 data-id="heading-10">五、 经验总结与个人见解</h4>
<ol>
<li><strong>避坑指南：</strong> 在使用 CLI 进行多轮修改时，务必关注 AI 生成的 V3、V4 等版本差异。如果出现乱码，通常是字符编码或 HTML 头部声明缺失，应明确要求 AI “使用 UTF-8 编码重新生成界面”。</li>
<li><strong>提效技巧：</strong> 优秀的 AI 编程并非完全脱离代码，而是**“比拼对工具的掌控力”**。开发者应学会将复杂问题拆解为多个微小指令，提高 AI 响应的精确度。</li>
<li><strong>行业前瞻：</strong> 2025 年至 2026 年将是 AI 编程工具竞争的白热化阶段。未来的核心竞争力将不仅在于模型质量，更在于如何解决“非编程用户”的实际问题，实现真正的 Natural Language Programming（自然语言编程）。</li>
</ol>
<hr/>
<p><strong>结论：</strong> 通过 Qoder CLI 开发 Chrome 插件是一条极高效率的路径。<strong>这种开发模式就像是在指挥一位反应极快的实习生：你不需要亲自动手写每一行代码，但你需要清晰地告诉他“桌子要挪到哪里”以及“桌布要什么颜色”。</strong> 当你掌握了与 AI 沟通的节奏，开发逻辑将从“如何写”转向“如何定义需求”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三年前，我帮万人转Go；今天，聊聊Go/Java程序员如何抢占AI高地]]></title>    <link>https://juejin.cn/post/7586263211087986714</link>    <guid>https://juejin.cn/post/7586263211087986714</guid>    <pubDate>2025-12-22T06:59:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586263211087986714" data-draft-id="7585920796100968475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三年前，我帮万人转Go；今天，聊聊Go/Java程序员如何抢占AI高地"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-22T06:59:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三年前，我帮万人转Go；今天，聊聊Go/Java程序员如何抢占AI高地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:59:23.000Z" title="Mon Dec 22 2025 06:59:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>从“调包侠”到“智能体架构师”，你需要的是思维升维，这才是1，其他的都是0。</p>
</blockquote>
<h2 data-id="heading-0">为什么要写这篇文章：</h2>
<p>三年前，我写过一篇《<a href="https://juejin.cn/post/7147939014870302756" target="_blank" title="https://juejin.cn/post/7147939014870302756">给想转Go或者Go进阶同学的一些建议</a>》，有幸在稀土掘金获得了近<strong>8万</strong>的阅读量，帮助了许多正在转型和迷茫中的开发者。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfac36d5ea2f485ca361ee321eb3317b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=9MFtsZVCT%2Fz9iJr4bgxu6wQ90%2BA%3D" alt="image.png" loading="lazy"/></p>
<p>今天，我们站在<strong>2026年</strong>的门槛上，技术浪潮已从云计算、移动互联网，无可争议地转向了人工智能。我最近一年All in在AI应用开发领域，密集交付了多个企业级AI项目，阅读、剖析了<strong>几十个</strong>高质量的AI开源应用代码，也评测了大量付费课程。</p>
<p>这篇文章，我将结合这些<strong>最新的、一线的实战认知</strong>，为你梳理一条在2026年，从传统开发转向AI应用开发的清晰路径。如果说三年前的文章是关于“<strong>编程思维</strong>”的转变，那么今天这篇，就是关于“<strong>智能构建思维</strong>”的跃迁。</p>
<p>我的核心结论依旧直接：</p>
<p><strong>2026年，从传统开发转向AI开发，最大的障碍不是学习新工具，而是从“业务逻辑实现者”到“智能工作流设计者”的思维重塑。对于广大Go/Java等后端开发者而言，你们的工程化能力正是AI时代最急需的稀缺品，机会远大于挑战。</strong></p>
<h2 data-id="heading-1">先说核心结论</h2>
<ol>
<li><strong>思维决胜</strong>：忘掉“我是XX语言程序员”的标签。AI时代最需要的是“<strong>智能体工作流架构师</strong>”。你的价值不再是单纯实现CRUD，而是设计多个智能体如何协同、可靠地完成复杂任务。（知易行难，不要给自己加标签，加束缚，AI时代，编程语言已经不存在界限了！）</li>
<li><strong>学习路径巨变</strong>：别再走“从头推导模型”的学术老路。2026年的高效路径是 <strong>“三层框架法”</strong>：<strong>感知层（会玩）→ 学习层（会改）→ 构建层（会造）</strong>。</li>
<li><strong>能力锚点迁移</strong>：你擅长的“<strong>高并发</strong>”、“<strong>高可用</strong>”架构思想，在AI时代等价于“<strong>复杂工作流编排与推理成本优化</strong>”。你熟悉的Go/Java/Python等语言在性能、并发和工程化上的优势，在<strong>AI工程化</strong>阶段将全面爆发。</li>
<li><strong>机会在垂直领域</strong>：大模型本身解决不了“<strong>行业特定知识</strong>”和“<strong>确定性的业务流程</strong>”。这里藏着普通开发者的最大机会——<strong>垂直领域AI应用</strong>。它的壁垒是你的<strong>行业知识+工程化能力</strong>，而非顶尖AI实验室的博士学位。</li>
<li><strong>新范式</strong>：AI原生应用不是“APP+大模型接口”。它的内核是 <strong>“智能体（Agent）协同网络”</strong>。理解并掌握这一点，<strong>是你摆脱“调包侠”命运、建立核心竞争力的关键。</strong></li>
</ol>
<h2 data-id="heading-2">我的观察：2026年AI应用开发的三重境界</h2>
<p>过去一年的深度实践，让我清晰地看到了开发者群体的分层：</p>
<ol>
<li><strong>第一重：Prompt使用者</strong>：能熟练使用各类AI聊天工具，但能力边界停留在对话界面，无法将能力产品化、工程化。<strong>可替代性：极高</strong>。</li>
<li><strong>第二重：AI应用集成者</strong>：能使用LangChain等框架快速搭建Demo，了解RAG、Agent基础概念。但容易陷入“<strong>玩具项目</strong>”陷阱，一旦面临生产环境中的<strong>幻觉、高延迟、高成本</strong>问题便手足无措。<strong>状态：焦虑的“项目缝合者”</strong>。</li>
<li><strong>第三重：AI原生架构师</strong>：他们从 <strong>“智能体协同”</strong> 的视角设计整个系统。思考的是：如何为不同的子任务（如数据分析、决策判断、代码生成）设计或选用<strong>专门的智能体（Specialized Agent）</strong>，并通过严谨的<strong>工作流</strong>将它们可靠地串联起来。他们像导演一样编排“角色”，并确保最终“演出”稳定、高效、低成本。<strong>特征：思考“如何设计智能”，掌控全链路。</strong></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cf5af43546b4e5fa6d4170eb36437ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=SqBJ%2FPNzAqrW%2BRYpbuLC41rHFro%3D" alt="deepseek_mermaid_20251222_ec452c.png" loading="lazy"/></p>
<p><strong>所谓“多个专门的智能体（Specialized Agents）”，可以这样理解</strong>：在一个“自动数据分析报告生成系统”中，你可能会设计：</p>
<ol>
<li><strong>一个“SQL专家”智能体</strong>：专门将自然语言问题转换成精准的SQL查询。</li>
<li><strong>一个“图表建议”智能体</strong>：根据数据特征和业务场景，推荐最合适的可视化方案。</li>
<li><strong>一个“报告润色”智能体</strong>：负责将干巴巴的数据结果，组织成符合人类阅读习惯的叙事性报告。</li>
</ol>
<p>每个智能体各司其职，通过工作流引擎协同作业，这就是比单一全能模型<strong>更强大、更可控</strong>的架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/664e2dbcf3a8489a88c2188ca87e461c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=mjhGxONO95JYqlZZK%2FKK1671yGw%3D" alt="这张图是我的智能体矩阵，极大的帮我提高了工作效率！" loading="lazy"/></p>
<h2 data-id="heading-3">2026版“三层框架”学习法：从玩转到构建</h2>
<h3 data-id="heading-4">第一层：感知层（1-2周）——“会玩”</h3>
<p><strong>目标</strong>：建立对AI能力最直接的体感，破除神秘感。
<strong>行动</strong>：</p>
<ol>
<li><strong>玩转前沿应用</strong>：深度体验 <strong>Cursor</strong>（AI代码编辑器）、<strong>Claude Desktop</strong>、<strong>v0.dev</strong>（AI生成UI）。以<strong>开发者视角</strong>思考其背后的可能性。</li>
<li><strong>搭建私有AI工作站</strong>：在本地通过 <strong>Ollama</strong> 一键部署并运行 <strong>Llama 3</strong>、<strong>Qwen</strong> 等开源模型。再部署 <strong>Open WebUI</strong>，打造你的私人ChatGPT。这一步是为了获得“<strong>一切皆可私有化、可控化</strong>”的底气。</li>
</ol>
<h3 data-id="heading-5">第二层：学习层（1-2个月）——“会改”</h3>
<p><strong>目标</strong>：掌握将想法快速实现为原型的能力。<strong>核心是：学会高效阅读开源项目</strong>。
<strong>行动</strong>：</p>
<ol>
<li>
<p><strong>精读3个高质量开源项目（附GitHub地址）</strong>：</p>
<ul>
<li><strong>全栈AI应用（Go/Python）</strong>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FChatGPTNextWeb%2FChatGPT-Next-Web" target="_blank" title="https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web" ref="nofollow noopener noreferrer">ChatGPT-Next-Web</a></strong> ：一个极简、高性能的私有化ChatGPT网页应用。结构清晰，是学习AI应用前端交互和后端集成的优秀范本。</li>
<li><strong>RAG增强类（Python）</strong>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuivrHQ%2FQuivr" target="_blank" title="https://github.com/QuivrHQ/Quivr" ref="nofollow noopener noreferrer">Quivr</a></strong> 或 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fimartinez%2FprivateGPT" target="_blank" title="https://github.com/imartinez/privateGPT" ref="nofollow noopener noreferrer">privateGPT</a></strong>：学习如何将文档处理、向量检索与大模型回答结合。重点关注其<strong>数据管道</strong>设计。</li>
<li><strong>智能体工作流类（Python）</strong>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fassafelovic%2Fgpt-researcher" target="_blank" title="https://github.com/assafelovic/gpt-researcher" ref="nofollow noopener noreferrer">gpt-researcher</a></strong> ：一个能自动进行网络调研的智能体。通过它学习<strong>任务规划、工具使用和多步推理</strong>的工作流设计。</li>
</ul>
</li>
<li>
<p><strong>怎么读？推荐一个神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzread.ai%2F" target="_blank" title="https://zread.ai/" ref="nofollow noopener noreferrer">ZREAD 读代码</a></strong>：</p>
<p>我今年能高效阅读几十个项目，全靠这个工具。它支持<strong>直接分析GitHub项目链接</strong>，能一键生成项目的整体架构图、核心流程时序图，并让你可以像查字典一样，从功能点到具体代码逐层下钻追踪。用它先建立<strong>宏观认知</strong>，再深入细节，效率提升十倍。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1c6ee798cff47cc9b11994086fb71e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=BP7qIYqHeQsgyLEg63c59O5i8Fk%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li><strong>掌握核心框架</strong>：</li>
</ol>
<ul>
<li><strong>LangChain/LangGraph（Python）</strong>：这是定义智能体工作流的<strong>事实标准</strong>。重点学习 <strong><code>LCEL</code></strong>（链式表达式）、<strong><code>Agent</code></strong>（智能体）和 <strong><code>Tools</code></strong>（工具）的概念，以及 <strong><code>LangGraph</code></strong> 如何用<strong>状态图（StateGraph）</strong> 来编排复杂、带循环的工作流。</li>
<li><strong>LlamaIndex（Python）</strong>：专注于复杂RAG场景，比LangChain的RAG模块更<strong>专精、性能更好</strong>。重点理解其 <strong><code>QueryEngine</code></strong>、各种 <strong><code>Retriever</code></strong> 和 <strong><code>Postprocessor</code></strong>。</li>
<li><strong>Eino（Golang）- 来自字节跳动的高性能AI应用框架</strong>
这是Go开发者的<strong>王牌</strong>。相比Python生态，<code>Eino</code> 的核心优势在于：
<ul>
<li><strong>原生性能与高并发</strong>：基于Go语言，天然适合构建高吞吐、低延迟的AI微服务。在处理<strong>流式响应、海量文档异步索引</strong>等I/O密集型任务时，优势巨大。</li>
<li><strong>强大的工作流编排</strong>：它提供了类似 <code>LangGraph</code> 的 <strong><code>DAG（有向无环图）</code></strong> 编排能力，但用Go编写，<strong>类型安全</strong>，编译期就能发现许多错误。</li>
<li><strong>卓越的工程化体验</strong>：编译部署简单，内存占用低，与现有Go微服务栈（如GoFrame、GoZero）<strong>无缝集成</strong>。对于中大型企业需要将AI能力平稳融入现有技术体系的情况，<code>Eino</code> 是比Python更稳健的选择。</li>
<li><strong>学习建议</strong>：如果你有Go基础，<strong>强烈建议将 <code>Eino</code> 作为你深入AI工程化的主框架</strong>。从官方示例入手，理解其 <strong><code>Graph</code></strong>、<strong><code>Node</code></strong>、<strong><code>Stream</code></strong> 等核心概念。</li>
<li>（Eino对于Go开发者来说是王牌框架。不过，<strong>从理解概念到真正写出第一个生产可用的Graph</strong>，中间仍有不少实践细节。我最近正在系统梳理一套《Eino框架实战入门》的短教程，<strong>如果你在实践过程中遇到任何具体问题，欢迎随时在我的交流群或通过微信与我讨论</strong>，你的真实案例可能会成为教程中的最佳素材。）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">第三层：构建层（长期）——“会造”</h3>
<p><strong>目标</strong>：设计并交付稳定、可评估、有商业价值的AI原生应用。
<strong>行动</strong>：</p>
<ol>
<li><strong>攻克生产级问题</strong>：
<ul>
<li><strong>成本与延迟</strong>：学习模型量化、推理加速（如<code>vLLM</code>）、缓存和流式输出技术。</li>
<li><strong>评估与治理</strong>：引入 <strong><code>RAGAS</code></strong>、<strong><code>TruLens</code></strong> 等评估框架，为你的AI应用建立<strong>可量化的质量指标体系</strong>。设计**<code>Guardrail</code>（护栏）<strong>和</strong><code>Fallback</code>（降级）**策略。</li>
<li><strong>可观测性</strong>：为AI应用添加细粒度监控，追踪每次调用的<strong>Token消耗、延迟及自定义的质量分</strong>。</li>
</ul>
</li>
<li><strong>深入一个垂直领域</strong>：结合你或你所在行业的专业知识（如金融风控、电商客服、智能制造），打造 <strong>“领域专家智能体”</strong>。你的<strong>工程能力+领域知识</strong>，将构成<strong>双重护城河</strong>。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/253e3e78ff324e548fc5cdcd58175993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=lnUUdXrZf16YFvCprZMGITR3G%2Bo%3D" alt="exported_image (1).png" loading="lazy"/></p>
<h2 data-id="heading-7">总结与行动起点</h2>
<p>2026年，AI应用的竞争已从“有无”进入“<strong>优劣</strong>”阶段。比赛的胜负手，在于<strong>智能体协同设计的思维</strong>与<strong>生产级交付的能力</strong>。</p>
<p><strong>给你的2026年启动清单</strong>：</p>
<ol>
<li><strong>本周</strong>：用Ollama在本地跑通一个开源模型，感受“<strong>掌控力</strong>”。</li>
<li><strong>本月</strong>：使用 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzread.ai%2F" target="_blank" title="https://zread.ai/" ref="nofollow noopener noreferrer">ZREAD读代码</a></strong> 工具，深度剖析一个上文推荐的GitHub项目，并尝试为其添加一个小功能。</li>
<li><strong>本季度</strong>：选择你的主战场框架（Python流选<code>LangGraph</code>，Go流选<code>Eino</code>），从零设计并实现一个能解决实际微小痛点的智能体工作流（例如：自动周报生成器、智能会议纪要整理器）。</li>
</ol>
<p>这条路迭代迅速，但方向清晰：<strong>从“工具使用者”变为“智能设计者”</strong>。你过去积累的所有工程经验，都将是这条新赛道上的宝贵燃料。</p>
<p><strong>欢迎交流</strong>：你正在AI应用开发的哪个阶段？是Go还是Python技术栈？遇到了什么具体挑战？欢迎在评论区留言，我们一起探讨。</p>
<blockquote>
<p><strong>关于我</strong>：王中阳，一名从Go微服务开发转向AI原生应用架构的实践者。关注<strong>AI工程化</strong>与<strong>大模型应用落地</strong>，持续分享最前沿、最可实操的Go&amp;AI结合实战经验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单的Python神经网络识别手写数字]]></title>    <link>https://juejin.cn/post/7586452779712675855</link>    <guid>https://juejin.cn/post/7586452779712675855</guid>    <pubDate>2025-12-22T08:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586452779712675855" data-draft-id="7585391510058303540" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单的Python神经网络识别手写数字"/> <meta itemprop="keywords" content="神经网络"/> <meta itemprop="datePublished" content="2025-12-22T08:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MMHM"/> <meta itemprop="url" content="https://juejin.cn/user/2455627311357436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单的Python神经网络识别手写数字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455627311357436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MMHM
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T08:42:40.000Z" title="Mon Dec 22 2025 08:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一.导语</h2>
<p>本文主要介绍了神经网络模型训练的基本步骤，主要使用了<strong>PyTorch</strong>库，基于<strong>Python3</strong>的神经网络模型训练。且简要提供了前端GUI操作程序，让训练好的模型得以第一时间发挥作用。最后放有完整源码，可以直接使用，确保放在同一个文件夹里即可。</p>
<p>成果如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e8a8dbbb7245998cf2ca6c8610971f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=DYIenJiSpIsrxPpM69%2B3WeRaFME%3D" alt="屏幕录制 2025-12-22 165134.gif" loading="lazy"/></p>
<p>本文目的在于通过这个实际项目，让大家得以理解神经网络的基本结构，和训练过程，以及弄清楚中间发生了什么，理解代码的内容。</p>
<p>话不多说，现在就让我们开始学习！</p>
<h2 data-id="heading-1">二.准备必要的库</h2>
<h3 data-id="heading-2"><strong>1.首先需要准备这几个库</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.<span class="hljs-property">nn</span> <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.<span class="hljs-property">optim</span> <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> datasets, transforms
<span class="hljs-keyword">import</span> os
</code></pre>
<p>解释一下</p>
<p>1.torch库 可以理解为门用来造 AI 的工具箱</p>
<p>2.torchvision库 计算机视觉工具包，用于下载数据集和处理图片</p>
<p>3.os库 可以理解为文件管理员</p>
<h2 data-id="heading-3">三.定义神经网络的结构和思考方式</h2>
<h3 data-id="heading-4"><strong>1.初始化结构</strong></h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Net</span>(nn.<span class="hljs-title class_">Module</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-variable language_">super</span>(<span class="hljs-title class_">Net</span>, <span class="hljs-variable language_">self</span>).__init__()
        <span class="hljs-variable language_">self</span>.fc1 = nn.<span class="hljs-title class_">Linear</span>(<span class="hljs-number">28</span> * <span class="hljs-number">28</span>, <span class="hljs-number">128</span>)
        <span class="hljs-variable language_">self</span>.relu = nn.<span class="hljs-title class_">Re</span>LU()
        <span class="hljs-variable language_">self</span>.dropout = nn.<span class="hljs-title class_">Dropout</span>(<span class="hljs-number">0.2</span>)
        <span class="hljs-variable language_">self</span>.fc2 = nn.<span class="hljs-title class_">Linear</span>(<span class="hljs-number">128</span>, <span class="hljs-number">10</span>)
</code></pre>
<p><strong>解释一下</strong></p>
<p><strong>1.self.fc1 = nn.Linear(28 * 28, 128)</strong></p>
<p>这段是<strong>输入层</strong>到<strong>隐藏层</strong>的连接，其中(28*28)是可识别的分辨率,128是隐藏层神经元的数量</p>
<p><strong>2.self.relu = nn.ReLU()</strong></p>
<p>这个是<strong>激活函数</strong>，目的就是过滤掉一些‘杂波’的影响，减小其对训练的干扰，相当于给数据增加了一个可被识别的阈值。更重要的是<strong>引入非线性</strong>，把直线变成折线，让神经网络能够描绘出复杂的形状（比如数字的弯曲边缘）。</p>
<p><strong>3.self.dropout = nn.Dropout(0.2)</strong></p>
<p>这是为了干扰网络训练的机制，目的是防止网络死记硬背从而影响学习效率。<code>0.2</code> 意味着在训练时，<strong>随机让 20% 的神经元“罢工”</strong> （输出变为 0）。可以让网络学会通过整体特征来认字，极大地防止<strong>过拟合</strong>。</p>
<p><strong>4.self.fc2 = nn.Linear(128, 10)</strong></p>
<p>这段是<strong>隐藏层</strong>到<strong>输出层</strong>的连接，其中<code>128</code>是接收那 128 个神经元处理后的特征。<code>10</code>是输出0-9的结果。</p>
<p><strong>最后的结构大致是这样</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b015ec993294b958c7acb3b032a9892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=UQRkuvBIQdfg70ZsXpiDLEwUo9I%3D" alt="Gemini_Generated_Image_2q2ekq2q2ekq2q2e.png" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>2.前向传播</strong></h3>
<pre><code class="hljs language-ini" lang="ini">def forward(self, x):
    <span class="hljs-attr">x</span> = x.view(-<span class="hljs-number">1</span>, <span class="hljs-number">28</span> * <span class="hljs-number">28</span>)
    <span class="hljs-attr">x</span> = self.fc1(x)
    <span class="hljs-attr">x</span> = self.relu(x)
    <span class="hljs-attr">x</span> = self.dropout(x)
    <span class="hljs-attr">x</span> = self.fc2(x)
    return torch.log_softmax(x, <span class="hljs-attr">dim</span>=<span class="hljs-number">1</span>)
</code></pre>
<p>可以看作是模型的思考过程，下面解释一下都做了哪些处理，发生了什么</p>
<p>我们的手写图片传入进来时，是一张28*28的方块图像，而我们的<code>fc1()</code>函数识别不了这个大方块。于是我们使用<code>x = x.view(-1, 28 * 28)</code>把这个<strong>大方块变为长条形</strong>来让<code>fc1()</code>函数识别。<code>-1</code>表示把每张图都压成 784 的长度，来对图片进行预处理。接着以下都是调用我们上面写的方法<code>self.fc1()，self.relu()，self.dropout()，self.fc2()</code>来处理每一个数据，这就是我们所提及的<strong>思考过程</strong>。</p>
<p>最后一句<code>return torch.log_softmax(x, dim=1)</code>来算出概率。因为<code>fc2()</code>最后的输出可以是任何数字，并且没有范围限制，我们可以叫做<strong>原始得分</strong>。而为了算出概率我们需要百分比的形式，于是我们用到了<code>softmax()</code>函数,<code>Softmax()</code> 是一个数学函数，它能把原始得分转换成<strong>总和为 1 的概率分布</strong>。取对数（Log）是为了数学计算更稳定，防止softmax的数据过大或过小导致代码瘫痪。<code>dim=0</code> 是“图”的维度（竖着看），<code>dim=1</code> 是“分类”的维度（横着看）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16667bda826e420ea4774fede4e74c5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=5ITcfyXlTy1oL5joYVnWjS195Zc%3D" alt="Gemini_Generated_Image_yu30tyyu30tyyu30.png" loading="lazy"/></p>
<p><code>dim=0</code>时是跨样本比较，<code>dim=1</code>时是在单个样本中比较概率</p>
<p>整个 <code>forward</code> 函数就是把<strong>图片像素</strong>（784个点）一步步<strong>浓缩</strong>，最后变成<strong>10个概率值</strong>的过程。</p>
<h2 data-id="heading-6">四.训练模型</h2>
<h3 data-id="heading-7"><strong>1.准备阶段</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>():
    <span class="hljs-string">"""训练模型或加载已有模型"""</span>
    model_path = <span class="hljs-string">"mnist_model.pth"</span>
    device = torch.device(<span class="hljs-string">"cuda"</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span>)
    model = Net().to(device)

    <span class="hljs-keyword">if</span> os.path.exists(model_path):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"发现已保存的模型，正在加载..."</span>)
        model.load_state_dict(torch.load(model_path, map_location=device))
        model.<span class="hljs-built_in">eval</span>()
        <span class="hljs-keyword">return</span> model, device
</code></pre>
<p>3-5行代码主要是决定用 CPU 还是 显卡 (CUDA) 跑模型。然后把主程序<code>Net()</code>搬到上面去跑。<code>model.load_state_dict(torch.load(model_path, map_location=device))</code>这段代码就是实际上加载的过程。用<code>load_state_dict()</code>把<code>model_path</code>里存储的权重参数加载到<code>Net()</code>里。然后用<code>model.eval()</code>关闭<code>Dropout()</code>也就是上文提到的干扰机制，从而让模型满功率运行。</p>
<h3 data-id="heading-8"><strong>2.数据处理与下载</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">transform</span> = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))
])

<span class="hljs-attr">train_dataset</span> = datasets.MNIST(<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>, transform=transform)
<span class="hljs-attr">train_loader</span> = torch.utils.data.DataLoader(train_dataset, batch_size=<span class="hljs-number">64</span>, shuffle=<span class="hljs-literal">True</span>)
</code></pre>
<p>现在我们开始对数据进行处理，而这个处理流程我们就先叫做<code>transform</code>。后面的<code>Compose([...])</code>负责把
多个处理步骤串联起来执行。</p>
<ul>
<li>
<p>第一步 <code>transforms.ToTensor()</code>负责把数据转换为<strong>浮点数</strong>，让神经网络更好地处理数据。</p>
</li>
<li>
<p>第二步 <code>transforms.Normalize((0.1307,), (0.3081,))</code>是让上一步得到的数据减去<strong>均值</strong>，除以<strong>标准差</strong>。让数值变成了以 0 为中心的正负数，分布在x轴上下。这一步就是把数据<strong>标准化</strong>，来让数据的分布更标准，能让神经网络收敛得更快（学得更快）。<code>0.1307</code> 和 <code>0.3081</code> 是 MNIST 数据集的官方统计数据。</p>
</li>
</ul>
<p><code>train_dataset = datasets.MNIST('./data', train=True, download=True, transform=transform)</code>这一串代码是用来下载数据。它会自动检查 <code>./data</code> 文件夹里有没有MNIST数据。有就会读取，没有就会去自动下载。(<code>train=True</code>表示要下载的是用于学习的训练集)。</p>
<p><code>train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=64, shuffle=True)</code>
有了数据之后，我们要把数据运给网络，但不能一次全部运完。于是我们用<code>batch_size=64</code>把图片分为64个一组，一组一组地运输。<code>shuffle=True</code>意思是在每 Epoch开始时，<strong>把图片打乱</strong>，因为MNIST数据集里的图片排列一般是有序的。打乱后，网络每次看到的都是随机的数字图片，从而逼迫它去学习数字本身的特征。</p>
<p>这一步是必须的，防止网络过拟合。</p>
<h3 data-id="heading-9"><strong>3.训练循环(核心一步)</strong></h3>
<pre><code class="hljs language-scss" lang="scss">optimizer = optim<span class="hljs-selector-class">.Adam</span>(model.parameters(), lr=<span class="hljs-number">0.001</span>)
criterion = nn<span class="hljs-selector-class">.CrossEntropyLoss</span>()

model<span class="hljs-selector-class">.train</span>()
epochs = <span class="hljs-number">6</span>  

for epoch in <span class="hljs-built_in">range</span>(epochs):
    for batch_idx, (data, target) in <span class="hljs-built_in">enumerate</span>(train_loader):
        data, target = data.<span class="hljs-built_in">to</span>(device), target.<span class="hljs-built_in">to</span>(device)
        optimizer.<span class="hljs-built_in">zero_grad</span>()
        output = <span class="hljs-built_in">model</span>(data)
        loss = <span class="hljs-built_in">criterion</span>(output, target)
        loss.<span class="hljs-built_in">backward</span>()
        optimizer.<span class="hljs-built_in">step</span>()

        if batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">'Epoch {epoch + 1}/{epochs} | Batch {batch_idx} | Loss: {loss.item():.4f}'</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"训练完成，正在保存模型..."</span>)
torch.<span class="hljs-built_in">save</span>(model.<span class="hljs-built_in">state_dict</span>(), model_path)
model.<span class="hljs-built_in">eval</span>()
return model, device
</code></pre>
<p>经过了上面的 <strong>搭建网络</strong> 和 <strong>处理数据</strong> 我们终于到了训练环节，让我们来逐一了解发生了什么事情。</p>
<p>首先是两个比较重要的部分，对应着1-2行的代码</p>
<p>1.<code>optimizer = optim.Adam(...)</code>这部分负责修改神经网络的参数<code>model.parameters()</code>。后面的<code>lr=0.001</code>我们管它叫做<strong>学习率</strong>，可以理解为模型的修改幅度，之所以是<code>0.001</code>是因为我们<strong>既不</strong>希望模型修改幅度过大导致<strong>预测结果和真实答案</strong>之间的差距(Loss)过大以至于影响学习，<strong>也不</strong>希望模型修改幅度过小导致训练极其低效，<strong>而</strong><code>0.001</code>这个数值是无数前辈总结出的最佳值。</p>
<p>2.<code>criterion = nn.CrossEntropyLoss()</code>这段代码就是负责计算出<strong>交叉熵CrossEntropy</strong>，什么是交叉熵呢，就是预测结果与真实答案之间的距离，也可以叫<strong>损失Loss</strong>。如果Loss太大，就会在 <code>backward()</code> 的时候大幅修改参数。所以我们的训练目标就是得到尽可能接近0的Loss，至于为什么不能为0，是因为这时模型会过拟合，从而让训练失去意义。</p>
<pre><code class="hljs language-ini" lang="ini">model.train() 
<span class="hljs-attr">epochs</span> = <span class="hljs-number">6</span>
</code></pre>
<p>然后我们开启训练模式，打开Dropout。定义循环次数，其实3次就已经可以让准确率达到90%以上了。</p>
<pre><code class="hljs language-scss" lang="scss">for epoch in <span class="hljs-built_in">range</span>(epochs): 
    for batch_idx, (data, target) in <span class="hljs-built_in">enumerate</span>(train_loader):
</code></pre>
<p>这边我们定义了2个循环，一个外层<code>for epoch in range(epochs):</code>让模型把所有的题做6遍。一个内层<code>for batch_idx, (data, target) in enumerate(train_loader):</code>让每一遍做题时一次只做64道(batch)，且每做完64道就总结一次。</p>
<p>然后我们正式进入学习的流程，注意我们是在内层循环里学习的。</p>
<p><code>data, target = data.to(device), target.to(device)</code>OK，我们用这行代码把数据成功的搬进了GPU/CPU里。</p>
<p>那我们开始学习</p>
<ul>
<li>第一步，<code>optimizer.zero_grad()</code>把梯度清零，把上次算的梯度忘掉。梯度可以理解为，为了让<strong>Loss=0</strong>，模型现在应该往哪个方向走一步，让权重朝着正确的方向修改，于是我们走一步看一圈。清零是因为我们使用的PyTorch会默认把指令<strong>累加</strong>，如果不清零，上一步的梯度会和这一步的混在一起，导致神经网络‘走错方向’，因此我们必须清零上次的梯度。</li>
</ul>
<p>梯度Like this</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89adaa46261342c798fece1ebdd67f53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=3TOypi35glC9cAwSSC0XRV7vLiE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>第二步，<code>output = model(data)</code>，可以理解为前向传播，把图片数据喂给神经网络后，经过层层计算，输出预测结果0-9。</p>
</li>
<li>
<p>第三步，<code>loss = criterion(output, target)</code>计算损失，给出一个具体的<strong>Loss</strong>，看看错的情况。</p>
</li>
<li>
<p>第四步，<code>loss.backward()</code>反向传播，程序会从<strong>Loss</strong>开始往回推，看看每一个神经元的参数(权重)对这个错误的‘贡献’，这一步算出了梯度，告诉每个神经元应该朝哪个方向更改参数。</p>
</li>
<li>
<p>第五步，<code>optimizer.step()</code>更新参数，根据第四步算出的<strong>梯度</strong>，配合<strong>学习率</strong>去更新参数</p>
</li>
</ul>
<p>走完这五步，我们的模型就聪明了一点</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>: 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Epoch <span class="hljs-subst">{epoch + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{epochs}</span> | Batch <span class="hljs-subst">{batch_idx}</span> | Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>'</span>)
</code></pre>
<p>这一块是负责定期汇报学习进度，每学习完100个Batch就汇报一次。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("训练完成，正在保存模型...")
torch<span class="hljs-selector-class">.save</span>(model.state_dict(), model_path)
</code></pre>
<p>训练完成后保存模型</p>
<pre><code class="hljs language-javascript" lang="javascript">model.<span class="hljs-built_in">eval</span>()
<span class="hljs-keyword">return</span> model, device
</code></pre>
<p>然后<code>model.eval()</code>这行代码强制关闭 <strong>Dropout</strong>，返回模型和使用的设备(GPU/CPU)。</p>
<p>至此，我们村里终于出了个大学生：)</p>
<p>然后就是设计一个岗位给大学生了，是时候就业了</p>
<h2 data-id="heading-10">五.GUI交互界面</h2>
<h3 data-id="heading-11">1.功能介绍</h3>
<p>我们最主要的一部分已经完成了，我这边直接给出一个实例，包含了写数字，识别，可信度，处理后图片，概论预测的可视化，热力图(数据的数值强度)。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tkinter <span class="hljs-keyword">as</span> tk
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageTk
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># ---导入训练模块---</span>
<span class="hljs-keyword">from</span> neural_net <span class="hljs-keyword">import</span> train_model


<span class="hljs-comment"># ---GUI---</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DigitRecognizerApp</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, root, model, device</span>):
        self.root = root
        self.model = model
        self.device = device
        self.root.title(<span class="hljs-string">"Handwritten Digit Recognition"</span>)

        <span class="hljs-comment"># 布局配置</span>
        self.main_frame = tk.Frame(root, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">20</span>)
        self.main_frame.pack()

        <span class="hljs-comment"># 1. 画板区域 (Canvas)</span>
        self.canvas_width = <span class="hljs-number">280</span>
        self.canvas_height = <span class="hljs-number">280</span>
        self.canvas_bg = <span class="hljs-string">"black"</span>
        self.brush_color = <span class="hljs-string">"white"</span>
        self.brush_size = <span class="hljs-number">18</span>

        self.canvas = tk.Canvas(self.main_frame, width=self.canvas_width, height=self.canvas_height, bg=self.canvas_bg,
                                cursor=<span class="hljs-string">"cross"</span>)
        self.canvas.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">0</span>, rowspan=<span class="hljs-number">4</span>, padx=<span class="hljs-number">10</span>, pady=<span class="hljs-number">10</span>)

        <span class="hljs-comment"># 绑定鼠标事件</span>
        self.canvas.bind(<span class="hljs-string">"&lt;B1-Motion&gt;"</span>, self.draw)

        <span class="hljs-comment"># 内存绘图对象 (PIL)</span>
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)

        <span class="hljs-comment"># 2. 控制区域</span>
        self.btn_frame = tk.Frame(self.main_frame)
        self.btn_frame.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"n"</span>)

        self.predict_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Predict"</span>, command=self.predict, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>),
                                     bg=<span class="hljs-string">"#4CAF50"</span>, fg=<span class="hljs-string">"white"</span>)
        self.predict_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        self.clear_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Clear"</span>, command=self.clear_canvas, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>))
        self.clear_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        <span class="hljs-comment"># 3. 结果显示区域</span>
        self.result_label = tk.Label(self.main_frame, text=<span class="hljs-string">"Prediction: None"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">16</span>, <span class="hljs-string">"bold"</span>), fg=<span class="hljs-string">"blue"</span>)
        self.result_label.grid(row=<span class="hljs-number">1</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 4. 略缩图显示</span>
        tk.Label(self.main_frame, text=<span class="hljs-string">"Neural Network Input:"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">10</span>)).grid(row=<span class="hljs-number">2</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"s"</span>)
        self.thumb_label = tk.Label(self.main_frame, bg=<span class="hljs-string">"gray"</span>)
        self.thumb_label.grid(row=<span class="hljs-number">3</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 5. 初始化 Matplotlib 可视化界面</span>
        plt.ion()
        self.fig, self.ax = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">4</span>))
        self.fig.canvas.manager.set_window_title(<span class="hljs-string">"Neural Network Visualization"</span>)  <span class="hljs-comment"># 英文窗口标题</span>
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">self, event</span>):
        x1, y1 = (event.x - self.brush_size), (event.y - self.brush_size)
        x2, y2 = (event.x + self.brush_size), (event.y + self.brush_size)
        self.canvas.create_oval(x1, y1, x2, y2, fill=self.brush_color, outline=self.brush_color)
        self.draw_obj.ellipse([x1, y1, x2, y2], fill=self.brush_color, outline=self.brush_color)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_canvas</span>(<span class="hljs-params">self</span>):
        self.canvas.delete(<span class="hljs-string">"all"</span>)
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)
        self.result_label.config(text=<span class="hljs-string">"Prediction: None"</span>)
        self.thumb_label.config(image=<span class="hljs-string">''</span>)
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_image</span>(<span class="hljs-params">self</span>):
        img_resized = self.image.resize((<span class="hljs-number">28</span>, <span class="hljs-number">28</span>), Image.Resampling.LANCZOS)
        img_array = np.array(img_resized)

        <span class="hljs-comment"># 归一化处理</span>
        img_tensor = torch.tensor(img_array, dtype=torch.float32) / <span class="hljs-number">255.0</span>
        img_tensor = (img_tensor - <span class="hljs-number">0.1307</span>) / <span class="hljs-number">0.3081</span>
        img_tensor = img_tensor.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">return</span> img_tensor, img_resized

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self</span>):
        input_tensor, pil_thumb = self.preprocess_image()

        <span class="hljs-comment"># 显示略缩图</span>
        display_thumb = pil_thumb.resize((<span class="hljs-number">112</span>, <span class="hljs-number">112</span>), Image.Resampling.NEAREST)
        self.photo_thumb = ImageTk.PhotoImage(display_thumb)
        self.thumb_label.config(image=self.photo_thumb)

        <span class="hljs-comment"># 调用模型推理</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            output = self.model(input_tensor.to(self.device))
            probs = torch.exp(output)
            prediction = torch.argmax(probs, dim=<span class="hljs-number">1</span>).item()
            confidence = probs[<span class="hljs-number">0</span>][prediction].item()

        self.result_label.config(text=<span class="hljs-string">f"Prediction: <span class="hljs-subst">{prediction}</span>\nConfidence: <span class="hljs-subst">{confidence:<span class="hljs-number">.1</span>%}</span>"</span>)
        self.update_plot(input_tensor, probs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_plot</span>(<span class="hljs-params">self</span>):
        self.ax[<span class="hljs-number">0</span>].clear()
        self.ax[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">"Input Heatmap"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">0</span>].axis(<span class="hljs-string">'off'</span>)

        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.fig.canvas.draw()
        self.fig.canvas.flush_events()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_plot</span>(<span class="hljs-params">self, input_tensor, probs</span>):
        img_data = input_tensor.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">0</span>].imshow(img_data, cmap=<span class="hljs-string">'viridis'</span>)

        probs_data = probs.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1.1</span>)
        bars = self.ax[<span class="hljs-number">1</span>].bar(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>), probs_data, color=<span class="hljs-string">'skyblue'</span>)
        bars[np.argmax(probs_data)].set_color(<span class="hljs-string">'orange'</span>)

        self.fig.canvas.draw()
        self.fig.canvas.flush_events()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 1. 调用 neural_net.py 中的函数加载/训练模型</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Initializing AI Model..."</span>)
    trained_model, device = train_model()

    <span class="hljs-comment"># 2. 启动 GUI</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Starting GUI..."</span>)
    root = tk.Tk()
    app = DigitRecognizerApp(root, trained_model, device)


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_closing</span>():
        plt.close(<span class="hljs-string">'all'</span>)
        root.destroy()


    root.protocol(<span class="hljs-string">"WM_DELETE_WINDOW"</span>, on_closing)
    root.mainloop()
</code></pre>
<h2 data-id="heading-12">六.源码</h2>
<p>没有模型的话先运行<code>neural_net.py</code>，然后运行<code>gui_app.py</code>。之后使用的话直接运行<code>gui_app.py</code>即可。</p>
<h3 data-id="heading-13">1.neural_net.py</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> datasets, transforms
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Net</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>(Net, self).__init__()
        self.fc1 = nn.Linear(<span class="hljs-number">28</span> * <span class="hljs-number">28</span>, <span class="hljs-number">128</span>)
        self.relu = nn.ReLU()
        self.dropout = nn.Dropout(<span class="hljs-number">0.2</span>)
        self.fc2 = nn.Linear(<span class="hljs-number">128</span>, <span class="hljs-number">10</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        x = x.view(-<span class="hljs-number">1</span>, <span class="hljs-number">28</span> * <span class="hljs-number">28</span>)
        x = self.fc1(x)
        x = self.relu(x)
        x = self.dropout(x)
        x = self.fc2(x)
        <span class="hljs-keyword">return</span> torch.log_softmax(x, dim=<span class="hljs-number">1</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>():
    <span class="hljs-string">"""训练模型或加载已有模型"""</span>
    model_path = <span class="hljs-string">"mnist_model.pth"</span>
    device = torch.device(<span class="hljs-string">"cuda"</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span>)
    model = Net().to(device)

    <span class="hljs-keyword">if</span> os.path.exists(model_path):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发现已保存的模型 <span class="hljs-subst">{model_path}</span>，正在加载..."</span>)
        model.load_state_dict(torch.load(model_path, map_location=device))
        model.<span class="hljs-built_in">eval</span>()
        <span class="hljs-keyword">return</span> model, device

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"未发现模型，开始下载数据集并训练 (准确率目标 &gt; 90%)..."</span>)

    transform = transforms.Compose([
        transforms.ToTensor(),
        transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))
    ])

    train_dataset = datasets.MNIST(<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>, transform=transform)
    train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=<span class="hljs-number">64</span>, shuffle=<span class="hljs-literal">True</span>)

    optimizer = optim.Adam(model.parameters(), lr=<span class="hljs-number">0.001</span>)
    criterion = nn.CrossEntropyLoss()

    model.train()
    epochs = <span class="hljs-number">6</span>

    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(epochs):
        <span class="hljs-keyword">for</span> batch_idx, (data, target) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):
            data, target = data.to(device), target.to(device)
            optimizer.zero_grad()
            output = model(data)
            loss = criterion(output, target)
            loss.backward()
            optimizer.step()

            <span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Epoch <span class="hljs-subst">{epoch + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{epochs}</span> | Batch <span class="hljs-subst">{batch_idx}</span> | Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>'</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"训练完成，正在保存模型..."</span>)
    torch.save(model.state_dict(), model_path)
    model.<span class="hljs-built_in">eval</span>()
    <span class="hljs-keyword">return</span> model, device
</code></pre>
<h3 data-id="heading-14">2.gui_app.py</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tkinter <span class="hljs-keyword">as</span> tk
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageTk
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># ---导入训练模块---</span>
<span class="hljs-keyword">from</span> neural_net <span class="hljs-keyword">import</span> train_model


<span class="hljs-comment"># ---GUI---</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DigitRecognizerApp</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, root, model, device</span>):
        self.root = root
        self.model = model
        self.device = device
        self.root.title(<span class="hljs-string">"Handwritten Digit Recognition"</span>)

        <span class="hljs-comment"># 布局配置</span>
        self.main_frame = tk.Frame(root, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">20</span>)
        self.main_frame.pack()

        <span class="hljs-comment"># 1. 画板区域 (Canvas)</span>
        self.canvas_width = <span class="hljs-number">280</span>
        self.canvas_height = <span class="hljs-number">280</span>
        self.canvas_bg = <span class="hljs-string">"black"</span>
        self.brush_color = <span class="hljs-string">"white"</span>
        self.brush_size = <span class="hljs-number">18</span>

        self.canvas = tk.Canvas(self.main_frame, width=self.canvas_width, height=self.canvas_height, bg=self.canvas_bg,
                                cursor=<span class="hljs-string">"cross"</span>)
        self.canvas.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">0</span>, rowspan=<span class="hljs-number">4</span>, padx=<span class="hljs-number">10</span>, pady=<span class="hljs-number">10</span>)

        <span class="hljs-comment"># 绑定鼠标事件</span>
        self.canvas.bind(<span class="hljs-string">"&lt;B1-Motion&gt;"</span>, self.draw)

        <span class="hljs-comment"># 内存绘图对象 (PIL)</span>
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)

        <span class="hljs-comment"># 2. 控制区域</span>
        self.btn_frame = tk.Frame(self.main_frame)
        self.btn_frame.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"n"</span>)

        self.predict_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Predict"</span>, command=self.predict, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>),
                                     bg=<span class="hljs-string">"#4CAF50"</span>, fg=<span class="hljs-string">"white"</span>)
        self.predict_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        self.clear_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Clear"</span>, command=self.clear_canvas, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>))
        self.clear_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        <span class="hljs-comment"># 3. 结果显示区域</span>
        self.result_label = tk.Label(self.main_frame, text=<span class="hljs-string">"Prediction: None"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">16</span>, <span class="hljs-string">"bold"</span>), fg=<span class="hljs-string">"blue"</span>)
        self.result_label.grid(row=<span class="hljs-number">1</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 4. 略缩图显示</span>
        tk.Label(self.main_frame, text=<span class="hljs-string">"Neural Network Input:"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">10</span>)).grid(row=<span class="hljs-number">2</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"s"</span>)
        self.thumb_label = tk.Label(self.main_frame, bg=<span class="hljs-string">"gray"</span>)
        self.thumb_label.grid(row=<span class="hljs-number">3</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 5. 初始化 Matplotlib 可视化界面</span>
        plt.ion()
        self.fig, self.ax = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">4</span>))
        self.fig.canvas.manager.set_window_title(<span class="hljs-string">"Neural Network Visualization"</span>)  <span class="hljs-comment"># 英文窗口标题</span>
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">self, event</span>):
        x1, y1 = (event.x - self.brush_size), (event.y - self.brush_size)
        x2, y2 = (event.x + self.brush_size), (event.y + self.brush_size)
        self.canvas.create_oval(x1, y1, x2, y2, fill=self.brush_color, outline=self.brush_color)
        self.draw_obj.ellipse([x1, y1, x2, y2], fill=self.brush_color, outline=self.brush_color)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_canvas</span>(<span class="hljs-params">self</span>):
        self.canvas.delete(<span class="hljs-string">"all"</span>)
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)
        self.result_label.config(text=<span class="hljs-string">"Prediction: None"</span>)
        self.thumb_label.config(image=<span class="hljs-string">''</span>)
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_image</span>(<span class="hljs-params">self</span>):
        img_resized = self.image.resize((<span class="hljs-number">28</span>, <span class="hljs-number">28</span>), Image.Resampling.LANCZOS)
        img_array = np.array(img_resized)

        <span class="hljs-comment"># 归一化处理</span>
        img_tensor = torch.tensor(img_array, dtype=torch.float32) / <span class="hljs-number">255.0</span>
        img_tensor = (img_tensor - <span class="hljs-number">0.1307</span>) / <span class="hljs-number">0.3081</span>
        img_tensor = img_tensor.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">return</span> img_tensor, img_resized

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self</span>):
        input_tensor, pil_thumb = self.preprocess_image()

        <span class="hljs-comment"># 显示略缩图</span>
        display_thumb = pil_thumb.resize((<span class="hljs-number">112</span>, <span class="hljs-number">112</span>), Image.Resampling.NEAREST)
        self.photo_thumb = ImageTk.PhotoImage(display_thumb)
        self.thumb_label.config(image=self.photo_thumb)

        <span class="hljs-comment"># 调用模型推理</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            output = self.model(input_tensor.to(self.device))
            probs = torch.exp(output)
            prediction = torch.argmax(probs, dim=<span class="hljs-number">1</span>).item()
            confidence = probs[<span class="hljs-number">0</span>][prediction].item()

        self.result_label.config(text=<span class="hljs-string">f"Prediction: <span class="hljs-subst">{prediction}</span>\nConfidence: <span class="hljs-subst">{confidence:<span class="hljs-number">.1</span>%}</span>"</span>)
        self.update_plot(input_tensor, probs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_plot</span>(<span class="hljs-params">self</span>):
        self.ax[<span class="hljs-number">0</span>].clear()
        self.ax[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">"Input Heatmap"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">0</span>].axis(<span class="hljs-string">'off'</span>)

        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.fig.canvas.draw()
        self.fig.canvas.flush_events()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_plot</span>(<span class="hljs-params">self, input_tensor, probs</span>):
        img_data = input_tensor.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">0</span>].imshow(img_data, cmap=<span class="hljs-string">'viridis'</span>)

        probs_data = probs.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1.1</span>)
        bars = self.ax[<span class="hljs-number">1</span>].bar(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>), probs_data, color=<span class="hljs-string">'skyblue'</span>)
        bars[np.argmax(probs_data)].set_color(<span class="hljs-string">'orange'</span>)

        self.fig.canvas.draw()
        self.fig.canvas.flush_events()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 1. 调用 neural_net.py 中的函数加载/训练模型</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Initializing AI Model..."</span>)
    trained_model, device = train_model()

    <span class="hljs-comment"># 2. 启动 GUI</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Starting GUI..."</span>)
    root = tk.Tk()
    app = DigitRecognizerApp(root, trained_model, device)


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_closing</span>():
        plt.close(<span class="hljs-string">'all'</span>)
        root.destroy()


    root.protocol(<span class="hljs-string">"WM_DELETE_WINDOW"</span>, on_closing)
    root.mainloop()
</code></pre>
<h2 data-id="heading-15">七.结语</h2>
<p>恭喜你，我们终于完成了Python神经网络识别手写数字的学习。使用时你可能会发现为什么答案有时不是完全对的，因为我们手写的数字还是与我们使用的训练数据有所出入，所以并不能保证100%识别出，尤其是一些比较复杂的数字，比如3，4，5，8。但是识别率还是挺高的，识别不出来的多写两次也能识别出。我们所学习的只是神经网络的冰山一角和最基础的概念框架，我们仍道阻且长，有更多的等着我们去探索。神经网络本身就在不断学习改错，更何况我们本身就是一个庞大的神经集群在控制。</p>
<p>写这么一篇文章相信大家都有所收获，我也一样！感觉理解又加深了一个层次。</p>
<p>这是我的第一篇文章，可能还存在一些解释上的不全面，如有错误欢迎大家改正！</p>
<p>至此，感谢你的观看！</p>
<p>[1]部分图片来自《Python神经网络编程》塔里克-拉希德</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[day 2 promote工程]]></title>    <link>https://juejin.cn/post/7587243886428913679</link>    <guid>https://juejin.cn/post/7587243886428913679</guid>    <pubDate>2025-12-24T06:21:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587243886428913679" data-draft-id="7587243886428848143" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="day 2 promote工程"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T06:21:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古蓬莱掌管玉米的神"/> <meta itemprop="url" content="https://juejin.cn/user/2654634748958267"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            day 2 promote工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2654634748958267/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古蓬莱掌管玉米的神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:21:06.000Z" title="Wed Dec 24 2025 06:21:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LLM的智能和人的智能区别（非技术视角）：
LLM的智能是怎么来的：</p>
<p>1 - 什么是next token prediction：根据上文猜测下一个文字是啥</p>
<p>2 - QKV怎么影响next token prediction，简单来说是收到query后（希望llm输出什么字符），LLM会去看一遍key&amp;value（在这之前都有啥字符），把其中关系（考虑距离和相关性）比较高的内容结合在一起，然后猜下一个字符是啥</p>
<p>3 - 所以transfomer的基本逻辑是，完形填空，永远只填最后一个字（conversation也是人为构建的，没有真正意义的conversation存在，每次都是全量上下文一起进，一轮对话只是一个在末尾的段落）</p>
<p>4 - 简单粗暴的概括，LLM智能是因为预训练阶段见过足够多的完形填空，所以比较能猜，这也是scaling law的本质，假设见过足够多的数据，是不是就总是能猜对。但实际上LLM并没有建立自己的逻辑体系（最近ilya的一篇访谈“scaling的时代已经结束”很值得看一下<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfGlYeGC79wQI_XVX5qnoRw%25EF%25BC%258C%25E4%25BB%2596%25E7%2594%25A8%25E3%2580%258C%25E5%2588%25B7%25E9%25A2%2598%25E5%25AE%25B6%25E3%2580%258D%25E4%25B8%258E%25E3%2580%258C%25E6%259C%2589%25E5%25A4%25A9%25E8%25B5%258B%25E7%259A%2584%25E5%25AD%25A6%25E7%2594%259F%25E3%2580%258D%25E5%2581%259A%25E7%25B1%25BB%25E6%25AF%2594%25E3%2580%2582%25E4%25BB%2596%25E8%25AE%25A4%25E4%25B8%25BA%25E7%259B%25AE%25E5%2589%258D%25E7%259A%2584%25E6%25A8%25A1%25E5%259E%258B%25E5%2583%258F%25E5%2588%25B7%25E4%25BA%2586" target="_blank" title="https://mp.weixin.qq.com/s/fGlYeGC79wQI_XVX5qnoRw%EF%BC%8C%E4%BB%96%E7%94%A8%E3%80%8C%E5%88%B7%E9%A2%98%E5%AE%B6%E3%80%8D%E4%B8%8E%E3%80%8C%E6%9C%89%E5%A4%A9%E8%B5%8B%E7%9A%84%E5%AD%A6%E7%94%9F%E3%80%8D%E5%81%9A%E7%B1%BB%E6%AF%94%E3%80%82%E4%BB%96%E8%AE%A4%E4%B8%BA%E7%9B%AE%E5%89%8D%E7%9A%84%E6%A8%A1%E5%9E%8B%E5%83%8F%E5%88%B7%E4%BA%86" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/fGlYeGC79…</a> 10,000 小时题目的学生，虽然能解题但缺乏真正的智能；而人类（有天赋的学生）即使练习很少，也能展现出更好的泛化能力。）</p>
<p>因此，对于当前的LLM来说，写prompt的本质是构建一个让ta能够更容易猜到答案的完形填空的环境
进一步的，可以把这个原则拆解成下列几个子原则：</p>
<p>1 - 说明当前任务所处的环境至关重要，不说明环境就提要求相当于不给说明书就开始要求组装乐高</p>
<p>2 - 如果不是和任务息息相关，尽可能不要提及太多特殊/个性化的黑话，这些数据在llm训练时很可能也没见过</p>
<p>3 - 确保每条规则都独立存在不互相影响，以及尽可能减少规则式（if else）的要求，规则越多，模型越容易错误参考，让模型自身的填空机制做出更符合预测的选择</p>
<p>4 - 尽量减少对任务无意义的context和减少重复的context，前者会增加填空参考错误信息的风险，后者会增加填空复读的风险</p>
<p>5 - 按照逻辑顺序，越基础、全局、重要的放在前面，因为模型是按顺序读信息的——前面的内容应该是“基础”，后面的内容才是“在这个基础上要做什么”。顺序乱了，模型就更容易猜错。</p>
<p>6 - 相关性强的内容不要分散的放在模型的各处，会分散模型的注意力，尽量都聚合在距离比较近的地方</p>
<p>进一步的，Context工程到底是啥，其实就干四件事：</p>
<p>1 - 怎么帮助模型减少冗余的、可能会干扰填空的上下文</p>
<p>2 - 怎么从一堆数据里找到需要增加给模型的重要的上下文（&lt;=100%一堆数据），强化模型填空的偏向</p>
<p>3 - 怎么定义不同类型的上下文的结构（包括模型自己输出的数据），提高模型填空的稳定性</p>
<p>4 - 怎么排序上下文，更符合模型常见的数据结构</p>
<p>如何判断要不要上工程：</p>
<p>1 - 不是模型做不好就立刻上工程，先检查prompt是不是符合原则，prompt问题大，上了工程也未必解决问题</p>
<p>2 - 超关键场景，需要追求成功率的，别犹豫，直接上工程，从业务逻辑追加的规则也会有幻觉（越特别的、越黑话的
规则，幻觉的概率越大）
3 - 剩下的，商量着来吧，毕竟模型就是个概率学的玩意儿，看看资源优先级，多调调prompt，80%-85%也是提升不是</p>
<p>特别重要的放最后：
都是猜了，要习惯稳定性和准确性的概率风险，也要习惯假设逻辑可能是错的，实验是检验llm的唯一真理</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源通义DeepResearch：智能体训练全流程揭秘]]></title>    <link>https://juejin.cn/post/7587284708943003682</link>    <guid>https://juejin.cn/post/7587284708943003682</guid>    <pubDate>2025-12-24T06:31:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708943003682" data-draft-id="7586941997196247092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源通义DeepResearch：智能体训练全流程揭秘"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-24T06:31:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源通义DeepResearch：智能体训练全流程揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:31:17.000Z" title="Wed Dec 24 2025 06:31:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年9月16日，阿里通义实验室发布了<strong>DeepResearch</strong>，宣称这是一款针对科研场景设计的开源“智能体”模型系统。它不再是简单的对话机器人，而是能像研究人员一样，围绕一个问题构建完整的“研究闭环”：深度检索、跨源交叉、结构化归纳、报告生成，最终输出有引用、可复现的调研报告与决策建议。通义团队通过创新的技术架构和训练方法，使DeepResearch在多个极高难度的信息检索和推理任务中取得了最先进的（SOTA）成绩：</p>
<p>●Humanity’s Last Exam (HLE)：32.9</p>
<p>●BrowseComp‑EN：43.4</p>
<p>●BrowseComp‑ZH：46.7</p>
<p>●xBench‑DeepSearch：75.0</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3d6f9ce09143429e46c27f8e54dcce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162676&amp;x-signature=75aghD8sxUd2okBkriIlO8P%2FKNQ%3D" alt="" loading="lazy"/></p>
<p>全面超越了目前所有的闭源及开源 Deep Research 智能体（Agent）。不仅如此，通义团队还完整分享了一套可落地的高水平Agent构建方法论，详细介绍了从数据合成、Agentic 增量预训练（CPT）、有监督微调（SFT）冷启动，到强化学习（RL）的全套流程。</p>
<p><strong>数据合成策略：为训练提供海量“燃料”</strong></p>
<p>通义 DeepResearch 独创了<strong>全自动合成数据管道</strong>，彻底摆脱昂贵人工标注的瓶颈。团队设计了一个名为 AgentFounder 的系统，持续从文档、网络爬取数据、知识图谱、工具调用记录等多源采集信息，构建“实体锚定的开放世界知识记忆”。基于采样得到的实体和相关知识，自动生成多种风格的问题–答案对，为预训练和后续微调提供海量基础训练样本。可以把这些过程想象成给模型构建了一个“知识宫殿”和“练习题库”，让它不断积累各种知识和场景下的问答能力。</p>
<p>此外，团队还进行<strong>动作（行为）合成</strong>：基于历史交互轨迹和题目，生成<strong>推理与决策过程</strong>数据。例如，将原始步骤重构为多步规划决策任务，形成多阶段解决方案序列。这些合成轨迹模拟模型在真实 Web 环境中的查询、点击、推理步骤，极大丰富了智能体对不同操作序列的认识，甚至无需额外调用真实 API 就能离线模拟各种复杂推理动作。所有这些数据合成策略形成了一个“数据飞轮”：预训练产生的数据不断供给后续阶段，又反过来促进更多样本的生成。</p>
<p><strong>Agentic 增量预训练 (CPT)：夯实模型基础</strong></p>
<p><strong>Agentic CPT</strong> 相当于给智能体做“扎实的理论学习”。团队首先用合成好的大规模数据对基础语言模型进行增量预训练。在这个阶段，模型并非仅仅背诵静态文本，而是学习一系列模拟“研究过程”的轨迹：比如根据一个查询逐步提取文档信息、调用工具、形成答案。这通过<strong>掩码语言建模</strong>的方式，让模型隐式学会<strong>规划和工具使用</strong>的技能。在类比上，就像让学徒阅读大量专业书籍和案例解析，同时练习整理信息和提出问题，为后续的实践操作打下坚实基础。Agentic CPT 的创新在于其<strong>AgentFounder 数据方案</strong>：利用前述数据合成产生的丰富问答对与推理过程，实现了可扩展的大规模训练。</p>
<p><strong>有监督微调 (SFT) 冷启动：模拟专家示范</strong></p>
<p>在增量预训练后，通义 DeepResearch 会让模型通过有<strong>监督微调 (SFT)</strong> 进行“专家示范”训练，快速进入任务状态。此阶段使用合成的高质量问答和轨迹数据，让模型<strong>学习规范的思考–行动–观察循环</strong>。具体做法是用两种风格的示例训练模型：一是经典的 ReAct 形式（“思考→行动→观察”循环），让模型学会结构化答题；二是团队提出的 IterResearch 形式，即在多轮推理时每轮重新聚焦关键内容，避免上下文信息过多造成干扰。可以把 SFT 阶段比作导师带着学生做练习题：模型在“老师示范”下，把之前打好的理论知识用于具体问答和多轮推理场景。通过这样的冷启动，模型迅速掌握从结构化思考到生成连贯行动的能力，为后续自我优化打下良好基础。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d8e776da784dc9a2fa68e0a3b312a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162676&amp;x-signature=ihqwGZvKDPKW%2FXPlaEmwWXG9yPE%3D" alt="" loading="lazy"/></p>
<p><strong>强化学习 (RL)：在模拟环境中自我演练</strong></p>
<p>最后进入<strong>强化学习阶段</strong>，让智能体在安全可控的模拟环境中“自行试错”，持续优化决策策略。通义团队采用定制的<strong>GRPO（Group Relative Policy Optimization）算法</strong>，严格遵循on-policy训练范式，确保奖励信号与模型当前能力匹配。在训练目标上，使用了基于Token级别的策略梯度损失，并引入<strong>留一法（leave-one-out）</strong> 来降低方差，同时有选择地剔除过长未完成的负样本，避免模型陷入“格式崩溃”。训练时还通过增大批次和并行实例来稳定学习。类似于模拟战场练习，智能体不断在仿真网页环境中进行查询、点击和推理，每一次成功完成任务都会得到奖励，模型的策略随着奖励（reward）持续上升，探索度（policy entropy）保持高位。这一切都依托稳定的环境和数据支持：团队构建了离线维基百科+自制工具的沙盒模拟环境，并实时自动管理生成数据，以保证训练过程高效且鲁棒。</p>
<p><strong>阶段协同与闭环：不断迭代的训练循环</strong></p>
<p>通义 DeepResearch 的成功还在于各阶段环环相扣、形成闭环。从<strong>CPT</strong>阶段打基础，到<strong>SFT</strong>阶段冷启动，最后到<strong>RL</strong>阶段自我进化，每一步都为下一步提供素材和启发。CPT和SFT产生的合成数据反过来可用于强化学习训练，RL训练新得的轨迹也可反馈到数据管道中，持续丰富训练样本。可谓是一个<strong>不断“自己喂养自己”的训练循环</strong>。正如通义团队所总结的：“从基础模型开始，先进行了 Agentic 持续预训练以初始化工具使用技能，然后使用类似专家的数据进行监督微调以实现冷启动，最后进行基于策略的强化学习，使模型进行自我进化”。这一全栈式方案相当于教会一个学习者：先在课堂上学习知识、再在实验室跟随导师练习，最后独立做项目，实现技能的真实落地。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08efc305c42a4c638e6b851415a215a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162676&amp;x-signature=GpyS5dY9BdzUqREWxgNoEGxd4vE%3D" alt="" loading="lazy"/></p>
<p>整体来看，通义 DeepResearch 的训练流程兼顾了<strong>规模化合成数据</strong>与<strong>精细化算法设计</strong>。通过高质量数据合成不断为模型提供“训练燃料”，并在各阶段采用面向智能体特性的训练目标和策略，最终培养出能够自主规划、多步推理的开源智能体。这一创新方法论为开源社区提供了完整可复现的方案，揭示了从“聊天机器人”到“自主研究者”转型的路径</p>
<p><strong>应用场景</strong></p>
<p>DeepResearch已在实际产品中得到应用。阿里表示，它已赋能高德地图和“通义法睿”等内部项目。例如，在高德地图中，DeepResearch被用作智能出行Agent：集成专用地图API、实时天气和交通监测等工具，可根据当前情况规划最优路线。通义团队提供Deep Research模型 + 高德团队提供工具和 Agent 链路”，打造了高德 App 中助手「小高老师」的复杂查询体验，在地图行业内打出影响力。</p>
<p>在法律领域，DeepResearch驱动的“通义法睿”智能体能自动检索法律法规、案例和裁判文书，并进行深度归纳分析，在“法条引用相关性”和“案例引用相关性”两项指标上超过了OpenAI和Claude等国际顶尖模型，为法律从业者提供了准确可靠的检索和分析支持。</p>
<p><strong>开源链接</strong></p>
<p>●Homepage:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Ftongyi-agent.github.io%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//tongyi-agent.github.io/" ref="nofollow noopener noreferrer">tongyi-agent.github.io/</a></p>
<p>●Blog:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Ftongyi-agent.github.io%2Fblog%2Fintroducing-tongyi-deep-research%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//tongyi-agent.github.io/blog/introducing-tongyi-deep-research/" ref="nofollow noopener noreferrer">tongyi-agent.github.io/blog/introd…</a></p>
<p>●Github:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2FAlibaba-NLP%2FDeepResearch" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/Alibaba-NLP/DeepResearch" ref="nofollow noopener noreferrer">github.com/Alibaba-NLP…</a></p>
<p>●Hugging Face:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fhuggingface.co%2FAlibaba-NLP%2FTongyi-DeepResearch-30B-A3B" target="_blank" title="https://link.zhihu.com/?target=https%3A//huggingface.co/Alibaba-NLP/Tongyi-DeepResearch-30B-A3B" ref="nofollow noopener noreferrer">huggingface.co/Alibaba-NLP…</a></p>
<p>●Model Scope:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmodelscope.cn%2Fmodels%2Fiic%2FTongyi-DeepResearch-30B-A3B" target="_blank" title="https://link.zhihu.com/?target=https%3A//modelscope.cn/models/iic/Tongyi-DeepResearch-30B-A3B" ref="nofollow noopener noreferrer">modelscope.cn/models/ii</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Knip - 一键清理项目无用代码]]></title>    <link>https://juejin.cn/post/7587208390482018310</link>    <guid>https://juejin.cn/post/7587208390482018310</guid>    <pubDate>2025-12-24T06:38:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587208390482018310" data-draft-id="7586971532699975689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Knip - 一键清理项目无用代码"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-24T06:38:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Knip - 一键清理项目无用代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:38:00.000Z" title="Wed Dec 24 2025 06:38:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<h2 data-id="heading-0">什么是 Knip？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2583caa79974700958f7a99af9aca11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163079&amp;x-signature=4ibWEwayDOIOL3nHDkvJixT9y0E%3D" alt="" loading="lazy"/></p>
<p>Knip 是一个专门用来清理 JavaScript 和 TypeScript 项目的工具。</p>
<h2 data-id="heading-1">它能帮你找到什么？</h2>
<p>Knip 主要帮你找出三类"垃圾代码"：</p>
<ol>
<li><strong>未使用的依赖包</strong> - 你安装了但实际没用到的 npm 包</li>
<li><strong>未使用的导出</strong> - 你导出了但没人使用的函数、类、变量等</li>
<li><strong>未使用的文件</strong> - 项目中存在但没被引用的文件</li>
</ol>
<h2 data-id="heading-2">如何使用？</h2>
<h3 data-id="heading-3">快速开始</h3>
<p>使用非常简单！只需要一条命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm init @knip/config
</code></pre>
<p>这个命令会：</p>
<ul>
<li>自动安装 Knip</li>
<li>在你的 <code>package.json</code> 中添加运行脚本</li>
</ul>
<p>然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">npm run knip
</code></pre>
<p>Knip 就会开始分析你的项目，告诉你哪些依赖、导出和文件没有被使用。</p>
<h3 data-id="heading-4">系统要求</h3>
<p>Knip 需要 Node.js 18.18.0 或更高版本，也支持 Bun。</p>
<h2 data-id="heading-5">强大的生态支持</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5bd2c2aabd4d93bb5dcecaf12720cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163079&amp;x-signature=vVMv%2BgZJ%2B67vYERb6M2lLYGug1A%3D" alt="" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fknip.dev" target="_blank" title="https://knip.dev" ref="nofollow noopener noreferrer">knip.dev</a></p>
<p>Knip 不是一个简单的工具，它内置了 100+ 个插件，支持各种流行的框架和工具，比如：</p>
<ul>
<li>Astro、Next.js、Remix、Svelte</li>
<li>Jest、Vitest、Cypress</li>
<li>ESLint、Webpack、Vite</li>
<li>GitHub Actions、Nx、Storybook</li>
<li>以及更多...</li>
</ul>
<p>这意味着 Knip 能够理解这些工具的配置文件，准确分析你的项目结构。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL与Redis缓存一致性方案]]></title>    <link>https://juejin.cn/post/7587021119254151195</link>    <guid>https://juejin.cn/post/7587021119254151195</guid>    <pubDate>2025-12-24T05:50:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587021119254151195" data-draft-id="7586957587077005362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL与Redis缓存一致性方案"/> <meta itemprop="keywords" content="后端,Redis,MySQL"/> <meta itemprop="datePublished" content="2025-12-24T05:50:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="镜花水月linyi"/> <meta itemprop="url" content="https://juejin.cn/user/451256763295396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL与Redis缓存一致性方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/451256763295396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    镜花水月linyi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:50:12.000Z" title="Wed Dec 24 2025 05:50:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、缓存一致性问题的本质</h2>
<p>在Java后端开发中，我们习惯通过<code>@Cacheable</code>注解或<code>RedisTemplate</code>操作缓存，但真正理解缓存一致性，必须深入到分布式系统的CAP理论层面。缓存一致性问题的本质是：<strong>在分布式环境下，同一份数据存在于数据库和缓存两个存储介质中，如何保证两者数据的一致性</strong>。</p>
<h3 data-id="heading-1">1.1 CAP理论与一致性</h3>
<p>根据CAP理论，分布式系统无法同时满足一致性(Consistency)、可用性(Availability)、分区容错性(Partition tolerance)。在缓存场景中：</p>
<ul>
<li><strong>强一致性</strong>：任何时刻读取缓存和数据库的数据完全相同，代价是性能下降</li>
<li><strong>最终一致性</strong>：允许短暂的数据不一致，但最终会达到一致状态，是大多数系统的选择</li>
<li><strong>弱一致性</strong>：不保证何时达到一致，适用于对一致性要求极低的场景</li>
</ul>
<h3 data-id="heading-2">1.2 一致性问题的分类</h3>



































<table><thead><tr><th>问题类型</th><th>描述</th><th>危害程度</th><th>评估依据</th></tr></thead><tbody><tr><td>缓存与DB不一致</td><td>缓存数据是旧值，DB是新值</td><td>高</td><td>持续到缓存过期，影响用户体验</td></tr><tr><td>并发写导致错乱</td><td>多线程同时写入导致数据覆盖</td><td>高</td><td>数据永久错误，需人工修复</td></tr><tr><td>删除缓存失败</td><td>DB更新成功但缓存删除失败</td><td>高</td><td>网络抖动时发生，需重试机制</td></tr><tr><td>读写并发冲突</td><td>读线程回填旧值覆盖新值</td><td>中</td><td>需缓存miss+特定时序，罕见</td></tr></tbody></table>
<p><strong>缓存架构总览图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef19358ad6714489a71de437125057fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=Ia3qbkQs9w3QboPLKfa3H%2F86ITQ%3D" alt="缓存架构总览.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.3 为什么需要缓存？</h3>
<p>缓存的核心价值在于<strong>以空间换时间</strong>，将热点数据存储在内存中，减少数据库访问压力。</p>
<p><strong>经典业务场景：电商商品详情页</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 无缓存：每次请求都查询数据库</span>
<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-keyword">return</span> productMapper.selectById(productId);
    <span class="hljs-comment">// QPS上限：约500-1000（受限于数据库连接池和磁盘IO）</span>
}

<span class="hljs-comment">// 有缓存：优先从Redis读取</span>
<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithCache</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
    <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
        product = productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, product, <span class="hljs-number">30</span>, TimeUnit.MINUTES);
        }
    }
    <span class="hljs-keyword">return</span> product;
    <span class="hljs-comment">// QPS上限：约10000-50000（取决于Redis集群规模）</span>
}
</code></pre>
<h2 data-id="heading-4">二、缓存读写策略详解</h2>
<p>业界主流的缓存读写策略有三种，它们在一致性、性能、复杂度之间做出不同的权衡。理解这三种策略的本质区别，是选择合适方案的前提。</p>
<h3 data-id="heading-5">2.1 三种经典缓存策略对比</h3>





































<table><thead><tr><th>策略</th><th>读流程</th><th>写流程</th><th>一致性</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td>Cache Aside</td><td>先读缓存，miss则读DB并回填</td><td>先更新DB，再删除缓存</td><td>最终一致</td><td>低</td><td><strong>通用场景（推荐）</strong></td></tr><tr><td>Read/Write Through</td><td>应用只与缓存交互</td><td>缓存代理负责同步DB</td><td>强一致</td><td>高</td><td>缓存中间件支持</td></tr><tr><td>Write Behind</td><td>应用只与缓存交互</td><td>缓存异步批量写DB</td><td>弱一致</td><td>高</td><td>写密集、允许丢数据</td></tr></tbody></table>
<p><strong>三种缓存策略架构对比图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03584550be5644539ec66c2145a651d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=t5hLvU3UB4GaSlrHF30EJUr2HGA%3D" alt="三种缓存策略对比.drawio.png" loading="lazy"/></p>
<p><strong>策略选择建议：</strong></p>
<ul>
<li><strong>Cache Aside</strong>：应用层控制缓存逻辑，灵活性高，是绝大多数互联网公司的首选</li>
<li><strong>Read/Write Through</strong>：需要缓存中间件支持（如Redis Module），适合有强一致性需求且中间件支持的场景</li>
<li><strong>Write Behind</strong>：写入性能极高，但存在数据丢失风险，仅适用于日志、统计等可丢失场景</li>
</ul>
<h3 data-id="heading-6">2.2 Cache Aside模式详解（业界主流）</h3>
<p>Cache Aside模式（旁路缓存）是业界使用最广泛的缓存策略，其核心思想是<strong>应用程序同时维护缓存和数据库</strong>，而不是依赖缓存中间件自动同步。</p>
<p><strong>读流程核心逻辑：</strong></p>
<ol>
<li>先查询缓存，命中则直接返回</li>
<li>缓存未命中，查询数据库</li>
<li>将数据库结果回填到缓存（设置合理的过期时间）</li>
</ol>
<p><strong>写流程核心逻辑：</strong></p>
<ol>
<li>先更新数据库（保证数据持久化）</li>
<li>再删除缓存（而非更新缓存）</li>
</ol>
<p><strong>Cache Aside读流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa91937a5610476ba568bbd17aaddce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=KJq8v3R8Y2E9vqR3cgMvdNlaA88%3D" alt="CacheAside读流程.drawio.png" loading="lazy"/></p>
<p><strong>Cache Aside写流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ea046e98a3f428ea2ec6ad25b21fb14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=Yq2RfO5uTI8OcDRnhg2V1TCjkS4%3D" alt="CacheAside写流程.drawio.png" loading="lazy"/></p>
<p><strong>Java实现代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">CACHE_TTL</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span>; <span class="hljs-comment">// 30分钟</span>
    
    <span class="hljs-comment">/**
     * Cache Aside 读取模式
     */</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> PRODUCT_KEY_PREFIX + productId;
        
        <span class="hljs-comment">// 1. 先查缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
            <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
        }
        
        <span class="hljs-comment">// 2. 缓存未命中，查数据库</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        
        <span class="hljs-comment">// 3. 回填缓存（注意空值处理，防止缓存穿透）</span>
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), 
                CACHE_TTL, TimeUnit.SECONDS);
        } <span class="hljs-keyword">else</span> {
            redisTemplate.opsForValue().set(key, <span class="hljs-string">""</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
        }
        <span class="hljs-keyword">return</span> product;
    }
    
    <span class="hljs-comment">/**
     * Cache Aside 写入模式
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-comment">// 1. 先更新数据库</span>
        productMapper.updateById(product);
        <span class="hljs-comment">// 2. 再删除缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> PRODUCT_KEY_PREFIX + product.getId();
        redisTemplate.delete(key);
    }
}
</code></pre>
<h2 data-id="heading-7">三、缓存一致性问题深度分析</h2>
<p>这是缓存一致性最核心的章节，我们来深入分析几个关键问题：为什么删除而不是更新？为什么先更新DB后删缓存？这些问题的答案直接决定了系统的数据一致性。</p>
<h3 data-id="heading-8">3.1 为什么是"删除缓存"而不是"更新缓存"？</h3>
<p>这是一个面试高频问题。直觉上，更新缓存似乎更高效（避免下次cache miss），但实际上<strong>删除缓存才是正确选择</strong>，原因有二：</p>
<p><strong>原因一：避免并发写导致数据错乱</strong></p>
<p>假设两个线程同时更新同一条数据：</p>
<ul>
<li>线程A更新DB为100，然后准备更新缓存</li>
<li>线程B更新DB为200，然后更新缓存为200</li>
<li>线程A由于网络延迟，最后才更新缓存为100</li>
<li><strong>结果</strong>：DB=200，缓存=100，数据不一致！</li>
</ul>
<p><strong>原因二：避免无效的缓存计算</strong></p>
<p>如果缓存数据是经过复杂计算得出的（如多表JOIN、聚合统计），每次更新都重新计算是浪费资源。而删除缓存后，只有真正被访问时才计算，这就是<strong>懒加载思想</strong>。</p>























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>推荐度</th></tr></thead><tbody><tr><td>更新缓存</td><td>缓存始终有值，无穿透风险</td><td>并发写导致数据错乱、无效计算</td><td>不推荐</td></tr><tr><td>删除缓存</td><td>简单可靠、避免并发问题、懒加载</td><td>下次读有一次cache miss</td><td><strong>推荐</strong></td></tr></tbody></table>
<p><strong>并发更新缓存导致数据错乱示意图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97265f130633445da276648e9fda3228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=eLkCEe2cT%2FBldQWRDIdQM8YZdFA%3D" alt="并发更新缓存问题.drawio.png" loading="lazy"/></p>
<p><strong>删除缓存方案（推荐）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24497d6c8394f47b632cb5aea63df07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=VgGp0XK3iV5vWadxcr7fb0d8iMg%3D" alt="删除缓存方案.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-9">3.2 为什么是"先更新DB，后删除缓存"？</h3>
<p>这是另一个高频面试题。既然要操作DB和缓存，那必然有先后顺序，我们来分析两种组合：</p>
<p><strong>组合一：先更新DB，后删除缓存（推荐）</strong></p>
<p>时间线：
T1: 线程A更新DB (price=100)
T2: 线程B读取缓存（命中旧值80）
T3: 线程B返回旧值80
T4: 线程A删除缓存
T5: 后续请求读取DB，获得最新值100</p>
<p>这种方案的问题是：在T2-T3时间窗口内，可能读到旧数据。但这个窗口极短（通常&lt;1ms），且下次读取就能获得最新值。</p>
<p><strong>方案对比分析图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76c4402f74274b34b4cf8c592e2f2aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=hYy6VhPyY5X9xE1FMBhvWPvxaNA%3D" alt="先更新DB后删缓存.drawio.png" loading="lazy"/></p>
<p><strong>组合二：先删除缓存，后更新DB（不推荐）</strong></p>
<p>时间线：
T1: 线程A删除缓存
T2: 线程B读取缓存（未命中）
T3: 线程B读取DB（旧值80）
T4: 线程A更新DB (price=100)
T5: 线程B将旧值80写入缓存
T6: 后续请求读取缓存，持续返回旧值80！</p>
<p>这种方案的严重问题是：<strong>缓存中会长时间存储旧数据</strong>，直到缓存过期或下次更新才能修复。</p>
<p><strong>先删除缓存后更新DB的问题：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f835b0ecd934a048eae9fe7178df088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=yoB2dSFrMLfK%2BcKQETnkP2l1LO0%3D" alt="先删缓存后更新DB问题.drawio.png" loading="lazy"/></p>
<blockquote>
<p><strong>结论</strong>：先更新DB，后删除缓存是最佳实践。虽然存在短暂不一致窗口，但这是可接受的最终一致性；而先删缓存可能导致长时间数据错误。</p>
</blockquote>
<h3 data-id="heading-10">3.3 删除缓存失败怎么办？</h3>
<p>在分布式环境中，网络是不可靠的。如果DB更新成功，但缓存删除失败（网络抖动、Redis故障等），就会导致缓存中一直存储旧数据。</p>
<p><strong>解决方案：基于消息队列的异步重试机制</strong></p>
<p>核心思路：</p>
<ol>
<li>尝试删除缓存</li>
<li>如果失败，将删除任务发送到消息队列</li>
<li>消费者异步重试删除，采用退避策略</li>
<li>超过最大重试次数则告警，人工介入</li>
</ol>
<p><strong>重试机制架构图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/590da48736da40369621eee11d97f737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=rv5dccvW8bIZMpfgBwWEpIsjnbc%3D" alt="缓存删除重试机制.drawio.png" loading="lazy"/></p>
<p><strong>Java实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    
    <span class="hljs-comment">/**
     * 带重试机制的缓存删除
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteCache</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">deleted</span> <span class="hljs-operator">=</span> redisTemplate.delete(key);
            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(deleted)) {
                <span class="hljs-keyword">return</span>;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Failed to delete cache: {}"</span>, key, e);
        }
        <span class="hljs-comment">// 删除失败，发送到消息队列进行异步重试</span>
        <span class="hljs-type">CacheDeleteMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheDeleteMessage</span>(key, <span class="hljs-number">0</span>);
        rabbitTemplate.convertAndSend(<span class="hljs-string">"cache.delete.queue"</span>, message);
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheDeleteRetryConsumer</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRY</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
    
    <span class="hljs-meta">@RabbitListener(queues = "cache.delete.queue")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCacheDelete</span><span class="hljs-params">(CacheDeleteMessage message)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> message.getKey();
        <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> message.getRetryCount();
        
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span> * (retryCount + <span class="hljs-number">1</span>)); <span class="hljs-comment">// 退避策略</span>
            redisTemplate.delete(key);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (retryCount &lt; MAX_RETRY) {
                message.setRetryCount(retryCount + <span class="hljs-number">1</span>);
                rabbitTemplate.convertAndSend(<span class="hljs-string">"cache.delete.queue"</span>, message);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Max retry reached for cache delete: {}"</span>, key);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-11">四、延迟双删策略</h2>
<p>延迟双删是针对<strong>极端并发场景</strong>的补充方案。虽然"先更新DB后删缓存"已经是最佳实践，但在特定条件下仍可能出现数据不一致。</p>
<blockquote>
<p><strong>方案演进说明</strong>：你可能注意到，第三章强调"先更新DB后删缓存"，而延迟双删却采用"先删缓存"。这看似矛盾，实则是不同场景的权衡：</p>
<ul>
<li>基本方案追求<strong>简单可靠</strong>，适用于99%的场景</li>
<li>延迟双删针对<strong>极端并发</strong>，通过第一次删除"临时封锁"读请求，牺牲少量性能换取更高一致性</li>
<li>两者可以结合使用：先删缓存→更新DB→延迟再删，覆盖更多边界场景</li>
</ul>
</blockquote>
<h3 data-id="heading-12">4.1 为什么需要延迟双删？</h3>
<p><strong>触发条件（同时满足）：</strong></p>
<ol>
<li>缓存刚好在此时过期（或不存在）</li>
<li>读请求在写请求"更新DB"和"删除缓存"之间到达</li>
<li>读请求的"回填缓存"操作晚于写请求的"删除缓存"</li>
</ol>
<p>这种情况概率极低（通常&lt;0.01%），但在高并发场景下确实可能发生。</p>
<p><strong>极端并发场景分析图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91dc0c0ac4fd44fe86cc2dbfe20af524~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=OXcrdO17zT502n19M1%2FPBUGENlM%3D" alt="延迟双删场景分析.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-13">4.2 延迟双删实现</h3>
<p><strong>延迟双删流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a6709dba6a431b96707fe5d086974c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=02As%2FXvOk5LfuEhWfONFmro7qw8%3D" alt="延迟双删流程.drawio.png" loading="lazy"/></p>
<p><strong>Java实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    
    <span class="hljs-comment">/**
     * 延迟双删策略
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductWithDoubleDelete</span><span class="hljs-params">(Product product, <span class="hljs-type">long</span> delayMs)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> PRODUCT_KEY_PREFIX + product.getId();
        
        <span class="hljs-comment">// 1. 第一次删除缓存</span>
        redisTemplate.delete(key);
        
        <span class="hljs-comment">// 2. 更新数据库</span>
        productMapper.updateById(product);
        
        <span class="hljs-comment">// 3. 延迟第二次删除缓存</span>
        CompletableFuture.delayedExecutor(delayMs, TimeUnit.MILLISECONDS)
            .execute(() -&gt; redisTemplate.delete(key));
    }
}
</code></pre>
<p><strong>延迟双删的局限性：</strong></p>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>解决极端并发问题</td><td>延迟期间仍可能不一致</td></tr><tr><td>实现相对简单</td><td>增加系统复杂度</td></tr><tr><td>无需额外中间件</td><td>延迟时间难以精确计算</td></tr></tbody></table>
<blockquote>
<p><strong>建议</strong>：对于大多数业务场景，"先更新DB后删缓存 + 合理的过期时间"已经足够。只有在对一致性要求较高且写并发较大的场景，才需要引入延迟双删。</p>
</blockquote>
<h2 data-id="heading-14">五、基于Binlog的最终一致性方案</h2>
<p>基于Binlog的方案是<strong>业务代码零侵入</strong>的终极方案，通过监听MySQL的Binlog变更，异步同步到缓存。这种方案常用于：</p>
<ul>
<li>微服务架构下的数据同步</li>
<li>对一致性要求较高但允许秒级延迟的场景</li>
<li>需要解耦业务代码与缓存逻辑的场景</li>
</ul>
<h3 data-id="heading-15">5.1 方案架构</h3>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>Canal</strong>：阿里开源的MySQL Binlog增量订阅组件，伪装成MySQL从库</li>
<li><strong>消息队列</strong>：Kafka/RocketMQ，用于解耦和削峰</li>
<li><strong>缓存同步服务</strong>：消费Binlog消息，执行缓存更新/删除</li>
</ul>
<p><strong>Binlog缓存同步架构图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/425d163a4fb44eab97703d5fa9c01d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=Cmfmu8wPlSI6BWmjB4mL3%2B0%2BkM4%3D" alt="Binlog缓存同步架构.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-16">5.2 Canal配置与使用</h3>
<p><strong>MySQL开启Binlog：</strong></p>
<pre><code class="hljs language-sql" lang="sql">[mysqld]
log<span class="hljs-operator">-</span>bin<span class="hljs-operator">=</span>mysql<span class="hljs-operator">-</span>bin
binlog<span class="hljs-operator">-</span>format<span class="hljs-operator">=</span><span class="hljs-type">ROW</span>
server<span class="hljs-operator">-</span>id<span class="hljs-operator">=</span><span class="hljs-number">1</span>

<span class="hljs-comment">-- 创建Canal用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'canal'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'canal123'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'canal'</span>@<span class="hljs-string">'%'</span>;
</code></pre>
<p><strong>Java消费端实现（完整版）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
<span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * Binlog缓存同步服务 - 处理INSERT/UPDATE/DELETE事件
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = "canal_product_topic", consumerGroup = "cache_sync_group")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalMessageConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;CanalMessage&gt; {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHE_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">CACHE_TTL</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span>; <span class="hljs-comment">// 30分钟</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(CanalMessage message)</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-string">"product"</span>.equals(message.getTable())) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-type">String</span> <span class="hljs-variable">eventType</span> <span class="hljs-operator">=</span> message.getType();
        log.info(<span class="hljs-string">"Received binlog event: table={}, type={}"</span>, message.getTable(), eventType);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (Map&lt;String, String&gt; data : message.getData()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> data.get(<span class="hljs-string">"id"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + id;
                
                <span class="hljs-keyword">switch</span> (eventType) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"INSERT"</span>:
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"UPDATE"</span>:
                        <span class="hljs-comment">// 方式一：直接删除缓存（推荐，简单可靠）</span>
                        redisTemplate.delete(key);
                        <span class="hljs-comment">// 方式二：更新缓存（可选，适合读多写少）</span>
                        <span class="hljs-comment">// String json = JSON.toJSONString(data);</span>
                        <span class="hljs-comment">// redisTemplate.opsForValue().set(key, json, CACHE_TTL, TimeUnit.SECONDS);</span>
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"DELETE"</span>:
                        redisTemplate.delete(key);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        log.warn(<span class="hljs-string">"Unknown event type: {}"</span>, eventType);
                }
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Failed to process binlog message: {}"</span>, message, e);
            <span class="hljs-comment">// 消费失败，RocketMQ会自动重试</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Binlog sync failed"</span>, e);
        }
    }
}

<span class="hljs-comment">/**
 * Canal消息实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalMessage</span> {
    <span class="hljs-keyword">private</span> String database;
    <span class="hljs-keyword">private</span> String table;
    <span class="hljs-keyword">private</span> String type;  <span class="hljs-comment">// INSERT, UPDATE, DELETE</span>
    <span class="hljs-keyword">private</span> List&lt;Map&lt;String, String&gt;&gt; data;
    <span class="hljs-keyword">private</span> List&lt;Map&lt;String, String&gt;&gt; old;  <span class="hljs-comment">// UPDATE时的旧值</span>
}
</code></pre>
<h3 data-id="heading-17">5.3 Binlog方案的可靠性与监控</h3>
<p><strong>潜在风险与应对：</strong></p>






























<table><thead><tr><th>风险点</th><th>描述</th><th>应对措施</th></tr></thead><tbody><tr><td>Canal延迟</td><td>Binlog解析+MQ投递，通常1-5秒</td><td>Prometheus监控Canal延迟，超阈值告警</td></tr><tr><td>Canal故障</td><td>进程挂掉或主从切换</td><td>部署高可用集群，Zookeeper选主</td></tr><tr><td>MQ消费失败</td><td>网络抖动或Redis故障</td><td>配置重试策略，死信队列兜底</td></tr><tr><td>消息积压</td><td>写入高峰期处理不及时</td><td>扩容消费者，监控lag指标</td></tr></tbody></table>
<p><strong>监控要点：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Prometheus监控指标示例</span>
<span class="hljs-string">canal_binlog_delay_seconds</span>  <span class="hljs-comment"># Canal解析延迟</span>
<span class="hljs-string">rocketmq_consumer_lag</span>       <span class="hljs-comment"># 消费积压量</span>
<span class="hljs-string">redis_cache_sync_success</span>    <span class="hljs-comment"># 同步成功率</span>
<span class="hljs-string">redis_cache_sync_latency</span>    <span class="hljs-comment"># 同步延迟</span>
</code></pre>
<h3 data-id="heading-18">5.4 Binlog方案优缺点</h3>






























<table><thead><tr><th>维度</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>一致性</td><td>最终一致性保证强</td><td>存在1-5秒延迟（Canal+MQ）</td></tr><tr><td>侵入性</td><td>业务代码零侵入</td><td>需运维Canal/Zookeeper集群</td></tr><tr><td>可靠性</td><td>Binlog本身不丢失</td><td>下游消费可能失败，需重试机制</td></tr><tr><td>扩展性</td><td>支持多表、多数据源同步</td><td>架构复杂度显著增加</td></tr></tbody></table>
<blockquote>
<p><strong>与Debezium对比</strong>：Debezium是另一个流行的CDC工具，支持更多数据库（PostgreSQL、MongoDB等），与Kafka Connector集成更好。Canal更适合国内MySQL生态，社区活跃度高。</p>
</blockquote>
<h2 data-id="heading-19">六、分布式锁方案</h2>
<p>当业务对一致性有<strong>强要求</strong>（如金融交易、库存扣减）时，可以使用分布式锁来保证缓存和数据库的强一致性。</p>
<h3 data-id="heading-20">6.1 读写锁保证强一致性</h3>
<p><strong>核心思想：</strong></p>
<ul>
<li>读操作获取<strong>读锁</strong>，允许多个读并发</li>
<li>写操作获取<strong>写锁</strong>，独占访问，阻塞其他读写</li>
<li>写锁释放后，其他读请求才能继续，保证读到最新数据</li>
</ul>
<p><strong>分布式读写锁架构图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/013a5f9ab53b4d019cf196470c85e53b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=6TqCKYUj4gn6lzGCejeLhvrsHWw%3D" alt="分布式读写锁架构.drawio.png" loading="lazy"/></p>
<p><strong>Java完整实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHE_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    
    <span class="hljs-comment">/**
     * 带读锁的查询
     */</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithLock</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_KEY_PREFIX + productId;
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + productId;
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取读锁，允许多个读并发</span>
            readLock.lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
            
            <span class="hljs-comment">// 先查缓存</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
            <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
                <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
            }
            
            <span class="hljs-comment">// 缓存miss，查数据库并回填</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                redisTemplate.opsForValue().set(cacheKey, 
                    JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
            }
            <span class="hljs-keyword">return</span> product;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (readLock.isHeldByCurrentThread()) {
                readLock.unlock();
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 带写锁的更新
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductWithLock</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_KEY_PREFIX + product.getId();
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + product.getId();
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取写锁，独占访问</span>
            writeLock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            
            <span class="hljs-comment">// 更新数据库</span>
            productMapper.updateById(product);
            
            <span class="hljs-comment">// 删除缓存</span>
            redisTemplate.delete(cacheKey);
            
            log.info(<span class="hljs-string">"Product updated with lock: {}"</span>, product.getId());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (writeLock.isHeldByCurrentThread()) {
                writeLock.unlock();
            }
        }
    }
}
</code></pre>
<p><strong>读写锁兼容性：</strong></p>

























<table><thead><tr><th>当前持有</th><th>读锁请求</th><th>写锁请求</th></tr></thead><tbody><tr><td>无锁</td><td>允许</td><td>允许</td></tr><tr><td>读锁</td><td>允许</td><td>阻塞</td></tr><tr><td>写锁</td><td>阻塞</td><td>阻塞</td></tr></tbody></table>
<p><strong>分布式锁方案的注意事项：</strong></p>
<ol>
<li><strong>锁粒度</strong>：锁的Key应该细化到具体数据ID，避免锁范围过大影响性能</li>
<li><strong>超时设置</strong>：必须设置锁超时，防止死锁</li>
<li><strong>性能影响</strong>：读写锁会降低系统吞吐量，仅在强一致性场景使用</li>
<li><strong>锁续期</strong>：对于长事务，考虑使用Redisson的看门狗机制自动续期</li>
<li><strong>锁重入</strong>：Redisson的RReadWriteLock支持锁重入，同一线程可多次获取</li>
</ol>
<blockquote>
<p><strong>建议</strong>：分布式锁方案仅适用于<strong>读多写少且对一致性有强要求</strong>的场景（如账户余额、库存扣减）。对于一般业务，Cache Aside + 合理TTL已足够。</p>
</blockquote>
<h2 data-id="heading-21">七、缓存一致性方案选型指南</h2>
<p>选择合适的缓存一致性方案，需要综合考虑业务场景、一致性要求、系统复杂度等因素。</p>
<h3 data-id="heading-22">7.1 方案对比总结</h3>















































<table><thead><tr><th>方案</th><th>一致性级别</th><th>实现复杂度</th><th>性能影响</th><th>适用场景</th></tr></thead><tbody><tr><td>Cache Aside</td><td>最终一致(ms级)</td><td>低</td><td>无</td><td><strong>通用场景（首选）</strong></td></tr><tr><td>延迟双删</td><td>最终一致(百ms级)</td><td>中</td><td>低</td><td>并发写入较多</td></tr><tr><td>MQ重试</td><td>最终一致(秒级)</td><td>中</td><td>无</td><td>网络不稳定</td></tr><tr><td>Binlog订阅</td><td>最终一致(秒级)</td><td>高</td><td>无</td><td>强一致性、数据同步</td></tr><tr><td>分布式锁</td><td>强一致</td><td>中</td><td>高</td><td>金融级要求</td></tr></tbody></table>
<h3 data-id="heading-23">7.2 决策流程图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba1623e794474f2aa2842d7b59f15027~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=diE1F0FITPhkuPOWxGD9hQDohQc%3D" alt="缓存方案选型决策.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-24">7.3 缓存三大经典问题</h3>
<p>除了一致性问题，缓存还有三个必须处理的经典问题：</p>

























<table><thead><tr><th>问题</th><th>描述</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>缓存穿透</strong></td><td>查询不存在的数据，每次都打到DB</td><td>缓存空值、布隆过滤器</td></tr><tr><td><strong>缓存击穿</strong></td><td>热点Key过期瞬间，大量请求打到DB</td><td>分布式锁、永不过期+异步更新</td></tr><tr><td><strong>缓存雪崩</strong></td><td>大量Key同时过期，DB瞬间压力剧增</td><td>过期时间加随机值、多级缓存</td></tr></tbody></table>
<h4 data-id="heading-25">7.3.1 缓存穿透防护</h4>
<p><strong>方案一：缓存空值</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
    
    <span class="hljs-comment">// 缓存命中（包括空值标记）</span>
    <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (json.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 空值标记，防止穿透</span>
        }
        <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
    }
    
    <span class="hljs-comment">// 查询数据库</span>
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
    
    <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
        redisTemplate.opsForValue().set(key, JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 缓存空值，短过期时间</span>
        redisTemplate.opsForValue().set(key, <span class="hljs-string">""</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
    }
    <span class="hljs-keyword">return</span> product;
}
</code></pre>
<p><strong>方案二：布隆过滤器（Redisson实现）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-keyword">private</span> RBloomFilter&lt;Long&gt; bloomFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBloomFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化布隆过滤器：预计元素数量100w，误判率0.01%</span>
        bloomFilter = redissonClient.getBloomFilter(<span class="hljs-string">"product:bloom"</span>);
        bloomFilter.tryInit(<span class="hljs-number">1_000_000L</span>, <span class="hljs-number">0.0001</span>);
        
        <span class="hljs-comment">// 预热：加载所有商品ID</span>
        List&lt;Long&gt; allIds = productMapper.selectAllIds();
        allIds.forEach(bloomFilter::add);
        log.info(<span class="hljs-string">"Bloom filter initialized with {} products"</span>, allIds.size());
    }
    
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithBloom</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-comment">// 1. 布隆过滤器快速判断</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.contains(productId)) {
            log.debug(<span class="hljs-string">"Product {} not in bloom filter"</span>, productId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 一定不存在</span>
        }
        
        <span class="hljs-comment">// 2. 布隆过滤器判断存在，但可能误判，继续查缓存和DB</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
            <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
        }
        
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
        }
        <span class="hljs-keyword">return</span> product;
    }
}
</code></pre>
<h4 data-id="heading-26">7.3.2 缓存击穿防护</h4>
<p><strong>方案一：分布式锁重建缓存</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithLockRebuild</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:rebuild:"</span> + productId;
    
    <span class="hljs-comment">// 1. 先查缓存</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
    <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
        <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
    }
    
    <span class="hljs-comment">// 2. 缓存miss，尝试获取锁重建</span>
    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 等待最多3秒获取锁</span>
        <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS)) {
            <span class="hljs-comment">// 双重检查</span>
            json = redisTemplate.opsForValue().get(cacheKey);
            <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
                <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
            }
            
            <span class="hljs-comment">// 查询DB并重建缓存</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                redisTemplate.opsForValue().set(cacheKey, 
                    JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
            }
            <span class="hljs-keyword">return</span> product;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 获取锁失败，短暂等待后重试</span>
            Thread.sleep(<span class="hljs-number">100</span>);
            <span class="hljs-keyword">return</span> getProductWithLockRebuild(productId);
        }
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        Thread.currentThread().interrupt();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Lock interrupted"</span>, e);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
</code></pre>
<p><strong>方案二：逻辑过期+异步更新</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheData</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> T data;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> expireTime; <span class="hljs-comment">// 逻辑过期时间戳</span>
}

<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithLogicalExpire</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
    
    <span class="hljs-keyword">if</span> (!StringUtils.hasText(json)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 需要预热</span>
    }
    
    CacheData&lt;Product&gt; cacheData = JSON.parseObject(json, 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;CacheData&lt;Product&gt;&gt;(){});
    
    <span class="hljs-comment">// 未过期，直接返回</span>
    <span class="hljs-keyword">if</span> (cacheData.getExpireTime() &gt; System.currentTimeMillis()) {
        <span class="hljs-keyword">return</span> cacheData.getData();
    }
    
    <span class="hljs-comment">// 已过期，异步更新</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:async:"</span> + productId;
    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
    <span class="hljs-keyword">if</span> (lock.tryLock()) {
        <span class="hljs-comment">// 异步更新缓存</span>
        CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
                CacheData&lt;Product&gt; newData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheData</span>&lt;&gt;();
                newData.setData(product);
                newData.setExpireTime(System.currentTimeMillis() + <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
                redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(newData));
            } <span class="hljs-keyword">finally</span> {
                lock.unlock();
            }
        });
    }
    
    <span class="hljs-comment">// 返回旧数据（兜底）</span>
    <span class="hljs-keyword">return</span> cacheData.getData();
}
</code></pre>
<h4 data-id="heading-27">7.3.3 缓存雪崩防护</h4>
<p><strong>随机过期时间</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">RANDOM</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithRandomExpire</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> baseMinutes)</span> {
    <span class="hljs-comment">// 基础过期时间 + 随机0-10分钟</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">randomMinutes</span> <span class="hljs-operator">=</span> baseMinutes + RANDOM.nextInt(<span class="hljs-number">10</span>);
    redisTemplate.opsForValue().set(key, JSON.toJSONString(value), 
        randomMinutes, TimeUnit.MINUTES);
}

<span class="hljs-comment">// 批量设置时使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchSetProducts</span><span class="hljs-params">(List&lt;Product&gt; products)</span> {
    products.forEach(p -&gt; {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + p.getId();
        setWithRandomExpire(key, p, <span class="hljs-number">30</span>); <span class="hljs-comment">// 30-40分钟随机过期</span>
    });
}
</code></pre>
<h2 data-id="heading-28">八、总结</h2>
<p>缓存一致性是分布式系统中的经典难题，没有银弹方案，只有适合业务场景的最佳实践。</p>
<h3 data-id="heading-29">方案选择速查表</h3>






























<table><thead><tr><th>业务场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>一般业务（如商品详情）</td><td>Cache Aside + 过期时间</td><td>简单可靠，满足最终一致</td></tr><tr><td>高并发写入（如秒杀库存）</td><td>延迟双删 + MQ重试</td><td>解决极端并发场景</td></tr><tr><td>数据同步（如搜索索引）</td><td>Binlog订阅</td><td>业务零侵入</td></tr><tr><td>金融交易</td><td>分布式读写锁</td><td>强一致性保证</td></tr></tbody></table>
<hr/>
<p>又是没有大厂约面日子😣😣😣，小编还在找实习的路上，这篇文章是我的笔记汇总整理。</p>
<h2 data-id="heading-30">参考文献</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fdocs%2Fmanual%2Fpatterns%2Fcaching%2F" target="_blank" title="https://redis.io/docs/manual/patterns/caching/" ref="nofollow noopener noreferrer">Redis官方文档 - Caching Patterns</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fcanal" target="_blank" title="https://github.com/alibaba/canal" ref="nofollow noopener noreferrer">Canal GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdebezium.io%2F" target="_blank" title="https://debezium.io/" ref="nofollow noopener noreferrer">Debezium - Change Data Capture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2017%2F03%2F17%2Fcache-about.html" target="_blank" title="https://tech.meituan.com/2017/03/17/cache-about.html" ref="nofollow noopener noreferrer">美团技术博客 - 缓存那些事</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcaching%2Fbest-practices%2F" target="_blank" title="https://aws.amazon.com/caching/best-practices/" ref="nofollow noopener noreferrer">AWS Caching Best Practices</a></li>
<li>《Redis设计与实现》- 黄健宏</li>
<li>《分布式系统：概念与设计》- George Coulouris</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Freleases%2Ftag%2F7.0.0" target="_blank" title="https://github.com/redis/redis/releases/tag/7.0.0" ref="nofollow noopener noreferrer">Redis 7.0 Release Notes</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[知识库-向量化功能-读取PDF文件内容的方法]]></title>    <link>https://juejin.cn/post/7586971532699828233</link>    <guid>https://juejin.cn/post/7586971532699828233</guid>    <pubDate>2025-12-24T06:10:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586971532699828233" data-draft-id="7586657335881203739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="知识库-向量化功能-读取PDF文件内容的方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-24T06:10:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlie_ll"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            知识库-向量化功能-读取PDF文件内容的方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlie_ll
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:10:01.000Z" title="Wed Dec 24 2025 06:10:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">知识库-向量化功能-读取PDF文件内容的方法</h2>
<h3 data-id="heading-1">一、核心逻辑</h3>
<p>基于Apache PDFBox组件解析PDF文件，<strong>仅提取原生文本内容</strong>（不处理图片、扫描件，也不涉及OCR光学字符识别），解析后对文本做格式化处理，为后续向量化提供干净的数据源。</p>
<h3 data-id="heading-2">二、依赖配置（Maven）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- PDF文本解析核心依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.pdfbox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pdfbox<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 稳定版本，兼容主流PDF格式 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>说明：PDFBox 3.0.2适配Java 8+，若项目为低版本Java，可降级至2.0.x系列（如2.0.32）。</p>
</blockquote>
<h3 data-id="heading-3">三、核心实现代码</h3>
<h4 data-id="heading-4">3.1 配置类（支持扩展OCR）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDDocument;
<span class="hljs-keyword">import</span> org.apache.pdfbox.text.PDFTextStripper;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * PDF解析配置类（预留OCR扩展能力，默认仅提取原生文本）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-comment">// 核心配置：是否提取原生文本（默认开启）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">extractNativeText</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// OCR扩展配置（当前功能未启用，仅预留）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">ocrLanguage</span> <span class="hljs-operator">=</span> <span class="hljs-string">"chi_sim+eng"</span>; <span class="hljs-comment">// 识别语言（中文+英文）</span>

    <span class="hljs-comment">/**
     * 设置是否提取原生文本
     * <span class="hljs-doctag">@param</span> enable 开启/关闭
     * <span class="hljs-doctag">@return</span> 配置对象（链式调用）
     */</span>
    <span class="hljs-keyword">public</span> Config <span class="hljs-title function_">extractNativeText</span><span class="hljs-params">(<span class="hljs-type">boolean</span> enable)</span> {
        <span class="hljs-built_in">this</span>.extractNativeText = enable;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-comment">/**
     * 设置OCR识别语言（预留配置）
     * <span class="hljs-doctag">@param</span> lang 语言编码（如chi_sim=简体中文，eng=英文）
     * <span class="hljs-doctag">@return</span> 配置对象（链式调用）
     */</span>
    <span class="hljs-keyword">public</span> Config <span class="hljs-title function_">ocrLanguage</span><span class="hljs-params">(String lang)</span> {
        <span class="hljs-built_in">this</span>.ocrLanguage = lang;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }

    <span class="hljs-comment">// 配置项getter（按需添加）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExtractNativeText</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> extractNativeText;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOcrLanguage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ocrLanguage;
    }
}
</code></pre>
<h4 data-id="heading-5">3.2 结果封装类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * PDF解析结果封装类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OcrResult</span> {
    <span class="hljs-comment">// 原生文本内容（核心字段）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-variable">nativeText</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-comment">// OCR文本（预留字段，当前未启用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-variable">ocrText</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-comment">// 图片路径（预留字段，当前未启用）</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; imagePaths = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 获取合并后的文本（当前仅返回原生文本）
     * <span class="hljs-doctag">@return</span> 格式化后的原生文本
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCombinedText</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> nativeText;
    }
}
</code></pre>
<h4 data-id="heading-6">3.3 核心解析方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 核心PDF处理方法（仅提取原生文本）
 * <span class="hljs-doctag">@param</span> pdfFile 待解析的PDF文件
 * <span class="hljs-doctag">@param</span> config 解析配置
 * <span class="hljs-doctag">@return</span> 解析结果对象
 * <span class="hljs-doctag">@throws</span> Exception 文件读取/解析异常
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OcrResult <span class="hljs-title function_">process</span><span class="hljs-params">(File pdfFile, Config config)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">OcrResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OcrResult</span>();
    <span class="hljs-comment">// 资源自动关闭，避免文件句柄泄漏</span>
    <span class="hljs-keyword">try</span> (<span class="hljs-type">PDDocument</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> org.apache.pdfbox.Loader.loadPDF(pdfFile)) {
        <span class="hljs-comment">// 仅处理原生文本提取（核心逻辑）</span>
        <span class="hljs-keyword">if</span> (config.isExtractNativeText()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">nativeText</span> <span class="hljs-operator">=</span> extractNativeText(doc);
            result.nativeText = nativeText;
            <span class="hljs-comment">// 预留：智能触发OCR的逻辑（当前功能未启用）</span>
            <span class="hljs-comment">// boolean needOcr = nativeText.trim().length() &lt; 100; // 示例：文本过短时触发OCR</span>
        }
        <span class="hljs-comment">// OCR处理逻辑（当前功能未启用，预留扩展）</span>
    }
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">/**
 * 提取PDF原生文本
 * <span class="hljs-doctag">@param</span> doc PDF文档对象
 * <span class="hljs-doctag">@return</span> 原始文本内容
 * <span class="hljs-doctag">@throws</span> IOException 解析异常
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">extractNativeText</span><span class="hljs-params">(PDDocument doc)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">PDFTextStripper</span> <span class="hljs-variable">stripper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDFTextStripper</span>();
    <span class="hljs-comment">// 可选：设置提取页码范围（如stripper.setStartPage(1); stripper.setEndPage(5);）</span>
    <span class="hljs-keyword">return</span> stripper.getText(doc);
}
</code></pre>
<h4 data-id="heading-7">3.4 文本格式化方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 格式化PDF解析后的文本，清理冗余字符
 * <span class="hljs-doctag">@param</span> content 原始解析文本
 * <span class="hljs-doctag">@return</span> 格式化后的干净文本
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">trimContent</span><span class="hljs-params">(String content)</span> {
    <span class="hljs-keyword">if</span> (content == <span class="hljs-literal">null</span> || content.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
    <span class="hljs-keyword">return</span> content
            .replaceAll(<span class="hljs-string">"-\\n"</span>, <span class="hljs-string">""</span>)        <span class="hljs-comment">// 合并PDF断行（如"文本-\\n换行"→"文本换行"）</span>
            .replaceAll(<span class="hljs-string">"\\s{2,}"</span>, <span class="hljs-string">" "</span>)    <span class="hljs-comment">// 压缩连续空格（多个空格→单个空格）</span>
            .replaceAll(<span class="hljs-string">"(?m)^\\d+$"</span>, <span class="hljs-string">""</span>)  <span class="hljs-comment">// 删除纯数字页码行（仅匹配整行数字）</span>
            .replaceAll(<span class="hljs-string">"\\r\\n|\\r|\\n"</span>, <span class="hljs-string">" "</span>) <span class="hljs-comment">// 统一换行符为空格</span>
            .trim();                       <span class="hljs-comment">// 去除首尾空白</span>
}
</code></pre>
<h4 data-id="heading-8">3.5 统一调用入口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 统一读取PDF文件文本内容
 * <span class="hljs-doctag">@param</span> filePath PDF文件绝对路径
 * <span class="hljs-doctag">@return</span> 格式化后的纯文本
 * <span class="hljs-doctag">@throws</span> RuntimeException 解析失败异常
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">(String filePath)</span> {
    <span class="hljs-comment">// 初始化配置：仅提取原生文本，预留OCR语言配置</span>
    <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>()
            .extractNativeText(<span class="hljs-literal">true</span>)
            .ocrLanguage(<span class="hljs-string">"chi_sim+eng"</span>); <span class="hljs-comment">// 中文+英文（预留配置）</span>

    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-comment">// 前置校验：文件存在性、合法性</span>
        <span class="hljs-keyword">if</span> (!file.exists()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileNotFoundException</span>(<span class="hljs-string">"PDF文件不存在："</span> + filePath);
        }
        <span class="hljs-keyword">if</span> (!file.isFile() || !filePath.endsWith(<span class="hljs-string">".pdf"</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非合法PDF文件："</span> + filePath);
        }

        <span class="hljs-type">OcrResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> process(file, config);
        <span class="hljs-type">String</span> <span class="hljs-variable">combinedText</span> <span class="hljs-operator">=</span> result.getCombinedText();
        <span class="hljs-comment">// 格式化文本，返回干净数据</span>
        <span class="hljs-keyword">return</span> trimContent(combinedText);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"PDF文本提取失败: "</span> + e.getMessage(), e);
    }
}
</code></pre>
<h3 data-id="heading-9">四、核心设计说明</h3>
<h4 data-id="heading-10">4.1 关键优化点</h4>





























<table><thead><tr><th>设计点</th><th>解决的问题</th></tr></thead><tbody><tr><td>仅提取原生文本</td><td>避免OCR带来的性能损耗，聚焦文本向量化核心需求</td></tr><tr><td>资源自动关闭（try-with-resources）</td><td>解决PDF文档对象/文件流未关闭导致的句柄泄漏</td></tr><tr><td>文本格式化处理</td><td>清理PDF解析后的断行、冗余空格、页码，提升后续向量化准确性</td></tr><tr><td>前置文件校验</td><td>提前拦截“文件不存在”“非PDF文件”等基础异常</td></tr><tr><td>链式配置类</td><td>便于扩展OCR等功能，保持代码可读性</td></tr></tbody></table>
<h4 data-id="heading-11">4.2 方法调用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 调用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">pdfText</span> <span class="hljs-operator">=</span> getContent(<span class="hljs-string">"D:/test.pdf"</span>);
        System.out.println(<span class="hljs-string">"PDF解析后的文本："</span> + pdfText);
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        System.err.println(<span class="hljs-string">"解析失败："</span> + e.getMessage());
        e.printStackTrace();
    }
}
</code></pre>
<h3 data-id="heading-12">五、注意事项</h3>
<ol>
<li><strong>格式支持范围</strong>：仅支持原生文本PDF（可复制文字的PDF），扫描件/图片型PDF解析后无内容（需扩展OCR）；</li>
<li><strong>特殊内容处理</strong>：PDFBox会忽略PDF中的图片、表单、批注，仅提取文本；若需解析表格，需额外适配<code>PDFTextStripperByArea</code>；</li>
<li><strong>性能优化</strong>：解析大PDF（&gt;100MB）时，建议分页码解析（设置<code>startPage/endPage</code>），避免内存溢出；</li>
<li><strong>编码问题</strong>：PDFBox默认采用UTF-8编码，解析乱码时可检查PDF文件本身的编码格式；</li>
<li><strong>依赖冲突</strong>：若项目中存在其他PDFBox版本，需统一为3.0.2，避免<code>NoSuchMethodError</code>；</li>
<li><strong>权限问题</strong>：解析网络路径/只读文件时，需确保文件读取权限，避免<code>AccessDeniedException</code>。</li>
</ol>
<h3 data-id="heading-13">六、扩展建议</h3>
<ol>
<li><strong>分页码解析</strong>：在<code>extractNativeText</code>方法中增加页码范围参数，支持指定页码提取；</li>
<li><strong>异步解析</strong>：结合线程池实现大批量PDF异步解析，提升处理效率；</li>
<li><strong>OCR扩展</strong>：集成Tesseract OCR，实现“原生文本+OCR”混合解析（适配扫描件PDF）；</li>
<li><strong>进度监控</strong>：解析大文件时增加进度回调，便于前端展示解析进度；</li>
<li><strong>容错处理</strong>：对损坏的PDF文件增加重试机制，或返回空字符串避免程序崩溃；</li>
<li><strong>日志记录</strong>：增加解析日志（文件路径、解析耗时、文本长度），便于问题排查；</li>
<li><strong>大小限制</strong>：在<code>getContent</code>方法中增加文件大小校验（如限制最大解析200MB），避免内存耗尽。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂 PHP 中的 `cURL` 和 `header()`：请求头 vs 响应头]]></title>    <link>https://juejin.cn/post/7587020682010116123</link>    <guid>https://juejin.cn/post/7587020682010116123</guid>    <pubDate>2025-12-24T06:18:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587020682010116123" data-draft-id="7586971532699861001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂 PHP 中的 `cURL` 和 `header()`：请求头 vs 响应头"/> <meta itemprop="keywords" content="PHP"/> <meta itemprop="datePublished" content="2025-12-24T06:18:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户307459698207"/> <meta itemprop="url" content="https://juejin.cn/user/4877851570621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂 PHP 中的 `cURL` 和 `header()`：请求头 vs 响应头
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4877851570621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户307459698207
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:18:27.000Z" title="Wed Dec 24 2025 06:18:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>一句话记住核心区别</strong>：<br/>
<strong><code>cURL</code> 是“你主动发请求给别人”，<code>header()</code> 是“你告诉浏览器怎么处理你的返回”。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、先搞清方向：HTTP 通信的两个角色</h2>
<p>在 Web 开发中，PHP 脚本可以扮演两种角色：</p>




















<table><thead><tr><th>角色</th><th>行为</th><th>使用工具</th></tr></thead><tbody><tr><td><strong>客户端（Client）</strong></td><td>主动调用其他服务器（如微信 API、支付接口）</td><td><code>cURL</code></td></tr><tr><td><strong>服务器（Server）</strong></td><td>响应浏览器或前端 AJAX 请求</td><td><code>header()</code></td></tr></tbody></table>
<p>✅ 所以：</p>
<ul>
<li>当你用 PHP <strong>调别人接口</strong> → 用 <strong><code>cURL</code></strong></li>
<li>当你用 PHP <strong>给前端返回数据</strong> → 用 <strong><code>header()</code></strong></li>
</ul>
<hr/>
<h2 data-id="heading-1">二、<code>cURL</code>：PHP 作为“客户端”发请求</h2>
<h3 data-id="heading-2">✅ 典型场景</h3>
<ul>
<li>调用微信支付</li>
<li>获取天气 API 数据</li>
<li>向第三方推送消息</li>
</ul>
<h3 data-id="heading-3">🔧 最简 POST JSON 示例</h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$data</span> = [<span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-number">123</span>, <span class="hljs-string">'action'</span> =&gt; <span class="hljs-string">'login'</span>];
<span class="hljs-variable">$json</span> = json_encode(<span class="hljs-variable">$data</span>);

<span class="hljs-variable">$ch</span> = curl_init(); <span class="hljs-regexp">//</span>初始化
curl_setopt_array(<span class="hljs-variable">$ch</span>, [
    <span class="hljs-variable constant_">CURLOPT_URL</span>            =&gt; <span class="hljs-string">'https://api.example.com/notify'</span>, <span class="hljs-regexp">//</span>设置路径
    <span class="hljs-variable constant_">CURLOPT_POST</span>           =&gt; <span class="hljs-literal">true</span>, <span class="hljs-regexp">//</span>是否为post
    <span class="hljs-variable constant_">CURLOPT_POSTFIELDS</span>     =&gt; <span class="hljs-variable">$json</span>, <span class="hljs-regexp">//post</span>的数据
    <span class="hljs-variable constant_">CURLOPT_RETURNTRANSFER</span> =&gt; <span class="hljs-literal">true</span>,  <span class="hljs-regexp">//</span>是否转成字符串
    <span class="hljs-variable constant_">CURLOPT_HTTPHEADER</span>     =&gt; [  <span class="hljs-regexp">//header</span>请求头
        <span class="hljs-string">'Content-Type: application/json'</span>,      <span class="hljs-regexp">//</span> 告诉对方：“我发的是 <span class="hljs-variable constant_">JSON</span>”
        <span class="hljs-string">'Authorization: Bearer your_token'</span>
    ]
]);
<span class="hljs-variable">$response</span> = curl_exec(<span class="hljs-variable">$ch</span>); <span class="hljs-regexp">//</span>执行
curl_close(<span class="hljs-variable">$ch</span>);  <span class="hljs-regexp">//</span>关闭
</code></pre>
<h3 data-id="heading-4">📌 关键点</h3>
<ul>
<li><code>CURLOPT_HTTPHEADER</code> 设置的是 <strong>请求头（Request Headers）</strong></li>
<li>必须手动加 <code>'Content-Type: application/json'</code>，否则对方可能无法解析</li>
<li><code>cURL</code> 的 Header 是 <strong>你告诉“目标服务器”</strong>  的话</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、<code>header()</code>：PHP 作为“服务器”响应浏览器</h2>
<h3 data-id="heading-6">✅ 典型场景</h3>
<ul>
<li>返回 JSON 给 AJAX</li>
<li>动态生成图片/PDF 并显示</li>
<li>登录后跳转页面</li>
<li>禁止缓存敏感页面</li>
</ul>
<h3 data-id="heading-7">🔧 常见用法示例</h3>
<h4 data-id="heading-8">1. 返回 JSON（API 接口）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">header</span>('<span class="hljs-attribute">Content</span>-Type: application/json; charset=utf-<span class="hljs-number">8</span>');
echo json_encode(<span class="hljs-selector-attr">[<span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'success'</span>]</span>);
</code></pre>
<h4 data-id="heading-9">2. 重定向（跳转）</h4>
<pre><code class="hljs language-perl" lang="perl">header(<span class="hljs-string">'Location: /dashboard.php'</span>);
<span class="hljs-keyword">exit</span>; <span class="hljs-regexp">//</span> ⚠️ 必须加 <span class="hljs-keyword">exit</span>！
</code></pre>
<h4 data-id="heading-10">3. 强制下载文件</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">header</span>(<span class="hljs-string">'Content-Type: application/pdf'</span>);
<span class="hljs-selector-tag">header</span>(<span class="hljs-string">'Content-Disposition: attachment; filename="report.pdf"'</span>);
<span class="hljs-selector-tag">readfile</span>(<span class="hljs-string">'report.pdf'</span>);
</code></pre>
<h4 data-id="heading-11">4. 禁止缓存</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">header</span>(<span class="hljs-string">'Cache-Control: no-cache, no-store, must-revalidate'</span>);
<span class="hljs-selector-tag">header</span>(<span class="hljs-string">'Pragma: no-cache'</span>);
<span class="hljs-selector-tag">header</span>(<span class="hljs-string">'Expires: 0'</span>);
</code></pre>
<h3 data-id="heading-12">📌 关键点</h3>
<ul>
<li><code>header()</code> 设置的是 <strong>响应头（Response Headers）</strong></li>
<li>必须在<strong>任何输出之前调用</strong>（不能有 echo、HTML、空格等）</li>
<li><code>header()</code> 的 Header 是 <strong>你告诉“浏览器/前端”</strong>  的话</li>
</ul>
<hr/>
<h2 data-id="heading-13">四、对比总结：一张表看懂区别</h2>








































<table><thead><tr><th>项目</th><th><code>cURL</code></th><th><code>header()</code></th></tr></thead><tbody><tr><td><strong>角色</strong></td><td>客户端（主动请求别人）</td><td>服务器（被动响应浏览器）</td></tr><tr><td><strong>方向</strong></td><td>PHP → 外部服务器</td><td>PHP → 浏览器/前端</td></tr><tr><td><strong>Header 类型</strong></td><td>请求头（Request Header）</td><td>响应头（Response Header）</td></tr><tr><td><strong>典型用途</strong></td><td>调 API、发数据</td><td>返回 JSON、跳转、下载、设 Cookie</td></tr><tr><td><strong>是否需提前输出</strong></td><td>无限制</td><td>❌ 必须在任何输出前调用</td></tr><tr><td><strong>常见 Header</strong></td><td><code>Content-Type</code>, <code>Authorization</code></td><td><code>Content-Type</code>, <code>Location</code>, <code>Cache-Control</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">五、高频问题解答（FAQ）</h2>
<h3 data-id="heading-15">❓ Q1：<code>Content-Type</code> 两边都能用？</h3>
<p>✅ 是的！但含义不同：</p>
<ul>
<li><code>cURL</code> 中： <strong>“我发的数据是 JSON”</strong></li>
<li><code>header()</code> 中： <strong>“我返回的数据是 JSON”</strong></li>
</ul>
<h3 data-id="heading-16">❓ Q2：前端发 JSON，我能回 HTML 吗？</h3>
<p>✅ 当然可以！只要：</p>
<ul>
<li>后端设 <code>header('Content-Type: text/html')</code></li>
<li>前端用 <code>.text()</code> 而不是 <code>.json()</code> 读取</li>
</ul>
<h3 data-id="heading-17">❓ Q3：怎么知道该写什么 MIME 类型？</h3>
<p>👉 查 MDN：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">Common MIME types</a><br/>
或用浏览器 DevTools 看别人网站的响应头。</p>
<h3 data-id="heading-18">❓ Q4：<code>header()</code> 报错 “Cannot modify header information”？</h3>
<p>👉 因为前面已经有输出（空格、echo、BOM 等）。<br/>
✅ 解决方案：</p>
<ul>
<li>确保 <code>header()</code> 在最顶部</li>
<li>或开启输出缓冲：<code>ob_start();</code></li>
</ul>
<hr/>
<h2 data-id="heading-19">六、记忆口诀（背这一段就够了）</h2>
<blockquote>
<p><strong>cURL 是“我说”——我发请求，告诉别人我是谁、发什么格式；</strong><br/>
<strong>header() 是“我说给你听”——我返回结果，告诉浏览器怎么处理。</strong></p>
<p><strong>方向相反，用途不同，千万别混！</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-20">七、推荐调试方法</h2>
<ol>
<li><strong>看请求头？</strong>  → 用 cURL + 日志，或抓包工具（如 Wireshark）</li>
<li><strong>看响应头？</strong>  → 浏览器按 <code>F12</code> → Network → 点请求 → 查看 <strong>Response Headers</strong></li>
<li><strong>不确定 MIME 类型？</strong>  → Google 搜 “mime type pdf”</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给前端明星开源项目Biome提 PR，被 Snapshot 测试坑了一把]]></title>    <link>https://juejin.cn/post/7586983243925782566</link>    <guid>https://juejin.cn/post/7586983243925782566</guid>    <pubDate>2025-12-24T05:27:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243925782566" data-draft-id="7586983243925766182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给前端明星开源项目Biome提 PR，被 Snapshot 测试坑了一把"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-12-24T05:27:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给前端明星开源项目Biome提 PR，被 Snapshot 测试坑了一把
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:27:55.000Z" title="Wed Dec 24 2025 05:27:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Snapshot 测试：从一次 CI 失败说起</h2>
<p>最近给 Biome 提了个 PR，改了几个文件，本地测试跑过了，push 上去，CI 挂了。</p>
<p>报错信息是这样的：</p>
<pre><code class="hljs language-arduino" lang="arduino">---- specs::nursery::no_undeclared_env_vars::invalid_js stdout ----
thread <span class="hljs-string">'specs::nursery::no_undeclared_env_vars::invalid_js'</span> panicked at
crates/biome_js_analyze/tests/spec_tests.rs:<span class="hljs-number">19</span>:<span class="hljs-number">5</span>:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot file: crates/biome_js_analyze/tests/specs/nursery/noUndeclaredEnvVars/invalid.js.snap
Snapshot: invalid_js
Source: crates/biome_js_analyze/tests/spec_tests.rs:<span class="hljs-number">19</span>

-old snapshot
+<span class="hljs-keyword">new</span> results
────────────────────────────────────────────────────────────────────────────────
</code></pre>
<p>一脸懵。我改的是 <code>--stdin-file-path</code> 的逻辑，跟 <code>noUndeclaredEnvVars</code> 这个 lint 规则有什么关系？</p>
<p>后来搞明白了：我的分支落后于 main，rebase 之后把上游的改动合进来了。上游给这个规则加了一行提示信息，但快照文件还是旧的，所以测试失败。</p>
<p>这就是 snapshot 测试。</p>
<h3 data-id="heading-1">什么是 snapshot 测试</h3>
<p>Snapshot，直译就是"快照"。生活中的快照是某个时刻的照片，代码里的 snapshot 是某个时刻程序输出的"照片"。</p>
<p>传统测试是这样写的：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 你得手动写出期望的输出</span>
<span class="hljs-built_in">assert_eq!</span>(<span class="hljs-title function_ invoke__">format</span>(<span class="hljs-string">"let x=1"</span>), <span class="hljs-string">"let x = 1;\n"</span>);
</code></pre>
<p>Snapshot 测试换了个思路：<strong>你不用写期望值，让程序自己记录。</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">第一次跑测试：
  输入 → 程序 → 输出 → 自动保存成 .snap 文件（这就是<span class="hljs-string">"快照"</span>）

后续跑测试：
  输入 → 程序 → 输出 → 跟 .snap 文件比对
                         │
                         ├── 一样 → 通过
                         └── 不一样 → 失败，显示 diff
</code></pre>
<p>第一次运行时，测试框架会问你："这个输出对吗？"你确认后，它就把输出存成 <code>.snap</code> 文件。之后每次运行，都拿新输出跟这个文件比。</p>
<p><strong>为什么叫"快照"？</strong></p>
<p>因为它记录的是某个时间点的状态。就像你给代码的输出拍了张照片，以后每次都拿新输出跟照片对比，看有没有变化。</p>
<p><strong>Snapshot 文件存什么？</strong></p>
<p>就是纯文本，记录程序的输出。比如格式化工具的 snapshot 存的是格式化后的代码，CLI 工具的 snapshot 存的是命令行输出，React 组件的 snapshot 存的是渲染出来的 DOM 结构。</p>
<p>我遇到的情况就是：上游改了规则的输出（多了一行 "This rule belongs to the nursery group"），但 <code>.snap</code> 文件还是旧的，新输出跟旧快照不一样，所以测试失败。</p>
<h3 data-id="heading-2">怎么修</h3>
<p>Biome 用的是 Rust 生态的 <code>insta</code> 库做 snapshot 测试。修起来很简单：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先本地跑一遍测试，确认是 snapshot 的问题</span>
cargo <span class="hljs-built_in">test</span>

<span class="hljs-comment"># 接受新的 snapshot</span>
cargo insta accept

<span class="hljs-comment"># 或者用交互模式，逐个确认</span>
cargo insta review
</code></pre>
<p>跑完 <code>cargo insta accept</code>，它会自动更新 <code>.snap</code> 文件。commit 进去，push，CI 就过了。</p>
<h3 data-id="heading-3">快照文件长什么样</h3>
<p>看一眼 Biome 里的快照文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">source:</span> <span class="hljs-string">crates/biome_cli/tests/snap_test.rs</span>
<span class="hljs-attr">expression:</span> <span class="hljs-string">content</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment">## `biome.json`</span>

<span class="hljs-string">```json</span>
{ <span class="hljs-attr">"files":</span> { <span class="hljs-attr">"includes":</span> [<span class="hljs-string">"apps/**"</span>] } }
</code></pre>
<h2 data-id="heading-4">Emitted Messages</h2>
<pre><code class="hljs language-block" lang="block">function f() {
	return {};
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp">
就是把测试的输入（配置文件）和输出（格式化结果）都记下来。下次跑测试，输出变了就能发现。

<span class="hljs-meta">## 为什么 Biome 要用 snapshot 测试</span>

先想一个问题：Biome 是做什么的？

代码格式化和 lint。输入一段代码，输出格式化后的代码，或者输出一堆 lint 警告。

这类工具有个特点：**输出又长又复杂，而且经常变。**

比如格式化 `<span class="hljs-function">function <span class="hljs-title">f</span>()</span>{<span class="hljs-keyword">return</span>{}}` 这段代码，输出是：

```<span class="hljs-function">javascript
function <span class="hljs-title">f</span>()</span> {
	<span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>如果用传统测试，你得这样写：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-built_in">assert_eq!</span>(
    <span class="hljs-title function_ invoke__">format_code</span>(<span class="hljs-string">"function f(){return{}}"</span>),
    <span class="hljs-string">"function f() {\n\treturn {};\n}\n"</span>
);
</code></pre>
<p>问题来了：</p>
<ol>
<li><strong>输出太长</strong>：这还是最简单的例子，真实场景可能是几十上百行代码</li>
<li><strong>转义字符地狱</strong>：<code>\n</code>、<code>\t</code> 一多，根本没法读</li>
<li><strong>改动频繁</strong>：格式化规则经常调整，比如"函数前要不要空行"，一改就得手动更新几百个测试</li>
</ol>
<p>Biome 有几千个测试用例，如果每个都手写期望值，维护成本太高了。</p>
<p>Snapshot 测试解决了这个问题：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不用写期望值，框架自动存</span>
assert_snapshot!(<span class="hljs-title function_ invoke__">format_code</span>(<span class="hljs-string">"function f(){return{}}"</span>));
</code></pre>
<p>输出自动存到 <code>.snap</code> 文件里，下次运行自动比对。改了格式化规则？跑一遍 <code>cargo insta accept</code>，几千个快照一起更新。</p>
<h3 data-id="heading-5">哪些项目在用</h3>
<p>不只是 Biome，很多知名项目都重度依赖 snapshot 测试：</p>













































<table><thead><tr><th>项目</th><th>类型</th><th>为什么用 snapshot</th></tr></thead><tbody><tr><td><strong>Prettier</strong></td><td>代码格式化</td><td>输出是格式化后的代码，手写太累</td></tr><tr><td><strong>Babel</strong></td><td>JS 编译器</td><td>输出是转换后的代码</td></tr><tr><td><strong>TypeScript</strong></td><td>类型检查</td><td>错误信息、类型推断结果</td></tr><tr><td><strong>Rome/Biome</strong></td><td>格式化+Lint</td><td>格式化结果、诊断信息</td></tr><tr><td><strong>Jest</strong></td><td>测试框架</td><td>React 组件渲染结果</td></tr><tr><td><strong>Rust Analyzer</strong></td><td>IDE 支持</td><td>代码补全、悬停提示</td></tr><tr><td><strong>SWC</strong></td><td>JS/TS 编译器</td><td>AST、转换结果</td></tr></tbody></table>
<p>这些项目有个共同点：<strong>输出是结构化的文本，而且量大</strong>。</p>
<p>用 snapshot 测试的好处：</p>
<ol>
<li><strong>防止回归</strong>：改了一行代码，所有相关输出的变化都能看到</li>
<li><strong>代码审查友好</strong>：PR 里能直接看到输出变化的 diff</li>
<li><strong>文档作用</strong>：快照文件本身就是"这个输入应该产生什么输出"的文档</li>
<li><strong>维护成本低</strong>：输出变了，一条命令更新，不用手动改几百个测试</li>
</ol>
<h3 data-id="heading-6">一个真实的例子</h3>
<p>我这次改的 PR 加了一个测试用例，测试 stdin 输入能不能正常格式化。</p>
<p>测试代码很简单：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[test]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">format_stdin_formats_virtual_path_outside_includes</span>() {
    <span class="hljs-comment">// 准备输入</span>
    console.in_buffer.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">"function f() {return{}}"</span>.<span class="hljs-title function_ invoke__">to_string</span>());

    <span class="hljs-comment">// 运行格式化</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">run_cli</span>(
        Args::<span class="hljs-title function_ invoke__">from</span>([<span class="hljs-string">"format"</span>, <span class="hljs-string">"--stdin-file-path"</span>, <span class="hljs-string">"mock.js"</span>]),
    );

    <span class="hljs-comment">// 快照测试</span>
    assert_cli_snapshot!(...);
}
</code></pre>
<p>生成的快照文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">source:</span> <span class="hljs-string">crates/biome_cli/tests/snap_test.rs</span>
<span class="hljs-attr">expression:</span> <span class="hljs-string">content</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment">## `biome.json`</span>

{ <span class="hljs-attr">"files":</span> { <span class="hljs-attr">"includes":</span> [<span class="hljs-string">"apps/**"</span>] } }

<span class="hljs-comment"># Emitted Messages</span>

<span class="hljs-string">function</span> <span class="hljs-string">f()</span> {
	<span class="hljs-string">return</span> {}<span class="hljs-string">;</span>
}
</code></pre>
<p>以后如果有人改了格式化逻辑，导致输出变了，测试就会失败，提醒你检查这个变化是不是预期的。</p>
<h3 data-id="heading-7">什么时候用</h3>
<p>适合的场景：</p>

























<table><thead><tr><th>场景</th><th>例子</th></tr></thead><tbody><tr><td>CLI 工具</td><td>帮助信息、错误消息、格式化输出</td></tr><tr><td>编译器/格式化器</td><td>代码转换结果、AST 输出</td></tr><tr><td>UI 组件</td><td>React/Vue 组件的渲染结果</td></tr><tr><td>序列化</td><td>JSON、YAML 的输出</td></tr></tbody></table>
<p>不太适合的场景：</p>
<ul>
<li>简单断言（<code>1 + 1 == 2</code>）</li>
<li>随机/时间相关的输出</li>
<li>业务逻辑验证（snapshot 只能告诉你"变了"，不能告诉你"对不对"）</li>
</ul>
<h3 data-id="heading-8">容易踩的坑</h3>
<p><strong>1. 无脑 accept</strong></p>
<p>测试挂了，看都不看直接 <code>cargo insta accept</code>。这样 snapshot 测试就失去意义了——万一是真的 bug 呢？</p>
<p>我这次的情况比较明确，是 rebase 带进来的改动，所以直接 accept 没问题。但平时还是要看一眼 diff。</p>
<p><strong>2. 忘了提交快照文件</strong></p>
<p>本地跑测试没问题，CI 挂了。因为 <code>.snap</code> 文件没 commit。</p>
<p><strong>3. 快照太大</strong></p>
<p>有些项目喜欢把整个页面的渲染结果存成快照，几千行。每次 review 都是折磨，最后大家都无脑 accept 了。</p>
<p>建议拆小一点，每个快照保持在几十行内。</p>
<h3 data-id="heading-9">JavaScript 生态</h3>
<p>JS 这边常用的是 Jest 的 snapshot 功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">test</span>(<span class="hljs-string">'Button 渲染正确'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> tree = renderer.<span class="hljs-title function_">create</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"点击"</span> /&gt;</span></span>).<span class="hljs-title function_">toJSON</span>();
  <span class="hljs-title function_">expect</span>(tree).<span class="hljs-title function_">toMatchSnapshot</span>();
});
</code></pre>
<p>更新快照：</p>
<pre><code class="hljs language-bash" lang="bash">jest --updateSnapshot
<span class="hljs-comment"># 或者</span>
jest -u
</code></pre>
<p>原理一样，就是 API 不同。</p>
<h3 data-id="heading-10">小结</h3>
<p>Snapshot 测试本质上是把"写期望值"这件事自动化了。对于输出复杂的场景（CLI、格式化器、UI 组件），能省不少事。</p>
<p>但记住：更新快照前要看一眼 diff，确认变化是你想要的。不然就跟我一样，rebase 完无脑 push，CI 一样会挂。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能提升5倍！Python列表和元组的底层原理揭秘]]></title>    <link>https://juejin.cn/post/7586971532699516937</link>    <guid>https://juejin.cn/post/7586971532699516937</guid>    <pubDate>2025-12-24T04:09:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586971532699516937" data-draft-id="7586954475657052206" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能提升5倍！Python列表和元组的底层原理揭秘"/> <meta itemprop="keywords" content="Python,后端"/> <meta itemprop="datePublished" content="2025-12-24T04:09:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王二哥的技术笔记"/> <meta itemprop="url" content="https://juejin.cn/user/3358381525700410"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能提升5倍！Python列表和元组的底层原理揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3358381525700410/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王二哥的技术笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T04:09:28.000Z" title="Wed Dec 24 2025 04:09:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">性能提升5倍！Python列表和元组的底层原理揭秘</h2>
<p>这是一份有基础、有深度的 Python 必备秘籍。</p>
<h3 data-id="heading-1">基础</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">################## 初始化</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"hello"</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span>l
[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'hello'</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span>t = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"hello"</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>t
(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'hello'</span>)

<span class="hljs-comment">################## 负数索引</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l[-<span class="hljs-number">1</span>]
<span class="hljs-string">'hello'</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>t[-<span class="hljs-number">1</span>]
<span class="hljs-string">'hello'</span>

<span class="hljs-comment">################## 切片</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>t[<span class="hljs-number">1</span>:]
(<span class="hljs-number">2</span>, <span class="hljs-string">'hello'</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>l[<span class="hljs-number">1</span>:]
[<span class="hljs-number">2</span>, <span class="hljs-string">'hello'</span>]

<span class="hljs-comment">################## 嵌套</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l = [[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-string">"hello"</span>]]
<span class="hljs-meta">&gt;&gt;&gt; </span>l
[[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-string">'hello'</span>]]
<span class="hljs-meta">&gt;&gt;&gt; </span>t = ((<span class="hljs-number">1</span>,<span class="hljs-number">2</span>), (<span class="hljs-string">"hello"</span>))
<span class="hljs-meta">&gt;&gt;&gt; </span>t
((<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-string">'hello'</span>)

<span class="hljs-comment">################## 转换</span>
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">tuple</span>(l)
([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], [<span class="hljs-string">'hello'</span>])
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">list</span>(t)
[(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-string">'hello'</span>]

<span class="hljs-comment">################## 列表内置函数</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l = [<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span>l.count(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 统计 3 的个数</span>
<span class="hljs-number">2</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.index(<span class="hljs-number">7</span>)  <span class="hljs-comment"># 查看 7 所在的索引位置</span>
<span class="hljs-number">3</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.reverse()  <span class="hljs-comment"># 原地倒置</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l
[<span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span>l.sort()  <span class="hljs-comment"># 原地排序</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l
[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]

<span class="hljs-comment">################## 元组内置函数</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>t = (<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>t.count(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 统计 3 的个数</span>
<span class="hljs-number">2</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>t.index(<span class="hljs-number">7</span>)  <span class="hljs-comment"># 查看 7 所在的索引位置</span>
<span class="hljs-number">3</span>
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">list</span>(<span class="hljs-built_in">reversed</span>(t))  <span class="hljs-comment"># 原地倒置，并以列表形式输出</span>
[<span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">sorted</span>(t)  <span class="hljs-comment"># 排序输出</span>
[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]
</code></pre>
<h3 data-id="heading-2">操作差异</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 列表是动态的，长度大小不固定，可以随意增、删、改</span>
<span class="hljs-comment"># 元组是静态的，长度大小固定，无法增、删、改</span>

<span class="hljs-meta">&gt;&gt;&gt; </span>l[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l
[<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'hello'</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span>t[<span class="hljs-number">0</span>] = <span class="hljs-number">3</span>
Traceback (most recent call last):
  File <span class="hljs-string">"&lt;stdin&gt;"</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;
TypeError: <span class="hljs-string">'tuple'</span> <span class="hljs-built_in">object</span> does <span class="hljs-keyword">not</span> support item assignment
</code></pre>
<h3 data-id="heading-3">存储差异</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">################## 初始化</span>
l = []
l.__sizeof__()
<span class="hljs-number">40</span>

<span class="hljs-meta">&gt;&gt;&gt; </span>l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]  <span class="hljs-comment"># 一个 int 占 8 个字节</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">64</span>

<span class="hljs-comment">################## 空间分配</span>
<span class="hljs-comment"># 结论：</span>
<span class="hljs-comment"># Python 每次分配空间时，都会额外多分配一些。</span>
<span class="hljs-comment"># 这样，可以减少每次增加/删减操作时，空间分配的开销，保证了操作的高效性。</span>
<span class="hljs-comment"># 存储空间，比元组要大</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l = []	
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">40</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.append(<span class="hljs-number">1</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">72</span>	<span class="hljs-comment"># 列表每次分配 4 个元素的空间 (72-40)/8=4</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.append(<span class="hljs-number">2</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">72</span>	<span class="hljs-comment"># 可以存得下</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.append(<span class="hljs-number">3</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">72</span>	<span class="hljs-comment"># 同上</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.append(<span class="hljs-number">4</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">72</span>	<span class="hljs-comment"># 同上</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>l.append(<span class="hljs-number">5</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>l.__sizeof__()
<span class="hljs-number">104</span>	<span class="hljs-comment"># 列表空间不足，扩容。再给分配 4 个元素的空间</span>

<span class="hljs-comment">################## 元组</span>
<span class="hljs-comment"># 结论：</span>
<span class="hljs-comment"># 大小固定，元素不可变。故存储空间固定不变</span>
<span class="hljs-comment"># 存储空间比列表小。</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>t = (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
<span class="hljs-meta">&gt;&gt;&gt; </span>t.__sizeof__()
<span class="hljs-number">48</span>
</code></pre>
<p><strong>为什么元组的存储空间比列表少 16 字节？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 列表是动态的，它需要指针，来指向对应的元素
<span class="hljs-bullet">2.</span> 列表是可变的，所以，需要额外存储已经分配的长度大小（8 字节），这样才能实时追踪列表空间的使用情况，及时分配额外空间。
</code></pre>
<h3 data-id="heading-4">性能差异</h3>
<p><strong>结论：元组的性能略优于列表。</strong></p>
<h5 data-id="heading-5">1、初始化时间对比</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 结论：元组比列表快约 5 倍</span>
$ python3.7 -m timeit <span class="hljs-string">"x=(1,2,3,4,5)"</span>
20000000 loops, best of 5: 16.9 nsec per loop
$ python3.7 -m timeit <span class="hljs-string">"x=[1,2,3,4,5]"</span>
5000000 loops, best of 5: 82.3 nsec per loop
</code></pre>
<h5 data-id="heading-6">2、索引操作对比</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 结论：元组比列表快约 2.5 倍</span>
$ python3.7 -m timeit <span class="hljs-string">"x=(1,2,3,4,5)"</span> <span class="hljs-string">"y=x[3]"</span>
5000000 loops, best of 5: 45.6 nsec per loop
$ python3.7 -m timeit <span class="hljs-string">"x=[1,2,3,4,5]"</span> <span class="hljs-string">"y=x[3]"</span>
2000000 loops, best of 5: 113 nsec per loop
</code></pre>
<h3 data-id="heading-7">列表 和 元组 的内部实现</h3>
<h5 data-id="heading-8">1、列表的底层结构</h5>
<ul>
<li>列表本质是<strong>过度分配的数组（over-allocate array）</strong>。</li>
</ul>

<pre><code class="hljs language-markdown" lang="markdown">over-allocate 是什么？

就是当底层数组容量满了，而需要扩充的时候，python 依据规则会扩充多个位置出来。
即，扩充容量的时候，会多分配一些存储空间。
另外，当列表存储的元素在变少时，python 也会及时收缩底层的数组，避免造成内存浪费。

优点：提高了执行效率。

查看内存变化：
<span class="hljs-bullet">	1.</span> <span class="hljs-strong">__sizeof__</span>()
<span class="hljs-bullet">	2.</span> sys.getsizeof()
</code></pre>
<ul>
<li><strong>核心结构</strong></li>
</ul>

<pre><code class="hljs language-scss" lang="scss">ob_item：指针列表，存储元素的内存地址。
allocated：预分配的总空间（通常大于实际元素数量 <span class="hljs-built_in">len</span>(list) ）。
ob_size：实际元素数量（即 <span class="hljs-built_in">len</span>(list) 的值 ）。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ea936e3fb334da78f61f673e9103f1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5LqM5ZOl55qE5oqA5pyv56yU6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767154167&amp;x-signature=DbpLo98WxoCb0s019WO%2BTAa%2FkiE%3D" alt="img" loading="lazy"/></p>
<ul>
<li><strong>特点</strong></li>
</ul>

<pre><code class="hljs language-scss" lang="scss">预分配空间（allocated）&gt;= <span class="hljs-built_in">len</span>(list) = 实际元素数（ob_size）

扩容时，按如下规律，申请更大空间：
<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">25</span>, <span class="hljs-number">35</span>, <span class="hljs-number">46</span>, <span class="hljs-number">58</span>, <span class="hljs-number">72</span>, <span class="hljs-number">88</span>, ...
</code></pre>
<ul>
<li>Python 3.7 的 list 源码地址</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby">listobject.h：

<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/python</span><span class="hljs-regexp">/cpython/blob</span><span class="hljs-regexp">/949fe976d5c62ae63ed505ecf729f815d0baccfc/</span><span class="hljs-title class_">Include</span>/listobject.h<span class="hljs-comment">#L23</span>

listobject.<span class="hljs-symbol">c:</span> 

<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/python</span><span class="hljs-regexp">/cpython/blob</span><span class="hljs-regexp">/3d75bd15ac82575967db367c517d7e6e703a6de3/</span><span class="hljs-title class_">Objects</span>/listobject.c<span class="hljs-comment">#L33</span>
</code></pre>
<h5 data-id="heading-9">2、元组的底层优化</h5>
<ul>
<li>
<p>元组本质也是数组，但空间大小<strong>固定</strong>，且做了特殊优化：</p>
<ol>
<li>大小 ≤20 时，复用内部 <code>free list</code> 缓存。创建相同元组时直接从缓存取，提升效率。</li>
<li>相比列表，元组不可变，无需考虑扩容，内存更紧凑。</li>
</ol>
</li>
<li>
<p>Python 3.7 的 tuple 源码地址</p>
</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby">tupleobject.h： 

<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/python</span><span class="hljs-regexp">/cpython/blob</span><span class="hljs-regexp">/3d75bd15ac82575967db367c517d7e6e703a6de3/</span><span class="hljs-title class_">Include</span>/tupleobject.h<span class="hljs-comment">#L25</span>

tupleobject.c：

<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/python</span><span class="hljs-regexp">/cpython/blob</span><span class="hljs-regexp">/3d75bd15ac82575967db367c517d7e6e703a6de3/</span><span class="hljs-title class_">Objects</span>/tupleobject.c<span class="hljs-comment">#L16</span>
</code></pre>
<h3 data-id="heading-10">使用场景</h3>
<pre><code class="hljs">如果，存储数据和数量不变，用元组。
如果，存储的数据或数量是可变的，用列表
</code></pre>
<h3 data-id="heading-11">总结</h3>
<ol>
<li><strong>列表是动态的，长度可变，可以随意增加、删减、更新元素。列表的存储空间略大于元组，性能图逊于元组</strong>。</li>
<li><strong>元组是静态的，长度大小固定，不可以对元素进行增加、删减、更新操作。元组相对于列表更加轻量级，性能稍优。</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SQLAlchemy + Pytest：如何优雅地关闭异步数据库连接池]]></title>    <link>https://juejin.cn/post/7586971532699533321</link>    <guid>https://juejin.cn/post/7586971532699533321</guid>    <pubDate>2025-12-24T04:26:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586971532699533321" data-draft-id="7586941468874014754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SQLAlchemy + Pytest：如何优雅地关闭异步数据库连接池"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-12-24T04:26:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WarrenWu"/> <meta itemprop="url" content="https://juejin.cn/user/369887009324631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SQLAlchemy + Pytest：如何优雅地关闭异步数据库连接池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/369887009324631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WarrenWu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T04:26:51.000Z" title="Wed Dec 24 2025 04:26:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SQLAlchemy + Pytest：如何优雅地关闭异步数据库连接池</h2>
<p>在开发高性能异步 Python 服务时，<code>SQLAlchemy</code> 配合 <code>aiomysql</code> 是标准的“黄金搭档”。然而，许多开发者在编写单元测试时，都会遇到一个令人困惑的报错：<code>RuntimeError: Event loop is closed</code>。</p>
<p>即便你在代码中显式调用了 <code>await engine.dispose()</code>，这个错误依然会像幽灵一样在测试结束时蹦出来。本文将深入剖析其底层成因，并提供一套工业级的解决方案。</p>
<h3 data-id="heading-1">1. 现象：明明关闭了引擎，为何报错？</h3>
<p>在 Pytest 中使用 <code>session</code> 作用域的异步引擎时，典型的报错堆栈如下：</p>
<pre><code class="hljs language-lua" lang="lua">Exception ignored <span class="hljs-keyword">in</span>: &lt;<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Connection.__del__</span> <span class="hljs-title">at</span> 0<span class="hljs-title">x112ee7600</span>&gt;
<span class="hljs-title">Traceback</span> <span class="hljs-params">(most recent call last)</span></span>:
  File <span class="hljs-string">".../aiomysql/connection.py"</span>, line <span class="hljs-number">1131</span>, <span class="hljs-keyword">in</span> __del__
    <span class="hljs-built_in">self</span>.<span class="hljs-built_in">close</span>()
  File <span class="hljs-string">".../aiomysql/connection.py"</span>, line <span class="hljs-number">339</span>, <span class="hljs-keyword">in</span> <span class="hljs-built_in">close</span>
    <span class="hljs-built_in">self</span>._writer.transport.<span class="hljs-built_in">close</span>()
RuntimeError: Event loop is closed
</code></pre>
<p><strong>困惑点：</strong> 我们的测试逻辑已经运行完毕，数据库清理也做了，为什么 Python 解释器仍试图在事件循环关闭后去操作连接？</p>
<h3 data-id="heading-2">2. 深度剖析：对象生命周期的“时间差”</h3>
<p>问题的根源在于：<strong>逻辑上的“引擎销毁”不等于内存中的“对象回收”。</strong></p>
<h4 data-id="heading-3">2.1 析构函数（<strong>del</strong>）的滞后性</h4>
<p>当你调用 <code>engine.dispose()</code> 时，SQLAlchemy 只是宣布连接池关闭。但底层 <code>aiomysql</code> 的 <code>Connection</code> 对象可能仍被某些存活的引用（如未被清理的变量、循环引用或 GC 延迟）持有。</p>
<p>当 Pytest 结束 <code>event_loop</code> fixture 并调用 <code>loop.close()</code> 后，Python 的垃圾回收器（GC）才开始真正清理这些不再使用的连接对象。此时，对象的 <code>__del__</code> 方法被触发，它试图通过 <code>loop</code> 来关闭底层的 Socket 传输层——但此时 <code>loop</code> 已经死了。</p>
<h4 data-id="heading-4">2.2 循环引用的陷阱</h4>
<p>异步框架中，对象之间常形成复杂的引用环。Python 依靠分代回收机制处理循环引用，这使得资源释放的时机变得更加不可预测。</p>
<h3 data-id="heading-5">3. 终极解决方案：构建“异步清理屏障”</h3>
<p>要彻底解决此问题，我们必须在 <code>event_loop</code> 关闭之前，强行同步对象回收过程。我们采用 <strong>“同步辅助函数 + 显式 GC + 任务周转”</strong> 的组合拳。</p>
<h4 data-id="heading-6">核心实现：<code>tests/conftest.py</code></h4>
<p>Python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> gc
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> pytest

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_cleanup_database_engines</span>(<span class="hljs-params">loop</span>):
    <span class="hljs-string">"""工业级异步引擎清理方案"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 1. 显式关闭异步引擎（清空连接池）</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">dispose_engines</span>():
            <span class="hljs-comment"># 替换为你的引擎对象</span>
            <span class="hljs-keyword">await</span> your_async_engine.dispose()
        
        loop.run_until_complete(dispose_engines())

        <span class="hljs-comment"># 2. 强制垃圾回收</span>
        <span class="hljs-comment"># 第一次清理普通对象，第二次清理因第一轮释放而暴露的循环引用</span>
        gc.collect()
        gc.collect()

        <span class="hljs-comment"># 3. 关键：给事件循环最后一次“呼吸”的机会</span>
        <span class="hljs-comment"># gc 触发的 __del__ 可能会向 loop 提交最后的清理 task</span>
        <span class="hljs-comment"># sleep(0) 能让 loop 切换上下文并执行这些就绪任务</span>
        loop.run_until_complete(asyncio.sleep(<span class="hljs-number">0</span>))
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Cleanup Error: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-meta">@pytest.fixture(<span class="hljs-params">scope=<span class="hljs-string">'session'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">event_loop</span>():
    policy = asyncio.get_event_loop_policy()
    loop = policy.new_event_loop()
    <span class="hljs-keyword">yield</span> loop

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 清理所有待处理任务</span>
        pending = asyncio.all_tasks(loop)
        <span class="hljs-keyword">if</span> pending:
            loop.run_until_complete(asyncio.gather(*pending, return_exceptions=<span class="hljs-literal">True</span>))
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 在 loop.close() 前执行清理屏障</span>
        _cleanup_database_engines(loop)
        loop.close()
</code></pre>
<h3 data-id="heading-7">4. 方案的三大硬核知识点</h3>
<h4 data-id="heading-8">A. 为什么不用 Async Fixture 直接清理？</h4>
<p>在 Pytest 中，<code>session</code> 级别的 <code>async fixture</code> 清理时机往往早于 <code>event_loop</code> 的销毁，但也可能因为插件机制导致清理顺序异常。通过在 <code>event_loop</code> 的 <code>finally</code> 块中硬编码清理逻辑，我们建立了一个<strong>显式的保护屏障</strong>，确保顺序永远是：<code>Dispose -&gt; GC -&gt; Final Tasks -&gt; Loop Close</code>。</p>
<h4 data-id="heading-9">B. 两次 <code>gc.collect()</code> 的必要性</h4>
<p>Python GC 的分代机制决定了单次回收可能无法处理跨代的循环引用。两次调用能确保那些由数据库连接池引用的、位于更高代内存中的对象被彻底标记并释放，从而触发它们的析构函数。</p>
<h4 data-id="heading-10">C. <code>asyncio.sleep(0)</code> 的妙用</h4>
<p>这行代码看似无意义，实则是异步编程中的“洗手液”。<code>gc.collect()</code> 触发的 <code>__del__</code> 可能会产生新的微任务（Micro-tasks）到 <code>loop</code> 的就绪队列中。<code>sleep(0)</code> 强制 <code>loop</code> 进行一次调度，把这些最后的“垃圾”处理掉，防止它们在 <code>loop.close()</code> 之后炸裂。</p>
<h3 data-id="heading-11">5. 总结</h3>
<p>处理异步数据库连接时，我们要敬畏内存。<strong>逻辑关闭（Dispose）不代表物理释放（GC）。</strong> 通过在测试框架的最底层注入清理逻辑，强制同步 GC 状态，并利用 <code>sleep(0)</code> 消化残余任务，我们可以获得一个干净、无报错的单元测试环境，同时也让系统在生产环境的优雅停机（Graceful Shutdown）变得更加可靠。</p>
<hr/>
<p><strong>如果你在项目中遇到了类似的异步资源泄漏问题，欢迎在评论区分享你的调试经历！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1：前端 CI/CD 实战 （ 第一篇： 云服务器环境搭建）]]></title>    <link>https://juejin.cn/post/7586971532699435017</link>    <guid>https://juejin.cn/post/7586971532699435017</guid>    <pubDate>2025-12-24T03:46:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586971532699435017" data-draft-id="7586306813726523402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1：前端 CI/CD 实战 （ 第一篇： 云服务器环境搭建）"/> <meta itemprop="keywords" content="前端,运维,自动化运维"/> <meta itemprop="datePublished" content="2025-12-24T03:46:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="饼饼饼"/> <meta itemprop="url" content="https://juejin.cn/user/8451822992855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1：前端 CI/CD 实战 （ 第一篇： 云服务器环境搭建）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451822992855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    饼饼饼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T03:46:32.000Z" title="Wed Dec 24 2025 03:46:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一篇： 云服务器环境搭建</h2>
<h3 data-id="heading-1">前言</h3>
<p>本系列带你从零开始搭建前端 CI/CD。本篇我们将聚焦<strong>云服务器环境搭建</strong>，从云服务器准备、Docker 安装，到镜像获取和容器运行，让你在最短时间内在云端拥有可运行的 Docker 环境，为后续 GitLab、Runner 和前端 CI/CD 的搭建打下基础。</p>
<h3 data-id="heading-2">服务器配置</h3>
<p>本次使用的云服务器配置如下：</p>
<ul>
<li><strong>CPU</strong>：4 核</li>
<li><strong>内存</strong>：4 GB</li>
<li><strong>硬盘</strong>：40 GB SSD 云硬盘</li>
<li><strong>操作系统</strong>：Ubuntu Server 22.04 LTS（64 位）</li>
</ul>
<p>这个配置对于个人学习和中小型前端项目来说完全足够，也能支撑后续 GitLab + Runner 的运行需求，当时我购买这台云主机的价格是 79 元一年性价比极很高，👉 相关产品可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcurl.qcloud.com%2FoSSjKaYH" target="_blank" title="https://curl.qcloud.com/oSSjKaYH" ref="nofollow noopener noreferrer">腾讯云云服务器</a>。</p>
<h3 data-id="heading-3">安装 Vim</h3>
<p>推荐用 vim 编辑文件后面的内容我将会用 vim 在命令行中处理文件。</p>
<p>安装 vim:</p>
<pre><code class="hljs">apt install -y vim
</code></pre>
<p>查看 vim 版本：</p>
<pre><code class="hljs language-css" lang="css">vim <span class="hljs-attr">--version</span>
</code></pre>
<h3 data-id="heading-4">创建项目目录结构</h3>
<p>为了后续 <strong>GitLab</strong>、<strong>Runner</strong>、<strong>Nginx</strong> 部署更清晰，先在服务器上规划一个合理的目录结构。</p>
<p>我们要创建的目录结构如下</p>
<pre><code class="hljs language-text" lang="text">/apps
├── infra/          # 基础设施
│   ├── gitlab
│   └── gitlab-runner
├── deploy/         # 项目部署
│   ├── dev
│   ├── test
│   ├── prod
│   └── uat
└── nginx-conf/     # nginx 配置

</code></pre>
<p>创建目录:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /apps/infra
<span class="hljs-built_in">mkdir</span> -p /apps/deploy/{dev,<span class="hljs-built_in">test</span>,prod,uat}
<span class="hljs-built_in">mkdir</span> -p /apps/nginx-conf
</code></pre>
<blockquote>
<p>本文中演示的目录结构，是在同一台服务器上同时部署多个环境（dev / test / prod）项目的示例场景，仅用于学习和演示。真实生产环境中，通常会将开发、测试、生产环境进行物理或逻辑隔离（如不同服务器、不同集群或不同云资源），以保证稳定性和安全性。</p>
</blockquote>
<h3 data-id="heading-5">安装 docker:</h3>
<p>我用的是 <strong>root</strong> 用户命所以命令前省去了 <strong>sudo</strong>。</p>
<p>下载 <strong>docker</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//get.docker.com -o install-docker.sh</span>
</code></pre>
<p>执行安装脚本:</p>
<pre><code class="hljs">sh install-docker.sh
</code></pre>
<p>等待安装完成。</p>
<p>下载好 docker 之后查看 docker 版本：</p>
<pre><code class="hljs language-css" lang="css">docker <span class="hljs-attr">--version</span>
</code></pre>
<h3 data-id="heading-6">配置镜像站</h3>
<blockquote>
<p>配置 Docker 镜像站可以显著提升镜像拉取速度，减少网络波动带来的失败，保证构建和部署过程更稳定可靠。</p>
</blockquote>
<p>打开文件</p>
<pre><code class="hljs language-bash" lang="bash">vim /etc/docker/daemon.json
</code></pre>
<p>粘贴下列内容，最后按ESC，输入 :wq! 保存退出。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"https://docker.m.daocloud.io"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://docker.1panel.live"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://hub.rat.dev"</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>重启 docker</p>
<pre><code class="hljs">service docker restart
</code></pre>
<h3 data-id="heading-7">测试 Docker 服务</h3>
<h4 data-id="heading-8">运行 hello-world 容器</h4>
<p>用一个最简单的 Demo 确认 Docker 能正常运行。</p>
<pre><code class="hljs language-arduino" lang="arduino">docker run hello-world
</code></pre>
<p>如果看到类似输出：</p>
<pre><code class="hljs language-csharp" lang="csharp">Hello <span class="hljs-keyword">from</span> Docker!
</code></pre>
<p>恭喜你：</p>
<ul>
<li>Docker 服务正常</li>
<li>镜像可以被正常拉取且容器能够正确运行</li>
</ul>
<h4 data-id="heading-9">运行一个 Nginx 容器</h4>
<p>接下来运行一个 Nginx 容器。</p>
<p>拉取 <strong>nginx</strong> 镜像：</p>
<pre><code class="hljs">docker pull nginx
</code></pre>
<p>你会看到 Docker 正在下载镜像：</p>
<pre><code class="hljs language-text" lang="text">Using default tag: latest
latest: Pulling from library/nginx
1733a4cd5954: Downloading
</code></pre>
<p>查看镜像：</p>
<pre><code class="hljs">docker images
</code></pre>
<p>你会看到：</p>
<pre><code class="hljs language-text" lang="text">IMAGE             ID             DISK USAGE   CONTENT SIZE   EXTRA
nginx:latest      fb01117203ff        228MB         62.6MB
</code></pre>
<p>接下来执行</p>
<pre><code class="hljs language-css" lang="css">docker run -d \
  <span class="hljs-attr">--name</span> nginx-demo \
  -<span class="hljs-selector-tag">p</span> <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \
  nginx
</code></pre>
<p>参数说明：</p>
<ul>
<li>-d：后台运行</li>
<li>--name：容器名称</li>
<li>-p 80:80：端口映射</li>
<li>nginx：官方镜像</li>
</ul>
<p>用命令验证容器是否运行</p>
<pre><code class="hljs">docker ps
</code></pre>
<p>如果能看到 nginx-demo，说明容器已成功启动。</p>
<p>此时在浏览器中访问：</p>
<p>http://&lt;你的服务器 IP&gt;</p>
<p>如果看到 <strong>Welcome to nginx!</strong> 页面，说明 Docker 环境完全可用。</p>
<p>如果碰到了</p>
<pre><code class="hljs language-text" lang="text">docker: Error response from daemon: 
failed to set up container networking: driver failed programming external connectivity on endpoint nginx-demo (3a624ed5e2eb8135b6be13): 
Bind for :::80 failed: port is already allocated
</code></pre>
<p>说明你服务器的 80 端口已经被占用了（ps:一般默认80 端口会被服务器 ssh 登录占用）</p>
<p>删除容器</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">rm</span> nginx-demo
</code></pre>
<p>换个 8989端口：</p>
<pre><code class="hljs language-css" lang="css">docker run -d \
  <span class="hljs-attr">--name</span> nginx-demo \
  -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8989</span>:<span class="hljs-number">80</span> \
  nginx
</code></pre>
<p>查看容器状态：</p>
<pre><code class="hljs">docker ps
</code></pre>
<p>可以看到 nginx-demo 出现在列表中。</p>
<h3 data-id="heading-10">本篇小结</h3>
<p>到这里，我们已经完成了 CI/CD 的第一步准备工作：</p>
<ul>
<li>云服务器基础环境已就绪</li>
<li>vim 安装完成，可以正常编辑配置文件</li>
<li>docker 镜像站配置完成</li>
<li>docker 成功安装并运行</li>
<li>成功运行了第一个 Nginx 容器</li>
</ul>
<p>从下一篇开始，我们将基于这套环境，<strong>部署 GitLab，并逐步引入 GitLab Runner</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零上手 LangChain：用 JavaScript 打造强大 AI 应用的全流程指南]]></title>    <link>https://juejin.cn/post/7586941468874063906</link>    <guid>https://juejin.cn/post/7586941468874063906</guid>    <pubDate>2025-12-24T04:16:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586941468874063906" data-draft-id="7586893663075467274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零上手 LangChain：用 JavaScript 打造强大 AI 应用的全流程指南"/> <meta itemprop="keywords" content="JavaScript,LangChain,LLM"/> <meta itemprop="datePublished" content="2025-12-24T04:16:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会js"/> <meta itemprop="url" content="https://juejin.cn/user/2517262684662348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零上手 LangChain：用 JavaScript 打造强大 AI 应用的全流程指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517262684662348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会js
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T04:16:18.000Z" title="Wed Dec 24 2025 04:16:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零上手 LangChain：用 JavaScript 打造强大 AI 应用的全流程指南</h2>
<p>2022 年 10 月，一个名为 LangChain 的开源框架悄然诞生，比 ChatGPT 正式发布早了一个月。它不是一个聊天机器人，而是一个<strong>AI 应用开发框架</strong>，专门帮助开发者把大语言模型（LLM）从“黑盒”变成可工程化、可组合的生产力工具。到 2025 年底，LangChain 已演进到 <strong>1.x 稳定版</strong>，成为构建 Agent、RAG、复杂工作流的事实标准，GitHub Star 数遥遥领先。</p>
<p>LangChain 的核心理念可以用一个词概括：<strong>Chain（链）</strong>。就像乐高积木一样，把 Prompt、Model、内存、工具、解析器等模块“链”起来，形成一个自动执行的工作流。这让 AI 应用从简单的“一问一答”跃升到多步骤推理、工具调用、长期记忆的智能代理。</p>
<p>本文基于实际代码示例（DeepSeek 模型 + JavaScript），带你从最基础的 Prompt 模板开始，一步步构建复杂链条。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa05e64f781042588b8709fafa24ce5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767154578&amp;x-signature=M5d3r33MgeNN1Rt20yAa7TwrFJs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-1">一、环境配置</h4>
<h5 data-id="heading-2">5 分钟快速上手环境配置</h5>
<p>LangChain 的 JavaScript 版（也叫 LangChain.js）完全基于现代 ESM（ES Modules），所以我们要用 Node.js 18+。</p>
<ol>
<li>
<p>创建项目文件夹并初始化<br/>
mkdir langchain-demo &amp;&amp; cd langchain-demo <strong>npm init -y</strong></p>
</li>
<li>
<p>修改 package.json 支持 ESM（关键！）<br/>
把这一行改成： <strong>"type": "module"</strong></p>
</li>
<li>
<p>安装核心依赖</p>
</li>
</ol>
<p>npm i @langchain/core @langchain/deepseek dotenv</p>
<ol start="4">
<li>创建 .env 文件存放 API Key（强烈推荐）</li>
</ol>
<p>去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fapi-keys" target="_blank" title="https://platform.deepseek.com/api-keys" ref="nofollow noopener noreferrer">platform.deepseek.com/api-keys</a></p>
<p>申请 DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</p>
<p><strong>易错提醒</strong>：</p>
<ul>
<li>忘记加 <strong>"type": "module"</strong> 会报错 Cannot use import statement outside a module。</li>
<li>不要直接把 API Key 写死在代码里，用 dotenv 读取更安全。</li>
</ul>
<p>(dotenv 的作用就是把 .env 文件里的环境变量读取并加载到 Node.js 的全局对象 process.env 上)</p>
<ul>
<li>DeepSeek 的包是 @langchain/deepseek，不是 langchain-deepseek。</li>
</ul>
<h4 data-id="heading-3">二、为什么需要 LangChain？LLM 的“黑盒”如何被打开</h4>
<p>大语言模型（如 DeepSeek、GPT、Claude）强大但原始：你给一个字符串，它吐出一个字符串。想做点复杂的事？比如：</p>
<ul>
<li>动态插入变量（Prompt 工程）</li>
<li>多次调用模型完成多步任务</li>
<li>记住对话历史</li>
<li>调用外部工具（搜索、计算器、数据库）</li>
</ul>
<p>直接用 API 就能实现，但代码会迅速变成“意大利面”：嵌套回调、重复的错误处理、模型切换麻烦……</p>
<p>LangChain 就是那个“工程化工具箱”：</p>
<ul>
<li><strong>统一接口</strong>：不管用 DeepSeek、OpenAI 还是 Anthropic，一个抽象层搞定切换。</li>
<li><strong>模块化组件</strong>：PromptTemplate、ChatModel、OutputParser、Memory 等。</li>
<li><strong>可组合性</strong>：用 <code>pipe()</code> 或 <code>RunnableSequence</code> 把组件串成链，数据自动流动。</li>
<li><strong>生产级特性</strong>：流式输出、异步、调试（LangSmith）、监控。</li>
</ul>
<p>用个比喻：原生 LLM API 像一辆法拉利引擎——动力强劲但裸露；LangChain 像整车工厂，把引擎装进车身，加方向盘、刹车、导航，让你安心上路。</p>
<h4 data-id="heading-4">三、LangChain 的适配器（Provider）</h4>
<p>在 LangChain 中，安装了 dotenv 后，你可以<strong>不用显式传 apiKey 和 baseURL</strong>，这正是 LangChain 的适配器（Provider）设计哲学的核心魅力之一：<strong>统一接口 + 智能默认配置。</strong></p>
<p>我们可以直接这样创建大模型实例：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>
  <span class="hljs-comment">// 不用写 apiKey 和 baseURL！</span>
});
</code></pre>
<p>而之前的老方式（不靠 dotenv）必须这样写：</p>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatDeepSeek</span>({
  apiKey: <span class="hljs-string">'sk-xxx'</span>,
  baseURL: <span class="hljs-string">'https://api.deepseek.com'</span>,  <span class="hljs-comment">// 某些老版本需要手动指定</span>
  model: <span class="hljs-string">'deepseek-reasoner'</span>
});
</code></pre>
<h5 data-id="heading-5">背后的核心机制是什么？</h5>
<p>这是 LangChain（尤其是 JS 版）在 <strong>ChatModel 适配器内部</strong> 实现的<strong>智能配置优先级链</strong>，大致逻辑如下（优先级从高到低）：</p>
<ol>
<li>
<p><strong>构造函数显式传入的参数</strong>（最高优先级） 你手动传了 apiKey 或 baseURL，就无条件用你的。</p>
</li>
<li>
<p><strong>环境变量（process.env）中的标准名称</strong>（这就是 dotenv 发挥作用的地方） LangChain 的每个 Provider（DeepSeek、OpenAI、Anthropic 等）都定义了<strong>约定的环境变量名</strong>：</p>
<ul>
<li>DeepSeek：DEEPSEEK_API_KEY</li>
<li>OpenAI：OPENAI_API_KEY（+ OPENAI_BASE_URL 可选）</li>
<li>Anthropic：ANTHROPIC_API_KEY</li>
<li>Groq：GROQ_API_KEY</li>
<li>...</li>
</ul>
<p>当你<strong>没有显式传 apiKey</strong> 时，ChatDeepSeek 构造函数内部会自动去 process.env.DEEPSEEK_API_KEY 里取！</p>
</li>
<li>
<p><strong>baseURL 的智能默认</strong> 每个 Provider 包内部都硬编码了官方 API 地址：</p>
<ul>
<li>@langchain/deepseek 默认 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.deepseek.com" target="_blank" title="https://api.deepseek.com" ref="nofollow noopener noreferrer">api.deepseek.com</a></li>
<li>@langchain/openai 默认 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.openai.com%2Fv1" target="_blank" title="https://api.openai.com/v1" ref="nofollow noopener noreferrer">api.openai.com/v1</a> 所以你根本不用手动指定，除非你要用代理或自定义 endpoint。</li>
</ul>
</li>
<li>
<p><strong>如果以上都没找到 → 抛错</strong> 防止你默默跑出“密钥为空”的诡异行为。</p>
</li>
</ol>
<h5 data-id="heading-6">统一接口的魅力</h5>
<p>LangChain 的统一接口，就是不管你用哪个大模型提供商（DeepSeek、OpenAI、Anthropic、Groq、Claude、Gemini 等），<strong>创建和调用模型的方式、链的构建方式、输入输出格式都完全一致</strong>，你只需要换个 import 包和环境变量，就能无缝切换模型。</p>
<h5 data-id="heading-7">具体体现在哪些统一接口？</h5>
<ol>
<li>
<p><strong>模型创建与调用接口统一</strong>（最常用）</p>
<p>所有聊天模型都继承自同一个基类 ChatModel，提供相同的构造函数和方法：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// DeepSeek</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span> });

<span class="hljs-comment">// OpenAI（切换只需改这一行 + .env）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/openai'</span>;
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span> });

<span class="hljs-comment">// Anthropic</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatAnthropic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/anthropic'</span>;
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatAnthropic</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'claude-3-5-sonnet'</span> });

<span class="hljs-comment">// 调用方式完全一样！</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(messages);  <span class="hljs-comment">// 所有模型都支持 .invoke()</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);
</code></pre>
<p>输出也统一为 AIMessage 对象，内容在 .content。</p>
</li>
<li>
<p><strong>Chain 构建接口统一</strong>（pipe 和 Runnable）</p>
<p>不管底层模型是谁，链的写法一模一样：</p>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> chain = prompt.<span class="hljs-built_in">pipe</span>(model).<span class="hljs-built_in">pipe</span>(parser);  <span class="hljs-comment">// 所有模型都支持 pipe</span>
await chain.<span class="hljs-built_in">invoke</span>({ topic: <span class="hljs-string">'闭包'</span> });
</code></pre>
</li>
<li>
<p><strong>输入输出格式统一</strong></p>
<ul>
<li>输入：通常是 { key: value } 对象或消息数组</li>
<li>输出：标准化消息对象（HumanMessage、AIMessage、SystemMessage）</li>
<li>解析器：StringOutputParser、JsonOutputParser 等通用</li>
</ul>
</li>
<li>
<p><strong>环境变量命名统一</strong></p>
<p>每个提供商都有约定的环境变量名：</p>
<ul>
<li>DEEPSEEK_API_KEY</li>
<li>OPENAI_API_KEY</li>
<li>ANTHROPIC_API_KEY</li>
<li>GROQ_API_KEY</li>
</ul>
<p>配合 dotenv，一换就灵。</p>
</li>
</ol>
<h4 data-id="heading-8">为什么这个统一接口这么重要？</h4>






























<table><thead><tr><th>场景</th><th>没统一接口（原始方式）</th><th>有统一接口（LangChain）</th></tr></thead><tbody><tr><td>切换模型</td><td>大改代码、改 URL、改参数格式</td><td>改一行 import + .env 的 key</td></tr><tr><td>团队协作</td><td>每个人用不同模型，代码不兼容</td><td>统一标准，代码可复用</td></tr><tr><td>成本优化</td><td>想用更便宜的模型？重写适配代码</td><td>直接换 Gpt 或 DeepSeek，零成本切换</td></tr><tr><td>生产稳定性</td><td>某个提供商挂了，应用瘫痪</td><td>快速切换备用模型，故障切换秒级完成</td></tr></tbody></table>
<h4 data-id="heading-9">实际案例：一键从 DeepSeek 切换到 GPT-4o</h4>
<p>Bash</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env 原版</span>
<span class="hljs-attr">DEEPSEEK_API_KEY</span>=sk-xxx

<span class="hljs-comment"># 改成</span>
<span class="hljs-attr">OPENAI_API_KEY</span>=sk-xxx
</code></pre>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 代码只改一行</span>
<span class="hljs-comment">// import { ChatDeepSeek } from '@langchain/deepseek';</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/openai'</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({  <span class="hljs-comment">// 构造函数参数基本一致</span>
  <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4o'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>
});

<span class="hljs-comment">// 下面所有链、invoke 代码完全不动！</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(model);
</code></pre>
<p>运行结果：行为几乎一致，但可能更聪明或更贵😂</p>
<h4 data-id="heading-10">总结</h4>
<p>LangChain 的“统一接口”本质就是：</p>
<p><strong>一套标准化的抽象层（基类 + 协议 + 约定），让所有大模型提供商看起来“长得一样”，用起来“感觉一样”。</strong></p>
<p>这才是 LangChain 能爆火的真正原因——它不只是工具，更是<strong>AI 应用的工程化基础设施</strong>。</p>
<h4 data-id="heading-11">四、入门：PromptTemplate + Model 的第一次“链”</h4>
<p>我们从最简单的例子开始。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">PromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">`
你是一个{role},
请用不超过{limit}字回答以下问题:
{question}
`</span>);

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span>,  <span class="hljs-comment">// 2025 年 DeepSeek 的旗舰推理模型，擅长长链思考</span>
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>
});

<span class="hljs-keyword">const</span> promptStr = <span class="hljs-keyword">await</span> prompt.<span class="hljs-title function_">format</span>({
  <span class="hljs-attr">role</span>: <span class="hljs-string">'前端面试官'</span>,
  <span class="hljs-attr">limit</span>: <span class="hljs-string">'50'</span>,
  <span class="hljs-attr">question</span>: <span class="hljs-string">'什么是闭包'</span>
});

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(promptStr);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);
</code></pre>
<p><strong>底层逻辑</strong>：<br/>
PromptTemplate 就是一个带占位符的字符串工厂。<code>format()</code> 方法把变量注入，生成完整提示词。然后直接扔给模型调用。</p>
<p><strong>扩展知识点</strong>：</p>
<ul>
<li><strong>为什么用模板？</strong> Prompt 工程是 AI 应用的核心，模板让你复用、动态调整，避免硬编码。</li>
<li><strong>DeepSeek-reasoner 模型亮点</strong>：2025 年版本内置 Chain of Thought（CoT），在回答前会自动生成推理过程（reasoning_content），准确率大幅提升，尤其适合复杂问题。</li>
</ul>
<p><strong>易错提醒</strong>：</p>
<ul>
<li>别忘了 <code>await prompt.format()</code> —— 它是异步的（虽然简单模板看起来同步）。</li>
<li>temperature=0 时输出最确定，适合知识问答；0.7~1.0 更有创意。</li>
</ul>
<h4 data-id="heading-12">五、真正意义上的 Chain：pipe() 与 RunnableSequence</h4>
<p>单纯的 Prompt + Model 还不是链。真正的链是用 <code>pipe()</code> 连接。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">PromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">`
你是一个前端专家，用一句话解释：{topic}
`</span>);

<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(model);  <span class="hljs-comment">// 这里诞生了链！</span>

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: <span class="hljs-string">'闭包'</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);
</code></pre>
<p><strong>底层逻辑揭秘</strong>：<br/>
<code>pipe()</code> 返回一个 <strong>RunnableSequence</strong> 对象（可运行序列）。内部结构是：</p>
<ul>
<li>first：PromptTemplate</li>
<li>middle：[]（空）</li>
<li>last：ChatModel</li>
</ul>
<p>输入 <code>{topic: '闭包'}</code> → Prompt 格式化 → 完整提示词 → Model 调用 → AIMessage 输出。</p>
<p><strong>扩展：RunnableSequence 的 first/middle/last</strong></p>
<ul>
<li>first：链的起点</li>
<li>middle：中间组件列表（可多个）</li>
<li>last：终点</li>
<li>数据像水流一样，从 first 流到 last，自动传递。</li>
</ul>
<p>当你用 prompt.pipe(model) 或 RunnableSequence.from([...]) 创建链时，LangChain 内部会自动把组件组织成以下结构：</p>
<ul>
<li><strong>first</strong>：永远是链的<strong>第一个组件</strong>（通常是 PromptTemplate 或 RunnablePassthrough 等）</li>
<li><strong>middle</strong>：<strong>从第二个到倒数第二个</strong>的所有组件，形成一个数组（可以是空 []，也可以有多个）</li>
<li><strong>last</strong>：永远是链的<strong>最后一个组件</strong>（通常是 ChatModel、OutputParser 或自定义 RunnableLambda）</li>
</ul>
<p><strong>数据流向</strong>：输入 → first → middle[0] → middle[1] → ... → middle[n] → last → 输出 每一步的输出自动成为下一步的输入。</p>
<p><strong>举例说明</strong>（假设用 pipe 连了 5 个组件）：</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss">const chain = prompt          <span class="hljs-comment">// 1. PromptTemplate</span>
  <span class="hljs-selector-class">.pipe</span>(model)               <span class="hljs-comment">// 2. ChatModel</span>
  <span class="hljs-selector-class">.pipe</span>(parser)              <span class="hljs-comment">// 3. StringOutputParser</span>
  <span class="hljs-selector-class">.pipe</span>(runnableLambda)      <span class="hljs-comment">// 4. 自定义函数</span>
  <span class="hljs-selector-class">.pipe</span>(finalFormatter);     <span class="hljs-comment">// 5. 最终格式化</span>

<span class="hljs-comment">// 内部结构相当于：</span>
{
  first: prompt,
  middle: [model, parser, runnableLambda],
  last: finalFormatter
}
</code></pre>
<p><strong>易错提醒</strong>：</p>
<ul>
<li>
<p>chain.invoke() 的输入必须匹配第一个组件的输入变量（这里是 {topic}）。</p>
<p><strong>核心规则：</strong> chain.invoke(input) 的 input 只看链的第一个组件（即 first）需要什么变量。</p>
</li>
<li>
<p>输出是 AIMessage 对象，内容在 <code>.content</code> 或 <code>.text</code>（不同模型略有差异）。</p>
</li>
</ul>
<h4 data-id="heading-13">六、进阶：多步链 + 自动数据传递</h4>
<p>手动链：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> explainChain.<span class="hljs-title function_">invoke</span>({<span class="hljs-attr">topic</span>: input.<span class="hljs-property">topic</span>}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">text</span>),
  <span class="hljs-function">(<span class="hljs-params">explanation</span>) =&gt;</span> summaryChain.<span class="hljs-title function_">invoke</span>({explanation}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-string">`知识点：<span class="hljs-subst">${explanation}</span> 总结：<span class="hljs-subst">${res.text}</span>`</span>)
]);
</code></pre>
<p>它能跑，但只是“伪链”——所有 invoke 和拼接都是你手动写的，LangChain 只负责笨笨地传返回值。</p>
<p><strong>纯线性自动链</strong>（真链，但丢失中间值）：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StringOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/output_parsers"</span>;

<span class="hljs-keyword">const</span> explainChain = explainPrompt.<span class="hljs-title function_">pipe</span>(model);          <span class="hljs-comment">// Prompt + Model</span>
<span class="hljs-keyword">const</span> summaryChain = summaryPrompt.<span class="hljs-title function_">pipe</span>(model);          <span class="hljs-comment">// Prompt + Model</span>

<span class="hljs-comment">// 真正的自动链：全都是 Runnable 对象</span>
<span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  explainChain.<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>()),  <span class="hljs-comment">// 第1步：输出详细解释字符串</span>
  summaryChain.<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>()),  <span class="hljs-comment">// 第2步：自动收到上一步字符串，输出总结字符串</span>
]);

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> fullChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: <span class="hljs-string">"闭包"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);  
<span class="hljs-comment">// 输出：只有“三点总结”的字符串，详细解释被“吃掉”了</span>
</code></pre>
<p><strong>为什么是真自动？</strong></p>
<ul>
<li>没有一行 invoke()</li>
<li>没有 .then()</li>
<li>数据完全由 LangChain 自动传递</li>
<li>支持流式、批处理、LangSmith 追踪</li>
</ul>
<p><strong>缺点</strong>：最终只能拿到总结，详细解释丢失了（线性链的特性）。</p>
<p><strong>终极优雅版：对象语法 + RunnablePassthrough</strong>（LCEL 精髓）：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnablePassthrough</span>, <span class="hljs-title class_">StringOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/runnables'</span>;

<span class="hljs-keyword">const</span> explainChain = explainPrompt.<span class="hljs-title function_">pipe</span>(model).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> summaryChain = summaryPrompt.<span class="hljs-title function_">pipe</span>(model).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  { <span class="hljs-attr">explanation</span>: explainChain },  <span class="hljs-comment">// 生成详细解释</span>

  {
    <span class="hljs-attr">explanation</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnablePassthrough</span>(),  <span class="hljs-comment">// 保留不吃掉</span>
    <span class="hljs-attr">summary</span>: summaryChain,
  },

  <span class="hljs-function">(<span class="hljs-params">{ explanation, summary }</span>) =&gt;</span> <span class="hljs-string">`
【前端知识点详解】
<span class="hljs-subst">${explanation}</span>

【三点核心总结】
<span class="hljs-subst">${summary}</span>
  `</span>.<span class="hljs-title function_">trim</span>()
]);

<span class="hljs-keyword">await</span> fullChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: <span class="hljs-string">'闭包'</span> });
</code></pre>
<p><strong>底层逻辑：</strong> new RunnablePassthrough() 的作用是把上一步的整个输出（返回值）原封不动地传递到下一步，但它通常和对象语法结合使用，才发挥最大威力。</p>
<p><strong>执行流程详解</strong>：</p>
<ol>
<li>
<p>第1步输出一个对象：{ explanation: "详细文本..." }</p>
</li>
<li>
<p>第2步收到这个对象：</p>
<ul>
<li>explanation: new RunnablePassthrough() → 直接返回收到的 explanation 值（不修改）</li>
<li>summary: summaryChain → 用收到的 explanation 作为输入，生成总结</li>
</ul>
</li>
<li>
<p>第2步最终输出：{ explanation: "详细文本...", summary: "三点总结..." }</p>
</li>
<li>
<p>第3步拿到完整对象，自由组合</p>
</li>
</ol>
<p><strong>所以：RunnablePassthrough 就是那个“搬运工”——它确保上一步的 explanation 不会被 summaryChain 的输出覆盖，而是继续向下传递。</strong></p>
<h4 data-id="heading-14">常见用法总结</h4>






























<table><thead><tr><th>用法场景</th><th>代码示例</th><th>作用</th></tr></thead><tbody><tr><td>保留原始输入</td><td>{ topic: new RunnablePassthrough() }</td><td>把 invoke 的 {topic} 一直传下去</td></tr><tr><td>保留中间结果</td><td>{ explanation: new RunnablePassthrough() }</td><td>防止被下一步吃掉</td></tr><tr><td>合并多个并行结果</td><td>和其他字段一起用</td><td>构建复杂对象</td></tr><tr><td>跳过处理直接传递</td><td>单独用（少见）</td><td>输入 = 输出</td></tr></tbody></table>
<h4 data-id="heading-15">核心点：对象语法，占位保留</h4>
<h5 data-id="heading-16">先说“对象语法”是什么</h5>
<p>对象语法就是：在 RunnableSequence.from() 里，每一步不是放单个 Runnable，而是放一个<strong>对象</strong> { key: runnable }。</p>
<p>JavaScript</p>
<pre><code class="hljs language-csharp" lang="csharp">RunnableSequence.<span class="hljs-keyword">from</span>([
  { explanation: explainChain },     <span class="hljs-comment">// 第一步：对象</span>
  { 
    explanation: ...,               <span class="hljs-comment">// 第二步：还是对象</span>
    summary: ...
  }
])
</code></pre>
<p>每一步的输入/输出不再是单个字符串，而是<strong>一个对象</strong>（带有多个字段）。</p>
<p>这让数据流从“一维流水线”变成了“多维结构化对象流”，你可以随意添加、保留、合并字段。</p>
<h4 data-id="heading-17">再来说“占位保留”是什么意思</h4>
<p>在对象语法里，如果你不做任何处理，后一步的输出会<strong>完全覆盖</strong>前一步的输出（只保留新生成的字段）。</p>
<p>比如：</p>
<p>JavaScript</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">RunnableSequence.from([</span>
  { <span class="hljs-attr">explanation:</span> <span class="hljs-string">explainChain</span> }<span class="hljs-string">,</span>  <span class="hljs-string">//</span> <span class="hljs-string">输出</span> { <span class="hljs-attr">explanation:</span> <span class="hljs-string">"详细文本"</span> }

  { <span class="hljs-attr">summary:</span> <span class="hljs-string">summaryChain</span> }       <span class="hljs-string">//</span> <span class="hljs-string">输入</span> { <span class="hljs-attr">explanation:</span> <span class="hljs-string">...</span> }<span class="hljs-string">，但只输出</span> { <span class="hljs-attr">summary:</span> <span class="hljs-string">"三点总结"</span> }
<span class="hljs-string">])</span>
<span class="hljs-string">//</span> <span class="hljs-string">最终结果：只有</span> { <span class="hljs-attr">summary:</span> <span class="hljs-string">...</span> }<span class="hljs-string">，explanation</span> <span class="hljs-string">没了！</span>
</code></pre>
<p><strong>explanation 被“吃掉”了</strong>——这就是线性思维的遗毒。</p>
<p><strong>“占位保留”</strong> 的意思就是：<strong>我要在这一步故意“占个位置”，把上一步的某个字段原样保留下来，不让它被吃掉</strong>。</p>
<p>工具就是 new RunnablePassthrough()。</p>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino">{
  explanation: <span class="hljs-keyword">new</span> <span class="hljs-built_in">RunnablePassthrough</span>(),  <span class="hljs-comment">// ← 这里！占位保留</span>
  summary: summaryChain
}
</code></pre>
<p>它相当于在对象里说：“explanation 这个字段，你别动，上一步是什么我就输出什么（占位传下去）”。</p>
<p><strong>优势</strong>：完全自动、保留所有中间值、支持并行/分支、LangSmith 追踪完美。</p>
<h4 data-id="heading-18">八、LangChain 的未来与最佳实践</h4>
<p>到 2025 年，LangChain 已与 LangGraph（状态图工作流）深度融合，支持更复杂的 Agent。记住：</p>
<ul>
<li>用 LCEL（LangChain Expression Language）即 <code>|</code> 或 <code>pipe()</code> 构建链，最简洁。</li>
<li>生产环境加 LangSmith 调试、追踪。</li>
<li>模型切换只需改一行：从 DeepSeek 换 OpenAI 零成本。</li>
</ul>
<p>LangChain 不是终点，而是起点。它让你把 LLM 从玩具变成生产力武器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙应用开发之通过AVPlayer如何实现音乐播放、暂停、音量设置？]]></title>    <link>https://juejin.cn/post/7586934804291928098</link>    <guid>https://juejin.cn/post/7586934804291928098</guid>    <pubDate>2025-12-24T04:41:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586934804291928098" data-draft-id="7586941997195788340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙应用开发之通过AVPlayer如何实现音乐播放、暂停、音量设置？"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-24T04:41:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙应用开发之通过AVPlayer如何实现音乐播放、暂停、音量设置？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T04:41:47.000Z" title="Wed Dec 24 2025 04:41:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">效果展示</h2>
<h2 data-id="heading-1"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0290caa80d3f4715bd66a59a4e47eaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767156158&amp;x-signature=P1%2BM4BLR9T1wo8x9YZqmGwN0ybQ%3D" alt="" loading="lazy"/></h2>
<h2 data-id="heading-2">实现思路</h2>
<ul>
<li>传统操作音乐播放：传统写项目(淘宝京东)就是一个个html文件，里面写Javascript代码（切记不允许全部看代码，看大步骤）</li>
</ul>
<p>1 获取音乐对象 player</p>
<p>2 调用api 播放play、暂定pause等等</p>
<pre><code class="hljs language-ini" lang="ini">&lt;audio
  controls
  <span class="hljs-attr">src</span>=<span class="hljs-string">"http://tmp00002.zhaodashen.cn/mp3/chenyixun_000z2oXY18Hsli.m4a"</span>
&gt;&lt;/audio&gt;

&lt;button <span class="hljs-attr">id</span>=<span class="hljs-string">"playerBtn"</span>&gt;播放&lt;/button&gt;
&lt;button <span class="hljs-attr">id</span>=<span class="hljs-string">"pausereBtn"</span>&gt;暂停&lt;/button&gt;
&lt;script&gt;
  // 1 获取实例
  const <span class="hljs-attr">player</span> = document.querySelector(<span class="hljs-string">"audio"</span>)<span class="hljs-comment">;</span>
  //   console.log("player::: ", player)<span class="hljs-comment">;</span>
  // 2 调用api播放
  <span class="hljs-attr">playerBtn.onclick</span> = () =&gt; {
    player.play()<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  <span class="hljs-attr">pausereBtn.onclick</span> = () =&gt; {
    player.pause()<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<ul>
<li>鸿蒙操作音乐播放语法</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {media} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>


<span class="hljs-comment">// ✅ 1. 创建音乐播放器对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">player</span>:media.<span class="hljs-property">AVPlayer</span>  = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVPlayer</span>()

<span class="hljs-comment">// ✅ 2. 侦听播放状态（监控设置地址）</span>
player.<span class="hljs-title function_">on</span>(<span class="hljs-string">'stateChange'</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-keyword">switch</span>(state) {
        <span class="hljs-comment">// 初始化状态</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'initialized'</span>:
            player.<span class="hljs-title function_">prepare</span>() <span class="hljs-comment">// 准备就绪态</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-comment">// 准备就绪态</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">'prepared'</span>:
            player.<span class="hljs-title function_">play</span>() <span class="hljs-comment">// 播放</span>
            <span class="hljs-keyword">break</span>;
    }
})
player.<span class="hljs-title function_">on</span>(<span class="hljs-string">'durationUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">duration</span>) =&gt;</span> {}) <span class="hljs-comment">// 歌曲时长</span>
player.<span class="hljs-title function_">on</span>(<span class="hljs-string">'timeUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {}) 				<span class="hljs-comment">// 播放时长</span>
player.<span class="hljs-title function_">on</span>(<span class="hljs-string">'volumeChange'</span>, <span class="hljs-function">() =&gt;</span> {})  <span class="hljs-comment">// 音量</span>


<span class="hljs-comment">// ✅ 3. 调用API控制状态</span>

<span class="hljs-comment">// - 播放地址</span>
player.<span class="hljs-property">url</span> = 播放源地址

<span class="hljs-comment">// - 切换播放地址</span>
<span class="hljs-keyword">await</span> player.<span class="hljs-title function_">reset</span>()
player.<span class="hljs-property">url</span> = 播放源地址

<span class="hljs-comment">// - 暂停</span>
player.<span class="hljs-title function_">pause</span>()

<span class="hljs-comment">// - 音量</span>
player.<span class="hljs-title function_">setVolume</span>(<span class="hljs-number">0</span>~<span class="hljs-number">1</span>范围)

<span class="hljs-comment">// - 循环播放</span>
player.<span class="hljs-property">loop</span> = 布尔

<span class="hljs-comment">// - 播放速率</span>
player.<span class="hljs-title function_">setSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_0_75_X</span>)
player.<span class="hljs-title function_">setSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_00_X</span>)
player.<span class="hljs-title function_">setSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_25_X</span>)
player.<span class="hljs-title function_">setSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_1_75_X</span>)
player.<span class="hljs-title function_">setSpeed</span>(media.<span class="hljs-property">PlaybackSpeed</span>.<span class="hljs-property">SPEED_FORWARD_2_00_X</span>)

<span class="hljs-comment">// - 本地播放</span>
<span class="hljs-comment">//这里的音频资源是放在rawfile文件夹中的.mp3文件，读者自己设置其他文件资源。</span>
<span class="hljs-comment">//给播放器设置播放资源，上图有参考资料，使用的是fsSrc资源，不是网络资源-&gt;。</span>
<span class="hljs-keyword">const</span> fd = <span class="hljs-title function_">getContext</span>().<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFdSync</span>(name)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">avplayer</span>.<span class="hljs-property">fdSrc</span> = { <span class="hljs-attr">fd</span>: fd.<span class="hljs-property">fd</span>, <span class="hljs-attr">offset</span>: fd.<span class="hljs-property">offset</span>, <span class="hljs-attr">length</span>: fd.<span class="hljs-property">length</span> }
</code></pre>
<h2 data-id="heading-3">完整代码</h2>
<pre><code class="hljs language-ini" lang="ini">import {media} from '@kit.MediaKit'


export class DateUtil {
  static m2s(ms:number) {
    // 分钟 = parseInt(总毫秒/1000/60) 得到分钟然后不够补0    这个parseInt是为了去掉小数
    const <span class="hljs-attr">m</span> = parseInt(String(ms/<span class="hljs-number">1000</span>/<span class="hljs-number">60</span>)).toString().padStart(<span class="hljs-number">2</span>,<span class="hljs-string">'0'</span>)<span class="hljs-comment">;</span>
    // 秒数 = parseInt(总毫秒/100得到秒 - 分占用的秒)   最终秒数  不够补0
    // const <span class="hljs-attr">s</span> = parseInt(String(ms/<span class="hljs-number">1000</span> - parseInt(m)*<span class="hljs-number">60</span>)).toString().padStart(<span class="hljs-number">2</span>,<span class="hljs-string">'0'</span>)
    const <span class="hljs-attr">s</span> = parseInt(String(ms/<span class="hljs-number">1000</span>%<span class="hljs-number">60</span>)).toString().padStart(<span class="hljs-number">2</span>,<span class="hljs-string">'0'</span>)
    return `${m}:${s}`
  }
}


@Entry
@Component
struct Index {

  // "<span class="hljs-section">[al:认了吧]</span>"
  // "<span class="hljs-section">[00:00.00]</span>爱情转移 - 陈奕迅 (Eason Chan)"
  // "<span class="hljs-section">[00:05.73]</span>词：林夕"
  @State currentLrc:<span class="hljs-attr">string</span> = <span class="hljs-string">''</span>
  private lrc: string<span class="hljs-section">[]</span> = "<span class="hljs-section">[ti:爱情转移 (《爱情呼叫转移》电影主题曲|《富士山下》国语版)]</span>\n<span class="hljs-section">[ar:陈奕迅]</span>\n<span class="hljs-section">[al:认了吧]</span>\n<span class="hljs-section">[by:]</span>\n<span class="hljs-section">[offset:0]</span>\n<span class="hljs-section">[00:00.00]</span>爱情转移 - 陈奕迅 (Eason Chan)\n<span class="hljs-section">[00:05.73]</span>词：林夕\n<span class="hljs-section">[00:11.47]</span>曲：泽日生\n<span class="hljs-section">[00:17.21]</span>编曲：陈珀/C.Y.Kong\n<span class="hljs-section">[00:22.95]</span>徘徊过多少橱窗\n<span class="hljs-section">[00:25.29]</span>住过多少旅馆\n<span class="hljs-section">[00:27.54]</span>才会觉得分离也并不冤枉\n<span class="hljs-section">[00:31.89]</span>感情是用来浏览\n<span class="hljs-section">[00:34.15]</span>还是用来珍藏\n<span class="hljs-section">[00:36.55]</span>好让日子天天都过得难忘\n<span class="hljs-section">[00:40.98]</span>熬过了多久患难\n<span class="hljs-section">[00:43.37]</span>湿了多少眼眶\n<span class="hljs-section">[00:45.63]</span>才能知道伤感是爱的遗产\n<span class="hljs-section">[00:50.22]</span>流浪几张双人床\n<span class="hljs-section">[00:52.63]</span>换过几次信仰\n<span class="hljs-section">[00:54.77]</span>才让戒指义无反顾的交换\n<span class="hljs-section">[00:59.28]</span>把一个人的温暖\n<span class="hljs-section">[01:01.70]</span>转移到另一个的胸膛\n<span class="hljs-section">[01:04.74]</span>让上次犯的错反省出梦想\n<span class="hljs-section">[01:08.48]</span>\n<span class="hljs-section">[01:08.98]</span>每个人都是这样\n<span class="hljs-section">[01:11.27]</span>享受过提心吊胆\n<span class="hljs-section">[01:13.74]</span>才拒绝做爱情待罪的羔羊\n<span class="hljs-section">[01:18.21]</span>回忆是抓不到的月光握紧就变黑暗\n<span class="hljs-section">[01:22.84]</span>等虚假的背影消失于晴朗\n<span class="hljs-section">[01:26.67]</span>\n<span class="hljs-section">[01:27.34]</span>阳光在身上流转\n<span class="hljs-section">[01:29.53]</span>等所有业障被原谅\n<span class="hljs-section">[01:32.62]</span>\n<span class="hljs-section">[01:34.94]</span>爱情不停站\n<span class="hljs-section">[01:36.78]</span>想开往地老天荒\n<span class="hljs-section">[01:39.34]</span>需要多勇敢\n<span class="hljs-section">[01:41.35]</span>\n<span class="hljs-section">[01:43.58]</span>烛光照亮了晚餐\n<span class="hljs-section">[01:45.95]</span>照不出个答案\n<span class="hljs-section">[01:48.20]</span>恋爱不是温馨的请客吃饭\n<span class="hljs-section">[01:52.18]</span>\n<span class="hljs-section">[01:52.69]</span>床单上铺满花瓣\n<span class="hljs-section">[01:55.11]</span>拥抱让它成长\n<span class="hljs-section">[01:57.33]</span>太拥挤就开到了别的土壤\n<span class="hljs-section">[02:01.79]</span>感情需要人接班\n<span class="hljs-section">[02:04.22]</span>接近换来期望\n<span class="hljs-section">[02:06.51]</span>期望带来失望的恶性循环\n<span class="hljs-section">[02:10.96]</span>短暂的总是浪漫\n<span class="hljs-section">[02:13.31]</span>漫长总会不满\n<span class="hljs-section">[02:15.57]</span>烧完美好青春换一个老伴\n<span class="hljs-section">[02:19.59]</span>\n<span class="hljs-section">[02:20.12]</span>把一个人的温暖\n<span class="hljs-section">[02:22.45]</span>转移到另一个的胸膛\n<span class="hljs-section">[02:25.28]</span>让上次犯的错反省出梦想\n<span class="hljs-section">[02:29.14]</span>\n<span class="hljs-section">[02:29.86]</span>每个人都是这样\n<span class="hljs-section">[02:32.03]</span>享受过提心吊胆\n<span class="hljs-section">[02:34.42]</span>才拒绝做爱情待罪的羔羊\n<span class="hljs-section">[02:39.01]</span>回忆是抓不到的月光握紧就变黑暗\n<span class="hljs-section">[02:43.54]</span>等虚假的背影消失于晴朗\n<span class="hljs-section">[02:47.43]</span>\n<span class="hljs-section">[02:48.08]</span>阳光在身上流转\n<span class="hljs-section">[02:50.38]</span>等所有业障被原谅\n<span class="hljs-section">[02:53.37]</span>\n<span class="hljs-section">[02:54.86]</span>爱情不停站\n<span class="hljs-section">[02:56.83]</span>想开往地老天荒\n<span class="hljs-section">[02:59.79]</span>需要多勇敢\n<span class="hljs-section">[03:01.88]</span>\n<span class="hljs-section">[03:04.22]</span>把一个人的温暖\n<span class="hljs-section">[03:06.75]</span>转移到另一个的胸膛\n<span class="hljs-section">[03:09.60]</span>让上次犯的错反省出梦想\n<span class="hljs-section">[03:13.70]</span>\n<span class="hljs-section">[03:14.21]</span>每个人都是这样\n<span class="hljs-section">[03:16.61]</span>享受过提心吊胆\n<span class="hljs-section">[03:19.08]</span>才拒绝做爱情待罪的羔羊\n<span class="hljs-section">[03:23.82]</span>回忆是抓不到的月光握紧就变黑暗\n<span class="hljs-section">[03:28.46]</span>等虚假的背影消失于晴朗\n<span class="hljs-section">[03:32.54]</span>\n<span class="hljs-section">[03:33.11]</span>阳光在身上流转\n<span class="hljs-section">[03:35.47]</span>等所有业障被原谅\n<span class="hljs-section">[03:38.67]</span>\n<span class="hljs-section">[03:42.48]</span>爱情不停站\n<span class="hljs-section">[03:44.28]</span>想开往地老天荒\n<span class="hljs-section">[03:47.24]</span>\n<span class="hljs-section">[03:47.82]</span>需要多勇敢\n<span class="hljs-section">[03:50.26]</span>\n<span class="hljs-section">[03:53.07]</span>你不要失望\n<span class="hljs-section">[03:54.75]</span>荡气回肠是为了\n<span class="hljs-section">[03:57.64]</span>最美的平凡".split('\n')


  @State duration:<span class="hljs-attr">number</span> = <span class="hljs-number">0</span>
  @State currentTime:<span class="hljs-attr">number</span> = <span class="hljs-number">0</span>

  // private player: <span class="hljs-attr">media.AVPlayer</span> = {} as media.AVPlayer
  // private player: <span class="hljs-attr">media.AVPlayer</span> = {} as ESObject
  private player: <span class="hljs-attr">media.AVPlayer</span> = Object()


  async aboutToAppear() {
    // ✅ 1. 创建音乐播放器对象
    // const player:<span class="hljs-attr">media.AVPlayer</span>  = await media.createAVPlayer()  切记player放外面 后期要操作
    <span class="hljs-attr">this.player</span> = await media.createAVPlayer()

    // ✅ 2. 侦听播放状态
    this.player.on('stateChange', (state) =&gt; {
      switch(state) {
        // 初始化状态
        case 'initialized':
          console.log('11111 initialized')
          this.player.prepare() // 准备就绪态
          break<span class="hljs-comment">;</span>
        // 准备就绪态
        case 'prepared':
          console.log('2222 prepared')
          this.player.play() // 播放
          break<span class="hljs-comment">;</span>
      }
    })
    this.player.on('durationUpdate', (duration) =&gt; { // 歌曲时长
      console.log('歌曲时长：', duration)
      <span class="hljs-attr">this.duration</span> = duration
    })
    this.player.on('timeUpdate', (time) =&gt; {  // 播放时长
      console.log('播放时长：', time)
      <span class="hljs-attr">this.currentTime</span> = time

      for (let <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">; i&lt;this.lrc.length; i++) {</span>
        const <span class="hljs-attr">item</span> = this.lrc[i]
        const <span class="hljs-attr">m2s</span> = item.slice(<span class="hljs-number">1</span>,<span class="hljs-number">6</span>)  // <span class="hljs-string">'01:11'</span>
        if (DateUtil.m2s(time) === m2s) {
          <span class="hljs-attr">this.currentLrc</span> = item.slice(<span class="hljs-number">10</span>)
        }
      }
    })
    // this.player.on('volumeChange', () =&gt; {})  // 音量
  }
  build() {
    Column() {
      Text('hello music').fontSize(30)


      Button('打开界面（设置播放链接）').onClick(() =&gt; {
        <span class="hljs-attr">this.player.url</span> = <span class="hljs-string">'http://tmp00002.zhaodashen.cn/mp3/chenyixun_003u2qmP0Mp2pW.m4a'</span>
      }).margin({bottom:20})
      Button('播放').onClick(() =&gt; this.player.play()).margin({bottom:20})
      Button('暂停').onClick(() =&gt; this.player.pause()).margin({bottom:20})
      Button('换一首').onClick(async () =&gt; {
        await this.player.reset()
        <span class="hljs-attr">this.player.url</span> = <span class="hljs-string">'http://tmp00002.zhaodashen.cn/mp3/wangjingwenbupang_0017ZGNs0ISfYi.m4a'</span>
      }).margin({bottom:20})


      Text(`播放进度：${this.currentTime} 、 ${this.duration}`).fontSize(20)
      Text(DateUtil.m2s(this.currentTime)).fontSize(20)
      Slider({
        value: this.currentTime,
        min: 0,
        max: this.duration,
        style: SliderStyle.OutSet
      })
        .showTips(true)
        .onChange((value: number, mode: SliderChangeMode) =&gt; {
          console.info('value:' + value + 'mode:' + mode.toString())
          if (<span class="hljs-attr">mode</span> === <span class="hljs-number">2</span>) {
            this.player.seek(value)
          }

        })
      Text(DateUtil.m2s(this.duration)).fontSize(20).margin({bottom:50})

      Text('音量🔊').fontSize(20)
      Slider({
        value: 100,
        min: 0,
        max: 100,
        style: SliderStyle.OutSet
      })
        .showTips(true)
        .onChange((value: number, mode: SliderChangeMode) =&gt; {
          console.info('value:' + value + 'mode:' + mode.toString())
          // this.player.setVolume(0~1范围)
          this.player.setVolume(value/100)
        })


      Text(this.currentLrc).fontSize(30)
    }.padding(50)
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">鸿蒙开发者班级</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Hooks 详解：从 useState 到 useEffect，彻底掌握函数组件的“灵魂”]]></title>    <link>https://juejin.cn/post/7586954475657166894</link>    <guid>https://juejin.cn/post/7586954475657166894</guid>    <pubDate>2025-12-24T04:48:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586954475657166894" data-draft-id="7586540799221071913" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Hooks 详解：从 useState 到 useEffect，彻底掌握函数组件的“灵魂”"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-24T04:48:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Hooks 详解：从 useState 到 useEffect，彻底掌握函数组件的“灵魂”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T04:48:06.000Z" title="Wed Dec 24 2025 04:48:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代 React 开发中，<strong>函数组件 + Hooks</strong> 已经成为主流范式。它们不仅语法简洁、逻辑清晰，还赋予了函数组件过去只有类组件才拥有的能力：<strong>状态管理</strong>、<strong>副作用处理</strong>、<strong>生命周期控制</strong>等。本文将结合实际代码，以最真实、最完整的代码为蓝本，深入浅出地讲解 React 中两个最核心的 Hooks：<code>useState</code> 和 <code>useEffect</code>，并穿插解释一个至关重要的编程概念——<strong>纯函数</strong>。</p>
<p>我们将严格引用代码，确保技术细节的准确性；同时用生动的语言和清晰的结构，带你从“知道怎么写”走向“真正理解为什么这样写”。</p>
<hr/>
<h2 data-id="heading-1">第一部分：useState —— 函数组件的状态之源</h2>
<h3 data-id="heading-2">什么是状态（State）？</h3>
<p>在 React 中，<strong>状态（State）是驱动 UI 变化的数据</strong>。没有状态，组件就是静态的、死板的。而 <code>useState</code> 就是让函数组件拥有状态的魔法钩子（Hook）。</p>
<p>我们来看 <code>App2.jsx</code> 的完整内容：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态管理 响应式数据，类似vue的ref</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// num是一个状态变量，初始值是1，setNum是更新num的函数</span>
  <span class="hljs-comment">// 数据通过setNum更新，变成了一个数据值，值不是固定的，而是一种状态 State</span>
  <span class="hljs-comment">// hook useState 为程序带来了关键的响应式状态</span>
  <span class="hljs-comment">// 状态是变化的数据，组件的核心是状态</span>
  <span class="hljs-comment">// const [num, setNum] = useState(1)</span>

  <span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span>{
    <span class="hljs-comment">// 如果初始值需要经过复杂的计算得到，用函数来计算</span>
    <span class="hljs-comment">// 一定要是同步函数，不支持异步函数</span>
    <span class="hljs-comment">// 异步的可能不确定有没有执行完，状态一定是确定的，所以不能用异步函数来计算初始值</span>
    <span class="hljs-comment">// 纯函数是指相同输入始终返回相同输出，而且没有副作用的函数</span>
    <span class="hljs-keyword">const</span> num1 = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>
    <span class="hljs-keyword">const</span> num2 = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>
    <span class="hljs-keyword">return</span> num1 + num2
  })

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// &lt;div onClick={() =&gt; setNum(num + 1)}&gt;</span>
    <span class="hljs-comment">// 修改函数中可以直接传新的值，也可以传入一个函数</span>
    <span class="hljs-comment">// 这个函数的参数是上一个状态值，返回值是新的状态值</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setNum((prevNum) =&gt; {
      console.log(prevNum)
      return prevNum + 1
    })}&gt;
      {num}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>这段代码展示了 <code>useState</code> 的两种典型用法：</p>
<h4 data-id="heading-3">✅ 1. 直接传入初始值（简单场景）</h4>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[num, setNum]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">1</span>);
</code></pre>
<ul>
<li><code>num</code> 是当前状态值。</li>
<li><code>setNum</code> 是更新状态的函数。</li>
<li>当调用 <code>setNum(newValue)</code>，React 会重新渲染组件，并用新值替换旧值。</li>
</ul>
<h4 data-id="heading-4">✅ 2. 传入初始化函数（复杂计算场景）</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> [<span class="hljs-built_in">num</span>, setNum] = useState(() =&gt; {
  <span class="hljs-keyword">const</span> num1 = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> num2 = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>
  <span class="hljs-keyword">return</span> num1 + num2
})
</code></pre>
<blockquote>
<p><strong>关键点</strong>：这个函数<strong>只在组件首次渲染时执行一次</strong>，用于避免重复计算。</p>
</blockquote>
<p>但注意注释中的警告：</p>
<blockquote>
<p>“一定要是同步函数，不支持异步函数。异步的可能不确定有没有执行完，状态一定是确定的，所以不能用异步函数来计算初始值。”</p>
</blockquote>
<p>这是因为 React 需要在渲染前就确定状态的初始值。如果用 <code>async/await</code>，函数会返回一个 Promise，而不是实际的值，这会导致状态变成 <code>Promise {&lt;pending&gt;}</code>，显然不是我们想要的。</p>
<hr/>
<h3 data-id="heading-5">深入理解：为什么强调“纯函数”？</h3>
<p>在 <code>useState</code> 的初始化函数注释中，有一句非常重要的话：</p>
<blockquote>
<p>“纯函数是指相同输入始终返回相同输出，而且没有副作用的函数。”</p>
</blockquote>
<p>为了理解这句话，我们来看看 <code>1.js</code> 中的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// function add(nums) {</span>
<span class="hljs-comment">//   nums.push(3)</span>
<span class="hljs-comment">//   return nums.reduce((pre, cur) =&gt; pre + cur, 0)</span>
<span class="hljs-comment">// }</span>
<span class="hljs-comment">// 改成纯函数 此时add函数没有副作用，作为赋值来使用</span>
<span class="hljs-keyword">const</span> add = <span class="hljs-keyword">function</span>(<span class="hljs-params">x,y</span>) {
  <span class="hljs-keyword">return</span> x + y
}
<span class="hljs-keyword">const</span> nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
<span class="hljs-title function_">add</span>(nums) <span class="hljs-comment">// 副作用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nums.<span class="hljs-property">length</span>)
</code></pre>
<h4 data-id="heading-6">原始版本（有副作用）：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">nums</span>) {
  nums.<span class="hljs-title function_">push</span>(<span class="hljs-number">3</span>) <span class="hljs-comment">// 修改了外部数组！</span>
  <span class="hljs-keyword">return</span> nums.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">pre, cur</span>) =&gt;</span> pre + cur, <span class="hljs-number">0</span>)
}
</code></pre>
<ul>
<li>这个函数不仅返回结果，还<strong>改变了传入的 <code>nums</code> 数组</strong>。</li>
<li>这种行为称为 <strong>副作用（Side Effect）</strong> ：函数除了返回值，还影响了外部环境。</li>
</ul>
<h4 data-id="heading-7">改写后（纯函数）：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> add = <span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) {
  <span class="hljs-keyword">return</span> x + y
}
</code></pre>
<ul>
<li>给定相同的 <code>x</code> 和 <code>y</code>，永远返回相同的和。</li>
<li>不修改任何外部变量，不发起网络请求，不操作 DOM。</li>
<li>这就是<strong>纯函数</strong>。</li>
</ul>
<h4 data-id="heading-8">为什么 React 要求初始化函数是纯函数？</h4>
<p>因为 React 依赖<strong>可预测性</strong>。如果初始化函数有副作用（比如修改全局变量、调用 API、改变传入参数），那么：</p>
<ul>
<li>多次渲染可能导致不一致的状态。</li>
<li>在服务端渲染（SSR）或 React.StrictMode 下可能出现 bug。</li>
<li>调试变得极其困难。</li>
</ul>
<p>因此，<code>useState(() =&gt; {...})</code> 中的函数必须是<strong>纯函数</strong>：无副作用、确定性输出。</p>
<hr/>
<h3 data-id="heading-9">如何安全地更新状态？</h3>
<p>在 <code>App2.jsx</code> 的 JSX 中，我们看到：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div onClick={<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setNum</span>(<span class="hljs-function">(<span class="hljs-params">prevNum</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prevNum)
  <span class="hljs-keyword">return</span> prevNum + <span class="hljs-number">1</span>
})}&gt;
  {num}
&lt;/div&gt;
</code></pre>
<p>这里 <code>setNum</code> 接收的是一个<strong>函数</strong>，而非直接的值。这种写法称为 <strong>“函数式更新”</strong> 。</p>
<h4 data-id="heading-10">为什么推荐这样做？</h4>
<p>当状态更新依赖于前一个状态时（如计数器 +1），使用函数式更新可以避免竞态条件（race condition）。例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 危险写法（可能出错）</span>
<span class="hljs-built_in">setNum</span>(num + <span class="hljs-number">1</span>);
<span class="hljs-built_in">setNum</span>(num + <span class="hljs-number">1</span>); <span class="hljs-comment">// 两次都基于同一个旧值！</span>

<span class="hljs-comment">// 安全写法</span>
<span class="hljs-built_in">setNum</span>(prev =&gt; prev + <span class="hljs-number">1</span>);
<span class="hljs-built_in">setNum</span>(prev =&gt; prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// 每次都基于最新值</span>
</code></pre>
<p>React 会将 <code>prevNum</code> 作为上一次提交的状态传入，确保你总是基于最新状态进行计算。</p>
<hr/>
<h2 data-id="heading-11">第二部分：useEffect —— 副作用的总指挥</h2>
<p>如果说 <code>useState</code> 赋予组件“记忆”，那么 <code>useEffect</code> 就赋予组件“行动力”。</p>
<p>我们来看 <code>App.jsx</code> 的完整代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, <span class="hljs-comment">// 副作用</span>
         useState <span class="hljs-comment">// 响应式状态</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Demo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Demo'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queryData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-number">666</span>)
    }, <span class="hljs-number">2000</span>);
  });
  <span class="hljs-keyword">return</span> data;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'useEffect 挂载前执行'</span>)

  <span class="hljs-comment">// useEffect(() =&gt; {</span>
  <span class="hljs-comment">//   console.log('useEffect 挂载后执行')</span>
  <span class="hljs-comment">//   // 挂载后执行， vue生命周期onMounted</span>
  <span class="hljs-comment">//   queryData().then(data =&gt; {</span>
  <span class="hljs-comment">//     setNum(data);</span>
  <span class="hljs-comment">//   })</span>
  <span class="hljs-comment">// }, [])</span>

  <span class="hljs-comment">// 依赖项，只有依赖项变化时，才会执行副作用函数</span>
  <span class="hljs-comment">// }, [1,2,3]) // 依赖项为常数，只有在挂载时执行一次</span>
  <span class="hljs-comment">// }, [1,2,3,new Date()]) // 依赖项为对象，每次渲染时都执行</span>

  <span class="hljs-comment">// useEffect(() =&gt; {</span>
  <span class="hljs-comment">//   // 挂载时执行一次 onMounted</span>
  <span class="hljs-comment">//   // 更新时执行 onUpdated</span>
  <span class="hljs-comment">//   console.log(num, 'useEffect num 变化时执行')</span>
  <span class="hljs-comment">//   // num 变化时执行， vue生命周期onUpdated</span>
  <span class="hljs-comment">// }, [num])</span>

  <span class="hljs-comment">// useEffect(() =&gt; {</span>
  <span class="hljs-comment">//   console.log('如果依赖项为空数组，只有在挂载时执行一次')</span>
  <span class="hljs-comment">// }, [])</span>

  <span class="hljs-comment">// useEffect 定时器副作用</span>
  <span class="hljs-comment">// 内存泄漏 每次都在新建定时器，组件卸载时，定时器没有清除，会一直执行</span>
  <span class="hljs-comment">// 解决方法：在副作用函数中返回一个清除函数，组件卸载时，清除定时器</span>
  <span class="hljs-comment">// useEffect(() =&gt; {</span>
  <span class="hljs-comment">//   const timer = setInterval(() =&gt; {</span>
  <span class="hljs-comment">//     console.log('定时器副作用执行')</span>
  <span class="hljs-comment">//   }, 1000);</span>
  <span class="hljs-comment">//   // 重新执行effect之前，会先清除上一次的定时器</span>
  <span class="hljs-comment">//   // useEffect return 函数</span>
  <span class="hljs-comment">//   // 不清除上一次的定时器，会导致内存泄漏</span>
  <span class="hljs-comment">//   return () =&gt; {</span>
  <span class="hljs-comment">//     console.log('清除定时器')</span>
  <span class="hljs-comment">//     clearInterval(timer)</span>
  <span class="hljs-comment">//   }</span>
  <span class="hljs-comment">// }, [num])</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setNum(prevNum =&gt; prevNum + 1)}&gt;{num}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      {num % 2 === 0 &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Demo</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>这段代码通过大量注释，揭示了 <code>useEffect</code> 的三大核心用法。</p>
<hr/>
<h3 data-id="heading-12">场景一：模拟 <code>onMounted</code> —— 组件挂载时执行一次</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>('useEffect 挂载后执行')
  <span class="hljs-built_in">queryData</span>()<span class="hljs-selector-class">.then</span>(data =&gt; {
    setNum(data);
  })
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<ul>
<li>
<p><strong>依赖项为 <code>[]</code>（空数组）</strong> ：表示该 effect <strong>只在组件挂载后执行一次</strong>。</p>
</li>
<li>
<p>相当于 Vue 的 <code>onMounted</code> 或类组件的 <code>componentDidMount</code>。</p>
</li>
<li>
<p>常用于：</p>
<ul>
<li>发起 API 请求</li>
<li>订阅 WebSocket</li>
<li>初始化第三方库</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：虽然 <code>queryData</code> 是异步的，但 <code>useEffect</code> 本身不能是 <code>async</code> 函数（因为不能返回 Promise）。正确做法是在内部定义 async 函数并调用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">场景二：模拟 <code>onUpdated</code> / <code>watch</code> —— 依赖变化时执行</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>(num, 'useEffect num 变化时执行')
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<ul>
<li>
<p><strong>依赖项为 <code>[num]</code></strong> ：只要 <code>num</code> 的值发生变化（通过 <code>Object.is</code> 比较），effect 就会重新执行。</p>
</li>
<li>
<p>相当于 Vue 的 <code>watch(num)</code> 或类组件的 <code>componentDidUpdate</code>（配合条件判断）。</p>
</li>
<li>
<p>适用于：</p>
<ul>
<li>根据搜索关键词发起请求</li>
<li>监听路由变化</li>
<li>动态调整 UI 行为</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">❗ 依赖项陷阱</h4>
<ul>
<li><code>[1, 2, 3]</code>：全是常量 → 只执行一次（等同于 <code>[]</code>）。</li>
<li><code>[new Date()]</code>：每次渲染都生成新对象 → <strong>每次都会执行</strong>（通常不是你想要的！）。</li>
<li>忘记添加依赖 → 可能导致闭包捕获旧值（stale closure）。</li>
</ul>
<p>React 官方推荐使用 <strong>ESLint 插件</strong>（<code>eslint-plugin-react-hooks</code>）自动检测依赖项是否完整。</p>
<hr/>
<h3 data-id="heading-15">场景三：清理副作用 —— 防止内存泄漏的关键！</h3>
<p>这是 <code>useEffect</code> 最容易被忽视、却最重要的特性。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器副作用执行'</span>)
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清除定时器'</span>)
    <span class="hljs-built_in">clearInterval</span>(timer)
  }
}, [num])
</code></pre>
<h4 data-id="heading-16">为什么需要清理？</h4>
<ul>
<li>每次 <code>num</code> 变化，effect 会重新运行，创建<strong>新的定时器</strong>。</li>
<li>如果不清除旧的定时器，它们会继续在后台运行 → <strong>内存泄漏</strong>。</li>
<li>更严重的是，如果组件卸载了，但定时器还在尝试 <code>setState</code>，React 会报 warning：“Can’t perform a React state update on an unmounted component.”</li>
</ul>
<h4 data-id="heading-17">清理函数的作用时机：</h4>
<ol>
<li><strong>下次 effect 执行前</strong>：先清理上一次的副作用。</li>
<li><strong>组件卸载时</strong>：彻底清理所有资源。</li>
</ol>
<p>这就是注释所说的：</p>
<blockquote>
<p>“return函数 闭包，在下次执行effect前 或 组件卸载时执行”</p>
</blockquote>
<p>这个返回的函数就是一个<strong>清理函数（cleanup function）</strong> ，它捕获了当前 effect 创建的资源（如 <code>timer</code>），形成闭包，确保能正确释放。</p>
<hr/>
<h2 data-id="heading-18">第三部分：Hooks 的哲学 —— 纯函数 vs 副作用</h2>
<blockquote>
<p>“useEffect 副作用管理 effect副作用对立面是纯函数。对组件来说输入参数，输出jsx。”</p>
</blockquote>
<p>这句话揭示了 React 函数组件的设计哲学：</p>
<ul>
<li><strong>理想组件 = 纯函数</strong>：给定 props，总是返回相同的 JSX。</li>
<li><strong>现实需求 = 副作用</strong>：需要发请求、操作 DOM、订阅事件……</li>
<li><strong>Hooks = 桥梁</strong>：用 <code>useEffect</code> 把副作用“隔离”起来，保持组件主体的纯净。</li>
</ul>
<p>这正是为什么：</p>
<ul>
<li><code>useState</code> 初始化要用纯函数（保证状态可预测）。</li>
<li><code>useEffect</code> 专门处理副作用（不污染渲染逻辑）。</li>
</ul>
<hr/>
<h2 data-id="heading-19">总结：React Hooks 的核心思想</h2>




















<table><thead><tr><th>Hook</th><th>作用</th><th>关键规则</th></tr></thead><tbody><tr><td><code>useState</code></td><td>管理状态</td><td>初始化函数必须是<strong>同步纯函数</strong>；更新状态推荐使用函数式更新</td></tr><tr><td><code>useEffect</code></td><td>管理副作用</td><td>依赖项决定执行时机；必须提供清理函数防止内存泄漏</td></tr></tbody></table>
<p>通过 <code>App2.jsx</code>，我们学会了如何用 <code>useState</code> 赋予组件状态，并理解了<strong>纯函数</strong>的重要性；<br/>
通过 <code>App.jsx</code>，我们掌握了 <code>useEffect</code> 的三种经典模式：<strong>挂载执行</strong>、<strong>依赖更新</strong>、<strong>清理资源</strong>；<br/>
通过 <code>1.js</code>，我们明白了<strong>副作用的危害</strong>与<strong>纯函数的价值</strong>；<br/>
通过 <code>readme.md</code>，我们看到了 Hooks 的整体图景。</p>
<p>项目源码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Fblob%2Fmaster%2Freact%2Fhooks%2Freadme.md" title="https://gitee.com/giaoZou/lesson_zp/blob/master/react/hooks/readme.md" target="_blank" ref="nofollow noopener noreferrer">react/hooks· Zou/lesson_zp - 码云 - 开源中国</a></p>
<p>项目结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf1e1682d2194fd7bf344539225debc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767156485&amp;x-signature=AhEO1vgqAXazaBooxFJhr7M4ZIw%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-20">结语</h2>
<p>React Hooks 不仅是一组 API，更是一种<strong>思维方式的转变</strong>：将状态逻辑从生命周期中解耦，以声明式的方式组合行为。当你真正理解 <code>useState</code> 的纯函数约束、<code>useEffect</code> 的依赖机制与清理闭包，你就不再只是“会用 Hooks”，而是<strong>掌握了一种构建健壮、可维护 React 应用的核心能力</strong>。</p>
<p>现在，打开你的编辑器，把那些被注释掉的 <code>useEffect</code> 代码取消注释，亲自运行看看控制台输出吧！实践，才是理解 Hooks 的最佳路径。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙应用开发之鸿蒙沙箱文件如何存媒体库？]]></title>    <link>https://juejin.cn/post/7587243886428471311</link>    <guid>https://juejin.cn/post/7587243886428471311</guid>    <pubDate>2025-12-24T05:03:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587243886428471311" data-draft-id="7587243886428454927" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙应用开发之鸿蒙沙箱文件如何存媒体库？"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-24T05:03:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙应用开发之鸿蒙沙箱文件如何存媒体库？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:03:10.000Z" title="Wed Dec 24 2025 05:03:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>​</p>
<h2 data-id="heading-0"><strong>效果展示</strong></h2>
<h4 data-id="heading-1"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d4f3f8d7a2b4820820ae84e81ad79dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767157390&amp;x-signature=IDkUpxqPrMtPhpWnjlKvoeqpmzI%3D" alt="cke_1010.png" loading="lazy"/></h4>
<h4 data-id="heading-2"/>
<h2 data-id="heading-3"><strong>实现思路</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a4173b3b8d84d54b49c5423d344d240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767157390&amp;x-signature=GlPxu1eXjh6FqKTtLxSt6VuXzqo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4"/>
<h2 data-id="heading-5"><strong>完整代码</strong></h2>
<p>​</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;
<span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { promptAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
<span class="hljs-keyword">import</span> { image } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ImageKit'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">savePhotoToGallery</span>(<span class="hljs-params">context: common.UIAbilityContext, url:<span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">let</span> helper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// onClick触发后10秒内通过createAsset接口创建图片文件，10秒后createAsset权限收回。</span>
    <span class="hljs-keyword">let</span> uri = <span class="hljs-keyword">await</span> helper.<span class="hljs-title function_">createAsset</span>(photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">IMAGE</span>, <span class="hljs-string">'jpg'</span>);
    <span class="hljs-comment">// 使用uri打开文件，可以持续写入内容，写入过程不受时间限制</span>
    <span class="hljs-keyword">let</span> file = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);
    <span class="hljs-comment">// 写到媒体库文件中</span>
    <span class="hljs-keyword">const</span> source = image.<span class="hljs-title function_">createImageSource</span>(url) <span class="hljs-comment">// 图片对象</span>
    <span class="hljs-keyword">const</span> packer = image.<span class="hljs-title function_">createImagePacker</span>() <span class="hljs-comment">// 创建打包对象</span>
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> packer.<span class="hljs-title function_">packing</span>(source, {
      <span class="hljs-attr">quality</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">format</span>: <span class="hljs-string">'image/jpeg'</span>
    })
    <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">write</span>(file.<span class="hljs-property">fd</span>, buffer);
    <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">close</span>(file.<span class="hljs-property">fd</span>);
    promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'已保存至相册！'</span> });
  }
  <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to save photo. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);
  }
}

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Row</span>() {
      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
        <span class="hljs-comment">// $r('app.media.startIcon')需要替换为开发者所需的图像资源文件</span>
        <span class="hljs-title class_">Image</span>(<span class="hljs-string">'http://tmp00002.zhaodashen.cn/jd.png'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)


        <span class="hljs-title class_">SaveButton</span>()
          .<span class="hljs-title function_">padding</span>({<span class="hljs-attr">top</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">left</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">24</span>})
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">event</span>: <span class="hljs-title class_">ClickEvent</span>, <span class="hljs-attr">result</span>: <span class="hljs-title class_">SaveButtonOnClickResult</span>) =&gt; {
            <span class="hljs-keyword">if</span> (result === <span class="hljs-title class_">SaveButtonOnClickResult</span>.<span class="hljs-property">SUCCESS</span>) {
              <span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
              <span class="hljs-comment">// 免去权限申请和权限请求等环节，获得临时授权，保存对应图片</span>
              <span class="hljs-comment">// =======================</span>
              <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 需要手动将 url 替换为真实服务器的 HTTP 协议地址</span>
                request.<span class="hljs-title function_">downloadFile</span>(
                  <span class="hljs-title function_">getContext</span>(),
                  {
                    <span class="hljs-attr">url</span>: <span class="hljs-string">'http://tmp00002.zhaodashen.cn/jd.png'</span>,
                    <span class="hljs-attr">filePath</span>: context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/hello3.jpg'</span>
                  }
                ).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: request.DownloadTask</span>) =&gt;</span> {
                  <span class="hljs-keyword">let</span> <span class="hljs-attr">downloadTask</span>: request.<span class="hljs-property">DownloadTask</span> = data;

                  downloadTask.<span class="hljs-title function_">on</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">receivedSize: <span class="hljs-built_in">number</span>, totalSize: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'下载中：'</span>, receivedSize, totalSize)
                  })

                  downloadTask.<span class="hljs-title function_">on</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'下载完成'</span>) <span class="hljs-comment">// 保存到媒体库中✅</span>
                    <span class="hljs-title function_">savePhotoToGallery</span>(context, context.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/hello3.jpg'</span>);
                  })
                }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
                  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to request the download. Code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);
                })
              } <span class="hljs-keyword">catch</span> (err) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to request the download. err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);
              }
              <span class="hljs-comment">// =======================</span>
            } <span class="hljs-keyword">else</span> {
              promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'设置权限失败！'</span> })
            }
          })
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-number">0xF1F3F5</span>)
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">鸿蒙开发者班级</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据数据资产智能答疑实践]]></title>    <link>https://juejin.cn/post/7586941997195919412</link>    <guid>https://juejin.cn/post/7586941997195919412</guid>    <pubDate>2025-12-24T05:33:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586941997195919412" data-draft-id="7586869907066257443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据数据资产智能答疑实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-24T05:33:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据数据资产智能答疑实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:33:28.000Z" title="Wed Dec 24 2025 05:33:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在企业大数据中台建设过程中，数仓往往承担了数据资产中心的角色，上承业务库，下接各个部门的分析师，数仓的建设就是数据清洗、中转和分发的一系列操作。我喜欢把数仓的工作比做图书馆管理员，数据资产就像一本书，我们做的数仓建模工作，就好比是系统化的设计、摆放和清理书架，把一本本书放到他应该属于的地方。如何让读者（数据使用方）快速、精确地找到自己想要的书，这就是数仓建设最重要的工作。</p>
<p>货拉拉数仓经过几年的建设目前已经日益成熟和庞大，随着业务发展，下游的分析师、数据科学家、工程师也越来越多，数仓同事每天都会花不少时间在帮助别人找数用数。在日益壮大的“图书馆”和日益增多的“读者”情况下，如何让用户自助解决各类数据资产问题成了当下最重要的提效点。<br/>
大数据数据资产智能答疑工具应运而生。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img16@main/2025/12/23/1766479810381-74746b77-681c-432d-a980-b3d5ad4a16f6.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">行业思路</h2>
<p><strong>Fine-tuning与Embeddings</strong></p>
<p>对于知识库答疑这样的场景，如果我们输入过多非必要的知识文本也会造成回答的不准确。为了解决这个问题，目前常有两种方法一个是Fine-tuning和Embedding。</p>






























<table><thead><tr><th><strong>对比维度</strong></th><th><strong>Fine-tuning</strong></th><th><strong>Embeddings</strong></th></tr></thead><tbody><tr><td><strong>核心原理</strong></td><td>基于预训练大模型，使用知识库数据调整模型部分or全部参数，让模型 “记住” 并直接生成知识相关内容</td><td>将知识库文本（文档、段落、问答对）转化为低维向量（Embedding Vector），存储于向量数据库，通过 “向量相似度检索” 匹配用户问题</td></tr><tr><td><strong>优点</strong></td><td>• 生成能力强：可直接输出结构化回答，无需额外检索逻辑；<br/> • 上下文融合好：能结合用户问题的上下文灵活生成，适配复杂对话场景；<br/> • 知识内化深：知识融入模型参数，对高频问题的响应更流畅自然</td><td>• 成本极低：无需调整大模型参数，仅需生成向量； <br/> • 实时性强：新增or修改知识时，仅需重新生成对应向量，无需重新微调模型； <br/> • 稳定性高：不易出现 “幻觉”，答案严格源于检索到的知识库内容； <br/> • 扩展性好：支持海量知识库</td></tr><tr><td><strong>缺点</strong></td><td>• 成本高昂：需大量计算资源（GPU/TPU）； <br/> • 更新困难：新增知识需重新微调，周期长，无法实时更新； <br/> • 风险高：小样本微调易导致 “灾难性遗忘”（忘记预训练知识），且可能产生 “幻觉”； <br/> • 数据要求高：需高质量、大规模标注数据（如结构化问答对），否则效果差</td><td>• 生成能力弱：仅输出检索到的原始知识片段，需依赖 “检索 + LLM 生成”（如 RAG）组合才能生成流畅回答； <br/> • 上下文依赖低：向量匹配依赖问题与知识的表层语义相似性，对 “同义不同表述” 的匹配精度可能下降； <br/> • 额外架构成本：需搭建向量数据库、检索逻辑（如 BM25 + 向量混合检索），增加系统复杂度； <br/> • 长文本处理差：单条 Embedding 对长文档（如 &gt; 5000 字）的语义捕捉不完整，需拆分段落导致检索颗粒度分散</td></tr><tr><td><strong>知识更新效率</strong></td><td>低（需重新微调模型，周期长，不支持增量更新）</td><td>高（新增知识直接生成向量插入数据库，秒级 / 分钟级更新）</td></tr></tbody></table>
<p>举个例子区分这两种方法：假设你招了一名实习生来帮你干活，Fine-tuning就好比是他刚入职时对他进行专门的入职培训，而Embedding则是提供一本指南宝典，当他遇到问题的时候翻宝典寻找最相似解法。<br/>
目前主流是基于work flow的compound system应用思路，由于其白盒的构建方式更可解释更可控，大部分的企业在构建知识库答疑机器人时还是会选择RAG方案。</p>
<p><strong>HyDE</strong></p>
<p>常见的知识库QA对有一个问题就是关键词的狭隘性，用户的提问通常都是多变的，如果用户换了另一种方式或者另一个关键词提问可能就查询不到对应知识。目前其中一种解决方案是HyDE，其思路是通过假设性文档拓展提问上下文。</p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2025/12/23/1766483552543-46a3353d-27fc-40aa-ad17-9ed82ec7302e.png" alt="" loading="lazy"/></p>
<p><strong>GraphRAG</strong></p>
<p>GraphRAG与传统RAG的区别在于，引入知识图谱，使用图结构来表示信息。节点代表实体（如表、字段、概念等），边表示这些实体之间的关系，通过捕捉实体间的复杂关系，能够精确丰富上下文，提高信息的丰富度和层次。其次通过Multi-hop Questions可以提高Agent推理能力，在知识向量数据库数据量变多时，可以提高查询速度，降低成本。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img5@main/2025/12/23/1766483635708-7b4f0d5d-1c45-4139-ac59-281bf709aff6.png" alt="" loading="lazy"/>
<img src="https://fastly.jsdelivr.net/gh/bucketio/img2@main/2025/12/23/1766483649461-c9afc1bf-57a1-4f43-b7a5-9e563a49e7b4.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">解决方案</h2>
<h3 data-id="heading-3">沟通成本的来源</h3>
<p>事实上数仓大量的数据答疑问题都来自数据资产建设不完善的地方。事实上很多问题并非短期能够解决，而且随着新问题的不断冒出缺陷漏洞可能会越来越大，那答疑工作只会日益增多。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img12@main/2025/12/23/1766483761103-d17fb822-51a7-4448-a7bb-8696a0fdb8da.png" alt="" loading="lazy"/></p>
<p><strong>问题的来源：</strong></p>
<ul>
<li>争议字段
业务研发和数仓开发过程中，可能会记录一些具有争议的字段，这些字段缺少有效的comment解释，使用方法不明确，业务逻辑不清晰，导致下游无法直接有效使用。
最常见的问题就是：XX字段枚举值的含义是什么？当它等于XXX时候业务上显示是怎么样的？</li>
<li>模糊口径
在指标或标签开发过程中，通常会出现一些复杂口径字段，这类口径需要超长的文本、图片、流程图甚至表格数据来解释，数仓不会将其记录在元数据系统里。因此需要单独一套文档来解释这类模糊口径。
最常见的问题就是：XX标签/指标计算的数据范围是什么？包不包含XX条件或有没有考虑XX场景？</li>
<li>数据质量
通常数据质量问题都需要比较长时间的定位，这可能是线上研发BUG导致，也可能是数仓开发错误导致，也可能是使用方不了解数据误会。这类问题通常会在某次发版/发布后出现，通常数据修复后就能解决。
<ol>
<li>前后端数据不一致：为什么这个数据前端显示XX，后端却显示YY？</li>
<li>表表间数据不一致：为什么同个订单ID这个表字段和那个表字段不一样？这个表有那个表没有？</li>
</ol>
</li>
</ul>
<p><strong>问题的分类：</strong></p>
<p>把数仓常见的问题进行分类，我们可以分成以下四类。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img7@main/2025/12/23/1766484082612-45685268-7fc2-4eed-b9bd-20cd91edc8da.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">日常答疑流程</h3>
<p>分析目前数仓的答疑流程有以下特点及缺陷：</p>






























<table><thead><tr><th/><th><strong>特点</strong></th><th><strong>缺陷</strong></th></tr></thead><tbody><tr><td><strong>职责划分</strong></td><td>• 数仓开发工作按主题域划分，答疑工作同样按主题域划分。</td><td>• 问题路由提高了沟通成本 <br/> • 团队成员间彼此答疑记录隔绝，没有办法通过分析下游提问频率发现提问价值 <br/> • 彼此知识库隔绝，小问题无法互相解决</td></tr><tr><td><strong>找数问题</strong></td><td>• 部分主题域有自己的数据字典文档，可以通过平台元数据+查阅文档可解决找数问题</td><td>• 数据字典缺少系统性维护 <br/> • 部分资料陈旧，落后于业务变化</td></tr><tr><td><strong>用数问题</strong></td><td>• 部分主题域有自己的知识库文档，可以通过查阅文档解决用数问题</td><td>• 知识库文档缺少系统性维护 <br/> • 文本知识库可能不规范，RAG工程不准确</td></tr><tr><td><strong>其他问题</strong></td><td>• 通过平台元数据血缘功能，可以找到对应研发，解决数仓无法答疑的数据问题</td><td/></tr></tbody></table>
<h3 data-id="heading-5">架构思路</h3>
<ol>
<li><strong>问题关键词提取和主题识别</strong><br/>
通过rag或prompt工程，完善大模型数仓建设主题域方面知识。在work flow设计主题域划分和关键词提取环节，通过提取结果路由至相关知识库和元数据。注意并非单一路由结果，部分问题可能涉及多个主题域。下图是个大致思路，实际上会有更多的上下文处理和流程优化节点。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img7@main/2025/12/23/1766484394072-56739d9b-8640-4e44-af1b-eea71a3777d1.png" alt="" loading="lazy"/></li>
<li><strong>数据字典维护转移至通过元数据平台维护</strong><br/>
统一的元数据平台满足日常使用，避免交接过程中重要文档丢失，同时长期积累的业务文档具备更深的价值沉淀，随着数据字典完善以及日常数据变更逐渐变小，对大模型的影响更可控。</li>
<li><strong>完善知识库文档</strong><br/></li>
</ol>
<ul>
<li>通过QA对的记录方式，保障文档chunking质量，关键词能被优先提取，确保核心知识路由。</li>
<li>文档记录在团队线上文档，团队成员可以彼此加工完善。</li>
<li>可以针对主题域划分知识库，针对一些小业务、特殊业务也可以做专门知识库。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img1@main/2025/12/23/1766484466157-a1ca7c62-4fe7-4965-a615-32a854a98aad.png" alt="" loading="lazy"/></li>
</ul>
<ol start="4">
<li><strong>提问和答疑记录</strong><br/>
通过分析用户提问可以挖掘数据资产未来开发方向，如业务侧重点、大型数据质量问题、新业务概念等。记录的答疑结果可以接入大模型测评平台，测试智能答疑效果。</li>
<li><strong>智能答疑运营</strong><br/>
通过用户提问-&gt;数据回收-&gt;优化模型 这个运营流程，不断正反馈和优化智能答疑效果，将整个项目往更好的方向推动。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img0@main/2025/12/23/1766484636980-f65fabf4-3ef3-4ceb-b362-9f7ac06434e8.png" alt="" loading="lazy"/>
<img src="https://fastly.jsdelivr.net/gh/bucketio/img8@main/2025/12/23/1766484653022-41b2f4ad-c75a-4e4e-97f4-5aeab187b088.png" alt="" loading="lazy"/></li>
</ol>
<h2 data-id="heading-6">未来方向</h2>
<ol>
<li><strong>数据血缘打通至业务研发</strong><br/>
事实上，在我们日常的答疑工作中有一部分是数仓无法解决的，这一类问题我们通常需要接通到相关产品或者业务研发。从节省沟通成本的角度来看，数仓通过数据血缘将这一类问题直接引入到后端研发，跳过数仓答疑的环节即可。但是这其实是一种将答疑成本转嫁给其他人的行为，如果数仓不将这部分知识沉淀到数仓，那在未来同样会有重复的答疑工作。</li>
<li><strong>数据质量问题难答疑</strong><br/>
在下游提问的问题中，数据质量问题往往是最棘手的。这一类问题的定位通常需要进行大量的SQL探查、口径沟通和拉齐工作。如果从最理想化的项目设计角度来看，未来是可以通过AISQL相结合的方式，来解决这一类问题的。但是这部分的定位SQL是不明确的，目前稳定的NLP2SQL方案其实还是停留在固定模板的方式，想要通过智能答疑完全解决这类问题目前还是比较难。
同时这类问题的终点其实不在定位，而是在修复。这需要比较重的开发经验、沟通能力甚至是资源打通的能力，目前大模型Agent还不具备这样的能力。</li>
<li><strong>更多的RAG架构</strong><br/>
<img src="https://fastly.jsdelivr.net/gh/bucketio/img5@main/2025/12/23/1766485026172-7b0fd33f-1db2-4489-8497-510223e58f14.png" alt="" loading="lazy"/></li>
<li><strong>更多场景补充</strong><br/>
如果把数仓的问题按数仓分层进行拆分，其实大致可以拆分成三层：
贴源层问血缘-&gt;公共层问用法-&gt;应用层问数据
过去的chatbi思路基本是集中在解决应用层问数据这块，在补齐了 问血缘、问用法、问数据更多细节场景之后，大数据Agent才能实现一条龙解决业务问题。</li>
<li><strong>开源框架</strong><br/></li>
</ol>
<ul>
<li>RAG-Anything: All-in-One RAG Framework
这个框架支持端到端多模态流水线、MinerU和Docling的文档解析工具、混合智能检索等特性。另外其Knowledge Graph的构建，通过实体提取和跨模态关联，能够真正打通不同文本、图像、表格之间的信息孤岛。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img6@main/2025/12/23/1766485102463-d3cb88fd-3155-4ee5-93f3-3b5df7ab9b4b.png" alt="" loading="lazy"/></li>
<li>MindsDB: An AI Data Solution
这个框架支持众多数据源集成，包括各种类型文件、数据库、向量存储、应用程序等，通过创建支持库可以将这些结构化和非结构化数据源的数据整合到统一的查询界面，最后通过大模型自然语言询问和返回，实现在所有数据上进行无缝查询和模型构建。
<img src="https://fastly.jsdelivr.net/gh/bucketio/img16@main/2025/12/23/1766485144613-b477f6e4-6a8f-487b-9fb6-36ec84d28bf5.png" alt="" loading="lazy"/></li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>RAG已死吗？<br/>
LLM支持的token数量，从GPT 4时代的8k，到如今Grok 4、Claude 4.5 Sonnet和Gemini 2.5 Pro都逐渐支持1M以上，这个量级的跃迁是明显的。要知道大部分长篇小说、学术著作字数，都在20万到200万之间，而如今的token支持字数，正在逐步超过这个范畴。过去的RAG技术，它其实有点像正则的升级版，用向量的思路帮助我们在茫茫学海里找到最相近的知识，精选出对应的信息，输入给LLM。但长下文更像是给LLM装上了记忆宫殿——我把知识都给你了，你在你的记忆宫殿里能找到吗？找得准吗？目前谁也不知道。<br/>
但RAG会死吗？<br/>
只要存在成本的控制，只要LLM还存在 幻觉、偏见的情况，像RAG这种定点爆破的方式，确实是最高效的。<br/></p>
<h2 data-id="heading-8">参考</h2>
<blockquote>
<p>GitHub - DEEP-PolyU/Awesome-GraphRAG: Awesome-GraphRAG:<br/>
GitHub - HKUDS/RAG-Anything: "RAG-Anything: All-in-One RAG Framework"<br/>
MindsDB, an AI Data Solution - MindsDB<br/></p>
</blockquote>
<p>笔者介绍：杨舒林｜资深数据仓库工程师，现就职于货拉拉，主导过货拉拉数仓交易主题域大型业务切流、保障链路治理等工作，目前负责数据资产核心主题域公共层建设。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js Middleware 极简教程]]></title>    <link>https://juejin.cn/post/7586983243925831718</link>    <guid>https://juejin.cn/post/7586983243925831718</guid>    <pubDate>2025-12-24T05:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243925831718" data-draft-id="7586957587076956210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js Middleware 极简教程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T05:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RedHeartWWW"/> <meta itemprop="url" content="https://juejin.cn/user/3263006243293768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js Middleware 极简教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006243293768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RedHeartWWW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:31:29.000Z" title="Wed Dec 24 2025 05:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js Middleware 极简进阶教程</h2>
<h4 data-id="heading-1">1. 核心角色：网站的“安检员”</h4>
<p>Middleware 就像是进入你网站大门前的<strong>安检员</strong>。它在请求（Request）到达你的页面（Page）或 API 之前运行。</p>
<ul>
<li><strong>执行时机</strong>：请求发出后 → <strong>Middleware (这里)</strong> → 匹配路由 → 渲染页面。</li>
<li><strong>能做什么</strong>：检查登录没？重定向到新页？改一下请求头？</li>
<li><strong>限制</strong>：默认运行在 <strong>Edge Runtime</strong>（极轻量，不能读取文件系统，响应必须极快）。</li>
</ul>
<hr/>
<h4 data-id="heading-2">2. 两个配置点 (在哪里写？)</h4>
<h5 data-id="heading-3">A. 文件位置</h5>
<p>必须放在项目根目录（或 <code>src</code> 目录下），文件名固定为：<code>middleware.ts</code>。</p>
<blockquote>
<p><strong>注意</strong>：整个项目只能有这<strong>一个</strong>中间件文件。</p>
</blockquote>
<h5 data-id="heading-4">B. 过滤规则 (<code>matcher</code>)</h5>
<p>你不需要每个请求都过一遍中间件（比如图片、静态文件）。通过 <code>config</code> 来告诉 Next.js 哪些路径需要被“安检”。</p>
<p>TypeScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// middleware.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> config = {
  <span class="hljs-comment">// 匹配所有路径，但排除掉 api、静态文件、图片、favicon 等</span>
  matcher: [<span class="hljs-string">'/((?!api|_next/static|_next/image|favicon.ico).*)'</span>],
}
</code></pre>
<hr/>
<h4 data-id="heading-5">3. 三个常用招式 (代码怎么写？)</h4>
<p>所有的逻辑都写在导出的 <code>middleware</code> 函数里：</p>
<h5 data-id="heading-6">招式一：权限拦截（没登录就去登录页）</h5>
<p>这是中间件最经典的使用场景。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/server'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">NextRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/server'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">request: NextRequest</span>) {
  <span class="hljs-keyword">const</span> token = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'token'</span>) <span class="hljs-comment">// 读取 Cookie</span>
  <span class="hljs-keyword">const</span> { pathname } = request.<span class="hljs-property">nextUrl</span>

  <span class="hljs-comment">// 如果访问后台页面但没登录，直接重定向到登录页</span>
  <span class="hljs-keyword">if</span> (pathname.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/dashboard'</span>) &amp;&amp; !token) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'/login'</span>, request.<span class="hljs-property">url</span>))
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>() <span class="hljs-comment">// 放行</span>
}
</code></pre>
<h5 data-id="heading-7">招式二：修改请求头（透传信息）</h5>
<p>比如你想在所有的请求头里塞一个 <code>x-user-id</code>，让后面的 API 或页面直接用。</p>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php">export <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span>(<span class="hljs-params">request: NextRequest</span>) </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">requestHeaders</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>(request.headers)
  requestHeaders.<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">'x-hello-from-middleware'</span>, <span class="hljs-string">'hello'</span>)

  <span class="hljs-comment">// 将修改后的 Header 传给下游</span>
  <span class="hljs-keyword">return</span> NextResponse.<span class="hljs-title function_ invoke__">next</span>({
    <span class="hljs-attr">request</span>: {
      <span class="hljs-attr">headers</span>: requestHeaders,
    },
  })
}
</code></pre>
<h5 data-id="heading-8">招式三：处理跨域 (CORS)</h5>
<p>如果你的 Next.js 同时充当后端接口，中间件是处理跨域最统一的地方。</p>
<p>TypeScript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">export function <span class="hljs-title">middleware</span>()</span> {
  <span class="hljs-keyword">const</span> response = NextResponse.next()
  response.headers.<span class="hljs-keyword">set</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)
  response.headers.<span class="hljs-keyword">set</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
  <span class="hljs-keyword">return</span> response
}
</code></pre>
<hr/>
<h4 data-id="heading-9">4. 避坑指南（进阶必看）</h4>
<ol>
<li>
<p><strong>绝对路径</strong>：在中间件里跳转，必须使用 <code>new URL('/path', request.url)</code>。直接写 <code>/path</code> 会报错。</p>
</li>
<li>
<p><strong>避免大数据请求</strong>：中间件是阻塞式的，如果你在里面等一个很慢的外部 API，用户会觉得网页打不开。</p>
</li>
<li>
<p><strong>Cookie 操作</strong>：中间件读取 Cookie 很快，但<strong>修改</strong>响应的 Cookie 需要通过 <code>NextResponse</code> 对象：</p>
<p>TypeScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> response = NextResponse.next()
response.cookies.<span class="hljs-keyword">set</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'dark'</span>) <span class="hljs-comment">// 在这里设置</span>
<span class="hljs-keyword">return</span> response
</code></pre>
</li>
</ol>
<h4 data-id="heading-10">总结：Middleware 的决策逻辑</h4>
<ul>
<li><strong>要权限校验？</strong> 用 Middleware。</li>
<li><strong>要根据语言/设备重定向？</strong> 用 Middleware。</li>
<li><strong>要修改响应头？</strong> 用 Middleware。</li>
<li><strong>要查数据库/拿大量数据？</strong> <strong>不要</strong>用 Middleware（去页面组件或 Server Action 里写）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 13 (API 33)开发自己的 Settings ，如何配置 WiFi BT 权限]]></title>    <link>https://juejin.cn/post/7586954475656986670</link>    <guid>https://juejin.cn/post/7586954475656986670</guid>    <pubDate>2025-12-24T03:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586954475656986670" data-draft-id="7586954475656953902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 13 (API 33)开发自己的 Settings ，如何配置 WiFi BT 权限"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T03:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BoomHe"/> <meta itemprop="url" content="https://juejin.cn/user/1513407128012333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 13 (API 33)开发自己的 Settings ，如何配置 WiFi BT 权限
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1513407128012333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BoomHe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T03:50:31.000Z" title="Wed Dec 24 2025 03:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 13 (API 33) 中，针对WiFi和蓝牙权限有非常严格的 runtime 检查。即使你的应用是系统应用（System App）且配置了 <code>sharedUserId="android.uid.system"</code>，如果缺少必要的权限声明或 <strong>Priv-app 权限白名单配置</strong>，依然会抛出 <code>SecurityException</code>。</p>
<h3 data-id="heading-0">1. AndroidManifest.xml 声明</h3>
<p>在 Android 12/13 中，原有的 <code>BLUETOOTH</code> 和 <code>BLUETOOTH_ADMIN</code> 已经不足以支撑扫描和连接。你必须显式声明新的权限：</p>
<p>XML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span> <span class="hljs-attr">android:sharedUserId</span>=<span class="hljs-string">"android.uid.system"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WRITE_SETTINGS"</span>
        <span class="hljs-attr">tools:ignore</span>=<span class="hljs-string">"ProtectedPermissions"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_WIFI_STATE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CHANGE_WIFI_STATE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- WiFi扫描所需权限 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_FINE_LOCATION"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_COARSE_LOCATION"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- Android 13及以上版本需要的WiFi扫描权限 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.NEARBY_WIFI_DEVICES"</span>
        <span class="hljs-attr">android:usesPermissionFlags</span>=<span class="hljs-string">"neverForLocation"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- 允许应用程序发现并连接到WiFi网络 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CHANGE_WIFI_MULTICAST_STATE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CONTROL_WIFI"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.NETWORK_SETTINGS"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.NETWORK_STACK"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WRITE_SECURE_SETTINGS"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- 蓝牙基本权限 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_ADMIN"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- Android 12及以上版本需要的蓝牙权限 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_SCAN"</span> <span class="hljs-attr">android:usesPermissionFlags</span>=<span class="hljs-string">"neverForLocation"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_CONNECT"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_ADVERTISE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_PRIVILEGED"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<blockquote>
<p><strong>注意：</strong> 如果你的扫描不涉及地理位置，建议加上 <code>neverForLocation</code> 标志，否则系统可能还会要求你申请 <code>ACCESS_FINE_LOCATION</code>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">2. 配置 Priv-app 权限白名单 (关键)</h3>
<p>报错显示 <code>uid = 10068</code>，说明这是一个系统级别的 UID。对于预置在 <code>system/priv-app</code> 或 <code>vendor/priv-app</code> 下的应用，必须在 <code>/etc/permissions/</code> 目录下配置对应的 XML 白名单。</p>
<p>如果你没有配置这个，或者 XML 格式像你上一个问题中提到的那样出现了 <code>Undefined Prefix</code> 错误，系统就会拒绝授予这些权限。</p>
<p><strong>在你的权限配置文件中（例如 <code>com.xxx.settings.xml</code>）添加：</strong></p>
<p>XML</p>
<pre><code class="hljs language-ini" lang="ini">&lt;?xml <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;
&lt;permissions&gt;
    &lt;privapp-permissions <span class="hljs-attr">package</span>=<span class="hljs-string">"com.xxx.settings"</span>&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_SCAN"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_CONNECT"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_PRIVILEGED"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.MODIFY_PHONE_STATE"</span>/&gt;
        
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.NETWORK_SETTINGS"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.NETWORK_STACK"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.CHANGE_WIFI_STATE"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.TETHER_PRIVILEGED"</span>/&gt;
        &lt;permission <span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.WRITE_SECURE_SETTINGS"</span>)
    &lt;/privapp-permissions&gt;
&lt;/permissions&gt;
</code></pre>
<hr/>
<p>配置这些权限后，你的应用就拥有权限特权了，不需要单独申请运行时权限。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConcurrentHashMap实现原理 笔记]]></title>    <link>https://juejin.cn/post/7587011278703951891</link>    <guid>https://juejin.cn/post/7587011278703951891</guid>    <pubDate>2025-12-24T05:03:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587011278703951891" data-draft-id="7586994471739064363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConcurrentHashMap实现原理 笔记"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:03:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心源xinyuan"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConcurrentHashMap实现原理 笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心源xinyuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:03:30.000Z" title="Wed Dec 24 2025 05:03:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ConcurrentHashMap实现原理</h2>
<h3 data-id="heading-1">1. <strong>版本演进概述</strong></h3>

















<table><thead><tr><th>Java版本</th><th>主要特点</th></tr></thead><tbody><tr><td>Java 5-7</td><td>分段锁（Segment Locking）</td></tr><tr><td>Java 8+</td><td>CAS + synchronized + 红黑树</td></tr></tbody></table>
<h3 data-id="heading-2">2. <strong>Java 7及之前：分段锁实现</strong></h3>
<h4 data-id="heading-3">数据结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 7中的结构</span>
ConcurrentHashMap
├── Segment[] segments (继承ReentrantLock)
    ├── HashEntry[] table
        ├── HashEntry (链表节点)
        └── HashEntry
</code></pre>
<h4 data-id="heading-4">分段锁机制</h4>
<ul>
<li>将整个哈希表分成多个<strong>段(Segment)</strong></li>
<li>每个Segment独立加锁</li>
<li>默认16个Segment，支持16个线程并发写</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 7简化的伪代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K, V&gt; {
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments;
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReentrantLock</span> {
        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;
        <span class="hljs-comment">// ...</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V value;
        <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next;
    }
    
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);
        <span class="hljs-comment">// 1. 定位到哪个Segment</span>
        Segment&lt;K,V&gt; s = segmentForHash(hash);
        <span class="hljs-comment">// 2. 对该Segment加锁</span>
        s.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 在Segment内部操作</span>
            <span class="hljs-keyword">return</span> s.put(key, hash, value, <span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">finally</span> {
            s.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-5">3. <strong>Java 8及之后：CAS + synchronized</strong></h3>
<h4 data-id="heading-6">主要改进</h4>
<ol>
<li><strong>放弃分段锁</strong>，使用更细粒度的锁</li>
<li><strong>引入红黑树</strong>解决哈希冲突</li>
<li><strong>使用CAS</strong>实现无锁化读取和部分写操作</li>
</ol>
<h4 data-id="heading-7">核心数据结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 8中的Node结构</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry&lt;K,V&gt; {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
    <span class="hljs-keyword">final</span> K key;
    <span class="hljs-keyword">volatile</span> V val;
    <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt; next;
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 树节点（当链表长度≥8时转化为红黑树）</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
    TreeNode&lt;K,V&gt; parent;  <span class="hljs-comment">// 红黑树链接</span>
    TreeNode&lt;K,V&gt; left;
    TreeNode&lt;K,V&gt; right;
    TreeNode&lt;K,V&gt; prev;    <span class="hljs-comment">// 删除时需要取消链接</span>
    <span class="hljs-type">boolean</span> red;
}

<span class="hljs-comment">// 转发节点（扩容时使用）</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
    <span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] nextTable;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-8">4. <strong>核心操作原理</strong></h3>
<h4 data-id="heading-9">4.1 初始化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 延迟初始化：table在第一次插入时创建</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcurrentHashMap</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 空构造函数，table为null</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] initTable() {
    Node&lt;K,V&gt;[] tab; <span class="hljs-type">int</span> sc;
    <span class="hljs-keyword">while</span> ((tab = table) == <span class="hljs-literal">null</span> || tab.length == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((sc = sizeCtl) &lt; <span class="hljs-number">0</span>)
            Thread.<span class="hljs-keyword">yield</span>(); <span class="hljs-comment">// 正在初始化</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (U.compareAndSwapInt(<span class="hljs-built_in">this</span>, SIZECTL, sc, -<span class="hljs-number">1</span>)) { <span class="hljs-comment">// CAS设置状态为-1</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 初始化table</span>
                <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-literal">null</span> || tab.length == <span class="hljs-number">0</span>) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> (sc &gt; <span class="hljs-number">0</span>) ? sc : DEFAULT_CAPACITY;
                    table = tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;?,?&gt;[n];
                    sc = n - (n &gt;&gt;&gt; <span class="hljs-number">2</span>); <span class="hljs-comment">// 0.75*n，扩容阈值</span>
                }
            } <span class="hljs-keyword">finally</span> {
                sizeCtl = sc;
            }
            <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">return</span> tab;
}
</code></pre>
<h4 data-id="heading-10">4.2 put操作流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-comment">// 1. 参数检查</span>
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();
    
    <span class="hljs-comment">// 2. 计算hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    <span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 3. 循环直到插入成功</span>
    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> n, i, fh;
        
        <span class="hljs-comment">// 3.1 表为空则初始化</span>
        <span class="hljs-keyword">if</span> (tab == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)
            tab = initTable();
        
        <span class="hljs-comment">// 3.2 计算桶位置，如果为空则CAS插入</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>)))
                <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// CAS成功，插入完成</span>
        }
        
        <span class="hljs-comment">// 3.3 如果正在扩容，则帮助扩容</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);
        
        <span class="hljs-comment">// 3.4 正常插入</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-type">V</span> <span class="hljs-variable">oldVal</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 对桶的头节点加锁</span>
                <span class="hljs-comment">// 再次检查节点是否变化</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 链表</span>
                        binCount = <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) {
                            K ek;
                            <span class="hljs-comment">// 找到相同key则更新</span>
                            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;
                                ((ek = e.key) == key ||
                                 (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))) {
                                oldVal = e.val;
                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                    e.val = value;
                                <span class="hljs-keyword">break</span>;
                            }
                            <span class="hljs-comment">// 遍历到链表末尾则插入</span>
                            Node&lt;K,V&gt; pred = e;
                            <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-literal">null</span>) {
                                pred.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeNode) {  <span class="hljs-comment">// 红黑树</span>
                        Node&lt;K,V&gt; p;
                        binCount = <span class="hljs-number">2</span>;
                        <span class="hljs-comment">// 红黑树插入</span>
                        <span class="hljs-keyword">if</span> ((p = ((TreeNode&lt;K,V&gt;)f).putTreeVal(hash, key, value)) != <span class="hljs-literal">null</span>) {
                            oldVal = p.val;
                            <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }
            
            <span class="hljs-comment">// 3.5 检查是否需要树化</span>
            <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)  <span class="hljs-comment">// 链表长度≥8</span>
                    treeifyBin(tab, i);  <span class="hljs-comment">// 可能转为红黑树</span>
                <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                    <span class="hljs-keyword">return</span> oldVal;
                <span class="hljs-keyword">break</span>;
            }
        }
    }
    
    <span class="hljs-comment">// 4. 增加计数，可能触发扩容</span>
    addCount(<span class="hljs-number">1L</span>, binCount);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-11">4.3 get操作（无锁读取）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-type">int</span> n, eh; K ek;
    
    <span class="hljs-comment">// 1. 计算hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    
    <span class="hljs-comment">// 2. 定位桶位置</span>
    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;
        (e = tabAt(tab, (n - <span class="hljs-number">1</span>) &amp; h)) != <span class="hljs-literal">null</span>) {
        
        <span class="hljs-comment">// 3. 检查头节点</span>
        <span class="hljs-keyword">if</span> ((eh = e.hash) == h) {
            <span class="hljs-keyword">if</span> ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))
                <span class="hljs-keyword">return</span> e.val;
        }
        
        <span class="hljs-comment">// 4. hash为负表示特殊节点（树节点或转发节点）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eh &lt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> (p = e.find(h, key)) != <span class="hljs-literal">null</span> ? p.val : <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 5. 遍历链表</span>
        <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e.hash == h &amp;&amp;
                ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek))))
                <span class="hljs-keyword">return</span> e.val;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-12">5. <strong>扩容机制</strong></h3>
<h4 data-id="heading-13">多线程协同扩容</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> tab.length, stride;
    
    <span class="hljs-comment">// 1. 计算每个线程处理的桶区间</span>
    <span class="hljs-keyword">if</span> ((stride = (NCPU &gt; <span class="hljs-number">1</span>) ? (n &gt;&gt;&gt; <span class="hljs-number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)
        stride = MIN_TRANSFER_STRIDE;  <span class="hljs-comment">// 最小16个桶</span>
    
    <span class="hljs-comment">// 2. 创建新数组（2倍大小）</span>
    <span class="hljs-keyword">if</span> (nextTab == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="hljs-number">1</span>];
            nextTab = nt;
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            sizeCtl = Integer.MAX_VALUE;
            <span class="hljs-keyword">return</span>;
        }
        nextTable = nextTab;
        transferIndex = n;  <span class="hljs-comment">// 从后往前迁移</span>
    }
    
    <span class="hljs-comment">// 3. 多线程协同迁移</span>
    <span class="hljs-comment">// 每个线程领取自己的迁移任务区间</span>
    <span class="hljs-comment">// 使用ForwardingNode标记已迁移的桶</span>
}
</code></pre>
<h3 data-id="heading-14">6. <strong>计数机制（size()）</strong></h3>
<h4 data-id="heading-15">LongAdder思想的应用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用CounterCell数组分散计数</span>
<span class="hljs-meta">@sun</span>.misc.Contended <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterCell</span> {
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> value;
    CounterCell(<span class="hljs-type">long</span> x) { value = x; }
}

<span class="hljs-comment">// 计数更新</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCount</span><span class="hljs-params">(<span class="hljs-type">long</span> x, <span class="hljs-type">int</span> check)</span> {
    CounterCell[] as; <span class="hljs-type">long</span> b, s;
    
    <span class="hljs-comment">// 1. 尝试通过CAS更新baseCount</span>
    <span class="hljs-keyword">if</span> ((as = counterCells) != <span class="hljs-literal">null</span> ||
        !U.compareAndSwapLong(<span class="hljs-built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)) {
        
        <span class="hljs-comment">// 2. CAS失败，使用CounterCell</span>
        CounterCell a; <span class="hljs-type">long</span> v; <span class="hljs-type">int</span> m;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">uncontended</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (as == <span class="hljs-literal">null</span> || (m = as.length - <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||
            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="hljs-literal">null</span> ||
            !(uncontended =
              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {
            
            <span class="hljs-comment">// 3. 创建或扩容CounterCell数组</span>
            fullAddCount(x, uncontended);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (check &lt;= <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span>;
        s = sumCount();  <span class="hljs-comment">// 汇总所有计数</span>
    }
    
    <span class="hljs-comment">// 4. 检查是否需要扩容</span>
    <span class="hljs-keyword">if</span> (check &gt;= <span class="hljs-number">0</span>) {
        Node&lt;K,V&gt;[] tab, nt; <span class="hljs-type">int</span> n, sc;
        <span class="hljs-keyword">while</span> (s &gt;= (<span class="hljs-type">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="hljs-literal">null</span> &amp;&amp;
               (n = tab.length) &lt; MAXIMUM_CAPACITY) {
            <span class="hljs-comment">// 触发扩容...</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-16">7. <strong>关键特性总结</strong></h3>
<h4 data-id="heading-17">并发控制策略</h4>

























<table><thead><tr><th>操作</th><th>并发策略</th></tr></thead><tbody><tr><td>读操作</td><td>完全无锁（volatile读）</td></tr><tr><td>空桶插入</td><td>CAS操作</td></tr><tr><td>非空桶操作</td><td>synchronized锁桶头节点</td></tr><tr><td>扩容</td><td>多线程协同迁移</td></tr></tbody></table>
<h4 data-id="heading-18">性能优化点</h4>
<ol>
<li><strong>锁分离</strong>：只锁单个桶而非整个表</li>
<li><strong>CAS优化</strong>：无锁化读和空桶插入</li>
<li><strong>红黑树</strong>：避免长链表性能下降</li>
<li><strong>扩容并发</strong>：多线程协同，不停服扩容</li>
<li><strong>计数优化</strong>：分散热点，避免CAS竞争</li>
</ol>
<h4 data-id="heading-19">内存可见性保证</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 通过Unsafe类保证原子操作</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> &lt;K,V&gt; Node&lt;K,V&gt; <span class="hljs-title function_">tabAt</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, <span class="hljs-type">int</span> i)</span> {
    <span class="hljs-keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="hljs-type">long</span>)i &lt;&lt; ASHIFT) + ABASE);
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> &lt;K,V&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">casTabAt</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, <span class="hljs-type">int</span> i,
                                    Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> {
    <span class="hljs-keyword">return</span> U.compareAndSwapObject(tab, ((<span class="hljs-type">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);
}
</code></pre>
<h3 data-id="heading-20">8. <strong>与HashMap的对比</strong></h3>








































<table><thead><tr><th>特性</th><th>HashMap</th><th>ConcurrentHashMap (Java 8)</th></tr></thead><tbody><tr><td>线程安全</td><td>否</td><td>是</td></tr><tr><td>锁机制</td><td>无</td><td>CAS + synchronized</td></tr><tr><td>数据结构</td><td>数组+链表/红黑树</td><td>数组+链表/红黑树</td></tr><tr><td>扩容</td><td>单线程</td><td>多线程协同</td></tr><tr><td>迭代器</td><td>fast-fail</td><td>弱一致性</td></tr><tr><td>null支持</td><td>允许key/value为null</td><td>不允许</td></tr></tbody></table>
<h3 data-id="heading-21">9. <strong>使用建议</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 创建</span>
ConcurrentHashMap&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// 2. 使用原子操作（推荐）</span>
map.compute(<span class="hljs-string">"key"</span>, (k, v) -&gt; v == <span class="hljs-literal">null</span> ? <span class="hljs-number">1</span> : v + <span class="hljs-number">1</span>);

<span class="hljs-comment">// 3. 并行操作</span>
map.forEach(<span class="hljs-number">1</span>, (k, v) -&gt; System.out.println(k + <span class="hljs-string">": "</span> + v));

<span class="hljs-comment">// 4. 搜索</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> map.search(<span class="hljs-number">1</span>, (k, v) -&gt; v &gt; <span class="hljs-number">100</span> ? k : <span class="hljs-literal">null</span>);
</code></pre>
<p>ConcurrentHashMap通过精细的锁设计、CAS操作、多线程协同等机制，在保证线程安全的同时提供了接近非并发容器的性能，是现代Java高并发编程的核心组件之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误]]></title>    <link>https://juejin.cn/post/7586959875769057289</link>    <guid>https://juejin.cn/post/7586959875769057289</guid>    <pubDate>2025-12-24T05:09:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586959875769057289" data-draft-id="7586983243925635110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误 "/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-24T05:09:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:09:27.000Z" title="Wed Dec 24 2025 05:09:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">INSERT ON DUPLICATE KEY UPDATE</h2>
<p>关于 <code>INSERT ... ON DUPLICATE KEY UPDATE</code>，相信大家都有所了解，是 <code>MySQL</code> 针对</p>
<blockquote>
<p>不存在则插入，存在则更新</p>
</blockquote>
<p>的一种方言实现；<code>存不存在</code> 该如何判定呢，基于表的 <code>唯一索引</code> 或 <code>主键</code></p>
<p>举个例子，如果列 <code>a</code> 被声明为 <code>唯一</code> 且表中已经存在 <code>a=1</code> 的记录，则以下两条语句具有类似的效果</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t1 (a,b,c) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
  <span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> c<span class="hljs-operator">=</span>c<span class="hljs-operator">+</span><span class="hljs-number">1</span>;

<span class="hljs-keyword">UPDATE</span> t1 <span class="hljs-keyword">SET</span> c<span class="hljs-operator">=</span>c<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> a<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
</code></pre>
<p>假设我们有表</p>
<pre><code class="hljs language-r" lang="r">CREATE TABLE `tbl_insert_on_update` <span class="hljs-punctuation">(</span>
  `id` bigint NOT <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>
  `name` varchar<span class="hljs-punctuation">(</span><span class="hljs-number">255</span><span class="hljs-punctuation">)</span> NOT <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>
  `uk_column1` varchar<span class="hljs-punctuation">(</span><span class="hljs-number">255</span><span class="hljs-punctuation">)</span> NOT <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>
  `uk_column2` varchar<span class="hljs-punctuation">(</span><span class="hljs-number">255</span><span class="hljs-punctuation">)</span> NOT <span class="hljs-literal">NULL</span><span class="hljs-punctuation">,</span>
  `remark` text<span class="hljs-punctuation">,</span>
  PRIMARY KEY <span class="hljs-punctuation">(</span>`id`<span class="hljs-punctuation">)</span><span class="hljs-punctuation">,</span>
  UNIQUE KEY `name` <span class="hljs-punctuation">(</span>`name`<span class="hljs-punctuation">)</span>
<span class="hljs-punctuation">)</span> ENGINE<span class="hljs-operator">=</span>InnoDB
</code></pre>
<p>一开始表中没有数据，那么</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span>;
</code></pre>
<p>的作用，相信大家都知道，与</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>);
</code></pre>
<p>作用一样，会往表中插入一条新的记录；如果再执行一次</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span>;
</code></pre>
<p>呢，会是怎么样的结果？相信大家都知道</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35cd951fc29041eca4c79413b515eab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767157767&amp;x-signature=AtFhIdHIyiIvSJNCx8F7DfwBIcw%3D" alt="insert_on_update_再执行一次" loading="lazy"/></p>
<p>与</p>
<pre><code class="hljs language-ini" lang="ini">UPDATE tbl_insert_on_update SET <span class="hljs-attr">uk_column1</span>=<span class="hljs-string">'20050101002'</span>, uk_column2=<span class="hljs-string">'男二号'</span>, remark=<span class="hljs-string">'狂风一样的男子'</span> WHERE id = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
</code></pre>
<p>的效果一样。我们接着做个简单调整，拿掉 <code>name</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>或者拿掉 <code>id</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>会是怎么样的一个结果，你们可以大胆猜一下。这两个 SQL 的执行结果是一样的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25c6f61faf2046f5905ac39330e099d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767157767&amp;x-signature=J%2BCVZ43M1t0p54VMSyxKqeDIxyk%3D" alt="男三浩" loading="lazy"/></p>
<p>此时你们是不是有疑问呢</p>
<blockquote>
<p>为什么拿掉 <code>name</code> 和拿掉 <code>id</code> 的 INSERT ... ON DUPLICATE KEY UPDATE 的执行结果会是一样的？</p>
</blockquote>
<p>这个问题先放一放，我们先录入女一号的数据</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'婉儿'</span>, <span class="hljs-string">'20050101001X'</span>, <span class="hljs-string">'女一号'</span>, <span class="hljs-string">'花一样的女子'</span>);
</code></pre>
<p>假设我们要修改女一号的信息，包括 <code>姓名</code>，是不是可以这么实现</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'婉儿'</span>, <span class="hljs-string">'20050101001X'</span>, <span class="hljs-string">'女一号'</span>, <span class="hljs-string">'花一样的女子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'张三'</span>, uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002X'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'女二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'牵牛花一样的女子'</span>;
</code></pre>
<p>有什么问题吗，执行下就知道了嘛</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0213ed0930d9444ca5f4860b44e7db56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767157767&amp;x-signature=D7JZo5fFt7lPDEhohHJDPwa49xc%3D" alt="唯一索引冲突" loading="lazy"/></p>
<p>执行报错了，提示</p>
<blockquote>
<p>1062 - Duplicate entry '张三' for key 'tbl_insert_on_update.name'</p>
</blockquote>
<p>这个错误信息我们是不是很熟悉？不就是唯一索引冲突吗？那么问题又来了</p>
<blockquote>
<p>用了MySQL的INSERT ON DUPLICATE KEY UPDATE，为什么还会唯一索引冲突？</p>
</blockquote>
<h2 data-id="heading-1">如何判断是否存在</h2>
<p>我们写 <code>INSERT ... ON DUPLICATE KEY UPDATE</code> 语句时，并未指定用哪个 <code>主键</code> 或者 <code>唯一索引</code> 来判定记录是否存在</p>
<blockquote>
<p>Oracle、SQL Server、PostgreSQL 的 <code>MERGE</code> 有类似作用</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">MERGE</span> <span class="hljs-keyword">INTO</span> TBL_INSERT_ON_UPDATE t
<span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> ID, <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AS</span> NAME, <span class="hljs-string">'20050101001'</span> <span class="hljs-keyword">AS</span> UK_COLUMN1, <span class="hljs-string">'男一号'</span> <span class="hljs-keyword">AS</span> UK_COLUMN2, <span class="hljs-string">'风一样的男子'</span> <span class="hljs-keyword">AS</span> REMARK <span class="hljs-keyword">FROM</span> dual
) s
<span class="hljs-keyword">ON</span> (t.NAME <span class="hljs-operator">=</span> s.NAME)  <span class="hljs-comment">-- 基于 NAME 字段匹配</span>
<span class="hljs-keyword">WHEN</span> MATCHED <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span>
        t.ID <span class="hljs-operator">=</span> s.ID,
        t.UK_COLUMN1 <span class="hljs-operator">=</span> s.UK_COLUMN1,
        t.UK_COLUMN2 <span class="hljs-operator">=</span> https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.falvce.com<span class="hljs-operator">/</span> s.UK_COLUMN2,
        t.REMARK <span class="hljs-operator">=</span> s.REMARK
<span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">NOT</span> MATCHED <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">INSERT</span> (ID, NAME, UK_COLUMN1, UK_COLUMN2, REMARK)
    <span class="hljs-keyword">VALUES</span> (s.ID, s.NAME, s.UK_COLUMN1, s.UK_COLUMN2, s.REMARK);
</code></pre>
<p>其中的 <code>ON</code> 明确指定匹配字段（根据哪些字段判断记录是否存在），一般是指定 <code>主键</code>字段或 <code>唯一索引</code>字段</p>
</blockquote>
<p>那 MySQL 是如何判定记录是否存在的呢？我们可以翻阅下官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finsert-on-duplicate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html" ref="nofollow noopener noreferrer">INSERT ... ON DUPLICATE KEY UPDATE Statement</a>。一开头有如下一段描述</p>
<blockquote>
<p>If you specify an <code>ON DUPLICATE KEY UPDATE</code> clause and a row to be inserted would cause a duplicate value in a <code>UNIQUE</code> index or <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.falvce.com%2F" target="_blank" title="https://www.falvce.com/" ref="nofollow noopener noreferrer">www.falvce.com/</a> <code>PRIMARY KEY</code>, an <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Fupdate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/update.html" ref="nofollow noopener noreferrer"><code>UPDATE</code></a> of the old row occurs</p>
<p>当我们使用 <code>ON DUPLICATE KEY UPDATE</code> 子句时，插入的行导致 <code>唯一</code> 索引或者 <code>主键</code> 重复时，会更新旧的行</p>
</blockquote>
<p>通过这段话，我们只知道 MySQL 是根据唯一索引或主键来判定行是否存在，并不知道</p>
<ol>
<li>先根据主键判定，不冲突之后再根据唯一索引判定？</li>
<li>有多个唯一索引时，这些唯一索引的判定优先级是怎样的？</li>
</ol>
<p>官方文档里面并未明确说明这些问题，只是在结尾进行了如下说明</p>
<blockquote>
<p>An <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finsert-on-duplicate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html" ref="nofollow noopener noreferrer"><code>INSERT ... ON DUPLICATE KEY UPDATE</code></a> statement against a table having more than one unique or primary key is also marked as unsafe. (Bug #11765650, <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.falvce.com%2F" target="_blank" title="https://www.falvce.com/" ref="nofollow noopener noreferrer">www.falvce.com/</a> Bug #58637)</p>
<p>当表中有多个唯一索引或者主键时，INSERT ... ON DUPLICATE KEY UPDATE 语句不安全</p>
</blockquote>
<p>不安全代表执行结果不固定，会出现我们预期之外的结果</p>
<h2 data-id="heading-2">工作原理</h2>
<p>如果让你们来实现 <code>不存在则插入，存在则更新</code>，你们会怎么实现？</p>
<p>逐个查询主键以及所有唯一索引，判断该行数据是否存在，一旦存在则根据重复的主键或者唯一索引进行 <code>UPDATE</code>，都不存在则进行 <code>INSERT</code>；这不仅是你们最容易想到的实现方式，也是我最容易想到的方式。</p>
<p>但 MySQL 并未采用这种方式，而是采用了另外一种更高效的方式，先尝试插入，存储引擎会向<strong>所有相关的唯一索引（包括主键）</strong>  中插入对应的索引条目，如果都插入成功，说明数据行不存在，那么 <code>INSERT</code> 数据行；一旦存储引擎尝试插入某个唯一索引时，发现该数据行已经存在，会立即停止插入动作，并向MySQL服务层抛出 <code>重复键</code> 错误，服务层收到重复键错误后，并不会让整个语句失败（因为使用了 ON DUPLICATE KEY UPDATE 子句），而是转换执行模式，会先回滚之前的插入，然后根据重复的那个唯一索引找到数据行对应的 <code>旧行</code> 数据，最后 <code>UPDATE</code> 数据行；总结下来分三步</p>
<ol>
<li>
<p>尝试插入</p>
<p>所有唯一索引（包括主键）都插入成功，则插入数据行，相当于完成普通的 <code>INSERT</code></p>
<p>一旦某个唯一索引插入失败，则立即停止插入，存储引擎会向上层抛出一个 <code>重复键</code> 错误</p>
</li>
<li>
<p>模式转换</p>
<p>MySQL服务器收到重复键后，发现执行语句中有 <code>ON DUPLICATE KEY UPDATE</code> 子句，不会直接让整个语句失败，而是先回滚之前的那部分唯一索引的插入，然后根据插入失败的唯一索引找到已经存在的 <code>旧行</code></p>
</li>
<li>
<p>执行更新</p>
<p>根据插入失败的唯一索引，对旧行执行更新操作，相当于完成普通的 <code>UPDATE</code></p>
</li>
</ol>
<p>整个 <code>尝试-失败-转换-更新</code> 过程时一个原子操作，那么完全成功，要么完全失败；相比于 <code>先查询后判断</code> 的传统实现，这种实现方式效率更高。</p>
<h2 data-id="heading-3">问题答疑</h2>
<p>前面涉及到两个问题，现在我们来解惑下</p>
<ol>
<li>
<p>为什么拿掉 <code>name</code> 和拿掉 <code>id</code> 的 INSERT ... ON DUPLICATE KEY UPDATE 的执行结果会是一样的？</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 拿掉name</span>
<span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;

<span class="hljs-comment">-- 拿掉id</span>
<span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>这个问题是不是很简单，我们一起来分析下</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>INSERT 的字段中没有 <code>name</code>，但有 <code>id</code>，可想而知判断数据行是否存在，用到的是 <code>主键</code>，因为 <code>id=1</code> 的记录已经存在，所以根据 id 去更新其他字段值；那么执行结果与如下 SQL 一致</p>
<pre><code class="hljs language-ini" lang="ini">UPDATE tbl_insert_on_update SET <span class="hljs-attr">uk_column1</span>=<span class="hljs-string">'20050101003'</span>, uk_column2=<span class="hljs-string">'男三号'</span>, remark=<span class="hljs-string">'暴风一样的男子'</span> WHERE id = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
</code></pre>
<p>同理</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>INSERT 的字段中没有 <code>id</code>，但有 <code>name</code>，可想而知判断数据行是否存在，用到的是 <code>唯一索引</code>，因为 <code>name=张三</code> 的记录已经存在，所以根据 name 去更新其他字段值；那么执行结果与如下 SQL 一致</p>
<pre><code class="hljs language-ini" lang="ini">UPDATE tbl_insert_on_update SET <span class="hljs-attr">uk_column1</span>=<span class="hljs-string">'20050101003'</span>, uk_column2=<span class="hljs-string">'男三号'</span>, remark=<span class="hljs-string">'暴风一样的男子'</span> WHERE name = <span class="hljs-string">'张三'</span><span class="hljs-comment">;</span>
</code></pre>
<p><code>id = 1</code> 与 <code>name = '张三'</code> 指向的本来就是同一行数据，更新的列与列值都一致，那么执行结果自然就一样了</p>
</li>
<li>
<p>存在多个唯一索引（包含主键）时，判断数据行是否存在，这些唯一索引的优先级顺序是怎样的？</p>
<p>MySQL 官方文档并未明确说明这个优先级顺序，但在 MySQL 的实现中肯定有这个优先级顺序的实现算法，可能跟版本、存储引擎有关</p>
<p>基于 <code>8.0.31</code> 版本，简单测试出以下优先级</p>
<blockquote>
<p>主键 &gt; 唯一索引</p>
<p>唯一索引之间按创建顺序，先创建的优先级高</p>
</blockquote>
<p>官方文档已经明确说明：当表中有多个唯一索引或者主键时，INSERT ... ON DUPLICATE KEY UPDATE 语句不安全，所以如上的测试结果并不具备确定性，不能作为使用准则</p>
</li>
<li>
<p>用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误</p>
<p>MySQL是基于尝试插入的第一个冲突的唯一索引来执行更新的，更新的字段完全有可能触发其他唯一索引（包括主键）冲突</p>
<p>这个问题根本不成立！</p>
</li>
</ol>
<h2 data-id="heading-4">总结</h2>
<ol>
<li>不管是 MySQL，还是 Oracle、SQL Server、PostgreSQL，针对 <code>不存在则插入，存在则更新</code> 判断数据是否存在的逻辑都是一样的，只是 MySQL 不需要显示指定 <code>判存</code> 的唯一索引（包括主键），由 MySQL 引擎内部自动实现</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 初学者指南 基础结构与常见错误]]></title>    <link>https://juejin.cn/post/7586971532699566089</link>    <guid>https://juejin.cn/post/7586971532699566089</guid>    <pubDate>2025-12-24T05:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586971532699566089" data-draft-id="7586959875769073673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 初学者指南 基础结构与常见错误 "/> <meta itemprop="keywords" content="PHP"/> <meta itemprop="datePublished" content="2025-12-24T05:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 初学者指南 基础结构与常见错误 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:17:26.000Z" title="Wed Dec 24 2025 05:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 结构:基础知识</h2>
<p>在深入常见错误之前,我们先看看每个初学者都必须理解的 PHP 基本结构。</p>
<h3 data-id="heading-1">PHP 语法</h3>
<p>PHP 代码嵌入在 HTML 中。要在网页中执行 PHP,我们用 <code>&lt;?php ... ?&gt;</code> 标签包裹 PHP 代码。</p>
<p>示例:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>PHP Basics<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to PHP!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-meta">&lt;?php
    echo "Hello, World!";
    ?&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>在上面的示例中,PHP 块 <code>&lt;?php echo "Hello, World!"; ?&gt;</code> 在 HTML body 中生成消息 "Hello, World!"。理解基本语法是编写 PHP 脚本的第一步。</p>
<h3 data-id="heading-2">变量和数据类型</h3>
<p>在 PHP 中,变量以美元符号 <code>$</code> 为前缀,后跟变量名。PHP 是弱类型语言,这意味着声明变量时不需要指定数据类型。类型将根据赋值自动推断。</p>
<p>示例:</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">name</span> = <span class="hljs-string">"John"</span><span class="hljs-comment">;      // String</span>
$<span class="hljs-attr">age</span> = <span class="hljs-number">30</span><span class="hljs-comment">;           // Integer</span>
$<span class="hljs-attr">height</span> = <span class="hljs-number">5.9</span><span class="hljs-comment">;       // Float</span>
$<span class="hljs-attr">isStudent</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;   // Boolean</span>
</code></pre>
<h3 data-id="heading-3">函数</h3>
<p>PHP 中的函数是可重用的代码块。使用 <code>function</code> 关键字定义它们,这有助于组织和模块化代码。</p>
<p>示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, <span class="hljs-subst">$name</span>!"</span>;
}
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">greet</span>(<span class="hljs-string">"Alice"</span>); <span class="hljs-comment">// Outputs: Hello, Alice!</span>
<span class="hljs-meta">?&gt;</span>
</code></pre>
<p>理解如何定义和使用函数将在代码变得更复杂时为你节省大量时间和精力。</p>
<h2 data-id="heading-4">初学者在 PHP 中常犯的错误</h2>
<p>虽然 PHP 是一门强大而灵活的语言,但初学者经常会犯一些常见错误。让我们深入了解一些最常见的陷阱以及如何避免它们。</p>
<h3 data-id="heading-5">忘记使用正确的 PHP 标签</h3>
<p>一个常见错误是忘记正确打开或关闭 PHP 标签。PHP 代码必须始终包含在 <code>&lt;?php ... ?&gt;</code> 中。如果这些标签缺失或不正确,代码将无法运行。</p>
<p>错误示例:</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">html</span>&gt;
&lt;<span class="hljs-selector-tag">body</span>&gt;
    <span class="hljs-selector-tag">echo</span> "<span class="hljs-selector-tag">Hello</span>, <span class="hljs-selector-tag">World</span>!"; <span class="hljs-comment">// Error: no PHP opening tag</span>
&lt;/<span class="hljs-selector-tag">body</span>&gt;
&lt;/<span class="hljs-selector-tag">html</span>&gt;
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-php" lang="php">&lt;html&gt;
&lt;body&gt;
    <span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, World!"</span>; <span class="hljs-meta">?&gt;</span>
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 data-id="heading-6">字符串中未转义特殊字符</h3>
<p>处理字符串时,需要转义特殊字符,特别是在字符串中使用引号时。否则会导致语法错误。</p>
<p>错误示例:</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">greeting</span> = <span class="hljs-string">"He said, "</span>Hello!<span class="hljs-string">""</span><span class="hljs-comment">;</span>
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">greeting</span> = <span class="hljs-string">"He said, "</span>Hello!<span class="hljs-string">""</span><span class="hljs-comment">;</span>
</code></pre>
<p>或者,可以对外层字符串使用单引号:</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">greeting</span> = <span class="hljs-string">'He said, "Hello!"'</span><span class="hljs-comment">;</span>
</code></pre>
<p>这个小错误可能导致代码出现意外行为,所以务必正确处理特殊字符。</p>
<h3 data-id="heading-7">使用错误的比较运算符</h3>
<p>PHP 有两种比较运算符:<code>=</code> 用于赋值,<code>==</code> 用于比较。初学者经常混淆这两者,导致意外结果。</p>
<p>错误示例:</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">age</span> = <span class="hljs-number">30</span><span class="hljs-comment">;</span>
if ($<span class="hljs-attr">age</span> = <span class="hljs-number">25</span>) {  // Mistake: uses assignment, not comparison
    echo "Age is 25"<span class="hljs-comment">;</span>
}
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">age</span> = <span class="hljs-number">30</span><span class="hljs-comment">;</span>
if ($<span class="hljs-attr">age</span> == <span class="hljs-number">25</span>) {  // Correct: comparison operator
    echo "Age is 25"<span class="hljs-comment">;</span>
}
</code></pre>
<p>在 if 语句中使用赋值运算符 <code>=</code> 会导致错误的条件判断。始终使用 <code>==</code> 进行比较以避免此类错误。</p>
<h3 data-id="heading-8">未使用适当的缩进和代码格式</h3>
<p>虽然 PHP 不强制严格的缩进规则,但未能正确格式化代码会使其难以阅读和调试,特别是随着项目的增长。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-variable">$name</span>==<span class="hljs-string">"Alice"</span>){<span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Alice!"</span>;}<span class="hljs-keyword">else</span>{<span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Guest!"</span>;}
    }
<span class="hljs-meta">?&gt;</span>
</code></pre>
<p>正确示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">greet</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$name</span> == <span class="hljs-string">"Alice"</span>) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Alice!"</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Hello, Guest!"</span>;
    }
}
<span class="hljs-meta">?&gt;</span>
</code></pre>
<p>正确格式化的代码不仅仅关乎美观——它对可读性和可维护性至关重要。</p>
<h3 data-id="heading-9">不当使用全局变量</h3>
<p>如果不谨慎使用,全局变量可能导致不可预测的行为。通常最好在函数之间显式传递变量,而不是依赖全局作用域。</p>
<p>错误示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$counter</span> = <span class="hljs-number">10</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increaseCounter</span>(<span class="hljs-params"/>) </span>{
<span class="hljs-comment">### $counter++; https://www.falvce.com/ // Refers to the global variable</span>
}
<span class="hljs-title function_ invoke__">increaseCounter</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$counter</span>;  <span class="hljs-comment">// Outputs 11</span>
</code></pre>
<p>更好的做法:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$counter</span> = <span class="hljs-number">10</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">increaseCounter</span>(<span class="hljs-params"><span class="hljs-variable">$counter</span></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$counter</span> + <span class="hljs-number">1</span>;
}
<span class="hljs-variable">$counter</span> = <span class="hljs-title function_ invoke__">increaseCounter</span>(<span class="hljs-variable">$counter</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$counter</span>;  <span class="hljs-comment">// Outputs 11</span>
</code></pre>
<p>显式传递变量使代码更可预测,更易于调试。</p>
<h2 data-id="heading-10">编写整洁 PHP 代码的最佳实践</h2>
<p>现在我们已经介绍了一些常见错误,让我们探讨一些能帮助你编写更好 PHP 代码的最佳实践。</p>
<h3 data-id="heading-11">使用 isset() 和 empty() 检查变量</h3>
<p>在访问变量之前,检查它是否已设置很重要。使用 <code>isset()</code> 和 <code>empty()</code> 有助于防止访问未定义变量时出错。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$username</span>) &amp;&amp; !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$username</span>)) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Username is set and not empty."</span>;
}
</code></pre>
<p>这有助于避免意外错误,使代码更健壮。</p>
<h3 data-id="heading-12">始终清理用户输入</h3>
<p>PHP 经常用于处理用户输入,但未经检查的输入可能导致安全漏洞,如 SQL 注入或 XSS 攻击。始终清理和验证用户输入。</p>
<pre><code class="hljs language-ini" lang="ini">$<span class="hljs-attr">username</span> = htmlspecialchars(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>])<span class="hljs-comment">;</span>
</code></pre>
<p>使用 <code>htmlspecialchars()</code> 等函数或数据库查询的预处理语句对于编写安全的 PHP 应用至关重要。</p>
<h3 data-id="heading-13">保持函数小而专注</h3>
<p>理想情况下,一个函数应该执行一项任务并做好它。保持函数小而专注于单一职责,使代码更模块化且更易于测试。</p>
<p>示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchUserData</span>(<span class="hljs-params"><span class="hljs-variable">$userId</span></span>) </span>{
    <span class="hljs-comment">// Fetch user data from database</span>
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">displayUserProfile</span>(<span class="hljs-params"><span class="hljs-variable">$userData</span></span>) </span>{
    <span class="hljs-comment">// https://www.falvce.com/ Display user profile information</span>
}
</code></pre>
<p>通过分离关注点,每个函数都变得更易于理解和修改。</p>
<h2 data-id="heading-14">进阶技巧</h2>
<h3 data-id="heading-15">使用命名空间</h3>
<p>随着项目的增长,将代码组织到命名空间中以避免命名冲突变得越来越重要。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">MyApp</span>\<span class="hljs-title class_">Controllers</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"/>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Displaying user profile."</span>;
    }
}
</code></pre>
<p>命名空间有助于保持代码组织有序,并防止命名冲突,特别是在大型项目中。</p>
<h3 data-id="heading-16">使用 Composer 进行依赖管理</h3>
<p>PHP 项目通常依赖外部库。Composer 是管理这些依赖的最佳工具。</p>
<pre><code class="hljs language-lua" lang="lua">composer <span class="hljs-built_in">require</span> vendor/<span class="hljs-built_in">package</span>
</code></pre>
<p>Composer 简化了依赖管理,并确保库始终保持最新。</p>
<h2 data-id="heading-17">结语</h2>
<p>掌握 PHP 需要对其结构和常见陷阱有扎实的理解。通过遵循最佳实践并避免错误,你将顺利编写整洁、高效且安全的 PHP 代码。虽然 PHP 一开始可能看起来令人生畏,但有了正确的基础,你很快就能轻松构建强大的应用。</p>
<p>无论你是刚起步还是希望提升技能,这些见解都将帮助你成为更自信、更有能力的 PHP 开发者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[synchronized 的入门理解]]></title>    <link>https://juejin.cn/post/7586959875769204745</link>    <guid>https://juejin.cn/post/7586959875769204745</guid>    <pubDate>2025-12-24T05:39:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586959875769204745" data-draft-id="7586954475657248814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="synchronized 的入门理解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-24T05:39:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌大抄手"/> <meta itemprop="url" content="https://juejin.cn/user/4405122315850060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            synchronized 的入门理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4405122315850060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌大抄手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:39:17.000Z" title="Wed Dec 24 2025 05:39:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多个线程访问共享资源的时候，由于分时系统，线程可能发生切换，导致指令没有按照我们预想的顺序执行，从而致使发生错误。例如商场系统中经典的库存超卖问题，就是多线程并发导致的问题。</p>
<p>为了准确描述问题，我们引入两个概念：<strong>临界区</strong> (Critical Section)、<strong>竞态条件</strong>(Race Condition)</p>
<ul>
<li><strong>临界区</strong>：临界区是指<strong>访问共享资源的代码块区域</strong>，并可能被多个线程同时执行</li>
<li><strong>竞态条件</strong>：竞态条件是指<strong>多个线程同时在临界区执行，由于执行的顺序未知导致结果不可预测</strong></li>
</ul>
<p>要解决并发带来的问题，就是要避免临界区的竞态条件，常用的手段如下</p>
<ul>
<li>阻塞式方案：synchronized、ReentrantLock</li>
<li>非阻塞式方案：原子化操作、乐观锁</li>
</ul>
<p>本文主要介绍synchronized方案，并介绍synchronized的一些原理，聊一聊不能唠的比磕~</p>
<h2 data-id="heading-0">synchronized 用法</h2>
<p>对于想要保护的临界区，我们可以直接用synchronized给这块区域上锁</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span>(obj) {
	<span class="hljs-comment">// 临界区</span>
}

<span class="hljs-keyword">synchronized</span>(obj.class) {
	<span class="hljs-comment">// 临界区</span>
}
</code></pre>
<p>可以看到上面的示例代码，我们既可以锁对象实例，也可以锁对象的Class对象。我们把它们分别称作：<strong>实例锁、类锁</strong></p>
<ul>
<li><strong>实例锁：锁定的是堆中的实例对象</strong></li>
<li><strong>类锁：锁定的是方法区中的Class对象</strong></li>
</ul>
<p>我们也可以直接在方法上加 synchronized 来上锁</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
	 <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">t1</span><span class="hljs-params">()</span> {
		 <span class="hljs-comment">// 临界区</span>
		 <span class="hljs-comment">// 锁static方法，相当于上类锁</span>
	 } 
	 
	 <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">t2</span><span class="hljs-params">()</span> {
		 <span class="hljs-comment">// 临界区</span>
		 <span class="hljs-comment">// 锁非static方法，相当于上实例锁</span>
	 }
}
</code></pre>
<p>synchronized 采取互斥的方式让<strong>同一时刻只有一个线程可以拿到锁对象</strong>，只有拿到锁对象的线程才可以执行临界区的代码。这样就可以保证拿到锁的线程可以安全地执行临界区的代码，不用担心线程上下文切换时其它线程执行临界区的代码。
syncrhonized 本质上是<strong>用对象锁保证了临界区中的代码的原子性</strong>，让临界区的代码执行时不可分割，不会被线程切换打断。</p>
<h2 data-id="heading-1">锁升级</h2>
<p>synchronized 会在遇到不同的情况之后进行锁膨胀，这对开发者是透明的。你只要上锁就行了，synchronized考虑的可就多了 (bushi)。
在JDK15前锁膨胀的路径是：无锁 -&gt; 偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁。因为近年来大多数应用的并发模式中，由偏向锁带来的收益已经小于其维护开销，因此JDK15决定默认禁用它，所以JDK15以后的锁膨胀的路径是：<strong>无锁 -&gt; 轻量级锁 -&gt; 重量级锁</strong>。本文以JDK15以后的环境为准，介绍轻量级锁和重量级锁</p>
<h3 data-id="heading-2">对象头</h3>
<p>为了更好的介绍轻量级锁的上锁原理，首先我们需要了解以下对象头。对象头是Java对象在内存中的一部分，用于存储该对象的元数据和运行时信息。普通对象头主要由两部分组成：Mark Word和Klass Word，数组对象还要多一个数组长度。如下图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2077b3a3001946d981e2b86af0ddea1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5aSn5oqE5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767159557&amp;x-signature=RHrs1R2zozM0RxLOpXLBn6RoxFk%3D" alt="普通对象头" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57c777f4a1794f65a4819cbdac2b0540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5aSn5oqE5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767159557&amp;x-signature=%2Fi3Z%2FCw4tCXi9m%2FaW%2BbJniKF6zI%3D" alt="数组对象头" loading="lazy"/>
其中Mark Word的结构为：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c02c921d22b04c6ea360fb5ecc925a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5aSn5oqE5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767159557&amp;x-signature=%2FIGwp4UdBwGiQYbs37a00u%2FM2yU%3D" alt="在这里插入图片描述" loading="lazy"/>
可以看到Mark Word中存储了线程上锁的状态，无锁、偏向锁、轻量级锁、重量级锁，这些正是锁膨胀的路径，可以发现在状态为轻量级时，有指针 <code>ptr_to_lock_record</code>, 状态为重量级锁时，有指针 <code>prt_to_heavyweight_monitor</code>，接下来我们一一介绍。</p>
<h3 data-id="heading-3">轻量级锁</h3>
<p>当第一个线程首次抢到锁，进入synchronized同步块的时候，会变成轻量级锁的状态。JVM会在当前线程创建一个Lock Record的记录空间，这个Lock Record包含两部分：Displaced Mark Word、指向锁对象的引用。Displaced Mark Word会拷贝一份锁对象原来的Mark Word并保存起来，以便以后释放锁的时候恢复。然后线程使用CAS原子操作，尝试将锁对象头中的Mark Word中的 <code>ptr_to_lock_record</code> 指针，指向该线程栈帧中Lock Record。</p>
<ul>
<li>
<p>如果CAS成功，即当前锁对象的Mark Word仍然是Lock Record之前复制时的状态，那么说明当前没有其它线程竞争，则此时当前线程获得该锁对象的轻量级锁</p>
</li>
<li>
<p>如果CAS失败，那么说当前存在其它线程竞争，此时会进入锁膨胀，这个后面再说
所以加轻量级锁的逻辑如下图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/909258b997bc4b46a00765183fe4e9ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5aSn5oqE5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767159557&amp;x-signature=Vk7GoYfFNgvdSXO3wkw5s7%2FN0nA%3D" alt="在这里插入图片描述" loading="lazy"/>
那么如果发生了锁重入呢？这时JVM会在线程栈创建一个新的Lock Record，但是这个Lock Record的 displaced mark word 会被设置为 null（起到一个计数器的作用），而不是复制对象头中的 mark word，JVM不会对这个新的 Lock Record 执行CAS去修改锁的对象头。在解锁的时候，会先解开内部同步块的锁，对应到线程栈中就是先弹出栈中 displaced mark word 为 null 的 LockRecord，这样就实现了可重入锁。</p>
<p>回到之前的线程竞争问题，如果CAS失败，那么说明当前线程存在竞争，此时当前线程会进入自旋，也可以说是忙等待，也就是不断尝试获取锁，如果自旋期间锁被释放了，那么就可能抢到锁，否则如果自旋期间没有抢到锁，就会进行锁膨胀，升级为重量级锁。</p>
<p>所以我们可以发现，轻量级锁只适应无线程竞争或者少量线程竞争的场景，一旦面临多线程竞争时，就需要用到重量级锁</p>
</li>
</ul>
<h3 data-id="heading-4">重量级锁</h3>
<p>对于每一个锁对象都会关联一个Monitor，这个Monitor就是真正的“锁”，Monitor的结构如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bbe5337835e4415a13128f28132d2ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5aSn5oqE5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767159557&amp;x-signature=frgjHM%2Flm6%2F%2FUCxvqEuzebUf77Q%3D" alt="在这里插入图片描述" loading="lazy"/>
可以看到Monitor中有Owner、EntryList、WaitSet，整个重量级锁就是由这三个字段给管理起来的。当轻量级锁膨胀升级为重量级锁时，原先持有锁的线程就会让owner指向该线程，而竞争失败的线程会进入EntryList，进入阻塞状态，等待锁释放后被唤醒。</p>
<p>WaitSet 是WAITING状态线程呆的地方，比如在线程中调用了obj.wait()就会进入WAITING状态，如果再被notify给叫醒就会重新与其它线程进行竞争。</p>
<p>这时发生线程竞争和锁重入就很好办了。首先对于锁重入，Monitor中有个锁计数器，在第一次获取锁的时候，线程会基于CAS将owner指向当前线程，并将锁计数器加一，而在第二次时，如果发现目前要获取的锁已经是当前持有的锁时，就直接不执行CAS操作，直接将锁计数器加一就行。在后面退出锁的时候将计数器减一，直到计数器为1时，把计数器减为0然后置owner为null。</p>
<p>发生线程竞争时，如果当前竞争锁的线程发现，目前的owner已经指向其它线程了，那么与轻量级锁近似，竞争失败的线程在进入EntryList之前，会有一个短暂的自旋优化尝试。这个自旋操作是为了在锁可能很快释放的情况下，避免线程阻塞和唤醒的成本。</p>
<h2 data-id="heading-5">synchronized 的秘密</h2>
<blockquote>
<p>可以和你一起竞争锁这件事本身就已经很带派了</p>
</blockquote>
<p>当你写下 <code>synchronized(obj)</code>这一行代码时，就像是与 JVM 立下了一个默契的约定。JVM 则在背后默默地为你上演着一出出锁升级、自旋、排队、唤醒的精彩大戏。所以，下次当你使用它时，或许可以会心一笑，想起这一切背后的精妙设计。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>