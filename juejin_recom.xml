<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Hibernate（46） Hibernate的配置文件如何加载？]]></title>    <link>https://juejin.cn/post/7595801647247327251</link>    <guid>https://juejin.cn/post/7595801647247327251</guid>    <pubDate>2026-01-16T11:55:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647247327251" data-draft-id="7595552420048338987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（46） Hibernate的配置文件如何加载？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T11:55:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（46） Hibernate的配置文件如何加载？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T11:55:28.000Z" title="Fri Jan 16 2026 11:55:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，配置文件通常用于定义数据库连接信息、Hibernate属性和实体类映射等。常见的配置文件包括<code>hibernate.cfg.xml</code>和<code>hibernate.properties</code>。本文将详细介绍如何加载Hibernate的配置文件，并结合代码示例说明。</p>
<h3 data-id="heading-0">加载Hibernate配置文件</h3>
<h4 data-id="heading-1">1. 使用<code>hibernate.cfg.xml</code>加载配置</h4>
<p><code>hibernate.cfg.xml</code>是最常用的Hibernate配置文件。通常放置在类路径的根目录下。</p>
<h5 data-id="heading-2">示例配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-3">加载<code>hibernate.cfg.xml</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.cfg.xml配置文件</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>new Configuration().configure("hibernate.cfg.xml")</code>会自动查找类路径下的<code>hibernate.cfg.xml</code>文件，并加载其中的配置信息。然后使用这些配置信息构建<code>SessionFactory</code>实例。</p>
<h4 data-id="heading-4">2. 使用<code>hibernate.properties</code>加载配置</h4>
<p>除了<code>hibernate.cfg.xml</code>，Hibernate还支持通过<code>hibernate.properties</code>文件加载配置信息。</p>
<h5 data-id="heading-5">示例配置文件 <code>hibernate.properties</code></h5>
<pre><code class="hljs language-properties" lang="properties">hibernate.connection.driver_class=com.mysql.cj.jdbc.Driver
hibernate.connection.url=jdbc:mysql://localhost:3306/your_database
hibernate.connection.username=your_username
hibernate.connection.password=your_password
hibernate.dialect=org.hibernate.dialect.MySQLDialect
hibernate.show_sql=true
hibernate.format_sql=true
hibernate.hbm2ddl.auto=update
</code></pre>
<h5 data-id="heading-6">加载<code>hibernate.properties</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.properties配置文件</span>
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();
            configuration.configure(); <span class="hljs-comment">// 默认会加载类路径下的hibernate.cfg.xml或hibernate.properties</span>
            sessionFactory = configuration.buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>configuration.configure()</code>默认会加载类路径下的<code>hibernate.cfg.xml</code>或<code>hibernate.properties</code>文件，可以根据具体需求调整。</p>
<h3 data-id="heading-7">配置文件加载的深入解释</h3>
<ol>
<li>
<p><strong>Configuration类</strong>：</p>
<ul>
<li><code>org.hibernate.cfg.Configuration</code>类是Hibernate用来配置的核心类。它可以从XML文件或Java属性文件加载配置。</li>
<li><code>configure()</code>方法默认查找类路径根目录下的<code>hibernate.cfg.xml</code>文件。如果提供文件名参数，<code>configure("hibernate.properties")</code>则会加载指定文件。</li>
</ul>
</li>
<li>
<p><strong>SessionFactory</strong>：</p>
<ul>
<li><code>SessionFactory</code>是Hibernate框架中的关键对象，负责创建<code>Session</code>对象。<code>Session</code>对象是单线程的短期对象，用于执行CRUD操作。</li>
<li><code>SessionFactory</code>是线程安全的，可以在应用程序中全局共享，通常在应用启动时创建一次，并在整个应用生命周期中使用。</li>
</ul>
</li>
<li>
<p><strong>异常处理</strong>：</p>
<ul>
<li>在静态块中初始化<code>SessionFactory</code>，并捕获任何可能的异常。如果初始化失败，会抛出<code>ExceptionInInitializerError</code>，确保应用及时发现配置问题。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">综合示例</h3>
<p>以下是一个完整的示例，展示如何配置并加载Hibernate配置文件，创建<code>SessionFactory</code>并执行一些基本操作。</p>
<h5 data-id="heading-9">完整示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-comment">// HibernateUtil类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}

<span class="hljs-comment">// Category类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Product类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "category_id")</span>
    <span class="hljs-keyword">private</span> Category category;

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Hibernate测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(<span class="hljs-string">"Electronics"</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product1.setName(<span class="hljs-string">"Laptop"</span>);
            product1.setPrice(<span class="hljs-number">1000.0</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product2.setName(<span class="hljs-string">"Smartphone"</span>);
            product2.setPrice(<span class="hljs-number">500.0</span>);

            category.addProduct(product1);
            category.addProduct(product2);

            session.save(category);

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个综合示例中，<code>HibernateUtil</code>类负责加载配置文件并创建<code>SessionFactory</code>，<code>Category</code>和<code>Product</code>类定义了实体，<code>HibernateTest</code>类则演示了如何使用Hibernate进行数据操作。通过这种方式，可以有效地加载和使用Hibernate的配置文件进行数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 最新发现：超大型项目 AI 也能做了，上百个 Agent 一起上]]></title>    <link>https://juejin.cn/post/7595842144906854450</link>    <guid>https://juejin.cn/post/7595842144906854450</guid>    <pubDate>2026-01-17T09:13:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595842144906854450" data-draft-id="7595831738234601481" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 最新发现：超大型项目 AI 也能做了，上百个 Agent 一起上"/> <meta itemprop="keywords" content="前端,AI编程,Cursor"/> <meta itemprop="datePublished" content="2026-01-17T09:13:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张拭心"/> <meta itemprop="url" content="https://juejin.cn/user/571401775094312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 最新发现：超大型项目 AI 也能做了，上百个 Agent 一起上
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401775094312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张拭心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:13:48.000Z" title="Sat Jan 17 2026 09:13:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是拭心。</p>
<p>2008 年 9 月 2 日，Google Chrome 浏览器正式发布。这个项目从 2005 年立项到发布，<strong>「历时 3 年，投入了数千名工程师」</strong>。如今，Chromium 代码规模已超过 3600 万行，被称为“人类史上最复杂的软件工程项目之一”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5f05cf35b2346cd9a49256b01845beb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byg5out5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769246245&amp;x-signature=mifJjS1mapz9Vx2UnF9lKUg9sDw%3D" alt="图片" loading="lazy"/></p>
<p>而就在最近，Cursor 团队做了一件让人震惊的事：<strong>「他们用上百个 AI Agent，花了不到一周时间，从零开始构建了一个浏览器，写出了超过 100 万行代码」</strong>。</p>
<p>这不是概念验证，也不是玩具项目。</p>
<p>他们用 Agent 持续运行数周，在多个超大型项目上写出了数百万行代码：Java LSP（55 万行）、Windows 7 模拟器（120 万行）、Excel（160 万行）。更令人震撼的是，它们还直接在 Cursor 自己的生产代码库中完成了一次大规模框架迁移，代码增删量达到 +266K/-193K，用时 3 周多。</p>
<p><strong>「从 3 年到 1 周，从数千名工程师到上百个 Agent，这不是量变，是质变」</strong>。</p>
<p>AI 编程正在跨越一个关键门槛：从“辅助写代码”到“自主开发项目”。</p>
<p>这篇文章我们来了解下 Cursor 是如何做到的，以及对我们意味着什么。</p>
<h2 data-id="heading-0">一、多 Agent 协作：从失败到突破</h2>
<p>单个 AI Agent 能写出几百行代码，但要开发一个百万行级别的项目，光靠一个 Agent 显然不够。</p>
<p>Cursor 团队的目标是让编码 Agent 持续运行数周，完全自主地完成超大型项目。</p>
<p>这意味着必须让上百个 Agent 同时工作。但问题来了：<strong>「怎么让它们高效协作，而不是互相干扰？」</strong></p>
<h3 data-id="heading-1">1.1 扁平结构：一场灾难</h3>
<p>Cursor 团队最初的想法很直觉：让所有 Agent 具有同等地位，通过一个共享文件自行协同。</p>
<p>每个 Agent 会检查其他 Agent 在做什么、认领一个任务并更新自己的状态。为防止两个 Agent 抢占同一项任务，他们使用了锁机制。</p>
<p>但这套方案在并发方面失败了：</p>
<p><strong>「锁机制成了瓶颈」</strong>。 Agent 会持有锁太久，或者干脆忘记释放锁。即使锁机制正常工作，它也会成为瓶颈。二十个 Agent 的速度会下降到相当于两三个 Agent 的有效吞吐量，大部分时间都花在等待上。</p>
<p><strong>「系统非常脆弱」</strong>。 Agent 可能在持有锁的情况下失败、尝试获取自己已经持有的锁，或者在完全没有获取锁的情况下更新协调文件。</p>
<p>后来他们尝试用乐观并发控制来替代锁：Agent 可以自由读取状态，但如果自上次读取后状态已经发生变化，则写入会失败。这种方式更简单、也更健壮，但更深层的问题依然存在。</p>
<p>在没有确定任务的情况下，Agent 变得非常规避风险。 它们会回避困难任务，转而做一些小而安全的修改。<strong>「没有任何一个 Agent 承担起解决难题或端到端实现的责任」</strong>（像极了曾经遇到的同事）。结果就是工作长时间在空转，却没有实质性进展。</p>
<p>这就像一个没有项目经理的团队，每个人都在做“看起来安全”的小任务，没人敢碰核心难题。</p>
<h3 data-id="heading-2">1.2 分层结构：像真实的团队一样工作</h3>
<p>Cursor 团队后来尝试里将不同角色拆分开来。不再使用每个 Agent 都什么都做的扁平结构，而是搭建了一条职责清晰的流水线：</p>
<ul>
<li><strong>「规划者」</strong>（Planners）：持续探索代码库并创建任务。他们可以针对特定区域派生子规划者，使规划过程本身也可以并行且递归地展开。</li>
<li><strong>「执行者」</strong>（Workers）：领取任务并专注于把任务完成到底。他们不会与其他执行者协调，也不关心整体大局，只是全力处理自己被分配的任务，完成后再提交变更。</li>
</ul>
<p>在每个周期结束时，会有一个**「评审 Agent」**判断是否继续，然后下一轮迭代会从干净的初始状态重新开始。</p>
<p>这套结构基本解决了协同问题，并且让他们可以扩展到非常大的项目，而不会让任何单个 Agent 陷入视野过于狭窄的状态。成百上千个 Worker 并发运行，向同一个分支推送代码，而且几乎没有冲突。</p>
<p>这就像一个真实的开发团队：<strong>「有人负责架构设计和任务拆解，有人专注执行具体任务，各司其职，高效协作。」</strong></p>
<h3 data-id="heading-3">1.3 三个震撼案例</h3>
<p>有了这套系统后，Cursor 团队开始测试它的边界：</p>
<p><strong>「从零开始构建浏览器」</strong>。 Agent 持续运行了将近一周，在 1，000 个文件中写出了超过 100 万行代码。虽然看起来只是一张简单的截图，但从零开始构建一个浏览器极其困难。尽管代码库规模庞大，新启动的 Agent 仍然可以理解它并取得实质性进展。</p>
<p><strong>「Cursor 代码库的框架迁移」</strong>。 他们在 Cursor 代码库中就地将 Solid 迁移到 React，整个过程持续了 3 周多，代码增删量达到 +266K/-193K。随着测试的进行，他们确实认为有可能合并这次大规模改动。</p>
<p><strong>「产品性能提升 25 倍」</strong>。 在一款即将上线的产品中，一个长时间运行的 Agent 通过一个高效的 Rust 实现，让视频渲染速度提升了 25 倍。它还新增了平滑缩放和平移的能力，使用自然的弹簧过渡和运动模糊效果，并能跟随光标顺畅移动。这部分代码已经合并，不久就会在生产环境中上线。</p>
<p>这些案例证明，多 Agent 开发大型项目不再是概念验证，而是真实的生产力。</p>
<h2 data-id="heading-4">二、为什么现在可以做到</h2>
<p>上百个 Agent 协作开发超大型项目，这在一年前几乎是不可想象的。Cursor 团队的成功，背后有几个关键因素。</p>
<h3 data-id="heading-5">2.1 模型能力的质变</h3>
<p>在运行时间极长的任务中，模型选择至关重要。Cursor 团队发现，不同模型在长时间自主工作时表现差异巨大。</p>
<p><strong>「GPT-5.2 系列在长时间自主工作方面要优秀得多：更能遵循指令、保持专注、避免偏离，并且在实现上更加精确和完整」</strong>。相比之下，Opus 4.5 往往会更早结束、在方便的时候走捷径，更快地把控制权交还给用户。</p>
<p>这不是说 Opus 4.5 不好，而是不同模型有不同的“性格”。Opus 4.5 更适合需要人类频繁介入的场景，而 GPT-5.2 更适合长时间无人值守的自主开发。</p>
<p>更有意思的是，不同模型在不同角色上各有所长。即便 GPT-5.1-codex 是专门为编码训练的，GPT-5.2 依然是更好的规划者。现在 Cursor 团队会**「针对每个角色选择最适合的模型，而不是依赖单一通用模型」**。</p>
<p>规划者用 GPT-5.2，执行者用 GPT-5.1-codex，评审者可能又是另一个模型。这就像组建一个真实团队，你会根据每个岗位的特点选择最合适的人。</p>
<h3 data-id="heading-6">2.2 提示词比框架更重要</h3>
<p>系统中有相当大一部分行为，很大程度上取决于如何为这些 Agent 设计提示词。要让它们良好协作、避免异常行为，并在长时间内保持专注，Cursor 团队做了大量实验。</p>
<p>运行框架和模型本身固然重要，但提示词更重要。</p>
<p>这个结论可能让很多人意外。我们往往以为技术架构和模型才是关键，但 Cursor 团队发现，同样的架构，不同的提示词设计，Agent 的表现会有天壤之别。</p>
<p>如何让规划者拆解任务时粒度合适？如何让执行者在遇到困难时不放弃？如何让评审者准确判断工作质量？这些都需要精心设计的提示词。</p>
<p>这也揭示了一个重要趋势：<strong>「Prompt Engineering（提示词工程）是成为 AI 时代的核心技能。」</strong></p>
<blockquote>
<p>❝</p>
<p>推荐阅读我写的《<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobot.net%2Fp%2Fai_1024" target="_blank" title="https://xiaobot.net/p/ai_1024" ref="nofollow noopener noreferrer">提示词工程：你缺的不只是专业术语</a>》</p>
<p>❞</p>
</blockquote>
<h3 data-id="heading-7">2.3 减法思维：少即是多</h3>
<p>Cursor 团队的许多改进来自“减法”而不是“加法”。</p>
<p>一开始他们为质量控制和冲突解决设计了一个集成者（Integrator）角色，专门负责协调各个 Worker 的代码、解决冲突、确保质量。听起来很合理，对吧？</p>
<p>但后来发现，<strong>「集成者制造的瓶颈多于解决的问题。各个 Worker 本身就已经有能力处理彼此之间的冲突。多出来的这个角色反而让流程变得复杂、脆弱，成了整个系统的瓶颈」</strong>。</p>
<p>去掉集成者后，系统反而更流畅了。</p>
<p>这个经验很有启发性：最好的系统往往比你想的更简单。起初 Cursor 团队尝试借鉴分布式计算和组织设计中的系统模型，但并不是所有这些方法都适用于 Agent。</p>
<h2 data-id="heading-8">三、剧变来临的信号</h2>
<p>Cursor 团队告诉我们，<strong>「上百个 Agent 可以在同一个代码库上协同工作数周，推动雄心勃勃的项目取得实质进展。这不是理论，而是已经发生的现实」</strong>。</p>
<p>但他们也坦承：多智能体协同仍然是一个难题。当前的系统虽然可用，但离最优状态还差得很远。Planner 应该在任务完成时自动“醒来”规划下一步，Agent 有时会运行时间过长，他们仍然需要定期从头重启，以对抗漂移和思维视野过于狭窄的问题。</p>
<p>即便如此，对于核心问题——“能否通过投入更多 Agent 来扩展 AI 自主编码能力”——他们得到的答案依然比预期更乐观。</p>
<p>回顾过去几年 AI 编程工具的发展：</p>
<ul>
<li>2022 年：GitHub Copilot 补全代码片段</li>
<li>2023 年：ChatGPT 生成完整函数</li>
<li>2024 年：Cursor 理解项目上下文</li>
<li>2025 年：Cursor/TRAE 支持 Agent 自主开发</li>
<li>2026 年：Cursor 探索多 Agent 系统自主开发超大型项目</li>
</ul>
<p>编程工具进展神速，AI 从“辅助写代码”变成了“自主开发项目”。</p>
<p>今天，Cursor 用上百个 Agent 写出了 100 万行代码。明年呢？后年呢？AI 编程的能力边界正在快速扩张。</p>
<p>对于开发者来说：如果你的核心能力是“写代码”，那么你需要警惕了。<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobot.net%2Fp%2Fai_1024" target="_blank" title="https://xiaobot.net/p/ai_1024" ref="nofollow noopener noreferrer">但如果你的核心能力是“理解需求、设计架构、协调资源、解决问题”，那么你反而会因为 AI 而变得更强大。</a></strong></p>
<p>那些提前拥抱 AI、学会与 AI 协作的人，正在获得巨大的竞争优势。不要等到 AI 完全成熟了再去学习，因为到那时候，窗口期可能已经关闭了。</p>
<p>Cursor 用上百个 Agent 开发超大型项目，这不是终点，而是起点。剧变正在发生，你准备好了吗？</p>
<p>好了，这篇文章到这里就结束了。感谢你的阅读，愿你平安顺遂。</p>
<p>如果对你有帮助，欢迎评论点赞转发，你的支持是我最大的动力❤️</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fcn%2Fblog%2Fscaling-agents" target="_blank" title="https://cursor.com/cn/blog/scaling-agents" ref="nofollow noopener noreferrer">cursor.com/cn/blog/sca…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ruoyi专题]]></title>    <link>https://juejin.cn/post/7595911076013932580</link>    <guid>https://juejin.cn/post/7595911076013932580</guid>    <pubDate>2026-01-17T06:38:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076013932580" data-draft-id="7593296804110041128" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ruoyi专题"/> <meta itemprop="keywords" content="Java,Spring Boot,前端"/> <meta itemprop="datePublished" content="2026-01-17T06:38:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ruoyi专题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:38:30.000Z" title="Sat Jan 17 2026 06:38:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">修改器下载</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flpf_project%2FRuoYi-MT" target="_blank" title="https://gitee.com/lpf_project/RuoYi-MT" ref="nofollow noopener noreferrer">gitee.com/lpf_project…</a></p>
<p>选择压缩包，配置修改内容，开始执行。会输出一个文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0979afba4c0c4176a77211e39a3c7068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=Q8THEbDjbgn5GYdepaad1RM8Xy8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">Swagger</h2>
<p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务</p>
<p>它的主要作用有：</p>
<ul>
<li>使得前后端分离开发更加方便，有利于团队协作</li>
<li>在线自动生成接口文档，降低后端开发人员编写接口文档的负担</li>
<li>功能测试</li>
</ul>
<p>Spring已经将Swagger纳入自身的标准，建立了Spring-Swagger项目，现在叫Springfox。通过在项目中引入Springfox ，就可以非常简单快捷的使用Swagger啦。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- swagger3--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 防止进入swagger页面报类型转换错误，排除3.0.0中的引用，手动增加1.6.2版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.swagger<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-models<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>核心配置类</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Swagger2的接口配置
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SwaggerConfig</span> {
    <span class="hljs-comment">/**
     * 系统基础配置
     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuoYiConfig ruoyiConfig;

    <span class="hljs-comment">/**
     * 是否开启swagger
     */</span>
    <span class="hljs-meta">@Value("${swagger.enabled}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;

    <span class="hljs-comment">/**
     * 设置请求的统一前缀
     */</span>
    <span class="hljs-meta">@Value("${swagger.pathMapping}")</span>
    <span class="hljs-keyword">private</span> String pathMapping;

    <span class="hljs-comment">/**
     * 创建API
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">createRestApi</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.OAS_30)
                <span class="hljs-comment">// 是否启用Swagger</span>
                .enable(enabled)
                <span class="hljs-comment">// 用来创建该API的基本信息，展示在文档的页面中（自定义展示的信息）</span>
                .apiInfo(apiInfo())
                <span class="hljs-comment">// 设置哪些接口暴露给Swagger展示</span>
                .select()
                <span class="hljs-comment">// 扫描所有有注解的api，用这种方式更灵活</span>
                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))
                <span class="hljs-comment">// 扫描指定包中的swagger注解</span>
                <span class="hljs-comment">// .apis(RequestHandlerSelectors.basePackage("com.kzzyl.project.tool.swagger"))</span>
                <span class="hljs-comment">// 扫描所有 .apis(RequestHandlerSelectors.any())</span>
                .paths(PathSelectors.any())
                .build()
                <span class="hljs-comment">/* 设置安全模式，swagger可以设置访问token */</span>
                .securitySchemes(securitySchemes())
                .securityContexts(securityContexts())
                .pathMapping(pathMapping);
    }

    <span class="hljs-comment">/**
     * 安全模式，这里指定token通过Authorization头请求头传递
     */</span>
    <span class="hljs-keyword">private</span> List&lt;SecurityScheme&gt; <span class="hljs-title function_">securitySchemes</span><span class="hljs-params">()</span> {
        List&lt;SecurityScheme&gt; apiKeyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        apiKeyList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiKey</span>(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Authorization"</span>, In.HEADER.toValue()));
        <span class="hljs-keyword">return</span> apiKeyList;
    }

    <span class="hljs-comment">/**
     * 安全上下文
     */</span>
    <span class="hljs-keyword">private</span> List&lt;SecurityContext&gt; <span class="hljs-title function_">securityContexts</span><span class="hljs-params">()</span> {
        List&lt;SecurityContext&gt; securityContexts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        securityContexts.add(
                SecurityContext.builder()
                        .securityReferences(defaultAuth())
                        .operationSelector(o -&gt;
                                o.requestMappingPattern().matches(<span class="hljs-string">"/.*"</span>))
                        .build());
        <span class="hljs-keyword">return</span> securityContexts;
    }

    <span class="hljs-comment">/**
     * 默认的安全上引用
     */</span>
    <span class="hljs-keyword">private</span> List&lt;SecurityReference&gt; <span class="hljs-title function_">defaultAuth</span><span class="hljs-params">()</span> {
        <span class="hljs-type">AuthorizationScope</span> <span class="hljs-variable">authorizationScope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationScope</span>(<span class="hljs-string">"global"</span>,
                <span class="hljs-string">"accessEverything"</span>);
        AuthorizationScope[] authorizationScopes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthorizationScope</span>[<span class="hljs-number">1</span>];
        authorizationScopes[<span class="hljs-number">0</span>] = authorizationScope;
        List&lt;SecurityReference&gt; securityReferences = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        securityReferences.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityReference</span>(<span class="hljs-string">"Authorization"</span>, authorizationScopes));
        <span class="hljs-keyword">return</span> securityReferences;
    }

    <span class="hljs-comment">/**
     * 添加摘要信息
     */</span>
    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 用ApiInfoBuilder进行定制</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()
                <span class="hljs-comment">// 设置标题</span>
                .title(<span class="hljs-string">"标题：若依管理系统_接口文档"</span>)
                <span class="hljs-comment">// 描述</span>
                .description(<span class="hljs-string">"描述：用于管理集团旗下公司的人员信息,具体包括XXX,XXX模块..."</span>)
                <span class="hljs-comment">// 作者信息</span>
                .contact(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(ruoyiConfig.getName(), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>))
                <span class="hljs-comment">// 版本</span>
                .version(<span class="hljs-string">"版本号:"</span> + ruoyiConfig.getVersion())
                .build();
    }
}

</code></pre>
<h2 data-id="heading-2">集成knife4j</h2>
<p>如果不习惯使用swagger可以使用前端UI的增强解决方案knife4j，对比swagger相比有以下优势，友好界面，离线文档，接口排序，安全控制，在线调试，文档清晰，注解增强，容易上手。
目前，企业项目中一般都使用knife4j框架。</p>
<blockquote>
<p>需要移除依赖，springfox-boot-starter 和 swagger-models</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringBoot2 使用依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>前端修改 ry-ui\views\tool\swagger\index.vue 跳转地址，如下</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">ref</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_BASE_API</span> + <span class="hljs-string">"/doc.html"</span>)
</code></pre>
<h3 data-id="heading-3">注解参数</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 作用到类上描述，标题</span>
<span class="hljs-meta">@Api(value = "护理项目管理", tags = "护理项目管理")</span>
<span class="hljs-comment">// 作用到方法上，描述具体的接口</span>
<span class="hljs-meta">@ApiOperation("查询护理项目列表")</span>
<span class="hljs-comment">// 作用到方法的参数上，描述参数信息</span>
<span class="hljs-meta">@ApiParam("查询条件对象")</span>
<span class="hljs-comment">// 作用到实体类上</span>
<span class="hljs-meta">@ApiModel("Entity基类")</span>
<span class="hljs-comment">// 作用到实体类的成员变量上</span>
<span class="hljs-meta">@ApiModelProperty("搜索值")</span>
</code></pre>
<h2 data-id="heading-4">Velocity模块引擎</h2>
<p>Velocity是一个基于Java的模板引擎，它可以通过特定的语法获取java对象的数据 , 填充到模板中，从而实现界面和java代码的分离。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3433d5b35001450990f095a738cd467f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=aHo%2FU8y22hjMMHOlSFipBAJcnIQ%3D" alt="image.png" loading="lazy"/></p>
<p>常见的应用场景：</p>
<ul>
<li>Web应用程序 : 作为应用程序的视图, 展示数据。</li>
<li>源代码生成 : Velocity可以基于模板生成Java源代码。</li>
<li>自动电子邮件 : 网站注册， 认证等的电子邮件模板。</li>
<li>网页静态化 : 基于velocity模板生成静态网页。</li>
</ul>
<blockquote>
<p>案例</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> 1.初始化velocity</span>
<span class="hljs-type">Properties</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
<span class="hljs-comment">// 加载classpath目录下的vm文件</span>
p.setProperty(<span class="hljs-string">"resource.loader.file.class"</span>, <span class="hljs-string">"org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader"</span>);
<span class="hljs-comment">// 定义字符集</span>
p.setProperty(Velocity.INPUT_ENCODING, Constants.UTF8);
<span class="hljs-comment">// 初始化Velocity引擎，指定配置Properties</span>
Velocity.init(p);

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 2.创建Velocity上下文对象</span>
<span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();
context.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"加油朋友"</span>);

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 3.获取模板</span>
<span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> Velocity.getTemplate(<span class="hljs-string">"vms/index.html.vm"</span>, Constants.UTF8);
<span class="hljs-comment">// 准备输出流，将文件写出</span>
<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fileWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"E:\\黑马ai\\kzzyl\\kzzyl-generator\\src\\main\\resources\\vms\\index.html"</span>);
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 4.合并模板和数据模型</span>
template.merge(context, fileWriter);

fileWriter.close();
</code></pre>
<p><strong>模板如下：使用 ${message} 传递 message 变量</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>随便写点数据吧--${message}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>Velocity语法解释</p>
<ul>
<li>${variable}: 表示插入变量值。</li>
<li>#foreach 和 #end: 循环结构，用于遍历列表。</li>
<li>#if 和 #end: 条件判断结构。</li>
<li>#set: 设置变量。</li>
<li>#elseif: 条件分支。</li>
</ul>
<h2 data-id="heading-5">集成 MybatisPlus</h2>
<p>在 common 下引入</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- MyBatis-Plus 增强CRUD --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>删除 mybatis-config.xml 文件</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># MyBatisPlus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-comment"># 搜索指定包别名</span>
  <span class="hljs-attr">typeAliasesPackage:</span> <span class="hljs-string">com.kzzyl.**.domain</span>
  <span class="hljs-comment"># 配置mapper的扫描，找到所有的mapper.xml映射文件</span>
  <span class="hljs-attr">mapperLocations:</span> <span class="hljs-string">classpath*:mapper/**/*Mapper.xml</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-comment"># 开启驼峰命名规则</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p>删除 MyBatisConfig 文件，替换成 MyBatisPlusConfig 如下</p>
</blockquote>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * Mybatis Plus 配置
 */</span>
<span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 分页插件</span>
        interceptor.addInnerInterceptor(paginationInnerInterceptor());
        <span class="hljs-comment">// 乐观锁插件</span>
        interceptor.addInnerInterceptor(optimisticLockerInnerInterceptor());
        <span class="hljs-comment">// 阻断插件</span>
        interceptor.addInnerInterceptor(blockAttackInnerInterceptor());
        <span class="hljs-keyword">return</span> interceptor;
    }

    <span class="hljs-comment">/**
     * 分页插件，自动识别数据库类型
     */</span>
    <span class="hljs-keyword">public</span> PaginationInnerInterceptor <span class="hljs-title function_">paginationInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">PaginationInnerInterceptor</span> <span class="hljs-variable">paginationInnerInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>();
        <span class="hljs-comment">// 设置数据库类型为mysql</span>
        paginationInnerInterceptor.setDbType(DbType.MYSQL);
        <span class="hljs-comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span>
        paginationInnerInterceptor.setMaxLimit(-<span class="hljs-number">1L</span>);
        <span class="hljs-keyword">return</span> paginationInnerInterceptor;
    }

    <span class="hljs-comment">/**
     * 乐观锁插件
     */</span>
    <span class="hljs-keyword">public</span> OptimisticLockerInnerInterceptor <span class="hljs-title function_">optimisticLockerInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>();
    }

    <span class="hljs-comment">/**
     * 如果是对全表的删除或更新操作，就会终止该操作
     */</span>
    <span class="hljs-keyword">public</span> BlockAttackInnerInterceptor <span class="hljs-title function_">blockAttackInnerInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockAttackInnerInterceptor</span>();
    }

}
</code></pre>
<p>注意事项：</p>
<ol>
<li>需要在 BaseEntity 里 <code>params和searchValue</code> 需要设置 @TableField(exist = false)</li>
</ol>
<blockquote>
<p>方便直接拷贝</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.kzzyl.common.core.domain;

<span class="hljs-keyword">import</span> java.io.Serial;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span> Kun
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ApiModel("Entity基类")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {

    <span class="hljs-meta">@Serial</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-meta">@JsonIgnore</span>
    <span class="hljs-meta">@ApiModelProperty("搜索值")</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-keyword">private</span> String searchValue;

    <span class="hljs-meta">@ApiModelProperty("创建者")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> String createBy;

    <span class="hljs-meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-meta">@ApiModelProperty("创建时间")</span>
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-meta">@ApiModelProperty("更新者")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.UPDATE)</span>
    <span class="hljs-keyword">private</span> String updateBy;

    <span class="hljs-meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.UPDATE)</span>
    <span class="hljs-meta">@ApiModelProperty("更新时间")</span>
    <span class="hljs-keyword">private</span> Date updateTime;

    <span class="hljs-comment">/**
     * 备注
     */</span>
    <span class="hljs-meta">@ApiModelProperty("备注")</span>
    <span class="hljs-keyword">private</span> String remark;

    <span class="hljs-comment">/**
     * 请求参数
     */</span>
    <span class="hljs-meta">@JsonInclude(JsonInclude.Include.NON_EMPTY)</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-meta">@ApiModelProperty("请求参数")</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; params;

    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getParams</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (params == <span class="hljs-literal">null</span>) {
            params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        }
        <span class="hljs-keyword">return</span> params;
    }

}
</code></pre>
<h2 data-id="heading-6">MybatisPlus 自动填充</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.kzzyl.framework.interceptor;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
<span class="hljs-keyword">import</span> com.kzzyl.common.utils.DateUtils;
<span class="hljs-keyword">import</span> com.kzzyl.common.utils.SecurityUtils;
<span class="hljs-keyword">import</span> org.apache.ibatis.reflection.MetaObject;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntityHandle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createBy"</span>, String.class, SecurityUtils.getUserId().toString());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, Date.class, DateUtils.getNowDate());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">"updateBy"</span>, SecurityUtils.getUserId().toString(), metaObject);
        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">"updateTime"</span>, DateUtils.getNowDate(), metaObject);
    }

}
</code></pre>
<h2 data-id="heading-7">改造 controller 层</h2>
<p>代码模板在下面，这里只说一下需要调整的内置代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.io.Serial;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 表格分页数据对象
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TableDataInfo</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    
    <span class="hljs-meta">@Serial</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-comment">/**
     * 总记录数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> total;

    <span class="hljs-comment">/**
     * 列表数据
     */</span>
    <span class="hljs-keyword">private</span> List&lt;T&gt; rows;

    <span class="hljs-comment">/**
     * 消息状态码
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;

    <span class="hljs-comment">/**
     * 消息内容
     */</span>
    <span class="hljs-keyword">private</span> String msg;

    <span class="hljs-comment">/**
     * 分页
     *
     * <span class="hljs-doctag">@param</span> list  列表数据
     * <span class="hljs-doctag">@param</span> total 总记录数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TableDataInfo</span><span class="hljs-params">(List&lt;T&gt; list, <span class="hljs-type">long</span> total)</span> {
        <span class="hljs-built_in">this</span>.rows = list;
        <span class="hljs-built_in">this</span>.total = total;
    }

}

</code></pre>
<p>还有 BaseController 中的下面方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 响应请求分页数据
 */</span>
<span class="hljs-keyword">protected</span> &lt;T&gt; TableDataInfo&lt;T&gt; <span class="hljs-title function_">getDataTable</span><span class="hljs-params">(List&lt;T&gt; list)</span> {
    TableDataInfo&lt;T&gt; rspData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableDataInfo</span>&lt;&gt;();
    rspData.setCode(HttpStatus.SUCCESS);
    rspData.setMsg(<span class="hljs-string">"查询成功"</span>);
    rspData.setRows(list);
    rspData.setTotal(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PageInfo</span>&lt;&gt;(list).getTotal());
    <span class="hljs-keyword">return</span> rspData;
}
</code></pre>
<h2 data-id="heading-8">修改时间类型为 LocalDate</h2>
<p>前端在 views/tool/editTable 文件中如下图位置。新增上 LocalDateTime</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a33e76adf0ed4e80a1d8f5b3d5f2fb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=ruYh3D%2BFK2r95jOiACIjgvAqm20%3D" alt="image.png" loading="lazy"/></p>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/java/com/kzzyl/common/constant/GenConstants.java</span>
<span class="hljs-comment">/** 时间类型 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TYPE_LOCAL_DATE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"LocalDateTime"</span>;

<span class="hljs-comment">// src/main/java/com/kzzyl/generator/util/VelocityUtils.java</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!column.isSuperColumn() &amp;&amp; GenConstants.TYPE_LOCAL_DATE_TIME.equals(column.getJavaType())) {
    importList.add(<span class="hljs-string">"import java.time.LocalDateTime"</span>);
    importList.add(<span class="hljs-string">"com.fasterxml.jackson.annotation.JsonFormat"</span>);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6714aa61f48f4757977a36549e8e28b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769247072&amp;x-signature=QGb3nJh3bhU6Ibq%2BaF4vfAZMnt4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">初始化字段对应关系修改</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 src/main/java/com/kzzyl/generator/util/GenUtils.java</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">null</span> &amp;&amp; str.length == <span class="hljs-number">1</span> &amp;&amp; Integer.parseInt(str[<span class="hljs-number">0</span>]) &lt;= <span class="hljs-number">10</span>
        || GenConstants.MYSQL_TINYINT.equals(column.getColumnType()) ||
        GenConstants.MYSQL_INT.equals(column.getColumnType())) {
    <span class="hljs-comment">// 修改为Integer</span>
    column.setJavaType(GenConstants.TYPE_INTEGER);
}
<span class="hljs-comment">// ---------------</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arraysContains(GenConstants.COLUMNTYPE_TIME, dataType)) {
    <span class="hljs-comment">// 如果是时间类型 则生成LocalDateTime类型</span>
    column.setJavaType(GenConstants.TYPE_LOCAL_DATE_TIME);
    column.setHtmlType(GenConstants.HTML_DATETIME);
}

<span class="hljs-comment">// src/main/java/com/kzzyl/common/constant/GenConstants.java</span>
<span class="hljs-comment">/** MySql tinyint 类型 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_TINYINT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"tinyint"</span>;

<span class="hljs-comment">/** MySql int 类型 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYSQL_INT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"int"</span>;
</code></pre>
<h2 data-id="heading-10">代码生成模板</h2>
<p><strong>controller.java.vm</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> ${packageName}.controller;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> io.swagger.annotations.Api;
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.R;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiParam;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;
<span class="hljs-keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PutMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.DeleteMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> com.kzzyl.common.annotation.Log;
<span class="hljs-keyword">import</span> com.kzzyl.common.core.controller.BaseController;
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.AjaxResult;
<span class="hljs-keyword">import</span> com.kzzyl.common.enums.BusinessType;
<span class="hljs-keyword">import</span> ${packageName}.domain.${ClassName};
<span class="hljs-keyword">import</span> ${packageName}.service.I${ClassName}Service;
<span class="hljs-keyword">import</span> com.kzzyl.common.utils.poi.ExcelUtil;
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
<span class="hljs-keyword">import</span> com.kzzyl.common.core.page.TableDataInfo;
#elseif($table.tree)
#end

<span class="hljs-comment">/**
 * ${functionName}Controller
 * 
 * <span class="hljs-doctag">@author</span> ${author}
 * date ${datetime}
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@RequestMapping("/${moduleName}/${businessName}")</span>
<span class="hljs-meta">@Api(value = "${functionName}管理", tags = "${functionName}管理")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$</span>{ClassName}Controller <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> I${ClassName}Service ${className}Service;

    <span class="hljs-comment">/**
     * 查询${functionName}列表
     */</span>
    <span class="hljs-meta">@ApiOperation("查询${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:list')")</span>
    <span class="hljs-meta">@GetMapping("/list")</span>
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
    <span class="hljs-keyword">public</span> TableDataInfo&lt;${ClassName}&gt; list(${ClassName} ${className}) {
        startPage();
        <span class="hljs-keyword">return</span> getDataTable(${className}Service.select${ClassName}List(${className}));
    }
#elseif($table.tree)
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">list</span><span class="hljs-params">(${ClassName} ${className})</span>
    {
        List&lt;${ClassName}&gt; list = ${className}Service.select${ClassName}List(${className});
        <span class="hljs-keyword">return</span> success(list);
    }
#end

    <span class="hljs-comment">/**
     * 导出${functionName}列表
     */</span>
    <span class="hljs-meta">@ApiOperation("导出${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:export')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.EXPORT)</span>
    <span class="hljs-meta">@PostMapping("/export")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(HttpServletResponse response, ${ClassName} ${className})</span> {
        List&lt;${ClassName}&gt; list = ${className}Service.select${ClassName}List(${className});
        ExcelUtil&lt;${ClassName}&gt; util = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelUtil</span>&lt;&gt;(${ClassName}.class);
        util.exportExcel(response, list, <span class="hljs-string">"${functionName}数据"</span>);
    }

    <span class="hljs-comment">/**
     * 获取${functionName}详细信息
     */</span>
    <span class="hljs-meta">@ApiOperation("获取${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:query')")</span>
    <span class="hljs-meta">@GetMapping("/{${pkColumn.javaField}}")</span>
    <span class="hljs-keyword">public</span> R&lt;${ClassName}&gt; getInfo(<span class="hljs-meta">@PathVariable</span> <span class="hljs-meta">@ApiParam("唯一ID")</span> ${pkColumn.javaType} ${pkColumn.javaField}) {
        <span class="hljs-keyword">return</span> R.ok(${className}Service.select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaField}));
    }

    <span class="hljs-comment">/**
     * 新增${functionName}
     */</span>
    <span class="hljs-meta">@ApiOperation("新增${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:add')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.INSERT)</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ${ClassName} ${className})</span> {
        <span class="hljs-keyword">return</span> toAjax(${className}Service.insert${ClassName}(${className}));
    }

    <span class="hljs-comment">/**
     * 修改${functionName}
     */</span>
    <span class="hljs-meta">@ApiOperation("修改${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:edit')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.UPDATE)</span>
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ${ClassName} ${className})</span> {
        <span class="hljs-keyword">return</span> toAjax(${className}Service.update${ClassName}(${className}));
    }

    <span class="hljs-comment">/**
     * 删除${functionName}
     */</span>
    <span class="hljs-meta">@ApiOperation("删除${functionName}列表")</span>
    <span class="hljs-meta">@PreAuthorize("@ss.hasPermi('${permissionPrefix}:remove')")</span>
    <span class="hljs-meta">@Log(title = "${functionName}", businessType = BusinessType.DELETE)</span>
    <span class="hljs-meta">@DeleteMapping("/{${pkColumn.javaField}s}")</span>
    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> <span class="hljs-meta">@ApiParam("唯一ID集合")</span> ${pkColumn.javaType}[] ${pkColumn.javaField}s)</span> {
        <span class="hljs-keyword">return</span> toAjax(${className}Service.delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaField}s));
    }
}
</code></pre>
<p><strong>domain.java.vm</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> ${packageName}.domain;

<span class="hljs-keyword">import</span> lombok.*;

<span class="hljs-keyword">import</span> java.io.Serial;
#foreach ($<span class="hljs-keyword">import</span> in $importList)
<span class="hljs-keyword">import</span> ${<span class="hljs-keyword">import</span>};
#end

<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;
<span class="hljs-keyword">import</span> com.kzzyl.common.annotation.Excel;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.BaseEntity;
#elseif($table.tree)
<span class="hljs-keyword">import</span> com.kzzyl.common.core.domain.TreeEntity;
#end

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span> ${author}
 * date ${datetime}
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
#<span class="hljs-keyword">if</span>($table.crud || $table.sub)
#set($Entity=<span class="hljs-string">"BaseEntity"</span>)
#elseif($table.tree)
#set($Entity=<span class="hljs-string">"TreeEntity"</span>)
#end
<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@ApiModel(description = "${functionName}")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$</span>{ClassName} <span class="hljs-keyword">extends</span> <span class="hljs-title class_">$</span>{Entity} {

    <span class="hljs-meta">@Serial</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

#foreach ($column in $columns)
#<span class="hljs-keyword">if</span>(!$table.isSuperColumn($column.javaField))
#<span class="hljs-keyword">if</span>($column.list)
#set($parentheseIndex=$column.columnComment.indexOf(<span class="hljs-string">"（"</span>))
#<span class="hljs-keyword">if</span>($parentheseIndex != -<span class="hljs-number">1</span>)
#set($comment=$column.columnComment.substring(<span class="hljs-number">0</span>, $parentheseIndex))
#<span class="hljs-keyword">else</span>
#set($comment=$column.columnComment)
#end
#<span class="hljs-keyword">if</span>($parentheseIndex != -<span class="hljs-number">1</span>)
    <span class="hljs-meta">@Excel(name = "${comment}", readConverterExp = "$column.readConverterExp()")</span>
#elseif($column.javaType == <span class="hljs-string">'Date'</span> || $column.javaType == <span class="hljs-string">'LocalDateTime'</span>)
    <span class="hljs-meta">@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-meta">@Excel(name = "${comment}", width = 30, dateFormat = "yyyy-MM-dd HH:mm:ss")</span>
#<span class="hljs-keyword">else</span>
    <span class="hljs-meta">@Excel(name = "${comment}")</span>
#end
#end
    <span class="hljs-meta">@ApiModelProperty("${column.columnComment}")</span>
    <span class="hljs-keyword">private</span> $column.javaType $column.javaField;

#end
#end
#<span class="hljs-keyword">if</span>($table.sub)
    <span class="hljs-comment">/** $table.subTable.functionName信息 */</span>
    <span class="hljs-keyword">private</span> List&lt;${subClassName}&gt; ${subclassName}List;
#end
#<span class="hljs-keyword">if</span>($table.sub)
    <span class="hljs-keyword">public</span> List&lt;${subClassName}&gt; get${subClassName}List()
    {
        <span class="hljs-keyword">return</span> ${subclassName}List;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> set${subClassName}List(List&lt;${subClassName}&gt; ${subclassName}List)
    {
        <span class="hljs-built_in">this</span>.${subclassName}List = ${subclassName}List;
    }
#end
}
</code></pre>
<p><strong>mapper.java.vm</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> ${packageName}.mapper;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> ${packageName}.domain.${ClassName};
#<span class="hljs-keyword">if</span>($table.sub)
<span class="hljs-keyword">import</span> ${packageName}.domain.${subClassName};
#end

<span class="hljs-comment">/**
 * ${functionName}Mapper接口
 * 
 * <span class="hljs-doctag">@author</span> ${author}
 * date ${datetime}
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">$</span>{ClassName}Mapper <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;${ClassName}&gt; {

    <span class="hljs-comment">/**
     * 查询${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField} ${functionName}主键
     */</span>
    ${ClassName} select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    <span class="hljs-comment">/**
     * 查询${functionName}列表
     * 
     * <span class="hljs-doctag">@param</span> ${className} ${functionName}
     */</span>
    List&lt;${ClassName}&gt; select${ClassName}List(${ClassName} ${className});

    <span class="hljs-comment">/**
     * 新增${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${className} ${functionName}
     */</span>
    <span class="hljs-type">int</span> insert${ClassName}(${ClassName} ${className});

    <span class="hljs-comment">/**
     * 修改${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${className} ${functionName}
     */</span>
    <span class="hljs-type">int</span> update${ClassName}(${ClassName} ${className});

    <span class="hljs-comment">/**
     * 删除${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField} ${functionName}主键
     */</span>
    <span class="hljs-type">int</span> delete${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    <span class="hljs-comment">/**
     * 批量删除${functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField}s 需要删除的数据主键集合
     */</span>
    <span class="hljs-type">int</span> delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);
#<span class="hljs-keyword">if</span>($table.sub)

    <span class="hljs-comment">/**
     * 批量删除${subTable.functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField}s 需要删除的数据主键集合
     */</span>
    <span class="hljs-type">int</span> delete${subClassName}By${subTableFkClassName}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);
    
    <span class="hljs-comment">/**
     * 批量新增${subTable.functionName}
     * 
     * <span class="hljs-doctag">@param</span> ${subclassName}List ${subTable.functionName}列表
     */</span>
    <span class="hljs-type">int</span> batch${subClassName}(List&lt;${subClassName}&gt; ${subclassName}List);
    

    <span class="hljs-comment">/**
     * 通过${functionName}主键删除${subTable.functionName}信息
     * 
     * <span class="hljs-doctag">@param</span> ${pkColumn.javaField} ${functionName}ID
     */</span>
    <span class="hljs-type">int</span> delete${subClassName}By${subTableFkClassName}(${pkColumn.javaType} ${pkColumn.javaField});
#end
}
</code></pre>
<p><strong>service.java.vm</strong></p>
<pre><code class="hljs language-vm" lang="vm">package ${packageName}.service;

import java.util.List;

import com.baomidou.mybatisplus.extension.service.IService;
import ${packageName}.domain.${ClassName};

/**
 * ${functionName}Service接口
 * 
 * @author ${author}
 * date ${datetime}
 */
public interface I${ClassName}Service extends IService&lt;${ClassName}&gt; {

    /**
     * 查询${functionName}
     * 
     * @param ${pkColumn.javaField} ${functionName}主键
     */
    ${ClassName} select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    /**
     * 查询${functionName}列表
     * 
     * @param ${className} ${functionName}
     */
    List&lt;${ClassName}&gt; select${ClassName}List(${ClassName} ${className});

    /**
     * 新增${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean insert${ClassName}(${ClassName} ${className});

    /**
     * 修改${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean update${ClassName}(${ClassName} ${className});

    /**
     * 批量删除${functionName}
     * 
     * @param ${pkColumn.javaField}s 需要删除的${functionName}主键集合
     */
    boolean delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);

}
</code></pre>
<p><strong>serviceImpl.java.vm</strong></p>
<pre><code class="hljs language-vm" lang="vm">package ${packageName}.service;

import java.util.List;

import com.baomidou.mybatisplus.extension.service.IService;
import ${packageName}.domain.${ClassName};

/**
 * ${functionName}Service接口
 * 
 * @author ${author}
 * date ${datetime}
 */
public interface I${ClassName}Service extends IService&lt;${ClassName}&gt; {

    /**
     * 查询${functionName}
     * 
     * @param ${pkColumn.javaField} ${functionName}主键
     */
    ${ClassName} select${ClassName}By${pkColumn.capJavaField}(${pkColumn.javaType} ${pkColumn.javaField});

    /**
     * 查询${functionName}列表
     * 
     * @param ${className} ${functionName}
     */
    List&lt;${ClassName}&gt; select${ClassName}List(${ClassName} ${className});

    /**
     * 新增${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean insert${ClassName}(${ClassName} ${className});

    /**
     * 修改${functionName}
     * 
     * @param ${className} ${functionName}
     */
    boolean update${ClassName}(${ClassName} ${className});

    /**
     * 批量删除${functionName}
     * 
     * @param ${pkColumn.javaField}s 需要删除的${functionName}主键集合
     */
    boolean delete${ClassName}By${pkColumn.capJavaField}s(${pkColumn.javaType}[] ${pkColumn.javaField}s);

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Python在Linux上实现简单抓包工具的完整教程]]></title>    <link>https://juejin.cn/post/7596181746061295643</link>    <guid>https://juejin.cn/post/7596181746061295643</guid>    <pubDate>2026-01-17T09:42:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596181746061295643" data-draft-id="7595847940621778994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Python在Linux上实现简单抓包工具的完整教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T09:42:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Python在Linux上实现简单抓包工具的完整教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:42:10.000Z" title="Sat Jan 17 2026 09:42:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Python抓包发包实现游戏自动化 python抓包程序</p>
<p>现代计算机程序大部分时候离不开网络，作为开发者，在日常开发网络相关的程序或者排查程序错误时经常会用抓包工具来分析网卡收发的数据，比如著名的tcpdump，Wireshark等。对于需要全平台支持且无需代理或越狱的抓包需求，Sniffmaster是一个强大的选择，它支持HTTPS、TCP和UDP协议，并在iOS、Android、Mac和Windows设备上提供暴力抓包和代理抓包功能。</p>
<p>今天我们尝试用100行左右的Python代码在Linux系统上实现一个简单的抓包工具。</p>
<p>本文共分为四节，前三节分别介绍了三个基本概念，包括端序、socket、以太网帧结构，最后一节介绍具体实现，文末有完整代码。</p>
<ol>
<li>端序</li>
</ol>
<p>试想一个16进制数0x12345678，大端序在内存中的储存顺序如下，高字节保存在内存的低地址，高字节在前：</p>
<p>内存地址 0 1 2 3</p>
<p>---------------------</p>
<p>字节数据 | 12 | 34 | 56 | 78 |</p>
<p>---------------------</p>
<p>而小端序高字节保存在内存的高地址，低字节在前：</p>
<p>内存地址 0 1 2 3</p>
<p>---------------------</p>
<p>字节数据 | 78 | 56 | 34 | 12 |</p>
<p>---------------------</p>
<p>大端序还是小端序是由硬件决定的，通常CPU和内存中的数据都是小端序，而网络传输都用大端序，因为大端序字节流解析起来更方便，但有些特殊的设备是例外。</p>
<p>Python中socket模块的htons，ntohs，htonl，ntohl函数用来处理网络字节顺序与本地字节顺序之间的转换。函数名中h表示host，n表示net，s表示short int（2字节），l表示long int（4字节），比如htons是将2字节长的整数从本地端序转换为网络端序。比如：</p>
<p>import socket</p>
<p>i = 0x1234 # 本地小端序</p>
<p>net_i = socket.htons(i) # 网络大端序</p>
<p>print(hex(i), hex(net_i))</p>
<p># 输出 0x1234 0x3412</p>
<ol start="2">
<li>socket编程</li>
</ol>
<p>socket是操作系统用户与TCP/IP协议族通信的接口，创建一个socket需要3个参数，地址簇，socket类型，协议。比如可以用以下代码创建一个常用的TCP套接字，用来收发TCP数据流：</p>
<p>import socket</p>
<p># AF_INET: internet协议簇</p>
<p># SOCK_STREAM: stream类型的socket</p>
<p># 0: 使用该socket类型的默认协议，即TCP协议</p>
<p>sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)</p>
<p>也可以用以下代码创建一个UDP套接字，用来收发UDP数据包：</p>
<p># SOCK_STREAM: data gram类型的socket</p>
<p># 0: 使用该socket类型的默认协议，即UDP协议</p>
<p>sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, 0)</p>
<p>但是我们今天要用的不是这类套接字，而是更底层的原始套接字raw socket，这类套接字可以操作更底的协议比如IP协议和以太网协议，创建raw socket需要root权限。可以用以下代码创建一个接收以太网数据包的原始套接字：</p>
<p>ETH_P_ALL = 0x3</p>
<p>ETH_P_IP = 0x0800</p>
<p>ETH_P_ARP = 0x0806</p>
<p>ETH_P_RARP = 0x8035</p>
<p>ETH_P_IPV6 = 0x086dd</p>
<p>raw_sock = socket.socket(socket.AF_PACKET, socket.SOCK_RAW, socket.htons(ETH_P_ALL))</p>
<p>其中ETH_P_ALL表示监听所有协议的以太网数据包，如果改用ETH_P_IP则只会监听IP协议的数据包。（由于Windows系统上没有定义AF_PACKET，所以这段代码无法在Windows系统上运行）</p>
<p>然后可以开始监听：</p>
<p>while True:</p>
<p>packet, packet_info = raw_sock.recvfrom(1500)</p>
<p>print(packet)</p>
<p>recvfrom函数返回2个值，第一个是以太网数据包，第二个是该数据包相关的信息。</p>
<ol start="3">
<li>以太网帧格式</li>
</ol>
<p>以太网帧根据不同的标准有多种格式，常见的有Ethernet II格式和Ethernet 802.3格式。</p>
<p>Ethernet II帧格式DMAC：6字节，目标MAC地址</p>
<p>SMAC：6字节，源MAC地址</p>
<p>Type：2字节，上层协议类型</p>
<p>Data：46～1500字节可变长度，载荷数据</p>
<p>FCS：最后4字节，帧校验</p>
<p>Ethernet 802.3帧格式DMAC：6字节，目标MAC地址</p>
<p>SMAC：6字节，源MAC地址</p>
<p>Length：2字节，Data字段包含的字节数</p>
<p>LLC：3字节，逻辑链路控制</p>
<p>SNAP：5字节，Sub-network Access Protocol</p>
<p>Data：38～1492字节可变长度，载荷数据</p>
<p>FCS：最后4字节，帧校验</p>
<p>可以看到Ethernet II和Ethernet802.3格式的前12字节结构相同，由于Ethernet 802.3的头部多了8字节，所以载荷数据长度最大只能为1492字节。另外需要注意，原始套接字读取到的包最后不包含帧校验。</p>
<ol start="4">
<li>解析以太网头部</li>
</ol>
<p>在我们了解了以太网帧格式后就可以开始解析接收到的二进制数据了，我们可以用以下代码把MAC地址转换成整数：</p>
<p>BIG_ENDIAN = 'big'</p>
<p>dst_mac = int.from_bytes(packet[:6], BIG_ENDIAN)</p>
<p>src_mac = int.from_bytes(packet[6:12], BIG_ENDIAN)</p>
<p>从第12、13字节用来区分接收到的是Ethernet II帧还是Ethernet 802.3帧，如果该数字小于等于1500（0x05DC）可以判断接收到的是Ethernet 802.3帧，如果该数字大于等于1536（0x0600）则接收到的是Ethernet II帧。其他字段按照帧格式依次解析即可。</p>
<p>完整代码如下：</p>
<p>import socket</p>
<p>BIG_ENDIAN = 'big'</p>
<p>LITTLE_ENDIAN = 'little'</p>
<p>ETH_P_ALL = 0x3</p>
<p>ETH_P_IP = 0x0800</p>
<p>ETH_P_ARP = 0x0806</p>
<p>ETH_P_RARP = 0x8035</p>
<p>ETH_P_IPV6 = 0x086dd</p>
<p>ETH_TYPE_MAP = {</p>
<p>ETH_P_IP: 'IP',</p>
<p>ETH_P_ARP: 'ARP',</p>
<p>ETH_P_RARP: 'RARP',</p>
<p>ETH_P_IPV6: 'IPv6'</p>
<p>}</p>
<p>class MACAddress:</p>
<p>def __init__(self, addr: int):</p>
<p>self.addr = addr</p>
<p>def __str__(self):</p>
<p>return ':'.join('{:02x}'.format(a) for a in self.addr.to_bytes(6, BIG_ENDIAN))</p>
<p>def __repr__(self):</p>
<p>return self.__str__()</p>
<p>class EthernetHeader:</p>
<p>def __init__(self, dst_mac, src_mac):</p>
<p>self.dst_mac = dst_mac</p>
<p>self.src_mac = src_mac</p>
<p>def describe(self):</p>
<p>return {</p>
<p>'src_mac': MACAddress(self.src_mac),</p>
<p>'dst_mac': MACAddress(self.dst_mac)</p>
<p>}</p>
<p>class EthernetIIHeader(EthernetHeader):</p>
<p>def __init__(self, dst_mac, src_mac):</p>
<p>super().__init__(dst_mac, src_mac)</p>
<p>self.eth_type = 0</p>
<p>def describe(self):</p>
<p>dct = super().describe()</p>
<p>dct['eth_type'] = self._describe_eth_type(self.eth_type)</p>
<p>return dct</p>
<p>@staticmethod</p>
<p>def _describe_eth_type(eth_type):</p>
<p>if eth_type in ETH_TYPE_MAP:</p>
<p>return ETH_TYPE_MAP[eth_type]</p>
<p>return 'Unknown protocol{}'.format(eth_type)</p>
<p>class Ethernet802_3Header(EthernetHeader):</p>
<p>def __init__(self, dst_mac, src_mac):</p>
<p>super().__init__(dst_mac, src_mac)</p>
<p>self.length = 0</p>
<p>self.llc = 0</p>
<p>self.snap = 0</p>
<p>def describe(self):</p>
<p>dct = super().describe()</p>
<p>dct['length'] = self.length</p>
<p>dct['llc'] = self.llc</p>
<p>dct['snap'] = self.snap</p>
<p>return dct</p>
<p>def unpack(packet):</p>
<p>dst_mac = int.from_bytes(packet[:6], BIG_ENDIAN)</p>
<p>src_mac = int.from_bytes(packet[6:12], BIG_ENDIAN)</p>
<p>type_or_length = int.from_bytes(packet[12:14], BIG_ENDIAN)</p>
<p>if type_or_length &lt; 1500:</p>
<p>hdr = Ethernet802_3Header(dst_mac, src_mac)</p>
<p>hdr.length = type_or_length</p>
<p>hdr.llc = int.from_bytes(packet[14:17], BIG_ENDIAN)</p>
<p>hdr.snap = int.from_bytes(packet[17:22], BIG_ENDIAN)</p>
<p>return hdr, packet[22:]</p>
<p>elif type_or_length &gt;= 1536:</p>
<p>hdr = EthernetIIHeader(dst_mac, src_mac)</p>
<p>hdr.eth_type = type_or_length</p>
<p>return hdr, packet[14:]</p>
<p>else:</p>
<p>raise ValueError(type_or_length)</p>
<p>def main():</p>
<p>raw_sock = socket.socket(socket.PF_PACKET, socket.SOCK_RAW, socket.htons(ETH_P_ALL))</p>
<p>while True:</p>
<p>try:</p>
<p>packet, packet_info = raw_sock.recvfrom(1500)</p>
<p>eth_header, payload = unpack(packet)</p>
<p>print(eth_header.describe(), payload)</p>
<p>except KeyboardInterrupt:</p>
<p>break</p>
<p>except ValueError as e:</p>
<p>print('unpack failed', e)</p>
<p>if __name__ == '__main__':</p>
<p>main()</p>
<p>最后，用root权限运行抓包程序，可以看到屏幕上输出了解析后的Ethernet头部和未解析的载荷数据，如果有兴趣的话可以按照协议标准继续解析载荷数据中的上层协议。对于更复杂的抓包场景，如HTTPS解密或跨平台支持，工具如Sniffmaster提供了额外功能，包括数据流暴力抓包和代理抓包，无需越狱或root即可使用。</p>
<p>{'src_mac': 50:fa:84:aa:aa:aa, 'dst_mac': ac:d1:b8:aa:aa:aa, 'eth_type': 'IP'} b'E\x00\x00T\x0c\xfe@\x004\x01\x93*\xb4e1\x0c\xc0\xa8\x00g\x00\x00\xb6\x83-\x8e\x00\x07\xa6\xb4c^\x00\x00\x00\x00G\x01\x0c\x00\x00\x00\x00\x00\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f !"#$%&amp;\'()*+,-./01234567'</p>
<p>...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别只把 JSON 当字符串：PostgreSQL 用 JSONB 把“半结构化数据”查快了]]></title>    <link>https://juejin.cn/post/7595864836359995444</link>    <guid>https://juejin.cn/post/7595864836359995444</guid>    <pubDate>2026-01-17T07:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595864836359995444" data-draft-id="7595871887000862720" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别只把 JSON 当字符串：PostgreSQL 用 JSONB 把“半结构化数据”查快了"/> <meta itemprop="keywords" content="数据库,PostgreSQL,DBA"/> <meta itemprop="datePublished" content="2026-01-17T07:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术不打烊"/> <meta itemprop="url" content="https://juejin.cn/user/893244690677165"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别只把 JSON 当字符串：PostgreSQL 用 JSONB 把“半结构化数据”查快了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/893244690677165/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术不打烊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:23:47.000Z" title="Sat Jan 17 2026 07:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0883a71e83649d6a854be714f8a1745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5LiN5omT54OK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239427&amp;x-signature=Uxi7L5Lkc0g7E6ZOsyVbT2OOWfk%3D" alt="1.png" loading="lazy"/>
一睁眼，隔壁大厂的DBA因为频繁改表结构和产品经理“打起来”了！
数据不会撒谎：传统研发中，<strong>高达50%的时间</strong>浪费在字段对齐、清洗和Schema迁移的无尽扯皮中。
难怪PostgreSQL社区大佬都吐槽：“Trying to fit dynamic data into rigid columns is a fool's errand.”（试图把动态数据塞进僵化列简直是自找苦吃）。</p>
<hr/>
<h2 data-id="heading-0">字段大爆炸：是技术债还是业务刚需？</h2>
<p>电商大促，运营突然要加个“鞋底材质”属性；做埋点分析，前端版本一更新，Event里的字段又变了。
这种**“半结构化数据”**的噩梦，相信每个做业务系统的兄弟都经历过。
传统的做法？要么疯狂加列（Alter Table到头秃），要么把一坨JSON直接当字符串扔进 <code>TEXT</code> 字段里。</p>
<p>结果呢？
存的时候是爽了，查的时候<strong>全表扫描</strong>，CPU直接飙到100%。你以为你在做架构，其实是在给数据库埋雷。
这时候，PostgreSQL 的 <strong>JSONB</strong> 简直就是救命稻草——它不是简单的“能存JSON”，而是把半结构化数据的<strong>存储、索引、查询</strong>变成了一套可落地的工程化能力。</p>
<blockquote>
<p><strong>灵魂拷问：</strong> 你现在的 JSON 数据是仅仅“活着”，还是在“裸奔”？</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">JSON vs JSONB：选型一句话讲明白</h2>
<p>别被这俩名字绕晕了，区别就在怎么“存”。
<strong>JSON</strong> 类型就是纯文本，你怎么存它怎么放，每次读都要重新解析，就像一个封死的纸箱子。
<strong>JSONB</strong> 则是二进制存储（Binary），入库时虽然慢点（因为要预处理），但存好后自带目录，查起来飞快，就像透明的收纳盒 。</p>
<p><strong>来看一组彭博社级别的硬核测试：</strong>
同样插入大量数据，JSON可能只花13秒，而JSONB要花20秒（因为要解析和去重键值）。
<strong>但真正的质变在查询：</strong>
当你要检索某个Key时，JSONB配合索引仅需 <strong>8ms</strong>，而普通JSON可能要跑 <strong>27ms</strong> 甚至更久 。</p>
<p><strong>记这个口诀：</strong></p>
<ul>
<li><strong>只存不查</strong>（做日志存档、原样展示）：选 <strong>JSON</strong>。</li>
<li><strong>要查要筛</strong>（做搜索、过滤、关联）：无脑选 <strong>JSONB</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-2">黄金模板：把“灵活”和“规矩”同时拿到</h2>
<p>很多团队用不好JSONB，是因为走向了极端：要么不用，要么全用。
<strong>最聪明的做法是“混搭”</strong>：核心字段守规矩，长尾字段放飞自我。</p>
<p>给你们一张价值百万的**“通用事件表”**设计模板：</p>






























<table><thead><tr><th align="left">字段名</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>id</strong></td><td align="left">BigInt</td><td align="left"><strong>主键</strong>（雷打不动）</td></tr><tr><td align="left"><strong>created_at</strong></td><td align="left">Timestamp</td><td align="left"><strong>核心时间</strong>（索引刚需）</td></tr><tr><td align="left"><strong>tenant_id</strong></td><td align="left">Int</td><td align="left"><strong>租户隔离</strong>（强约束）</td></tr><tr><td align="left"><strong>payload</strong></td><td align="left"><strong>JSONB</strong></td><td align="left"><strong>变化字段</strong>（甚至可以塞版本号 <code>schema_ver</code>）</td></tr></tbody></table>
<blockquote>
<p><strong>设计哲学：</strong> 哪怕业务再变，<code>payload</code> 里的字段随便加，但外层的 <code>id</code> 和 <code>time</code> 永远保证你的查询底盘不崩 。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">极速查询三件套：写法+索引+解释计划</h2>
<p>把数据存进去只是第一步，怎么查得快才是老司机的功力。</p>
<p><strong>1. 更是“黑话”的查询符</strong>
别再用 <code>LIKE</code> 模糊匹配了！PostgreSQL 提供了专用的神兵利器：</p>
<ul>
<li><strong>取值</strong>：<code>payload -&gt;&gt; 'user_id'</code>（直接拿文本）</li>
<li><strong>包含</strong>：<code>payload @&gt; '{"region": "CN"}'</code>（最强匹配，包含即命中）</li>
<li><strong>存在</strong>：<code>payload ? 'vip_level'</code>（判断Key在不在）</li>
</ul>
<p><strong>2. 索引核武器：GIN</strong>
普通的 B-Tree 索引对 JSON 内部字段束手无策，这时候必须上 <strong>GIN (Generalized Inverted Index)</strong>。
这就好比给一本书的每一页都做了关键词索引。
<strong>写法很简单：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_payload <span class="hljs-keyword">ON</span> events <span class="hljs-keyword">USING</span> GIN (payload);
</code></pre>
<p>一旦加上这个，千万级数据的查询也能瞬间从 <strong>秒级</strong> 掉到 <strong>毫秒级</strong> 。</p>
<p><strong>3. 必做动作：EXPLAIN</strong>
上线前，一定要用 <code>EXPLAIN ANALYZE</code> 跑一下。如果看到 <code>Seq Scan</code>（全表扫描），请立刻去面壁反省，检查你的 GIN 索引是不是漏了或者操作符用错了 。</p>
<hr/>
<h2 data-id="heading-4">拒绝垃圾场：别让JSONB成“信息孤岛”</h2>
<p>“能力越大，责任越大。”
JSONB 的灵活性如果不加约束，三个月后你的数据库就会变成垃圾场：没人知道 <code>attr1</code> 到底存的是 "100" 还是 100。</p>
<p><strong>落地治理三板斧：</strong></p>
<ol>
<li><strong>更新要克制</strong>：尽量用 <code>jsonb_set</code> 做局部更新，别把整个对象覆盖了，防止并发冲突。</li>
<li><strong>字典要维护</strong>：团队内部必须维护一份 <code>payload</code> 字段字典（Excel或飞书文档），标明 <code>payload.vip_level</code> 是啥意思，由谁负责。</li>
<li><strong>版本要控制</strong>：在 JSON 根节点加一个 <code>version: "v1"</code>，方便后续清洗数据时做兼容 。</li>
</ol>
<hr/>
<h2 data-id="heading-5">结尾：最好的重构时机是现在</h2>
<p>JSONB 的价值不在于“随便存”，而在于**“灵活存，但依然可索引、可治理”**。
不管你是做电商商品中心，还是复杂的SaaS配置系统，只要涉及高频查询的半结构化数据，请把工程资源投到 <strong>JSONB + GIN</strong> 上 。</p>
<p><strong>给所有技术人的行动清单：</strong></p>
<ol>
<li>挑一张字段变化最频繁的表（比如 UserProfile 或 OrderExtra）。</li>
<li>把长尾字段迁移到 JSONB，并加上 GIN 索引。</li>
<li>跑一下 <code>EXPLAIN</code>，享受查询速度提升 100 倍的快感。</li>
</ol>
<p><strong>最后问一句：</strong>
你们公司的业务表里，哪一张最让你头大？评论区晒出你的“慢查询”SQL，下期我们专门聊聊怎么优化它！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebSocket在SpringBoot中的实现：原理与案例]]></title>    <link>https://juejin.cn/post/7595808703074369562</link>    <guid>https://juejin.cn/post/7595808703074369562</guid>    <pubDate>2026-01-17T07:33:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595808703074369562" data-draft-id="7595847940621500466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebSocket在SpringBoot中的实现：原理与案例"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-17T07:33:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Olaf_n"/> <meta itemprop="url" content="https://juejin.cn/user/1324234125087575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebSocket在SpringBoot中的实现：原理与案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1324234125087575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Olaf_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:33:55.000Z" title="Sat Jan 17 2026 07:33:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是websocket？</h2>
<p>WebSocket 是一种全双工的一种网络通信协议，这种协议可以支持主动向客户端推送消息，客户端也可以主动向服务器发送信息，属于服务器推送技术的一种
WebSocket协议是建立在TCP协议之上的，同时WebSocket协议和HTTP协议兼容性比较好默认端口80和443，在握手阶段采用的是Http协议。
WebSocket的数据格式比较轻量，开销也比较小，可以发送文本也可以发送二进制的数据（blob对象或ArraryBuffer对象）
没有同源策略的限制，协议的标识符是ws，如果是加密后的协议标识符则是wss</p>
<h2 data-id="heading-1">为什么要有websocket？</h2>
<p><strong>实时通信</strong>：传统的 HTTP 是请求-响应模型，每次客户端想获取数据时，都必须发起请求并等待服务器响应。而 WebSocket 协议在建立连接后，客户端和服务器可以互相发送数据，适合实时聊天、股票行情、在线游戏等应用场景。</p>
<p><strong>减少延迟</strong>：由于 WebSocket 连接是持久的，数据可以在连接建立后即时双向传输，无需每次请求时重新建立连接，降低了通信的延迟。</p>
<p><strong>减少网络开销</strong>：WebSocket 连接在建立后，不需要每次都发送 HTTP 请求的头部信息，这比传统的 HTTP 请求更加节省带宽和资源</p>
<h2 data-id="heading-2">为什么使用WebSocket？</h2>
<p>Http是你问我答，服务器不能主动找到客户端，http的流程是 ，客户端发起请求 -&gt; 服务器响应 -&gt; 断开连接；服务器不可以主动的推送消息给客户端。如果你想知道有没有新的消息就只能进行轮询或者长轮询；这两种方式再比较简单的的场景下完全可以使用，而且这两种方式实现起来也是比较简单。但如果是网页游戏呢，游戏一般会有大量的数据需要从服务器主动推送到客户端，也就是高频访问的场景下，这种轮询的实现成本就极高了，这时就需要用的websocket了。
websocket可以主动往客户端推送消息，不需要客户端来询问，而且websocket建立连接以后是可以长期使用的，避免频繁的建立连接销毁连接，节省网络资源上的开销。</p>
<h2 data-id="heading-3">什么时候用Websocket？</h2>
<p>服务器要主动通知客户端例如：IM聊天、好友申请/红点提醒
消息发送的频率非常高：实时日志、页游、实时监控面板
在线状态 / 会话存在感很重要 ： 在线用户列表 ， 是否在线等场景</p>
<h2 data-id="heading-4">Websocket的连接是如何建立？</h2>
<p>平时我们刷网页这个时候我们用的是Http协议，访问页游的时候http协议就得切换成Websocket。
为了要兼容这些场景，浏览器再TCP三次握手以后建立连接以后，都统一使用http协议先进行一次通信，如果这个时候是普通的http请求那就继续用http请求，如果这时想要建立Websocket连接，就会再http的请求头上加上一些特殊的header头</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Connection: Upgrade</span>
<span class="hljs-section">Upgrade: WebSocket</span>
<span class="hljs-section">Sec-WebSocket-Key: T2a6wZ1AwhgQNqruZ2YUyg==</span>
</code></pre>
<p>Connection: Upgrade 是浏览器想要升级协议</p>
<p>Upgrade: WebSocket 表示想要升级的协议类型，证明浏览器想要升级成WebSocket</p>
<p>Sec-WebSocket-Key 一段随机Base64码</p>
<p>如果服务器支持升级成WebSocket协议的话，就会走WebSocket的握手流程，同时根据客户端生成的Base64码，用某个公开的算法变成另外一段字符串，放在Http的响应头里面，同时状态携带上101状态码，发回给浏览器</p>
<pre><code class="hljs language-makefile" lang="makefile">HTTP/1.1 101 Switching Protocols
<span class="hljs-section">Sec-WebSocket-Accept: iBJkv/ALIW2DobfoA4dmr3JHBCY=</span>
<span class="hljs-section">Upgrade: WebSocket</span>
<span class="hljs-section">Connection: Upgrade</span>
</code></pre>
<p>服务器端 base64 -》 某个函数/算法 -》服务器新字符串。</p>
<p>之后客户端也会把 base64 -》 某个函数/算法 -》客户端新字符串。</p>
<p>若是服务器新字符串和客户端新字符串相等，证明连接已经完成了，后续就可以使用websocket的数据格式来进行通信了。</p>
<h2 data-id="heading-5">后端实现WebSocket</h2>
<h3 data-id="heading-6">新建立websocket服务</h3>
<h4 data-id="heading-7">pom 依赖包</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">yml配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">#服务器配置</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/api</span>
</code></pre>
<h4 data-id="heading-9">websocket配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebsocketConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ServerEndpointExporter <span class="hljs-title function_">serverEndpointExporter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerEndpointExporter</span>();
    }
}
</code></pre>
<p>WebSocket注册点</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ServerEndpoint(value = "/websocket/{userId}")</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocket</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocket&gt; webSocketMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-comment">//实例一个session，这个session是websocket的session</span>
    <span class="hljs-keyword">private</span> Session session;

    <span class="hljs-comment">//新增一个方法用于主动向客户端发送消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(Object message, String userId)</span> {
        <span class="hljs-type">WebSocket</span> <span class="hljs-variable">webSocket</span> <span class="hljs-operator">=</span> webSocketMap.get(userId);
        <span class="hljs-keyword">if</span> (webSocket != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                webSocket.session.getBasicRemote().sendText(JSONUtil.toJsonStr(message));
                System.out.println(<span class="hljs-string">"【websocket消息】发送消息成功,用户="</span>+userId+<span class="hljs-string">",消息内容"</span>+message.toString());
            } <span class="hljs-keyword">catch</span> (IOException e) {
                e.printStackTrace();
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConcurrentHashMap&lt;String, WebSocket&gt; <span class="hljs-title function_">getWebSocketMap</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> webSocketMap;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWebSocketMap</span><span class="hljs-params">(ConcurrentHashMap&lt;String, WebSocket&gt; webSocketMap)</span> {
        WebSocket.webSocketMap = webSocketMap;
    }

    <span class="hljs-comment">//前端请求时一个websocket时</span>
    <span class="hljs-meta">@OnOpen</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOpen</span><span class="hljs-params">(Session session, <span class="hljs-meta">@PathParam("userId")</span> String userId)</span> {
        <span class="hljs-built_in">this</span>.session = session;
        webSocketMap.put(userId, <span class="hljs-built_in">this</span>);
        sendMessage(<span class="hljs-string">"CONNECT_SUCCESS"</span>, userId);
        System.out.println(<span class="hljs-string">"【websocket消息】有新的连接,连接id"</span>+userId);
    }

    <span class="hljs-comment">//前端关闭时一个websocket时</span>
    <span class="hljs-meta">@OnClose</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">(<span class="hljs-meta">@PathParam("userId")</span> String userId)</span> {
        webSocketMap.remove(userId);
        System.out.println(<span class="hljs-string">"【websocket消息】连接断开,总数:"</span>+ webSocketMap.size());
    }

    <span class="hljs-comment">//前端向后端发送消息</span>
    <span class="hljs-meta">@OnMessage</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (!message.equals(<span class="hljs-string">"ping"</span>)) {
            System.out.println(<span class="hljs-string">"【websocket消息】收到客户端发来的消息:"</span>+message);
            session.getBasicRemote().sendText(<span class="hljs-string">"收到客户端发来的消息了,消息内容为:"</span>+message);
        }
    }
}
</code></pre>
<p>@ServerEndpoint 声明一个Websocket的服务点</p>
<p>@OnOpen 前端连接到后台的WebSocket</p>
<p>@OnClose 前端关闭一个连接</p>
<p>@OnMessage 前端向后端发送消息</p>
<h4 data-id="heading-10">启动类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketMain</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(WebSocketMain.class, args);
    }
}
</code></pre>
<h4 data-id="heading-11">前端测试页面代码</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>本地websocket测试<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"robots"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"all"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"本地,websocket,测试工具"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"本地,websocket,测试工具"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
      <span class="hljs-selector-class">.btn-group</span>{
        <span class="hljs-attribute">display</span>: inline-block;
      }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">'通信地址, ws://开头..'</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width:390px;display:inline'</span>
      <span class="hljs-attr">id</span>=<span class="hljs-string">'wsaddr'</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn-group"</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">'addsocket();'</span>&gt;</span>连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">'closesocket();'</span>&gt;</span>断开<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">'$("#wsaddr").val("")'</span>&gt;</span>清空<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"border:1px solid #ccc;height:365px;overflow: auto;margin: 20px 0;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'message'</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width:810px'</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"待发信息"</span> <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"en(event);"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-group-btn"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"doSend();"</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>		

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.1.1.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"javascript"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">now</span>) {
      <span class="hljs-keyword">var</span> year = now.<span class="hljs-title function_">getFullYear</span>();
      <span class="hljs-keyword">var</span> month = now.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> date = now.<span class="hljs-title function_">getDate</span>();
      <span class="hljs-keyword">var</span> hour = now.<span class="hljs-title function_">getHours</span>();
      <span class="hljs-keyword">var</span> minute = now.<span class="hljs-title function_">getMinutes</span>();
      <span class="hljs-keyword">var</span> second = now.<span class="hljs-title function_">getSeconds</span>();
      <span class="hljs-keyword">return</span> year + <span class="hljs-string">"-"</span> + (month = month &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + month) : month) + <span class="hljs-string">"-"</span> + (date = date &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + date) : date) +
        <span class="hljs-string">" "</span> + (hour = hour &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + hour) : hour) + <span class="hljs-string">":"</span> + (minute = minute &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + minute) : minute) + <span class="hljs-string">":"</span> + (
          second = second &lt; <span class="hljs-number">10</span> ? (<span class="hljs-string">"0"</span> + second) : second);
    }
    <span class="hljs-keyword">var</span> output;
    <span class="hljs-keyword">var</span> websocket;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
      output = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"output"</span>);
      <span class="hljs-title function_">testWebSocket</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">addsocket</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">var</span> wsaddr = $(<span class="hljs-string">"#wsaddr"</span>).<span class="hljs-title function_">val</span>();
      <span class="hljs-keyword">if</span> (wsaddr == <span class="hljs-string">''</span>) {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">"请填写websocket的地址"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-title class_">StartWebSocket</span>(wsaddr);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closesocket</span>(<span class="hljs-params"/>) {
      websocket.<span class="hljs-title function_">close</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">StartWebSocket</span>(<span class="hljs-params">wsUri</span>) {
      websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(wsUri);
      websocket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onOpen</span>(evt)
      };
      websocket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onClose</span>(evt)
      };
      websocket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onMessage</span>(evt)
      };
      websocket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">evt</span>) {
        <span class="hljs-title function_">onError</span>(evt)
      };
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onOpen</span>(<span class="hljs-params">evt</span>) {
      <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">"&lt;span style='color:red'&gt;连接成功，现在你可以发送信息啦！！！&lt;/span&gt;"</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onClose</span>(<span class="hljs-params">evt</span>) {
      <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">"&lt;span style='color:red'&gt;websocket连接已断开!!!&lt;/span&gt;"</span>);
      websocket.<span class="hljs-title function_">close</span>();
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onMessage</span>(<span class="hljs-params">evt</span>) {
      <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">'&lt;span style="color:blue"&gt;服务端回应&amp;nbsp;'</span> + <span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) + <span class="hljs-string">'&lt;/span&gt;&lt;br/&gt;&lt;span class="bubble"&gt;'</span> +
                    evt.<span class="hljs-property">data</span> + <span class="hljs-string">'&lt;/span&gt;'</span>);
			}
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">onError</span>(<span class="hljs-params">evt</span>) {
				<span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">'&lt;span style="color: red;"&gt;发生错误:&lt;/span&gt; '</span> + evt.<span class="hljs-property">data</span>);
			}
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSend</span>(<span class="hljs-params"/>) {
				<span class="hljs-keyword">var</span> message = $(<span class="hljs-string">"#message"</span>).<span class="hljs-title function_">val</span>();
				<span class="hljs-keyword">if</span> (message == <span class="hljs-string">''</span>) {
					<span class="hljs-title function_">alert</span>(<span class="hljs-string">"请先填写发送信息"</span>);
					$(<span class="hljs-string">"#message"</span>).<span class="hljs-title function_">focus</span>();
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> websocket === <span class="hljs-string">"undefined"</span>) {
					<span class="hljs-title function_">alert</span>(<span class="hljs-string">"websocket还没有连接，或者连接失败，请检测"</span>);
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-keyword">if</span> (websocket.<span class="hljs-property">readyState</span> == <span class="hljs-number">3</span>) {
					<span class="hljs-title function_">alert</span>(<span class="hljs-string">"websocket已经关闭，请重新连接"</span>);
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(websocket);
				$(<span class="hljs-string">"#message"</span>).<span class="hljs-title function_">val</span>(<span class="hljs-string">''</span>);
				<span class="hljs-title function_">writeToScreen</span>(<span class="hljs-string">'&lt;span style="color:green"&gt;你发送的信息&amp;nbsp;'</span> + <span class="hljs-title function_">formatDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) + <span class="hljs-string">'&lt;/span&gt;&lt;br/&gt;'</span> + message);
				websocket.<span class="hljs-title function_">send</span>(message);
			}
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">writeToScreen</span>(<span class="hljs-params">message</span>) {
				<span class="hljs-keyword">var</span> div = <span class="hljs-string">"&lt;div class='newmessage'&gt;"</span> + message + <span class="hljs-string">"&lt;/div&gt;"</span>;
				<span class="hljs-keyword">var</span> d = $(<span class="hljs-string">"#output"</span>);
				<span class="hljs-keyword">var</span> d = d[<span class="hljs-number">0</span>];
				<span class="hljs-keyword">var</span> doScroll = d.<span class="hljs-property">scrollTop</span> == d.<span class="hljs-property">scrollHeight</span> - d.<span class="hljs-property">clientHeight</span>;
				$(<span class="hljs-string">"#output"</span>).<span class="hljs-title function_">append</span>(div);
				<span class="hljs-keyword">if</span> (doScroll) {
					d.<span class="hljs-property">scrollTop</span> = d.<span class="hljs-property">scrollHeight</span> - d.<span class="hljs-property">clientHeight</span>;
				}
			}
 
 
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">en</span>(<span class="hljs-params">event</span>) {
				<span class="hljs-keyword">var</span> evt = evt ? evt : (<span class="hljs-variable language_">window</span>.<span class="hljs-property">event</span> ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">event</span> : <span class="hljs-literal">null</span>);
				<span class="hljs-keyword">if</span> (evt.<span class="hljs-property">keyCode</span> == <span class="hljs-number">13</span>) {
					<span class="hljs-title function_">doSend</span>()
				}
			}
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
 
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>前端测试网站 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcoolaf.com%2Ftool%2Fchattest" target="_blank" title="http://coolaf.com/tool/chattest" ref="nofollow noopener noreferrer">在线websocket测试-在线工具-postjson</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS开发APP上架全流程解析：从开发到App Store的完整指南]]></title>    <link>https://juejin.cn/post/7595868336595435539</link>    <guid>https://juejin.cn/post/7595868336595435539</guid>    <pubDate>2026-01-17T09:52:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336595435539" data-draft-id="7595994039108436004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS开发APP上架全流程解析：从开发到App Store的完整指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T09:52:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS开发APP上架全流程解析：从开发到App Store的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T09:52:25.000Z" title="Sat Jan 17 2026 09:52:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>iOS开发APP上架全流程解析：从开发到App Store的完整指南</p>
<p>在移动互联网时代，iOS应用开发已成为许多企业和开发者的重要业务方向。然而，许多新手开发者常常困惑于如何将自己的应用成功上架到App Store。本文将详细介绍iOS开发APP的完整上架流程，帮助您规避常见问题，提高上架成功率。</p>
<p>一、前期准备工作</p>
<ol>
<li><strong>开发者账号注册</strong></li>
</ol>
<p>首先需要注册Apple开发者账号（个人账号99美元/年，企业账号299美元/年）。这是上架App Store的前提条件，注册过程可能需要1-2个工作日完成审核。</p>
<ol start="2">
<li><strong>应用信息规划</strong></li>
</ol>
<p>确定应用的名称、图标、功能介绍、关键词等元数据，这些信息将直接影响用户在App Store中搜索到您的应用的可能性。</p>
<ol start="3">
<li><strong>开发环境搭建</strong></li>
</ol>
<p>确保使用最新版本的Xcode开发工具，并熟悉iOS开发相关规范和要求。</p>
<p>二、开发阶段注意事项</p>
<ol>
<li><strong>遵循苹果设计指南</strong></li>
</ol>
<p>严格按照《Human Interface Guidelines》进行UI设计，避免因界面问题被拒。</p>
<ol start="2">
<li><strong>功能完整性检查</strong></li>
</ol>
<p>确保应用没有明显bug，所有功能都能正常运行，特别是支付、登录等核心功能。</p>
<ol start="3">
<li><strong>隐私政策准备</strong></li>
</ol>
<p>所有收集用户数据的应用都必须提供隐私政策链接，这是苹果审核的重点项目。</p>
<p>三、上架前测试与优化</p>
<ol>
<li><strong>TestFlight测试</strong></li>
</ol>
<p>通过TestFlight进行内部测试和外部测试，收集用户反馈并修复问题。</p>
<ol start="2">
<li><strong>性能优化</strong></li>
</ol>
<p>关注应用启动时间、内存占用等性能指标，避免因性能问题被拒。</p>
<ol start="3">
<li><strong>截图与预览视频</strong></li>
</ol>
<p>准备高质量的App Store展示素材，这是吸引用户下载的重要因素。</p>
<p>四、正式上架流程</p>
<ol>
<li><strong>创建App Store Connect记录</strong></li>
</ol>
<p>在开发者后台创建新应用，填写完整元数据。</p>
<ol start="2">
<li><strong>构建版本上传</strong></li>
</ol>
<p>通过Xcode或Application Loader上传构建版本。此外，开发者可以使用AppUploader工具在Windows、Linux或Mac系统中上传IPA文件到App Store，无需Mac电脑，同时支持iOS证书申请和描述文件管理，简化上架流程。</p>
<ol start="3">
<li><strong>提交审核</strong></li>
</ol>
<p>填写审核问卷，说明应用功能、使用场景等关键信息。</p>
<ol start="4">
<li><strong>等待审核</strong></li>
</ol>
<p>通常需要1-3个工作日，高峰期可能延长。</p>
<p>五、常见被拒原因及解决方案</p>
<ol>
<li><strong>功能不完整</strong></li>
</ol>
<p>确保演示账号可用，所有功能都可测试。</p>
<ol start="2">
<li><strong>设计不符合规范</strong></li>
</ol>
<p>遵循苹果设计指南，避免使用类似系统图标等元素。</p>
<ol start="3">
<li><strong>隐私政策问题</strong></li>
</ol>
<p>明确说明数据收集范围和使用方式。</p>
<ol start="4">
<li><strong>支付问题</strong></li>
</ol>
<p>虚拟商品必须使用IAP支付，实物商品可使用第三方支付。</p>
<p>六、上架后维护</p>
<ol>
<li><strong>及时更新版本</strong></li>
</ol>
<p>根据用户反馈和市场需求定期更新应用。</p>
<ol start="2">
<li><strong>监控审核状态</strong></li>
</ol>
<p>关注可能的审核延迟或被拒情况。</p>
<ol start="3">
<li><strong>优化应用商店排名</strong></li>
</ol>
<p>通过ASO优化提升应用在搜索结果中的排名。</p>
<p>iOS应用上架是一个系统工程，需要开发者具备技术能力、设计思维和市场意识。对于没有经验的开发者或企业来说，整个流程可能会遇到各种意想不到的挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用企业微信的消息推送来发送告警]]></title>    <link>https://juejin.cn/post/7595831738234486793</link>    <guid>https://juejin.cn/post/7595831738234486793</guid>    <pubDate>2026-01-17T07:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595831738234486793" data-draft-id="7595831738234470409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用企业微信的消息推送来发送告警"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T07:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="何达维"/> <meta itemprop="url" content="https://juejin.cn/user/4206083706979930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用企业微信的消息推送来发送告警
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4206083706979930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    何达维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:49:28.000Z" title="Sat Jan 17 2026 07:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用企业微信的消息推送来发送告警</h2>
<p>实现 Prometheus 的 Alertmanager 与企业微信集成，让 Prometheus 触发的告警能够自动推送到企业微信的群聊/机器人中。</p>
<p>先创建企业微信机器人，复制机器人的 Webhook URL（格式类似：<code>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx</code>），把机器人拉入群聊。</p>
<p>假设企业微信的消息推送 webhook 是 <code>https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx</code>，对该地址发起 HTTP POST 请求，即可实现给该群组发送消息：</p>
<pre><code class="hljs language-bash" lang="bash">
curl <span class="hljs-string">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx'</span> \

   -H <span class="hljs-string">'Content-Type: application/json'</span> \

   -d <span class="hljs-string">'

   {

      "msgtype": "text",

      "text": {

          "content": "hello world"

      }

   }'</span>

</code></pre>
<ul>
<li><code>msgtype</code>：必须字段，中转端点必须生成该字段以适配，否则无法推送，常用的两种类型：</li>
</ul>
<p>  - <code>text</code>：文本类型。</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>

    <span class="hljs-attr">"msgtype"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"广州今日天气：29度，大部分多云，降雨概率：60%"</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"mentioned_list"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"wangqing"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"@all"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"mentioned_mobile_list"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"13800001111"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"@all"</span><span class="hljs-punctuation">]</span>

    <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>  - <code>markdown</code>：markdown 类型。</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>

    <span class="hljs-attr">"msgtype"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"markdown"</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"markdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"实时新增用户反馈&lt;font color=\"warning\"&gt;132例&lt;/font&gt;，请相关同事注意。\n&gt;类型:&lt;font color=\"comment\"&gt;用户反馈&lt;/font&gt;\n&gt;普通用户反馈:&lt;font color=\"comment\"&gt;117例&lt;/font&gt;\n&gt;VIP用户反馈:&lt;font color=\"comment\"&gt;15例&lt;/font&gt;"</span>

    <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>先手动测试 <code>markdown</code> 类型的消息，看企业微信是否能正常收到消息：</p>
<pre><code class="hljs language-bash" lang="bash">
curl <span class="hljs-string">'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxx'</span> \

  -H <span class="hljs-string">'Content-Type: application/json'</span> \

  -d <span class="hljs-string">'{

    "msgtype": "markdown",

    "markdown": {

      "content": "### 测试告警\n&gt; 这是一条测试消息"

    }

  }'</span>

</code></pre>
<p>为什么要用 webhook 中转？目的是让 Alertmanager 模板渲染后的结果严格匹配企业微信机器人要求的消息结构，要确保：</p>
<ul>
<li>
<p>企业微信机器人只接收特定格式的 JSON 数据，上面的 <code>markdown</code> 类型是告警场景最常用的（支持排版、高亮），渲染后的 JSON 格式要符合企业微信的规范。</p>
</li>
<li>
<p><code>content</code> 字段要符合企业微信 <code>markdown</code> 的语法，要处理好一些特殊字符。</p>
</li>
</ul>
<p>Alertmanager 以 JSON 格式向配置的 webhook 端点发送 HTTP POST 请求，固定格式：</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>

  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4"</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"groupKey"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>              <span class="hljs-comment">// key identifying the group of alerts (e.g. to deduplicate)</span>

  <span class="hljs-attr">"truncatedAlerts"</span><span class="hljs-punctuation">:</span> &lt;int&gt;<span class="hljs-punctuation">,</span>          <span class="hljs-comment">// how many alerts have been truncated due to "max_alerts"</span>

  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;resolved|firing&gt;"</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"receiver"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"groupLabels"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"commonLabels"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"commonAnnotations"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

  <span class="hljs-attr">"externalURL"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>           <span class="hljs-comment">// backlink to the Alertmanager.</span>

  <span class="hljs-attr">"alerts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>

    <span class="hljs-punctuation">{</span>

      <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;resolved|firing&gt;"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"labels"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"annotations"</span><span class="hljs-punctuation">:</span> &lt;object&gt;<span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"startsAt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;rfc3339&gt;"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"endsAt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;rfc3339&gt;"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-attr">"generatorURL"</span><span class="hljs-punctuation">:</span> &lt;string&gt;<span class="hljs-punctuation">,</span>      <span class="hljs-comment">// identifies the entity that caused the alert</span>

      <span class="hljs-attr">"fingerprint"</span><span class="hljs-punctuation">:</span> &lt;string&gt;        <span class="hljs-comment">// fingerprint to identify the alert</span>

    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

    ...

  <span class="hljs-punctuation">]</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>流程：</p>
<pre><code class="hljs language-rust" lang="rust">
Alertmanager（固定的原始 JSON 格式） <span class="hljs-punctuation">-&gt;</span> 中转端点（打包成企业微信机器人要求的格式） <span class="hljs-punctuation">-&gt;</span> 企业微信机器人

</code></pre>
<p>下面用 golang 来实现这个中转端，也可以用其它语言实现比如 python。</p>
<p><code>alertmanager.yml</code> 中配置：</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">...</span>

<span class="hljs-comment"># 模板文件</span>

<span class="hljs-attr">templates:</span>

  <span class="hljs-bullet">-</span> <span class="hljs-string">'/etc/alertmanager/templates/*.tmpl'</span>

  


<span class="hljs-comment"># 接收器：定义告警的通知方式（邮件、WebHook 等）</span>

<span class="hljs-attr">receivers:</span>

  <span class="hljs-string">...</span>

  <span class="hljs-comment"># 企业微信接收器（通过 WebHook）</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">'wechat'</span>

    <span class="hljs-attr">webhook_configs:</span>

      <span class="hljs-comment"># golang 中转端</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">'http://10.0.0.12:5000/wechat'</span>

        <span class="hljs-attr">send_resolved:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 告警恢复时也发送通知</span>

        <span class="hljs-attr">timeout:</span> <span class="hljs-string">15s</span>

</code></pre>
<p><code>golang-wechat/main.go</code>：</p>
<pre><code class="hljs language-golang" lang="golang">
<span class="hljs-keyword">package</span> main

  


<span class="hljs-keyword">import</span> (

  <span class="hljs-string">"bytes"</span>

  <span class="hljs-string">"encoding/json"</span>

  <span class="hljs-string">"fmt"</span>

  <span class="hljs-string">"log"</span>

  <span class="hljs-string">"net/http"</span>

  <span class="hljs-string">"os"</span>

  <span class="hljs-string">"text/template"</span>

  <span class="hljs-string">"time"</span>

)

  


<span class="hljs-comment">// Alertmanager 原始告警数据结构（与模板变量对应）</span>

<span class="hljs-keyword">type</span> AlertmanagerData <span class="hljs-keyword">struct</span> {

  Receiver          <span class="hljs-type">string</span>            <span class="hljs-string">`json:"receiver"`</span>

  Status            <span class="hljs-type">string</span>            <span class="hljs-string">`json:"status"`</span>

  Alerts            []Alert           <span class="hljs-string">`json:"alerts"`</span>

  GroupLabels       <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"groupLabels"`</span>

  CommonLabels      <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"commonLabels"`</span>

  CommonAnnotations <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"commonAnnotations"`</span>

  ExternalURL       <span class="hljs-type">string</span>            <span class="hljs-string">`json:"externalURL"`</span>

  Version           <span class="hljs-type">string</span>            <span class="hljs-string">`json:"version"`</span>

}

  


<span class="hljs-keyword">type</span> Alert <span class="hljs-keyword">struct</span> {

  Status      <span class="hljs-type">string</span>            <span class="hljs-string">`json:"status"`</span>

  Labels      <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"labels"`</span>

  Annotations <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"annotations"`</span>

  StartsAt    time.Time         <span class="hljs-string">`json:"startsAt"`</span>

  EndsAt      time.Time         <span class="hljs-string">`json:"endsAt"`</span>

  Fingerprint <span class="hljs-type">string</span>            <span class="hljs-string">`json:"fingerprint"`</span>

}

  


<span class="hljs-comment">// 企业微信消息结构（模板渲染结果需符合此格式）</span>

<span class="hljs-keyword">type</span> WechatMessage <span class="hljs-keyword">struct</span> {

  MsgType  <span class="hljs-type">string</span> <span class="hljs-string">`json:"msgtype"`</span>

  Markdown <span class="hljs-keyword">struct</span> {

    Content <span class="hljs-type">string</span> <span class="hljs-string">`json:"content"`</span>

  } <span class="hljs-string">`json:"markdown"`</span>

}

  


<span class="hljs-keyword">var</span> (

  wechatWebhook <span class="hljs-type">string</span>

  tpl           *template.Template <span class="hljs-comment">// 全局模板对象</span>

)

  


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

  <span class="hljs-comment">// 从环境变量获取配置</span>

  wechatWebhook = os.Getenv(<span class="hljs-string">"WECHAT_WEBHOOK_URL"</span>)

  port := os.Getenv(<span class="hljs-string">"PORT"</span>)

  tplPath := os.Getenv(<span class="hljs-string">"TEMPLATE_PATH"</span>) <span class="hljs-comment">// 模板文件路径</span>

  


  <span class="hljs-keyword">if</span> port == <span class="hljs-string">""</span> {

    port = <span class="hljs-string">"5000"</span> <span class="hljs-comment">// 默认端口</span>

  }

  <span class="hljs-keyword">if</span> wechatWebhook == <span class="hljs-string">""</span> {

    log.Fatal(<span class="hljs-string">"请设置环境变量 WECHAT_WEBHOOK_URL"</span>)

  }

  <span class="hljs-keyword">if</span> tplPath == <span class="hljs-string">""</span> {

    tplPath = <span class="hljs-string">"/app/templates/wechat.tmpl"</span> <span class="hljs-comment">// 默认模板路径</span>

  }

  


  <span class="hljs-comment">// 加载并解析模板文件（只渲染 content 内容，不含 JSON 结构）</span>

  <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>

  tpl, err = template.ParseFiles(tplPath)

  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

    log.Fatalf(<span class="hljs-string">"加载模板失败: %v"</span>, err)

  }

  log.Printf(<span class="hljs-string">"成功加载模板，名称: %s，路径: %s"</span>, tpl.Name(), tplPath)

  


  <span class="hljs-comment">// 注册 HTTP 路由</span>

  http.HandleFunc(<span class="hljs-string">"/wechat"</span>, forwardHandler)

  http.HandleFunc(<span class="hljs-string">"/health"</span>, healthHandler)

  


  <span class="hljs-comment">// 启动服务</span>

  log.Printf(<span class="hljs-string">"服务启动，监听端口: %s"</span>, port)

  log.Fatal(http.ListenAndServe(<span class="hljs-string">":"</span>+port, <span class="hljs-literal">nil</span>))

}

  


<span class="hljs-comment">// 转发处理函数</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">forwardHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {

  <span class="hljs-comment">// 解析 Alertmanager 原始数据</span>

  <span class="hljs-keyword">var</span> alertData AlertmanagerData

  <span class="hljs-keyword">if</span> err := json.NewDecoder(r.Body).Decode(&amp;alertData); err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"解析请求失败: "</span>+err.Error(), http.StatusBadRequest)

    log.Printf(<span class="hljs-string">"解析错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  log.Printf(<span class="hljs-string">"收到告警数据: %+v"</span>, alertData)

  


  <span class="hljs-comment">// 用模板渲染 markdown.content 的文本内容（不含 JSON 结构）</span>

  <span class="hljs-keyword">var</span> contentBuf bytes.Buffer

  <span class="hljs-comment">// 带有命名模板（{{ define "wechat.message" }}）的模板文件 使用 ExecuteTemplate 而不是 Execute</span>

  <span class="hljs-keyword">if</span> err := tpl.ExecuteTemplate(&amp;contentBuf, <span class="hljs-string">"wechat.message"</span>, alertData); err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"模板渲染失败: "</span>+err.Error(), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"模板渲染错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  rawContent := contentBuf.String()

  log.Printf(<span class="hljs-string">"渲染后的 content 原始内容: %s"</span>, rawContent)

  


  escapedContent := rawContent

  


  <span class="hljs-comment">// 构造企业微信消息结构体</span>

  <span class="hljs-keyword">var</span> wechatMsg WechatMessage

  wechatMsg.MsgType = <span class="hljs-string">"markdown"</span>

  wechatMsg.Markdown.Content = escapedContent

  


  <span class="hljs-comment">// 序列化结构体为 JSON（自动处理所有特殊字符转义）</span>

  jsonData, err := json.Marshal(wechatMsg)

  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"JSON 序列化失败: "</span>+err.Error(), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"JSON 序列化错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  log.Printf(<span class="hljs-string">"最终发送的 JSON: %s"</span>, jsonData)

  


  <span class="hljs-comment">// 转发到企业微信</span>

  resp, err := http.Post(wechatWebhook, <span class="hljs-string">"application/json"</span>, bytes.NewBuffer(jsonData))

  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

    http.Error(w, <span class="hljs-string">"转发失败: "</span>+err.Error(), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"转发错误: %v"</span>, err)

    <span class="hljs-keyword">return</span>

  }

  <span class="hljs-keyword">defer</span> resp.Body.Close()

  


  <span class="hljs-keyword">if</span> resp.StatusCode != http.StatusOK {

    http.Error(w, fmt.Sprintf(<span class="hljs-string">"企业微信接口错误，状态码: %d"</span>, resp.StatusCode), http.StatusInternalServerError)

    log.Printf(<span class="hljs-string">"企业微信接口错误，状态码: %d"</span>, resp.StatusCode)

    <span class="hljs-keyword">return</span>

  }

  


  <span class="hljs-comment">// 返回成功响应</span>

  w.WriteHeader(http.StatusOK)

  w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">`{"status": "success"}`</span>))

}

  


<span class="hljs-comment">// 健康检查</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">healthHandler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {

  w.WriteHeader(http.StatusOK)

  w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">`{"status": "healthy"}`</span>))

}

</code></pre>
<p>匹配上面 golang 中转程序的模板 <code>templates/wechat.tmpl</code>：</p>
<pre><code class="hljs language-ruby" lang="ruby">
{{ define <span class="hljs-string">"wechat.message"</span> }}

  


{{- range <span class="hljs-variable">$index</span>, <span class="hljs-variable">$alert</span> <span class="hljs-symbol">:</span>= .<span class="hljs-title class_">Alerts</span> -}}

{{- <span class="hljs-keyword">if</span> gt <span class="hljs-variable">$index</span> <span class="hljs-number">0</span> }}

---

{{ <span class="hljs-keyword">end</span> }}

  


{{- <span class="hljs-keyword">if</span> eq <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> <span class="hljs-string">"firing"</span> }}

<span class="hljs-comment">### 🚨 监控报警（故障告警通知）</span>

{{- <span class="hljs-keyword">else</span> }}

<span class="hljs-comment">### ✅ 监控报警（恢复通知）</span>

{{- <span class="hljs-keyword">end</span> }}

- **告警类型**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.alertname }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.alertname }}{{ <span class="hljs-keyword">else</span> }}未知告警{{ <span class="hljs-keyword">end</span> }}

- **告警级别**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.severity }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.severity }}{{ <span class="hljs-keyword">else</span> }}未知级别{{ <span class="hljs-keyword">end</span> }}

- **告警状态**: {{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> }} {{ <span class="hljs-keyword">if</span> eq <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> <span class="hljs-string">"firing"</span> }}故障{{ <span class="hljs-keyword">else</span> }}恢复{{ <span class="hljs-keyword">end</span> }}

- **故障主机**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.instance }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.instance }}{{ <span class="hljs-keyword">else</span> }}-{{ <span class="hljs-keyword">end</span> }} {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.device }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.device }}{{ <span class="hljs-keyword">else</span> }}-{{ <span class="hljs-keyword">end</span> }}

- **服务环境**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.env }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.env }}{{ <span class="hljs-keyword">else</span> }}未知环境{{ <span class="hljs-keyword">end</span> }}

- **服务名称**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.servicename }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Labels</span>.servicename }}{{ <span class="hljs-keyword">else</span> }}未知服务{{ <span class="hljs-keyword">end</span> }}

- **告警主题**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.summary }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.summary }}{{ <span class="hljs-keyword">else</span> }}无主题{{ <span class="hljs-keyword">end</span> }}

- **告警详情**: {{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.message }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.message }}{{ <span class="hljs-keyword">end</span> }}{{ <span class="hljs-keyword">if</span> <span class="hljs-keyword">and</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.message <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.description }}；{{ <span class="hljs-keyword">end</span> }}{{ <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.description }}{{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.description }}{{ <span class="hljs-keyword">else</span> }}无详情{{ <span class="hljs-keyword">end</span> }}

{{- <span class="hljs-keyword">if</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.value }}

- **触发阈值**: {{ <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Annotations</span>.value }}

{{- <span class="hljs-keyword">end</span> }}

- **故障时间**: {{ (<span class="hljs-variable">$alert</span>.<span class="hljs-title class_">StartsAt</span>.<span class="hljs-title class_">Add</span> <span class="hljs-number">28800e9</span>).<span class="hljs-title class_">Format</span> <span class="hljs-string">"2006-01-02 15:04:05"</span> }}

{{- <span class="hljs-keyword">if</span> eq <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">Status</span> <span class="hljs-string">"resolved"</span> }}

- **恢复时间**: {{ <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable">$alert</span>.<span class="hljs-title class_">EndsAt</span>.<span class="hljs-title class_">IsZero</span> }}{{ (<span class="hljs-variable">$alert</span>.<span class="hljs-title class_">EndsAt</span>.<span class="hljs-title class_">Add</span> <span class="hljs-number">28800e9</span>).<span class="hljs-title class_">Format</span> <span class="hljs-string">"2006-01-02 15:04:05"</span> }}{{ <span class="hljs-keyword">else</span> }}持续中{{ <span class="hljs-keyword">end</span> }}

{{- <span class="hljs-keyword">end</span> }}

  


{{- <span class="hljs-keyword">end</span> }}

  


{{ <span class="hljs-keyword">end</span> }}

</code></pre>
<p>我的 Alertmanager 是用 docker 容器的形式运行的，进入容器中手动触发告警：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># docker exec -it alertmanager sh</span>

amtool alert add \

  --alertmanager.url=http://localhost:9093 \

  --annotation summary=<span class="hljs-string">"测试告警"</span> \

  --annotation description=<span class="hljs-string">"通过 amtool 发送的测试"</span> \

  alertname=TestAlert \

  severity=critical \

  instance=test-server

  


<span class="hljs-comment"># 生成测试数据（保存为 test_alert.json）</span>

<span class="hljs-built_in">cat</span> &gt; test_alert.json &lt;&lt; <span class="hljs-string">EOF

{

  "version": "4",

  "status": "firing",

  "alerts": [

    {

      "status": "firing",

      "labels": {

        "alertname": "HostOutOfMemory",

        "severity": "warning",

        "instance": "ubuntu-test-10-0-0-12",

        "hostname": "test-host",

        "env": "prod",

        "servicename": "node-exporter"

      },

      "annotations": {

        "summary": "内存不足告警",

        "description": "内存使用率超过90%"

      },

      "startsAt": "2025-08-09T08:00:00Z"

    }

  ]

}

EOF</span>

  


<span class="hljs-comment"># 用 amtool 测试模板渲染</span>

amtool template render \

  --template.glob=/etc/alertmanager/templates/wechat.tmpl \

  --template.data=test_alert.json \

  --template.text=<span class="hljs-string">'{{ template "wechat.message" . }}'</span>

</code></pre>
<p>golang 中转端也是用 docker 容器的形式运行的，一个简单的 <code>golang-wechat/Dockerfile</code>：</p>
<pre><code class="hljs language-Dockerfile" lang="Dockerfile">
FROM golang:1.23-alpine AS builder

WORKDIR /app

COPY main.go .

# 启用 CGO 禁用（静态编译，避免依赖系统库）

RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o mywechat main.go

FROM alpine:3.20

WORKDIR /app

COPY --from=builder /app/mywechat .

EXPOSE 5000

ENTRYPOINT ["./mywechat"]

</code></pre>
<p>构建、启动：</p>
<pre><code class="hljs language-bash" lang="bash">
docker build -t mywechat:v1 .

docker stop mywechat

docker <span class="hljs-built_in">rm</span> mywechat

docker run -d \

-v /etc/localtime:/etc/localtime:ro \

--user 1026:1026 \

--name mywechat \

-p 5000:5000 \

-e WECHAT_WEBHOOK_URL=<span class="hljs-string">"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxx-xxxx-xxxxx-xxxx-xxxx"</span> \

-v templates:/app/templates \

mywechat:v1

</code></pre>
<p>接下来就可以手动触发一些告警来验证告警规则的处理了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 启动全解析：4 大关键动作 + 底层逻辑]]></title>    <link>https://juejin.cn/post/7596181746061197339</link>    <guid>https://juejin.cn/post/7596181746061197339</guid>    <pubDate>2026-01-17T07:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596181746061197339" data-draft-id="7591728734983880731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 启动全解析：4 大关键动作 + 底层逻辑"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-17T07:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 启动全解析：4 大关键动作 + 底层逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:52:45.000Z" title="Sat Jan 17 2026 07:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring Boot 以 “约定优于配置” 的核心思想大幅简化了 Spring 应用的开发与部署，其启动流程是理解框架底层原理的关键。本文将从 “核心动作” 和 “实现细节” 两个维度，全面拆解 Spring Boot 启动过程中完成的核心工作及底层实现逻辑。</p>
<h2 data-id="heading-0">一、Spring Boot 启动流程核心动作</h2>
<p>Spring Boot 启动的本质是完成 “环境准备 - 容器初始化 - 服务启动” 的全链路流程，核心可拆解为以下 4 个关键动作，且各动作遵循严格的执行顺序：</p>
<ol>
<li><strong>加载配置文件</strong>：整合多来源配置（内置默认、自定义配置文件、环境变量、命令行参数等），构建统一的应用环境上下文；</li>
<li><strong>加载日志组件</strong>：初始化日志系统，确保启动过程及应用运行的日志可追溯、可配置；</li>
<li><strong>创建 Spring 容器并初始化 Bean</strong>：构建 IoC 容器，扫描指定范围的 Bean 定义、解析注解、完成 Bean 的实例化与依赖注入；</li>
<li><strong>启动嵌入式 Web 服务器（如 Tomcat）</strong>：针对 Web 应用，初始化嵌入式服务器并绑定 Servlet/Filter 等组件，对外提供服务。</li>
</ol>
<h2 data-id="heading-1">二、核心动作的底层实现细节</h2>
<h3 data-id="heading-2">2.1 加载配置文件：整合多来源配置，构建环境上下文</h3>
<p>Spring Boot 配置文件的加载核心依赖 <code>ConfigFileApplicationListener</code>（Spring Boot 2.4+ 后逐步被 <code>ConfigDataEnvironmentPostProcessor</code> 替代，但核心逻辑一致），其核心作用是扫描指定路径下的配置文件（如 <code>application.yml</code>/<code>application.properties</code>），并将配置项整合到 <code>Environment</code> 上下文对象中。</p>
<h4 data-id="heading-3">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|创建 SpringApplication 实例| B("new SpringApplication(primarySources)")
B--&gt;|构造函数初始化监听器| C("setListeners(getSpringFactoriesInstances(ApplicationListener.class))&lt;br/&gt;核心逻辑：读取 META-INF/spring.factories 文件，加载所有&lt;br/&gt; ApplicationListener 实现类，包含 ConfigFileApplicationListener")
C --&gt;D("调用 application.run(args) 执行启动流程")
D --&gt;|初始化运行监听器| E("SpringApplicationRunListeners listeners = getRunListeners(args)&lt;br/&gt;读取 META-INF/spring.factories 加载 EventPublishingRunListener&lt;br/&gt;（事件发布监听器）")
E--&gt;|准备环境上下文| F("prepareEnvironment(listeners, applicationArguments)")
F--&gt;|发布环境准备事件|G("listeners.environmentPrepared(environment)")
G--&gt;|事件分发|H("EventPublishingRunListener.environmentPrepared()&lt;br/&gt;触发 EnvironmentPreparedEvent 事件")
H--&gt;|监听器处理事件|I("ConfigFileApplicationListener.onApplicationEvent(EnvironmentPreparedEvent)")
I--&gt;|核心处理逻辑|J("onApplicationEnvironmentPreparedEvent(EnvironmentPreparedEvent)")
J--&gt;|解析配置文件|K("postProcessEnvironment(environment, applicationArguments)&lt;br/&gt;1. 扫描 classpath:/、classpath:/config/、file:./、file:./config/ 等路径；&lt;br/&gt;2. 按优先级加载 application.properties/yml、profile 专属配置；&lt;br/&gt;3. 整合环境变量、命令行参数覆盖配置项；&lt;br/&gt;4. 将配置项注入 Environment 上下文")


classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;
</code></pre>
<h4 data-id="heading-4">关键补充说明</h4>
<ul>
<li>配置加载优先级：命令行参数 &gt; 环境变量 &gt; 自定义配置文件（如 application-dev.yml）&gt; 内置默认配置；</li>
<li>支持的配置格式：properties、yml、yaml，且支持多环境隔离（通过 <code>spring.profiles.active</code> 指定激活的 profile）；</li>
<li>核心目的：将分散的配置统一整合到 <code>Environment</code> 对象中，后续 Bean 初始化、服务器启动均可通过 <code>Environment</code> 获取配置项（如 <code>server.port</code>）。</li>
</ul>
<h3 data-id="heading-5">2.2 加载日志组件：初始化日志系统，保障日志可配置</h3>
<p>Spring Boot 启动时优先初始化日志组件，核心依赖 <code>LoggingApplicationListener</code>，其作用是根据应用配置（或默认规则）选择并初始化日志框架（如 Logback、Log4j2、Java Util Logging），确保启动过程的日志能正常输出。</p>
<h4 data-id="heading-6">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|创建 SpringApplication 实例| B("new SpringApplication(primarySources)")
B--&gt;|构造函数初始化监听器| C("setListeners(getSpringFactoriesInstances(ApplicationListener.class))&lt;br/&gt;读取 META-INF/spring.factories 加载 LoggingApplicationListener")
C --&gt;D("调用 application.run(args) 执行启动流程")
D --&gt;|初始化运行监听器| E("SpringApplicationRunListeners listeners = getRunListeners(args)&lt;br/&gt;加载 EventPublishingRunListener")
E--&gt;|发布应用环境已准备事件|G("listeners.environmentPrepared()&lt;br/&gt;触发ApplicationEnvironmentPreparedEvent 事件")
G--&gt;|事件分发|H("EventPublishingRunListener.environmentPrepared()")
H--&gt;|监听器处理事件|I("LoggingApplicationListener.onApplicationEvent(ApplicationEvent)")
I--&gt;|核心处理逻辑|J("onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent)")
J--&gt;|选择并初始化日志系统|K("LoggingSystem.get(classLoader)&lt;br/&gt;1. 按优先级检测日志框架（Logback &gt; Log4j2 &gt; JUL）；&lt;br/&gt;2. 加载日志配置文件（如 logback-spring.xml）；&lt;br/&gt;3. 初始化日志级别、输出格式、输出路径等；&lt;br/&gt;4. 绑定日志系统到 Spring 环境，支持运行时动态调整")


classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;

</code></pre>
<h4 data-id="heading-7">关键补充说明</h4>
<ul>
<li>日志框架优先级：Spring Boot 默认内置 Logback（无需额外依赖），若需切换为 Log4j2，需排除 Logback 依赖并引入 Log4j2 相关包；</li>
<li>日志配置加载路径：默认扫描 <code>classpath:logback-spring.xml</code>、<code>classpath:log4j2.xml</code> 等，也可通过 <code>logging.config</code> 配置项指定自定义路径；</li>
<li>核心目的：在应用核心逻辑启动前完成日志初始化，避免启动过程中日志丢失或格式异常。</li>
</ul>
<h3 data-id="heading-8">2.3 创建 Spring 容器并初始化 Bean：构建 IoC 核心，管理 Bean 生命周期</h3>
<p>Spring Boot 核心是构建 Spring IoC 容器，核心依赖 <code>ConfigurationClassPostProcessor</code>（Bean 定义后置处理器），其作用是解析启动类上的注解（如 <code>@SpringBootApplication</code>）、扫描指定包下的 Bean、解析自动配置类，最终完成 Bean 的注册与初始化。</p>
<h4 data-id="heading-9">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|"创建 SpringApplication 实例"| A1("new SpringApplication(primarySources)")
A1--&gt;|执行启动逻辑| A2("application.run(args)")
A2--&gt;|创建应用上下文| B("createApplicationContext()&lt;br/&gt;根据应用类型选择上下文：Web 应用为 AnnotationConfigServletWebServerApplicationContext，&lt;br/&gt;非 Web 应用为 AnnotationConfigApplicationContext")
B--&gt;|"初始化 Web 应用上下文"| C("context = new AnnotationConfigServletWebServerApplicationContext()")
C --&gt;|"初始化 Bean 定义读取器"| D("new AnnotatedBeanDefinitionReader(beanFactory)&lt;br/&gt;用于解析注解驱动的 Bean 定义")
D --&gt;|注册核心后置处理器| E("AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory)&lt;br/&gt;向容器中注册 ConfigurationClassPostProcessor 等核心处理器")
E--&gt;|关键处理器注册完成|F("ConfigurationClassPostProcessor 加入容器（Bean 定义解析核心）")
F--&gt;|"注册启动类为 Bean"|C1("application.load(primarySources)&lt;br/&gt;将 @SpringBootApplication 标注的启动类作为核心 Bean 注入容器")
C1--&gt;|"刷新上下文（核心步骤）"|G("refreshContext(context)")
G--&gt;|容器刷新核心方法|H("context.refresh()&lt;br/&gt;执行 Spring 容器初始化全流程")
H--&gt;|"执行 BeanFactory 后置处理器"|I("invokeBeanFactoryPostProcessors(beanFactory)")
I--&gt;|分发后置处理器执行逻辑|J("PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()")
J--&gt;|"执行 BeanDefinitionRegistry 后置处理器"|K("invokeBeanDefinitionRegistryPostProcessors(registryProcessors, registry)")
K--&gt;|"解析并注册 Bean 定义"|L("ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry(registry)&lt;br/&gt;1. 解析启动类上的 @ComponentScan，扫描指定包下的 @Component/@Service/@Repository 等 Bean；&lt;br/&gt;2. 解析 @EnableAutoConfiguration，读取 META-INF/spring/&lt;br/&gt;org.springframework.boot.autoconfigure.AutoConfiguration.imports 文件，加载自动配置类；&lt;br/&gt;3. 解析 @Bean 注解，注册手动声明的 Bean；&lt;br/&gt;4. 将所有 Bean 定义注册到 IoC 容器")
L--&gt;|"Bean 实例化与依赖注入"|M("finishBeanFactoryInitialization(beanFactory)&lt;br/&gt;实例化所有非懒加载 Bean，完成依赖注入、初始化方法（@PostConstruct）执行")

classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;

</code></pre>
<h4 data-id="heading-10">关键补充说明</h4>
<ul>
<li>自动配置核心：<code>@EnableAutoConfiguration</code> 是自动配置的入口，Spring Boot 通过 <code>spring-boot-autoconfigure</code> 包中的自动配置类，实现 “按需加载”（如引入 redis 依赖则自动配置 RedisTemplate）；</li>
<li>扫描范围：默认扫描启动类所在包及其子包，可通过 <code>@ComponentScan</code> 指定自定义扫描范围；</li>
<li>核心目的：构建完整的 IoC 容器，管理所有 Bean 的生命周期，为应用提供依赖注入、AOP 等核心能力。</li>
</ul>
<h3 data-id="heading-11">2.4 启动嵌入式 Tomcat：初始化 Web 服务器，对外提供服务</h3>
<p>对于 Web 应用（引入 <code>spring-boot-starter-web</code>），Spring Boot 会自动启动嵌入式 Tomcat（默认），核心逻辑在 <code>ServletWebServerApplicationContext</code> 的 <code>onRefresh</code> 方法中，完成服务器创建、Servlet/Filter 绑定、端口监听等操作。</p>
<h4 data-id="heading-12">调用流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init:"wrap": false, {"flowchart":{"wrappingWidth":2000}}}%%
graph TD
A("SpringApplication.run() 入口方法")--&gt;|创建 SpringApplication 实例| A1("new SpringApplication(primarySources)")
A1--&gt;|执行启动逻辑| A2("application.run(args)")
A2--&gt;|创建应用上下文| B("createApplicationContext()")
B--&gt;|初始化 Web 应用上下文| C("context = new AnnotationConfigServletWebServerApplicationContext()")
C--&gt;|刷新上下文|G("refreshContext(context)")
G--&gt;|容器刷新核心方法|H("context.refresh()")
H--&gt;|Web 服务器初始化|I("onRefresh()&lt;br/&gt;ServletWebServerApplicationContext 重写的刷新方法，专用于 Web 服务器启动")
I--&gt;|创建 Tomcat 实例|J("createWebServer()&lt;br/&gt;1. 根据 server.port 等配置创建 Tomcat 实例；&lt;br/&gt;2. 配置 Tomcat 基础路径、连接器（Connector）、引擎（Engine）等核心组件；&lt;br/&gt;3. 绑定上下文路径（server.servlet.context-path）")
J--&gt;|绑定 Servlet/Filter 等组件|L("getSelfInitializer()&lt;br/&gt;1. 从 IoC 容器中获取所有 ServletContextInitializer 实现类（如 DispatcherServletRegistrationBean）；&lt;br/&gt;2. 扫描容器中的 @Servlet/@Filter 注解组件，封装为 ServletContextInitializer 实现类；&lt;br/&gt;3. Tomcat 创建 ServletContext 时，执行这些 Initializer，完成 DispatcherServlet、Filter 等组件的注册")
L--&gt;|启动 Tomcat 服务器|K("finishRefresh()&lt;br/&gt;1. 调用 Tomcat.start() 启动服务器；&lt;br/&gt;2. 绑定端口监听，等待客户端请求；&lt;br/&gt;3. 发布 ApplicationStartedEvent 事件，标识应用启动完成")


classDef leftAlign text-align:left;
class A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,S,Y,Z leftAlign;
</code></pre>
<h4 data-id="heading-13">关键补充说明</h4>
<ul>
<li>服务器切换：若需将 Tomcat 替换为 Jetty/Undertow，只需排除 <code>spring-boot-starter-tomcat</code> 依赖，引入 <code>spring-boot-starter-jetty</code>/<code>spring-boot-starter-undertow</code>；</li>
<li>核心组件：DispatcherServlet 是 Spring MVC 的核心 Servlet，由 <code>DispatcherServletAutoConfiguration</code> 自动配置，负责接收并分发所有 Web 请求；</li>
<li>端口配置：默认端口 8080，可通过 <code>server.port</code> 配置，若配置为 0 则随机分配端口；</li>
<li>核心目的：启动嵌入式 Web 服务器，将 Spring MVC 核心组件绑定到服务器，对外提供 HTTP 服务。</li>
</ul>
<h2 data-id="heading-14">三、启动流程整体时序总结</h2>
<p>Spring Boot 启动流程的核心时序可概括为：</p>
<pre><code class="hljs language-scss" lang="scss">SpringApplication<span class="hljs-selector-class">.run</span>()
→ 初始化监听器（加载 LoggingApplicationListener/ConfigFileApplicationListener）
→ 发布 ApplicationStartingEvent（初始化日志）
→ 准备环境（加载配置文件，构建 Environment）
→ 创建 IoC 容器（AnnotationConfigServletWebServerApplicationContext）
→ 注册 ConfigurationClassPostProcessor（解析 Bean 定义）
→ 刷新容器（<span class="hljs-built_in">refresh</span>()）
 → 执行 BeanFactory 后置处理器（扫描并注册 Bean）
 → 实例化 Bean（完成依赖注入）
 → 初始化 Web 服务器（创建并启动 Tomcat）
→ 发布 ApplicationStartedEvent（启动完成）
</code></pre>
<h2 data-id="heading-15">四、核心总结</h2>
<p>Spring Boot 启动流程的本质是 “通过监听器机制完成环境准备，通过后置处理器完成 Bean 容器初始化，通过 Web 应用上下文完成嵌入式服务器启动”，其核心优势在于：</p>
<ol>
<li>自动化：通过 <code>spring.factories</code>/ 自动配置类，实现 “按需加载”，无需手动配置核心组件；</li>
<li>标准化：固定的启动流程确保应用开发的一致性，降低配置成本；</li>
<li>可扩展：通过自定义 <code>ApplicationListener</code>/<code>EnvironmentPostProcessor</code>/<code>BeanFactoryPostProcessor</code>，可灵活扩展启动逻辑。
理解上述流程，不仅能帮助开发者定位启动过程中的异常（如配置加载失败、Bean 冲突、端口占用），也能为自定义 Spring Boot Starter、扩展框架能力提供底层支撑。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重磅福利，TRAE 国际版全部用户限免一个月！]]></title>    <link>https://juejin.cn/post/7595868336595255315</link>    <guid>https://juejin.cn/post/7595868336595255315</guid>    <pubDate>2026-01-17T08:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336595255315" data-draft-id="7595868336595238931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重磅福利，TRAE 国际版全部用户限免一个月！"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-17T08:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重磅福利，TRAE 国际版全部用户限免一个月！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:11:51.000Z" title="Sat Jan 17 2026 08:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>好消息，TRAE 官方宣布为庆祝上线一周年 TRAE 国际版全部用户限免一个月！即从 2026 年 1 月 14 日 10:00 起，TRAE 国际版全部用户赠送 Fast Request 权益（不少于 1 个月 Pro 会员的用量）！</p>
<ul>
<li><strong>Free 用户：</strong> 账号增加 600 次 Fast Request，有效期至北京时间 2 月 14 日 10:00</li>
<li><strong>Pro 用户：</strong> 账号增加 800 次 Fast Request，有效期至北京时间 3 月 14 日 10:00</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e56f08d087e492da9044f2b13a0ec1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=Ua1SWt4bz1cULKkCGOOUvSigNV0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">什么是 TRAE？</h2>
<p>TRAE 是字节跳动官方推出的 AI 原生 IDE，深度融合 AI 能力，是一名能够理解需求、调用工具并独立完成各类开发任务的“AI 开发工程师”，帮助你高效推进每一个项目。</p>
<h2 data-id="heading-2">主要功能</h2>
<p>TRAE 覆盖从编码、调试到测试、重构、部署等多类开发任务。提供智能体编程工具 CUE，支持代码补全、多行修改、智能导入和智能重命名等功能，适配多种日常开发场景，帮助你减少重复操作，专注核心创新。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd67b575590943db9c969abde712eea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=YQMNr%2BSFRu%2F%2Bl5VVnn%2FWTyCHbYQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">TRAE 内置 Al Coding 智能体</h2>
<p>TRAE 内置的 SOLO 模式，配备专属 Coding Agent，可理解目标、规划任务并调度工具，独立推进各阶段开发工作。从自然语言输入到可执行产出，帮助你高效完成开发任务。</p>
<ul>
<li><strong>SOLO Coder：</strong> 面向复杂项目开发的智能体。SOLO Coder 能够助力你高效完成从需求迭代到架构重构的全流程开发工作。</li>
<li><strong>SOLO Builder：</strong> 快速构建专业且功能完善的 Web 应用。你只需用自然语言描述需求，SOLO Builder 便会自动根据任务选择最合适的 AI 模型、分析需求、生成 PRD、编写代码，并产出可预览成果。</li>
</ul>
<h2 data-id="heading-4">领取限时权益包</h2>
<ul>
<li>领取地址：<a href="https://www.trae.ai/2026-anniversary-gift" target="_blank" title="https://www.trae.ai/2026-anniversary-gift" ref="nofollow noopener noreferrer">www.trae.ai/2026-annive…</a></li>
</ul>
<p><strong>或者打开 TRAE 直接调整领取：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079f632d3f1b421587d02b83728d1782~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=N0IHyrSvj9QlN9wDAG9NlShKI%2Bk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27d2f06ac0f94919b43e8f056855047b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=6ZCBUxVNyoQ3Cmce10mdUa1PZak%3D" alt="" loading="lazy"/></p>
<p><strong>领取成功：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81a460a6f77d4ca29f3fd1f2e85cff34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=b5d%2BvQbmwFoO%2BC4wu8sChPr67IM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">TRAE 国际版下载安装</h2>
<ul>
<li>下载地址：<a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5dc7bb8c8b4ced8187a52ac96872b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=5uNrBOx%2BhT0OD0xQKoh0zOHc%2FJI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e8bc5c7f0440a08cc8c225add16831~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=S1FjzZZlJk6j2P0Ky2OLeDicX7A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8541247833df43b6b85a65e834709ab3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=LzqlEasXsZ4WFzkJ%2F8mTJaBgo%2BQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c96e4402e34e069bb4091d1f68e422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=o2JYLLK%2FTqdK5IahJO%2BJ0kVtNdg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88b31830cd6d4f809cc9b6ed7bb2c779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=MplGuNksk5RQflq%2BjAtxXlyjkFs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d067f8f230b4f628cf988b47cdda2db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=5Osd7nwzu7Sn1sAIMvB%2Bn%2FeTiwc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9f9a9348f0d41db8861d733268a1491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=vweUe9khmcAdAT6s56UyU7vnGXQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">TRAE 开发者社区</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flcnziv86vkx6.feishu.cn%2Fwiki%2FGEEnwlfTQi8qZrkFsPycfkUKnul" target="_blank" title="https://lcnziv86vkx6.feishu.cn/wiki/GEEnwlfTQi8qZrkFsPycfkUKnul" ref="nofollow noopener noreferrer">lcnziv86vkx6.feishu.cn/wiki/GEEnwl…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/815c0911ad4347c58d3745b8a414d5fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769242310&amp;x-signature=mtAwKEQWSxIC7%2ByYH%2Bq24YzUGt8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">TRAE 官方文档</h2>
<ul>
<li><a href="https://docs.trae.ai/ide/what-is-trae?_lang=zh" target="_blank" title="https://docs.trae.ai/ide/what-is-trae?_lang=zh" ref="nofollow noopener noreferrer">docs.trae.ai/ide/what-is…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026最新AI模型横评：谁才是你的最强“工作搭子”？]]></title>    <link>https://juejin.cn/post/7595831738234519561</link>    <guid>https://juejin.cn/post/7595831738234519561</guid>    <pubDate>2026-01-17T08:25:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595831738234519561" data-draft-id="7595841630677205043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2026最新AI模型横评：谁才是你的最强“工作搭子”？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-17T08:25:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2026最新AI模型横评：谁才是你的最强“工作搭子”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T08:25:22.000Z" title="Sat Jan 17 2026 08:25:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 时代，最痛苦的不是没有工具，而是<strong>工具太多，根本不知道选哪个</strong>！</p>
<p>一边是 <strong>ChatGPT、Claude</strong> 等国外老牌霸主，一边是 <strong>DeepSeek、Kimi、通义千问</strong> 等国产新贵强势崛起。究竟是“外来的和尚好念经”，还是“国产之光”更懂中国心？</p>
<p>今天，我们实测了目前市面上最火的 8 款大模型，从<strong>逻辑推理、长文本处理、代码能力、日常交互</strong>等维度，为你送上一份<strong>保姆级选型指南</strong>。</p>
<hr/>
<h2 data-id="heading-0">🎬 视频演示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1HkrUBVEpn%2F" target="_blank" title="https://www.bilibili.com/video/BV1HkrUBVEpn/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Hk…</a></p>
<hr/>
<h2 data-id="heading-1">第一梯队：国际“三巨头”</h2>
<p>如果你能解决网络门槛问题，这三位依然代表着<strong>目前 AI 智力的“天花板”</strong>。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a0f42aeef343f2a576ad110266b43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243121&amp;x-signature=3wmhMPqJyYR0zHNwO0HsRu26UV8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1. ChatGPT (OpenAI) —— “六边形战士”</h3>
<p><strong>👑 地位：</strong> 行业标杆，所有模型的模仿对象。</p>
<ul>
<li><strong>🔥 核心优势：</strong>
<ul>
<li><strong>综合能力最强：</strong> 无论是写诗、写代码还是逻辑推理，GPT 几乎没有短板。</li>
<li><strong>生态无敌：</strong> 拥有海量的 GPTs（插件），可以画图、数据分析、联网搜索，一站式搞定。</li>
<li><strong>语音模式：</strong> 它的实时语音对话流畅度，目前仍是独一档的存在。</li>
</ul>
</li>
<li><strong>💔 缺点：</strong>
<ul>
<li>订阅费用贵（20 美元/月）。</li>
<li>国内访问门槛高，账号容易被封。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. Claude (Anthropic) —— “不仅是文科生，更是程序员”</h3>
<p><strong>🦄 地位：</strong> 最像“人”的 AI，ChatGPT 最强的竞争对手。</p>
<ul>
<li><strong>🔥 核心优势：</strong>
<ul>
<li><strong>拟人化最高：</strong> 写出来的文章不仅逻辑通顺，而且文笔优美，没有“AI 味”，非常适合公文写作、邮件润色。</li>
<li><strong>Artifacts 功能：</strong> 能够直接在侧边栏预览代码效果（如网页、图表），是前端程序员和数据分析师的最爱。</li>
<li><strong>超大上下文：</strong> 能够一次性吃透整本书的内容。</li>
</ul>
</li>
<li><strong>💔 缺点：</strong>
<ul>
<li><strong>风控极严：</strong> 稍微聊点敏感话题（甚至只是为了剧情需要）就会拒绝回答。</li>
<li>免费版限制次数较多。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">3. Gemini (Google) —— “全知全能的数据怪兽”</h3>
<p><strong>🚀 地位：</strong> Google 生态的亲儿子，拥有百万级上下文处理能力。</p>
<ul>
<li><strong>🔥 核心优势：</strong>
<ul>
<li><strong>百万上下文窗口：</strong> Gemini 3 Pro 可以一次性处理极长的视频、音频和文档，这是它的杀手锏。</li>
<li><strong>Google 全家桶集成：</strong> 直接调用 Google Docs, Gmail, Drive 里的资料，办公效率极高。</li>
<li><strong>多模态理解：</strong> 扔给它一段视频，它能精准告诉你视频里发生了什么。</li>
</ul>
</li>
<li><strong>💔 缺点：</strong>
<ul>
<li>逻辑推理偶尔会“幻觉”（一本正经胡说八道）。</li>
<li>产品线改名频繁，用户容易晕。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">第二梯队：国产“五虎上将”</h2>
<p>国产模型不仅<strong>免费/便宜</strong>，而且<strong>更懂中文语境</strong>，在某些垂直领域甚至已经超越了 GPT-4。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a37ce125bb94db59f4df998ccfd87ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243121&amp;x-signature=JICqUjU1aljvh7yKezpBsmCbkas%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">1. DeepSeek (深度求索) —— “硬核理工男，国产之光”</h3>
<p><strong>⚡ 特性：</strong> 开源界的英雄，代码与数学能力的王者。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>代码/数学能力极强：</strong> 在 Coding 领域，DeepSeek V3/R1 的表现直逼甚至超越 GPT-4，深受程序员喜爱。</li>
<li><strong>开源精神：</strong> 模型权重公开，不仅 API 极其便宜（几乎是白菜价），还能本地部署。</li>
<li><strong>深度思考：</strong> R1 版本引入了类似 o1 的深度思考链，解决复杂逻辑问题能力爆表。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>由于太火，服务器偶尔会崩。</li>
<li>文案写作略显生硬，不如文科类模型细腻。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2. Kimi (月之暗面) —— “长文本阅读神器”</h3>
<p><strong>📚 特性：</strong> 最早打响“长文本”招牌的国产模型。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>吃透研报/论文：</strong> 扔给它 50 份 PDF，它能迅速帮你总结核心观点，是金融从业者和学生党的救星。</li>
<li><strong>联网搜索精准：</strong> 它的搜索引用链接非常规范，减少了胡编乱造的概率。</li>
<li><strong>界面清爽：</strong> UI 设计简洁，不仅好用，而且好看。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>生成长文时，创意度有时稍显不足。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3. 通义千问 (Qwen - 阿里巴巴) —— “全能实干家”</h3>
<p><strong>🛠️ 特性：</strong> 阿里技术背书，开源生态极其丰富，并且最新的千问 APP 还<strong>可以帮你自动点餐</strong>。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>图片理解能力强：</strong> 视觉识别（Vision）能力在国产模型中数一数二，能看懂复杂的图表和菜单。</li>
<li><strong>文档处理：</strong> 解析 Word、Excel 的能力非常稳定。</li>
<li><strong>不仅是聊天：</strong> 背后有通义听悟（做会议纪要）等一系列应用支持。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>有时候回答过于“官方”，缺乏一点个性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">4. 智谱清言 (ChatGLM) —— “数据分析大师”</h3>
<p><strong>📊 特性：</strong> 源自清华系，工具调用能力强。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>数据分析：</strong> 内置的代码解释器非常强大，上传 Excel 表格，它能直接帮你画出可视化的图表（柱状图、热力图等）。</li>
<li><strong>GLM 能力均衡：</strong> 综合素质很高，既能画图，又能联网，而且<strong>最新的 GLM 4.7 代码能力也不错</strong>。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>移动端 APP 的体验偶尔有卡顿。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">5. 豆包 (字节跳动) —— “最强语音搭子”</h3>
<p><strong>🎧 特性：</strong> 日活最高的国产 AI，主打 C 端日常陪伴。</p>
<ul>
<li><strong>👍 优点：</strong>
<ul>
<li><strong>语音交互最自然：</strong> 声音极其逼真，有情绪起伏，不像机器人在念稿，非常适合练口语或闲聊。</li>
<li><strong>功能丰富：</strong> 内置了各种“智能体”（如英语老师、小说写手），玩法很多。</li>
<li><strong>响应速度快：</strong> 字节的技术优化，让它在手机上用起来非常丝滑。</li>
</ul>
</li>
<li><strong>👎 缺点：</strong>
<ul>
<li>处理复杂逻辑和硬核代码任务时，相比 DeepSeek 稍弱。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-11">⚡ 总结：到底该选哪一个？</h2>
<p>为了帮你省时间，我直接给出**“抄作业”建议**：</p>















































<table><thead><tr><th align="left">你的需求</th><th align="left"><strong>首选推荐 (国内)</strong></th><th align="left"><strong>首选推荐 (国外)</strong></th><th align="left">理由</th></tr></thead><tbody><tr><td align="left"><strong>写代码 / 搞数学</strong></td><td align="left"><strong>DeepSeek</strong></td><td align="left">Claude</td><td align="left">逻辑最强，不容易写出 Bug。</td></tr><tr><td align="left"><strong>读论文 / 看研报</strong></td><td align="left"><strong>Kimi</strong></td><td align="left">Gemini</td><td align="left">长文本吞吐量大，总结精准。</td></tr><tr><td align="left"><strong>写文章 / 润色邮件</strong></td><td align="left"><strong>通义千问 / Kimi</strong></td><td align="left">ChatGPT/Gemini</td><td align="left">文笔自然，读起来不尴尬。</td></tr><tr><td align="left"><strong>做图表 / 数据分析</strong></td><td align="left"><strong>智谱清言</strong></td><td align="left">ChatGPT/Gemini</td><td align="left">直接出图，省去 Excel 操作。</td></tr><tr><td align="left"><strong>练口语 / 闲聊解闷</strong></td><td align="left"><strong>豆包</strong></td><td align="left">ChatGPT</td><td align="left">声音好听，反应快，情商高。</td></tr><tr><td align="left"><strong>综合办公 / 啥都干</strong></td><td align="left"><strong>通义千问 / DeepSeek</strong></td><td align="left">ChatGPT/Gemini</td><td align="left">均衡发展，也是最稳的选择。</td></tr></tbody></table>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9069286cc1744dc8f2542336fc7de4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769243121&amp;x-signature=BzxMHgBq6p2btftOoqmEUf21vno%3D" alt="" loading="lazy"/><br/>
AI 模型更新速度极快（按周计算）。如果是<strong>工作重度使用</strong>，建议**“DeepSeek (逻辑) + Kimi (阅读)”**组合使用，完全免费且效率翻倍；如果有条件，<strong>ChatGPT/Gemini</strong> 依然是探索 AI 边界的最佳窗口。</p>
<p>拒绝选择困难症，现在就去打开一个试试吧！</p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，网站包含的内容有：<strong>N8N/Coze/Dify/LangChain/SpringAI/SpringAIAlibaba/LangChain4j/AI实战项目/AI常见面试题</strong>等技术分享，欢迎各位大佬光临指导~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙异步并发 async/await 最佳实践，代码瞬间优雅]]></title>    <link>https://juejin.cn/post/7595527937832861750</link>    <guid>https://juejin.cn/post/7595527937832861750</guid>    <pubDate>2026-01-16T08:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595527937832861750" data-draft-id="7595552420047585323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙异步并发 async/await 最佳实践，代码瞬间优雅"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2026-01-16T08:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙异步并发 async/await 最佳实践，代码瞬间优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T08:00:48.000Z" title="Fri Jan 16 2026 08:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hello，兄弟们，我是 V 哥！</p>
<p>还记得以前写 Android 或者早期 JavaScript 的时候，那个传说中的**“回调地狱”**吗？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 伪代码演示：让人崩溃的金字塔</span>
<span class="hljs-title function_">login</span>(user, <span class="hljs-function">(<span class="hljs-params">res1</span>) =&gt;</span> {
  <span class="hljs-title function_">getUserInfo</span>(res1.<span class="hljs-property">id</span>, <span class="hljs-function">(<span class="hljs-params">res2</span>) =&gt;</span> {
    <span class="hljs-title function_">getOrders</span>(res2.<span class="hljs-property">token</span>, <span class="hljs-function">(<span class="hljs-params">res3</span>) =&gt;</span> {
      <span class="hljs-title function_">getDetail</span>(res3.<span class="hljs-property">orderId</span>, <span class="hljs-function">(<span class="hljs-params">res4</span>) =&gt;</span> {
        <span class="hljs-comment">// 终于结束了... 代码已经缩进到屏幕外边了</span>
      })
    })
  })
})
</code></pre>
<p>这种代码，维护起来简直是噩梦！但在鸿蒙 ArkTS 的 API 21 环境下，兄弟们千万别再这么写了！ArkTS 是基于 TypeScript 的，它原生支持非常强大的 <strong><code>async/await</code></strong> 语法。</p>
<p>今天 V 哥就带你把这段“金字塔”拍平，用 <strong>同步的逻辑写异步的代码</strong>，优雅得像喝下午茶一样！</p>
<hr/>
<h2 data-id="heading-0">核心心法：把“等待”变成“暂停”</h2>
<p>兄弟们，记住 V 哥这两个口诀：</p>
<ol>
<li><strong><code>async</code></strong>：加在函数定义前面，表示“这里面有耗时的活儿”。</li>
<li><strong><code>await</code></strong>：加在耗时的调用前面，表示“<strong>等着这儿干完，再去干下一行，但别把界面卡死</strong>”。</li>
</ol>
<p>有了这两个神器，异步代码写出来就像在写小学作文，从上到下，一行一行读，逻辑清晰无比。</p>
<hr/>
<h2 data-id="heading-1">实战代码案例</h2>
<p>为了让大家直观感受，V 哥写了一个完整的 Demo。咱们模拟三个常见的真实场景：</p>
<ol>
<li><strong>串行执行</strong>：先登录，再拿用户信息。</li>
<li><strong>并发执行</strong>：同时拉取“广告配置”和“首页推荐”。</li>
<li><strong>异常处理</strong>：优雅地捕获网络错误。</li>
</ol>
<p><strong>操作步骤：</strong> 打开你的 DevEco Studio 6.0，新建一个 ArkTS 页面，把下面的代码完整复制进去，直接运行！</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> promptAction <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.promptAction'</span>;

<span class="hljs-comment">/**
 * V哥的模拟网络请求类
 * 在真实项目中，这里会换成 httpRequest 或者 网络库
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkSimulator</span> {
  <span class="hljs-comment">// 模拟一个异步耗时操作，返回 Promise</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">request</span>(<span class="hljs-attr">apiName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 模拟 20% 的概率失败</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-number">0.2</span>) {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> 请求失败，网络不给力！`</span>));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> 返回的数据: <span class="hljs-subst">${data}</span>`</span>);
        }
      }, delay);
    });
  }
}

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">AsyncAwaitDemo</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">resultLog</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'V哥准备好输出日志了...'</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">isLoading</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'鸿蒙 async/await 实战实验室'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })

      <span class="hljs-comment">// 场景一：串行执行</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'场景1：串行执行 (登录 -&gt; 获取信息)'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">testSequential</span>();
        })

      <span class="hljs-comment">// 场景二：并发执行</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'场景2：并发执行 (同时拉取配置和广告)'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">testParallel</span>();
        })

      <span class="hljs-comment">// 场景三：异常捕获</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'场景3：异常捕获 (模拟失败重试)'</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">testErrorHandling</span>();
        })

      <span class="hljs-comment">// 日志显示区域</span>
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)
          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#333333'</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'40%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">15</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span>) {
        <span class="hljs-title class_">LoadingProgress</span>()
          .<span class="hljs-title function_">width</span>(<span class="hljs-number">30</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">30</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })
          .<span class="hljs-title function_">color</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)
      }

    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })
  }

  <span class="hljs-comment">/**
   * V哥解析：场景1 - 串行执行
   * 特点：一步接一步，下一步依赖上一步的结果。
   * 代码逻辑：完全是线性的，像同步代码一样易读！
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testSequential</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> = <span class="hljs-string">'1. 开始登录...\n'</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// V哥重点：await 会暂停函数执行，直到 Promise resolve</span>
      <span class="hljs-comment">// 这里模拟先登录，耗时 1000ms</span>
      <span class="hljs-keyword">let</span> loginRes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'LoginAPI'</span>, <span class="hljs-string">'Token123'</span>, <span class="hljs-number">1000</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${loginRes}</span>\n`</span>;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">'2. 正在获取用户信息...\n'</span>;
      <span class="hljs-comment">// 依赖上面的 Token，继续 await</span>
      <span class="hljs-keyword">let</span> userRes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'GetUserInfo'</span>, <span class="hljs-string">'V哥的大名'</span>, <span class="hljs-number">800</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${userRes}</span>\n`</span>;

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">'✅ 全部完成！(串行总耗时约 1.8s)'</span>;
      
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'串行执行完成'</span> });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`❌ 出错了: <span class="hljs-subst">${error.message}</span>`</span>;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">/**
   * V哥解析：场景2 - 并发执行
   * 特点：两个请求互不依赖，同时发出，谁先回来谁先结束。
   * 优势：速度最快！总耗时 = 两个请求中最慢的那个，而不是两者之和。
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testParallel</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> = <span class="hljs-string">'1. 同时启动多个任务...\n'</span>;

    <span class="hljs-comment">// 记录开始时间</span>
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// V哥重点：Promise.all()</span>
      <span class="hljs-comment">// 把所有要并发的 Promise 放进数组里</span>
      <span class="hljs-comment">// await 会等数组里所有的 Promise 都 resolve 才继续</span>
      <span class="hljs-keyword">let</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'GetConfig'</span>, <span class="hljs-string">'系统配置'</span>, <span class="hljs-number">1500</span>), <span class="hljs-comment">// 假设这个慢</span>
        <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'GetBanner'</span>, <span class="hljs-string">'广告图片'</span>, <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 假设这个快</span>
      ]);

      <span class="hljs-comment">// results 是一个数组，顺序和你传入的顺序一致，不管谁先回来</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${results[<span class="hljs-number">0</span>]}</span>\n`</span>; <span class="hljs-comment">// 第一个结果</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   <span class="hljs-subst">${results[<span class="hljs-number">1</span>]}</span>\n`</span>; <span class="hljs-comment">// 第二个结果</span>

      <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`✅ 全部完成！(并发总耗时约 <span class="hljs-subst">${duration}</span>ms，比串行快！)`</span>;
      
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'并发执行完成'</span> });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`❌ 出错了: <span class="hljs-subst">${error.message}</span>`</span>;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">/**
   * V哥解析：场景3 - 异常处理
   * 特点：async/await 下，我们用 try...catch...finally 代替 .then().catch()
   * 这比传统的 Promise 链式调用要直观得多，像处理 Java 异常一样舒服。
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testErrorHandling</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> = <span class="hljs-string">'尝试发送请求 (模拟20%失败率)...\n'</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 这里的请求可能会抛出 Error</span>
      <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NetworkSimulator</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">'RiskyAPI'</span>, <span class="hljs-string">'试试运气'</span>, <span class="hljs-number">1000</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   成功: <span class="hljs-subst">${data}</span>`</span>;
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请求成功'</span> });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// V哥重点：一旦任何一步 await 报错，直接跳进 catch</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   捕获到异常: <span class="hljs-subst">${error.message}</span>\n`</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resultLog</span> += <span class="hljs-string">`   这里可以进行重试逻辑...`</span>;
      
      promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请求被拦截'</span> });

    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-comment">// V哥重点：finally 无论成功失败都会执行</span>
      <span class="hljs-comment">// 适合用来关闭 Loading 弹窗</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLoading</span> = <span class="hljs-literal">false</span>;
    }
  }
}
</code></pre>
<p>运行结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6818be9281524d31a73fff7d7edfe3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769155247&amp;x-signature=zL9R6ZeXyZSmko98g2VPgKpHfNU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">V 哥的代码深度解析</h2>
<p>兄弟们，代码能跑了，咱们得懂原理，不然面试的时候要挂！</p>
<h3 data-id="heading-3">1. 为什么 async/await 不会卡死界面？</h3>
<p>这就是并发编程的魔力。
当你写 <code>let res = await someRequest()</code> 的时候，ArkTS 的运行时会把<strong>当前任务的挂起</strong>，把主线程的控制权交还给 UI 系统。
这就好比你去排队买奶茶，你叫服务员做奶茶（发起请求），你站在旁边等（await），但**店里的其他人（UI线程）**依然可以继续进店买东西。只有当你的奶茶好了（Promise resolve），你才拿着奶茶走人（代码继续往下走）。</p>
<h3 data-id="heading-4">2. Promise.all 是性能优化的利器</h3>
<p>在场景 2 中，V 哥演示了 <code>Promise.all</code>。
如果你的首页有 5 个接口，互不依赖，你千万别写 5 行 await：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误写法：慢得要死</span>
<span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">req1</span>(); <span class="hljs-comment">// 等1秒</span>
<span class="hljs-keyword">let</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">req2</span>(); <span class="hljs-comment">// 再等1秒</span>
<span class="hljs-comment">// ... 总耗时 5秒</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ V 哥正确写法：飞快</span>
<span class="hljs-keyword">let</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">req1</span>(), <span class="hljs-title function_">req2</span>(), <span class="hljs-title function_">req3</span>(), <span class="hljs-title function_">req4</span>(), <span class="hljs-title function_">req5</span>()]);
<span class="hljs-comment">// 总耗时 = 最慢的那个接口 (假设是 1.2秒)</span>
</code></pre>
<p>这可是实打实的性能提升，用户打开 App 的速度直接肉眼可见变快！</p>
<h3 data-id="heading-5">3. 不要忘记了 try-catch</h3>
<p>以前写 Promise 链，如果不加 <code>.catch()</code>，报错了可能就像石沉大海，静默失败。
用了 <code>async/await</code>，<strong>一定要</strong> 包裹在 <code>try...catch</code> 里。这是对自己代码负责，也是对用户负责。</p>
<hr/>
<h2 data-id="heading-6">总结</h2>
<p>来来来，V 哥稍微小结一下：</p>
<ol>
<li><strong>逻辑复杂？</strong> 用 <code>async/await</code> 拍平金字塔。</li>
<li><strong>请求多且慢？</strong> 用 <code>Promise.all</code> 并行加速。</li>
<li><strong>怕出错？</strong> 用 <code>try/catch</code> 稳稳兜底。</li>
</ol>
<p>在 DevEco Studio 6.0 里，这套组合拳用熟练了，你的代码质量和开发效率绝对能甩开同行一条街。</p>
<p>我是 V 哥，拒绝回调地狱，从今天开始！咱们下期见！👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥1篇搞懂AI通识:大白话拆解核心点]]></title>    <link>https://juejin.cn/post/7595610998033727515</link>    <guid>https://juejin.cn/post/7595610998033727515</guid>    <pubDate>2026-01-16T07:25:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595610998033727515" data-draft-id="7595626157909213193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥1篇搞懂AI通识:大白话拆解核心点"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-16T07:25:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥1篇搞懂AI通识:大白话拆解核心点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T07:25:11.000Z" title="Fri Jan 16 2026 07:25:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：卢旭</p>
<h2 data-id="heading-0">引言</h2>
<p>随着 AI 技术从实验室走向日常，“机器学习”“大模型”“Transformer”“MOE” 等词汇已不再是技术圈的专属。从智能聊天助手到电商推荐，从语音识别到自动驾驶，AI 正以多元形态融入生活。这篇文章按 “基础→核心→优化→落地→工具→术语” 的逻辑，用最通俗的大白话，把 AI 通识技术点讲透。帮助你我他她建立更完整的 AI 认知框架，理解技术背后的核心逻辑与实际价值，“看透” AI 技术的底层逻辑，让复杂概念变得清晰易懂。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-1">一、基础概念（搞懂 AI 的 “底层逻辑”）</h2>
<h3 data-id="heading-2">1. 什么是 AI（人工智能）？</h3>
<p>AI 本质就是 “让机器像人一样思考、干活” 的技术体系 —— 不用人一步步指挥，机器能自己学规律、做决策。比如手机人脸识别、聊天机器人、自动驾驶，都是 AI 的具体应用。它不是单一技术，而是一堆技术的 “总称”，就像 “家电” 包含冰箱、电视一样。这张网上流行的图概述了人工智能（AI）随着时间推移的发展历程，从早期阶段到机器学习、深度学习以及大型语言模型（LLM）的出现。</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa11585169c437f8b058f602f61fc0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=I7cedMjtba%2FN8BFKucvxk4dKCJA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-3">2. 什么是机器学习、强化学习、深度学习，它们的关系？</h3>
<p>这仨是 AI 的 “核心方法论”，是 “大圈套小圈” 的关系：</p>
<p>•<strong>机器学习</strong>：AI 的 “基础学习法”—— 让机器像 “学生刷题”，从数据里自己找规律（比如看 1000 张猫的照片，自己总结 “尖耳朵 = 猫”），不用人逐条教规则。</p>
<p>•<strong>深度学习</strong>：机器学习的 “高级版”—— 给机器配了 “多层思考大脑”（神经网络），能分层挖数据的深层规律（比如先看猫的轮廓，再看细节，最后判断），适合处理图片、长文本等复杂任务。</p>
<p>•<strong>强化学习</strong>：机器学习的 “特训法”—— 让机器像 “宠物学技能”，做对了给奖励（赢棋加分），做错了给惩罚（输棋扣分），反复试错后优化策略，比如 AI 玩游戏、下围棋都靠它。</p>
<p>关系总结：机器学习是 “总方法”，深度学习是 “高级分支”，强化学习是 “训练技巧”，三者常搭配使用（比如 ChatGPT 用深度学习架构，靠强化学习优化回答）。</p>
<h3 data-id="heading-4">3. 机器学习三大范式</h3>
<p>范式就是 “教机器干活的具体方式”，核心区别是 “给不给机器‘标准答案’”（标准答案叫 “标签”，比如 “这张是猫”）：</p>





























<table><thead><tr><th>范式类型</th><th>通俗类比</th><th>核心逻辑</th><th>实际应用</th></tr></thead><tbody><tr><td>监督学习</td><td>做 “带答案的习题册”</td><td>给机器的所有数据都标好 “对错 / 结果”，机器学完后直接套用规律</td><td>垃圾邮件识别、翻译软件、图片分类</td></tr><tr><td>无监督学习</td><td>整理 “无标签的杂物”</td><td>只给机器原始数据，不标答案，让它自己找分类 / 规律</td><td>电商 “猜你喜欢”、客户群体划分、异常交易检测</td></tr><tr><td>半监督学习</td><td>做 “一半有答案的习题册”</td><td>少量数据标答案（教基础规律），大量数据无答案（让机器举一反三）</td><td>方言识别、罕见疾病诊断（标注数据少的场景）</td></tr></tbody></table>
<p>补充：强化学习也常被单独列为一类，核心是 “靠奖励 / 惩罚试错学习”。</p>
<h3 data-id="heading-5">4. 什么是神经网络？</h3>
<p>神经网络是深度学习的 “核心骨架”，模仿人脑神经元的连接方式，本质是 “按层排列的小计算单元集合”，像 “工厂流水线”：</p>
<p>•<strong>输入层</strong>：“原材料入口”—— 接收原始数据（比如图片像素、文字）；</p>
<p>•<strong>隐藏层</strong>：“核心加工车间”—— 层数越多，深度学习越 “深”，负责一步步提取数据特征（从轮廓到细节）；</p>
<p>•<strong>输出层</strong>：“成品出口”—— 输出最终结果（比如 “这是猫”“翻译结果”）。</p>
<p>每个 “小计算单元”（神经元）就像 “小计算器”，筛选有用信息、弱化无用信息，训练模型就是调整这些单元的 “工作规则”，让它越来越精准。</p>
<h3 data-id="heading-6">5. 为什么深度学习要 “深”？</h3>
<p>“深” 指神经网络的 “隐藏层多”，不是为了凑数，而是为了 “挖深层规律”：</p>
<p>•1 层网络（浅）：只能看表面信息（比如图片的像素颜色），分不清猫和狗；</p>
<p>•3 层网络（中深）：第 1 层看 “边缘 / 明暗”→第 2 层拼 “耳朵 / 圆形轮廓”→第 3 层判断 “尖耳朵 = 猫、圆形 = 球”；</p>
<p>•10 层以上网络（深）：能分层提取特征（先轮廓→再细节→再逻辑），比如识别 “小狗在追蝴蝶”，能看懂 “动作” 和 “场景”。</p>
<p>简单说：“深” 的本质是 “分层提取特征”：从表面的 “像素 / 文字”，挖到深层的 “逻辑 / 场景”；任务越复杂（写小说、解数学题），越需要 “深” 网络，才能从表面数据挖到核心逻辑。</p>
<h3 data-id="heading-7">6. 什么是预训练？</h3>
<p>预训练就是给大模型 “打基础”—— 用海量通用数据（比如几百万本书、网页）让模型先学 “通用知识”（语法、常识、逻辑），相当于让学生先读完小学到大学的通识课程，具备基本能力。</p>
<p>预训练后的模型就像 “有基础的学霸”，不用再从零学起，后续只需针对性培训（微调），就能适配具体任务（比如当客服、写代码）。</p>
<h3 data-id="heading-8">7. 什么是大模型 LLM？</h3>
<p>LLM 是 “大语言模型” 的缩写，核心是 “用超大神经网络，学海量文字数据，能像人一样理解和生成语言”—— 通俗说就是 “读过全世界书的超级学霸”。</p>
<p>“大” 体现在三点：</p>
<p>•参数量大：相当于 “学霸的脑细胞多”，能存更多知识（比如 GPT-4 有万亿级参数）；</p>
<p>•数据量多：相当于 “学霸读的书多”，覆盖书籍、论文、网页等，知识渊博；</p>
<p>•能力全：能聊天、写文案、解数学题、编代码，不用专门训练。</p>
<h3 data-id="heading-9">8. 什么是多模态大模型？</h3>
<p>“模态” 就是 AI 能处理的 “信息类型”（文字、图片、语音、视频），多模态大模型就是 “全能选手”—— 能同时处理多种信息：</p>
<p>•比如你发一张风景照，它能描述内容、配诗，还能把诗读出来；</p>
<p>•常见例子：GPT-4V、文心一言多模态版，能看图片、听语音、写文字。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-10">二、核心架构与机制（AI 的 “底层骨架”）</h2>
<h3 data-id="heading-11">1. 传统架构与演进：什么是 RNN/LSTM/GRU？</h3>
<p>在 Transformer 出现前，处理文字、语音等 “序列数据”（有先后顺序的数据）靠这些架构：</p>
<p>•<strong>RNN</strong>：“逐字处理” 的架构 —— 像读文章逐字念，只能记住最近的信息，处理长文本会 “忘事”（比如读 1000 字文章，后面忘了前面）；</p>
<p>•<strong>LSTM/GRU</strong>：RNN 的 “升级版”—— 加了 “记忆单元”，能记住更多长距离信息，但效率还是低，处理超长文本仍吃力。</p>
<p>这些架构是 AI 的 “老基建”，现在主流大模型已不用，但了解它们能更好理解 Transformer 的创新。</p>
<h3 data-id="heading-12">2. 现代大模型基石：什么是 Transformer 架构？</h3>
<p>Transformer 架构是一种以 “并行计算 + 自注意力机制” 为核心的神经网络结构，能高效捕捉数据（如文字）间的关联关系，是现代大模型（如 ChatGPT、DeepSeek）的基础骨架。2017 年由 Google 提出，是大模型 “高效运行” 的关键—— 决定了模型能跑多快、处理多长文本、效果多好，彻底解决了传统架构的痛点：</p>
<p>•核心创新：“并行计算 + 注意力机制”—— 不用逐字处理，能同时分析多个关键词，还能记住词与词的关系，又快又准；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b24f4b72e34841bf830659b83f57847f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=jNXWMIKEgskzQQybMbt%2B1bklkQA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•核心结构：分 “编码器（Encoder）” 和 “解码器（Decoder）”—— 编码器负责 “理解信息”（比如读文章），解码器负责 “生成信息”（比如写文章）；</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd91b6a0e004a59988db4a2ffb4b698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=e7WulIpGuhX1PMah%2FfZtR%2BAtLxU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>简单说，Transformer 架构就是让 AI 能同时看懂文字间的关联、还能快速处理长文本的 “高效大脑骨架”～。</p>
<h3 data-id="heading-13">3. 什么是位置编码？</h3>
<p>Transformer 架构本身 “不认识文字顺序”—— 如果不加位置编码，机器会把 “我打你” 和 “你打我” 当成一回事。位置编码的核心作用是 “标记文字的先后顺序”，让机器理解语序逻辑。</p>
<p>•通俗解释</p>
<p>◦比如处理句子 “小明吃苹果”：位置编码给 “小明” 贴 “1 号”、“吃” 贴 “2 号”、“苹果” 贴 “3 号”；</p>
<p>◦机器看到标签后，就知道 “1 号（小明）做 2 号（吃）动作，对象是 3 号（苹果）”，不会搞反逻辑；</p>
<p>◦注意：位置编码不是简单的 1、2、3，而是用特殊数字编码，让机器同时理解 “相邻词关系更近”（如 “吃” 和 “小明”“苹果” 的关系比 “小明” 和 “苹果” 更近）。</p>
<p>•核心作用</p>
<p>◦位置编码解决了 “语序混乱” 的问题，让机器能正确理解 “主谓宾”“先后顺序” 等语言逻辑，是处理文本任务的关键小技巧。</p>
<h3 data-id="heading-14">4. 语义理解引擎：什么是注意力模型、自注意力机制、多头注意力？</h3>
<p>这仨是 Transformer 的 “核心能力”，本质是让机器 “抓重点、理关系”：</p>

























<table><thead><tr><th>概念名称</th><th>通俗类比</th><th>核心作用 （输入句子 “北京的故宫和上海的东方明珠，哪个更适合拍照？）</th></tr></thead><tbody><tr><td>注意力模型</td><td>读书时 “划重点”</td><td>从海量信息中筛选出关键内容（如 “北京”“故宫”“拍照”）</td></tr><tr><td>自注意力机制</td><td>划重点后 “分析关系”</td><td>不仅找重点，还能理清重点间的关联（如 “北京有故宫，故宫适合拍照”）</td></tr><tr><td>多头注意力</td><td>用 “多副眼镜看重点”</td><td>从多个角度抓重点（一副看 “谁做什么”，一副看 “在哪里做”，一副看 “怎么做”）</td></tr></tbody></table>
<h3 data-id="heading-15">5. 注意力优化升级：什么是 MLA、NSA 和代理注意力？</h3>
<p>普通注意力机制处理长文本（比如 10 万字报告）时，会 “内存不够、跑不动”，这三个是 “优化版”，核心是 “省资源、提效率”：</p>





























<table><thead><tr><th>技术名称</th><th>通俗类比</th><th>核心逻辑</th><th>应用场景</th></tr></thead><tbody><tr><td>多头潜在注意力（MLA）</td><td>把厚书做成 “思维导图”</td><td>压缩关键信息，减少内存占用（如把 10 万字报告的重点压缩成 1000 字）</td><td>如DeepSeek 可处理 12 万字长文本</td></tr><tr><td>原生稀疏注意力（NSA）</td><td>读书只看 “核心段落”</td><td>跳过无用信息，只分析关键内容的关系（如忽略 “的、了、吗” 等虚词）</td><td>如超长篇小说分析、论文摘要</td></tr><tr><td>代理注意力</td><td>先看 “目录” 再看正文</td><td>用 “摘要 / 目录” 替代原文找重点，再对应到原文（如先看书籍目录，再针对性看章节）</td><td>如百万字级文档处理、知识库问答</td></tr></tbody></table>
<p>三者的核心思路都是 “抓大放小”，在不影响理解效果的前提下，通过压缩信息、减少计算量，实现长文本的高效处理。</p>
<h3 data-id="heading-16">6. 生成逻辑差异：什么是自回归生成与非自回归生成？</h3>
<p>大模型生成文字的两种核心方式：</p>
<p>•<strong>自回归生成</strong>：“逐字写”—— 像人写字一样，写完一个字再写下一个，能保证逻辑连贯，ChatGPT、DeepSeek 都用这种；</p>
<p>•<strong>非自回归生成</strong>：“同时写多个字”—— 效率高，但容易逻辑混乱，适合对速度要求高、对连贯性要求低的场景（比如简单翻译）。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-17">三、模型优化与适配技术（让 AI 更实用、更易部署）</h2>
<h3 data-id="heading-18">1. 什么是 MOE 混合专家架构？</h3>
<p>MOE（Mixture of Experts）即混合专家架构，核心是让 “专业的人干专业的事”—— 模型里有多个 “专家模块”，每个模块只擅长一个领域，处理任务时只激活相关专家，既省算力又高效。<strong>主要结构拆解如下：</strong></p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a8576af52049dbaf4617e70b97898d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153111&amp;x-signature=NtUV4z2F9%2FVkI8lR7yJf1eKWcm4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>1.<strong>专家模块</strong>：不同科室的医生，每个专家只擅长一个领域（如 “代码专家” 专做编程，“数学专家” 专解难题，“中文专家” 专处理诗词和对话）；</p>
<p>2.<strong>门控网络</strong>：医院导诊台，输入任务后先 “判断任务类型”（如 “怎么写 Python 代码” 属于编程任务）；接收输入任务后，通过计算判断任务类型，筛选出最适合处理该任务的 1-2 个专家模块；</p>
<p>3.<strong>高效协作</strong>：只叫醒需要的专家，不会让无关专家参与（如编程任务只激活 “代码专家”，不打扰 “数学专家”）。</p>
<p><strong>实际案例：DeepSeek-V3 的 MOE 架构</strong></p>
<p>•总参数量：6710 亿（相当于 256 个专家模块）；</p>
<p>•激活数量：处理任务时只激活 370 亿参数（8 个专家模块）；</p>
<p>•优势：算力浪费少，训练成本仅为传统模型的 1/3，处理任务速度更快。</p>
<h3 data-id="heading-19">2. 什么是数据并行、模型并行、张量并行？</h3>
<p>大模型参数量太大（比如万亿级），单台电脑装不下、训不动，这三种是 “分工训练” 的方式：</p>
<p>•<strong>数据并行</strong>：多台电脑 “一起练不同批次的数据”—— 比如甲练第 1-100 条，乙练第 101-200 条，最后汇总经验；</p>
<p>•<strong>模型并行</strong>：多台电脑 “各负责模型的一部分”—— 比如甲负责输入层，乙负责隐藏层，分工协作；</p>
<p>•<strong>张量并行</strong>：把模型的 “计算任务拆分”—— 比如一个复杂计算拆成 3 份，3 台电脑同时算，加快速度。</p>
<h3 data-id="heading-20">3. 什么是量化、知识蒸馏、剪枝？</h3>
<p>大模型原本 “笨重”（需超大内存），这三种是 “给模型瘦身” 的技术，让它能装在普通电脑、手机上：</p>
<p>•<strong>量化</strong>：把模型里的 “精准数字简化”—— 比如 “1.23456” 改成 “1.23”，像把 4K 照片转成清晰缩略图，体积变小但核心信息不变；</p>
<p>•<strong>知识蒸馏</strong>：让 “小模型学大模型的本事”—— 大模型像 “教授”，小模型像 “学生”，学生学教授的核心知识，体积变小 10 倍仍保精度；</p>
<p>•<strong>剪枝</strong>：给模型 “删无用部分”—— 去掉模型里没用的参数（比如很少用到的 “小计算单元”），让它更轻巧。</p>
<h3 data-id="heading-21">4. 什么是模型压缩？</h3>
<p>就是把量化、蒸馏、剪枝等技术 “打包使用”，综合给模型瘦身，比如把 10GB 的大模型压缩到 1GB，适配手机、智能手表等资源受限设备。</p>
<h3 data-id="heading-22">5. 什么是模型微调（Fine-tuning）？</h3>
<p>微调就是给 “有基础的 AI 学霸” 做 “岗前培训”—— 预训练模型已经会通用知识（会说话、懂常识），微调时用少量专项数据（比如公司客服对话），教它做具体事：</p>
<p>•流程：通用大模型→输入专项数据→训练几天→输出专项模型（比如客服 AI）；</p>
<p>•优势：省数据、省时间，不用从零训练；学完专项技能后，仍会聊天、算数学题等通用能力。</p>
<h3 data-id="heading-23">6. 什么是 LoRA、QLoRA？</h3>
<p>普通微调仍需要不少算力，这俩是 “轻量级微调” 技术：</p>
<p>•核心逻辑：不改变大模型的核心参数，只给它加 “小插件”（少量新参数），教插件专项技能；</p>
<p>•优势：用普通电脑就能做，成本低、速度快，适合中小企业和个人。</p>
<h3 data-id="heading-24">7. 什么是领域自适应（Domain Adaptation）？</h3>
<p>让大模型 “适配特定行业”—— 比如给通用大模型喂医疗数据，让它学会看病历、答医疗问题；喂金融数据，让它懂股票、基金，成为行业专用模型。</p>
<h3 data-id="heading-25">8. 什么是 RLHF（人类反馈强化学习）？</h3>
<p>让模型的输出 “符合人类偏好”—— 比如模型回答后，人给打分（好 / 不好），再用这些分数训练模型，让它越来越懂 “人喜欢什么样的回答”（比如更礼貌、更精准）。</p>
<h3 data-id="heading-26">9. 什么是 RAG、KAG？</h3>
<p>解决大模型 “知识过时、不懂专业领域” 的问题：</p>
<p>•<strong>RAG（检索增强生成）</strong> ：AI “开卷考试”—— 回答问题前，先从外部知识库（比如公司文档、最新新闻）查相关信息，再结合自己的知识生成答案，比如问 “2025 年最新政策”，它会先查 2025 年的资料；</p>
<p>•<strong>KAG（知识增强生成）</strong> ：AI “把知识点记牢再答题”—— 预训练时就把结构化知识（比如百科词条、行业术语）融入模型，不用临时查，适合回答固定常识（比如 “牛顿三大定律”）。</p>
<h3 data-id="heading-27">10. 什么是事实核查（Fact-checking）？</h3>
<p>减少大模型 “胡说八道”（幻觉）的技术 —— 模型生成答案后，自动核对事实（比如查资料确认 “北京到上海的距离”），纠正错误信息，让回答更靠谱。</p>
<h3 data-id="heading-28">11. 什么是对齐（Alignment）与安全护栏（Safety Guardrails）？</h3>
<p>•<strong>对齐</strong>：让模型的目标和人类一致 —— 比如不生成有害内容、不撒谎；</p>
<p>•<strong>安全护栏</strong>：给模型 “设禁区”—— 禁止生成暴力、歧视等有害内容，确保使用安全。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-29">四、典型模型与生态实践（从理论到应用）</h2>
<h3 data-id="heading-30">1. 主流大模型分类与代表</h3>
<p>•<strong>通用大模型</strong>：能应对多种任务，比如 GPT 系列（OpenAI）、文心一言（百度）、Llama 系列（Meta）、通义千问（阿里）、Qwen（阿里云）；</p>
<p>•<strong>垂直领域大模型</strong>：专注某一行业，比如医疗大模型（看病历、辅助诊断）、法律大模型（查法条、写合同）、编程大模型（DeepSeek-Coder、GitHub Copilot）。</p>
<h3 data-id="heading-31">2. 典型创新案例：DeepSeek 的核心创新点</h3>
<p>DeepSeek 的核心创新围绕 “高效、低成本、高适配” 展开，通过架构优化、训练方法创新等，实现了 “用更少资源做出高性能模型” 的目标，让大模型更易普及。</p>
<p><strong>核心创新点：</strong></p>
<p>◦<strong>高效架构设计：MOE+MLA</strong>结合混合专家架构（MOE）和多头潜在注意力（MLA），6710 亿总参数量仅激活 370 亿参数处理任务，同时通过 MLA 压缩长文本信息，支持 12 万字长文本处理，算力成本降低 70% 以上。</p>
<p>◦<strong>低成本训练技术：强化学习 + 知识蒸馏</strong>采用 GRPO 强化学习算法，无需大量人工标注数据，通过 “试错反馈” 优化模型推理能力；结合动态知识蒸馏技术，将大模型能力迁移至小模型，体积减少 40% 仍保持精度，训练成本仅为 GPT-4 的 1/18。</p>
<p>◦<strong>高适配性部署：多场景 + 轻量化</strong>推出通用模型、编程模型（DeepSeek-Coder）、推理模型（DeepSeek-R1）等系列产品，适配不同场景；支持本地、云端、边缘设备部署，普通 GPU 即可运行，企业可快速集成到金融、教育、医疗等行业。</p>
<p>◦<strong>强推理能力：分步思考机制</strong>基于强化学习实现 “分步推理”，模型处理数学、编程等复杂任务时，会像人类一样拆解步骤、逐步求解，准确率比肩 OpenAI o1 系列。</p>
<h3 data-id="heading-32">3. 部署形态：云端、边缘、本地部署</h3>
<p>•<strong>云端部署</strong>：模型存在远程服务器上，通过网络使用（比如 ChatGPT 网页版），不用自己装；</p>
<p>•<strong>本地部署</strong>：把模型装在自己的电脑、服务器上，离线也能用，适合注重数据隐私的场景；</p>
<p>•<strong>边缘部署</strong>：把模型装在边缘设备上（比如手机、智能摄像头），响应快、不占网络带宽。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-33">五、常用工具与交互技术（高效用 AI）</h2>
<h3 data-id="heading-34">1. 什么是提示工程（Prompt Engineering）？</h3>
<p>就是 “教 AI 怎么说话”—— 通过优化输入指令（提示词），让 AI 输出符合预期的结果：</p>
<p>•比如只说 “写旅游攻略”，效果一般；但说 “写一篇适合亲子家庭的北京 3 日游攻略，含景点、餐饮、交通，语言简洁”，结果更精准；</p>
<p>•核心：指令清晰、逻辑明确，帮 AI 懂你的需求。</p>
<h3 data-id="heading-35">2. 关于提示学习中的思维链、自恰性和思维树？</h3>
<p>•<strong>一句话总结：</strong></p>
<p>思维链：让 AI “会写步骤”；</p>
<p>自洽性：让 AI “会查答案”；</p>
<p>思维树：让 AI“会拆难题、选思路”；都是为了让 AI 的回答更靠谱，只是简单问题用思维链，易出错问题加自洽性，复杂问题用思维树～</p>
<p>•三者<strong>对比</strong></p>





























<table><thead><tr><th>概念</th><th>通俗类比</th><th>核心动作</th><th>适合场景</th></tr></thead><tbody><tr><td>思维链（CoT）</td><td>写解题步骤</td><td>单一线性推理（一步一步）</td><td>简单、有明确步骤的问题</td></tr><tr><td>自洽性</td><td>反复检查作业</td><td>多轮独立验证（换思路重算）</td><td>易出错、结果不确定的问题</td></tr><tr><td>思维树（ToT）</td><td>拆难题 + 多条思路探索</td><td>多分支推理（拆分 + 选优）</td><td>复杂、多选项、需权衡的问题</td></tr></tbody></table>
<p>•<strong>举例：</strong></p>
<p>1.用思维树（ToT）拆问题：把大题拆成 3 个小题，每个小题想 2 种解法；</p>
<p>2.用思维链（CoT）写步骤：每个解法都写详细推导；</p>
<p>3.用自洽性验证：每个小题的 2 种解法结果一致，再汇总大题答案。</p>
<h3 data-id="heading-36">3. 什么是少样本 / 零样本提示？</h3>
<p>提示工程的 “进阶技巧”：</p>
<p>•<strong>少样本提示：给 AI “几个例子”—— 比如让它翻译方言，先给 2 个 “方言→普通话” 的例子，它就会模仿；</strong></p>
<p>•<strong>零样本提示：不给例子，直接让 AI 做任务 —— 比如让它写一首诗，全靠它自己的知识。</strong></p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-37">六、高频术语（读懂 AI 文档的关键词）</h2>
<p>1.<strong>Token</strong>：AI 处理文字的 “最小单位”—— 中文是单个字或词语（比如 “我 / 爱 / AI”），英文是单词或词根，模型能处理的 Token 数量决定了文本长度（比如 4096 个 Token 约 3000 中文字）；</p>
<p>2.<strong>标签（Label）</strong> ：数据的 “标准答案”，比如 “这张是猫”；</p>
<p>3.<strong>批次（Batch）</strong> ：训练时一次喂给模型的数据量（比如一次喂 32 条文本）；</p>
<p>4.<strong>训练步长（Step）</strong> ：模型处理一批数据 + 调整一次参数，算 1 个 Step（衡量训练进度）；</p>
<p>5.<strong>轮次（Epoch）</strong> ：把所有训练数据完整学一遍，算 1 个 Epoch（比如 10 万条数据，每批 32 条，约 3125 个 Step=1 个 Epoch）。</p>
<p>6.<strong>上下文（Context）</strong> ：AI 的 “聊天记忆”—— 记住之前的对话内容，比如你先问 “北京天气”，再问 “穿什么”，AI 知道你指北京；</p>
<p>7.<strong>上下文窗口（Context Window）</strong> ：AI 能记住的 “对话长度上限”—— 比如 4096 个 Token 窗口，超过就会忘前面的内容；</p>
<p>8.<strong>多轮对话（Multi-turn Conversation）</strong> ：和 AI 聊好几轮（比如问问题→追更→再问），AI 能连贯回应；</p>
<p>9.<strong>Agent（AI 智能体）</strong> ：“有自主能力的 AI 助手”—— 不用你一步步指挥，能自己理解任务、用工具、解决问题（比如让它规划旅游，自己查景点、订酒店）；</p>
<p>10.<strong>A2A（Agent-to-Agent）</strong> ：A2A是谷歌公开的一个协议，它能够实现不同的Agent之间能够实现直接互通，让智能体之间能够协作起来解决多任务的问题；A2A是让多个Agent能够连接起来，形成一个能力更加强大的Agent，解决多个Agent的通信效率问题。简单说就是多个 AI 智能体 “协作干活”—— 比如一个查资料、一个写文案、一个校对，合力完成复杂任务。</p>
<p>11.<strong>幻觉（Hallucination）</strong> ：AI “胡说八道”—— 编造不存在的事实（比如假新闻、假数据）。</p>
<p>12.<strong>MCP（模型上下文协议）</strong> ：MCP（Model Context Protocol）即 “模型上下文协议”，简单说就是AI 聊天的 “记忆管理规则”—— 规定能记多少轮对话、优先保留什么信息，确保连贯又省内存。MCP让所有的API、工具、数据源能够按照统一的协议通信，只要按此规范，这些工具都可以被开发者直接调用；MCP解决了搭建单个Agent的效率问题，让搭建单个Agent的效率变得更高。</p>
<p>13.<strong>AGI（通用人工智能）</strong> ：AI 的 “终极目标”—— 具备人类级智慧，能做任何人类能做的事（做饭、编程、科研），目前还在理论阶段；</p>
<p>14.<strong>ASI（超级人工智能）</strong> ：比人类智慧还强的 AI，目前仅存在于设想中。</p>
<hr/>
<p>﻿</p>
<h2 data-id="heading-38">结语</h2>
<p>AI 技术的核心逻辑可概括为 “从数据找规律到落地实用” 的递进过程，本质简洁且层层聚焦：</p>
<p>核心是让机器从数据中学习规律 —— 机器学习是基础 “找规律”，深度学习是 “多层递进找规律”，大模型则是 “海量数据 + 多层架构” 的高效找规律。具体通过四层实现：</p>
<p>1.基础层：机器学习让机器 “从数据中找规律”，神经网络是实现这一目标的 “骨架”；</p>
<p>2.进阶层：Transformer 架构 + 注意力机制让机器 “高效找规律、记重点”，解决长文本、高难度任务；</p>
<p>3.优化层：量化、蒸馏、微调、MOE 等技术让机器 “变小、变快、变便宜”，适配更多场景；</p>
<p>4.应用层：大模型（如 ChatGPT、DeepSeek）是最终成果，直接服务于日常聊天、办公、编程等需求。</p>
<p>这篇文章覆盖 AI 全链路知识，从基础概念到架构、优化技术、落地应用及术语，希望能在此找到自己需要的内容。而学习 AI 的关键，正如 Transformer 架构的逻辑 —— 先掌握整体全貌与基本原理，再层层深入剖析细节.....</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[仅两台缓存节点，如何支撑 1.45TB/s 大吞吐业务]]></title>    <link>https://juejin.cn/post/7595610998032826395</link>    <guid>https://juejin.cn/post/7595610998032826395</guid>    <pubDate>2026-01-16T05:35:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595610998032826395" data-draft-id="7595513077220343854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="仅两台缓存节点，如何支撑 1.45TB/s 大吞吐业务"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-16T05:35:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JuiceFS"/> <meta itemprop="url" content="https://juejin.cn/user/2665636828032446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            仅两台缓存节点，如何支撑 1.45TB/s 大吞吐业务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665636828032446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JuiceFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T05:35:04.000Z" title="Fri Jan 16 2026 05:35:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着面向大规模并发读取与数据分发的业务需求增加，如影视渲染等场景，传统存储方案（如 NAS）在并发客户端数量增加时，往往需要投入更多缓存资源；为了提升响应时效，通常还需提前进行数据预热，不仅带来额外的时间开销，也进一步加重了资源负担。</p>
<p>JuiceFS 作为一种基于对象存储的分布式文件系统，通过其高性能架构，利用分布式缓存聚合吞吐量并降低延迟，能够在大规模客户端并发读取时提供高效支持。本文分享的是我们近期在实际测试中的一个案例，展示如何利用 4,000 台业务节点成功聚合了 1.45TB/s 的带宽，并在此过程中通过引入二级缓存池，保障了系统的稳定性。</p>
<p>通过这篇文章，我们希望为高并发、大吞吐需求场景中的存储瓶颈提供一个切实可行的解决方案，并借此抛砖引玉，欢迎大家共同探索存储优化的思路与方法。</p>
<h2 data-id="heading-0">01 传统 NAS：节点越多，存储越慢</h2>
<p>该客户为影视渲染农场用户，日常作业中会同时启动数千台 Windows 节点进行渲染。</p>
<ul>
<li><strong>业务特点</strong>：每台节点在渲染时需同时读取一批文件（大部分为重复素材）到本地。</li>
<li><strong>原有痛点</strong>：原公有云 NAS 存储（SMB 挂载）在节点数增多时，不得不不断增加后端 SMB 服务节点来应对激增的流量和 IOPS，导致管理复杂度和成本直线上升。当并发节点超过 1,000 台时，存储系统往往不堪重负。</li>
<li><strong>核心需求</strong>：迫切需要一种在存储底座之外，能够分担业务吞吐压力的能力。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73608659d8f44ab9911c4f99ed4dc76a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=IGNCMgX%2Fo4wlqJk9z28pw2Fu%2ByA%3D" alt="" loading="lazy"/></p>
<p>在 SMB 服务模式下，每个客户端都需要从 SMB 存储读取全量数据。导致服务端流量长期高位，管理员需要持续监控 SMB 服务的健康状况，一旦接近最大负荷，就需要及时进行扩容，提供与集群规模匹配的存储能力，运维压力显著增加。</p>
<h2 data-id="heading-1">02 闲置资源利用：用大量业务节点做分布式缓存</h2>
<p>JuiceFS 在社区版 1.3 及企业版 5.2 之后发布了全新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fdocs%2Fzh%2Fcloud%2Fgetting_started%23windows-installation" target="_blank" title="https://juicefs.com/docs/zh/cloud/getting_started#windows-installation" ref="nofollow noopener noreferrer">Windows 客户端</a>，支持通过 <code>.exe</code> 进程将文件系统挂载为本地盘，使用方式与 Linux 类似。</p>
<p>但在海量客户端场景下，如果仅将业务切换为标准的「JuiceFS 挂载点 —— 分布式缓存 —— 对象存储」链路，流量会集中打到独立缓存层，可能成为新的性能瓶颈。与其不断扩容专用的缓存节点，不如转换思路：<strong>利用海量业务节点自身的闲置带宽和磁盘，将它们池化为一个巨大的分布式缓存池。</strong></p>
<ul>
<li><strong>JuiceFS 分布式缓存模式（P2P 模式）</strong>：同一份文件只需在集群内读取一次，后续其他节点直接从 P2P 缓存池的邻近节点获取。</li>
<li><strong>对象存储侧</strong>：回源流量极低，文件首次冷读后，后续流量几乎全由缓存池承担。</li>
<li><strong>资源要求</strong>：无需专用缓存硬件，仅需每个业务节点贡献部分磁盘和带宽。</li>
</ul>
<p>在这个方案中，<strong>我们没有配置任何一台独立缓存节点。所有的业务节点既是消费者，也是提供者</strong>（P2P 模式）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e05c72b0d6407b8f0c3aa0ba458e6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=9oa9KiCrbiUMk08uRLTZ%2BvqoddA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">03 实测案例：4,000 台业务节点聚合到 1.45TB/s 的巨大吞吐</h2>
<p><strong>测试任务</strong>：每台 Windows 机器在无预热（冷读）的情况下，读取 16 个 2GB 的大文件。 统计所有节点读完的总耗时，并观察各节点的耗时方差，以及是否存在长尾效应。</p>
<p><strong>配置策略</strong>：将 4,000 个节点拆分为多个子组（每组 500 个节点）。16 个 2GB 的数据块会散列分布在组内节点中，避免所有节点同时回源对象存储，造成拥塞。</p>
<p>那么现在 JuiceFS 客户端的冷读流程就变为：</p>
<ol>
<li>Windows 客户端读取 16 个 2GB 的文件，通过一致性哈希拓扑定位这些数据块在 500 个缓存组内的负责节点，向其发起请求。</li>
<li>缓存节点收到了数据块请求后，发现本地未命中缓存（冷读），则回源对象存储拉取数据块，拉取完成后将数据返回给客户端，并且写入本地缓存，供后续请求复用。</li>
<li>当客户端从所有缓存服务节点获取完整数据块后，测试结束，统计所有客户端读完的耗时分布（最大值、最小值），用于评估方差与长尾情况。</li>
</ol>
<p>下面是不同客户端节点数量读取这批 16*2GB 大文件的时间结果：</p>



































<table><thead><tr><th align="center">客户端台数</th><th align="left">聚合吞吐最高</th><th align="left">总耗时（范围/平均）</th></tr></thead><tbody><tr><td align="center">2,000 台</td><td align="left"><strong>729GB/s</strong></td><td align="left">92s~136s 平均 107s</td></tr><tr><td align="center">2,500 台</td><td align="left"><strong>921GB/s</strong></td><td align="left">87s~109s 平均 98s</td></tr><tr><td align="center">3,000 台</td><td align="left"><strong>1.11TB/s</strong></td><td align="left">93s~121s 平均 106s</td></tr><tr><td align="center">3,500 台</td><td align="left"><strong>1.34TB/s</strong></td><td align="left">89~112s 平均 100s</td></tr><tr><td align="center">4,000 台</td><td align="left"><strong>1.45TB/s</strong></td><td align="left">92s~115s 平均 101s</td></tr></tbody></table>
<p>不同数量客户端，JuiceFS 聚合吞吐表现</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5569fb6c97df4846aef07c566dc1a80c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=ndOp28trk%2FxpSc7GusT%2F2lFyRAY%3D" alt="" loading="lazy"/></p>
<p>整体结果各方面都符合预期：</p>
<ul>
<li><strong>稳定性</strong>：无论是 2,000 台还是 4,000 台，读完数据的总耗时都稳定在 100 秒左右。</li>
<li><strong>扩展性</strong>：<strong>4,000 台节点成功聚合出 1.45TB/s 的超大带宽，理论上，在元数据能够承载的前提下，该架构可实现持续的水平扩展，能够支持达到万台级别的缓存节点规模。</strong></li>
</ul>
<p>业务节点的挂载参数参考：</p>
<pre><code class="hljs language-bash" lang="bash">juicefs.exe mount juice-fs X: --cache-group=primary --buffer-size=4096 --enable-kernel-cache --as-root --subgroups=8
</code></pre>
<p>由此，我们未使用一台独立的缓存服务节点，仅靠用户的业务节点就聚合了 1.45TB/s 的读取能力。过客通户端节点组成的分布式缓存层，我们以零成本将绝大多数流量从对象存储中分流，减轻了底层存储的负担。</p>
<p>实际业务中，未必能达到如此高的吞吐能力，因为缓存效益通常与数据重复度相关。在实际场景中，每个节点读取的文件并不完全相同。尽管如此，这一方案仍然是有效的存储扩展方法，即使只有部分提升，也能带来非常可观的收益，且几乎不需要额外的成本投入。</p>
<h2 data-id="heading-3">04 稳定性增强：两级分布式缓存</h2>
<p>缓存效果虽然炸裂，但客户对系统的稳定性提出了担忧。例如，在某些场景下，业务节点在完成任务后会立即销毁，而这些业务节点同时也是缓存节点。当大量业务节点突然下线时，原本存储在这些节点上的缓存也随之丢失，导致大量流量回源至对象存储，进而使对象存储成为瓶颈，影响整体稳定性。为了解决因业务节点波动引发的缓存性能问题，我们提出了两级分布式缓存方案，架构图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3953e1d679410cb5bbe11fea476677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769146503&amp;x-signature=mCuro4zhvMMiZV47agYkk%2FIfgnU%3D" alt="" loading="lazy"/></p>
<p>第二层缓存池（L2）位于第一层（L1）缓存池和对象存储之间。当 L1 未命中时，数据首先会从 L2 获取；如果 L2 缓存也未命中，则回源到对象存储。这样可以有效抵消 L1 缓存节点波动带来的影响。加入 L2 缓存池后，读取流程发生了以下变化：</p>
<ul>
<li>在 Windows 客户端读取 16 个 2GB 的文件，通过一致性哈希拓扑确定数据块所在 L1 缓存组中的特定节点；并同时向 L2 缓存组请求数据。</li>
<li>由于是冷读，L2 缓存组中没有数据，L2 缓存节点会向对象存储发起请求并填充 L2 缓存池。</li>
<li>数据块从 L2 缓存池返回至 L1 缓存池并进行填充，然后由 L1 缓存池内的节点自行进行点对点（P2P）分发。</li>
<li><strong>此时，大部分流量集中在 L1 缓存池，L2 只处理极少数回源对象存储的流量，因此即使 L2 只有少数几个节点，也不会成为性能瓶颈。L2 缓存池的作用是就近替代对象存储，降低延迟。</strong></li>
</ul>
<p>即使大量 L1 业务节点下线，缓存拓扑发生变化并需要重新下载数据块，数据仍可从 L2 缓存池就近获取。只要合理控制下线比例，业务几乎不受影响。</p>
<p>L2 缓存组挂载参数：</p>
<pre><code class="hljs language-bash" lang="bash">juicefs mount juice-fs /jfs-cache --cache-group=secondary --cache-size=-1 --cache-dir=/data* --free-space-ratio=0.01 --buffer-size=10240 --max-downloads=400
</code></pre>
<p>L1（业务节点）挂载参数：</p>
<pre><code class="hljs language-bash" lang="bash">juicefs.exe mount juice-fs X: --cache-group=primary --second-group=secondary --buffer-size=4096 --enable-kernel-cache --as-root --subgroups=8
</code></pre>
<p><strong>此外，两级分布式缓存还非常适用于需要重复利用已有缓存池的场景</strong>。例如，我们有一批位于北京的缓存池业务，总容量为 2PiB，缓存池名为 cache-group-bj。突然，上海的业务也需要使用相同的数据，而这些数据与北京的数据几乎完全相同。如果不希望重新从北京的对象存储中预热这 2PiB 的数据，我们可以在上海的缓存组中配置 <code>--second-group=cache-group-bj</code>。这样，当上海的业务请求数据时，将优先通过专线从北京的缓存池读取数据，速度非常快且延迟稳定（在 2ms 以内），免去了重复预热数据的复杂过程，能够直接启动业务，极大地方便了操作。</p>
<h2 data-id="heading-4">05 小结</h2>
<p>通过本次 4,000 节点的极限压测，我们成功将计算集群的大规模闲置资源转化为高达 1.45TB/s 的存储池；而二级缓存的引入，有效解决了“最后一公里”的稳定性顾虑。通过使用 JuiceFS 这套存储软件架构，可充分挖掘客户端集群的潜能，在不增加额外硬件成本的情况下，实现了性能的显著提升。</p>
<p>本方案适用场景：</p>
<ul>
<li><strong>高并发重复读取场景</strong>：如模型训推数据调用、容器镜像分发、影视渲染等，节点越多，P2P 缓存收益越大；</li>
<li><strong>弹性计算场景</strong>：业务节点经常大规模扩缩容（如 Spot Instances），利用二级缓存架构可确保数据访问的连续性与稳定性；</li>
<li><strong>混合云/多云架构</strong>：利用二级缓存机制可以复用异地缓存池资源，最大程度减少重复预热带来的对象存储调用和传输成本。</li>
</ul>
<p>我们希望本文中的一些实践经验，能为正在面临类似问题的开发者提供参考，如果有其他疑问欢迎加入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2F" target="_blank" title="https://juicefs.com/" ref="nofollow noopener noreferrer">JuiceFS 社区</a>与大家共同交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qunar酒店搜索排序模型的演进]]></title>    <link>https://juejin.cn/post/7595626157908869129</link>    <guid>https://juejin.cn/post/7595626157908869129</guid>    <pubDate>2026-01-16T06:36:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595626157908869129" data-draft-id="7594813727053070370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qunar酒店搜索排序模型的演进"/> <meta itemprop="keywords" content="前端,架构,操作系统"/> <meta itemprop="datePublished" content="2026-01-16T06:36:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="去哪儿技术沙龙"/> <meta itemprop="url" content="https://juejin.cn/user/2251436075786791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qunar酒店搜索排序模型的演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2251436075786791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    去哪儿技术沙龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T06:36:01.000Z" title="Fri Jan 16 2026 06:36:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、背景</h3>
<p>在用户在线浏览酒店时，旅行平台需要解决一个重要问题：如何更好地为用户挑选适合的酒店，并降低用户选择的费力度。而为用户挑选符合需求的酒店，需要千人千面的模型排序。在去哪儿（Qunar）APP中，触发个性化排序的场景主要是欢迎度排序（见图1）。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/030c148d0fef4833bc48244848ee773e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=iuKj3qAYd6gOHRCAiyK4AEipxwE%3D" alt="" loading="lazy"/></p>
<p align="center">图1 Qunar酒店搜索产品形态</p>
<h3 data-id="heading-1">二、Qunar酒店搜索排序架构</h3>
<p>Qunar酒店搜索推荐系统的总体流程可以分成四块，主要是召回、粗排、精排、重排。其中精排主要会根据用户的搜索关键词和其他相关信息，选出与用户需求最相符合的酒店，确保在搜索结果中，用户能够看到那些与其需求最相关的酒店。而Qunar酒店长期优化的业务目标是s2o，即下单用户数/搜索用户数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e976df357f39491d86bf0eb55927c8c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=J4FS6mJjGyxn6kSjDix5UKzojpY%3D" alt="" loading="lazy"/></p>
<p align="center">图2 Qunar搜索架构</p>
<h3 data-id="heading-2">三、Qunar酒店搜索精排排序的发展历程</h3>
<p>第一阶段升级机器学习模型，酒店搜索业务准备使用机器学习模型替换人工规则排序。为了能快速上线验证模型效果，并考虑到酒店业务天生自带大量连续特征，如酒店价格、酒店距离等，我们选择了对连续特征比较友好的树模型LambdaMart模型。</p>
<p>第二阶段升级深度模型，LambdaMart排序模型常用的迭代优化手段，如添加特征、样本调整等几乎已经无法带来增量收益，因此我们准备升级成比树模型天花板更高的深度模型架构LambdaDNN。</p>
<p>第三阶段升级多目标模型，LambdaDNN排序模型主要还是聚焦单目标建模（CTCVR），而多目标建模更好的考虑了排序全空间的曝光样本，综合考虑了下单前的用户点击行为，降低样本偏差问题，我们借鉴了Google的MMOE模型，同时学习CTR目标任务和CTCVR目标任务。</p>
<p>第四阶段升级多场景多目标模型，酒店业务搜索场景分为同城空搜、异地空搜等，每个场景单独一个模型，使得维护成本很高，并且用户出行时，会在多个场景（同城搜索、异地搜索）下搜索找到符合自己期望的酒店。若将多个场景分别单独训练模型，会使得用户连贯的搜索行为割裂，学习不到用户在不同场景下的差异和共性。因此，我们提出将信息表征拆分，融合多场景样本的多场景多目标模型。</p>
<p>下面具体阐述我们在Qunar酒店搜索排序模型的演进。</p>
<h3 data-id="heading-3">四、Qunar酒店搜索精排排序算法的迭代</h3>
<p>排序学习（Learning to Rank）是一个监督学习过程，给定一个query，搜索引擎会召回一系列相关的item，然后对这些召回的item进行排序，最后将Top N的item输出。而排序问题就是使用一个模型 f(q,d)来对该query下的item进行排序，分为PointWise，PairWise，ListWise三种排序学习方式。</p>
<p>PointWise：输入空间中样本是单个 item（和对应 query）构成的特征向量，输出空间中样本是单个 item（和对应 query）的相关度，是将所有用户的样本空间的样本同等对待。</p>
<p>PairWise：输入空间中样本是（同一 query 对应的）两个item构成的两个特征向量，输出空间中样本对的偏序关系，此方法学习了同一个query下的两个样本对比偏好。</p>
<p>ListWise：输入空间中样本是（同一 query 对应的）所有item构成的多个特征向量列表，输出空间是同一个query下的最优排序列表，是pairwise和lambda梯度的结合，如LambdaMart算法，对整个列表建模，学习一个最优排序列表。</p>















<table><thead><tr><th>pointWise</th><th>pairWise</th><th>listWise</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e465e1ee37546e2a082c2453b5efb31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=XEThDzGzChSk93nvwrmVC%2FLat5s%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be0b25796d3448eab81e26e6200ea2fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=eZ1nu4KZzD%2BmEFeOZyTnp85IUYQ%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86f7b1da238e4f408166fea126d137ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=vULzqmFWqcAISTjuc%2B9dE8b6A5M%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>模型的预测目标与业务指标之间存在一定的差距，Pointwise注重单个物品的点击率，对所有请求下的物品同等对待，与搜索业务指标存在较大的Gap，而搜索业务更关注在页面头部的搜索结果的优劣。</p>
<p>因此，初期阶段我们选择了更适合搜索排序的Listwise方式学习模型，即LambdaMart树模型作为base模型，同时树模型不需要做大量的特征处理，可以快速上线验证效果、拿到收益。</p>
<h4 data-id="heading-4">1. 由LambdaMart模型升级到LambdaDNN模型</h4>
<p>将排序模型从LambdaMart升级到LambdaDNN模型主要考虑到以下几点：</p>
<ul>
<li>旅游具有强烈的节假日周期属性，需要长时间窗的大规模数据学习。而树模型容量有限，随着数据规模的增加，很难很好的表达数据内部隐藏的知识。LambdaDNN能够实现更复杂的模型，且具备强大的表征能力，有更高的天花板。</li>
<li>基于深度学习的模型，具有更好的泛化能力，和处理高维稀疏数据的能力，此外应用深度学习模型后可以更好的应用新的研究成果，比如后面介绍的多目标排序。</li>
</ul>
<p>树模型和深度模型的主要区别见表1。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f18a285af81a420e9e4fdad5d7eb6108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=dF%2BxcPEzjX0Llhta%2BvXvoaI8l9c%3D" alt="a44cfa7ec9874f8d0a95ed9b79884305.png" loading="lazy"/></p>
<h4 data-id="heading-5">2. LambdaDNN模型实践</h4>
<p>为了验证深度模型的有效性，我们控制了loss的学习方式，统一为listwise方式，唯一变量只是模型的结构。而LambdaDNN模型是将神经网络DNN与LamdaRank [2] 定义的NDCG排序指标梯度相结合，演进出了LambdaDNN，是一种listwise的学习方式。因此我们尝试将LambdaDNN模型应用在了Qunar搜索推荐下的精排阶段，</p>
<p>模型学习目标定义为曝光转化率（ctcvr）。LambdaDNN的搭建主要包括了框架选型、样本构造、特征工程、模型离线训练及线上化，其中样本与特征决定了模型效果的上限。接下来分别介绍下这几个部分：</p>
<h5 data-id="heading-6">2.1 框架选型</h5>
<p>TensorFlow Ranking (TFR) 是 TensorFlow 官方开发的 LTR 框架，旨在基于 TensorFlow 开发和整合 LTR 相关的技术，使开发人员可以更加方便的进行 LTR 算法的开发。TFR 使用了 Estimator API，提供了排序任务常见的损失函数和指标计算实现，比如 listwise Loss 和 NDCG指标。</p>
<p>根据训练流程，模块结构可以分成特征输入、特征转换、模型打分和损失计算等模块。这样的模块划分可以提高后续快速迭代的便利性和灵活性，而不用关注于各种实施上的细节。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c9f88896d04b62955d7c15426048ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=c0Lk9FUAZD7fFIyfho785K1RB9A%3D" alt="" loading="lazy"/></p>
<p align="center">图3 TFRanking框架</p>
<p>如上图3所示，model_fn 参数内需要自己设计和开发的算法模型模块。在这个 model_fn 中，需要自行设计模型结构 (Scoring Function)，然后用模型计算的 logit 和 label 来计算 Loss 和 Metrics，最后利用 Optimizer 来进行模型的优化。图3中的下方部分为使用 TFR 服务的整个流程。</p>
<p>为了配合 TFR 框架中的 LTR 相关的 Loss 和 Metrics 来实现 LTR 的训练，训练数据需要以 listwise 的形式组织。即LTR 模型与一次只对一个item进行分类的标准分类模型不同，它会将整个items列表接收输入，并学习排序，充分提升整个list列表的效用，如图4所示。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35f1b0bc8ad846c1b12835b31e1ff1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=SJbAjGqzjFbEd33Pq%2BZCemzdVxs%3D" alt="" loading="lazy"/></p>
<p align="center">图4 listwise的学习方式</p>
<h5 data-id="heading-7">2.2 模型结构</h5>
<p>我们使用的模型结构，借鉴了Airbnb的深度学习[3]模型演进的经验，模型探索的原则是从简单到复杂，逐步积累经验，针对特征数量不多的情况下，使用非常深的网络，会导致过拟合。因此，如图5所示，采用了简单2层隐藏层的金字塔网络结构。</p>
<p>对一个query下的样本计算Lambda Loss，优化网络参数。其中，模型调优参数，batch size为1024，加入dropout和Batch Normalization（BN），梯度优化器是Adam，学习率为0.01。输入特征仅为77维，隐藏层神经元数为[128，86]。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e9e9ca5a1b49008405301c2cd77764~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=sOg9Q15hSmzp2zBuldyRlgMZVs4%3D" alt="" loading="lazy"/></p>
<p align="center">图5 模型结构</p>
<h5 data-id="heading-8">2.3 样本构造</h5>
<p>为了训练listwise模型，需要构造样本来表示用户的查询query和item之间的关系。图6(左图)显示了一个典型的用户搜索旅程的简化示例，其中客户在多天内进行多次query搜索，并点击多个搜索结果以查看其详细页面，最终在第M日query#3下的结果列表中用户点击了酒店（hotel-b）和下单了酒店（hotel-d），整个会话以用户下单酒店成功结束。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e73372caac2496ea7a067f68e712fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=zg%2BsK07AYu7CPp%2F3tCVxNDVcsys%3D" alt="" loading="lazy"/></p>
<p align="center">图6 用户搜索行为示例</p>
<p>在我们的业务场景下，线上业务优化目标为下单转化率，对应离线建模目标为曝光转化率（ctcvr），即从search到order的转化，训练的目标是从曝光到下单的转化。</p>
<ul>
<li>list列表选择：
<ul>
<li>在以Listwise方式学习时，我们只使用含有成功下单的搜索列表（Day M的query#3）为List训练样本，Day1和Day2下的无下单列表样本将丢弃，标签见图6（右图）；</li>
<li>原因是若将只有点击标签的list加入训练，在计算NDCG时，不管点击标签的值是0.01还是1，ndcg的值都是一样，此时计算LambdaLoss时，模型会更倾向于只有点击的list，重点优化了ctr。</li>
</ul>
</li>
<li>正样本构造：
<ul>
<li>下单酒店标签1；</li>
<li>点击酒店标签0.01，标签值表示样本和query的相关度大小，可根据实验效果调整（点击和下单相关度比值我们是数据统计得来）。我们认为用户点击过的酒店是具有一定的喜好，不能简单的设置标签为0。</li>
</ul>
</li>
<li>负样本构造：
<ul>
<li>hard negative sample：曝光未下单且未点击的酒店；</li>
<li>easy negative sample：在同一个list列表中，采样list列表最底部的n家(&lt;&lt;当次请求曝光酒店数)未曝光的酒店，标签为0。由于线上精排排序家数较多，只选取曝光样本训练，模型对easy负样本学习不好。推荐结果会有部分低质量酒店，需要采样部分低质酒店作为easy negative sample，修正线上线下样本分布偏差，提升模型泛化能力。</li>
</ul>
</li>
<li>样本量：模型训练的样本以时间维度切分，30天为训练集，7天作为验证集，7天作为测试集。</li>
</ul>
<p>工程实践：Listwise学习方式的Lambda梯度需要对同Query下的样本进行计算。因此我们需要对样本进行预处理：将同一个查询(Query)的样本聚合在一起，采用ExampleListWithContext编码方式，将这些样本打包进一个TFRecord中。由于每次请求Query召回的item数不一样，对于可变Size的Query样本在拉取数据进行训练时需要注意，TF会自动补齐Mini-Batch内每个样本大小一致。</p>
<h5 data-id="heading-9">2.4特征工程</h5>
<p>特征工程主要包括特征构建、特征分析、特征处理，以及特征选择等：</p>
<p><strong>特征构建：</strong></p>
<ul>
<li>用户特征：用户行为特征，如过去1年下单的次数，下单该酒店的次数，用户画像等</li>
<li>酒店特征：属性特征等，如价格，档次，星级，点击率，转化率，节假日等</li>
<li>交叉特征：用户到酒店的距离，poi到酒店的距离等</li>
<li>上下文特征：时间，搜索场景等</li>
</ul>
<p><strong>构建原则：</strong></p>
<ul>
<li>防止特征穿越</li>
<li>尽量和业务相关</li>
<li>有区分性，尽量使特征能很好的区分出正负样本。</li>
</ul>
<p><strong>特征选择：</strong></p>
<ul>
<li>深度模型相对于树模型对特征值的大小更敏感，没有像树模型一样有自动特征选择功能，引入一些冗余特征会增大深度模型的噪声。因此我们基于LambdaMart的特征重要性排序，选取最重要的特征训练LambdaDnn，如图7所示，top49维（总维度是200维）时，测试集合的ndcg@10指标（test_ndcg）和全量特征ndcg@10（origin_test_ndcg）相比持平，且特征在top25维时指标不在增长。考虑到深度模型的参数空间更大，学习能力更强，我们在top49维特征的基础上，基于人工经验又挑选了28维特征，一共77维。</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f97d6acfe2f4dcd870fee8b89fd7f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=CFy1WTk%2BLM%2FjFSCYEuK2O%2FJsLRg%3D" alt="" loading="lazy"/></p>
<p align="center">图7 选择不同top数量的特征训练后的模型效果</p>
<p><strong>特征分析：</strong></p>
<p>深度模型对特征大小较为敏感，因此特征处理的好坏直接影响后续模型的表现。</p>
<ul>
<li>长尾分布：例如点击率、点击次数等特征，80%的值分布在靠近0的附近，若直接加入模型训练，由于值差距太小，和其他特征相比没有区分性，因此需要做一些log变换后为正态分布，更有利于模型收敛。如下表：</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/020bbec932a1457295073a1bb73a80a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=Nyfl8xGaxl4mXHDmjf%2BHMQDa6Xc%3D" alt="6ba3501906803be67bc43b369df8b67b.png" loading="lazy"/></p>
<ul>
<li>正态分布：价格等取值较大连续特征，使用了最大最小归一化方法，将特征值都转化为0-1之间的数值。</li>
<li>缺失值填补：在训练样本中不可避免地有部分连续特征存在缺失值，合理处理缺失值会对最终效果有一定帮助。填补缺失值的方式有：
<ul>
<li>取零值，会导致相应权重无法进行更新，收敛速度减慢。</li>
<li>取平均值也略显武断，毕竟不同的特征缺失所表示的含义可能不尽相同。</li>
<li>我们希望神经网络也可以通过学习的方式自适应地处理缺失值，而不是人为设置默认值。对较为重要的特征（特征重要度可通过模型的信息增益得分得到），且缺失率较大的，填补值为0，同时对缺失特征学习一个缺失权重，如下公式所示：</li>
</ul>
</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/242195055ceb4845980ea7fe670e1412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=bGeg6MBXCJhvjZz%2BhkD8OG2YaVk%3D" alt="" loading="lazy"/></p>
<p>我们通过上述变换方式，让所有特征范围在0-1之间或者0附近，在输入模型后经过一层bn操作进行正态分布处理。当然还有其他处理方式，具体还要根据自己业务选择合适的处理方式。</p>
<h5 data-id="heading-10">2.5 实验评估</h5>
<p>baseline模型即LambdaMart，离线ndcg@10效果如下表，LambdaDnn线上转化率提升0.5%。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2df1297120f343a7a846f49b23cf1444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=8WqxqrvSK4qIrQ6wXsWvSMZIuWo%3D" alt="61f15fcf5396064c9e98db66661b2597.png" loading="lazy"/></p>
<h4 data-id="heading-11">3. 多目标模型优化</h4>
<p>在类似电商搜索推荐系统中，用户的行为通常按照一种序列化的模式进行，即首先是曝光，然后是点击，最后是转化。因此，CTCVR模型的作用是预估在曝光发生后的转化概率。</p>
<h5 data-id="heading-12">3.1 为什么选择多目标建模？</h5>
<p><strong>单目标方式缺陷：</strong></p>
<p>1）样本选择偏差问题</p>
<ul>
<li>训练阶段：Listwise模式训练样本是用户最后一次在Day M日query#3下的下单列表，下单前的行为列表都被丢弃。</li>
<li>在线推断：query#1、query#2的列表都会经过推理，此时样本是有选择偏差的，离线训练和在线推理样本分布不一致，模型很难学习到真实样本分布信息，导致模型的泛化性能降低；</li>
<li>对无下单行为的用户学习效果较差</li>
</ul>
<p>2）模型分可解释性差</p>
<ul>
<li>Listwise模式学习的输出是偏序关系，值范围较大，不是在[0-1]之间，且每一次请求的值范围区间不同，对后续业务重排策略调整难度较大。若归一化到[0-1]后，不像实际ctr一样具有物理含义。</li>
</ul>
<p>3）数据稀疏，模型泛化能力不足</p>
<ul>
<li>若pointwise模式只使用曝光和下单样本训练CTCVR目标时，下单数据非常稀疏，下单样本的数量远远小于曝光样本。而利用CTR任务的丰富数据可以帮助CTCVR任务克服数据稀疏性问题，提高模型的泛化能力和预测性能</li>
</ul>
<p><strong>多目标优势：</strong></p>
<p>1）缓解样本偏差，及稀疏性</p>
<ul>
<li>将曝光点击下单都可以加入到模型中学习</li>
</ul>
<p>2）可解释性好</p>
<ul>
<li>输出值是概率意义，更好融合后面的重排加权策略；</li>
</ul>
<p>3）促进作用</p>
<ul>
<li>通过共享一些浅层次的特征，多任务学习可以借助彼此之间的相似性和差异性来促进学习过程</li>
</ul>
<p>4）约束作用</p>
<ul>
<li>当多个任务同时进行反向传播时，由于不同任务具有不同的噪声模式，多目标可以将多个任务的反馈信息结合起来，平均噪声模式，从而得到更一般和稳定的表征，有点像正则化的作用。通过这种方式，相对于单个任务，模型的过拟合风险会降低，泛化能力会提高。</li>
</ul>
<h5 data-id="heading-13">3.2 多目标建模选型</h5>
<p>MMOE是谷歌18年提出的模型结构，其思想是所有目标共享多个experts，但是考虑到不同任务之间的差异性，为每一个目标设置一个gate门控网络，用来控制不同目标选择每个expert的信号占比，类似于weighted sum pooling操作。</p>
<p>MMOE（如图8所示）通过共享experts学习到不同任务的联系和差异，提高了每个任务的学习效率和质量，同时通过gates来平衡多个任务对experts信号的选择，不要求目标之间必须是高相关性的，MMOE是业界通用的多目标实现算法。</p>
<p>多目标建模更好的考虑了排序全空间的曝光样本，综合考虑了下单前的用户点击行为，降低样本偏差问题，引入了多个专家、2个目标任务、一个CTR目标任务和一个CTCVR目标任务。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13cd33a45b334a079829c586a29a9183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=QqL9TVZAcK4beXbAo8D67gCuoNM%3D" alt="" loading="lazy"/></p>
<p align="center">图8 MMOE网络结构</p>
<h5 data-id="heading-14">3.3 MMOE样本选择</h5>
<p>1）只选取有行为的搜索列表，即该列表是有被点击或被下单的酒店的列表；</p>
<ul>
<li>原因：正负样本比例相差较大，过滤一部分认为无效负样本；其次训练时避免没有正行为用户的影响，在一批数据中如果某个用户对所有展示的物品都没有点击等行为，应当过滤掉该用户的记录（没有正行为用户只提供负例，看不出用户喜好，对模型训练没有帮助）。</li>
</ul>
<p>2）选取每个列表的曝光样本，以及每个列表的最底部未曝光的n家酒店作为easy negative sample，防止排序出一些较差的酒店。</p>
<p>3）同一个请求列表中的酒店被点击多次的，只记录一次点击行为，即一次点击正样本。</p>
<h5 data-id="heading-15">3.4 MMOE训练过程中遇到的问题</h5>
<p>1）实际的业务数据中，曝光到转化过于稀疏，具体训练过程中ctcvr的loss明显比ctr的loss小。为了使得2个目标任务的loss的量级一致，并没有采用loss加权处理，而是在样本构造过程中对下单样本进行上采样复制，保持正负样本1:1，基本上可以使得目标loss大小量级一样。</p>
<p>这样在训练shuffle时，不会使得一个正样本在batch内重复出现N次，使得ctcvr任务泛化性更好，同时对ctr任务中的上采样过的点击样本进行降权处理，恢复原先样本分布。</p>
<p>2）gate network输出进入饱和区，反向传播梯度消失：</p>
<p>expert gate输出，是由输入特征经过门网络后softmax得到，在训练的过程中，经过一段迭代次数，门控网络的输入值方差变大，经过softmax后gate network大部分输出是0，在这种情况下，multi expert的优势就没办法发挥出来，</p>
<p>一种解决方式是dropout，依然解决不了部分值偏大的问题；另一种方式对进入softmax之前的得分，进行得分除以一个lambda平滑处理（即，温度系数的调节），缓解部分专家退化现象；这里取lambda为输入特征的维度，也可以参考self-attention。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0118f6a54044ce39a428fb4bfa5eb78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=EgkKNgifd7oyugJLm%2BfverfEzJI%3D" alt="微信图片_2026-01-14_153851_295.png" loading="lazy"/></p>
<p>如下表指数e函数曲线中所示，x的域范围在[-10,10]区间时，softmax的值很容易在x小于-2.5时为0，x大于10时为1。如果将x缩放尺度为1/100，就会缓解退化问题。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30798f72e0334d6dbe3b5bd9678c0c4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=aL2ZZJA2fid2p7Mygh3OlD8XXws%3D" alt="3b9aedd9a2ea098fd6d5f8fb47021e6d.png" loading="lazy"/></p>
<h5 data-id="heading-16">3.5 实验结果</h5>
<p>线上预测时，我们会加权融合两个目标预测值作为排序分，而融合权重可以通过离线数据拟合得到。</p>
<p>从下表中，我们的MMOE最终的离线指标NDCG@10没有提升，主要的原因是测试集是只能在有下单的请求上预测，而lambda直接学习的ndcg目标，所以ndcg更高。而多目标线上的ctr有明显提升，线上点击率提升2%，转化率持平。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1176845db93740caa18c492ce2534015~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=277IzinRpbECKQIFvO2oFx%2FfMCk%3D" alt="e69c4c99b5bbf117b81801da690150a3.png" loading="lazy"/></p>
<h4 data-id="heading-17">4. 多场景多目标优化</h4>
<h5 data-id="heading-18">4.1 业务背景</h5>
<p>在用户出行想要预定酒店时，搜索酒店列表是一个常见的行为。根据用户所处空间不同、搜索行为不同，分为：异地空搜，同城空搜等场景，并且一个用户会跨不同场景进行搜索。而之前模型建模，每个场景单独训练一个模型，一是树模型容量小等历史原因延续单独建模，二是每个场景下所使用的特征不一样，特征的索引也没有对齐。</p>
<p>单独建模不会受到其他场景下的特征影响，其次也可学到单个场景独有的一些特点。但是带来的问题是不同场景下的共有信息无法相互共享、无法迁移学习，造成了信息孤岛。因为同一个用户会在不同场景下都有搜索行为，将同一个用户行为样本分开建模显然是不合理的，同时对多个模型的维护成本也很高。</p>
<p>因此，升级到了MMOE模型后，我们考虑将几个场景下的样本融合学习一个模型，宗旨是既可以学习到场景间独有信息，也能迁移学习不同场景下的共有信息。</p>
<h5 data-id="heading-19">4.2 多场景样本如何进行融合？</h5>
<p>不同场景下用户和item存在重叠，具有一定共性，不同场景下的用户行为，具有一定差异性；不同任务之间具有不同的稀疏性，同时也存在相互影响；如果在建模过程中忽略了多场景和多任务之间的共性和差异性，会影响建模效果，如果多个场景和任务不能很好地进行平衡，会存在场景跷跷板和 任务跷跷板现象。</p>
<p>一开始我们也是调研了目前不同场景下建模的方式，如阿里STAR、HMOE等多场景建模方式，但是效果不佳。原因是STAR、HMOE模型都是对不同场景下的分布差异较大的样本进行建模，会有比较好的效果。例如、淘宝的商品的主搜列表推荐、和主页的猜你喜欢等不同的多个频道的建模，而在去哪儿的酒店场景，其实还都是一个频道，用户的行为分布都是一致的，在目的地确定的前提下，无论是poi搜索、同城搜索，都是想预定目的地下的符合需求的酒店。</p>
<p>因此，我们尝试了直接将多个场景的样本放在一起学习，同时特征一起输入到MMOE中，简单的hard-share效果比STAR、HMOE效果会好。我们将训练完的模型，输出每个场景的专家权重，来分析不同场景下的权重是否分布一样。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620531d072224d5fb4bc9ea125aeb245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=AzAfm2Qg2IYUrVHG95Qh3jUcXig%3D" alt="" loading="lazy"/></p>
<p align="center">图9 不同场景下样本在专家下的权重占比</p>
从图9来看，不同场景下的专家权重，分布几乎一致，最高的权重是专家2。侧面验证了，在我们的业务下场景间的分布差异没有很大。线上的下单转化相对提升0.56%。
<h5 data-id="heading-20">4.3 多场景下特征如何对齐？</h5>
<p>对于酒店业务下的特征，特征主要分为4类：</p>
<ul>
<li>场景无关特征：如酒店价格、用户点击次数、下单次数等</li>
<li>场景共有特征：如酒店在poi下的转化率、点击率等，此时特征会共用一个特征索引</li>
<li>场景独有特征：如同城空搜下用户距离酒店的距离，poi场景下poi距离酒店的距离等，此时，特征索引不共用</li>
<li>场景标识特征：主要就是场景 ID 类特征</li>
</ul>
<p>如上所述，输入部分，将场景的domain信息作为特征和场景共有特征一起拼接输入到感知网络中，抽取场景间共性信息；将场景的domain信息作为特征和场景特有特征一起拼接输入到感知网络中，抽取场景间差异信息；</p>
<p>如果统一作为MMOE的输入直接输入，模型无法很好的学习到不同场景的差异，若人为先验的分为上述几类特征，拉平场景特征之间的差异。可以使得模型在一个稳定的样本分布下学习，增强模型对用户跨域行为的底层感知能力。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d28ab86b110f4bce87e3ed19d8c457a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=fA7N5%2B6eD21BrF4FennTBtmF0b8%3D" alt="微信图片_2026-01-14_154104_798.png" loading="lazy"/></p>
<p align="center">图10 多场景多目标网络结构</p>
<h5 data-id="heading-21">4.4 实验评估</h5>
<ul>
<li>在v2阶段多场景样本合并时，ndcg@10指标提升不大，多个场景下的样本融合后，网络的参数量不能很好的表达出场景间的特性。</li>
<li>因此，将网络专家数扩大到8个，希望每个专家能充分学习到场景间差异，离线指标ndcg@10相对v1提升0.19%，上线后，s2o指标提升0.46%，另外，我们做了其他的专家数量的实验，发现增加9个以后，ndcg指标没有什么变化。</li>
<li>为了更好的对齐场景的特征差异，我们对输入特征分类建模输入MMOE（v4）。此时，离线指标ndcg@10相对提升0.22%，上线后，s2o指标提升0.51%。</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26887a13085a47f6a05120a1c194a068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=941VOboOfo8q4E3QLFF%2FD%2F8aABY%3D" alt="f523e796169819e3bd5fd590008d0956.png" loading="lazy"/></p>
<h4 data-id="heading-22">5. 特征选择</h4>
<h5 data-id="heading-23">5.1 为什么需要做特征选择？</h5>
<p>随着Qunar酒店排序模型业务需求的迭代，越来越多的特征被引入模型中，导致出现如下问题：</p>
<ul>
<li>冗余特征增多
<ul>
<li>有些特征可能与当下的问题无关。这意味着它们与模型要解决的任务完全无关，丢弃不相关的特征可以防止模型得到无关特征上可能携带的虚假相关性，从而避免过拟合。</li>
</ul>
</li>
<li>维度灾难
<ul>
<li>特征选择技术在具有许多特征但训练示例很少的场景中尤为重要。这种情况受到所谓的维度灾难的影响：在高维空间中，每个训练示例都与其他所有示例相距甚远，因此模型无法学习任何有用的模式。</li>
</ul>
</li>
<li>训练时间长
<ul>
<li>特征越多，训练时间就越长。这种权衡的具体细节取决于所使用的特定学习算法，但在需要实时进行再训练的情况下，可能需要限制在几个最佳特征中进行。</li>
</ul>
</li>
<li>部署工作成本高
<ul>
<li>特征越多，机器学习系统在生产中就越复杂。这会带来多种风险，包括但不限于高维护工作量、纠纷、未申报的使用者或纠正级联。</li>
</ul>
</li>
<li>可解释性差
<ul>
<li>由于特征太多，我们失去了模型的可解释性。虽然对模型结果的解释并不总是主要的建模目标，但通常很重要，在某些受监管的领域，甚至可能是法律要求。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-24">5.2 传统特征选择方法</h5>
<ul>
<li>无监督的特征选择方法</li>
<li>包装器特征选择方法</li>
<li>过滤器特征选择方法</li>
<li>Boruta（布尔塔）方法</li>
</ul>
<p>上述传统方法更适合数量小，训练时间短，模型简单的场景。而我们深度模型采用了基于dropout 的特征选择，借鉴了论文Dropout Feature Ranking for Deep Learning Models 的工作。</p>
<h5 data-id="heading-25">5.3 使用变分dropout来做特征的排序</h5>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd6610248cf4492aaed4e594ac015450~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=tWSu32VhRWdNZJtv0mnYD9BfZ38%3D" alt="" loading="lazy"/></p>
<p align="center">图11 dropout的训练前后的丢弃概率示意图</p>
<p>基于两阶段，第一阶段需要先训练一个pretrained Model 这样先学习模型的参数，第二阶段固定模型参数不做梯度更新，对输入的特征增加一个dropout丢弃变量（可导）与输入特征元素相乘，这个阶段的主要目的是优化该dropout丢弃概率。</p>
<p>如图11所示，论文提出了Dropout Feature Ranking方法，在训练完后，可以获取到每个特征的重要度。</p>
<p>本质的思想是将不可导的离散变量dropout，采用Concrete relaxation操作，对符合伯努利分布的离散变量近似估计为一个连续可导变量。松弛为连续性的噪声扰动过程，使其可以进行梯度更新。并对1-dropout_rate添加正则，使其在训练中尽可能最小化。图12 中的p就是特征的丢弃概率。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81b817f69e9042f1be01342919c68fe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=3NG00dQ5uG1A4WOXDhwkHjT3jxo%3D" alt="" loading="lazy"/></p>
<p align="center">图12 dropout layer层</p>
<p>这种方案的优点：</p>
<ul>
<li>通用性高：可以应用于任何深度学习模型</li>
<li>简单方便：在训练好的模型只进行一次dropout参数训练即可得出特征重要性排序，无需进行多次实验来剔除特征</li>
<li>效果可靠：该方法在实际业务应用中展现出了出色的特征筛选效果。</li>
</ul>
<h5 data-id="heading-26">实验效果：</h5>
<p>1、为了验证无效特征会影响模型的效果，我们在模型的原特征基础上增加了10个随机生成的噪声生成噪声特征（在某些特征上添加均匀分布噪声、高斯分布噪声等）</p>
<p>2、加上DFR层后，删减了14维特征后，模型效果不但没有下降，反而有微弱的提升。删除特征重新训练模型，线上转化率提升0.2%。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ac2afe054b45b690a6a39c3907ef33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=LbydBDARjkm5MJjZffdDZ%2F2yzCg%3D" alt="4cbe3a5269eb4687a95e6edaaaa684d3.png" loading="lazy"/></p>
<p>3、使用DFR算法后，特征重要性如下：</p>
<ul>
<li>基本上是实时特征更重要</li>
<li>我们将低于对照特征（高斯噪声）重要度分的特征删除，基本上是一些冗余特征。</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6bad579cdc49b9b72d422a46eabd1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769150161&amp;x-signature=zLYMWwRJjzNyKUsDuWfq9KcujpQ%3D" alt="973e23cd3794b64133c5763dbd144d8d.png" loading="lazy"/></p>
<h2 data-id="heading-27">五、阶段总结和未来规划</h2>
<p>本文主要介绍Qunar在酒店搜索精排模型上的演进实践，从实验效果来看，证明了深度模型在酒店搜索排序的有效性，以及合理引入多场景特征间的差异建模可以让模型更好的理解数据。</p>
<p>对于接下来的深度模型优化：借鉴listwise的建模方式，将pointwise loss和listwise loss融合，既可以学习排序，又可以学习判别分类。</p>
<p>[1]Chris J.C. Burges. 2010. From RankNet to LambdaRank to LambdaMART: An Overview. Technical Report. <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.microsoft.com%2Fen-us%2Fresearch%2Fpublication%2Ffrom-ranknet-to-lambdarank-to-lambdamart-an-overview%2F" target="_blank" title="https://www.microsoft.com/en-us/research/publication/from-ranknet-to-lambdarank-to-lambdamart-an-overview/" ref="nofollow noopener noreferrer">www.microsoft.com/en-us/resea…</a></p>
<p>[2] Rama Kumar Pasumarthi, Sebastian Bruch, Xuanhui Wang, Cheng Li, Michael Bendersky, Marc Najork, Jan Pfeifer, Nadav Golbandi, Rohan Anil, Stephan Wolf.</p>
<p>TF-Ranking: Scalable TensorFlow Library for Learning-to-Rank.KDD 2019.</p>
<p>[3] Haldar M, Abdool M, Ramanathan P, et al. Applying deep learning to airbnb search[C]//Proceedings of the 25th ACM SIGKDD International Conference on Knowledge Discovery &amp; Data Mining. 2019: 1927-1935.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java双亲委派模型工作原理]]></title>    <link>https://juejin.cn/post/7595472747455676431</link>    <guid>https://juejin.cn/post/7595472747455676431</guid>    <pubDate>2026-01-16T01:51:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595472747455676431" data-draft-id="7595400254348378127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java双亲委派模型工作原理"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-16T01:51:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java双亲委派模型工作原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T01:51:41.000Z" title="Fri Jan 16 2026 01:51:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、双亲委派模型的核心机制</h2>
<h3 data-id="heading-1">1.1 类加载器的层级结构</h3>
<p>Java类加载器采用<strong>树形层级结构</strong>，包含三类核心加载器：</p>
<ul>
<li><strong>Bootstrap ClassLoader（启动类加载器）</strong> ：由C++实现，负责加载JVM核心类库（如<code>java.lang.*</code>），位于<code>&lt;JAVA_HOME&gt;/lib</code>目录。</li>
<li><strong>Extension ClassLoader（扩展类加载器）</strong> ：加载<code>&lt;JAVA_HOME&gt;/lib/ext</code>目录或<code>java.ext.dirs</code>指定的扩展类。</li>
<li><strong>Application ClassLoader（应用类加载器）</strong> ：默认加载用户类路径（Classpath）上的类，是自定义类加载器的父加载器。</li>
</ul>
<p>三者通过组合关系形成层级，而非继承。</p>
<h3 data-id="heading-2">1.2 双亲委派的工作流程</h3>
<p>当类加载器收到加载请求时，执行以下步骤：</p>
<ol>
<li><strong>检查缓存</strong>：若当前加载器已加载该类，直接返回。</li>
<li><strong>委派父加载器</strong>：递归请求父加载器加载（直至Bootstrap）。</li>
<li><strong>父加载失败后自加载</strong>：若父加载器无法加载，当前加载器调用<code>findClass()</code>方法加载。</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ClassLoader源码核心逻辑（简化）</span>
protected Class&lt;?&gt; <span class="hljs-built_in">loadClass</span>(String name, boolean resolve) {
    synchronized (getClassLoadingLock(name)) {
        Class&lt;?&gt; c = <span class="hljs-built_in">findLoadedClass</span>(name);
        if (c == null) {
            try {
                if (parent != null) {
                    c = parent<span class="hljs-selector-class">.loadClass</span>(name, false); <span class="hljs-comment">// 委派父加载器</span>
                } else {
                    c = <span class="hljs-built_in">findBootstrapClassOrNull</span>(name); <span class="hljs-comment">// Bootstrap加载</span>
                }
            } catch (ClassNotFoundException ignored) {}
            if (c == null) {
                c = <span class="hljs-built_in">findClass</span>(name); <span class="hljs-comment">// 自加载</span>
            }
        }
        if (resolve) <span class="hljs-built_in">resolveClass</span>(c);
        return c;
    }
}
</code></pre>
<p>此流程确保<strong>类加载请求最终由最顶层的Bootstrap尝试处理</strong>。</p>
<hr/>
<h2 data-id="heading-3">二、双亲委派的核心优势</h2>
<h3 data-id="heading-4">2.1 安全性保障</h3>
<ul>
<li><strong>核心类库保护</strong>：用户自定义的<code>java.lang.String</code>等类会被Bootstrap加载器拦截，避免篡改核心API。</li>
<li><strong>沙箱隔离</strong>：恶意代码无法通过覆盖核心类实现攻击。</li>
</ul>
<h3 data-id="heading-5">2.2 唯一性与稳定性</h3>
<ul>
<li><strong>类唯一性</strong>：类由<strong>全限定名+加载器实例</strong>共同标识，避免重复加载。</li>
<li><strong>资源一致性</strong>：确保<code>System.getProperty("java.version")</code>等全局资源加载一致性。</li>
</ul>
<h3 data-id="heading-6">2.3 性能优化</h3>
<ul>
<li>减少重复类加载的开销，尤其对频繁使用的类（如集合框架）效果显著。</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、破坏双亲委派的典型场景</h2>
<h3 data-id="heading-8">3.1 SPI机制（服务提供接口）</h3>
<ul>
<li>
<p><strong>问题</strong>：<code>java.sql.Driver</code>由Bootstrap加载，但具体实现（如MySQL驱动）需由应用类加载器加载。</p>
</li>
<li>
<p><strong>实现</strong>：通过<code>Thread.currentThread().getContextClassLoader()</code>获取上下文加载器，打破委派链。</p>
<pre><code class="hljs language-ini" lang="ini">// JDBC驱动加载示例
ServiceLoader&lt;Driver&gt; <span class="hljs-attr">loader</span> = ServiceLoader.load(Driver.class, Thread.currentThread().getContextClassLoader())<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-9">3.2 应用服务器热部署</h3>
<ul>
<li>
<p><strong>Tomcat的WebappClassLoader</strong>：优先从<code>WEB-INF/lib</code>加载类，而非委派给父加载器，实现Web应用隔离。</p>
</li>
<li>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Tomcat类加载逻辑（简化）</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Class</span>&lt;?&gt; <span class="hljs-title function_">loadClass</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"com.example.app"</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">findClass</span>(name); <span class="hljs-comment">// 自优先加载</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">loadClass</span>(name);
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-10">3.3 模块化框架（OSGi）</h3>
<ul>
<li><strong>动态模块加载</strong>：每个Bundle拥有独立类加载器，支持热插拔。</li>
<li><strong>选择性委派</strong>：仅对<code>java.*</code>等核心包委派，其他包由自身加载。</li>
</ul>
<hr/>
<h2 data-id="heading-11">四、破坏双亲委派的后果与风险</h2>
<h3 data-id="heading-12">4.1 类重复加载与类型冲突</h3>
<ul>
<li>
<p><strong>问题</strong>：不同加载器加载同名类（如<code>com.user.User</code>），导致<code>ClassCastException</code>。</p>
<pre><code class="hljs language-ini" lang="ini">// 示例：两个Web应用加载不同版本的Log4j
ClassLoader <span class="hljs-attr">loader1</span> = app1.getClassLoader()<span class="hljs-comment">;</span>
ClassLoader <span class="hljs-attr">loader2</span> = app2.getClassLoader()<span class="hljs-comment">;</span>
Class&lt;?&gt; <span class="hljs-attr">log4j1</span> = loader1.loadClass(<span class="hljs-string">"org.apache.log4j.Logger"</span>)<span class="hljs-comment">;</span>
Class&lt;?&gt; <span class="hljs-attr">log4j2</span> = loader2.loadClass(<span class="hljs-string">"org.apache.log4j.Logger"</span>)<span class="hljs-comment">;</span>
// log4j1 != log4j2，类型不兼容
</code></pre>
</li>
</ul>
<h3 data-id="heading-13">4.2 核心类库篡改风险</h3>
<ul>
<li><strong>恶意代码注入</strong>：若绕过双亲委派加载伪造的<code>java.lang.Runtime</code>，可能执行危险操作。</li>
</ul>
<h3 data-id="heading-14">4.3 内存泄漏与类卸载失败</h3>
<ul>
<li><strong>类加载器泄漏</strong>：自定义加载器持有静态引用（如缓存），导致其无法被GC回收，连带类也无法卸载。</li>
<li><strong>元空间OOM</strong>：频繁加载/卸载类导致元空间膨胀。</li>
</ul>
<hr/>
<h2 data-id="heading-15">五、最佳实践与调优建议</h2>
<h3 data-id="heading-16">5.1 谨慎打破双亲委派</h3>
<ul>
<li><strong>限定范围</strong>：仅在必要时（如SPI、热部署）局部打破，避免全局破坏。</li>
<li><strong>隔离策略</strong>：使用独立类加载器加载高风险代码，并限制其权限。</li>
</ul>
<h3 data-id="heading-17">5.2 类加载器管理</h3>
<ul>
<li>
<p><strong>弱引用缓存</strong>：对<code>Class</code>对象使用<code>WeakReference</code>，避免内存泄漏。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">WeakReference</span>&lt;Class<span class="hljs-meta">&lt;?</span>&gt;&gt; clazzRef = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakReference</span>&lt;&gt;(MyClass.<span class="hljs-keyword">class</span>);
</code></pre>
</li>
<li>
<p><strong>清理机制</strong>：在Web应用停止时，显式卸载类加载器并释放资源。</p>
</li>
</ul>
<h3 data-id="heading-18">5.3 监控与调试</h3>
<ul>
<li>
<p><strong>JVM参数</strong>：</p>
<ul>
<li><code>-verbose:class</code>：跟踪类加载过程。</li>
<li><code>-XX:+TraceClassLoading</code>：输出详细加载日志。</li>
</ul>
</li>
<li>
<p><strong>工具分析</strong>：使用JConsole、VisualVM监控类加载器状态。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-19">六、总结</h2>
<p>双亲委派模型通过<strong>层级委派、唯一性保障</strong>和<strong>安全隔离</strong>，成为Java类加载机制的基石。尽管在SPI、热部署等场景中需灵活打破该模型，但开发者需深刻理解其风险，通过<strong>隔离加载、严格资源管理</strong>和<strong>监控调优</strong>规避潜在问题。未来，随着模块化系统（如Project Jigsaw）的普及，类加载机制将更趋精细化，但双亲委派的核心思想仍将延续。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React从入门到出门第九章 资源加载新特性Suspense 原生协调原理与实战]]></title>    <link>https://juejin.cn/post/7595478717985243145</link>    <guid>https://juejin.cn/post/7595478717985243145</guid>    <pubDate>2026-01-16T01:22:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595478717985243145" data-draft-id="7590309337861570601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React从入门到出门第九章 资源加载新特性Suspense 原生协调原理与实战"/> <meta itemprop="keywords" content="JavaScript,前端框架,React.js"/> <meta itemprop="datePublished" content="2026-01-16T01:22:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React从入门到出门第九章 资源加载新特性Suspense 原生协调原理与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T01:22:30.000Z" title="Fri Jan 16 2026 01:22:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 提到 React 的 Suspense，很多开发者的第一印象是“用来做代码分割”或“配合 lazy 加载组件”。但在 React 19 之前，Suspense 在资源加载场景下始终有个致命短板：无法原生协调多个异步资源的加载状态，导致我们需要写大量模板代码处理“多资源并行加载”“依赖资源串行加载”等场景。</p>
<p>React 19 彻底解决了这个问题，推出了 <strong>Suspense 原生协调</strong> 特性，让多资源加载的状态管理变得极简。今天这篇文章，我们就从“旧版 Suspense 的痛点”出发，一步步拆解 React 19 原生协调的核心原理，再通过 4 个高频实战案例，带你彻底掌握这个新特性的用法，让资源加载逻辑更清晰、代码更简洁～</p>
<h2 data-id="heading-0">一、先回顾：旧版 Suspense 的资源加载痛点</h2>
<p>在 React 19 之前，Suspense 虽然能处理单个异步资源的“加载中 fallback”，但面对多资源加载场景时，就显得力不从心了。我们先通过两个常见场景，看看旧版 Suspense 的问题所在。</p>
<h3 data-id="heading-1">1. 痛点 1：多资源并行加载，需手动管理整体状态</h3>
<p>假设我们需要在页面中同时加载“用户信息”和“用户订单列表”两个异步资源，要求两个资源都加载完成后再展示页面，加载过程中显示统一的 loading。在 React 19 之前，我们需要手动管理两个资源的加载状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19 之前：多资源并行加载的繁琐实现</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/orders'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDashboard</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 手动管理两个资源的加载状态和结果</span>
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [orders, setOrders] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 并行请求两个资源</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">fetchUser</span>(), <span class="hljs-title function_">fetchOrders</span>()])
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[userData, ordersData]</span>) =&gt;</span> {
        <span class="hljs-title function_">setUser</span>(userData);
        <span class="hljs-title function_">setOrders</span>(ordersData);
      })
      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span>))
      .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>));
  }, []);

  <span class="hljs-comment">// 手动处理 loading 和 error 状态</span>
  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载失败：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (!user || !orders) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的仪表盘<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的订单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {orders.map((order) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{order.id}</span>&gt;</span>{order.title} - ￥{order.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这种写法的问题很明显：<strong>需要手动用 useState 管理多个资源的状态，用 Promise.all 协调并行逻辑，代码模板化严重</strong>。如果资源数量增加到 3 个、4 个，状态管理会变得更加混乱。</p>
<h3 data-id="heading-2">2. 痛点 2：依赖资源串行加载，逻辑嵌套冗余</h3>
<p>再看一个更复杂的场景：加载“用户订单详情”需要先加载“用户信息”（获取用户 ID），再根据用户 ID 加载“订单列表”，最后根据订单 ID 加载“订单详情”。这种串行依赖的场景，在旧版 React 中需要嵌套多层 Promise，逻辑繁琐：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// React 19 之前：串行资源加载的嵌套实现</span>
function <span class="hljs-built_in">OrderDetail</span>() {
  const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null);
  const <span class="hljs-selector-attr">[order, setOrder]</span> = <span class="hljs-built_in">useState</span>(null);
  const <span class="hljs-selector-attr">[detail, setDetail]</span> = <span class="hljs-built_in">useState</span>(null);
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(true);
  const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">setLoading</span>(true);
    <span class="hljs-built_in">setError</span>(null);

    <span class="hljs-comment">// 串行请求：用户信息 → 订单列表 → 订单详情</span>
    <span class="hljs-built_in">fetchUser</span>()
      <span class="hljs-selector-class">.then</span>((userData) =&gt; {
        <span class="hljs-built_in">setUser</span>(userData);
        return <span class="hljs-built_in">fetchOrders</span>(userData.id); <span class="hljs-comment">// 依赖用户 ID</span>
      })
      <span class="hljs-selector-class">.then</span>((ordersData) =&gt; {
        const firstOrder = ordersData<span class="hljs-selector-attr">[0]</span>;
        <span class="hljs-built_in">setOrder</span>(firstOrder);
        return <span class="hljs-built_in">fetchOrderDetail</span>(firstOrder.id); <span class="hljs-comment">// 依赖订单 ID</span>
      })
      <span class="hljs-selector-class">.then</span>((detailData) =&gt; {
        <span class="hljs-built_in">setDetail</span>(detailData);
      })
      <span class="hljs-selector-class">.catch</span>((err) =&gt; <span class="hljs-built_in">setError</span>(err.message))
      <span class="hljs-selector-class">.finally</span>(() =&gt; <span class="hljs-built_in">setLoading</span>(false));
  }, <span class="hljs-selector-attr">[]</span>);

  if (loading) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">div</span>&gt;;
  if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载失败：{error}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
  if (!user || !order || !detail) return null;

  return (
    &lt;div&gt;
      &lt;h2&gt;{user.name} 的订单详情&lt;/h2&gt;
      &lt;p&gt;订单号：{order.id}&lt;/p&gt;
      &lt;p&gt;商品：{detail.goodsName}&lt;/p&gt;
      &lt;p&gt;金额：￥{detail.amount}&lt;/p&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p>这种嵌套写法不仅可读性差，而且一旦某个环节需要修改（比如增加一个依赖资源），就需要改动多层代码，维护成本极高。</p>
<h3 data-id="heading-3">3. 痛点总结：旧版 Suspense 为何“不省心”？</h3>
<p>旧版 Suspense 之所以无法解决这些问题，核心原因是：<strong>不具备原生的资源协调能力</strong>。它只能监听单个组件内部的异步资源（比如通过 use() 或 lazy 加载的资源），无法感知多个组件、多个资源之间的依赖关系和加载顺序。因此，开发者必须手动用 Promise 或状态管理库来协调这些资源，导致代码冗余、逻辑复杂。</p>
<h2 data-id="heading-4">二、React 19 核心升级：Suspense 原生协调原理</h2>
<p>React 19 为 Suspense 新增了 <strong>原生协调能力</strong>，核心目标是：<strong>自动感知并协调多个异步资源的加载状态，支持并行、串行等多种加载策略，无需手动管理状态</strong>。这一特性彻底解决了旧版的痛点，让多资源加载变得极简。</p>
<h3 data-id="heading-5">1. 核心概念：什么是“原生协调”？</h3>
<p>Suspense 原生协调，简单来说就是：<strong>当多个异步资源被 Suspense 包裹时，React 会自动收集所有资源的加载状态，根据你指定的策略（并行/串行）等待资源加载完成，再统一渲染内容；期间只显示一个 fallback，错误也会被统一捕获</strong>。</p>
<p>关键变化在于：React 19 让 Suspense 从“单个资源的加载容器”升级为“多个资源的协调器”，能够主动管理多个资源的加载生命周期。</p>
<h3 data-id="heading-6">2. 核心原理：3 步实现资源协调</h3>
<p>Suspense 原生协调的底层原理，依赖于 React 19 对“异步资源调度系统”的升级，核心流程可以拆解为 3 步：</p>
<ol>
<li>
<p><strong>资源收集阶段</strong>：当 Suspense 组件渲染时，React 会自动追踪其内部所有通过 use() 消费的异步资源（或通过 lazy 加载的组件），将这些资源的 Promise 收集到一个“资源队列”中；</p>
</li>
<li>
<p><strong>加载协调阶段</strong>：React 根据 Suspense 的配置（默认并行，可通过配置实现串行），协调资源队列的加载顺序：</p>
<ol>
<li>并行策略：同时触发所有资源的加载，等待所有资源都决议（成功/失败）；</li>
<li>串行策略：按资源的依赖关系依次触发加载，前一个资源成功后再加载下一个；</li>
</ol>
</li>
<li>
<p><strong>状态统一阶段</strong>：在资源加载过程中，Suspense 始终显示 fallback；当所有资源都成功加载，Suspense 会渲染内部内容；如果任何一个资源加载失败，错误会被 ErrorBoundary 统一捕获。</p>
</li>
</ol>
<h4 data-id="heading-7">Suspense 原生协调流程图</h4>
<h3 data-id="heading-8">3. 关键技术：React 19 如何追踪资源依赖？</h3>
<p>Suspense 原生协调的核心技术支撑，是 React 19 对 <code>use()</code> Hook 的增强和“资源依赖追踪机制”：</p>
<ul>
<li><strong>use() 增强</strong>：React 19 中的 use() 不仅能消费单个 Promise，还能将其对应的资源注册到最近的 Suspense 组件中，让 Suspense 感知到这个资源的存在；</li>
<li><strong>依赖追踪</strong>：React 会在组件渲染过程中，通过“上下文”记录当前 Suspense 组件与资源的对应关系，形成一个“资源依赖树”。当资源状态变化时，React 能通过这个树快速定位到对应的 Suspense 组件，触发重新协调。</li>
</ul>
<p>简单来说，React 19 让 Suspense 和 use() 形成了“父子关系”：Suspense 是“协调器”，use() 消费的资源是“被协调的子节点”，协调器统一管理所有子节点的加载状态。</p>
<h2 data-id="heading-9">三、实战演练：4 个高频场景玩转 Suspense 原生协调</h2>
<p>理解了核心原理后，我们通过 4 个真实业务场景，看看 React 19 Suspense 原生协调如何落地。所有案例都基于“use() + Suspense + ErrorBoundary”的组合，无需手动管理任何加载状态。</p>
<h3 data-id="heading-10">场景 1：多资源并行加载（基础用法）</h3>
<p>需求：同时加载“用户信息”和“订单列表”，全部加载完成后展示页面，统一显示 loading，错误统一捕获。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：Suspense 原生协调实现多资源并行加载</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 定义异步请求函数（返回 Promise）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户信息加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/orders'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'订单列表加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-comment">// 2. 子组件：分别使用 use() 消费资源</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>()); <span class="hljs-comment">// 消费用户资源</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的仪表盘<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>()); <span class="hljs-comment">// 消费订单资源</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的订单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {orders.map((order) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{order.id}</span>&gt;</span>{order.title} - ￥{order.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. ErrorBoundary 组件（统一捕获错误）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> };
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span>, error };
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载失败：{this.state.error.message}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-comment">// 4. 父组件：用 Suspense 包裹所有子组件，实现原生协调</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDashboard</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">UserInfo</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心简化点：</p>
<ul>
<li>去掉了所有手动管理的 loading、error、数据状态；</li>
<li>无需用 Promise.all 协调并行资源，Suspense 会自动收集 UserInfo 和 OrderList 中的两个资源，并行加载；</li>
<li>加载状态和错误状态分别由 Suspense 和 ErrorBoundary 统一处理，代码逻辑极度简洁。</li>
</ul>
<h3 data-id="heading-11">场景 2：依赖资源串行加载（通过嵌套 Suspense 实现）</h3>
<p>需求：先加载“用户信息”（获取 user.id），再根据 user.id 加载“订单列表”，最后根据 order.id 加载“订单详情”，串行执行，统一显示 loading。</p>
<p>实现思路：利用 <strong>嵌套 Suspense</strong> 实现串行加载。因为内层 Suspense 会等待外层 Suspense 中的资源加载完成后，才会渲染自身内容，从而触发内层资源的加载。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：嵌套 Suspense 实现串行资源加载</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 异步请求函数（订单和详情依赖前序资源的 ID）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户信息加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/orders?userId=<span class="hljs-subst">${userId}</span>`</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'订单列表加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrderDetail</span>(<span class="hljs-params">orderId</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/orders/<span class="hljs-subst">${orderId}</span>/detail`</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'订单详情加载失败'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
}

<span class="hljs-comment">// 子组件 1：加载用户信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>());
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的订单详情<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单列表中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{user.id}</span> /&gt;</span> {/* 传入 user.id 给下一层 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件 2：加载订单列表（依赖 user.id）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>(userId));
  <span class="hljs-keyword">const</span> firstOrder = orders[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前订单：{firstOrder.id}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单详情中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderDetail</span> <span class="hljs-attr">orderId</span>=<span class="hljs-string">{firstOrder.id}</span> /&gt;</span> {/* 传入 order.id 给下一层 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件 3：加载订单详情（依赖 order.id）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderDetail</span>(<span class="hljs-params">{ orderId }</span>) {
  <span class="hljs-keyword">const</span> detail = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrderDetail</span>(orderId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>商品：{detail.goodsName}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>金额：￥{detail.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>状态：{detail.status}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：最外层 Suspense 统一管理整体加载状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderDetailPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>整体加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">User</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心逻辑：</p>
<ul>
<li>外层 Suspense 包裹 User 组件，等待 fetchUser 完成；</li>
<li>User 组件加载完成后，渲染内层 Suspense 和 OrderList 组件，触发 fetchOrders（依赖 user.id）；</li>
<li>OrderList 组件加载完成后，渲染最内层 Suspense 和 OrderDetail 组件，触发 fetchOrderDetail（依赖 order.id）；</li>
<li>整个过程是串行执行的，最外层 Suspense 会显示整体 loading，也可以为每一层设置单独的 fallback，实现更精细的加载状态展示。</li>
</ul>
<h3 data-id="heading-12">场景 3：混合加载策略（部分并行 + 部分串行）</h3>
<p>需求：加载“用户信息”后，并行加载“订单列表”和“用户收藏”，最后加载“订单详情”。即：串行（用户）→ 并行（订单+收藏）→ 串行（详情）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：混合加载策略（串行+并行）</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params">userId</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchCollections</span>(<span class="hljs-params">userId</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrderDetail</span>(<span class="hljs-params">orderId</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 并行加载订单和收藏的组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderAndCollection</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 两个组件并行加载，由内层 Suspense 协调 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">CollectionList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 订单列表组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>(userId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的订单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{orders.map(o =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{o.id}</span>&gt;</span>{o.title}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 收藏列表组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CollectionList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> collections = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchCollections</span>(userId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我的收藏<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{collections.map(c =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{c.id}</span>&gt;</span>{c.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 订单详情组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderDetail</span>(<span class="hljs-params">{ orderId }</span>) {
  <span class="hljs-keyword">const</span> detail = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrderDetail</span>(orderId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>订单详情<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>商品：{detail.goodsName}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：通过嵌套 Suspense 实现混合策略</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MixedLoadPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户信息中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">UserWrapper</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserWrapper</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>());
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的个人中心<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 并行加载订单和收藏 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单和收藏中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderAndCollection</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{user.id}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      {/* 加载订单详情（依赖订单列表） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单详情中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">OrderDetail</span> <span class="hljs-attr">orderId</span>=<span class="hljs-string">"123"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心思路：通过“不同层级的 Suspense 包裹不同的资源组合”，实现混合加载策略。外层 Suspense 管理串行环节，内层 Suspense 管理并行环节，逻辑清晰，可扩展性强。</p>
<h3 data-id="heading-13">场景 4：动态资源加载（根据用户操作加载资源）</h3>
<p>需求：页面初始只加载“用户信息”，用户点击“查看订单”按钮后，再加载“订单列表”，点击按钮时显示 loading。</p>
<p>实现思路：用 useState 控制动态资源的加载时机，只有当用户点击按钮后，才渲染依赖订单资源的组件，Suspense 会自动捕获这个动态加载的资源。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 19：动态资源加载（用户操作触发）</span>
<span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span>, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOrders</span>(<span class="hljs-params">userId</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 订单列表组件（动态加载）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>(userId));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {orders.map(o =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{o.id}</span>&gt;</span>{o.title} - ￥{o.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>());
  <span class="hljs-keyword">const</span> [showOrders, setShowOrders] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 控制是否加载订单</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{user.name} 的页面<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowOrders(true)}&gt;查看订单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 动态加载订单资源：只有 showOrders 为 true 时才渲染 */}
      {showOrders &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载订单中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">OrderList</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{user.id}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">DynamicLoadPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户信息中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">UserPage</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  );
}
</code></pre>
<p>核心逻辑：</p>
<ul>
<li>初始状态下，showOrders 为 false，OrderList 组件不渲染，fetchOrders 不会被触发；</li>
<li>用户点击按钮后，showOrders 变为 true，OrderList 组件渲染，use(fetchOrders()) 触发请求；</li>
<li>Suspense 捕获 fetchOrders 的加载状态，显示 fallback，加载完成后展示订单列表。</li>
</ul>
<h2 data-id="heading-14">四、避坑指南：使用 Suspense 原生协调的 6 个关键注意点</h2>
<p>在实际使用过程中，有几个容易踩坑的点，需要特别注意，避免出现状态混乱或性能问题。</p>
<h3 data-id="heading-15">1. 必须配合 use() 消费资源</h3>
<p>Suspense 原生协调只能感知通过 <code>use()</code> 消费的异步资源（或通过 <code>React.lazy</code> 加载的组件）。如果直接在组件中用 Promise.then 处理异步请求，Suspense 无法捕获其状态，无法进行协调。</p>
<p>错误示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误：直接用 Promise.then，Suspense 无法感知</span>
function <span class="hljs-built_in">OrderList</span>() {
  const <span class="hljs-selector-attr">[orders, setOrders]</span> = <span class="hljs-built_in">useState</span>(null);
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">fetchOrders</span>()<span class="hljs-selector-class">.then</span>(setOrders);
  }, <span class="hljs-selector-attr">[]</span>);
  return &lt;<span class="hljs-selector-tag">ul</span>&gt;{orders<span class="hljs-selector-class">.map</span>(o =&gt; &amp;lt;li key={o.id}&amp;gt;{o.title}&amp;lt;/li&amp;gt;)}&amp;lt;/<span class="hljs-selector-tag">ul</span>&amp;gt;;
}
</code></pre>
<p>正确示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 正确：用 use() 消费资源，Suspense 可感知</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">OrderList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> orders = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchOrders</span>());
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{orders.map(o =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{o.id}</span>&gt;</span>{o.title}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-16">2. 错误必须用 ErrorBoundary 捕获</h3>
<p>Suspense 只处理“加载中”状态，不处理“加载失败”状态。如果任何一个资源加载失败，会抛出错误，必须用 ErrorBoundary 组件捕获，否则会导致整个应用崩溃。</p>
<h3 data-id="heading-17">3. 嵌套 Suspense 的 fallback 优先级</h3>
<p>当存在嵌套 Suspense 时，<strong>内层 Suspense 的 fallback 会覆盖外层的 fallback</strong>。如果需要显示整体加载状态，可以在最外层设置一个全局 fallback，内层设置局部 fallback，实现分层加载提示。</p>
<h3 data-id="heading-18">4. 避免过度嵌套 Suspense</h3>
<p>虽然嵌套 Suspense 可以实现复杂的加载策略，但过度嵌套会增加 React 的协调成本，影响性能。建议根据实际需求，合理划分 Suspense 的层级，避免不必要的嵌套。</p>
<h3 data-id="heading-19">5. 动态资源加载的状态重置</h3>
<p>当动态加载的资源（如场景 4 中的订单列表）需要重新加载时（比如用户切换了用户 ID），只需修改资源依赖的参数（如 userId），Suspense 会自动重新协调，触发新的请求，无需手动重置状态。</p>
<h3 data-id="heading-20">6. 不支持同步资源的协调</h3>
<p>Suspense 原生协调只针对“异步资源”（返回 Promise 的资源）。如果资源是同步的（如直接导入的静态数据），Suspense 不会对其进行协调，会直接渲染内容。</p>
<h2 data-id="heading-21">五、核心总结</h2>
<p>今天我们详细拆解了 React 19 Suspense 原生协调的核心原理和实战用法，核心要点总结如下：</p>
<ol start="4">
<li>
<p><strong>核心价值</strong>：Suspense 从“单个资源加载容器”升级为“多资源协调器”，自动感知并协调多个异步资源的加载状态，支持并行、串行、混合等多种加载策略，彻底消除资源加载的模板代码；</p>
</li>
<li>
<p><strong>核心原理</strong>：通过“资源收集-加载协调-状态统一”三步流程，结合 use() 的增强和资源依赖追踪机制，实现多资源的自动协调；</p>
</li>
<li>
<p><strong>实战关键</strong>：</p>
<ol>
<li>并行加载：用一个 Suspense 包裹所有资源组件；</li>
<li>串行加载：用嵌套 Suspense 按依赖顺序包裹组件；</li>
<li>动态加载：用状态控制资源组件的渲染时机；</li>
<li>错误处理：必须配合 ErrorBoundary 统一捕获错误。</li>
</ol>
</li>
<li>
<p><strong>避坑要点</strong>：必须用 use() 消费资源，避免过度嵌套，错误处理不能少。</p>
</li>
</ol>
<h2 data-id="heading-22">六、进阶学习方向</h2>
<p>掌握了 Suspense 原生协调的基础用法后，可以进一步学习以下内容，深化理解：</p>
<ul>
<li>Suspense 与 React 19 Action 的协同：如何用 Action 处理表单提交后的资源重新加载；</li>
<li>Suspense 服务器组件（Server Components）的结合：在服务端渲染场景下如何优化资源加载；</li>
<li>资源预加载策略：如何通过 preload 等方式优化 Suspense 的加载体验；</li>
<li>源码阅读：查看 React 19 源码中 Suspense 协调器的实现（重点看 react-reconciler 包中的 Suspense相关逻辑）。</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发～ 有任何问题也可以在评论区留言交流～ 我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[InheritableThreadLocal从入门到放弃]]></title>    <link>https://juejin.cn/post/7595771085393100851</link>    <guid>https://juejin.cn/post/7595771085393100851</guid>    <pubDate>2026-01-16T07:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085393100851" data-draft-id="7595513077221031982" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="InheritableThreadLocal从入门到放弃"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-16T07:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            InheritableThreadLocal从入门到放弃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T07:37:49.000Z" title="Fri Jan 16 2026 07:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：田超辉</p>
<h2 data-id="heading-0">背景：</h2>
<p>一个上线了很久但是请求量很低(平均每天一两次)的历史功能突然出现空指针报错：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8380d11214154ca3aa1ede7eee0545aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=lNRjruk4rpSlLh5PfSXQySnxpTw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>我们翻开代码定位到对应的报错代码：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e753899bf0648b5b420f592accee9ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=CKX7XSnUlViROzcJ4fZ0BtOvDoc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>结合堆栈和代码可以确定是由于bdIdJobMap的值为null导致往bdIdEmployeeJobMap这个map中putAll的时候空指针了。</p>
<p>而bdIdJobMap又取自employeeJobMapThread.get(); 那么这个employeeJobMapThread又是何物？</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a90ab3d7ce7464ea281c7ec4c9c9482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=mUEQtevsu7H%2Fvrz6fgm2xUXhSiw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>哦豁，employeeJobMapThread居然是个InheritableThreadLocal。</p>
<p>梳理一下报错代码的上下文逻辑如下：</p>
<p>1.首先在当前主线程中对InheritableThreadLocal类型变量employeeJobMapThread进行赋值</p>
<p>2.把耗时操作提交到线程池中异步执行，在异步任务中去获取employeeJobMapThread的值（其中线程池配置的coreSize/maxSize均为4，queue大小为3000）</p>
<p>3.在主线程中执行employeeJobMapThread.remove()，在异步任务完成之后没有执行employeeJobMapThread.remove()</p>
<p>4.最后在异步任务中通过employeeJobMapThread获取到的值为null导致后续操作空指针</p>
<p>﻿</p>
<h2 data-id="heading-1">是否和最近的上线有关？</h2>
<p>相信大家都有这样的共识：线上出现报错，首先怀疑是否和最近的上线有关系。</p>
<p>我们做的第一件事情也是排查了近期的上线功能，从上线的功能点和相关代码上来看都和这次报错的代码没什么关系，</p>
<p>因此初步排除了这个原因。所以接下来只能进一步了解代码来排查原因了。</p>
<p>要搞清楚当前报错的根因，毫无疑问肯定是要翻过InheritableThreadLocal这座小山啦。</p>
<p>﻿</p>
<h2 data-id="heading-2">简单聊下InheritableThreadLocal：</h2>
<p>提起ThreadLocal，大家应该相对都比较熟悉了，比如存放登录用户信息到ThreadLocal变量中，然后在接口层可以比较方便的获取登录用户，帮助开发提效。</p>
<p>但是对于InheritableThreadLocal，有不少同学都不太了解。</p>
<p>挑重点来说，InheritableThreadLocal相比ThreadLocal多一个能力：在创建子线程Thread时，子线程Thread会自动继承父线程的InheritableThreadLocal信息到子线程中，进而实现在在子线程获取父线程的InheritableThreadLocal值的目的。</p>
<p>举个简单的栗子对比下InheritableThreadLocal和ThreadLocal：</p>
<pre><code class="hljs language-csharp" lang="csharp">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InheritableThreadLocalTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> InheritableThreadLocal&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        testThreadLocal();
        testInheritableThreadLocal();
    }

    <span class="hljs-comment">/**
     * threadLocal测试
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testThreadLocal</span>()</span> {
        <span class="hljs-comment">// 在主线程中设置值到threadLocal</span>
        threadLocal.<span class="hljs-keyword">set</span>(<span class="hljs-string">"我是父线程threadLocal的值"</span>);

        <span class="hljs-comment">// 创建一个新线程并启动</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-comment">// 在子线程里面无法获取到父线程设置的threadLocal，结果为null</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"从子线程获取到threadLocal的值: "</span> + threadLocal.<span class="hljs-keyword">get</span>());
        }).start();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal测试
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInheritableThreadLocal</span>()</span> {
        <span class="hljs-comment">// 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.<span class="hljs-keyword">set</span>(<span class="hljs-string">"我是父线程inheritableThreadLocal的值"</span>);

        <span class="hljs-comment">// 创建一个新线程并启动</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-comment">// 在子线程里面可以自动获取到父线程设置的inheritableThreadLocal</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"从子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.<span class="hljs-keyword">get</span>());
        }).start();
    }

}
</code></pre>
<p>执行结果：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a27e0ced731d449a9422895fdee5fa21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=1hL1sus%2FV6jSF6Bi1VeFiWZ6oN8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>可以看到子线程中可以获取到父线程设置的inheritableThreadLocal值，但不能获取到父线程设置的threadLocal值。</p>
<p>为什么InheritableThreadLocal能够做到这点呢？</p>
<p>是因为在父线程创建子线程Thread的时候，Thread的构造器内部会自动继承父线程的InheritableThreadLocal到子线程。</p>
<p>Thread源码这两处地方解释了原因：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29640a537a864efba81c146cd6d4bdd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=sBTcTh2NFsxVBa%2BbsOce6IVUnpM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>init方法内部实现：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254227b472ae40ec981fd97a27d667d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=Oc8n%2FZtoMYleuxcPSS1t%2BhFN1BA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>通过这个简单的介绍可以帮助对于InheritableThreadLocal不了解的同学有一个初步的了解，本文不是专门介绍InheritableThreadLocal的深入原理，所以就不展开聊了，大家感兴趣可以自己进一步探索。</p>
<h2 data-id="heading-3">验证InheritableThreadLocal+线程池：</h2>
<p>前面介绍了InheritableThreadLocal可以自动把父线程的InheritableThreadLocal信息继承到子线程Thread中。</p>
<p>但是在业务项目中真正需要用到子线程的时候正经人谁自己new Thread，咱可是用线程池的。</p>
<p>当然了，就像文章开头说明的，这次报错的代码里面也用线程池来执行异步任务。</p>
<p>那么InheritableThreadLocal+线程池的组合会摩擦出什么样的火花呢？</p>
<p>我把这次报错的代码精简之后得到下面的示例（实际代码中往InheritableThreadLocal赋的值类型不是字符串，后面会提到）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dada.bd.data.service;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalWithThreadPoolTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">2</span>,
            <span class="hljs-number">2</span>,
            <span class="hljs-number">0L</span>,
            TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="hljs-number">3000</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
    );

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        testInheritableThreadLocalWithThreadPool();
        threadPoolExecutor.shutdown();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal+线程池测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInheritableThreadLocalWithThreadPool</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.set(<span class="hljs-string">"我是父线程inheritableThreadLocal的值"</span>);

        <span class="hljs-comment">// 2. 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 3. 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"从线程池-子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.get());
        });

        <span class="hljs-comment">// 4. 清除inheritableThreadLocal</span>
        inheritableThreadLocal.remove();
    }

}
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65927ab9fd254ce889a230fadecc03c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=JekI5yxB4la9CisD6N%2Bx4qZ5sII%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>执行结果如图所示，可以看到在线程池里面也可以获取到父线程设置的inheritableThreadLocal值。</p>
<p>接下来我们来分析下InheritableThreadLocal+线程池的执行过程：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d855bd2f3a949e08b221a9a2a80fd00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=PV28SF83kkUQRHLZEiefGOhyI3w%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>也就说只有在以下这两个场景下才会继承父线程的InheritableThreadLocal：</p>
<p>1.线程池当前线程数 &lt; 核心线程数</p>
<p>2.线程池当前线程数 &gt;= 核心线程数 &amp;&amp; 队列已满 &amp;&amp; 线程数 &lt; 最大线程数（本次线上报错的代码使用的线程池设置的coreSize和maxSize一致，所以走不到该场景）</p>
<p>其他情况都是在复用线程池现有的Thread，自然也就不会继承父线程的InheritableThreadLocal。</p>
<p>我们提交多个异步任务到线程池来验证下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dada.bd.data.service;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalWithThreadPoolTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">2</span>,
            <span class="hljs-number">2</span>,
            <span class="hljs-number">0L</span>,
            TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="hljs-number">3000</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
    );

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"张三"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"李四"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"王五"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"赵六"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"孙七"</span>);
        threadPoolExecutor.shutdown();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal+线程池测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInheritableThreadLocalWithThreadPool</span><span class="hljs-params">(String param)</span> {
        <span class="hljs-comment">// 1. 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.set(param);

        <span class="hljs-comment">// 2. 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 3. 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"线程名: "</span> + Thread.currentThread().getName() + <span class="hljs-string">", 父线程设置的inheritableThreadLocal值: "</span> + param + <span class="hljs-string">", 子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.get());
        });

        <span class="hljs-comment">// 4. 清除inheritableThreadLocal</span>
        inheritableThreadLocal.remove();
    }

}
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c89ea48a0e742979b98f8b6c0931014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=9B1N%2F47SLWKdWmw0pLtTvQPkHlU%3D" alt="" loading="lazy"/></p>
<p>﻿</p>
<p>执行结果用表格形式展示如下：</p>






























<table><thead><tr><th>步骤</th><th>使用线程池</th><th>结果解释说明</th></tr></thead><tbody><tr><td>提交第一个异步任务值为【张三】</td><td>创建Thread：pool-1-thread-1</td><td>自动继承父线程的InheritableThreadLocal值【张三】到pool-1-thread-1</td></tr><tr><td>提交第二个异步任务值为【李四】</td><td>创建Thread：pool-1-thread-2</td><td>自动继承父线程的InheritableThreadLocal值【李四】到pool-1-thread-2</td></tr><tr><td>提交第三个异步任务值为【王五】</td><td>复用Thread：pool-1-thread-1</td><td>没有自动继承父线程的InheritableThreadLocal值【王五】，所以拿到了第一个任务提交时Thread继承下来的值【张三】</td></tr><tr><td>提交第四个异步任务值为【赵六】</td><td>复用Thread：pool-1-thread-2</td><td>没有自动继承父线程的InheritableThreadLocal值【赵六】，所以拿到了第一个任务提交时Thread继承下来的值【李四】</td></tr></tbody></table>
<p><strong>可以看到InheritableThreadLocal+线程池的组合，会面临InheritableThreadLocal污染的问题，即异步任务可能取到其他父线程设置的InheritableThreadLocal值。</strong></p>
<p>有同学会提到我们不是在代码里面加了inheritableThreadLocal.remove()来清除inheritableThreadLocal的吗？为什么没有清除掉呢？</p>
<p>这是因为此时我们清除的只是父线程的inheritableThreadLocal，而没有清除子线程的inheritableThreadLocal的缘故。</p>
<p>﻿</p>
<h2 data-id="heading-4">为什么InheritableThreadLocal污染对线上没有产生影响？</h2>
<p>既然InheritableThreadLocal+线程池的组合，会存在InheritableThreadLocal污染的问题，那岂不是线上报错的这段代码也存在这个问题？</p>
<p>再次检查代码，确认历史代码的确存在这个问题，</p>
<p>但是，这个代码上线2年多为啥一直稳定运行且没有用户反馈过功能有问题？只有最近突然出现报错？一时之间脑袋懵懵的。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef1c66e8947748688c007ad7de5b3089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=RWhvCgfynIz91Xgnmv8Ojil9hvE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>仔细检代码之后发现：</p>
<p>这段代码在父子线程之间通过InheritableThreadLocal类型变量employeeJobMapThread传递的值是【全量的&lt;人员Id, 该人员基本信息&gt;结构的map】，可以近乎看做是一个不变的常量，所以虽然异步任务会拿到污染的数据，也是正常可以用的，没有产生业务影响。</p>
<p>这种感觉怎么说呢，只能说感叹前人的智慧，把几乎不可能做到了可能~</p>
<p>好了，到这里我们解释了为什么这段代码上线这么久一直没问题，<strong>因为代码确实有InheritableThreadLocal污染问题，但被污染了也不影响使用。。。所以从最终结果来看确实可以正常运行。</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b1a0c1c64314867a7a181d04306b3fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=wI8FplIjVejiaiVxWKw%2FTxvOghc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-5">什么原因导致子线程获取到的InheritableThreadLocal值是null？</h2>
<p>但是。。。说了这么多，还是不能解释为什么线上代码获取到的inheritableThreadLocal值会是null。</p>
<p>1.难道父线程设置的inheritableThreadLocal值可能会是null？</p>
<p>检查代码发现父线程设置的inheritableThreadLocal不可能为null，顶多会是空集合：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a80e4335b56443fbc540d1c2c701d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=OIHRC0xFlp8KPnfvg6yYLTj80TU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>2.难道是线程池创建之后通过prestartAllCoreThreads初始化了核心线程，在执行异步任务的时候，都是复用的已有线程导致的？</p>
<p>检查了对应线程池的初始化代码，发现并没有初始化核心线程，也排除了这个可能。而且如果真的是该原因22年上线之后功能一定是有问题的，前面说过，该功能上线之后没人反馈过异常，所以也可以排除该原因。</p>
<p>﻿</p>
<p>•该功能22年上线之间2年多一直没人反馈，大概率该功能之前很长时间是正常的，近期由于某个原因导致功能异常</p>
<p>•虽然历史代码的用法存在子任务中获取到的InheritableThreadLocal被污染的问题，但是被污染的值也能用，不影响正确性</p>
<p>•只要线程池中的线程初始化的时候继承了正确的InheritableThreadLocal值，后续就不会被清除掉，也就可以正常运行功能</p>
<p>从这些已知的信息来推断，可以推断出这段历史代码写法虽然有隐患，但是不是引发当前空指针的的原因。</p>
<p>3.剩下的只有一种可能：<strong>存在线程池的共用。</strong></p>
<p><strong>在执行这个报错的异步任务的时候，复用了某个已有的线程A，并且当时创建该线程A的时候，没有继承InheritableThreadLocal，进而导致后面复用该线程的时候，从InheritableThreadLocal获取到的值为null。</strong></p>
<p><strong>而只要是通过这段历史代码创建的线程一定是没问题的，所以一定是存在其他业务共用了这个线程池，并且这个业务优先执行进而初始化了线程池的线程，导致线程池的线程没有继承InheritableThreadLocal。</strong></p>
<p>如下代码示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.dada.bd.data.service;

<span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalWithThreadPoolTest</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-comment">// 这里线程池core/max数量都只有2</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPoolExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">2</span>,
            <span class="hljs-number">2</span>,
            <span class="hljs-number">0L</span>,
            TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="hljs-number">3000</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
    );

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 先执行了不涉及InheritableThreadLocal的子任务初始化线程池线程</span>
        testAnotherFunction();
        testAnotherFunction();
        <span class="hljs-comment">// 后执行了本次的历史代码，其涉及InheritableThreadLocal</span>
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"张三"</span>);
        testInheritableThreadLocalWithThreadPool(<span class="hljs-string">"李四"</span>);
        threadPoolExecutor.shutdown();
    }

    <span class="hljs-comment">/**
     * inheritableThreadLocal+线程池测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInheritableThreadLocalWithThreadPool</span><span class="hljs-params">(String param)</span> {
        <span class="hljs-comment">// 1. 在主线程中设置一个值到inheritableThreadLocal</span>
        inheritableThreadLocal.set(param);

        <span class="hljs-comment">// 2. 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 3. 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"线程名: "</span> + Thread.currentThread().getName() + <span class="hljs-string">", 父线程设置的inheritableThreadLocal值: "</span> + param + <span class="hljs-string">", 子线程获取到inheritableThreadLocal的值: "</span> + inheritableThreadLocal.get());
        });

        <span class="hljs-comment">// 4. 清除inheritableThreadLocal</span>
        inheritableThreadLocal.remove();
    }

    <span class="hljs-comment">/**
     * 模拟另一个独立的功能
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAnotherFunction</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 提交异步任务到线程池</span>
        threadPoolExecutor.execute(() -&gt; {
            <span class="hljs-comment">// 在线程池-子线程里面可以获取到父线程设置的inheritableThreadLocal吗？</span>
            System.out.println(<span class="hljs-string">"线程名: "</span> + Thread.currentThread().getName() + <span class="hljs-string">", 线程池-子线程摸个鱼"</span>);
        });
    }

}
</code></pre>
<p>执行结果：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec173b5ceb94d0e9b2682e36554882a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=VKoOVd2tvXKIH2Rbfbr%2FMTM%2Bv%2B8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>在项目里面搜一下看看，果真如此，有2出地方在用这个线程池，并且另外的一处代码中提交的异步任务不涉及inheritableThreadLocal：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b7252364dd40c481b0e04bd6072312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=371YiGglilqaZ8puW6D2WRpgPbQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>示意图如下：</p>
<p>逻辑执行顺序为：<strong>创建线程池 - 执行功能A - 执行功能A - 执行功能B</strong></p>
<p>其中：</p>
<p>功能A全流程均不涉及InheritableThreadLocal</p>
<p>功能B对应报错的代码，主线程设置InheritableThreadLocal并且在子线程使用</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f046ff6251fe43288c764d29f334b68e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=LU9oGqcE5yfyvlF9i%2FmxCc9UuK4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>至此，线上报错的根因确定了：<strong>就是因为InheritableThreadLocal + 线程池共用导致。</strong></p>
<p>﻿</p>
<p>扩展一下：</p>
<p>假如执行顺序是这样呢：<strong>创建线程池 - 执行功能B - 执行功能B - 执行功能A</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d5962f26cae4b19a6f07e377fadf0b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=7SQpylxXpoblgFCyH5h4bOzgiTA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>结局居然是一切安好。</p>
<p>﻿</p>
<p>假如执行顺序是这样呢：<strong>创建线程池 - 执行功能B - 执行功能A - 执行功能B</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fd8326d9c354a66a1a0bcc0f5cb14dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=R5vDd%2FKkFxDw9dabEwbESC%2BMlHM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>发现了吗？如果应用启动之后功能B先执行并且初始化了线程池所有核心线程，那么一切正常，否则就可能报错。</strong></p>
<p><strong>也就是说功能B是否正常还看运气的，运气好就正常执行，运气不好就报空指针的错。</strong></p>
<p>﻿</p>
<p>这你敢信？</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f53a48af60c44188eb202b8ef47b72a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769153869&amp;x-signature=nxqA6HGHqejuSeVLmqFBwKKPDFg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-6">小插曲：</h2>
<p>这个问题的排查当中还遇到了2个小插曲：</p>
<p>插曲1：</p>
<p>最初怀疑是线程池复用导致的，但是在IDEA里面搜代码的时候粗心大意没有看到其他地方在复用线程池。</p>
<p>因此期间一度自我怀疑见鬼了，导致本来可以一两个小时确定根因的，结果饶了弯路多花了两个小时才确定根因。</p>
<p>所以说<strong>排查问题的时候每一步都要保持细心，得出的每一个结论都应该是证据确凿，理由充分</strong>，</p>
<p>否则会让自己兜兜转转浪费宝贵的时间。</p>
<p>﻿</p>
<p>插曲2：</p>
<p>排查代码的时候发现异步任务代码没有做任何的异常处理，这其实是很坑的。</p>
<p>有经验的同学应该知道，<strong>线程池里面提交异步任务如果没有做异常处理，出现异常的话不会有任何的日志信息。</strong></p>
<p>本地运行的时候会打印到控制台，但是线上控制台的信息可不会记录到日志里面。</p>
<p>所以经常遇到异步任务执行结果不符合预期，但是线上没有任何相关日志就是这个原因。</p>
<p>我们这里有日志是因为使用的线程池是二次封装过的，里面对异步任务做了兜底的异常记录。</p>
<p>﻿</p>
<h2 data-id="heading-7">总结：</h2>
<p>前面分析到了导致空指针的原因是线程池共用导致的老代码报错，而共用这个线程池的代码是新上线的功能引入的。</p>
<p>这就打脸了开头我们检查了上线的功能与此无关，实则有关。</p>
<p>只是我们评估复用线程池的影响时，很难想到会有这样的影响，通常我们会考虑：</p>
<p>1.是否会影响共用该线程池的老功能响应时间边长</p>
<p>2.是否存在父子任务共用线程池导致可能产生死锁</p>
<p>针对InheritableThreadLocal，我个人的建议是：</p>
<p>1.InheritableThreadLocal（其实ThreadLocal也一样）不适合应用于业务代码中，因为他们都是隐式的参数传递，而业务系统中好维护的代码应当是显式的参数传递（我们这个线上问题就采用该方式）</p>
<p>2.框架类代码才是InheritableThreadLocal和ThreadLocal主要发光发热的地方，因为对应的研发水平通常较高，且代码经过严格测试验证，并且较少变动。而业务系统研发水平参差不齐，且经常会发生同步操作变异步等</p>
<p>3.虽然InheritableThreadLocal不建议在业务代码中使用，但是我们还是需要掌握它，不为别的，只有掌握它的优缺点才能告诉自己和他人为什么应该在业务代码中放弃使用它</p>
<p>﻿</p>
<p>针对如何有效的应对业务研发遇到的一些“疑难杂症”，我的建议是：</p>
<p>1.大胆提出合理的假设，小心谨慎进行验证</p>
<p>2.没有充足理由，不要轻易下结论</p>
<p>3.没有头绪时，休息一下，或找合适的人一起探讨，给自己打开新的思路</p>
<p>﻿</p>
<p>最后，愿天下没有故障，没有线上问题，没有bug。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净]]></title>    <link>https://juejin.cn/post/7595495896134647834</link>    <guid>https://juejin.cn/post/7595495896134647834</guid>    <pubDate>2026-01-15T23:48:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595495896134647834" data-draft-id="7595478717984849929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-15T23:48:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T23:48:00.000Z" title="Thu Jan 15 2026 23:48:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净</h2>
<h3 data-id="heading-1">parse_url() 能用，但不够用</h3>
<p>多年来，PHP 开发者处理 URL 的方式大同小异：</p>
<ul>
<li>用 <code>parse_url()</code> 拆分各部分</li>
<li>用 <code>rawurlencode()</code> / <code>urlencode()</code> 转义</li>
<li>用字符串拼接重建最终 URL</li>
<li>遇到"奇怪"输入时，再上几个正则</li>
</ul>
<p>大多数情况下这套流程能跑通。问题在于，URL 处理恰恰是那种"在边角情况下出问题"的领域：编码、fragment、userinfo、国际化域名、"等价但不相同"的 URL，以及各种只在生产日志里才冒出来的边缘场景。</p>
<p>PHP 8.5 提供了一个内置替代方案：一个始终可用的 URI 扩展，提供 API 来按照 RFC 3986 和 WHATWG URL 标准解析、修改 URL/URI。</p>
<p>如果"标准"二字让你觉得抽象，这里给出实际含义：</p>
<ul>
<li>拿到 URI/URL 对象，而不是数组 + 字符串拼接。</li>
<li>用安全的组件 getter 和不可变的 <code>with*()</code> 方法。</li>
<li>你可以选择 RFC 3986 行为（严格 URI，"原始 vs 规范化解码"）或浏览器风格的 WHATWG 行为（Unicode/IDNA、软错误、自动编码）。</li>
</ul>
<p>本文是一篇实战教程，重点讲：</p>
<ul>
<li>为什么手动解析容易出错，</li>
<li>新 URI 对象怎么用，</li>
<li>如何安全地修改/规范化，</li>
<li>在重定向、签名链接等安全敏感场景下如何使用。</li>
</ul>
<p>不讲升级指南，不讲废弃清单——只讲 URI 扩展。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fphp85-uri-extension-safer-cleaner-urls" target="_blank" title="https://catchadmin.com/post/2026-01/php85-uri-extension-safer-cleaner-urls" ref="nofollow noopener noreferrer">原文 别再手写 URL 解析器了：PHP 8.5 URI 扩展让 URL 处理更安全、更干净</a></p>
<h3 data-id="heading-2">手动 URL 解析的问题</h3>
<h4 data-id="heading-3">parse_url() 不解码（而且很容易忘）</h4>
<p>PHP 的 <code>parse_url()</code> 返回各组件，但<strong>不会</strong> URL 解码它们。</p>
<p>也就是说：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$u</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-string">"https://example.com/t%65st?name=Ali%63e#fr%61g"</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u</span>[<span class="hljs-string">'path'</span>]);   <span class="hljs-comment">// "/t%65st"</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u</span>[<span class="hljs-string">'query'</span>]);  <span class="hljs-comment">// "name=Ali%63e"</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u</span>[<span class="hljs-string">'fragment'</span>]); <span class="hljs-comment">// "fr%61g"</span>
</code></pre>
<p>如果你在比较路径或应用路由规则时没有统一解码/规范化，可能会把等价的 URI 当成不同的来处理。</p>
<p>更糟的是：团队往往混用：</p>
<ul>
<li>有些地方用解码后的值，</li>
<li>有些地方用原始值，</li>
<li>再加上散落在各处的临时解码逻辑。</li>
</ul>
<p>这种混乱很容易埋下隐蔽 bug 和安全隐患。</p>
<h4 data-id="heading-4">字符串拼接容易拼出"差一点对"的 URL</h4>
<p>手动重建 URL 容易犯的错：</p>
<ul>
<li>漏掉 <code>?</code> 或 <code>#</code></li>
<li>重复编码</li>
<li>完全没编码</li>
<li>编码错了东西（比如把整个 query string 编码而不是只编码 value）</li>
<li>丢失或打乱参数顺序</li>
<li>空 query/fragment 处理不当</li>
</ul>
<p>一个常见的"差一点对"函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addQueryParam</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$url</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$key</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-variable">$parts</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$url</span>);
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'query'</span>] ?? <span class="hljs-string">''</span>;
    <span class="hljs-variable">$query</span> .= (<span class="hljs-variable">$query</span> === <span class="hljs-string">''</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">'&amp;'</span>) . <span class="hljs-variable">$key</span> . <span class="hljs-string">'='</span> . <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$value</span>);
    <span class="hljs-variable">$out</span> = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'scheme'</span>] . <span class="hljs-string">'://'</span> . <span class="hljs-variable">$parts</span>[<span class="hljs-string">'host'</span>] . (<span class="hljs-variable">$parts</span>[<span class="hljs-string">'path'</span>] ?? <span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$query</span> !== <span class="hljs-string">''</span>) {
        <span class="hljs-variable">$out</span> .= <span class="hljs-string">'?'</span> . <span class="hljs-variable">$query</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$parts</span>[<span class="hljs-string">'fragment'</span>])) {
        <span class="hljs-variable">$out</span> .= <span class="hljs-string">'#'</span> . <span class="hljs-variable">$parts</span>[<span class="hljs-string">'fragment'</span>];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;
}
</code></pre>
<p>看起来没问题。直到遇到：</p>
<ul>
<li>没有 scheme/host 的 URL（相对 URL），</li>
<li>带 userinfo/port 的 URL，</li>
<li>已经编码过的值，</li>
<li>需要 <code>rawurlencode()</code> 规则（RFC 3986）的参数，</li>
<li>应该原样保留的 fragment。</li>
</ul>
<h4 data-id="heading-5">等价的 URL 不一定是相同的字符串</h4>
<p>下面这些可以指向同一个资源，但字符串不同：</p>
<ul>
<li>scheme/host 大小写不同（<code>HTTPS://EXAMPLE.com</code>）</li>
<li>path 中 <code>%65</code> vs <code>e</code>（<code>/t%65st</code> vs <code>/test</code>）</li>
<li>path 中的点号段（<code>/foo/../bar/</code>）</li>
<li>默认端口（https 的 <code>:443</code>）</li>
</ul>
<p>如果你把 URL 当成纯字符串处理，要么：</p>
<ul>
<li>缓存/路由出现诡异问题，</li>
<li>要么安全检查被绕过，因为你比较的是"错误的表示形式"。</li>
</ul>
<h4 data-id="heading-6">IDNA（国际化域名）还涉及安全问题</h4>
<p>如果你允许用户提交 URL，国际化域名可能是合法的——但也可能造成混淆。域名可以用 Unicode 或 punycode（ASCII 形式）表示。RFC 讨论中明确指出人为风险：punycode 域名在 Unicode 渲染时可能看起来像一个熟悉的、但实际不同的域名。</p>
<p>这不是你想用正则"手动处理"然后祈祷没问题的事。</p>
<h3 data-id="heading-7">URI 扩展的概念：URI 对象 + 两套标准</h3>
<p>PHP 8.5 的 URI 扩展提供两个主要类：</p>
<ul>
<li><code>Uri\Rfc3986\Uri</code>（RFC 3986 合规，严格 URI 规则）</li>
<li><code>Uri\WhatWg\Url</code>（WHATWG URL 合规，浏览器风格的 URL 规则）</li>
</ul>
<p>配套的类型包括：</p>
<ul>
<li><code>Uri\InvalidUriException</code></li>
<li><code>Uri\WhatWg\InvalidUrlException</code></li>
<li><code>Uri\WhatWg\UrlValidationError</code> 和 <code>UrlValidationErrorType</code></li>
<li><code>Uri\UriComparisonMode</code>（用于比较）</li>
</ul>
<p>一个关键设计决策：两个实现都是 readonly 且以不可变方式使用——<code>withPath()</code>、<code>withQuery()</code> 等方法返回新实例。</p>
<p>另一个要点：这个扩展在 PHP 8.5 中始终可用，底层由以下库驱动：</p>
<ul>
<li>uriparser（用于 RFC 3986）</li>
<li>Lexbor（用于 WHATWG URL）</li>
</ul>
<p>所以你不需要第三方库就能获得合理的 URL 处理能力。</p>
<h3 data-id="heading-8">创建和解析 URI：从字符串到组件</h3>
<h4 data-id="heading-9">最简单的情况：解析一个 HTTP URL 并访问各部分</h4>
<p>RFC 3986：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://php.net/releases/8.5/en.php"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>(); <span class="hljs-comment">// "https"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();   <span class="hljs-comment">// "php.net"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();   <span class="hljs-comment">// "/releases/8.5/en.php"</span>
</code></pre>
<p>WHATWG：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com/path?query=1#frag"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();      <span class="hljs-comment">// "https"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>();   <span class="hljs-comment">// "example.com"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();        <span class="hljs-comment">// "/path"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();       <span class="hljs-comment">// "query=1"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getFragment</span>();    <span class="hljs-comment">// "frag"</span>
</code></pre>
<p>注意：WHATWG 的 getter 故意不返回分隔符（如 <code>:</code> <code>/</code> <code>?</code> <code>#</code>）。</p>
<h4 data-id="heading-10">构造函数抛异常；parse() 返回 null</h4>
<p>两个实现都支持两种解析风格：</p>
<ul>
<li>构造函数：无效时抛异常</li>
<li><code>parse()</code>：无效时返回 null</li>
</ul>
<p>RFC 3986 行为：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">InvalidUriException</span>;

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"not a uri"</span>);
} <span class="hljs-keyword">catch</span> (InvalidUriException <span class="hljs-variable">$e</span>) {
    <span class="hljs-comment">// 拒绝输入</span>
}

<span class="hljs-variable">$uri</span> = <span class="hljs-title class_">Uri</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"not a uri"</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$uri</span>); <span class="hljs-comment">// null</span>
</code></pre>
<p>WHATWG 行为提供更丰富的错误信息：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">InvalidUrlException</span>;

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"invalid url"</span>);
} <span class="hljs-keyword">catch</span> (InvalidUrlException <span class="hljs-variable">$e</span>) {
    <span class="hljs-comment">// $e-&gt;errors 包含 UrlValidationError 实例</span>
}

<span class="hljs-variable">$errors</span> = [];
<span class="hljs-variable">$url</span> = <span class="hljs-title class_">Url</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"invalid url"</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$errors</span>);
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$url</span>);    <span class="hljs-comment">// null</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$errors</span>); <span class="hljs-comment">// UrlValidationError 数组</span>
</code></pre>
<p>这种区分（硬错误 vs 软错误 vs parse-and-return-null）在 RFC 中有详细说明。</p>
<h4 data-id="heading-11">Base URL 和引用解析（相对 → 绝对）</h4>
<p>有了这个功能，你不再需要手动检查是否以 <code>/</code> 开头然后拼接。</p>
<p>在构造函数或 <code>parse()</code> 中使用 base URL：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.com"</span>);
<span class="hljs-variable">$uri</span>  = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"/foo"</span>, <span class="hljs-variable">$base</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>(); <span class="hljs-comment">// "https://example.com/foo"</span>
</code></pre>
<p>WHATWG 类似：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com"</span>);
<span class="hljs-variable">$url</span>  = <span class="hljs-title class_">Url</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-string">"/foo"</span>, <span class="hljs-variable">$base</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>(); <span class="hljs-comment">// "https://example.com/foo"</span>
</code></pre>
<p>扩展还提供了便捷的 <code>resolve()</code> 方法，以当前对象作为 base。</p>
<h3 data-id="heading-12">安全修改：设置/替换 path、query、fragment（不可变）</h3>
<p>拿到对象后，可以用 <code>with*()</code> 方法修改组件。这些方法返回新实例，原对象保持不变。</p>
<h4 data-id="heading-13">RFC 3986：withPath()、withQuery()、withFragment()</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.com/products?sort=asc#top"</span>);

<span class="hljs-variable">$updated</span> = <span class="hljs-variable">$uri</span>
    -&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">"/products/123"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-string">"sort=desc&amp;ref=home"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withFragment</span>(<span class="hljs-string">"reviews"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>();     <span class="hljs-comment">// 原对象不变</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$updated</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>(); <span class="hljs-comment">// 修改后的</span>
</code></pre>
<p>RFC 3986 提供"原始"和"规范化解码"两种 getter（下一节详述），以及 <code>toString()</code> 和 <code>toRawString()</code> 方法。</p>
<h4 data-id="heading-14">WHATWG：同样的思路，外加 ASCII/Unicode 字符串输出</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com/"</span>);

<span class="hljs-variable">$new</span> = <span class="hljs-variable">$url</span>
    -&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">"/search"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-string">"q=php+8.5"</span>)
    -&gt;<span class="hljs-title function_ invoke__">withFragment</span>(<span class="hljs-string">"results"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>-&gt;<span class="hljs-title function_ invoke__">toUnicodeString</span>();
</code></pre>
<p>WHATWG 有 <code>toAsciiString()</code> 和 <code>toUnicodeString()</code> 两种输出，分别用于机器处理和人类展示。</p>
<h4 data-id="heading-15">一个小但重要的行为：输入中的分隔符</h4>
<p>使用 WHATWG 时，如果你在设置 query/fragment 时不小心包含了 <code>?</code> 或 <code>#</code>，它会把它们当作分隔符并去掉：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com/"</span>);
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-string">"?foo"</span>);
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withFragment</span>(<span class="hljs-string">"#bar"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();    <span class="hljs-comment">// "foo"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getFragment</span>(); <span class="hljs-comment">// "bar"</span>
</code></pre>
<p>这个行为在文档中有明确说明。</p>
<h3 data-id="heading-16">规范化与编码：避免重复编码和"奇怪字符"</h3>
<p>URI 扩展的价值不止于 API 设计——它让你能控制 URL 的表示形式。</p>
<h4 data-id="heading-17">RFC 3986 给你两种表示：原始 vs 规范化解码</h4>
<p>对于大多数组件，<code>Uri\Rfc3986\Uri</code> 暴露：</p>
<ul>
<li>raw：解析器给出的形式（最接近原始输入）</li>
<li>规范化解码：规范化 + 百分号解码，意在成为规范形式且可往返转换</li>
</ul>
<p>RFC 解释了为什么需要两种形式以及何时使用——签名方和 API 客户端通常偏好 raw，而路由/缓存通常偏好规范化解码。</p>
<p>具体效果：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://%61pple:p%61ss@ex%61mple.com:433/foob%61r?%61bc=%61bc#%61bc"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawHost</span>(); <span class="hljs-comment">// "ex%61mple.com"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();    <span class="hljs-comment">// "example.com"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawPath</span>(); <span class="hljs-comment">// "/foob%61r"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();    <span class="hljs-comment">// "/foobar"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawQuery</span>(); <span class="hljs-comment">// "%61bc=%61bc"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();    <span class="hljs-comment">// "abc=abc"</span>
</code></pre>
<p>规范化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"HTTPS://EXAMPLE.COM/foo/../bar/"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawScheme</span>(); <span class="hljs-comment">// "HTTPS"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();    <span class="hljs-comment">// "https"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawHost</span>(); <span class="hljs-comment">// "EXAMPLE.COM"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();    <span class="hljs-comment">// "example.com"</span>

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawPath</span>(); <span class="hljs-comment">// "/foo/../bar/"</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();    <span class="hljs-comment">// "/bar/"</span>
</code></pre>
<h4 data-id="heading-18">WHATWG 在修改时自动编码某些字符</h4>
<p>如果你设置的 path 包含该组件必须百分号编码的字符，WHATWG 会自动编码：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://example.com"</span>);
<span class="hljs-variable">$url</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">"/?#:"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>(); <span class="hljs-comment">// "/%3F%23:"</span>
</code></pre>
<p>这能防止意外构建出损坏的 URL。</p>
<h4 data-id="heading-19">"重复编码"陷阱（以及新 API 如何帮忙）</h4>
<p>重复编码通常这样发生：</p>
<ol>
<li>你用 <code>rawurlencode()</code> 编码一个值，因为"它要放进 URL"</li>
<li>你手动把它加到 query string</li>
<li>后来某处又编码了一次（框架、代理、客户端）</li>
</ol>
<p>使用 URI 对象，一个好做法是：</p>
<ul>
<li>数据保持为普通字符串（未编码）</li>
<li>用 <code>http_build_query()</code> 构建 query（或你偏好的编码器）</li>
<li>把结果传给 <code>withQuery()</code></li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.com/search"</span>);

<span class="hljs-variable">$params</span> = [
    <span class="hljs-string">'q'</span> =&gt; <span class="hljs-string">'php 8.5 uri'</span>,
    <span class="hljs-string">'tag'</span> =&gt; <span class="hljs-string">'url/encoding'</span>,
];

<span class="hljs-comment">// RFC 3986 风格编码（空格用 %20 而非 +）</span>
<span class="hljs-variable">$query</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'+'</span>, <span class="hljs-string">'%20'</span>, <span class="hljs-title function_ invoke__">http_build_query</span>(<span class="hljs-variable">$params</span>));

<span class="hljs-variable">$uri</span> = <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-variable">$query</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toString</span>();
</code></pre>
<p><code>http_build_query()</code> 不一定适合所有场景，但好处是编码规则集中在一处，而非散落在各种字符串拼接里。</p>
<p>如果确实需要对 path 段进行 RFC 3986 原始编码，PHP 的 <code>rawurlencode()</code> 遵循 RFC 3986 规则。</p>
<h3 data-id="heading-20">验证用户输入的 URL：实用的最低规则</h3>
<p>如果输入来自用户（或不可信来源），验证应该有明确的立场。</p>
<p>对于你打算 fetch 或跳转的 URL，一个务实的安全导向模式：</p>
<ul>
<li>必须解析成功（硬错误直接拒绝）</li>
<li>只允许 http / https</li>
<li>URL 中不能有用户名/密码</li>
<li>域名白名单（用 ASCII 形式比较）</li>
<li>可选：限制端口</li>
<li>可选：要求绝对 URL（或相对 URL 基于已知 base 解析）</li>
</ul>
<h4 data-id="heading-21">严格验证 helper（WHATWG 版本）</h4>
<p>WHATWG 适合处理"浏览器风格"URL 和 IDNA。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">InvalidUrlException</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateExternalUrl</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$allowedHosts</span></span>): <span class="hljs-title">Url</span>
</span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$softErrors</span> = [];
        <span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-variable">$input</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$softErrors</span>);
    } <span class="hljs-keyword">catch</span> (InvalidUrlException <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid URL."</span>);
    }

    <span class="hljs-comment">// Scheme 白名单</span>
    <span class="hljs-variable">$scheme</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$scheme</span>, [<span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Unsupported scheme."</span>);
    }

    <span class="hljs-comment">// 禁止凭证</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getUsername</span>() !== <span class="hljs-literal">null</span> || <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPassword</span>() !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Credentials in URL are not allowed."</span>);
    }

    <span class="hljs-comment">// Host 白名单（ASCII 比较）</span>
    <span class="hljs-variable">$host</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> === <span class="hljs-literal">null</span> || !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$host</span>), <span class="hljs-variable">$allowedHosts</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Host not allowed."</span>);
    }

    <span class="hljs-comment">// 可选：端口限制</span>
    <span class="hljs-variable">$port</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getPort</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$port</span> !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$port</span>, [<span class="hljs-number">80</span>, <span class="hljs-number">443</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Port not allowed."</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$url</span>;
}
</code></pre>
<p>几点说明：</p>
<ul>
<li><code>Url</code> 即使解析成功也可能返回软错误。RFC 解释了"软 vs 硬"模型，并给出了解析继续但报告验证错误的例子。</li>
<li>WHATWG 同时暴露 <code>getAsciiHost()</code> 和 <code>getUnicodeHost()</code>；比较通常用 ASCII，展示用 Unicode。</li>
</ul>
<h4 data-id="heading-22">RFC 3986 验证：严格 URI 解析 + 规范化选项</h4>
<p>如果你在验证通用 URI（不只是 HTTP URL），或者你关心 raw vs 规范化解码的表示，<code>Uri\Rfc3986\Uri</code> 是个好选择。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">InvalidUriException</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateHttpUri</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$input</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$allowedHosts</span></span>): <span class="hljs-title">Uri</span>
</span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-variable">$input</span>);
    } <span class="hljs-keyword">catch</span> (InvalidUriException <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid URI."</span>);
    }

    <span class="hljs-variable">$scheme</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$scheme</span>, [<span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Unsupported scheme."</span>);
    }

    <span class="hljs-comment">// Userinfo 在大多数 Web 应用中是个坑</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getUserInfo</span>() !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Userinfo is not allowed."</span>);
    }

    <span class="hljs-variable">$host</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> === <span class="hljs-literal">null</span> || !<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$host</span>), <span class="hljs-variable">$allowedHosts</span>, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Host not allowed."</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uri</span>;
}
</code></pre>
<h3 data-id="heading-23">实际用例：签名链接、安全重定向、规范 URL</h3>
<h4 data-id="heading-24">用例：签名链接而不破坏编码</h4>
<p>签名 URL（HMAC token、临时访问链接、CDN 认证）对表示形式极其敏感。一个小的"规范化变更"就能使签名失效。</p>
<p>这也是 RFC 明确指出"API 客户端或签名方"通常偏好原始表示的原因。</p>
<p>一个简单的签名 URL 方法：</p>
<ol>
<li>构建 URL</li>
<li>对稳定的字符串表示计算签名</li>
<li>把签名作为 query 参数加进去</li>
</ol>
<p>示例，使用 RFC 3986 和 <code>toRawString()</code> 签名：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">signUri</span>(<span class="hljs-params">Uri <span class="hljs-variable">$uri</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$secret</span></span>): <span class="hljs-title">Uri</span>
</span>{
    <span class="hljs-comment">// 当你想避免意外转换时，用 raw string</span>
    <span class="hljs-variable">$baseString</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">toRawString</span>();
    <span class="hljs-variable">$sig</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">'sha256'</span>, <span class="hljs-variable">$baseString</span>, <span class="hljs-variable">$secret</span>);

    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getRawQuery</span>();
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$query</span> ? <span class="hljs-variable">$query</span> . <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">''</span>;
    <span class="hljs-variable">$query</span> .= <span class="hljs-string">'sig='</span> . <span class="hljs-title function_ invoke__">rawurlencode</span>(<span class="hljs-variable">$sig</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-variable">$query</span>);
}

<span class="hljs-variable">$uri</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://download.example.com/file/%2Fsafe?expires=1736035200"</span>);
<span class="hljs-variable">$signed</span> = <span class="hljs-title function_ invoke__">signUri</span>(<span class="hljs-variable">$uri</span>, <span class="hljs-string">"super-secret-key"</span>);

<span class="hljs-keyword">echo</span> <span class="hljs-variable">$signed</span>-&gt;<span class="hljs-title function_ invoke__">toRawString</span>();
</code></pre>
<p>两个要点：</p>
<ul>
<li>你是故意选择 raw 的，因为签名关心的是"线上实际发送的是什么"。</li>
<li>query 构建仍然要小心，避免编码错误。</li>
</ul>
<p>如果你的签名算法需要规范形式（有些确实需要），可以故意对 <code>toString()</code> 签名——但要知道自己在做什么，而不是意外这么做。</p>
<h4 data-id="heading-25">用例：安全重定向（避免开放重定向 + 解析混淆）</h4>
<p>安全重定向问题通常长这样：</p>
<ol>
<li>你有 <code>/login?next=&lt;something&gt;</code></li>
<li>登录后跳转到 next</li>
<li>攻击者尝试 <code>next=https://evil.com</code> 或各种变体</li>
</ol>
<p>一个健壮的模式是：</p>
<ol>
<li>把用户输入解析为相对 URL 或绝对 URL</li>
<li>相对 URL 基于你自己的已知 base 解析</li>
<li>验证 host/scheme 是你的（或在允许列表中）</li>
</ol>
<p>使用 WHATWG：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safeRedirectTarget</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$next</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$appBase</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-variable">$base</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-variable">$appBase</span>);

    <span class="hljs-comment">// 安全解析相对引用</span>
    <span class="hljs-variable">$errors</span> = [];
    <span class="hljs-variable">$resolved</span> = <span class="hljs-title class_">Url</span>::<span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-variable">$next</span>, <span class="hljs-variable">$base</span>, <span class="hljs-variable">$errors</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$resolved</span> === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>(); <span class="hljs-comment">// fallback</span>
    }

    <span class="hljs-comment">// 只允许同 host</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$resolved</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>() ?? <span class="hljs-string">''</span>) !== <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>() ?? <span class="hljs-string">''</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
    }

    <span class="hljs-comment">// 只允许 http/https</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$resolved</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>(), [<span class="hljs-string">'http'</span>, <span class="hljs-string">'https'</span>], <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$base</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$resolved</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
}

<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">safeRedirectTarget</span>(<span class="hljs-string">"/dashboard"</span>, <span class="hljs-string">"https://app.example.com"</span>);
</code></pre>
<p>这里用到了 base URL 解析和引用解析功能。</p>
<h4 data-id="heading-26">用例：规范 URL（SEO 和缓存的一致表示）</h4>
<p>规范化通常意味着：</p>
<ul>
<li>scheme/host 小写</li>
<li>移除 path 中的点号段</li>
<li>移除默认端口</li>
<li>query 保持一致（有时排序）</li>
<li>决定如何处理末尾斜杠</li>
</ul>
<p>使用 <code>Uri\Rfc3986\Uri</code>，你已经可以通过 <code>get*()</code> vs <code>getRaw*()</code>（以及 <code>toString()</code> vs <code>toRawString()</code>）清晰地获得规范化行为。</p>
<p>一个简单的规范化示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canonicalizeForCache</span>(<span class="hljs-params">Uri <span class="hljs-variable">$uri</span></span>): <span class="hljs-title">Uri</span>
</span>{
    <span class="hljs-comment">// 从规范化解码的部分开始</span>
    <span class="hljs-variable">$uri</span> = <span class="hljs-variable">$uri</span>
        -&gt;<span class="hljs-title function_ invoke__">withScheme</span>(<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getScheme</span>())
        -&gt;<span class="hljs-title function_ invoke__">withHost</span>(<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getHost</span>())
        -&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>());

    <span class="hljs-comment">// 为缓存 key 排序 query 参数（这是一种策略选择）</span>
    <span class="hljs-variable">$query</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">getQuery</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$query</span>) {
        <span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$query</span>, <span class="hljs-variable">$params</span>);
        <span class="hljs-title function_ invoke__">ksort</span>(<span class="hljs-variable">$params</span>);
        <span class="hljs-variable">$sorted</span> = <span class="hljs-title function_ invoke__">http_build_query</span>(<span class="hljs-variable">$params</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'&amp;'</span>, PHP_QUERY_RFC3986);
        <span class="hljs-variable">$uri</span> = <span class="hljs-variable">$uri</span>-&gt;<span class="hljs-title function_ invoke__">withQuery</span>(<span class="hljs-variable">$sorted</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$uri</span>;
}

<span class="hljs-variable">$u</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"HTTPS://EXAMPLE.COM/foo/../bar/?b=2&amp;a=1"</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">canonicalizeForCache</span>(<span class="hljs-variable">$u</span>)-&gt;<span class="hljs-title function_ invoke__">toString</span>();
</code></pre>
<p>这个函数不试图覆盖所有规范化策略（那是应用层面的事），但结构化 API 的好处是：规则可以显式构建、可以测试。</p>
<h3 data-id="heading-27">从 parse_url() + 字符串拼接迁移（不痛苦）</h3>
<p>你不需要一次性重写所有代码。最简单的迁移路径是：</p>
<p><strong>1. 找出 URL 处理对安全敏感或容易出 bug 的地方：</strong></p>
<ul>
<li>重定向</li>
<li>webhook 验证</li>
<li>签名 URL</li>
<li>域名白名单</li>
<li>路由/缓存 key</li>
</ul>
<p><strong>2. 先替换这些。</strong></p>
<p><strong>3. 纯展示用途的简单解析，等到有必要时再处理。</strong></p>
<h4 data-id="heading-28">迁移前：数组解析 + 手动重建</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$parts</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$input</span>);
<span class="hljs-variable">$host</span>  = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'host'</span>] ?? <span class="hljs-literal">null</span>;

<span class="hljs-keyword">if</span> (<span class="hljs-variable">$host</span> !== <span class="hljs-string">'example.com'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">"Bad host"</span>);
}

<span class="hljs-variable">$newUrl</span> = <span class="hljs-variable">$parts</span>[<span class="hljs-string">'scheme'</span>] . <span class="hljs-string">'://'</span> . <span class="hljs-variable">$parts</span>[<span class="hljs-string">'host'</span>] . <span class="hljs-string">'/new-path'</span>;
</code></pre>
<p>问题：</p>
<ul>
<li>没处理 port、userinfo、fragment、相对 URL</li>
<li>没有规范化</li>
<li>没有规范化选择</li>
<li>容易构建出无效输出</li>
</ul>
<h4 data-id="heading-29">迁移后：使用 Url/Uri，改动局部化</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;

<span class="hljs-variable">$url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-variable">$input</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">getAsciiHost</span>() ?? <span class="hljs-string">''</span>) !== <span class="hljs-string">'example.com'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Bad host"</span>);
}

<span class="hljs-variable">$new</span> = <span class="hljs-variable">$url</span>-&gt;<span class="hljs-title function_ invoke__">withPath</span>(<span class="hljs-string">'/new-path'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>-&gt;<span class="hljs-title function_ invoke__">toAsciiString</span>();
</code></pre>
<p>代码更短，意图更明确，细节上更难出错。</p>
<h4 data-id="heading-30">RFC 3986 和 WHATWG 怎么选（经验法则）</h4>
<p><strong>使用 <code>Uri\WhatWg\Url</code> 当：</strong></p>
<ul>
<li>你在处理来自浏览器/用户的 HTTP(S) URL</li>
<li>你需要 IDNA/Unicode 域名处理（<code>getUnicodeHost()</code> 用于展示，<code>getAsciiHost()</code> 用于比较）</li>
<li>你想要 WHATWG 解析行为和错误报告（软错误）</li>
</ul>
<p><strong>使用 <code>Uri\Rfc3986\Uri</code> 当：</strong></p>
<ul>
<li>你在处理"Web URL"之外的通用 URI</li>
<li>你需要 raw vs 规范化解码的表示</li>
<li>你在做签名或协议层面的工作，表示形式很重要</li>
</ul>
<p>RFC 明确区分了这两种方法，包括 Unicode/IDNA 支持的差异。</p>
<h3 data-id="heading-31">附加内容：正确比较 URL（equals() 以及为什么没有 __toString()）</h3>
<p>一个值得留意的设计：内置 URI 类故意不实现 <code>__toString()</code>，因为松散比较（<code>==</code>）容易出错。</p>
<p>取而代之，你用 <code>equals()</code> 比较：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">Rfc3986</span>\<span class="hljs-title">Uri</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">UriComparisonMode</span>;

<span class="hljs-variable">$u1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://example.COM#foo"</span>);
<span class="hljs-variable">$u2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uri</span>(<span class="hljs-string">"https://EXAMPLE.COM"</span>);

<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-variable">$u2</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$u1</span>-&gt;<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-variable">$u2</span>, <span class="hljs-title class_">UriComparisonMode</span>::<span class="hljs-variable constant_">IncludeFragment</span>)); <span class="hljs-comment">// false</span>
</code></pre>
<p>WHATWG 类似：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">WhatWg</span>\<span class="hljs-title">Url</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Uri</span>\<span class="hljs-title">UriComparisonMode</span>;

<span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https:////example.COM/"</span>);
<span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Url</span>(<span class="hljs-string">"https://EXAMPLE.COM"</span>);

<span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$a</span>-&gt;<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-variable">$b</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-32">结论</h3>
<p>PHP 8.5 的 URI 扩展看起来是个小功能，用一段时间后才会发现它挡掉了多少细微的 URL bug。</p>
<p>核心价值在于<strong>控制</strong>：</p>
<ul>
<li>你可以选择 RFC 3986 vs WHATWG 语义。</li>
<li>你可以决定要 raw 还是规范化解码的表示。</li>
<li>你可以不可变且安全地修改组件。</li>
<li>你可以用更难意外削弱的方式验证和比较 URL。</li>
</ul>
<p>如果你曾经发布过一个"快速 URL 修复"，后来在安全报告或生产事故中看到它，这个扩展值得尽早采用——从重定向和签名 URL 开始。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java结合大模型文生图实战]]></title>    <link>https://juejin.cn/post/7595513077220524078</link>    <guid>https://juejin.cn/post/7595513077220524078</guid>    <pubDate>2026-01-16T06:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595513077220524078" data-draft-id="7595619510042181670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java结合大模型文生图实战"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-16T06:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java结合大模型文生图实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T06:13:45.000Z" title="Fri Jan 16 2026 06:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java结合大模型文生图实战</p>
<blockquote>
<p><strong>导读</strong>：随着AIGC技术的快速发展，文生图已成为软件开发中的热门功能。本文将带你从零开始，使用Java结合OpenAI的DALL-E模型，构建一个完整的文生图系统。</p>
</blockquote>
<h2 data-id="heading-0">一、技术背景与选型</h2>
<p>2023年全球AIGC市场规模达到150亿美元，预计2025年将突破500亿美元。Java作为企业级开发的主力语言，与AI大模型的结合正成为开发者关注的焦点。</p>
<h2 data-id="heading-1">为什么选择OpenAI DALL-E？</h2>
<pre><code class="hljs">✅ 技术成熟：API稳定，文档完善
✅ 效果优质：生成图片质量高
✅ 集成便捷：提供官方Java SDK
✅ 商业友好：清晰的定价模型
</code></pre>
<h2 data-id="heading-2"><strong>二、系统架构设计</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1386ab3fc2e54d8b89e8e7231e1eef67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=4mGg5JlUAxHy7AE4eaF8tCb0R%2F0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>六层架构体系</strong>：</h2>
<pre><code class="hljs">1️⃣ 表现层：React/Vue前端
2️⃣ API网关层：认证授权、流量管理
3️⃣ 应用服务层：业务逻辑编排
4️⃣ 业务逻辑层：核心算法处理
5️⃣ 数据层：MySQL/Redis/MongoDB
6️⃣ AI服务层：OpenAI DALL-E调用
</code></pre>
<h2 data-id="heading-4"><strong>三、核心代码实现</strong></h2>
<h2 data-id="heading-5">核心依赖配置</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Webflux --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- OpenAI Client --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.theokanning.openai-gpt3-java<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Caffeine缓存 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6"><strong>核心类图</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27d9893693224fbf9d2ada3fa85bdcaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=gJeyeXKTZvrzeN8PaJjqHNC6v8U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>五个核心类</strong>：</h2>
<pre><code class="hljs">🔹 ImageController：处理HTTP请求
🔹 OpenAiImageService：调用OpenAI API
🔹 ImageRequest：请求参数封装
🔹 ImageResponse：响应结果封装
🔹 CacheService：缓存管理
</code></pre>
<h2 data-id="heading-8">核心代码示例</h2>
<h2 data-id="heading-9">ImageRequest - 请求模型</h2>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.textToImage.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> javax.validation.constraints.*;

<span class="hljs-comment">/**
 * 文生图请求参数
 */</span>
@Data
@NoArgsConstructor
@AllArgsConstructor
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageRequest</span> {

    <span class="hljs-comment">/**
     * 提示词
     */</span>
    @<span class="hljs-built_in">NotBlank</span>(message = <span class="hljs-string">"提示词不能为空"</span>)
    @<span class="hljs-built_in">Size</span>(max = <span class="hljs-number">1000</span>, message = <span class="hljs-string">"提示词长度不能超过1000字符"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> prompt;

    <span class="hljs-comment">/**
     * 图片尺寸
     */</span>
    @<span class="hljs-built_in">NotNull</span>(message = <span class="hljs-string">"图片尺寸不能为空"</span>)
    <span class="hljs-keyword">private</span> ImageSize size = ImageSize.S1024X1024;

    <span class="hljs-comment">/**
     * 图片数量
     */</span>
    @<span class="hljs-built_in">Min</span>(value = <span class="hljs-number">1</span>, message = <span class="hljs-string">"图片数量至少为1"</span>)
    @<span class="hljs-built_in">Max</span>(value = <span class="hljs-number">10</span>, message = <span class="hljs-string">"图片数量最多为10"</span>)
    <span class="hljs-keyword">private</span> Integer n = <span class="hljs-number">1</span>;

    <span class="hljs-comment">/**
     * 图片风格
     */</span>
    <span class="hljs-keyword">private</span> ImageStyle style = ImageStyle.VIVID;

    <span class="hljs-comment">/**
     * 用户ID（用于缓存）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> userId;

    <span class="hljs-comment">/**
     * 图片尺寸枚举
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ImageSize</span> {
        <span class="hljs-built_in">S256X256</span>(<span class="hljs-string">"256x256"</span>),
        <span class="hljs-built_in">S512X512</span>(<span class="hljs-string">"512x512"</span>),
        <span class="hljs-built_in">S1024X1024</span>(<span class="hljs-string">"1024x1024"</span>);

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> value;

        <span class="hljs-built_in">ImageSize</span>(<span class="hljs-type">String</span> value) {
            <span class="hljs-keyword">this</span>.value = value;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> value;
        }
    }

    <span class="hljs-comment">/**
     * 图片风格枚举
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ImageStyle</span> {
        <span class="hljs-built_in">NATURAL</span>(<span class="hljs-string">"natural"</span>),
        <span class="hljs-built_in">VIVID</span>(<span class="hljs-string">"vivid"</span>);

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> value;

        <span class="hljs-built_in">ImageStyle</span>(<span class="hljs-type">String</span> value) {
            <span class="hljs-keyword">this</span>.value = value;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> value;
        }
    }
}
</code></pre>
<h2 data-id="heading-10">ImageController - REST接口</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.controller</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageRequest</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageResponse</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.OpenAiImageService</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">lombok</span><span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.http</span><span class="hljs-selector-class">.ResponseEntity</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.validation</span><span class="hljs-selector-class">.Valid</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Arrays</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.CompletableFuture</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * 文生图控制器
 *
 * 提供RESTful API接口
 */</span>
@<span class="hljs-selector-tag">Slf4j</span>
@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/api/images"</span>)
@<span class="hljs-selector-tag">CrossOrigin</span>(origins = <span class="hljs-string">"*"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ImageController</span> {

    <span class="hljs-variable">@Autowired</span>
    private OpenAiImageService imageService;

    <span class="hljs-comment">/**
     * 生成图片 - 同步接口
     */</span>
    <span class="hljs-variable">@PostMapping</span>
    public ResponseEntity&lt;ImageResponse&gt; <span class="hljs-built_in">generateImage</span>(<span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> ImageRequest request) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"收到图片生成请求: prompt={}, size={}"</span>, request.<span class="hljs-built_in">getPrompt</span>(), request.<span class="hljs-built_in">getSize</span>());

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">ImageResponse</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">imageService</span><span class="hljs-selector-class">.generateImage</span>(request);

            <span class="hljs-selector-tag">if</span> (response.<span class="hljs-built_in">getSuccess</span>()) {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()<span class="hljs-selector-class">.body</span>(response);
            }
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"图片生成请求处理失败"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()
                    <span class="hljs-selector-class">.body</span>(ImageResponse.<span class="hljs-built_in">builder</span>()
                            .<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">getMessage</span>())
                            .<span class="hljs-built_in">success</span>(false)
                            .<span class="hljs-built_in">build</span>());
        }
    }

    <span class="hljs-comment">/**
     * 生成图片 - 异步接口
     */</span>
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/async"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">ImageResponse</span>&gt;&gt; <span class="hljs-selector-tag">generateImageAsync</span>(<span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> ImageRequest request) {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"收到异步图片生成请求: prompt={}"</span>, request.<span class="hljs-built_in">getPrompt</span>());

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">CompletableFuture</span><span class="hljs-selector-class">.supplyAsync</span>(() -&gt; {
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-selector-tag">ImageResponse</span> <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">imageService</span><span class="hljs-selector-class">.generateImage</span>(request);

                <span class="hljs-selector-tag">if</span> (response.<span class="hljs-built_in">getSuccess</span>()) {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()<span class="hljs-selector-class">.body</span>(response);
                }
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"异步图片生成请求处理失败"</span>, e);
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()
                        <span class="hljs-selector-class">.body</span>(ImageResponse.<span class="hljs-built_in">builder</span>()
                                .<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">getMessage</span>())
                                .<span class="hljs-built_in">success</span>(false)
                                .<span class="hljs-built_in">build</span>());
            }
        });
    }

    <span class="hljs-comment">/**
     * 批量生成图片
     */</span>
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/batch"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageResponse</span>&gt;&gt;&gt; <span class="hljs-selector-tag">generateImages</span>(
            <span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> List&lt;ImageRequest&gt; requests) {

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">CompletableFuture</span><span class="hljs-selector-class">.supplyAsync</span>(() -&gt; {
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageResponse</span>&gt; <span class="hljs-selector-tag">responses</span> = <span class="hljs-selector-tag">requests</span><span class="hljs-selector-class">.stream</span>()
                        <span class="hljs-selector-class">.map</span>(<span class="hljs-attribute">imageService</span>::generateImage)
                        <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>());

                <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">allSuccess</span> = <span class="hljs-selector-tag">responses</span><span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.allMatch</span>(<span class="hljs-attribute">ImageResponse</span>::getSuccess);

                <span class="hljs-selector-tag">if</span> (allSuccess) {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(responses);
                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()<span class="hljs-selector-class">.body</span>(responses);
                }
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"批量图片生成请求处理失败"</span>, e);
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.internalServerError</span>()
                        <span class="hljs-selector-class">.body</span>(Arrays.<span class="hljs-built_in">asList</span>(ImageResponse.<span class="hljs-built_in">builder</span>()
                                .<span class="hljs-built_in">error</span>(e.<span class="hljs-built_in">getMessage</span>())
                                .<span class="hljs-built_in">success</span>(false)
                                .<span class="hljs-built_in">build</span>()));
            }
        });
    }

    <span class="hljs-comment">/**
     * 生成示例图片
     */</span>
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/examples"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageRequest</span>&gt;&gt; <span class="hljs-selector-tag">getExampleRequests</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ImageRequest</span>&gt; <span class="hljs-selector-tag">examples</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
                <span class="hljs-built_in">createExampleRequest</span>(<span class="hljs-string">"一只可爱的卡通猫，坐在花园里，阳光明媚"</span>, ImageRequest.ImageSize.S1024X1024, <span class="hljs-number">1</span>, ImageRequest.ImageStyle.VIVID),
                <span class="hljs-built_in">createExampleRequest</span>(<span class="hljs-string">"现代城市天际线，夜晚，霓虹灯"</span>, ImageRequest.ImageSize.S1024X1024, <span class="hljs-number">1</span>, ImageRequest.ImageStyle.NATURAL),
                <span class="hljs-built_in">createExampleRequest</span>(<span class="hljs-string">"抽象艺术，彩色几何形状"</span>, ImageRequest.ImageSize.S512X512, <span class="hljs-number">2</span>, ImageRequest.ImageStyle.VIVID)
        );

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(examples);
    }

    <span class="hljs-comment">/**
     * 检查服务状态
     */</span>
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/health"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">String</span>&gt; <span class="hljs-selector-tag">healthCheck</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(<span class="hljs-string">"Image Generation Service is running"</span>);
    }

    <span class="hljs-comment">/**
     * 创建请求
     */</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">ImageRequest</span> <span class="hljs-selector-tag">createExampleRequest</span>(String prompt, ImageRequest.ImageSize size, int n, ImageRequest.ImageStyle style) {
        <span class="hljs-selector-tag">ImageRequest</span> <span class="hljs-selector-tag">request</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ImageRequest</span>();
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setPrompt</span>(prompt);
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setSize</span>(size);
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setN</span>(n);
        <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.setStyle</span>(style);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">request</span>;
    }
}
</code></pre>
<h2 data-id="heading-11"><strong>OpenAiImageService</strong></h2>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.service</span>;

import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ApiKeyConfig</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageRequest</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.textToImage</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.ImageResponse</span>;
import com<span class="hljs-selector-class">.theokanning</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.image</span><span class="hljs-selector-class">.CreateImageRequest</span>;
import com<span class="hljs-selector-class">.theokanning</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.image</span><span class="hljs-selector-class">.ImageResult</span>;
import com<span class="hljs-selector-class">.theokanning</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.OpenAiService</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Cacheable</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Service</span>;

import java<span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.Duration</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Arrays</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Collections</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.UUID</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * OpenAI文生图服务实现
 *
 * 使用DALL-E 3/2模型生成图片
 * 支持多种参数配置
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Service</span>
public class OpenAiImageService {

    <span class="hljs-keyword">@Autowired</span>
    private ApiKeyConfig apiKeyConfig;

    <span class="hljs-comment">/**
     * 生成图片
     */</span>
    <span class="hljs-keyword">@Cacheable</span>(value = <span class="hljs-string">"images"</span>, key = <span class="hljs-string">"#request.prompt + '_' + #request.size + '_' + #request.style"</span>)
    public ImageResponse generateImage(ImageRequest request) {
        long startTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();
        String requestId = UUID<span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();

        try {
            <span class="hljs-comment">// 创建OpenAI服务</span>
            OpenAiService service = <span class="hljs-built_in">createOpenAiService</span>();

            <span class="hljs-comment">// 构建请求参数</span>
            CreateImageRequest imageRequest = <span class="hljs-built_in">buildCreateImageRequest</span>(request);

            <span class="hljs-comment">// 调用API生成图片</span>
            ImageResult result = service<span class="hljs-selector-class">.createImage</span>(imageRequest);

            <span class="hljs-comment">// 构建响应</span>
            ImageResponse response = <span class="hljs-built_in">buildResponse</span>(request, requestId, result, startTime);

            log<span class="hljs-selector-class">.info</span>("图片生成成功: requestId={}, prompt={}", requestId, request.getPrompt());
            return response;

        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("图片生成失败: requestId={}, prompt={}", requestId, request.getPrompt(), e);
            return <span class="hljs-built_in">buildErrorResponse</span>(requestId, e.getMessage(), startTime);
        }
    }

    <span class="hljs-comment">/**
     * 创建OpenAI服务
     */</span>
    private OpenAiService <span class="hljs-built_in">createOpenAiService</span>() {
        if (apiKeyConfig.getUseProxy() &amp;&amp; apiKeyConfig<span class="hljs-selector-class">.getProxy</span>() != null) {
            <span class="hljs-comment">// 代理配置（示例）</span>
            return new <span class="hljs-built_in">OpenAiService</span>(apiKeyConfig.getOpenaiKey(), Duration<span class="hljs-selector-class">.ofSeconds</span>(apiKeyConfig.getTimeout()));
        } else {
            <span class="hljs-comment">// 直接连接</span>
            return new <span class="hljs-built_in">OpenAiService</span>(apiKeyConfig.getOpenaiKey(), Duration<span class="hljs-selector-class">.ofSeconds</span>(apiKeyConfig.getTimeout()));
        }
    }

    <span class="hljs-comment">/**
     * 构建图片请求
     */</span>
    private CreateImageRequest <span class="hljs-built_in">buildCreateImageRequest</span>(ImageRequest request) {
        return CreateImageRequest<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.prompt</span>(request.getPrompt())
                <span class="hljs-selector-class">.n</span>(request.getN())
                <span class="hljs-selector-class">.size</span>(request.getSize()<span class="hljs-selector-class">.getValue</span>())
                <span class="hljs-selector-class">.responseFormat</span>("url")
                <span class="hljs-selector-class">.user</span>(request.getUserId() != null ? request<span class="hljs-selector-class">.getUserId</span>() : <span class="hljs-string">"anonymous"</span>)
                .<span class="hljs-built_in">build</span>();
    }

    <span class="hljs-comment">/**
     * 构建成功响应
     */</span>
    private ImageResponse <span class="hljs-built_in">buildResponse</span>(ImageRequest request, String requestId,
                                       ImageResult result, long startTime) {
        List&lt;String&gt; urls = Arrays<span class="hljs-selector-class">.asList</span>(result.getData()<span class="hljs-selector-class">.stream</span>()
                <span class="hljs-selector-class">.map</span>(image -&gt; image.getUrl())
                <span class="hljs-selector-class">.toArray</span>(String[]::new));

        List&lt;String&gt; imageIds = Collections<span class="hljs-selector-class">.emptyList</span>(); <span class="hljs-comment">// 暂时使用空列表</span>

        return ImageResponse<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.requestId</span>(requestId)
                <span class="hljs-selector-class">.prompt</span>(request.getPrompt())
                <span class="hljs-selector-class">.createdAt</span>(java.time.LocalDateTime.now())
                <span class="hljs-selector-class">.urls</span>(urls)
                <span class="hljs-selector-class">.imageIds</span>(imageIds)
                <span class="hljs-selector-class">.duration</span>(System.currentTimeMillis() - startTime)
                <span class="hljs-selector-class">.success</span>(true)
                <span class="hljs-selector-class">.build</span>();
    }

    <span class="hljs-comment">/**
     * 构建错误响应
     */</span>
    private ImageResponse <span class="hljs-built_in">buildErrorResponse</span>(String requestId, String errorMessage, long startTime) {
        return ImageResponse<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.requestId</span>(requestId)
                <span class="hljs-selector-class">.error</span>(errorMessage)
                <span class="hljs-selector-class">.createdAt</span>(java.time.LocalDateTime.now())
                <span class="hljs-selector-class">.duration</span>(System.currentTimeMillis() - startTime)
                <span class="hljs-selector-class">.success</span>(false)
                <span class="hljs-selector-class">.build</span>();
    }
}
</code></pre>
<h2 data-id="heading-12">四、业务流程详解</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0805a9c66498428b80e59e848aa70aaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=T83iGvnktqU8tT1ADDDbTOGRDlo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>8步完整流程</strong>：</h2>
<pre><code class="hljs">1️⃣ 用户输入文本：前端提交文本描述
2️⃣ 参数验证：校验参数格式和内容
3️⃣ 缓存查询：检查是否已生成过
4️⃣ 构建API请求：组装OpenAI请求
5️⃣ 调用OpenAI：发送图片生成请求
6️⃣ 接收响应：获取图片URL
7️⃣ 处理结果：保存到数据库
8️⃣ 返回图片：响应给用户
</code></pre>
<h2 data-id="heading-14">时序图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2caa60ec4ec946d7b19738e5a807eb95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=5Q5ko1T06kut0cPjPe8Y1ntAsco%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15"><strong>关键交互流程</strong>：</h2>
<p>前端→控制器：POST请求</p>
<p>控制器→服务：参数验证</p>
<p>服务→缓存：查询缓存</p>
<p>服务→OpenAI：API调用</p>
<p>OpenAI→服务：返回图片URL</p>
<p>服务→缓存：更新缓存</p>
<p>服务→控制器：返回响应</p>
<h2 data-id="heading-16">五、缓存机制优化</h2>
<h2 data-id="heading-17">多级缓存策略</h2>
<h2 data-id="heading-18">L1 - Caffeine本地缓存</h2>
<p>读写速度快，适合热点数据</p>
<p>减少网络调用</p>
<h2 data-id="heading-19">L2 - Redis分布式缓存</h2>
<p>支持集群，容量大</p>
<p>集群环境数据共享</p>
<h2 data-id="heading-20">L3 - OpenAI API缓存</h2>
<p>第三方服务自带缓存</p>
<p>降低API成本</p>
<h2 data-id="heading-21">Caffeine</h2>
<pre><code class="hljs language-csharp" lang="csharp">package com.example.textToImage.demo;

import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import com.github.benmanes.caffeine.cache.Expiry;
import org.springframework.stereotype.Component;

import java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * Caffeine缓存演示类
 *
 * Caffeine缓存的基本用法和高级特性
 */</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CaffeineDemo</span> {

    <span class="hljs-comment">/**
     * 创建基础缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">String</span>&gt; <span class="hljs-title">createBasicCache</span>()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 最大缓存数量</span>
                .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS) <span class="hljs-comment">// 写入后1小时过期</span>
                .build();
    }

    <span class="hljs-comment">/**
     * 带有自定义过期策略的缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Object</span>&gt; <span class="hljs-title">createCustomExpiryCache</span>()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
                .expireAfter(<span class="hljs-keyword">new</span> Expiry&lt;String, Object&gt;() {
                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> <span class="hljs-title">expireAfterCreate</span>(<span class="hljs-params">String key, Object <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> currentTime</span>)</span> {
                        <span class="hljs-keyword">return</span> TimeUnit.MINUTES.toNanos(<span class="hljs-number">30</span>); <span class="hljs-comment">// 创建后30分钟过期</span>
                    }

                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> <span class="hljs-title">expireAfterUpdate</span>(<span class="hljs-params">String key, Object <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> currentTime, <span class="hljs-built_in">long</span> currentDuration</span>)</span> {
                        <span class="hljs-keyword">return</span> currentDuration; <span class="hljs-comment">// 更新时不重置过期时间</span>
                    }

                    @Override
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> <span class="hljs-title">expireAfterRead</span>(<span class="hljs-params">String key, Object <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> currentTime, <span class="hljs-built_in">long</span> currentDuration</span>)</span> {
                        <span class="hljs-keyword">return</span> currentDuration; <span class="hljs-comment">// 读取时不重置过期时间</span>
                    }
                })
                .maximumSize(<span class="hljs-number">500</span>)
                .build();
    }

    <span class="hljs-comment">/**
     * 带有统计信息的缓存
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Cache&lt;String, String&gt; <span class="hljs-title">createStatsCache</span>()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .recordStats() <span class="hljs-comment">// 开启统计功能</span>
                .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)
                .build();
    }

    <span class="hljs-comment">/**
     * 缓存操作
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demonstrateCacheOperations</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== Caffeine缓存演示 ==="</span>);

        <span class="hljs-comment">// 创建缓存</span>
        Cache&lt;String, String&gt; cache = createBasicCache();

        <span class="hljs-comment">// 1. 基本操作</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n1. 基本缓存操作:"</span>);

        <span class="hljs-comment">// 存储</span>
        cache.put(<span class="hljs-string">"user:1001"</span>, <span class="hljs-string">"张三"</span>);
        cache.put(<span class="hljs-string">"user:1002"</span>, <span class="hljs-string">"李四"</span>);
        cache.put(<span class="hljs-string">"user:1003"</span>, <span class="hljs-string">"王五"</span>);

        <span class="hljs-comment">// 获取</span>
        String user1 = cache.getIfPresent(<span class="hljs-string">"user:1001"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"获取用户1001: "</span> + user1);

        <span class="hljs-comment">// 使用computeIfAbsent（原子操作）</span>
        String user4 = cache.<span class="hljs-keyword">get</span>(<span class="hljs-string">"user:1004"</span>, k -&gt; <span class="hljs-string">"新用户"</span> + k.substring(k.lastIndexOf(<span class="hljs-string">":"</span>) + <span class="hljs-number">1</span>));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"获取用户1004: "</span> + user4);

        <span class="hljs-comment">// 2. 统计信息</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n2. 缓存统计:"</span>);
        Cache&lt;String, String&gt; statsCache = createStatsCache();

        <span class="hljs-comment">// 模拟一些操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            statsCache.put(<span class="hljs-string">"key:"</span> + i, <span class="hljs-string">"value:"</span> + i);
        }

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) {
            statsCache.getIfPresent(<span class="hljs-string">"key:"</span> + i);
        }

        <span class="hljs-comment">// 打印统计信息</span>
        com.github.benmanes.caffeine.cache.stats.CacheStats stats = statsCache.stats();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存命中次数: "</span> + stats.hitCount());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存未命中次数: "</span> + stats.missCount());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存命中率: "</span> + stats.hitRate());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"加载时间: "</span> + stats.totalLoadTime() + <span class="hljs-string">" ns"</span>);

        <span class="hljs-comment">// 3. 手动失效</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n3. 缓存失效:"</span>);
        cache.invalidate(<span class="hljs-string">"user:1001"</span>); <span class="hljs-comment">// 单个key失效</span>
        cache.invalidateAll(); <span class="hljs-comment">// 全部失效</span>

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存演示完成!"</span>);
    }

    <span class="hljs-comment">/**
     * 图片缓存场景
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demonstrateImageCache</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n=== 图片缓存演示 ==="</span>);

        Cache&lt;String, <span class="hljs-built_in">byte</span>[]&gt; imageCache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">100</span>) <span class="hljs-comment">// 缓存100张图片</span>
                .maximumWeight(<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-comment">// 最大10MB</span>
                .expireAfterWrite(<span class="hljs-number">24</span>, TimeUnit.HOURS) <span class="hljs-comment">// 24小时过期</span>
                .build();

        <span class="hljs-comment">// 模拟图片数据</span>
        <span class="hljs-built_in">byte</span>[] smallImage = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">50</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 50KB</span>
        <span class="hljs-built_in">byte</span>[] largeImage = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 2MB</span>

        <span class="hljs-comment">// 存储图片</span>
        imageCache.put(<span class="hljs-string">"image:small"</span>, smallImage);
        imageCache.put(<span class="hljs-string">"image:large"</span>, largeImage);

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"小图片缓存状态: "</span> +
            (imageCache.getIfPresent(<span class="hljs-string">"image:small"</span>) != <span class="hljs-literal">null</span> ? <span class="hljs-string">"已缓存"</span> : <span class="hljs-string">"未缓存"</span>));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"大图片缓存状态: "</span> +
            (imageCache.getIfPresent(<span class="hljs-string">"image:large"</span>) != <span class="hljs-literal">null</span> ? <span class="hljs-string">"已缓存"</span> : <span class="hljs-string">"未缓存"</span>));

        <span class="hljs-comment">// 获取缓存统计</span>
        com.github.benmanes.caffeine.cache.stats.CacheStats stats = imageCache.stats();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"图片缓存命中率: "</span> + String.format(<span class="hljs-string">"%.2f%%"</span>, stats.hitRate() * <span class="hljs-number">100</span>));
    }
}
</code></pre>
<h2 data-id="heading-22">数据流转</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b40904f168e40d0a82d234f2f1c85d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=sokObZi%2FIcvu5uom26rRt4gDaEU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-23"><strong>智能缓存查询流程</strong>：</h2>
<pre><code class="hljs">1、用户发起请求
2、验证并查询缓存
3、缓存未命中调用API
4、OpenAI生成图片
5、处理结果并缓存
6、返回结果给用户
</code></pre>
<h2 data-id="heading-24">六、性能优化与部署</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e20de3c3a4d44566993e0949d237dc71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769148824&amp;x-signature=QCo8%2Fedj%2BFofoXqJgW4SjfNJA30%3D" alt="部署图.png" loading="lazy"/></p>
<h2 data-id="heading-25">JVM参数优化</h2>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-Xms2g -Xmx4g </span>
<span class="hljs-deletion">-XX:+UseG1GC </span>
<span class="hljs-deletion">-XX:MaxGCPauseMillis=200</span>
</code></pre>
<h2 data-id="heading-26">异步处理配置</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableAsync</span>
public class AsyncConfig {
    <span class="hljs-variable">@Bean</span>
    public Executor <span class="hljs-built_in">taskExecutor</span>() {
        <span class="hljs-selector-tag">ThreadPoolTaskExecutor</span> <span class="hljs-selector-tag">executor</span> = 
            <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ThreadPoolTaskExecutor</span>();
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setCorePoolSize</span>(<span class="hljs-number">5</span>);
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setMaxPoolSize</span>(<span class="hljs-number">20</span>);
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setQueueCapacity</span>(<span class="hljs-number">100</span>);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">executor</span>;
    }
}
</code></pre>
<h2 data-id="heading-27">七、总结</h2>
<h2 data-id="heading-28">多模态融合</h2>
<pre><code class="hljs">文+图→图
图+图→视频
AR/VR内容生成
</code></pre>
<h2 data-id="heading-29">本地化部署</h2>
<pre><code class="hljs">模型小型化
推理优化
成本可控
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArcGIS Pro 实现影像波段合成]]></title>    <link>https://juejin.cn/post/7595878718171496484</link>    <guid>https://juejin.cn/post/7595878718171496484</guid>    <pubDate>2026-01-17T07:17:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595878718171496484" data-draft-id="7595878718171447332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArcGIS Pro 实现影像波段合成"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T07:17:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArcGIS Pro 实现影像波段合成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:17:49.000Z" title="Sat Jan 17 2026 07:17:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>通常，我们下载的卫星影像数据每个波段都存在一个单独的波段中，但是在生产实践中，我们往往需要由各个波段组成的完整数据集。所以，这个时候就需要进行波段合成操作。</p>
</blockquote>
<p>本节主要讲解如何在<code>ArcGIS Pro</code>中实现TIFF影像波段合成。</p>
<h2 data-id="heading-2">1. 软件环境</h2>
<p>本文使用以下软件环境，仅供参考。</p>
<p>时间：2026 年</p>
<p>操作软件：ArcGIS Pro 3.5</p>
<p>操作系统：windows 11</p>
<h2 data-id="heading-3">2. 下载卫星影像数据</h2>
<p>俗话说巧妇难为无米之炊，数据就是软件的基石，没有数据，再美好的设想都是空中楼阁。因此，第一步需要下载遥感影像数据。</p>
<p>但是，影像数据在哪里下载呢？别着急，本文都给你整理好了。</p>
<p>数据下载可参考文章：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5c_J7f0xkUXEv7_z0eNweQ" target="_blank" title="https://mp.weixin.qq.com/s/5c_J7f0xkUXEv7_z0eNweQ" ref="nofollow noopener noreferrer">GIS 影像数据源介绍</a></strong></p>
<hr/>
<p>如下，这是我在【地理空间数据云】平台下载的<code>landsat8</code>遥感影像。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84b92a0b40d4034963934177df1a031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=of2Fly6Jshn0NSPXuxWzZhYbV80%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. ArcGIS Pro 软件安装</h2>
<p>要想使用<code>ArcGIS Pro</code>实现影像波段合成，那你得安装好<code>ArcGIS Pro</code>软件。</p>
<p>但是，软件安装说明不在本文的教程之内，就不进行介绍了，请未安装的同学自行解决。</p>
<h2 data-id="heading-5">4. 波段合成</h2>
<p>好了，经过上面一堆废话，下面正式进入主题，进行实操。</p>
<p>如果有过<code>ArcGIS</code>版本软件基础的同学，可以很快完成，因为<code>ArcGIS Pro</code>和<code>ArcGIS</code>的工具设置大体相同。</p>
<p>我们首先需要找到数据处理工具箱。点击菜单栏分析按钮<code>Analysis</code>，然后再点击工具<code>Tools</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7c8076dc07845479102d90dd17d308a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=OSDuOcG9NRBTxxGad5f1WlZlJ4U%3D" alt="" loading="lazy"/></p>
<p>或者点击软件搜索框中，其中会出现推荐的地理处理工具箱。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5fff6d3407a4e3fb2f8374db9359252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=X%2Fx9moBCXTD6c%2FQQoVqsTsQ%2BLPs%3D" alt="" loading="lazy"/></p>
<p>打开工具之后，点击数据数据处理工具<code>Data Management Tools</code>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b3e6e05dec4467bd3e8cc4b681b24d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=iebeNhWxQ7lVOPMgrOmx7O72sG0%3D" alt="" loading="lazy"/></p>
<p>然后依次点击栅格<code>Raster</code>、栅格处理<code>Raster Processing</code>、波段合成<code>Composite Bands</code>即可。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f510cb90a704b508a978116ba2ef779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=AG0UNLFjvlcGr5GK9ZclORqIJYI%3D" alt="" loading="lazy"/></p>
<p>如果你觉得上述操作路径太长，或者你熟悉操作工具名称的话，可以直接在页面顶部搜索框输入工具名称<code>Composite Bands</code>进行检索。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6b42d3a9c24b4084223de64da05b7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=flCgGSeanif6XunNBJTROOpdmpk%3D" alt="" loading="lazy"/>又或者在地理处理搜索框输入工具名称<code>Composite Bands</code>进行检索。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b25223e45d456ca4e3abab70ecb9ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=uewFzBIH4aBse9eAYUXx0R5GtOw%3D" alt="" loading="lazy"/></p>
<p>打开波段合成工具，先在输入栅格中选择需要进行合成的波段数据，然后选择输出位置，最后点击运行。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bacb94e89a4131ab6db1d68c3a1f2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=usZeSG6NRqEdp5fd4rzI5%2B8nnyQ%3D" alt="" loading="lazy"/></p>
<p>如下为波段4、波段3、波段2合成的彩色效果图。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34917ce015fd4ce5ade7870358129a15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=MNASd9tuC3QJLLRCmt16Popl%2FCQ%3D" alt="" loading="lazy"/></p>
<p>如下为波段5、波段4、波段3合成的彩色效果图。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3587d067d40a452a861ee370223a94fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=M7mI4xsjsA1YzXz9QXb1%2BHchzoA%3D" alt="" loading="lazy"/></p>
<p>可在属性中查看源数据信息，其中三个波段显示如下。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/443efe33146949759ecf91f538658ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=W0KAGiPSKV0nywM84wscE6SFm%2FY%3D" alt="" loading="lazy"/></p>
<p><strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a464e74f3dd1474297f5c6b912c7c142~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=DrwtKbkVjkCn%2BWP5e32RMwsFZAs%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98fb3fd9bb7a4811aea7749e685e59ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=xDF%2Bixl%2FX68BrkFtZzyeGWri1zs%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73ee6be123244a598088074583d02a14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=2D81qCPIatgudDFCfp6FwhehdK4%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7df248a6f1614c67a274cebeaad1fd51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=aQ2DqpsmJynDTpbZt5kktnADd2g%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca3c1964cf644a608241df989ebf3ed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769239069&amp;x-signature=zzPiuq4%2BaowJ0pxpdjAM1Gx%2FwNA%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwkHv2NnJfuPhtyjJcFLrEQ" target="_blank" title="https://mp.weixin.qq.com/s/wkHv2NnJfuPhtyjJcFLrEQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据转换处理（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FMZIQ57Ka3NQfKFi9AuEQEg" target="_blank" title="https://mp.weixin.qq.com/s/MZIQ57Ka3NQfKFi9AuEQEg" ref="nofollow noopener noreferrer">GDAL 实现投影转换</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQVFiW5C5wXQ6a1WODCaH0g" target="_blank" title="https://mp.weixin.qq.com/s/QVFiW5C5wXQ6a1WODCaH0g" ref="nofollow noopener noreferrer">自然资源部党组关于苗泽等4名同志职务任免的通知</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSX2u2ww1iNOtqR5m3BE93g" target="_blank" title="https://mp.weixin.qq.com/s/SX2u2ww1iNOtqR5m3BE93g" ref="nofollow noopener noreferrer">国产版的Google Earth，吉林一号卫星App“共生地球”来了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfWufqSyplniNj4Q3BRRbAQ" target="_blank" title="https://mp.weixin.qq.com/s/fWufqSyplniNj4Q3BRRbAQ" ref="nofollow noopener noreferrer">2026年全国自然资源工作会议召开</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FRq7mCSrKU7DA7WRGDEy6Cg" target="_blank" title="https://mp.weixin.qq.com/s/Rq7mCSrKU7DA7WRGDEy6Cg" ref="nofollow noopener noreferrer">日本欲打造“本土版”星链系统</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FEqpOD--IdOUO6gyzwBc6RA" target="_blank" title="https://mp.weixin.qq.com/s/EqpOD--IdOUO6gyzwBc6RA" ref="nofollow noopener noreferrer">吉林一号国内首张高分辨率彩色夜光卫星影像发布</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FznfhqB1_3JbQHG7CEqWSCw" target="_blank" title="https://mp.weixin.qq.com/s/znfhqB1_3JbQHG7CEqWSCw" ref="nofollow noopener noreferrer">2025 年度信创领军企业名单出炉！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的手势冲突解决了吗？鸿蒙事件拦截机制全解析]]></title>    <link>https://juejin.cn/post/7595552420047568939</link>    <guid>https://juejin.cn/post/7595552420047568939</guid>    <pubDate>2026-01-16T08:00:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595552420047568939" data-draft-id="7595552420047552555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的手势冲突解决了吗？鸿蒙事件拦截机制全解析"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2026-01-16T08:00:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的手势冲突解决了吗？鸿蒙事件拦截机制全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T08:00:04.000Z" title="Fri Jan 16 2026 08:00:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>哈喽，兄弟们，我是 V 哥！
在鸿蒙开发中，尤其是做复杂的交互页面（比如<strong>列表里套按钮</strong>、<strong>横滑菜单</strong>、<strong>地图缩放</strong>）时，手势事件就像是一群调皮的孩子，谁都想抢着接盘。如果你不管好他们，App的体验会差强人意。</p>
<p>关于鸿蒙API 21 的事件拦截机制。这三招，专治各种“乱跳”、“误触”和“滑动失效”。代码我都给你写好了，直接复制就能治好你的 App！</p>
<hr/>
<h2 data-id="heading-0">痛点一：点击冒泡 —— “我点的按钮，你关列表什么事？”</h2>
<h3 data-id="heading-1">📜 案发现场</h3>
<p>最常见的场景：一个 <code>ListItem</code> 本身是可以点击跳转详情的，但里面有一个“删除”按钮。
用户想点删除，结果手指稍微偏了一点点，或者系统判定失误，不仅删除了数据，还顺手跳到了详情页。用户体验极其糟糕。</p>
<h3 data-id="heading-2">🔍 原理剖析</h3>
<p>这是典型的<strong>事件冒泡</strong>。触摸事件从子组件（按钮）传递到父组件（列表项）。子组件处理完了，如果没说“别传了”，父组件就会觉得：“哦？有人点了我的地盘？那我也响应一下吧。”</p>
<h3 data-id="heading-3">✅ V 哥的一招制敌：hitTestBehavior</h3>
<p>我们要做的就是：<strong>给子组件（按钮）设个“路障”，告诉父组件：这事我办了，你别插手！</strong></p>
<hr/>
<h2 data-id="heading-4">痛点二：滑动打架 —— “我想横滑，你非要竖着滚？”</h2>
<h3 data-id="heading-5">📜 案发现场</h3>
<p>你在做一个音乐播放器，进度条支持横向拖动。但是，这个播放器是放在一个 <code>Scroll</code>（垂直滚动）容器里的。
当你想拖动进度条时，手指稍微带点垂直角度，页面就开始上下滚动，进度条根本拖不动。</p>
<h3 data-id="heading-6">🔍 原理剖析</h3>
<p>父容器的 <code>VerticalScroll</code>（垂直滚动手势）和子组件的 <code>PanGesture</code>（拖动手势）发生了<strong>竞争</strong>。系统不知道你是想切歌还是想看歌词。</p>
<h3 data-id="heading-7">✅ V 哥的一招制敌：PanGesture &amp; ParallelGesture</h3>
<p>我们需要精细化控制手势的<strong>方向</strong>和<strong>并发模式</strong>。</p>
<hr/>
<h2 data-id="heading-8">代码案例</h2>
<p>我们打开 DevEco Studio 6.0，新建一个页面 <code>GestureDemo.ets</code>。这段代码包含了上面两个问题的完整解决方案，跑一遍你就全懂了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> promptAction <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.promptAction'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">GestureDemo</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">deleteLog</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'操作日志：等待操作...'</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'V哥的手势冲突诊疗室'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })

      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-comment">// 场景一：点击冲突（冒泡问题）</span>
      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'场景1：列表项点击 vs 按钮点击'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })
        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#666'</span>)

      <span class="hljs-comment">// 模拟一个列表项</span>
      <span class="hljs-title class_">Row</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'V哥的鸿蒙实战教程.mp4'</span>)
          .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)
        
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)
          .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">12</span> })
          <span class="hljs-comment">// --- V哥的关键神技 ---</span>
          <span class="hljs-comment">// HitTestMode.Block 表示：我（按钮）是挡箭牌。</span>
          <span class="hljs-comment">// 只要点击落在按钮区域，就由我处理，绝不传给父组件 Row。</span>
          <span class="hljs-comment">// 这样父组件的 onClick 就不会被误触了！</span>
          .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Block</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span> = <span class="hljs-string">'🔥 操作：点击了【删除】按钮（父组件被拦截）'</span>;
            promptAction.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'删除成功！'</span> });
          })
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">15</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
      .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 点击 Row 的空白处会触发这里，但点按钮不会</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span> = <span class="hljs-string">'📖 操作：点击了【列表项】，应该跳转详情'</span>;
      })

      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-comment">// 场景二：滑动冲突（纵横问题）</span>
      <span class="hljs-comment">// ==========================================</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'场景2：竖向滚动 vs 横向拖拽'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">10</span> })
        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#666'</span>)

      <span class="hljs-comment">// 外层：竖向滚动容器</span>
      <span class="hljs-title class_">Scroll</span>() {
        <span class="hljs-title class_">Column</span>() {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'这是顶部内容'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Pink</span>)

          <span class="hljs-comment">// 这是一个专门用于横向拖拽的区域</span>
          <span class="hljs-title class_">Row</span>() {
            <span class="hljs-title class_">Text</span>(<span class="hljs-string">'拖动我 -&gt; '</span>)
              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
            <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">toString</span>())
              .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
          }
          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Orange</span>)
          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
          .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })
          <span class="hljs-comment">// --- V哥的关键神技 ---</span>
          <span class="hljs-comment">// 1. 定义一个横向拖动手势</span>
          .<span class="hljs-title function_">gesture</span>(
            <span class="hljs-title class_">PanGesture</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">PanDirection</span>.<span class="hljs-property">Horizontal</span> })
              .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span> = <span class="hljs-string">'🤚 操作：开始【横向】拖拽'</span>;
              })
              .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
                <span class="hljs-comment">// V哥演示：简单累加一下偏移量</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> += event.<span class="hljs-property">offsetX</span>;
              })
          )

          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'这是底部内容，多撑开点高度'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Grey</span>)
        }
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)
      .<span class="hljs-title function_">scrollable</span>(<span class="hljs-title class_">ScrollDirection</span>.<span class="hljs-property">Vertical</span>) <span class="hljs-comment">// 申明竖向滚动</span>
      .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span> })

      <span class="hljs-comment">// 日志显示</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteLog</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">14</span>)
        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#333'</span>)
        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">20</span> })
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">5</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#E0E0E0'</span>)

    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>({ <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">20</span> })
  }

  <span class="hljs-comment">// 用于存储滑块值的变量</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-9">复盘一下：手势机制的三个“挡箭牌”</h2>
<p>代码跑通了，咱们得把 API 21 里的这几个参数吃透，以后遇到变种 Bug 也能一招制敌。</p>
<h3 data-id="heading-10">1. hitTestBehavior 的四个境界</h3>
<p>这是最常用的属性，修饰在组件上。</p>
<ul>
<li>
<p><strong><code>HitTestMode.Default</code>（默认）</strong>：</p>
<ul>
<li>特点：该谁是谁。如果组件本身是 <code>Button</code> 这类可点击的，它就拦截；如果是 <code>Text</code> 这种，它就放行给父组件。</li>
<li><strong>V 哥吐槽</strong>：有时候系统误判，导致布局透明的 <code>Row</code> 挡住了下层按钮，这时候你就得改它。</li>
</ul>
</li>
<li>
<p><strong><code>HitTestMode.None</code>（透明人）</strong>：</p>
<ul>
<li>特点：<strong>我不拦截</strong>。点击我这个区域，就好像我不存在一样，事件直接穿透我，传给我的孩子或者兄弟。</li>
<li><strong>场景</strong>：你做了一个复杂的背景布局，但不想它挡住背后的按钮。</li>
</ul>
</li>
<li>
<p><strong><code>HitTestMode.Block</code>（拦路虎）</strong>：🌟 <strong>V 哥推荐</strong></p>
<ul>
<li>特点：<strong>我全收了</strong>。不管我下面是什么，只要点到我，我就处理，绝不往外传。</li>
<li><strong>场景</strong>：这就是咱们代码里解决“列表里套按钮”的神器。给按钮加上它，父组件再也不会误触跳转。</li>
</ul>
</li>
<li>
<p><strong><code>HitTestMode.Transparent</code>（传声筒）</strong>：</p>
<ul>
<li>特点：我拦截到事件后，处理完，还要传给父组件。</li>
<li><strong>场景</strong>：很少用，除非你想实现“点子组件，父子一起动”的效果（通常不推荐，容易乱）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">2. 手势的优先级</h3>
<p>如果两个手势都想响应，听谁的？</p>
<ul>
<li><strong>系统默认</strong>：<code>TapGesture</code> (点击) &gt; <code>LongPressGesture</code> (长按) &gt; <code>PanGesture</code> (拖动) &gt; <code>PinchGesture</code> (捏合)。</li>
<li><strong>手动干预</strong>：如果你想强行让某个手势优先，可以用 <code>priorityGesture</code> 包裹手势。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript">    .<span class="hljs-title function_">gesture</span>(
      <span class="hljs-comment">// 即使父组件想滚动，子组件的横向拖动优先级更高</span>
      <span class="hljs-title function_">priorityGesture</span>(<span class="hljs-title class_">PanGesture</span>({ <span class="hljs-attr">direction</span>: <span class="hljs-title class_">PanDirection</span>.<span class="hljs-property">Horizontal</span> }))
    )
</code></pre>
<h3 data-id="heading-12">3. 并发手势</h3>
<p>如果两个手势可以<strong>同时发生</strong>（比如一边缩放一边旋转），用 <code>GestureGroup</code> 配合 <code>GestureMode.Parallel</code>。
不过，对于大多数“纵横冲突”，鸿蒙系统 API 21 已经能很智能地通过 <code>PanGesture</code> 的 <code>direction</code> 属性自动区分方向了。如果你发现它分不清，通常是<strong>布局重叠</strong>或者<strong>触摸区域设置不合理</strong>导致的。</p>
<hr/>
<h2 data-id="heading-13">小结一下</h2>
<p>下次再做列表、相册、播放器的时候，把这三招拿出来，产品经理看你的眼神绝对不一样！</p>
<ol>
<li><strong>怕误触（点击冲突）</strong>：给按钮加 <strong><code>hitTestBehavior(HitTestMode.Block)</code></strong>。</li>
<li><strong>怕抢滑（滑动冲突）</strong>：给子组件绑定明确方向的 <strong><code>PanGesture</code></strong>，必要时加 <strong><code>priorityGesture</code></strong>。</li>
<li><strong>怕透传</strong>：给遮挡层加 <strong><code>hitTestBehavior(HitTestMode.None)</code></strong>。</li>
</ol>
<p>我是V哥，咱们下期技术复盘见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux】文件系统与 fsck.ext4 修复 - 我踩过的坑与总结]]></title>    <link>https://juejin.cn/post/7595994039108173860</link>    <guid>https://juejin.cn/post/7595994039108173860</guid>    <pubDate>2026-01-17T07:27:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595994039108173860" data-draft-id="7595878718171562020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux】文件系统与 fsck.ext4 修复 - 我踩过的坑与总结"/> <meta itemprop="keywords" content="运维,Linux"/> <meta itemprop="datePublished" content="2026-01-17T07:27:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kida的躺平小屋"/> <meta itemprop="url" content="https://juejin.cn/user/1684864740889758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux】文件系统与 fsck.ext4 修复 - 我踩过的坑与总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684864740889758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kida的躺平小屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:27:41.000Z" title="Sat Jan 17 2026 07:27:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>承接上一回，这期依然是 Linux 的总结。但这次我想聊聊文件系统和 fsck，这个我踩过千百遍的坑。</p>
<h2 data-id="heading-0">一、首先什么是 fsck？</h2>
<p>在我早期使用 Linux 的时候，对磁盘问题的理解非常肤浅：</p>
<blockquote>
<p>“系统起不来了？那就 fsck 一下试试。”</p>
</blockquote>
<p>直到我遇到 <strong>ext4 分区无法挂载、系统进入 emergency mode、fsck 直接报错</strong>，我才意识到：<br/>
<strong>fsck 不是“万能修复键”，而是“最后的外科手术刀”。</strong></p>
<p>理解下面三件事，对我来说是分水岭：</p>
<ol>
<li><strong>什么时候能用 fsck，什么时候绝对不能用</strong></li>
<li><strong>fsck 到底在“修什么”</strong></li>
<li><strong>哪些参数会救命，哪些参数会毁数据</strong></li>
</ol>
<h2 data-id="heading-1">二、fsck 在 Linux 中的定位</h2>
<p>从本质上讲：</p>
<blockquote>
<p><strong>fsck（File System Consistency Check）是用来“校验并修复文件系统结构一致性”的工具，而不是数据恢复工具。</strong></p>
</blockquote>
<p>它主要检查和修复的是：</p>
<ul>
<li>superblock（超级块）</li>
<li>inode 表</li>
<li>block bitmap</li>
<li>inode bitmap</li>
<li>目录结构与引用关系</li>
</ul>
<p><strong>值得注意的是 fsck 关心的是“结构是否一致”，它是不保证你的文件内容“正确或完整”的。</strong></p>
<h2 data-id="heading-2">三、在 fsck 之前必做的三件事（重点）</h2>
<h3 data-id="heading-3">1.确认分区没有被挂载</h3>
<p>fsck 对“已挂载分区”执行是极其危险的行为。我通常用：</p>
<pre><code class="hljs language-bash" lang="bash">mount | grep sda
lsblk
</code></pre>
<p>如果是根分区：</p>
<ul>
<li>必须进入单用户模式</li>
<li>或使用 Live CD / 救援系统</li>
</ul>
<h3 data-id="heading-4">2.能备份就先备份（哪怕是 dd）</h3>
<p>如果磁盘还能读，我至少会做一份原始镜像：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/sda of=/backup/sda.img bs=4M status=progress
</code></pre>
<p>我宁愿慢，总比事后后悔强。</p>
<h3 data-id="heading-5">3.搞清楚文件系统类型</h3>
<pre><code class="hljs language-bash" lang="bash">blkid
lsblk -f
</code></pre>
<p>确认是 ext4，而不是 xfs / btrfs</p>
<h2 data-id="heading-6">四、fsck.ext4 的核心用法</h2>
<h3 data-id="heading-7">1.基础检查（只读，不修改）</h3>
<pre><code class="hljs language-bash" lang="bash">fsck.ext4 -n /dev/sda1
</code></pre>
<p>一般我会采用 -n（不做任何修改）参数先做一次评估，先看损坏程度。</p>
<h3 data-id="heading-8">2.自动修复（踩坑最多）</h3>
<pre><code class="hljs language-bash" lang="bash">fsck.ext4 -y /dev/sda1
</code></pre>
<p>这可以算是我踩坑最多的参数，-y（对所有修复询问自动回答 yes）。以前常用，现在的话只在我已经有备份，或别无选择时使用。</p>
<h3 data-id="heading-9">3.指定备用 superblock 修复</h3>
<p>这是我最常“救活”分区的一招。先查看备用 superblock：</p>
<pre><code class="hljs language-bash" lang="bash">dumpe2fs /dev/sda1 | grep -i superblock
</code></pre>
<p>然后指定一个：</p>
<pre><code class="hljs language-bash" lang="bash">fsck.ext4 -b 32768 /dev/sda1
</code></pre>
<h2 data-id="heading-10">五、lost+found？</h2>
<p>fsck 修复后，经常会看到：</p>
<pre><code class="hljs language-bash" lang="bash">/lost+found
</code></pre>
<p>里面是：</p>
<ul>
<li>找不到原目录结构的 inode</li>
<li>文件名通常是数字</li>
</ul>
<p>我的过往经验是若是小文件，那一般内容还算是完整的，如果是大文件（譬如，数据库、镜像等）那么可用性就不高了，那如果是目录结构的话，那基本就不可能完全恢复的。那么我的做法是：</p>
<ul>
<li>逐个 file + less 判断</li>
<li>能确认用途的，手动归位</li>
<li>其余长期留档，不轻易删除</li>
</ul>
<h2 data-id="heading-11">六、我踩过的坑（血的教训）</h2>
<h3 data-id="heading-12">1.在已挂载的根分区上跑 fsck</h3>
<p>结果可想而知，文件系统状态直接混乱，最后只能进救援系统重修。这也让我意识到 “fsck ≠ 在线修复工具” 这个道理。</p>
<h3 data-id="heading-13">2.对 XFS 分区使用 fsck.ext4</h3>
<p>fsck 根本就“看不懂”，并且造成二次损坏。后面我知道了 XFS 用 xfs_repair，只有 ext4 才用 fsck.ext4。</p>
<h2 data-id="heading-14">七、我现在的做法</h2>
<p>说实话，我并不想经常用 fsck。现在我更倾向于：</p>
<ul>
<li>RAID + 定期 SMART 检测</li>
<li>UPS 防断电</li>
<li>日志与业务数据分盘</li>
<li>关键数据 快照 + 备份</li>
<li>新系统优先考虑 btrfs / zfs</li>
</ul>
<p>fsck 对我来说，已经变成了“最后的止血手段”，而不是常规维护方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Caffeine入门到实战]]></title>    <link>https://juejin.cn/post/7595841630677106739</link>    <guid>https://juejin.cn/post/7595841630677106739</guid>    <pubDate>2026-01-17T07:46:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595841630677106739" data-draft-id="7595842144906625074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Caffeine入门到实战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-17T07:46:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Caffeine入门到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:46:22.000Z" title="Sat Jan 17 2026 07:46:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>高性能Java缓存框架实战，让你秒懂缓存优化</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在当今高并发的互联网应用中，缓存已经成为提升系统性能的关键技术之一。本文将带你从零开始，深入浅出地学习Caffeine这款高性能的Java缓存框架，并通过实际案例让你掌握缓存技术的精髓。</p>
<h2 data-id="heading-1">1. Caffeine简介</h2>
<p>Caffeine是一个基于Java的高性能缓存库，由Google开发并开源。它被认为是Java缓存领域的王者，在性能测试中表现优异。</p>
<h3 data-id="heading-2">为什么选择Caffeine？</h3>
<ul>
<li><strong>高性能</strong>：采用先进的算法，读写性能卓越</li>
<li><strong>功能丰富</strong>：支持多种过期策略、异步加载、统计信息等</li>
<li><strong>线程安全</strong>：并发性能优秀</li>
<li><strong>易于使用</strong>：API设计简洁直观</li>
<li><strong>活跃社区</strong>：持续维护和更新</li>
</ul>
<h3 data-id="heading-3">架构设计</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e6e0d899e14fbaaafafa3123056baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=hfMSuIcQysmqzw2OjT3WiDv4Wtw%3D" alt="" loading="lazy"/></p>
<p>Caffeine的核心架构包括：</p>
<ol>
<li><strong>缓存容器</strong>：使用ConcurrentHashMap作为底层数据结构</li>
<li><strong>访问策略</strong>：采用Window TinyLFU算法进行频率统计</li>
<li><strong>淘汰策略</strong>：基于时间窗口和频率的混合淘汰策略</li>
<li><strong>事件机制</strong>：支持监听缓存的各种事件</li>
</ol>
<h2 data-id="heading-4">2. 快速入门</h2>
<h3 data-id="heading-5">Maven依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">基础使用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Caffeine</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicCacheExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 创建缓存</span>
        <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; cache = <span class="hljs-title class_">Caffeine</span>.<span class="hljs-title function_">newBuilder</span>()
            .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 最大缓存数量</span>
            .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>) <span class="hljs-comment">// 写入后10分钟过期</span>
            .<span class="hljs-title function_">build</span>();

        <span class="hljs-comment">// 存储数据</span>
        cache.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

        <span class="hljs-comment">// 获取数据</span>
        <span class="hljs-title class_">String</span> value = cache.<span class="hljs-title function_">getIfPresent</span>(<span class="hljs-string">"key1"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"缓存值: "</span> + value);

        <span class="hljs-comment">// 获取或计算</span>
        <span class="hljs-title class_">String</span> value2 = cache.<span class="hljs-title function_">get</span>(<span class="hljs-string">"key2"</span>, k -&gt; <span class="hljs-string">"defaultValue"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"缓存值: "</span> + value2);

        <span class="hljs-comment">// 移除数据</span>
        cache.<span class="hljs-title function_">invalidate</span>(<span class="hljs-string">"key1"</span>);
    }
}
</code></pre>
<h2 data-id="heading-7">3. 核心概念</h2>
<h3 data-id="heading-8">3.1 Cache vs LoadingCache vs AsyncLoadingCache</h3>
<p>Caffeine提供了三种缓存类型：</p>
<ol>
<li><strong>Cache</strong>：基础缓存，需要手动管理数据</li>
<li><strong>LoadingCache</strong>：自动加载数据的缓存</li>
<li><strong>AsyncLoadingCache</strong>：异步加载数据的缓存</li>
</ol>
<h3 data-id="heading-9">3.2 过期策略</h3>
<p>Caffeine提供了三种过期策略：</p>
<pre><code class="hljs language-scss" lang="scss">Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.expireAfterWrite</span>(<span class="hljs-number">10</span>, TimeUnit.MINUTES) <span class="hljs-comment">// 写入后过期</span>
    <span class="hljs-selector-class">.expireAfterAccess</span>(<span class="hljs-number">5</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// 最后访问后过期</span>
    <span class="hljs-selector-class">.expireAfter</span>(<span class="hljs-number">30</span>, TimeUnit.MINUTES);       <span class="hljs-comment">// 自定义过期逻辑</span>
</code></pre>
<h3 data-id="heading-10">3.3 淘汰策略</h3>
<pre><code class="hljs language-scss" lang="scss">Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)         <span class="hljs-comment">// 基于数量</span>
    <span class="hljs-selector-class">.maximumWeight</span>(<span class="hljs-number">10000</span>)      <span class="hljs-comment">// 基于权重</span>
    <span class="hljs-selector-class">.weakKeys</span>()               <span class="hljs-comment">// 弱引用键</span>
    <span class="hljs-selector-class">.weakValues</span>()             <span class="hljs-comment">// 弱引用值</span>
    <span class="hljs-selector-class">.softValues</span>();            <span class="hljs-comment">// 软引用值</span>
</code></pre>
<h2 data-id="heading-11">4. 高级特性</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff936a2d76c04f1aaf866ccba450d2fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=vIDzfY5%2B20eLh9huJFxIDK%2FnZbk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">4.1 异步加载</h3>
<pre><code class="hljs language-ini" lang="ini">AsyncLoadingCache&lt;String, User&gt; <span class="hljs-attr">asyncCache</span> = Caffeine.newBuilder()
    .maximumSize(1000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .buildAsync(key -&gt; loadUserFromDatabase(key))<span class="hljs-comment">;</span>

// 异步获取
CompletableFuture&lt;User&gt; <span class="hljs-attr">userFuture</span> = asyncCache.get(<span class="hljs-string">"user1"</span>)<span class="hljs-comment">;</span>
userFuture.thenAccept(user -&gt; {
    System.out.println("获取用户: " + user.getName())<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-13">4.2 事件监听</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">Cache&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; cache = Caffeine.newBuilder()
    .maximumSize(<span class="hljs-number">1000</span>)
    .removalListener((<span class="hljs-keyword">key</span>, value, cause) -&gt; {
        System.out.println(<span class="hljs-string">"缓存移除: "</span> + <span class="hljs-keyword">key</span> + <span class="hljs-string">" -&gt; "</span> + value + <span class="hljs-string">", 原因: "</span> + cause);
    })
    .build();
</code></pre>
<h3 data-id="heading-14">4.3 统计信息</h3>
<pre><code class="hljs language-scss" lang="scss">Cache&lt;String, String&gt; cache = Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)
    <span class="hljs-selector-class">.recordStats</span>() <span class="hljs-comment">// 启用统计</span>
    <span class="hljs-selector-class">.build</span>();

<span class="hljs-comment">// 使用缓存...</span>
cache<span class="hljs-selector-class">.put</span>("key1", "value1");
cache<span class="hljs-selector-class">.getIfPresent</span>("key1");

<span class="hljs-comment">// 获取统计信息</span>
CacheStats stats = cache<span class="hljs-selector-class">.stats</span>();
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("命中率: " + stats.hitRate());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("加载时间: " + stats.averageLoadPenalty());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("请求数: " + stats.requestCount());
</code></pre>
<h2 data-id="heading-15">5. Spring Boot集成</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff82efaf278437f8045c4dae72c58be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=x8wXynqrw1CSWo8vv794U8KA5Sg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">5.1 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-17">5.2 配置类</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Caffeine</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">CacheManager</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">EnableCaching</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">CaffeineCacheManager</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Bean</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Configuration</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableCaching</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CacheManager</span> <span class="hljs-title function_">cacheManager</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">CaffeineCacheManager</span> cacheManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>();
        cacheManager.<span class="hljs-title function_">setCaffeine</span>(<span class="hljs-title function_">caffeineCacheBuilder</span>());
        <span class="hljs-keyword">return</span> cacheManager;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Caffeine</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">caffeineCacheBuilder</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Caffeine</span>.<span class="hljs-title function_">newBuilder</span>()
                .<span class="hljs-title function_">initialCapacity</span>(<span class="hljs-number">100</span>)
                .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">1000</span>)
                .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
                .<span class="hljs-title function_">recordStats</span>();
    }
}
</code></pre>
<h3 data-id="heading-18">5.3 使用注解</h3>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">service</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">model</span>.<span class="hljs-property">User</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">CacheEvict</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">CachePut</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Cacheable</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.*;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">ConcurrentHashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-comment">// 模拟数据库存储</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">User</span>&gt; userMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserService</span>() {
        <span class="hljs-comment">// 初始化一些测试数据</span>
        userMap.<span class="hljs-title function_">put</span>(1L, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(1L, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>, <span class="hljs-string">"13800138000"</span>));
        userMap.<span class="hljs-title function_">put</span>(2L, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(2L, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"lisi@example.com"</span>, <span class="hljs-string">"13900139000"</span>));
        userMap.<span class="hljs-title function_">put</span>(3L, <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(3L, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"wangwu@example.com"</span>, <span class="hljs-string">"13700137000"</span>));
    }

    <span class="hljs-comment">/**
     * 获取用户信息（带缓存）
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 用户信息
     */</span>
    <span class="hljs-meta">@Cacheable</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#userId"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-comment">// 模拟数据库查询耗时</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MILLISECONDS</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }

        <span class="hljs-title class_">User</span> user = userMap.<span class="hljs-title function_">get</span>(userId);
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在: "</span> + userId);
        }
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 获取用户信息（异步）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getUserByIdAsync</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">supplyAsync</span>(() -&gt; <span class="hljs-title function_">getUserById</span>(userId));
    }

    <span class="hljs-comment">/**
     * 获取所有用户信息
     */</span>
    <span class="hljs-meta">@Cacheable</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"'all'"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 模拟数据库查询耗时</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MILLISECONDS</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">200</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(userMap.<span class="hljs-title function_">values</span>());
    }

    <span class="hljs-comment">/**
     * 创建用户
     */</span>
    <span class="hljs-meta">@CachePut</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#user.id"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userMap.<span class="hljs-title function_">put</span>(user.<span class="hljs-title function_">getId</span>(), user);
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 更新用户信息
     */</span>
    <span class="hljs-meta">@CachePut</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#user.id"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-keyword">if</span> (!userMap.<span class="hljs-title function_">containsKey</span>(user.<span class="hljs-title function_">getId</span>())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在: "</span> + user.<span class="hljs-title function_">getId</span>());
        }
        user.<span class="hljs-title function_">setUpdateTime</span>(<span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>());
        userMap.<span class="hljs-title function_">put</span>(user.<span class="hljs-title function_">getId</span>(), user);
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 删除用户
     */</span>
    <span class="hljs-meta">@CacheEvict</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"#userId"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-title class_">User</span> removed = userMap.<span class="hljs-title function_">remove</span>(userId);
        <span class="hljs-keyword">if</span> (removed == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在: "</span> + userId);
        }
    }

    <span class="hljs-comment">/**
     * 批量获取用户信息
     */</span>
    <span class="hljs-meta">@Cacheable</span>(value = <span class="hljs-string">"users"</span>, key = <span class="hljs-string">"'batch:' + #userIds.hashCode()"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">batchGetUsers</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;Long&gt; userIds</span>) {
        <span class="hljs-comment">// 模拟批量查询耗时</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MILLISECONDS</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">150</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }

        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">User</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Long</span> userId : userIds) {
            <span class="hljs-title class_">User</span> user = userMap.<span class="hljs-title function_">get</span>(userId);
            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
                result.<span class="hljs-title function_">put</span>(userId, user);
            }
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 根据用户名模糊查询
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">searchUsersByUsername</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> keyword</span>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">User</span> user : userMap.<span class="hljs-title function_">values</span>()) {
            <span class="hljs-keyword">if</span> (user.<span class="hljs-title function_">getUsername</span>().<span class="hljs-title function_">contains</span>(keyword)) {
                result.<span class="hljs-title function_">add</span>(user);
            }
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 清空所有缓存
     */</span>
    <span class="hljs-meta">@CacheEvict</span>(value = <span class="hljs-string">"users"</span>, allEntries = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearAllCache</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"清空所有用户缓存"</span>);
    }

    <span class="hljs-comment">/**
     * 获取用户总数
     */</span>
    <span class="hljs-keyword">public</span> long <span class="hljs-title function_">getUserCount</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userMap.<span class="hljs-title function_">size</span>();
    }
}
</code></pre>
<h2 data-id="heading-19">6. 生产环境最佳实践</h2>
<h3 data-id="heading-20">6.1 缓存雪崩与击穿</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ae45c5ae2c644e7b19813de7bb61db4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=s5Bj%2B0%2FpD1TT%2FcUtgYIihfc%2BzFI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21">缓存雪崩解决方案</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 设置随机过期时间</span>
Caffeine.newBuilder()
    .expireAfterWrite(<span class="hljs-number">10</span> + <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">5</span>), TimeUnit.MINUTES);

<span class="hljs-comment">// 2. 使用互斥锁</span>
<span class="hljs-keyword">private</span> final Lock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">new</span> ReentrantLock();

<span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUserWithLock</span>(<span class="hljs-params">Long id</span>)</span> {
    User user = cache.getIfPresent(id);
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-keyword">lock</span>.<span class="hljs-keyword">lock</span>();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 双重检查</span>
        user = cache.getIfPresent(id);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> user;
        }

        user = userRepository.findById(id);
        cache.put(id, user);
        <span class="hljs-keyword">return</span> user;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">lock</span>.unlock();
    }
}
</code></pre>
<h4 data-id="heading-22">缓存击穿解决方案</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用Caffeine的异步加载</span>
AsyncLoadingCache&lt;Long, User&gt; asyncCache = Caffeine<span class="hljs-selector-class">.newBuilder</span>()
    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)
    <span class="hljs-selector-class">.expireAfterWrite</span>(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
    <span class="hljs-selector-class">.buildAsync</span>(key -&gt; loadUserFromDatabase(key));

public User <span class="hljs-built_in">getUser</span>(Long id) {
    return asyncCache<span class="hljs-selector-class">.get</span>(id)<span class="hljs-selector-class">.join</span>();
}
</code></pre>
<h3 data-id="heading-23">6.2 缓存预热</h3>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.caffeine</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.cache</span>;

import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.caffeine</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.User</span>;
import com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.caffeine</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.UserService</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.boot</span><span class="hljs-selector-class">.CommandLineRunner</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Component</span>;

import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Arrays</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.CompletableFuture</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.ExecutorService</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.Executors</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.TimeUnit</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * 缓存预热启动器
 *
 * 功能：
 * 1. 在应用启动时自动预热热点数据到缓存
 * 2. 支持同步和异步预热方式
 * 3. 支持批量预热
 * 4. 提供预热进度监控
 * 5. 异常处理和重试机制
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Component</span>
public class CacheWarmupRunner implements CommandLineRunner {

    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;

    <span class="hljs-comment">/**
     * 预热配置
     */</span>
    private static class WarmupConfig {
        <span class="hljs-comment">// 预热用户ID列表（可以根据业务需求配置）</span>
        private static final List&lt;Long&gt; HOT_USER_IDS = Arrays<span class="hljs-selector-class">.asList</span>(<span class="hljs-number">1</span>L, <span class="hljs-number">2</span>L, <span class="hljs-number">3</span>L, <span class="hljs-number">4</span>L, <span class="hljs-number">5</span>L);

        <span class="hljs-comment">// 预热批次大小</span>
        private static final int BATCH_SIZE = <span class="hljs-number">3</span>;

        <span class="hljs-comment">// 线程池大小</span>
        private static final int THREAD_POOL_SIZE = <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 是否启用异步预热</span>
        private static final boolean ASYNC_WARMUP = true;

        <span class="hljs-comment">// 最大重试次数</span>
        private static final int MAX_RETRY_TIMES = <span class="hljs-number">3</span>;

        <span class="hljs-comment">// 重试间隔（毫秒）</span>
        private static final long RETRY_INTERVAL = <span class="hljs-number">1000</span>L;
    }

    <span class="hljs-keyword">@Override</span>
    public void run(String... args) throws Exception {
        log<span class="hljs-selector-class">.info</span>("开始执行缓存预热...");
        long startTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();

        try {
            if (WarmupConfig.ASYNC_WARMUP) {
                <span class="hljs-comment">// 异步预热</span>
                <span class="hljs-built_in">asyncWarmup</span>();
            } else {
                <span class="hljs-comment">// 同步预热</span>
                <span class="hljs-built_in">syncWarmup</span>();
            }

            long endTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();
            log<span class="hljs-selector-class">.info</span>("缓存预热完成！耗时: {} ms", endTime - startTime);

        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("缓存预热失败！错误信息: {}", e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 同步预热方式
     */</span>
    private void <span class="hljs-built_in">syncWarmup</span>() {
        log<span class="hljs-selector-class">.info</span>("使用同步方式预热缓存...");

        <span class="hljs-comment">// 方法1：逐个预热</span>
        log<span class="hljs-selector-class">.info</span>("逐个预热用户数据...");
        for (Long userId : WarmupConfig.HOT_USER_IDS) {
            <span class="hljs-built_in">warmupSingleUser</span>(userId);
        }

        <span class="hljs-comment">// 方法2：批量预热</span>
        log<span class="hljs-selector-class">.info</span>("批量预热用户数据...");
        <span class="hljs-built_in">batchWarmupUsers</span>(WarmupConfig.HOT_USER_IDS);

        <span class="hljs-comment">// 方法3：预热所有用户</span>
        log<span class="hljs-selector-class">.info</span>("预热所有用户数据...");
        <span class="hljs-built_in">warmupAllUsers</span>();
    }

    <span class="hljs-comment">/**
     * 异步预热方式
     */</span>
    private void <span class="hljs-built_in">asyncWarmup</span>() {
        log<span class="hljs-selector-class">.info</span>("使用异步方式预热缓存...");

        ExecutorService executor = Executors<span class="hljs-selector-class">.newFixedThreadPool</span>(WarmupConfig.THREAD_POOL_SIZE);

        <span class="hljs-comment">// 创建异步预热任务</span>
        List&lt;CompletableFuture&lt;Void&gt;&gt; futures = WarmupConfig<span class="hljs-selector-class">.HOT_USER_IDS</span><span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(userId -&gt; CompletableFuture.runAsync(() -&gt; {
                try {
                    <span class="hljs-built_in">warmupSingleUserWithRetry</span>(userId);
                } catch (Exception e) {
                    log<span class="hljs-selector-class">.error</span>("预热用户 {} 失败: {}", userId, e.getMessage());
                }
            }, executor))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());

        <span class="hljs-comment">// 等待所有任务完成</span>
        CompletableFuture<span class="hljs-selector-class">.allOf</span>(futures.toArray(new CompletableFuture[<span class="hljs-number">0</span>]))
            <span class="hljs-selector-class">.whenComplete</span>((result, ex) -&gt; {
                if (ex != null) {
                    log<span class="hljs-selector-class">.error</span>("部分预热任务失败", ex);
                } else {
                    log<span class="hljs-selector-class">.info</span>("所有预热任务完成");
                }
                executor<span class="hljs-selector-class">.shutdown</span>();
            })
            <span class="hljs-selector-class">.join</span>();
    }

    <span class="hljs-comment">/**
     * 预热单个用户数据（带重试机制）
     */</span>
    private void <span class="hljs-built_in">warmupSingleUserWithRetry</span>(Long userId) {
        int retryCount = <span class="hljs-number">0</span>;
        boolean success = false;

        while (retryCount &lt; WarmupConfig.MAX_RETRY_TIMES &amp;&amp; !success) {
            try {
                <span class="hljs-built_in">warmupSingleUser</span>(userId);
                success = true;
                log<span class="hljs-selector-class">.debug</span>("用户 {} 预热成功，尝试次数: {}", userId, retryCount + <span class="hljs-number">1</span>);
            } catch (Exception e) {
                retryCount++;
                if (retryCount &gt;= WarmupConfig.MAX_RETRY_TIMES) {
                    log<span class="hljs-selector-class">.error</span>("用户 {} 预热失败，已达到最大重试次数: {}", userId, e.getMessage());
                    throw new <span class="hljs-built_in">RuntimeException</span>("预热用户 " + userId + " 失败", e);
                }
                log<span class="hljs-selector-class">.warn</span>("用户 {} 预热失败，第{}次重试。错误: {}", userId, retryCount, e.getMessage());
                try {
                    Thread<span class="hljs-selector-class">.sleep</span>(WarmupConfig.RETRY_INTERVAL);
                } catch (InterruptedException ie) {
                    Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
                    throw new <span class="hljs-built_in">RuntimeException</span>("预热被中断", ie);
                }
            }
        }
    }

    <span class="hljs-comment">/**
     * 预热单个用户
     */</span>
    private void <span class="hljs-built_in">warmupSingleUser</span>(Long userId) {
        log<span class="hljs-selector-class">.info</span>("预热用户: {}", userId);
        try {
            <span class="hljs-comment">// 预热用户基本信息</span>
            User user = userService<span class="hljs-selector-class">.getUserById</span>(userId);
            log<span class="hljs-selector-class">.debug</span>("用户 {} 基本信息预热完成", userId);
            <span class="hljs-comment">// 预热相关数据（如果有）</span>
            <span class="hljs-built_in">warmupRelatedData</span>(user);

        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("预热用户 {} 失败: {}", userId, e.getMessage());
            throw e;
        }
    }

    <span class="hljs-comment">/**
     * 批量预热用户数据
     */</span>
    private void <span class="hljs-built_in">batchWarmupUsers</span>(List&lt;Long&gt; userIds) {
        log<span class="hljs-selector-class">.info</span>("批量预热用户: {}", userIds);

        <span class="hljs-comment">// 按批次处理</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; userIds.size(); <span class="hljs-selector-tag">i</span> += WarmupConfig<span class="hljs-selector-class">.BATCH_SIZE</span>) {
            int end = Math<span class="hljs-selector-class">.min</span>(i + WarmupConfig.BATCH_SIZE, userIds.size());
            List&lt;Long&gt; batch = userIds<span class="hljs-selector-class">.subList</span>(i, end);

            log<span class="hljs-selector-class">.info</span>("预热第 {} 批，用户ID: {}", (i / WarmupConfig.BATCH_SIZE) + <span class="hljs-number">1</span>, batch);

            try {
                <span class="hljs-comment">// 批量查询</span>
                Map&lt;Long, User&gt; users = userService<span class="hljs-selector-class">.batchGetUsers</span>(new HashSet&lt;&gt;(batch));
                log<span class="hljs-selector-class">.info</span>("批量预热完成，成功预热 {} 个用户", users.size());

                <span class="hljs-comment">// 添加批次间间隔，避免压力过大</span>
                if (end &lt; userIds.size()) {
                    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">500</span>);
                }

            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("批量预热失败: {}", e.getMessage());
                <span class="hljs-comment">// 单个预热降级</span>
                for (Long userId : batch) {
                    try {
                        <span class="hljs-built_in">warmupSingleUser</span>(userId);
                    } catch (Exception ex) {
                        log<span class="hljs-selector-class">.error</span>("降级预热用户 {} 失败: {}", userId, ex.getMessage());
                    }
                }
            }
        }
    }

    <span class="hljs-comment">/**
     * 预热所有用户
     */</span>
    private void <span class="hljs-built_in">warmupAllUsers</span>() {
        log<span class="hljs-selector-class">.info</span>("开始预热所有用户数据...");
        try {
            List&lt;User&gt; allUsers = userService<span class="hljs-selector-class">.getAllUsers</span>();
            log<span class="hljs-selector-class">.info</span>("预热所有用户完成，共 {} 个用户", allUsers.size());
            <span class="hljs-comment">// 预热用户的其他关联数据</span>
            for (User user : allUsers) {
                <span class="hljs-built_in">warmupRelatedData</span>(user);
                <span class="hljs-comment">// 添加间隔，避免一次性加载过多数据</span>
                Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">100</span>);
            }
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("预热所有用户失败: {}", e.getMessage());
            throw e;
        }
    }

    <span class="hljs-comment">/**
     * 预热相关数据
     */</span>
    private void <span class="hljs-built_in">warmupRelatedData</span>(User user) {
        <span class="hljs-comment">// 预热用户的行为数据</span>
        <span class="hljs-built_in">warmupUserActivities</span>(user.getId());
    }

    <span class="hljs-comment">/**
     * 预热用户行为数据
     */</span>
    private void <span class="hljs-built_in">warmupUserActivities</span>(Long userId) {
        try {
            <span class="hljs-comment">// 调用行为服务预热</span>
            <span class="hljs-comment">// activityService.warmupUserActivities(userId);</span>
            log<span class="hljs-selector-class">.debug</span>("预热用户 {} 的行为数据", userId);
        } catch (Exception e) {
            log<span class="hljs-selector-class">.warn</span>("预热用户 {} 的行为数据失败: {}", userId, e.getMessage());
        }
    }


    <span class="hljs-comment">/**
     * 验证预热结果
     */</span>
    public void <span class="hljs-built_in">verifyWarmupResult</span>() {
        log<span class="hljs-selector-class">.info</span>("验证预热结果...");
        int successCount = <span class="hljs-number">0</span>;
        int totalCount = WarmupConfig<span class="hljs-selector-class">.HOT_USER_IDS</span><span class="hljs-selector-class">.size</span>();
        for (Long userId : WarmupConfig.HOT_USER_IDS) {
            try {
                <span class="hljs-comment">// 测试缓存是否命中</span>
                long startTime = System<span class="hljs-selector-class">.nanoTime</span>();
                User user = userService<span class="hljs-selector-class">.getUserById</span>(userId);
                long endTime = System<span class="hljs-selector-class">.nanoTime</span>();
                long duration = TimeUnit<span class="hljs-selector-class">.NANOSECONDS</span><span class="hljs-selector-class">.toMillis</span>(endTime - startTime);
                if (duration &lt; <span class="hljs-number">10</span>) { <span class="hljs-comment">// 如果响应时间小于10ms，说明命中了缓存</span>
                    successCount++;
                    log<span class="hljs-selector-class">.debug</span>("用户 {} 缓存预热验证成功，响应时间: {} ms", userId, duration);
                } else {
                    log<span class="hljs-selector-class">.warn</span>("用户 {} 缓存预热验证失败，响应时间: {} ms", userId, duration);
                }
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("验证用户 {} 失败: {}", userId, e.getMessage());
            }
        }
        log<span class="hljs-selector-class">.info</span>("预热结果验证完成，成功率: {} / {} ({:.<span class="hljs-number">2</span>f}%)",
                successCount, totalCount, (double) successCount / totalCount * <span class="hljs-number">100</span>);
    }
}
</code></pre>
<h3 data-id="heading-24">6.3 缓存监控</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e4458c72707476fb32e692560b310cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=wky0TvmiONYywhTeIPUlOrfciO0%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">CacheManager</span> cacheManager;
    <span class="hljs-comment">// 预警阈值配置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertThreshold</span> {
        <span class="hljs-comment">// 命中率阈值（低于此值发出警告）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final double <span class="hljs-variable constant_">MIN_HIT_RATE</span> = <span class="hljs-number">0.8</span>;
        <span class="hljs-comment">// 平均加载时间阈值（超过此值发出警告）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long <span class="hljs-variable constant_">MAX_AVG_LOAD_TIME_MS</span> = <span class="hljs-number">100</span>;
        <span class="hljs-comment">// 内存使用率阈值</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final double <span class="hljs-variable constant_">MAX_MEMORY_USAGE_PERCENT</span> = <span class="hljs-number">80.0</span>;
        <span class="hljs-comment">// 错误率阈值</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final double <span class="hljs-variable constant_">MAX_ERROR_RATE</span> = <span class="hljs-number">0.01</span>;
        <span class="hljs-comment">// 缓存大小阈值</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long <span class="hljs-variable constant_">MAX_CACHE_SIZE</span> = <span class="hljs-number">10000</span>;
    }

    <span class="hljs-comment">/**
     * 获取所有缓存的统计信息
     */</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/stats"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title function_">getAllCacheStats</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        <span class="hljs-comment">// 获取所有缓存名称</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; cacheNames = cacheManager.<span class="hljs-title function_">getCacheNames</span>();
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"timestamp"</span>, <span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>());
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"cacheNames"</span>, cacheNames);
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"cacheCount"</span>, cacheNames.<span class="hljs-title function_">size</span>());
        <span class="hljs-comment">// 统计汇总</span>
        <span class="hljs-title class_">CacheSummary</span> summary = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheSummary</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> cacheName : cacheNames) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; cacheStat = <span class="hljs-title function_">getCacheStat</span>(cacheName);
                result.<span class="hljs-title function_">put</span>(cacheName, cacheStat);
                <span class="hljs-comment">// 汇总统计</span>
                summary.<span class="hljs-title function_">aggregate</span>(cacheStat);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取缓存 {} 的统计信息失败: {}"</span>, cacheName, e.<span class="hljs-title function_">getMessage</span>());
                result.<span class="hljs-title function_">put</span>(cacheName, <span class="hljs-string">"获取统计信息失败: "</span> + e.<span class="hljs-title function_">getMessage</span>());
            }
        }
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"summary"</span>, summary);
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"health"</span>, <span class="hljs-title function_">getCacheHealthStatus</span>(summary));
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(result);
    }

    <span class="hljs-comment">/**
     * 获取指定缓存的统计信息
     */</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/stats/{cacheName}"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title function_">getCacheStat</span>(<span class="hljs-params"><span class="hljs-meta">@PathVariable</span> <span class="hljs-built_in">String</span> cacheName</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"获取缓存 {} 的统计信息"</span>, cacheName);
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">try</span> {
            org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span> springCache = cacheManager.<span class="hljs-title function_">getCache</span>(cacheName);
            <span class="hljs-keyword">if</span> (springCache == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">notFound</span>().<span class="hljs-title function_">build</span>();
            }
            <span class="hljs-title class_">Object</span> nativeCache = springCache.<span class="hljs-title function_">getNativeCache</span>();
            <span class="hljs-keyword">if</span> (nativeCache <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cache</span>) {
                <span class="hljs-title class_">Cache</span>&lt;?, ?&gt; cache = (<span class="hljs-title class_">Cache</span>&lt;?, ?&gt;) nativeCache;
                <span class="hljs-title class_">CacheStats</span> stats = cache.<span class="hljs-title function_">stats</span>();
                <span class="hljs-comment">// 基本信息</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"name"</span>, cacheName);
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"size"</span>, <span class="hljs-title function_">estimateCacheSize</span>(cache));
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"estimatedMemoryUsage"</span>, <span class="hljs-title function_">estimateMemoryUsage</span>(cache));
                <span class="hljs-comment">// 统计数据</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"requestCount"</span>, stats.<span class="hljs-title function_">requestCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"hitCount"</span>, stats.<span class="hljs-title function_">hitCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"missCount"</span>, stats.<span class="hljs-title function_">missCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"hitRate"</span>, stats.<span class="hljs-title function_">hitRate</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"missRate"</span>, stats.<span class="hljs-title function_">missRate</span>());
                <span class="hljs-comment">// 加载统计</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadSuccessCount"</span>, stats.<span class="hljs-title function_">loadSuccessCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadFailureCount"</span>, stats.<span class="hljs-title function_">loadFailureCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadFailureRate"</span>, <span class="hljs-title function_">calculateLoadFailureRate</span>(stats));
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"totalLoadTime"</span>, stats.<span class="hljs-title function_">totalLoadTime</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"averageLoadPenalty"</span>, stats.<span class="hljs-title function_">averageLoadPenalty</span>());
                <span class="hljs-comment">// 淘汰统计</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"evictionCount"</span>, stats.<span class="hljs-title function_">evictionCount</span>());
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"evictionWeight"</span>, stats.<span class="hljs-title function_">evictionWeight</span>());
                <span class="hljs-comment">// 其他统计</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"rejectionCount"</span>, stats.<span class="hljs-title function_">rejectionCount</span>());
                <span class="hljs-comment">// 计算衍生指标</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"errorRate"</span>, <span class="hljs-title function_">calculateErrorRate</span>(stats));
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"loadSuccessRate"</span>, <span class="hljs-title function_">calculateLoadSuccessRate</span>(stats));
                <span class="hljs-comment">// 预警信息</span>
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"alerts"</span>, <span class="hljs-title function_">checkCacheAlerts</span>(cacheName, stats, cache.<span class="hljs-title function_">estimatedSize</span>()));
            } <span class="hljs-keyword">else</span> {
                result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"error"</span>, <span class="hljs-string">"不支持的缓存类型: "</span> + nativeCache.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">getName</span>());
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取缓存 {} 统计信息失败: {}"</span>, cacheName, e.<span class="hljs-title function_">getMessage</span>());
            result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"error"</span>, e.<span class="hljs-title function_">getMessage</span>());
        }
        result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"timestamp"</span>, <span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(result);
    }
</code></pre>
<h2 data-id="heading-25">7. 性能优化技巧</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2dffb22ad91461a8f99e3004d37810b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769240782&amp;x-signature=wNJ8gy1A7MDRs2dww%2FMgRI0bpkg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">7.1 批量加载优化</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 批量加载优化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchUserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AsyncLoadingCache&lt;<span class="hljs-built_in">Long</span>, User&gt; userCache;

    <span class="hljs-keyword">public</span> BatchUserService() {
        <span class="hljs-keyword">this</span>.userCache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
            .buildAsync(<span class="hljs-keyword">this</span>::batchLoadUsers);
    }

    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-built_in">Long</span>, User&gt; batchLoadUsers(Set&lt;<span class="hljs-built_in">Long</span>&gt; userIds) {
        <span class="hljs-keyword">if</span> (userIds.isEmpty()) {
            <span class="hljs-keyword">return</span> Collections.emptyMap();
        }

        <span class="hljs-comment">// 批量查询数据库</span>
        List&lt;User&gt; users = userRepository.findAllById(userIds);

        <span class="hljs-comment">// 转换为Map</span>
        <span class="hljs-keyword">return</span> users.stream()
            .collect(Collectors.toMap(User::getId, user -&gt; user));
    }

    <span class="hljs-keyword">public</span> Map&lt;<span class="hljs-built_in">Long</span>, User&gt; getUsers(Set&lt;<span class="hljs-built_in">Long</span>&gt; userIds) {
        <span class="hljs-keyword">return</span> userCache.getAll(userIds).join();
    }
}
</code></pre>
<h2 data-id="heading-27">8. 实战案例</h2>
<h3 data-id="heading-28">8.1 用户信息缓存服务</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Cache</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">github</span>.<span class="hljs-property">benmanes</span>.<span class="hljs-property">caffeine</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">Caffeine</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoCacheService</span> {

    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserInfo</span>&gt; userInfoCache;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserInfoCacheService</span>() {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfoCache</span> = <span class="hljs-title class_">Caffeine</span>.<span class="hljs-title function_">newBuilder</span>()
            .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">10000</span>)
            .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">30</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
            .<span class="hljs-title function_">expireAfterAccess</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>)
            .<span class="hljs-title function_">recordStats</span>()
            .<span class="hljs-title function_">build</span>();
    }

    <span class="hljs-comment">/**
     * 获取用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserInfo</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-keyword">return</span> userInfoCache.<span class="hljs-title function_">get</span>(userId, <span class="hljs-attr">this</span>::loadUserInfoFromDB);
    }

    <span class="hljs-comment">/**
     * 批量获取用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserInfo</span>&gt; <span class="hljs-title function_">batchGetUserInfo</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;Long&gt; userIds</span>) {
        <span class="hljs-keyword">return</span> userInfoCache.<span class="hljs-title function_">getAll</span>(userIds, <span class="hljs-attr">this</span>::batchLoadUserInfoFromDB);
    }

    <span class="hljs-comment">/**
     * 更新用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUserInfo</span>(<span class="hljs-params">Long userId, UserInfo userInfo</span>) {
        userInfoCache.<span class="hljs-title function_">put</span>(userId, userInfo);
    }

    <span class="hljs-comment">/**
     * 删除用户信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeUserInfo</span>(<span class="hljs-params">Long userId</span>) {
        userInfoCache.<span class="hljs-title function_">invalidate</span>(userId);
    }

    <span class="hljs-comment">/**
     * 获取缓存统计
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CacheStats</span> <span class="hljs-title function_">getCacheStats</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userInfoCache.<span class="hljs-title function_">stats</span>();
    }

    <span class="hljs-comment">/**
     * 从数据库加载用户信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserInfo</span> <span class="hljs-title function_">loadUserInfoFromDB</span>(<span class="hljs-params">Long userId</span>) {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 模拟数据库查询耗时</span>
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findById</span>(userId);
    }

    <span class="hljs-comment">/**
     * 批量从数据库加载用户信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserInfo</span>&gt; <span class="hljs-title function_">batchLoadUserInfoFromDB</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;Long&gt; userIds</span>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findAllById</span>(userIds).<span class="hljs-title function_">stream</span>()
            .<span class="hljs-title function_">collect</span>(<span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">toMap</span>(<span class="hljs-title class_">UserInfo</span>::getId, <span class="hljs-title class_">Function</span>.<span class="hljs-title function_">identity</span>()));
    }
}
</code></pre>
<h2 data-id="heading-29">9. 总结</h2>
<p>Caffeine作为Java缓存领域的佼佼者，凭借其出色的性能和丰富的功能，已经成为许多项目的首选缓存方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5大核心分析维度+3种可视化方案：脑肿瘤大数据分析系统全解析 毕业设计 选题推荐 毕设选题 数据分析 机器学习]]></title>    <link>https://juejin.cn/post/7595859552347979828</link>    <guid>https://juejin.cn/post/7595859552347979828</guid>    <pubDate>2026-01-17T07:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595859552347979828" data-draft-id="7595878718171234340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5大核心分析维度+3种可视化方案：脑肿瘤大数据分析系统全解析 毕业设计 选题推荐 毕设选题 数据分析 机器学习"/> <meta itemprop="keywords" content="后端,Python,大数据"/> <meta itemprop="datePublished" content="2026-01-17T07:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计算机编程指导师"/> <meta itemprop="url" content="https://juejin.cn/user/881156097585216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5大核心分析维度+3种可视化方案：脑肿瘤大数据分析系统全解析 毕业设计 选题推荐 毕设选题 数据分析 机器学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/881156097585216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计算机编程指导师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T07:51:17.000Z" title="Sat Jan 17 2026 07:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">脑肿瘤数据可视化分系统-简介</h2>
<p>本系统是一个基于Hadoop+Spark的大数据分析平台，专注于脑肿瘤医疗数据的可视化研究。系统后端采用Python语言，结合Django框架构建服务接口，并利用Spark进行大规模数据的高效处理与计算。原始脑肿瘤数据存储于Hadoop分布式文件系统（HDFS）中，通过Spark SQL对数据进行清洗、转换和多维度聚合分析。分析功能涵盖患者人口学特征、肿瘤临床特征、治疗方案与预后效果、临床症状关联性以及高风险因素探索等五大核心模块。处理后的结果经由Django API传递至前端，前端则运用Vue框架结合ElementUI组件库与Echarts图表库，将复杂的数据关系转化为直观的交互式图表，如性别年龄分布、肿瘤位置与恶性程度关联、不同治疗方案生存率对比等，为医疗研究者和临床医生提供一个全面、高效的数据洞察工具。</p>
<h2 data-id="heading-1">脑肿瘤数据可视化分系统-技术</h2>
<p>开发语言：Python或Java
大数据框架：Hadoop+Spark（本次没用Hive，支持定制）
后端框架：Django+Spring Boot(Spring+SpringMVC+Mybatis)
前端：Vue+ElementUI+Echarts+HTML+CSS+JavaScript+jQuery
详细技术点：Hadoop、HDFS、Spark、Spark SQL、Pandas、NumPy
数据库：MySQL</p>
<h2 data-id="heading-2">脑肿瘤数据可视化分系统-背景</h2>
<p>选题背景
随着医疗信息化进程的加快，医院积累了海量的脑肿瘤患者诊疗数据，这些数据包含了从患者基本信息到复杂治疗方案的多个维度。脑肿瘤本身作为一种复杂的疾病，其成因、发展和治疗效果受到众多因素交织影响。面对如此庞大且关系错综复杂的数据集，传统的统计分析工具往往显得力不从心，难以快速、全面地揭示隐藏在数据背后的规律。如何有效利用这些宝贵的数据资产，从中发现有价值的临床洞见，辅助医生进行更精准的诊断和治疗决策，成为了当前医疗领域面临的一个实际问题。因此，构建一个能够处理和分析这类复杂数据的系统显得尤为必要。</p>
<p>选题意义
本课题的意义在于将前沿的大数据技术应用于具体的医疗数据分析场景中，具有很强的实践价值。从技术层面看，它完整地实践了从数据存储、分布式计算到前端可视化的全流程，巩固了对Hadoop和Spark生态的理解与应用能力。从应用角度看，系统通过多维度的交互式图表，将原本枯燥的脑肿瘤数据变得直观易懂，能够帮助医学专业的学生或初级研究人员快速把握数据特征，发现一些潜在的临床关联模式，比如特定年龄段的高发肿瘤类型或不同治疗方案的疗效对比。虽然作为一个毕业设计，其分析深度和模型精度有限，但它为探索医疗数据的价值提供了一个可行的方法和思路，展示了大数据技术在精准医疗领域的应用潜力。</p>
<h2 data-id="heading-3">脑肿瘤数据可视化分系统-视频展示</h2>
<p>[video(video-53oW3KNj-1768628790189)(type-csdn)(url-<a href="https://link.juejin.cn?target=https%3A%2F%2Flive.csdn.net%2Fv%2Fembed%2F510509)(image-https%3A%2F%2Fi-blog.csdnimg.cn%2Fdirect%2Fba107941315b4411b07040a15571a3d1.png)(title-%25E5%259F%25BA%25E4%25BA%258EHadoop%2BSpark%25E7%259A%2584%25E8%2584%2591%25E8%2582%25BF%25E7%2598%25A4%25E6%2595%25B0%25E6%258D%25AE%25E5%258F%25AF%25E8%25A7%2586%25E5%258C%2596%25E5%2588%2586%25E7%25B3%25BB%25E7%25BB%259F" target="_blank" title="https://live.csdn.net/v/embed/510509)(image-https://i-blog.csdnimg.cn/direct/ba107941315b4411b07040a15571a3d1.png)(title-%E5%9F%BA%E4%BA%8EHadoop+Spark%E7%9A%84%E8%84%91%E8%82%BF%E7%98%A4%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E7%B3%BB%E7%BB%9F" ref="nofollow noopener noreferrer">live.csdn.net/v/embed/510…</a>)]</p>
<h2 data-id="heading-4">脑肿瘤数据可视化分系统-图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ca6479f27640cea8fc037c722e9626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=L0L4Ooc%2BC%2BVlgNYPQq3nDbOt%2BAk%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61167753b6894641894b32b7db9fb88d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=czPlR0ro48G9eNe2e7Wp7OQ%2B9ME%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef857ad3c8f470ab1f897a47ed43b19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=V%2Bw1wUNaYt8rgqSj9RndYKmQiBE%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34aff6a7fc54254b5da103426ef75c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=k12dpiENNLtfduJjMg9ISoNFvb0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51ab6cab7144bfb9e3c3bddfd65c128~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=Ne8fzBXWEk31IeFo3Iq%2BhCRzZCM%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4517d050331f47d98cb50fec03307c63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=aMU5wKvmetBFw%2BWL1qBC%2Bj2VKzg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf6a4bb6e794084babc2721a675edd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=4bFpALfQjiyQfdqLAob4BCFqyi0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b64fe039a2e3403c9b66be7c381c5f72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=Uf5IHjRxrequrUB30UpDqS0t4xk%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebbdbb846879468591e47ed6cd5b03ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=G0yXRlkvPLkgPWOMFnDKSjd3CUg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8668a1825a574a5da064bd933f3bc979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=CMK7xL3HL4W7t%2BvwZ2hWvxBpKpo%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a048459d774ab3bc78a6a73acdbca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py657yW56iL5oyH5a-85biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769241077&amp;x-signature=9wk1%2FM%2BH1lWcRTGtc6i0MMbP6NY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">脑肿瘤数据可视化分系统-代码展示</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession, functions <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">from</span> pyspark.sql.types <span class="hljs-keyword">import</span> IntegerType
spark = SparkSession.builder.appName(<span class="hljs-string">"BrainTumorAnalysis"</span>).getOrCreate()
df = spark.read.csv(<span class="hljs-string">"hdfs://path/to/brain_tumor_data.csv"</span>, header=<span class="hljs-literal">True</span>, inferSchema=<span class="hljs-literal">True</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_age_gender_distribution</span>():
    age_group_df = df.withColumn(<span class="hljs-string">"Age_Group"</span>, F.when((df.Age &lt; <span class="hljs-number">18</span>), <span class="hljs-string">"少年"</span>).when((df.Age &gt;= <span class="hljs-number">18</span>) &amp; (df.Age &lt; <span class="hljs-number">40</span>), <span class="hljs-string">"青年"</span>).when((df.Age &gt;= <span class="hljs-number">40</span>) &amp; (df.Age &lt; <span class="hljs-number">60</span>), <span class="hljs-string">"中年"</span>).otherwise(<span class="hljs-string">"老年"</span>))
    result_df = age_group_df.groupBy(<span class="hljs-string">"Age_Group"</span>, <span class="hljs-string">"Gender"</span>).count().orderBy(<span class="hljs-string">"Age_Group"</span>, <span class="hljs-string">"Gender"</span>)
    result_df.show()
    <span class="hljs-keyword">return</span> result_df
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_treatment_survival</span>():
    treatment_df = df.withColumn(<span class="hljs-string">"Treatment_Combination"</span>, F.concat_ws(<span class="hljs-string">"+"</span>, F.when(df.Surgery_Performed == <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"手术"</span>), F.when(df.Radiation_Treatment == <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"放疗"</span>), F.when(df.Chemotherapy == <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"化疗"</span>)))
    survival_df = treatment_df.groupBy(<span class="hljs-string">"Treatment_Combination"</span>).agg(F.avg(<span class="hljs-string">"Survival_Rate"</span>).alias(<span class="hljs-string">"Average_Survival_Rate"</span>), F.count(<span class="hljs-string">"*"</span>).alias(<span class="hljs-string">"Patient_Count"</span>)).orderBy(F.desc(<span class="hljs-string">"Average_Survival_Rate"</span>))
    survival_df.show()
    <span class="hljs-keyword">return</span> survival_df
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_correlation</span>():
    correlation_df = df.select(<span class="hljs-string">"Age"</span>, <span class="hljs-string">"Tumor_Size"</span>, <span class="hljs-string">"Survival_Rate"</span>, <span class="hljs-string">"Tumor_Growth_Rate"</span>).na.drop()
    age_size_corr = correlation_df.stat.corr(<span class="hljs-string">"Age"</span>, <span class="hljs-string">"Tumor_Size"</span>)
    age_survival_corr = correlation_df.stat.corr(<span class="hljs-string">"Age"</span>, <span class="hljs-string">"Survival_Rate"</span>)
    size_survival_corr = correlation_df.stat.corr(<span class="hljs-string">"Tumor_Size"</span>, <span class="hljs-string">"Survival_Rate"</span>)
    growth_survival_corr = correlation_df.stat.corr(<span class="hljs-string">"Tumor_Growth_Rate"</span>, <span class="hljs-string">"Survival_Rate"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"年龄与肿瘤尺寸的相关系数: <span class="hljs-subst">{age_size_corr}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"年龄与生存率的相关系数: <span class="hljs-subst">{age_survival_corr}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"肿瘤尺寸与生存率的相关系数: <span class="hljs-subst">{size_survival_corr}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"肿瘤生长速率与生存率的相关系数: <span class="hljs-subst">{growth_survival_corr}</span>"</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"age_size"</span>: age_size_corr, <span class="hljs-string">"age_survival"</span>: age_survival_corr, <span class="hljs-string">"size_survival"</span>: size_survival_corr, <span class="hljs-string">"growth_survival"</span>: growth_survival_corr}
</code></pre>
<h2 data-id="heading-6">脑肿瘤数据可视化分系统-结语</h2>
<p>这个项目完整走通了大数据分析流程，从Hadoop存储到Spark计算，再到前端可视化，技术栈很扎实。希望能给正在做毕设的同学一点启发。如果觉得有帮助，别忘了点赞收藏，你的支持是我更新的最大动力！</p>
<p>刚肝完这个基于Spark的脑肿瘤分析毕设，感觉头发又掉了不少😂。数据清洗和特征工程真的太磨人了，但最后看到Echarts图表出来的那一刻，值了！大家选题都定了吗？评论区聊聊，互相避坑啊！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nestjs学习3：核心概念扫盲]]></title>    <link>https://juejin.cn/post/7595873251165257769</link>    <guid>https://juejin.cn/post/7595873251165257769</guid>    <pubDate>2026-01-17T03:21:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595873251165257769" data-draft-id="7595491816776040489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nestjs学习3：核心概念扫盲"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-01-17T03:21:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nestjs学习3：核心概念扫盲
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T03:21:02.000Z" title="Sat Jan 17 2026 03:21:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>声明：本文来自于光神的文章，复制到这里只是为了自己更好的复习。</p>
<p>Nest 是对标 Java 的 Spring 框架的后端框架，它有很多概念。对于新手来说，上来就接触这些概念可能会有点懵，今天主要是过一下概念。</p>
<p>我们通过不同的 url 来访问后端接口：/user/create 、/user/list、/book/create、/book/list，不同的 url 是不同的路由。</p>
<p>这些路由在 Controller 里声明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3181246e60004f85bfefc5afe96ebc49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=uGDa6K40G5cxVK9E%2BuxiHQifeGs%3D" alt="image.png" loading="lazy"/></p>
<p>在 class 上和它方法的方法上加上 @Controller、@Get、@Post 的装饰器就可以了。</p>
<p>controller里面的方法，比如 create、findAll等叫做 <code>handler</code>，是处理路由的。</p>
<p>post 的请求体，get 的请求参数，都可以通过装饰来取：</p>
<p>通过 @Param 取 url 中的参数，比如 /user/111 里的 111:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b18cdebe39f49f88aa9d6bda3772bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=dFTUpGAxAyyq6akjUa7e3NTFI%2Fk%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Query 来取 url 中的 query 参数，比如 /user/xx?id=222 里的 222</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b2cb2c2484d46aa87bd119e16022472~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=m9aWInXUgnqYm0bYXpVcNmJ1%2BUM%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Body 取 /book/create 的请求体内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3fde21f100a4369b1fb0b2e88b0579f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=4NX0db%2B15cH5JGysqbc2CMQYNlU%3D" alt="image.png" loading="lazy"/></p>
<p>那<code>@Param、@Query、@Body</code>装饰器在其中起了什么作用呢？</p>
<ul>
<li>当 NestJS 应用启动、加载控制器类时，装饰器会<strong>先执行</strong>（装饰器的执行时机是类 / 方法定义时，而非请求到来时），<code>@Param('id')</code> 的核心逻辑如下：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>; 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Param</span>(<span class="hljs-params">paramKey?: string</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: object, methodKey: string | symbol, paramIndex: number</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">METADATA_KEY</span> = <span class="hljs-string">'nest:params:metadata'</span>;
        <span class="hljs-comment">// 先获取该方法已有的元数据</span>
        <span class="hljs-keyword">const</span> existingMetadata = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-variable constant_">METADATA_KEY</span>, target, methodKey) || [];
        existingMetadata[paramIndex] = { 
            <span class="hljs-attr">type</span>: <span class="hljs-string">'param'</span>, <span class="hljs-comment">// 标识参数类型是路由参数 </span>
            <span class="hljs-attr">key</span>: paramKey, <span class="hljs-comment">// 要提取的参数名（比如 'id'） </span>
        };
        <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineMetadata</span>(<span class="hljs-variable constant_">METADATA_KEY</span>, existingMetadata, target, methodKey);
}
</code></pre>
<ul>
<li>当客户端发起 <code>GET /users/123</code> 请求时，NestJS 的底层 HTTP 适配器（Express/Fastify）解析请求，得到 <code>request</code> 对象，其中 <code>request.params = { id: '123' }</code>。NestJS 会创建执行上下文（ExecutionContext），把 <code>request</code>、<code>response</code>、路由匹配结果等都封装进去。NestJS 的参数处理器（Parameter Handler）会执行以下操作：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getParamValue</span>(<span class="hljs-params">target: object, methodKey: string, paramIndex: number, context: ExecutionContext</span>) {
  <span class="hljs-comment">// 1. 获取步骤 1 中存入的元数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">METADATA_KEY</span> = <span class="hljs-string">'nest:params:metadata'</span>;
  <span class="hljs-keyword">const</span> paramMetadata = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-variable constant_">METADATA_KEY</span>, target, methodKey)[paramIndex];
  
  <span class="hljs-comment">// 2. 从上下文获取 request 对象</span>
  <span class="hljs-keyword">const</span> request = context.<span class="hljs-title function_">switchToHttp</span>().<span class="hljs-title function_">getRequest</span>();
  
  <span class="hljs-comment">// 3. 根据元数据提取对应值</span>
  <span class="hljs-keyword">if</span> (paramMetadata.<span class="hljs-property">type</span> === <span class="hljs-string">'param'</span>) {
    <span class="hljs-comment">// 如果指定了 key（比如 'id'），取单个值；否则取整个 params 对象</span>
    <span class="hljs-keyword">return</span> paramMetadata.<span class="hljs-property">key</span> ? request.<span class="hljs-property">params</span>[paramMetadata.<span class="hljs-property">key</span>] : request.<span class="hljs-property">params</span>;
  }
}
</code></pre>
<ul>
<li>NestJS 把上面提取到的 <code>'123'</code> 赋值给 <code>findOne</code> 方法的第 0 个参数（也就是 <code>id</code>），执行 <code>findOne</code> 函数时<code>id</code> 被赋值为 <code>'123'</code>。</li>
</ul>
<p>总的来说就是这样：</p>
<ol>
<li>
<p><strong>定义元数据</strong>：应用启动时，<code>@Param</code> 装饰器通过 <code>Reflect.defineMetadata</code> 把参数要从哪里取值的规则存在方法的元数据中；</p>
</li>
<li>
<p><strong>运行时注入</strong>：请求到来时，NestJS 先通过 <code>Reflect.getMetadata</code> 读取元数据，再从请求上下文的 <code>request.params</code> 中提取对应值，最后注入到函数参数中执行；</p>
</li>
<li>
<p><strong>核心依赖</strong>：整个过程的基础是 <code>Reflect Metadata</code> API，它让 NestJS 能 “记住” 装饰器的规则，实现参数的自动注入，<strong>无需手动操作 <code>request</code> 对象</strong>。</p>
</li>
</ol>
<blockquote>
<p>框架这样做的好处是什么呢？</p>
<p>好处是我们无需手动处理<code>request</code>对象，全是框架帮我们做了。你在写express时是不是自己从request对象中获取参数，特别繁琐。</p>
</blockquote>
<p>回归正题，也就是说 <strong>controller 是处理路由和解析请求参数的</strong>。</p>
<p>请求参数解析出来了，下一步就是做业务逻辑的处理了，这些东西不写在 controller 里，而是放在 service 里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/144f7d1085724893bf3ddbdf4311f099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=g%2BpUfqYehgfL%2Bd%2Fj0MHSJAwC35U%3D" alt="image.png" loading="lazy"/></p>
<p><strong>service 里做业务逻辑的具体实现，比如操作数据库等</strong></p>
<p>同理，/book/list、/book/create 接口是在另一个 BookController 里，它的业务逻辑实现也是在 BookService 里。</p>
<p>很明显，UserController 和 UserService 是一块的，BookController 和 BookService 是一块的。</p>
<p>所以，Nest 有了模块的划分，每个模块里都包含 controller 和 service：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c452baa95e24e109258a584904a769f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=faqdr2kQaPV9ffyB9QKkSY2UT1w%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Module 声明模块，它包含 controllers 和 providers。</p>
<p>为啥不是 services 而是 providers 呢？</p>
<p>因为 Nest 实现了一套依赖注入机制，叫做 IoC（Inverse of Control 反转控制）。</p>
<p>简单说就是你只需要声明依赖了啥就行，不需要手动去 new 依赖，Nest 的 IoC 容器会自动给你创建并注入依赖。</p>
<p>比如这个 UserController 依赖了 JwtService，那只需要通过 @Inject 声明依赖，然后就可以在方法里用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b39ec6743c2f4051a84af012f2644b70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=NiWMSzXFfWWKLavk%2B3jHitYF3%2FA%3D" alt="image.png" loading="lazy"/></p>
<p>运行的时候会自动查找这个 JwtServcie 的实例来注入。</p>
<p><strong>在 @Module 里的 providers 数组里，就是声明要往 IoC 容器里提供的对象，所以这里叫做 providers。</strong></p>
<p>provider 有很多种写法：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4410d7fe085748d39efd8949f4e47248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=8nnerrkKgLvTDerPZvPZW%2FvdVqI%3D" alt="image.png" loading="lazy"/></p>
<p>默认的 XxxService 只是一种简化的写法。</p>
<p>还可以直接 useValue 创建，通过 useFactory 创建等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad7a6761a1e74507baa6c7e49a3e2769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=JmvkW7WSlLixwdKaC1V84jJz7Ac%3D" alt="image.png" loading="lazy"/></p>
<p>刚才提到了 IoC 会自动从容器中查找实例来注入，注入的方式有两种：</p>
<p><strong>属性注入和构造器注入。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e2068d805f4e25901c6fcf5e04a162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=VUyJvI5Tn6WJBGI%2BGMA32NiPVrw%3D" alt="image.png" loading="lazy"/></p>
<p>这种写在构造器里的依赖，就是构造器注入。</p>
<p>@Inject 写在属性上的依赖，就是属性注入。</p>
<p>效果是一样的，只是注入的时机不同。</p>
<p>每个模块都会包含 controller、service、module、dto、entities 这些东西：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/accdd60bafff4c5b9ffeaaeb0274cbe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=d2%2BhuQzY2waoUohU7aCZJ2Upgwk%3D" alt="image.png" loading="lazy"/></p>
<p>controller 是处理路由，解析请求参数的。</p>
<p>service 是处理业务逻辑的，比如操作数据库。</p>
<p>dto 是封装请求参数的。</p>
<p>entities 是封装对应数据库表的实体的。</p>
<p>nest 应用跑起来后，会从 AppModule 开始解析，初始化 IoC 容器，加载所有的 service 到容器里，然后解析 controller 里的路由，接下来就可以接收请求了。</p>
<p>应用中会有很多 controller、service，那如果是跨多个 controller 的逻辑呢？</p>
<p>这种在 Nest 提供了 AOP （Aspect Oriented Programming 面向切面编程）的机制</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe82217eb164362b240efc1c3dae1e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=QkkKSKL182OVLuGYMv7%2BHroFwEU%3D" alt="image.png" loading="lazy"/></p>
<p>具体来说，有 Middleware、Guard、Interceptor、Pipe、Exception Filter 这五种。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b377262312524529acbf6e47cdd404e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=xwuk%2FP%2F8q6Pqf%2FJrkzTLCb4fBfg%3D" alt="image.png" loading="lazy"/></p>
<p>它们都是在目标 controller 的 handler 前后，额外加一段逻辑的。</p>
<p>比如你可以通过 interceptor 实现请求到响应的时间的记录：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f084f2355e184a6d98d3e04f979465ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=9ExCE89cD8xOanwtI4L%2FIV2PXuo%3D" alt="image.png" loading="lazy"/></p>
<p>这种逻辑适合放在 controller 里么？</p>
<p>不适合，这种通用逻辑应该通过 interceptor 等方式抽离出来，然后需要用的时候在 controller 上声明一下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b30e27c45f1a4d5d9e78e2bdf074189f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769224862&amp;x-signature=DGqdYLUY1bbWke9dZkY9WHHq71g%3D" alt="image.png" loading="lazy"/></p>
<p>我们可以通过一个简单的例子来理解下 <code>@UseInterceptors</code>的逻辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Intercept</span>(<span class="hljs-params">interceptor: { before?: <span class="hljs-built_in">Function</span>; after?: <span class="hljs-built_in">Function</span> }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">target: any, propertyKey: string, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-comment">// 保存原始方法</span>
    <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 重写方法</span>
    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: any[]</span>) {
      <span class="hljs-comment">// 执行前置拦截逻辑</span>
      <span class="hljs-keyword">if</span> (interceptor.<span class="hljs-property">before</span>) {
        interceptor.<span class="hljs-title function_">before</span>(args);
      }

      <span class="hljs-comment">// 调用原始方法</span>
      <span class="hljs-keyword">const</span> result = originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);

      <span class="hljs-comment">// 执行后置拦截逻辑</span>
      <span class="hljs-keyword">if</span> (interceptor.<span class="hljs-property">after</span>) {
        interceptor.<span class="hljs-title function_">after</span>(result);
      }

      <span class="hljs-comment">// 返回原始方法的结果</span>
      <span class="hljs-keyword">return</span> result;
    };

    <span class="hljs-keyword">return</span> descriptor;
  };
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
  @<span class="hljs-title class_">Intercept</span>({
    <span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">args: any[]</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[BEFORE] Method is about to be called with args: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(args)}</span>`</span>);
    },
    <span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">result: any</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[AFTER] Method returned: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result)}</span>`</span>);
    },
  })
  <span class="hljs-title function_">myMethod</span>(<span class="hljs-params">arg1: string, arg2: number</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Executing myMethod"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Received: <span class="hljs-subst">${arg1}</span>, <span class="hljs-subst">${arg2}</span>`</span>;
  }
}

<span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();
instance.<span class="hljs-title function_">myMethod</span>(<span class="hljs-string">"Hello"</span>, <span class="hljs-number">42</span>);

</code></pre>
<p>这些就是 Nest 的核心概念了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发 Kafka 消息发送：基于 Go 的并发安全实现与最佳实践]]></title>    <link>https://juejin.cn/post/7595871887000420352</link>    <guid>https://juejin.cn/post/7595871887000420352</guid>    <pubDate>2026-01-17T03:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595871887000420352" data-draft-id="7595871887000403968" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发 Kafka 消息发送：基于 Go 的并发安全实现与最佳实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T03:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kevin666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发 Kafka 消息发送：基于 Go 的并发安全实现与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kevin666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T03:33:05.000Z" title="Sat Jan 17 2026 03:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高吞吐业务场景中，Kafka 作为分布式消息队列，是实现消息异步投递、削峰填谷的核心组件。而基于 Go 语言开发 Kafka 生产者时，如何通过并发提升发送速度，同时保证并发安全，是很多开发者面临的核心问题。本文将通过一个实际场景，拆解「多生产者 + 多协程」的并发模型，详解其并发安全性，并基于开源组件完成可落地的实现。</p>
<h2 data-id="heading-0">一、场景背景：为什么需要并发发送 Kafka 消息？</h2>
<p>在内容审核、日志采集、数据同步等业务场景中，常常会遇到每秒数万条甚至数十万条消息的发送需求。单生产者实例的处理能力存在上限，受限于网络 IO、消息批量打包、服务器资源等因素，无法满足高并发投递要求，容易出现消息积压、发送延迟升高等问题。</p>
<p>Go 语言凭借其轻量级协程（Goroutine）的优势，能够轻松实现高并发处理。而「多生产者 + 多协程」的并发模型，正是突破单生产者性能瓶颈，实现高吞吐消息发送的最优方案之一。</p>
<p>本文将基于开源的 <code>sarama</code> 库（Kafka 官方推荐的 Go 语言客户端），实现高并发 Kafka 消息发送，并重点解答：<strong>并发场景下，Kafka 消息发送的安全性如何保证？</strong></p>
<h2 data-id="heading-1">二、核心疑问：并发发送 Kafka 消息，会存在安全问题吗？</h2>
<p>很多开发者在实现并发发送时，都会有这样的顾虑：多个协程同时调用消息发送方法，会不会出现数据竞争、消息丢失、消息错乱等问题？</p>
<p>答案先抛出来：<strong>合理的并发设计下，Kafka 消息发送是并发安全的</strong>。具体可从两个核心层面保障，这也是本文实现的核心依据。</p>
<h3 data-id="heading-2">1. 消息发送方法本身：无状态、无共享，天然并发安全</h3>
<p>消息发送的核心方法，本身只负责参数传递和底层客户端调用，不维护任何全局状态、静态变量，也不修改传入参数的内容。每个调用都是独立的，多个协程同时调用不会相互干扰。</p>
<h3 data-id="heading-3">2. 开源 Kafka 客户端（sarama）：生产者实例协程安全</h3>
<p><code>sarama</code> 库实现的 Kafka 生产者（<code>sarama.SyncProducer</code>/<code>sarama.AsyncProducer</code>）本身是协程安全的，支持多个协程同时调用其发送方法。底层通过锁机制、内部消息队列，处理并发请求的竞争问题，开发者无需手动处理同步锁，降低了并发开发的复杂度。</p>
<h3 data-id="heading-4">3. 额外保障：「一个协程对应一个独立生产者实例」</h3>
<p>即使在某些场景下，客户端生产者实例非协程安全（极少出现），我们也可以通过「一个协程对应一个独立生产者实例」的设计，避免共享实例的竞争问题，实现双重保障。这也是本文实现的核心设计思路。</p>
<h2 data-id="heading-5">三、可落地实现：基于 sarama 的高并发 Kafka 生产者</h2>
<h3 data-id="heading-6">1. 前期准备：安装 sarama 开源库</h3>
<p>首先安装官方推荐的<code>sarama</code>库，这是实现 Kafka 消息发送的基础：</p>
<pre><code class="hljs language-arduino" lang="arduino">go get github.com/Shopify/sarama
</code></pre>
<h3 data-id="heading-7">2. 全局配置定义：替换业务变量，统一配置管理</h3>
<p>我们先定义全局的配置常量和通道，替换原业务代码中的私有变量，保证代码的可复用性：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"os/signal"</span>
	<span class="hljs-string">"syscall"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/Shopify/sarama"</span>
)

<span class="hljs-comment">// 全局配置：替换原业务中的 MAX_WORKERS、JobQue、JobQuitChan</span>
<span class="hljs-keyword">const</span> (
	<span class="hljs-comment">// 并发生产者数量（可根据业务需求、服务器资源调整）</span>
	ConcurrentProducerNum = <span class="hljs-number">5</span>
	<span class="hljs-comment">// 任务通道缓冲区大小：防止协程阻塞，削峰填谷</span>
	JobChanBufferSize = <span class="hljs-number">10000</span>
)

<span class="hljs-comment">// 消息任务结构体：替换原业务中的 job，封装发送所需的核心数据</span>
<span class="hljs-keyword">type</span> KafkaSendJob <span class="hljs-keyword">struct</span> {
	Ctx  context.Context <span class="hljs-comment">// 上下文：用于超时控制、取消操作</span>
	Msg  []<span class="hljs-type">byte</span>          <span class="hljs-comment">// 待发送的消息内容</span>
	Key  <span class="hljs-type">string</span>          <span class="hljs-comment">// Kafka消息Key：用于分区路由</span>
}

<span class="hljs-comment">// 全局变量：任务通道和退出通道</span>
<span class="hljs-keyword">var</span> (
	<span class="hljs-comment">// 消息任务通道：接收待发送的消息任务</span>
	KafkaJobChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> KafkaSendJob, JobChanBufferSize)
	<span class="hljs-comment">// 协程退出通道：用于优雅关闭所有生产者协程</span>
	ProducerQuitChan = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, ConcurrentProducerNum)
	<span class="hljs-comment">// Kafka集群地址：替换原业务中的 kafkaEnv.ProducerEnv.Cluster</span>
	KafkaBrokerList = []<span class="hljs-type">string</span>{<span class="hljs-string">"127.0.0.1:9092"</span>}
	<span class="hljs-comment">// Kafka主题：替换原业务中的 kafkaEnv.ProducerEnv.KafkaTopic</span>
	KafkaTopic = <span class="hljs-string">"test_high_concurrency_topic"</span>
)
</code></pre>
<h3 data-id="heading-8">3. 核心实现 1：初始化多生产者，启动并发协程</h3>
<p>这部分对应原业务中的<code>InitProducers</code>函数，我们基于<code>sarama</code>创建多个生产者实例，每个实例对应一个独立协程，实现并发发送：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// InitKafkaProducers 初始化多个Kafka生产者实例，启动并发发送协程</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitKafkaProducers</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 1. 配置sarama生产者参数</span>
	saramaConfig := sarama.NewConfig()
	<span class="hljs-comment">// 设置生产者ACK级别：-1=等待所有副本确认，保证消息不丢失</span>
	saramaConfig.Producer.RequiredAcks = sarama.WaitForAll
	<span class="hljs-comment">// 启用消息批量发送：提升发送吞吐量</span>
	saramaConfig.Producer.Flush.Bytes = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// 批量发送阈值：1MB</span>
	saramaConfig.Producer.Flush.Frequency = <span class="hljs-number">50</span> * time.Millisecond <span class="hljs-comment">// 批量发送间隔：50ms</span>
	<span class="hljs-comment">// 配置消息序列化格式</span>
	saramaConfig.Producer.Return.Successes = <span class="hljs-literal">true</span>
	saramaConfig.Producer.Return.Errors = <span class="hljs-literal">true</span>
	<span class="hljs-comment">// 设置版本兼容（根据你的Kafka集群版本调整）</span>
	saramaConfig.Version = sarama.V2_8_1_0

	<span class="hljs-comment">// 2. 循环创建多个生产者实例，启动对应协程</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= ConcurrentProducerNum; i++ {
		<span class="hljs-comment">// 创建同步生产者实例（同步发送：等待发送结果返回，便于重试）</span>
		producer, err := sarama.NewSyncProducer(KafkaBrokerList, saramaConfig)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"创建第%d个Kafka生产者失败：%v"</span>, i, err)
			<span class="hljs-keyword">return</span> err
		}
		log.Printf(<span class="hljs-string">"第%d个Kafka生产者创建成功，已启动对应发送协程"</span>, i)

		<span class="hljs-comment">// 启动独立协程，处理消息发送任务（每个协程独占一个生产者实例）</span>
		<span class="hljs-keyword">go</span> RunKafkaProducer(producer, i)
	}

	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-9">4. 核心实现 2：协程业务逻辑，处理消息发送任务</h3>
<p>这部分对应原业务中的<code>Run</code>函数，每个协程从任务通道中获取消息，调用发送方法完成投递，并支持优雅退出：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// RunKafkaProducer 单个生产者协程的业务逻辑，循环处理消息任务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RunKafkaProducer</span><span class="hljs-params">(producer sarama.SyncProducer, producerID <span class="hljs-type">int</span>)</span></span> {
	<span class="hljs-comment">// 优雅退出：关闭生产者实例，释放资源</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">if</span> err := producer.Close(); err != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"第%d个生产者关闭失败：%v"</span>, producerID, err)
		} <span class="hljs-keyword">else</span> {
			log.Printf(<span class="hljs-string">"第%d个生产者已正常关闭"</span>, producerID)
		}
		<span class="hljs-comment">// 捕获协程panic，防止单个协程异常导致整个服务崩溃</span>
		<span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
			log.Printf(<span class="hljs-string">"第%d个生产者协程发生panic：%v"</span>, producerID, r)
		}
	}()

	log.Printf(<span class="hljs-string">"第%d个生产者协程已启动，开始监听消息任务"</span>, producerID)

	<span class="hljs-comment">// 循环监听任务通道和退出通道</span>
	<span class="hljs-keyword">for</span> {
		<span class="hljs-keyword">select</span> {
		<span class="hljs-comment">// 从任务通道获取待发送的消息</span>
		<span class="hljs-keyword">case</span> job := &lt;-KafkaJobChan:
			<span class="hljs-comment">// 记录发送指标（此处简化，实际可接入Prometheus）</span>
			log.Printf(<span class="hljs-string">"第%d个生产者获取到消息任务，消息长度：%d"</span>, producerID, <span class="hljs-built_in">len</span>(job.Msg))
			<span class="hljs-comment">// 调用发送方法，支持3次重试</span>
			err := RetryKafkaMsgSend(producer, job, <span class="hljs-number">3</span>)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				log.Printf(<span class="hljs-string">"第%d个生产者消息发送失败（已重试3次）：%v"</span>, producerID, err)
			}
		<span class="hljs-comment">// 接收退出信号，优雅关闭协程</span>
		<span class="hljs-keyword">case</span> &lt;-ProducerQuitChan:
			log.Printf(<span class="hljs-string">"第%d个生产者接收到退出信号，即将停止工作"</span>, producerID)
			<span class="hljs-keyword">return</span>
		}
	}
}
</code></pre>
<h3 data-id="heading-10">5. 核心实现 3：消息发送与重试机制</h3>
<p>这部分对应原业务中的<code>MsgSend</code>和<code>RetryMsgSend</code>函数，实现消息的核心发送逻辑，并添加重试机制，保证消息投递的可靠性：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// KafkaMsgSend 核心消息发送方法，调用sarama生产者完成消息投递</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">KafkaMsgSend</span><span class="hljs-params">(producer sarama.SyncProducer, job KafkaSendJob)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 构建Kafka消息</span>
	msg := &amp;sarama.ProducerMessage{
		Topic: KafkaTopic,
		Key:   sarama.StringEncoder(job.Key),
		Value: sarama.ByteEncoder(job.Msg),
	}

	<span class="hljs-comment">// 调用sarama同步发送方法</span>
	partition, offset, err := producer.SendMessage(msg)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}

	<span class="hljs-comment">// 发送成功，打印日志（实际场景可省略或接入监控）</span>
	log.Printf(<span class="hljs-string">"消息发送成功：分区=%d，偏移量=%d"</span>, partition, offset)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// RetryKafkaMsgSend 消息发送重试机制，支持指定重试次数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RetryKafkaMsgSend</span><span class="hljs-params">(producer sarama.SyncProducer, job KafkaSendJob, retryTimes <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>

	<span class="hljs-comment">// 循环重试发送</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; retryTimes; i++ {
		err = KafkaMsgSend(producer, job)
		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
			<span class="hljs-comment">// 发送成功，直接返回</span>
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}

		<span class="hljs-comment">// 发送失败，打印重试日志，延迟后重试（指数退避，优化版可调整）</span>
		log.Printf(<span class="hljs-string">"消息发送第%d次失败，即将重试：%v"</span>, i+<span class="hljs-number">1</span>, err)
		time.Sleep(time.Duration(i+<span class="hljs-number">1</span>) * <span class="hljs-number">100</span> * time.Millisecond)
	}

	<span class="hljs-comment">// 所有重试次数耗尽，返回最终错误</span>
	<span class="hljs-keyword">return</span> err
}
</code></pre>
<h3 data-id="heading-11">6. 优雅关闭：处理系统信号，保证消息不丢失</h3>
<p>在实际生产环境中，服务停止时需要优雅关闭生产者，防止正在发送的消息丢失，我们通过监听系统信号实现这一功能：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// SetupGracefulShutdown 配置优雅关闭，处理系统停止信号</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetupGracefulShutdown</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 创建系统信号通道</span>
	sigChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
	<span class="hljs-comment">// 监听SIGINT（Ctrl+C）和SIGTERM（容器停止）信号</span>
	signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

	<span class="hljs-comment">// 阻塞等待系统信号</span>
	&lt;-sigChan
	log.Println(<span class="hljs-string">"接收到系统停止信号，开始优雅关闭Kafka生产者..."</span>)

	<span class="hljs-comment">// 1. 关闭任务通道，停止接收新任务</span>
	<span class="hljs-built_in">close</span>(KafkaJobChan)
	log.Println(<span class="hljs-string">"消息任务通道已关闭，不再接收新任务"</span>)

	<span class="hljs-comment">// 2. 向所有生产者协程发送退出信号</span>
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; ConcurrentProducerNum; i++ {
		ProducerQuitChan &lt;- <span class="hljs-keyword">struct</span>{}{}
	}
	<span class="hljs-built_in">close</span>(ProducerQuitChan)
	log.Println(<span class="hljs-string">"已向所有生产者协程发送退出信号"</span>)

	<span class="hljs-comment">// 3. 等待所有协程退出（此处简化，实际可通过sync.WaitGroup实现精准等待）</span>
	time.Sleep(<span class="hljs-number">5</span> * time.Second)
	log.Println(<span class="hljs-string">"Kafka生产者优雅关闭完成，服务退出"</span>)
}
</code></pre>
<h3 data-id="heading-12">7. 测试主函数：模拟消息生产，验证并发效果</h3>
<p>最后，我们编写主函数，模拟高并发消息生产，验证整个方案的可行性：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 1. 初始化Kafka生产者</span>
	err := InitKafkaProducers()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"初始化Kafka生产者失败：%v"</span>, err)
	}

	<span class="hljs-comment">// 2. 配置优雅关闭</span>
	<span class="hljs-keyword">go</span> SetupGracefulShutdown()

	<span class="hljs-comment">// 3. 模拟生产1000条测试消息，投递到任务通道</span>
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ {
			job := KafkaSendJob{
				Ctx:  context.Background(),
				Msg:  []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">"高并发测试消息：%d"</span>, i)),
				Key:  fmt.Sprintf(<span class="hljs-string">"test_key_%d"</span>, i%<span class="hljs-number">10</span>), <span class="hljs-comment">// 均匀分布到10个分区</span>
			}
			<span class="hljs-comment">// 投递任务到通道（非阻塞，利用缓冲区削峰）</span>
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> KafkaJobChan &lt;- job:
			<span class="hljs-keyword">default</span>:
				log.Printf(<span class="hljs-string">"消息任务通道已满，丢弃第%d条消息"</span>, i)
			}
			<span class="hljs-comment">// 模拟消息生产间隔</span>
			time.Sleep(<span class="hljs-number">1</span> * time.Millisecond)
		}
		log.Println(<span class="hljs-string">"1000条测试消息已全部投递到任务通道"</span>)
	}()

	<span class="hljs-comment">// 4. 阻塞主线程，保持服务运行</span>
	<span class="hljs-keyword">select</span> {}
}
</code></pre>
<h2 data-id="heading-13">四、关键总结：并发安全的核心保障与最佳实践</h2>
<h3 data-id="heading-14">1. 并发安全的核心保障</h3>
<ol>
<li><strong><code>KafkaMsgSend</code> 方法天然安全</strong>：无内部共享状态，仅做参数传递和<code>sarama</code>方法调用，多个协程同时调用无干扰；</li>
<li><strong><code>sarama</code> 生产者协程安全</strong>：底层封装了锁机制和并发处理逻辑，支持多协程共享调用；</li>
<li><strong>「一个协程一个生产者」的设计</strong>：避免共享实例的竞争问题，即使客户端非协程安全，也能保证并发安全，同时提升发送效率；</li>
<li><strong>panic 捕获与优雅关闭</strong>：防止单个协程异常扩散，保证服务稳定性，避免消息丢失。</li>
</ol>
<h3 data-id="heading-15">2. 最佳实践</h3>
<ol>
<li><strong>合理配置并发数</strong>：<code>ConcurrentProducerNum</code> 不宜过大，需结合服务器 CPU、内存和 Kafka 集群处理能力调整，一般建议与 CPU 核心数相当；</li>
<li><strong>启用批量发送</strong>：通过<code>sarama</code>的批量配置，减少网络请求次数，大幅提升吞吐量；</li>
<li><strong>添加重试机制</strong>：针对网络抖动、Kafka 集群临时不可用等场景，重试机制能提升消息投递的可靠性；</li>
<li><strong>使用通道缓冲区</strong>：任务通道的缓冲区能有效削峰填谷，避免高并发场景下的协程阻塞；</li>
<li><strong>优雅关闭不可少</strong>：服务停止时，先关闭任务通道，再等待生产者协程处理完剩余消息，最后关闭生产者实例，防止消息丢失。</li>
</ol>
<h2 data-id="heading-16">五、扩展场景</h2>
<ol>
<li>若追求更高的吞吐量，可使用 <code>sarama.AsyncProducer</code>（异步生产者），进一步提升并发性能；</li>
<li>可接入 Prometheus 监控，统计消息发送成功率、延迟、积压量等指标，便于问题排查；</li>
<li>可添加消息持久化机制，对于发送失败的消息，落地到本地文件或数据库，后续进行重试补偿，实现消息零丢失。</li>
</ol>
<h2 data-id="heading-17">总结</h2>
<p>本文基于开源的<code>sarama</code>库，实现了高并发 Kafka 消息发送的方案，既保证了发送速度，又解决了并发安全的核心问题。「多生产者 + 多协程」的模型，充分发挥了 Go 语言协程的优势，能够满足大多数高吞吐业务场景的需求。同时，文中的最佳实践和扩展方案，也为生产环境的落地提供了参考，帮助开发者避开常见的坑，构建稳定、高效的 Kafka 消息发送服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📁 Java IO流完全指南：从字节流到高级操作]]></title>    <link>https://juejin.cn/post/7595868336594731027</link>    <guid>https://juejin.cn/post/7595868336594731027</guid>    <pubDate>2026-01-17T03:44:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336594731027" data-draft-id="7595800318519263238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📁 Java IO流完全指南：从字节流到高级操作"/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2026-01-17T03:44:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="总会落叶"/> <meta itemprop="url" content="https://juejin.cn/user/766787307710060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📁 Java IO流完全指南：从字节流到高级操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/766787307710060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    总会落叶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T03:44:19.000Z" title="Sat Jan 17 2026 03:44:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📁 Java IO流完全指南：从字节流到高级操作</h2>
<h3 data-id="heading-1">🎯 前言</h3>
<p>Java I/O流是处理输入输出的核心API，用于读写文件、网络通信等。掌握IO流是Java程序员的必备技能！让我们一起来系统学习吧~ 😊</p>
<h3 data-id="heading-2">📊 IO流体系总览</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Java IO流
├── 按数据类型分
│   ├── 字节流（<span class="hljs-built_in">Byte</span> Streams）
│   │   ├── InputStream（抽象类）
│   │   └── OutputStream（抽象类）
│   └── 字符流（Character Streams）
│       ├── Reader（抽象类）
│       └── Writer（抽象类）
├── 按功能分
│   ├── 节点流（直接操作数据源）
│   └── 处理流（包装节点流，增强功能）
└── 特殊流
    ├── 对象流（序列化）
    ├── 打印流
    ├── 转换流
    └── 压缩流
</code></pre>
<h3 data-id="heading-3">🔢 字节流（Byte Streams）</h3>
<h4 data-id="heading-4"><strong>FileOutputStream</strong> - 字节输出流 💾</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileOutputStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 方法1：直接使用文件路径</span>
        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 方法2：使用File对象（更灵活）</span>
        <span class="hljs-comment">// FileOutputStream fos2 = new FileOutputStream(new File("test.txt"));</span>
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建对象（会清空原文件内容）</span>
            fos1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"test.txt"</span>);
            
            <span class="hljs-comment">// 2. 写入数据</span>
            fos1.write(<span class="hljs-number">97</span>);           <span class="hljs-comment">// 写入字节 'a'</span>
            fos1.write(<span class="hljs-string">"\r\n"</span>.getBytes());  <span class="hljs-comment">// 换行</span>
            fos1.write(<span class="hljs-string">"Hello Java!"</span>.getBytes());
            
            <span class="hljs-comment">// 3. 续写模式（不会清空原内容）</span>
            <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-literal">true</span>);
            fos2.write(<span class="hljs-string">"\n追加内容"</span>.getBytes());
            fos2.close();
            
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 释放资源（必须执行）</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (fos1 != <span class="hljs-literal">null</span>) {
                    fos1.close();
                }
            } <span class="hljs-keyword">catch</span> (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-5">💡 注意事项：</h5>
<ul>
<li>换行符：Windows用 <code>\r\n</code>，Linux/Mac用 <code>\n</code></li>
<li>路径不存在会自动创建，但父目录必须存在</li>
<li>使用 try-with-resources 更安全（Java 7+）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐：使用try-with-resources自动关闭流</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
    fos.write(<span class="hljs-string">"自动关闭流，安全！"</span>.getBytes());
} <span class="hljs-keyword">catch</span> (IOException e) {
    e.printStackTrace();
}
</code></pre>
<h4 data-id="heading-6"><strong>FileInputStream</strong> - 字节输入流 📖</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInputStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 单个字节读取（效率低）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">int</span> b;
            <span class="hljs-keyword">while</span> ((b = fis.read()) != -<span class="hljs-number">1</span>) {
                System.out.print((<span class="hljs-type">char</span>) b);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 字节数组读取（高效推荐）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <span class="hljs-comment">// 1KB缓冲区</span>
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = fis.read(buffer)) != -<span class="hljs-number">1</span>) {
                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer, <span class="hljs-number">0</span>, len));
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 读取指定长度</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">5</span>];
            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> fis.read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);  <span class="hljs-comment">// 最多读5个字节</span>
            System.out.println(<span class="hljs-string">"读取了 "</span> + len + <span class="hljs-string">" 字节"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-7">🔤 字符流（Character Streams）</h3>
<h4 data-id="heading-8"><strong>FileReader</strong> - 字符输入流 📚</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileReader;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileReaderDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 单个字符读取</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">int</span> ch;
            <span class="hljs-keyword">while</span> ((ch = fr.read()) != -<span class="hljs-number">1</span>) {
                System.out.print((<span class="hljs-type">char</span>) ch);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 字符数组读取（推荐）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">char</span>[] chars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">1024</span>];
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = fr.read(chars)) != -<span class="hljs-number">1</span>) {
                System.out.print(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(chars, <span class="hljs-number">0</span>, len));
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 读取到指定数组位置</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileReader</span> <span class="hljs-variable">fr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>)) {
            <span class="hljs-type">char</span>[] chars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">10</span>];
            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> fr.read(chars, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>);  <span class="hljs-comment">// 从数组索引2开始存，最多读5个</span>
            System.out.println(<span class="hljs-string">"实际读取字符数："</span> + len);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 data-id="heading-9"><strong>FileWriter</strong> - 字符输出流 📝</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileWriter;
<span class="hljs-keyword">import</span> java.io.IOException;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileWriterDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 基本写入</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>)) {
            fw.write(<span class="hljs-string">"Hello World!\n"</span>);
            fw.write(<span class="hljs-number">65</span>);  <span class="hljs-comment">// 写入字符 'A'</span>
            fw.write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[]{<span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>});
            fw.write(<span class="hljs-string">"Java编程"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);  <span class="hljs-comment">// 写入"Java"</span>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 追加模式</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>, <span class="hljs-literal">true</span>)) {
            fw.write(<span class="hljs-string">"\n这是追加的内容"</span>);
            fw.flush();  <span class="hljs-comment">// 刷新缓冲区，立即写入</span>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 写入字符数组的一部分</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>)) {
            <span class="hljs-type">char</span>[] data = {<span class="hljs-string">'J'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'v'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'编'</span>, <span class="hljs-string">'程'</span>};
            fw.write(data, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);  <span class="hljs-comment">// 只写入"Java"</span>
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-10">🔄 编码与解码详解</h3>
<h4 data-id="heading-11"><strong>编码过程</strong> 🔡→🔢</h4>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.Arrays;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EncodingDemo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws Exception</span> {
        String str = <span class="hljs-string">"ai你哟❤"</span>;
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 不同编码方式比较 ==="</span>);
        
        <span class="hljs-comment">// 1. 平台默认编码（通常是UTF-8）</span>
        <span class="hljs-built_in">byte</span>[] defaultBytes = str.getBytes();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认编码（"</span> + System.getProperty(<span class="hljs-string">"file.encoding"</span>) + <span class="hljs-string">"）："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(defaultBytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"字节数："</span> + defaultBytes.length);
        
        <span class="hljs-comment">// 2. UTF-8编码（变长，中文3-4字节）</span>
        <span class="hljs-built_in">byte</span>[] utf8Bytes = str.getBytes(<span class="hljs-string">"UTF-8"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\nUTF-8编码："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(utf8Bytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"字节数："</span> + utf8Bytes.length);
        
        <span class="hljs-comment">// 3. GBK编码（中文2字节）</span>
        <span class="hljs-built_in">byte</span>[] gbkBytes = str.getBytes(<span class="hljs-string">"GBK"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\nGBK编码："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(gbkBytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"字节数："</span> + gbkBytes.length);
        
        <span class="hljs-comment">// 4. ISO-8859-1（不支持中文，会丢失信息）</span>
        <span class="hljs-built_in">byte</span>[] isoBytes = str.getBytes(<span class="hljs-string">"ISO-8859-1"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\nISO-8859-1编码（不支持中文）："</span>);
        System.<span class="hljs-keyword">out</span>.println(Arrays.toString(isoBytes));
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"解码后："</span> + <span class="hljs-keyword">new</span> String(isoBytes, <span class="hljs-string">"ISO-8859-1"</span>));
    }
}
</code></pre>
<h4 data-id="heading-12"><strong>解码过程</strong> 🔢→🔡</h4>
<pre><code class="hljs language-ini" lang="ini">public class DecodingDemo {
    public static void main(String<span class="hljs-section">[]</span> args) throws Exception {
        String <span class="hljs-attr">original</span> = <span class="hljs-string">"你好Java🎉"</span><span class="hljs-comment">;</span>
        
        // 1. 正确解码（编码解码一致）
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">utf8Bytes</span> = original.getBytes(<span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        String <span class="hljs-attr">correct</span> = new String(utf8Bytes, <span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        System.out.println("正确解码：" + correct)<span class="hljs-comment">;</span>
        
        // 2. 错误解码（编码解码不一致）
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">gbkBytes</span> = original.getBytes(<span class="hljs-string">"GBK"</span>)<span class="hljs-comment">;</span>
        String <span class="hljs-attr">wrong1</span> = new String(gbkBytes, <span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        System.out.println("错误解码（GBK→UTF-8）：" + wrong1)<span class="hljs-comment">;</span>
        
        // 3. 恢复乱码
        byte<span class="hljs-section">[]</span> <span class="hljs-attr">wrongBytes</span> = wrong1.getBytes(<span class="hljs-string">"UTF-8"</span>)<span class="hljs-comment">;</span>
        String <span class="hljs-attr">recovered</span> = new String(wrongBytes, <span class="hljs-string">"GBK"</span>)<span class="hljs-comment">;</span>
        System.out.println("恢复后：" + recovered)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-13">⚡ 缓冲流（高效流）</h3>
<h4 data-id="heading-14"><strong>字节缓冲流</strong> 🚀</h4>
<pre><code class="hljs language-ini" lang="ini">import java.io.*<span class="hljs-comment">;</span>

public class BufferedStreamDemo {
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">srcFile</span> = <span class="hljs-string">"largefile.mp4"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">destFile</span> = <span class="hljs-string">"copy.mp4"</span><span class="hljs-comment">;</span>
        
        // 1. 基本拷贝（单个字节，慢！）
        long <span class="hljs-attr">start1</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        try (FileInputStream <span class="hljs-attr">fis</span> = new FileInputStream(srcFile)<span class="hljs-comment">;</span>
             FileOutputStream <span class="hljs-attr">fos</span> = new FileOutputStream(<span class="hljs-string">"copy1.mp4"</span>)) {
            int b<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">b</span> = fis.read()) != -<span class="hljs-number">1</span>) {
                fos.write(b)<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        long <span class="hljs-attr">end1</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        System.out.println("基本拷贝耗时：" + (end1 - start1) + "ms")<span class="hljs-comment">;</span>
        
        // 2. 缓冲流拷贝（高效）
        long <span class="hljs-attr">start2</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        try (BufferedInputStream <span class="hljs-attr">bis</span> = new BufferedInputStream(
                new FileInputStream(srcFile))<span class="hljs-comment">;</span>
             BufferedOutputStream <span class="hljs-attr">bos</span> = new BufferedOutputStream(
                new FileOutputStream("copy2.mp4"))) {
            int b<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">b</span> = bis.read()) != -<span class="hljs-number">1</span>) {
                bos.write(b)<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        long <span class="hljs-attr">end2</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        System.out.println("缓冲流拷贝耗时：" + (end2 - start2) + "ms")<span class="hljs-comment">;</span>
        
        // 3. 缓冲流+数组（最快）
        long <span class="hljs-attr">start3</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        try (BufferedInputStream <span class="hljs-attr">bis</span> = new BufferedInputStream(
                new FileInputStream(srcFile))<span class="hljs-comment">;</span>
             BufferedOutputStream <span class="hljs-attr">bos</span> = new BufferedOutputStream(
                new FileOutputStream("copy3.mp4"))) {
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">8192</span>]<span class="hljs-comment">;  // 8KB缓冲区</span>
            int len<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">len</span> = bis.read(buffer)) != -<span class="hljs-number">1</span>) {
                bos.write(buffer, 0, len)<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        long <span class="hljs-attr">end3</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        System.out.println("缓冲流+数组拷贝耗时：" + (end3 - start3) + "ms")<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-15"><strong>字符缓冲流</strong> 📚</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BufferedReaderWriterDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. BufferedReader - 按行读取</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(<span class="hljs-string">"test.txt"</span>))) {
            String line;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) {
                System.out.println(lineNumber++ + <span class="hljs-string">": "</span> + line);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. BufferedWriter - 高效写入</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">bw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"output.txt"</span>))) {
            bw.write(<span class="hljs-string">"第一行"</span>);
            bw.newLine();  <span class="hljs-comment">// 跨平台换行</span>
            bw.write(<span class="hljs-string">"第二行"</span>);
            bw.flush();  <span class="hljs-comment">// 立即写入</span>
            
            <span class="hljs-comment">// 批量写入</span>
            String[] lines = {<span class="hljs-string">"第三行"</span>, <span class="hljs-string">"第四行"</span>, <span class="hljs-string">"第五行"</span>};
            <span class="hljs-keyword">for</span> (String l : lines) {
                bw.write(l);
                bw.newLine();
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 标准输入读取</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">consoleReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(System.in))) {
            System.out.print(<span class="hljs-string">"请输入："</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> consoleReader.readLine();
            System.out.println(<span class="hljs-string">"您输入的是："</span> + input);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-16">🔀 转换流（InputStreamReader/OutputStreamWriter）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConvertStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 读取GBK编码文件，转换为UTF-8</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"gbkfile.txt"</span>), <span class="hljs-string">"GBK"</span>);
             <span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"utf8file.txt"</span>), <span class="hljs-string">"UTF-8"</span>)) {
            
            <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">1024</span>];
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = isr.read(buffer)) != -<span class="hljs-number">1</span>) {
                osw.write(buffer, <span class="hljs-number">0</span>, len);
            }
        }
        
        <span class="hljs-comment">// 2. 控制台指定编码读取</span>
        System.out.println(<span class="hljs-string">"请输入中文："</span>);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(System.in, <span class="hljs-string">"GBK"</span>))) {
            <span class="hljs-type">String</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> br.readLine();
            System.out.println(<span class="hljs-string">"您输入的是："</span> + input);
            
            <span class="hljs-comment">// 以UTF-8保存</span>
            <span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"input.txt"</span>), <span class="hljs-string">"UTF-8"</span>)) {
                osw.write(input);
            }
        }
        
        <span class="hljs-comment">// 3. 文件编码检测和转换</span>
        convertFileEncoding(<span class="hljs-string">"source.txt"</span>, <span class="hljs-string">"GBK"</span>, <span class="hljs-string">"target.txt"</span>, <span class="hljs-string">"UTF-8"</span>);
    }
    
    <span class="hljs-comment">// 通用编码转换方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertFileEncoding</span><span class="hljs-params">(String srcFile, String srcCharset,
                                          String destFile, String destCharset)</span> 
                                          <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(srcFile), srcCharset);
             <span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(destFile), destCharset)) {
            
            <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">4096</span>];
            <span class="hljs-type">int</span> len;
            <span class="hljs-keyword">while</span> ((len = isr.read(buffer)) != -<span class="hljs-number">1</span>) {
                osw.write(buffer, <span class="hljs-number">0</span>, len);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-17">💾 序列化流（ObjectInputStream/ObjectOutputStream）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-comment">// 必须实现Serializable接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-comment">// 序列化版本ID，防止类修改后反序列化失败</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String password;  <span class="hljs-comment">// transient修饰的字段不序列化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> Date birthday;
    
    <span class="hljs-comment">// 构造方法、getter/setter省略...</span>
    
    <span class="hljs-comment">// 自定义序列化过程（可选）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(ObjectOutputStream oos)</span> <span class="hljs-keyword">throws</span> IOException {
        oos.defaultWriteObject();  <span class="hljs-comment">// 默认序列化</span>
        <span class="hljs-comment">// 自定义序列化逻辑</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> 
            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException {
        ois.defaultReadObject();  <span class="hljs-comment">// 默认反序列化</span>
        <span class="hljs-comment">// 自定义反序列化逻辑</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">25</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        
        <span class="hljs-comment">// 1. 序列化（对象→字节）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"user.dat"</span>))) {
            oos.writeObject(user);
            oos.writeInt(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 可以写入基本类型</span>
            oos.writeObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 2. 反序列化（字节→对象）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"user.dat"</span>))) {
            <span class="hljs-type">User</span> <span class="hljs-variable">readUser</span> <span class="hljs-operator">=</span> (User) ois.readObject();
            <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> ois.readInt();
            <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> (Date) ois.readObject();
            
            System.out.println(<span class="hljs-string">"用户名："</span> + readUser.getName());
            System.out.println(<span class="hljs-string">"密码："</span> + readUser.getPassword());  <span class="hljs-comment">// null</span>
        } <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) {
            e.printStackTrace();
        }
        
        <span class="hljs-comment">// 3. 序列化集合</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"list.dat"</span>))) {
            java.util.List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.ArrayList&lt;&gt;();
            users.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-string">"111"</span>, <span class="hljs-number">30</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
            users.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-string">"222"</span>, <span class="hljs-number">28</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()));
            oos.writeObject(users);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-18">🖨️ 打印流（PrintStream/PrintWriter）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrintStreamDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. PrintStream（字节打印流）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintStream</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintStream</span>(<span class="hljs-string">"print.txt"</span>)) {
            ps.println(<span class="hljs-string">"Hello PrintStream!"</span>);
            ps.printf(<span class="hljs-string">"当前时间：%tF %tT%n"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
            ps.print(<span class="hljs-string">"不换行"</span>);
            ps.println(<span class="hljs-string">"接着写"</span>);
            
            <span class="hljs-comment">// 不会抛出异常，用checkError()检查</span>
            ps.write(<span class="hljs-number">65</span>);  <span class="hljs-comment">// 'A'</span>
            <span class="hljs-keyword">if</span> (ps.checkError()) {
                System.err.println(<span class="hljs-string">"写入出错！"</span>);
            }
        }
        
        <span class="hljs-comment">// 2. PrintWriter（字符打印流，更常用）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">pw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">"print2.txt"</span>), <span class="hljs-literal">true</span>)) {  <span class="hljs-comment">// true表示自动刷新</span>
            
            pw.println(<span class="hljs-string">"=== 学生信息 ==="</span>);
            pw.printf(<span class="hljs-string">"姓名：%-10s 年龄：%d%n"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-number">20</span>);
            pw.printf(<span class="hljs-string">"分数：%.2f%n"</span>, <span class="hljs-number">95.5</span>);
            pw.println(<span class="hljs-string">"=============="</span>);
            
            <span class="hljs-comment">// 支持链式调用</span>
            pw.append(<span class="hljs-string">"追加内容"</span>)
              .append(<span class="hljs-string">"\n"</span>)
              .append(<span class="hljs-string">"另一行"</span>);
        }
        
        <span class="hljs-comment">// 3. 重定向System.out</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintStream</span> <span class="hljs-variable">fileOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintStream</span>(<span class="hljs-string">"system_out.txt"</span>)) {
            <span class="hljs-type">PrintStream</span> <span class="hljs-variable">originalOut</span> <span class="hljs-operator">=</span> System.out;
            System.setOut(fileOut);  <span class="hljs-comment">// 重定向</span>
            
            System.out.println(<span class="hljs-string">"这行会写到文件里"</span>);
            System.out.println(<span class="hljs-string">"控制台看不到我"</span>);
            
            System.setOut(originalOut);  <span class="hljs-comment">// 恢复</span>
            System.out.println(<span class="hljs-string">"回到控制台"</span>);
        }
        
        <span class="hljs-comment">// 4. 格式化输出</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">pw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-string">"format.txt"</span>)) {
            pw.printf(<span class="hljs-string">"商品\t单价\t数量\t小计%n"</span>);
            pw.printf(<span class="hljs-string">"%-10s\t%8.2f\t%4d\t%8.2f%n"</span>, 
                     <span class="hljs-string">"Java书"</span>, <span class="hljs-number">89.50</span>, <span class="hljs-number">2</span>, <span class="hljs-number">179.00</span>);
            pw.printf(<span class="hljs-string">"%-10s\t%8.2f\t%4d\t%8.2f%n"</span>,
                     <span class="hljs-string">"鼠标"</span>, <span class="hljs-number">150.00</span>, <span class="hljs-number">1</span>, <span class="hljs-number">150.00</span>);
            pw.printf(<span class="hljs-string">"%-10s\t%8s\t%4s\t%8.2f%n"</span>,
                     <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"合计"</span>, <span class="hljs-number">329.00</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-19">📦 压缩与解压缩流</h3>
<pre><code class="hljs language-ini" lang="ini">import java.io.*<span class="hljs-comment">;</span>
import java.util.zip.*<span class="hljs-comment">;</span>
import java.util.Enumeration<span class="hljs-comment">;</span>

public class ZipDemo {
    public static void main(String<span class="hljs-section">[]</span> args) {
        // 1. 单个文件压缩
        try (FileInputStream <span class="hljs-attr">fis</span> = new FileInputStream(<span class="hljs-string">"test.txt"</span>)<span class="hljs-comment">;</span>
             FileOutputStream <span class="hljs-attr">fos</span> = new FileOutputStream(<span class="hljs-string">"test.zip"</span>)<span class="hljs-comment">;</span>
             ZipOutputStream <span class="hljs-attr">zos</span> = new ZipOutputStream(fos)) {
            
            ZipEntry <span class="hljs-attr">entry</span> = new ZipEntry(<span class="hljs-string">"test.txt"</span>)<span class="hljs-comment">;</span>
            zos.putNextEntry(entry)<span class="hljs-comment">;</span>
            
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">1024</span>]<span class="hljs-comment">;</span>
            int len<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">len</span> = fis.read(buffer)) != -<span class="hljs-number">1</span>) {
                zos.write(buffer, 0, len)<span class="hljs-comment">;</span>
            }
            zos.closeEntry()<span class="hljs-comment">;</span>
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        
        // 2. 多个文件压缩
        String<span class="hljs-section">[]</span> <span class="hljs-attr">files</span> = {<span class="hljs-string">"file1.txt"</span>, <span class="hljs-string">"file2.txt"</span>, <span class="hljs-string">"file3.txt"</span>}<span class="hljs-comment">;</span>
        try (ZipOutputStream <span class="hljs-attr">zos</span> = new ZipOutputStream(
                new FileOutputStream("multi.zip"))) {
            
            for (String file : files) {
                try (FileInputStream <span class="hljs-attr">fis</span> = new FileInputStream(file)) {
                    ZipEntry <span class="hljs-attr">entry</span> = new ZipEntry(file)<span class="hljs-comment">;</span>
                    zos.putNextEntry(entry)<span class="hljs-comment">;</span>
                    
                    byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">1024</span>]<span class="hljs-comment">;</span>
                    int len<span class="hljs-comment">;</span>
                    while ((<span class="hljs-attr">len</span> = fis.read(buffer)) != -<span class="hljs-number">1</span>) {
                        zos.write(buffer, 0, len)<span class="hljs-comment">;</span>
                    }
                    zos.closeEntry()<span class="hljs-comment">;</span>
                }
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        
        // 3. 解压缩
        try (ZipInputStream <span class="hljs-attr">zis</span> = new ZipInputStream(
                new FileInputStream("multi.zip"))) {
            
            ZipEntry entry<span class="hljs-comment">;</span>
            while ((<span class="hljs-attr">entry</span> = zis.getNextEntry()) != null) {
                System.out.println("解压: " + entry.getName())<span class="hljs-comment">;</span>
                
                // 创建目录结构
                File <span class="hljs-attr">file</span> = new File(<span class="hljs-string">"extracted/"</span> + entry.getName())<span class="hljs-comment">;</span>
                if (entry.isDirectory()) {
                    file.mkdirs()<span class="hljs-comment">;</span>
                } else {
                    file.getParentFile().mkdirs()<span class="hljs-comment">;</span>
                    
                    try (FileOutputStream <span class="hljs-attr">fos</span> = new FileOutputStream(file)) {
                        byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">1024</span>]<span class="hljs-comment">;</span>
                        int len<span class="hljs-comment">;</span>
                        while ((<span class="hljs-attr">len</span> = zis.read(buffer)) != -<span class="hljs-number">1</span>) {
                            fos.write(buffer, 0, len)<span class="hljs-comment">;</span>
                        }
                    }
                }
                zis.closeEntry()<span class="hljs-comment">;</span>
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
        
        // 4. 使用ZipFile类（更方便）
        try (ZipFile <span class="hljs-attr">zipFile</span> = new ZipFile(<span class="hljs-string">"multi.zip"</span>)) {
            Enumeration&lt;? extends ZipEntry&gt; <span class="hljs-attr">entries</span> = zipFile.entries()<span class="hljs-comment">;</span>
            
            while (entries.hasMoreElements()) {
                ZipEntry <span class="hljs-attr">entry</span> = entries.nextElement()<span class="hljs-comment">;</span>
                System.out.println("文件: " + entry.getName() + 
                                 " 大小: " + entry.getSize())<span class="hljs-comment">;</span>
                
                if (!entry.isDirectory()) {
                    try (InputStream <span class="hljs-attr">is</span> = zipFile.getInputStream(entry)) {
                        // 处理文件内容
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-20">🔧 Apache Commons IO 工具库</h3>
<h4 data-id="heading-21"><strong>添加依赖</strong> 📦</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.13.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22"><strong>常用工具类</strong> 🛠️</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.commons.io.FileUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.FilenameUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.FileExistsUtils;
​
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.List;
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsIODemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. FileUtils - 文件操作神器</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">src</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"source.txt"</span>);
        <span class="hljs-type">File</span> <span class="hljs-variable">dest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"backup.txt"</span>);
        
        <span class="hljs-comment">// 复制文件</span>
        FileUtils.copyFile(src, dest);
        FileUtils.copyFile(src, dest, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// 强制覆盖</span>
        
        <span class="hljs-comment">// 复制目录</span>
        FileUtils.copyDirectory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"srcDir"</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"destDir"</span>));
        
        <span class="hljs-comment">// 读取文件内容</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> FileUtils.readFileToString(src, <span class="hljs-string">"UTF-8"</span>);
        List&lt;String&gt; lines = FileUtils.readLines(src, <span class="hljs-string">"UTF-8"</span>);
        
        <span class="hljs-comment">// 写入文件</span>
        FileUtils.writeStringToFile(dest, <span class="hljs-string">"Hello Commons IO"</span>, <span class="hljs-string">"UTF-8"</span>);
        FileUtils.writeLines(dest, <span class="hljs-string">"UTF-8"</span>, lines, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// true表示追加</span>
        
        <span class="hljs-comment">// 删除目录（包括子目录）</span>
        FileUtils.deleteDirectory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"tempDir"</span>));
        FileUtils.forceDelete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"file.txt"</span>));  <span class="hljs-comment">// 强制删除</span>
        
        <span class="hljs-comment">// 清空目录</span>
        FileUtils.cleanDirectory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"cache"</span>));
        
        <span class="hljs-comment">// 2. IOUtils - 流操作简化</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"input.txt"</span>);
             <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"output.txt"</span>)) {
            
            <span class="hljs-comment">// 复制流（自动处理缓冲和关闭）</span>
            IOUtils.copy(is, os);
            
            <span class="hljs-comment">// 读取全部字节</span>
            <span class="hljs-type">byte</span>[] bytes = IOUtils.toByteArray(is);
            
            <span class="hljs-comment">// 读取为字符串</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> IOUtils.toString(is, <span class="hljs-string">"UTF-8"</span>);
            
            <span class="hljs-comment">// 写入字符串到流</span>
            IOUtils.write(<span class="hljs-string">"Hello"</span>, os, <span class="hljs-string">"UTF-8"</span>);
            
            <span class="hljs-comment">// 关闭多个流</span>
            IOUtils.closeQuietly(is, os);  <span class="hljs-comment">// 静默关闭，不抛异常</span>
            
            <span class="hljs-comment">// 3. 资源复制（自动关闭）</span>
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"a.txt"</span>);
                 <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"b.txt"</span>)) {
                IOUtils.copy(in, out);
            }
        }
        
        <span class="hljs-comment">// 3. FilenameUtils - 文件名处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">"C:/test/file.txt"</span>;
        
        System.out.println(<span class="hljs-string">"扩展名: "</span> + FilenameUtils.getExtension(filename));
        System.out.println(<span class="hljs-string">"文件名（无扩展名）: "</span> + FilenameUtils.getBaseName(filename));
        System.out.println(<span class="hljs-string">"完整文件名: "</span> + FilenameUtils.getName(filename));
        System.out.println(<span class="hljs-string">"路径: "</span> + FilenameUtils.getFullPath(filename));
        System.out.println(<span class="hljs-string">"规范路径: "</span> + FilenameUtils.normalize(filename));
        
        <span class="hljs-comment">// 路径比较</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">same</span> <span class="hljs-operator">=</span> FilenameUtils.equals(
            <span class="hljs-string">"C:/test/../test/file.txt"</span>, 
            <span class="hljs-string">"C:/test/file.txt"</span>);  <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 4. FileSystemUtils - 文件系统工具</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">freeSpace</span> <span class="hljs-operator">=</span> FileSystemUtils.freeSpaceKb(<span class="hljs-string">"C:"</span>);
        System.out.println(<span class="hljs-string">"C盘剩余空间: "</span> + freeSpace + <span class="hljs-string">"KB"</span>);
        
        <span class="hljs-comment">// 5. 监控文件变化</span>
        <span class="hljs-comment">// FileAlterationMonitor monitor = new FileAlterationMonitor(1000);</span>
        <span class="hljs-comment">// FileAlterationObserver observer = new FileAlterationObserver("watchDir");</span>
        <span class="hljs-comment">// observer.addListener(new FileAlterationListenerAdaptor() {</span>
        <span class="hljs-comment">//     public void onFileCreate(File file) {</span>
        <span class="hljs-comment">//         System.out.println("创建: " + file.getName());</span>
        <span class="hljs-comment">//     }</span>
        <span class="hljs-comment">// });</span>
        <span class="hljs-comment">// monitor.addObserver(observer);</span>
        <span class="hljs-comment">// monitor.start();</span>
    }
}
</code></pre>
<h3 data-id="heading-23">🎯 最佳实践总结</h3>
<h4 data-id="heading-24"><strong>1. 选择正确的流类型</strong></h4>






























<table><thead><tr><th>场景</th><th>推荐流</th><th>说明</th></tr></thead><tbody><tr><td>文本文件</td><td>FileReader/FileWriter</td><td>字符流处理文本更合适</td></tr><tr><td>二进制文件</td><td>FileInputStream/FileOutputStream</td><td>图片、视频等用字节流</td></tr><tr><td>需要高效</td><td>BufferedXXX</td><td>总是使用缓冲流提升性能</td></tr><tr><td>网络传输</td><td>字节流</td><td>网络传输都是字节</td></tr></tbody></table>
<h4 data-id="heading-25"><strong>2. 资源管理规范</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：忘记关闭流</span>
<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>);
<span class="hljs-comment">// 处理数据...</span>
<span class="hljs-comment">// fis.close();  // 忘记调用</span>
​
<span class="hljs-comment">// ✅ 正确1：try-with-resources（Java 7+）</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>);
     <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"output.txt"</span>)) {
    <span class="hljs-comment">// 自动关闭</span>
}
​
<span class="hljs-comment">// ✅ 正确2：传统try-catch-finally</span>
<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-keyword">try</span> {
    fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>);
    <span class="hljs-comment">// 处理数据</span>
} <span class="hljs-keyword">catch</span> (IOException e) {
    e.printStackTrace();
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (fis != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            fis.close();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 data-id="heading-26"><strong>3. 性能优化建议</strong></h4>
<pre><code class="hljs language-ini" lang="ini">// 缓冲区大小选择（经验值）
byte<span class="hljs-section">[]</span> <span class="hljs-attr">buffer</span> = new byte[<span class="hljs-number">8192</span>]<span class="hljs-comment">;  // 8KB - 适合大多数场景</span>
// 或
char<span class="hljs-section">[]</span> <span class="hljs-attr">charBuffer</span> = new char[<span class="hljs-number">8192</span>]<span class="hljs-comment">;</span>
​
// 批量操作优于单字节操作
while ((<span class="hljs-attr">len</span> = input.read(buffer)) != -<span class="hljs-number">1</span>) {
    output.write(buffer, 0, len)<span class="hljs-comment">;  // 批量写入</span>
}
​
// 使用NIO（大文件或高并发）
Path <span class="hljs-attr">source</span> = Paths.get(<span class="hljs-string">"largefile.iso"</span>)<span class="hljs-comment">;</span>
Path <span class="hljs-attr">target</span> = Paths.get(<span class="hljs-string">"copy.iso"</span>)<span class="hljs-comment">;</span>
Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-27"><strong>4. 编码处理黄金法则</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原则：编码解码必须一致</span>
<span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"你好世界"</span>;
​
<span class="hljs-comment">// 保存时指定编码</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">osw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"file.txt"</span>), StandardCharsets.UTF_8)) {
    osw.write(text);
}
​
<span class="hljs-comment">// 读取时使用相同编码</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">isr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>), StandardCharsets.UTF_8)) {
    <span class="hljs-comment">// 读取...</span>
}
​
<span class="hljs-comment">// 网页处理使用UTF-8</span>
response.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
request.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
</code></pre>
<h3 data-id="heading-28">🚀 快速参考卡</h3>






















































<table><thead><tr><th>操作</th><th>字节流</th><th>字符流</th><th>缓冲流</th><th>Commons IO</th></tr></thead><tbody><tr><td><strong>读取文件</strong></td><td><code>FileInputStream</code></td><td><code>FileReader</code></td><td><code>BufferedReader</code></td><td><code>FileUtils.readFileToString()</code></td></tr><tr><td><strong>写入文件</strong></td><td><code>FileOutputStream</code></td><td><code>FileWriter</code></td><td><code>BufferedWriter</code></td><td><code>FileUtils.writeStringToFile()</code></td></tr><tr><td><strong>复制文件</strong></td><td>手动循环</td><td>手动循环</td><td>缓冲+数组</td><td><code>FileUtils.copyFile()</code></td></tr><tr><td><strong>读取行</strong></td><td>N/A</td><td><code>readLine()</code></td><td><code>BufferedReader.readLine()</code></td><td><code>FileUtils.readLines()</code></td></tr><tr><td><strong>处理编码</strong></td><td>字节数组+String</td><td><code>InputStreamReader</code></td><td>指定Charset</td><td>自动UTF-8</td></tr><tr><td><strong>关闭资源</strong></td><td>try-with-resources</td><td>try-with-resources</td><td>try-with-resources</td><td>自动管理</td></tr></tbody></table>
<h3 data-id="heading-29">📝 常见问题解答</h3>
<p><strong>Q: 字节流和字符流怎么选择？</strong> A: 文本用字符流（Reader/Writer），二进制数据用字节流（InputStream/OutputStream）</p>
<p><strong>Q: 为什么用缓冲流？</strong> A: 减少物理读写次数，提升性能几十到几百倍！</p>
<p><strong>Q: 如何处理大文件？</strong> A: 使用缓冲流+适当缓冲区，或考虑NIO的FileChannel</p>
<p><strong>Q: 中文乱码怎么解决？</strong> A: 确保编码一致，推荐统一使用UTF-8</p>
<p><strong>Q: 流为什么要关闭？</strong> A: 释放系统资源，避免内存泄漏和文件锁定</p>
<p>希望这篇全面的IO流指南能帮助你！编程愉快！ 🚀💻</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringAI快速上手教程]]></title>    <link>https://juejin.cn/post/7595858353660461090</link>    <guid>https://juejin.cn/post/7595858353660461090</guid>    <pubDate>2026-01-17T04:09:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858353660461090" data-draft-id="7592803747471917106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringAI快速上手教程"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-17T04:09:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="devlogix01"/> <meta itemprop="url" content="https://juejin.cn/user/2701937351075513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringAI快速上手教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2701937351075513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    devlogix01
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:09:26.000Z" title="Sat Jan 17 2026 04:09:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01-SpringAI的介绍</h2>
<p><strong>Spring AI</strong> 是由 VMware / Spring 团队推出的一个 <strong>面向 AI 的 Spring 官方项目</strong>，目标是让 Java / Spring 开发者 <strong>像用 Spring Data、Spring Security 一样，用统一、规范的方式接入大模型（LLM）和 AI 能力</strong>。</p>
<p>一句话理解：   <strong>Spring AI = 给大模型用的 Spring Framework</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2507e2c2e46c49b79270824041199b65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=RJR3F8qFwIUmcNM3adlsHCs%2FBtc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">02-创建项目远程调用deepseek大模型</h2>
<p>1 创建项目
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/965c31c9ed9e4a86ae39a3193d383331~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=rH14fobITTqfAWHXT2DNiyHBPXM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">Releases - Use Maven Central</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven Central is included by default in Maven builds.
     You usually don’t need to configure it explicitly,
     but it's shown here for clarity. --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">Snapshots - Add Snapshot Repositories</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Central Portal Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-portal-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<p>deepseek dependency</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-deepseek<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>ChatController.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;

<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.UserMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.model.ChatResponse;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.prompt.Prompt;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"generation"</span>, chatModel.call(message));
    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">var</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> chatModel.stream(prompt).map(ChatResponse -&gt; ChatResponse.getResult().getOutput().getText());
    }
}
</code></pre>
<p>测试接口</p>
<p><code>http://localhost:8080/ai/generateStream?message=讲个笑话</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6c48a8cd86749f691ebad3c1f8ec7ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=gqVLCi4%2FnL3FrmPh9per90nFLxk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">03-SpringAI调用本地大模型ollama</h2>
<p>1 引入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2 配置yml</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-comment"># In application.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">error:</span>
    <span class="hljs-attr">include-message:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">include-binding-errors:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">include-stacktrace:</span> <span class="hljs-string">on_param</span>
    <span class="hljs-attr">include-exception:</span> <span class="hljs-literal">false</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">deepseek:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">sk-7fee8ebd8c0744ac9c1d91d9f0d81372</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1-1.5b</span>
</code></pre>
<p>3 chatController.java 调用本地ollama的大模型</p>
<pre><code class="hljs language-typescript" lang="typescript">package org.<span class="hljs-property">example</span>.<span class="hljs-property">springaidemo</span>.<span class="hljs-property">controller</span>;

<span class="hljs-keyword">import</span> jakarta.<span class="hljs-property">annotation</span>.<span class="hljs-property">Resource</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">ai</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">messages</span>.<span class="hljs-property">UserMessage</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">ai</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">prompt</span>.<span class="hljs-property">Prompt</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">ai</span>.<span class="hljs-property">ollama</span>.<span class="hljs-property">OllamaChatModel</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">GetMapping</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RequestParam</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RestController</span>;
<span class="hljs-keyword">import</span> reactor.<span class="hljs-property">core</span>.<span class="hljs-property">publisher</span>.<span class="hljs-property">Flux</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OllamaChatModel</span> chatModel;


    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/ai/generate"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span>(value = <span class="hljs-string">"message"</span>, defaultValue = <span class="hljs-string">"Tell me a joke"</span>) <span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(<span class="hljs-string">"generation"</span>, chatModel.<span class="hljs-title function_">call</span>(message));
    }

    <span class="hljs-meta">@GetMapping</span>(value = <span class="hljs-string">"/ai/generateStream"</span>, produces = <span class="hljs-string">"text/html; charset=UTF-8"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Flux</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">generateStream</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span>(value = <span class="hljs-string">"message"</span>, defaultValue = <span class="hljs-string">"Tell me a joke"</span>) <span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-keyword">var</span> prompt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> chatModel.<span class="hljs-title function_">stream</span>(prompt).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">ChatResponse</span> -&gt; <span class="hljs-title class_">ChatResponse</span>.<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">getOutput</span>().<span class="hljs-title function_">getText</span>());
    }
}
</code></pre>
<h2 data-id="heading-5">04-SpringAI创建ChatClient示例实现AI人设</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;


<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }


    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).call().content();

    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).stream().content();
    }
}
</code></pre>
<p>测试
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fba5ef9c07643e092b3c0b3eac6e9b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=qpk%2B%2BBl4Y6EATRXcZBUV%2Bh4Fws0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">05-SpringAI实现记录上下文</h2>
<p><strong>1 创建数据库</strong></p>
<p>打开 navicat 进行创建</p>
<p>数据库的名称就叫</p>
<p>20260110-ai</p>
<p>字符集编码选择为 utf8mb4</p>
<p>创建成功</p>
<p>点击 查询的选项</p>
<p>然后把聊天记录表的 sql 语句给复制粘贴进来</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_history` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'序列号'</span>,
  `datetime` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'聊天时间'</span>,
  `content` longtext <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci COMMENT <span class="hljs-string">'聊天内容'</span>,
  `role` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'user'</span> COMMENT <span class="hljs-string">'角色'</span>,
  `sessionId` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'会话Id'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">227</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci ROW_FORMAT<span class="hljs-operator">=</span><span class="hljs-keyword">DYNAMIC</span> COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'聊天记录'</span>;
</code></pre>
<p><strong>2 导入依赖坐标</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--Mysql驱动        --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--  Mybatis——Plus 插件    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-jsqlparser<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--  Mybatis——Plus     --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>3 配置数据源</strong></p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">datasource:</span>
  <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/20260110-ai?allowPublicKeyRetrieval=true&amp;useUnicode=true&amp;useSSL=false&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
</code></pre>
<p><strong>4 配置其他文件夹</strong></p>
<p>config/AiConfig.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.entity.impl;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;

<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.mapper.HistoryMapper;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;



<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;HistoryMapper, History&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HistoryService</span> {

}
</code></pre>
<p>config/MybatisPlusConfig.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.config;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>

<span class="hljs-meta">@MapperScan("org.example.springaidemo.mapper")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<p>entity/History.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.entity;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableId;
<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.TableName;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;
<span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;
<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Builder;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;


<span class="hljs-comment">/**
 * 聊天记录实体类
 */</span>

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder(toBuilder = true)</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@TableName("sys_history")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">History</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;

    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Schema(title = "聊天时间")</span>
    <span class="hljs-meta">@TableField("datetime")</span>

    <span class="hljs-meta">@JsonFormat( pattern = "yyyy-MM-dd HH:mm:ss")</span>
    <span class="hljs-keyword">private</span> LocalDateTime datetime;
    <span class="hljs-meta">@Schema(title = "聊天内容")</span>
    <span class="hljs-meta">@TableField("content")</span>

    <span class="hljs-keyword">private</span> String content;
    <span class="hljs-meta">@Schema(title = "角色")</span>
    <span class="hljs-meta">@TableField("role")</span>

    <span class="hljs-keyword">private</span> String role;
    <span class="hljs-meta">@Schema(title = "会话Id")</span>
    <span class="hljs-meta">@TableField("sessionId")</span>

    <span class="hljs-keyword">private</span> Long sessionId;
}
</code></pre>
<p>service/HistoryService.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.service;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HistoryService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;History&gt; {

}
</code></pre>
<p>service/impl/HistoryServiceImpl.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.service.impl;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;

<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.mapper.HistoryMapper;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;



<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;HistoryMapper, History&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HistoryService</span> {

}
</code></pre>
<p>mapper/HistoryMapper.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.mapper;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;


<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HistoryMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;History&gt; {

}
</code></pre>
<p>更新chatController.java</p>
<p>使用MyBatis-Plus进行数据库操作</p>
<p>Spring AI框架的各种组件（ChatClient、消息类型等）</p>
<p>DeepSeek和Ollama两个AI模型（虽然导入了Ollama但未使用）</p>
<p>响应式编程库Reactor的Flux</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.UserMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {
    <span class="hljs-comment">//依赖注入</span>
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;

    <span class="hljs-comment">//构造函数注入</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-comment">/*
    * HTTP GET端点：/ai/generate
    接收用户消息参数，默认值为"Tell me a joke"
    返回AI助手"小黑"对用户消息的同步响应内容
    * */</span>
    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).call().content();

    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message,
                                       <span class="hljs-meta">@RequestParam(value = "sessionId", defaultValue = " 1 ")</span> <span class="hljs-type">long</span> sessionId
                                       )</span> {
        <span class="hljs-comment">//用户消息保存</span>
        <span class="hljs-type">History</span> <span class="hljs-variable">userhistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
        userhistory.setDatetime(LocalDateTime.now());
        userhistory.setRole(<span class="hljs-string">"user"</span>);
        userhistory.setContent(message);
        userhistory.setSessionId(sessionId);
        historyService.save(userhistory); <span class="hljs-comment">//创建并保存用户发送的消息到数据库</span>

        <span class="hljs-comment">//获取历史对话</span>
        <span class="hljs-comment">//查询指定会话ID的所有历史记录</span>
        <span class="hljs-comment">//排除刚刚保存的当前用户消息（避免重复）</span>
        List&lt;History&gt; histories = historyService.list(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;History&gt;().eq(History::getSessionId, sessionId).ne(History::getId , userhistory.getId())
        ) ;

        <span class="hljs-comment">//转换历史消息格式: 将历史记录转换为AI模型能理解的消息格式</span>
        List&lt;Message&gt; messages = histories.stream().map(history -&gt;
                <span class="hljs-string">"user"</span>.equals(history.getRole())?<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(history.getContent()):<span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(history.getContent())).collect(Collectors.toList());

        <span class="hljs-comment">//数组 用来累积AI流式回复内容</span>
        <span class="hljs-comment">//使用数组是为了在lambda表达式中能够修改变量</span>
        StringBuilder[] builder = {<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()};

        <span class="hljs-comment">//构建包含上下文的AI请求并返回流式响应</span>
        Flux&lt;String&gt; stream = chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).messages( messages).stream().content();
        <span class="hljs-keyword">return</span>  stream.doOnNext(s -&gt; builder[<span class="hljs-number">0</span>].append(s)) <span class="hljs-comment">//当AI返回每个片段时，将其追加到builder中进行累积</span>
                .doOnComplete(() -&gt; {
                    <span class="hljs-type">History</span> <span class="hljs-variable">aihistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
                    aihistory.setId(<span class="hljs-literal">null</span>);
                    aihistory.setDatetime(LocalDateTime.now());
                    aihistory.setRole(<span class="hljs-string">"assistant"</span>);
                    aihistory.setContent(builder[<span class="hljs-number">0</span>].toString());
                    aihistory.setSessionId(sessionId);
                    historyService.save(aihistory);
                });
        <span class="hljs-comment">/*
        当AI流式回复完成后，执行以下操作：
        创建新的历史记录对象
        设置时间戳
        设置角色为"assistant"
        将累积的完整回复内容保存
        设置会话ID
        保存到数据库
        这种方式确保了只有在AI完全生成回复后，才会将其保存到历史记录中，同时保持了流式响应的实时性*/</span>
    }
}
</code></pre>
<h2 data-id="heading-7">06-语义向量化、向量数据库、RAG的概念</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e243d5d55b42430fb96499a218aa2fbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=xIm672r%2F7cPLR6YDpRUqTuZhokk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">1 RAG 检索增强生成 Retrieval Augmented Generated</h4>
<p>文本读取 - 文本分割 - 转向量化 - 存向量数据库
用户问题 - 向量化 - 检索相关内容 - 构造prompt - 大模型生成答案</p>
<h2 data-id="heading-9">07-SpringAI实现语义向量化</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fembeddings.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/embeddings.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<p>导入的依赖</p>
<pre><code class="hljs language-java" lang="java">        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud.ai&lt;/groupId&gt;
            &lt;artifactId&gt;spring-ai-alibaba-starter-dashscope&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.alibaba.cloud.ai&lt;/groupId&gt;
                &lt;artifactId&gt;spring-ai-alibaba-bom&lt;/artifactId&gt;
                &lt;version&gt;<span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;<span class="hljs-keyword">import</span>&lt;/scope&gt;
            &lt;/dependency&gt;
    &lt;/dependencyManagement&gt;
</code></pre>
<p>配置示例</p>
<pre><code class="hljs language-yml" lang="yml">    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1:8b</span>
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">dashscope:</span>
      <span class="hljs-attr">api-key:</span> 
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">text-embedding-v4</span>
</code></pre>
<p>示例方法</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-meta">@GetMapping("/ai/embedding")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">embed</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.embedForResponse(List.of(message));
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"embedding"</span>, embeddingResponse);
    }
</code></pre>
<h2 data-id="heading-10">08-SpringAI实现文本分割</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fetl-pipeline.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<p>因为在日常工作的过程中, 文本都是以文档的形式进行存储的, 常见的文档格式有 txt 文件、markdown 文件、pdf 文件, 需要把这个文档给读出来, 读出来文档以后才能进行分割, SpringAI 给我们定义了文本读取的规范规范接口, 同时给我们提供了很多类型的文本阅读工具 , 例如 JSON 类型的、txt 类型的、MarkDown 类型的、PDF 类型等</p>
<p>PDF 的有两种读取方式</p>
<p>一种是按页读取</p>
<p>另外一种是按章节读取</p>
<p>他们都是按照 SpringAI 的接口进行实现，特别的规范</p>
<p>1 添加依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-pdf-document-reader<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2 测试方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testPdf</span><span class="hljs-params">()</span>{
    <span class="hljs-type">PagePdfDocumentReader</span> <span class="hljs-variable">pdfReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagePdfDocumentReader</span>(<span class="hljs-string">"classpath:/阿里巴巴Java开发手册(终极版).pdf"</span>,
            PdfDocumentReaderConfig.builder()
                    .withPageTopMargin(<span class="hljs-number">0</span>)
                    .withPageExtractedTextFormatter(ExtractedTextFormatter.builder()
                            .withNumberOfTopTextLinesToDelete(<span class="hljs-number">0</span>)
                            .build())
                    .withPagesPerDocument(<span class="hljs-number">1</span>)
                    .build());
    System.out.println( pdfReader.read().size());
}
</code></pre>
<p>3 按Token进行分割</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">testPdf</span><span class="hljs-params">()</span>{
    <span class="hljs-type">PagePdfDocumentReader</span> <span class="hljs-variable">pdfReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagePdfDocumentReader</span>(<span class="hljs-string">"classpath:/阿里巴巴Java开发手册(终极版).pdf"</span>,
            PdfDocumentReaderConfig.builder()
                    .withPageTopMargin(<span class="hljs-number">0</span>)
                    .withPageExtractedTextFormatter(ExtractedTextFormatter.builder()
                            .withNumberOfTopTextLinesToDelete(<span class="hljs-number">0</span>)
                            .build())
                    .withPagesPerDocument(<span class="hljs-number">1</span>)
                    .build());


    <span class="hljs-type">TokenTextSplitter</span> <span class="hljs-variable">splitter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenTextSplitter</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">400</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100000</span>, <span class="hljs-literal">true</span>);
    splitter.apply(pdfReader.read()).forEach(document -&gt; {
    System.out.printf(Arrays.toString(embeddingModel.embed(document)));
    });
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/011678f6ada64f0894d60f4e9ced7589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=gMU%2FUqM14enbAfdbdM7w6gAAmGU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">09-SpringAI实现向量数据库的存储</h2>
<p>1 docker 配置</p>
<p>维度选择 1024 保持一致
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ede2e0d01443c78ee84e308589fa7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGV2bG9naXgwMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769227766&amp;x-signature=KqCKGEWr3UfTMMlKBcpUzgyAlqc%3D" alt="image.png" loading="lazy"/></p>
<p>2 依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-vector-store-qdrant<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">vectorstore:</span>
      <span class="hljs-attr">qdrant:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">6334</span>
        <span class="hljs-attr">collection-name:</span> <span class="hljs-string">vector_store</span>
</code></pre>
<h2 data-id="heading-12">10-SpringAI实现检索增强</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.example.springaidemo.controller;


<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.example.springaidemo.entity.History;
<span class="hljs-keyword">import</span> org.example.springaidemo.service.HistoryService;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.UserMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.deepseek.DeepSeekChatModel;
<span class="hljs-keyword">import</span> org.springframework.ai.document.Document;
<span class="hljs-keyword">import</span> org.springframework.ai.embedding.EmbeddingModel;
<span class="hljs-keyword">import</span> org.springframework.ai.embedding.EmbeddingResponse;
<span class="hljs-keyword">import</span> org.springframework.ai.vectorstore.VectorStore;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {
    <span class="hljs-comment">//依赖注入</span>
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeepSeekChatModel chatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> EmbeddingModel embeddingModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> VectorStore vectorStore;


    <span class="hljs-comment">//构造函数注入</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(DeepSeekChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-comment">/*
    * HTTP GET端点：/ai/generate
    接收用户消息参数，默认值为"Tell me a joke"
    返回AI助手"小黑"对用户消息的同步响应内容
    * */</span>
    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span>  chatClient.prompt(<span class="hljs-string">"你是ai助手小黑"</span>).user( message).call().content();

    }

    <span class="hljs-meta">@GetMapping(value = "/ai/generateStream", produces = "text/html; charset=UTF-8")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message,
                                       <span class="hljs-meta">@RequestParam(value = "sessionId", defaultValue = " 1 ")</span> <span class="hljs-type">long</span> sessionId
                                       )</span> {

        List&lt;Document&gt; documentList = vectorStore.similaritySearch(message);
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">contextBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        documentList.forEach(document -&gt; contextBuilder.append(document).append(<span class="hljs-string">"\n"</span>));
        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span>  <span class="hljs-operator">=</span> <span class="hljs-string">"你是编程助手小红 , 以下是本次会话传递的信息"</span>+contextBuilder.toString()+
                <span class="hljs-string">"/n 请根据以上信息，回答用户的问题："</span>+message;
        <span class="hljs-comment">//用户消息保存</span>
        <span class="hljs-type">History</span> <span class="hljs-variable">userhistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
        userhistory.setDatetime(LocalDateTime.now());
        userhistory.setRole(<span class="hljs-string">"user"</span>);
        userhistory.setContent(message);
        userhistory.setSessionId(sessionId);
        historyService.save(userhistory); <span class="hljs-comment">//创建并保存用户发送的消息到数据库</span>

        <span class="hljs-comment">//获取历史对话</span>
        <span class="hljs-comment">//查询指定会话ID的所有历史记录</span>
        <span class="hljs-comment">//排除刚刚保存的当前用户消息（避免重复）</span>
        List&lt;History&gt; histories = historyService.list(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;History&gt;().eq(History::getSessionId, sessionId).ne(History::getId , userhistory.getId())
        ) ;

        <span class="hljs-comment">//转换历史消息格式: 将历史记录转换为AI模型能理解的消息格式</span>
        List&lt;Message&gt; messages = histories.stream().map(history -&gt;
                <span class="hljs-string">"user"</span>.equals(history.getRole())?<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(history.getContent()):<span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(history.getContent())).collect(Collectors.toList());

        <span class="hljs-comment">//数组 用来累积AI流式回复内容</span>
        <span class="hljs-comment">//使用数组是为了在lambda表达式中能够修改变量</span>
        StringBuilder[] builder = {<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()};

        <span class="hljs-comment">//构建包含上下文的AI请求并返回流式响应</span>
        Flux&lt;String&gt; stream = chatClient.prompt(prompt).user( message).messages( messages).stream().content();
        <span class="hljs-keyword">return</span>  stream.doOnNext(s -&gt; builder[<span class="hljs-number">0</span>].append(s)) <span class="hljs-comment">//当AI返回每个片段时，将其追加到builder中进行累积</span>
                .doOnComplete(() -&gt; {
                    <span class="hljs-type">History</span> <span class="hljs-variable">aihistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">History</span>();
                    aihistory.setId(<span class="hljs-literal">null</span>);
                    aihistory.setDatetime(LocalDateTime.now());
                    aihistory.setRole(<span class="hljs-string">"assistant"</span>);
                    aihistory.setContent(builder[<span class="hljs-number">0</span>].toString());
                    aihistory.setSessionId(sessionId);
                    historyService.save(aihistory);
                });
        <span class="hljs-comment">/*
        当AI流式回复完成后，执行以下操作：
        创建新的历史记录对象
        设置时间戳
        设置角色为"assistant"
        将累积的完整回复内容保存
        设置会话ID
        保存到数据库
        这种方式确保了只有在AI完全生成回复后，才会将其保存到历史记录中，同时保持了流式响应的实时性*/</span>
    }

    <span class="hljs-meta">@GetMapping("/ai/embedding")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">embed</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.embedForResponse(List.of(message));
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"embedding"</span>, embeddingResponse);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 Golang 遇见工业 4.0：从“制造”到“智造”的数字化跃迁]]></title>    <link>https://juejin.cn/post/7595878718171037732</link>    <guid>https://juejin.cn/post/7595878718171037732</guid>    <pubDate>2026-01-17T04:13:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595878718171037732" data-draft-id="7595794942087446563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 Golang 遇见工业 4.0：从“制造”到“智造”的数字化跃迁"/> <meta itemprop="keywords" content="后端,Go,程序员"/> <meta itemprop="datePublished" content="2026-01-17T04:13:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码扳手"/> <meta itemprop="url" content="https://juejin.cn/user/177501539672379"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 Golang 遇见工业 4.0：从“制造”到“智造”的数字化跃迁
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/177501539672379/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码扳手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:13:00.000Z" title="Sat Jan 17 2026 04:13:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇关于正则的硬核文章中，我们浅尝辄止地提到了 FSM（有限状态机）。本想在评论区和大家来一场“华山论剑”，探讨它的花式实现，但转念一想，光谈理论未免枯燥。</p>
<p>正好最近在研究工业 4.0 的数字化转型，今天不妨换个视角，以<strong>工业数字化流程管理</strong>为例，带大家看看 Golang 是如何指挥庞大的物理工厂运转的。当然，作为“老朋友”的 FSM 状态机，也会在其中扮演关键角色，让我们一探究竟！</p>
<blockquote>
<p><strong>💡 点金之句：</strong>
代码的优雅，不仅在于逻辑的闭环，更在于对物理世界的敬畏与精准控制。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">01 核心架构：给工厂装上“大脑”</h2>
<p>我们的系统由三个核心组件构成，它们各司其职，像极了工厂里的各个部门：</p>
<ul>
<li><strong>Workflow Engine（编排引擎）</strong>：负责定义工序（上料 -&gt; 组装 -&gt; 质检 -&gt; 下料），它是生产线的“说明书”。</li>
<li><strong>Scheduler（调度器）</strong>：负责分发任务，决定谁先做、谁后做，它是工厂的“指挥官”。</li>
<li><strong>Station（工站）</strong>：实际干活的节点，模拟物理设备的执行。</li>
</ul>
<h3 data-id="heading-1">为什么选择 Go？</h3>
<p>工业场景对<strong>并发</strong>和<strong>实时性</strong>要求极高。Go 语言原生的 <code>goroutine</code> 和 <code>channel</code> 机制，天生就是为处理这种高并发流水线而生的。</p>
<hr/>
<h2 data-id="heading-2">02 痛点一：老板的 VIP 订单要插队！</h2>
<p>在传统队列（FIFO）中，先来后到是铁律。但在工业生产中，缺料补单、加急样品是常态。如果一个紧急订单被堵在几千个普通订单后面，工厂可能面临巨额违约金。</p>
<p><strong>解决方案：优先级队列 (Priority Queue)</strong></p>
<p>我们利用 Go 标准库 <code>container/heap</code> 实现了一个最小堆（Min-Heap），但这里我们反其道而行之，按优先级从大到小排序。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 核心代码片段：让 VIP 走绿色通道</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pq PriorityQueue)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> {
    <span class="hljs-comment">// 优先级高的排前面！</span>
    <span class="hljs-keyword">return</span> pq[i].Product.Priority &gt; pq[j].Product.Priority
}

<span class="hljs-comment">// 调度器逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span></span> SubmitTask(p *types.Product) {
    s.mu.Lock()
    heap.Push(&amp;s.pq, &amp;Item{Product: p}) <span class="hljs-comment">// 无论何时提交，自动排序</span>
    s.cond.Signal() <span class="hljs-comment">// 唤醒沉睡的工人</span>
    s.mu.Unlock()
}
</code></pre>
<p><strong>效果：</strong> 哪怕普通订单排了 100 米长，只要 VIP 订单一提交，下一个空闲的工位就是它的。这就是<strong>算法的特权</strong>。</p>
<hr/>
<h2 data-id="heading-3">03 痛点二：质检不合格，前面的工序白做了？</h2>
<p>假设一个电池包经过了“电芯组装”和“焊接”，结果在“质检”环节发现电压异常。这时候直接丢弃是不够的，我们需要<strong>逆向物流</strong>——拆解、回收、记录。</p>
<p><strong>解决方案：Saga 事务模式 + FSM 状态机</strong></p>
<p>在分布式系统中，Saga 用于处理长事务。在工厂里，我们用它来保证<strong>最终一致性</strong>。同时，我们引入了 <strong>FSM (有限状态机)</strong> 来精准管理工件的生命周期，确保状态流转（如 <code>PROCESSING</code> -&gt; <code>QUALITY_CHECK</code> -&gt; <code>FAILED</code>）的合法性。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 编排引擎的核心逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *WorkflowEngine)</span></span> Process(p *types.Product) {
    <span class="hljs-comment">// 初始化 FSM</span>
    productFSM := fsm.NewFSM(p.ID)
    _ = productFSM.Fire(fsm.EventStart) <span class="hljs-comment">// 状态流转：CREATED -&gt; PROCESSING</span>

    <span class="hljs-keyword">for</span> _, step := <span class="hljs-keyword">range</span> sequence {
        <span class="hljs-comment">// ... 执行工序 ...</span>
        <span class="hljs-keyword">if</span> !res.Success {
            _ = productFSM.Fire(fsm.EventFail) <span class="hljs-comment">// 状态流转：-&gt; FAILED</span>
            <span class="hljs-comment">// ⚠️ 报警！触发熔断与补偿</span>
            e.rollback(executedStations, p, productFSM)
            <span class="hljs-keyword">return</span>
        }
    }
    _ = productFSM.Fire(fsm.EventFinish) <span class="hljs-comment">// 状态流转：-&gt; COMPLETED</span>
}
</code></pre>
<p>这不仅是代码层面的回滚，更是物理世界的“后悔药”。</p>
<hr/>
<h2 data-id="heading-4">04 痛点三：效率至上，能并行的绝不串行！</h2>
<p>传统的流水线往往是线性的，但现代工厂中，很多工序可以并行处理。例如，在组装底盘的同时，可以并行进行车身喷涂。</p>
<p><strong>解决方案：抽象接口与并发编排</strong></p>
<p>我们将 <code>Station</code> 抽象为接口，并利用 Go 强大的 <code>sync.WaitGroup</code> 实现工序的并行执行。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// executeStep 执行单个步骤，支持并行工站</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *WorkflowEngine)</span></span> executeStep(step types.WorkflowStep, p *types.Product) {
    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    <span class="hljs-keyword">for</span> _, sID := <span class="hljs-keyword">range</span> step.StationIDs {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s station.Station)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            s.Execute(p) <span class="hljs-comment">// 并发执行！</span>
        }(st)
    }
    wg.Wait() <span class="hljs-comment">// 等待所有并行工序完成</span>
}
</code></pre>
<p>通过这种方式，我们不仅提高了生产效率，还解耦了具体的工站实现，为未来接入真实的硬件控制接口打下了基础。</p>
<hr/>
<h2 data-id="heading-5">05 痛点四：系统崩溃，数据全丢？</h2>
<p>工厂停电或服务器宕机是不可避免的。如果重启后，所有正在排队的订单都消失了，那将是灾难性的。</p>
<p><strong>解决方案：WAL (Write-Ahead Logging) 持久化</strong></p>
<p>我们借鉴数据库的设计，引入了 <strong>WAL 预写日志</strong>。在任务进入内存队列前，先写入磁盘日志。系统启动时，自动重放日志，恢复未完成的任务。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 提交任务时：先写日志，再入内存</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span></span> SubmitTask(p *types.Product) {
    <span class="hljs-keyword">if</span> err := s.wal.Append(p); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 处理错误...</span>
    }
    heap.Push(&amp;s.pq, &amp;Item{Product: p})
}

<span class="hljs-comment">// 启动时：从日志恢复</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span></span> RecoverTasks() {
    tasks := s.wal.Recover()
    <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> tasks {
        heap.Push(&amp;s.pq, &amp;Item{Product: p})
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">06 总结与展望</h2>
<p>通过这个 Demo，我们不仅复习了 Go 的并发模型，更看到了技术在实体产业中的巨大潜力。</p>
<ul>
<li><strong>PriorityQueue</strong> 解决了资源分配的公平与效率问题。</li>
<li><strong>Saga + FSM</strong> 解决了长流程中的容错与状态管理问题。</li>
<li><strong>并发编排</strong> 提升了生产效率。</li>
<li><strong>WAL 持久化</strong> 保证了数据的可靠性。</li>
<li><strong>Prometheus 监控</strong> 让系统状态一目了然。</li>
</ul>
<p>工业 4.0 不仅仅是硬件的升级，更是软件架构的革命。作为开发者，我们的每一行代码，都可能驱动着现实世界中某个齿轮的转动。</p>
<p><strong>Talk is cheap, show me the code.</strong>
如果你对源码感兴趣，欢迎在后台回复 <strong>“工业4.0”</strong> 获取完整 GitHub 仓库地址，一起探讨 Golang 在物联网领域的更多可能！</p>
<hr/>
<p><strong>👇 喜欢这篇文章？“点赞”，“收藏”，“分享”，让技术更有温度！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Elasticsearch 管理 agentic 记忆]]></title>    <link>https://juejin.cn/post/7595858760133673023</link>    <guid>https://juejin.cn/post/7595858760133673023</guid>    <pubDate>2026-01-17T05:54:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858760133673023" data-draft-id="7595911076013785124" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Elasticsearch 管理 agentic 记忆"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-01-17T05:54:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Elasticsearch 管理 agentic 记忆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T05:54:49.000Z" title="Sat Jan 17 2026 05:54:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fsomeshwaran-mohankumar" title="https://www.elastic.co/search-labs/author/someshwaran-mohankumar" target="_blank" ref="nofollow noopener noreferrer">Someshwaran Mohankumar</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00cfc15cfd814ee897d28d128bc95581~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=bQdHJS8FskRZYpZB700BCFklEJo%3D" alt="" loading="lazy"/></p>
<p>通过使用 Elasticsearch 管理记忆来创建更具上下文感知且更高效的代理。</p>
<p>Agent Builder 现在以技术预览版的形式提供。使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration%3Futm_source%3Dagentic-ai-category%26utm_medium%3Dsearch-labs%26utm_campaign%3Dagent-builder" title="https://cloud.elastic.co/registration?utm_source=agentic-ai-category&amp;utm_medium=search-labs&amp;utm_campaign=agent-builder" target="_blank" ref="nofollow noopener noreferrer">Elastic Cloud Trial</a> 开始体验，并在<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Felastic-agent-builder%3Futm_source%3Dagentic-ai-category%26utm_medium%3Dsearch-labs%26utm_campaign%3Dagent-builder" title="https://www.elastic.co/docs/solutions/search/elastic-agent-builder?utm_source=agentic-ai-category&amp;utm_medium=search-labs&amp;utm_campaign=agent-builder" target="_blank" ref="nofollow noopener noreferrer">这里</a>查看 Agent Builder 的文档。</p>
<hr/>
<p>在新兴的 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F151232162" title="https://elasticstack.blog.csdn.net/article/details/151232162" target="_blank" ref="nofollow noopener noreferrer">context engineering</a></strong> 领域，给 AI agent 在正确时间提供正确信息至关重要。context engineering 中最重要的方面之一是管理 AI 的 <strong>memory</strong>。就像人类一样，AI 系统依赖短期 memory 和长期 memory 来回忆信息。如果我们希望 large language model (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134747557" title="https://elasticstack.blog.csdn.net/article/details/134747557" target="_blank" ref="nofollow noopener noreferrer">LLM</a>) agent 进行逻辑对话、记住用户偏好，或在之前的结果或响应基础上继续工作，我们需要为它们配备有效的 memory 机制。</p>
<p>毕竟，上下文中的一切都会影响 AI 的响应。垃圾进, 垃圾出同样适用。</p>
<p>在本文中，我们将介绍短期和长期 memory 对 AI agent 的意义，具体包括：</p>
<ul>
<li>短期 memory 和长期 memory 的区别。</li>
<li>它们如何与基于 vector database 的 retrieval-augmented generation (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134396254" title="https://elasticstack.blog.csdn.net/article/details/134396254" target="_blank" ref="nofollow noopener noreferrer">RAG</a>) 技术（如 Elasticsearch）相关，以及为什么需要谨慎管理 memory。</li>
<li>忽视 memory 的风险，包括 context overflow 和 context poisoning。</li>
<li>最佳实践，如 context pruning、summarizing，以及只检索相关内容，以保持 agent 的 memory 既有用又安全。</li>
</ul>
<p>最后，我们还会介绍 memory 如何在 multi-agent 系统中共享和传播，使 agent 能在使用 Elasticsearch 时协作而不产生混乱。</p>
<h2 data-id="heading-0">AI agent 中的短期记忆与长期记忆</h2>
<p>AI agent 的短期记忆通常指即时的对话上下文或状态 —— 本质上是当前的聊天记录或活跃会话中的最近消息。这包括用户的最新查询和最近的来回交流。这与人在进行对话时心中保持的信息非常相似。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c43c707eb794c65b7c3fd7aa95f6f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=857UdLfIQeSx3pxvD%2FbdOv43Eqc%3D" alt="" loading="lazy"/> Image source:  <a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain.ai.github.io%2Flanggraphjs%2Fconcepts%2Fmemory" title="https://langchain.ai.github.io/langgraphjs/concepts/memory" target="_blank" ref="nofollow noopener noreferrer">langchain.ai.github.io/langgraphjs…</a></p>
<p>AI 框架通常将这种短暂记忆作为 agent 状态的一部分（例如，使用 checkpointer 存储对话状态，就像 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Fpersistence%23checkpoints" title="https://docs.langchain.com/oss/python/langgraph/persistence#checkpoints" target="_blank" ref="nofollow noopener noreferrer">LangGraph 示例</a>中展示的那样）。短期记忆是<strong>会话范围的</strong>；也就是说，它存在于单个对话或任务中，并在该会话结束时重置或清除，除非被显式保存到其他地方。会话绑定的短期记忆示例就是 ChatGPT 中可用的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F8914046-temporary-chat-faq" title="https://help.openai.com/en/articles/8914046-temporary-chat-faq" target="_blank" ref="nofollow noopener noreferrer">临时聊天记录</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cc2de7d82454b3bb5aa74a758618d5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=uYT761e7KhYYaGqoH4Fpwz2tNJU%3D" alt="" loading="lazy"/> 图片来源: :  <a href="https://link.juejin.cn?target=http%3A%2F%2F%3A%2520https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Fpersistence%23memory-store" title="http://:%20https://docs.langchain.com/oss/python/langgraph/persistence#memory-store" target="_blank" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p>
<p>另一方面，长期记忆指的是跨对话或会话持续存在的信息。这是 agent 随时间保留的知识、早先学到的事实、用户偏好，或我们要求它永久记住的任何数据。</p>
<p>长期记忆通常通过存储在外部来源（如文件或<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Felasticsearch%2Fvector-database" title="https://www.elastic.co/elasticsearch/vector-database" target="_blank" ref="nofollow noopener noreferrer">向量数据库</a>）并进行检索来实现，这些来源在当前上下文窗口之外。与短期聊天记录不同，长期记忆不会自动包含在每个 prompt 中。相反，基于特定场景，agent 必须在调用相关工具时回忆或检索它。实际中，长期记忆可能包括用户的个人信息、agent 先前生成的答案或分析，或可查询的知识库。</p>
<p>例如，如果你有一个旅行规划 agent，短期记忆会包含当前行程查询的详细信息（日期、目的地、预算）及聊天中的任何后续问题；而长期记忆可以存储用户的一般旅行偏好、过去的行程以及之前会话中共享的其他事实。当用户之后再次访问时，agent 可以从这个长期存储中调用信息（例如，用户喜欢海滩和山脉，平均预算为 INR 100,000，有旅行愿望清单，偏好体验历史和文化而非儿童友好景点），这样每次就不需要把用户当作空白。</p>
<p>短期记忆（聊天记录）提供即时上下文和连续性，而长期记忆提供更广泛的上下文供 agent 在需要时参考。大多数先进的 AI agent 框架同时支持两者：它们跟踪最近对话以维持上下文，并提供在长期存储中查找或存储信息的机制。管理短期记忆确保其保持在上下文窗口内，而管理长期记忆则帮助 agent 基于之前的互动和用户特征提供更有依据的回答。</p>
<h2 data-id="heading-1">上下文工程中的记忆与 RAG</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147134f94236443b8b7e8e69e71700f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=LmKLipWoTrGjBwKaVkx7xwPQh54%3D" alt="" loading="lazy"/> Image source:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhumanlayer%2F12-factor-agents%2Fblob%2Fmain%2Fcontent%2Ffactor-03-own-your-context-window.md" title="https://github.com/humanlayer/12-factor-agents/blob/main/content/factor-03-own-your-context-window.md" target="_blank" ref="nofollow noopener noreferrer">github.com/humanlayer/…</a></p>
<h3 data-id="heading-2">在实践中，我们如何为 AI agent 提供有用的长期记忆？</h3>
<p>一种常用的长期记忆方法是<strong>语义记忆</strong>，通常通过倒数排序增强生成（<strong>RAG, Retrieval-Augmented Generation</strong>）实现。这涉及将 LLM 与外部知识库或支持向量的存储（如 Elasticsearch）结合。当 LLM 需要超出 prompt 或内置训练的信息时，它会对 Elasticsearch 进行语义检索，并将最相关的结果注入到 prompt 中作为上下文。这样，模型的有效上下文不仅包括最近对话（短期记忆），还包括即时获取的相关长期事实。LLM 随后基于自身推理和检索到的信息来生成回答，有效地结合短期记忆和长期记忆，从而提供更准确、上下文感知的响应。</p>
<p><strong>Elasticsearch</strong> 可以用于为 AI agent 实现长期记忆。下面是一个高级示例，展示如何从 Elasticsearch 中检索上下文以实现长期记忆。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14432fb8d97745118733b3eb0c5d52f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=UrGN7f27dhP0pwrGcozYJpVudeU%3D" alt="" loading="lazy"/></p>
<p>这样，agent 通过搜索相关数据来 “记住”，而不是把所有内容都存储在有限的 prompt 中，否则<strong>会带来不同风险</strong>。</p>
<h3 data-id="heading-3">使用 RAG 配合 Elasticsearch 或任何向量存储有多个好处：</h3>
<p>首先，它将模型的知识扩展到训练截止日期之外。agent 可以检索 LLM 可能不知道的最新信息或特定领域数据。这对于涉及近期事件或专业主题的问题至关重要。</p>
<p>其次，按需检索上下文有助于减少幻觉，尤其是因为 LLM 没有针对你特定用例中的专有或高度专业化数据进行训练，这很可能导致幻觉。与其让 LLM 根据评估激励去猜测或虚构信息（如最近 OpenAI 论文《<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2509.04664" title="https://arxiv.org/pdf/2509.04664" target="_blank" ref="nofollow noopener noreferrer">Why Language Models Hallucinate</a>》指出的），模型可以通过来自 Elasticsearch 的事实引用来落地。自然地，LLM 的可靠性依赖于向量存储中数据的准确性，相关数据会根据核心相关性指标被检索出来。</p>
<p>第三，RAG 允许 agent 使用远大于任何 prompt 容量的知识库。无需将整篇文档（如长篇研究论文或政策文件）推入上下文窗口而冒着过载或无关<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F15je2KBUgkYKuR2jxGVCGVaa2UhXzwL11cTv8ikC1-z8%2Fedit%3Ftab%3Dt.0%23heading%3Dh.p9dxm9xxrnvp" title="https://docs.google.com/document/d/15je2KBUgkYKuR2jxGVCGVaa2UhXzwL11cTv8ikC1-z8/edit?tab=t.0#heading=h.p9dxm9xxrnvp" target="_blank" ref="nofollow noopener noreferrer">上下文信息污染</a>模型推理的风险，RAG 使用<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152072259" title="https://elasticstack.blog.csdn.net/article/details/152072259" target="_blank" ref="nofollow noopener noreferrer">分块</a>策略。大型文档被拆分为较小、语义明确的片段，系统只检索与查询最相关的几个片段。这样，模型无需百万 token 的上下文就能显得知识丰富；只需访问更大语料库中正确的片段即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/630535cbca7f423fb7d47c0269b03be7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=%2FPdPVCNBY1%2BjuKsUudwXoiWwqqA%3D" alt="" loading="lazy"/> Image source:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.meibel.ai%2Fpost%2Funderstanding-the-impact-of-increasing-llm-context-windows" title="https://www.meibel.ai/post/understanding-the-impact-of-increasing-llm-context-windows" target="_blank" ref="nofollow noopener noreferrer">www.meibel.ai/post/unders…</a></p>
<p>值得注意的是，随着 LLM 上下文窗口的增大（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2F1m-context" title="https://www.anthropic.com/news/1m-context" target="_blank" ref="nofollow noopener noreferrer">一些模型现在支持数十万甚至数百万 token</a>），关于 RAG 是否 “过时” 的讨论出现了。为什么不把所有数据都放入 prompt 呢？如果你也有类似想法，可以参考我同事 Jeffrey Rengifo 和 Eduard Martin 的精彩文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F149288509" title="https://elasticstack.blog.csdn.net/article/details/149288509" target="_blank" ref="nofollow noopener noreferrer">上下文更长 ≠ 更好：为什么 RAG 仍然重要</a>》。这种方法避免了 “垃圾进，垃圾出” 的问题：LLM 关注少量重要片段，而不是处理大量噪声。</p>
<p>也就是说，将 Elasticsearch 或任何向量存储集成到 AI agent 架构中，可以提供<strong>长期记忆</strong>。agent 将知识存储在外部，并在需要时拉入作为记忆上下文。这可以实现为一种架构：每次用户查询后，agent 在 Elasticsearch 中搜索相关信息，然后将最相关结果追加到 prompt 中，再调用 LLM。如果回答包含有用的新信息，也可以将其保存回长期存储（形成学习的反馈循环）。通过使用这种基于检索的记忆，agent 可以保持信息更新，无需在每个 prompt 中塞入它知道的所有内容，即便上下文窗口支持一百万 token。这一技术是上下文工程的基石，结合了信息检索和生成式 AI 的优势。</p>
<p>下面是一个使用 LangGraph checkpoint 系统在会话期间管理短期记忆的内存对话状态示例。（参考我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FsomeshwaranM%2Felastic-context-engineering-short-term-long-term-memory" title="https://github.com/someshwaranM/elastic-context-engineering-short-term-long-term-memory" target="_blank" ref="nofollow noopener noreferrer">上下文工程支持应用</a>。）</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  <span class="hljs-comment"># Initialize chat memory (<span class="hljs-doctag">Note:</span> This is in-memory only, not persistent)</span>
<span class="hljs-attr">2.  memory</span> = MemorySaver()

4.  <span class="hljs-comment"># Create a LangGraph agent</span>
<span class="hljs-attr">5.  langgraph_agent</span> = create_react_agent(model=llm, tools=tools, checkpointer=memory)

7.  ...
8.  ...
9.  <span class="hljs-comment"># Only process and display checkpoints if verbose mode is enabled</span>
10.  if args.verbose:
11.      <span class="hljs-comment"># List all checkpoints that match a given configuration</span>
<span class="hljs-attr">12.      checkpoints</span> = memory.list({<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>}})
13.      <span class="hljs-comment"># Process the checkpoints</span>
14.      process_checkpoints(checkpoints)

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>以下是它如何存储 checkpoint 的方式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">`</span>

<span class="hljs-attr">1.  Checkpoint:</span>
<span class="hljs-attr">2.  Timestamp:</span> <span class="hljs-number">2025-12-30T09:19:41.691087+00:00</span>
<span class="hljs-attr">3.  Checkpoint ID:</span> <span class="hljs-string">1f0e560a-c2fa-69ec-8001-14ee5373f9cf</span>
<span class="hljs-attr">4.  User:</span> <span class="hljs-string">Hi</span> <span class="hljs-string">I'm</span> <span class="hljs-string">Som,</span> <span class="hljs-string">how</span> <span class="hljs-string">are</span> <span class="hljs-string">you?</span> <span class="hljs-string">(Message</span> <span class="hljs-attr">ID:</span> <span class="hljs-string">ad0a8415-5392-4a58-85ad-84154875bbf2)</span>
<span class="hljs-attr">5.  Agent:</span> <span class="hljs-string">Hi</span> <span class="hljs-string">Som!</span> <span class="hljs-string">I'm</span> <span class="hljs-string">doing</span> <span class="hljs-string">well,</span> <span class="hljs-string">thank</span> <span class="hljs-string">you!</span> <span class="hljs-string">How</span> <span class="hljs-string">about</span> <span class="hljs-string">you?</span> <span class="hljs-string">(Message</span> <span class="hljs-attr">ID:</span> 
<span class="hljs-number">6</span><span class="hljs-string">.</span>  <span class="hljs-string">56d31efb-14e3-4148-806e-24a839799ece)</span>
<span class="hljs-attr">7.  Agent:</span>  <span class="hljs-string">(Message</span> <span class="hljs-attr">ID:</span> <span class="hljs-string">lc_run--019b6e8e-553f-7b52-8796-a8b1fbb206a4-0)</span>

<span class="hljs-attr">9.  Checkpoint:</span>
<span class="hljs-attr">10.  Timestamp:</span> <span class="hljs-number">2025-12-30T09:19:40.350507+00:00</span>
<span class="hljs-attr">11.  Checkpoint ID:</span> <span class="hljs-string">1f0e560a-b631-6a08-8000-7796d108109a</span>
<span class="hljs-attr">12.  User:</span> <span class="hljs-string">Hi</span> <span class="hljs-string">I'm</span> <span class="hljs-string">Som,</span> <span class="hljs-string">how</span> <span class="hljs-string">are</span> <span class="hljs-string">you?</span> <span class="hljs-string">(Message</span> <span class="hljs-attr">ID:</span> <span class="hljs-string">ad0a8415-5392-4a58-85ad-84154875bbf2)</span>
<span class="hljs-attr">13.  Agent:</span> <span class="hljs-string">Hi</span> <span class="hljs-string">Som!</span> <span class="hljs-string">I'm</span> <span class="hljs-string">doing</span> <span class="hljs-string">well,</span> <span class="hljs-string">thank</span> <span class="hljs-string">you!</span> <span class="hljs-string">How</span> <span class="hljs-string">about</span> <span class="hljs-string">you?</span> <span class="hljs-string">(Message</span> <span class="hljs-attr">ID:</span> 
<span class="hljs-number">14</span><span class="hljs-string">.</span>  <span class="hljs-string">56d31efb-14e3-4148-806e-24a839799ece)</span>

<span class="hljs-attr">16.  Checkpoint:</span>
<span class="hljs-attr">17.  Timestamp:</span> <span class="hljs-number">2025-12-30T09:19:40.349027+00:00</span>
<span class="hljs-attr">18.  Checkpoint ID:</span> <span class="hljs-string">1f0e560a-b62e-6010-bfff-cbebe1d865f6</span>

<span class="hljs-string">`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>对于长期记忆，以下是我们如何在 Elasticsearch 上执行<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145485873" title="https://elasticstack.blog.csdn.net/article/details/145485873" target="_blank" ref="nofollow noopener noreferrer">语义搜索</a>：在将 checkpoint 总结并索引到 Elasticsearch 后，使用向量嵌入（<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134748014" title="https://elasticstack.blog.csdn.net/article/details/134748014" target="_blank" ref="nofollow noopener noreferrer">vector embeddings</a> ）检索相关的历史对话。</p>
<pre><code class="hljs language-python" lang="python">`

<span class="hljs-number">1.</span>  Functions: 
<span class="hljs-number">2.</span>  retrieve_from_elasticsearch() 

<span class="hljs-number">4.</span>  <span class="hljs-comment"># Enhanced Elasticsearch retrieval with rank_window and verbose display</span>
<span class="hljs-number">5.</span>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_from_elasticsearch</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>, rank_window: <span class="hljs-built_in">int</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]], <span class="hljs-built_in">str</span>]:
<span class="hljs-number">6.</span>      <span class="hljs-string">"""
7.      Retrieve context from Elasticsearch with score-based ranking

9.      Args:
10.          query: Search query
11.          k: Number of results to return
12.          rank_window: Number of candidates to retrieve before ranking (default: args.rank_window)

14.      Returns:
15.          Tuple of (retrieved_documents, formatted_context_string)
16.      """</span>
<span class="hljs-number">17.</span>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> es_client <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> es_index_name:
<span class="hljs-number">18.</span>          <span class="hljs-keyword">return</span> [], <span class="hljs-string">"Elasticsearch is not available. Cannot search long-term memory."</span>

<span class="hljs-number">20.</span>      <span class="hljs-keyword">if</span> rank_window <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
<span class="hljs-number">21.</span>          rank_window = args.rank_window

<span class="hljs-number">23.</span>      <span class="hljs-keyword">try</span>:
<span class="hljs-number">24.</span>          <span class="hljs-comment"># Check if index exists and has documents</span>
<span class="hljs-number">25.</span>          <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> es_client.indices.exists(index=es_index_name):
<span class="hljs-number">26.</span>              <span class="hljs-keyword">return</span> [], <span class="hljs-string">"No previous conversations stored in long-term memory yet."</span>

<span class="hljs-number">28.</span>          <span class="hljs-comment"># Get document count</span>
<span class="hljs-number">29.</span>          <span class="hljs-keyword">try</span>:
<span class="hljs-number">30.</span>              doc_count = es_client.count(index=es_index_name)[<span class="hljs-string">"count"</span>]
<span class="hljs-number">31.</span>              <span class="hljs-keyword">if</span> doc_count == <span class="hljs-number">0</span>:
<span class="hljs-number">32.</span>                  <span class="hljs-keyword">return</span> [], <span class="hljs-string">"Long-term memory is empty. No previous conversations to search."</span>
<span class="hljs-number">33.</span>          <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
<span class="hljs-number">34.</span>              <span class="hljs-keyword">return</span> [], <span class="hljs-string">f"Error checking memory: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-number">36.</span>          <span class="hljs-comment"># Generate embedding for the query</span>
<span class="hljs-number">37.</span>          <span class="hljs-keyword">try</span>:
<span class="hljs-number">38.</span>              query_embedding = embeddings.embed_query(query)
<span class="hljs-number">39.</span>          <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
<span class="hljs-number">40.</span>              <span class="hljs-keyword">return</span> [], <span class="hljs-string">f"Error generating embedding: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-number">42.</span>          <span class="hljs-comment"># Perform semantic search using kNN with rank_window</span>
<span class="hljs-number">43.</span>          <span class="hljs-keyword">try</span>:
<span class="hljs-number">44.</span>              search_body = {
<span class="hljs-number">45.</span>                  <span class="hljs-string">"knn"</span>: {
<span class="hljs-number">46.</span>                      <span class="hljs-string">"field"</span>: <span class="hljs-string">"vector"</span>,
<span class="hljs-number">47.</span>                      <span class="hljs-string">"query_vector"</span>: query_embedding,
<span class="hljs-number">48.</span>                      <span class="hljs-string">"k"</span>: k,
<span class="hljs-number">49.</span>                      <span class="hljs-string">"num_candidates"</span>: rank_window  <span class="hljs-comment"># Retrieve more candidates, then rank top k</span>
<span class="hljs-number">50.</span>                  },
<span class="hljs-number">51.</span>                  <span class="hljs-string">"_source"</span>: [<span class="hljs-string">"text"</span>, <span class="hljs-string">"content"</span>, <span class="hljs-string">"message_type"</span>, <span class="hljs-string">"timestamp"</span>, <span class="hljs-string">"thread_id"</span>],
<span class="hljs-number">52.</span>                  <span class="hljs-string">"size"</span>: k
<span class="hljs-number">53.</span>              }

<span class="hljs-number">55.</span>              response = es_client.search(index=es_index_name, body=search_body)

<span class="hljs-number">57.</span>              <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response.get(<span class="hljs-string">"hits"</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(response[<span class="hljs-string">"hits"</span>][<span class="hljs-string">"hits"</span>]) == <span class="hljs-number">0</span>:
<span class="hljs-number">58.</span>                  <span class="hljs-keyword">return</span> [], <span class="hljs-string">"No relevant previous conversations found in long-term memory."</span>

<span class="hljs-number">60.</span>              <span class="hljs-comment"># Extract documents with scores</span>
<span class="hljs-number">61.</span>              retrieved_docs = []
<span class="hljs-number">62.</span>              <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> response[<span class="hljs-string">"hits"</span>][<span class="hljs-string">"hits"</span>]:
<span class="hljs-number">63.</span>                  source = hit[<span class="hljs-string">"_source"</span>]
<span class="hljs-number">64.</span>                  score = hit[<span class="hljs-string">"_score"</span>]
<span class="hljs-number">65.</span>                  retrieved_docs.append({
<span class="hljs-number">66.</span>                      <span class="hljs-string">"content"</span>: source.get(<span class="hljs-string">"content"</span>, source.get(<span class="hljs-string">"text"</span>, <span class="hljs-string">""</span>)),
<span class="hljs-number">67.</span>                      <span class="hljs-string">"message_type"</span>: source.get(<span class="hljs-string">"message_type"</span>, <span class="hljs-string">"unknown"</span>),
<span class="hljs-number">68.</span>                      <span class="hljs-string">"timestamp"</span>: source.get(<span class="hljs-string">"timestamp"</span>, <span class="hljs-string">"unknown"</span>),
<span class="hljs-number">69.</span>                      <span class="hljs-string">"thread_id"</span>: source.get(<span class="hljs-string">"thread_id"</span>, <span class="hljs-string">"unknown"</span>),
<span class="hljs-number">70.</span>                      <span class="hljs-string">"score"</span>: score
<span class="hljs-number">71.</span>                  })

<span class="hljs-number">73.</span>              <span class="hljs-comment"># Format context string</span>
<span class="hljs-number">74.</span>              context_parts = []
<span class="hljs-number">75.</span>              <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(retrieved_docs, <span class="hljs-number">1</span>):
<span class="hljs-number">76.</span>                  context_parts.append(doc[<span class="hljs-string">"content"</span>])

<span class="hljs-number">78.</span>              context_string = <span class="hljs-string">"\n\n"</span>.join(context_parts)

<span class="hljs-number">80.</span>              <span class="hljs-comment"># Verbose display</span>
<span class="hljs-number">81.</span>              <span class="hljs-keyword">if</span> args.verbose:
<span class="hljs-number">82.</span>                  rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n[bold yellow]🔍 RETRIEVAL ANALYSIS[/bold yellow]"</span>)
<span class="hljs-number">83.</span>                  rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">80</span>)
<span class="hljs-number">84.</span>                  rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[blue]Query:[/blue] <span class="hljs-subst">{query}</span>"</span>)
<span class="hljs-number">85.</span>                  rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[blue]Retrieved:[/blue] <span class="hljs-subst">{<span class="hljs-built_in">len</span>(retrieved_docs)}</span> documents (from <span class="hljs-subst">{rank_window}</span> candidates)"</span>)
<span class="hljs-number">86.</span>                  rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[blue]Total context length:[/blue] <span class="hljs-subst">{<span class="hljs-built_in">len</span>(context_string)}</span> characters\n"</span>)

<span class="hljs-number">88.</span>                  <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(retrieved_docs, <span class="hljs-number">1</span>):
<span class="hljs-number">89.</span>                      rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[cyan]📄 Document <span class="hljs-subst">{i}</span> | Score: <span class="hljs-subst">{doc[<span class="hljs-string">'score'</span>]:<span class="hljs-number">.4</span>f}</span> | Type: <span class="hljs-subst">{doc[<span class="hljs-string">'message_type'</span>]}</span>[/cyan]"</span>)
<span class="hljs-number">90.</span>                      rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[cyan]   Timestamp: <span class="hljs-subst">{doc[<span class="hljs-string">'timestamp'</span>]}</span> | Thread: <span class="hljs-subst">{doc[<span class="hljs-string">'thread_id'</span>]}</span>[/cyan]"</span>)
<span class="hljs-number">91.</span>                      content_preview = doc[<span class="hljs-string">'content'</span>][:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(doc[<span class="hljs-string">'content'</span>]) &gt; <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> doc[<span class="hljs-string">'content'</span>]
<span class="hljs-number">92.</span>                      rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[cyan]   Content: <span class="hljs-subst">{content_preview}</span>[/cyan]"</span>)
<span class="hljs-number">93.</span>                      rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)

<span class="hljs-number">95.</span>              <span class="hljs-keyword">return</span> retrieved_docs, context_string

<span class="hljs-number">97.</span>          <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
<span class="hljs-number">98.</span>              <span class="hljs-keyword">return</span> [], <span class="hljs-string">f"Error searching memory: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-number">100.</span>      <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
<span class="hljs-number">101.</span>          <span class="hljs-keyword">return</span> [], <span class="hljs-string">f"Error accessing long-term memory: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)收起代码块![](https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png)
</code></pre>
<p>现在我们已经了解了如何使用 LangGraph 的 checkpoint 在 Elasticsearch 中索引和获取短期记忆与长期记忆，让我们花点时间理解为什么索引和导出完整对话可能存在风险。</p>
<h2 data-id="heading-4">不管理上下文记忆的风险</h2>
<p>在讨论上下文工程，以及短期记忆和长期记忆时，我们需要明白如果不妥善管理 agent 的记忆和上下文，会发生什么。</p>
<p>不幸的是，当 AI 的上下文变得非常长或包含错误信息时，可能会出现很多问题。随着上下文窗口增大，会出现<strong>新的失败模式</strong>，例如：</p>
<ul>
<li>上下文污染</li>
<li>上下文分心</li>
<li>上下文混淆</li>
<li>上下文冲突</li>
<li>上下文泄露和知识冲突</li>
<li>幻觉和错误信息</li>
</ul>
<p>让我们分解这些问题，以及由于上下文管理不当可能产生的其他风险：</p>
<h3 data-id="heading-5">上下文污染</h3>
<p>上下文污染指错误或有害信息进入上下文并 “污染” 模型后续输出。一个常见例子是模型产生的幻觉被当作事实，插入对话历史中。模型随后可能在后续回答中基于该错误继续推理，错误不断累积。在迭代 agent 循环中，一旦错误信息进入共享上下文（例如在 agent 工作笔记的总结中），它可能被反复强化。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fstorage.googleapis.com%2Fdeepmind-media%2Fgemini%2Fgemini_v2_5_report.pdf" title="https://storage.googleapis.com/deepmind-media/gemini/gemini_v2_5_report.pdf" target="_blank" ref="nofollow noopener noreferrer">DeepMind 的研究人员在发布 Gemini 2.5 报告时</a>（摘要，可查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dbreunig.com%2F2025%2F06%2F17%2Fan-agentic-case-study-playing-pok%25C3%25A9mon-with-gemini.html" title="https://www.dbreunig.com/2025/06/17/an-agentic-case-study-playing-pok%C3%A9mon-with-gemini.html" target="_blank" ref="nofollow noopener noreferrer">此处</a>）观察到，一个长时间运行的 Pokémon 玩游戏 agent 中出现了这种情况：如果 agent 幻觉了错误的游戏状态，并且该状态被记录在上下文中（它的目标记忆），agent 会围绕一个不可能实现的目标形成<strong>荒谬策略</strong>并陷入困境。换句话说，被污染的记忆可能让 agent 无休止地走向错误路径。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1272ac46d4e04c52a0aa64dba15d6053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=ONfrl7N4Qw33Ap0moS2UbmZg5vU%3D" alt="" loading="lazy"/> agent 工具概览（Zhang, 2025）。大地图的迷雾系统在探索过的区域会自动存储该格子，并标记访问计数器。格子类型从 RAM 中记录。agent 工具（pathfinder、boulder_puzzle_strategist）是 Gemini 2.5 Pro 的提示实例。pathfinder 用于导航，boulder_puzzle_strategist 用于解决 Victory Road 地下城的岩石谜题。<br/>
图片来源： <a href="https://link.juejin.cn?target=https%3A%2F%2Fstorage.googleapis.com%2Fdeepmind-media%2Fgemini%2Fgemini_v2_5_report.pdf" title="https://storage.googleapis.com/deepmind-media/gemini/gemini_v2_5_report.pdf" target="_blank" ref="nofollow noopener noreferrer">storage.googleapis.com/deepmind-me…</a> - 第68页。</p>
<p>上下文污染可能无意发生（出错）或恶意发生，例如通过提示注入攻击（prompt injection），用户或第三方偷偷插入隐藏指令或错误信息，使 agent 记住并执行。</p>
<p><strong>推荐的对策</strong>：</p>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wiz.io%2Facademy%2Fdata-poisoning" title="https://www.wiz.io/academy/data-poisoning" target="_blank" ref="nofollow noopener noreferrer">Wiz</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fzerlo.net%2Fen%2Fblog%2Fwhat-is-llm-data-poisoning" title="https://zerlo.net/en/blog/what-is-llm-data-poisoning" target="_blank" ref="nofollow noopener noreferrer">Zerlo</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fresearch%2Fsmall-samples-poison" title="https://www.anthropic.com/research/small-samples-poison" target="_blank" ref="nofollow noopener noreferrer">Anthropic</a> 的见解，防止上下文污染的措施侧重于阻止错误或误导信息进入 LLM 的 prompt、上下文窗口或检索流程。关键步骤包括：</p>
<ul>
<li>持续检查上下文：监控对话或检索文本，发现任何可疑或有害内容，而不仅仅是初始 prompt。</li>
<li>使用可信来源：根据可信度评分或标记文档，使系统偏好可靠信息，忽略低评分数据。</li>
<li>发现异常数据：使用工具检测奇怪、异常或被操控的内容，并在模型使用前移除。</li>
<li>过滤输入输出：增加保护措施，防止有害或误导文本轻易进入系统或被模型重复。</li>
<li>用干净数据更新模型：定期用验证过的信息刷新系统，以对抗任何漏网的坏数据。</li>
<li>人工干预：让人审核重要输出或将其与已知可信来源对比。</li>
</ul>
<p>简单的用户习惯也有帮助，比如重置长对话，仅分享相关信息，将复杂任务拆成小步骤，以及在模型外保持干净的笔记。</p>
<p>这些措施共同形成分层防护，保护 LLM 免受上下文污染，使输出准确可信。</p>
<p>如果没有上述对策，agent 可能记住攻击者插入的指令，如忽略之前的指南或无关事实，从而产生有害输出。</p>
<h3 data-id="heading-6">上下文干扰</h3>
<p>上下文干扰是指上下文变得非常长，以至于模型过度关注上下文，而忽略了它在训练中学到的知识。在极端情况下，这类似灾难性遗忘（<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FCatastrophic_interference" title="https://en.wikipedia.org/wiki/Catastrophic_interference" target="_blank" ref="nofollow noopener noreferrer">catastrophic forgetting</a>）；也就是说，模型实际上 “忘记”了 其基础知识，而过度依赖呈现在它面前的信息。以前的研究表明，当 prompt 非常长时，LLM 往往会失去焦点。</p>
<p>例如，Gemini 2.5 agent 支持百万 token 的窗口，但一旦上下文超过某个点（实验中约 100,000 token），它就开始<strong>过分重复过去的操作</strong>，而不是提出新解决方案。从某种意义上说，agent 成了其庞大历史的囚徒。它不断查看长长的过去操作日志（上下文）并模仿，而不是利用其基础训练知识来制定新的创新策略。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ac2b8677f84495e8ec1e39d4dea18a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=hp5m%2BB8rhbVJIZWipyu09h99TLY%3D" alt="" loading="lazy"/> Imgage source:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fstorage.googleapis.com%2Fdeepmind-media%2Fgemini%2Fgemini_v2_5_report.pdf" title="https://storage.googleapis.com/deepmind-media/gemini/gemini_v2_5_report.pdf" target="_blank" ref="nofollow noopener noreferrer">storage.googleapis.com/deepmind-me…</a> - page18.</p>
<p>这是适得其反的。我们希望模型使用相关上下文来辅助推理，而不是覆盖它的思考能力。值得注意的是，即使是拥有巨大窗口的模型，也会出现这种上下文衰减（<a href="https://link.juejin.cn?target=https%3A%2F%2Fresearch.trychroma.com%2Fcontext-rot" title="https://research.trychroma.com/context-rot" target="_blank" ref="nofollow noopener noreferrer">context rot</a>）：随着添加的 token 增多，其性能会不均匀下降。这似乎存在一个注意力预算。就像人类的工作记忆有限一样，LLM 对 token 的关注能力是有限的，当预算被拉伸时，其精度和专注度会下降。</p>
<p>作为缓解措施，可以通过分块（chunking）、工程化关键信息、定期上下文总结，以及使用评分评估和监控技术来防止上下文干扰。</p>
<p>这些方法让模型在相关上下文和基础训练之间保持扎实的基础，降低干扰风险，并提高整体推理质量。</p>
<h3 data-id="heading-7">上下文混淆</h3>
<p>上下文混淆是指上下文中多余内容被模型用于生成低质量响应的情况。一个典型例子是给 agent 提供大量工具或 API 定义。如果这些工具中有许多与当前任务无关，模型仍可能不适当地尝试使用它们，仅仅因为它们出现在上下文中。实验发现，如果提供的工具或文档超过实际需要，反而会损害性能。agent 可能开始出错，比如调用错误的函数或引用无关文本。</p>
<p>在一个案例中，一个小型 <strong>Llama 3.1 8B</strong> 模型在考虑 46 个工具时任务失败，但只给 19 个工具时却成功。额外的工具造成了混淆，即使上下文长度在限制范围内。根本问题是，prompt 中的任何信息都会被模型关注。如果模型不知道要忽略某些内容，这些内容可能以不希望的方式影响输出。无关信息可能 “抢走” 模型的注意力，使其偏离方向（例如，一个无关文档可能导致 agent 回答与问题不同的内容）。上下文混淆通常表现为模型生成融合无关上下文的低质量响应。参见研究论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2411.15399" title="https://arxiv.org/pdf/2411.15399" target="_blank" ref="nofollow noopener noreferrer">少即是多：优化边缘设备上LLM执行的函数调用</a>。</p>
<p>这提醒我们，更多的上下文并不总是更好，尤其是当它没有经过相关性<strong>筛选</strong>时。</p>
<h3 data-id="heading-8">上下文冲突</h3>
<p>上下文冲突是指<strong>上下文中的部分信息彼此矛盾</strong>，导致内部不一致，从而干扰模型的推理。当 agent 累积了多个相互冲突的信息时，就可能发生冲突。</p>
<p>例如，假设一个 agent 从两个来源获取数据：一个说航班 A 下午 5 点起飞，另一个说航班 A 下午 6 点起飞。如果这两个事实都出现在上下文中，模型无法判断哪个正确；它可能会困惑，或者生成错误或不一致的答案。</p>
<p>上下文冲突也常出现在多轮对话中，模型<strong>早期的回答</strong>尝试仍留在上下文中，而后续改进的信息也在上下文里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daeb5998c9614b98a2a82edc6660f34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=ShRPc4MNVro5NOMpqMr9brpf3uQ%3D" alt="" loading="lazy"/> Image source:  <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2505.06120" title="https://arxiv.org/pdf/2505.06120" target="_blank" ref="nofollow noopener noreferrer">LLMS gets lost in the mult-turn conversation</a> (Page04)</p>
<p>微软 和 Salesforce 的一项<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2505.06120" title="https://arxiv.org/pdf/2505.06120" target="_blank" ref="nofollow noopener noreferrer">研究表明</a>，如果把一个复杂查询拆分成多个 chatbot 轮次（逐步添加细节），最终准确率会显著下降，相比之下，把所有细节一次性放进一个 prompt 的效果更好。为什么？因为早期轮次中包含了模型给出的不完整或错误的中间答案，而这些内容会一直留在上下文中。当模型后来尝试在所有信息齐全的情况下作答时，它的记忆中仍然包含这些错误尝试，这些内容与修正后的信息发生冲突，导致模型偏离正确方向。本质上，对话的上下文与自身发生了冲突。模型可能会无意中使用过时的上下文片段（来自早期轮次），而这些内容在新信息加入后已经不再适用。</p>
<p>在 agent 系统中，上下文冲突尤其危险，因为 agent 可能会组合来自不同工具或子 agent 的输出。如果这些输出彼此不一致，聚合后的上下文就会变得不一致。agent 在试图调和这些矛盾时，可能会卡住或生成毫无意义的结果。防止上下文冲突需要确保上下文是<strong>最新且一致</strong>的，例如清除或更新任何过时的信息，并且不要混合未经一致性验证的来源。</p>
<h3 data-id="heading-9">上下文泄漏与知识冲突</h3>
<p>在多个 agent 或多个用户共享同一个记忆存储的系统中，信息在不同上下文之间相互泄漏是一个风险。</p>
<p>例如，如果两个不同用户的数据 embeddings 存在于同一个 vector database 中，但没有适当的访问控制，那么在回答用户 A 的查询时，agent 可能会意外检索到用户 B 的记忆。这种跨上下文泄漏可能暴露隐私信息，或者至少会让回答变得混乱。</p>
<p>根据 OWASP Top 10 for LLM Applications，多租户的 vector database 必须防范这种泄漏：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfce731ce6664250aac63244419d890f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=0ux%2BInQrE5t4U0BLrrnPBJ60pJg%3D" alt="" loading="lazy"/> Image source:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwtit.com%2Fblog%2F2025%2F04%2F17%2Fowasp-top-10-for-llm-applications-2025" title="https://wtit.com/blog/2025/04/17/owasp-top-10-for-llm-applications-2025" target="_blank" ref="nofollow noopener noreferrer">wtit.com/blog/2025/0…</a></p>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwtit.com%2Fblog%2F2025%2F04%2F17%2Fowasp-top-10-for-llm-applications-2025%2F" title="https://wtit.com/blog/2025/04/17/owasp-top-10-for-llm-applications-2025/" target="_blank" ref="nofollow noopener noreferrer">LLM08:2025 Vector 和 Embedding 弱点</a>，常见风险之一是上下文泄漏：</p>
<blockquote>
<p>在多租户环境中，多个用户类别或应用共享同一个 vector database 时，存在用户或查询之间发生上下文泄漏的风险。当来自多个数据源的数据相互矛盾时，可能会出现数据联邦的知识冲突错误。当 LLM 无法用 Retrieval Augmentation 获取的新数据覆盖其在训练期间学到的旧知识时，也会发生这种情况。</p>
</blockquote>
<p>另一个方面是，LLM 可能很难用 memory 中的新信息去覆盖它内置的知识。如果模型在训练时学过某个事实，而检索到的 context 说的是相反的内容，模型可能会混淆，不知道该信哪一个。如果没有合适的设计，agent 可能会混合不同的 context，或者无法用新的证据更新旧知识，从而导致陈旧或错误的答案。</p>
<h3 data-id="heading-10"><strong>幻觉（hallucinations）和错误信息（misinformation）</strong></h3>
<p>即使在没有长 context 的情况下，幻觉（LLM 编造看起来合理但实际上是错误的信息）也是一个已知问题，而糟糕的 memory 管理会放大这个问题。</p>
<p>如果 agent 的 memory 缺少一个关键事实，模型可能会<strong>用猜测来填补空白</strong>；而如果这个猜测随后进入了 context（污染了 context），错误就会持续存在。</p>
<p>OWASP LLM 安全报告（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwtit.com%2Fblog%2F2025%2F04%2F17%2Fowasp-top-10-for-llm-applications-2025%2F" title="https://wtit.com/blog/2025/04/17/owasp-top-10-for-llm-applications-2025/" target="_blank" ref="nofollow noopener noreferrer">LLM09:2025 Misinformation</a>）将错误信息列为一个核心漏洞：LLM 可能生成自信但捏造的答案，而用户可能会过度信任它们。一个拥有不良或过时 long-term memory 的 agent，可能会自信地引用去年还正确、但现在已经错误的信息，除非它的 memory 能保持更新。</p>
<p>用户或 agent 自身（在循环中）对 AI 输出的过度依赖，会让问题更加严重。如果没有人去检查 memory 里的信息，agent 可能会不断积累错误内容。这也是为什么常常使用 RAG 来减少幻觉：通过检索权威来源，模型就不必去编造事实。但如果检索拉取了错误的文档（例如包含错误信息的文档），或者早期的幻觉没有被清理，系统就可能在整个行动过程中传播这些错误信息。</p>
<p><strong>总结</strong>：未能正确管理 memory 会导致<strong>不正确和具有误导性的输出</strong>，而在高风险场景下（例如金融或医疗领域给出错误建议）尤其具有破坏性。一个 agent 需要有机制去验证或纠正其 memory 内容，而不是无条件地信任 context 中的任何信息。</p>
<p>总之，给 AI agent 一个无限长的 memory，或者把所有可能的东西一股脑丢进它的 context，并不是成功的做法。</p>
<h2 data-id="heading-11"><strong>LLM 应用中 memory 管理的最佳实践</strong></h2>
<p>为了避免上述问题，开发者和研究人员总结了一些用于<strong>管理 AI 系统中 context 和 memory 的最佳实践</strong>。这些实践的目标是让 AI 的工作 context 保持精简、相关且最新。下面是一些关键策略，以及它们如何发挥作用的示例。</p>
<h3 data-id="heading-12"><strong>RAG：使用有针对性的 context</strong></h3>
<p>前面的章节已经介绍了很多关于 RAG 的内容，这里作为一组简明的实践提醒：</p>
<ul>
<li>使用有针对性的检索，而不是批量加载：只检索最相关的 chunk，而不是把整个文档或完整的对话历史都塞进 prompt。</li>
<li>将 RAG 视为即时（just-in-time）的 memory 召回：只在需要时才拉取 context，而不是在多轮对话中一直携带所有内容。</li>
<li>优先使用与相关性相关的检索策略：例如 top-k 语义搜索、倒数排序融合（Reciprocal Rank Fusion），或 tool loadout 过滤，有助于减少噪声并提升 grounding。</li>
<li>更大的 context window 并不能消除对 RAG 的需求：两个高度相关的段落，几乎总是比 20 页松散相关的内容更有效。</li>
</ul>
<p>也就是说，RAG 的重点不是加入更多 context，而是加入<strong>正确的 context</strong>。</p>
<h3 data-id="heading-13"><strong>工具配置（ Tool loadout ）</strong></h3>
<p>工具配置是指只给模型完成某个任务<strong>真正需要的工具</strong>。这个术语来自游戏：你会选择一个适合当前情境的 loadout。工具太多会拖慢你；工具选错会直接失败。根据研究论文 <em><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2411.15399" title="https://arxiv.org/abs/2411.15399" target="_blank" ref="nofollow noopener noreferrer">Less is More</a></em>，LLM 的行为也是一样的。一旦工具数量超过约 30 个，描述就开始相互重叠，模型会变得困惑；超过约 100 个工具，几乎必然失败。这不是 context window 的问题，而是 <strong>context 混乱</strong>。</p>
<p>一个简单而有效的解决方案是 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2505.03275" title="https://arxiv.org/abs/2505.03275" target="_blank" ref="nofollow noopener noreferrer">RAG-MCP</a></strong>。与其把所有工具一股脑塞进 prompt，不如把工具描述存进向量数据库，然后每次请求只检索最相关的工具。实际效果是：loadout 保持小而聚焦，prompt 明显变短，工具选择的准确率最高可以提升到原来的 3 倍。</p>
<p>更小的模型会更早撞上这堵墙。研究显示，一个 8B 模型在面对几十个工具时会失败，但在精简 loadout 之后却能成功。动态选择工具 —— 有时先让 LLM 自己推理它需要哪些工具 —— 可以将性能提升 44%，同时降低功耗和延迟。结论是：大多数 agent 实际上只需要少量工具，但随着系统规模增长，工具配置和 RAG-MCP 会成为一等重要的设计决策。</p>
<h3 data-id="heading-14"><strong>Context 剪枝：限制聊天历史长度</strong></h3>
<p>如果一次对话持续很多轮，累积的聊天历史可能会变得太大，无法放入 context，或者对模型来说过于干扰。</p>
<p>Trimming（对话修剪） 指的是在对话不断增长时，以程序方式移除或缩短不那么重要的对话部分。一种最简单的形式是在达到某个限制时丢弃最早的对话轮次，只保留最近的 N 条消息。更复杂的剪枝方式可能会移除无关的岔题内容，或已经不再需要的旧指令。目标是<strong>让 context window 不被过时的信息弄乱</strong>。</p>
<p>例如，如果 agent 在 10 轮之前已经解决了一个子问题，而现在已经进入新的阶段，我们就可以把那一段历史从 context 中删除（前提是之后不再需要它）。许多基于聊天的实现都会这样做：它们维护一个滚动的最近消息窗口。</p>
<p>Trimming 也可以很简单，比如在对话被总结完成，或被判断为无关之后，就 “忘记” 最早的部分。这样做可以降低 context overflow 错误的风险，同时减少 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F15je2KBUgkYKuR2jxGVCGVaa2UhXzwL11cTv8ikC1-z8%2Fedit%3Ftab%3Dt.0%23heading%3Dh.kuopole01bum" title="https://docs.google.com/document/d/15je2KBUgkYKuR2jxGVCGVaa2UhXzwL11cTv8ikC1-z8/edit?tab=t.0#heading=h.kuopole01bum" target="_blank" ref="nofollow noopener noreferrer">context 干扰</a>，让模型不会被旧的或跑题的内容分散注意力。这种方式非常类似人类的行为：我们不会记住一小时演讲中的每一句话，但会保留重点。</p>
<p>如果你对 context 剪枝感到困惑，正如作者 Drew Breunig 提到的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dbreunig.com%2F2025%2F06%2F26%2Fhow-to-fix-your-context.html%23tool-loadout%3A~%3Atext%3DProvence%2520is%2520fast%252C%2520accurate%252C%2520simple%2520to%2520use%252C%2520and%2520relatively%2520small%2520%25E2%2580%2593%2520only%25201.75%2520GB.%2520You%2520can%2520call%2520it%2520in%2520a%2520few%2520lines%252C%2520like%2520so%253A" title="https://www.dbreunig.com/2025/06/26/how-to-fix-your-context.html#tool-loadout:~:text=Provence%20is%20fast%2C%20accurate%2C%20simple%20to%20use%2C%20and%20relatively%20small%20%E2%80%93%20only%201.75%20GB.%20You%20can%20call%20it%20in%20a%20few%20lines%2C%20like%20so%3A" target="_blank" ref="nofollow noopener noreferrer">那样</a>，使用 Provence（<code>[naver/provence-reranker-debertav3-v1](https://huggingface.co/naver/provence-reranker-debertav3-v1 "naver/provence-reranker-debertav3-v1")</code>）模型——一个轻量级（1.75 GB）、高效且准确的 context 剪枝器，用于 question answering —— 可以带来明显帮助。它可以根据给定 query，把大型文档裁剪为只包含最相关的文本。你可以在特定的时间间隔调用它。</p>
<p>下面是我们在代码中调用 <code>provence-reranker</code> 模型来剪枝 context 的方式：</p>
<pre><code class="hljs language-python" lang="python">`

<span class="hljs-number">1.</span>  <span class="hljs-comment"># Context pruning with Provence</span>
<span class="hljs-number">2.</span>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">prune_with_provence</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span>, threshold: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
<span class="hljs-number">3.</span>      <span class="hljs-string">"""
4.      Prune context using Provence reranker model

6.      Args:
7.          query: User's query/question
8.          context: Original context to prune
9.          threshold: Relevance threshold (0-1) for Provence reranker.
10.                     If None, uses args.pruning_threshold.
11.                     0.1 = conservative (recommended, no performance drop)
12.                     0.3-0.5 = moderate to aggressive pruning

14.      Returns:
15.          Pruned context with only relevant sentences
16.      """</span>
<span class="hljs-number">17.</span>      <span class="hljs-keyword">if</span> provence_model <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
<span class="hljs-number">18.</span>          <span class="hljs-keyword">return</span> context

<span class="hljs-number">20.</span>      <span class="hljs-keyword">if</span> threshold <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
<span class="hljs-number">21.</span>          threshold = args.pruning_threshold

<span class="hljs-number">23.</span>      <span class="hljs-keyword">try</span>:
<span class="hljs-number">24.</span>          <span class="hljs-comment"># Use Provence's process method</span>
<span class="hljs-number">25.</span>          provence_output = provence_model.process(
<span class="hljs-number">26.</span>              question=query,
<span class="hljs-number">27.</span>              context=context,
<span class="hljs-number">28.</span>              threshold=threshold,
<span class="hljs-number">29.</span>              always_select_title=<span class="hljs-literal">False</span>,
<span class="hljs-number">30.</span>              enable_warnings=<span class="hljs-literal">False</span>
<span class="hljs-number">31.</span>          )

<span class="hljs-number">33.</span>          <span class="hljs-comment"># Extract pruned context from output</span>
<span class="hljs-number">34.</span>          pruned_context = provence_output.get(<span class="hljs-string">'pruned_context'</span>, context)
<span class="hljs-number">35.</span>          reranking_score = provence_output.get(<span class="hljs-string">'reranking_score'</span>, <span class="hljs-number">0.0</span>)

<span class="hljs-number">37.</span>          <span class="hljs-comment"># Log statistics</span>
<span class="hljs-number">38.</span>          original_length = <span class="hljs-built_in">len</span>(context)
<span class="hljs-number">39.</span>          pruned_length = <span class="hljs-built_in">len</span>(pruned_context)
<span class="hljs-number">40.</span>          reduction_pct = ((original_length - pruned_length) / original_length * <span class="hljs-number">100</span>) <span class="hljs-keyword">if</span> original_length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

<span class="hljs-number">42.</span>          <span class="hljs-keyword">if</span> args.verbose:
<span class="hljs-number">43.</span>              rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[cyan]📊 Pruning stats: <span class="hljs-subst">{pruned_length}</span>/<span class="hljs-subst">{original_length}</span> chars (<span class="hljs-subst">{reduction_pct:<span class="hljs-number">.1</span>f}</span>% reduction, threshold=<span class="hljs-subst">{threshold:<span class="hljs-number">.2</span>f}</span>, rerank_score=<span class="hljs-subst">{reranking_score:<span class="hljs-number">.3</span>f}</span>)[/cyan]"</span>)

<span class="hljs-number">45.</span>          <span class="hljs-keyword">return</span> pruned_context <span class="hljs-keyword">if</span> pruned_context <span class="hljs-keyword">else</span> context

<span class="hljs-number">47.</span>      <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
<span class="hljs-number">48.</span>          rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[yellow]⚠️ Error in Provence pruning: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>[/yellow]"</span>)
<span class="hljs-number">49.</span>          rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[yellow]⚠️ Falling back to original context[/yellow]"</span>)
<span class="hljs-number">50.</span>          <span class="hljs-keyword">return</span> context

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)收起代码块![](https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png)
</code></pre>
<p>我们使用 Provence reranker 模型（<code>naver/provence-reranker-debertav3-v1</code>）来对句子的相关性进行打分。基于阈值的过滤会保留高于相关性阈值的句子。同时，我们引入了一个 fallback 机制：如果剪枝失败，就返回原始 context。最后，在 verbose 模式下，通过统计日志来跟踪 context 缩减的百分比。</p>
<h3 data-id="heading-15"><strong>Context 总结：压缩较旧的信息，而不是完全丢弃</strong></h3>
<p>Summarization 是 trimming 的一个配套方法。当历史记录或知识库变得过大时，你可以使用 LLM 生成一份关键点的简要总结，并在后续使用这份总结来替代完整内容，就像我们在上面的代码中所做的一样。</p>
<p>例如，如果一个 AI assistant 已经进行了 50 轮对话，那么在第 51 轮时，与其把全部 50 轮都发送给模型（很可能放不下），系统可以把第 1–40 轮交给模型生成一段总结，然后在下一次 prompt 中只提供这段总结加上最近的 10 轮对话。这样，模型仍然知道之前讨论了什么，而不需要每一个细节。早期的 chatbot 用户会手动这样做，比如问：“你能总结一下我们到目前为止聊过的内容吗？”然后在一个新的 session 中基于总结继续。现在，这个过程可以自动化完成。Summarization 不仅可以节省 context window 空间，还可以通过去除多余细节、只保留关键信息，来减少 <strong>context 混淆 / 干扰</strong>。</p>
<p>下面是我们如何使用 OpenAI 模型（你也可以使用任何 LLM）来压缩 context，在保留所有相关信息的同时，消除冗余和重复内容。</p>
<pre><code class="hljs language-python" lang="python">`

<span class="hljs-number">1.</span>  <span class="hljs-comment"># Context summarization</span>
<span class="hljs-number">2.</span>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_context</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
<span class="hljs-number">3.</span>      <span class="hljs-string">"""
4.      Summarize context using LLM to reduce duplication and focus on relevant information

6.      Args:
7.          query: User's query/question
8.          context: Context to summarize

10.      Returns:
11.          Summarized context
12.      """</span>
<span class="hljs-number">13.</span>      <span class="hljs-keyword">try</span>:
<span class="hljs-number">14.</span>          summary_prompt = <span class="hljs-string">f"""You are an expert at summarizing conversation context.

16.  Your task: Analyze the provided conversation context and produce a condensed summary that fully answers or supports the user's specific question.

18.  The summary must:
19.  1. Preserve every fact, detail, and information that directly relates to the question
20.  2. Eliminate redundancy and duplicate information
21.  3. Maintain chronological flow when relevant
22.  4. Focus on information that helps answer: "<span class="hljs-subst">{query}</span>"

24.  Context to summarize:
25.  <span class="hljs-subst">{context}</span>

27.  Provide a concise summary that preserves all relevant information:"""</span>

<span class="hljs-number">29.</span>          summary = llm.invoke(summary_prompt).content

<span class="hljs-number">31.</span>          <span class="hljs-keyword">if</span> args.verbose:
<span class="hljs-number">32.</span>              original_length = <span class="hljs-built_in">len</span>(context)
<span class="hljs-number">33.</span>              summary_length = <span class="hljs-built_in">len</span>(summary)
<span class="hljs-number">34.</span>              reduction_pct = ((original_length - summary_length) / original_length * <span class="hljs-number">100</span>) <span class="hljs-keyword">if</span> original_length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
<span class="hljs-number">35.</span>              rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[cyan]📝 Summarization stats: <span class="hljs-subst">{summary_length}</span>/<span class="hljs-subst">{original_length}</span> chars (<span class="hljs-subst">{reduction_pct:<span class="hljs-number">.1</span>f}</span>% reduction)[/cyan]"</span>)

<span class="hljs-number">37.</span>          <span class="hljs-keyword">return</span> summary

<span class="hljs-number">39.</span>      <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
<span class="hljs-number">40.</span>          rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[yellow]⚠️ Error in context summarization: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>[/yellow]"</span>)
<span class="hljs-number">41.</span>          rich.<span class="hljs-built_in">print</span>(<span class="hljs-string">f"[yellow]⚠️ Falling back to original context[/yellow]"</span>)
<span class="hljs-number">42.</span>          <span class="hljs-keyword">return</span> context

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>重要的是，当 context 被总结之后，模型就不太容易被琐碎的细节或过去的错误压垮（前提是 summary 是准确的）。</p>
<p>但是，summarization 必须非常小心。一个不好的 summary 可能会遗漏关键细节，甚至引入错误。本质上，这又是一次给模型的 prompt（“summarize this”），因此它可能会 hallucinate，或者丢失细微差别。最佳实践是<strong>增量式 summarization</strong>，并且可能要保留一些规范性的事实，不对它们做总结。</p>
<p>尽管如此，summarization 已被证明非常有用。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F15je2KBUgkYKuR2jxGVCGVaa2UhXzwL11cTv8ikC1-z8%2Fedit%3Ftab%3Dt.0%23heading%3Dh.kuopole01bum" title="https://docs.google.com/document/d/15je2KBUgkYKuR2jxGVCGVaa2UhXzwL11cTv8ikC1-z8/edit?tab=t.0#heading=h.kuopole01bum" target="_blank" ref="nofollow noopener noreferrer">在 Gemini agent 的场景中</a>，大约每 ~100k tokens 对 context 做一次总结，是对抗模型反复重复自身行为的一种方式。这个 summary 就像是对话或数据的压缩记忆。作为开发者，我们可以让 agent 定期调用一个 summarization 函数（可能是一个更小的 LLM，或者一个专用流程），对对话历史或长文档进行总结，然后用生成的 summary 替换 prompt 中的原始内容。这种策略被广泛用于保持 context 在限制范围内，并提炼关键信息。</p>
<h3 data-id="heading-16"><strong>Context 隔离（context quarantine）：在可能的情况下隔离 context</strong></h3>
<p>这一点在复杂的 agent 系统或多步骤 workflow 中尤其重要。Context segmentation 的思想是，把一个大任务拆分成更小、彼此隔离的任务，每个任务都有自己的 context，这样就不会积累一个包含所有信息的巨大 context。每个 subagent 或 subtask 都在一个高度聚焦的 context 中处理问题，然后由一个更高层的 agent、supervisor 或 coordinator 来整合这些结果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97373df8834e42ad9c1e8b3512540916~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769234088&amp;x-signature=uG7u2Xb1YmrUFYBplbP%2Bp2PY4Zo%3D" alt="" loading="lazy"/> 多 agent 架构实际运行：用户查询通过一个 lead agent 流动，该 agent 创建专门的 subagents 并行搜索不同方面。<br/>
图片来源: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fmulti-agent-research-system" title="https://www.anthropic.com/engineering/multi-agent-research-system" target="_blank" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fmulti-agent-research-system" title="https://www.anthropic.com/engineering/multi-agent-research-system" target="_blank" ref="nofollow noopener noreferrer">Anthropic 的研究策略使用多个 subagents</a>，每个 subagent 调查问题的不同方面，拥有自己的 context window，同时由一个 lead agent 阅读这些 subagents 的提炼结果。这种并行、模块化的方法意味着没有单一的 context window 会过于臃肿。它还减少了无关信息混入的可能性，每个线程保持主题相关（没有 context 混乱），在回答特定子问题时不会携带不必要的负担。从某种意义上说，这就像运行独立的思维线程，只共享结果，而不是整个思维过程。</p>
<p>在多 agent 系统中，这种方法至关重要。如果 Agent A 处理任务 A，Agent B 处理任务 B，除非确实需要，否则没有理由让任一 agent 消耗另一个的完整 context。相反，agents 只交换必要的信息。例如，Agent A 可以通过一个 supervisor agent 将其发现的综合总结传给 Agent B，同时每个 subagent 保持自己专用的 context 线程。这种设置不需要 human-in-the-loop 干预；它依赖于一个带启用工具的 supervisory agent，并进行最小且可控的 context 共享。</p>
<p>尽管如此，设计系统时让 agents 或工具以最小必要 context 重叠运行可以大大增强清晰度和性能。可以把它看作 AI 的 microservices，每个组件处理自己的 context，然后以可控方式传递消息，而不是一个单一庞大的 context。这些最佳实践通常结合使用。它还允许你修剪琐碎历史，总结重要的旧消息或对话，将详细日志卸载到 Elasticsearch 以供长期 context 使用，并在需要时通过检索取回相关内容。</p>
<p>如前所述，指导原则是 context 是有限且宝贵的资源。你希望 prompt 中的每个 token 都物有所值，即它应当提升输出质量。如果 memory 中的某些内容不起作用（或更糟，还会造成混乱），那么它应当被修剪、总结或排除。</p>
<p>作为开发者，我们现在可以像编程代码一样编程 context，决定包含哪些信息、如何格式化以及何时省略或更新。遵循这些实践，我们可以赋予 LLM agents 所需的 context，使其执行任务而不受前面描述的失败模式影响。结果是 agent 能记住应该记住的，忘记不需要的，并在需要时及时检索所需内容。</p>
<h2 data-id="heading-17">结论</h2>
<p>Memory 并不是你给 agent 添加的东西，而是你设计的东西。Short-term memory 是 agent 的工作草稿板，long-term memory 是其持久知识库。RAG 是两者之间的桥梁，将被动的数据存储（如 Elasticsearch）转化为可主动调用的机制，从而支持输出并保持 agent 的实时性。</p>
<p>但 memory 是把双刃剑。一旦你让 context 无限制增长，就会引入 poisoning、distraction、confusion 和 clash，在共享系统中甚至可能发生数据泄漏。这就是为什么最重要的 memory 工作不是 “存储更多”，而是 “更好地策划”：选择性检索、积极修剪、谨慎总结，并避免混合无关 context，除非任务确实要求。</p>
<p>在实践中，良好的 context engineering 就像良好的系统设计：更小、足够的 context，组件之间受控的接口，以及原始状态与实际希望模型看到的精炼状态之间的清晰分离。做得对，你不会得到一个记住一切的 agen t—— 你会得到一个在正确时间记住正确事情、出于正确原因的 agent。</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fagentic-memory-management-elasticsearch" title="https://www.elastic.co/search-labs/blog/agentic-memory-management-elasticsearch" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用15个技巧让Python程序飞速运行]]></title>    <link>https://juejin.cn/post/7595911076013801508</link>    <guid>https://juejin.cn/post/7595911076013801508</guid>    <pubDate>2026-01-17T05:57:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076013801508" data-draft-id="7460009465326239770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用15个技巧让Python程序飞速运行"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2026-01-17T05:57:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件测试杂谈"/> <meta itemprop="url" content="https://juejin.cn/user/4004881767865897"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用15个技巧让Python程序飞速运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4004881767865897/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件测试杂谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T05:57:45.000Z" title="Sat Jan 17 2026 05:57:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天我们就来聊聊如何用15个技巧让Python程序飞速运行。这些技巧不仅能让代码跑得更快，还能让你的编程思维更加严谨。</p>
<h2 data-id="heading-0">1. 使用内置函数和库</h2>
<p>Python自带了很多高效的内置函数和库，它们通常比你自己写的代码要快得多。尽量使用这些现成的工具，而不是自己重新发明轮子。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不推荐：手动计算列表元素之和</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_list_manual</span>(<span class="hljs-params">lst</span>):
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> lst:
        total += num
    <span class="hljs-keyword">return</span> total

<span class="hljs-comment"># 推荐：使用内置sum函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_list_builtin</span>(<span class="hljs-params">lst</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(lst)

<span class="hljs-comment"># 测试</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
<span class="hljs-built_in">print</span>(sum_list_manual(numbers))  <span class="hljs-comment"># 输出: 15</span>
<span class="hljs-built_in">print</span>(sum_list_builtin(numbers))  <span class="hljs-comment"># 输出: 15</span>
</code></pre>
<h2 data-id="heading-1">2. 使用列表推导式代替循环</h2>
<p>列表推导式不仅更简洁，而且执行速度也更快。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 不推荐：使用for循环创建平方数列表</span>
<span class="hljs-attr">squares_loop</span> = []
for i in range(10):
    squares_loop.append(i ** 2)

<span class="hljs-comment"># 推荐：使用列表推导式</span>
<span class="hljs-attr">squares_comprehension</span> = [i ** <span class="hljs-number">2</span> for i in range(<span class="hljs-number">10</span>)]

print(squares_loop)  <span class="hljs-comment"># 输出: [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
print(squares_comprehension)  <span class="hljs-comment"># 输出: [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
</code></pre>
<h2 data-id="heading-2">3. 使用生成器表达式节省内存</h2>
<p>当你处理大数据集时，生成器表达式可以节省大量内存，因为它只在需要时生成数据。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不推荐：使用列表存储所有平方数</span>
squares_list = [i ** <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]

<span class="hljs-comment"># 推荐：使用生成器表达式</span>
squares_generator = (i ** <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))

<span class="hljs-comment"># 计算总和</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">sum</span>(squares_list))  <span class="hljs-comment"># 需要大量内存</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">sum</span>(squares_generator))  <span class="hljs-comment"># 内存使用较少</span>
</code></pre>
<h2 data-id="heading-3">4. 使用<code>set</code>进行成员检查</h2>
<p>集合（<code>set</code>）的数据结构查找元素的时间复杂度是O(1)，而列表（<code>list</code>）是O(n)。因此，如果需要频繁进行成员检查，使用<code>set</code>会更快。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不推荐：使用列表进行成员检查</span>
my_list = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))
<span class="hljs-keyword">if</span> <span class="hljs-number">999999</span> <span class="hljs-keyword">in</span> my_list:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Found!"</span>)

<span class="hljs-comment"># 推荐：使用集合进行成员检查</span>
my_set = <span class="hljs-built_in">set</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))
<span class="hljs-keyword">if</span> <span class="hljs-number">999999</span> <span class="hljs-keyword">in</span> my_set:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Found!"</span>)
</code></pre>
<h2 data-id="heading-4">5. 使用字典代替多重条件判断</h2>
<p>当有多个条件判断时，可以考虑使用字典来简化代码，并提高效率。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不推荐：使用多重if-else</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_grade</span>(<span class="hljs-params">score</span>):
    <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">90</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'A'</span>
    <span class="hljs-keyword">elif</span> score &gt;= <span class="hljs-number">80</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'B'</span>
    <span class="hljs-keyword">elif</span> score &gt;= <span class="hljs-number">70</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'C'</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'D'</span>

<span class="hljs-comment"># 推荐：使用字典映射</span>
grade_mapping = {
    (<span class="hljs-number">90</span>, <span class="hljs-number">100</span>): <span class="hljs-string">'A'</span>,
    (<span class="hljs-number">80</span>, <span class="hljs-number">89</span>): <span class="hljs-string">'B'</span>,
    (<span class="hljs-number">70</span>, <span class="hljs-number">79</span>): <span class="hljs-string">'C'</span>,
    (<span class="hljs-number">0</span>, <span class="hljs-number">69</span>): <span class="hljs-string">'D'</span>
}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_grade_dict</span>(<span class="hljs-params">score</span>):
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> grade_mapping.items():
        <span class="hljs-keyword">if</span> key[<span class="hljs-number">0</span>] &lt;= score &lt;= key[<span class="hljs-number">1</span>]:
            <span class="hljs-keyword">return</span> value

<span class="hljs-built_in">print</span>(get_grade(<span class="hljs-number">85</span>))  <span class="hljs-comment"># 输出: B</span>
<span class="hljs-built_in">print</span>(get_grade_dict(<span class="hljs-number">85</span>))  <span class="hljs-comment"># 输出: B</span>
</code></pre>
<h2 data-id="heading-5">6. 使用局部变量提高性能</h2>
<p>局部变量的访问速度比全局变量快。因此，在循环中尽量使用局部变量。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 不推荐：使用全局变量</span>
global_var = <span class="hljs-number">10</span>
<span class="hljs-function">def <span class="hljs-title">increment_global</span>():
    <span class="hljs-keyword">global</span> global_var
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-title">range</span>(<span class="hljs-params"><span class="hljs-number">1000000</span></span>):
        global_var +</span>= <span class="hljs-number">1</span>

<span class="hljs-meta"># 推荐：使用局部变量</span>
<span class="hljs-function">def <span class="hljs-title">increment_local</span>():
    local_var</span> = <span class="hljs-number">10</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-function"><span class="hljs-keyword">in</span> <span class="hljs-title">range</span>(<span class="hljs-params"><span class="hljs-number">1000000</span></span>):
        local_var +</span>= <span class="hljs-number">1</span>

increment_global()  <span class="hljs-meta"># 较慢</span>
increment_local()   <span class="hljs-meta"># 较快</span>
</code></pre>
<h2 data-id="heading-6">7. 使用<code>functools.lru_cache</code>缓存结果</h2>
<p>对于耗时的函数调用，可以使用<code>functools.lru_cache</code>来缓存结果，避免重复计算。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> functools

<span class="hljs-comment"># 不推荐：每次调用都重新计算</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fibonacci(n-<span class="hljs-number">1</span>) + fibonacci(n-<span class="hljs-number">2</span>)

<span class="hljs-comment"># 推荐：使用缓存</span>
<span class="hljs-meta">@functools.lru_cache(<span class="hljs-params">maxsize=<span class="hljs-literal">None</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci_cached</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fibonacci_cached(n-<span class="hljs-number">1</span>) + fibonacci_cached(n-<span class="hljs-number">2</span>)

<span class="hljs-built_in">print</span>(fibonacci(<span class="hljs-number">30</span>))  <span class="hljs-comment"># 较慢</span>
<span class="hljs-built_in">print</span>(fibonacci_cached(<span class="hljs-number">30</span>))  <span class="hljs-comment"># 较快</span>
</code></pre>
<h2 data-id="heading-7">8. 使用<code>numpy</code>处理数值计算</h2>
<p><code>numpy</code>是一个专门用于科学计算的库，它提供了高效的数组操作功能。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-lua" lang="lua">import numpy as np

# 不推荐：使用纯Python列表进行矩阵乘法
matrix_a = <span class="hljs-string">[[1, 2], [3, 4]]</span>
matrix_b = <span class="hljs-string">[[5, 6], [7, 8]]</span>

result = <span class="hljs-string">[[0, 0], [0, 0]]</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-built_in">len</span>(matrix_a)):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-built_in">len</span>(matrix_b[<span class="hljs-number">0</span>])):
        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> range(<span class="hljs-built_in">len</span>(matrix_b)):
            result[i][j] += matrix_a[i][k] * matrix_b[k][j]

# 推荐：使用numpy进行矩阵乘法
matrix_a_np = np.array(matrix_a)
matrix_b_np = np.array(matrix_b)
result_np = np.dot(matrix_a_np, matrix_b_np)

<span class="hljs-built_in">print</span>(result)  # 输出: <span class="hljs-string">[[19, 22], [43, 50]]</span>
<span class="hljs-built_in">print</span>(result_np)  # 输出: <span class="hljs-string">[[19 22] [43 50]]</span>
</code></pre>
<h2 data-id="heading-8">9. 使用<code>pandas</code>处理数据</h2>
<p><code>pandas</code>是一个强大的数据分析库，特别适合处理表格数据。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">import pandas as pd

<span class="hljs-comment"># 不推荐：使用纯Python字典和列表处理数据</span>
<span class="hljs-attr">data</span> = {<span class="hljs-string">'Name'</span>: [<span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'Charlie'</span>], <span class="hljs-string">'Age'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">35</span>]}
<span class="hljs-attr">ages</span> = [age for age in data[<span class="hljs-string">'Age'</span>] if age &gt; <span class="hljs-number">30</span>]

<span class="hljs-comment"># 推荐：使用pandas处理数据</span>
<span class="hljs-attr">df</span> = pd.DataFrame(data)
<span class="hljs-attr">filtered_df</span> = df[df[<span class="hljs-string">'Age'</span>] &gt; <span class="hljs-number">30</span>]

print(ages)  <span class="hljs-comment"># 输出: [35]</span>
print(filtered_df)  <span class="hljs-comment"># 输出:      Name  Age</span>
                 <span class="hljs-comment"># 2  Charlie   35</span>
</code></pre>
<h2 data-id="heading-9">10. 使用<code>multiprocessing</code>进行并行处理</h2>
<p>如果你的任务是可以并行化的，那么使用<code>multiprocessing</code>模块可以显著提高性能。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing

<span class="hljs-keyword">def</span> <span class="hljs-title function_">square</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x ** <span class="hljs-number">2</span>

<span class="hljs-comment"># 不推荐：串行处理</span>
results_serial = [square(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]

<span class="hljs-comment"># 推荐：并行处理</span>
pool = multiprocessing.Pool()
results_parallel = pool.<span class="hljs-built_in">map</span>(square, <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
pool.close()
pool.join()

<span class="hljs-built_in">print</span>(results_serial)  <span class="hljs-comment"># 输出: [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
<span class="hljs-built_in">print</span>(results_parallel)  <span class="hljs-comment"># 输出: [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
</code></pre>
<h2 data-id="heading-10">11. 使用<code>asyncio</code>进行异步编程</h2>
<p>对于I/O密集型任务，使用<code>asyncio</code>可以提高程序的响应速度。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Data fetched"</span>

<span class="hljs-comment"># 不推荐：同步等待</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sync_fetch</span>():
    <span class="hljs-keyword">import</span> time
    time.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Data fetched"</span>

<span class="hljs-comment"># 推荐：异步等待</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    result = <span class="hljs-keyword">await</span> fetch_data()
    <span class="hljs-built_in">print</span>(result)

asyncio.run(main())  <span class="hljs-comment"># 输出: Data fetched</span>
</code></pre>
<h2 data-id="heading-11">12. 使用<code>cython</code>编译Python代码</h2>
<p><code>cython</code>可以将Python代码编译成C代码，从而提高执行速度。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不推荐：纯Python代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_function</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(i * i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n))

<span class="hljs-comment"># 推荐：使用Cython编译</span>
<span class="hljs-comment"># 在文件slow_function.pyx中定义</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fast_function</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> n</span>):
    cdef <span class="hljs-built_in">int</span> i, result = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        result += i * i
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 编译并导入</span>
<span class="hljs-keyword">from</span> distutils.core <span class="hljs-keyword">import</span> setup
<span class="hljs-keyword">from</span> Cython.Build <span class="hljs-keyword">import</span> cythonize

setup(ext_modules=cythonize(<span class="hljs-string">"slow_function.pyx"</span>))

<span class="hljs-keyword">from</span> slow_function <span class="hljs-keyword">import</span> fast_function

<span class="hljs-built_in">print</span>(slow_function(<span class="hljs-number">1000000</span>))  <span class="hljs-comment"># 较慢</span>
<span class="hljs-built_in">print</span>(fast_function(<span class="hljs-number">1000000</span>))  <span class="hljs-comment"># 较快</span>
</code></pre>
<h2 data-id="heading-12">13. 使用<code>numba</code>加速数值计算</h2>
<p><code>numba</code>可以通过即时编译技术加速数值计算。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numba

<span class="hljs-meta">@numba.jit</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fast_sum</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-comment"># 不推荐：纯Python加法</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_sum</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-built_in">print</span>(slow_sum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>))  <span class="hljs-comment"># 输出: 30</span>
<span class="hljs-built_in">print</span>(fast_sum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>))  <span class="hljs-comment"># 输出: 30</span>
</code></pre>
<h2 data-id="heading-13">14. 使用<code>cProfile</code>进行性能分析</h2>
<p>在优化代码之前，先使用<code>cProfile</code>找出瓶颈所在。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">import</span> cProfile

def <span class="hljs-title">profile_me</span><span class="hljs-params">()</span>:
    total =</span> <span class="hljs-number">0</span>
    <span class="hljs-function"><span class="hljs-keyword">for</span> i in <span class="hljs-title">range</span><span class="hljs-params">(<span class="hljs-number">1000000</span>)</span>:
        total +=</span> i
    <span class="hljs-keyword">return</span> total

cProfile.<span class="hljs-built_in">run</span>(<span class="hljs-string">'profile_me()'</span>)
</code></pre>
<h2 data-id="heading-14">15. 使用<code>line_profiler</code>进行逐行分析</h2>
<p><code>line_profiler</code>可以帮助你找到具体哪一行代码最耗时。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 安装line_profiler</span>
<span class="hljs-comment"># pip install line_profiler</span>

@profile
def function_to_profile():
    <span class="hljs-attr">a</span> = <span class="hljs-number">2</span>
    <span class="hljs-attr">b</span> = <span class="hljs-number">3</span>
    <span class="hljs-attr">c</span> = a + b
    return c

function_to_profile()
</code></pre>
<h2 data-id="heading-15">实战案例：优化图像处理算法</h2>
<p>假设你需要编写一个图像处理程序，将一张图片转换为灰度图。我们来看一下如何应用上述技巧来优化这个过程。</p>
<p><strong>原始代码：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">from PIL <span class="hljs-keyword">import</span> Image

def <span class="hljs-title">to_grayscale</span><span class="hljs-params">(image_path)</span>:
    image =</span> Image.<span class="hljs-built_in">open</span>(image_path)
    width, height = image.size
    grayscale_image = Image.<span class="hljs-built_in">new</span>(<span class="hljs-string">'L'</span>, (width, height))

    <span class="hljs-keyword">for</span> x in <span class="hljs-built_in">range</span>(width):
        <span class="hljs-keyword">for</span> y in <span class="hljs-built_in">range</span>(height):
            r, g, b = image.<span class="hljs-built_in">getpixel</span>((x, y))
            gray = <span class="hljs-built_in">int</span>(<span class="hljs-number">0.299</span> * r + <span class="hljs-number">0.587</span> * g + <span class="hljs-number">0.114</span> * b)
            grayscale_image.<span class="hljs-built_in">putpixel</span>((x, y), gray)

    grayscale_image.<span class="hljs-built_in">save</span>(<span class="hljs-string">'grayscale.jpg'</span>)

<span class="hljs-built_in">to_grayscale</span>(<span class="hljs-string">'input.jpg'</span>)
</code></pre>
<p><strong>优化后的代码：</strong></p>
<pre><code class="hljs language-scss" lang="scss">import numpy as np
from PIL import Image

def <span class="hljs-built_in">to_grayscale_optimized</span>(image_path):
    image = Image.<span class="hljs-built_in">open</span>(image_path).<span class="hljs-built_in">convert</span>(<span class="hljs-string">'RGB'</span>)
    image_array = np.<span class="hljs-built_in">array</span>(image)
    grayscale_array = np.<span class="hljs-built_in">dot</span>(image_array[..., :<span class="hljs-number">3</span>], [<span class="hljs-number">0.299</span>, <span class="hljs-number">0.587</span>, <span class="hljs-number">0.114</span>]).<span class="hljs-built_in">astype</span>(np.uint8)
    grayscale_image = Image.<span class="hljs-built_in">fromarray</span>(grayscale_array, <span class="hljs-string">'L'</span>)
    grayscale_image.<span class="hljs-built_in">save</span>(<span class="hljs-string">'grayscale.jpg'</span>)

<span class="hljs-built_in">to_grayscale_optimized</span>(<span class="hljs-string">'input.jpg'</span>)
</code></pre>
<p>在这个实战案例中，我们使用了<code>numpy</code>来进行高效的数组操作，避免了显式的双重循环，从而大大提高了程序的运行速度。</p>
<h2 data-id="heading-16">总结</h2>
<p>本文介绍了15个让Python程序飞速运行的技巧，包括使用内置函数和库、列表推导式、生成器表达式、集合成员检查、字典映射、局部变量、缓存结果、<code>numpy</code>和<code>pandas</code>库、并行和异步处理、<code>cython</code>和<code>numba</code>编译、性能分析工具等。通过这些技巧，你可以写出更高效、更优雅的Python代码。</p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13967704.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13967704.html" target="_blank">测试新人可以学习《测试人的 Python 工具书》书籍</a>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13543572.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13543572.html" target="_blank">《性能测试 JMeter 实战》书籍</a></strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝“面条代码”：NestJS 是如何用 DI 和模块化重塑 Node.js 后端的？]]></title>    <link>https://juejin.cn/post/7595808703074140186</link>    <guid>https://juejin.cn/post/7595808703074140186</guid>    <pubDate>2026-01-17T05:57:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595808703074140186" data-draft-id="7595831738234273801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝“面条代码”：NestJS 是如何用 DI 和模块化重塑 Node.js 后端的？"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-01-17T05:57:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝“面条代码”：NestJS 是如何用 DI 和模块化重塑 Node.js 后端的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T05:57:47.000Z" title="Sat Jan 17 2026 05:57:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：在 Node.js 生态中，Express 和 Koa 统治了多年。它们简单灵活，但在面对大型企业级项目时，开发者往往会陷入“架构混乱”、“依赖耦合”、“缺乏规范”的泥潭。</p>
<p><strong>NestJS</strong> 的出现，将后端开发从“脚本式”转向了真正的“工程化”。它不仅仅是一个框架，更是一套融合了 OOP（面向对象）、FP（函数式编程）和 FRP（函数响应式编程）的架构哲学。本文将带你深入 NestJS 的核心，理解那些精妙的设计模式。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、工厂模式与入口设计：一切从 <code>main.ts</code> 说起</h2>
<p>很多新手看到 <code>main.ts</code> 觉得平平无奇，但这里藏着 NestJS 的第一个设计模式：<strong>工厂模式</strong>。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3000</span>);
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h3 data-id="heading-1">1. 为什么是 <code>NestFactory</code>？</h3>
<p>NestJS 并没有让我们直接 <code>new App()</code>，而是通过 <code>NestFactory.create()</code> 来构建应用。这不仅仅是为了创建一个实例，它在幕后完成了关键的<strong>初始化工作</strong>：</p>
<ul>
<li><strong>IoC 容器装载</strong>：扫描整个模块树，解析所有类之间的依赖关系。</li>
<li><strong>平台无关性</strong>：NestJS 默认基于 Express，但可以通过工厂轻松切换到底层更快的 Fastify，而无需修改业务代码。</li>
</ul>
<h3 data-id="heading-2">2. <code>??</code> 运算符的深意</h3>
<p>注意 <code>process.env.PORT ?? 3000</code>。这是 ES2020 的空值合并运算符。</p>
<ul>
<li><strong>传统写法</strong>：<code>PORT || 3000</code>。如果环境变量误传了 <code>0</code>，<code>||</code> 会将其视为假值从而使用 3000，导致逻辑错误。</li>
<li><strong>严谨写法</strong>：<code>??</code> 仅在 <code>undefined</code> 或 <code>null</code> 时回退。这体现了企业级开发中对<strong>配置严谨性</strong>的要求。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、模块系统：乐高积木式的架构基石</h2>
<p>在 Express 中，我们常通过文件夹来组织代码；而在 NestJS 中，<strong>Module（模块）</strong> 是组织代码的物理边界。</p>
<p>TypeScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Module</span>({
  <span class="hljs-attribute">imports</span>: [UsersModule, DatabaseModule], <span class="hljs-comment">// 导入其他模块</span>
  <span class="hljs-attribute">controllers</span>: [AppController],           <span class="hljs-comment">// 注册控制器</span>
  <span class="hljs-attribute">providers</span>: [AppService],                <span class="hljs-comment">// 注册服务</span>
  <span class="hljs-attribute">exports</span>: [AppService]                   <span class="hljs-comment">// 导出服务供其他模块使用</span>
})
export class AppModule {}
</code></pre>
<h3 data-id="heading-4">架构思考：为什么要强制模块化？</h3>
<ol>
<li><strong>依赖隔离</strong>：每个模块就像一个独立的“微服务”单元，拥有自己的上下文。</li>
<li><strong>显式依赖</strong>：通过 <code>imports</code> 和 <code>exports</code>，模块间的依赖关系清晰可见，拒绝“隐式引用”带来的维护噩梦。</li>
<li><strong>循环依赖检测</strong>：NestJS 在编译期就能利用模块图谱检测出 A 依赖 B，B 依赖 A 的死锁问题。</li>
</ol>
<hr/>
<h2 data-id="heading-5">三、核心灵魂：依赖注入 (Dependency Injection)</h2>
<p>这是 NestJS 最劝退新手，也是最强大的特性。</p>
<h3 data-id="heading-6">1. 什么是 DI？</h3>
<ul>
<li><strong>控制反转 (IoC)</strong> ：不要自己在代码里 <code>new Service()</code>，而是向框架“申请”一个 Service。</li>
<li><strong>依赖注入 (DI)</strong> ：框架（IoC 容器）在运行时，自动把你需要的对象塞给你。</li>
</ul>
<h3 data-id="heading-7">2. 实战对比</h3>
<p><strong>❌ 传统写法（强耦合）：</strong></p>
<p>TypeScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {
  <span class="hljs-keyword">private</span> appService;
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.appService = new AppService(); <span class="hljs-comment">// 自己创建，难以测试，难以替换</span>
  }
}
</code></pre>
<p><strong>✅ NestJS 写法（松耦合）：</strong></p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {
  <span class="hljs-comment">// 只需要声明类型，NestJS 自动注入实例</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> appService: AppService</span>) {} 
}
</code></pre>
<h3 data-id="heading-8">3. 高级玩法：自定义 Provider</h3>
<p>DI 不仅仅能注入类，还能注入<strong>值</strong>或<strong>异步连接</strong>（如数据库连接池）。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// database.module.ts</span>
<span class="hljs-keyword">const</span> dbProvider = {
  <span class="hljs-attr">provide</span>: <span class="hljs-string">'PG_CONNECTION'</span>, <span class="hljs-comment">// 令牌 (Token)</span>
  <span class="hljs-attr">useValue</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pool</span>({ <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>, ... }) <span class="hljs-comment">// 直接注入一个连接池实例</span>
};

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [dbProvider],
  <span class="hljs-attr">exports</span>: [<span class="hljs-string">'PG_CONNECTION'</span>] <span class="hljs-comment">// 导出给其他模块用</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseModule</span> {}
</code></pre>
<p>在 Service 中使用：</p>
<p>TypeScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">constructor</span>(<span class="hljs-variable">@Inject</span>(<span class="hljs-string">'PG_CONNECTION'</span>) private <span class="hljs-attribute">conn</span>: Pool) {}
</code></pre>
<p>这种设计让第三方库的集成变得异常优雅且易于管理。</p>
<hr/>
<h2 data-id="heading-9">四、装饰器</h2>
<p>NestJS 代码里到处都是 <code>@Get</code>, <code>@Controller</code>, <code>@Injectable</code>。这些<strong>装饰器 (Decorators)</strong> 到底是什么？</p>
<p>它们本质上是<strong>元数据 (Metadata) 的载体</strong>。</p>
<p>当你在类上写 <code>@Controller('cats')</code> 时，NestJS 并不会修改这个类，而是通过 <code>Reflect Metadata</code> API 在这个类上打了一个“标签”。</p>
<p><strong>运行流程解析：</strong></p>
<ol>
<li><strong>编译期</strong>：TS 保留装饰器信息。</li>
<li><strong>启动时</strong>：NestJS 扫描所有类，读取这些元数据。</li>
<li><strong>路由映射</strong>：发现 <code>@Get('list')</code>，就自动生成一条 <code>GET /cats/list</code> 的路由规则。</li>
</ol>
<p>这种<strong>声明式编程</strong>大大减少了样板代码，让开发者专注于业务逻辑而非底层实现。</p>
<hr/>
<h2 data-id="heading-10">五、HTTP 语义化：RESTful 的最佳实践</h2>
<p>NestJS 严格遵循 RESTful 规范，提供了完整的动词装饰器。</p>









































<table><thead><tr><th><strong>装饰器</strong></th><th><strong>对应动作</strong></th><th><strong>语义场景</strong></th><th><strong>架构师备注</strong></th></tr></thead><tbody><tr><td><code>@Get()</code></td><td>GET</td><td>查询资源</td><td>幂等，不应产生副作用</td></tr><tr><td><code>@Post()</code></td><td>POST</td><td>创建资源</td><td>非幂等，常用于新建</td></tr><tr><td><code>@Put()</code></td><td>PUT</td><td><strong>全量</strong>替换</td><td>幂等，例如上传新头像覆盖旧头像</td></tr><tr><td><code>@Patch()</code></td><td>PATCH</td><td><strong>局部</strong>更新</td><td>非幂等，例如只修改用户的昵称字段</td></tr><tr><td><code>@Delete()</code></td><td>DELETE</td><td>删除资源</td><td>幂等</td></tr></tbody></table>
<p><strong>面试重点：PUT vs PATCH</strong></p>
<ul>
<li><strong>PUT</strong> 是“整体覆盖”，如果只传了 <code>name</code> 没传 <code>age</code>，<code>age</code> 可能会被置空。</li>
<li><strong>PATCH</strong> 是“差量补丁”，只更新你传递的字段。</li>
<li>在 NestJS DTO 设计中，PUT 的 DTO 字段通常全是必填的，而 PATCH 的 DTO 字段全是可选的 (<code>@IsOptional()</code>)。</li>
</ul>
<hr/>
<h2 data-id="heading-11">六、数据库集成：全局模块与单例模式</h2>
<p>在企业级应用中，数据库连接（Database Connection）是典型的<strong>基础设施资源</strong>。我们不希望每个模块都去建立一个新的连接池。</p>
<h3 data-id="heading-12">最佳实践：<code>@Global()</code></h3>
<p>TypeScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Global</span>() <span class="hljs-comment">// 关键：标记为全局模块</span>
<span class="hljs-variable">@Module</span>({
  <span class="hljs-attribute">providers</span>: [...databaseProviders],
  <span class="hljs-attribute">exports</span>: [...databaseProviders],
})
export class DatabaseModule {}
</code></pre>
<p><strong>设计哲学：</strong></p>
<ul>
<li><strong>全局单例</strong>：加上 <code>@Global()</code> 后，<code>DatabaseModule</code> 只需要在 <code>AppModule</code> 导入一次，全应用的所有模块都可以直接使用其导出的 Provider，无需重复导入。</li>
<li><strong>性能优化</strong>：确保整个应用只维护一个数据库连接池，避免连接数爆炸。</li>
</ul>
<hr/>
<h2 data-id="heading-13">七、结语</h2>
<p>NestJS 的学习曲线虽然比 Express 陡峭，但它带来的回报是巨大的。</p>
<ul>
<li><strong>从“怎么写”到“怎么设计”</strong> ：它强迫你去思考代码的结构、边界和依赖。</li>
<li><strong>从“单兵作战”到“团队协作”</strong> ：规范化的架构使得团队成员可以无缝衔接彼此的代码。</li>
</ul>
<p>当你掌握了 <strong>工厂模式</strong> 的启动流程、<strong>模块化</strong> 的组织方式、<strong>依赖注入</strong> 的解耦思维以及 <strong>装0  饰器</strong> 的元编程能力，你就真正推开了企业级 Node.js 开发的大门。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java广播 —如何利用广播做服务发现]]></title>    <link>https://juejin.cn/post/7595858760133738559</link>    <guid>https://juejin.cn/post/7595858760133738559</guid>    <pubDate>2026-01-17T06:11:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858760133738559" data-draft-id="7595868336594960403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java广播 —如何利用广播做服务发现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T06:11:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户98512003583"/> <meta itemprop="url" content="https://juejin.cn/user/1927871600799337"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java广播 —如何利用广播做服务发现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927871600799337/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户98512003583
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:11:25.000Z" title="Sat Jan 17 2026 06:11:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>通过广播可以在局域网内广播信息，广播接收端通过监听广播信息，可以自动发现局域网内所有的设备/服务信息。</p>
</blockquote>
<h2 data-id="heading-0">1. 发送广播</h2>
<p>在 Java 中通过将 DatagramSocket 设置 <code>setBroadcast(true)</code> 来发送广播。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">DatagramSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramSocket</span>();
socket.setBroadcast(<span class="hljs-literal">true</span>);
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 广播内容</span>
<span class="hljs-type">byte</span>[] broadcastContent = <span class="hljs-string">"广播内容"</span>.getBytes();
<span class="hljs-comment">// 发送广播的指定端口</span>
<span class="hljs-type">int</span> <span class="hljs-variable">broadcastPort</span> <span class="hljs-operator">=</span> <span class="hljs-number">12135</span>;
<span class="hljs-comment">// 发送广播的地址</span>
<span class="hljs-type">InetAddress</span> <span class="hljs-variable">broadcastAddress</span> <span class="hljs-operator">=</span> InetAddress.getByName(<span class="hljs-string">"255.255.255.255"</span>);
<span class="hljs-comment">// 构建广播数据包</span>
<span class="hljs-type">DatagramPacket</span> <span class="hljs-variable">packet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramPacket</span>(broadcastContent, broadcastContent.length,  broadcastAddress, broadcastPort);
socket.send(pocket);
</code></pre>
<ul>
<li>broadcastAddress(255.255.255.255): 表示发送到本地网络中的所有设备，并且不会被路由器转发到其他网络，意味着该网络数据包会广播到局域网中的所有设备。</li>
<li>broadcastPort(12135): 表示发送到该端口，广播数据包只能发送到一个端口，不能发送到多个端口。</li>
</ul>
<p>除了通过 255.255.255.255 也可以设置发送到指定的子网的所有主机。如： 192.168.1.255。
可以通过以下方式获取当前主机所在子网的所有广播地址列表。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;InetAddress&gt; <span class="hljs-title function_">listAllBroadcastAddresses</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SocketException {  
    List&lt;InetAddress&gt; broadcastList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-comment">// 获取所有的网络接口  </span>
    Enumeration&lt;NetworkInterface&gt; interfaces = NetworkInterface.getNetworkInterfaces();  
    <span class="hljs-keyword">while</span> (interfaces.hasMoreElements()) {  
        <span class="hljs-type">NetworkInterface</span> <span class="hljs-variable">networkInterface</span> <span class="hljs-operator">=</span> interfaces.nextElement();  
		<span class="hljs-comment">// 剔除本地回环地址(127.0.0.1) 以及未启用的接口</span>
        <span class="hljs-keyword">if</span> (networkInterface.isLoopback() || !networkInterface.isUp()) {  
            <span class="hljs-keyword">continue</span>;  
        }  
		<span class="hljs-comment">// 提取每个地址的广播地址</span>
        networkInterface.getInterfaceAddresses().stream()  
                .map(InterfaceAddress::getBroadcast)  
                .filter(Objects::nonNull)  
                .forEach(broadcastList::add);  
    }  
    <span class="hljs-keyword">return</span> broadcastList;  
}
</code></pre>
<p>这样就可以从列表中选择向哪一个子网发送广播信息，或是遍历列表都发送。</p>
<h2 data-id="heading-1">2. 接收广播</h2>
<p>接收广播同样是通过 DatagramSocket 类，但不需要设置为广播模式，需要监听本地端口，这个端口也就是广播发送端广播的端口。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 监听端口</span>
<span class="hljs-type">DatagramSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramSocket</span>(<span class="hljs-number">12135</span>);

<span class="hljs-type">byte</span>[] receiveBuff = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];

<span class="hljs-type">DatagramPacket</span> <span class="hljs-variable">packet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatagramPacket</span>(receiveBuff, receiveBuff.length);

<span class="hljs-comment">// 阻塞式等待接收广播信息</span>
socket.receive(packet);

<span class="hljs-comment">// 解析广播信息</span>
<span class="hljs-type">String</span> <span class="hljs-variable">receiveContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(packet.getData(), <span class="hljs-number">0</span>, packet.getLength());

System.out.println(<span class="hljs-string">"接收到广播信息 :"</span> + receiveContent);

</code></pre>
<h2 data-id="heading-2">3. 应用</h2>
<p>通过广播的方式，我们可以做到局域网内的自动服务发现。比如以下技术都是通过广播来做到的</p>
<ol>
<li>DHCP， 客户端通过广播 255.255.255.255，67端口发现DHCP服务器。</li>
<li>打印机，物联网设备的设备发现</li>
<li>局域网游戏服务器的服务发现</li>
</ol>
<h3 data-id="heading-3">3.1 服务发现流程</h3>
<ol>
<li>客户端向局域网的指定端口定期发送广播信息。</li>
<li>服务端在指定端口监听所有客户端的广播信息。</li>
<li>服务端解析接收到的广播信息，获取与客户端的通信方式（通信方式自定义，可以通过TCP协议，HTTP协议....）</li>
<li>以TCP协议为例，客户端发送的数据包中应该有通信端口，服务端通过该端口与客户端进行双向通信。</li>
<li>服务端维护已连接的客户端列表。</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
participant A as 客户端
participant C as 局域网
participant B as 服务发现端

A --&gt;&gt; C: 定期发送广播数据包
B --&gt;&gt; C: 监听广播数据包
C --&gt;&gt; B: 监听到广播数据包 

B -&gt;&gt; B: 解析数据包，获取通信端口与客户端IP

B -&gt;&gt; A: 请求与客户端通信
A -&gt;&gt; B: 响应服务端请求
B -&gt;&gt; B: 更新客户端列表

A -&gt;&gt; B: 客户端下线请求
B -&gt;&gt; B: 更新客户端列表
</code></pre>
<h3 data-id="heading-4">3.2 注意点</h3>
<ol>
<li>广播的数据意味着可以被网络中所有的设备监听到，因此可以在广播数据包时做好数据加密。</li>
<li>在客户端与服务端进行双向连接时做身份验证</li>
<li>控制广播频率，如30秒一次，高频广播会占用带宽。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐一个超好用的全栈通用瀑布流布局库 universal-waterfall-layout]]></title>    <link>https://juejin.cn/post/7595858063502606370</link>    <guid>https://juejin.cn/post/7595858063502606370</guid>    <pubDate>2026-01-17T04:00:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858063502606370" data-draft-id="7595864836359618612" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐一个超好用的全栈通用瀑布流布局库 universal-waterfall-layout"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T04:00:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Summer不秃"/> <meta itemprop="url" content="https://juejin.cn/user/3798155850693484"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐一个超好用的全栈通用瀑布流布局库 universal-waterfall-layout
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3798155850693484/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Summer不秃
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:00:39.000Z" title="Sat Jan 17 2026 04:00:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，瀑布流布局（Masonry Layout）一直是一个让人又爱又恨的需求。爱它是因为它能极大提升图片类应用（如 Pinterest、小红书）的视觉体验和空间利用率；恨它是因为实现起来坑点满满——图片高度不固定、窗口缩放重排、框架兼容性问题等等。</p>
<p>今天给大家推荐一个最近发现的宝藏开源库：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Funiversal-waterfall-layout" target="_blank" title="https://www.npmjs.com/package/universal-waterfall-layout" ref="nofollow noopener noreferrer">universal-waterfall-layout</a></strong>。</p>
<p>正如其名，不仅仅是给 Vue 用，也不仅仅是给 React 用，它是一个**通用（Universal）**的解决方案。</p>
<h2 data-id="heading-0">为什么选择它？</h2>
<p>现在的市面上的瀑布流插件往往绑定特定框架，或者包体积过大。而 <code>universal-waterfall-layout</code> 有几个非常击中痛点的特性：</p>
<h3 data-id="heading-1">1. 🚀 全栈通用，一次学习</h3>
<p>无论你是 <strong>Vue 3</strong> 爱好者，还是 <strong>React</strong> 拥趸，甚至是 <strong>原生 JS</strong> 的死忠粉，这个库都能无缝支持。它的核心逻辑是用原生 TypeScript 编写的，零依赖，仅仅在核心之上封装了轻量级的 Vue 和 React 组件适配层。</p>
<h3 data-id="heading-2">2. ⚡️ 内置"刚需"功能</h3>
<p>很多瀑布流插件只管布局，不管体验。但这个库在 <code>v1.0.3</code> 版本中贴心地加入了很多实战刚需功能：</p>
<ul>
<li><strong>骨架屏 (Skeleton Loading)</strong>: 数据还没回来？直接通过 props 开启加载状态，自带脉冲动画的骨架屏，拒绝白屏。</li>
<li><strong>空状态 (Empty State)</strong>: 列表为空时自动显示占位提示，不再需要自己写 <code>v-if/v-else</code>。</li>
<li><strong>图片懒加载 (Lazy Load)</strong>: 内置原生图片懒加载支持，性能直接拉满，不需要再引入额外的 lazyload 库。</li>
</ul>
<h3 data-id="heading-3">3. 📐 两种核心布局策略</h3>
<p>它不仅仅是简单的“排列”，还提供了两种最常用的响应式策略：</p>
<ul>
<li><strong>固定列宽 (Fixed Column Width)</strong>: 指定每列 <code>250px</code>，容器会自动计算能放下几列，并<strong>自动居中</strong>。适合大屏展示。</li>
<li><strong>固定列数 (Fixed Column Count)</strong>: 指定“我要 3 列”，无论屏幕多大，宽度都会自动拉伸填满。适合移动端 H5。</li>
</ul>
<hr/>
<h2 data-id="heading-4">快速上手</h2>
<h3 data-id="heading-5">安装</h3>
<p>非常简单，体积也很小：</p>
<pre><code class="hljs language-bash" lang="bash">npm install universal-waterfall-layout
<span class="hljs-comment"># 或者</span>
pnpm add universal-waterfall-layout
</code></pre>
<h3 data-id="heading-6">via Vue 3</h3>
<p>在 Vue 中使用非常丝滑，你可以直接利用 <code>slot</code> 来自定义加载中和空状态的 UI：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Waterfall 
    :gap="20" 
    :columnWidth="250"
    :loading="isLoading"
    :lazyload="true"
  &gt;
    &lt;!-- 数据列表 --&gt;
    &lt;div v-for="item in items" :key="item.id" class="card"&gt;
      &lt;img :src="item.image" alt="" /&gt;
      &lt;p&gt;{{ item.title }}&lt;/p&gt;
    &lt;/div&gt;
    
    &lt;!-- 自定义加载骨架 --&gt;
    &lt;template #loading&gt;
       &lt;div class="my-skeleton"&gt;正在加载精彩内容...&lt;/div&gt;
    &lt;/template&gt;

    &lt;!-- 自定义空状态 --&gt;
    &lt;template #empty&gt;
       &lt;div class="empty-box"&gt;暂无相关数据&lt;/div&gt;
    &lt;/template&gt;
  &lt;/Waterfall&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { Waterfall } from 'universal-waterfall-layout/vue';
import { ref } from 'vue';

const isLoading = ref(true);
const items = ref([]);

// 模拟请求
setTimeout(() =&gt; {
  items.value = [{/*...*/}, {/*...*/}];
  isLoading.value = false;
}, 1000);
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">via React</h3>
<p>React 版本同样拥有优秀的类型提示（TypeScript Friendly）：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Waterfall</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'universal-waterfall-layout/react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyGallery</span> = (<span class="hljs-params">{ data, loading }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Waterfall</span> 
      <span class="hljs-attr">gap</span>=<span class="hljs-string">{15}</span> 
      <span class="hljs-attr">columnCount</span>=<span class="hljs-string">{3}</span> // <span class="hljs-attr">移动端常用</span>：<span class="hljs-attr">固定3列</span>
      <span class="hljs-attr">loading</span>=<span class="hljs-string">{loading}</span>
      <span class="hljs-attr">lazyload</span>=<span class="hljs-string">{true}</span>
      <span class="hljs-attr">loadingComponent</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading Skeleton...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      emptyComponent={<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Nothing here yet!<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
    &gt;
      {data.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"card"</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{item.url}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Waterfall</span>&gt;</span></span>
  );
};
</code></pre>
<hr/>
<h3 data-id="heading-8">via Vanilla JS (原生 HTML)</h3>
<p>如果你不使用任何框架，或者在传统的 HTML 页面中使用，也完全没问题。核心库提供了直接操作 DOM 的能力：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"waterfall-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"..."</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"..."</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- ... --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">WaterFallCore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'universal-waterfall-layout'</span>;

  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'waterfall-container'</span>);
  
  <span class="hljs-keyword">const</span> waterfall = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WaterFallCore</span>({
    <span class="hljs-attr">container</span>: container, <span class="hljs-comment">// 必填：容器 DOM 元素</span>
    <span class="hljs-attr">gap</span>: <span class="hljs-number">15</span>,              <span class="hljs-comment">// 间距</span>
    <span class="hljs-attr">columnWidth</span>: <span class="hljs-number">220</span>,     <span class="hljs-comment">// 固定列宽策略</span>
    <span class="hljs-attr">lazyload</span>: <span class="hljs-literal">true</span>        <span class="hljs-comment">// 开启懒加载</span>
  });
  
  <span class="hljs-comment">// 如果后续通过 JS 动态添加了元素，可以手动触发布局更新</span>
  <span class="hljs-comment">// waterfall.updateItems();</span>
  <span class="hljs-comment">// waterfall.layout();</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">结语</h2>
<p>在造轮子泛滥的今天，找到一个<strong>克制且好用</strong>的库并不容易。<code>universal-waterfall-layout</code> 没有过度封装，但把最核心的<strong>布局算法</strong>、<strong>响应式处理</strong>和<strong>加载体验</strong>做得非常扎实。</p>
<p>如果你正在开发图片流、商品墙或者作品集展示页面，强烈推荐试一试！</p>
<p>🔗 <strong>NPM 地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Funiversal-waterfall-layout" target="_blank" title="https://www.npmjs.com/package/universal-waterfall-layout" ref="nofollow noopener noreferrer">universal-waterfall-layout</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 LangChain.js 在node端 连接glm大模型示例]]></title>    <link>https://juejin.cn/post/7595868336594911251</link>    <guid>https://juejin.cn/post/7595868336594911251</guid>    <pubDate>2026-01-17T04:47:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595868336594911251" data-draft-id="7595868336594862099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 LangChain.js 在node端 连接glm大模型示例"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T04:47:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevinIcoding"/> <meta itemprop="url" content="https://juejin.cn/user/400700903005726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 LangChain.js 在node端 连接glm大模型示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/400700903005726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevinIcoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:47:12.000Z" title="Sat Jan 17 2026 04:47:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 LangChain 在后端连接大模型：实践指南 🚀</h2>
<blockquote>
<p>本文以实战项目代码为例，包含完整后端接入、流式（SSE）实现、前端接收示例与调试方法，读者可直接复制运行。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">介绍 ✨</h3>
<p>随着大模型在各类应用中的普及，后端如何稳健地接入并把模型能力以 API/流式方式对外提供，成为常见需求。本文基于 LangChain（JS）演示如何在 Node.js 后端（Koa）中：</p>
<ul>
<li>初始化并调用大模型（示例使用智谱 GLM 的接入方式）</li>
<li>支持普通请求与流式（Server-Sent Events，SSE）响应</li>
<li>在前端用 fetch 读取流并实现打字机效果</li>
</ul>
<p>适用人群：熟悉 JS/TS、Node.js、前端基本知识，想把模型能力放到后端并对外提供 API 的工程师。</p>
<hr/>
<h3 data-id="heading-2">一、准备与依赖 🧩</h3>
<p>环境：Node.js 16+。</p>
<p>安装依赖（Koa 示例）：</p>
<pre><code class="hljs language-bash" lang="bash">npm install koa koa-router koa-bodyparser @koa/cors dotenv
npm install @langchain/openai @langchain/core
</code></pre>
<p>在项目根创建 <code>.env</code>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ZHIPU_API_KEY</span>=你的_api_key_here
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3001</span>
</code></pre>
<blockquote>
<p>提示：不同模型提供方的 baseURL 与认证字段会不同，请根据提供方文档调整。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">二、后端：服务封装（chatService）🔧</h3>
<p>把模型调用封装到服务层，提供普通调用与流式调用接口：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// backend/src/services/chatService.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">SystemMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-keyword">const</span> chatService = {
  <span class="hljs-attr">llm</span>: <span class="hljs-literal">null</span>,

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">llm</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">llm</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
        <span class="hljs-attr">openAIApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">ZHIPU_API_KEY</span>,
        <span class="hljs-attr">modelName</span>: <span class="hljs-string">"glm-4.5-flash"</span>,
        <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
        <span class="hljs-attr">configuration</span>: { <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://open.bigmodel.cn/api/paas/v4/"</span> },
      });
    }
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message, conversationHistory = []</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
    <span class="hljs-keyword">const</span> messages = [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"你是一个有帮助的 AI 助手，使用中文回答问题。"</span>),
      ...conversationHistory.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span>
        msg.<span class="hljs-property">role</span> === <span class="hljs-string">"user"</span>
          ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(msg.<span class="hljs-property">content</span>)
          : <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(msg.<span class="hljs-property">content</span>),
      ),
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(message),
    ];

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llm</span>.<span class="hljs-title function_">invoke</span>(messages);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">content</span>: response.<span class="hljs-property">content</span>,
        <span class="hljs-attr">usage</span>: response.<span class="hljs-property">usage_metadata</span>,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"聊天服务错误:"</span>, error);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> };
    }
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendMessageStream</span>(<span class="hljs-params">message, conversationHistory = []</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
    <span class="hljs-keyword">const</span> messages = [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"你是一个有帮助的 AI 助手，使用中文回答问题。"</span>),
      ...conversationHistory.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span>
        msg.<span class="hljs-property">role</span> === <span class="hljs-string">"user"</span>
          ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(msg.<span class="hljs-property">content</span>)
          : <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(msg.<span class="hljs-property">content</span>),
      ),
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(message),
    ];

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 假设 llm.stream 返回异步迭代器，逐 chunk 返回 { content }</span>
      <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llm</span>.<span class="hljs-title function_">stream</span>(messages);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, stream };
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"流式聊天服务错误:"</span>, error);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> };
    }
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> chatService;
</code></pre>
<p>说明：实际 SDK 接口名（如 <code>invoke</code>、<code>stream</code>）请依据你所用的 LangChain / provider 版本调整。</p>
<hr/>
<h3 data-id="heading-4">三、控制器：普通与 SSE 流式（Koa）🌊</h3>
<p>SSE 要点：需要直接写原生 <code>res</code>，并设置 <code>ctx.respond = false</code>，防止 Koa 在中间件链结束时覆盖响应或返回 404。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// backend/src/controllers/chatController.js</span>
<span class="hljs-keyword">import</span> chatService <span class="hljs-keyword">from</span> <span class="hljs-string">"../services/chatService.js"</span>;

<span class="hljs-keyword">const</span> chatController = {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">ctx</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { message, conversationHistory = [] } = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>;
      <span class="hljs-keyword">if</span> (!message) {
        ctx.<span class="hljs-property">status</span> = <span class="hljs-number">400</span>;
        ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">"消息内容不能为空"</span> };
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chatService.<span class="hljs-title function_">sendMessage</span>(
        message,
        conversationHistory,
      );
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">success</span>) ctx.<span class="hljs-property">body</span> = result;
      <span class="hljs-keyword">else</span> {
        ctx.<span class="hljs-property">status</span> = <span class="hljs-number">500</span>;
        ctx.<span class="hljs-property">body</span> = result;
      }
    } <span class="hljs-keyword">catch</span> (error) {
      ctx.<span class="hljs-property">status</span> = <span class="hljs-number">500</span>;
      ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">"服务器内部错误"</span> };
    }
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendMessageStream</span>(<span class="hljs-params">ctx</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { message, conversationHistory = [] } = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">body</span>;
      <span class="hljs-keyword">if</span> (!message) {
        ctx.<span class="hljs-property">status</span> = <span class="hljs-number">400</span>;
        ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">"消息内容不能为空"</span> };
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chatService.<span class="hljs-title function_">sendMessageStream</span>(
        message,
        conversationHistory,
      );
      <span class="hljs-keyword">if</span> (!result.<span class="hljs-property">success</span>) {
        ctx.<span class="hljs-property">status</span> = <span class="hljs-number">500</span>;
        ctx.<span class="hljs-property">body</span> = result;
        <span class="hljs-keyword">return</span>;
      }

      ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>);
      ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache"</span>);
      ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);
      ctx.<span class="hljs-property">status</span> = <span class="hljs-number">200</span>;
      <span class="hljs-comment">// 关键：让我们直接操作 Node 原生 res</span>
      ctx.<span class="hljs-property">respond</span> = <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> result.<span class="hljs-property">stream</span>) {
        <span class="hljs-keyword">const</span> content = chunk.<span class="hljs-property">content</span>;
        <span class="hljs-keyword">if</span> (content) ctx.<span class="hljs-property">res</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content })}</span>\n\n`</span>);
      }

      ctx.<span class="hljs-property">res</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"data: [DONE]\n\n"</span>);
      ctx.<span class="hljs-property">res</span>.<span class="hljs-title function_">end</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"流式控制器错误:"</span>, error);
      ctx.<span class="hljs-property">status</span> = <span class="hljs-number">500</span>;
      ctx.<span class="hljs-property">body</span> = { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">"服务器内部错误"</span> };
    }
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> chatController;
</code></pre>
<hr/>
<h3 data-id="heading-5">四、路由与启动 🌐</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// backend/src/routes/index.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Router</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"koa-router"</span>;
<span class="hljs-keyword">import</span> chatController <span class="hljs-keyword">from</span> <span class="hljs-string">"../controllers/chatController.js"</span>;
<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Router</span>({ <span class="hljs-attr">prefix</span>: <span class="hljs-string">"/api"</span> });
router.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/chat"</span>, chatController.<span class="hljs-property">sendMessage</span>);
router.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/chat/stream"</span>, chatController.<span class="hljs-property">sendMessageStream</span>);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;

<span class="hljs-comment">// backend/src/app.js</span>
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Koa</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"koa"</span>;
<span class="hljs-keyword">import</span> bodyParser <span class="hljs-keyword">from</span> <span class="hljs-string">"koa-bodyparser"</span>;
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">"@koa/cors"</span>;
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">"./routes/index.js"</span>;

dotenv.<span class="hljs-title function_">config</span>();
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>({ <span class="hljs-attr">origin</span>: <span class="hljs-string">"*"</span>, <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span> }));
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">bodyParser</span>());
app.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">routes</span>());
app.<span class="hljs-title function_">use</span>(router.<span class="hljs-title function_">allowedMethods</span>());
app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3001</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Server running"</span>));
</code></pre>
<hr/>
<h3 data-id="heading-6">五、前端：接收 SSE 流并实现“打字机”效果 ⌨️</h3>
<p>前端用 <code>fetch</code> + ReadableStream 读取 SSE 后端发送的 chunk（格式为 <code>data: {...}\n\n</code>）。下面给出简洁示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// frontend/src/services/chatService.ts (核心片段)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessageStream</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  message,
  conversationHistory,
  onChunk,
  onComplete,
  onError,
</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/chat/stream"</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ message, conversationHistory }),
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"网络请求失败"</span>);
    <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();

    <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
      <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
      <span class="hljs-comment">// 简单按行解析 SSE data: 行</span>
      <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"data: "</span>)) {
          <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>);
          <span class="hljs-keyword">if</span> (data === <span class="hljs-string">"[DONE]"</span>) {
            <span class="hljs-title function_">onComplete</span>();
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
            <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">content</span>) <span class="hljs-title function_">onChunk</span>(parsed.<span class="hljs-property">content</span>);
          } <span class="hljs-keyword">catch</span> (e) {}
        }
      }
    }
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-title function_">onError</span>(err.<span class="hljs-property">message</span> || <span class="hljs-string">"流式请求失败"</span>);
  }
};
</code></pre>
<p>打字机效果思路（前端）📌：</p>
<ul>
<li>后端 chunk 通常是按小段返回，前端把每个 chunk 追加到 <code>buffer</code>。</li>
<li>用一个定时器以固定速度（如 20–40ms/字符）把 <code>buffer</code> 的字符逐个移动到展示内容，使文本逐字出现。</li>
<li>onComplete 时快速显示剩余字符并停止定时器。</li>
</ul>
<p>你可以参考项目中 <code>App.tsx</code> 的实现（已实现逐 chunk 追加与打字机渲染逻辑）。</p>
<hr/>
<p>App.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MessageList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/MessageList"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChatInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/ChatInput"</span>;
<span class="hljs-keyword">import</span> { chatService, <span class="hljs-title class_">Message</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./services/chatService"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./App.css"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [messages, setMessages] = useState&lt;<span class="hljs-title class_">Message</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [isStreaming, setIsStreaming] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSendMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">userMessage</span>: <span class="hljs-title class_">Message</span> = { <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: message };
    <span class="hljs-title function_">setMessages</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> [...prev, userMessage]);
    <span class="hljs-title function_">setIsStreaming</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">let</span> assistantContent = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">const</span> conversationHistory = messages;

    <span class="hljs-keyword">await</span> chatService.<span class="hljs-title function_">sendMessageStream</span>(
      message,
      conversationHistory,
      <span class="hljs-function">(<span class="hljs-params">chunk: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        assistantContent += chunk;
        <span class="hljs-title function_">setMessages</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> newMessages = [...prev];
          <span class="hljs-keyword">const</span> lastMessage = newMessages[newMessages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
          <span class="hljs-keyword">if</span> (lastMessage &amp;&amp; lastMessage.<span class="hljs-property">role</span> === <span class="hljs-string">"assistant"</span>) {
            lastMessage.<span class="hljs-property">content</span> = assistantContent;
          } <span class="hljs-keyword">else</span> {
            newMessages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: assistantContent });
          }
          <span class="hljs-keyword">return</span> newMessages;
        });
      },
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setIsStreaming</span>(<span class="hljs-literal">false</span>);
      },
      <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"流式响应错误:"</span>, error);
        <span class="hljs-title function_">setMessages</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> [
          ...prev,
          { <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"抱歉，发生了错误，请稍后重试。"</span> },
        ]);
        <span class="hljs-title function_">setIsStreaming</span>(<span class="hljs-literal">false</span>);
      },
    );
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"app-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>🤖 LangChain + 智谱 GLM<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>AI 聊天助手<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"app-main"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MessageList</span> <span class="hljs-attr">messages</span>=<span class="hljs-string">{messages}</span> <span class="hljs-attr">isStreaming</span>=<span class="hljs-string">{isStreaming}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ChatInput</span> <span class="hljs-attr">onSendMessage</span>=<span class="hljs-string">{handleSendMessage}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isStreaming}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>MessageList</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Message</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../services/chatService"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageListProps</span> {
  <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Message</span>[];
  <span class="hljs-attr">isStreaming</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageList</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">MessageListProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ messages, isStreaming }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> messagesEndRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    messagesEndRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">"smooth"</span> });
  }, [messages, isStreaming]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-list"</span>&gt;</span>
      {messages.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty-state"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>👋 欢迎使用 LangChain + 智谱 GLM 聊天助手！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>开始提问吧，我会尽力帮助你 💬<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        messages.map((msg, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">message</span> ${<span class="hljs-attr">msg.role</span>}`}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-avatar"</span>&gt;</span>
              {msg.role === "user" ? "👤" : "🤖"}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-content"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-role"</span>&gt;</span>
                {msg.role === "user" ? "用户" : "AI 助手"}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-text"</span>&gt;</span>{msg.content}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))
      )}
      {isStreaming &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message assistant"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-avatar"</span>&gt;</span>🤖<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-role"</span>&gt;</span>AI 助手<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"message-text streaming"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"typing-indicator"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{messagesEndRef}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MessageList</span>;
</code></pre>
<h3 data-id="heading-7">六、调试建议与常见坑 ⚠️</h3>
<ul>
<li>404：确认前端请求路径 <code>/api/chat/stream</code> 与路由前缀一致；开发时若使用 Vite，请在 <code>vite.config.ts</code> 配置 proxy 到后端端口。</li>
<li>SSE 返回 404/空响应：确认控制器里 <code>ctx.respond = false</code> 已设置，并且在设置 header 后立即开始 <code>ctx.res.write</code>。</li>
<li>headers already sent：不要在写入原生 <code>res</code> 后再次设置 <code>ctx.body</code> 或 <code>ctx.status</code>。</li>
<li>CORS：若跨域，确保后端 CORS 配置允许 <code>Content-Type</code>、<code>Authorization</code> 等必要 header。</li>
</ul>
<hr/>
<h3 data-id="heading-8">七、快速上手测试命令 🧪</h3>
<p>启动后端：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 backend 目录下</span>
node src/app.js
<span class="hljs-comment"># 或使用 nodemon</span>
npx nodemon src/app.js
</code></pre>
<p>用 curl 测试流式（查看快速返回流）：</p>
<pre><code class="hljs language-bash" lang="bash">curl -N -H <span class="hljs-string">"Content-Type: application/json"</span> -X POST http://localhost:3001/api/chat/stream -d <span class="hljs-string">'{"message":"你好","conversationHistory":[]} '</span>
</code></pre>
<p>你应能看到类似：</p>
<pre><code class="hljs language-css" lang="css">data: {"<span class="hljs-attribute">content</span>":<span class="hljs-string">"你"</span>}
data: {"<span class="hljs-attribute">content</span>":<span class="hljs-string">"好"</span>}
data: [DONE]
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年 Node.js + TS 开发：别再纠结 nodemon 了，聊聊热编译的最优解]]></title>    <link>https://juejin.cn/post/7595911076013899812</link>    <guid>https://juejin.cn/post/7595911076013899812</guid>    <pubDate>2026-01-17T06:18:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595911076013899812" data-draft-id="7595859552347701300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年 Node.js + TS 开发：别再纠结 nodemon 了，聊聊热编译的最优解"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2026-01-17T06:18:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年 Node.js + TS 开发：别再纠结 nodemon 了，聊聊热编译的最优解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:18:21.000Z" title="Sat Jan 17 2026 06:18:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发 Node.js 服务端时，“修改代码 -&gt; 自动生效”的开发体验（即热编译/热更新）是影响效率的关键。随着 <strong>Node.js 23+</strong>  原生支持 TS 以及 <strong>Vite 5</strong> 的普及，我们的工具链已经发生了巨大的更迭。</p>
<p>今天我们深度拆解三种主流的 Node.js TS 开发实现方式，帮你选出最适合 2026 年架构的方案。</p>
<hr/>
<p>一、 方案对比大盘点</p>

































<table><thead><tr><th>方案</th><th>核心原理</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>tsx (Watch Mode)</strong></td><td>基于 esbuild 的极速重启</td><td>零配置、性能强、生态位替代 nodemon</td><td>每次修改重启整个进程，状态丢失</td><td>小型服务、工具脚本</td></tr><tr><td><strong>vite-node</strong></td><td>基于 Vite 的模块加载器</td><td>完美继承 Vite 配置、支持模块级 HMR</td><td>配置相对复杂，需手动处理 HMR 逻辑</td><td>中大型 Vite 全栈项目</td></tr><tr><td><strong>Node.js 原生</strong></td><td>Node 23+ Type Stripping</td><td>无需第三方依赖，官方标准</td><td>需高版本 Node，功能相对单一</td><td>追求极简、前瞻性实验</td></tr></tbody></table>
<hr/>
<p>二、 方案详解</p>
<ol>
<li>现代替代者：<code>tsx</code> —— 告别 nodemon + ts-node</li>
</ol>
<p>过去我们常用 <code>nodemon --exec ts-node</code>，但在 ESM 时代，这套组合经常报 <code>ERR_UNKNOWN_FILE_EXTENSION</code> 错误。</p>
<p><strong><code>tsx</code></strong> 内部集成了 <strong>esbuild</strong>，它是目前 Node 18+ 环境下最稳健的方案。</p>
<ul>
<li>
<p><strong>实现热编译：</strong></p>
<p>bash</p>
<pre><code class="hljs language-css" lang="css">npx tsx <span class="hljs-attr">--watch</span> <span class="hljs-attribute">src</span>/index<span class="hljs-selector-class">.ts</span>
</code></pre>
<p>请谨慎使用此类代码。</p>
</li>
<li>
<p><strong>为什么选它：</strong>  它不需要额外的加载器配置（--loader），且 <code>watch</code> 模式非常智能，重启速度在毫秒级。</p>
</li>
</ul>
<ol start="2">
<li>开发者体验天花板：<code>vite-node</code> —— 真正的 HMR</li>
</ol>
<p>如果你已经在项目中使用 <strong>Vite 5</strong>，那么 <code>vite-node</code> 是不二之选。它不仅是“重启”，而是“热替换”。</p>
<ul>
<li>
<p><strong>核心优势：</strong></p>
<ul>
<li><strong>共享配置</strong>：直接复用 <code>vite.config.ts</code> 中的 <code>alias</code> 和插件。</li>
<li><strong>按需编译</strong>：只编译当前运行到的模块，项目越大优势越明显。</li>
</ul>
</li>
<li>
<p><strong>实现热更新（不重启进程）：</strong></p>
<p>typescript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/index.ts</span>
<span class="hljs-keyword">import</span> { app } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app'</span>;
<span class="hljs-keyword">let</span> server = app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>) {
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./app'</span>, <span class="hljs-function">(<span class="hljs-params">newModule</span>) =&gt;</span> {
    server.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 优雅关闭旧服务</span>
    server = newModule.<span class="hljs-property">app</span>.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 启动新逻辑，DB连接可复用</span>
  });
}
</code></pre>
<p>请谨慎使用此类代码。</p>
</li>
</ul>
<ol start="3">
<li>官方正统：Node.js 原生支持</li>
</ol>
<p>如果你能使用 <strong>Node.js 23.6+</strong> ，那么可以摆脱所有构建工具。</p>
<ul>
<li><strong>运行：</strong>  <code>node --watch src/index.ts</code></li>
<li><strong>点评：</strong>  这是未来的趋势，但在 2026 年，由于生产环境往往还停留在 Node 18/20 LTS，该方案目前更多用于本地轻量级开发。</li>
</ul>
<hr/>
<p>三、 避坑指南：Vite 5 打包 Node 服务的报错</p>
<p>在实现热编译的过程中，如果你尝试用 Vite 打包 Node 服务，可能会遇到：</p>
<blockquote>
<p><code>Invalid value for option "preserveEntrySignatures" - setting this option to false is not supported for "output.preserveModules"</code></p>
</blockquote>
<p><strong>原因：</strong>  当你开启 <code>preserveModules: true</code> 想保持源码目录结构输出时，Rollup 无法在“强制保留模块”的同时又“摇树优化（Tree Shaking）”掉入口导出。</p>
<p><strong>修复方案：</strong><br/>
在 <code>vite.config.ts</code> 中明确设置：</p>
<p>typescript</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">build:</span> {
  <span class="hljs-attr">rollupOptions:</span> {
    <span class="hljs-attr">preserveEntrySignatures:</span> <span class="hljs-string">'exports-only'</span>, <span class="hljs-string">//</span> <span class="hljs-string">显式声明保留导出</span>
    <span class="hljs-attr">output:</span> {
      <span class="hljs-attr">preserveModules:</span> <span class="hljs-literal">true</span>
    }
  }
}
</code></pre>
<p>请谨慎使用此类代码。</p>
<hr/>
<p>四、 总结：我该选哪个？</p>
<ol>
<li><strong>如果你只想快速写个接口，不想折腾配置</strong>：请直接使用 <strong><code>tsx</code></strong>。它是 2026 年 nodemon 的完美继承者。</li>
<li><strong>如果你在做复杂全栈项目，或者有大量的路径别名</strong>：请使用 <strong><code>vite-node</code></strong>。它能让你在 Node 端获得跟前端 React/Vue 编写时一样丝滑的 HMR 体验。</li>
<li><strong>如果是为了部署生产环境</strong>：无论开发环境用什么，生产环境请务必通过 <code>vite build</code> 产出纯净的 JS，并使用 <code>node dist/index.js</code> 运行。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【2026最新最全】AI架构能力-新一代架构图绘制方法论]]></title>    <link>https://juejin.cn/post/7595873251165175849</link>    <guid>https://juejin.cn/post/7595873251165175849</guid>    <pubDate>2026-01-17T02:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595873251165175849" data-draft-id="7595800318519017478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【2026最新最全】AI架构能力-新一代架构图绘制方法论"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-17T02:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Calvad0s"/> <meta itemprop="url" content="https://juejin.cn/user/650557396898199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【2026最新最全】AI架构能力-新一代架构图绘制方法论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/650557396898199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Calvad0s
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T02:57:02.000Z" title="Sat Jan 17 2026 02:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">一、传统IT架构图绘制痛点和AI架构图绘制介绍</h2>
<h3 data-id="heading-1">1.1 绘图痛点</h3>
<p>需求背景：<strong>做项目的第一步都离不开画图，传统IT架构图绘制的痛点</strong></p>
<ul>
<li>
<p><strong>绘制效率低</strong></p>
<ul>
<li><strong>手动绘制耗时</strong>：使用Visio、Draw.io、ProcessOn等工具手动绘制，一个复杂架构图需要2-4小时</li>
<li><strong>反复修改繁琐</strong>：架构调整后需要手动修改每个组件、连线、标注，工作量大</li>
<li><strong>版本管理困难</strong>：多版本架构图难以对比，容易丢失历史版本</li>
</ul>
</li>
<li>
<p><strong>绘制质量不稳定</strong></p>
<ul>
<li><strong>标准化程度低</strong>：不同人员绘制风格不统一，缺乏统一标准</li>
<li><strong>容易出错遗漏</strong>：手动绘制容易遗漏组件、连接错误、标注不规范</li>
<li><strong>专业门槛高</strong>：新人需要学习工具使用，绘制专业架构图需要经验积累</li>
</ul>
</li>
<li>
<p><strong>维护成本高</strong></p>
<ul>
<li><strong>同步更新困难</strong>：代码变更后，架构图难以同步更新，容易过时</li>
<li><strong>多人协作冲突</strong>：团队多人编辑同一架构图，容易出现冲突和重复工作</li>
<li><strong>文档化成本高</strong>：需要专门维护架构文档，增加团队工作负担</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">1.2 什么是AI架构图绘制？</h3>
<h4 data-id="heading-3">定义</h4>
<p>AI架构图绘制是利用AI大模型能力，通过自然语言描述自动生成IT架构图的技术方案。</p>
<p><strong>简单说</strong>，就像对AI说"画一个微服务架构图，包含网关、用户服务、订单服务、数据库"，AI就能自动生成专业的架构图。</p>
<p><strong>核心能力包括</strong>：</p>
<ul>
<li><strong>自然语言理解</strong>：理解你的架构需求描述，提取关键组件和关系</li>
<li><strong>智能布局设计</strong>：自动设计组件位置、连线方式，保证图表清晰美观</li>
<li><strong>多格式支持</strong>：支持Draw.io、Mermaid、PlantUML等多种格式输出</li>
<li><strong>架构模式识别</strong>：识别微服务、分层架构、事件驱动等常见架构模式</li>
</ul>
<h4 data-id="heading-4">适用场景</h4>
<ul>
<li><strong>新项目架构设计</strong>：快速生成初始架构图，用于技术方案评审</li>
<li><strong>现有系统梳理</strong>：通过代码分析自动生成现有系统架构图</li>
<li><strong>技术方案评审</strong>：快速产出多个架构方案对比图</li>
<li><strong>团队协作</strong>：统一架构图标准，提高团队沟通效率</li>
</ul>
<h4 data-id="heading-5">AI架构图绘制工具类型</h4>
<ul>
<li><strong>AI增强型绘图工具</strong>：如next-ai-draw-io，在传统绘图工具基础上集成AI能力</li>
<li><strong>代码生成图表工具</strong>：如Mermaid，通过代码描述生成图表，AI辅助代码生成</li>
<li><strong>注意：传统的IT绘图工具， 也在逐步加入AI绘图功能</strong></li>
</ul>
<h4 data-id="heading-6">注意事项</h4>
<ul>
<li><strong>AI生成的架构图需要人工审核</strong>：AI可能不理解业务细节，需要技术专家校验（<strong>依旧离不开基础架构能力</strong>）</li>
<li><strong>持续优化提示词</strong>：更好的描述能生成更准确的架构图</li>
<li><strong>结合代码同步更新</strong>：建议将架构图纳入版本控制，配合代码变更自动更新</li>
<li><strong>选择合适工具</strong>：不同工具适合不同场景，需要根据团队需求选择</li>
</ul>
<h2 data-id="heading-7">二、工程师画架构图的秘密武器-Mermaid</h2>
<h3 data-id="heading-8">2.1 为什么需要Mermaid？</h3>
<ul>
<li><strong>图表维护困难</strong>：传统图片格式难以版本控制，修改麻烦</li>
<li><strong>文档自动化需求</strong>：需要在Markdown等文档中嵌入图表</li>
<li><strong>团队协作需要</strong>：代码化图表便于团队协作和审查</li>
</ul>
<h3 data-id="heading-9">2.2 什么是Mermaid？</h3>
<h4 data-id="heading-10"><strong>核心定义</strong></h4>
<ul>
<li><strong>Mermaid 是一个基于 JavaScript 的开源图表生成库</strong></li>
<li>允许用户通过<strong>简洁的文本语法</strong>（类似 Markdown）来定义流程图、时序图、类图等，并自动渲染为 SVG 或 PNG 图像</li>
</ul>
<h4 data-id="heading-11"><strong>特点</strong></h4>
<ul>
<li><strong>代码即文档</strong>：图表定义就是代码，可以版本控制、代码审查</li>
<li><strong>多图表类型</strong>：支持流程图、时序图、类图、架构图、甘特图等</li>
<li><strong>广泛支持</strong>：GitHub、GitLab、Notion、Typora等平台都支持Mermaid</li>
<li><strong>AI绘制架构图需要</strong>：利用AI大模型绘制业务架构图-出错少的情况下采用这个最好</li>
</ul>
<h4 data-id="heading-12"><strong>在线文档地址</strong></h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.nodejs.cn%2F" title="https://mermaid.nodejs.cn/" target="_blank" ref="nofollow noopener noreferrer">mermaid.nodejs.cn/</a></p>
<h3 data-id="heading-13">2.3 Mermaid支持的图表类型</h3>
<ul>
<li><strong>流程图（Flowchart）</strong> ：用于业务流程、算法流程</li>
<li><strong>时序图（Sequence Diagram）</strong> ：用于展示系统交互时序</li>
<li><strong>类图（Class Diagram）</strong> ：用于展示类结构和关系</li>
<li><strong>架构图（C4 Context/Container）</strong> ：用于展示系统架构</li>
<li><strong>状态图（State Diagram）</strong> ：用于展示状态转换</li>
<li><strong>甘特图（Gantt Chart）</strong> ：用于项目管理</li>
<li><strong>实体关系图（ER Diagram）</strong> ：用于数据库设计</li>
</ul>
<h3 data-id="heading-14">2.4 架构图语法示例</h3>
<pre><code class="hljs language-css" lang="css">graph TB
    subgraph 网关层
        <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[API Gateway]</span>
    end
    
    subgraph 服务层
        <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[User Service]</span>
        C<span class="hljs-selector-attr">[Order Service]</span>
        D<span class="hljs-selector-attr">[Payment Service]</span>
    end
    
    subgraph 数据层
        E<span class="hljs-selector-attr">[(MySQL)]</span>
        F<span class="hljs-selector-attr">[(Redis)]</span>
    end
    
    <span class="hljs-selector-tag">A</span> --&gt; <span class="hljs-selector-tag">B</span>
    <span class="hljs-selector-tag">A</span> --&gt; C
    <span class="hljs-selector-tag">A</span> --&gt; D
    <span class="hljs-selector-tag">B</span> --&gt; E
    C --&gt; E
    D --&gt; E
    <span class="hljs-selector-tag">B</span> --&gt; F
    C --&gt; F
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe06c865e3b44728f8538a685fcdbfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FsdmFkMHM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769223422&amp;x-signature=DIeR%2Bxr5DrjvmfefkQNAhBMgqWU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h2 data-id="heading-15">三、Mermaid在线地址绘制架构图上手实战</h2>
<p>在线运行地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid-live.nodejs.cn%2Fedit" title="https://mermaid-live.nodejs.cn/edit" target="_blank" ref="nofollow noopener noreferrer">mermaid-live.nodejs.cn/edit</a></p>
<h3 data-id="heading-16">3.1 案例实战：微服务架构图绘制</h3>
<h4 data-id="heading-17">需求说明</h4>
<ul>
<li>绘制完整的微服务架构图</li>
<li>包含网关层、服务层、数据层</li>
<li>展示各组件之间的关系</li>
</ul>
<h4 data-id="heading-18">步骤</h4>
<ul>
<li>打开在线编辑器， <a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.live%2F" title="https://mermaid.live/" target="_blank" ref="nofollow noopener noreferrer">mermaid.live/</a></li>
<li>复制以下代码到左侧编辑区</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">graph TB
    subgraph 客户端层
        Web[Web前端]
        App[移动App]
    <span class="hljs-keyword">end</span>
    
    subgraph 网关层
        Gateway[API Gateway<span class="hljs-operator">&lt;</span>br<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>Spring Cloud Gateway]
    <span class="hljs-keyword">end</span>
    
    subgraph 服务注册发现
        Nacos[Nacos注册中心]
    <span class="hljs-keyword">end</span>
    
    subgraph 微服务层
        UserService[用户服务<span class="hljs-operator">&lt;</span>br<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span><span class="hljs-keyword">User</span> Service]
        OrderService[订单服务<span class="hljs-operator">&lt;</span>br<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span><span class="hljs-keyword">Order</span> Service]
        ProductService[商品服务<span class="hljs-operator">&lt;</span>br<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>Product Service]
        PaymentService[支付服务<span class="hljs-operator">&lt;</span>br<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>Payment Service]
    <span class="hljs-keyword">end</span>
    
    subgraph 中间件层
        Redis[(Redis缓存)]
        MQ[消息队列<span class="hljs-operator">&lt;</span>br<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>RocketMQ]
    <span class="hljs-keyword">end</span>
    
    subgraph 数据层
        MySQL[(MySQL数据库)]
    <span class="hljs-keyword">end</span>
    
    Web <span class="hljs-comment">--&gt; Gateway</span>
    App <span class="hljs-comment">--&gt; Gateway</span>
    Gateway <span class="hljs-comment">--&gt; Nacos</span>
    Gateway <span class="hljs-comment">--&gt; UserService</span>
    Gateway <span class="hljs-comment">--&gt; OrderService</span>
    Gateway <span class="hljs-comment">--&gt; ProductService</span>
    Gateway <span class="hljs-comment">--&gt; PaymentService</span>
    
    UserService <span class="hljs-comment">--&gt; Nacos</span>
    OrderService <span class="hljs-comment">--&gt; Nacos</span>
    ProductService <span class="hljs-comment">--&gt; Nacos</span>
    PaymentService <span class="hljs-comment">--&gt; Nacos</span>
    
    UserService <span class="hljs-comment">--&gt; Redis</span>
    OrderService <span class="hljs-comment">--&gt; Redis</span>
    ProductService <span class="hljs-comment">--&gt; Redis</span>
    
    UserService <span class="hljs-comment">--&gt; MySQL</span>
    OrderService <span class="hljs-comment">--&gt; MySQL</span>
    ProductService <span class="hljs-comment">--&gt; MySQL</span>
    PaymentService <span class="hljs-comment">--&gt; MySQL</span>
    
    OrderService <span class="hljs-comment">--&gt; MQ</span>
    PaymentService <span class="hljs-comment">--&gt; MQ</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de518a5eb1154ae8bafec3a554818c19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FsdmFkMHM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769223422&amp;x-signature=tsumorGw9ydYQnXfP1Zj7na6aoM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h3 data-id="heading-19">3.2 Mermaid在项目中的应用</h3>
<ul>
<li><strong>README文档</strong>：在项目README中添加架构图</li>
<li><strong>技术文档</strong>：在技术设计文档中嵌入架构图</li>
<li><strong>Wiki文档</strong>：在项目Wiki中使用Mermaid图表</li>
<li><strong>代码注释</strong>：在代码注释中使用Mermaid展示逻辑流程</li>
</ul>
<h2 data-id="heading-20">四、AI架构图绘制工具对比和选择指南</h2>
<h3 data-id="heading-21">4.1 需求背景</h3>
<ul>
<li>
<p>知道了常见的架构图可以采用Mermaid代码进行绘制</p>
</li>
<li>
<p>我们就可以让AI辅助生成Mermaid架构图代码，市场有很多工具</p>
</li>
<li>
<p>主要分两类</p>
<ul>
<li><strong>使用AI编辑器</strong>：在Cursor、Qoder等AI编辑器中描述需求，AI生成Mermaid代码</li>
<li><strong>使用在线AI画图</strong>：在processON、next-ai-draw-io 等网站中直接中描述需求，AI生成Mermaid代码</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">4.2 主流AI架构图绘制工具</h3>
<h4 data-id="heading-23">在线网站：<strong>ProcessOn</strong></h4>
<ul>
<li>
<p><strong>定位</strong>：在线协作式思维导图与流程图工具，支持 AI 辅助绘图</p>
</li>
<li>
<p><strong>特点</strong>：轻量化操作、实时协作、模板丰富、AI 快速生成图表</p>
</li>
<li>
<p><strong>适用场景</strong>：思维导图创作、流程图绘制、项目管理甘特图、团队需求梳理、架构原型设计</p>
</li>
<li>
<p>优势</p>
<ul>
<li>免安装在线使用，跨设备同步，支持多人实时协作编辑，团队沟通效率高</li>
<li>内置海量行业模板（流程图 / 思维导图 / ER 图 / 架构图等），新手易上手</li>
<li>AI 辅助功能可一键生成图表框架、优化排版，降低复杂绘图门槛</li>
</ul>
</li>
<li>
<p>劣势</p>
<ul>
<li>免费版有节点数量和文件数量限制，高级功能需开通会员</li>
<li>完全依赖网络环境，离线状态下无法编辑已保存文件</li>
</ul>
</li>
<li>
<p><strong>提示词示例</strong>：</p>
</li>
</ul>

<pre><code class="hljs language-diff" lang="diff">帮我生成一个微服务架构图，包含：
<span class="hljs-deletion">- API网关作为入口</span>
<span class="hljs-deletion">- 用户服务、订单服务、商品服务、支付服务</span>
<span class="hljs-deletion">- Nacos服务注册中心</span>
<span class="hljs-deletion">- Redis缓存和MySQL数据库</span>
<span class="hljs-deletion">- 展示所有组件之间的连接关系</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-24">在线网站：<strong>next-ai-draw-io</strong></h4>
<ul>
<li>
<p><strong>定位</strong>：基于Draw.io的AI增强版</p>
</li>
<li>
<p><strong>特点</strong>：功能强大、专业绘图、AI辅助生成</p>
</li>
<li>
<p><strong>适用场景</strong>：复杂架构图、专业文档、团队协作</p>
</li>
<li>
<p><strong>优势</strong>：</p>
<ul>
<li>继承了Draw.io的所有专业功能，AI辅助提升绘制效率</li>
<li>支持多种格式导出，图表质量专业规范</li>
</ul>
</li>
<li>
<p><strong>劣势</strong>：</p>
<ul>
<li>需要学习Draw.io基本操作，在线版本可能受网络影响，复杂图表生成可能需要多次对话</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25"><strong>Mermaid + AI编辑器</strong></h4>
<ul>
<li>
<p><strong>定位</strong>：代码化图表生成工具</p>
</li>
<li>
<p><strong>特点</strong>：代码即文档、版本控制友好、易于维护</p>
</li>
<li>
<p><strong>适用场景</strong>：文档嵌入、版本控制</p>
</li>
<li>
<p><strong>优势</strong>：</p>
<ul>
<li>图表代码可以版本控制、易于维护和更新</li>
<li>广泛平台支持，结合AI编辑器快速生成</li>
</ul>
</li>
<li>
<p><strong>劣势</strong>：</p>
<ul>
<li>需要学习Mermaid语法，复杂布局控制相对困难，可视化编辑能力较弱</li>
</ul>
</li>
</ul>
<h4 data-id="heading-26"><strong>PlantUML + AI辅助</strong></h4>
<ul>
<li>
<p><strong>定位</strong>：UML图表生成工具</p>
</li>
<li>
<p><strong>特点</strong>：专业UML支持、代码生成、多格式输出</p>
</li>
<li>
<p><strong>适用场景</strong>：UML设计、系统设计、文档生成</p>
</li>
<li>
<p><strong>优势</strong>：</p>
<ul>
<li>专业的UML图表支持，代码化定义便于维护，支持多种图表类型</li>
</ul>
</li>
<li>
<p><strong>劣势</strong>：</p>
<ul>
<li>语法相对复杂，主要用于UML图表，学习成本较高</li>
</ul>
</li>
</ul>















































<table><thead><tr><th><strong>对比维度</strong></th><th><strong>next-ai-draw-io</strong></th><th><strong>Mermaid+AI</strong></th><th><strong>PlantUML+AI</strong></th></tr></thead><tbody><tr><td><strong>学习成本</strong></td><td>中等（需学Draw.io）</td><td>低（语法简单）</td><td>高（语法复杂）</td></tr><tr><td><strong>绘制效率</strong></td><td>高（AI辅助）</td><td>高（AI生成）</td><td>中（需写代码）</td></tr><tr><td><strong>版本控制</strong></td><td>中等（文件格式）</td><td>高（代码格式）</td><td>高（代码格式）</td></tr><tr><td><strong>图表质量</strong></td><td>高（专业标准）</td><td>中高</td><td>高（UML标准）</td></tr><tr><td><strong>维护成本</strong></td><td>中（手动维护）</td><td>低（代码维护）</td><td>低（代码维护）</td></tr><tr><td><strong>适用场景</strong></td><td>复杂架构、专业文档</td><td>文档嵌入、协作</td><td>UML设计</td></tr></tbody></table>
<h3 data-id="heading-27">4.3 选择指南</h3>
<h4 data-id="heading-28">场景一：新项目架构设计</h4>
<p>推荐工具：<strong>next-ai-draw-io</strong></p>
<p>原因：需要专业美观的架构图用于技术方案评审，AI辅助可以快速生成高质量图表。</p>
<p>使用方式：通过对话描述架构需求，AI生成图表后手动微调。</p>
<h4 data-id="heading-29">场景二：技术文档编写</h4>
<p>推荐工具：Mermaid + AI编辑器</p>
<p>原因：文档需要嵌入图表，Mermaid可以直接在Markdown中使用，版本控制友好。</p>
<p>使用方式：在AI编辑器中描述需求，AI生成Mermaid代码，嵌入文档。</p>
<h4 data-id="heading-30">场景三：现有系统梳理</h4>
<p>推荐工具：Mermaid + AI代码分析工具（Cursor、Qoder）</p>
<p>原因：自动分析代码生成架构图，效率最高，后续用Mermaid维护。</p>
<p>使用方式：工具自动分析代码，生成Mermaid代码，纳入版本控制。</p>
<h2 data-id="heading-31">五、什么是next-ai-draw-io和AI架构图实战</h2>
<h3 data-id="heading-32">5.1 什么是next-ai-draw-io？</h3>
<p>next-ai-draw-io是基于Draw.io的AI增强版本，集成了AI大模型能力，支持通过自然语言描述自动生成架构图。</p>
<p><strong>简单说</strong>，就像给Draw.io装了一个"AI助手"，你可以用文字描述架构，AI帮你自动画图。</p>
<ul>
<li>
<p><strong>技术特点</strong>：</p>
<ul>
<li><strong>基于Draw.io</strong>：继承了Draw.io的所有功能和优势</li>
<li><strong>AI能力集成</strong>：集成了GPT、Claude等大模型，支持智能绘图</li>
<li><strong>实时生成</strong>：支持实时对话生成和编辑架构图</li>
<li><strong>多格式导出</strong>：支持PNG、SVG、PDF等多种格式导出</li>
</ul>
</li>
<li>
<p>资料地址</p>
<ul>
<li>GitHub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" title="https://github.com/DayuanJiang/next-ai-draw-io" target="_blank" ref="nofollow noopener noreferrer">github.com/DayuanJiang…</a></li>
</ul>
</li>
</ul>
<h3 data-id="heading-33">5.2 为什么需要next-ai-draw-io？</h3>
<h4 data-id="heading-34">需求背景</h4>
<ul>
<li><strong>Draw.io功能强大但操作复杂</strong>：专业绘图功能多，但学习成本高</li>
<li><strong>架构图绘制效率低</strong>：手动绘制复杂架构图需要大量时间</li>
<li><strong>需要AI辅助提升效率</strong>：希望通过AI能力快速生成专业架构图</li>
</ul>
<h4 data-id="heading-35">核心作用</h4>
<ul>
<li><strong>提升绘制效率</strong>：通过AI辅助，绘制时间从小时级降到分钟级</li>
<li><strong>降低学习成本</strong>：无需深入学习Draw.io复杂功能，用自然语言描述即可</li>
<li><strong>保持专业标准</strong>：生成的图表符合专业规范，风格统一</li>
<li><strong>支持迭代优化</strong>：可以不断通过对话优化和完善架构图</li>
</ul>
<h3 data-id="heading-36">5.3 案例实战</h3>
<h4 data-id="heading-37">需求说明</h4>
<ul>
<li>快速生成一个微服务架构图</li>
<li>包含API网关、用户服务、订单服务、支付服务、商品服务</li>
<li>包含Redis缓存、MySQL数据库</li>
</ul>
<h4 data-id="heading-38">实战步骤</h4>
<p><strong>步骤1：访问next-ai-draw-io</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">访问地址：https:<span class="hljs-comment">//next-ai-drawio.jiang.jp/zh</span>
或使用本地部署版本
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>步骤2：使用AI对话生成架构图</strong></p>
<pre><code class="hljs language-diff" lang="diff">对话示例：

用户：帮我画一个微服务架构图，包含以下服务：
<span class="hljs-deletion">- API网关（Gateway）</span>
<span class="hljs-deletion">- 用户服务（User Service）</span>
<span class="hljs-deletion">- 订单服务（Order Service）</span>
<span class="hljs-deletion">- 支付服务（Payment Service）</span>
<span class="hljs-deletion">- 商品服务（Product Service）</span>
使用Redis作为缓存，MySQL作为数据库

AI：正在为您生成微服务架构图...
已生成架构图，包含：
<span class="hljs-deletion">- API网关作为统一入口</span>
<span class="hljs-deletion">- 五个微服务通过网关暴露接口</span>
<span class="hljs-deletion">- Redis缓存层用于提高性能</span>
<span class="hljs-deletion">- MySQL数据库存储持久化数据</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e2d1e419eb4f309fd0397822d30c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FsdmFkMHM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769223422&amp;x-signature=CJwo6DlXb8Lhoysyzu387w%2BKIZg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p><strong>步骤3：优化和完善架构图</strong></p>
<pre><code class="hljs">用户：添加服务注册中心Nacos，并将所有服务注册到Nacos

AI：已添加Nacos服务注册中心，所有微服务已注册到Nacos
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>步骤4：导出架构图</strong></p>
<blockquote>
<p>导出格式：</p>
<ul>
<li>PNG：用于文档插入</li>
<li>SVG：用于网页展示</li>
<li>PDF：用于打印</li>
<li>Draw.io格式：用于后续编辑</li>
</ul>
</blockquote>
<h2 data-id="heading-39">六、AI架构图绘制综合实战和最佳实践</h2>
<h3 data-id="heading-40">6.1 需求说明</h3>
<ul>
<li>
<p><strong>项目背景</strong>：电商微服务系统</p>
</li>
<li>
<p><strong>功能模块</strong>：</p>
<ul>
<li>用户管理、商品管理、订单管理、支付管理</li>
<li>购物车、推荐系统、消息通知</li>
</ul>
</li>
<li>
<p><strong>技术栈</strong>：</p>
<ul>
<li>网关：Spring Cloud Gateway</li>
<li>注册中心：Nacos</li>
<li>服务：Spring Boot微服务</li>
<li>缓存：Redis</li>
<li>数据库：MySQL</li>
<li>消息队列：RabbitMQ</li>
<li>搜索引擎：Elasticsearch</li>
</ul>
</li>
</ul>
<h3 data-id="heading-41">6.2 实战步骤</h3>
<h4 data-id="heading-42"><strong>步骤1：使用AI生成基础架构图（next-ai-draw-io）</strong></h4>
<pre><code class="hljs language-markdown" lang="markdown">AI对话提示词：

帮我生成一个电商微服务系统架构图，包含：
<span class="hljs-bullet">1.</span> API网关层：Spring Cloud Gateway
<span class="hljs-bullet">2.</span> 服务注册中心：Nacos
<span class="hljs-bullet">3.</span> 微服务层：
<span class="hljs-bullet">   -</span> 用户服务
<span class="hljs-bullet">   -</span> 商品服务
<span class="hljs-bullet">   -</span> 订单服务
<span class="hljs-bullet">   -</span> 支付服务
<span class="hljs-bullet">   -</span> 购物车服务
<span class="hljs-bullet">   -</span> 推荐服务
<span class="hljs-bullet">   -</span> 消息服务
<span class="hljs-bullet">4.</span> 中间件层：
<span class="hljs-bullet">   -</span> Redis缓存
<span class="hljs-bullet">   -</span> RabbitMQ消息队列
<span class="hljs-bullet">   -</span> Elasticsearch搜索引擎
<span class="hljs-bullet">5.</span> 数据层：
<span class="hljs-bullet">   -</span> MySQL主从数据库
请展示各组件之间的连接关系和数据流向
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/749449cfdbaa4b95907b0b1603c8a071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FsdmFkMHM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769223422&amp;x-signature=Z6q6iHJ74VyxmO3SLLExnoi6a%2Bw%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-43"><strong>步骤2：转换为Mermaid代码（便于文档维护）</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ef5659110954e249152db771e788038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FsdmFkMHM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769223422&amp;x-signature=k%2BGjQCnpqdUb3fCSqveD0Q9NjhY%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-44">步骤三：项目根目录创建md文档，将生成的Mermaid代码复制到里面</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">graph</span> <span class="hljs-selector-tag">TD</span>
    %% 样式定义
    <span class="hljs-selector-tag">classDef</span> <span class="hljs-selector-tag">client</span> <span class="hljs-selector-tag">fill</span>:<span class="hljs-selector-id">#d5e8d4</span>,<span class="hljs-selector-tag">stroke</span>:<span class="hljs-selector-id">#82b366</span>,<span class="hljs-selector-tag">stroke-width</span>:<span class="hljs-number">2px</span>
    <span class="hljs-selector-tag">classDef</span> <span class="hljs-selector-tag">gateway</span> <span class="hljs-selector-tag">fill</span>:<span class="hljs-selector-id">#1ba1e2</span>,<span class="hljs-selector-tag">stroke</span>:<span class="hljs-selector-id">#006EAF</span>,<span class="hljs-selector-tag">stroke-width</span>:<span class="hljs-number">2px</span>,<span class="hljs-selector-tag">color</span>:<span class="hljs-selector-id">#fff</span>
    <span class="hljs-selector-tag">classDef</span> <span class="hljs-selector-tag">service</span> <span class="hljs-selector-tag">fill</span>:<span class="hljs-selector-id">#f8cecc</span>,<span class="hljs-selector-tag">stroke</span>:<span class="hljs-selector-id">#b85450</span>,<span class="hljs-selector-tag">stroke-width</span>:<span class="hljs-number">2px</span>
    <span class="hljs-selector-tag">classDef</span> <span class="hljs-selector-tag">registry</span> <span class="hljs-selector-tag">fill</span>:<span class="hljs-selector-id">#966699</span>,<span class="hljs-selector-tag">stroke</span>:<span class="hljs-selector-id">#6c5278</span>,<span class="hljs-selector-tag">stroke-width</span>:<span class="hljs-number">2px</span>,<span class="hljs-selector-tag">color</span>:<span class="hljs-selector-id">#fff</span>
    <span class="hljs-selector-tag">classDef</span> <span class="hljs-selector-tag">middleware</span> <span class="hljs-selector-tag">fill</span>:<span class="hljs-selector-id">#82b366</span>,<span class="hljs-selector-tag">stroke</span>:<span class="hljs-selector-id">#669933</span>,<span class="hljs-selector-tag">stroke-width</span>:<span class="hljs-number">2px</span>,<span class="hljs-selector-tag">color</span>:<span class="hljs-selector-id">#fff</span>
    <span class="hljs-selector-tag">classDef</span> <span class="hljs-selector-tag">database</span> <span class="hljs-selector-tag">fill</span>:<span class="hljs-selector-id">#d79b00</span>,<span class="hljs-selector-tag">stroke</span>:<span class="hljs-selector-id">#A66C00</span>,<span class="hljs-selector-tag">stroke-width</span>:<span class="hljs-number">2px</span>,<span class="hljs-selector-tag">color</span>:<span class="hljs-selector-id">#fff</span>

    %% 客户端层
    <span class="hljs-selector-tag">Client</span><span class="hljs-selector-attr">[客户端]</span>:::<span class="hljs-selector-tag">client</span>

    %% <span class="hljs-selector-tag">API</span>网关层
    <span class="hljs-selector-tag">Gateway</span><span class="hljs-selector-attr">[Spring Cloud Gateway]</span>:::<span class="hljs-selector-tag">gateway</span>

    %% 微服务层
    <span class="hljs-selector-tag">subgraph</span> 微服务层
        <span class="hljs-selector-tag">UserService</span><span class="hljs-selector-attr">[用户服务]</span>:::<span class="hljs-selector-tag">service</span>
        <span class="hljs-selector-tag">ProductService</span><span class="hljs-selector-attr">[商品服务]</span>:::<span class="hljs-selector-tag">service</span>
        <span class="hljs-selector-tag">OrderService</span><span class="hljs-selector-attr">[订单服务]</span>:::<span class="hljs-selector-tag">service</span>
        <span class="hljs-selector-tag">PaymentService</span><span class="hljs-selector-attr">[支付服务]</span>:::<span class="hljs-selector-tag">service</span>
        <span class="hljs-selector-tag">CartService</span><span class="hljs-selector-attr">[购物车服务]</span>:::<span class="hljs-selector-tag">service</span>
        <span class="hljs-selector-tag">RecommendService</span><span class="hljs-selector-attr">[推荐服务]</span>:::<span class="hljs-selector-tag">service</span>
        <span class="hljs-selector-tag">MessageService</span><span class="hljs-selector-attr">[消息服务]</span>:::<span class="hljs-selector-tag">service</span>
    <span class="hljs-selector-tag">end</span>

    %% 服务注册中心
    <span class="hljs-selector-tag">subgraph</span> 服务注册中心
        <span class="hljs-selector-tag">Nacos</span><span class="hljs-selector-attr">[Nacos]</span>:::<span class="hljs-selector-tag">registry</span>
    <span class="hljs-selector-tag">end</span>

    %% 中间件层
    <span class="hljs-selector-tag">subgraph</span> 中间件层
        <span class="hljs-selector-tag">Redis</span><span class="hljs-selector-attr">[Redis缓存]</span>:::<span class="hljs-selector-tag">middleware</span>
        <span class="hljs-selector-tag">RabbitMQ</span><span class="hljs-selector-attr">[RabbitMQ消息队列]</span>:::<span class="hljs-selector-tag">middleware</span>
        <span class="hljs-selector-tag">Elasticsearch</span><span class="hljs-selector-attr">[Elasticsearch]</span>:::<span class="hljs-selector-tag">middleware</span>
    <span class="hljs-selector-tag">end</span>

    %% 数据层
    <span class="hljs-selector-tag">subgraph</span> 数据层
        <span class="hljs-selector-tag">MySQLMaster</span><span class="hljs-selector-attr">[MySQL主库]</span>:::<span class="hljs-selector-tag">database</span>
        <span class="hljs-selector-tag">MySQLSlave</span><span class="hljs-selector-attr">[MySQL从库]</span>:::<span class="hljs-selector-tag">database</span>
    <span class="hljs-selector-tag">end</span>

    %% 连接关系
    <span class="hljs-selector-tag">Client</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">Gateway</span>

    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">UserService</span>
    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">ProductService</span>
    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">OrderService</span>
    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">PaymentService</span>
    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">CartService</span>
    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">RecommendService</span>
    <span class="hljs-selector-tag">Gateway</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">MessageService</span>

    %% 服务注册（虚线）
    <span class="hljs-selector-tag">UserService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>
    <span class="hljs-selector-tag">ProductService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>
    <span class="hljs-selector-tag">OrderService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>
    <span class="hljs-selector-tag">PaymentService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>
    <span class="hljs-selector-tag">CartService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>
    <span class="hljs-selector-tag">RecommendService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>
    <span class="hljs-selector-tag">MessageService</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|服务注册| <span class="hljs-selector-tag">Nacos</span>

    %% <span class="hljs-selector-tag">Redis</span>连接
    <span class="hljs-selector-tag">UserService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">Redis</span>
    <span class="hljs-selector-tag">ProductService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">Redis</span>
    <span class="hljs-selector-tag">CartService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">Redis</span>

    %% <span class="hljs-selector-tag">RabbitMQ</span>连接
    <span class="hljs-selector-tag">OrderService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">RabbitMQ</span>
    <span class="hljs-selector-tag">PaymentService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">RabbitMQ</span>
    <span class="hljs-selector-tag">MessageService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">RabbitMQ</span>

    %% <span class="hljs-selector-tag">Elasticsearch</span>连接
    <span class="hljs-selector-tag">ProductService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">Elasticsearch</span>
    <span class="hljs-selector-tag">RecommendService</span> <span class="hljs-selector-tag">--</span>&gt; <span class="hljs-selector-tag">Elasticsearch</span>

    %% <span class="hljs-selector-tag">MySQL</span>主库连接（写操作）
    <span class="hljs-selector-tag">UserService</span> <span class="hljs-selector-tag">--</span>&gt;|写| <span class="hljs-selector-tag">MySQLMaster</span>
    <span class="hljs-selector-tag">OrderService</span> <span class="hljs-selector-tag">--</span>&gt;|写| <span class="hljs-selector-tag">MySQLMaster</span>
    <span class="hljs-selector-tag">PaymentService</span> <span class="hljs-selector-tag">--</span>&gt;|写| <span class="hljs-selector-tag">MySQLMaster</span>
    <span class="hljs-selector-tag">ProductService</span> <span class="hljs-selector-tag">--</span>&gt;|写| <span class="hljs-selector-tag">MySQLMaster</span>

    %% <span class="hljs-selector-tag">MySQL</span>主从复制
    <span class="hljs-selector-tag">MySQLMaster</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt;|读写分离| <span class="hljs-selector-tag">MySQLSlave</span>

    %% <span class="hljs-selector-tag">MySQL</span>从库连接（读操作）
    <span class="hljs-selector-tag">UserService</span> <span class="hljs-selector-tag">--</span>&gt;|读| <span class="hljs-selector-tag">MySQLSlave</span>
    <span class="hljs-selector-tag">ProductService</span> <span class="hljs-selector-tag">--</span>&gt;|读| <span class="hljs-selector-tag">MySQLSlave</span>
    <span class="hljs-selector-tag">OrderService</span> <span class="hljs-selector-tag">--</span>&gt;|读| <span class="hljs-selector-tag">MySQLSlave</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28f8dec5f9764ffcb5b3d47d5dc43469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FsdmFkMHM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769223422&amp;x-signature=Gisr0RbjjWopj8p4BixMRO65RzY%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你真的会用 Python 的 print 吗？]]></title>    <link>https://juejin.cn/post/7595842144906592306</link>    <guid>https://juejin.cn/post/7595842144906592306</guid>    <pubDate>2026-01-17T06:42:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595842144906592306" data-draft-id="7595808703074222106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你真的会用 Python 的 print 吗？"/> <meta itemprop="keywords" content="Python,编程语言"/> <meta itemprop="datePublished" content="2026-01-17T06:42:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你真的会用 Python 的 print 吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:42:15.000Z" title="Sat Jan 17 2026 06:42:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！今天我们来聊聊<code>Python</code>里最 <strong>“平平无奇”</strong> 却又无处不在的<code>print()</code>函数。</p>
<p>作为<code>Python</code>开发者，我们几乎每天都在用它，但你真的了解它的所有玩法吗？</p>
<p>其实很多时候，我们只用了它 10% 的功力。</p>
<p>今天，我们就来扒一扒 <code>print</code> 函数的“隐秘角落”。</p>
<p>掌握了它的几个参数，保证让你在同事眼中瞬间变身 <code>Python</code> 资深玩家！</p>
<h2 data-id="heading-0">1. 基础玩法：不仅仅是打印一个字符串</h2>
<p>如果你把鼠标悬停在 <code>print</code> 函数上，你会发现它的第一个参数其实是 <code>*args</code>（或者叫 <code>*objects</code>）。</p>
<p>那个星号 <code>*</code> 意味着它是 <strong>“贪婪”</strong> 的--你可以给它塞进一个，甚至无数个对象。</p>
<p>比如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 普通玩家</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"毛肚"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"鸭肠"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"雪花肥牛"</span>)

<span class="hljs-comment"># 进阶玩家：一次性打印多个</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"毛肚"</span>, <span class="hljs-string">"鸭肠"</span>, <span class="hljs-string">"雪花肥牛"</span>)
<span class="hljs-comment"># 输出：毛肚 鸭肠 雪花肥牛</span>
</code></pre>
<p>更酷的是，如果你有一个列表，你可以直接通过<strong>解包</strong>（<code>Unpacking</code>）把它“炸”开传给 <code>print</code>：</p>
<pre><code class="hljs language-python" lang="python">hotpot_list = [<span class="hljs-string">"虾滑"</span>, <span class="hljs-string">"宽粉"</span>, <span class="hljs-string">"娃娃菜"</span>]
<span class="hljs-built_in">print</span>(hotpot_list)
<span class="hljs-comment"># 输出：['虾滑', '宽粉', '娃娃菜']</span>

<span class="hljs-comment"># 加上星号 * 进行解包</span>
<span class="hljs-built_in">print</span>(*hotpot_list)
<span class="hljs-comment"># 输出：虾滑 宽粉 娃娃菜</span>
</code></pre>
<p>加上<code>*</code>号，列表的方括号没了，逗号也没了，直接变成了清爽的空格分隔。</p>
<h2 data-id="heading-1">2. 拒绝千篇一律的空格：sep 参数</h2>
<p>细心的你可能发现了，上面打印多个元素时，默认是用空格隔开的。</p>
<p>如果你想打印一个日期，或者生成一个 <code>CSV</code> 格式的字符串，空格就显得很尴尬了。</p>
<p>这时候，<code>sep</code>（<strong>separator 分隔符</strong>）参数闪亮登场。</p>
<p>比如：格式化日期</p>
<pre><code class="hljs language-python" lang="python">year = <span class="hljs-number">2026</span>
month = <span class="hljs-number">1</span>
day = <span class="hljs-number">15</span>

<span class="hljs-comment"># 默认情况</span>
<span class="hljs-built_in">print</span>(year, month, day)
<span class="hljs-comment"># 输出：2026 1 15 （不太好看）</span>

<span class="hljs-comment"># 使用 sep 参数</span>
<span class="hljs-built_in">print</span>(year, month, day, sep=<span class="hljs-string">"-"</span>)
<span class="hljs-comment"># 输出：2026-1-15 （这就对了！）</span>
</code></pre>
<p>或者生成一个竖线分割的标题样式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"Python"</span>, <span class="hljs-string">"Java"</span>, <span class="hljs-string">"C++"</span>, sep=<span class="hljs-string">" | "</span>)
<span class="hljs-comment"># 输出：Python | Java | C++</span>
</code></pre>
<p>只要你愿意，<strong>分隔符</strong>可以是<strong>任何字符</strong>，甚至是<strong>一段话</strong>。</p>
<h2 data-id="heading-2">3. 控制结尾的艺术：end 参数</h2>
<p>默认情况下，<code>print</code> 函数是个“急性子”，每打印完一次，它都会自动帮我们敲一个回车换行（<code>\n</code>）。</p>
<p>这就是为什么我们连续写三个 <code>print</code>，它们会显示在三行。</p>
<p>但有时候，我们想把两句话连在一起，或者在同一行输出内容，这时就需要 <code>end</code> 参数出马了。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"凶手其实是"</span>, end=<span class="hljs-string">"......"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"管家！"</span>)
<span class="hljs-comment"># 输出：凶手其实是......管家！</span>
</code></pre>
<p>这样，两行代码的输出无缝衔接在了一起。</p>
<p><strong>注意</strong>： 如果你把 <code>end</code> 设置为空字符串或者非换行符，记得在最后适当地加一个换行，否则你的终端提示符可能会尴尬地挤在文字后面。</p>
<h2 data-id="heading-3">4. 偷偷记笔录：file 参数</h2>
<p>这是很多初学者最容易忽略的参数。</p>
<p><code>print</code> 默认是将内容输出到 <code>sys.stdout</code>（也就是你的屏幕/控制台），但其实，它完全可以把内容“打印”到文件里。</p>
<p>这就相当于你自己写了一个迷你版的日志记录器（<code>Logger</code>），非常适合快速调试或记录脚本运行结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 打开一个文件用于追加内容</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"摸鱼日志.txt"</span>, <span class="hljs-string">"a"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"10:00 - 喝了一杯咖啡"</span>, file=f)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"10:30 - 刷了一会儿推特"</span>, file=f)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"11:00 - 盯着屏幕发呆"</span>, file=f)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"日志记录完毕，请查看 摸鱼日志.txt"</span>)
</code></pre>
<p>运行完这段代码，控制台只会显示最后一句提示，而你的 <strong>“摸鱼记录”</strong> 已经悄悄保存在了 txt 文件里。</p>
<p>虽然对于大型项目我们推荐用 <code>logging</code> 模块，但在这个脚本写的小工具里，用 <code>file</code> 参数简直不要太方便。</p>
<h2 data-id="heading-4">5. 拒绝卡顿，实时刷新：flush 参数</h2>
<p>最后这个参数 <code>flush</code>，常常让新手摸不着头脑。</p>
<p>计算机为了效率，通常会有 <strong>“缓冲区”</strong> 的概念。</p>
<p>当你 <code>print</code> 东西时，它不一定会立刻显示在屏幕上，而是攒够了一波再一起吐出来（特别是当你没有换行的时候）。</p>
<p>这会导致有时候你写了代码，屏幕却像卡死了一样半天没反应。</p>
<p>如果你想做一个倒计时或者进度条，就需要将 <code>flush</code> 设置为 <code>True</code>，强制计算机：“别攒了，立刻给我显示出来！”</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"正在入侵系统"</span>, end=<span class="hljs-string">""</span>)

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"."</span>, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 关键在这里！</span>
    time.sleep(<span class="hljs-number">0.5</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n入侵成功！"</span>)
</code></pre>
<p>如果你不加 <code>flush=True</code>，你可能会发现屏幕卡顿了 <code>2.5</code> 秒，然后一次性蹦出五个点。</p>
<p>加上之后，你就能看到那种 <strong>“嘟...嘟...嘟...”</strong> 的动态加载效果了。</p>
<h2 data-id="heading-5">6. 总结</h2>
<p>虽然在 <code>90%</code> 的日常开发中，我们只需要最简单的 <code>print(x)</code>，但编程的乐趣往往隐藏在剩下的 <code>10%</code> 里。</p>
<ul>
<li><code>*args</code>：让你可以一次打印多个宝贝，或者解包列表。</li>
<li><code>sep</code>：让你自定义元素之间的胶水。</li>
<li><code>end</code>：让你控制话有没有说完（换不换行）。</li>
<li><code>file</code>：让你把话悄悄说给文件听。</li>
<li><code>flush</code>：让你拒绝延迟，即刻兑现。</li>
</ul>
<p>掌握了这些，下次有机会就给同事露一手！</p>
<p>Happy Coding!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI Alibaba与 Agent Scope到底选哪个？]]></title>    <link>https://juejin.cn/post/7595878718171316260</link>    <guid>https://juejin.cn/post/7595878718171316260</guid>    <pubDate>2026-01-17T06:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595878718171316260" data-draft-id="7596181746061082651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI Alibaba与 Agent Scope到底选哪个？"/> <meta itemprop="keywords" content="后端,人工智能,Java"/> <meta itemprop="datePublished" content="2026-01-17T06:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI Alibaba与 Agent Scope到底选哪个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:42:50.000Z" title="Sat Jan 17 2026 06:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Spring AI Alibaba 和 Agent Scope <strong>虽然都出自阿里巴巴</strong>，但它们的核心设计理念、适用场景以及对“Agent（智能体）”的定义有本质的区别。那我们怎么根据自己的场景来选择不同的框架呢？今天就来讲讲这两者适用的不同场景与相关概念，坐稳扶好！</p>
<h2 data-id="heading-1">概念纠正</h2>
<p>有些人总是认为chatbot(ChatGPT、DeepSeek等)就是Agent，其实是错误的。</p>
<p>Agent = LLM(大脑) + Memory(记忆) + Planning(规划) + Tool calling(工具调用)</p>
<p>专业的agent能帮你解决专业领域的问题，自主纠错，自主解决。</p>
<h2 data-id="heading-2">目前的两大发展方向</h2>
<p>无论是什么AI框架，都几乎是这两种发展方向中的一种，第一种是workflow(工作流)，第二种是Agentic(智能体自主模式)。但有趣的是，现在的框架发展虽然大体是其中的一种，但是内部的东西正在朝着两种范式融合走。</p>
<p>因为纯粹的 Agent 太不可控，纯粹的 Workflow 太死板，现在行业正在往中间走，出现了一个新词叫 <strong>Flow Engineering (流程工程)</strong> 。</p>
<p><strong>目前的最佳实践是：</strong> <strong>“外层是 Workflow，节点是 Agent”</strong> 或者 <strong>“大局可控，局部自主”</strong></p>
<p>接下来我们就来讲讲两种模式有什么不同吧</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d80a4e0ac29a4e8b9d76e6db3e89c036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769236969&amp;x-signature=A6lz%2BRp58YL%2FiNUbxNkFzZ2zHds%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">Workflow模式(工作流)</h3>
<p>这种模式认为：<strong>LLM 是一个不可靠的“函数”，我们需要用可靠的代码结构把它“框”住。</strong> 它不相信 AI 的自主规划能力，而是相信<strong>人类工程师的架构设计能力</strong>。</p>
<h4 data-id="heading-4">运行机制</h4>
<ul>
<li>
<p><strong>结构</strong>：显式定义 <code>A -&gt; B -&gt; C</code> 的路径。</p>
</li>
<li>
<p><strong>控制权</strong>：<strong>100% 在代码侧</strong>。你（开发者）决定何时调用 LLM，Prompt 是什么，输出怎么解析，解析失败怎么重试。</p>
</li>
<li>
<p><strong>典型模式</strong>：</p>
<ul>
<li><strong>Prompt Chaining (提示词链)</strong> ：Step 1 的输出作为 Step 2 的输入。</li>
<li><strong>Router (路由)</strong> ：先用一个小模型分类（是“退款”还是“咨询”？），然后 <code>if-else</code> 走到不同的处理链路。</li>
<li><strong>Parallelization (并行)</strong> ：同时让 LLM 翻译成 3 种语言，最后聚合结果。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">后端视角类比</h4>
<ul>
<li><strong>Java</strong>: 就像 <code>CompletableFuture</code> 的编排，或者 Spring Cloud Data Flow。</li>
<li><strong>Go</strong>: 就像通过 Channel 串联的一组 Goroutine Pipeline。</li>
<li><strong>特点</strong>：<strong>幂等性高、延迟低、可测试</strong>。你写个单元测试，输入 A 必然得到 B（或者误差在可控范围内）。</li>
</ul>
<h4 data-id="heading-6">适用场景</h4>
<ul>
<li><strong>RAG（检索增强生成）</strong> ：搜索 -&gt; 排序 -&gt; 生成。路径极其固定。</li>
<li><strong>实体提取 / 结构化数据处理</strong>：从 PDF 提取发票金额。</li>
<li><strong>高风险业务</strong>：金融风控、医疗建议（必须有人类定义的 Checkpoint）</li>
</ul>
<h3 data-id="heading-7">Agentic 模式 (智能体 / 自主模式)</h3>
<p><strong>核心理念：Cognitive Architecture (认知架构)</strong></p>
<p>这种模式认为：<strong>LLM 是一个“大脑”，我们应该给它工具和目标，让它自己找路。</strong> 它容忍过程的<strong>不确定性</strong>，以换取解决<strong>复杂、未知问题</strong>的能力。</p>
<h4 data-id="heading-8">运行机制：Loop (循环)</h4>
<ul>
<li>
<p><strong>结构</strong>：<code>While(任务未完成) { 观察 -&gt; 思考 -&gt; 行动 }</code>。</p>
</li>
<li>
<p><strong>控制权</strong>：<strong>在 LLM 侧</strong>。系统只给一个目标（"帮我写个贪吃蛇游戏"），LLM 自主决定是先写代码，还是先查库，还是先修复报错。</p>
</li>
<li>
<p><strong>核心范式</strong>：</p>
<ul>
<li><strong>ReAct (Reason + Act)</strong> ：推理和行动交替进行。</li>
<li><strong>Reflection (反思)</strong> ：做完了自己检查一遍，“我有 Bug 吗？有的话重写”。</li>
<li><strong>Multi-Agent (多智能体)</strong> ：模拟人类组织，Role A (产品经理) -&gt; Role B (程序员) -&gt; Role C (测试)。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">后端视角类比</h4>
<ul>
<li><strong>架构</strong>：<strong>事件驱动架构 (EDA) + 消息总线</strong>。这更像是<strong>微服务编舞 (Choreography)</strong> ，服务之间通过 Topic 交互，没有中心化的上帝视角控制流程。</li>
<li><strong>Go</strong>: 就像一个死循环的 <code>select</code>，根据不同的信号动态决定执行哪个 <code>case</code>。</li>
<li><strong>特点</strong>：<strong>上限极高，下限极低</strong>。它可能写出惊世骇俗的代码，也可能在一个死循环里空转烧钱，直到 Token 耗尽。</li>
</ul>
<h4 data-id="heading-10">适用场景</h4>
<ul>
<li><strong>开放式任务</strong>：“调研一下现在的 AI 市场竞品并写份报告”。（没法写死步骤，因为搜索结果是不确定的）</li>
<li><strong>代码生成与自动修复</strong>：Devin 类产品。</li>
<li><strong>复杂仿真</strong>：模拟经济系统、游戏 NPC</li>
</ul>
<h2 data-id="heading-11">AgentScope java 和 Spring AI Alibaba的区别</h2>
<p>简单来说，两者的核心设计理念和擅长领域不同。</p>
<ul>
<li>
<p>AgentScope Java：是一个原生为 Agentic 范式设计的框架。它的核心是 “Agent”，旨在帮助你构建以 Agent 为中心、具备自主思考和行动能力的智能应用。</p>
</li>
<li>
<p>Spring AI Alibaba：更侧重于 Workflow 编排。它以 Spring AI 生态和图（Graph）思想为基础，擅长将 AI 能力作为工具，融入到预定义的工作流中。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5482ba0a791e483fbeee5361a92c2deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769236969&amp;x-signature=jzTPFPe%2Fj9%2ByjLVbVxLa5x5%2FX%2FE%3D" alt="96ef27d99d419d3f61205a687f93a27a.jpg" loading="lazy"/></p>
<p>简单来说，就是分业务场景选用不同的框架：</p>
<ul>
<li>如果你追求稳定、流程可控，希望AI根据编排的工作流来作业，场景是RAG、智能客服、辅助工具等等，那就选择Spring AI Alibaba。简单编排可以使用Agent FrameWork，复杂编排可以使用更加底层的Graph。</li>
<li>如果你追求自主、多角色博弈，希望AI可以更加自主的来决定如何完成要求，场景是做类似Manus、虚拟团队等，那就可以选择Agent Scope。</li>
</ul>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>Spring AI Alibaba</strong></th><th><strong>Agent Scope</strong></th></tr></thead><tbody><tr><td><strong>核心理念</strong></td><td><strong>Workflow-Centric (工作流为中心)</strong></td><td><strong>Agent-Centric (智能体为中心)</strong></td></tr><tr><td><strong>控制权</strong></td><td><strong>开发者掌握控制权</strong>。你定义好流程图（Graph），AI 在节点内执行任务。</td><td><strong>模型掌握部分控制权</strong>。AI 根据 ReAct 范式自主决定下一步调用什么工具或联系哪个 Agent。</td></tr><tr><td><strong>通信模式</strong></td><td>传统的服务调用、Event-Driven。</td><td><strong>消息驱动 (Message-Passing)</strong> 。类似 Actor 模型，Agent 之间互发消息。</td></tr><tr><td><strong>技术栈</strong></td><td><strong>纯 Java</strong> (基于 Spring Boot 生态)。</td><td><strong>Python (主打)</strong> + <strong>Java 版本</strong>。</td></tr><tr><td><strong>最强项</strong></td><td>集成企业现有业务、RAG（检索增强）、确定性高的任务编排。</td><td>多智能体协作（Multi-Agent）、复杂仿真模拟、容错与自我修正。</td></tr></tbody></table>
<p>但是值得注意的是，并不是选择了Spring AI Alibaba就不能使用ReAct Agent等，相反，该有的全部都有，后面Spring AI Alibaba还会引入Agent Scope来提高A2A能力。</p>
<h2 data-id="heading-12">总结</h2>
<p>两个框架有相似之处，但是侧重点和设计思想都有不同，可以根据自己的业务场景来进行选择。</p>
<p>如果你觉得这篇文章给你带来了不错的体感，那就点赞 + 收藏 + 关注吧，这是我更新的最大动力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Codex配合chorme-devtools-mcp使用]]></title>    <link>https://juejin.cn/post/7595859552347815988</link>    <guid>https://juejin.cn/post/7595859552347815988</guid>    <pubDate>2026-01-17T06:50:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595859552347815988" data-draft-id="7595858063502540834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Codex配合chorme-devtools-mcp使用"/> <meta itemprop="keywords" content="前端,人工智能,Chrome"/> <meta itemprop="datePublished" content="2026-01-17T06:50:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栗鼠怪"/> <meta itemprop="url" content="https://juejin.cn/user/3544481220790648"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Codex配合chorme-devtools-mcp使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481220790648/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栗鼠怪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:50:36.000Z" title="Sat Jan 17 2026 06:50:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>—— 基于 Codex CLI 的浏览器运行态 AI 调试方案</p>
<blockquote>
<p>本文重点记录 <strong>chrome-devtools-mcp</strong> 在 Windows 环境下的安装、配置与使用实践，<br/>
以及它如何与 <strong>Codex CLI</strong> 协作，构建一个具备<strong>真实浏览器运行态感知能力</strong>的 AI 工程调试环境。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、为什么需要 chrome-devtools-mcp？</h2>
<p>在前端工程实践中，很多问题<strong>仅靠代码是无法定位的</strong>，例如：</p>
<ul>
<li>接口请求失败，但代码看不出问题</li>
<li>Cookie / Token 在 WebView、iOS、登录跳转中丢失</li>
<li>某些逻辑只在真实浏览器运行态才会触发</li>
<li>Console 报错、Network 行为与代码不一致</li>
</ul>
<p>传统 AI 编程工具的局限在于：</p>
<ul>
<li>只能“看代码”</li>
<li>无法感知真实浏览器的 <strong>Network / DOM / Console</strong></li>
</ul>
<h3 data-id="heading-1">chrome-devtools-mcp 的核心价值</h3>
<p><strong>chrome-devtools-mcp</strong> 通过 Chrome DevTools Protocol（CDP），让 AI Agent 能够：</p>
<ul>
<li>启动并控制真实 Chrome</li>
<li>读取 Network 请求与响应</li>
<li>查看 Console 报错</li>
<li>分析 DOM 状态</li>
<li>结合运行态反向定位代码问题</li>
</ul>
<p>这使 AI 从“代码分析器”，升级为 <strong>工程级调试助手</strong>。</p>
<hr/>
<h3 data-id="heading-2">具体流程</h3>
<ol>
<li>安装Codex CLI，大部分开发情况下大家可能使用 Vscode 中 Codex 插件多一点，但是 VsCode中Codex插件并不支持拓展安装mcp，所以先安装
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.openai.com%2Fcodex%2Fcli" target="_blank" title="https://developers.openai.com/codex/cli" ref="nofollow noopener noreferrer">codex cli</a></li>
</ol>

<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># Node 版本要求 &gt;= 22</span>
nvm install <span class="hljs-number">22</span>
nvm <span class="hljs-keyword">use</span> <span class="hljs-number">22.22</span>.<span class="hljs-number">0</span>

npm install -g @openai/codex
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711c4e74ec1447e58880c007d7e141e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCX6byg5oCq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769237436&amp;x-signature=W0cY95XCk%2Bgvs5e6OfLUw%2F4PZyA%3D" alt="image.png" loading="lazy"/>
2. 然后登录Codex CLI</p>
<pre><code class="hljs language-arduino" lang="arduino">codex <span class="hljs-comment">// 命令进入codex 对话</span>
codex login  <span class="hljs-comment">// 授权登录</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7ace38e5e9c468c9bcff67410d477b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCX6byg5oCq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769237436&amp;x-signature=6tIr%2F0JrjcTeIn9bxALOqWLBj3Y%3D" alt="image.png" loading="lazy"/>
完成浏览器授权后，即可在终端中使用 Codex CLI。</p>
<ol start="3">
<li>安装 chrome-devtools-mcp</li>
</ol>

<pre><code class="hljs language-sql" lang="sql">codex mcp <span class="hljs-keyword">add</span> chrome<span class="hljs-operator">-</span>devtools <span class="hljs-comment">-- npx chrome-devtools-mcp@latest</span>
</code></pre>
<p>打开codex配置文件，添加一下配置，因为我的 chrom 安装在了D盘
C:\Users\Administrator.codex\config.toml (全局安装默认路径)</p>
<pre><code class="hljs language-ini" lang="ini">该命令会将 `chrome-devtools-mcp` 注册为 Codex 可用的 MCP Server。
<span class="hljs-section">[mcp_servers.chrome-devtools]</span>
<span class="hljs-attr">command</span> = <span class="hljs-string">"cmd"</span>
<span class="hljs-attr">args</span> = [
  <span class="hljs-string">"/c"</span>,
  <span class="hljs-string">"npx"</span>,
  <span class="hljs-string">"-y"</span>,
  <span class="hljs-string">"chrome-devtools-mcp@latest"</span>
]

!<span class="hljs-section">[image.png]</span>(https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5245d1aa5f3407cb738588390e9817e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCX6byg5oCq:q75.awebp?<span class="hljs-attr">rk3s</span>=f64ab15b&amp;x-expires=<span class="hljs-number">1769237436</span>&amp;x-signature=LgJ0gBB%<span class="hljs-number">2</span>B9py4afoNAf46iHkI3DA%<span class="hljs-number">3</span>D)
<span class="hljs-attr">env</span> = { 
  <span class="hljs-attr">SystemRoot</span> = <span class="hljs-string">"C:\\Windows"</span>,
  <span class="hljs-attr">CHROME_PATH</span> = <span class="hljs-string">"D:\\software\\chrome\\Google\\Chrome\\Application\\chrome.exe"</span>
}

<span class="hljs-attr">startup_timeout_ms</span> = <span class="hljs-number">30000</span>

// 无需执行chrome.exe <span class="hljs-attr">--remote-debugging-port</span>=<span class="hljs-number">9222</span> 他会自行启动
</code></pre>
<p>4.  接下来就大功告成，可以输入命令操控浏览器
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e239129e4baf4598a0d8c3ded7cf75cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCX6byg5oCq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769237436&amp;x-signature=i4orkBK1CXZLc8fiqVgYcx1r7Rk%3D" alt="image.png" loading="lazy"/></p>
<p>总结：当前阶段侧重 <strong>环境与方案搭建</strong>。，后续有在日常编码中调试使用上的体验在反馈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[部署翻车现场：那些年我们踩过的坑]]></title>    <link>https://juejin.cn/post/7595878718171250724</link>    <guid>https://juejin.cn/post/7595878718171250724</guid>    <pubDate>2026-01-17T06:08:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595878718171250724" data-draft-id="7595911076013850660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="部署翻车现场：那些年我们踩过的坑"/> <meta itemprop="keywords" content="CI/CD"/> <meta itemprop="datePublished" content="2026-01-17T06:08:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            部署翻车现场：那些年我们踩过的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T06:08:06.000Z" title="Sat Jan 17 2026 06:08:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">凌晨三点，生产环境炸了</h2>
<p>周五晚上 11 点，你刚准备关电脑下班。</p>
<p>"应该没事吧？就改了一行代码。"</p>
<p>你点击了部署按钮。</p>
<p>三分钟后，运维群炸了：</p>
<p>"网站打不开了！"
"数据库连接失败！"
"用户疯狂投诉！"
"老板在问怎么回事！"</p>
<p>你的手开始发抖，冷汗直冒。</p>
<p><strong>这不是电影情节，这是每个开发者都可能经历的噩梦。</strong></p>
<p>今天，我们就来聊聊那些年我们在部署时踩过的坑，以及如何避免它们。</p>
<hr/>
<h2 data-id="heading-1">错误 1：直接在生产环境改代码</h2>
<h3 data-id="heading-2">灾难现场</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># SSH 连接到生产服务器</span>
ssh root@production-server

<span class="hljs-comment"># 直接修改代码</span>
vim /var/www/app/index.js

<span class="hljs-comment"># 改完重启服务</span>
pm2 restart app

<span class="hljs-comment"># 结果：网站挂了，而且不知道改了什么 💥</span>
</code></pre>
<p><strong>为什么这样做？</strong></p>
<ul>
<li>"就改一行，很快的"</li>
<li>"测试环境太慢了"</li>
<li>"紧急修复，来不及走流程"</li>
</ul>
<p><strong>为什么会翻车？</strong></p>
<ol>
<li><strong>没有版本控制</strong>：改了什么？谁改的？什么时候改的？全都不知道</li>
<li><strong>无法回滚</strong>：出问题了想恢复？对不起，没有备份</li>
<li><strong>没有测试</strong>：直接在生产环境测试，用户就是你的测试员</li>
<li><strong>团队不知情</strong>：其他人不知道你改了什么，后续维护一脸懵逼</li>
</ol>
<h3 data-id="heading-3">正确姿势：永远不要直接改生产环境</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 正确的流程</span>

<span class="hljs-comment"># 1. 在本地开发分支修改</span>
git checkout -b hotfix/urgent-bug
<span class="hljs-comment"># 修改代码...</span>
git add .
git commit -m <span class="hljs-string">"fix: 修复紧急 bug"</span>

<span class="hljs-comment"># 2. 推送到远程仓库</span>
git push origin hotfix/urgent-bug

<span class="hljs-comment"># 3. 创建 Pull Request，代码审查</span>
<span class="hljs-comment"># 4. 合并到主分支</span>
<span class="hljs-comment"># 5. 触发 CI/CD 自动部署</span>

<span class="hljs-comment"># 或者使用 Git Flow</span>
git flow hotfix start urgent-bug
<span class="hljs-comment"># 修改代码...</span>
git flow hotfix finish urgent-bug
</code></pre>
<p><strong>黄金法则：</strong></p>
<ul>
<li>✅ 所有代码修改都要经过版本控制</li>
<li>✅ 所有部署都要经过 CI/CD 流程</li>
<li>✅ 生产环境只读，不可写</li>
<li>✅ 紧急修复也要走流程（可以简化，但不能跳过）</li>
</ul>
<hr/>
<h2 data-id="heading-4">错误 2：没有回滚计划，出问题就慌了</h2>
<h3 data-id="heading-5">灾难现场</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 部署新版本</span>
./deploy.sh v2.0.0

<span class="hljs-comment"># 5 分钟后发现问题</span>
<span class="hljs-comment"># 想回滚，但是...</span>

<span class="hljs-comment"># ❌ 没有保留旧版本</span>
<span class="hljs-comment"># ❌ 数据库已经迁移，无法回退</span>
<span class="hljs-comment"># ❌ 配置文件被覆盖</span>
<span class="hljs-comment"># ❌ 不知道怎么回滚</span>

<span class="hljs-comment"># 结果：网站挂了 2 小时，损失惨重</span>
</code></pre>
<p><strong>真实案例：</strong></p>
<p>某电商网站在双十一当天部署新版本，结果支付功能出现 bug。因为没有回滚方案，工程师花了 3 小时才修复，损失订单数千万。</p>
<h3 data-id="heading-6">正确姿势：部署前先准备好回滚方案</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 蓝绿部署（Blue-Green Deployment）</span>

<span class="hljs-comment"># 1. 保留旧版本（蓝色环境）</span>
<span class="hljs-comment"># 2. 部署新版本到新环境（绿色环境）</span>
<span class="hljs-comment"># 3. 切换流量到绿色环境</span>
<span class="hljs-comment"># 4. 观察一段时间</span>
<span class="hljs-comment"># 5. 如果有问题，立即切回蓝色环境</span>

<span class="hljs-comment"># Nginx 配置示例</span>
upstream backend {
    server blue.example.com:3000;   <span class="hljs-comment"># 旧版本</span>
    <span class="hljs-comment"># server green.example.com:3000;  # 新版本（注释掉）</span>
}

<span class="hljs-comment"># 部署新版本后，只需要修改配置</span>
upstream backend {
    <span class="hljs-comment"># server blue.example.com:3000;   # 旧版本（注释掉）</span>
    server green.example.com:3000;  <span class="hljs-comment"># 新版本</span>
}

<span class="hljs-comment"># 重载 Nginx（不中断服务）</span>
nginx -s reload

<span class="hljs-comment"># 如果出问题，立即切回</span>
upstream backend {
    server blue.example.com:3000;   <span class="hljs-comment"># 切回旧版本</span>
}
nginx -s reload
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ Kubernetes 滚动更新 + 快速回滚</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">strategy:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span>
    <span class="hljs-attr">rollingUpdate:</span>
      <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># 最多多出 1 个 Pod</span>
      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># 最多 0 个 Pod 不可用</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:v2.0.0</span>

<span class="hljs-comment"># 部署</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">deployment.yaml</span>

<span class="hljs-comment"># 查看部署状态</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">status</span> <span class="hljs-string">deployment/myapp</span>

<span class="hljs-comment"># 如果出问题，一键回滚</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">undo</span> <span class="hljs-string">deployment/myapp</span>

<span class="hljs-comment"># 回滚到指定版本</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">undo</span> <span class="hljs-string">deployment/myapp</span> <span class="hljs-string">--to-revision=2</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 使用 PM2 的部署和回滚</span>
<span class="hljs-comment">// ecosystem.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">apps</span>: [{
    <span class="hljs-attr">name</span>: <span class="hljs-string">'myapp'</span>,
    <span class="hljs-attr">script</span>: <span class="hljs-string">'./app.js'</span>,
    <span class="hljs-attr">instances</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">exec_mode</span>: <span class="hljs-string">'cluster'</span>,
    <span class="hljs-attr">env</span>: {
      <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">'production'</span>
    }
  }],
  <span class="hljs-attr">deploy</span>: {
    <span class="hljs-attr">production</span>: {
      <span class="hljs-attr">user</span>: <span class="hljs-string">'deploy'</span>,
      <span class="hljs-attr">host</span>: <span class="hljs-string">'production-server'</span>,
      <span class="hljs-attr">ref</span>: <span class="hljs-string">'origin/main'</span>,
      <span class="hljs-attr">repo</span>: <span class="hljs-string">'git@github.com:user/repo.git'</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">'/var/www/myapp'</span>,
      <span class="hljs-string">'post-deploy'</span>: <span class="hljs-string">'npm install &amp;&amp; pm2 reload ecosystem.config.js'</span>
    }
  }
}

<span class="hljs-comment">// 部署</span>
pm2 deploy production

<span class="hljs-comment">// 回滚到上一个版本</span>
pm2 deploy production revert <span class="hljs-number">1</span>
</code></pre>
<p><strong>回滚检查清单：</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 代码可以快速回滚（保留旧版本）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 数据库迁移可逆（或者分两步部署）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 配置文件有备份</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 静态资源有版本控制</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 有回滚演练（定期测试回滚流程）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 回滚时间 &lt; 5 分钟</li>
</ul>
<hr/>
<h2 data-id="heading-7">错误 3：数据库迁移和代码部署一起搞</h2>
<h3 data-id="heading-8">灾难现场</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ❌ 错误的做法：同时部署代码和数据库迁移</span>

<span class="hljs-comment"># deploy.sh</span>
git pull
npm install
npm run db:migrate  <span class="hljs-comment"># 数据库迁移</span>
pm2 restart app     <span class="hljs-comment"># 重启应用</span>

<span class="hljs-comment"># 结果：</span>
<span class="hljs-comment"># 1. 迁移过程中，旧代码访问新表结构 → 报错</span>
<span class="hljs-comment"># 2. 迁移失败，但代码已经部署 → 不兼容</span>
<span class="hljs-comment"># 3. 想回滚，但数据库已经改了 → 数据丢失风险</span>
</code></pre>
<p><strong>真实案例：</strong></p>
<p>某社交平台在部署时，同时执行了"删除旧字段"的数据库迁移和"使用新字段"的代码部署。结果在部署过程中，部分服务器还在使用旧代码访问已删除的字段，导致大量报错。</p>
<h3 data-id="heading-9">正确姿势：数据库迁移分三步走</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 正确的做法：向后兼容的数据库迁移</span>

<span class="hljs-comment"># === 第一步：添加新字段（不删除旧字段）===</span>
<span class="hljs-comment"># 迁移脚本 001_add_new_column.sql</span>
ALTER TABLE <span class="hljs-built_in">users</span> ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;

<span class="hljs-comment"># 部署迁移</span>
npm run db:migrate

<span class="hljs-comment"># 此时：旧代码和新代码都能正常运行</span>

<span class="hljs-comment"># === 第二步：部署新代码（同时支持新旧字段）===</span>
<span class="hljs-comment"># 新代码</span>
class User {
  async <span class="hljs-function"><span class="hljs-title">save</span></span>() {
    // 同时写入新旧字段
    await db.query(`
      UPDATE <span class="hljs-built_in">users</span>
      SET
        email_verified = <span class="hljs-variable">$1</span>,
        is_verified = <span class="hljs-variable">$1</span>  -- 旧字段也更新
      WHERE <span class="hljs-built_in">id</span> = <span class="hljs-variable">$2</span>
    `, [this.emailVerified, this.id])
  }

  async <span class="hljs-function"><span class="hljs-title">load</span></span>() {
    // 优先读取新字段，fallback 到旧字段
    const user = await db.query(<span class="hljs-string">'SELECT * FROM users WHERE id = $1'</span>, [this.id])
    this.emailVerified = user.email_verified ?? user.is_verified
  }
}

<span class="hljs-comment"># 部署新代码</span>
git pull
npm install
pm2 restart app

<span class="hljs-comment"># 此时：新旧代码都能正常运行</span>

<span class="hljs-comment"># === 第三步：观察一段时间后，删除旧字段 ===</span>
<span class="hljs-comment"># 等待 1-2 周，确认没问题后</span>
<span class="hljs-comment"># 迁移脚本 002_remove_old_column.sql</span>
ALTER TABLE <span class="hljs-built_in">users</span> DROP COLUMN is_verified;

<span class="hljs-comment"># 部署迁移</span>
npm run db:migrate
</code></pre>
<p><strong>数据库迁移黄金法则：</strong></p>
<ol>
<li><strong>向后兼容</strong>：新迁移不能破坏旧代码</li>
<li><strong>分步进行</strong>：添加 → 部署代码 → 删除</li>
<li><strong>可回滚</strong>：每个迁移都要有回滚脚本</li>
<li><strong>小步快跑</strong>：一次迁移只做一件事</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 使用迁移工具（Knex.js 示例）</span>
<span class="hljs-comment">// migrations/20250117_add_email_verified.js</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">up</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">knex</span>) {
  <span class="hljs-keyword">return</span> knex.<span class="hljs-property">schema</span>.<span class="hljs-title function_">table</span>(<span class="hljs-string">'users'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">table</span>) {
    table.<span class="hljs-title function_">boolean</span>(<span class="hljs-string">'email_verified'</span>).<span class="hljs-title function_">defaultTo</span>(<span class="hljs-literal">false</span>)
  })
}

<span class="hljs-built_in">exports</span>.<span class="hljs-property">down</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">knex</span>) {
  <span class="hljs-keyword">return</span> knex.<span class="hljs-property">schema</span>.<span class="hljs-title function_">table</span>(<span class="hljs-string">'users'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">table</span>) {
    table.<span class="hljs-title function_">dropColumn</span>(<span class="hljs-string">'email_verified'</span>)
  })
}

<span class="hljs-comment">// 执行迁移</span>
knex <span class="hljs-attr">migrate</span>:latest

<span class="hljs-comment">// 回滚迁移</span>
knex <span class="hljs-attr">migrate</span>:rollback
</code></pre>
<hr/>
<h2 data-id="heading-10">错误 4：环境变量管理混乱</h2>
<h3 data-id="heading-11">灾难现场</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 硬编码配置</span>
<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">database</span>: {
    <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">5432</span>,
    <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">'admin123'</span>  <span class="hljs-comment">// 密码写死在代码里！</span>
  },
  <span class="hljs-attr">apiKey</span>: <span class="hljs-string">'sk-1234567890abcdef'</span>,  <span class="hljs-comment">// API 密钥也写死！</span>
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 生产环境还开着 debug！</span>
}

<span class="hljs-comment">// 提交到 Git</span>
git add config.<span class="hljs-property">js</span>
git commit -m <span class="hljs-string">"add config"</span>
git push

<span class="hljs-comment">// 结果：</span>
<span class="hljs-comment">// 1. 密码泄露到 GitHub</span>
<span class="hljs-comment">// 2. 所有环境用同一个配置</span>
<span class="hljs-comment">// 3. 改配置要重新部署代码</span>
</code></pre>
<h3 data-id="heading-12">正确姿势：使用环境变量和密钥管理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 使用 .env 文件（不提交到 Git）</span>

<span class="hljs-comment"># .env.example（提交到 Git，作为模板）</span>
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=your_username
DATABASE_PASSWORD=your_password
API_KEY=your_api_key
NODE_ENV=development

<span class="hljs-comment"># .env（不提交到 Git，包含真实密钥）</span>
DATABASE_HOST=prod-db.example.com
DATABASE_PORT=5432
DATABASE_USER=prod_user
DATABASE_PASSWORD=super_secret_password_123
API_KEY=sk-real-api-key-here
NODE_ENV=production

<span class="hljs-comment"># .gitignore</span>
.<span class="hljs-built_in">env</span>
.env.local
.<span class="hljs-built_in">env</span>.*.<span class="hljs-built_in">local</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 代码中使用环境变量</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"dotenv"</span>).<span class="hljs-title function_">config</span>()

<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">database</span>: {
    <span class="hljs-attr">host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_HOST</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_PORT</span>),
    <span class="hljs-attr">username</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_USER</span>,
    <span class="hljs-attr">password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_PASSWORD</span>,
  },
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_KEY</span>,
  <span class="hljs-attr">debug</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">"production"</span>,
}

<span class="hljs-comment">// 验证必需的环境变量</span>
<span class="hljs-keyword">const</span> requiredEnvVars = [
  <span class="hljs-string">"DATABASE_HOST"</span>,
  <span class="hljs-string">"DATABASE_USER"</span>,
  <span class="hljs-string">"DATABASE_PASSWORD"</span>,
  <span class="hljs-string">"API_KEY"</span>,
]

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> envVar <span class="hljs-keyword">of</span> requiredEnvVars) {
  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">env</span>[envVar]) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Missing required environment variable: <span class="hljs-subst">${envVar}</span>`</span>)
  }
}
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ Docker Compose 管理环境变量</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">"3.8"</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:latest</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">NODE_ENV=production</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DATABASE_HOST=${DATABASE_HOST}</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DATABASE_PASSWORD=${DATABASE_PASSWORD}</span>
    <span class="hljs-attr">env_file:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.env.production</span>
    <span class="hljs-attr">secrets:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db_password</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">api_key</span>

<span class="hljs-attr">secrets:</span>
  <span class="hljs-attr">db_password:</span>
    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">api_key:</span>
    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span>
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ Kubernetes Secrets</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">app-secrets</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">database-password:</span> <span class="hljs-string">c3VwZXJfc2VjcmV0X3Bhc3N3b3Jk</span> <span class="hljs-comment"># base64 编码</span>
  <span class="hljs-attr">api-key:</span> <span class="hljs-string">c2stcmVhbC1hcGkta2V5LWhlcmU=</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:latest</span>
          <span class="hljs-attr">env:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DATABASE_PASSWORD</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">secretKeyRef:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">app-secrets</span>
                  <span class="hljs-attr">key:</span> <span class="hljs-string">database-password</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">API_KEY</span>
              <span class="hljs-attr">valueFrom:</span>
                <span class="hljs-attr">secretKeyRef:</span>
                  <span class="hljs-attr">name:</span> <span class="hljs-string">app-secrets</span>
                  <span class="hljs-attr">key:</span> <span class="hljs-string">api-key</span>
</code></pre>
<p><strong>环境变量管理最佳实践：</strong></p>
<ol>
<li><strong>永远不要提交密钥到 Git</strong></li>
<li><strong>使用密钥管理服务</strong>（AWS Secrets Manager、HashiCorp Vault）</li>
<li><strong>不同环境使用不同的密钥</strong></li>
<li><strong>定期轮换密钥</strong></li>
<li><strong>最小权限原则</strong>（每个服务只能访问它需要的密钥）</li>
</ol>
<hr/>
<h2 data-id="heading-13">错误 5：没有健康检查，部署完就不管了</h2>
<h3 data-id="heading-14">灾难现场</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ❌ 简单粗暴的部署脚本</span>
<span class="hljs-comment">#!/bin/bash</span>
git pull
npm install
pm2 restart app

<span class="hljs-built_in">echo</span> <span class="hljs-string">"部署完成！"</span>
<span class="hljs-comment"># 然后就不管了...</span>

<span class="hljs-comment"># 实际情况：</span>
<span class="hljs-comment"># - 应用启动失败了，但 pm2 显示 "online"</span>
<span class="hljs-comment"># - 数据库连接不上，但没人知道</span>
<span class="hljs-comment"># - 内存泄漏，1 小时后服务挂了</span>
<span class="hljs-comment"># - 用户疯狂投诉，但监控没报警</span>
</code></pre>
<h3 data-id="heading-15">正确姿势：完善的健康检查和监控</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 实现健康检查端点</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>)
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()

<span class="hljs-comment">// 简单的健康检查</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/health"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">status</span>: <span class="hljs-string">"ok"</span> })
})

<span class="hljs-comment">// 详细的健康检查</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/health/detailed"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> health = {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"ok"</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">uptime</span>: process.<span class="hljs-title function_">uptime</span>(),
    <span class="hljs-attr">checks</span>: {},
  }

  <span class="hljs-comment">// 检查数据库连接</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">query</span>(<span class="hljs-string">"SELECT 1"</span>)
    health.<span class="hljs-property">checks</span>.<span class="hljs-property">database</span> = { <span class="hljs-attr">status</span>: <span class="hljs-string">"ok"</span> }
  } <span class="hljs-keyword">catch</span> (error) {
    health.<span class="hljs-property">checks</span>.<span class="hljs-property">database</span> = {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
    }
    health.<span class="hljs-property">status</span> = <span class="hljs-string">"error"</span>
  }

  <span class="hljs-comment">// 检查 Redis 连接</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">ping</span>()
    health.<span class="hljs-property">checks</span>.<span class="hljs-property">redis</span> = { <span class="hljs-attr">status</span>: <span class="hljs-string">"ok"</span> }
  } <span class="hljs-keyword">catch</span> (error) {
    health.<span class="hljs-property">checks</span>.<span class="hljs-property">redis</span> = {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
    }
    health.<span class="hljs-property">status</span> = <span class="hljs-string">"error"</span>
  }

  <span class="hljs-comment">// 检查磁盘空间</span>
  <span class="hljs-keyword">const</span> diskUsage = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkDiskUsage</span>()
  <span class="hljs-keyword">if</span> (diskUsage &gt; <span class="hljs-number">90</span>) {
    health.<span class="hljs-property">checks</span>.<span class="hljs-property">disk</span> = {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"warning"</span>,
      <span class="hljs-attr">usage</span>: <span class="hljs-string">`<span class="hljs-subst">${diskUsage}</span>%`</span>,
    }
    health.<span class="hljs-property">status</span> = <span class="hljs-string">"warning"</span>
  } <span class="hljs-keyword">else</span> {
    health.<span class="hljs-property">checks</span>.<span class="hljs-property">disk</span> = {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"ok"</span>,
      <span class="hljs-attr">usage</span>: <span class="hljs-string">`<span class="hljs-subst">${diskUsage}</span>%`</span>,
    }
  }

  <span class="hljs-comment">// 检查内存使用</span>
  <span class="hljs-keyword">const</span> memUsage = process.<span class="hljs-title function_">memoryUsage</span>()
  health.<span class="hljs-property">checks</span>.<span class="hljs-property">memory</span> = {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"ok"</span>,
    <span class="hljs-attr">heapUsed</span>: <span class="hljs-string">`<span class="hljs-subst">${(memUsage.heapUsed / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> MB`</span>,
    <span class="hljs-attr">heapTotal</span>: <span class="hljs-string">`<span class="hljs-subst">${(memUsage.heapTotal / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span> MB`</span>,
  }

  <span class="hljs-keyword">const</span> statusCode = health.<span class="hljs-property">status</span> === <span class="hljs-string">"ok"</span> ? <span class="hljs-number">200</span> : <span class="hljs-number">503</span>
  res.<span class="hljs-title function_">status</span>(statusCode).<span class="hljs-title function_">json</span>(health)
})

<span class="hljs-comment">// 就绪检查（Readiness Probe）</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/ready"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-comment">// 检查应用是否准备好接收流量</span>
  <span class="hljs-keyword">const</span> isReady = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkIfReady</span>()
  <span class="hljs-keyword">if</span> (isReady) {
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">ready</span>: <span class="hljs-literal">true</span> })
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">503</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">ready</span>: <span class="hljs-literal">false</span> })
  }
})

<span class="hljs-comment">// 存活检查（Liveness Probe）</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/alive"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 简单检查进程是否还活着</span>
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">alive</span>: <span class="hljs-literal">true</span> })
})
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ Kubernetes 健康检查配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:latest</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3000</span>

          <span class="hljs-comment"># 存活探针：检查容器是否还活着</span>
          <span class="hljs-attr">livenessProbe:</span>
            <span class="hljs-attr">httpGet:</span>
              <span class="hljs-attr">path:</span> <span class="hljs-string">/alive</span>
              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment"># 启动后 30 秒开始检查</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># 每 10 秒检查一次</span>
            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 超时时间 5 秒</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 失败 3 次后重启容器</span>

          <span class="hljs-comment"># 就绪探针：检查容器是否准备好接收流量</span>
          <span class="hljs-attr">readinessProbe:</span>
            <span class="hljs-attr">httpGet:</span>
              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span>
              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>
            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span>

          <span class="hljs-comment"># 启动探针：检查容器是否启动成功</span>
          <span class="hljs-attr">startupProbe:</span>
            <span class="hljs-attr">httpGet:</span>
              <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>
              <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">0</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>
            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">30</span> <span class="hljs-comment"># 最多等待 150 秒（30 * 5）</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 部署后自动验证脚本</span>
<span class="hljs-comment">#!/bin/bash</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始部署..."</span>

<span class="hljs-comment"># 1. 部署新版本</span>
kubectl apply -f deployment.yaml

<span class="hljs-comment"># 2. 等待部署完成</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"等待部署完成..."</span>
kubectl rollout status deployment/myapp --<span class="hljs-built_in">timeout</span>=5m

<span class="hljs-comment"># 3. 检查健康状态</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检查健康状态..."</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {1..30}; <span class="hljs-keyword">do</span>
  HTTP_CODE=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> http://myapp.example.com/health)

  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$HTTP_CODE</span>"</span> == <span class="hljs-string">"200"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 健康检查通过"</span>
    <span class="hljs-built_in">break</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"⏳ 等待服务就绪... (<span class="hljs-variable">$i</span>/30)"</span>
    <span class="hljs-built_in">sleep</span> 10
  <span class="hljs-keyword">fi</span>

  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$i</span> -eq 30 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 健康检查失败，开始回滚"</span>
    kubectl rollout undo deployment/myapp
    <span class="hljs-built_in">exit</span> 1
  <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 4. 冒烟测试</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"执行冒烟测试..."</span>
SMOKE_TEST_RESULT=$(curl -s http://myapp.example.com/api/test)

<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$SMOKE_TEST_RESULT</span> == *<span class="hljs-string">"success"</span>* ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 冒烟测试通过"</span>
<span class="hljs-keyword">else</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 冒烟测试失败，开始回滚"</span>
  kubectl rollout undo deployment/myapp
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 5. 监控关键指标</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"监控关键指标 5 分钟..."</span>
<span class="hljs-built_in">sleep</span> 300

ERROR_RATE=$(curl -s <span class="hljs-string">"http://prometheus.example.com/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])"</span>)

<span class="hljs-keyword">if</span> (( $(echo "<span class="hljs-variable">$ERROR_RATE</span> &gt; <span class="hljs-number">0.01</span>" | bc -l) )); <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 错误率过高，开始回滚"</span>
  kubectl rollout undo deployment/myapp
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🎉 部署成功！"</span>
</code></pre>
<hr/>
<h2 data-id="heading-16">错误 6：周五下午部署，周末背锅</h2>
<h3 data-id="heading-17">灾难现场</h3>
<pre><code class="hljs language-swift" lang="swift">周五下午 <span class="hljs-number">5</span>:<span class="hljs-number">30</span>
开发：就一个小改动，部署一下吧
运维：行吧，反正马上下班了

周五晚上 <span class="hljs-number">8</span>:<span class="hljs-number">00</span>
用户：网站怎么打不开了？

周五晚上 <span class="hljs-number">8</span>:<span class="hljs-number">30</span>
老板：<span class="hljs-meta">@全体成员</span> 紧急会议

周六凌晨 <span class="hljs-number">3</span>:<span class="hljs-number">00</span>
团队：终于修好了<span class="hljs-operator">...</span>

周一早上
老板：以后周五不准部署！
</code></pre>
<p><strong>真实数据：</strong></p>
<ul>
<li>70% 的生产事故发生在周五下午到周日</li>
<li>周五部署的回滚率是平时的 3 倍</li>
<li>周末修复问题的平均时间是工作日的 2 倍</li>
</ul>
<h3 data-id="heading-18">正确姿势：制定部署时间窗口</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ 部署时间规则</span>

<span class="hljs-string">允许部署的时间：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">周一到周四：10:00</span> <span class="hljs-bullet">-</span> <span class="hljs-number">16</span><span class="hljs-string">:00</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">周五：10:00</span> <span class="hljs-bullet">-</span> <span class="hljs-number">14</span><span class="hljs-string">:00（留出时间观察）</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">周末和节假日：禁止部署（除非紧急情况）</span>

<span class="hljs-string">禁止部署的时间：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">业务高峰期（如电商的晚上</span> <span class="hljs-number">8</span><span class="hljs-number">-10</span> <span class="hljs-string">点）</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">重大活动前后（如双十一、春节）</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">下班前</span> <span class="hljs-number">2</span> <span class="hljs-string">小时</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">周五下午</span>

<span class="hljs-string">紧急部署流程：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">需要技术负责人批准</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">需要完整的回滚方案</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">需要相关人员待命</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">需要详细的风险评估</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 自动检查部署时间</span>
<span class="hljs-comment">// deploy-time-check.js</span>
<span class="hljs-keyword">const</span> moment = <span class="hljs-built_in">require</span>(<span class="hljs-string">"moment"</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">canDeploy</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title function_">moment</span>()
  <span class="hljs-keyword">const</span> hour = now.<span class="hljs-title function_">hour</span>()
  <span class="hljs-keyword">const</span> day = now.<span class="hljs-title function_">day</span>() <span class="hljs-comment">// 0 = 周日, 6 = 周六</span>

  <span class="hljs-comment">// 周末禁止部署</span>
  <span class="hljs-keyword">if</span> (day === <span class="hljs-number">0</span> || day === <span class="hljs-number">6</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">allowed</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">reason</span>: <span class="hljs-string">"周末禁止部署"</span>,
    }
  }

  <span class="hljs-comment">// 周五下午 2 点后禁止部署</span>
  <span class="hljs-keyword">if</span> (day === <span class="hljs-number">5</span> &amp;&amp; hour &gt;= <span class="hljs-number">14</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">allowed</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">reason</span>: <span class="hljs-string">"周五下午 2 点后禁止部署"</span>,
    }
  }

  <span class="hljs-comment">// 工作日只允许 10:00 - 16:00 部署</span>
  <span class="hljs-keyword">if</span> (hour &lt; <span class="hljs-number">10</span> || hour &gt;= <span class="hljs-number">16</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">allowed</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">reason</span>: <span class="hljs-string">"只允许在 10:00 - 16:00 部署"</span>,
    }
  }

  <span class="hljs-comment">// 检查是否在业务高峰期</span>
  <span class="hljs-keyword">if</span> (hour &gt;= <span class="hljs-number">20</span> &amp;&amp; hour &lt;= <span class="hljs-number">22</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">allowed</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">reason</span>: <span class="hljs-string">"业务高峰期禁止部署"</span>,
    }
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">allowed</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">reason</span>: <span class="hljs-string">"可以部署"</span>,
  }
}

<span class="hljs-comment">// 在 CI/CD 流程中使用</span>
<span class="hljs-keyword">const</span> deployCheck = <span class="hljs-title function_">canDeploy</span>()
<span class="hljs-keyword">if</span> (!deployCheck.<span class="hljs-property">allowed</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 部署被阻止: <span class="hljs-subst">${deployCheck.reason}</span>`</span>)
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ <span class="hljs-subst">${deployCheck.reason}</span>`</span>)
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ GitHub Actions 部署时间限制</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Production</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">check-deploy-time:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">if</span> <span class="hljs-string">deployment</span> <span class="hljs-string">is</span> <span class="hljs-string">allowed</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          HOUR=$(date +%H)
          DAY=$(date +%u)  # 1-7 (周一到周日)
</span>
          <span class="hljs-comment"># 周末禁止部署</span>
          <span class="hljs-string">if</span> [ <span class="hljs-string">$DAY</span> <span class="hljs-string">-eq</span> <span class="hljs-number">6</span> ] <span class="hljs-string">||</span> [ <span class="hljs-string">$DAY</span> <span class="hljs-string">-eq</span> <span class="hljs-number">7</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"❌ 周末禁止部署"</span>
            <span class="hljs-string">exit</span> <span class="hljs-number">1</span>
          <span class="hljs-string">fi</span>

          <span class="hljs-comment"># 周五下午 2 点后禁止部署</span>
          <span class="hljs-string">if</span> [ <span class="hljs-string">$DAY</span> <span class="hljs-string">-eq</span> <span class="hljs-number">5</span> ] <span class="hljs-string">&amp;&amp;</span> [ <span class="hljs-string">$HOUR</span> <span class="hljs-string">-ge</span> <span class="hljs-number">14</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"❌ 周五下午 2 点后禁止部署"</span>
            <span class="hljs-string">exit</span> <span class="hljs-number">1</span>
          <span class="hljs-string">fi</span>

          <span class="hljs-comment"># 只允许 10:00 - 16:00 部署</span>
          <span class="hljs-string">if</span> [ <span class="hljs-string">$HOUR</span> <span class="hljs-string">-lt</span> <span class="hljs-number">10</span> ] <span class="hljs-string">||</span> [ <span class="hljs-string">$HOUR</span> <span class="hljs-string">-ge</span> <span class="hljs-number">16</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"❌ 只允许在 10:00 - 16:00 部署"</span>
            <span class="hljs-string">exit</span> <span class="hljs-number">1</span>
          <span class="hljs-string">fi</span>

          <span class="hljs-string">echo</span> <span class="hljs-string">"✅ 可以部署"</span>

  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">check-deploy-time</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 部署逻辑...
</span></code></pre>
<hr/>
<h2 data-id="heading-19">错误 7：没有灰度发布，一上线就全量</h2>
<h3 data-id="heading-20">灾难现场</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ❌ 直接全量部署</span>
kubectl <span class="hljs-built_in">set</span> image deployment/myapp myapp=myapp:v2.0.0

<span class="hljs-comment"># 结果：</span>
<span class="hljs-comment"># - 新版本有 bug，影响所有用户</span>
<span class="hljs-comment"># - 发现问题时已经来不及了</span>
<span class="hljs-comment"># - 回滚需要时间，损失已经造成</span>
</code></pre>
<p><strong>真实案例：</strong></p>
<p>某视频网站直接全量部署新版本，结果新版本的视频播放器在某些浏览器上无法正常工作。等发现问题时，已经有数百万用户受影响，投诉电话打爆了客服。</p>
<h3 data-id="heading-21">正确姿势：灰度发布（金丝雀部署）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ Kubernetes 金丝雀部署</span>

<span class="hljs-comment"># 1. 保留旧版本（90% 流量）</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-stable</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">9</span> <span class="hljs-comment"># 90% 的 Pod</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0.0</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:v1.0.0</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 2. 部署新版本（10% 流量）</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-canary</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 10% 的 Pod</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">v2.0.0</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:v2.0.0</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># 3. Service 同时指向两个版本</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span> <span class="hljs-comment"># 不区分版本，流量自动分配</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">3000</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 使用 Nginx 实现灰度发布</span>
<span class="hljs-comment">// nginx.conf</span>
upstream backend_stable {
    server stable-<span class="hljs-number">1.</span>example.<span class="hljs-property">com</span>:<span class="hljs-number">3000</span>;
    server stable-<span class="hljs-number">2.</span>example.<span class="hljs-property">com</span>:<span class="hljs-number">3000</span>;
    server stable-<span class="hljs-number">3.</span>example.<span class="hljs-property">com</span>:<span class="hljs-number">3000</span>;
}

upstream backend_canary {
    server canary-<span class="hljs-number">1.</span>example.<span class="hljs-property">com</span>:<span class="hljs-number">3000</span>;
}

server {
    listen <span class="hljs-number">80</span>;

    location / {
        # <span class="hljs-number">10</span>% 流量到金丝雀版本
        <span class="hljs-keyword">if</span> ($request_id ~* <span class="hljs-string">"^[0-9a-f]$"</span>) {
            proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//backend_canary;</span>
            <span class="hljs-keyword">break</span>;
        }

        # <span class="hljs-number">90</span>% 流量到稳定版本
        proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//backend_stable;</span>
    }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 基于用户的灰度发布</span>
<span class="hljs-comment">// feature-flag.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FeatureFlag</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canaryUsers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([
      <span class="hljs-string">"user123"</span>, <span class="hljs-comment">// 内部测试用户</span>
      <span class="hljs-string">"user456"</span>,
      <span class="hljs-comment">// ...</span>
    ])
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canaryPercentage</span> = <span class="hljs-number">10</span> <span class="hljs-comment">// 10% 的用户</span>
  }

  <span class="hljs-title function_">shouldUseCanary</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-comment">// 1. 白名单用户始终使用金丝雀版本</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">canaryUsers</span>.<span class="hljs-title function_">has</span>(userId)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-comment">// 2. 根据用户 ID 哈希决定</span>
    <span class="hljs-keyword">const</span> hash = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hashUserId</span>(userId)
    <span class="hljs-keyword">return</span> hash % <span class="hljs-number">100</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">canaryPercentage</span>
  }

  <span class="hljs-title function_">hashUserId</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">let</span> hash = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; userId.<span class="hljs-property">length</span>; i++) {
      hash = (hash &lt;&lt; <span class="hljs-number">5</span>) - hash + userId.<span class="hljs-title function_">charCodeAt</span>(i)
      hash = hash &amp; hash
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(hash)
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> featureFlag = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeatureFlag</span>()

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/api/data"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> userId = req.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>

  <span class="hljs-keyword">if</span> (featureFlag.<span class="hljs-title function_">shouldUseCanary</span>(userId)) {
    <span class="hljs-comment">// 使用新版本逻辑</span>
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataV2</span>())
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 使用旧版本逻辑</span>
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">getDataV1</span>())
  }
})
</code></pre>
<p><strong>灰度发布流程：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 部署金丝雀版本（5% 流量）
   ↓
<span class="hljs-bullet">2.</span> 观察 30 分钟
<span class="hljs-bullet">   -</span> 错误率正常？
<span class="hljs-bullet">   -</span> 响应时间正常？
<span class="hljs-bullet">   -</span> 用户投诉？
   ↓
<span class="hljs-bullet">3.</span> 如果正常，扩大到 25% 流量
   ↓
<span class="hljs-bullet">4.</span> 观察 1 小时
   ↓
<span class="hljs-bullet">5.</span> 如果正常，扩大到 50% 流量
   ↓
<span class="hljs-bullet">6.</span> 观察 2 小时
   ↓
<span class="hljs-bullet">7.</span> 如果正常，全量发布
   ↓
<span class="hljs-bullet">8.</span> 观察 24 小时后，下线旧版本
</code></pre>
<hr/>
<h2 data-id="heading-22">部署最佳实践总结</h2>
<h3 data-id="heading-23">1. 自动化一切</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ✅ 完整的 CI/CD 流程</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Pipeline</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">test</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">linter</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">lint</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Security</span> <span class="hljs-string">scan</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">audit</span>

  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">test</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">Docker</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">build</span> <span class="hljs-string">-t</span> <span class="hljs-string">myapp:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span> <span class="hljs-string">.</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Push</span> <span class="hljs-string">to</span> <span class="hljs-string">registry</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">docker</span> <span class="hljs-string">push</span> <span class="hljs-string">myapp:${{</span> <span class="hljs-string">github.sha</span> <span class="hljs-string">}}</span>

  <span class="hljs-attr">deploy-canary:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">build</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">canary</span> <span class="hljs-string">(10%)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          kubectl set image deployment/myapp-canary \
            myapp=myapp:${{ github.sha }}
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Wait</span> <span class="hljs-string">and</span> <span class="hljs-string">monitor</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          sleep 300  # 等待 5 分钟
          ./scripts/check-metrics.sh
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Rollback</span> <span class="hljs-string">if</span> <span class="hljs-string">needed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">undo</span> <span class="hljs-string">deployment/myapp-canary</span>

  <span class="hljs-attr">deploy-production:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">deploy-canary</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">production</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          kubectl set image deployment/myapp \
            myapp=myapp:${{ github.sha }}
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Monitor</span> <span class="hljs-string">deployment</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          kubectl rollout status deployment/myapp
          ./scripts/smoke-test.sh
</span></code></pre>
<h3 data-id="heading-24">2. 监控和告警</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 部署后自动监控关键指标</span>
<span class="hljs-keyword">const</span> metrics = {
  <span class="hljs-comment">// 错误率</span>
  <span class="hljs-attr">errorRate</span>: {
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.01</span>, <span class="hljs-comment">// 1%</span>
    <span class="hljs-attr">query</span>: <span class="hljs-string">'rate(http_requests_total{status=~"5.."}[5m])'</span>,
  },

  <span class="hljs-comment">// 响应时间</span>
  <span class="hljs-attr">responseTime</span>: {
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 1 秒</span>
    <span class="hljs-attr">query</span>: <span class="hljs-string">"histogram_quantile(0.95, http_request_duration_seconds)"</span>,
  },

  <span class="hljs-comment">// CPU 使用率</span>
  <span class="hljs-attr">cpuUsage</span>: {
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">80</span>, <span class="hljs-comment">// 80%</span>
    <span class="hljs-attr">query</span>: <span class="hljs-string">"rate(process_cpu_seconds_total[5m]) * 100"</span>,
  },

  <span class="hljs-comment">// 内存使用率</span>
  <span class="hljs-attr">memoryUsage</span>: {
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">85</span>, <span class="hljs-comment">// 85%</span>
    <span class="hljs-attr">query</span>: <span class="hljs-string">"(process_resident_memory_bytes / node_memory_MemTotal_bytes) * 100"</span>,
  },
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">monitorDeployment</span>(<span class="hljs-params">duration = <span class="hljs-number">300000</span></span>) {
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()

  <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime &lt; duration) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [name, metric] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(metrics)) {
      <span class="hljs-keyword">const</span> value = <span class="hljs-keyword">await</span> <span class="hljs-title function_">queryPrometheus</span>(metric.<span class="hljs-property">query</span>)

      <span class="hljs-keyword">if</span> (value &gt; metric.<span class="hljs-property">threshold</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ <span class="hljs-subst">${name}</span> 超过阈值: <span class="hljs-subst">${value}</span> &gt; <span class="hljs-subst">${metric.threshold}</span>`</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">rollback</span>()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }
    }

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">30000</span>) <span class="hljs-comment">// 每 30 秒检查一次</span>
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 监控通过"</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-25">3. 部署检查清单</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 部署前检查</span>

<span class="hljs-bullet">-</span> [ ] 代码已经过 Code Review
<span class="hljs-bullet">-</span> [ ] 所有测试都通过（单元测试、集成测试、E2E 测试）
<span class="hljs-bullet">-</span> [ ] 已在测试环境验证
<span class="hljs-bullet">-</span> [ ] 数据库迁移脚本已准备好（且可回滚）
<span class="hljs-bullet">-</span> [ ] 配置文件已更新
<span class="hljs-bullet">-</span> [ ] 依赖项已更新
<span class="hljs-bullet">-</span> [ ] 文档已更新
<span class="hljs-bullet">-</span> [ ] 回滚方案已准备好
<span class="hljs-bullet">-</span> [ ] 相关人员已通知
<span class="hljs-bullet">-</span> [ ] 在允许的部署时间窗口内

<span class="hljs-section">## 部署中检查</span>

<span class="hljs-bullet">-</span> [ ] 健康检查通过
<span class="hljs-bullet">-</span> [ ] 日志没有异常
<span class="hljs-bullet">-</span> [ ] 关键指标正常（错误率、响应时间、CPU、内存）
<span class="hljs-bullet">-</span> [ ] 数据库连接正常
<span class="hljs-bullet">-</span> [ ] 外部服务连接正常
<span class="hljs-bullet">-</span> [ ] 缓存正常工作

<span class="hljs-section">## 部署后检查</span>

<span class="hljs-bullet">-</span> [ ] 冒烟测试通过
<span class="hljs-bullet">-</span> [ ] 关键业务流程正常（登录、支付、下单等）
<span class="hljs-bullet">-</span> [ ] 监控指标正常
<span class="hljs-bullet">-</span> [ ] 没有用户投诉
<span class="hljs-bullet">-</span> [ ] 日志没有异常
<span class="hljs-bullet">-</span> [ ] 观察至少 30 分钟
</code></pre>
<hr/>
<h2 data-id="heading-26">写在最后：部署不是结束，而是开始</h2>
<p>很多人觉得代码写完、部署上线就完事了。</p>
<p><strong>但实际上，部署只是开始。</strong></p>
<p>一个成熟的部署流程应该包括：</p>
<ol>
<li><strong>自动化测试</strong>：确保代码质量</li>
<li><strong>自动化部署</strong>：减少人为错误</li>
<li><strong>灰度发布</strong>：降低风险</li>
<li><strong>健康检查</strong>：及时发现问题</li>
<li><strong>监控告警</strong>：快速响应</li>
<li><strong>快速回滚</strong>：止损及时</li>
<li><strong>事后复盘</strong>：持续改进</li>
</ol>
<p><strong>记住这些黄金法则：</strong></p>
<ul>
<li>✅ 永远不要直接在生产环境改代码</li>
<li>✅ 永远要有回滚方案</li>
<li>✅ 数据库迁移要向后兼容</li>
<li>✅ 环境变量不要提交到 Git</li>
<li>✅ 部署后要监控关键指标</li>
<li>✅ 周五下午不要部署</li>
<li>✅ 先灰度，再全量</li>
</ul>
<p><strong>2026 年了，别再让部署成为噩梦。</strong></p>
<p>下次部署前，先问自己：</p>
<ul>
<li>如果出问题，我能在 5 分钟内回滚吗？</li>
<li>我有监控和告警吗？</li>
<li>我在合适的时间部署吗？</li>
<li>我有灰度发布吗？</li>
</ul>
<p>如果答案都是"是"，那就放心部署吧。</p>
<p>如果有任何一个是"否"，那就先完善流程，再部署。</p>
<p><strong>记住：部署不是赌博，而是工程。</strong></p>
<hr/>
<h2 data-id="heading-27">彩蛋：一键部署脚本模板</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># deploy.sh - 生产级部署脚本</span>

<span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即退出</span>

<span class="hljs-comment"># 颜色输出</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
NC=<span class="hljs-string">'\033[0m'</span> <span class="hljs-comment"># No Color</span>

<span class="hljs-comment"># 配置</span>
APP_NAME=<span class="hljs-string">"myapp"</span>
ENVIRONMENT=<span class="hljs-string">"production"</span>
HEALTH_CHECK_URL=<span class="hljs-string">"https://myapp.example.com/health"</span>
ROLLBACK_ON_FAILURE=<span class="hljs-literal">true</span>

<span class="hljs-comment"># 日志函数</span>
<span class="hljs-function"><span class="hljs-title">log_info</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_warn</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARN]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_error</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>[ERROR]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-comment"># 检查部署时间</span>
<span class="hljs-function"><span class="hljs-title">check_deploy_time</span></span>() {
    HOUR=$(<span class="hljs-built_in">date</span> +%H)
    DAY=$(<span class="hljs-built_in">date</span> +%u)

    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$DAY</span> -eq 6 ] || [ <span class="hljs-variable">$DAY</span> -eq 7 ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"周末禁止部署"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$DAY</span> -eq 5 ] &amp;&amp; [ <span class="hljs-variable">$HOUR</span> -ge 14 ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"周五下午 2 点后禁止部署"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$HOUR</span> -lt 10 ] || [ <span class="hljs-variable">$HOUR</span> -ge 16 ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"只允许在 10:00 - 16:00 部署"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    log_info <span class="hljs-string">"部署时间检查通过"</span>
}

<span class="hljs-comment"># 健康检查</span>
<span class="hljs-function"><span class="hljs-title">health_check</span></span>() {
    log_info <span class="hljs-string">"执行健康检查..."</span>

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {1..30}; <span class="hljs-keyword">do</span>
        HTTP_CODE=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> <span class="hljs-variable">$HEALTH_CHECK_URL</span>)

        <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$HTTP_CODE</span>"</span> == <span class="hljs-string">"200"</span> ]; <span class="hljs-keyword">then</span>
            log_info <span class="hljs-string">"健康检查通过"</span>
            <span class="hljs-built_in">return</span> 0
        <span class="hljs-keyword">fi</span>

        log_warn <span class="hljs-string">"等待服务就绪... (<span class="hljs-variable">$i</span>/30)"</span>
        <span class="hljs-built_in">sleep</span> 10
    <span class="hljs-keyword">done</span>

    log_error <span class="hljs-string">"健康检查失败"</span>
    <span class="hljs-built_in">return</span> 1
}

<span class="hljs-comment"># 回滚</span>
<span class="hljs-function"><span class="hljs-title">rollback</span></span>() {
    log_error <span class="hljs-string">"部署失败，开始回滚..."</span>
    kubectl rollout undo deployment/<span class="hljs-variable">$APP_NAME</span>
    log_info <span class="hljs-string">"回滚完成"</span>
}

<span class="hljs-comment"># 主流程</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    log_info <span class="hljs-string">"开始部署 <span class="hljs-variable">$APP_NAME</span> 到 <span class="hljs-variable">$ENVIRONMENT</span>"</span>

    <span class="hljs-comment"># 1. 检查部署时间</span>
    check_deploy_time

    <span class="hljs-comment"># 2. 拉取最新代码</span>
    log_info <span class="hljs-string">"拉取最新代码..."</span>
    git pull origin main

    <span class="hljs-comment"># 3. 运行测试</span>
    log_info <span class="hljs-string">"运行测试..."</span>
    npm <span class="hljs-built_in">test</span> || {
        log_error <span class="hljs-string">"测试失败"</span>
        <span class="hljs-built_in">exit</span> 1
    }

    <span class="hljs-comment"># 4. 构建镜像</span>
    log_info <span class="hljs-string">"构建 Docker 镜像..."</span>
    VERSION=$(git rev-parse --short HEAD)
    docker build -t <span class="hljs-variable">$APP_NAME</span>:<span class="hljs-variable">$VERSION</span> .

    <span class="hljs-comment"># 5. 推送镜像</span>
    log_info <span class="hljs-string">"推送镜像到仓库..."</span>
    docker push <span class="hljs-variable">$APP_NAME</span>:<span class="hljs-variable">$VERSION</span>

    <span class="hljs-comment"># 6. 部署</span>
    log_info <span class="hljs-string">"部署到 Kubernetes..."</span>
    kubectl <span class="hljs-built_in">set</span> image deployment/<span class="hljs-variable">$APP_NAME</span> <span class="hljs-variable">$APP_NAME</span>=<span class="hljs-variable">$APP_NAME</span>:<span class="hljs-variable">$VERSION</span>

    <span class="hljs-comment"># 7. 等待部署完成</span>
    log_info <span class="hljs-string">"等待部署完成..."</span>
    kubectl rollout status deployment/<span class="hljs-variable">$APP_NAME</span> --<span class="hljs-built_in">timeout</span>=5m || {
        <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$ROLLBACK_ON_FAILURE</span>"</span> = <span class="hljs-literal">true</span> ]; <span class="hljs-keyword">then</span>
            rollback
        <span class="hljs-keyword">fi</span>
        <span class="hljs-built_in">exit</span> 1
    }

    <span class="hljs-comment"># 8. 健康检查</span>
    health_check || {
        <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$ROLLBACK_ON_FAILURE</span>"</span> = <span class="hljs-literal">true</span> ]; <span class="hljs-keyword">then</span>
            rollback
        <span class="hljs-keyword">fi</span>
        <span class="hljs-built_in">exit</span> 1
    }

    <span class="hljs-comment"># 9. 冒烟测试</span>
    log_info <span class="hljs-string">"执行冒烟测试..."</span>
    npm run smoke-test || {
        <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$ROLLBACK_ON_FAILURE</span>"</span> = <span class="hljs-literal">true</span> ]; <span class="hljs-keyword">then</span>
            rollback
        <span class="hljs-keyword">fi</span>
        <span class="hljs-built_in">exit</span> 1
    }

    <span class="hljs-comment"># 10. 监控</span>
    log_info <span class="hljs-string">"监控关键指标 5 分钟..."</span>
    <span class="hljs-built_in">sleep</span> 300

    log_info <span class="hljs-string">"🎉 部署成功！"</span>
    log_info <span class="hljs-string">"版本: <span class="hljs-variable">$VERSION</span>"</span>
    log_info <span class="hljs-string">"时间: <span class="hljs-subst">$(date)</span>"</span>
}

<span class="hljs-comment"># 执行</span>
main
</code></pre>
<p>现在，去建立一个让人放心的部署流程吧！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[electron preload.js调试技巧ignore list：Content scripts injected by extensions]]></title>    <link>https://juejin.cn/post/7595847940620943410</link>    <guid>https://juejin.cn/post/7595847940620943410</guid>    <pubDate>2026-01-17T04:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595847940620943410" data-draft-id="7595808703073861658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="electron preload.js调试技巧ignore list：Content scripts injected by extensions"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-17T04:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xu__yanfeng"/> <meta itemprop="url" content="https://juejin.cn/user/3052689432524861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            electron preload.js调试技巧ignore list：Content scripts injected by extensions
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052689432524861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xu__yanfeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:19:23.000Z" title="Sat Jan 17 2026 04:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用electron开发工具时，我使用到了vite，为了使用vue devserver加快开发速度，通常在dev环境，BrowserWindow会加载dev server的url，也就是这样子</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> win = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({});
win.<span class="hljs-title function_">loadURL</span>(<span class="hljs-string">"http://localhost:8065/"</span>);
</code></pre>
<p>但是我还想使用nodejs的特性，很明显在web页面不行，我不想写在主进程，因为需要ipc通讯，很麻烦。</p>
<p>看到可以通过preload.js来实现我的需求：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> win = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
    <span class="hljs-attr">sandbox</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">contextIsolation</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">preload</span>: <span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'./preload.js'</span>),
});
win.<span class="hljs-title function_">loadURL</span>(<span class="hljs-string">"http://localhost:8065/"</span>);
</code></pre>
<p>在preload.js里面注入一个全局变量给渲染界面使用，最重要的是直接可以在preload脚步里面写nodejs的逻辑了</p>
<pre><code class="hljs language-arduino" lang="arduino">contextBridge.<span class="hljs-built_in">exposeInMainWorld</span>(<span class="hljs-string">"gss"</span>, gss)
</code></pre>
<p>现在问题来了，我要调试这个preload.js，发现在devtools里面能看到preload.js的打印，也能够下断点，但是无法步进，如果我逐行调试，就导致每一行我都需要下断点，非常难受。</p>
<h2 data-id="heading-0">解决办法</h2>
<p>查了很多资料，发现是chrome的ignore list的问题，因为preload.js属于注入的脚本，所以导致被忽略了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1958926fda404190e0ac7b175623c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVfX3lhbmZlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769228362&amp;x-signature=KabE2x6lcnuDyxqleJYMeF6Zako%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a606cfae7ff4e88b53e39a4746db776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVfX3lhbmZlbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769228362&amp;x-signature=8Gp5vCl5Wkl68TFGuA72dH3cIFg%3D" alt="image.png" loading="lazy"/></p>
<p>取消选中即可，现在可以逐行调试preload.js了，开发起来非常丝滑！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[媒体采集标准草案 与 Chromium 音频采集实现简介]]></title>    <link>https://juejin.cn/post/7595495896135581722</link>    <guid>https://juejin.cn/post/7595495896135581722</guid>    <pubDate>2026-01-16T02:55:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595495896135581722" data-draft-id="7595484390428606499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="媒体采集标准草案 与 Chromium 音频采集实现简介"/> <meta itemprop="keywords" content="前端,音视频开发,Chrome"/> <meta itemprop="datePublished" content="2026-01-16T02:55:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节架构前端"/> <meta itemprop="url" content="https://juejin.cn/user/1530175206729016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            媒体采集标准草案 与 Chromium 音频采集实现简介
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6984296204297306148/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ce530e92b8f474a93c7599c70cb7e25~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6984296204297306148/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="字节架构前端" class="title" data-v-d326b38e="">字节架构前端</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-16T02:55:47.000Z" title="Fri Jan 16 2026 02:55:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-16
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                2
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读19分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              FE @字节跳动
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<ul>
<li>简要介绍 W3C Media Capture and Streams 草案中采集部分的约定</li>
<li>粗略介绍 Chromium 的多进程架构以及音频采集功能的实现</li>
</ul>
</blockquote>
<h2 data-id="heading-0">Media Capture and Streams</h2>
<h3 data-id="heading-1">什么是 Media Capture and Streams TR</h3>
<p>Media Capture and Streams 是由 W3C WebRTC Working Group 提出的规范草案，主要定义了获取本地媒体的 JavaScript API。目前该草案处于 CRD (Candidate Recommend Draft) 状态，也可以被称为技术报告（Technical Report, TR）</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fmediacapture-streams%2F" target="_blank" title="https://www.w3.org/TR/mediacapture-streams/" ref="nofollow noopener noreferrer">www.w3.org/TR/mediacap…</a></p>
<p>虽然 W3C 强调，W3C CRD 不能（MUST NOT）以 W3C 标准的名义引用。并且，W3C CRD 可能成为 W3C 标准，也可能不会成为 W3C 标准。但截至目前，主流浏览器都参考了这份草案进行了实现。各位 Web 开发者大可放心使用相关 API 开发自己的网页应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4735081ee9b14f30b64cab4c5f4a8b7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=w6TcJaFTupkB6tNiA%2BUwObpkGb4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">草案包含的 API</h3>
<p>这份草案包含了两大类 API：MediaStream、MediaDevices。</p>
<ul>
<li>
<p>MediaStream: 主要包含 MediaStream、MediaStreamTrack 两大类。</p>
<ul>
<li>MediaStreamTrack: 从一个媒体源获取的、单一类型的媒体。（例如：来自摄像头的视频）</li>
<li>MediaStream: 由多个 MediaStreamTrack 构成的一个单元，可以被录制或者在 Media Element 上渲染。</li>
</ul>
</li>
<li>
<p>MediaDevices: 扩展自 Navigator 接口，主要包含枚举媒体设备、获取媒体流两类。</p>
<ul>
<li>enumerateDevices: 收集浏览器可用的媒体输入设备和媒体输出设备。</li>
<li>getUserMedia: 向用户申请权限，获取用户的摄像头或者其他的音视频输入信息。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">怎样使用这些 API</h3>
<p>下面的实例代码简单展示了如何采集摄像头流，并将流渲染到媒体元素上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"startBtn"</span>); <span class="hljs-comment">// &lt;button&gt;</span>
<span class="hljs-keyword">const</span> videoPlayer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"videoPlayer"</span>); <span class="hljs-comment">// &lt;video&gt;</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureCamera</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 约束</span>
    <span class="hljs-keyword">const</span> constraints = {
      <span class="hljs-attr">video</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-number">640</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">480</span>,
      },
      <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span>,
    };

    <span class="hljs-comment">// 采集</span>
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>(constraints);

    <span class="hljs-comment">// 播放</span>
    videoPlayer.<span class="hljs-property">srcObject</span> = stream;
    videoPlayer.<span class="hljs-title function_">play</span>();
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
  }
}

startBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, captureCamera);
</code></pre>
<p>上述代码中包含了三个重要的步骤：</p>
<ol>
<li>
<p>约束：向浏览器提供所需要的媒体流的信息。</p>
<ol>
<li>每种媒体都可以指定其约束</li>
<li>只设置为 true 表示需要这个媒体流，但没有任何限制</li>
</ol>
</li>
</ol>
<blockquote>
<p>JS：浏览器，请给我一个分辨率 640x480 的视频流，再来一个音频流。哪个设备的都可以。</p>
</blockquote>
<ol start="2">
<li>采集：将约束传入 getUserMedia 接口。该接口将以 Promise 形式返回一个 MediaStream。</li>
</ol>
<blockquote>
<p>[等了一会]</p>
<p>浏览器：好嘞，你要的两个流。打包放一起了。</p>
</blockquote>
<ol start="3">
<li>播放：该草案中也提供了在 HTMLMediaElement 上渲染这些流的接口。将 MediaElement 的 srcObject 设置为想要播放的流。然后调用 play 即可。</li>
</ol>
<p>主要注意的是，传给 getUserMedia 接口的参数被称作“约束”。这是因为该接口最终返回的流可能与约束不一致。这就涉及到设置、能力与约束的区别了。</p>
<h3 data-id="heading-4">设置、能力与约束</h3>
<h4 data-id="heading-5">Setting 设置</h4>
<p>设置表示一个媒体源当前所应用的参数。显然，这个参数需要是只读的。</p>
<p>这里以上文采集到的音视频轨道为例，分别调用 <code>getSettings()</code> 接口。可以发现接口返回了如下内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// audio</span>
{
    <span class="hljs-attr">autoGainControl</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">channelCount</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">deviceId</span>: <span class="hljs-string">"cc0e809ba21cc1e8a1403b835d13ea3a4e8541f438d0b31989294cace5f43ec2"</span>,
    <span class="hljs-attr">echoCancellation</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">groupId</span>: <span class="hljs-string">"075cbccd30ba3337cf5d990a77525475153112df8066833c3213706ceeab2b42"</span>,
    <span class="hljs-attr">latency</span>: <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">noiseSuppression</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">48000</span>,
    <span class="hljs-attr">sampleSize</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">voiceIsolation</span>: <span class="hljs-literal">false</span>
}
<span class="hljs-comment">// video</span>
{
    <span class="hljs-attr">aspectRatio</span>: <span class="hljs-number">1.3333333333333333</span>,
    <span class="hljs-attr">deviceId</span>: <span class="hljs-string">"d1216494e164337d39248c6d9610a0e7038ec774998f758665270dcaaae29093"</span>,
    <span class="hljs-attr">frameRate</span>: <span class="hljs-number">30</span>,
    <span class="hljs-attr">groupId</span>: <span class="hljs-string">"f9b73b0dac3ff31397c5bb01df58e1256aa1acc930d2634f7d090b24da06a513"</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">480</span>,
    <span class="hljs-attr">resizeMode</span>: <span class="hljs-string">"none"</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">640</span>
}
</code></pre>
<p>这两个对象详细描述了音视频源<strong>正在应用</strong>的参数，也可以看到对于视频的分辨率约束也生效了。</p>
<p>一些常用的字段含义如下所示，不做赘述。</p>
<p>音频</p>
<ul>
<li><code>deviceId</code>：设备 ID</li>
<li><code>channelCount</code>: 声道数</li>
<li><code>autoGainControl</code>：自动增益控制</li>
<li><code>echoCancellation</code>：回声消除</li>
<li><code>noiseSuppression</code>：噪声抑制</li>
</ul>
<p>视频</p>
<ul>
<li><code>deviceId</code>: 设备 ID</li>
<li><code>width</code>：画面宽度</li>
<li><code>height</code>：画面高度</li>
<li><code>frameRate</code>：帧率</li>
</ul>
<h4 data-id="heading-6">Capability 能力</h4>
<p>能力是指媒体源支持哪些参数，每个参数的范围如何。</p>
<p>例如：一个摄像头可能支持 640x480@60, 1920x1080@30 等多种分辨率、帧率组合。一个麦克风可能支持 48000Hz 采样率，也支持 44100Hz 采样率。</p>
<p>然而通过上面两个例子，就可以发现完整列举设备能力是几乎不可能的。</p>
<ol>
<li>参数种类很多，每个参数又有不同的取值范围。使用约束列表进行描述，将获得非常多的组合，无法完整列举。</li>
<li>过于详细的能力集合很容易用来作为设备指纹。</li>
</ol>
<p>因此 <code>getCapability()</code> 只能获取已经采集到的流所对应的媒体源的参数。</p>
<p>还是以上面的采集到的音视频轨道为例。分别调用 <code>getCapability()</code> 接口，可以看到这两个设备的能力列表。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// audio</span>
{
    <span class="hljs-attr">autoGainControl</span>: [<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>],
    <span class="hljs-attr">channelCount</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>},
    <span class="hljs-attr">deviceId</span>: <span class="hljs-string">"cc0e809ba21cc1e8a1403b835d13ea3a4e8541f438d0b31989294cace5f43ec2"</span>,
    <span class="hljs-attr">echoCancellation</span>:  [<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>],
    <span class="hljs-attr">groupId</span>: <span class="hljs-string">"6190ef675de1872a2190edd82ee43c58899d1d6b0c6a613113de98cf3650c1c8"</span>,
    <span class="hljs-attr">latency</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">0.085333</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">0.002666</span>},
    <span class="hljs-attr">noiseSuppression</span>:  [<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>],
    <span class="hljs-attr">sampleRate</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">48000</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">48000</span>},
    <span class="hljs-attr">sampleSize</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">16</span>},
    <span class="hljs-attr">voiceIsolation</span>:  [<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>],
}
<span class="hljs-comment">// video</span>
{
    <span class="hljs-attr">aspectRatio</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">0.0005208333333333333</span>},
    <span class="hljs-attr">deviceId</span>: <span class="hljs-string">"d1216494e164337d39248c6d9610a0e7038ec774998f758665270dcaaae29093"</span>,
    <span class="hljs-attr">facingMode</span>: [],
    <span class="hljs-attr">frameRate</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>},
    <span class="hljs-attr">groupId</span>: <span class="hljs-string">"ebfbdd93ec4d8fc55a6e98ba59961767621761d27110e22c64a2033d26e19246"</span>,
    <span class="hljs-attr">height</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>},
    <span class="hljs-attr">resizeMode</span>: [<span class="hljs-string">'none'</span>, <span class="hljs-string">'crop-and-scale'</span>],
    <span class="hljs-attr">width</span>: {<span class="hljs-attr">max</span>: <span class="hljs-number">1920</span>, <span class="hljs-attr">min</span>: <span class="hljs-number">1</span>}
}
</code></pre>
<p>可以发现，能力有以下几种描述形式。</p>
<ul>
<li>列表：表示可以使用列表中的其中一项。</li>
<li>最大值与最小值：表示可以使用这个范围内的值。</li>
</ul>
<h4 data-id="heading-7">Constraints 约束</h4>
<p>约束这个概念比较抽象。可以理解为这是一种描述网页应用所需媒体流的特征的接口。向媒体源提供约束，将影响媒体源如何提供尽可能符合要求的媒体流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d86870e0db646e5965f2f39c1262161~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=bNwunC7KPn2%2FxPQF2q2aCXq8RfQ%3D" alt="" loading="lazy"/></p>
<p>正如前面的例子，网页应用的需求是一个宽 640px、高 480px 的视频流。这个需求是约束。媒体源在应用这个约束时，会根据媒体源的能力选择最接近的设置，生成媒体流。</p>
<p>除了上文约束可以通过单一值来设置约束以外，还可以有如下形式的约束。</p>
<ul>
<li>
<p><code>{max, mix}</code>：表示一个范围。</p>
<ul>
<li>例如：<code>width: {max: 1080, min: 720}</code></li>
</ul>
</li>
<li>
<p><code>{exact}</code>：表示精确值，不满足约束时报错。</p>
<ul>
<li>例如：<code>deviceId: {exact: 'd1216494'}</code></li>
</ul>
</li>
<li>
<p><code>{ideal}</code>：表示理想值，不满足时浏览器可能会应用其他接近的设置。</p>
<ul>
<li>例如：<code>deviceId: {ideal: 'd1216494'}</code></li>
<li>  此外，还支持进阶约束（advanced constraint）。这些约束的优先级将小于普通约束。</li>
</ul>
</li>
</ul>
<p>那么浏览器应该如何实现这个 通过约束获得设置 的算法呢？这份草案中定义了 <code>SelectSetting</code> 算法。</p>
<h4 data-id="heading-8"><code>SelectSetting</code> 算法</h4>
<p><code>SelectSetting</code> 算法的目标就是在多个候选设置中，选出一个符合约束的设置。当然，如果没办法满足要求的话需要报错。</p>
<p><code>SelectSetting</code>算法的输入分别是一组候选设置 Candidates 和一个约束 ConstraintSet (CS)。</p>
<ol>
<li>选择 CS 中的普通约束，与所有候选设置进行匹配。如果匹配失败直接返回空值。</li>
<li>遍历 CS 中的进阶约束组，如果匹配失败则删除这个约束。</li>
<li>选择最终保留下来的候选设置，这个候选设置必须（MUST）是匹配距离最小的候选设置之一。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3b71b168fca4f7c9aa9583c1976788c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=z0dxwwcAeZeS0mIvVL4dpI6hxeg%3D" alt="" loading="lazy"/></p>
<p>W3C 草案也定义了计算匹配距离（fitness distance）的算法，具体如下图。</p>
<p>算法的输入是一个候选设置 Setting 与一个约束 CS。</p>
<ol>
<li>遍历约束中的约束名称（ConstraintName, name）与约束值（ConstraintValue, value）。</li>
<li>对每一个 name，做图中的各种判断，计算出每个 name 对应的分数。</li>
<li>最终求和得到最终分数。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca2c9784203b41098cc91bb0f5de4d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=BqLeMozvR1B1FITQXBaszx0mh8Y%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">W3C 草案中的 <code>getUserMedia</code> 方法</h3>
<p>结合上文我们了解到，<code>getUserMedia</code> 需要处理约束和能力的匹配，生成一套符合要求的设置，根据设置生成媒体流。因此 <code>getUserMedia</code> 方法的核心为上文提到的匹配约束的算法。</p>
<p>但 W3C 草案考虑到隐私与安全问题，定义了多种需要抛出错误的情况，详情可以参考下图。主要包含以下几个特点：</p>
<ol>
<li>采集流程需要得到用户的授权。当没有被拒绝时，会在完成约束匹配后再弹窗申请权限。而在被拒绝时会直接跳过约束匹配流程。</li>
<li>采集流程需要页面处于 active / in view / focued 等活跃状态。从而限制了恶意代码在未经用户同意时静默打开摄像头或者麦克风。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d451b190f9a47938b6bfee733e6b523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=3xvnS6FrqeFJacQxWHWqID1fQJk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">Chromium 多进程架构</h2>
<blockquote>
<p>以下内容来自个人阅读 Chromium 文档和代码的总结，可能存在错误和缺漏，欢迎斧正。</p>
</blockquote>
<p>在上文中介绍了 W3C Media Capture and Streams 草案的一些重要概念。也介绍了草案中对 <code>getUserMedia</code> 方法的描述。理想情况下，所有浏览器都应该严格遵守这个标准草案。但在实践中，部分浏览器可能处于多方权衡，总会与这份草案存在一定的偏差。本文以 Chrome 的开源项目：Chromium 为例，简单了解浏览器是如何实现 <code>getUserMedia</code> 接口的。</p>
<p>在阅读源码之前，需要对 Chromium 项目有一些整体认知。这些知识有助于降低阅读难度。</p>
<h3 data-id="heading-11">多进程架构</h3>
<blockquote>
<p>正如现代操作系统一样，使用多个进程将应用分离，从而提高健壮性。Chromium 架构的目标也是为了这种更健壮的设计。</p>
</blockquote>
<p>Chromium 使用多进程结构，主要有以下两个好处。</p>
<ol>
<li>可以防止单个进程的意外错误破坏整个程序。</li>
<li>可以隔离单个进程，控制其访问范围。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/157fc28d54de45fb9900a8565f843e79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=94%2Fs9ypqsKxwSyldLVfVNpW5xv4%3D" alt="" loading="lazy"/></p>
<ul>
<li>Browser 进程：也被视为主进程。Browser 进程负责渲染 UI、管理其他 renderer 进程、接管 renderer 进程中对于操作系统的调用等功能。</li>
<li>Renderer 进程：用来处理网页内容，这部分通常包含 Blink、V8 等引擎。</li>
</ul>
<p>此外，随着浏览器复杂程度的提高，browser 进程的所负责的工作将会愈发臃肿。因此当前很多工作从 browser 进程中分离，以 service 的形式提供给 browser 进程或 renderer 进程。主要的 service 都列举在最顶层的 <code>//services</code> 目录下。</p>
<ul>
<li>audio: 主要用于处理音频采集相关功能</li>
<li>video_capture: 主要用于处理视频采集相关功能</li>
<li>webnn: 用于实现 Web Neural Network API 的服务。主要通过调用操作系统的硬件加速机器学习 API 来实现对应功能。</li>
</ul>
<h3 data-id="heading-12">跨进程通信 - Mojo</h3>
<p>Mojo 是一个跨平台的 IPC 框架，它诞生于 chromium ，用来实现 chromium 进程内/进程间的通信。主要提供三个 IPC 通信机制：MessagePipe，DataPipe 和 SharedBuffer。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64a9951e6aff4616b4d07e1120547723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=G1FqTgZ7%2BqZgz%2FXN%2B9FgphvHs0U%3D" alt="" loading="lazy"/></p>
<ul>
<li>MessagePipe: 用于进程间的双向通信。底层使用 Channel 通道。</li>
<li>DataPipe: 用于进程间的单向 数据块 传递。底层使用操作系统提供的 Shared Memory。</li>
<li>SharedBuffer: 用户进程间的双向数据块传递。底层也是 Shared Memory。</li>
</ul>
<p>Mojo 的在使用中的最大特点是提供一套方便的绑定接口。可以通过创建 .mojom 文件完成接口定义，由 BUILD.gn 中增加对应的编译代码就可以生成源代码文件。（这些源代码文件也是使 Chromium 源码跳转较为困难的原因）。</p>
<h3 data-id="heading-13">跨线程通信 - 任务队列</h3>
<p>Chromium 在代码中大量使用任务队列来提高并发能力，但在不同场景中对于任务队列的要求各有不同。Chromium 在这里设计了多种任务队列满足不同需求。</p>
<ul>
<li>TaskRunner：普通的任务队列。使用线程池消费任务，不保证任务执行顺序。</li>
<li>SequencedTaskRunner: 额外保证任务执行顺序的队列。遵循先入先出原则，但不保证任务在同一个线程中执行。</li>
<li>SingleThreadTaskRunner: 额外保证在同一线程执行的有序队列。</li>
</ul>
<h2 data-id="heading-14">如何获取、阅读 Chromium 源码</h2>
<h3 data-id="heading-15">如何获取并编译 Chromium</h3>
<p>Chromium 开源项目提供的非常完整的工具链和文档，如果你的网络情况较好、存储空间较充足、设备性能较好，可以尝试自己编译 Chromium。只需要参考官网文档即可。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.chromium.org%2Fdevelopers%2Fhow-tos%2Fget-the-code%2F" target="_blank" title="https://www.chromium.org/developers/how-tos/get-the-code/" ref="nofollow noopener noreferrer">www.chromium.org/developers/…</a></p>
<p>主要注意的是，Chromium 完整 git 历史+ 源码 + 一次全量编译的产物大约 200 GB。如果想减少对存储空间的占用，可以考虑 shallow fetch 等方式减少 git 历史文件的大小。</p>
<h3 data-id="heading-16">如何阅读</h3>
<h4 data-id="heading-17">在线阅读</h4>
<p>如果你是否有下载源码，都推荐选择在线阅读 Chromium 代码。在线版本 Chromium 代码不仅加载非常快，而且还有非常完善的引用调用查找功能。除了没办法调整字体外还是非常实用的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc" target="_blank" title="https://source.chromium.org/chromium/chromium/src" ref="nofollow noopener noreferrer">source.chromium.org/chromium/ch…</a></p>
<p>如果你执念想使用本地代码阅读，那么你还要至少进行以下几个步骤才能愉快地开始符号跳转。</p>
<h4 data-id="heading-18">如果你使用 Visual Studio Code</h4>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fchromium.googlesource.com%2Fchromium%2Fsrc.git%2F%2B%2FHEAD%2Fdocs%2Fclangd.md" target="_blank" title="https://chromium.googlesource.com/chromium/src.git/+/HEAD/docs/clangd.md" ref="nofollow noopener noreferrer">chromium.googlesource.com/chromium/sr…</a></p>
</blockquote>
<p>使用 VSCode 的话，需要依赖于 clangd 插件。主要分为以下几个步骤。</p>
<ol>
<li>完整编译 Chromium</li>
<li>生成 compile_commands.json 文件。其中 <code>out/Default</code> 为编译产物所在位置。</li>
</ol>

<pre><code class="hljs language-sql" lang="sql">tools<span class="hljs-operator">/</span>clang<span class="hljs-operator">/</span>scripts<span class="hljs-operator">/</span>generate_compdb.py <span class="hljs-operator">-</span>p <span class="hljs-keyword">out</span><span class="hljs-operator">/</span><span class="hljs-keyword">Default</span> <span class="hljs-operator">&gt;</span> compile_commands.json
</code></pre>
<p>3.  开始索引。后台索引通常是自动开始的。索引耗时与设备性能高度相关，可能在 2 小时（MacBook Pro, M2 pro）至 7 小时（MacBook Air, M2）不等。</p>
<p>clangd 有时会因为单一文件出现大量报错，而停止分析。可以通过配置 .clangd 文件提高错误数量上线，从而得到更多文件分析结果。</p>
<pre><code class="hljs language-ini" lang="ini">CompileFlags:
  Add: <span class="hljs-attr">-ferror-limit</span>=<span class="hljs-number">100</span>
</code></pre>
<h4 data-id="heading-19">如果你使用 JetBrains CLion</h4>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fchromium.googlesource.com%2Fchromium%2Fsrc.git%2F%2B%2FHEAD%2Fdocs%2Fclion.md" target="_blank" title="https://chromium.googlesource.com/chromium/src.git/+/HEAD/docs/clion.md" ref="nofollow noopener noreferrer">chromium.googlesource.com/chromium/sr…</a></p>
</blockquote>
<p>CLion 依赖于 CMake 进行语法分析，所以需要正确配置 CMakeLists.txt 。CMakeLists.txt 文件需要与 src 文件夹在同一目录。文件内容如下所示。</p>
<pre><code class="hljs language-css" lang="css">.
├── CMakeLists<span class="hljs-selector-class">.txt</span>
└── <span class="hljs-attribute">src</span>
</code></pre>
<pre><code class="hljs language-make" lang="make">cmake_minimum_required(VERSION 3.10)
project(chromium)

set(CMAKE_CXX_STANDARD 14)

include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/out/Default/gen)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/third_party/protobuf/src)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/third_party/googletest/src/googletest/<span class="hljs-keyword">include</span>)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/third_party/googletest/src/googlemock/<span class="hljs-keyword">include</span>)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src/third_party/abseil-cpp)

<span class="hljs-comment"># The following file used is irrelevant, it's only to improve CLion</span>
<span class="hljs-comment"># performance. Leaving at least 1 file is required in order for CLion</span>
<span class="hljs-comment"># to provide code completion, navigation, etc.</span>
add_executable(chromium src/components/omnibox/browser/document_provider.cc)
</code></pre>
<h3 data-id="heading-20">如何获取日志</h3>
<pre><code class="hljs language-bash" lang="bash">currentTime=`<span class="hljs-built_in">date</span> <span class="hljs-string">"+%Y%m%d_%H%M%S"</span>`
filePath=<span class="hljs-variable">${HOME}</span>/chrome_debug_<span class="hljs-variable">${currentTime}</span>.<span class="hljs-built_in">log</span>
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --enable-logging --v=1 --log-file=<span class="hljs-variable">${filePath}</span> &amp;
<span class="hljs-built_in">sleep</span> 1
open -a Console <span class="hljs-variable">${filePath}</span>
</code></pre>
<p>以上方法可以在 macOS 上获取日志，日志存放于用户目录下。通常正式发布版本的 Chrome 只能获取 VERBOSE1 级别的日志，而且不包含代码中的各项断言检查。</p>
<h2 data-id="heading-21">Chromium 中的 getUserMedia</h2>
<h3 data-id="heading-22">Chromium getUserMedia 音频流程图</h3>
<p>Chromium 的麦克风音频采集主要包含获取设备能力、检查设备约束、创建 Stream、创建 Track、启动 Track 这几个步骤。至少涉及到三个进程间的通信，包含至少四个模块。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5bdada5617847f695bb87dbacace35d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=5o%2FiWA0bAVNFLpGOYFISAMsmelE%3D" alt="" loading="lazy"/></p>
<ul>
<li>renderer 进程：主要通过 UserMediaProcessor 对象流转 UserMediaRequest 中的状态，主要实现各种检查功能。</li>
<li>browser 进程：主要通过 MediaStreamManager 对象管理所有媒体流。</li>
<li>audio 进程：主要作为操作系统 API 的适配层，调用操作系统提供的音频接口。</li>
</ul>
<h3 data-id="heading-23">主要模块的流转</h3>
<h4 data-id="heading-24">UserMediaProcessor</h4>
<blockquote>
<p>位于 third_party/blink/renderer/modules/mediastream/user_media_processor.cc</p>
</blockquote>
<p>该模块位于 renderer 进程中，主要用于处理 getUserMedia 请求。</p>
<ul>
<li>每次只能创建一个 MediaStream</li>
<li>在各个函数中流转 UserMediaRequest 对象，以队列方式处理。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e042520dcb2947ee841dff68d9c26e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=7UVJf84LV5aacZiOaeObAu90b7M%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-25">Chromium 中的 SelectSetting 算法</h4>
<blockquote>
<p>位于 third_party/blink/renderer/modules/mediastream/media_stream_constraints_util_audio.cc</p>
</blockquote>
<p>可以发现这段代码基本符合 W3C 草案中的 SelectSetting 算法。包含先处理基本约束（绿色区域），再处理进阶约束（橙色区域）。但比较显著的是，Chromium 忽略了不同 setting 的匹配距离部分（紫色区域）。</p>
<pre><code class="hljs language-c++" lang="c++">    <span class="hljs-function">AudioCaptureSettings <span class="hljs-title">SelectSettingsAudioCapture</span><span class="hljs-params">(
        <span class="hljs-type">const</span> AudioDeviceCaptureCapabilities&amp; capabilities,
        <span class="hljs-type">const</span> MediaConstraints&amp; constraints,
        mojom::blink::MediaStreamType stream_type,
        <span class="hljs-type">bool</span> should_disable_hardware_noise_suppression,
        <span class="hljs-type">bool</span> is_reconfiguration_allowed)</span> </span>{
      <span class="hljs-keyword">if</span> (capabilities.<span class="hljs-built_in">empty</span>())
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AudioCaptureSettings</span>();

      std::string media_stream_source = <span class="hljs-built_in">GetMediaStreamSource</span>(constraints);
      std::string default_device_id;
      <span class="hljs-type">bool</span> is_device_capture = media_stream_source.<span class="hljs-built_in">empty</span>();
      <span class="hljs-keyword">if</span> (is_device_capture)
        default_device_id = capabilities.<span class="hljs-built_in">begin</span>()-&gt;<span class="hljs-built_in">DeviceID</span>().<span class="hljs-built_in">Utf8</span>();

      <span class="hljs-function">CandidatesContainer <span class="hljs-title">candidates</span><span class="hljs-params">(capabilities, stream_type, media_stream_source,
                                     default_device_id, is_reconfiguration_allowed)</span></span>;
      <span class="hljs-built_in">DCHECK</span>(!candidates.<span class="hljs-built_in">IsEmpty</span>());

      <span class="hljs-keyword">auto</span>* failed_constraint_name =
          candidates.<span class="hljs-built_in">ApplyConstraintSet</span>(constraints.<span class="hljs-built_in">Basic</span>());
      <span class="hljs-keyword">if</span> (failed_constraint_name)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AudioCaptureSettings</span>(failed_constraint_name);

      <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; advanced_set : constraints.<span class="hljs-built_in">Advanced</span>()) {
        CandidatesContainer copy = candidates;
        failed_constraint_name = candidates.<span class="hljs-built_in">ApplyConstraintSet</span>(advanced_set);
        <span class="hljs-keyword">if</span> (failed_constraint_name)
          candidates = std::<span class="hljs-built_in">move</span>(copy);
      }
      <span class="hljs-built_in">DCHECK</span>(!candidates.<span class="hljs-built_in">IsEmpty</span>());

      <span class="hljs-comment">// Score is ignored as it is no longer needed.</span>
      AudioCaptureSettings settings;
      std::<span class="hljs-built_in">tie</span>(std::ignore, settings) = candidates.<span class="hljs-built_in">SelectSettingsAndScore</span>(
          constraints.<span class="hljs-built_in">Basic</span>(),
          media_stream_source == blink::kMediaStreamSourceDesktop,
          should_disable_hardware_noise_suppression);

      <span class="hljs-keyword">return</span> settings;
    }
</code></pre>
<p>观察 <code>ApplyConstraintSet</code> 函数，这里基本上对应 W3C 草案中的 fitness_distance 的部分。可以发现其实 Chromium 完全没有参考草案中的流程。代码将约束分为四类：deviceId、groupId、number 与 boolean、processing_based。其中 processing_based 表示需要使用 WebRTC 模块提供的音频处理功能的约束。</p>
<p>这种计算方式显然也没办法得出一个分数，因此在 <code>SelectSettingsAudioCapture</code> 函数的注释中，也明显表示因为不再需要 score，所以将 score 忽略。</p>
<pre><code class="hljs language-c++" lang="c++">    <span class="hljs-comment">// class DeviceContainer</span>
      <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">ApplyConstraintSet</span><span class="hljs-params">(<span class="hljs-type">const</span> ConstraintSet&amp; constraint_set)</span> </span>{
        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* failed_constraint_name;

        failed_constraint_name =
            device_id_container_.<span class="hljs-built_in">ApplyConstraintSet</span>(constraint_set.device_id);
        <span class="hljs-keyword">if</span> (failed_constraint_name)
          <span class="hljs-keyword">return</span> failed_constraint_name;

        failed_constraint_name =
            group_id_container_.<span class="hljs-built_in">ApplyConstraintSet</span>(constraint_set.group_id);
        <span class="hljs-keyword">if</span> (failed_constraint_name)
          <span class="hljs-keyword">return</span> failed_constraint_name;

        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; kNumBooleanContainerIds; ++i) {
          <span class="hljs-keyword">auto</span>&amp; info = kBooleanPropertyContainerInfoMap[i];
          failed_constraint_name =
              boolean_containers_[info.index].<span class="hljs-built_in">ApplyConstraintSet</span>(
                  constraint_set.*(info.constraint_member));
          <span class="hljs-keyword">if</span> (failed_constraint_name)
            <span class="hljs-keyword">return</span> failed_constraint_name;
        }

        <span class="hljs-comment">// For each processing based container, apply the constraints and only fail</span>
        <span class="hljs-comment">// if all of them failed.</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = processing_based_containers_.<span class="hljs-built_in">begin</span>();
             it != processing_based_containers_.<span class="hljs-built_in">end</span>();) {
          <span class="hljs-built_in">DCHECK</span>(!it-&gt;<span class="hljs-built_in">IsEmpty</span>());
          failed_constraint_name = it-&gt;<span class="hljs-built_in">ApplyConstraintSet</span>(constraint_set);
          <span class="hljs-keyword">if</span> (failed_constraint_name)
            it = processing_based_containers_.<span class="hljs-built_in">erase</span>(it);
          <span class="hljs-keyword">else</span>
            ++it;
        }
        <span class="hljs-keyword">if</span> (processing_based_containers_.<span class="hljs-built_in">empty</span>()) {
          <span class="hljs-built_in">DCHECK_NE</span>(failed_constraint_name, <span class="hljs-literal">nullptr</span>);
          <span class="hljs-keyword">return</span> failed_constraint_name;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
      }
</code></pre>
<h4 data-id="heading-26">MediaStreamManager</h4>
<blockquote>
<p>位于 content/browser/renderer_host/media/media_stream_manager.cc</p>
</blockquote>
<p>该模块位于 browser 进程中，主要用于创建和关闭媒体设备，管理 MediaStream。</p>
<ul>
<li>在各个函数中流转 DeviceRequest 对象</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca2414bcc064da6b5cdea37618d4aec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=gKPPeRzhc0XzmxzZPgK8mLm1R4c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27">使用这些 API 可以做到什么</h2>
<p>Media Capture and Streams API 主要支持了采集用户音视频流的功能。结合其他 Web API 可以实现多种功能。</p>
<ul>
<li>结合 WebRTC API，可以将摄像头流和音频流发送其他用户，实现实时会议等功能。</li>
<li>结合 WebAudio API，可以将音频流进行处理，实现各种混音效果。</li>
</ul>
<p>下面以拍照功能为例，简单介绍上述 API 的使用方法。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c303b794c804193b56be9ef9dac141b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC5p625p6E5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769137163&amp;x-signature=ouEfIoT0cMPZLdUBzFpLuiBzwhI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-28">预览视频流</h3>
<p>这部分与上文相同，需要执行三个步骤。设置约束、采集、播放。可以直接沿用上文提供的代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">previewCamera</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> videoPlayer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"videoPlayer"</span>); <span class="hljs-comment">// &lt;video&gt;</span>
  <span class="hljs-keyword">if</span> (!videoPlayer || !(videoPlayer <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLVideoElement</span>)) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 约束</span>
    <span class="hljs-keyword">const</span> constraints = {
      <span class="hljs-attr">video</span>: {<span class="hljs-attr">width</span>: <span class="hljs-number">640</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">480</span>},
    };
    <span class="hljs-comment">// 采集</span>
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>(constraints);
    <span class="hljs-comment">// 播放</span>
    videoPlayer.<span class="hljs-property">srcObject</span> = stream;
    videoPlayer.<span class="hljs-title function_">play</span>();
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
  }
}
</code></pre>
<h3 data-id="heading-29">获取可用设备</h3>
<p>此处可以使用枚举用户设备接口实现。首先我们需要调用这个接口，获取设备信息列表。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> devices = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">enumerateDevices</span>();
</code></pre>
<p>设备信息列表中包含设备名称、设备 ID 等信息。设备名称可以用来作为用户展示，设备 ID 则需要传给约束更新视频流。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reloadDevices</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> selector = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"device-select"</span>);
  <span class="hljs-keyword">if</span> (!selector || !(selector <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLSelectElement</span>)) {
    <span class="hljs-keyword">return</span>;
  }
  selector.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 获取设备列表</span>
  <span class="hljs-keyword">const</span> devices = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">enumerateDevices</span>();
  <span class="hljs-comment">// 创建选项</span>
  devices.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">device</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (device.<span class="hljs-property">kind</span> === <span class="hljs-string">"videoinput"</span>) {
      <span class="hljs-keyword">const</span> option = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"option"</span>);
      option.<span class="hljs-property">value</span> = device.<span class="hljs-property">deviceId</span>;
      option.<span class="hljs-property">text</span> = device.<span class="hljs-property">label</span> || <span class="hljs-string">`Camera <span class="hljs-subst">${selector.length + <span class="hljs-number">1</span>}</span>`</span>;
      selector.<span class="hljs-title function_">appendChild</span>(option);
    }
  });
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">previewCamera</span>(<span class="hljs-params">deviceId</span>) {
  <span class="hljs-keyword">const</span> videoPlayer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"videoPlayer"</span>); <span class="hljs-comment">// &lt;video&gt;</span>
  <span class="hljs-keyword">if</span> (!videoPlayer || !(videoPlayer <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLVideoElement</span>)) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 清除正在预览的流</span>
  <span class="hljs-keyword">const</span> stream = videoPlayer.<span class="hljs-property">srcObject</span>;
  <span class="hljs-keyword">if</span> (stream <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MediaStream</span>) {
    stream?.<span class="hljs-title function_">getTracks</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">track</span>) =&gt;</span> {
      track.<span class="hljs-title function_">stop</span>();
    });
  }
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 约束</span>
    <span class="hljs-keyword">const</span> constraints = {
      <span class="hljs-attr">video</span>: {<span class="hljs-attr">width</span>: <span class="hljs-number">640</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">480</span>},
    };
    <span class="hljs-keyword">if</span> (deviceId) {
      constraints.<span class="hljs-property">video</span>.<span class="hljs-property">deviceId</span> = { <span class="hljs-attr">exact</span>: deviceId };
    }
    <span class="hljs-comment">// 采集</span>
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>(constraints);
    <span class="hljs-comment">// 播放</span>
    videoPlayer.<span class="hljs-property">srcObject</span> = stream;
    videoPlayer.<span class="hljs-title function_">play</span>();
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
  }
}
</code></pre>
<h3 data-id="heading-30">拍照</h3>
<p>拍照的部分可以使用 Canvas API 的 <code>drawImage</code> 接口。具体如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">capture</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> videoPlayer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"videoPlayer"</span>); <span class="hljs-comment">// &lt;video&gt;</span>
  <span class="hljs-keyword">if</span> (!videoPlayer || !(videoPlayer <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLVideoElement</span>)) {
    <span class="hljs-keyword">return</span>;
  }
  canvas.<span class="hljs-property">width</span> = videoPlayer.<span class="hljs-property">videoWidth</span>;
  canvas.<span class="hljs-property">height</span> = videoPlayer.<span class="hljs-property">videoHeight</span>;
  <span class="hljs-keyword">if</span> (!ctx) {
    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Canvas 2d Context is not supported'</span>);
  }
  ctx.<span class="hljs-title function_">drawImage</span>(videoPlayer, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
  <span class="hljs-keyword">const</span> img = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"img"</span>);
  img.<span class="hljs-property">src</span> = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">"image/png"</span>);
  <span class="hljs-keyword">const</span> photoView = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">".photo-view"</span>);
  <span class="hljs-keyword">if</span> (photoView) {
    photoView.<span class="hljs-title function_">appendChild</span>(img);
  }
}
</code></pre>
<h2 data-id="heading-31">总结</h2>
<ol>
<li>W3C 标准通常从易用性、安全性上进行考量。很多功能都会尝试避免被用来收集设备指纹。</li>
<li>Chromium 开源项目提供了非常完善的工具链。除去网络因素，通常很快就可以开始编译 Chromium。</li>
<li>Chromium 开源项目中包含大量优秀的设计，非常值得参考和学习。但同时，作为历史较为悠久的开源项目，代码的组织结构和实现不可避免的存在一些瑕疵。通常项目成员也会认真对待各种类型的提交，所以也欢迎各位尝试参与进 Chromium 开源项目中来。</li>
</ol>
<h2 data-id="heading-32">一些注释</h2>
<ol>
<li>W3C 草案中通常使用用户代理（User Agent）这个概念。为了和 <code>navigator.userAgent</code> 进行区分，本文统一翻译为 “浏览器” 。但实际上浏览器只是一种用户代理，下载管理器、爬虫等也可以称为是用户代理。</li>
</ol>
<h2 data-id="heading-33">参考文献与资料</h2>
<ol>
<li>W3C Media Capture and Streams 草案 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fmediacapture-streams%2F" target="_blank" title="https://www.w3.org/TR/mediacapture-streams/" ref="nofollow noopener noreferrer">www.w3.org/TR/mediacap…</a></li>
<li>W3C 组织关于 TR 的要求 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2Fstandards%2Ftypes%2F%23CRD" target="_blank" title="https://www.w3.org/standards/types/#CRD" ref="nofollow noopener noreferrer">www.w3.org/standards/t…</a></li>
<li>Chromium 多进程架构 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.chromium.org%2Fdevelopers%2Fdesign-documents%2Fmulti-process-architecture%2F" target="_blank" title="https://www.chromium.org/developers/design-documents/multi-process-architecture/" ref="nofollow noopener noreferrer">www.chromium.org/developers/…</a></li>
<li>一篇非常详细介绍 mojo 的原理和使用方式的文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkeyou.github.io%2Fblog%2F2020%2F01%2F03%2FChromium-Mojo%26IPC%2F" target="_blank" title="https://keyou.github.io/blog/2020/01/03/Chromium-Mojo&amp;IPC/" ref="nofollow noopener noreferrer">keyou.github.io/blog/2020/0…</a></li>
<li>MDN 关于用户代理概念的解释 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FGlossary%2FUser_agent" target="_blank" title="https://developer.mozilla.org/en-US/docs/Glossary/User_agent" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Netty的WebSocket自动解决拆包粘包问题]]></title>    <link>https://juejin.cn/post/7595494087879000115</link>    <guid>https://juejin.cn/post/7595494087879000115</guid>    <pubDate>2026-01-16T02:23:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595494087879000115" data-draft-id="7595492075119788059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Netty的WebSocket自动解决拆包粘包问题"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-16T02:23:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Netty的WebSocket自动解决拆包粘包问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T02:23:38.000Z" title="Fri Jan 16 2026 02:23:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd1f6146c66c4974930eb586976bee26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769135018&amp;x-signature=UJ6NrGaxuJomZKuRLOAp6to1Qi8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>我们做了<code>Websocket</code>的案例，并没有像<code>TCP</code>协议一样处理拆包和粘包问题。<code>Websocket</code>基于<code>Frame</code>已经自动帮我们解决了拆包和粘包问题，我们一起来看看是怎么解决的！</p>
<h2 data-id="heading-1">02 WebSocketFrame</h2>
<p><code>WebSocketFrame</code>是 Netty 中用于表示 <code>WebSocket</code> 协议数据帧的抽象基类。在 <code>WebSocket</code> 通信中，所有数据（文本、二进制、控制帧等）都通过帧的形式进行传输。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f72c1cf960f24096b4f291a88d20f695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769135018&amp;x-signature=T9ceNMjd92Eh4%2BDt1M1%2F1yp2BIA%3D" alt="" loading="lazy"/></p>
<p><strong>核心属性</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bffec7866caa4d3eb1c05596f93f0229~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769135018&amp;x-signature=PGNGxzSIyz3V%2B4Go0%2BF9eOIWdoU%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 帧的最终标志位（FIN）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> finalFragment;

<span class="hljs-comment">// 保留位（RSV1, RSV2, RSV3）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> rsv;
</code></pre>
<p><code>finalFragment</code>参数是解决拆包粘包的关键标志位。</p>
<h2 data-id="heading-2">03 处理流程</h2>
<h3 data-id="heading-3">3.1 调用链</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ec68ad7c1b4cef8b7624a47e327bf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769135018&amp;x-signature=hNqbuQ0v8AFiM5Fyp4lyNiMfLAA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 解码关键类</h3>
<p><code>io.netty.handler.codec.http.websocketx.WebSocket08FrameDecoder</code></p>
<p><code>WebSocket</code>协议定义了明确的帧格式，每个帧都有明确的边界标识：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e8bc5f5f7644339e8d0da30f4f8eba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769135018&amp;x-signature=dJP8YktQrrU0o3KelxMPgwYeVX0%3D" alt="" loading="lazy"/></p>
<p><strong>关键字段：</strong></p>
<ul>
<li><strong>FIN位（1位）</strong>：标识是否是消息的最后一个帧</li>
<li><strong>opcode（4位）</strong>：操作码，标识帧类型（文本、二进制、控制帧等）</li>
<li><strong>MASK位（1位）</strong>：标识是否掩码</li>
<li><strong>Payload length（7位）</strong>：负载长度，自动扩展</li>
</ul>
<p>而<code>WebSocket08FrameDecoder</code>专门定义了解析帧的字段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ecb4699413a445e8ad95c84168cab6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769135018&amp;x-signature=BXliWt%2FarFiZ93IC6M%2FCrE6AdQ0%3D" alt="" loading="lazy"/></p>
<p>其中关键的代码块：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> in.readByte();
frameFinalFlag = (b &amp; <span class="hljs-number">0x80</span>) != <span class="hljs-number">0</span>;
</code></pre>
<p><code>(b &amp; 0x80) != 0</code>是用于检测某个字节 b 的最高位（即第7位，从右往左数）是否为1。如果为1，则返回true，表示数据已经读完。这里正是解决拆包粘包的关键标志位。</p>
<h3 data-id="heading-5">3.3 整个解析流程</h3>
<ul>
<li><strong>长度字段解析</strong>：首先读取帧头部，解析payload长度</li>
<li><strong>动态读取</strong>：根据长度字段值，读取相应字节数的数据</li>
<li><strong>帧完整性检查</strong>：检查FIN位，确定消息是否结束</li>
<li><strong>消息聚合</strong>：对于分片消息（FIN=0），自动缓存和重组</li>
</ul>
<h2 data-id="heading-6">04 小结</h2>
<p><code>WebSocket</code>的拆包粘包问题已经妥善解决，开发者只需要配置<code>WebSocketServerProtocolHandler</code>，Netty就会在合适的时机自动创建和配置<code>WebSocket13FrameDecoder</code>。为我们解决困扰，无需手动处理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么你的 Prompt 越写越长，效果却越来越差？]]></title>    <link>https://juejin.cn/post/7595808703074074650</link>    <guid>https://juejin.cn/post/7595808703074074650</guid>    <pubDate>2026-01-17T05:10:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595808703074074650" data-draft-id="7595841630676795443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么你的 Prompt 越写越长，效果却越来越差？"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-17T05:10:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西陵"/> <meta itemprop="url" content="https://juejin.cn/user/4353721774379054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么你的 Prompt 越写越长，效果却越来越差？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721774379054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西陵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T05:10:05.000Z" title="Sat Jan 17 2026 05:10:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大语言模型（LLM）在早期阶段主要以对话机器人的形式出现，用户通过自然语言向模型提问，模型返回一段看似智能的文本结果。这一阶段，模型能力的发挥高度依赖用户如何提问，同一个问题，用不同的描述方式，往往会得到质量差异巨大的结果。</p>
<p>在这种背景下，<code>提示词工程</code>作为一门面向大语言模型的输入设计方法论逐渐成型，本篇文章主要帮助大家快速了解<code>提示词工程</code>的本质以及在书写技巧。</p>
<h2 data-id="heading-1">什么是提示词工程？</h2>
<p>提示词工程的本质就是<strong>在有限上下文窗口内，最大化模型输出的确定性与可用性，减少模型自由发挥的空间</strong>。简单来说，就是提供一种提示词书写范式来确保大模型能够精准地按照用户的要求输出高质量的内容。</p>
<p><strong>❌ 差提示词</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">帮我做一个个人待办清单页面
</code></pre>
<p>对于这段提示词，AI 不知道用什么技术、什么风格、要哪些功能、有什么限制。结果就是 AI 自由发挥，生成的代码和项目规范不符合。</p>
<p><strong>✅ 好提示词</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">## 角色
你是一个擅长 <span class="hljs-title class_">React</span> 和用户体验设计的前端开发者。

## 背景
我需要做一个个人待办清单网页，用来记录每天的待办任务，现在已经完整基本功能的开发。

## 任务
实现任务的<span class="hljs-string">"拖拽排序"</span>功能，让用户可以通过拖拽调整任务顺序。

## 要求
- 拖拽时被拖动的任务半透明
- 放置位置有明显的视觉指示线
- 拖拽完成后顺序立即更新

## 约束
- 技术栈为 <span class="hljs-title class_">React</span> + <span class="hljs-title class_">TypeScript</span> + <span class="hljs-title class_">Tailwind</span> <span class="hljs-variable constant_">CSS</span>
- 不使用第三方拖拽库（如 react-beautiful-dnd）
- 用原生 <span class="hljs-title class_">HTML5</span> 拖拽 <span class="hljs-variable constant_">API</span>
- 代码要有详细注释，我是拖拽 <span class="hljs-variable constant_">API</span> 的初学者

## 输出格式
完整的 <span class="hljs-title class_">React</span> 组件代码，包含：
<span class="hljs-number">1.</span> 组件文件（<span class="hljs-title class_">TypeScript</span>）
<span class="hljs-number">2.</span> 关键逻辑的中文注释
<span class="hljs-number">3.</span> 简单的使用说明
</code></pre>
<h2 data-id="heading-2">提示词常见问题</h2>
<p>在实际使用中，提示词的质量参差不齐，以下是几类最常见的问题及其本质原因。</p>
<h3 data-id="heading-3">信息量过多</h3>
<p>我想让 AI 帮我做一个待办清单应用，于是将所有想法一次性列出：</p>
<pre><code class="hljs language-jsx" lang="jsx">帮我做一个待办清单应用，要有添加任务、删除任务、编辑任务、
标记完成、设置优先级、设置截止日期、分类标签、搜索功能、
数据统计、导出功能，还要有暗黑模式，最好能同步到云端，
支持多设备使用，界面要好看，用 <span class="hljs-title class_">React</span> 写，要有动画效果。
</code></pre>
<p><strong>问题本质</strong>：无结构、无重点。AI 可能会忽略关键信息，输出与某些要求冲突。</p>
<h3 data-id="heading-4">信息量太少</h3>
<p>我想让 AI 帮我写个按钮组件，只有一句需求，没有任何背景：</p>
<pre><code class="hljs language-jsx" lang="jsx">帮我写一个按钮组件
</code></pre>
<p><strong>问题本质</strong>：缺少上下文。上下文可能是：</p>
<ul>
<li>项目的技术栈</li>
<li>按钮需要的功能</li>
<li>期望的样式风格</li>
</ul>
<p>最终 AI 只能给一个通用的结果。</p>
<h3 data-id="heading-5">没有目标</h3>
<p>我想让 AI 帮我优化代码，但不给优化目标：</p>
<pre><code class="hljs language-jsx" lang="jsx">帮我优化一下这段代码：
[粘贴了一段代码]
</code></pre>
<p><strong>问题本质</strong>：只有动作，没有结果。优化指代不明确——是体积、性能还是可读性？最终输出的结果必然不符合预期。</p>
<h3 data-id="heading-6">没有约束</h3>
<p>我想让 AI 帮我写一个输入框组件，但是没有添加相关约束：</p>
<pre><code class="hljs language-jsx" lang="jsx">帮我写一个输入框组件。

技术栈：<span class="hljs-title class_">React</span> + <span class="hljs-title class_">TypeScript</span> + <span class="hljs-variable constant_">SCSS</span>
</code></pre>
<p><strong>问题本质</strong>：AI 容易引入额外的假设，例如：</p>
<ul>
<li>使用不兼容的 ui 组件库，例如 antd。</li>
<li>使用复杂的状态管理机制。</li>
</ul>
<p>导致最终输出<strong>不可控</strong>，隐性引入错误假设。</p>
<h2 data-id="heading-7">提示词模板</h2>
<p>了解了常见问题后，我们需要一套结构化的方法来避免它们。这就是提示词模板的价值所在。</p>
<h3 data-id="heading-8">提示词的困扰</h3>
<p>我们现在知道在使用 AI 时，提供的上下文越清晰，AI 给出的回答就会越符合预期。但是每次写提示词的时候，我们大概率还是会陷入这样的状态：</p>
<blockquote>
<p>我要先给 AI 指定一个角色，告诉他背景和任务，还有约束、要求、技术栈……约束要包含什么内容？要求要写什么？技术栈要放到哪里？</p>
</blockquote>
<p>这会给 AI 使用者带来很大的认知负担，我们同时要思考"说什么"和"怎么说"。而模板的价值，就是<strong>把"怎么说"变成固定格式，让你专注于"说什么"</strong>。</p>
<p>这与前端的开发框架（React/Vue）很类似：在没有框架之前，开发者既要关注业务，同时还需要关注 DOM 更新及性能问题；随着框架的推出，前端开发者能把更多的精力放到业务功能开发上。</p>
<h3 data-id="heading-9">模板目标</h3>
<p>提示词模板的目标是<strong>减少使用者的思考负担并提高 AI 输出的稳定性</strong>。但模板并不是终极目标，因为固定的模板反而会限制灵活性。因此在不同阶段、不同场景，使用者可以对模板进行调整：</p>





















<table><thead><tr><th><strong>阶段</strong></th><th><strong>做法</strong></th></tr></thead><tbody><tr><td>初级阶段</td><td>严格按框架填写，确保不遗漏</td></tr><tr><td>熟练阶段</td><td>根据任务复杂度简化或扩展</td></tr><tr><td>高手阶段</td><td>框架内化成直觉，自然地组织信息</td></tr></tbody></table>
<h3 data-id="heading-10">推荐模板</h3>
<p>模板结构：</p>













































<table><thead><tr><th><strong>主题</strong></th><th><strong>必填程度</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>角色</td><td>必须</td><td>让 AI 成为某个领域的专家</td></tr><tr><td>背景</td><td>必须</td><td>让 AI 提前了解任务的背景知识</td></tr><tr><td>任务</td><td>必须</td><td>告诉 AI 要做什么</td></tr><tr><td>要求</td><td>推荐</td><td>告诉 AI 任务完成的标准</td></tr><tr><td>约束</td><td>推荐</td><td>为 AI 划定边界，防止自由发挥</td></tr><tr><td>格式</td><td>可选</td><td>告诉 AI 最终输出内容的格式</td></tr><tr><td>示例</td><td>可选</td><td>用实际的例子告诉 AI 要怎么做</td></tr></tbody></table>
<p>模板示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 角色</span>
你是一个擅长 React 和组件开发的的前端开发者。

<span class="hljs-section">## 背景</span>
我使用 react 开发了一个基础组件库，里面包含了xx个组件，组件名称如下xxx。

<span class="hljs-section">## 任务</span>
帮我为每个组件生成一份 mdr 文件，表示该组件的使用详细说明。

<span class="hljs-section">## 要求</span>
<span class="hljs-bullet">-</span> 文档要包含组件的 API、使用示例、xxx。

<span class="hljs-section">## 约束</span>
<span class="hljs-bullet">-</span> 使用 md 语法。
<span class="hljs-bullet">-</span> 必须保证 API 的完整，不能漏掉内容。

<span class="hljs-section">## 输出格式</span>
Title: 组件名称

description: 组件描述

API：
xxx

Examples：
xxx

<span class="hljs-section">## 示例</span>

Title: Alert

description: 警示组件

API:

| 参数 | 说明 | 类型 | 默认值 | 版本 |
| --- | --- | --- | --- | --- |
| action | 自定义操作项 | ReactNode | - | 4.9.0 |
| afterClose | 关闭动画结束后触发的回调函数 | () =&gt; void | - |  |
| banner | 是否用作顶部公告 | boolean | false |  |

</code></pre>
<h2 data-id="heading-11">进阶提示词技巧</h2>
<h3 data-id="heading-12"><strong>Few-shot Prompting</strong></h3>
<p>Few-shot 的核心思想就是给 AI 几个例子，让他先按照例子学习，理解任务处理流程及最终的内容输出。这种模式能够更高效的让 AI 理解用户的意图，这和人学习新东西一样，直接看示范比读文档更高效。</p>
<pre><code class="hljs language-jsx" lang="jsx">任务：为 <span class="hljs-title class_">React</span> 组件生成 <span class="hljs-title class_">TypeScript</span> <span class="hljs-title class_">Props</span> 类型定义

示例<span class="hljs-number">1</span>：
组件描述：一个显示任务标题的组件，标题必填，可选显示完成状态
输出：
interface <span class="hljs-title class_">TaskTitleProps</span> {
  <span class="hljs-attr">title</span>: string;           <span class="hljs-comment">// 任务标题，必填</span>
  isCompleted?: boolean;   <span class="hljs-comment">// 完成状态，可选</span>
}

示例<span class="hljs-number">2</span>：
组件描述：一个按钮组件，显示文字必填，点击事件必填，可选禁用状态
输出：
interface <span class="hljs-title class_">ButtonProps</span> {
  <span class="hljs-attr">label</span>: string;           <span class="hljs-comment">// 按钮文字，必填</span>
  <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>;     <span class="hljs-comment">// 点击事件，必填</span>
  disabled?: boolean;      <span class="hljs-comment">// 禁用状态，可选</span>
}
</code></pre>
<p>示例虽然能够更高效的帮助 AI 理解任务，但是过多的示例也会加大 token 的消耗，因此示例不是越多越好，要遵循<strong>少而精的原则</strong>，通过 2～5 个例子将典型的场景、多样性场景以及边界场景列举出来。</p>
<h3 data-id="heading-13"><strong>Chain of Thought</strong></h3>
<p>Chain of Thought 的核心思想是告诉 AI 让他一步步思考推理，输出推理内容，而不是直接给答案。就像解数学题一样，把解题的每一步都写出来，这样往往能让 AI 输出更准确的答案。</p>
<pre><code class="hljs language-jsx" lang="jsx">## 角色
你是一个擅长 <span class="hljs-title class_">React</span> 和组件开发的的前端开发者。

## 背景
我使用 react 开发了一个基础组件库，里面包含了xx个组件。

## 任务
帮我给修改的 react 组件补充新的单测。

### 修改点分析步骤
- 分析组件的 props，找出新增/删减/修改的参数，并输出出来。
- 分析组件的内部逻辑，找出新增/删除/修改的逻辑，并输出出来。

</code></pre>
<p>这种模式在复杂的场景中会大大提升输出效果，但是也存在一些局限：</p>
<ul>
<li>输出内容的长度会大大增加，增加 Token 的消耗。</li>
<li>对于某些简单任务，强行使用该模式可能反而会降低效果。</li>
<li>如果推理的过程中某一步出错，可能会导致接下来步骤都会出错，需要配合 Self-Critique 来检查。</li>
</ul>
<h3 data-id="heading-14"><strong>Self-Critique</strong></h3>
<p>与人类一样，AI 并非总能在首次尝试时就生成最佳输出，Self-Critique 的核心思想是在 AI 生成内容之后，让 AI 再自我检查一遍，发现并修复问题。这个和我们考试答题一样，做完之后再检查一遍往往能发现遗漏的细节或者写错的题。</p>
<pre><code class="hljs language-jsx" lang="jsx">## 角色
你是一个擅长 <span class="hljs-title class_">React</span> 和组件开发的的前端开发者。

## 背景
我使用 react 开发了一个基础组件库，里面包含了xx个组件。

## 任务
帮我给修改的 react 组件补充新的单测。

## 修改点分析步骤
- 分析组件的 props，找出新增/删减/修改的参数，并输出出来。
- 分析组件的内部逻辑，找出新增/删除/修改的逻辑，并输出出来。

## 要求

- 生成完之后，请严格自查
	- 是否覆盖了所有修改点。
	- 每个修改点是否覆盖了所有边界情况（空值、空字符串、只有空格）
</code></pre>
<p>这种模式下会让 AI 扮演一个审查者的角色重新审下生成的内容，提高内容的准确性，但是也有它的局限：</p>
<ul>
<li>增加 Token 的消耗，这种模式更推荐在复杂的场景中使用。</li>
<li>AI 可能出现自我认可的偏差，认为输出是没问题的，此时<strong>需要严格给 AI 设定审查者的角色</strong>。</li>
</ul>
<h2 data-id="heading-15">总结</h2>
<p>本文围绕「提示词工程」展开，从背景、核心目标、常见问题、结构化模板，到 Few-shot、Chain of Thought、Self-Critique 等进阶技巧，系统性地说明了一件事：</p>
<blockquote>
<p>提示词工程的本质，不是“如何把话说得更漂亮”，而是如何通过结构化上下文，降低大模型输出的不确定性。</p>
</blockquote>
<p>然而，这种提示词优化的思路也带来了新的工程问题：<strong>提示词越来越长、结构越来越复杂，最终直接反映为 Token 体积的持续膨胀</strong>。</p>
<p>因此，在实际工程中，提示词优化并不等同于写得越详细越好，而是需要在<strong>信息充分性与 Token 成本之间取得平衡</strong>。如何控制上下文规模、避免无效信息堆积、并在复杂任务中持续提供刚刚好的上下文，成为提示词工程之后必须面对的核心问题。</p>
<h2 data-id="heading-16">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fprompt-engineering" target="_blank" title="https://platform.openai.com/docs/guides/prompt-engineering" ref="nofollow noopener noreferrer">OpenAI Prompt Engineering Guide</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fclaude%2Fdocs%2Fprompt-engineering" target="_blank" title="https://docs.anthropic.com/claude/docs/prompt-engineering" ref="nofollow noopener noreferrer">Anthropic Prompt Engineering</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2005.14165" target="_blank" title="https://arxiv.org/abs/2005.14165" ref="nofollow noopener noreferrer">Few-shot Prompting</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2201.11903" target="_blank" title="https://arxiv.org/abs/2201.11903" ref="nofollow noopener noreferrer">Chain of Thought</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2303.17651" target="_blank" title="https://arxiv.org/abs/2303.17651" ref="nofollow noopener noreferrer">Self-Critique</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI编程出海门槛降低，PayPal可开通国内个人账户]]></title>    <link>https://juejin.cn/post/7595858353660559394</link>    <guid>https://juejin.cn/post/7595858353660559394</guid>    <pubDate>2026-01-17T05:21:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858353660559394" data-draft-id="7595864836359733300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI编程出海门槛降低，PayPal可开通国内个人账户"/> <meta itemprop="keywords" content="后端,面试,GitHub"/> <meta itemprop="datePublished" content="2026-01-17T05:21:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卷福同学"/> <meta itemprop="url" content="https://juejin.cn/user/3456520291098686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI编程出海门槛降低，PayPal可开通国内个人账户
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520291098686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卷福同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T05:21:59.000Z" title="Sat Jan 17 2026 05:21:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天，PayPal中国正式支持个人卖家账户注册，为独立开发者、小微创业者和从事海外产品销售的个人用户提供了更便捷的跨境收款渠道。下面为您详细介绍申请流程和常见问题</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3da7118fb5e641338b90df2136847de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769232119&amp;x-signature=g19mE3MlW60gOsFrb1VOSZhszvM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、申请流程</h2>
<p><strong>1. 访问申请入口</strong></p>
<p>前往PayPal官方页面（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.paypal.cn%2Fportal%2Faccount-selection%25EF%25BC%2589%25EF%25BC%258C%25E9%2580%2589%25E6%258B%25A9%25E2%2580%259C%25E4%25B8%25AA%25E4%25BA%25BA%25E5%258D%2596%25E5%25AE%25B6%25E2%2580%259D%25E8%25B4%25A6%25E6%2588%25B7%25E7%25B1%25BB%25E5%259E%258B%25E3%2580%2582" target="_blank" title="https://www.paypal.cn/portal/account-selection%EF%BC%89%EF%BC%8C%E9%80%89%E6%8B%A9%E2%80%9C%E4%B8%AA%E4%BA%BA%E5%8D%96%E5%AE%B6%E2%80%9D%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B%E3%80%82" ref="nofollow noopener noreferrer">www.paypal.cn/portal/acco…</a></p>
<p><strong>2. 账户注册</strong></p>
<p>使用邮箱和手机号创建新账户。如曾注册过PayPal，需使用新邮箱完成申请。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa86039fed5405d90de5708f8da6d19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769232119&amp;x-signature=eTiYrpdVFDC7h9lsaJP%2B0gf8T8Q%3D" alt="img" loading="lazy"/></p>
<p><strong>3. 完成验证</strong></p>
<p>依次完成手机短信验证和邮箱验证。</p>
<p><strong>4. 身份认证</strong></p>
<p>提交身份证信息并进行人脸识别认证。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85332dec8b244d8ab2c83278e6da034c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769232119&amp;x-signature=mmLT5Nh7EQNieRghR3Hlc3cppDY%3D" alt="img" loading="lazy"/></p>
<p><strong>5. 填写商业信息</strong></p>
<p>如实填写职业和商品/行业信息，例如：</p>
<ul>
<li>
<p>职业：工程技术人员</p>
</li>
<li>
<p>行业：计算机软件开发服务</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/937fb59a407e4a88bf42a0983ac9d42e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769232119&amp;x-signature=F83AcbBnihwbPnqOSscjLWczNXo%3D" alt="img" loading="lazy"/></p>
<p><strong>6. 提交审核</strong></p>
<p>信息提交后，通常30分钟内即可完成审核。通过后即可集成使用PayPal收款功能。</p>
<h2 data-id="heading-1">二、常见问题解答</h2>
<p><strong>1. 费用标准</strong></p>
<ul>
<li>手续费：0.5%（限时优惠，标准费率为1.0%）</li>
<li>增值税：6%（由PayPal代缴）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e78e07bf98284f829b6ca6f3cebfa7a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769232119&amp;x-signature=%2Bdvo7kM2IQ2afnPPBQJIageJ8GE%3D" alt="img" loading="lazy"/></p>
<p><strong>2. 外汇额度与申报</strong></p>
<ul>
<li>无需个人逐笔申报，由PayPal统一向银行申报</li>
<li>不占用个人外汇额度，但PayPal会根据政策设置收款额度限制</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502d6559520b4c5fbf5bbf822d9b2fc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769232119&amp;x-signature=hQrDM2nR2bLG6kLveAfQvQmsmfI%3D" alt="img" loading="lazy"/></p>
<p><strong>3. 税务注意事项</strong></p>
<p>建议用户关注个人年度所得税申报要求，确保合规。</p>
<h2 data-id="heading-2">结语</h2>
<p>PayPal个人卖家账户的推出，降低了个人从事跨境业务的门槛，为独立开发者和小微创业者提供了更便捷的收款渠道。建议有需求的用户尽早完成账户开通，为海外业务发展打好基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为啥 Array.isArray 判断数组最靠谱？]]></title>    <link>https://juejin.cn/post/7595437351461945359</link>    <guid>https://juejin.cn/post/7595437351461945359</guid>    <pubDate>2026-01-16T03:12:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595437351461945359" data-draft-id="7595472747456299023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为啥 Array.isArray 判断数组最靠谱？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-16T03:12:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为啥 Array.isArray 判断数组最靠谱？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T03:12:01.000Z" title="Fri Jan 16 2026 03:12:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <code>JavaScript</code> 中，如何判断一个值是否为数组是很常见的需求，一般有以下几种方法。</p>
<h2 data-id="heading-0">1、方式一：JSON.stringify</h2>
<p>可以通过 <code>JSON.stringify</code> 序列化字符串，然后判断字符串是否以 <code>["</code> 开头，以 <code>"]</code> 结尾来判断是否为数组。这其实和使用 <code>JSON.stringify(obj) === '{}'</code> 判断一个对象是否是空对象的思路类似。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(arr).<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'['</span>) &amp;&amp; <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(arr).<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">']'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>兼容性好。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>需要序列化性能较差。</li>
<li>无法处理循环引用的数据，会报错 <code>TypeError: Converting circular structure to JSON</code>。</li>
<li>判断代码也较为复杂。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [];
arr[<span class="hljs-number">0</span>] = arr; <span class="hljs-comment">// 添加循环引用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(arr).<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'['</span>) &amp;&amp; <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(arr).<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">']'</span>)); <span class="hljs-comment">// 报错 TypeError: Converting circular structure to JSON</span>
</code></pre>
<h2 data-id="heading-1">2、方式二：instanceof</h2>
<p><code>instanceof</code> 可以判断某个实例是否属于某种类型，它内部会通过原型链往上一级一级查找，直到找到和当前对象的原型相等的原型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>);      <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({} <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>);      <span class="hljs-comment">// false</span>
</code></pre>
<p>但是<strong>原型链是可以被修改的</strong>，所以 <code>instanceof</code> 判断结果可能不准确。比如我们可以利用 <code>Object.setPrototypeOf(target, newProto)</code> 来修改原型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = {};
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(arr, <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>还有一种情况，就是跨 <code>iframe</code> 进行判断时，<code>instanceof</code> 判断结果可能不准确。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'iframe'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(iframe);
    <span class="hljs-keyword">const</span> iframeArray = iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">Array</span>;
    <span class="hljs-keyword">const</span> iframeArr = <span class="hljs-keyword">new</span> <span class="hljs-title function_">iframeArray</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iframeArr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>);  <span class="hljs-comment">// false</span>
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这里其实 <code>iframeArr</code> 是一个数组，但是 <code>instanceof</code> 判断结果却是 <code>false</code>。</p>
<p><strong>优点</strong>：</p>
<ul>
<li>简单直观。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>通过 <code>Object.setPrototypeOf</code> 修改原型后判断不准确。</li>
<li>跨 <code>iframe</code> 失效。</li>
</ul>
<h2 data-id="heading-2">3、方式三：constructor 属性</h2>
<p>每个实例对象都有一个 <code>constructor</code> 属性，指向它的构造函数，所以通过 <code>constructor</code> 属性可以判断一个实例是否属于某个类型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([].<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Array</span>);  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({}.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Array</span>);  <span class="hljs-comment">// false</span>
</code></pre>
<p>然而和原型一样，<code>constructor</code> 属性也是可以被修改的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [];
arr.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Object</span>; <span class="hljs-comment">// 修改 constructor</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// false（被修改了导致判断错误）</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>简单直观。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li><code>constructor</code> 可被修改，判断不准确。</li>
</ul>
<h2 data-id="heading-3">4、方式四：Object.prototype.toString.call</h2>
<p><code>Object.prototype.toString.call()</code> 是 <code>JavaScript</code> 中一个非常强大的类型检测方法，它可以获取任意值的内部 <code>[[Class]]</code> 属性，并以字符串形式返回其类型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(arr) === <span class="hljs-string">'[object Array]'</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>它是一个检测数据类型的<strong>标准方法</strong>，它不仅可以检查数组 <code>Array</code>、对象 <code>Object</code>，基本数据类型和其它引用类型像<code>日期 Date</code>、 <code>正则 regexp</code> 等都可以判断出来，实际开发中通常会把它封装成一个通用的类型检测方法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 判断特定类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isType</span>(<span class="hljs-params">value, type</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(value) === <span class="hljs-string">`[object <span class="hljs-subst">${type}</span>]`</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isType</span>([], <span class="hljs-string">'Array'</span>));     <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isType</span>({}, <span class="hljs-string">'Object'</span>));    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isType</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-string">'Date'</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isType</span>(<span class="hljs-regexp">/abc/</span>, <span class="hljs-string">'RegExp'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<p>但是在 <code>es6</code> 的 <code>Symbol</code>出现之后，可以通过 <code>Symbol.toStringTag</code> 属性来控制其返回值，也会导致其判断不准确。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]: <span class="hljs-string">'Array'</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(arr) === <span class="hljs-string">'[object Array]'</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p><code>Symbol.toStringTag</code> 也可以支持设置为任意值。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]: <span class="hljs-string">'111'</span> <span class="hljs-comment">// 可以设置为任意值</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj)); <span class="hljs-comment">// [object 111]</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>简单直观。</li>
<li>不仅可以判断数组，基本数据类型和其它引用数据类型 <code>Date</code>、<code>Regexp</code> 也可以。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>代码较长，并且可通过 <code>Symbol.toStringTag</code> 修改判断结果。</li>
</ul>
<h2 data-id="heading-4">5、方式五：Array.isArray（最推荐）</h2>
<p><code>Array.isArray()</code> 是 <code>Array</code> 的一个静态方法，可以判断一个值是否为数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr));  <span class="hljs-comment">// true</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>最可靠。</li>
<li>简单直观。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>兼容性问题，只支持 <code>IE9+</code>。</li>
</ul>
<h2 data-id="heading-5">为什么 Array.isArray 是最靠谱的呢？</h2>
<p><strong>1. 通过判断内部存储的数据结构是否符合数组的数据结构定义</strong>。</p>
<p>数组是一种数据结构：</p>
<ul>
<li>它是一种线性表数据结构，也就是它里面的数据是排成一条线一样的，它的数据只有前和后两个方向。除了数组，队列、栈、链接也是线性表数据结构。</li>
<li>连续的内存空间。就是说数据中的元素在内存中是连续存储的，正是因为这个特性，所以数据可以实现<strong>随机访问</strong>，也就是访问数据中的每个元素花的时间就是一样的，时间复杂度都是 <code>O(1)</code>，查询数据特别快。</li>
</ul>
<p><strong>2. 它是一个原生方法，内部<code> C++</code> 编码实现，我们从 js 代码层面无法判断数据内部的存储结构，也就无法模拟实现。</strong></p>
<h2 data-id="heading-6">小结</h2>









































<table><thead><tr><th>判断是否是数组的方法</th><th>优点</th><th>缺点</th><th>推荐度</th></tr></thead><tbody><tr><td>Array.isArray()</td><td>标准、跨环境、最可靠</td><td>兼容性问题，只支持IE9+</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>Object.prototype.toString.call()</td><td>最兼容、可靠</td><td>代码较长，并且可通过 Symbol.toStringTag 修改判断结果</td><td>⭐⭐⭐⭐</td></tr><tr><td>instanceof</td><td>简单直观</td><td>通过 Object.setPrototypeOf 修改原型后判断不准确，跨 iframe 失效</td><td>⭐⭐⭐</td></tr><tr><td>constructor</td><td>简单</td><td>constructor 可被修改</td><td>⭐⭐</td></tr><tr><td>JSON.stringify</td><td>兼容性好</td><td>无法处理循环引用、性能差</td><td>⭐</td></tr></tbody></table>
<p>在平时实际前端项目开发中，如果需要判断是否是数组，直接用 <code>Array.isArray()</code> 就好了，它内部通过 <code>C++</code> 编码实现，判断其存储结构是否为数组，是最可靠的判断方法，如果需要封装一个通用的数据类型判断方法，可以采用 <code>Object.prototype.toString.call()</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript开发者必知的5个高效调试技巧：告别console.log时代！]]></title>    <link>https://juejin.cn/post/7595858063502639138</link>    <guid>https://juejin.cn/post/7595858063502639138</guid>    <pubDate>2026-01-17T04:19:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858063502639138" data-draft-id="7595858353660510242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript开发者必知的5个高效调试技巧：告别console.log时代！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-17T04:19:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript开发者必知的5个高效调试技巧：告别console.log时代！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T04:19:20.000Z" title="Sat Jan 17 2026 04:19:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript开发者必知的5个高效调试技巧：告别console.log时代！</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在JavaScript开发中，调试是不可避免的一部分。尽管<code>console.log</code>是最简单直接的调试工具，但它远非最高效的方式。随着现代浏览器开发者工具的日益强大，以及Node.js生态的成熟，开发者拥有了更多高效的调试方法。本文将介绍5个专业级的JavaScript调试技巧，帮助你彻底告别“<code>console.log</code>泛滥”的时代，提升开发效率和代码质量。</p>
<hr/>
<h3 data-id="heading-2">1. 使用断点调试（Breakpoints）</h3>
<h4 data-id="heading-3">为什么断点比<code>console.log</code>更强大？</h4>
<p>断点调试允许你在代码执行的特定位置暂停程序，查看当前的变量状态、调用栈以及作用域链。相比<code>console.log</code>，断点提供了动态的、交互式的调试体验，无需反复修改代码并刷新页面。</p>
<h4 data-id="heading-4">如何设置断点？</h4>
<ol>
<li>
<p><strong>浏览器中的断点</strong>：</p>
<ul>
<li>在Chrome DevTools的“Sources”面板中，找到目标文件并点击行号添加断点。</li>
<li>使用条件断点（右键点击行号选择“Add conditional breakpoint”），仅在满足特定条件时暂停执行。</li>
<li>使用DOM断点（Elements面板右键DOM节点）监听DOM结构变化或事件触发。</li>
</ul>
</li>
<li>
<p><strong>Node.js中的断点</strong>：</p>
<ul>
<li>使用<code>debugger</code>关键字结合<code>--inspect</code>标志启动Node.js应用：
<pre><code class="hljs language-bash" lang="bash">node --inspect your-script.js
</code></pre>
</li>
<li>通过Chrome DevTools连接到Node.js进程进行调试。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-5">适用场景</h4>
<ul>
<li>复杂逻辑的逐步跟踪。</li>
<li>异步代码的执行顺序分析。</li>
<li>性能问题的定位（结合Performance面板）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. 利用日志增强工具（Console API的高级用法）</h3>
<p>如果你仍然需要日志输出，不妨试试<code>console</code>对象的更多功能，而不仅仅是<code>console.log</code>：</p>
<h4 data-id="heading-7"><code>console.table()</code></h4>
<p>以表格形式打印数组或对象，便于结构化数据的可视化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }, { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">table</span>(users);
</code></pre>
<h4 data-id="heading-8"><code>console.group()</code>和<code>console.groupEnd()</code></h4>
<p>将相关日志分组显示，避免输出混乱：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">group</span>(<span class="hljs-string">'User Details'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Name: Alice'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Age: 25'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupEnd</span>();
</code></pre>
<h4 data-id="heading-9"><code>console.time()</code>和<code>console.timeEnd()</code></h4>
<p>测量代码块的执行时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'API Call'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'API Call'</span>); <span class="hljs-comment">// 输出: API Call: 120ms</span>
</code></pre>
<h4 data-id="heading-10"><code>console.trace()</code></h4>
<p>打印函数调用的堆栈轨迹，快速定位问题来源：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">trace</span>(<span class="hljs-string">'Trace from foo'</span>);
}
<span class="hljs-title function_">foo</span>();
</code></pre>
<hr/>
<h3 data-id="heading-11">3. Chrome DevTools的“黑科技”</h3>
<p>现代浏览器的开发者工具提供了许多不为人知的高效功能：</p>
<h4 data-id="heading-12"><strong>即时表达式（Live Expressions）</strong></h4>
<p>在DevTools的Console面板中点击“Eye”图标，添加一个实时更新的表达式。例如监控某个变量的值变化，无需反复手动输入命令。</p>
<h4 data-id="heading-13"><strong>网络请求重放与修改</strong></h4>
<p>在Network面板中右键请求，选择“Replay XHR”或“Edit and Replay”，直接修改请求参数并重新发送，适合测试API边界条件。</p>
<h4 data-id="heading-14"><strong>内存与性能分析</strong></h4>
<ul>
<li><strong>Memory面板</strong>：捕获堆快照，查找内存泄漏。</li>
<li><strong>Performance面板</strong>：录制并分析运行时性能瓶颈。</li>
</ul>
<hr/>
<h3 data-id="heading-15">4. Node.js调试与错误追踪工具</h3>
<p>对于后端或全栈开发者，Node.js生态提供了强大的工具链：</p>
<h4 data-id="heading-16"><strong>内置Debugger模块</strong></h4>
<p>通过<code>node inspect your-script.js</code>启动交互式调试会话，支持步进（step over/into）、观察表达式等操作。</p>
<h4 data-id="heading-17"><strong>VS Code集成调试</strong></h4>
<p>配置<code>.vscode/launch.json</code>文件后，可直接在VS Code中打断点和调试Node.js应用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Debug Node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}/app.js"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-18"><strong>错误追踪服务（Sentry, New Relic）</strong></h4>
<p>集成Sentry等工具可捕获生产环境的异常并生成详细报告（包括调用栈、环境变量等），远超本地<code>try-catch + console.error</code>的能力范围。</p>
<hr/>
<h3 data-id="heading-19">5. Source Map与生产环境调试</h3>
<p>生产环境的代码通常经过压缩和混淆，但通过Source Map可以还原原始代码结构进行调试：</p>
<h4 data-id="heading-20"><strong>生成Source Map</strong></h4>
<p>在Webpack、Rollup等构建工具中启用配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>,
};
</code></pre>
<h4 data-id="heading-21"><strong>浏览器加载Source Map</strong></h4>
<p>确保生产环境的JS文件末尾包含注释映射路径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//# sourceMappingURL=app.min.js.map</span>
</code></pre>
<h4 data-id="heading-22"><strong>Node.js的Source Map支持</strong></h4>
<p>通过<code>--enable-source-maps</code>标志运行Node.js应用：</p>
<pre><code class="hljs language-bash" lang="bash">node --enable-source-maps app.js
</code></pre>
<hr/>
<h3 data-id="heading-23">总结</h3>
<p>从原始的<code>console.log</code>到现代的断点调试、性能分析和生产环境追踪，JavaScript开发者拥有丰富的工具链来应对各种复杂的调试场景。掌握这些技巧不仅能大幅提升效率，还能帮助你更深入地理解代码的运行机制和潜在问题。下一次当你准备随手写一个<code>console.log</code>时——不妨先想想是否有更高效的替代方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>