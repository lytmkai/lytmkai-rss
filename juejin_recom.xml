<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[SpringBoot实战避坑指南：我在微服务项目中总结的12条高效开发经验]]></title>    <link>https://juejin.cn/post/7571285984090144820</link>    <guid>https://juejin.cn/post/7571285984090144820</guid>    <pubDate>2025-11-12T00:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984090144820" data-draft-id="7571344319702450216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot实战避坑指南：我在微服务项目中总结的12条高效开发经验"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-12T00:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot实战避坑指南：我在微服务项目中总结的12条高效开发经验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:16:53.000Z" title="Wed Nov 12 2025 00:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot实战避坑指南：我在微服务项目中总结的12条高效开发经验</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot作为Java生态中最流行的微服务框架之一，以其"约定优于配置"的理念和强大的自动化能力赢得了广大开发者的青睐。然而在实际企业级项目中，尤其是复杂的微服务架构下，开发者仍然会遇到各种意想不到的"坑"。本文基于笔者在多个大型微服务项目中的实战经验，总结了12条高效开发的黄金法则，涵盖配置管理、性能优化、异常处理等关键领域，帮助开发者避开常见陷阱。</p>
<h3 data-id="heading-2">一、配置管理篇</h3>
<h4 data-id="heading-3">1. 多环境配置的正确打开方式</h4>
<p>新手常犯的错误是将不同环境的配置硬编码在application.properties中。更专业的做法是：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">@activatedProperties@</span>
</code></pre>
<p>配合Maven Profile实现动态切换：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">activation</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">activeByDefault</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">activeByDefault</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">activation</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">activatedProperties</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">activatedProperties</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2. 敏感信息的安全处理</h4>
<p>永远不要在代码库中提交明文密码！推荐组合方案：</p>
<ul>
<li>生产环境使用Vault或Kubernetes Secrets</li>
<li>开发环境使用Jasypt加密：</li>
</ul>
<pre><code class="hljs language-properties" lang="properties"># 加密后的配置示例
db.password=ENC(AQICAHhML...)
</code></pre>
<h4 data-id="heading-5">3. Configuration Properties的验证技巧</h4>
<p>避免简单的<code>@Value</code>注入，改用类型安全的绑定：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.mail")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MailProperties</span> {
    <span class="hljs-meta">@NotEmpty</span> <span class="hljs-keyword">private</span> String host;
    <span class="hljs-meta">@Min(1025)</span> <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
}
</code></pre>
<p>配合<code>@EnableConfigurationProperties</code>启用，SpringBoot会自动验证参数合法性。</p>
<h3 data-id="heading-6">二、性能优化篇</h3>
<h4 data-id="heading-7">4. 启动速度的极致优化</h4>
<p>当依赖过多导致启动缓慢时：</p>
<ol>
<li>使用SpringBoot的Lazy Initialization模式：</li>
</ol>
<pre><code class="hljs language-properties" lang="properties">spring.main.lazy-initialization=true
</code></pre>
<ol start="2">
<li>通过<code>spring-context-indexer</code>加速组件扫描：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-indexer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">5. JPA/Hibernate的性能陷阱</h4>
<p>N+1查询问题是常见性能杀手。解决方案：</p>
<ul>
<li>Always JOIN FETCH关联对象：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@EntityGraph(attributePaths = "orders")</span>
List&lt;Customer&gt; <span class="hljs-title function_">findByActiveTrue</span><span class="hljs-params">()</span>;
</code></pre>
<ul>
<li>Batch Fetching配置：</li>
</ul>
<pre><code class="hljs language-properties" lang="properties">spring.jpa.properties.hibernate.default_batch_fetch_size=20
</code></pre>
<h4 data-id="heading-9">6. Redis缓存的最佳实践</h4>
<p>避免缓存穿透的三重防护：</p>
<ol>
<li>Null值缓存：<code>cache-null-values: true</code></li>
<li>BloomFilter前置过滤</li>
<li>synchronized本地锁控制并发重建</li>
</ol>
<h3 data-id="heading-10">三、异常处理篇</h3>
<h4 data-id="heading-11">7. RESTful API的统一异常处理</h4>
<p>告别混乱的try-catch块，使用<code>@ControllerAdvice</code>标准化错误响应：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(
    BusinessException ex)</span> {
    <span class="hljs-keyword">return</span> ResponseEntity.status(ex.getStatusCode())
           .body(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(ex.getErrorCode(), ex.getMessage()));
}
</code></pre>
<p>配套定义全局错误码枚举：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
    PARAM_INVALID(<span class="hljs-number">40001</span>, <span class="hljs-string">"参数校验失败"</span>),
    SERVICE_UNAVAILABLE(<span class="hljs-number">50002</span>, <span class="hljs-string">"服务暂不可用"</span>);
}
</code></pre>
<h4 data-id="heading-12">8. Transactional注解的隐藏细节</h4>
<p>事务失效的五种常见场景：</p>
<ol>
<li>
<p><strong>自调用问题</strong>：同类方法内调用不会触发AOP代理<br/>
✅ Solution：注入self或使用AopContext</p>
</li>
<li>
<p><strong>异常类型不匹配</strong>：默认只回滚RuntimeException<br/>
✅ Solution：明确指定<code>rollbackFor</code></p>
</li>
<li>
<p><strong>传播行为误用</strong>：REQUIRES_NEW需要新连接<br/>
✅ Solution：评估事务边界设计</p>
</li>
<li>
<p><strong>非public方法</strong><br/>
✅ Solution：遵循Spring AOP规范</p>
</li>
<li>
<p><strong>异步上下文丢失</strong><br/>
✅ Solution：手动传递TransactionTemplate</p>
</li>
</ol>
<h3 data-id="heading-13">四、测试与部署篇</h3>
<h4 data-id="heading-14">9. SpringBootTest的正确姿势</h4>
<p>集成测试的资源消耗优化策略：</p>
<ul>
<li><strong>分层测试</strong>：纯单元测试不用加载Spring上下文</li>
<li><strong>MockBean精准替换</strong>：避免全量启动数据库</li>
<li><strong>Testcontainers替代H2</strong>：更真实的集成测试环境</li>
</ul>
<p>示例Docker化测试配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Testcontainers</span> 
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentServiceIT</span> {
   <span class="hljs-meta">@Container</span> 
   <span class="hljs-keyword">static</span> PostgreSQLContainer&lt;?&gt; postgres = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgreSQLContainer</span>&lt;&gt;();
   
   <span class="hljs-meta">@DynamicPropertySource</span> 
   <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(DynamicPropertyRegistry registry)</span> {
       registry.add(<span class="hljs-string">"spring.datasource.url"</span>, postgres::getJdbcUrl);
   }
}
</code></pre>
<h4 data-id="heading-15">10.Kubernetes健康检查深度定制</h4>
<p>超越actuator的基础健康指示器：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deployment.yaml片段 </span>
<span class="hljs-attr">livenessProbe:</span>
   <span class="hljs-attr">httpGet:</span>
     <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/liveness</span> 
     <span class="hljs-attr">port:</span> <span class="hljs-string">actuator-port</span> 
<span class="hljs-string">initialDelaySeconds:60</span> <span class="hljs-comment">#根据应用实际启动时间调整 </span>

<span class="hljs-attr">readinessProbe:</span>
   <span class="hljs-attr">httpGet:</span>
     <span class="hljs-string">path:/actuator/health/readiness?components=custom-service-check</span> 
</code></pre>
<p>自定义健康指标实现示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span> 
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomHealthIndicator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HealthIndicator</span> {
   <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> Health <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
      <span class="hljs-type">boolean</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> checkExternalService();
      <span class="hljs-keyword">return</span> available ? Health.up().build() : Health.down().build();
   }
} 
</code></pre>
<p>###五、架构设计篇</p>
<p>####11.DDD与SpringBoot的结合实践</p>
<p>避免贫血模型的三个关键点：</p>
<p>1.<strong>领域层保持纯净</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> { <span class="hljs-comment">//不是简单的POJO模型类！</span>
<span class="hljs-keyword">public</span> Money <span class="hljs-title function_">calculateTotal</span><span class="hljs-params">()</span> { ... } <span class="hljs-comment">//业务逻辑内聚封装 }</span>
</code></pre>
<p>2.<strong>基础设施层依赖反转</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">package</span> infrastructure; <span class="hljs-comment">//实现放在基础设施层 @Repository public class JpaOrderRepository implements OrderRepository {} ```</span>

<span class="hljs-number">3.</span>**CQRS模式的应用**
``` properties spring.datasource.write.url=jdbc:postgresql:<span class="hljs-comment">//master-db spring.datasource.read.url=jdbc:postgresql://replica-db ```</span>

####<span class="hljs-number">12.</span>Saga分布式事务模式实现 

在没有XA的情况下保证最终一致性：

事件编排模式示例序列图:

</code></pre>
<p>[Order Service] -&gt; [Payment Service]: Reserve Credit (async event)
[Payment Service] --&gt; [Order Service]: Credit Reserved Event<br/>
[Order Service] -&gt; [Inventory Service]: Prepare Items (async event)
[Inventory Service] --&gt; [Order Service]: Items Prepared Event</p>
<pre><code class="hljs language-css" lang="css">
补偿事务的关键代码结构:
``` java @Transactional public void <span class="hljs-built_in">cancelOrder</span>(Long orderId) { orderRepository<span class="hljs-selector-class">.findById</span>(orderId)<span class="hljs-selector-class">.ifPresent</span>(<span class="hljs-attribute">order</span> -&gt; { paymentService<span class="hljs-selector-class">.refund</span>(<span class="hljs-attribute">order</span>); inventoryService<span class="hljs-selector-class">.restock</span>(<span class="hljs-attribute">order</span>); <span class="hljs-attribute">order</span><span class="hljs-selector-class">.cancel</span>(); }); } ```

###总结 

SpringBoot虽然极大地简化了开发流程,但要在生产环境中构建健壮的微服务系统,仍然需要深入理解其工作原理并遵循最佳实践。本文总结的<span class="hljs-number">12</span>条经验涵盖了从基础配置到高级架构设计的多个维度,其中特别强调的两点是:

<span class="hljs-number">1</span>.**约定优于配置不等于零配置**,合理的显式声明往往比隐式行为更可靠   
<span class="hljs-number">2</span>.**微服务的核心挑战是分布式系统问题**,单纯的技术栈升级不能解决架构缺陷    

希望这些经过实战检验的建议能帮助开发者在SpringBoot项目中少走弯路,构建出高性能、易维护的生产级应用。记住,好的框架应该解放生产力而非掩盖问题本质。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制]]></title>    <link>https://juejin.cn/post/7571351275976605747</link>    <guid>https://juejin.cn/post/7571351275976605747</guid>    <pubDate>2025-11-12T00:21:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571351275976605747" data-draft-id="7571352754896437274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-12T00:21:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:21:57.000Z" title="Wed Nov 12 2025 00:21:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在进行网页爬取时，如果频繁访问同一网站，极有可能被网站识别为爬虫，从而封禁 IP 或要求验证码验证。
为了保证爬虫稳定、高效运行，我们需要了解并掌握 <strong>防封机制与代理使用方法</strong>。</p>
</blockquote>
<p>本章将介绍 Python 爬虫中常用的防封策略、代理原理及实战应用技巧。</p>
<hr/>
<h2 data-id="heading-0">一、为什么会被封</h2>
<p>网站封禁爬虫主要是为了防止资源滥用与服务器过载。常见的封禁手段包括：</p>
<ol>
<li><strong>IP 封禁</strong>：短时间内请求频繁，直接拉黑访问 IP。</li>
<li><strong>User-Agent 检测</strong>：识别请求头中是否包含浏览器标识。</li>
<li><strong>Referer 检查</strong>：判断请求是否来自正常页面跳转。</li>
<li><strong>Cookie 校验</strong>：验证登录状态或访问来源。</li>
<li><strong>请求频率限制</strong>：同一用户短时间内过多请求触发反爬。</li>
</ol>
<p>要应对这些情况，我们可以从 <strong>“伪装自己”</strong> 和 <strong>“多IP访问”</strong> 两个方向入手。</p>
<hr/>
<h2 data-id="heading-1">二、请求伪装：模拟真实用户访问</h2>
<h3 data-id="heading-2">1. 设置请求头</h3>
<p><code>requests</code> 支持通过 <code>headers</code> 参数自定义请求头。
常见做法是添加浏览器信息，让服务器认为请求来自正常用户。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"https://example.com"</span>
headers = {
    <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span>
                  <span class="hljs-string">"AppleWebKit/537.36 (KHTML, like Gecko) "</span>
                  <span class="hljs-string">"Chrome/122.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Referer"</span>: <span class="hljs-string">"https://www.google.com"</span>,
}
response = requests.get(url, headers=headers)
<span class="hljs-built_in">print</span>(response.status_code)
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 随机切换 User-Agent</h3>
<p>为了避免单一 User-Agent 被识别为爬虫，可以在请求中随机切换浏览器标识。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> random

user_agents = [
    <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/123.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) Firefox/124.0"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Linux; Android 10) Mobile Safari/537.36"</span>,
]

headers = {<span class="hljs-string">"User-Agent"</span>: random.choice(user_agents)}
</code></pre>
<p>每次访问时随机选择一个头部，能有效减少被识别风险。</p>
<hr/>
<h3 data-id="heading-4">3. 添加延时与随机等待</h3>
<p>频繁访问网站最容易触发风控。
合理的做法是添加访问间隔，并随机化等待时间：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random

time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment"># 等待1~3秒</span>
</code></pre>
<p>这样能让访问节奏更像人类操作。</p>
<hr/>
<h2 data-id="heading-5">三、使用代理服务器（Proxy）</h2>
<p>当 IP 被封时，使用代理服务器可以切换出口 IP，从而继续访问。</p>
<p>代理服务器会代替你访问目标网站，然后将结果返回。
Python 中可以通过 <code>requests</code> 轻松使用代理。</p>
<hr/>
<h3 data-id="heading-6">1. 设置代理参数</h3>
<pre><code class="hljs language-python" lang="python">proxies = {
    <span class="hljs-string">"http"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"https"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
}

response = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxies, timeout=<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(response.text)
</code></pre>
<p>如果代理有效，返回的 IP 将与本机不同。</p>
<hr/>
<h3 data-id="heading-7">2. 使用代理池（Proxy Pool）</h3>
<p>手动设置代理不方便，可以使用 <strong>代理池</strong> 自动随机选取可用代理。</p>
<p>简单示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time

proxies_list = [
    <span class="hljs-string">"http://111.22.33.44:8080"</span>,
    <span class="hljs-string">"http://222.11.55.66:8888"</span>,
    <span class="hljs-string">"http://77.88.99.100:3128"</span>,
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_proxy</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    proxy = get_random_proxy()
    <span class="hljs-keyword">try</span>:
        res = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxy, timeout=<span class="hljs-number">5</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用代理 <span class="hljs-subst">{proxy[<span class="hljs-string">'http'</span>]}</span> -&gt; <span class="hljs-subst">{res.json()}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"代理失效："</span>, e)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 购买或搭建代理池</h3>
<p>免费代理常常不稳定，建议：</p>
<ul>
<li>使用付费代理服务（如芝麻代理、快代理等）。</li>
<li>自行搭建代理池服务，结合 Redis 存储和自动检测可用 IP。</li>
</ul>
<p>一个简单的代理池架构：</p>
<pre><code class="hljs">爬虫程序 → 请求代理池接口 → 返回可用代理 → 访问目标网站
代理池后台 → 定期检测代理可用性 → 清理无效IP
</code></pre>
<hr/>
<h2 data-id="heading-9">四、Cookie 与会话保持</h2>
<p>某些网站需要登录才能访问数据，这时需要处理 <strong>Cookie</strong>。
可以使用 <code>requests.Session()</code> 自动保持会话状态。</p>
<pre><code class="hljs language-python" lang="python">session = requests.Session()
login_url = <span class="hljs-string">"https://example.com/login"</span>
payload = {<span class="hljs-string">"username"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>: <span class="hljs-string">"pass"</span>}
session.post(login_url, data=payload)

<span class="hljs-comment"># 登录成功后继续访问页面</span>
resp = session.get(<span class="hljs-string">"https://example.com/user/profile"</span>)
<span class="hljs-built_in">print</span>(resp.text)
</code></pre>
<p><code>Session</code> 会自动保存登录后的 Cookie 信息，避免每次请求重新认证。</p>
<hr/>
<h2 data-id="heading-10">五、验证码与高级防爬</h2>
<p>有的网站会要求输入验证码或 JavaScript 加密验证请求。
常见应对思路包括：</p>
<ol>
<li><strong>人工辅助识别</strong>：遇到验证码暂停爬取，手动输入。</li>
<li><strong>OCR 识别验证码</strong>：通过 <code>pytesseract</code> 识别简单图片验证码。</li>
<li><strong>模拟浏览器行为</strong>：使用 <code>selenium</code> 或 <code>playwright</code> 执行网页中的 JS 逻辑。</li>
</ol>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver

driver = webdriver.Chrome()
driver.get(<span class="hljs-string">"https://example.com"</span>)
<span class="hljs-built_in">print</span>(driver.title)
driver.quit()
</code></pre>
<p>这种方式能绕过大部分基于 JS 渲染或验证的防爬机制。</p>
<hr/>
<h2 data-id="heading-11">六、异常与重试机制</h2>
<p>网络请求容易超时或失败，建议添加异常重试机制。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_request</span>(<span class="hljs-params">url, retries=<span class="hljs-number">3</span></span>):
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(retries):
        <span class="hljs-keyword">try</span>:
            res = requests.get(url, timeout=<span class="hljs-number">10</span>)
            <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span>:
                <span class="hljs-keyword">return</span> res.text
        <span class="hljs-keyword">except</span> requests.RequestException:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 次请求失败，重试中..."</span>)
            time.sleep(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">七、综合实战示例</h2>
<p>综合以上技巧，我们可以实现一个稳定、抗封的爬虫：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests, random, time

headers_list = [
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Chrome/122.0.0.0"</span>},
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Firefox/124.0"</span>},
]
proxies_list = [
    <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"http://222.111.55.66:8888"</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url</span>):
    headers = random.choice(headers_list)
    proxy = {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, headers=headers, proxies=proxy, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问成功："</span>, response.status_code, <span class="hljs-string">"IP："</span>, proxy)
        <span class="hljs-keyword">return</span> response.text
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问失败："</span>, e)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    html = fetch(<span class="hljs-string">"https://httpbin.org/ip"</span>)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))
</code></pre>
<hr/>
<h2 data-id="heading-13">八、总结</h2>

































<table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td><strong>请求伪装</strong></td><td>设置随机 User-Agent、Referer 等头信息</td></tr><tr><td><strong>请求间隔控制</strong></td><td>使用随机延时，模拟真实用户行为</td></tr><tr><td><strong>代理机制</strong></td><td>通过代理IP切换访问来源</td></tr><tr><td><strong>会话保持</strong></td><td>使用 Session 管理登录状态</td></tr><tr><td><strong>异常重试</strong></td><td>防止临时网络错误导致程序中断</td></tr><tr><td><strong>浏览器模拟</strong></td><td>处理验证码或动态渲染内容</td></tr></tbody></table>
<hr/>
<p>通过合理运用这些防封策略与代理机制，你的 Python 爬虫将更稳定、更高效、更接近真实用户访问行为，为后续数据采集与分析奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战 - Python实用工具与库 - 操作Excel：openpyxl / pandas]]></title>    <link>https://juejin.cn/post/7571332468898136091</link>    <guid>https://juejin.cn/post/7571332468898136091</guid>    <pubDate>2025-11-12T00:22:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571332468898136091" data-draft-id="7571351275976622131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战 - Python实用工具与库 - 操作Excel：openpyxl / pandas"/> <meta itemprop="keywords" content="后端,面试,Python"/> <meta itemprop="datePublished" content="2025-11-12T00:22:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战 - Python实用工具与库 - 操作Excel：openpyxl / pandas
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:22:29.000Z" title="Wed Nov 12 2025 00:22:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在日常数据处理工作中，Excel 是最常见的数据文件格式之一。无论是财务报表、销售统计还是实验数据，Python 都能通过强大的库快速读写和处理 Excel 文件。其中最常用的就是 <strong>openpyxl</strong> 和 <strong>pandas</strong>。</p>
</blockquote>
<p>本文将带你了解这两个库的核心用法，并通过实战示例展示如何高效操作 Excel 文件。</p>
<hr/>
<h3 data-id="heading-0">一、openpyxl：原生 Excel 文件操作库</h3>
<p><code>openpyxl</code> 是一个专门用于读写 <code>.xlsx</code> 文件的纯 Python 库。它支持单元格读写、样式设置、图表创建等高级功能，适合对 Excel 文件结构进行精细控制的场景。</p>
<h4 data-id="heading-1">1. 安装 openpyxl</h4>
<pre><code class="hljs language-bash" lang="bash">pip install openpyxl
</code></pre>
<h4 data-id="heading-2">2. 创建 Excel 文件</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openpyxl <span class="hljs-keyword">import</span> Workbook

<span class="hljs-comment"># 创建一个新的工作簿</span>
wb = Workbook()
ws = wb.active

<span class="hljs-comment"># 写入数据</span>
ws[<span class="hljs-string">'A1'</span>] = <span class="hljs-string">'姓名'</span>
ws[<span class="hljs-string">'B1'</span>] = <span class="hljs-string">'成绩'</span>
ws.append([<span class="hljs-string">'Alice'</span>, <span class="hljs-number">95</span>])
ws.append([<span class="hljs-string">'Bob'</span>, <span class="hljs-number">88</span>])

<span class="hljs-comment"># 保存文件</span>
wb.save(<span class="hljs-string">'成绩表.xlsx'</span>)
</code></pre>
<p>运行后，你将得到一个包含学生成绩的 Excel 文件。</p>
<h4 data-id="heading-3">3. 读取 Excel 文件</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openpyxl <span class="hljs-keyword">import</span> load_workbook

wb = load_workbook(<span class="hljs-string">'成绩表.xlsx'</span>)
ws = wb.active

<span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> ws.iter_rows(values_only=<span class="hljs-literal">True</span>):
    <span class="hljs-built_in">print</span>(row)
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">(<span class="hljs-string">'姓名'</span>, <span class="hljs-string">'成绩'</span>)
(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">95</span>)
(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">88</span>)
</code></pre>
<h4 data-id="heading-4">4. 修改单元格内容</h4>
<pre><code class="hljs language-python" lang="python">ws[<span class="hljs-string">'B2'</span>] = <span class="hljs-number">98</span>  <span class="hljs-comment"># 修改 Alice 的成绩</span>
wb.save(<span class="hljs-string">'成绩表_修改.xlsx'</span>)
</code></pre>
<h4 data-id="heading-5">5. 设置单元格样式（可选）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openpyxl.styles <span class="hljs-keyword">import</span> Font, Alignment

ws[<span class="hljs-string">'A1'</span>].font = Font(bold=<span class="hljs-literal">True</span>, color=<span class="hljs-string">"FF0000"</span>)
ws[<span class="hljs-string">'A1'</span>].alignment = Alignment(horizontal=<span class="hljs-string">'center'</span>)
wb.save(<span class="hljs-string">'成绩表_格式.xlsx'</span>)
</code></pre>
<hr/>
<h3 data-id="heading-6">二、pandas：高效的数据分析利器</h3>
<p>如果你更关注数据分析和批量处理，而不是 Excel 的格式细节，那么 <code>pandas</code> 是更高效的选择。
<code>pandas</code> 可以轻松地读写 Excel 文件并与 DataFrame 无缝结合。</p>
<h4 data-id="heading-7">1. 安装 pandas</h4>
<pre><code class="hljs language-bash" lang="bash">pip install pandas openpyxl
</code></pre>
<h4 data-id="heading-8">2. 从 Excel 读取数据</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd

df = pd.read_excel(<span class="hljs-string">'成绩表.xlsx'</span>)
<span class="hljs-built_in">print</span>(df)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">     姓名  成绩
0  Alice  95
1    Bob  88
</span></code></pre>
<h4 data-id="heading-9">3. 修改数据并写回 Excel</h4>
<pre><code class="hljs language-python" lang="python">df.loc[df[<span class="hljs-string">'姓名'</span>] == <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'成绩'</span>] = <span class="hljs-number">90</span>
df.to_excel(<span class="hljs-string">'成绩表_更新.xlsx'</span>, index=<span class="hljs-literal">False</span>)
</code></pre>
<h4 data-id="heading-10">4. 多表格（多 Sheet）操作</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> pd.ExcelWriter(<span class="hljs-string">'多表格.xlsx'</span>) <span class="hljs-keyword">as</span> writer:
    df.to_excel(writer, sheet_name=<span class="hljs-string">'一班'</span>, index=<span class="hljs-literal">False</span>)
    df.to_excel(writer, sheet_name=<span class="hljs-string">'二班'</span>, index=<span class="hljs-literal">False</span>)
</code></pre>
<h4 data-id="heading-11">5. 从多个 Excel 文件合并数据</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> glob

files = glob.glob(<span class="hljs-string">"data/*.xlsx"</span>)
all_data = pd.concat((pd.read_excel(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files))
all_data.to_excel(<span class="hljs-string">'合并结果.xlsx'</span>, index=<span class="hljs-literal">False</span>)
</code></pre>
<hr/>
<h3 data-id="heading-12">三、openpyxl 与 pandas 的比较</h3>






























<table><thead><tr><th>特性</th><th>openpyxl</th><th>pandas</th></tr></thead><tbody><tr><td>文件类型</td><td><code>.xlsx</code></td><td><code>.xls</code>, <code>.xlsx</code>, <code>.csv</code></td></tr><tr><td>操作粒度</td><td>单元格级别</td><td>表格/数据级别</td></tr><tr><td>适合场景</td><td>精细化格式控制、表格样式、美化</td><td>批量处理、分析计算、数据转换</td></tr><tr><td>是否支持样式</td><td>✅ 是</td><td>❌ 否（仅限数据）</td></tr></tbody></table>
<p><strong>结论：</strong></p>
<ul>
<li>如果你需要精细控制 Excel 外观（如模板、美化），推荐 <strong>openpyxl</strong>。</li>
<li>如果你主要关注数据计算和处理，推荐 <strong>pandas</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、实战案例：销售数据汇总</h3>
<p>假设你有多个销售 Excel 文件（如每月销售数据），需要快速汇总并输出总销售额。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> glob

<span class="hljs-comment"># 合并所有销售文件</span>
files = glob.glob(<span class="hljs-string">"sales/*.xlsx"</span>)
df = pd.concat([pd.read_excel(f) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files])

<span class="hljs-comment"># 汇总计算</span>
summary = df.groupby(<span class="hljs-string">'销售员'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>().reset_index()

<span class="hljs-comment"># 导出结果</span>
summary.to_excel(<span class="hljs-string">'销售汇总.xlsx'</span>, index=<span class="hljs-literal">False</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"汇总完成！"</span>)
</code></pre>
<p>这段代码可以帮你自动读取所有销售文件，统计每位销售员的总销售额，并生成一个新的汇总文件。</p>
<hr/>
<h3 data-id="heading-14">五、总结</h3>
<p>通过本文的学习，你应该掌握了以下内容：</p>
<ol>
<li>使用 <strong>openpyxl</strong> 创建、修改和美化 Excel 文件。</li>
<li>使用 <strong>pandas</strong> 快速读写、分析和汇总 Excel 数据。</li>
<li>理解两者的差异与适用场景。</li>
<li>掌握一个实战级的数据汇总案例。</li>
</ol>
<p>无论你是做数据分析、办公自动化，还是构建数据驱动应用，Excel 操作都是 Python 工具箱中不可或缺的一环。
下一步，你可以继续学习如何用 <strong>pandas</strong> + <strong>Matplotlib</strong> 实现数据可视化，为数据报告添加图形洞察。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[今天我去面试游戏开发，说我回答得不全面...]]></title>    <link>https://juejin.cn/post/7571360278970318857</link>    <guid>https://juejin.cn/post/7571360278970318857</guid>    <pubDate>2025-11-12T00:31:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571360278970318857" data-draft-id="7571272874847338548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="今天我去面试游戏开发，说我回答得不全面..."/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T00:31:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            今天我去面试游戏开发，说我回答得不全面...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:31:34.000Z" title="Wed Nov 12 2025 00:31:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>点击上方亿元程序员+关注和★星标</p>
<h2 data-id="heading-0">引言</h2>
<hr/>
<p><strong>面试官</strong>：“我们上一个项目就在包体大小上吃了亏，你能详细讲讲，有哪些手段可以优化游戏包体吗？”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30ffd41aa8da46ee9e78bb784f457c44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=0GRg1pf8%2Bb9GPi3Jg8kHKsf4lWI%3D" alt="表情包源于网络" loading="lazy"/></p>
<p><strong>我嘴角微微上扬</strong>，这题我会：</p>
<blockquote>
<p>**嗯…**包体优化很重要。</p>
<p><strong>我们</strong>主要是压缩图片，把小的图片合成一张大图，这样可以减少<strong>DrawCall</strong>。</p>
<p><strong>还有</strong>就是音频文件不能太大，要用<strong>MP3</strong>格式。</p>
<p><strong>另外</strong>，构建的时候可以把不需要的引擎模块去掉。</p>
<p><strong>差不多就这些吧</strong>。</p>
</blockquote>
<hr/>
<p><strong>哈喽大家好</strong>，感谢粉丝提供的上面的素材，他说整个面试过程可能就<strong>1-2</strong>分钟，最后被指出回答得不够全面。</p>
<p><strong>如果是我</strong>，我可能觉得没什么问题，但是，既然被指出了，我们还是一起来分析一下。</p>
<h2 data-id="heading-1">面试官为什么觉得“不够全面”？</h2>
<p><del>首先可能面试官心情不好。</del></p>
<p><del>其次呢可能已经招到人了，象征性地面试一下。</del></p>
<p><del>最后应该是缘分未到。</del></p>
<p><strong>上面都是我瞎说的。</strong></p>
<p><strong>我们</strong>一起来拆解一下这位粉丝的回答：</p>
<h3 data-id="heading-2">1.提到了资源优化，但非常笼统：</h3>
<ul>
<li>只说了“压缩图片”和“合图”。</li>
<li>只说了音频用MP3，但没有提到可以根据场景（长背景音乐/短音效）选择不同格式和参数。</li>
</ul>
<h3 data-id="heading-3">2.忽略了资源管理的核心问题：</h3>
<ul>
<li>完全没有提到 “清理未引用资源”。这是导致包体无故增大的最常见原因之一。开发过程中导入又弃用的资源，如果没从项目移除，会被打进包里。</li>
</ul>
<h3 data-id="heading-4">3.对构建配置的理解较浅：</h3>
<ul>
<li>提到了“移除引擎模块”，这是对的，但只是构建配置的其中一项。</li>
<li>完全没有提到 MD5 Cache、代码裁剪、压缩选项（如Zip压缩）等构建面板里的其他利器。</li>
</ul>
<h3 data-id="heading-5">4.缺乏层次感和系统性：</h3>
<ul>
<li>回答是点状的，想到什么说什么，没有形成一个从基础到高级、从开发时到构建时的逻辑链条。这反映出候选人对这个问题的认知是零散的，而非体系化的。</li>
</ul>
<h2 data-id="heading-6">那如何回答“全面又出色”？</h2>
<p><strong>我不要你觉得，我要我觉得！</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38a30f50ad1f41309fbe3ff612211e74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=dG0Jz%2BixuBB%2FHYdMzik1DBoU9AE%3D" alt="表情包源于网络" loading="lazy"/></p>
<p><strong>当然不是上面这样回答</strong>，一个高分的回答，应该像一篇结构清晰的小作文，有层次、有细节、有总结。</p>
<p><strong>可以这样组织语言：</strong></p>
<p><strong>首先</strong>：承上启下，结构化答案</p>
<p><strong>关于</strong>Cocos的包体优化，这是一个系统工程，通常会从 <strong>资源优化</strong>、<strong>代码与引擎优化</strong>、<strong>构建配置优化</strong>以及<strong>进阶策略</strong>这四个层面来综合考虑。</p>
<p><strong>然后</strong>：分点阐述，细节致胜</p>
<h3 data-id="heading-7">1. 资源优化（这是大头，占比最高）</h3>
<ul>
<li><strong>图片资源：</strong>
<ul>
<li><strong>合图：</strong> 主要目的并不是优化包体，使用合图通常只会则增大包体，仅有很极致的美术约束才会减小包体。</li>
<li><strong>清理冗余：</strong> 在构建前，检查未被使用但被误引用的资源。同时，利用“依赖列表”插件，查找并清理完全未被引用的资源。</li>
</ul>
</li>
<li><strong>音频资源：</strong>
<ul>
<li>根据用途区分处理：背景音乐这类长音频，采用高压缩比的<code>MP3</code>；短音效则考虑使用<code>WAV</code>或更低码率的<code>MP3</code>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aa545afac28459da0f338a7fd1b5e76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=Sd0jCABMnPRAbyqqQ1S0I20PlBE%3D" alt="表情包源于网络" loading="lazy"/></li>
</ul>
</li>
<li><strong>字体资源：</strong> 对于字体文件，动态裁剪，只保留项目用到的字；</li>
</ul>
<p><strong>2. 代码与引擎优化</strong></p>
<ul>
<li><strong>引擎裁剪：</strong> 在构建时，取消勾选项目根本用不到的引擎模块，比如用不到3D模块、视频播放、WebView等，就一定要把它们去掉，这是最直接的代码体积削减。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/863fc18de28f4194be6ea2ea05c262fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=ev3SpKO2l5TXcASqp%2BU3wLaA0qY%3D" alt="" loading="lazy"/></li>
<li><strong>代码本身</strong>：通过代码压缩或者混淆。就是将你项目里面复杂的命名压缩或者混淆成简短的命名，例如<code>let checkZiYuanIsBeRelease = true</code>压缩或者混淆成<code>let aaa = !0</code>。</li>
</ul>
<p><strong>3. 构建配置优化</strong></p>
<ul>
<li>
<p><strong>MD5 Cache：</strong> 通过这个可以给构建后的所有资源文件名将加上MD5信息，解决CDN资源缓存问题。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d9733940580448fb71a85ca54a56cf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=NW%2F%2F6JX2He1pwZTlRJz%2Fo4b8INM%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>压缩选项：</strong> 在构建Web Mobile时，可以开启Zip压缩，让整个Bundle压缩成为一个Zip文件，体积更小。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c357bfb4f5471897e6b2c03812905a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=rvX%2Fepyax8GcvkP0u2KKeYzQIoY%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>小游戏平台特殊处理：</strong>
对于微信小游戏等平台，可以使用分离引擎代码，缓存过后无需再次下载。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8df6b38aa8e049948f0ef9af864c0e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=D%2B0xdGBpEkP2zeaIXwVKloaZQLM%3D" alt="" loading="lazy"/>
引擎原生代码(wasm/asmjs)分包等等。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6159a282a2f5427497a0c57009ac5518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512293&amp;x-signature=%2BXFwGOuSIJHvOvvDkJxRm%2FAed1o%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<p><strong>4. 进阶与架构策略</strong></p>
<ul>
<li><strong>资源动态加载与热更新：</strong> 对于非首屏必须的资源，全部采用动态加载。同时，搭建热更新，让玩家只下载变更的资源，而不是所有资源。</li>
</ul>
<p><strong>最后</strong>：总结与展望</p>
<p><strong>根据</strong>不同过的项目选择不同的优化策略，但是可以遵循一个思路：先清理后压缩、先静态后动态、先通用后平台。</p>
<h2 data-id="heading-8">结语</h2>
<p><strong>面试</strong>不仅仅是知道“是什么”，更重要的是展现你如何系统性地思考问题和解决问题。</p>
<p><strong>但是</strong>面试有时候除了看看面试者的水平外，还有很多其他因素，小伙伴们知道都有哪些吗？</p>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐专栏：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3175880857546129410%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3175880857546129410#wechat_redirect" ref="nofollow noopener noreferrer">知识付费专栏</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26mid%3D2247487282%26idx%3D1%26sn%3De3cb8ab6f5c0d5f804d5c29e2e90b9ad%26chksm%3Dc00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54%26token%3D336413522%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NTY2MjIzMg==&amp;mid=2247487282&amp;idx=1&amp;sn=e3cb8ab6f5c0d5f804d5c29e2e90b9ad&amp;chksm=c00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54&amp;token=336413522&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3207702867494305797%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3207702867494305797#wechat_redirect" ref="nofollow noopener noreferrer">100个Cocos实例</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3073771187570999299%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3073771187570999299#wechat_redirect" ref="nofollow noopener noreferrer">8年主程手把手打造Cocos独立游戏开发框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3121583619634626562%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3121583619634626562#wechat_redirect" ref="nofollow noopener noreferrer">和8年游戏主程一起学习设计模式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3Faction%3Dgetalbum%26__biz%3DMzg5NTY2MjIzMg%3D%3D%26scene%3D1%26album_id%3D3038883468588089350%26count%3D3%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg5NTY2MjIzMg==&amp;scene=1&amp;album_id=3038883468588089350&amp;count=3#wechat_redirect" ref="nofollow noopener noreferrer">从零开始开发贪吃蛇小游戏到上线系列</a></p>
<p>点击下方灰色按钮+关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[稚晖君公司的最新工资和招人标准]]></title>    <link>https://juejin.cn/post/7571352754896535578</link>    <guid>https://juejin.cn/post/7571352754896535578</guid>    <pubDate>2025-11-12T00:45:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754896535578" data-draft-id="7571352754896502810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="稚晖君公司的最新工资和招人标准"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-12T00:45:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            稚晖君公司的最新工资和招人标准
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:45:43.000Z" title="Wed Nov 12 2025 00:45:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为具身智能领域的独角兽，智元机器人这两年在资本市场可谓是备受关注.</p>
<p>谁都没有想到，这家成立仅仅才两年的创业公司，如今已经成为了国内具身智能领域估值最高的公司之一。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a1445752bf4b22bae1105708bf8456~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=BOhfiqDbXH4%2FJsoGwg0mjCtsnvg%3D" alt="" loading="lazy"/></p>
<p>成立两年多，智元已经完成了多轮次融资。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23ab85ed82d140f99806b3db5ef49a1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=jGj3B5JX0KmPxAoZvz1xqCOiMn4%3D" alt="" loading="lazy"/></p>
<p>而当我们翻开智元机器人的股东名册，可是堪称科技创投界的“明星阵容”：既有高瓴创投、红杉中国、鼎晖投资等顶级风投；也包含比亚迪、上汽、北汽等车企巨头；除此之外还有像立讯精密等这样的产业龙头。</p>
<p>包括不久前腾讯和京东这两大互联网巨头在具身智能领域的投资纷纷也都选择了智元，这也充分证明这家公司在资本市场的独特地位。</p>
<p>众所周知，一个月前智元正式官宣合伙人团队，正式公布了「七人核心团队」名单，揽扩了包括技术研发、市场营销、业务开发和人力资源等<strong>各个领域的精英</strong>。</p>
<p>看到这里，<strong>相信大家也挺好奇</strong>，既然这个公司在资本市场如此出圈，外加又有各路大佬相继为之奔赴，那他们<strong>在业内的「薪资水平」和「招人标准」究竟又是怎样的呢</strong>？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76bc646554014d268ea648752f8754b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=XtQsCS0bCKNlpP6O0wecRHxaNzA%3D" alt="" loading="lazy"/></p>
<p>包括前段时间智元 2026 校招启动时，也有不少同学也关心这家公司的「招聘岗位」和「薪资待遇」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14d69b119a3347c3b72de20108cbe8aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=Ep5lFOQpuY8B6Ay4bswlUi4F4lo%3D" alt="智元2026校园招聘官方海报" loading="lazy"/></p>
<p>正好最近，我发现智元在某招聘平台上<strong>又更新了一大波最新招聘信息和岗位</strong>，而其中<strong>近八成</strong>都是技术研发岗。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70b59b5ada8468dbe7fb316fba848e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=joque0JrxwuBqHvgOUgRC5rQIcM%3D" alt="" loading="lazy"/></p>
<p>其工作地点主要 base 在北京、上海和深圳。</p>
<p>就技术研发岗而言，智元的招聘岗位基本覆盖了机器人研发的各个环节，而且<strong>核心岗全开放</strong>。</p>
<p>具体来看，热招岗位包括：</p>
<ul>
<li><strong>算法类</strong>：具身算法工程师、运动控制算法工程师、多模态大模型算法工程师等</li>
<li><strong>软件系统类</strong>：C++开发工程师、仿真系统开发工程师、嵌入式软件工程师等</li>
<li><strong>硬件与结构类</strong>：结构工程师、硬件工程师等</li>
<li><strong>测试类</strong>：软件测试工程师、硬件测试工程师、测试开发工程师等</li>
</ul>
<p>而非技术研发岗这一块，智元也提供了包括<strong>生产</strong>、<strong>运营</strong>、<strong>采购</strong>、<strong>市场</strong>、<strong>销服</strong>、<strong>策划</strong>以及其他诸多<strong>职能类</strong>、<strong>支持类</strong>岗位。</p>
<p>话不多说，<strong>先来看看岗位 JD 和招人标准。</strong></p>
<p>这里也集中梳理了一下，比如：</p>
<ul>
<li>
<p><strong>具身算法类岗位</strong>基本都是机器人操作（比如灵巧手之类）算法研究，要懂大模型，要懂强化学习，有仿真能力和工程能力那更是头等加分项。</p>
</li>
<li>
<p><strong>运控类岗位</strong>则需要懂机器人学、刚体运动学、刚体动力学，掌握常用的FK/IK方法基本是标配，RBDL、Pinocchio 等动力学库玩得溜的话那是最好不过的了。</p>
</li>
<li>
<p><strong>仿真开发类岗位</strong>则需要你懂机器人仿真平台，熟悉 ROS2 以及 Isaac Sim、MuJoCo 等具体的仿真引擎或平台。</p>
</li>
</ul>
<p><strong>可以说，想在智元做技术，熟练 Python/C++ 编程是标配，熟悉 ROS/ROS2 系统是标配，熟悉机器人仿真工具基本还是标配</strong>。</p>
<p>同时如果你还有 RoboMaster 等<strong>竞赛经验</strong>、机器人<strong>顶会</strong>（ICRA、RSS、IROS等）或<strong>期刊</strong>（T-RO、IJRR、T-FR、T-MECH等）的论文的话，那恭喜你，这可就太吃香了。</p>
<p>再具体一点来看，算法类我们以「<strong>具身算法工程师</strong>」岗位为例，大家可以详细直观感受一下他们的详细招聘标准和岗位要求。</p>
<blockquote>
<p><strong>职位描述</strong></p>
<ul>
<li>设计并实现VLA算法方案，以量产落地为导向，熟悉RT-1/2、pi0等主流多模态具身大模型优劣，改善调优</li>
<li>负责机器人具身操作任务的强化学习算法设计、开发和优化 优化Sim2Real的迁移技术，提高算法鲁棒性；跟踪前沿技术，进行强化学习算法的调研、性能对比和评估</li>
<li>研究多模态学习方法，结合视觉、触觉、力反馈提升机器人决策能力 包括VLM的训练与微调，实现模型实际场景的落地需求，多模态数据集的构建、清洗等，提升算法性能和决策质量等</li>
</ul>
</blockquote>
<blockquote>
<p><strong>职位要求</strong></p>
<ul>
<li>计算机科学、人工智能、机器人工程或相关领域硕士及以上学历</li>
<li>具备深度学习、计算机视觉和自然语言处理的扎实理论基础和实践经验</li>
<li>熟练掌握Python、C++等编程语言，有使用PyTorch、TensorFlow等深度学习框架的经验</li>
<li>熟悉VLM/MLLM模型的训练流程，了解常见的增量训练方法与微调方法</li>
<li>熟悉主流的多模态预训练基座，熟悉多模态对齐等关键技术</li>
<li>具备良好的团队合作精神和沟通能力，能够通过团队协作推进项目进展</li>
</ul>
</blockquote>
<p>可以看到，其对学历、特定垂直领域的编程能力和开发经验等都有不低的要求，如果有科研成果、论文或者竞赛加持，那更是加分项。</p>
<p>而类似于「<strong>C++软件开发工程师</strong>」这样的开发类岗位，其所要求的编码经验和工程能力也都是需要与<strong>机器人控制</strong>、<strong>通信协议</strong>、<strong>控制工程</strong>等强相关。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fea8dcef68f24317a7b47cec9bc35c0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=xhAPcxc2WLS4Lh2vSDn3Z%2Bu9mKA%3D" alt="" loading="lazy"/></p>
<p>除了常规技术招聘岗之外，智元还设有面向全球顶尖技术人才的<strong>优才计划</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e1b88d0b8242b7844864dd4b1f0f2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=xM5PPtKQ7lju5gvO08jiXrrAtzM%3D" alt="" loading="lazy"/></p>
<p>该计划主要面向公司内部的「<strong>智元 X-Lab</strong>」和「<strong>智元具身研究中心</strong>」两大核心技术研究中心，其中前者直接由 CTO 稚晖君直接管理，而后者则由具身大佬罗剑岚博士亲自牵头组建和带队。</p>
<p>大家如果想进智元做技术的话，能进这两大技术研究中心简直不要太香啊，两位领域内顶尖的 90 后技术大佬亲自带队培养，成长速度直接拉满！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8bee41a70d34b0480f1efbf986081ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=7aLvKiu4JfcN1bqLE8YoDiZ42Fo%3D" alt="" loading="lazy"/></p>
<p>聊完岗位 JD 和招人标准，接着我们<strong>再来看一眼薪资数据</strong>。</p>
<p>怎么说呢，放在垂直领域内来看还算比较具有吸引力，不是最顶尖，但是普遍都不低，大多都是 15 薪。</p>
<p>细看了一下，其中「<strong>算法岗</strong>」和「<strong>机器人研发核心岗</strong>」薪资段位基本是最高的，不少都能给到 （30K-60K）*15 薪的水平：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/393298556cba41a1bd6659e10b0f4475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=3QXJAON8sPT7BB03ffK8rNhPdAg%3D" alt="" loading="lazy"/></p>
<p>当然像「算法专家」、「算法架构师」、「算法总监」这类岗位薪资会给的更高，基本都是（50K-80K）*15 薪这样一个水平，这种高端岗位基本都是奔着年入百万去的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe42296d11d941d1a0eaf37560f75023~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=rxOqjW9h14JXk%2FzRqU%2B2Pr4yQqw%3D" alt="" loading="lazy"/></p>
<p>而类似「<strong>软件开发</strong>」、「<strong>C++开发</strong>」等开发岗较算法岗薪资相比基本是要低上一档，大致范围锚定在（20K-40K）*15 这样一个区间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177a6520a9c34e119c4f93ca8c643650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=YdOEiJgfOd5DO9ftPxXjuj8snf0%3D" alt="" loading="lazy"/></p>
<p>大家觉得这个数据怎么样？</p>
<p>除此之外，智元官网还发布了很多与实习相关的岗位招聘，大模型实习、具身算法实习、嵌入式实习、硬件实习等等都有。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bae291d12f64fdd96e769e194faa235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513142&amp;x-signature=ovpr1jwnVf9VqWWVP0w00%2FVDLVo%3D" alt="" loading="lazy"/></p>
<p>实习生实习待遇这块基本锚定在本科 200-300元/天，硕士 300-400元/天，博士 500-600元/天，表现优秀的话有项目奖金，此外还提供一日三餐、加班餐补，部分城市有提供实习宿舍或住房补贴等。</p>
<p>总体来看，作为一家机器人初创公司，这个薪资水平放到行业来看算不上最顶尖，但也还可以，同时从这些招聘信息中也能折射出这家年轻企业对技术创新和卓越人才的渴求。</p>
<p>对于有志于投身机器人行业的专业人士和年轻学子来说，智元的确是一个值得关注的平台。</p>
<p>在当今快速发展的人工智能领域，具身智能机器人已经成为最炙手可热的赛道之一，作为科技密集型行业，并且目前处于上行期，后面潜力可期，感兴趣的小伙伴果断可以试试。</p>
<p>好了，那以上就是今天的内容分享了，希望能对大家有所帮助，我们下篇见。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[来了解一下，为什么你的 Flutter WebView 在 iOS 26 上有点击问题？]]></title>    <link>https://juejin.cn/post/7571306072423448618</link>    <guid>https://juejin.cn/post/7571306072423448618</guid>    <pubDate>2025-11-12T00:48:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072423448618" data-draft-id="7571348736153174052" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="来了解一下，为什么你的 Flutter WebView 在 iOS 26 上有点击问题？"/> <meta itemprop="keywords" content="Android,Flutter,前端"/> <meta itemprop="datePublished" content="2025-11-12T00:48:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            来了解一下，为什么你的 Flutter WebView 在 iOS 26 上有点击问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:48:32.000Z" title="Wed Nov 12 2025 00:48:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前段时间 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F175099" target="_blank" title="https://github.com/flutter/flutter/issues/175099" ref="nofollow noopener noreferrer">#175099</a> 又提出了一个  iOS 26  的问题，大概就是 <code>webview_flutter</code> 的点击事件又出现了“点不动”或“点了不触发” 的情况，源头还是 <strong>WKWebView（WebKit）内部的手势识别器与 Flutter 在 Engine 里用于“阻止/延迟”手势的 recognizer 之间的冲突</strong>。</p>
<p>针对和这个问题，去年 iOS 18.2  beta 里有出现类似情况，而那时候在 Engine 里，可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fengine%2Fpull%2F56804%2Ffiles" target="_blank" title="https://github.com/flutter/engine/pull/56804/files" ref="nofollow noopener noreferrer">#56804</a> 这个 PR，临时移除并再添加 <code>delayingRecognizer</code> 的实现来暂时绕过问题，<strong>主要是通过刷新 WebKit 的内部状态从而临时修复</strong>，但这个绕过在 iOS 26 上造成了另一个严重回归（overlay 的手势阻止失效、触摸穿透底下的 WebView），因此在最近被针对 iOS 26 的条件下回退（revert）了该提交。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f6feca614be4cceb0fb9faa35caa7d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=%2Bswyzp5RL6k6T5wFGilvuDrFs0I%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>另外也是因为 Flutter 团队发现这是 Apple / WebKit 的 bug ，所以也已经同步上报请求和 Apple 协作。</p>
</blockquote>
<p>问题最开始出现在 iOS 18.2 beta 版本上，当页面上先触发了某些 Flutter widget（或者 overlay，比如 context menu / Drawer）后，<strong>WKWebView 内的点击（链接、按钮）不再响应</strong>（可高亮，但不会激活），需要重新加载 WebView 才恢复。</p>
<p>而具体原因在于，Flutter 在 iOS 的 PlatformView（例如承载 WKWebView 的视图）上实现了一套“手势拦截/延迟”机制：在需要时会把一个 <code>FlutterDelayingGestureRecognizer</code>（<code>delayingRecognizer</code> ）切到某些状态（<code>possible</code>, <code>ended</code>, <code>failed</code> 等）来告诉 UIKit 或者其他 recognizers 是否应该阻止/允许手势传递。</p>
<p>而 UIKit 的手势识别器有自己的状态机（<code>possible</code> → <code>recognized/failed</code> / <code>ended</code> ），不同 recognizer 相互之间会有阻塞/依赖关系：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecab37a2a3a94e3185c643faca291935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=Hgu%2FfYJ3tDGsK7jMeYJp3P%2FXUWw%3D" alt="https://developer.apple.com/documentation/uikit/about-the-gesture-recognizer-state-machine" loading="lazy"/></p>
<p>这里需要简单介绍一个背景知识：<strong>Flutter + iOS 平台视图的手势处理机制</strong>，在 iOS 上当你把一个原生控件（比如 WKWebView）嵌进 Flutter 时，实际上会经历以下层级：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">[FlutterView]               ← 整个 Flutter 渲染层（Dart UI 层）
   ├─ Flutter widgets
   │     ↑
   │     │ 手势事件由 Flutter framework（Dart）处理
   │
   └─ PlatformView (e.g. <span class="hljs-built_in">WKWebView</span>)
         ↑
         │ 手势事件由 <span class="hljs-built_in">UIKit</span> / WebKit 内部 recognizer 处理
</code></pre>
<p>Flutter 和 UIKit 都各自有手势识别系统（GestureRecognizer），为了防止互相抢事件，Flutter engine 在 iOS 上加入了一个“<strong>delaying gesture recognizer</strong>”（延迟识别器）：</p>
<blockquote>
<p>它的作用是：当 Flutter 框架检测到某个 widget 想“阻止”事件时（比如 <code>GestureDetector</code> 或 overlay 遮罩），Flutter 会让这个 <code>delayingRecognizer</code>  阻止 UIKit 里的 recognizer（例如 WKWebView 的点击识别器）响应。</p>
</blockquote>
<p>这个系统在 Flutter → UIKit 手势交界处非常敏感，而问题就出现在：<strong>WebKit（WKWebView）内部的某些 recognizer 会“缓存”或持有对  <code>delayingRecognizer</code>  的“旧状态”</strong>，导致当 Flutter 在运行时切换 <code>delayingRecognizer</code>  状态（例如 blockGesture）时，WebKit 的部分识别器获取到了过时状态，从而无法触发正确的“激活 click”逻辑，例如：</p>
<blockquote>
<p>它们可能只看到 <code>failed</code>/<code>possible</code> 的不一致组合，导致只高亮不执行动作。</p>
</blockquote>
<p>针对这个问题，在 iOS 18.2 时，Flutter 团队进行了多种尝试，比如 toggle <code>enabled</code>、插入 dummy recognizer、异步 dispatch、重建 recognizer 实例等，最后发现<strong>移除并重新添加同一个 <code>delayingRecognizer</code>  实例</strong> 会触发 UIKit 重新刷新相关 recognizers 的关联，从而让 WebKit 的内部识别器看到“最新”状态并恢复点击功能：</p>
<blockquote>
<p>在 blockGesture 的处理流程里把  <code>delayingRecognizer</code>  <strong>移除后再添加回去</strong>，以强制 UIKit/WebKit 刷新识别器关系，这个功能应该是在 3.29 的版本里发布了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49dcd06d72024bc7bd4506f482b6f8db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=ry8WmjTkiUzE948oA6mOnhgBX40%3D" alt="" loading="lazy"/></p>
</blockquote>
<p>不过在 iOS 26 上，这个“移除再添加”的操作带来了新的严重问题：<strong>Flutter 的手势阻塞系统在某些场景（比如 Drawer/overlay）里完全失效，触摸会穿透到下面的 WebView</strong>，这比“点不动”更糟，因为会造成错点与功能错乱。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8029c396e4d84899a1ae6fbe828fe012~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=ppgexoEpirehhIZo6%2Ft3n2w2hnA%3D" alt="" loading="lazy"/></p>
<p>所以，Flutter 在针对 <strong>iOS 26（<code>@available(iOS 26.0, \*)</code>）上不再执行“移除再添加 <code>delayingRecognizer</code>  ” 的绕过逻辑</strong>，但回退会让之前通过绕过解决的“WebView 点不动”问题在 iOS 26 上再次出现。</p>
<blockquote>
<p>很明显这是一个 iOS 18.2 时 WKWebView 自身就存在的 bug，并且因为系统升级修改，WebKit 内部 recognizer 缓存行为在新版 iOS 上变化，所以如果要完成修复问题，还是需要和 Apple 一起修复处理。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bae374d84a74f96955847ed2ddd9fff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=inBSX8X19Dxhz6C%2B8nT3Ba5cESE%3D" alt="" loading="lazy"/></p>
<p>所以问题主要出现的场景在于：“<strong>必须在 WebView 上出现过 overlay 或类似触摸阻止的 widget” 才会触发 Bug</strong> ，比如：</p>
<ul>
<li>打开了一个半透明的 ModalBarrier</li>
<li>弹出了一个 Drawer</li>
<li>显示了一个半透明的 PopupMenu</li>
<li>使用了 <code>showDialog()</code></li>
<li>甚至某些动画（Hero ）在内部也会临时创建 overlay 层</li>
</ul>
<p>这些操作的里根本的诱饵就是：“要阻止触摸传递到底层 platform view” ，于是 engine 调用 <code>delaying_recognizer.blockGesture(true)</code>；，WKWebView 的内部 recognizer 因此暂停触发，然后 overlay 消失后，engine 再执行 <code>blockGesture(false)</code> ，但是 UIKit 没有恢复 WKWebView recognizer 的响应，从而导致问题。</p>
<blockquote>
<p>而在 iOS18.2 可以通过 remove/add 的方式来重置刷新状态，但是在 iOS 26 上 Recognizer 重新添加后，看起来系统会重新建立默认的依赖关系，也就是当 Flutter 把 delaying recognizer 移除再添加时，UIKit 不仅刷新了它的依赖， 还重置了某些全局 recognizer 的 <code>delaysTouchesBegan</code> / <code>requiresFailureOf</code> 配置，这些配置正是 Flutter engine 用来防止 overlay 点击穿透的相关逻辑。</p>
</blockquote>
<p><strong>而针对这个问题，目前社区层面的临时解决方法是通过 <code>pointer_interceptor </code> 来规避 overlay 与 WebView 的事件竞争</strong>，核心是在 iOS 26 上的 WebView ，只要在它上方有视图并点击就会导致它停止接受点击，而在此之前 WebView  一直可以正常工作，所以使用 PointerInterceptor 可以防止在与 WebView 上方的视图交互后中断 WebView，例如：</p>
<pre><code class="hljs language-dart" lang="dart">  <span class="hljs-comment">// to know anytime if we are on top of navigation stack</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> _isTopOfNavigationStack =&gt; ModalRoute.of(context)?.isCurrent ?? <span class="hljs-keyword">false</span>;

  <span class="hljs-comment">// Wrapper for the webview</span>
  Widget buildWebviewWithIOSWorkaround(BuildContext context) {
    <span class="hljs-keyword">return</span> Stack(
      children: [
        buildWebView(context),
        <span class="hljs-keyword">if</span> (Platform.isIOS)
          Positioned.fill(
            child: PointerInterceptor(
              intercepting: !_isTopOfNavigationStack, <span class="hljs-comment">// the webview is not on top -&gt; inhib click</span>
              debug: <span class="hljs-keyword">false</span>,
              child: <span class="hljs-keyword">const</span> SizedBox.expand()
            ),
          )
      ],
    );
  }
</code></pre>
<p>另外，在和 Apple 进行问题推动修复的同时，Flutter 也在需求一些外部解决思路，例如通过全新的 <code>HitTest</code> 来规避问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a43281ac96a408f9691d60eca07cdf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=g7qiy%2Bf8CEIaGn7hu6qu5CF%2BLPM%3D" alt="" loading="lazy"/></p>
<p>根据   <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176597" target="_blank" title="https://github.com/flutter/flutter/pull/176597" ref="nofollow noopener noreferrer">#176597</a>  ，主要基于假设大多数用例平台视图只有一个重叠，如果触摸位置在 Flutter  Widget 和平台视图之间的“重叠”范围内，Flutter 会阻止平台视图上的所有 UIGestureRecognizer，具体为：</p>
<ul>
<li>定义了一个新的拦截策略枚举值：<code>FlutterPlatformViewGestureRecognizersBlockingPolicyHitTestByOverlay</code>（ “通过 overlay 层的 hitTest 来阻止手势”）</li>
<li>在 platform view 的 touch / hitTest 逻辑里加入判断：如果某点落在 overlay 区域，就让 <code>hitTest:</code> 返回拦截自己（<code>self</code>），而不是默认走到底层 WebView，也就是说 <strong>在 Flutter 层“用 hitTest”来屏蔽底层点击</strong></li>
<li>在 <code>blockGesture</code> 方法里，对于这种 overlay-hitTest 类型的策略，PR 把原来 <code>blockGesture</code> 的逻辑改为 “no-op”（什么都不做），因为在这个策略下，“拦截”是在 hitTest 层做了，不需要再在 delaying recognizer 层去干预</li>
<li>在 controller 更新 overlay 层（<code>bringLayersIntoView:</code>）时，把 overlay 视图引用记录下来，并赋给内部的 intercepting view（<code>interceptor.overlays = overlays;</code>）这样拦截逻辑有 overlay 区域信息可用</li>
</ul>
<p>总的来说，<strong>改动提供了一种 “hitTest 层面的 overlay 拦截” 策略，不依赖 delaying recognizer 的状态切换，以避免手势状态切换带来的复杂性</strong>：</p>
<blockquote>
<p>但是，如果多个重叠被合并到一个触摸阻挡区域时，blocking area 将是一个包含所有重叠的区域。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c6a8fa7d1c144d6b6a4b0da011d860d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=HXKEciN%2Fg5%2B0dRoFpjYMsmIeHMs%3D" alt="" loading="lazy"/></p>
<p>不过维护人员在进行到一半的时候发现，完整解决方案也许并不难推进（<em>我感觉是他的一厢情愿居多</em>），所以决定关闭临时的 MVP 方案：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23ee7c5c4a1645e58fe19393929a8521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=W0UyNj%2FMTs%2BDaqNwt4IXgAEDJt4%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7a849e4aa7d456fb833df1f95f82c83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513312&amp;x-signature=zZzoRxEbg1Zwku5nF4%2BZc03iuww%3D" alt="" loading="lazy"/></p>
<p><strong>完整的解决方案，是依赖于 FFI 从 Flutter 的手势竞技场同步查询来做出决定，不过这又是属于另外一个重大改动了</strong>。</p>
<p>所以目前推进流程进入到了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F177859" target="_blank" title="https://github.com/flutter/flutter/pull/177859" ref="nofollow noopener noreferrer">#177859</a> ，PR 将 <strong>不再通过“延迟（delaying）手势识别器”来阻塞 platform view 的手势</strong>，改成在 iOS 端对触点做 <strong>同步 hit-test（利用 FFI 从 framework 查询是否应接受/阻止该手势）</strong>，解决了 web_view / admob 等平台视图不可点按的问题，并新增一个可选的 blocking policy（<code>FlutterPlatformViewGestureRecognizersBlockingPolicyHitTest</code>）</p>
<p>具体调整有：</p>
<ul>
<li>
<p><strong>从“延迟识别器（delaying recognizer）”切换到“hit test”决策</strong></p>
<ul>
<li>以往的方案是把识别器设置成 delaying 类型，然后用延迟决策来阻塞/接受手势，本次 PR 直接改成直接做 hit test 判断是否应阻止该手势（在触点处是否落在应该被 platform view 拦截的区域）</li>
</ul>
</li>
<li>
<p><strong>FFI 同步调用框架（framework）以避免死锁</strong></p>
<ul>
<li>直接让 embedder 在主线程等待 framework 的异步回应会导致主线程互相等待（deadlock），利用 FFI 在 native 层<strong>同步调用</strong>框架中的函数（_platformViewShouldAcceptGesture<code>/</code>platformViewShouldAcceptGesture`）来获得是否接受手势的结果，从而避免线程死锁问题</li>
</ul>
</li>
<li>
<p><strong>新增/修改 policy 与 API 辅助</strong></p>
<ul>
<li>通过 <code>FlutterPlatformViewGestureRecognizersBlockingPolicyHitTest</code>，逐步采纳并降低全局回归风险（也就是说不把旧策略直接替换掉，而是增加新的策略供插件或内部使用）</li>
</ul>
</li>
</ul>
<p>PR 还涉及 engine 的 UI 层（ <code>engine/src/.../hooks.dart</code>、<code>platform_configuration.cc</code> 等）以及 iOS 平台 view / embedder 相关代码， 这些改动把 hit-test 的入口函数和 FFI 绑定、以及 platform view 手势决策路径连接起来 。</p>
<p>所以，这会是一个涉及很多地方的底层调整，也算是一个高风险的修改，特别是 iOS 平台 view（platform view）手势处理路径（尤其 web_view、admob、任何嵌入 UIView 的插件），目前建议事是需要插件作者（特别是官方 1P 插件）切换使用新 policy。</p>
<p>当然，PR 还需要等等，目前除此之外，我们也可以做的规避问题还有：</p>
<ul>
<li><strong>避免在 WebView 上方显示需要拦截手势的复杂 overlay（尽量减少交互型 overlay）</strong>，如果能避免覆盖 WebView，问题就不会触发</li>
<li><strong>在 overlay 关闭后重载或重建 WebView（重建 controller / reload）</strong>，不过这种造成的闪烁其实并不友好</li>
</ul>
<p>所以目前的方向，应该是先完成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176597" target="_blank" title="https://github.com/flutter/flutter/pull/176597" ref="nofollow noopener noreferrer">#176597</a> 的 PR，之后再实现 FFI 从框架中进行查询的完整解决方案，也就是从目前来说：</p>
<ul>
<li>对于 iOS 18.2 上的因为重叠控件导致  WebView 点击问题，需要 3.29 以及以上版本解决</li>
<li>对于 iOS 26 上的因为重叠控件导致  WebView 点击问题
<ul>
<li>3.35.4 之前，会出现触摸穿透问题</li>
<li>3.35.4 之后，由于 cp revert，会恢复成点击无效问题</li>
<li>以上两个问题可以使用  <code>pointer_interceptor </code> 来尝试规避</li>
</ul>
</li>
<li>等待官方内置 HitTest 和 FFI 解决方案发布</li>
</ul>
<p>只能说，之前发布的线程合并为 FFI 提供了支持的基础，也为这次调整的方向提供了一种全新的思路，只是这个修改需要更加谨慎。</p>
<h2 data-id="heading-0">参考链接</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176597" target="_blank" title="https://github.com/flutter/flutter/pull/176597" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F175099" target="_blank" title="https://github.com/flutter/flutter/issues/175099" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F177859" target="_blank" title="https://github.com/flutter/flutter/pull/177859" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[H5开发避坑！解决Safari浏览器的video会覆盖z-index:1的绝对定位元素]]></title>    <link>https://juejin.cn/post/7571299394346156074</link>    <guid>https://juejin.cn/post/7571299394346156074</guid>    <pubDate>2025-11-12T00:34:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394346156074" data-draft-id="7569946369989886015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="H5开发避坑！解决Safari浏览器的video会覆盖z-index:1的绝对定位元素"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T00:34:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            H5开发避坑！解决Safari浏览器的video会覆盖z-index:1的绝对定位元素
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:34:14.000Z" title="Wed Nov 12 2025 00:34:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p><code>H5</code>开发中，跨浏览器兼容性问题总数让人脑壳疼。最近我在开发视频相关页面时，就遇到了一个典型的浏览器兼容问题：相同的层叠布局代码，在<code>Chrome</code>浏览器中表现正常，而在<code>Safari</code>浏览器（包括macOS和iOS版本）中，本该显示在视频上方的绝对定位图标却离奇消失，我初步估计是被<code>video</code>元素完全覆盖了。下面我将从问题复现、根源剖析到解决，一步一步拆解思路，希望可以帮到有同样遭遇的开发者。</p>
<h2 data-id="heading-0">1. 问题场景复现</h2>
<p>场景布局很简单：外层一个<code>relative</code>定位的<code>div</code>容器，内部包含<code>video</code>视频元素和一个<code>absolute</code>定位的关闭按钮图标，图标设置<code>z-index:1;top: 8px;right: 8px;</code>置于视频右上角，如下：</p>
<p><strong>HTML：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-wrapper"</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">video</span>
		<span class="hljs-attr">autoplay</span>
		<span class="hljs-attr">loop</span>
		<span class="hljs-attr">muted</span>
		<span class="hljs-attr">playsinline</span>
		<span class="hljs-attr">webkit-playsinline</span>
		<span class="hljs-attr">disablepictureinpicture</span>
		<span class="hljs-attr">disable-remote-playback</span>
		<span class="hljs-attr">poster</span>
		<span class="hljs-attr">controlsList</span>=<span class="hljs-string">"nodownload nofullscreen noremoteplayback noplaybackrate"</span>
		<span class="hljs-attr">class</span>=<span class="hljs-string">"video-dom"</span>
	&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./water-drop.mp4"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>您的浏览器不支持 video 标签<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge"</span>&gt;</span>关闭<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>CSS：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.main-wrapper</span> {
	<span class="hljs-attribute">position</span>: relative;
	<span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
<span class="hljs-selector-class">.video-dom</span> {
	<span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
	<span class="hljs-attribute">object-fit</span>: contain;
}
<span class="hljs-selector-class">.badge</span> {
	<span class="hljs-attribute">position</span>: absolute;
	<span class="hljs-attribute">top</span>: <span class="hljs-number">8px</span>;
	<span class="hljs-attribute">right</span>: <span class="hljs-number">8px</span>;
	<span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
	<span class="hljs-attribute">width</span>: fit-content;
	<span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
	<span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);
	<span class="hljs-attribute">padding</span>: <span class="hljs-number">0px</span> <span class="hljs-number">8px</span>;
	<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
	<span class="hljs-attribute">color</span>: white;
	<span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
	<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
	<span class="hljs-attribute">line-height</span>: <span class="hljs-number">40px</span>;
}
</code></pre>
<p>而两大浏览器表现如下：</p>
<ul>
<li>
<p><strong>Chrome浏览器</strong>：表现正常，关闭图标稳定显示在视频右上角，层级正确。</p>
</li>
<li>
<p><strong>Safari浏览器</strong>：图标完全消失，通过开发者工具检查发现图标确实存在于DOM中，但被video元素完全覆盖，z-index:1未生效。</p>
</li>
</ul>
<h2 data-id="heading-1">2. 根源剖析</h2>
<p>要解决问题，必须先搞懂“为什么”。表面上看是<code>z-index</code>失效，但本质是<code>Safari</code>与<code>Chrome</code>对<strong>层叠上下文</strong>和<strong>特殊元素渲染机制</strong>的处理存在差异，核心原因有两点。</p>
<h3 data-id="heading-2">2.1. 层叠上下文的隐性规则</h3>
<p>根据CSS层叠规范，<code>z-index</code>仅在<strong>已建立的层叠上下文</strong>中生效，而层叠上下文的建立有明确条件（如position为relative/absolute且z-index不为auto、flex容器的子元素等）。在我们的初始代码中：</p>
<ul>
<li>
<p>外层.main-wrapper仅设置<code>position:relative</code>，未设置<code>z-index</code>，因此<strong>未建立独立的层叠上下文</strong>，其内部元素的层叠关系受全局上下文影响。</p>
</li>
<li>
<p>Chrome等浏览器中，未设置position的video元素属于<strong>普通流元素</strong>，层叠层级低于<code>absolute</code>定位的元素（即使z-index:1）；但<code>Safari</code>中，<code>video</code>元素被归为<strong>特殊渲染层</strong>，默认会创建一个隐性的层叠上下文，且层级高于普通的<code>absolute</code>元素。</p>
</li>
</ul>
<h3 data-id="heading-3">2.2. Safari对video元素的特殊渲染优化</h3>
<p><code>Safari</code>为了提升视频播放的流畅度（尤其是硬件加速播放），对<code>video</code>元素采用了特殊的渲染策略：将<code>video</code>元素独立渲染在一个<strong>硬件加速层</strong>中，这个层的优先级默认高于普通的DOM元素层。即使开发者没有为<code>video</code>设置任何<code>position和z-index</code>，<code>Safari</code>也会让其<strong>漂浮</strong>在普通DOM层之上，导致普通<code>absolute</code>元素无法覆盖。</p>
<p>关键结论：Safari中，video元素默认处于“高优先级渲染层”，而未建立独立层叠上下文的absolute元素，即使设置z-index，也无法突破这个层级限制。</p>
<h2 data-id="heading-4">3. 解决方案</h2>
<p>基于上述分析，解决思路的核心是：<strong>通过显式建立层叠上下文，让图标和video元素处于同一“层级坐标系”中，从而使z-index生效</strong>。我测试了3种方案，从简单到复杂，均能解决问题，大家可根据场景选择。</p>
<h3 data-id="heading-5">3.1 方案一：给外层容器加z-index:0</h3>
<p>这是最符合CSS规范、兼容性最好的方案，仅需修改一行代码。核心逻辑是：给外层.main-wrapper仅设置设置<code>z-index:0</code>，强制其建立独立的层叠上下文，此时内部的video和图标都处于这个上下文内，z-index规则即可正常生效。</p>
<p><strong>修改后的CSS代码</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.main-wrapper</span> {
	<span class="hljs-attribute">position</span>: relative;
	<span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
	<span class="hljs-attribute">z-index</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 关键修改：建立独立层叠上下文 */</span>
}
</code></pre>
<p><strong>原理验证：</strong></p>
<p>设置<code>z-index:0</code>后，.main-wrapper成为层叠上下文容器，内部元素的层叠关系仅相对于.main-wrapper生效：</p>
<ul>
<li>
<p>video元素未设置<code>position</code>和<code>z-index</code>，在容器内属于<strong>普通流层</strong>，层级默认较低。</p>
</li>
<li>
<p>.badge设置<code>absolute</code>和<code>z-index:1</code>，在容器内层级高于<code>video</code>，自然显示在上方。</p>
</li>
</ul>
<p>此方案的优势：无副作用、代码改动最小、兼容所有现代浏览器（包括Safari 10+、Chrome、Firefox等）。</p>
<h3 data-id="heading-6">3.2. 方案二：给video加relative和z-index:-1</h3>
<p>如果因业务限制无法修改外层容器样式，可通过调整<code>video</code>元素的层级实现。核心逻辑是：给<code>video</code>设置<code>position:relative</code>（使其能响应z-index），并设置<code>z-index:-1</code>，将其层级降至图标下方。</p>
<p><strong>修改后的CSS代码</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.video-dom</span> {
	<span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 关键：让z-index生效 */</span>
	<span class="hljs-attribute">z-index</span>: -<span class="hljs-number">1</span>; <span class="hljs-comment">/* 将视频层级降至最低 */</span>
	<span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
	<span class="hljs-attribute">object-fit</span>: contain;
}
</code></pre>
<p>此方案虽能生效，但需注意两个点：</p>
<ul>
<li>
<p><code>z-index:-1</code>会让<code>video</code>元素层级低于容器的背景（如果容器有背景色），需确保容器无背景或背景透明。</p>
</li>
<li>
<p>部分老旧设备的<code>Safari</code>版本（如Safari 9及以下）对负<code>z-index</code>的支持有瑕疵，需谨慎使用。</p>
</li>
</ul>
<h3 data-id="heading-7">3.3. 方案三：用transform触发3D渲染</h3>
<p>如果前两种方案因特殊场景失效（如嵌套了多个层叠上下文），可采用<strong>触发3D渲染</strong>的技巧。核心逻辑是：给图标元素添加<code>transform: translateZ(1px)</code>，强制浏览器为其创建一个3D渲染层，提升层级优先级。</p>
<p><strong>修改后的CSS代码</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.video-dom</span> {
	<span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
	<span class="hljs-attribute">object-fit</span>: contain;
	<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(-<span class="hljs-number">1px</span>); <span class="hljs-comment">/* 关键：触发3D渲染层 */</span>
}
<span class="hljs-selector-class">.badge</span> {
	<span class="hljs-attribute">position</span>: absolute;
	<span class="hljs-attribute">top</span>: <span class="hljs-number">8px</span>;
	<span class="hljs-attribute">right</span>: <span class="hljs-number">8px</span>;
	<span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
	<span class="hljs-attribute">width</span>: fit-content;
	<span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
	<span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);
	<span class="hljs-attribute">padding</span>: <span class="hljs-number">0px</span> <span class="hljs-number">8px</span>;
	<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
	<span class="hljs-attribute">color</span>: white;
	<span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
	<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
	<span class="hljs-attribute">line-height</span>: <span class="hljs-number">40px</span>;
	<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">1px</span>); <span class="hljs-comment">/* 关键：触发3D渲染层 */</span>
}
</code></pre>
<p>原理说明：</p>
<p>根据CSS规范，<code>transform</code>属性（非none值）会触发元素建立独立的层叠上下文，且3D渲染层的优先级高于普通层。此方案属于<strong>兼容性hack</strong>，适用于前两种方案无法使用的极端场景。</p>
<h2 data-id="heading-8">4. 总结与拓展</h2>
<p>解决完具体问题后，我们需要提炼通用规律，避免未来遇到类似的跨浏览器层叠问题：</p>
<ol>
<li>
<p><strong>层叠上下文是z-index生效的前提</strong>：当元素层级异常时，先通过开发者工具检查其父容器是否建立了独立的层叠上下文。</p>
</li>
<li>
<p><strong>Safari对特殊元素有特殊处理</strong>：除了<code>video</code>，<code>canvas</code>、<code>iframe</code>等元素在<code>Safari</code>中也可能被赋予较高的默认渲染层级，需提前做好兼容预案。</p>
</li>
<li>
<p><strong>优先采用规范方案</strong>：方案一符合CSS标准，无副作用，应作为首选；方案二和三作为备选兜底。</p>
</li>
</ol>
<h3 data-id="heading-9">4.1. 调试技巧</h3>
<p>遇到层叠问题时，可通过以下工具快速定位：</p>
<ul>
<li>
<p><strong>Chrome/Safari开发者工具</strong>：打开“Elements”面板，选中元素后查看“Computed”中的z-index和层叠上下文信息；“Layers”面板可直观看到元素的层级堆叠。</p>
</li>
<li>
<p><strong>临时调试</strong>：给可疑元素添加<code>background: red</code>等醒目样式，快速判断元素是否存在且位置正确，排除<strong>元素不存在</strong>或<strong>定位错误</strong>等非层叠问题的干扰。</p>
</li>
</ul>
<p>跨浏览器兼容问题的本质，往往是不同浏览器对规范的解读或优化策略不同。遇到问题时，先复现、再剖析根源、最后针对性落地方案，才能做到“有理有据，一步一营”，而不是盲目试错。希望本文的思路能为大家提供参考，让后续的H5开发少踩坑、更高效。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 跨平台开发中的权衡]]></title>    <link>https://juejin.cn/post/7571316028321628195</link>    <guid>https://juejin.cn/post/7571316028321628195</guid>    <pubDate>2025-11-12T00:35:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571316028321628195" data-draft-id="7568785441128153122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 跨平台开发中的权衡"/> <meta itemprop="keywords" content="Android,iOS,Kotlin"/> <meta itemprop="datePublished" content="2025-11-12T00:35:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 跨平台开发中的权衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:35:44.000Z" title="Wed Nov 12 2025 00:35:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/020a1ae80ed7481f9738db369f2f51e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512544&amp;x-signature=6MZQfJysJ%2BsBWg6eHkcWk51pR%2Fg%3D" alt="0.png" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>“开发一致性很关键”——这句话在分布式系统领域经常被提及，在移动和 Web 应用开发中同样适用。</p>
<p>在当今这个单个应用需要在多个平台上无缝运行的时代，确保各平台之间的一致性不仅是一个目标，更是一种必要。多年来，开发者们一直面临着艰难的抉择：是为每个平台分别构建原生应用，还是采用跨平台框架。</p>
<p>从传统意义上来说，针对 Android 和 iOS 进行原生开发需要将资源翻倍投入：两套代码库、两支工程团队，还需要付出双倍的努力来确保功能和业务逻辑同步。当应用程序需要一致的 UI 和相同的业务逻辑时，自然就需要共享驱动它们运行的代码。</p>
<p>这种需求催生了像 <strong>Flutter</strong> 和 <strong>React Native</strong> 这样的跨平台工具。虽然这些工具非常有效，但往往需要做出重大的权衡。它们通常要求开发者使用不同的 UI 渲染引擎（<strong>Flutter</strong>）或使用桥接（<strong>React Native</strong>），与原生代码相比，这势必会导致性能损失。</p>
<p>在这种情况下，<strong>KMP</strong>（Kotlin Multiplatform） 提供了一种独特的方法。<strong>KMP</strong> 并不是取代原生平台的 SDK，而是与之协同工作，使开发者能够共享通用代码，并能以直观的惯用方式访问平台 API。具体来说，这意味着你可以像使用 <strong>React Native</strong> 一样，通过使用原生 UI 工具包来创建一款保留各平台外观和感觉的 <strong>KMP</strong> 应用程序。你也可以采用 <strong>CMP</strong>（Compose Multiplatform），效仿 <strong>Flutter</strong> 的方式共享 UI 实现，尽管这可能会导致应用在 iOS 上失去 “原生” 外观。</p>
<p>总之，当与 <strong>CMP</strong> 结合使用时，<strong>KMP</strong> 提供了一个极具吸引力的应用场景：与 <strong>Flutter</strong> 类似，它能编译成本地代码以实现出色的性能，同时也保留了使用原生 UI 工具包的选项，这一点与 <strong>React Native</strong> 一样具有灵活性。</p>
<p><strong>KMP</strong> 正成为跨平台开发的一个强大替代方案，它提供了一种在不牺牲原生应用性能和体验的前提下共享代码的途径。作为一种替代方案，<strong>KMP</strong> 也有自身需要权衡的方面，本文将深入探讨这些问题。</p>
<p>虽然本文主要关注 Android 和 iOS 开发，但 <strong>KMP</strong> 的应用前景更为广阔。借助同样的共享逻辑，它可用于构建桌面应用（Windows、macOS、Linux）、网页应用（通过 <strong>Kotlin/JavaScript</strong>），甚至服务器端应用。</p>
<h2 data-id="heading-1">什么是 Kotlin 跨平台（KMP）</h2>
<p><strong>KMP</strong> 允许开发团队在不同平台间编写和共享代码，而且借助 <strong>CMP</strong>，仍可选择构建原生 UI。它并非那种将平台特性完全抽象掉的 “非此即彼” 的框架。相反，它是一个精妙的工具，能让你共享应用中与平台无关的部分，同时让特定于平台的部分保持原生特性。Android 开发者可以用 <strong>Kotlin</strong> 编写 UI 代码，iOS 开发者则可以用 <strong>Objective-C</strong> 或 <strong>Swift</strong> 编写 UI 代码。但这并不意味着只能使用原生界面构建 UI，这是一个重要的区别。<strong>KMP</strong> 为你提供了按自己意愿构建 UI 的灵活性。</p>
<h3 data-id="heading-2">KMP 是如何工作的</h3>
<p><strong>KMP</strong> 有特定的项目结构以及 <code>expect/actual</code> 机制，这使其能够跨平台运行。一个典型的 <strong>KMP</strong> 项目分为多个模块：</p>
<ul>
<li><code>commonMain</code> 包含通用代码。这段代码只需编译一次，即可在所有目标平台上共享。你可以将业务逻辑、网络调用等放在这个模块中。</li>
<li><code>androidMain</code> 包含 Android 实现。Android 设备的 UI 可以在这个模块中用 <strong>Kotlin</strong> 编写。</li>
<li><code>iosMain</code> 包含 iOS 实现。iOS 设备的 UI 可以用 <strong>Swift</strong> 或 <strong>Objective-C</strong> 编写。</li>
</ul>
<p><code>expect</code> 和 <code>actual</code> 关键字是通用实现与特定平台实现之间的桥梁。在 <code>commonMain</code> 中，你可以预期某个类或函数存在，并定义其 API。然后，在 <code>androidMain</code> 和 <code>iosMain</code> 中，为该声明提供特定于平台的实际实现。例如，在 <code>commonMain</code> 中你可能预期有一个生成唯一标识符（UUID）的函数，然后在 <code>androidMain</code> 中使用 Android 的 <code>UUID.randomUUID()</code> ，在 <code>iosMain</code> 中使用 iOS 的 <code>NSUUID().uuidString</code> 来提供实际实现。</p>
<p>利用上述结构，可以为跨平台应用同时进行构建，而不会牺牲应用性能。</p>
<h2 data-id="heading-3">KMP 的优势</h2>
<h3 data-id="heading-4">降低成本</h3>
<p>统一架构并使同一批开发者能够为多个平台编写代码，无疑能显著降低工程成本。通过将业务逻辑、网络等功能置于共享的 <code>commonMain</code> 模块中，就无需针对同一功能在不同平台重复实现和测试。这直接避免了重复工作，也减少了特定于平台的错误，从而打造出更强大、更可靠的产品。此外，由于核心逻辑只需测试一次，这也简化了质量保证流程。需要重点指出的是，<strong>Flutter</strong> 和 <strong>React Native</strong> 也具备这一优势。在这方面，<strong>KMP</strong> 并不比其他技术更具有优势。</p>
<h3 data-id="heading-5">原生性能</h3>
<p>与其他跨平台工具不同，<strong>KMP</strong> 允许开发者使用平台的原生工具构建 UI。共享的 <strong>Kotlin</strong> 代码会被编译成目标平台所需的格式，为 Android 生成 <strong>JVM</strong> 字节码，为 iOS 生成原生二进制文件。与 <strong>React Native</strong> 不同，运行时不存在解释层，这使得应用程序能够实现接近原生的性能。</p>
<h3 data-id="heading-6">逐步采用</h3>
<p><strong>Flutter</strong>（使用 <strong>Dart</strong>）和 <strong>React Native</strong>（使用 <strong>TypeScript</strong> 或 <strong>JavaScript</strong>）需要 “全有或全无” 式的采用方式，而 <strong>Kotlin</strong> 多平台则并非如此。它可以在代码库中逐步引入，过渡会更加平缓。你可以将 <strong>KMP</strong> 逐步引入到现有的原生应用中，这有助于确保应用在整个过程中保持稳定。常见的起点是将单个功能或特定层迁移到共享的 <strong>KMP</strong> 模块中。</p>
<h3 data-id="heading-7">平滑演进</h3>
<p>由于谷歌正式认可 <strong>Kotlin</strong> 作为安卓开发的主要语言，大多数安卓开发团队都已在使用 <strong>Kotlin</strong> 进行开发。对于这些团队来说，向 <strong>Kotlin</strong> 多平台的过渡门槛极低。</p>
<h2 data-id="heading-8">Flutter vs React Native vs KMP</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/284f77dd8e5647afa6e97a293bbe27d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512544&amp;x-signature=%2BXwyK3Dr6SrFtZYCHgh%2Bh4uNQX8%3D" alt="cmp.png" loading="lazy"/></p>
<p>虽然这三项技术都支持跨平台开发，但它们的工作原理不同，特别是在 UI 和整体理念方面。下表总结了我们上面讨论的主要差异：</p>



































<table><thead><tr><th>特性</th><th><strong>Flutter</strong></th><th><strong>React Native</strong></th><th><strong>KMP</strong></th></tr></thead><tbody><tr><td>语言</td><td><strong>Dart</strong></td><td><strong>JavaScript / TypeScript</strong></td><td><strong>Kotlin</strong></td></tr><tr><td>UI 渲染</td><td>使用 <strong>Skia</strong> 引擎渲染自己的 UI</td><td>通过 <strong>JS</strong> 桥控制原生 UI 组件</td><td>可以使用原生 UI (<strong>SwiftUI/Compose</strong>) 或共享 UI (<strong>Compose Multiplatform</strong>)</td></tr><tr><td>性能</td><td>优秀，编译为原生代码，无需桥接</td><td>良好，但 <strong>JavaScript</strong> 桥可能会成为瓶颈</td><td>优秀，编译为平台原生格式，无需桥接</td></tr><tr><td>采用</td><td>完全投入</td><td>完全投入</td><td>逐步采用</td></tr></tbody></table>
<h2 data-id="heading-9">iOS 系统中的现状</h2>
<p>历史上，<strong>Kotlin</strong> 从未用于开发 iOS 应用程序。但有了 <strong>KMP</strong> 和 <strong>CMP</strong>，现在这已经成为可能。</p>
<p>长期以来，<strong>Kotlin</strong> 多平台在 iOS 方面秉持的理念是 “共享逻辑，原生构建用户界面”。虽说这是一种强大的方法，但它仍意味着用户界面开发是特定于平台的任务。随着 <code>1.8.0</code> 稳定版的发布，这种情况发生了改变。截至 2025 年 5 月 6 日，用于 iOS 的 <strong>CMP</strong> 达到一个稳定的、可用于生产环境的里程碑。</p>
<p>这一里程碑对于 <strong>Kotlin</strong> 多平台生态系统而言是一项重大成果。<strong>Jetpack Compose</strong> 是谷歌为安卓系统打造的现代声明式用户界面工具包。有了 <strong>CMP</strong>，现在你可以使用完全相同的 <strong>Kotlin</strong> 代码为 Android 和 iOS 定义 UI。这意味着不仅业务逻辑可以共享，用户界面本身也能共享。目前，该框架在功能上已经与面向 iOS 的 <strong>Jetpack Compose</strong> 不相上下，这使其成为新项目的可行选择。在我看来，<strong>CMP</strong> <code>1.8.0</code> 版本不仅对 iOS 开发有价值，而且实现了 <strong>KMP</strong> 真正的价值主张，因为开发者现在能够基于此构建整个应用程序。</p>
<p>此外，某些屏幕使用原生 <strong>Swift/UIKit</strong>，而其他屏幕使用 <strong>Compose</strong> 进行混合搭配的选项提供了极大的灵活性。为此，你可以依赖框架提供的特定包装组件，这些组件利用了 <strong>SwiftUI/UIKit</strong> 的互操作性。例如，要在原生 <strong>SwiftUI</strong> 应用中使用 <strong>CMP</strong> 界面，可将可组合 UI 包装在 <code>ComposeUIViewController</code> 中。然后，在 <strong>SwiftUI</strong> 代码中，为 <code>UIViewControllerRepresentable</code> 协议创建一个结构体，该结构体将管理控制器。若要在 <strong>Compose</strong> UI 中使用原生 <strong>SwiftUI</strong> 界面，可将 <strong>SwiftUI</strong> 视图托管在 <code>UIHostingController</code> 中，该控制器可使用 <code>UIKitView</code> 可组合项直接嵌入到 <strong>Compose</strong> 布局中。</p>
<h2 data-id="heading-10">使用 KMP 的大用户</h2>
<p><strong>KMP</strong> 并非只是一个理论概念，像网飞（Netflix）、麦当劳（McDonald’s）和飞利浦（Philips）这样的全球大型公司都在实际产品中使用它。</p>
<h3 data-id="heading-11">网飞</h3>
<p>网飞是 <strong>KMP</strong> 的早期重要用户，自 2020 年 10 月就开始采用该技术。他们利用 <strong>KMP</strong> 统一了各应用程序中的业务逻辑，确保无论用户使用何种设备，各项功能的运行表现一致。他们还在内部的 <strong>Prodicle</strong> 应用程序中使用了该技术，该应用程序为电视和电影项目的实际制作提供支持。</p>
<blockquote>
<p>我们的 Android 和 iOS 应用程序有着共享的架构，两个平台上编写的业务逻辑相似，甚至在某些情况下完全相同。—— <a href="https://link.juejin.cn?target=https%3A%2F%2Fnetflixtechblog.com%2Fnetflix-android-and-ios-studio-apps-kotlin-multiplatform-d6d4d8d25d23" target="_blank" title="https://netflixtechblog.com/netflix-android-and-ios-studio-apps-kotlin-multiplatform-d6d4d8d25d23" ref="nofollow noopener noreferrer">网飞</a></p>
</blockquote>
<p>网飞能够实现代码与底层平台 50% 的解耦。展望未来，网飞还谈到了将其应用程序发展成为一个薄 UI 层的可能性，该 UI 层共享用 <strong>KMP</strong> 编写的相同业务逻辑。</p>
<h3 data-id="heading-12">麦当劳</h3>
<p>麦当劳在其应用程序中引入应用内支付功能时，开始使用 <strong>KMP</strong>（早期版本中称为 <strong>KMM</strong>）。在验证了这种方法后，他们将 <strong>KMP</strong> 的使用扩展到其他服务。</p>
<blockquote>
<p>将 <strong>KMM</strong> 集成到应用程序流程中，使我们能够在一个地方开发解析和存储逻辑，此外还能开发在每个平台上正确显示本地化数据和产品所需的业务逻辑。—— <a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fmcdonalds-technical-blog%2Fmobile-multiplatform-development-at-mcdonalds-3b72c8d44ebc" target="_blank" title="https://medium.com/mcdonalds-technical-blog/mobile-multiplatform-development-at-mcdonalds-3b72c8d44ebc" ref="nofollow noopener noreferrer">麦当劳</a></p>
</blockquote>
<p>例如，为了满足不同国际地区客户的各种需求，他们将管理特定地区产品和数据的逻辑集中到一个共享的 <strong>KMP</strong> 模块中。在这个模块里，他们将 <strong>KMP</strong> 引入到处理特定地区和设备的产品与数据的业务逻辑中。</p>
<p>最终，麦当劳重写了整个应用程序以采用 <strong>KMP</strong>。通过这一战略转变，他们将独立的 Android 和 iOS 开发团队合并成一个更加统一且高效的移动开发团队。</p>
<h3 data-id="heading-13">飞利浦</h3>
<p>2018 年，飞利浦采用 <strong>KMP</strong> 来摆脱原生开发。飞利浦利用 <strong>KMP</strong> 为其互联消费产品和个人健康产品开发了一个用于设备通信和数据同步的共享 SDK，实现了牙刷和空气净化器等设备与移动应用的连接。通过使用 <strong>KMP</strong>，他们得以保留共享的业务逻辑。</p>
<blockquote>
<p>蓝牙低功耗接口存在很大差异，以至于无法设计出一种能同时适配两者的方案。所以在这方面，我们仍将采用原生开发方式。—— <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DhZPL8QqiLi8" target="_blank" title="https://www.youtube.com/watch?v=hZPL8QqiLi8" ref="nofollow noopener noreferrer">飞利浦</a></p>
</blockquote>
<p>他们最初在处理蓝牙低功耗的蓝牙 API 时遇到了一些问题。为了解决这个问题，他们对蓝牙协议栈保留了原生实现，这表明开发人员并非在整个代码库中都采用 <strong>KMP</strong>。</p>
<p>我们可以看到，现在越来越多的公司正在采用 <strong>KMP</strong>，它开始受到重视。各公司一开始行动较为缓慢，但随着他们开始看到其好处，便逐渐增加了使用案例。我建议大家查看所有这些案例研究，因为我仅提及了少数几个。</p>
<h2 data-id="heading-14">挑战与考量</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/077a51d6259042fba256bc6968e44f4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512544&amp;x-signature=oPKwLpDGIul5IDH0DfvbZY36DJw%3D" alt="bl.png" loading="lazy"/></p>
<p>虽然 <strong>KMP</strong> 为跨平台开发提供了一种很有前景的方法，但我们也必须认识到 <strong>KMP</strong> 目前的局限性。</p>
<h3 data-id="heading-15">生态系统成熟度</h3>
<p>与现有的工具（如 <strong>Flutter</strong> 和 <strong>React Native</strong>）相比，一个主要挑战在于 <strong>KMP</strong> 的开发者社区规模较小，支持生态系统也不够完善。虽然核心功能得到了很好的支持，但要找到满足特定需求（比如高级蓝牙交互或后台服务）的、适配 <strong>KMP</strong> 的库，情况依然不容乐观，就如同我们在飞利浦案例中看到的，可能仍需编写特定平台的代码实现。这有时意味着开发者需要围绕原生解决方案创建自己的包装器，这并不是理想的情况 。</p>
<h3 data-id="heading-16">iOS 团队的学习曲线</h3>
<p>对于 iOS 团队而言，采用 <strong>Kotlin</strong> 和 <strong>Gradle</strong> 构建系统可能会有一定的学习曲线，它们在安卓生态系统中很常见，但对大多数 iOS 开发者来说是新鲜事物。</p>
<h3 data-id="heading-17">Kotlin/Native 互操作性</h3>
<p><strong>Kotlin/Native</strong> 与 <strong>Swift/Objective-C</strong> 之间的互操作性存在自身的局限性。<strong>Kotlin/Native</strong> 通过 <strong>Swift/Objective-C</strong> 提供间接互操作性。例如，一些 <strong>Kotlin</strong> 语言特性在 <strong>Objective-C</strong> 中可能没有直接对应的特性，这就要求开发者在开发过程中了解这些差异。这一要求可能会成为一个很大的障碍，因为大多数开发者在开始开发之前并不了解这一点。泛型就是一个例子，在转换过程中类型信息会丢失。开发者需要留意传递的类型，并围绕此进行检查。</p>
<h3 data-id="heading-18">工具和开发流程</h3>
<p>虽然相关工具在不断改进，但目前仍不如原生开发工具那样无缝衔接。<strong>KMP</strong> 有一些插件，使用起来更加便捷，而且 <strong>JetBrains</strong> 正在积极开发这些插件。</p>
<p>虽然面临的挑战不少且不容忽视，但这种情况正在迅速改变。可以说，对 <strong>Kotlin</strong> 本身的支持已经成熟，并且还在不断发展，而 <strong>KMP</strong> 社区正是这一趋势的直接受益者。随着采用率的提高，共享知识和开源库的数量也会增加。</p>
<h2 data-id="heading-19">总结</h2>
<p>跨平台开发一直是在权衡利弊中进行的：要在开发效率与原生性能以及外观和用户体验之间找到平衡 。有了 <strong>KMP</strong>，这些权衡因素在一定程度上有所减少。你可以获得共享代码库带来的效率，同时交付几乎与原生应用性能相当的产品。</p>
<p>虽然核心功能有良好的支持，但要找到满足特定需求（如高级蓝牙低功耗交互或后台定位服务）的现成 <strong>KMP</strong> 库，可能仍需要编写特定于平台的实现代码。这确实是个问题，因为需要所有这些功能的应用程序无法仅通过 <strong>KMP</strong> 构建。但正如前面提到的，这是一个迭代演进的过程，由于 <strong>KMP</strong> 开发活跃，更好的支持将会推出。</p>
<blockquote>
<p>推荐一个网站，可以搜索当前的 <strong>KMP</strong> 相关的库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fklibs.io%2F" target="_blank" title="https://klibs.io/" ref="nofollow noopener noreferrer">klibs.io</a>。</p>
</blockquote>
<p><strong>KMP</strong> 提供了一个灵活且有前景的前进方向，使团队能够为多平台世界构建一致的高性能应用程序，同时又不脱离原生基础。对 <strong>Kotlin</strong> 的支持力度很大，其多平台功能也只会从此不断发展壮大。</p>
<hr/>
<blockquote>
<p>原文<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.com%2Farticles%2Fkotlin-multiplatform-evaluation%2F" target="_blank" title="https://www.infoq.com/articles/kotlin-multiplatform-evaluation/" ref="nofollow noopener noreferrer">www.infoq.com/articles/ko…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记第一次鸿蒙应用上架之旅：一场略带遗憾的旅途]]></title>    <link>https://juejin.cn/post/7571338749198188594</link>    <guid>https://juejin.cn/post/7571338749198188594</guid>    <pubDate>2025-11-12T00:35:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198188594" data-draft-id="7571360278970351625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记第一次鸿蒙应用上架之旅：一场略带遗憾的旅途"/> <meta itemprop="keywords" content="前端,HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-12T00:35:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记第一次鸿蒙应用上架之旅：一场略带遗憾的旅途
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:35:52.000Z" title="Wed Nov 12 2025 00:35:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">记第一次鸿蒙应用上架之旅：一场略带遗憾的旅途</h2>
<h4 data-id="heading-1">记第一次鸿蒙应用上架之旅：一场略带遗憾的旅途</h4>
<p>我们制作的一款旅行类应用 ——<strong>鸿途智导</strong>，上架也有一周多了。</p>
<p>对我来说，作为第一款上架的应用，按理来说应该满心兴奋，但或许是战线拉得太长，也经历了许多曲折，内心已没有太多波澜，更多的是遗憾。</p>
<p>此话怎讲呢？恰巧今天略有空闲，就来给大家聊聊这款应用，以及我们哭笑不得的开发历程。</p>
<p><strong>使用链接</strong>：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fappgallery.huawei.com%2Fapp%2Fdetail%3Fid%3Dhongtuzhidao.qinglanzhuma.huawei%26channelId%3DSHARE%26source%3Dappshare" target="_blank" title="https://appgallery.huawei.com/app/detail?id=hongtuzhidao.qinglanzhuma.huawei&amp;channelId=SHARE&amp;source=appshare" ref="nofollow noopener noreferrer">appgallery.huawei.com/app/detail?…</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca44250e5fb43ec89f89926b4f3405f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512552&amp;x-signature=VqOMdH8VnvllX1Zk9nTV%2BNGtVjU%3D" alt="图片" loading="lazy"/></p>
<hr/>
<h5 data-id="heading-2">这是一款什么样的产品？</h5>
<p>先和大家说说核心功能点，每一个都藏着我们对旅行的小期待～</p>
<h6 data-id="heading-3">🌍 应用首页：你的旅行情报站</h6>
<p>天气卡片 + 每日景点推荐 + 热门排行榜，打开 APP 就能解锁当日旅行灵感，一键开启鸿途之旅～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0614dda0567448e398d314e8df305225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512552&amp;x-signature=JvjbQT%2FmG4fk7VGbJa7HxWfQBEI%3D" alt="应用首页" loading="lazy"/></p>
<p>应用首页</p>
<h6 data-id="heading-4">🗣️ 随行探客：你的专属导游</h6>
<p>根据当前位置信息，为你生成专属语音导览，走到哪儿讲到哪儿，再也不用提前做攻略记知识点～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19f2b89c857b4af1ac3b7fc704a1b429~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512552&amp;x-signature=5HcIUNG5PbduNkKMArThnFXDPLA%3D" alt="随行探客功能" loading="lazy"/></p>
<p>随行探客功能</p>
<h6 data-id="heading-5">📸 洞见万物：一拍即懂</h6>
<p>遇到不知名的美景、古建筑、植物？把摄像机对准它，即刻获取详细介绍，旅行中的好奇心随时满足～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/053c2af5ca0643faa69fc7ddfaeec914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512552&amp;x-signature=QMcdJxkoPXsaYYB20NaL3pFkcug%3D" alt="洞见万物功能" loading="lazy"/></p>
<p>洞见万物功能</p>
<h6 data-id="heading-6">✍️ 攻略分享：打开你的旅行灵感库</h6>
<p>记录旅途趣事、分享小众玩法，和其他旅行者交流心得，让每一次出行都有迹可循～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e46a96e8dafd42a38ef91681be2ac5d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763512552&amp;x-signature=is1TOOUSLyAvbiVOXrZSe2ZEzAI%3D" alt="攻略分享功能" loading="lazy"/></p>
<p>攻略分享功能</p>
<hr/>
<h5 data-id="heading-7">我们本想做一款「更完美」的产品</h5>
<p>聊完现有功能，就该说说那份「遗憾」的由来 —— 先和大家讲讲我们最初的美好设想。</p>
<p>在做这款产品前，我们研究了市面上大部分旅行类 APP，发现它们大致分为四种风格，但各有优劣：</p>
<ul>
<li><strong>全能型</strong>（携程、马蜂窝、高德等）：覆盖交通、酒店、购票全链路，但功能臃肿，找入口费劲；</li>
<li><strong>社交型</strong>（小红书）：攻略参考丰富、用户粘性高，但旅行相关功能相对单一；</li>
<li><strong>AI 问答型</strong>（如豆包）：能做攻略、讲景点，但攻略散落在对话中，不易查找和二次编辑；</li>
<li><strong>旅程管理型</strong>（如圆周旅迹）：聚焦旅行前规划，却忽略了旅行中的实时体验优化。</li>
</ul>
<p>我们想做的，是<strong>取各家所长，聚焦「旅行中」的体验优化</strong>—— 打造一款「旅行百宝箱」式的 APP：</p>
<p>✅ 内置 AI 对话小助手，随时解答旅行中遇到的问题；</p>
<p>✅ 智能导游双模式：</p>
<ul>
<li>
<p>实时位置语音导览 + 短时行程规划（3 小时 / 半天 / 1 天），支持二次调整编辑；</p>
</li>
<li>
<p>图片识别功能，美景一拍即懂，满足好奇心；</p>
<p>✅ 旅行者交流社区 + 每日景点推荐，提升日常使用率和粘性。</p>
</li>
</ul>
<p>有了这个想法，我们就一头扎进了开发里 —— 从刚开始接触鸿蒙系统的边学边练，到遇到难题时的彻夜琢磨，再到逐步实现功能的成就感，每一步都走得很扎实。</p>
<p>终于，我们基本完成了最初的构想，本以为能带着「完整版」和大家见面，却没想到被现实泼了冷水。</p>
<hr/>
<h5 data-id="heading-8">上架路上的「妥协」：从完整版到青春版</h5>
<p>第一次提交审核后，我们收到了要求：需要提供 AI 生成、社区安全相关的资质证书。</p>
<p>其实这一点我们早有预料，于是兵分两路：一边申请资质，一边调整功能、补充细节（比如添加内容审核、生成标识、举报入口），希望能先实现上架。</p>
<p>但修修改改几次后，审核仍卡在读资质上。就这样等了差不多一个月，资质申请有了消息，却不是好消息 —— 一长串复杂的手续、数据同步共享等要求，让我们这个小团队有些招架不住。</p>
<p>权衡再三，我们不得不做出妥协：<strong>隐藏部分核心功能，尽量去 AI 化，简化产品形态</strong>。</p>
<p>于是，原本设想的「全能百宝箱」，最终以「青春版」的样子和大家见面了。</p>
<p>说实话，我们对这个版本并不完全满意 —— 它没能完全展现我们的初衷，也少了很多我们认为「能提升旅行体验」的关键功能。</p>
<p>但至少，它上架了，算是给这段时间的努力一个阶段性交代。</p>
<hr/>
<h5 data-id="heading-9">故事还没结束，我们仍在努力</h5>
<p>虽然这次上架带着遗憾，但这并不意味着我们放弃了最初的构想。</p>
<p>目前，我们还在尽力办理相关资质和材料，同时也在收集用户反馈，持续优化现有功能。</p>
<p>如果你愿意支持我们这个小团队，欢迎下载「鸿途智导」体验～ 无论是功能建议、使用问题，还是你心中「理想旅行 APP」的样子，都欢迎在评论区畅所欲言，你的每一条反馈，都是我们完善产品的动力。</p>
<p>期待不久的将来，我们能带着「完整版」甚至「Pro Max 版」回归，真正实现最初的设想，让每一段旅程都更精彩、更省心～</p>
<p>👉 点击下载：【鸿途智导】鸿蒙应用商店搜索即可</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fappgallery.huawei.com%2Fapp%2Fdetail%3Fid%3Dhongtuzhidao.qinglanzhuma.huawei%26channelId%3DSHARE%26source%3Dappshare" target="_blank" title="https://appgallery.huawei.com/app/detail?id=hongtuzhidao.qinglanzhuma.huawei&amp;channelId=SHARE&amp;source=appshare" ref="nofollow noopener noreferrer">appgallery.huawei.com/app/detail?…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（118）Redis的缓存机制如何实现？]]></title>    <link>https://juejin.cn/post/7571285984089964596</link>    <guid>https://juejin.cn/post/7571285984089964596</guid>    <pubDate>2025-11-11T23:07:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984089964596" data-draft-id="7571303808116686900" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（118）Redis的缓存机制如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T23:07:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（118）Redis的缓存机制如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T23:07:06.000Z" title="Tue Nov 11 2025 23:07:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 作为一个高性能的内存数据库，广泛应用于缓存机制中，以快速存取数据、减轻数据库压力。Redis 提供了多种缓存策略和持久化选项，帮助用户实现高效的缓存管理。以下是 Redis 缓存机制的详细讲解及代码示例。</p>
<h3 data-id="heading-0">1. 基本缓存操作</h3>
<p>Redis 提供了一系列命令来进行缓存操作，如 <code>SET</code>、<code>GET</code>、<code>EXPIRE</code> 等。以下是一些基本的缓存操作示例：</p>
<h4 data-id="heading-1">设置缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCacheExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 设置键值对</span>
            jedis.set(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

            <span class="hljs-comment">// 设置键值对并指定过期时间 (单位: 秒)</span>
            jedis.setex(<span class="hljs-string">"key2"</span>, <span class="hljs-number">3600</span>, <span class="hljs-string">"value2"</span>); <span class="hljs-comment">// 1 小时后过期</span>

            <span class="hljs-comment">// 获取键值对</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key1"</span>);
            System.out.println(<span class="hljs-string">"key1: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-2">2. 缓存过期策略</h3>
<p>Redis 提供了多种方法来设置缓存的过期时间：</p>
<ul>
<li><code>EXPIRE key seconds</code>：设置键的过期时间（秒）。</li>
<li><code>PEXPIRE key milliseconds</code>：设置键的过期时间（毫秒）。</li>
<li><code>EXPIREAT key timestamp</code>：设置键的过期时间为特定时间戳（秒）。</li>
<li><code>PEXPIREAT key timestamp</code>：设置键的过期时间为特定时间戳（毫秒）。</li>
<li><code>TTL key</code>：查看键的剩余生存时间（秒）。</li>
<li><code>PTTL key</code>：查看键的剩余生存时间（毫秒）。</li>
</ul>
<h4 data-id="heading-3">设置和获取过期时间</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisExpireExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 设置键值对并指定过期时间</span>
            jedis.set(<span class="hljs-string">"key3"</span>, <span class="hljs-string">"value3"</span>);
            jedis.expire(<span class="hljs-string">"key3"</span>, <span class="hljs-number">10</span>); <span class="hljs-comment">// 10 秒后过期</span>

            <span class="hljs-comment">// 获取过期时间</span>
            <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> jedis.ttl(<span class="hljs-string">"key3"</span>);
            System.out.println(<span class="hljs-string">"TTL for key3: "</span> + ttl);
        }
    }
}
</code></pre>
<h3 data-id="heading-4">3. 缓存淘汰策略</h3>
<p>当 Redis 达到最大内存限制时，会根据配置的淘汰策略删除一些键以释放内存。常见的策略包括：</p>
<ul>
<li><code>noeviction</code>：当内存不足时，返回错误，不会删除任何键。</li>
<li><code>allkeys-lru</code>：移除最近最少使用的键。</li>
<li><code>volatile-lru</code>：移除最近最少使用的设置了过期时间的键。</li>
<li><code>allkeys-random</code>：随机移除一些键。</li>
<li><code>volatile-random</code>：随机移除一些设置了过期时间的键。</li>
<li><code>volatile-ttl</code>：移除一些将要过期的键。</li>
</ul>
<p>可以在 <code>redis.conf</code> 文件中配置：</p>
<pre><code class="hljs language-conf" lang="conf">maxmemory 256mb
maxmemory-policy allkeys-lru
</code></pre>
<h3 data-id="heading-5">4. 使用缓存的示例：缓存数据库查询结果</h3>
<p>以下示例展示了如何使用 Redis 缓存数据库查询结果，以提高查询性能。</p>
<h4 data-id="heading-6">数据库查询类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">query</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"DB_Value_for_"</span> + key;
    }
}
</code></pre>
<h4 data-id="heading-7">缓存类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> Jedis jedis;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> cacheExpireTime;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cache</span><span class="hljs-params">(Jedis jedis, <span class="hljs-type">int</span> cacheExpireTime)</span> {
        <span class="hljs-built_in">this</span>.jedis = jedis;
        <span class="hljs-built_in">this</span>.cacheExpireTime = cacheExpireTime;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getData</span><span class="hljs-params">(String key, Database db)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(key);
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 缓存未命中，从数据库查询</span>
            value = db.query(key);
            <span class="hljs-comment">// 将结果缓存到 Redis，并设置过期时间</span>
            jedis.setex(key, cacheExpireTime, value);
        }
        <span class="hljs-keyword">return</span> value;
    }
}
</code></pre>
<h4 data-id="heading-8">主程序</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">Database</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Database</span>();
            <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>(jedis, <span class="hljs-number">3600</span>); <span class="hljs-comment">// 缓存 1 小时</span>

            <span class="hljs-comment">// 查询并缓存结果</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.getData(<span class="hljs-string">"key1"</span>, db);
            System.out.println(<span class="hljs-string">"Result: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">5. 缓存的持久化</h3>
<p>Redis 提供了 RDB 和 AOF 两种持久化方式，以确保数据在重启或故障后的恢复。</p>
<h4 data-id="heading-10">RDB 持久化</h4>
<p>RDB (Redis Database Backup) 是一种定期快照的持久化方式，可以通过配置 <code>redis.conf</code> 来启用：</p>
<pre><code class="hljs language-conf" lang="conf">save 900 1
save 300 10
save 60 10000
</code></pre>
<h4 data-id="heading-11">AOF 持久化</h4>
<p>AOF (Append-Only File) 是一种将每次写操作记录到日志文件的持久化方式：</p>
<pre><code class="hljs language-conf" lang="conf">appendonly yes
appendfsync everysec
</code></pre>
<h3 data-id="heading-12">6. 实现缓存更新机制</h3>
<p>当数据源（如数据库）更新时，需要同步更新缓存，以确保缓存数据的一致性。常见的策略包括：</p>
<ul>
<li><strong>主动更新</strong>：在数据源更新时，主动更新或删除缓存。</li>
<li><strong>定时刷新</strong>：定期刷新缓存中的数据。</li>
<li><strong>缓存失效</strong>：设置合理的过期时间，让缓存自动失效。</li>
</ul>
<h4 data-id="heading-13">主动更新示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> Jedis jedis;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> cacheExpireTime;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cache</span><span class="hljs-params">(Jedis jedis, <span class="hljs-type">int</span> cacheExpireTime)</span> {
        <span class="hljs-built_in">this</span>.jedis = jedis;
        <span class="hljs-built_in">this</span>.cacheExpireTime = cacheExpireTime;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getData</span><span class="hljs-params">(String key, Database db)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(key);
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 缓存未命中，从数据库查询</span>
            value = db.query(key);
            <span class="hljs-comment">// 将结果缓存到 Redis，并设置过期时间</span>
            jedis.setex(key, cacheExpireTime, value);
        }
        <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateData</span><span class="hljs-params">(String key, String newValue)</span> {
        <span class="hljs-comment">// 更新数据库</span>
        <span class="hljs-comment">// db.update(key, newValue);</span>

        <span class="hljs-comment">// 更新缓存</span>
        jedis.setex(key, cacheExpireTime, newValue);
    }
}
</code></pre>
<h3 data-id="heading-14">总结</h3>
<p>Redis 提供了强大的缓存机制，能够有效提升系统性能。在使用 Redis 实现缓存时，可以利用其提供的多种缓存策略、过期策略和淘汰策略，并结合实际业务需求进行合理配置。此外，通过缓存数据库查询结果、实现缓存更新机制，可以确保缓存数据的一致性和有效性。通过上述示例代码，可以帮助你更好地理解和实现 Redis 的缓存机制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（119）Redis的安全机制如何配置？]]></title>    <link>https://juejin.cn/post/7571272874847682612</link>    <guid>https://juejin.cn/post/7571272874847682612</guid>    <pubDate>2025-11-11T23:07:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874847682612" data-draft-id="7571285984089980980" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（119）Redis的安全机制如何配置？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T23:07:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（119）Redis的安全机制如何配置？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T23:07:57.000Z" title="Tue Nov 11 2025 23:07:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 提供了一些安全机制来保护其免受未授权访问和其他潜在的安全威胁。以下是 Redis 安全机制的详细介绍及配置示例。</p>
<h3 data-id="heading-0">1. 绑定 IP 地址</h3>
<p>Redis 默认监听所有网络接口，建议将其绑定到指定的 IP 地址以限制访问范围。可以在 <code>redis.conf</code> 文件中配置 <code>bind</code> 选项：</p>
<pre><code class="hljs language-conf" lang="conf"># 绑定到本地回环地址
bind 127.0.0.1
</code></pre>
<h3 data-id="heading-1">2. 设置密码</h3>
<p>Redis 支持设置密码来限制未授权访问。可以在 <code>redis.conf</code> 文件中配置 <code>requirepass</code> 选项：</p>
<pre><code class="hljs language-conf" lang="conf"># 设置访问密码
requirepass your_password_here
</code></pre>
<p>在代码中需要使用密码进行连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAuthExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.auth(<span class="hljs-string">"your_password_here"</span>);
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
            System.out.println(<span class="hljs-string">"key: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-2">3. 保护模式</h3>
<p>Redis 从版本 3.2 开始引入了保护模式。在保护模式下，如果没有设置密码且 Redis 绑定到所有网络接口（0.0.0.0），则默认拒绝外部连接。可以在 <code>redis.conf</code> 文件中配置 <code>protected-mode</code> 选项：</p>
<pre><code class="hljs language-conf" lang="conf">protected-mode yes
</code></pre>
<h3 data-id="heading-3">4. 禁用危险命令</h3>
<p>出于安全考虑，可以禁用一些危险命令，如 <code>FLUSHALL</code>、<code>CONFIG</code> 等。可以在 <code>redis.conf</code> 文件中配置 <code>rename-command</code> 选项将这些命令重命名为一个无效的命令：</p>
<pre><code class="hljs language-conf" lang="conf"># 重命名危险命令，使其不可用
rename-command FLUSHALL ""
rename-command CONFIG ""
</code></pre>
<h3 data-id="heading-4">5. 通过防火墙限制访问</h3>
<p>除了在 <code>redis.conf</code> 中进行配置，还可以使用防火墙来限制 Redis 的访问。例如，在 Linux 上使用 <code>iptables</code>：</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 只允许本地访问 Redis</span>
iptables -A INPUT -p tcp --dport 6379 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 6379 -j DROP
</code></pre>
<h3 data-id="heading-5">6. 启用 TLS 加密</h3>
<p>从 Redis 6.0 开始，Redis 支持 TLS 加密。配置 TLS 加密需要生成证书和密钥，并在 <code>redis.conf</code> 文件中进行配置：</p>
<pre><code class="hljs language-conf" lang="conf">tls-port 6379
port 0
tls-cert-file /path/to/redis.crt
tls-key-file /path/to/redis.key
tls-ca-cert-file /path/to/ca.crt
</code></pre>
<p>客户端连接时也需要使用 TLS 证书：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.JedisShardInfo;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTLSExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">JedisShardInfo</span> <span class="hljs-variable">shardInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisShardInfo</span>(<span class="hljs-string">"rediss://localhost:6379"</span>);
        shardInfo.setPassword(<span class="hljs-string">"your_password_here"</span>);
        shardInfo.setSsl(<span class="hljs-literal">true</span>);
        shardInfo.setSslSocketFactory(SSLContext.getDefault().getSocketFactory());

        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(shardInfo)) {
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
            System.out.println(<span class="hljs-string">"key: "</span> + value);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">7. 配置客户端连接限制</h3>
<p>通过配置 <code>redis.conf</code> 文件中的 <code>maxclients</code> 选项，可以限制同时连接到 Redis 的最大客户端数量，以防止资源耗尽：</p>
<pre><code class="hljs language-conf" lang="conf">maxclients 10000
</code></pre>
<h3 data-id="heading-7">8. 配置最大内存使用</h3>
<p>通过配置 <code>redis.conf</code> 文件中的 <code>maxmemory</code> 选项，可以限制 Redis 使用的最大内存量，以防止内存使用过多：</p>
<pre><code class="hljs language-conf" lang="conf">maxmemory 256mb
</code></pre>
<h3 data-id="heading-8">9. 日志审计</h3>
<p>Redis 支持将日志记录到文件或标准输出。可以在 <code>redis.conf</code> 文件中配置 <code>logfile</code> 和 <code>loglevel</code> 选项：</p>
<pre><code class="hljs language-conf" lang="conf">logfile "/var/log/redis/redis-server.log"
loglevel notice
</code></pre>
<h3 data-id="heading-9">10. 示例配置文件</h3>
<p>以下是一个示例 <code>redis.conf</code> 文件，结合了上述安全配置：</p>
<pre><code class="hljs language-conf" lang="conf"># 网络绑定
bind 127.0.0.1

# 保护模式
protected-mode yes

# 访问密码
requirepass your_password_here

# 重命名危险命令
rename-command FLUSHALL ""
rename-command CONFIG ""

# TLS 加密
tls-port 6379
port 0
tls-cert-file /path/to/redis.crt
tls-key-file /path/to/redis.key
tls-ca-cert-file /path/to/ca.crt

# 客户端连接限制
maxclients 10000

# 最大内存使用
maxmemory 256mb

# 日志配置
logfile "/var/log/redis/redis-server.log"
loglevel notice
</code></pre>
<h3 data-id="heading-10">总结</h3>
<p>通过合理配置 Redis 的安全机制，可以有效地保护 Redis 实例免受未授权访问和其他潜在的安全威胁。上述配置涵盖了 IP 绑定、密码保护、保护模式、禁用危险命令、防火墙限制、TLS 加密、客户端连接限制、最大内存使用和日志审计等方面。结合具体业务需求，可以进一步定制和优化 Redis 的安全配置。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#.NET ControllerBase 深入解析：Web API 控制器的核心基石]]></title>    <link>https://juejin.cn/post/7571342319892922403</link>    <guid>https://juejin.cn/post/7571342319892922403</guid>    <pubDate>2025-11-11T23:19:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571342319892922403" data-draft-id="7571285984090030132" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#.NET ControllerBase 深入解析：Web API 控制器的核心基石"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-11-11T23:19:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#.NET ControllerBase 深入解析：Web API 控制器的核心基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T23:19:09.000Z" title="Tue Nov 11 2025 23:19:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>ControllerBase</code> 是 <code>ASP.NET Core</code> 中构建 <code>Web API</code> 控制器的基类，位于 <code>Microsoft.AspNetCore.Mvc</code> 命名空间。它提供了丰富的功能来处理 <code>HTTP</code> 请求，但不包含视图支持。</p>
<p>核心功能：</p>
<ul>
<li>
<p><code>HTTP</code> 响应：提供方法（如 <code>Ok、NotFound</code>）生成标准 <code>HTTP</code> 响应。</p>
</li>
<li>
<p>模型绑定：自动将请求数据绑定到参数（如查询字符串、请求体）。</p>
</li>
<li>
<p>验证支持：结合 <code>[ApiController]</code> 实现自动模型验证。</p>
</li>
<li>
<p>异步友好：支持 <code>async/await</code> 处理高并发请求。</p>
</li>
<li>
<p>轻量设计：不包含 <code>MVC</code> 视图相关的功能，适合 <code>API</code> 场景。</p>
</li>
</ul>
<h3 data-id="heading-1">ControllerBase 的定位</h3>
<ul>
<li>
<p>位于命名空间 <code>Microsoft.AspNetCore.Mvc</code>，是所有 <code>Web API</code> 控制器的基类。</p>
</li>
<li>
<p>与 MVC 的 <code>Controller</code> 相比，<code>ControllerBase</code> 不包含视图（<code>Razor</code>）相关功能，仅提供 内容结果、状态码、路由绑定、模型验证 等 <code>Web API</code> 核心支持。</p>
</li>
<li>
<p>通常搭配 <code>[ApiController]</code> 特性使用，开启自动模型验证、参数绑定规则和返回行为。</p>
</li>
</ul>
<h3 data-id="heading-2">继承体系</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">object</span>
 └─ ControllerBase
     ├─ Controller         <span class="hljs-comment">// 包含 View()、PartialView() 等 MVC 视图方法</span>
     └─ 用户自定义 Controllers…
</code></pre>
<ul>
<li>
<p><code>ControllerBase</code></p>
<ul>
<li>
<p>提供结果工厂方法（<code>Ok(), CreatedAtAction()</code> 等）</p>
</li>
<li>
<p>包含属性如 <code>Request、Response、ModelState、User</code></p>
</li>
<li>
<p>实现接口 <code>IActionFilterMetadata、IActionResult</code> 等元数据标记</p>
</li>
</ul>
</li>
<li>
<p><code>Controller</code>（典型用于 <code>MVC</code>）</p>
<ul>
<li>继承自 <code>ControllerBase</code> 并额外添加视图渲染方法</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">构造注入与内置属性</h3>
<p>在自定义 <code>API</code> 控制器中，通常这样声明：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsController</span> : <span class="hljs-title">ControllerBase</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IProductService _svc;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProductsController</span>(<span class="hljs-params">IProductService svc</span>)</span>
    {
        _svc = svc;
    }
    <span class="hljs-comment">// Action 方法…</span>
}
</code></pre>
<ul>
<li>
<p><code>[ApiController]</code></p>
<ul>
<li>
<p>自动执行模型验证，错误时直接返回 400</p>
</li>
<li>
<p>简化参数绑定（如 <code>[FromBody]、[FromQuery]</code> 默认行为）</p>
</li>
</ul>
</li>
<li>
<p><code>Route、HttpXXX</code> 特性</p>
<ul>
<li>定义路由模板与 <code>HTTP</code> 动作要匹配的请求</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">常用内置属性</h4>

































<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>HttpContext</code></td><td>当前请求上下文</td></tr><tr><td><code>Request</code></td><td>快速访问 <code>HttpContext.Request</code></td></tr><tr><td><code>Response</code></td><td>快速访问 <code>HttpContext.Response</code></td></tr><tr><td><code>User</code></td><td>当前认证用户的 <code>ClaimsPrincipal</code></td></tr><tr><td><code>RouteData</code></td><td>路由参数及其绑定值</td></tr><tr><td><code>ModelState</code></td><td>模型验证状态与错误详情</td></tr></tbody></table>
<h3 data-id="heading-5">结果工厂方法</h3>
<p><code>ControllerBase</code> 提供一系列返回 <code>ActionResult</code> 的方法，用于快速构造 <code>HTTP</code> 响应：</p>
<h4 data-id="heading-6">成功响应</h4>






























<table><thead><tr><th>方法</th><th>HTTP 状态码</th><th>说明</th></tr></thead><tbody><tr><td><code>Ok()</code> / <code>Ok(object value)</code></td><td>200</td><td>返回 200，带或不带响应体</td></tr><tr><td><code>Created(string uri, object value)</code></td><td>201</td><td>资源已创建，Location 头部指定新资源 URI</td></tr><tr><td><code>CreatedAtAction(...)</code> / <code>CreatedAtRoute(...)</code></td><td>201</td><td>指定路由或动作生成 Location</td></tr><tr><td><code>NoContent()</code></td><td>204</td><td>成功但无响应体</td></tr></tbody></table>
<h4 data-id="heading-7">客户端错误</h4>








































<table><thead><tr><th>方法</th><th>HTTP 状态码</th><th>说明</th></tr></thead><tbody><tr><td><code>BadRequest()</code> / <code>BadRequest(object error)</code></td><td>400</td><td>返回模型验证错误或自定义错误消息</td></tr><tr><td><code>Unauthorized()</code></td><td>401</td><td>未认证</td></tr><tr><td><code>Forbid()</code></td><td>403</td><td>无访问权限</td></tr><tr><td><code>NotFound()</code> / <code>NotFound(object value)</code></td><td>404</td><td>资源未找到</td></tr><tr><td><code>Conflict()</code></td><td>409</td><td>冲突，如重复资源</td></tr><tr><td><code>UnsupportedMediaType()</code></td><td>415</td><td>不支持的媒体类型</td></tr></tbody></table>
<h4 data-id="heading-8">服务端错误</h4>




















<table><thead><tr><th>方法</th><th>HTTP 状态码</th><th>说明</th></tr></thead><tbody><tr><td><code>StatusCode(int statusCode)</code></td><td>自定义</td><td>返回任意状态码</td></tr><tr><td><code>Problem()</code></td><td>500+</td><td>按 RFC 7807 生成标准化错误响应体</td></tr></tbody></table>
<blockquote>
<p>Tip: 这些工厂方法本质上返回了实现 IActionResult 的对象，框架在管道末端执行并写入 HTTP。</p>
</blockquote>
<h3 data-id="heading-9">核心功能详解</h3>
<h4 data-id="heading-10">HTTP 响应方法</h4>
<p>状态码响应</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetProduct</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span>
{
    <span class="hljs-keyword">var</span> product = _repository.Get(id);
    
    <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> NotFound(); <span class="hljs-comment">// 404</span>
    
    <span class="hljs-keyword">return</span> Ok(product); <span class="hljs-comment">// 200 + 数据</span>
}
</code></pre>
<p>文件响应</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">HttpGet(<span class="hljs-string">"download/{fileName}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">DownloadFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName</span>)</span>
{
    <span class="hljs-keyword">var</span> filePath = Path.Combine(_env.ContentRootPath, <span class="hljs-string">"Files"</span>, fileName);
    
    <span class="hljs-keyword">if</span> (!System.IO.File.Exists(filePath))
        <span class="hljs-keyword">return</span> NotFound();
    
    <span class="hljs-keyword">var</span> fileBytes = System.IO.File.ReadAllBytes(filePath);
    <span class="hljs-keyword">return</span> File(fileBytes, <span class="hljs-string">"application/octet-stream"</span>, fileName);
}
</code></pre>
<h4 data-id="heading-11">请求上下文访问</h4>
<p>常用属性</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsController</span> : <span class="hljs-title">ControllerBase</span>
{
    [<span class="hljs-meta">HttpGet(<span class="hljs-string">"info"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetInfo</span>()</span>
    {
        <span class="hljs-comment">// 获取请求信息</span>
        <span class="hljs-keyword">var</span> method = Request.Method;
        <span class="hljs-keyword">var</span> contentType = Request.ContentType;
        
        <span class="hljs-comment">// 获取用户信息</span>
        <span class="hljs-keyword">var</span> userName = User.Identity?.Name;
        <span class="hljs-keyword">var</span> isAdmin = User.IsInRole(<span class="hljs-string">"Admin"</span>);
        
        <span class="hljs-comment">// 获取路由数据</span>
        <span class="hljs-keyword">var</span> routeId = RouteData.Values[<span class="hljs-string">"id"</span>];
        
        <span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { method, userName });
    }
}
</code></pre>
<h4 data-id="heading-12">模型绑定与验证</h4>
<ul>
<li>
<p>自动验证（启用 <code>[ApiController]</code> 时）</p>
<ul>
<li>
<p>在 <code>Action</code> 执行前对标注了验证特性的模型进行验证</p>
</li>
<li>
<p><code>ModelState.IsValid == false</code> 则自动返回 400 <code>Bad Request</code>，响应体包含错误详情</p>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">HttpPost</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">CreateProduct</span>(<span class="hljs-params">
    [FromBody] Product product, // 从JSON绑定
    [FromQuery] <span class="hljs-built_in">string</span> category, // 从查询字符串绑定
    [FromHeader] <span class="hljs-built_in">string</span> apiKey</span>) <span class="hljs-comment">// 从请求头绑定</span></span>
{
    <span class="hljs-comment">// 自动模型验证</span>
    <span class="hljs-keyword">if</span> (!ModelState.IsValid)
    {
        <span class="hljs-keyword">return</span> BadRequest(ModelState);
    }
    
    <span class="hljs-comment">// 业务逻辑处理</span>
    <span class="hljs-keyword">var</span> createdProduct = _service.Create(product, category);
    
    <span class="hljs-keyword">return</span> CreatedAtAction(<span class="hljs-keyword">nameof</span>(GetProduct), 
        <span class="hljs-keyword">new</span> { id = createdProduct.Id }, createdProduct);
}
</code></pre>
<h3 data-id="heading-13">高级功能与最佳实践</h3>
<h4 data-id="heading-14">操作结果包装</h4>
<p>自定义统一响应格式</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApiResult</span>&lt;<span class="hljs-title">T</span>&gt; : <span class="hljs-title">IActionResult</span>
{
    <span class="hljs-keyword">public</span> T Data { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> StatusCode { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Message { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ApiResult</span>(<span class="hljs-params">T data, <span class="hljs-built_in">int</span> statusCode = <span class="hljs-number">200</span>, <span class="hljs-built_in">string</span>? message = <span class="hljs-literal">null</span></span>)</span>
    {
        Data = data;
        StatusCode = statusCode;
        Message = message;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ExecuteResultAsync</span>(<span class="hljs-params">ActionContext context</span>)</span>
    {
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> ObjectResult(<span class="hljs-keyword">new</span>
        {
            Success = StatusCode &gt;= <span class="hljs-number">200</span> &amp;&amp; StatusCode &lt; <span class="hljs-number">300</span>,
            Data,
            Message,
            Timestamp = DateTime.UtcNow
        })
        {
            StatusCode = StatusCode
        };

        <span class="hljs-keyword">await</span> result.ExecuteResultAsync(context);
    }
}

<span class="hljs-comment">// 在控制器中使用</span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> ApiResult&lt;Product&gt; <span class="hljs-title">GetProduct</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span>
{
    <span class="hljs-keyword">var</span> product = _repository.Get(id);
    <span class="hljs-keyword">return</span> product == <span class="hljs-literal">null</span> 
        ? <span class="hljs-keyword">new</span> ApiResult&lt;Product&gt;(<span class="hljs-literal">null</span>, <span class="hljs-number">404</span>, <span class="hljs-string">"Product not found"</span>) 
        : <span class="hljs-keyword">new</span> ApiResult&lt;Product&gt;(product);
}
</code></pre>
<h4 data-id="heading-15">内容协商</h4>
<p>支持多种响应格式</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
[<span class="hljs-meta">Produces(<span class="hljs-string">"application/json"</span>, <span class="hljs-string">"application/xml"</span>)</span>] <span class="hljs-comment">// 支持的响应类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsController</span> : <span class="hljs-title">ControllerBase</span>
{
    [<span class="hljs-meta">HttpGet</span>]
    <span class="hljs-keyword">public</span> ActionResult&lt;IEnumerable&lt;Product&gt;&gt; GetAll()
    {
        <span class="hljs-keyword">return</span> _repository.GetAll();
    }
}
</code></pre>
<h4 data-id="heading-16">API 版本控制</h4>
<p>实现 <code>API</code> 版本管理</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">ApiVersion(<span class="hljs-string">"1.0"</span>)</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/v{version:apiVersion}/[controller]"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductsController</span> : <span class="hljs-title">ControllerBase</span>
{
    [<span class="hljs-meta">HttpGet</span>]
    [<span class="hljs-meta">MapToApiVersion(<span class="hljs-string">"1.0"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;Product&gt; <span class="hljs-title">GetV1</span>()</span>
    {
        <span class="hljs-comment">// 版本1.0的实现</span>
    }

    [<span class="hljs-meta">HttpGet</span>]
    [<span class="hljs-meta">MapToApiVersion(<span class="hljs-string">"2.0"</span>)</span>]
    <span class="hljs-keyword">public</span> ActionResult&lt;IEnumerable&lt;ProductDto&gt;&gt; GetV2()
    {
        <span class="hljs-comment">// 版本2.0的实现</span>
    }
}
</code></pre>
<h4 data-id="heading-17">异步支持</h4>
<ul>
<li><code>ControllerBase</code> 建议写 异步 <code>Action</code>，返回 <code>Task&lt;IActionResult&gt;</code> 或直接 <code>Task&lt;T&gt;</code>（结合泛型 <code>ActionResult&lt;T&gt;</code>）：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;ActionResult&lt;Product&gt;&gt; Get(<span class="hljs-built_in">int</span> id)
{
    <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">await</span> _svc.FindAsync(id);
    <span class="hljs-keyword">return</span> p <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> ? NotFound() : Ok(p);
}
</code></pre>
<ul>
<li>
<p><code>ActionResult&lt;T&gt;</code>（.NET Core 2.1+）</p>
<ul>
<li>允许方法既返回 <code>T</code>（自动包装为 200）也返回 <code>ActionResult</code>（可自定义状态码）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-18">过滤器与管道</h3>
<ul>
<li>
<p><code>ControllerBase</code> 支持注册和应用各种 过滤器：</p>
<ul>
<li>
<p>授权过滤器（<code>[Authorize]</code>）</p>
</li>
<li>
<p>资源过滤器（<code>IResourceFilter</code>）</p>
</li>
<li>
<p>动作过滤器（<code>IActionFilter</code>）</p>
</li>
<li>
<p>异常过滤器（<code>IExceptionFilter</code>）</p>
</li>
<li>
<p>结果过滤器（<code>IResultFilter</code>）</p>
</li>
</ul>
</li>
<li>
<p>示例：全局注册</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">services.AddControllers(options =&gt;
{
    options.Filters.Add&lt;GlobalExceptionFilter&gt;();
});
</code></pre>
<ul>
<li>示例：单控制器/Action 应用</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">TypeFilter(typeof(LogActionFilter))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyController</span> : <span class="hljs-title">ControllerBase</span> { … }
</code></pre>
<h3 data-id="heading-19">安全最佳实践</h3>
<h4 data-id="heading-20">身份验证与授权</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Authorize</span>] <span class="hljs-comment">// 控制器级别要求认证</span>
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OrdersController</span> : <span class="hljs-title">ControllerBase</span>
{
    [<span class="hljs-meta">HttpGet</span>]
    [<span class="hljs-meta">Authorize(Roles = <span class="hljs-string">"Admin"</span>)</span>] <span class="hljs-comment">// 要求管理员角色</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetAllOrders</span>()</span> { <span class="hljs-comment">/* ... */</span> }

    [<span class="hljs-meta">HttpGet(<span class="hljs-string">"my"</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetMyOrders</span>()</span>
    {
        <span class="hljs-comment">// 获取当前用户ID</span>
        <span class="hljs-keyword">var</span> userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
        <span class="hljs-keyword">return</span> Ok(_repository.GetOrdersByUser(userId));
    }

    [<span class="hljs-meta">HttpPost</span>]
    [<span class="hljs-meta">Authorize(Policy = <span class="hljs-string">"RequireVerifiedEmail"</span>)</span>] <span class="hljs-comment">// 使用自定义策略</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">CreateOrder</span>(<span class="hljs-params">[FromBody] Order order</span>)</span> { <span class="hljs-comment">/* ... */</span> }
}
</code></pre>
<h4 data-id="heading-21">跨域资源共享 (CORS)</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiController</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/[controller]"</span>)</span>]
[<span class="hljs-meta">EnableCors(<span class="hljs-string">"AllowSpecificOrigin"</span>)</span>] <span class="hljs-comment">// 启用CORS策略</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicDataController</span> : <span class="hljs-title">ControllerBase</span>
{
    [<span class="hljs-meta">HttpGet</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetPublicData</span>()</span> { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-comment">// 在Startup中配置CORS策略</span>
services.AddCors(options =&gt;
{
    options.AddPolicy(<span class="hljs-string">"AllowSpecificOrigin"</span>,
        builder =&gt; builder.WithOrigins(<span class="hljs-string">"https://example.com"</span>)
                          .AllowAnyMethod()
                          .AllowAnyHeader());
});
</code></pre>
<h3 data-id="heading-22">常见问题解决方案</h3>
<h4 data-id="heading-23">模型验证统一处理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 创建统一验证过滤器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ValidateModelAttribute</span> : <span class="hljs-title">ActionFilterAttribute</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnActionExecuting</span>(<span class="hljs-params">ActionExecutingContext context</span>)</span>
    {
        <span class="hljs-keyword">if</span> (!context.ModelState.IsValid)
        {
            context.Result = <span class="hljs-keyword">new</span> BadRequestObjectResult(<span class="hljs-keyword">new</span>
            {
                Code = <span class="hljs-number">400</span>,
                Message = <span class="hljs-string">"参数验证失败"</span>,
                Errors = context.ModelState
                    .SelectMany(m =&gt; m.Value.Errors)
                    .Select(e =&gt; e.ErrorMessage)
            });
        }
    }
}

<span class="hljs-comment">// 全局注册</span>
services.AddControllers(options =&gt; 
{
    options.Filters.Add&lt;ValidateModelAttribute&gt;();
});
</code></pre>
<h4 data-id="heading-24">全局异常处理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApiExceptionFilter</span> : <span class="hljs-title">IExceptionFilter</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnException</span>(<span class="hljs-params">ExceptionContext context</span>)</span>
    {
        <span class="hljs-keyword">var</span> exception = context.Exception;
        <span class="hljs-keyword">var</span> statusCode = exception <span class="hljs-keyword">switch</span>
        {
            NotFoundException =&gt; <span class="hljs-number">404</span>,
            ValidationException =&gt; <span class="hljs-number">400</span>,
            UnauthorizedAccessException =&gt; <span class="hljs-number">401</span>,
            _ =&gt; <span class="hljs-number">500</span>
        };

        context.Result = <span class="hljs-keyword">new</span> ObjectResult(<span class="hljs-keyword">new</span>
        {
            Code = statusCode,
            Message = exception.Message
        })
        {
            StatusCode = statusCode
        };
        
        context.ExceptionHandled = <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-25">ControllerBase 最佳实践总结</h3>
<h4 data-id="heading-26">API 设计规范</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用HTTP动词特性</span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"{id}"</span>)</span>]
[<span class="hljs-meta">HttpPost</span>]
[<span class="hljs-meta">HttpPut(<span class="hljs-string">"{id}"</span>)</span>]
[<span class="hljs-meta">HttpDelete(<span class="hljs-string">"{id}"</span>)</span>]
</code></pre>
<h4 data-id="heading-27">响应类型声</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ProducesResponseType(StatusCodes.Status200OK, Type = typeof(Product))</span>]
[<span class="hljs-meta">ProducesResponseType(StatusCodes.Status404NotFound)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">GetProduct</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span> { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h4 data-id="heading-28">异步优先</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">Get</span>()</span> { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h4 data-id="heading-29">依赖注入</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyController</span>(<span class="hljs-params">IMyService service</span>)</span> { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h4 data-id="heading-30">安全加固</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Authorize</span>]
[<span class="hljs-meta">ValidateAntiForgeryToken</span>]
[<span class="hljs-meta">EnableCors(<span class="hljs-string">"SafePolicy"</span>)</span>]
</code></pre>
<h4 data-id="heading-31">版本管理</h4>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">ApiVersion(<span class="hljs-string">"1.0"</span>)</span>]
[<span class="hljs-meta">Route(<span class="hljs-string">"api/v{version:apiVersion}/[controller]"</span>)</span>]
</code></pre>
<h4 data-id="heading-32">统一响应格式</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">return</span> Ok(<span class="hljs-keyword">new</span> { Data = result, Message = <span class="hljs-string">"Success"</span> });
</code></pre>
<h3 data-id="heading-33">资源和文档</h3>
<ul>
<li>
<p>官方文档：</p>
<ul>
<li>
<p><code>Microsoft Learn</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Faspnet%2Fcore%2Fmvc%2Fcontrollers" target="_blank" title="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/aspne…</a></p>
</li>
<li>
<p><code>ControllerBase</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fdotnet%2Fapi%2Fmicrosoft.aspnetcore.mvc.controllerbase" target="_blank" title="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.controllerbase" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/dotne…</a></p>
</li>
</ul>
</li>
<li>
<p><code>NuGet</code> 包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nuget.org%2Fpackages%2FMicrosoft.AspNetCore.Mvc.Core" target="_blank" title="https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Core" ref="nofollow noopener noreferrer">www.nuget.org/packages/Mi…</a></p>
</li>
<li>
<p><code>GitHub</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdotnet%2Faspnetcore" target="_blank" title="https://github.com/dotnet/aspnetcore" ref="nofollow noopener noreferrer">github.com/dotnet/aspn…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在重复造轮子？掌握这7个原则，让你的Vue组件复用性飙升！]]></title>    <link>https://juejin.cn/post/7571355146770251818</link>    <guid>https://juejin.cn/post/7571355146770251818</guid>    <pubDate>2025-11-11T23:25:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146770251818" data-draft-id="7571334572768804907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在重复造轮子？掌握这7个原则，让你的Vue组件复用性飙升！"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-11T23:25:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在重复造轮子？掌握这7个原则，让你的Vue组件复用性飙升！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T23:25:27.000Z" title="Tue Nov 11 2025 23:25:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是经常遇到这样的情况：每次开始新项目，都要把之前的组件复制粘贴一遍，然后修修补补？或者在团队协作时，发现同事写的组件根本没法直接用，只能重写？</p>
<p>说实话，这种重复劳动真的挺浪费时间的。不过别担心，今天我就来分享7个编写高复用性Vue组件的核心原则。掌握了这些，你的开发效率至少能提升一倍！</p>
<p>读完这篇文章，你会获得一套完整的组件设计思路，从设计理念到具体实现，还有可以直接复用的代码示例。准备好了吗？让我们开始吧！</p>
<h2 data-id="heading-0">原则一：单一职责，让组件更专注</h2>
<p>一个组件应该只做好一件事。就像餐厅里的厨师，有人专门切菜，有人专门炒菜，各司其职才能高效运作。</p>
<p>想象一下，如果一个组件既负责表单验证，又要处理数据请求，还要管UI展示，那它就会变得臃肿不堪，难以维护。我们来对比一下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的做法：职责过多</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div&gt;
      &lt;form @submit="handleSubmit"&gt;
        &lt;input v-model="formData.name" /&gt;
        &lt;button type="submit"&gt;提交&lt;/button&gt;
      &lt;/form&gt;
      &lt;div v-if="loading"&gt;加载中...&lt;/div&gt;
      &lt;div v-else&gt;{{ data }}&lt;/div&gt;
    &lt;/div&gt;
  `</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">formData</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> },
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-comment">// 这里混入了数据请求逻辑</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/submit'</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>)
      })
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<p>看到问题了吗？这个组件把表单展示、表单处理、数据请求全都混在一起了。正确的做法应该是：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 好的做法：职责单一</span>
<span class="hljs-comment">// FormComponent.vue - 只负责表单展示和基础交互</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;form @submit="$emit('submit', formData)"&gt;
      &lt;input v-model="formData.name" /&gt;
      &lt;button type="submit"&gt;提交&lt;/button&gt;
    &lt;/form&gt;
  `</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">formData</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> }
    }
  }
}

<span class="hljs-comment">// 在父组件中处理业务逻辑</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div&gt;
      &lt;FormComponent @submit="handleSubmit" /&gt;
      &lt;div v-if="loading"&gt;加载中...&lt;/div&gt;
      &lt;div v-else&gt;{{ data }}&lt;/div&gt;
    &lt;/div&gt;
  `</span>,
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">FormComponent</span> },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params">formData</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$api</span>.<span class="hljs-title function_">submit</span>(formData)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<p>这样拆分后，FormComponent就可以在任何需要表单的地方复用了，而业务逻辑则由父组件负责。</p>
<h2 data-id="heading-1">原则二：props设计要合理，让组件更灵活</h2>
<p>props是组件与外界通信的桥梁，设计好坏直接决定了组件的复用性。好的props设计应该像乐高积木一样，可以灵活组合。</p>
<p>先来看一个常见的按钮组件例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础按钮组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">type</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'default'</span>,
      <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> [<span class="hljs-string">'default'</span>, <span class="hljs-string">'primary'</span>, <span class="hljs-string">'danger'</span>].<span class="hljs-title function_">includes</span>(value)
    },
    <span class="hljs-attr">size</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'medium'</span>,
      <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> [<span class="hljs-string">'small'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'large'</span>].<span class="hljs-title function_">includes</span>(value)
    },
    <span class="hljs-attr">disabled</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
    },
    <span class="hljs-attr">loading</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;button 
      :class="['btn', `</span>btn-${type}<span class="hljs-string">`, `</span>btn-${size}<span class="hljs-string">`]"
      :disabled="disabled || loading"
    &gt;
      &lt;span v-if="loading" class="loading-spinner"&gt;&lt;/span&gt;
      &lt;slot&gt;&lt;/slot&gt;
    &lt;/button&gt;
  `</span>
}
</code></pre>
<p>这个设计已经不错了，但还可以更好。我们经常遇到需要传递原生HTML属性的情况，比如id、class、style等。这时候可以用<code>v-bind="$attrs"</code>来简化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">inheritAttrs</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁止自动绑定到根元素</span>
  <span class="hljs-attr">props</span>: {
    <span class="hljs-comment">// ... 其他props</span>
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;button 
      v-bind="$attrs"
      :class="['btn', `</span>btn-${type}<span class="hljs-string">`, `</span>btn-${size}<span class="hljs-string">`]"
      :disabled="disabled || loading"
    &gt;
      &lt;span v-if="loading" class="loading-spinner"&gt;&lt;/span&gt;
      &lt;slot&gt;&lt;/slot&gt;
    &lt;/button&gt;
  `</span>
}

<span class="hljs-comment">// 使用时就非常方便了</span>
&lt;<span class="hljs-title class_">MyButton</span> 
  id=<span class="hljs-string">"submit-btn"</span>
  <span class="hljs-keyword">class</span>=<span class="hljs-string">"custom-class"</span>
  type=<span class="hljs-string">"primary"</span>
  @click=<span class="hljs-string">"handleClick"</span>
  点击我
&lt;/<span class="hljs-title class_">MyButton</span>&gt;
</code></pre>
<h2 data-id="heading-2">原则三：巧用插槽，让内容更自由</h2>
<p>插槽是Vue组件复用的超级武器！它允许父组件向子组件传递任意内容，大大增强了组件的灵活性。</p>
<p>最基本的用法就是默认插槽：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Card组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="card"&gt;
      &lt;div class="card-header"&gt;
        &lt;slot name="header"&gt;&lt;/slot&gt;
      &lt;/div&gt;
      &lt;div class="card-body"&gt;
        &lt;slot&gt;&lt;/slot&gt; &lt;!-- 默认插槽 --&gt;
      &lt;/div&gt;
      &lt;div class="card-footer"&gt;
        &lt;slot name="footer"&gt;&lt;/slot&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  `</span>
}

<span class="hljs-comment">// 使用示例</span>
&lt;<span class="hljs-title class_">Card</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
  
  这里是卡片的主要内容，可以放任何东西
  
  &lt;template #footer&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>确定<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  &lt;/template&gt;
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p>但插槽的真正威力在于作用域插槽。它允许子组件向插槽内容传递数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 列表组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'items'</span>],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;ul class="list"&gt;
      &lt;li v-for="(item, index) in items" :key="item.id"&gt;
        &lt;slot :item="item" :index="index"&gt;&lt;/slot&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  `</span>
}

<span class="hljs-comment">// 使用示例</span>
&lt;<span class="hljs-title class_">List</span> :items=<span class="hljs-string">"userList"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ item, index }"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ index + 1 }}.<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.avatar"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"editUser(item)"</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">List</span>&gt;
</code></pre>
<p>这样，List组件只负责列表的渲染逻辑，而每个列表项的具体展示内容完全由父组件决定，复用性大大提升！</p>
<h2 data-id="heading-3">原则四：事件通信要清晰，让组件更独立</h2>
<p>组件之间的事件通信就像人与人之间的对话，要清晰明了。好的事件设计能让组件保持独立，便于复用。</p>
<p>先看一个常见的误区：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的做法：在组件内部直接修改props</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'value'</span>],
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleInput</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-comment">// 直接修改props，违反了单向数据流</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    }
  }
}
</code></pre>
<p>正确的做法是使用事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 好的做法：通过事件通信</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'modelValue'</span>], <span class="hljs-comment">// Vue 3中使用modelValue</span>
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleInput</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'update:modelValue'</span>, e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)
    }
  }
}

<span class="hljs-comment">// 使用v-model</span>
&lt;<span class="hljs-title class_">MyInput</span> v-model=<span class="hljs-string">"username"</span> /&gt;
</code></pre>
<p>对于复杂组件，我们可以设计更详细的事件体系：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 搜索组件示例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'keywords'</span>],
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleSearch</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'search'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">keywords</span>)
    },
    <span class="hljs-title function_">handleReset</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'reset'</span>)
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'update:keywords'</span>, <span class="hljs-string">''</span>)
    },
    <span class="hljs-title function_">handleInputChange</span>(<span class="hljs-params">value</span>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'update:keywords'</span>, value)
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'input-change'</span>, value)
    }
  }
}
</code></pre>
<h2 data-id="heading-4">原则五：组合式函数，让逻辑更复用</h2>
<p>Composition API是Vue 3的杀手级特性，它让我们可以更好地复用逻辑。把可复用的逻辑抽离成组合式函数，就像拥有了一个自己的工具库。</p>
<p>来看一个数据请求的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useApi.js - 数据请求逻辑复用</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useApi</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)
      data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    } <span class="hljs-keyword">catch</span> (err) {
      error.<span class="hljs-property">value</span> = err.<span class="hljs-property">message</span>
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-keyword">return</span> {
    data,
    loading,
    error,
    fetchData
  }
}

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { data, loading, error, fetchData } = <span class="hljs-title function_">useApi</span>(<span class="hljs-string">'/api/users'</span>)
    
    <span class="hljs-comment">// 组件挂载时自动获取数据</span>
    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">fetchData</span>()
    })
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userList</span>: data,
      loading,
      error
    }
  }
}
</code></pre>
<p>再来看一个表单验证的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useFormValidation.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFormValidation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> errors = <span class="hljs-title function_">ref</span>({})
  
  <span class="hljs-keyword">const</span> rules = {
    <span class="hljs-attr">required</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> !!value || <span class="hljs-string">'该字段是必填的'</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-regexp">/.+@.+\..+/</span>.<span class="hljs-title function_">test</span>(value) || <span class="hljs-string">'请输入有效的邮箱地址'</span>,
    <span class="hljs-attr">minLength</span>: <span class="hljs-function"><span class="hljs-params">min</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> 
      value.<span class="hljs-property">length</span> &gt;= min || <span class="hljs-string">`至少需要<span class="hljs-subst">${min}</span>个字符`</span>
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params">field, value, fieldRules</span>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rule <span class="hljs-keyword">of</span> fieldRules) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">typeof</span> rule === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_">rule</span>(value) : <span class="hljs-title function_">rule</span>(value)
      <span class="hljs-keyword">if</span> (result !== <span class="hljs-literal">true</span>) {
        errors.<span class="hljs-property">value</span>[field] = result
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }
    }
    <span class="hljs-keyword">delete</span> errors.<span class="hljs-property">value</span>[field]
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
  
  <span class="hljs-keyword">const</span> isValid = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> 
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(errors.<span class="hljs-property">value</span>).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>
  )
  
  <span class="hljs-keyword">return</span> {
    errors,
    rules,
    validate,
    isValid
  }
}
</code></pre>
<h2 data-id="heading-5">原则六：提供充分的配置能力</h2>
<p>一个高复用性的组件应该像瑞士军刀一样，能够适应各种使用场景。这就要求我们提供充分的配置能力。</p>
<p>看看这个图标组件的设计：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">size</span>: {
      <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>],
      <span class="hljs-attr">default</span>: <span class="hljs-string">'1em'</span>
    },
    <span class="hljs-attr">color</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">spin</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">rotate</span>: <span class="hljs-title class_">Number</span>
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">style</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-string">'number'</span> ? <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.size}</span>px`</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span>,
        <span class="hljs-attr">transform</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">rotate</span> ? <span class="hljs-string">`rotate(<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.rotate}</span>deg)`</span> : <span class="hljs-literal">null</span>
      }
    },
    <span class="hljs-title function_">className</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> [
        <span class="hljs-string">'icon'</span>,
        <span class="hljs-string">`icon-<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>,
        { <span class="hljs-string">'icon-spin'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">spin</span> }
      ]
    }
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;i :class="className" :style="style"&gt;&lt;/i&gt;
  `</span>
}
</code></pre>
<p>但有时候，仅仅靠props配置还不够。我们可以提供全局配置的能力：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建组件插件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponentPlugin</span> = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">app, options = {}</span>) {
    <span class="hljs-comment">// 合并默认配置和用户配置</span>
    <span class="hljs-keyword">const</span> config = {
      <span class="hljs-attr">size</span>: <span class="hljs-string">'medium'</span>,
      <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>,
      ...options
    }
    
    <span class="hljs-comment">// 提供全局配置</span>
    app.<span class="hljs-title function_">provide</span>(<span class="hljs-string">'my-component-config'</span>, config)
    
    <span class="hljs-comment">// 注册全局组件</span>
    app.<span class="hljs-title function_">component</span>(<span class="hljs-string">'MyComponent'</span>, <span class="hljs-title class_">MyComponent</span>)
  }
}

<span class="hljs-comment">// 在main.js中使用</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">MyComponentPlugin</span>, {
  <span class="hljs-attr">size</span>: <span class="hljs-string">'large'</span>,
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>
})
</code></pre>
<h2 data-id="heading-6">原则七：文档和类型提示要完善</h2>
<p>再好的组件，如果没有清晰的文档和类型提示，别人（包括未来的你）也很难使用。好的文档就像产品说明书，让使用者一目了然。</p>
<p>对于TypeScript用户，我们可以提供完整的类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> {
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">'default'</span> | <span class="hljs-string">'primary'</span> | <span class="hljs-string">'danger'</span>
  size?: <span class="hljs-string">'small'</span> | <span class="hljs-string">'medium'</span> | <span class="hljs-string">'large'</span>
  disabled?: <span class="hljs-built_in">boolean</span>
  loading?: <span class="hljs-built_in">boolean</span>
  onClick?: <span class="hljs-function">(<span class="hljs-params">event: MouseEvent</span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonSlots</span> {
  <span class="hljs-keyword">default</span>?: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VNode</span>[]
  icon?: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VNode</span>[]
}

<span class="hljs-comment">// Button.vue</span>
<span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ButtonProps</span>, <span class="hljs-title class_">ButtonSlots</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'MyButton'</span>,
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">type</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PropType</span>&lt;<span class="hljs-title class_">ButtonProps</span>[<span class="hljs-string">'type'</span>]&gt;,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'default'</span>
    },
    <span class="hljs-comment">// ... 其他props</span>
  } <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// Vue 3的类型定义方式</span>
  
  <span class="hljs-attr">emits</span>: {
    <span class="hljs-attr">click</span>: <span class="hljs-function">(<span class="hljs-params">event: MouseEvent</span>) =&gt;</span> <span class="hljs-literal">true</span>
  },
  
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props: ButtonProps, { slots, emit }</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params">event: MouseEvent</span>) =&gt; {
      <span class="hljs-keyword">if</span> (!props.<span class="hljs-property">disabled</span> &amp;&amp; !props.<span class="hljs-property">loading</span>) {
        <span class="hljs-title function_">emit</span>(<span class="hljs-string">'click'</span>, event)
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">{[</span>'<span class="hljs-attr">btn</span>', `<span class="hljs-attr">btn-</span>${<span class="hljs-attr">props.type</span>}`, `<span class="hljs-attr">btn-</span>${<span class="hljs-attr">props.size</span>}`]}
        <span class="hljs-attr">disabled</span>=<span class="hljs-string">{props.disabled</span> || <span class="hljs-attr">props.loading</span>}
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>
      &gt;</span>
        {slots.icon?.()}
        {slots.default?.()}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    )
  }
})
</code></pre>
<p>除了代码中的类型提示，我们还需要提供使用示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## MyButton 按钮组件</span>

<span class="hljs-section">### 基础用法</span>
<span class="hljs-code">```vue
&lt;MyButton @click="handleClick"&gt;点击我&lt;/MyButton&gt;
</span></code></pre>
<h3 data-id="heading-7">不同类型</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;MyButton type="primary"&gt;主要按钮&lt;/MyButton&gt;
&lt;MyButton type="danger"&gt;危险按钮&lt;/MyButton&gt;
</code></pre>
<h3 data-id="heading-8">不同尺寸</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;MyButton size="small"&gt;小按钮&lt;/MyButton&gt;
&lt;MyButton size="large"&gt;大按钮&lt;/MyButton&gt;
</code></pre>
<h3 data-id="heading-9">加载状态</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;MyButton loading&gt;加载中...&lt;/MyButton&gt;
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin">
## 实战：打造一个高复用性的模态框组件

现在，让我们把所有的原则应用起来，打造一个真正高复用性的模态框组件：

```javascript
<span class="hljs-comment">// Modal.vue</span>
export default {
  props: {
    modelValue: <span class="hljs-built_in">Boolean</span>, <span class="hljs-comment">// 控制显示隐藏</span>
    title: String,
    closable: {
      type: <span class="hljs-built_in">Boolean</span>,
      default: <span class="hljs-literal">true</span>
    },
    maskClosable: {
      type: <span class="hljs-built_in">Boolean</span>,
      default: <span class="hljs-literal">true</span>
    },
    showFooter: {
      type: <span class="hljs-built_in">Boolean</span>,
      default: <span class="hljs-literal">true</span>
    }
  },
  emits: [<span class="hljs-string">'update:modelValue'</span>, <span class="hljs-string">'close'</span>, <span class="hljs-string">'confirm'</span>, <span class="hljs-string">'cancel'</span>],
  
  methods: {
    close() {
      <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'update:modelValue'</span>, <span class="hljs-literal">false</span>)
      <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'close'</span>)
    },
    
    handleMaskClick() {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.maskClosable) {
        <span class="hljs-keyword">this</span>.close()
      }
    },
    
    handleConfirm() {
      <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'confirm'</span>)
      <span class="hljs-keyword">this</span>.close()
    },
    
    handleCancel() {
      <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'cancel'</span>)
      <span class="hljs-keyword">this</span>.close()
    }
  },
  
  template: `
    &lt;teleport to=<span class="hljs-string">"body"</span>&gt;
      &lt;div 
        v-<span class="hljs-keyword">if</span>=<span class="hljs-string">"modelValue"</span>
        <span class="hljs-keyword">class</span>=<span class="hljs-string">"modal-mask"</span>
        <span class="hljs-meta">@click</span>=<span class="hljs-string">"handleMaskClick"</span>
      &gt;
        &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"modal-wrapper"</span>&gt;
          &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"modal"</span> <span class="hljs-meta">@click</span>.stop&gt;
            &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"modal-header"</span>&gt;
              &lt;h3&gt;{{ title }}&lt;/h3&gt;
              &lt;button 
                v-<span class="hljs-keyword">if</span>=<span class="hljs-string">"closable"</span>
                <span class="hljs-keyword">class</span>=<span class="hljs-string">"close-btn"</span>
                <span class="hljs-meta">@click</span>=<span class="hljs-string">"close"</span>
              &gt;×&lt;/button&gt;
            &lt;/div&gt;
            
            &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"modal-body"</span>&gt;
              &lt;slot name=<span class="hljs-string">"body"</span>&gt;&lt;/slot&gt;
            &lt;/div&gt;
            
            &lt;div v-<span class="hljs-keyword">if</span>=<span class="hljs-string">"showFooter"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"modal-footer"</span>&gt;
              &lt;slot name=<span class="hljs-string">"footer"</span>&gt;
                &lt;button <span class="hljs-meta">@click</span>=<span class="hljs-string">"handleCancel"</span>&gt;取消&lt;/button&gt;
                &lt;button <span class="hljs-meta">@click</span>=<span class="hljs-string">"handleConfirm"</span>&gt;确定&lt;/button&gt;
              &lt;/slot&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/teleport&gt;
  `
}
</code></pre>
<p>这个模态框组件体现了我们讨论的所有原则：</p>
<ul>
<li>单一职责：只负责模态框的展示和行为</li>
<li>合理的props设计：提供了丰富的配置选项</li>
<li>灵活的插槽：允许自定义内容和底部区域</li>
<li>清晰的事件通信：提供了完整的事件体系</li>
<li>易于使用：提供了默认的底部按钮</li>
</ul>
<p>使用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础用法</span>
&lt;<span class="hljs-title class_">Modal</span> v-model=<span class="hljs-string">"showModal"</span> title=<span class="hljs-string">"提示"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个模态框<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Modal</span>&gt;

<span class="hljs-comment">// 自定义底部</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"showModal"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"自定义底部"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>自定义内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"customAction"</span>&gt;</span>自定义操作<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>编写高复用性的Vue组件，其实就是在寻找一种平衡：既要提供足够的功能，又要保持足够的简单；既要考虑当前的需求，又要预见未来的变化。</p>
<p>记住这7个原则，你的组件设计能力会有质的飞跃：</p>
<ol>
<li>单一职责 - 让组件更专注</li>
<li>合理设计props - 让组件更灵活</li>
<li>巧用插槽 - 让内容更自由</li>
<li>清晰的事件通信 - 让组件更独立</li>
<li>使用组合式函数 - 让逻辑更复用</li>
<li>提供充分配置 - 让组件更强大</li>
<li>完善文档提示 - 让使用更简单</li>
</ol>
<p>下次当你开始编写组件时，不妨问问自己：这个组件在未来可能被用在什么场景？其他人能否不看我代码就知道怎么使用？如果答案是否定的，那就回头看看这7个原则，相信你会找到改进的方向。</p>
<p>你在组件开发中还遇到过哪些棘手的问题？欢迎在评论区分享，我们一起讨论解决！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年的热门 AI 编程工具评测：Cursor、Claude Code、Codex、Lovable、v0 等]]></title>    <link>https://juejin.cn/post/7571272874847010868</link>    <guid>https://juejin.cn/post/7571272874847010868</guid>    <pubDate>2025-11-11T13:36:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874847010868" data-draft-id="7568669720430264372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年的热门 AI 编程工具评测：Cursor、Claude Code、Codex、Lovable、v0 等"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-11T13:36:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="莫尔索"/> <meta itemprop="url" content="https://juejin.cn/user/518625218016504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年的热门 AI 编程工具评测：Cursor、Claude Code、Codex、Lovable、v0 等
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/518625218016504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    莫尔索
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:36:46.000Z" title="Tue Nov 11 2025 13:36:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这是一篇关于 AI 编程工具的评测，由 Greg Isenberg 和 Mickey 对 2025 年的热门 AI 编程工具进行了排名和分析，他们讨论了这些工具对技术开发者和非技术构建者的适用性，并强调了选择工具时对团队和生态系统的信任的重要性。</p>
</blockquote>
<p>欢迎订阅合集 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg2OTk1NDQ4Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4221297752417992707%26subscene%3D%26scenenote%3Dhttps%253A%252F%252Fmp.weixin.qq.com%252Fs%252FX1JwNWhO9tjVQfh9Qq9uJw%26nolastread%3D1%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2OTk1NDQ4Ng==&amp;action=getalbum&amp;album_id=4221297752417992707&amp;subscene=&amp;scenenote=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX1JwNWhO9tjVQfh9Qq9uJw&amp;nolastread=1#wechat_redirect" ref="nofollow noopener noreferrer">AI 播客捕手</a>，专门面向文字内容爱好者分享 AI 领域优质播客！如需文字稿，后台私我获取，请务必备注（城市+行业+岗位+一句话介绍）。</p>
<h2 data-id="heading-0">四个层级</h2>
<p>把常见 AI 编程工具按<strong>好不好用＋信不信得过</strong>排成 S~D 四档，并点出每样东西最该记住的核心能力。下面按档次列出，先写排名，再写功能亮点与注意点，一眼就能对比。</p>
<h3 data-id="heading-1">S 档：闭眼选</h3>
<ol>
<li><strong>Cursor</strong>    - 定位：纯程序员编辑器，需会敲命令行。    - 核心能力：        – 社区教程最多，插件生态大。        – 自带 Agent，可一次完成读文件 → 改代码 → 跑测试。    - 团队公开说“主要为开发者服务”，非技术用户要有耐心。</li>
</ol>
<h3 data-id="heading-2">A 档：强烈考虑</h3>
<ol start="2">
<li><strong>v0（Vercel 出品）</strong></li>
</ol>
<ul>
<li>定位：不会代码也能做网页。    - 核心能力：        – 一键把组件丢进 Vercel 托管，域名、数据库全配好。        – 模板市场大，可复用现成区块。    - 记住：和 Vercel 深度绑定，用别家后端时要多一步导出。</li>
</ul>
<ol start="3">
<li><strong>Codex（OpenAI）</strong>    - 定位：网页版“对话式”生成代码，技术/非技术都能玩。    - 核心能力：        – GPT 系列模型更新最快，迭代肉眼可见。        – 支持把整段代码贴回去继续改，上下文窗口大。    - 记住：目前仍略逊于 Cursor 的 Agent 自动化程度。</li>
</ol>
<h3 data-id="heading-3">B 档：够用，看场景</h3>
<ol start="4">
<li><strong>Lovable</strong></li>
</ol>
<ul>
<li>定位：给“完全不会后端”的人做 SaaS 原型。    - 核心能力：        – 内置 Superb 后端，API 密钥自动帮你填好。        – 拖拽+提示词即可出管理后台、支付页。    - 记住：后端只能用它家指定的，灵活度低于 v0。</li>
</ul>
<ol start="5">
<li><strong>Bolt</strong></li>
</ol>
<ul>
<li>定位：和 Lovable 类似，主打“零配置全栈”。    - 核心能力：        – 一键生成前后台，支持 Supabase、Stripe 等常用集成。    - 记住：模板少，社区比 v0 小，复杂需求容易“卡壳”。</li>
</ul>
<ol start="6">
<li><strong>Replit</strong></li>
</ol>
<ul>
<li>定位：在线 IDE + 云端运行环境。    - 核心能力：        – 15 分钟“Agent 模式”自动把项目跑通。        – 支持多人实时协作，教育圈用户多。    - 记住：国内访问偶尔慢，商业项目要算运行时长费用。</li>
</ul>
<ol start="7">
<li><strong>移动端三件套：Rork / VibeCode App / Anything</strong> 移动端 AI 编程 应用    - 定位：手机原生 App 的“一句话生成”。    - 核心能力：        – 全部基于 Expo，一次输出 iOS 与 Android 双包。        – 内置广告、内购、推送模板，做付费订阅类 App 快。    - 记住：生态刚起步，出错信息比网页工具更难排。</li>
</ol>
<h3 data-id="heading-4">D 档：先观望</h3>
<ol start="8">
<li><strong>Windsurf</strong>    - 技术本身 B~A 水平，但创始人“跑路”后被收购，团队稳定性存疑，文章建议“暂时别押宝”。</li>
</ol>
<h2 data-id="heading-5">AI 编程工具功能总结（2025 版）</h2>








































































































<table><thead><tr><th>工具名称</th><th>排名</th><th>技术门槛</th><th>适用人群</th><th>核心功能与特点</th><th>优势与亮点</th><th>劣势与风险</th></tr></thead><tbody><tr><td><strong>Cursor</strong></td><td>S</td><td>高</td><td>技术开发者</td><td>AI 编程助手，支持代码补全、重构、调试、代理模式（Plan Mode）</td><td>社区庞大、教程丰富、代理能力强、Claude Sonnet 模型支持</td><td>对非技术用户不友好，需要理解代码结构</td></tr><tr><td><strong>v0</strong></td><td>S/A</td><td>低</td><td>非技术用户</td><td>Vercel 推出的前端生成工具，支持组件复用、模板、集成多种后端</td><td>与 Vercel 深度集成、组件市场丰富、适合快速原型开发</td><td>后端集成依赖第三方，灵活性略逊于 Cursor</td></tr><tr><td><strong>Claude Code</strong></td><td>A</td><td>高</td><td>技术开发者</td><td>Anthropic 推出的 AI 编程工具，支持文件读写、代码生成、调试</td><td>基于 Claude Sonnet 4.5，模型能力强</td><td>最近性能下降，代理能力不如 Cursor，更新频率低</td></tr><tr><td><strong>Codex</strong></td><td>A</td><td>中高</td><td>技术/非技术用户</td><td>OpenAI 的编程模型，支持网页端使用，集成于 Cursor 等平台</td><td>模型进步快，社区关注度高，OpenAI 背景强</td><td>起步较晚，功能尚不完善，略逊于 Claude Sonnet</td></tr><tr><td><strong>Lovable</strong></td><td>B</td><td>低</td><td>非技术用户</td><td>一键生成前后端项目，自动集成后端（如 Superbase）</td><td>上手快，适合不懂技术的用户快速构建应用</td><td>后端选择受限，扩展性差，稳定性一般</td></tr><tr><td><strong>Bolt</strong></td><td>B</td><td>低</td><td>非技术用户</td><td>类似 Lovable，支持快速生成 Web 应用，集成前后端</td><td>界面友好，适合快速原型</td><td>集成能力有限，社区支持较弱</td></tr><tr><td><strong>Replit</strong></td><td>B</td><td>中</td><td>技术/非技术用户</td><td>在线 IDE + AI 编程助手，支持代理模式，模型自研或集成外部模型</td><td>可在线运行项目，支持多语言，适合教学和原型开发</td><td>国内用户访问受限，AI 功能不如 Cursor 强大</td></tr><tr><td><strong>Chef (Convex)</strong></td><td>B</td><td>低</td><td>非技术用户</td><td>Convex 推出的展示型工具，用于演示其作为 AI 编程 后端的能力</td><td>后端能力强，实时数据库、订阅机制完善</td><td>非商业化产品，功能有限，主要用于展示 Convex 能力</td></tr><tr><td><strong>Rork / VibeCode App / Anything</strong></td><td>B</td><td>低</td><td>非技术用户</td><td>移动端 AI 编程 工具，支持生成 iOS/Android 应用，基于 Expo 框架</td><td>适合构建移动应用，快速上线 App Store / Google Play</td><td>工具尚新，功能不稳定，生态尚未成熟</td></tr><tr><td><strong>Windsurf</strong></td><td>D</td><td>高</td><td>技术开发者</td><td>技术强大的 AI 编程工具，支持复杂项目构建</td><td>技术能力强，曾受开发者欢迎</td><td>创始人“跑路”，被收购后团队不稳定，信任度极低</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">评估维度</h2>
<h3 data-id="heading-7">1. 技术门槛</h3>
<ul>
<li><strong>高</strong>：需理解代码结构、命令行操作（如 Cursor、Claude Code）</li>
<li><strong>低</strong>：通过自然语言提示即可生成应用（如 v0、Lovable）</li>
</ul>
<h3 data-id="heading-8">2. 用户群体</h3>
<ul>
<li><strong>技术开发者</strong>：偏好可控性、可扩展性、代码质量（如 Cursor）</li>
<li><strong>非技术构建者</strong>：偏好易用性、自动化、快速上线（如 v0、Lovable）</li>
</ul>
<h3 data-id="heading-9">3. 建议使用场景</h3>



































<table><thead><tr><th>用户类型</th><th>推荐工具</th><th>理由</th></tr></thead><tbody><tr><td>技术开发者</td><td><strong>Cursor</strong></td><td>功能最全，社区最强，支持复杂项目开发</td></tr><tr><td>非技术用户</td><td><strong>v0</strong></td><td>最易上手，支持组件复用，Vercel 集成好，适合快速原型</td></tr><tr><td>移动端开发者</td><td><strong>VibeCode App / Rork</strong></td><td>专注移动端，支持 Expo，适合快速发布 App</td></tr><tr><td>教育和初学者</td><td><strong>Replit</strong></td><td>在线运行，支持多语言，适合学习和实验</td></tr><tr><td>后端展示/集成</td><td><strong>Chef</strong></td><td>展示 Convex 后端能力，适合开发者了解实时数据库与订阅机制</td></tr></tbody></table>
<h2 data-id="heading-10">总结建议</h2>
<ul>
<li><strong>技术人员</strong>：首选 Cursor，其次可考虑 Claude Code 或 Codex。</li>
<li><strong>非技术人员</strong>：首选 v0，其次为 Lovable 或 Bolt。</li>
<li><strong>移动端构建者</strong>：可尝试 VibeCode App、Rork，但需接受其早期不稳定性。</li>
<li><strong>所有用户</strong>：选择工具时，不仅看功能，更要看团队与生态，避免“被 Windsurf”的风险。</li>
</ul>
<p>欢迎订阅合集 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg2OTk1NDQ4Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4221297752417992707%26subscene%3D%26scenenote%3Dhttps%253A%252F%252Fmp.weixin.qq.com%252Fs%252FX1JwNWhO9tjVQfh9Qq9uJw%26nolastread%3D1%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2OTk1NDQ4Ng==&amp;action=getalbum&amp;album_id=4221297752417992707&amp;subscene=&amp;scenenote=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX1JwNWhO9tjVQfh9Qq9uJw&amp;nolastread=1#wechat_redirect" ref="nofollow noopener noreferrer">AI 播客捕手</a>，专门面向文字内容爱好者分享 AI 领域优质播客！如需文字稿，后台私我获取，请务必备注（城市+行业+岗位+一句话介绍）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windsurf Codemaps 深度解析：重新定义 AI 时代的代码理解方式]]></title>    <link>https://juejin.cn/post/7571285984089243700</link>    <guid>https://juejin.cn/post/7571285984089243700</guid>    <pubDate>2025-11-11T13:37:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984089243700" data-draft-id="7569789282430009386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windsurf Codemaps 深度解析：重新定义 AI 时代的代码理解方式"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-11T13:37:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="莫尔索"/> <meta itemprop="url" content="https://juejin.cn/user/518625218016504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windsurf Codemaps 深度解析：重新定义 AI 时代的代码理解方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/518625218016504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    莫尔索
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:37:27.000Z" title="Tue Nov 11 2025 13:37:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当前主流的 AI 编程工具正引导开发者进入“Vibe 编码”（凭感觉编程）的误区，它们通过直接包办代码的阅读、思考和编写，增加了开发者与代码之间的隔阂。<strong>这种模式对于低价值的重复性任务尚可接受，但对于定义真正工程能力的、困难且敏感的高价值工作而言，是完全不可接受的。</strong> Cognition 公司(Devin 团队)推出了 <strong>Windsurf Codemaps</strong>，这是一种由 SWE-1.5 和 Claude Sonnet 4.5 驱动的、AI 注释的代码结构图，旨在帮助开发者更好地理解代码，从而提升开发效率。</p>
</blockquote>
<p>欢迎订阅合集 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg2OTk1NDQ4Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4243205243418624006%26subscene%3D159%26subscene%3D%26scenenote%3Dhttps%253A%252F%252Fmp.weixin.qq.com%252Fs%252F0Tdan3R8juUlj-Lh-QMmew%26nolastread%3D1%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2OTk1NDQ4Ng==&amp;action=getalbum&amp;album_id=4243205243418624006&amp;subscene=159&amp;subscene=&amp;scenenote=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Tdan3R8juUlj-Lh-QMmew&amp;nolastread=1#wechat_redirect" ref="nofollow noopener noreferrer">AI 博客精选</a>：精心编译海外技术厂商发布的高质量 AI 领域博客文章，其他合集：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg2OTk1NDQ4Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4243230891033935893%26subscene%3D159%26subscene%3D%26scenenote%3Dhttps%253A%252F%252Fmp.weixin.qq.com%252Fs%252FZcMiAmfNkmYLDgAu0rlb1Q%26nolastread%3D1%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2OTk1NDQ4Ng==&amp;action=getalbum&amp;album_id=4243230891033935893&amp;subscene=159&amp;subscene=&amp;scenenote=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZcMiAmfNkmYLDgAu0rlb1Q&amp;nolastread=1#wechat_redirect" ref="nofollow noopener noreferrer">AI 冷思考</a>：个人在 AI 狂欢下的冷思考，聚焦 AI 工程化、Agent Infra 产品、效率型 AI 工具和人机协作话题，寻找可持续的产业价值。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg2OTk1NDQ4Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4221297752417992707%26subscene%3D%26scenenote%3Dhttps%253A%252F%252Fmp.weixin.qq.com%252Fs%252FX1JwNWhO9tjVQfh9Qq9uJw%26nolastread%3D1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg2OTk1NDQ4Ng==&amp;action=getalbum&amp;album_id=4221297752417992707&amp;subscene=&amp;scenenote=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX1JwNWhO9tjVQfh9Qq9uJw&amp;nolastread=1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI 播客捕手</a>：专门面向文字内容爱好者分享 AI 领域优质播客。</li>
</ul>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><strong>为什么需要 Codemaps？代码理解的挑战</strong></li>
<li><strong>Windsurf Codemaps 的解决方案</strong></li>
<li><strong>停止 Vibe coding：开发者应理解 AI 生成的代码</strong></li>
<li><strong>个人思考</strong></li>
</ul>
<h2 data-id="heading-1">为什么需要 Codemaps？代码理解的挑战</h2>
<p>正如 Paul Graham 所言：“你的代码就是你对所探索问题的理解。因此，只有当你的代码真正进入你的脑海时，你才算真正理解了问题。” 软件开发只有在理解的基础上才能升华为工程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc0b8e03ea6d4c1fa4b12e8fe1bf6f30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5bCU57Si:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473046&amp;x-signature=CdMIio17CPsb9YVgunc93uvfKHs%3D" alt="代码理解" loading="lazy"/></p>
<p>现代代码库日益庞杂：动辄成百上千的文件、多个服务系统、层层嵌套的密集抽象。根据 Cognition 团队的自身经验以及与财富 500 强客户的深入交流，即便是顶尖的开发者，也需要花费大量的深度工作时间来寻找和记住那些真正重要的代码。：</p>
<ul>
<li>新开发者需要 <strong>3 到 9 个月</strong> 才能完全上手。</li>
<li>高级开发者每周要花费 <strong>5 个多小时</strong> 来帮助他人上手代码。</li>
<li>Stripe 的研究发现，遗留代码的维护是其客户生产力下降的第一大拖累。</li>
</ul>
<p>“上手”甚至不是一次性成本，每次切换上下文和代码库时，你都需要重新支付这个成本。这正是 AI 编码工具尚未解决的问题。<strong>你越快、越好地理解你的代码库，你就能越快、越好地自己修复它，或者提示 AI Agent 来修复它。</strong></p>
<p>直到今天，Github Copilot、Claude Code、Codex 乃至 Windsurf Cascade 的标准方法，都是让你在一个典型的聊天界面中，向一个能够访问你代码的 Agent 提问，但这些解决方案并不能解决<strong>针对性入门指引和扎实的代码理解</strong>问题，而这两者对于上手、调试和为代码库进行更好的上下文工程至关重要。</p>
<h2 data-id="heading-2">Windsurf Codemaps 的解决方案</h2>
<p>Codemaps 的核心是为任何特定问题提供<strong>即时映射(Just-in-Time mapping)</strong> 。当你在 Windsurf 中打开一个代码库，并通过新图标或快捷键（<strong>Cmd+Shift+C</strong>）首次打开 Codemaps 时，你可以输入一个关于你正试图执行的任务的提示（prompt），或者采纳自动建议。你可以选择 <strong>Fast</strong> (SWE-1.5) 或 <strong>Smart</strong> (Sonnet 4.5) 模型来生成你的 Codemap。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8be469d3bb524673b07166f547b0a262~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5bCU57Si:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473046&amp;x-signature=wdnRHp4b1eZ%2BIh36dk12RhMHJu0%3D" alt="" loading="lazy"/></p>
<p>Codemaps 提供了多种方式来帮助理解：</p>
<p>1.  <strong>列表与跳转</strong>：Codemaps 会将与你问题相关的代码部分进行分组和嵌套展示，Codemaps 中的答案会链接到了代码的确切行，你可以快速跳转浏览这些代码。     <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d03c24f26d842d0a9e2511247300baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5bCU57Si:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473046&amp;x-signature=4htygmHLwDNqVQJz3Q3O1OQ8nTI%3D" alt="列表与跳转" loading="lazy"/> 2.  <strong>可视化地图</strong>：可视化绘制的 Codemap，这是一个动态生成的图表，当你点击图中的各个节点时，它们会执行相同的功能，将你带到你所点击的代码库的确切部分。     <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0964392a8bed407287636463d902c1b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5bCU57Si:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473046&amp;x-signature=FFiBKED50diD2WOCgHofV0uaI%2Fk%3D" alt="可视化地图" loading="lazy"/> 3.  <strong>追踪指南</strong>：如果你需要更多上下文，可以点击任何部分的查看更多来展开追踪。它会提供更具描述性的解释，说明 AI 是如何将这些被发现的代码行组织在一起的。     <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d99021648e4e058326155ed7dc0a64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5bCU57Si:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473046&amp;x-signature=xy4B6OclTz63ZpFl5thE4LP5Q2I%3D" alt="追踪指南" loading="lazy"/> 4.  <strong>与 Cascade Agent 集成</strong>：可以在 Cascade 聊天中，通过 <code>@{codemap}</code> 语法（可以引用整个地图或特定子部分）来引用一个 Codemap。这能为你的任务提供更具体的上下文，从而“显著提高”Agent 的性能。</p>
<h2 data-id="heading-3">停止 Vibe coding：开发者应理解 AI 生成的代码</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f78a797ba44e809442834f883f88a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5bCU57Si:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473046&amp;x-signature=qqudn5V0egLa5CfNzX5y2WnN7bs%3D" alt="" loading="lazy"/></p>
<p><strong>Vibe coding（氛围编码）</strong> 已严重偏离其初衷，演变为对 AI 生成的劣质代码的盲目推崇。观察高效与低效的 AI 辅助编码者，可以发现一个关键区别：高效者能够基于对代码的深刻理解，“驾驭”由此产生的直觉（surf the vibes）；而当开发者所生成和维护的代码超出其理解能力时，问题便随之而来。</p>
<p><strong>“理解”即意味着“负责”</strong> 。随着 AI 承担越来越多基础性编码任务，开发者面临的挑战也日益复杂：调试系统、重构遗留代码、制定架构决策——这些工作都要求真正的深度理解。在这一背景下，开发者的角色正从“代码编写者”向“责任承担者”转变。你或许不再亲手编写每一行代码，但仍必须对你交付的成果负责。</p>
<p>这种责任感，取决于你是否真正理解 AI 生成的内容、其修改逻辑以及潜在的安全风险。Codemaps 正是为弥合这一鸿沟而设计：它为人与 AI 构建了一个关于系统的共享上下文——清晰展现系统的结构、数据流动路径和关键依赖关系。其目标远不止提升速度，它的核心使命是帮助开发者维持“心流”状态，掌控代码全局，并在应对最棘手问题时更高效、更自信地推进，避免交付任何未经理解的代码。</p>
<p>人机协作的历史表明，协同效应往往能超越“仅靠人类”或“仅靠 AI”的独立表现。开发者最青睐的 AI 工具，是那些能够增强自身能力、助其在工作中表现更出色的产品，而不是那个试图用一个“粗制滥造的复制品”(sloppy facsimile) 来取代他们的产品。</p>
<h2 data-id="heading-4">个人思考</h2>
<h3 data-id="heading-5">即时映射的代码理解流程</h3>
<p>从 Codemaps 的功能中，可以抽象出一个用于深度理解代码的“即时映射”框架，它强调的不是预先生成所有文档，而是在需要时生成针对特定任务的结构化代码：</p>
<p>1.  <strong>意图驱动</strong>：流程的起点不是文件树，而是开发者的意图或任务。用户通过一个具体的提示来启动 Codemaps，例如“追踪用户登录请求的完整流程”或“找到处理支付失败逻辑的所有位置”。 2.  <strong>整合分析</strong>：系统根据任务需求，调用合适的模型（如用于快速定位的 SWE-1.5 或用于深度理解的 Sonnet 4.5）来扫描和分析整个代码库，挖掘出与意图相关的所有代码片段、依赖关系和数据流。 3.  <strong>结构化呈现</strong>：分析结果被组织成一个结构化地图，而不只是一段扁平的回答。     - <strong>列表视图</strong>：提供了一个可导航、可折叠的层级列表，将相关代码按逻辑（如文件、功能、调用链）分组和嵌套。     - <strong>可视化视图</strong>：为喜欢图形化思考的开发者提供一个节点-连线图，直观展示组件、服务或函数之间的依赖和交互关系。 4.  <strong>上下文丰富的追踪指南</strong>：区别于传统查找工具。每个部分都附带追踪指南，即 AI 提供的自然语言解释。它不仅告诉你“是什么”，还告诉你“为什么”，解释了这些代码片段是如何协同作用来完成上层任务的。 5.  <strong>人机协同的上下文工程</strong>：开发者可以将这个经过人类验证和筛选的代码 (<code>@{codemap}</code>) 作为高质量的、人类可读的上下文，反馈给 AI Agent。这极大提升了后续 AI Agent 执行任务（如编写新代码或修复 Bug）的准确性和相关性，形成一个<strong>理解 -&gt; 增强上下文 -&gt; 更优执行</strong>的闭环。</p>
<h3 data-id="heading-6">理解即责任</h3>
<p>Codemaps 所倡导理解即责任，它重塑了 AI 时代开发者的自我定位：</p>
<p>1.  <strong>拒绝 Vibe coding，拥抱掌控力</strong>：开发者要抵制 Vibe coding 的诱惑。高效的 Vibe 必须建立在对代码库的深刻理解之上。当生成的代码超越了你的理解范围时，你就失去了掌控力，并开始积累技术债务和风险。 2.  <strong>从作者演进为责任人</strong>：在 AI 辅助下，开发者的价值核心不再是亲手编写每一行代码，而是对最终交付的系统负责。你可能没有创作所有代码，但你必须理解所有代码（包括 AI 生成的），并对其正确性、安全性和可维护性负最终责任。 3.  <strong>共享上下文是协同的基石</strong>：高效的人机（或人与人）协作，依赖于一个共享上下文。代码库太复杂，无法装进任何一个人的大脑。Codemaps 这样的工具，其价值在于为人和 AI Agent 提供了一个共同的、可视化的、可讨论的上下文。这个共享上下文是消除误解、精确传达意图、让人类和 AI 协同解决高难度问题的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果上线App Store Web版本，以后浏览外区更方便了]]></title>    <link>https://juejin.cn/post/7571102074039386153</link>    <guid>https://juejin.cn/post/7571102074039386153</guid>    <pubDate>2025-11-11T13:46:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074039386153" data-draft-id="7571306072422711338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果上线App Store Web版本，以后浏览外区更方便了"/> <meta itemprop="keywords" content="Apple,iOS"/> <meta itemprop="datePublished" content="2025-11-11T13:46:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CocoaKier"/> <meta itemprop="url" content="https://juejin.cn/user/4388906146735864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果上线App Store Web版本，以后浏览外区更方便了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906146735864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CocoaKier
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:46:46.000Z" title="Tue Nov 11 2025 13:46:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近期，苹果低调上线了<strong>网页版 App Store</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn" target="_blank" title="https://apps.apple.com/cn" ref="nofollow noopener noreferrer">apps.apple.com/cn</a>）</p>
<p><strong>只要打开浏览器，用户就可以浏览AppStore了，即便非苹果设备也能访问，但目前只能浏览、搜索，不支持在网页端下载 app</strong>。</p>
<p><strong>网页版的一个亮点是支持快速切换区域，我们只需修改网页地址中的区域代码即可快速浏览其他地区的 App Store 内容</strong>。这对于竞品分析，特别是出海产品的竞品分析，带来了非常大的便利，可以更方便快捷地查看某个国家地区的榜单，同类型应用有哪些，某个应用在不同地区的可用性、价格、评分、评论情况。</p>
<p>中国大陆 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2F" target="_blank" title="https://apps.apple.com/cn/" ref="nofollow noopener noreferrer">apps.apple.com/cn/</a><br/>
中国香港：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fhk%2F" target="_blank" title="https://apps.apple.com/hk/" ref="nofollow noopener noreferrer">apps.apple.com/hk/</a><br/>
中国台湾：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Ftw%2F" target="_blank" title="https://apps.apple.com/tw/" ref="nofollow noopener noreferrer">apps.apple.com/tw/</a><br/>
中国澳门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fmo%2F" target="_blank" title="https://apps.apple.com/mo/" ref="nofollow noopener noreferrer">apps.apple.com/mo/</a><br/>
新加坡 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fsg%2F" target="_blank" title="https://apps.apple.com/sg/" ref="nofollow noopener noreferrer">apps.apple.com/sg/</a><br/>
日本 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fjp%2F" target="_blank" title="https://apps.apple.com/jp/" ref="nofollow noopener noreferrer">apps.apple.com/jp/</a><br/>
韩国 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fru%2F" target="_blank" title="https://apps.apple.com/ru/" ref="nofollow noopener noreferrer">apps.apple.com/ru/</a><br/>
美国 <a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2F" target="_blank" title="https://apps.apple.com/us/" ref="nofollow noopener noreferrer">apps.apple.com/us/</a></p>
<p>更多地区代码见<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2FISO%25203166-1%2F5269555%3Ffr%3Dge_ala" title="https://link.juejin.cn?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2FISO%25203166-1%2F5269555%3Ffr%3Dge_ala" target="_blank">《ISO 31666-1》</a>中的两位字母改小写。</p>
<p>Web版本几乎就是复刻了App端的样式。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2fa8c5878944e879437a2fa3533871b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29jb2FLaWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473606&amp;x-signature=fslwwQZOqJ%2BImPUlmx0Fq96VX44%3D" alt="图片" title="null" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f89e4d3fe834451ac9268d7368c04f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29jb2FLaWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473606&amp;x-signature=xZfr%2Fo2sXyzqQQBcT9p5QTawXHM%3D" alt="图片" title="null" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f514abd4d7794f15a774ddd85d0df2bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29jb2FLaWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473606&amp;x-signature=aMSXnXgWCEsYd3arCn61eB34%2F3s%3D" alt="图片" title="null" loading="lazy"/></p>
<p>Web版还支持切换到特定设备端进行浏览
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6620a847b1c4a09b389d13d29f88d91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29jb2FLaWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763473606&amp;x-signature=TDO14fsElZMLCRT7exxwYmj7%2Bss%3D" alt="图片" loading="lazy"/></p>
<p><strong>Web版有啥使用场景？</strong></p>
<p><strong>1、竞品分析</strong><br/>
这个应该是它最大的价值，上文提到过，Web版可以方便快捷地浏览不同国家地区的商店页面。在此之前，我们可能需要借助第三方平台（比如 点点数据）才能实现，第三方平台的缺点：步骤繁琐（需要登录）、网页加载慢、数据延迟、部分数据VIP解锁。</p>
<p><strong>2、浏览特定设备端（Mac、iPad、Vision、Watch）商店</strong><br/>
以前，想看下某个产品（或者自家产品）有没有上Mac端，你首先得有一台Mac M系列芯片的电脑；<br/>
以前，想看下商店5图在iPad端的呈现效果，首先你得有一台iPad；<br/>
以前，作为独立开发，你可能想了解下iWatch上都有哪些产品，首先你得有一台iWatch；<br/>
Vision，更别说了...</p>
<p>现在，你只需要打开浏览器，切换一下左边的设备专区，不花一分钱，上面的这些都搞定！</p>
<p><strong>3、安卓和Windows也可以浏览AppStore了</strong><br/>
假如你是产品经理或者运营，你做调研需要浏览器AppStore，但你只有安卓手机和Windows电脑，以后不用再找同事借苹果手机了。</p>
<p><strong>4、更快速的分享应用（商店地址）</strong><br/>
运营时不时找我要公司产品的AppStore商店地址，以前我要么去自己存的xx.txt中找，要么打开点点数据搜应用，再点到苹果的商店页面，把浏览器URL复制给运营。现在好了，我可以直接打开App Store Web版，搜应用，然后把浏览器URL发给他们。或者我干脆告诉他们，你们自己去搜吧！</p>
<p><strong>5、更大的屏幕、更方便的操作</strong><br/>
电脑端浏览AppStore，有更大的屏幕、更方便的操作（键盘打字），无论是竞品分析，还是纯自己想找找新应用或游戏，都有更好的浏览和操作体验。这就是手机端腾讯视频和Web端腾讯视频的区别。</p>
<p><strong>6、爬虫门槛更低了</strong><br/>
以前爬苹果的数据，要么使用苹果官方的API（功能有限），要么破解App Store App抓包。现在Web版出来了，爬数据更方便了。</p>
<p><strong>结语</strong></p>
<p>苹果上线App Store Web版，不知道是出于什么目的，几方欢喜几方愁吧。对于开发者和用户更多的是便利，还是给苹果点个赞吧！</p>
<p>苹果上线App Store Web版，还闹出了点幺蛾子，感兴趣的可以看看：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy6qJA0mM55loshG74Zz4MQ" target="_blank" title="https://mp.weixin.qq.com/s/y6qJA0mM55loshG74Zz4MQ" ref="nofollow noopener noreferrer">《苹果又闹乌龙，App Store源码泄露》</a></p>
<p>相关阅读：<br/>
<a href="https://juejin.cn/post/7436939221392818210" target="_blank" title="https://juejin.cn/post/7436939221392818210">多地区发布，苹果商店下载链接怎么填</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[进入职场第四课—产出]]></title>    <link>https://juejin.cn/post/7571280402965233699</link>    <guid>https://juejin.cn/post/7571280402965233699</guid>    <pubDate>2025-11-11T13:48:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571280402965233699" data-draft-id="7571280402965217315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="进入职场第四课—产出"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-11T13:48:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapbarfront"/> <meta itemprop="url" content="https://juejin.cn/user/624178336632407"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            进入职场第四课—产出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178336632407/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapbarfront
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:48:57.000Z" title="Tue Nov 11 2025 13:48:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>新入职一家公司观察、融入、立足之后，要做的第四件事就是产出。</p>
<p>观察和融入帮你顺利度过新手期，立足则让你在团队中站稳脚跟，被大家真正接受，接下来你要做的是保持稳定，持续不断的产出，让团队感受到你究竟有多大能量。</p>
<p>易经乾卦中的终日乾乾，说的就是这个意思，终日指的是持续不断，意味着不能三天打鱼两天晒网，有了开头没有结尾，乾乾代表着产出，要有价值、有思考、有进阶，不能只做重复工作，毕竟在易经中，乾代表天，想完成立足到产出的关键跃升，以下这4个动作一定要做好。</p>
<p>1、产出有价值的成果。</p>
<p>立足期是你独立承担任务的开始，而产出期则需要你更进一步，持续负责有价值的工作。</p>
<p>如果你是应届新人，这个时候，需要逐渐摆脱掉新人的标签，进入团队常规战斗力的行列，这个过程因人而异，有的人很短，有的人很长，当然了，时间越短，横向对比，你在同届新人里也越突出。</p>
<p>如果你是职场老鸟，你的老板招你来，一定有他的预期，一定有他的安排，一定有他等着你完成的事，这个时候，你必须100%的体现出自己的价值，啃下这块硬骨头，完成老板安排的任务，匹配他招你来的预期，对你来说，老板等着你做的事就是有价值，把这件事做好，就是有成果。</p>
<p>2、按节奏做事，按章法出拳。</p>
<p>做事有节奏、有章法，说明你是成熟的职场人，无论是你的老板，还是团队内的其他同事，跟你配合起来都会更简单、更舒服。如果你总是一惊一乍，做事全凭心情，像个无头苍蝇一样到处乱撞，我相信谁也不会愿意和你合作。</p>
<p>分析、实施、复盘工作中，做事情的方法无非就是这3步，每个人不同的只是分析的多深，实施的多好，复盘的多透而已，按节奏做事，按章法出拳，一步一个脚印，稳中有进，比无脑的横冲直撞，那可是要强太多了。</p>
<p>3、沉淀加上分享，打造影响力</p>
<p>持续做好事情的同时，还要持续沉淀，持续分享，沉淀是为了总结经验，复盘整个过程，同时，也是为了提炼可复用的工作方法，提高今后的工作效率。</p>
<p>沉淀了，别人看不到也不行，大声的说出来，让大家都看到你的输出，你可能会想，这不是邀功，这不是汇报吗？还真不是，你的经验分享出来，可以帮助其他同事更好地处理，类似的工作场景，你的方法分享出来，或多或少，都能提高团队整体的工作效率。</p>
<p>光说不练假把式，光练不说傻把式，只沉淀不分享，或者没沉淀硬分享都不行，只有实打实的沉淀，不保留的分享，才能真正打造自己的影响力，也就是连说带练真把式。</p>
<p>四、成为团队中的正磁场。</p>
<p>每个人都有自己的磁场，人和人的磁场也各不相同，相互影响，相互传递能量，立足期想要站得稳，要主动结识团队中有正磁场的人，这也是见龙在田，利见大人的意思，产初期想要走得远，你自己要成为团队中的正磁场，成为那个可以利他的大人。</p>
<p>打工，想干的好，大的方向你必须顺着公司，顺着你的老板来，顺着来，的前提是，你要在心里先认可这个思路，认可了之后，你的言行举止，自然会向这个方向倾斜，遇到问题，你也会自然而然的去想办法解决，而不是下意识的找理由只抱怨，有了正磁场，相信团队里无论谁都感受得到。</p>
<p>除此之外，中日乾乾还有后半句，夕惕若厉，也就是除了持续不断的产出之外，还要时刻保持清醒，保持警惕，看看自己有没有跑偏，努力工作，产出成果是老板想要的，还是自嗨？做事情有节奏有章法，是自以为，还是收到了同事的正反馈？沉淀的是干货，还是敷衍了事？分享的好不好，还能不能再提高？</p>
<p>总之，终日乾乾，只有保持住稳定的产出，才能最终走得远，这也是你在团队中从被人看见，进阶到让人倚重的蜕变过程，夕惕若厉则是说产出期一般都比较长，保持耐心，保持警惕，把握分寸，稳中有进，别着急，这个阶段走的远，才能在下个阶段跳的高。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解读麦肯锡报告：Agent落地的六大经验教训]]></title>    <link>https://juejin.cn/post/7571303808116752436</link>    <guid>https://juejin.cn/post/7571303808116752436</guid>    <pubDate>2025-11-12T00:01:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571303808116752436" data-draft-id="7571272874847191092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解读麦肯锡报告：Agent落地的六大经验教训"/> <meta itemprop="keywords" content="前端,JavaScript,产品经理"/> <meta itemprop="datePublished" content="2025-11-12T00:01:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="华洛"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474430190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解读麦肯锡报告：Agent落地的六大经验教训
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474430190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    华洛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:01:49.000Z" title="Wed Nov 12 2025 00:01:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>麦肯锡报告解读：《One year of agentic AI: Six lessons from the people doing the work》</p>
<p>报告我帮你们看过了，我将报告核心洞察与我的亲身实践相融合，整理了6000字干货。</p>
<p>无论您是正在规划首个Agent（智能体）项目的决策者，还是身处一线的AI产品经理或开发者，希望这些内容为您拨开迷雾，指引方向。</p>
<p>内容与麦肯锡报告中的六大经验教训相结合，无论是你否在开发Agent都值得一看。</p>
<h2 data-id="heading-0">一：与智能体无关、与工作流程有关</h2>
<p>我们希望落地的智能体，通常有这样的一个定义：</p>
<p>智能体是一种基于生成式人工智能基础模型的系统，能够在现实世界中行动并执行多步骤流程。</p>
<p>智能体可以自动化执行复杂任务，而这些任务通常需要运用自然语言处理，且<strong>原本需要人类执行和处理</strong>。</p>
<p>让智能体代替人工，这就是我们追求的结果。</p>
<p>而在追求这个结果的过程中，我们更应该关注的是流程的变革，而不是智能体的落地。</p>
<p>再说一遍，不要着急落地智能体！流程不够完善的情况下，大概率会得到一个智障，而不是一个智能体。</p>
<p><strong>真正实现业务价值的关键是变革工作流</strong>。</p>
<p>错误思路：做个Agent实现企业当前的业务工作流程。</p>
<p>正确思路：围绕Agent把企业业务工作流程重新设计。</p>
<p>我们需重新设计涵盖人、流程、技术的完整工作流，先梳理流程、识别用户痛点，并设计智能体与人类的反馈协同机制。</p>
<ul>
<li>例如保险行业可通过规则系统、分析型 AI、生成式 AI 与智能体的组合，重构理赔等复杂工作流。</li>
</ul>
<p>在重新设计工作流程时，一个重要起点是<strong>绘制流程图</strong>并<strong>识别用户的痛点</strong>。</p>
<p>这一步在设计智能体系统时至关重要，这类系统能够减少不必要的工作，让智能体和人类得以协作，更高效、更有效地实现业务目标。</p>
<p>这种协作可以通过学习循环和反馈机制来实现，从而构建一个完善的Agent。</p>
<p>在Agent的众多落地应用技术中，能让团队在恰当的节点使用合适的技术，这在对复杂、多步骤的工作流程进行重新设计时尤为重要。</p>
<ul>
<li>如何设计提示词工程，大量提示词的组合、联动、迭代</li>
<li>要如何设计工具列表，function call 和 提示词如何结合</li>
<li>RAG系统如何在Agent中落地，应用在哪些节点，是否需要和function call结合使用</li>
<li>workflow应该如何设计，</li>
<li>微调是否有必要加入，要如何抉择</li>
</ul>
<p>等等内容，在恰当的节点使用合适的技术，我们的Agent才能达到我们的预期效果。</p>
<p>画三个重点，来说明一下Agent流程设计对于AI产品经理的重要性：</p>
<ol>
<li>
<p>对于AI产品经理来说，“这个需求我就要，怎么实现我不管”的年代彻底过去了。AI产品你必须要告知开发明确的流程实现，否则你什么都得不到。</p>
</li>
<li>
<p>AI产品经理要对AI产品的结果负责，在整个流程中的任意一个节点出现问题，都会导致输出结果差异巨大。所以清晰的指导智能体中每一个步骤的执行逻辑，更有助于对结果进行优化。</p>
</li>
<li>
<p>由于延续了大模型的特性，AI产品也具有一定的不可解释性，对于错误的结果，我们修正Agent流程，通常都是我们最后的手段。</p>
</li>
</ol>
<h2 data-id="heading-1">二：智能体并非总能解决问题（智能体的选择与协作）</h2>
<p>认真思考：<code>高方差（结果不稳定、不统一）、低标准化的任务</code>和<code>低方差、高标准化的任务</code>，哪一类任务更适合用Agent来代替人工。</p>
<p>我在做1V1培训的时候，AI产品的需求挖掘环节，一定要再三强调的一句话：<strong>当需求能用AI且只能用AI完成时，才是一个AI的需求</strong></p>
<p>这里有两个重点：能用AI 和 只能用AI</p>
<p>例如：</p>
<p><code>把固定格式的文案转换成JSON格式的信息</code>。这就是一个能用AI但不是只能用AI的需求，这就不是一个AI需求</p>
<p><code>把用户随机输入的query进行分类，然后按照不同类型转换成JSON格式的信息</code>。这就是一个真正的AI需求</p>
<p>当一个任务足够标准化的时候，我们应该更倾向于用固定的程序来执行，既保证准确性，又可以保证执行速度。</p>
<p>所以我们需根据任务特性选择工具，避免盲目使用智能体。</p>
<p><strong>低方差、高标准化的任务适合规则式自动化，高方差、低标准化的任务更适配智能体。</strong></p>
<p>此外，真正的生产环境中，任务通常不是非黑即白的，并不是要么有智能体，要么没有智能体的。</p>
<p>智能体的两层作用：帮助我们完成特定任务、帮助我们更好的开展工作。</p>
<p><strong>千万不要忽略协作的重要性</strong></p>
<ol>
<li>有些任务如果单纯的用程序实现，可能会耗费很多人力和时间成本。</li>
<li>有些任务无法完全使用程序实现，需要结合一小部分的大模型能力。</li>
</ol>
<p>在决策时需明确任务的标准化程度，考虑更简单的自动化方案（如 LLM 提示词），而非陷入 “非智能体即无智能体” 的二元思维。</p>
<h2 data-id="heading-2">三：杜绝 “AI 糟粕”，重视评估与信任</h2>
<p>很多智能体在演示中表现亮眼，但实际使用中输出质量低（即 “AI 糟粕”），导致用户信任流失。</p>
<p>是的，相信大家一定见过非常多了了，推广软文看了觉得这可太NB了，等体验完就发现不过又是一个垃圾桶里的东西罢了。</p>
<p>麦肯锡报告表示：AI产品需要有持续的测试、监督才能确保效果，保证不断进步，需像培养员工一样培育智能体，明确其 “岗位职责”，通过细化的评估标准（如任务成功率、检索准确率、幻觉率）持续优化，专家需全程参与测试，避免 “一上线就不管”。</p>
<p><strong>以下是在决定为不同任务使用哪种人工智能工具时的指南：</strong></p>
<ul>
<li>如果任务是基于规则且重复性的，并且有结构化输入（例如数据录入），请使用基于规则的自动化。</li>
<li>如果输入是非结构化的（例如，冗长的文档），但任务仍然是抽取式或生成式的，请使用生成式人工智能、自然语言处理或预测分析。</li>
<li>如果任务涉及根据过往数据进行分类或预测，请使用预测分析或生成式人工智能。</li>
<li>如果输出需要综合、判断或创造性解读，请使用生成式人工智能。</li>
<li>如果任务涉及多步骤决策，并且存在大量输入和上下文高度可变的情况，请使用AI智能体。</li>
</ul>
<p><strong>以下是一些用于评估智能体性能的典型评估方法：</strong></p>
<ol>
<li>任务成功率（端到端）。任务成功率衡量的是无需升级处理或人工干预即可正确完成的工作流所占的百分比，这反映了实际应用价值。</li>
</ol>
<ul>
<li>F1分数/精确率和召回率。该指标平衡了假阳性和假阴性，使其在分类、提取以及具有明确可衡量结果（即是或否）的决策准确性任务中非常有用。</li>
<li>检索准确性。检索准确性是指检索到的正确文档、事实或证据相对于基准数据集的百分比，这对于检索增强型工作流程至关重要。</li>
<li>语义相似度。语义相似度是通过生成输出与参考输出之间基于嵌入的余弦相似度来衡量的，它捕捉的是超越精确词语匹配的意义对齐。</li>
</ul>
<ol start="2">
<li>将大语言模型（LLM）用作评判者，就是根据黄金标准或人类偏好来评估输出结果。这一指标在用于评估清晰度、有用性和推理合理性等主观性判断时，具有很好的可扩展性。</li>
</ol>
<ul>
<li>偏差检测（通过混淆矩阵）。偏差检测利用混淆矩阵来衡量不同用户群体在结果上的系统性差异，这些矩阵能凸显偏差的表现之处（例如，假阴性对某一群体的影响过大）。</li>
<li>幻觉率。该指标用于跟踪事实错误或无依据声明的出现频率，以确保智能体输出内容的可信度。</li>
<li>校准误差（置信度与准确度）。校准误差用于衡量智能体的置信度分数是否与实际正确性相符，这在对风险敏感的工作流程中十分重要。</li>
</ul>
<h2 data-id="heading-3">四：让追踪和验证每一步都变得简单</h2>
<p>当企业仅部署少数智能体时，人工排查错误尚可应对；但随着智能体数量增至数百、数千个，仅追踪最终结果的传统方式，会让错误定位变得如同 “大海捞针”。</p>
<p>因此我们需在工作流中嵌入监控与评估机制，实时验证每一步表现。</p>
<p>这里我们额外说说，如何实现一个AI产品的评估反馈系统。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc8dbb6b78ec448389f5996a2665c9f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763510509&amp;x-signature=rjD8ZrOAm%2BWv9eSge5pi5Reg53g%3D" alt="pinggu.jpg" width="100%" loading="lazy"/>
<p>评估反馈系统是AI产品的三个辅助系统之一，主要目标是长期持续的监控我们的AI产品。</p>
<p>为什么会有这样的一个辅助系统？</p>
<p>主要原因是：AI产品出现问题后具有非常强的隐蔽性。</p>
<p>例如：现在线上跑着我们调试好的客服机器人，但是假设当前时间我们的机器人出问题了，它在跟我们的用户闲聊、扯淡，但是就是不回答它应该回答的问题。</p>
<ul>
<li>我们的客服是否还在正常回复问题</li>
<li>我们的客服是否越权了</li>
<li>我们的客服是否泄露隐私信息了</li>
<li>等等....</li>
</ul>
<p>如果没有反馈，我们就无法知道是否发生了这样的事情。</p>
<p>就像传统的产品，404了、502了、程序崩溃了，这些都有监控系统随时通知，我们AI对话也需要有监控系统。</p>




























































<table><thead><tr><th>维度</th><th>细分指标/场景</th><th>具体说明/工具/指标</th></tr></thead><tbody><tr><td>准确性</td><td>明确的答案</td><td>测试数据集的query与answer直接比对</td></tr><tr><td/><td>非明确答案</td><td>测试数据集的query、参考文案、打分体系；使用BLEU（词汇匹配度）、ROUGE（摘要质量）评估</td></tr><tr><td>响应时间</td><td>首包响应时间</td><td>大模型最终回复的模型，影响用户体验</td></tr><tr><td/><td>平均响应时长</td><td>宏观把控响应效率</td></tr><tr><td/><td>报警逻辑</td><td>一段时间内，出现的百分比累计出现次数（如5分钟内，出现了50%/80次）</td></tr><tr><td>执行节点信息</td><td>错误原因分析</td><td>保留每个节点的执行信息，分为大模型原因（错误码、提示词）、程序原因（json格式兼容）、环境原因（502）</td></tr><tr><td>消耗</td><td>调用次数</td><td>成功次数、失败次数</td></tr><tr><td/><td>RPM</td><td>每分钟请求数，体现单位时间请求负载</td></tr><tr><td/><td>TPM</td><td>每分钟Token数，衡量文本处理吞吐量</td></tr><tr><td/><td>tokens</td><td>文本处理的基础单元消耗数量，关联成本与性能</td></tr></tbody></table>
<h2 data-id="heading-4">五：优先打造可复用智能体</h2>
<p>为单个任务单独开发智能体会造成冗余浪费，应聚焦可复用性。</p>
<p>识别重复出现的任务，构建集中化的资源平台（含验证服务、可复用代码、训练材料等），让智能体组件能跨工作流使用，可减少 30%-50% 的非必要工作。</p>
<p>识别重复性任务是一个很好的起点。企业可以开发能在不同工作流中轻松复用的智能体及智能体组件，并让开发者能便捷地使用它们。</p>
<p>这包括开发一套集中化的经过验证的服务（如大模型可观测性或预先批准的提示词）和资产（例如，应用模式、可复用代码和培训材料），这些服务和资产要易于查找和使用。</p>
<p>将这些功能整合到一个单一平台中至关重要。根据我们的经验，这有助于减少通常所需的30%到50%的非必要工作。</p>
<p><strong>哦豁，中台再次浮出水面，世界果然是个圈</strong></p>
<p>还是建议大家利用中台来统一管理大模型、提示词、知识库、function call、智能体、测试、评估、日志、权限等。</p>
<p>无论是单部门要开发多智能体、还是多部门要各自开发智能体或者使用大模型。都由中台统一提供大模型的基础能力。</p>
<p>提示词的版本迭代，测试，等操作也完全又提示词工程师在中台完成即可，一套做完，全公司可用。</p>
<h2 data-id="heading-5">六：人类仍不可或缺，角色与规模将改变</h2>
<p><strong>人类尚有存在的必要。工作流的设计，一定要考虑人类加入工作的便捷性</strong></p>
<p>随着人工智能智能体的不断增多，人类将扮演何种角色这一问题引发了诸多焦虑，</p>
<p>一方面是对工作安全性的担忧，另一方面则是对生产力提升的过高期望。</p>
<p>这导致人们对当今许多工作中人类的角色产生了截然不同的看法。</p>
<p>智能体无法完全替代人类，人类需负责监督模型准确性、处理边缘案例、确保合规等。</p>
<p>工作流变革后，特定流程的人力规模可能下降，但<strong>需重新设计人机协作模式</strong>，</p>
<p>比如通过简洁的可视化界面提升交互效率，明确人类在关键决策中的最终把控权（如律师审核智能体整理的案件核心信息）。</p>
<p>人机协作设计的一个重要部分是开发简单的可视化用户界面，让人们能够轻松与智能体交互。</p>
<p>回到最开始，我们说过要围绕Agent把企业业务工作流程重新设计。现在要再加上一句话工作流程重新设计时，要充分考虑人机协作的必要性和便利性。</p>
<h2 data-id="heading-6">结语</h2>
<p>Agent的成功，绝非仅仅是技术模型的胜利，而是一场关于工作流程、人机协作与组织变革的系统性工程。</p>
<p>Agent的规模化落地将不再是少数科技巨头的游戏，而是每一个致力于智能化转型企业的必修课。 前方的道路已然清晰：</p>
<p>对于决策者，首要任务是为这场变革扫清障碍，投资于可复用的平台建设，并推动跨部门的流程重塑。</p>
<p>对于AI产品经理与开发者，需要兼具技术理解与业务洞察，成为连接智能世界与真实需求的桥梁，用严谨的流程设计和细致的评估体系，将Agent的潜力转化为实实在在的业务价值。</p>
<p>这场由Agent引领的变革，其终点并非一个“无人化”的工厂，而是一个人机协同、高效共进的新工作范式。</p>
<p>现在，正是我们放下对技术的盲目崇拜，回归业务本质，用智慧和匠心去设计和构建这一新范式的最佳时机。</p>
<p>我是华洛，关注我，学习更多AI落地的实战经验与技巧。</p>
<p>加油，共勉。</p>
<blockquote>
<p>☺️你好，我是<strong>华洛</strong>，All in AI多年，专注于AI在产品侧的落地与应用和全自动化AI员工的研发。</p>
<p>你可以在这里联系我👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fhualuo-fztnr%2Frnkfkn%2Fhgg1ai826tm55vxs%3FsingleDoc%23" title="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fhualuo-fztnr%2Frnkfkn%2Fhgg1ai826tm55vxs%3FsingleDoc%23" target="_blank">www.yuque.com/hualuo-fztn…</a></p>
</blockquote>
<h2 data-id="heading-7">专栏文章</h2>
<p><a href="https://juejin.cn/post/7512332419203727371" target="_blank" title="https://juejin.cn/post/7512332419203727371"># 聊聊我们公司的AI应用工程师每天都干啥？</a></p>
<p><a href="https://juejin.cn/post/7547051639740743721" target="_blank" title="https://juejin.cn/post/7547051639740743721"># SEO还没死，GEO之战已经开始</a></p>
<p><a href="https://juejin.cn/post/7497890801348821055" title="https://juejin.cn/post/7497890801348821055" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南二：RAG工程落地之数据处理篇🧐</a></p>
<p><a href="https://juejin.cn/post/7496397558358900790" title="https://juejin.cn/post/7496397558358900790" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南一：根据产品需求和定位进行agent流程设计🧐</a></p>
<p><a href="https://juejin.cn/post/7492271537010671635" title="https://juejin.cn/post/7492271537010671635" target="_blank"># 聊一下MCP，希望能让各位清醒一点吧🧐</a></p>
<p><a href="https://juejin.cn/post/7485727472999579659" title="https://juejin.cn/post/7485727472999579659" target="_blank"># 实战派！百万PV的AI产品如何搭建RAG系统？</a></p>
<p><a href="https://juejin.cn/post/7482695183477047315" title="https://juejin.cn/post/7482695183477047315" target="_blank"># 团队落地AI产品的全流程</a></p>
<p><a href="https://juejin.cn/post/7474925725662969883" title="https://juejin.cn/post/7474925725662969883" target="_blank"># 5000字长文，AI时代下程序员的巨大优势！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[豆包编程模型来了，我们用四个关卡考了考它！]]></title>    <link>https://juejin.cn/post/7571126773809496074</link>    <guid>https://juejin.cn/post/7571126773809496074</guid>    <pubDate>2025-11-11T11:31:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571126773809496074" data-draft-id="7571191453126557722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="豆包编程模型来了，我们用四个关卡考了考它！"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T11:31:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            豆包编程模型来了，我们用四个关卡考了考它！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:31:10.000Z" title="Tue Nov 11 2025 11:31:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 编程助手，人人都爱。从补全一行代码到生成整个函数，它们极大地改变了我们的开发工作流，就连曾经对它们嗤之以鼻的 Linus Torvalds 也改变了想法。他在近日一次访谈中表示：「我认为它们是能帮助我们更好地完成工作的工具。」</p>
<p>但它们也常会在关键时刻翻车：当你甩给它一个跨越了多个文件、藏得极深的 Bug 时，它失忆了；当你让它重构一个复杂的旧模块时，它开始胡言乱语；当项目变大、依赖变多时，大多数 Copilot 就从助手退化成了麻烦制造机。很明显，对于这些更为复杂的需求，我们需要的不再是代码补全工具，而是一个能理解复杂上下文、自主规划任务、甚至能帮我们调试的 Agentic Coder。</p>
<p>2025 年，AI 编程助手正分化为两条主要路线。第一条可称为 IDE 增强路线，以 GitHub Copilot 为代表。它们深度集成在开发者的编辑器中，更像一个「副驾驶」，在你编程时提供代码补全、上下文感知建议和聊天辅助，目标是提升开发者的编辑效率。</p>
<p>第二条是 Agentic 路线，即任务委托路线，以 Claude Code 为代表。这条路线的工具更像一个「结对工程师」，通常在终端中运行。开发者不再是逐行获取建议，而是将整个复杂的、多步骤的任务（如项目重构、跨语言移植、Bug 修复）委托给它，由它自主规划和执行。这正是「Agentic Coder」的核心理念。</p>
<p>然而，就在 2025 年 10 月底，大量开发者在社区抱怨 Claude Pro 计划的每周用量限制过于严苛，甚至有很多用户反馈称，在进行了几小时的严肃编码工作后就撞到了「周上限」，导致工具无法用于严肃工作。更别说 Anthropic 对中国用户的限制。这在开发者中制造了一个明显的痛点：谁能提供一个既具备强大 Agentic 能力（特指第二条路线），又真正好用、管够的编程模型？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/695a5aae02cd48b9862b72dd66c9f2d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=A53RP9g7z8ovadCu8JhAcDbg1pQ%3D" alt="图片" loading="lazy"/></p>
<p>今天，火山引擎带着豆包编程模型 Doubao-Seed-Code 入场了；顾名思义，这正是一个专为编程任务设计的模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d06be3f37242de937e76c2038f9d56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=9DuakNFLLMQRvEWRwIHpFi797y0%3D" alt="图片" loading="lazy"/></p>
<p>为了检验 Doubao-Seed-Code 的能力，我们将用几个真实工作流中的「硬骨头」来考验它，但在此之前，我们先了解下它的基准表现与核心能力。</p>
<p>一、Doubao-Seed-Code：实力登顶权威榜单</p>
<p>豆包编程模型 Doubao-Seed-Code 在 Terminal Bench、SWE-Bench-Verified-Openhands、Multi-SWE-Bench-Flash-Openhands 等多项权威评测中均表现优异，仅次于甚至超过了 Claude 4.5 Sonnet。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30e88c6b1ac3420980084d61ba98f581~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=JTtjdvJeJDHTUAA6pVTgL9KMrHw%3D" alt="图片" loading="lazy"/></p>
<p>而更亮眼的是：它登顶了 SWE-Bench Verified 榜单。值得注意的是，这一成绩是其与 Trae 相结合实现的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/174c4490b2b84e67ab902ba8dad077dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=ydUXHpXcUEn5RjbE%2B%2F8NE4MNbvg%3D" alt="图片" loading="lazy"/>SWE-Bench Verified 榜单当前前十名</p>
<p>这恰好印证了 Doubao-Seed-Code「为 Agentic Coding 优化」的定位：它不仅是一个基础模型，更是为任务委托型工作流设计的大脑。须知，SWE-Bench 不是一个简单的算法题库，它是一个评估模型在真实 GitHub 项目中修复 Bug 和处理 issue 能力的基准，含金量很高 。能在 Trae 这样的 Agentic 框架中与之携手登顶，证明了它在执行复杂、多步骤的真实工程任务时的潜力。</p>
<p>1、核心能力：原生 256K 长上下文</p>
<p>Doubao-Seed-Code 的强大榜单表现离不开这个基础：原生 256K 长上下文。</p>
<p>这个数字意味着模型有能力一次性读完并理解极其复杂的项目。在真实的编程场景中，一个 Bug 可能横跨多个文件、一个功能可能依赖数十个模块。Doubao-Seed-Code 的 256K 上下文使其能轻松处理长代码文件、多模块依赖等复杂场景。</p>
<p>不仅如此，Doubao-Seed-Code 还是国内首个支持视觉理解能力的编程模型，能参照 UI 设计稿、截图或手绘草图生成代码，或对生成页面进行视觉比对，自主完成样式修复和 Bug 修复，大幅提升前端开发效率。</p>
<p>2、变强之路：Coding RL Agent at Scale</p>
<p>如果说 256K 上下文是让 Doubao-Seed-Code 看得远，那么它做得好的秘密武器就是：Coding RL Agent at Scale（编程智能体大规模强化学习训练）。</p>
<p>火山引擎构建了一个大规模的强化学习系统来训练这个编程模型，</p>
<p>这套系统内构建了覆盖十万容器镜像的庞大训练数据集，具备万级并发沙盒会话的能力，可以对上千卡的单个 RL 任务实现高效训练。基于这套系统，模型无需蒸馏或标注的冷启动数据，完全依靠端到端强化学习训练即可练就顶尖的 Agent 能力，优化路径更简洁高效。</p>
<p>这种训练方式的效果体现在了基准测试上，官方信息显示，在 SWE-bench 基准上，仅 RL 训练就让模型达到了当前最优（SOTA）水平，充分验证了纯强化学习在真实软件工程场景下的强大潜力。</p>
<p>如下图的数据所示，在 multi-swe-bench 和 swe-bench-verified 两个基准上，Doubao-Seed-Code 的性能在训练过程中呈现一致的上升趋势，这表明模型具有良好的泛化能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/678815131d624c438a442d2d98ab2a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=CaROdXYvWK4yj6OQNJScOvAV%2BaM%3D" alt="图片" loading="lazy"/></p>
<p>理论和数据固然亮眼，但它在真实工作流中的表现究竟如何？我们马上进入实战环节来一探究竟。</p>
<p>二、Agentic Coding 大考：四大关卡，实战见真章</p>
<p>我们这次对 Doubao-Seed-Code 的考验主要围绕其三个核心能力 ：</p>
<ul>
<li>
<p>Agentic Coding（任务规划能力）：能否把一个模糊的、多步骤的任务拆解并执行？</p>
</li>
<li>
<p>长上下文（256K）： 能否处理跨越多个文件、依赖关系复杂的屎山代码？</p>
</li>
<li>
<p>调试能力（软件工程）： 能否像一个真实工程师一样，根据报错信息定位并修复 Bug？</p>
</li>
</ul>
<p>1、序章：30 秒「无痛换芯」</p>
<p>当然，在开始评测之前，先搞定接入。</p>
<p>一句话总结：体验非常丝滑。</p>
<p>对于广大使用 Claude Code 的开发者，迁移到 Doubao-Seed-Code 的成本几乎为零，因为它一开始就原生兼容 Anthropic API，用户仅需修改配置文件中几行代码即可将模型切换到 Doubao-Seed-Code。而如果使用火山引擎官方的 CLI，veCLI，则可以直接使用 Doubao-Seed-Code 模型，无需额外配置。本文主要使用 Claude Code 进行测试。</p>
<p>不仅如此，开发者还能将 Doubao-Seed-Code 无缝集成到 Cursor、Cline、Codex CLI、Trae 等主流智能编程环境中，实现即连即用的高效体验。</p>
<p>总之，我们花了不到 30 秒就完成了这一切。下面，大考开始。</p>
<p>2、关卡一：Python 脚本重构</p>
<p>首先，我们尝试一个简单任务：让 Doubao-Seed-Code 将一个由 Gemini 生成的垃圾 Python 脚本重构成结构优良的脚本。</p>
<p>这是一个用于数据处理和报告的模拟脚本 ，但集各种陋习于一身：所有逻辑都塞在一个 main 函数里、使用了全局变量、混乱的 try/except 嵌套和 if/else 逻辑、到处都是 print () 语句、混合了数据获取和数据解析以及文件写入、注释混乱。</p>
<p>结果，耗时不到 3 分钟，Doubao-Seed-Code 不仅完成了对这个脚本的优雅重构，还主动编写了测试脚本，对重构后的代码进行了测试 。</p>
<p>Doubao-Seed-Code 的调试能力（软件工程）能力得到了初步验证，顺利过关。</p>
<p>3、关卡二：C++ 到 Python 跨语言重构</p>
<p>开胃菜结束，我们直接上硬菜，考验它的长上下文和任务规划能力。</p>
<p>任务： 将 GitHub 上一个开源的 C++/OpenGL 版《打砖块》游戏，完整重构为一个 Python 实现 。</p>
<ul>
<li>原项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsdavydouski%2Fbreakout%25C2%25A0" target="_blank" title="https://github.com/sdavydouski/breakout%C2%A0" ref="nofollow noopener noreferrer">github.com/sdavydouski…</a></li>
</ul>
<p>必须说明，这个任务并不简单。因为这已经不是简单的代码翻译，这几乎等于跨语言的项目重建。这个任务的难度体现在：</p>
<ul>
<li>
<p>范式鸿沟：模型需要处理 C++（静态编译型）和 Python（动态解释型）之间巨大的语法和设计范式差异。</p>
</li>
<li>
<p>API 转译：它必须理解 C++ 中底层的 OpenGL 图形 API，并将其智能地转译为 Python 生态中（如 Pygame ）的高级 API 和事件驱动的游戏循环。</p>
</li>
<li>
<p>项目级理解：最关键的是，这是一个完整的项目。模型必须利用其长上下文能力，一次性读懂代码库中所有 C++ 文件（.h 和 .cpp）的复杂依赖关系。</p>
</li>
<li>
<p>自主规划：它不能逐行翻译，而必须自主规划出一个全新的 Python 项目结构，并正确处理所有游戏素材。</p>
</li>
</ul>
<p>可以说这是对模型 256K 长上下文 和 Agentic 任务规划能力的一次压力测试。</p>
<p>我们将项目 clone 下来，启动配置好 Doubao-Seed-Code 的 Claude Code，然后输入一条指令：「将这个 C++ 项目重构为 Python 项目，使用其原本的素材。」接下来就是见证奇迹的时刻，以下视频展示了其最初的执行阶段：</p>
<p>可以看到，Doubao-Seed-Code 首先分析了整个代码库，准确理解了其功能和 C++/OpenGL 技术栈。然后，它制定了详细的重构计划，包括创建 Python 项目结构、安装 Pygame 库、建立游戏主类和游戏循环、重构游戏对象、实现关卡系统等等，并开始一步步执行 。</p>
<p>从实现到测试完成，整个项目耗时近 40 分钟，而我们所做的，仅仅是提供了最初的指令和中间的几次文件操作许可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52ebe1f1122b4665b04d236dcb8018c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=xiwSp%2F81Jqq4%2BVq2u3r7jFTYXwk%3D" alt="图片" loading="lazy"/></p>
<p>项目结束时，Doubao-Seed-Code 给出的总结</p>
<p>一切完成后，Doubao-Seed-Code 还为我们撰写了详细的文档，并交付了一个完全可玩的 Python 版《打砖块》游戏。</p>
<p>Doubao-Seed-Code 重构的游戏完整可玩，且音乐也非常适配</p>
<p>这已经不是简单的「代码补全」，而是真正的「Agentic Coding」。它完美地践行了我们在引言中提到的 Agentic 路线：我们不再是逐行获取建议，而是将一个横跨范式鸿沟和 API 转译的复杂项目，完整地委托给它，由它自主规划并最终执行。这正是 Agentic Coding 的核心理念。</p>
<p>4、关卡三：从零开始的软件创造</p>
<p>在跨语言重构之后，我们想看看 Doubao-Seed-Code 从零开始构建一个全新项目的能力。</p>
<p>这一次，我们想让它为我们编写一个桌面宠物小程序。不过，在开始之前，我们遇到了一个很现实的问题：我们没有素材。</p>
<p>使用即梦，我们先生成了一张卡通树懒睡觉图，然后使用这张图继续让即梦生成了一段树懒站起来的视频。接下来，我们需要将其中的可爱树懒提取出来，并将背景透明化。在使用 ffmpeg 提取出所有帧之后，我们意识到接下来的工作完全可以让 Doubao-Seed-Code 来完成！</p>
<p>简单描述下我们的需求，剩下的就交给 Doubao-Seed-Code 了：</p>
<blockquote>
<p>这里有 300 帧图片，我需要你将其制作成 5 秒的 gif 动图。但首先，你需要提取出图中的人物，去掉背景和左上角及右下角的背景水印。给我一张透明背景的动图。</p>
</blockquote>
<p>Doubao-Seed-Code 立刻理解了任务，它安装了 rembg、imageio 等相关库，并帮我们完美地处理了所有原始帧，最终交付了两张我们需要的核心素材：sleep.gif 和 stand.gif。</p>
<p>接下来我们将素材放入项目文件夹，再次唤起 Doubao-Seed-Code，输入以下指令：</p>
<blockquote>
<p>使用 Python 编写一个桌面宠物小程序，这个宠物是一只卡通树懒，它一般在屏幕上睡觉（sleep.gif）。但如果用户点击它，它就会站起来 (stand.gif)。之后，它又会变回睡觉姿势。用户可以在屏幕上拖动它到任何位置。宠物画面宽度固定为 300px。透明背景。使用 assets 文件夹中的素材。</p>
</blockquote>
<p>同样，它一次性构建完成。</p>
<p>运行看看效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78913e5f261640218cac9834a3aecaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=NXcCzJjz7hxLas%2F9Mp9uNYoUNdc%3D" alt="图片" loading="lazy"/></p>
<p>这就是我们预期想要实现的目标！它不仅完全实现了我们指令中的所有功能（睡觉、点击站立、可拖动、透明背景），而且整个工作流（从 AI 生成素材、到 AI 处理素材、再到 AI 构建软件）都展现了极高的流畅度。</p>
<p>当然，我们还可以进一步与 Doubao-Seed-Code 交互，让其对这个桌面宠物进行改进，比如提供更多素材让其具备更加风格的动作库、设置双击它打开某个链接或 AI 助手、让它根据天气和时间自动执行执行不同的动作等等。</p>
<p>一个桌面宠物还不够。为了更好地领略它的创造能力，我们还让 Doubao-Seed-Code 从零开始构建了其它几个风格迥异的有趣项目。我们发现，它基本都是一次成形，偶尔需要的反馈也只是明确需求或提供额外信息。当遇到 Bug 时，我们也只需将报错信息直接反馈回去，它也能直接解决。</p>
<p>比如一个会动态演进的弹珠撞墙模拟程序：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ee9965867442eaa69525946265b36b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=Pwmx1ZbhqMZlqx8It9CpOsPKE44%3D" alt="图片" loading="lazy"/></p>
<p>提示词：用 Pyhon 写一个模拟程序：一个小球在一个六边形中弹跳。这个六边形的六条边各有特性，小球撞上不同的边会触发不同的效果。撞上边 1 会导致小球颜色随机变化，边 2 导致小球变大 10%，边 3 导致小球变小 10%，边 4 导致小球加速 20%，边 5 导致小球减速 20%。边 6 会在六边形中央克隆出一个一样的小球。如有文字，使用微软雅黑字体。</p>
<p>一个游玩难度颇大的邯郸学步小游戏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959c98c30bbe4605a099d4939b2cd418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=xPg%2B9hUKSZKE4Mx815NFPvtTIhk%3D" alt="图片" loading="lazy"/></p>
<p>构建一个邯郸学步小游戏。游戏一开始会随机展示一个火柴人走路或扭动的样子（四肢和头部随机摆动），玩家需要操控另一个火柴人模仿它并且只有 2 秒反应时间。模仿正确则得 1 分，错误扣 1 分。10 分玩家胜利，负 10 分则玩家失败。玩家使用方向键分别控制四肢，用空格键控制火柴人头部摆动。如有文字，使用微软雅黑字体。</p>
<p>我们甚至还让 Doubao-Seed-Code 基于我们之前关于<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650997783%26idx%3D1%26sn%3D0f796e9cbaf70b81378e4cb06ba7ea90%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650997783&amp;idx=1&amp;sn=0f796e9cbaf70b81378e4cb06ba7ea90&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"> Yoshua Bengio 引用量突破百万的报道</a>构建了一个像素风格的展示网页 —— 我们所做的仅仅是提供一份 docx 文档。</p>
<p>提示词：这里的 docx 文件是我们之前关于 Yoshua Bengio 引用量破百万的专题报道，请基于这些素材，构建一个介绍网页，生动地展示 Bengio 取得的这一成绩。使用多页网页的形式，采用现代、美观的像素风格，其中首页集中展示主要的信息，再通过几个按钮链接到其它网页。</p>
<p>从数据处理脚本、跨语言游戏移植，再到创意小程序和专题网站，Doubao-Seed-Code 在从零开始这一关卡中，充分展现了其强大的 Agentic 规划能力和工程实现能力。</p>
<p>5、关卡四：一个实际问题</p>
<p>最后，我们来让 Doubao-Seed-Code 解决一个实际问题。</p>
<p>作为一家专业的 AI 媒体，arXiv 上的新论文是机器之心日常报道的重要来源。但每天手动去刷几十位行业技术大佬的论文更新情况，费时费力还容易遗漏。</p>
<p>于是，我们决定让 Doubao-Seed-Code 帮我们解决这个痛点：构建一个「论文查找器」。首先，将我们的需求组合成一个提示词，表达清楚即可：</p>
<blockquote>
<p>用 Python 构建一个论文查找器，其功能为：检索 arXiv，找到用户提供的 authors 文件中所有人物过去一周内最新更新或发布的三篇论文，将结果输出为一个 Markdown 文件，内容包括人名、论文标题和链接。如果过去一周没有论文更新，则无需包含进来。作为参考，这是查询 Yoshua Bengio 论文的 arXiv API：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fexport.arxiv.org%2Fapi%2Fquery%3Fsearch_query%3Dau%3A%2BBengio_Yoshua%26sortBy%3DlastUpdatedDate%26sortOrder%3Ddescending%26max_results%3D100" target="_blank" title="https://export.arxiv.org/api/query?search_query=au:+Bengio_Yoshua&amp;sortBy=lastUpdatedDate&amp;sortOrder=descending&amp;max_results=100" ref="nofollow noopener noreferrer">export.arxiv.org/api/query?s…</a></p>
</blockquote>
<p>顺带一提，这一次我们选择在 Trae 中完成这个项目。</p>
<p>7 分钟，Doubao-Seed-Code 就搞定了一切。它还生成了一个 authors.txt 文件，里面包含 Geoffrey Hinton 等四位 AI 领域的传奇人物，现在我们为这份名单添加更多人物（包括近期有更新的作者），测试一下。</p>
<p>完美！现在，我只需要把它设置成一个定时任务，每天上午自动运行。我们再也不用担心错过前沿 AI 论文选题了。</p>
<p>三、最后聊点实在的：要花多少钱？</p>
<p>实战评测之后，终于到了最实在的部分：价格。毕竟，如果像 Claude Pro 那样有严格的用量限制或高昂的门槛，再强大的 Agentic Coder 也难以「飞入寻常百姓家」。</p>
<p>而在价格方面，Doubao-Seed-Code 也试图解决前文中提到的痛点。恰逢双十一，火山引擎同步推出了一个 Coding Plan 套餐包。</p>
<p>这个「方舟 Coding Plan」是专为开发者量身打造的 AI Coding 场景订阅服务。作为「双十一」的重头戏，它的套餐包价格非常亮眼：</p>
<ul>
<li>
<p>Lite 套餐（适合大多数开发者）：首购首月仅需 9.9 元 / 月；用一杯咖啡的价格」，就能享受一整个月的优质编码辅助。后续续费为 40 元 / 月。</p>
</li>
<li>
<p>Pro 套餐（适合复杂项目开发）：首购首月仅需 49.9 元；后续续费为 200 元 / 月。</p>
</li>
</ul>
<p>除了套餐包的巨大优惠，Doubao-Seed-Code 在调用价格上也实现了普惠开发者。它通过采用全量透明 Cache 技术，能使成本再降低 80%。不仅如此，火山引擎还为该模型推出了分层定价模式。官方表示，在实际使用场景中，综合使用成本可降低 62.7%，实现了目前国内最低价格。</p>
<p>总而言之，Doubao-Seed-Code 在尝试解决 Agentic Coding 路线性能问题的同时，也通过这个 Coding Plan 对前文提到的价格和用量限制痛点做出了回应。</p>
<p>四、强大的 Agentic Coder，更是完美平替？</p>
<p>从易到难再到我们日常工作中的实际问题，一场评测下来，我们认为连通四关的豆包编程模型 Doubao-Seed-Code 令人印象深刻，足称「强大」。而且很明显它与 IDE 增强路线的辅助补全不同，其核心能力更多体现在对复杂、多步骤任务的自主规划与执行上。</p>
<p>无论是重构屎山代码，还是挑战 C++/OpenGL 到 Python 的跨语言移植，亦或是从零孵化一只功能完备的「桌面树懒」；乃至帮我们解决 arXiv 刷论文的真实痛点，它都展现出了强大的 Agentic Coding 能力，证明了自己是 Agentic 路线的有力竞争者。</p>
<p>原生 256K 的长上下文能力及其背后 Coding RL Agent at Scale 的端到端强化学习训练共同构成了 Doubao-Seed-Code 应对「真实编程场景」的技术基础。</p>
<p>Doubao-Seed-Code 的意义还不止于技术。它不仅解决了 Agentic 路线的性能问题 ，更通过 Coding Plan 和 API 兼容性解决了开发者们在原版 Claude Code 上遇到的价格、用量限制乃至用户限制的痛点。</p>
<p>它不仅是一个高性能的结对工程师，也是一个高性价比、易于获取的前沿编程模型的「完美平替」。它让我们看到了 Agentic Coding 真正走向普惠、人人可用时代的可能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris 4.0.1 版本正式发布]]></title>    <link>https://juejin.cn/post/7571191453126541338</link>    <guid>https://juejin.cn/post/7571191453126541338</guid>    <pubDate>2025-11-11T11:28:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126541338" data-draft-id="7571278865517314098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris 4.0.1 版本正式发布"/> <meta itemprop="keywords" content="Apache,数据库"/> <meta itemprop="datePublished" content="2025-11-11T11:28:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris 4.0.1 版本正式发布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:28:02.000Z" title="Tue Nov 11 2025 11:28:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>亲爱的社区小伙伴们，**Apache Doris 4.0.1 版本已于 2025 年 11 月 08 日正式发布。**此版本聚焦核心模块的打磨与优化，在 AI &amp; Search 方面实现了重要能力扩展，同时全面提升了 Lakehouse 与查询引擎的稳定性和性能。</p>
<ul>
<li>GitHub 下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdoris%2Freleases" target="_blank" title="https://github.com/apache/doris/releases" ref="nofollow noopener noreferrer">github.com/apache/dori…</a></li>
<li>官网下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdownload" target="_blank" title="https://doris.apache.org/download" ref="nofollow noopener noreferrer">doris.apache.org/download</a></li>
</ul>
<h2 data-id="heading-0">行为变更</h2>
<ul>
<li><code>SHOW PARTITIONS</code> 命令不再支持 Iceberg 表，请直接使用 Iceberg 的 <code>$partitions</code> 系统表查看。#56985</li>
</ul>
<h2 data-id="heading-1">新增功能</h2>
<ul>
<li>新增 mmh64_v2 函数，用于生成与其他三方库相同的 Hash 结果。#57180</li>
<li>新增 json_hash 函数，支持对 JSONB 类型生成 Hash 值。#56962</li>
<li>新增 Binary 数据类型，并增加一系列函数 length、from_base64_binary、to_base64_bianry、sub_binary。#56648</li>
<li>新增 sort_json_object_keys / normalize_json_numbers_to_double 函数，用于对 JSONB 的 Key 进行排序。</li>
<li>新增与 MySQL 兼容的时间函数：UTC_DATE、UTC_TIME 及 UTC_TIMESTAMP。#57443</li>
<li>新增对 MaxCompute Schema 层级的支持。 #56874
<ul>
<li>相关文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdocs%2F3.x%2Flakehouse%2Fcatalogs%2Fmaxcompute-catalog%23hierarchical-mapping" target="_blank" title="https://doris.apache.org/docs/3.x/lakehouse/catalogs/maxcompute-catalog#hierarchical-mapping" ref="nofollow noopener noreferrer">doris.apache.org/docs/3.x/la…</a></li>
</ul>
</li>
<li>JSON_OBJECT 函数支持使用 * 作为参数。#57256</li>
</ul>
<h2 data-id="heading-2">功能改进</h2>
<h3 data-id="heading-3">AI &amp; Search</h3>
<ul>
<li>为 SEARCH 函数新增短语查询、通配符查询和正则查询支持。#57372 #57007</li>
<li>扩展 SEARCH 函数参数，新增可选的 default_field 参数（默认列）和 default_operator 参数（指定多列查询的布尔运算符为 "and" 或 "or"）。#57312</li>
<li>SEARCH 函数新增对 Variant 类型子列的搜索支持，可通过点号语法（如 variantColumn.subcolumn：关键词）直接搜索 JSON 路径中的特定字段。</li>
<li>将倒排索引的默认存储格式由 V2 升级为 V3 版本。#57140</li>
<li>完善自定义分词器 Pipeline 支持，新增 char_filter 组件；在 Analyzer 框架中新增 Basic Tokenizer 和 和 ICU Tokenizer 两种内置分词器支持；新增内置分词器别名并支持组件同名配置，优化统一 Analyzer 框架。#57055</li>
</ul>
<h3 data-id="heading-4">Lakehouse</h3>
<ul>
<li>新增会话变量 <code>merge_io_read_slice_size_bytes</code> 来解决某些情况下，外表 Merge IO 读放大严重的问题。
<ul>
<li>相关文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdocs%2F3.x%2Flakehouse%2Fbest-practices%2Foptimization%23merge-io-optimization" target="_blank" title="https://doris.apache.org/docs/3.x/lakehouse/best-practices/optimization#merge-io-optimization" ref="nofollow noopener noreferrer">doris.apache.org/docs/3.x/la…</a></li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">查询</h3>
<ul>
<li>优化了 JOIN Shuffle 选择算法 #56279</li>
</ul>
<h3 data-id="heading-6">其他</h3>
<ul>
<li>优化了物理计划中 Runtime Filter 序列化信息的大小 #56978</li>
</ul>
<h2 data-id="heading-7">问题修复</h2>
<h3 data-id="heading-8">AI &amp; Search</h3>
<ul>
<li>修复非分词字段的 SEARCH 查询结果问题，支持在 MOW 表上执行 SEARCH 函数查询 #56927</li>
<li>修复倒排索引在执行 IS NULL 谓词过滤时的计算错误问题 #56964</li>
</ul>
<h3 data-id="heading-9">Lakehouse</h3>
<ul>
<li>修复某些情况下，谓词下推无法使用 Parquet Page Index 的问题 #55795</li>
<li>修复某些情况下外表查询分片读取丢失的问题 #57071</li>
<li>修复某些情况下，Hadoop 文件系统缓存开启导致修改 Catalog 属性不生效的问题 #57063</li>
<li>修复某些情况下，从旧版本升级时，连接属性校验导致元数据回放失败的问题 #56929</li>
<li>修复某些情况下，Refresh Catalog 导致 FE 线程死锁的问题 #56639</li>
<li>修复无法读取由 Hive 转换生成的 Iceberg 表的问题 #56918</li>
<li>修复某些情况下收集 Query Profile 导致 BE 宕机的问题 #56806</li>
</ul>
<h3 data-id="heading-10">查询</h3>
<ul>
<li>修复 datetime 类型在 Timezone 相关 Cast 时，边界条件下结果错误的问题 #57422</li>
<li>修复部分 datetime 相关函数结果精度推导不正确的问题 #56671</li>
<li>修复 inf 作为 float 的谓词条件时 Core 的问题 #57100</li>
<li>修复 explode 函数在可变参数下 Core 的问题 #56991</li>
<li>修复 decimal256 到 float 类型的 Cast 不稳定的问题 #56848</li>
<li>修复 Spill Disk 时可能出现重复调度导致 Core 的问题 #56755</li>
<li>修复偶发的错误调整 Mark Join 和其他 Join 顺序的问题 #56837</li>
<li>修复部分命令未被正确转发到 Master Frontend 执行的问题 #55185</li>
<li>修复偶现的窗口函数错误生成 Partition TopN 的问题 #56622</li>
<li>修复当同步物化视图定义中存在关键字时，查询可能报错的问题 #57052</li>
</ul>
<h3 data-id="heading-11">其他</h3>
<ul>
<li>禁止基于同步物化视图创建另外一个同步物化视图 #56912</li>
<li>修复 Profile 中存在内存未及时释放问题 #57257</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞最新长文：AI的下一个十年——构建真正具备空间智能的机器]]></title>    <link>https://juejin.cn/post/7571191453126574106</link>    <guid>https://juejin.cn/post/7571191453126574106</guid>    <pubDate>2025-11-11T11:31:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126574106" data-draft-id="7571126773809512458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞最新长文：AI的下一个十年——构建真正具备空间智能的机器"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T11:31:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞最新长文：AI的下一个十年——构建真正具备空间智能的机器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:31:59.000Z" title="Tue Nov 11 2025 11:31:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在昨晚，关于其投身的空间智能，斯坦福大学教授李飞飞发表了一篇长篇博客《From Words to Worlds: Spatial Intelligence is AI’s Next Frontier》。</p>
<p>在文中，李飞飞详细解读了「空间智能究竟是什么？它为什么重要？我们如何构建它？我们又如何使用它？」她同时阐述了真正的空间智能世界模型必须实现的核心框架：构建具有故事讲述者想象力的 AI、具备第一响应者流畅性的 AI 以及以科学精确性进行空间推理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0152c9a32184bb285cd0c9393f29af0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465518&amp;x-signature=4n6v7VHVjnfO7HEtCMYd8nso8is%3D" alt="图片" loading="lazy"/></p>
<p>以下为全文翻译：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e7e903c3cab457e8ace1989f552ba99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465518&amp;x-signature=52laQu%2FVueTCLvqoyLxTbdoYZcY%3D" alt="图片" loading="lazy"/></p>
<p>1950 年，当计算机还只是自动化的算术和简单逻辑时，艾伦・图灵提出了一个至今仍余音不绝的问题：机器能思考吗？他拥有非凡的想象力，看到了一个超越时代的可能 —— 智能或许可以被「构建」，而非「诞生」。这一洞见开启了一个持久而伟大的科学征程 —— 人工智能（AI）。在我投身人工智能研究二十五年后的今天，图灵的愿景仍让我心怀敬意与灵感。但我们究竟走到了哪一步？答案并不简单。</p>
<p>如今，以大语言模型（LLM）为代表的前沿 AI 技术，已经开始改变我们获取和运用抽象知识的方式。然而，它们依然像是「黑暗中的文匠」：能言善辩却缺乏经验，知识丰富却脱离现实。空间智能将彻底改变我们创造和交互现实与虚拟世界的方式 —— 它将重塑叙事、创意、机器人学、科学发现等领域。这正是 AI 的下一个前沿。</p>
<p>自我踏入这一领域以来，对视觉与空间智能的追求一直是我心中的北极星。这也是我花费多年时间创建 ImageNet 的原因 —— 这是首个大规模视觉学习与评测数据集，与神经网络算法和现代计算（如图形处理器 GPU）一道，构成了现代人工智能诞生的三大基石。这也是为什么我的斯坦福实验室在过去十年中，持续探索将计算机视觉与机器人学习相结合。</p>
<p>而这一追求，也促使我与合伙人 Justin Johnson、Christoph Lassner、Ben Mildenhall 共同创立了 World Labs—— 在一年多前，我们立志首次将这一愿景彻底实现。在这篇文章中，我将阐述什么是空间智能、它为何重要，以及我们如何构建能够释放空间智能潜力的世界模型 —— 这种能力将深刻影响创造力、具身智能与人类的未来进步。</p>
<p>空间智能：</p>
<p>人类认知的脚手架</p>
<p>人工智能正处在前所未有的激动人心时刻。生成式 AI 模型 —— 例如大语言模型（LLM）—— 已经从研究实验室走入日常生活，成为数十亿人创造、工作与沟通的工具。它们展现出了曾被认为不可能的能力：能够轻松生成连贯的文本、海量的代码、逼真的图像，甚至短视频片段。如今，问题已不再是「人工智能是否会改变世界」，而是「它已经如何改变了世界」。</p>
<p>然而，仍有许多目标尚未触及。自主机器人的愿景依旧令人神往，却依然停留在推测阶段，离未来学家长期描绘的日常现实仍有距离。在疾病治疗、新材料发现、粒子物理等领域，人工智能加速科研的梦想也尚未真正实现。而一种能够真正理解并赋能人类创造者的 AI—— 无论是学习分子化学复杂概念的学生、构思空间的建筑师、构建世界的电影创作者，还是渴望沉浸式虚拟体验的任何人 —— 这一承诺仍未兑现。</p>
<p>要理解这些能力为何依然难以实现，我们需要回溯空间智能的演化历程，并审视它如何塑造了我们对世界的理解。</p>
<p>视觉一直是人类智能的基石，但它的力量源自更为根本的东西。早在动物学会筑巢、照料幼崽、用语言交流或建立文明之前，最简单的「感知」行为，便悄然点燃了一场通向智能的进化旅程。</p>
<p>这种看似孤立的能力 —— 从外部世界中提取信息，无论是一道微光，还是一种触感 —— 在感知与生存之间搭起了一座桥梁，并随着世代更迭不断加固、延展。神经元层层叠加，沿着这座桥梁生长，形成了能解释世界、协调生物体与环境互动的神经系统。正因如此，许多科学家推测，感知与行动构成了驱动智能演化的核心循环，也成为自然创造人类这一物种的根基 —— 一种集感知、学习、思考与行动于一体的终极体现。</p>
<p>空间智能在定义人类如何与物理世界互动中起着根本性的作用。每天，我们都依赖它完成最平常的行为：停车时通过想象车尾与路缘之间逐渐缩小的间隙来判断距离；接住被人扔来的钥匙；在人群密集的人行道上穿行而不相撞；或者在半睡半醒间不看杯子也能准确地把咖啡倒进去。在更极端的情境中，消防员在浓烟弥漫、结构不断坍塌的建筑中穿行，瞬间判断稳定与危险，依靠手势、身体语言以及一种无法用言语表达的职业直觉进行协作。</p>
<p>而婴儿在还未学会说话的数月甚至数年中，正是通过与环境的嬉戏互动来认识世界。所有这一切都在无意识间、自动地完成 —— 这种流畅性，是机器至今尚未具备的。</p>
<p>空间智能同样是人类想象力与创造力的基础。讲故事的人在脑海中构建独特而丰富的世界，并借助各种视觉媒介将其传达给他人 —— 从史前的洞穴壁画，到现代电影，再到沉浸式电子游戏。无论是孩子在沙滩上筑起的沙堡，还是他们在电脑上玩《我的世界》所创造的空间，这种基于空间的想象力构成了现实与虚拟世界中交互体验的核心。而在众多行业应用中，对物体、场景和动态交互环境的模拟，正支撑着从工业设计到数字孪生再到机器人训练的无数关键业务场景。</p>
<p>纵观历史，空间智能在推动文明发展的关键时刻屡次扮演核心角色。在古希腊，埃拉托色尼通过几何化阴影来揭示地球的尺度 —— 他在亚历山大测量出七度的日影角度，并在太阳直射、影子消失的赛恩进行对比，计算出了地球的周长。哈格里夫斯通过一个空间构想发明了「珍妮纺纱机」：将多个纺锤并列在同一架构中，使一个工人能够同时纺出多股纱线，生产效率因此提升八倍。沃森和克里克通过亲手搭建三维分子模型、不断调整金属板与铁丝的位置，最终发现了 DNA 的双螺旋结构。</p>
<p>当科学家与发明家需要操纵物体、想象结构、推理空间关系时，正是空间智能推动了人类文明的跃进 —— 而这些都无法仅凭文字所捕捉。</p>
<p>空间智能是支撑人类认知的脚手架。无论我们是在被动观察，还是主动创造，它都在发挥作用。它驱动我们的推理与规划，哪怕是在最抽象的思维领域；它也是我们与他人、与环境进行互动 —— 无论通过语言还是行动 —— 所必不可少的能力。虽然我们大多数人并不会像埃拉托色尼那样揭示新的宇宙真理，但我们几乎每天都以相似的方式思考 —— 通过感官理解复杂的世界，并凭借对物理与空间规律的直觉掌握，来形成认知与判断。</p>
<p>遗憾的是，当下的人工智能尚未具备这种思维方式。</p>
<p>过去几年，AI 的确取得了巨大进步。多模态大语言模型（MLLM）在文本之外引入了海量的多媒体数据，使 AI 具备了初步的空间感知能力。如今，AI 已经能够分析图像、回答相关问题，并生成高度逼真的图片和短视频。借助传感器与触觉技术的突破，最先进的机器人也开始能够在高度受限的环境中操纵物体与工具。</p>
<p>然而，坦率地说，AI 的空间能力仍与人类相距甚远，这一差距显而易见。最先进的多模态模型在估算距离、方向和大小等任务上，其表现往往仅略高于随机水平；在「心智旋转」（从不同角度重新生成物体）的测试中也极为有限。它们无法穿越迷宫，不能识别捷径，也无法预测最基本的物理规律。AI 生成的视频 —— 虽令人惊叹，但往往在数秒后便失去连贯性。</p>
<p>当前最先进的 AI 在阅读、写作、研究和数据模式识别方面表现出色，但在对物理世界的表征与交互上却存在根本性局限。人类对世界的理解是整体性的 —— 不仅关乎我们「看见了什么」，还包括事物在空间上的关系、它们的意义以及彼此的关联。通过想象、推理、创造与互动来理解世界，而非仅仅依赖语言描述，这正是空间智能的力量。没有它，AI 就与它试图理解的物理现实脱节，无法真正安全高效地驾驶汽车、引导家庭或医院中的机器人，也难以实现学习与娱乐中的沉浸式互动体验，更无法加速材料科学与医学中的突破性发现。</p>
<p>哲学家维特根斯坦曾说，「我的语言的界限意味着我的世界的界限」。我不是哲学家，但我深知，对人工智能而言，世界远不止语言本身。空间智能代表着超越语言的前沿 —— 它连接了想象、感知与行动，开启了机器真正赋能人类生活的可能，从医疗到创造力，从科学发现到日常助理。</p>
<p>AI 的下一个十年：</p>
<p>构建真正具备空间智能的机器</p>
<p>那么，我们该如何打造具备空间智能的 AI？通往那样的模型之路是什么样的？它不仅能像埃拉托色尼那样进行空间推理，像工业设计师那样精准构造，像讲故事的人那样富于想象，还能像应急救援人员那样自然地与环境互动。</p>
<p>要实现空间智能，我们需要的远不止 LLM 那样的体系，而是更具雄心的「世界模型」—— 一种新型生成式模型，能够在语义、物理、几何与动态等多重复杂世界（无论虚拟还是现实）中进行理解、推理、生成与交互。</p>
<p>这一领域仍处在萌芽阶段，当前的研究方法从抽象推理模型到视频生成系统皆有涉及。World Labs 正是在这一信念之上，于 2024 年初创立：即世界模型的基础方法尚在确立之中，而这正是未来十年人工智能的关键挑战所在。</p>
<p>在这一新兴领域中，最重要的是确立指导发展的基本原则。对于空间智能而言，我将「世界模型」定义为具备以下三种核心能力的系统：</p>
<p>一是生成性：世界模型能够生成在感知、几何与物理层面保持一致的世界。</p>
<p>要解锁空间理解与推理的能力，世界模型必须能够生成属于自己的模拟世界。它需要具备创造出无限多样的虚拟世界的能力，这些世界必须遵循语义或感知层面的指令，同时在几何、物理和动态层面保持一致性 —— 无论这些世界对应的是现实空间还是虚拟空间。研究界目前正积极探索这些世界的内部几何结构应当以隐式还是显式的方式表示。</p>
<p>除此之外，我认为，除了强大的潜在表征之外，一个通用的世界模型还必须能够生成明确、可观测的世界状态，以适配不同的应用场景。尤其重要的是，它对当前世界的理解，必须与过去保持连贯 —— 与导致这一现状的先前世界状态相一致。</p>
<p>二是多模态性：世界模型在设计上即是多模态的。</p>
<p>正如动物与人类一样，世界模型应能够处理多种形式的输入 —— 在生成式 AI 中通常被称为提示词。当输入信息不完整时，无论是图像、视频、深度图、文本指令、手势还是动作，世界模型都应能够预测或生成尽可能完整的世界状态。这要求模型具备如真实视觉般处理视觉输入的能力，同时又能同样熟练地理解语义指令。这样的能力使得智能体与人类能够通过多样化的输入方式与模型就世界进行交流，并获得多样化的输出反馈。</p>
<p>三是交互性：世界模型能够根据输入的动作生成下一个世界状态。</p>
<p>当动作和 / 或目标成为世界模型的输入提示时，其输出必须包括世界的下一个状态 —— 可以是隐式的，也可以是显式的。当输入仅包含一个动作，或者包含动作与目标状态时，世界模型应能生成与先前世界状态、预期目标（若有）、语义含义、物理规律及动态行为相一致的输出。随着空间智能世界模型在推理与生成能力上的不断增强，可以想见，在某些情况下，模型不仅能预测世界的下一状态，还能基于这一新状态，进一步预测实现目标所需的下一步行动。</p>
<p>这一挑战的规模，超出了人工智能以往所面对的一切。</p>
<p>语言只是人类认知中一种纯粹的生成现象，而「世界」则遵循着远为复杂的规律。在地球上，重力主宰着运动，原子结构决定了光如何产生色彩与亮度，无数物理定律约束着每一次交互。即便是最奇幻、最具创造力的世界，其构成的空间物体与行动主体，也都必须服从特定的物理法则与动态行为。要在语义、几何、动态与物理层面上实现一致的统一与协调，需要全新的技术与理论路径。</p>
<p>相较于语言这样一维、顺序性的信号，对「世界」的表征在维度与复杂度上要庞大得多。要让世界模型具备人类所拥有的那种普适能力，必须突破多个艰巨的技术壁垒。在 World Labs，我们的研究团队正致力于在这一目标上取得根本性的进展。</p>
<p>以下是我们当前的一些研究方向：</p>
<p>1、一种新的通用训练任务函数：</p>
<p>为世界模型定义一种像 LLM 中的「下一 token 预测」那样简洁优雅的通用任务函数，一直是该领域的核心目标之一。然而，由于世界模型在输入与输出空间上的复杂性，使得这种函数的构建本身极具挑战。尽管仍有大量未知有待探索，但这种目标函数及其对应的表征方式，必须能够反映几何与物理规律，体现世界模型作为联结想象与现实的基础性表征体系的本质特征。</p>
<p>2、大规模训练数据：</p>
<p>训练世界模型所需的数据远比文本更为复杂。好消息是，大规模数据源已经存在。互联网上海量的图像与视频，提供了丰富且可获取的训练材料，真正的挑战在于如何研发能够从二维图像或视频帧（即 RGB 信号）中提取更深层空间信息的算法。过去十年的研究表明，在语言模型中，数据量与模型规模之间存在明确的「scaling laws」；对于世界模型而言，关键在于构建能够在相似规模上充分利用现有视觉数据的架构。</p>
<p>此外，高质量的合成数据，以及诸如深度信息与触觉信息等额外模态，也将在训练过程中的关键阶段发挥重要作用。但要实现这一目标，我们仍需更先进的传感系统、更稳健的信号提取算法，以及更强大的神经模拟方法。</p>
<p>3、新型模型架构与表征学习：</p>
<p>世界模型的研究将不可避免地推动模型架构与学习算法的革新，尤其是在超越当前 MLLM 与视频扩散模型范式的方向上。现有方法通常将数据离散化为一维或二维序列，这使得一些简单的空间任务变得不必要地困难 —— 比如统计短视频中独特的椅子数量，或记住一个房间一小时前的样子。替代性架构可能带来突破，例如具备三维或四维感知能力的分词、上下文和记忆机制。</p>
<p>以 World Labs 为例，我们最近开发的实时生成帧模型 RTFM（Real-Time Frame-based Model）正体现了这一方向的转变。它将空间锚定的帧作为一种空间记忆形式，在保持生成世界连续性与一致性的同时，实现了高效的实时生成。</p>
<p>显然，在通过世界模型彻底释放空间智能之前，我们仍面临着艰巨的挑战。这项研究不仅仅是理论探索，它将成为新一代创造力与生产力工具的核心引擎。而来自 World Labs 的最新进展令人振奋。我们近日首次向少量用户展示了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650991095%26idx%3D1%26sn%3D2d4b5c89e7051cbb8eaedfdf3428e1ad%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650991095&amp;idx=1&amp;sn=2d4b5c89e7051cbb8eaedfdf3428e1ad&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Marble</a> 的早期成果 —— 这是首个能够通过多模态输入进行提示，从而生成并维持一致性三维环境的世界模型。用户与创作者可以在其中探索、交互，并在创作流程中不断扩展这一虚拟世界。我们也正全力推进，让它尽快向公众开放。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ac8bae604b43a2b30babd1d81059e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465518&amp;x-signature=ldsL%2F57VFO4zr4GlxBzuVJYUM7Q%3D" alt="图片" loading="lazy"/></p>
<p>Marble 只是我们迈向真正具备空间智能的世界模型的第一步。随着研究不断加速，更多科学家、工程师、用户与商业领袖开始意识到它所蕴含的巨大潜能。新一代的世界模型将使机器在空间智能方面达到全新的高度，这将开启当今 AI 系统仍普遍缺乏的关键能力。</p>
<p>利用世界模型，</p>
<p>为人类创造更美好的世界</p>
<p>人工智能的发展动力至关重要。作为推动现代人工智能时代到来的一名科学家，我的初心始终清晰：AI 应当增强人类能力，而非取而代之。多年来，我一直致力于让 AI 的研发、应用与治理与人类需求保持一致。如今，关于科技乌托邦或末日论的极端叙事层出不穷，但我依然坚持一种更务实的观点：AI 由人类创造、由人类使用、也应由人类治理。它必须始终尊重人的自主性与尊严。</p>
<p>AI 的真正魅力，在于扩展我们的能力，使我们变得更加富有创造力、更加紧密相连、更高效、更有成就感。空间智能正是这种愿景的体现 —— 一种能让创作者、照护者、科学家与梦想家实现曾经不可能之事的 AI。这一信念，是我将空间智能视为人工智能下一个伟大前沿的根本动力。</p>
<p>空间智能的应用涵盖不同的时间维度。面向创作者的工具正在崭露头角 ——World Labs 的 Marble 已经让创作者与讲述者能够直接掌握这些能力。机器人学则代表了中期的雄心目标，我们正不断完善感知与行动之间的闭环。而那些最具变革性的科学应用可能需要更长时间，但它们有望对人类的繁荣产生深远影响。</p>
<p>纵观这些不同阶段，有几个领域格外值得关注，因为它们最有潜力重塑人类能力。要实现这一愿景，需要集体的巨大努力，远超任何一个团队或公司的能力范围。这需要整个 AI 生态系统的共同参与：研究者、创新者、企业家、公司，乃至政策制定者，都必须携手朝着共同的愿景前进。而这一愿景，值得我们全力以赴。接下来，让我们看看这个未来将带来什么。</p>
<p>创造力：赋能故事叙述与沉浸式体验</p>
<p>「创造力是智力在享受乐趣。」这是我最喜爱的名言之一，出自我的精神偶像阿尔伯特・爱因斯坦。早在文字出现之前，人类就已经在讲述故事 —— 他们将故事绘在洞穴的石壁上，口耳相传，代代延续，并以共同的叙事建构出整个文化。故事是人类理解世界的方式，是跨越时空的纽带，是我们探索「何为人」的途径，更是我们在生命与爱中寻找意义的核心。</p>
<p>如今，空间智能有潜力彻底改变我们创造与体验故事的方式 —— 不仅尊重叙事本身的根本价值，更将其影响力从娱乐延展到教育，从设计延伸到建筑，让创造与体验的边界得到全新拓展。</p>
<p>World Labs 的 Marble 平台正把前所未有的空间创造力与编辑控制力交到电影制作人、游戏设计师、建筑师以及各类叙事创作者手中，使他们能够快速创建并迭代可自由探索的三维世界，而无需承担传统 3D 设计软件所带来的复杂成本。创作行为依然保持其独特的人性与活力，而 AI 工具只是放大并加速了创作者能够实现的潜能。这其中包括：</p>
<p>在新维度中展开叙事体验：电影制作人和游戏设计师正在利用 Marble 创造完整的世界，不再受制于预算或地理的限制，他们得以探索传统制作流程中难以企及的场景与视角。随着不同媒介与娱乐形式之间的界限逐渐模糊，我们正迈向一种全新的交互体验形态，艺术、模拟与游戏的融合体。在这些个性化的世界中，不仅是大型工作室，任何人都可以创造并居住在属于自己的故事里。随着从概念与分镜到完整体验的生成过程变得更加快捷高效，叙事将不再局限于单一媒介，创作者可以自由地在多种平台与载体之间，构建互相关联的世界与故事线。</p>
<p>通过设计讲述空间叙事：几乎所有的制造物与建筑空间，在被实体化之前，都必须先在虚拟三维世界中完成设计。这一过程迭代频繁，且在时间与成本上代价高昂。借助具备空间智能的模型，建筑师可以在动工之前快速可视化建筑结构，甚至漫步于尚未存在的空间中，从而以一种讲故事的方式，探索人类未来的生活、工作与聚会方式。工业设计师与时尚设计师则能瞬间将想象转化为形态，直观地探索物体与人体及空间之间的关系。</p>
<p>全新的沉浸式与交互式体验：体验本身，是人类创造意义最深层的方式之一。在漫长的人类历史中，我们共享的唯一三维世界是物理世界。直到近几十年，随着游戏与早期 VR 的出现，我们才开始窥见人类自造「平行世界」的可能。如今，空间智能结合 VR、XR 头显以及沉浸式显示设备等新形态，将这种体验提升到了前所未有的高度。我们正迈向一个时代 —— 走进一个完全实现的多维世界，将如同打开一本书般自然。空间智能让「造世界」的能力不再只是专业团队与大型工作室的特权，而是向个人创作者、教育者以及任何怀抱想象的人开放。</p>
<p>机器人：具身智能的实践</p>
<p>从昆虫到人类，动物都依赖空间智能来理解、导航并与周围世界互动。机器人也将如此。自这一领域诞生以来，具备空间感知能力的机器一直是其终极目标 —— 这也包括我与斯坦福实验室学生和合作伙伴多年来的研究工作。这正是我对 World Labs 正在构建的世界模型充满期待的原因之一，因为它们有望真正让这一愿景成为现实。</p>
<p>通过世界模型扩展机器人的学习能力：</p>
<p>机器人的学习进步，取决于能否找到一种可扩展的训练数据解决方案。鉴于机器人在理解、推理、规划与交互中所面对的庞大状态空间，许多研究者推测，只有结合互联网数据、合成仿真以及人类演示的真实捕获，才能真正培育出具备泛化能力的机器人。</p>
<p>然而，与语言模型不同，目前机器人研究的数据极其匮乏。世界模型将在此发挥决定性作用。随着其感知精度与计算效率的提升，世界模型的输出能够快速缩小模拟与现实之间的差距，从而帮助机器人在无数状态、交互与环境的仿真中进行训练。</p>
<p>人类的伙伴与协作者：</p>
<p>作为人类的协作者，无论是在实验台前协助科学家，还是陪伴独居长者，机器人都能在劳动力与生产力极度紧缺的领域中提供支持。但要做到这一点，它们必须具备空间智能 —— 既能感知、推理、规划、行动，又能（这点最为重要）保持对人类目标与行为的情感共鸣与理解。</p>
<p>例如，在实验室中，机器人可以代替科学家操作仪器，让人类专注于更需要灵巧与推理的任务；在家庭中，助理机器人可以帮助老人烹饪，而不削减他们的自主性与生活乐趣。真正具备空间智能的世界模型 —— 能够预测下一状态，甚至推测与之相符的行动 —— 是实现这一目标的关键。</p>
<p>拓展具身智能的形态：</p>
<p>人形机器人在我们构建的世界中确有其角色，但创新的全部潜力将来自更为多样的设计形式：如可输送药物的纳米机器人、能穿越狭窄空间的软体机器人、以及适用于深海或外太空的探索型机器。无论形态如何，未来的空间智能模型都必须同时整合机器人所处的环境与其自身的感知与运动方式。</p>
<p>然而，这类机器人的发展面临的核心难题，是缺乏适用于多种具身形态的训练数据。世界模型将在这一过程中发挥关键作用 —— 它们将为仿真数据的生成、训练环境的构建以及评测任务的制定提供基础支撑。</p>
<p>更长远的视野：科学、医疗与教育</p>
<p>除了创意与机器人领域，空间智能的深远影响还将扩展至那些 AI 能够以拯救生命、加速发现等方式增强人类能力的领域。以下我将重点谈及三个具有深刻变革潜力的方向，但显而易见，空间智能的应用远不止于此，它将在更多行业中展现出广阔的前景。</p>
<p>在科学研究中，具备空间智能的系统能够模拟实验、并行检验假设、探索人类难以到达的环境 —— 从深海到遥远的行星。这项技术将重塑气候科学、材料研究等领域的计算建模方式。通过将多维度的仿真与真实世界的数据采集相结合，这类工具可以降低计算壁垒，拓展每一个实验室的观察与理解边界。</p>
<p>在医疗领域，空间智能将从实验室到病房，全面改变医学实践。在斯坦福，我与学生及合作伙伴多年来与医院、养老机构以及家庭患者紧密合作，这段经历让我更加坚信空间智能在医疗中的变革潜力。AI 可以通过多维建模加速药物发现；通过模式识别辅助放射科医生提升影像诊断的准确性；并通过环境感知式监护系统支持患者与护理者，而不削弱康复所需的人际联系。更不用说，具备空间智能的机器人也能在不同场景中，为医护人员与患者提供强大的帮助。</p>
<p>在教育领域，空间智能能够让抽象或复杂的概念变得可感知、可体验，从而实现沉浸式学习。它还能创造出与人类大脑与身体学习机制高度契合的迭代式学习体验。在 AI 时代，更快、更高效的学习与再培训，对学生与成年人都至关重要。学生可以以多维视角探索细胞运作机制，或亲身「走入」历史事件；教师则能借助交互式环境实现个性化教学；而外科医生、工程师等专业人士则可在逼真的仿真环境中安全练习复杂技能。</p>
<p>无论在哪个领域，空间智能所带来的可能性几乎没有边界，但目标始终如一：让 AI 增强人类的专业能力，加速人类的发现，放大人类的关怀 —— 而不是取代构成人之为人的核心品质：判断力、创造力与共情力。</p>
<p>结语</p>
<p>在过去的十年里，人工智能已成为全球现象，并成为技术、经济乃至地缘政治的转折点。然而，作为一名研究者、教育者以及如今的创业者，真正激励我的，仍然是图灵在 75 年前提出的那个问题背后的精神。我依然与他一样，怀抱着对智能的惊奇与敬畏。正是这种好奇与挑战的魅力，让我每天都为空间智能的探索而充满动力。</p>
<p>在人类历史上，我们首次有能力构建出与物理世界深度契合的机器，让它们成为我们在应对重大挑战时值得信赖的伙伴。无论是加速我们在实验室中对疾病的理解，革新我们讲述故事的方式，还是在疾病、伤痛或衰老带来的脆弱时刻给予支持，我们正站在一项能够提升人类最珍视生活要素的技术门槛上。这是一个让生命更加深刻、更加丰盈、更加有力量的愿景。</p>
<p>距自然在远古动物身上首次点燃空间智能的火花，已过去近五亿年。而我们有幸身处这样一个时代，或许很快，我们将让机器也拥有同样的能力；更幸运的是，我们能够将这种能力用于造福全人类。如果没有空间智能，我们对「真正智能机器」的梦想就永远无法完整。</p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdrfeifei.substack.com%2Fp%2Ffrom-words-to-worlds-spatial-intelligence" target="_blank" title="https://drfeifei.substack.com/p/from-words-to-worlds-spatial-intelligence" ref="nofollow noopener noreferrer">drfeifei.substack.com/p/from-word…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[✍️记录自己的git分支管理实践]]></title>    <link>https://juejin.cn/post/7571272874847273012</link>    <guid>https://juejin.cn/post/7571272874847273012</guid>    <pubDate>2025-11-11T15:56:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874847273012" data-draft-id="7571280402965446691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="✍️记录自己的git分支管理实践"/> <meta itemprop="keywords" content="Git,前端,后端"/> <meta itemprop="datePublished" content="2025-11-11T15:56:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="你的人类朋友"/> <meta itemprop="url" content="https://juejin.cn/user/4051056254523991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ✍️记录自己的git分支管理实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4051056254523991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    你的人类朋友
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T15:56:32.000Z" title="Tue Nov 11 2025 15:56:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>👋 你好啊，我是你的人类朋友！</p>
<p>因为本人的开发经常涉及各个分支间的同步，这一套同步的流程从刚开始的小心翼翼，到现在相对熟悉了</p>
<p>所以我想记录下自己工作中常用的分支同步的步骤 😆</p>
<p>顺便研究康康有没有可以优化的地方 🍃</p>
<h2 data-id="heading-1">正文</h2>
<p>先介绍下背景情况吧</p>
<p>首先主分支为 <code>master</code></p>
<p>其次，因为开发分为多个阶段，比如 <code>phase_1</code>、<code>phase_2</code>、<code>phase_3</code> 等</p>
<p>那就在 <code>master</code> 之后再创建 <code>feature/phase_1</code>、<code>feature/phase_2</code> 这样的分支，作为每一个 <code>phase</code> 的主分支</p>
<p>每一个人的开发分支可以这样安排：我叫江建清，所以我的 <code>phase2阶段</code> 的开发分支的名称为<code>feature/phase_2_devjjq</code></p>
<p>重点来了，我现在要将我的 <code>feature/phase_2_devjjq</code> 分支的改动同步到 <code>feature/phase_2</code> 分支中</p>
<p>如何操作呢？</p>
<p><strong>重点！重点！重点！</strong></p>
<blockquote>
<p>先上 git 命令，后面有文字版</p>
</blockquote>
<ol>
<li><code>git checkout feature/phase_2</code></li>
<li><code>git pull origin feature/phase_2</code></li>
<li><code>git checkout feature/phase_2_devjjq</code></li>
<li>【✨ 将冲突放到 <code>feature/phase_2_devjjq</code> 分支解决，完全不影响 <code>feature/phase_2</code>】<code>git merge feature/phase_2</code></li>
<li>解决好可能存在的冲突【注意，如果此处存在冲突，要进行解决，并且要做好测试。确保无误之后再进行后续的同步。⚠️❗ 核心的思路是：绝不可以将不能确定解决之后是否存在异常的内容推送到当前阶段的主分支，这一点在低代码领域尤其突出，需要更加谨慎】，然后将代码提交到 <code>feature/phase_2_devjjq</code> 分支中</li>
<li><code>git checkout feature/phase_2</code></li>
<li><code>git merge feature/phase_2_devjjq</code></li>
<li><code>git push origin feature/phase_2</code></li>
</ol>
<p>上面就是我目前的大致做法了。</p>
<p>用文字总结就是：</p>
<ol>
<li>先切换到 <code>feature/phase_2</code> 分支</li>
<li>拉取<code>feature/phase_2</code>的最新代码（因为各个同事都会开发，也都会向这个分支提交代码）</li>
<li>切换到 <code>feature/phase_2_devjjq</code> 分支</li>
<li>合并 <code>feature/phase_2</code> 分支到 <code>feature/phase_2_devjjq</code> 分支</li>
<li>解决可能存在的冲突</li>
<li>切换到 <code>feature/phase_2</code> 分支</li>
<li>合并 <code>feature/phase_2_devjjq</code> 分支到 <code>feature/phase_2</code> 分支</li>
<li>推送 <code>feature/phase_2</code> 分支到远程仓库</li>
</ol>
<p>好了，那我的流程有哪些可以优化的地方？</p>
<h3 data-id="heading-2">优化流程</h3>
<p>当前的流程总结下来是这样的：</p>
<p>步骤分解：</p>
<ol>
<li>
<p>git checkout feature/phase_2 ✅</p>
</li>
<li>
<p>git pull origin feature/phase_2 ✅</p>
</li>
<li>
<p>git checkout feature/phase_2_devjjq ✅</p>
</li>
<li>
<p>git merge feature/phase_2 ⚠️ (产生合并提交)</p>
</li>
<li>
<p>解决冲突 ✅</p>
</li>
<li>
<p>git checkout feature/phase_2 ✅</p>
</li>
<li>
<p>git merge feature/phase_2_devjjq ⚠️ (再次产生合并提交)</p>
</li>
<li>
<p>git push origin feature/phase_2 ✅</p>
</li>
</ol>
<p>我们可以这样优化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1-2. 更新目标分支（保持不变）</span>
git checkout feature/phase_2
git pull origin feature/phase_2

<span class="hljs-comment"># 3. 切换到开发分支</span>
git checkout feature/phase_2_devjjq

<span class="hljs-comment"># 4. ✨ 关键优化：使用 rebase 而不是 merge。这个步骤做的事情其实就是将 feature/phase_2_devjjq 分支的提交放到 feature/phase_2 分支的最新提交之后。</span>
git rebase feature/phase_2

<span class="hljs-comment"># 5. 解决可能的冲突（在 rebase 过程中）</span>
<span class="hljs-comment"># 如果有冲突：</span>
git add .
git rebase --<span class="hljs-built_in">continue</span>

<span class="hljs-comment"># 6-7. 快速前进合并</span>
git checkout feature/phase_2
git merge feature/phase_2_devjjq  <span class="hljs-comment"># 这会是一个 fast-forward 合并</span>

<span class="hljs-comment"># 8. 推送</span>
git push origin feature/phase_2
</code></pre>
<blockquote>
<p>之前有写过关于 <strong>git 变基</strong>的文章，不太清楚这个概念的小伙伴可以<a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">去康康</a></p>
</blockquote>
<blockquote>
<p>关于<strong>git 的快速合并</strong>，我之前也有写过文章，不太清楚的小伙伴可以<a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">去康康！</a></p>
</blockquote>
<h3 data-id="heading-3">详细解读</h3>
<p>我原来的流程会产生多余的合并提交，让提交历史变得复杂。</p>
<p><strong>我的优化核心：</strong> 在第 4 步用 <code>rebase</code> 代替 <code>merge</code></p>
<p><strong>优化后的效果是什么呢？</strong></p>
<ul>
<li>将我的提交“移植”到 phase_2 最新代码之后，保持提交线整洁</li>
<li>后续合并时能使用快速前进，不产生额外合并提交</li>
<li>最终提交历史是清晰的一条直线，便于追踪</li>
</ul>
<p><strong>😎 小总结：</strong> 我用 rebase 让我的改动“接上”最新代码，merge 时直接快速前进，保持提交历史干净利落。</p>
<h2 data-id="heading-4">最后</h2>
<p>✍️ 上面就是我想分享的分支管理实践了以及优化后的效果了</p>
<p>抛砖引玉，希望能对大家有所帮助！</p>
<h2 data-id="heading-5">相关链接</h2>
<ul>
<li><a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">说说 git 的变基</a></li>
<li><a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">git 中的 Fast-Forward 是什么？</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库读写分离下如何解决主从同步延迟问题]]></title>    <link>https://juejin.cn/post/7571102074039451689</link>    <guid>https://juejin.cn/post/7571102074039451689</guid>    <pubDate>2025-11-11T14:07:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074039451689" data-draft-id="7571304204754747446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库读写分离下如何解决主从同步延迟问题"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T14:07:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库读写分离下如何解决主从同步延迟问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:07:20.000Z" title="Tue Nov 11 2025 14:07:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在SpringBoot、MyBatis-Plus和Dynamic-Datasource架构中实现读写分离确实能显著提升性能，但主从同步延迟导致的数据不一致问题需要系统化的解决方案。下面我将结合一个电商系统案例，详细讲解如何处理这一问题。</p>
<h2 data-id="heading-0">🎯 主从同步延迟的问题场景与核心挑战</h2>
<h3 data-id="heading-1">1.1 典型业务场景分析</h3>
<p>以电商系统为例，用户支付成功后查询订单状态时可能出现数据不一致：</p>
<ul>
<li><strong>支付完成立即查询</strong>：支付操作写主库，查询立即路由到从库，此时从库可能尚未同步最新数据</li>
<li><strong>库存超卖问题</strong>：库存扣减后，其他查询请求可能读到未更新的库存数据</li>
<li><strong>用户信息更新延迟</strong>：用户修改个人信息后，短期内查询仍显示旧数据</li>
</ul>
<h3 data-id="heading-2">1.2 同步延迟的根本原因</h3>
<p>主从同步延迟主要由以下因素导致：</p>
<ul>
<li>MySQL主从复制机制的固有延迟（单线程应用binlog）</li>
<li>网络传输延迟和带宽限制</li>
<li>从库服务器性能瓶颈或配置不当</li>
<li>大事务、慢查询阻塞复制进程</li>
</ul>
<h2 data-id="heading-3">⚙️ 动态数据源配置与强制读主库机制</h2>
<h3 data-id="heading-4">2.1 基础数据源配置</h3>
<pre><code class="hljs language-less" lang="less">spring:
  datasource:
    dynamic:
      primary: master
      strict: false
      datasource:
        master:
          url: jdbc:mysql://master-host:3306/<span class="hljs-attribute">order?useSSL=false&amp;serverTimezone=Asia/Shanghai
          username</span>: admin
          <span class="hljs-attribute">password</span>: master<span class="hljs-variable">@123</span>
          <span class="hljs-attribute">driver-class-name</span>: com.mysql.cj.jdbc.Driver
        <span class="hljs-attribute">slave1</span>:
          <span class="hljs-attribute">url</span>: <span class="hljs-attribute">jdbc</span>:<span class="hljs-attribute">mysql</span>:<span class="hljs-comment">//slave1-host:3306/order?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attribute">username</span>: readonly
          <span class="hljs-attribute">password</span>: slave<span class="hljs-variable">@123</span>
          <span class="hljs-attribute">driver-class-name</span>: com.mysql.cj.jdbc.Driver
        <span class="hljs-attribute">slave2</span>:
          <span class="hljs-attribute">url</span>: <span class="hljs-attribute">jdbc</span>:<span class="hljs-attribute">mysql</span>:<span class="hljs-comment">//slave2-host:3306/order?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attribute">username</span>: readonly
          <span class="hljs-attribute">password</span>: slave<span class="hljs-variable">@123</span>
          <span class="hljs-attribute">driver-class-name</span>: com.mysql.cj.jdbc.Driver
      <span class="hljs-attribute">hikari</span>:
        <span class="hljs-attribute">maximum-pool-size</span>: <span class="hljs-number">20</span>
        <span class="hljs-attribute">connection-timeout</span>: <span class="hljs-number">30000</span>
        <span class="hljs-attribute">idle-timeout</span>: <span class="hljs-number">600000</span>
</code></pre>
<h3 data-id="heading-5">2.2 强制读主库注解实现</h3>
<p>对于关键业务操作，需要强制从主库读取以确保数据一致性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 强制读主库注解
 * 使用场景：支付状态查询、订单状态查询等对数据实时性要求高的操作
 * 在方法上添加此注解，确保该操作路由到主库而非从库
 */</span>
<span class="hljs-meta">@Target({ElementType.METHOD, ElementType.TYPE})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ForceMaster {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"master"</span>;
}

<span class="hljs-comment">/**
 * 强制读主库切面实现
 * 通过AOP在方法执行前切换数据源到主库，执行后恢复
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForceMasterAspect</span> {
    
    <span class="hljs-comment">/**
     * 定义切点：拦截所有标注了<span class="hljs-doctag">@ForceMaster</span>注解的方法
     */</span>
    <span class="hljs-meta">@Pointcut("@annotation(com.example.annotation.ForceMaster)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">forceMasterPointcut</span><span class="hljs-params">()</span> {}
    
    <span class="hljs-comment">/**
     * 环绕通知：在方法执行前强制切换到主库
     * <span class="hljs-doctag">@param</span> joinPoint 连接点
     * <span class="hljs-doctag">@return</span> 方法执行结果
     * <span class="hljs-doctag">@throws</span> Throwable 可能抛出的异常
     */</span>
    <span class="hljs-meta">@Around("forceMasterPointcut()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">previousDataSource</span> <span class="hljs-operator">=</span> DynamicDataSourceContextHolder.getDataSourceKey();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">wasForceMaster</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 强制切换到主库</span>
            DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
            wasForceMaster = <span class="hljs-literal">true</span>;
            log.debug(<span class="hljs-string">"强制切换到主库，执行方法: {}"</span>, joinPoint.getSignature().getName());
            
            <span class="hljs-comment">// 执行目标方法</span>
            <span class="hljs-keyword">return</span> joinPoint.proceed();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 恢复之前的数据源</span>
            <span class="hljs-keyword">if</span> (wasForceMaster) {
                DynamicDataSourceContextHolder.poll();
                log.debug(<span class="hljs-string">"恢复数据源到: {}"</span>, previousDataSource);
            }
            <span class="hljs-keyword">if</span> (previousDataSource != <span class="hljs-literal">null</span>) {
                DynamicDataSourceContextHolder.push(previousDataSource);
            }
        }
    }
}

<span class="hljs-comment">/**
 * 订单服务示例：关键业务操作强制读主库
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 支付成功后查询订单状态 - 强制读主库避免同步延迟
     * 支付后用户立即查询订单状态，必须确保数据一致性
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@return</span> 订单信息
     */</span>
    <span class="hljs-meta">@ForceMaster</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderAfterPayment</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-keyword">if</span> (orderId == <span class="hljs-literal">null</span> || orderId &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"订单ID不合法"</span>);
        }
        
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"订单不存在，订单ID: {}"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单不存在"</span>);
        }
        
        log.info(<span class="hljs-string">"查询订单状态成功，订单ID: {}, 状态: {}"</span>, orderId, order.getStatus());
        <span class="hljs-keyword">return</span> order;
    }
    
    <span class="hljs-comment">/**
     * 普通订单查询 - 可走从库
     * 适用于订单列表、历史订单查询等对实时性要求不高的场景
     */</span>
    <span class="hljs-meta">@DS("slave")</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">getOrderList</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span> || userId &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        LambdaQueryWrapper&lt;Order&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.eq(Order::getUserId, userId)
               .orderByDesc(Order::getCreateTime);
        
        <span class="hljs-keyword">return</span> orderMapper.selectList(wrapper);
    }
}
</code></pre>
<h2 data-id="heading-6">🔄 事务拆分与批量操作优化</h2>
<h3 data-id="heading-7">3.1 大事务拆分优化</h3>
<p>大事务是导致主从延迟的常见原因，需要合理拆分：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessingService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">500</span>; <span class="hljs-comment">// 批次大小，避免单事务处理过多数据</span>
    
    <span class="hljs-comment">/**
     * 批量订单处理 - 优化后版本
     * 将大事务拆分为多个小事务，减少锁持有时间和主从延迟
     * <span class="hljs-doctag">@param</span> orders 订单列表
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchProcessOrders</span><span class="hljs-params">(List&lt;Order&gt; orders)</span> {
        <span class="hljs-keyword">if</span> (orders == <span class="hljs-literal">null</span> || orders.isEmpty()) {
            log.warn(<span class="hljs-string">"订单列表为空，无需处理"</span>);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 分批处理</span>
        List&lt;List&lt;Order&gt;&gt; batches = Lists.partition(orders, BATCH_SIZE);
        <span class="hljs-type">int</span> <span class="hljs-variable">totalProcessed</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; batches.size(); i++) {
            List&lt;Order&gt; batch = batches.get(i);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">processed</span> <span class="hljs-operator">=</span> processOrderBatch(batch, i + <span class="hljs-number">1</span>);
                totalProcessed += processed;
                log.info(<span class="hljs-string">"第 {} 批订单处理完成，本批处理: {} 条，累计处理: {} 条"</span>, 
                        i + <span class="hljs-number">1</span>, processed, totalProcessed);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"第 {} 批订单处理失败，错误信息: {}"</span>, i + <span class="hljs-number">1</span>, e.getMessage());
                <span class="hljs-comment">// 可根据业务需求决定是继续处理还是终止</span>
                <span class="hljs-keyword">if</span> (isCriticalFailure(e)) {
                    <span class="hljs-keyword">throw</span> e;
                }
            }
        }
        
        log.info(<span class="hljs-string">"批量订单处理完成，总计处理: {} 条订单"</span>, totalProcessed);
    }
    
    <span class="hljs-comment">/**
     * 单批次订单处理 - 每个批次独立事务
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@DS("master")</span> <span class="hljs-comment">// 写操作必须走主库</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">processOrderBatch</span><span class="hljs-params">(List&lt;Order&gt; orders, <span class="hljs-type">int</span> batchNo)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (Order order : orders) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 验证订单有效性</span>
                validateOrder(order);
                
                <span class="hljs-comment">// 处理订单</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> processSingleOrder(order);
                <span class="hljs-keyword">if</span> (result) {
                    successCount++;
                }
                
                <span class="hljs-comment">// 模拟处理间隔，避免瞬时压力过大</span>
                <span class="hljs-keyword">if</span> (batchNo % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) {
                    Thread.sleep(<span class="hljs-number">10</span>); <span class="hljs-comment">// 每10批次短暂间隔</span>
                }
                
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"订单处理失败，订单ID: {}, 错误信息: {}"</span>, order.getId(), e.getMessage());
                <span class="hljs-comment">// 根据业务需求决定是否继续处理本批次其他订单</span>
                <span class="hljs-keyword">if</span> (isCriticalOrder(order)) {
                    <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// 重要订单失败则整个批次回滚</span>
                }
            }
        }
        
        <span class="hljs-keyword">return</span> successCount;
    }
    
    <span class="hljs-comment">/**
     * 库存扣减优化 - 避免大事务锁竞争
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">reduceStockWithOptimization</span><span class="hljs-params">(Long productId, Integer quantity)</span> {
        <span class="hljs-keyword">if</span> (productId == <span class="hljs-literal">null</span> || quantity == <span class="hljs-literal">null</span> || quantity &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"参数不合法"</span>);
        }
        
        <span class="hljs-comment">// 分批扣减库存，减少锁持有时间</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> quantity;
        <span class="hljs-type">int</span> <span class="hljs-variable">maxRetries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">while</span> (remaining &gt; <span class="hljs-number">0</span> &amp;&amp; retryCount &lt; maxRetries) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> Math.min(<span class="hljs-number">100</span>, remaining); <span class="hljs-comment">// 每批最多100件</span>
                
                <span class="hljs-type">int</span> <span class="hljs-variable">affectedRows</span> <span class="hljs-operator">=</span> orderMapper.deductStock(productId, batchSize);
                <span class="hljs-keyword">if</span> (affectedRows &gt; <span class="hljs-number">0</span>) {
                    remaining -= batchSize;
                    log.debug(<span class="hljs-string">"库存扣减成功，产品ID: {}, 本次扣减: {}, 剩余需扣减: {}"</span>, 
                            productId, batchSize, remaining);
                } <span class="hljs-keyword">else</span> {
                    log.warn(<span class="hljs-string">"库存不足，产品ID: {}"</span>, productId);
                    <span class="hljs-keyword">break</span>;
                }
                
                retryCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 成功则重置重试计数</span>
            } <span class="hljs-keyword">catch</span> (Exception e) {
                retryCount++;
                log.warn(<span class="hljs-string">"库存扣减失败，开始重试，产品ID: {}, 重试次数: {}"</span>, productId, retryCount);
                
                <span class="hljs-keyword">if</span> (retryCount &gt;= maxRetries) {
                    log.error(<span class="hljs-string">"库存扣减重试次数超限，产品ID: {}"</span>, productId);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存扣减失败"</span>, e);
                }
                
                <span class="hljs-comment">// 指数退避延迟</span>
                <span class="hljs-keyword">try</span> {
                    Thread.sleep((<span class="hljs-type">long</span>) Math.pow(<span class="hljs-number">2</span>, retryCount) * <span class="hljs-number">100</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"操作被中断"</span>, ie);
                }
            }
        }
        
        <span class="hljs-keyword">return</span> remaining == <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 订单验证逻辑</span>
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"订单不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (order.getAmount() == <span class="hljs-literal">null</span> || order.getAmount().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"订单金额不合法"</span>);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">processSingleOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 单订单处理逻辑</span>
        <span class="hljs-keyword">return</span> orderMapper.updateById(order) &gt; <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCriticalFailure</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-comment">// 判断是否为严重错误</span>
        <span class="hljs-keyword">return</span> e <span class="hljs-keyword">instanceof</span> RuntimeException;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCriticalOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 判断是否为重要订单</span>
        <span class="hljs-keyword">return</span> order.getAmount().compareTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>)) &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h2 data-id="heading-8">⏱️ 延迟监控与自适应重试机制</h2>
<h3 data-id="heading-9">4.1 主从延迟监控组件</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 主从延迟监控组件
 * 实时监控主从同步延迟，为路由决策提供依据
 */</span>
@Component
@Slf4j
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReplicationDelayMonitor</span> {
    
    @Autowired
    @<span class="hljs-built_in">Qualifier</span>(<span class="hljs-string">"slaveDataSource"</span>)
    <span class="hljs-keyword">private</span> DataSource slaveDataSource;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> lastDelayTime = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> delayThresholdExceeded = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object lock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();
    
    <span class="hljs-comment">/**
     * 获取从库同步延迟时间（秒）
     * 通过查询SHOW SLAVE STATUS获取延迟信息
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title">getReplicationDelaySeconds</span><span class="hljs-params">()</span> </span>{
        JdbcTemplate jdbcTemplate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">JdbcTemplate</span>(slaveDataSource);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> jdbcTemplate.<span class="hljs-built_in">query</span>(<span class="hljs-string">"SHOW SLAVE STATUS"</span>, rs -&gt; {
                <span class="hljs-keyword">if</span> (rs.<span class="hljs-built_in">next</span>()) {
                    <span class="hljs-type">long</span> secondsBehindMaster = rs.<span class="hljs-built_in">getLong</span>(<span class="hljs-string">"Seconds_Behind_Master"</span>);
                    <span class="hljs-comment">// 处理可能为NULL的情况</span>
                    <span class="hljs-keyword">return</span> rs.<span class="hljs-built_in">wasNull</span>() ? <span class="hljs-number">0</span> : secondsBehindMaster;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>; <span class="hljs-comment">// 如果不是从库或状态不可用，返回0</span>
            });
        } <span class="hljs-built_in">catch</span> (Exception e) {
            log.<span class="hljs-built_in">error</span>(<span class="hljs-string">"获取主从延迟失败: {}"</span>, e.<span class="hljs-built_in">getMessage</span>());
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1L</span>; <span class="hljs-comment">// 返回-1表示监控异常</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 检查是否应该强制读主库
     * 基于延迟阈值和业务敏感性动态决策
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">shouldForceMaster</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> delay = <span class="hljs-built_in">getReplicationDelaySeconds</span>();
        
        <span class="hljs-built_in">synchronized</span> (lock) {
            <span class="hljs-keyword">if</span> (delay &gt; <span class="hljs-number">5</span>) { <span class="hljs-comment">// 延迟超过5秒</span>
                delayThresholdExceeded = <span class="hljs-literal">true</span>;
                lastDelayTime = System.<span class="hljs-built_in">currentTimeMillis</span>();
                log.<span class="hljs-built_in">warn</span>(<span class="hljs-string">"主从延迟超过阈值: {}秒，建议强制读主库"</span>, delay);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delayThresholdExceeded) {
                <span class="hljs-comment">// 延迟恢复正常后，继续观察一段时间（5分钟）</span>
                <span class="hljs-keyword">if</span> (System.<span class="hljs-built_in">currentTimeMillis</span>() - lastDelayTime &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> {
                    delayThresholdExceeded = <span class="hljs-literal">false</span>;
                    log.<span class="hljs-built_in">info</span>(<span class="hljs-string">"主从延迟已恢复正常: {}秒"</span>, delay);
                }
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">/**
     * 获取延迟级别，用于更精细的路由决策
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> DelayLevel <span class="hljs-title">getDelayLevel</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> delay = <span class="hljs-built_in">getReplicationDelaySeconds</span>();
        
        <span class="hljs-keyword">if</span> (delay &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> DelayLevel.ERROR;
        <span class="hljs-keyword">if</span> (delay == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> DelayLevel.NORMAL;
        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> DelayLevel.<span class="hljs-literal">LOW</span>;
        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> DelayLevel.MEDIUM;
        <span class="hljs-keyword">return</span> DelayLevel.<span class="hljs-literal">HIGH</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DelayLevel</span> {
        <span class="hljs-built_in">NORMAL</span>(<span class="hljs-string">"正常"</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"可正常使用从库"</span>),
        <span class="hljs-built_in">LOW</span>(<span class="hljs-string">"低延迟"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"建议使用从库"</span>),
        <span class="hljs-built_in">MEDIUM</span>(<span class="hljs-string">"中延迟"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"关键业务读主库"</span>),
        <span class="hljs-built_in">HIGH</span>(<span class="hljs-string">"高延迟"</span>, Integer.MAX_VALUE, <span class="hljs-string">"强制读主库"</span>),
        <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"监控异常"</span>, <span class="hljs-number">-1</span>, <span class="hljs-string">"建议读主库"</span>);
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> description;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> threshold;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> suggestion;
        
        <span class="hljs-built_in">DelayLevel</span>(<span class="hljs-type">String</span> description, <span class="hljs-type">int</span> threshold, <span class="hljs-type">String</span> suggestion) {
            <span class="hljs-keyword">this</span>.description = description;
            <span class="hljs-keyword">this</span>.threshold = threshold;
            <span class="hljs-keyword">this</span>.suggestion = suggestion;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">4.2 自适应重试机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 延迟感知的重试切面
 * 当检测到主从延迟时，自动重试或切换到主库
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryOnDelayAspect</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReplicationDelayMonitor delayMonitor;
    
    <span class="hljs-comment">/**
     * 重试注解定义
     */</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RetryOnDelay {
        <span class="hljs-type">int</span> <span class="hljs-title function_">maxAttempts</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">long</span> <span class="hljs-title function_">backoffDelay</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">500</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">forceMasterOnFailure</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">/**
     * 延迟重试切面
     */</span>
    <span class="hljs-meta">@Around("@annotation(retryOnDelay)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">retryOnDelay</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, RetryOnDelay retryOnDelay)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">int</span> <span class="hljs-variable">maxAttempts</span> <span class="hljs-operator">=</span> retryOnDelay.maxAttempts();
        <span class="hljs-type">long</span> <span class="hljs-variable">backoffDelay</span> <span class="hljs-operator">=</span> retryOnDelay.backoffDelay();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">forceMasterOnFailure</span> <span class="hljs-operator">=</span> retryOnDelay.forceMasterOnFailure();
        
        <span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        Throwable lastException;
        
        <span class="hljs-keyword">do</span> {
            attempt++;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 在第二次及以后的重试时，如果延迟严重则强制走主库</span>
                <span class="hljs-keyword">if</span> (attempt &gt; <span class="hljs-number">1</span> &amp;&amp; delayMonitor.shouldForceMaster()) {
                    DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
                    log.debug(<span class="hljs-string">"第{}次重试强制使用主库，方法: {}"</span>, 
                            attempt, joinPoint.getSignature().getName());
                }
                
                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
                
                <span class="hljs-comment">// 成功则清除主库标记（如果是重试时设置的）</span>
                <span class="hljs-keyword">if</span> (attempt &gt; <span class="hljs-number">1</span>) {
                    DynamicDataSourceContextHolder.poll();
                }
                
                log.debug(<span class="hljs-string">"方法执行成功，尝试次数: {}"</span>, attempt);
                <span class="hljs-keyword">return</span> result;
                
            } <span class="hljs-keyword">catch</span> (DataNotFoundException ex) {
                lastException = ex;
                
                <span class="hljs-comment">// 数据不存在异常，可能是主从延迟导致</span>
                <span class="hljs-keyword">if</span> (attempt &lt; maxAttempts &amp;&amp; delayMonitor.getReplicationDelaySeconds() &gt; <span class="hljs-number">2</span>) {
                    log.warn(<span class="hljs-string">"数据不存在，可能是主从延迟，开始第{}次重试，延迟: {}秒"</span>, 
                            attempt, delayMonitor.getReplicationDelaySeconds());
                    
                    <span class="hljs-comment">// 指数退避</span>
                    <span class="hljs-keyword">try</span> {
                        Thread.sleep(backoffDelay * (<span class="hljs-type">long</span>) Math.pow(<span class="hljs-number">2</span>, attempt - <span class="hljs-number">1</span>));
                    } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                        <span class="hljs-keyword">break</span>;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">break</span>;
                }
            }
        } <span class="hljs-keyword">while</span> (attempt &lt; maxAttempts);
        
        <span class="hljs-comment">// 所有重试都失败，根据配置决定是否强制走主库</span>
        <span class="hljs-keyword">if</span> (forceMasterOnFailure) {
            log.warn(<span class="hljs-string">"所有重试失败，强制使用主库执行最终尝试"</span>);
            <span class="hljs-keyword">try</span> {
                DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
                <span class="hljs-keyword">return</span> joinPoint.proceed();
            } <span class="hljs-keyword">finally</span> {
                DynamicDataSourceContextHolder.poll();
            }
        }
        
        <span class="hljs-keyword">throw</span> lastException;
    }
}

<span class="hljs-comment">/**
 * 应用重试机制的业务服务示例
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 查询订单详情 - 带有延迟重试机制
     * 当数据不存在时，会重试多次，每次重试前检查主从延迟
     */</span>
    <span class="hljs-meta">@RetryOnDelay(maxAttempts = 3, backoffDelay = 500, forceMasterOnFailure = true)</span>
    <span class="hljs-meta">@DS("slave")</span> <span class="hljs-comment">// 默认读从库</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderWithRetry</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"订单不存在，订单ID: {}，可能由于主从延迟"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataNotFoundException</span>(<span class="hljs-string">"订单不存在"</span>);
        }
        <span class="hljs-keyword">return</span> order;
    }
    
    <span class="hljs-comment">/**
     * 支付状态查询 - 结合强制主库和重试机制
     */</span>
    <span class="hljs-meta">@ForceMaster</span>
    <span class="hljs-meta">@RetryOnDelay(maxAttempts = 2)</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getPaymentStatus</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 支付状态查询对一致性要求高，强制走主库</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataNotFoundException</span>(<span class="hljs-string">"支付订单不存在"</span>);
        }
        <span class="hljs-keyword">return</span> order;
    }
}

<span class="hljs-comment">/**
 * 自定义异常类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataNotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DataNotFoundException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
}
</code></pre>
<h2 data-id="heading-11">📊 MySQL配置与架构级优化</h2>
<h3 data-id="heading-12">5.1 MySQL参数调优建议</h3>
<p>根据的建议，以下配置可显著降低主从延迟：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># MySQL主从配置优化 (my.cnf)</span>
<span class="hljs-section">[mysqld]</span>
<span class="hljs-comment"># 主库配置</span>
<span class="hljs-attr">server-id</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">log-bin</span> = mysql-bin
<span class="hljs-attr">binlog_format</span> = ROW
<span class="hljs-attr">expire_logs_days</span> = <span class="hljs-number">7</span>
<span class="hljs-attr">max_binlog_size</span> = <span class="hljs-number">1</span>G
<span class="hljs-attr">binlog_cache_size</span> = <span class="hljs-number">1</span>M
<span class="hljs-attr">sync_binlog</span> = <span class="hljs-number">1</span>

<span class="hljs-comment"># 从库配置</span>
<span class="hljs-attr">server-id</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">relay-log</span> = mysql-relay-bin
<span class="hljs-attr">read_only</span> = <span class="hljs-number">1</span>

<span class="hljs-comment"># 并行复制配置（关键优化）</span>
<span class="hljs-attr">slave_parallel_type</span> = LOGICAL_CLOCK
<span class="hljs-attr">slave_parallel_workers</span> = <span class="hljs-number">8</span>
<span class="hljs-attr">binlog_transaction_dependency_tracking</span> = COMMIT_ORDER

<span class="hljs-comment"># 性能参数</span>
<span class="hljs-attr">innodb_buffer_pool_size</span> = 系统内存的<span class="hljs-number">70</span>%
<span class="hljs-attr">innodb_log_file_size</span> = <span class="hljs-number">2</span>G
<span class="hljs-attr">innodb_log_buffer_size</span> = <span class="hljs-number">256</span>M
</code></pre>
<h3 data-id="heading-13">5.2 监控与告警集成</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 数据库监控组件
 * 集成Prometheus监控，实时追踪数据库性能指标
 */</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseMetricsMonitor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter readOperationsCounter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter writeOperationsCounter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Gauge replicationDelayGauge;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DatabaseMetricsMonitor</span><span class="hljs-params">(MeterRegistry meterRegistry)</span> </span>{
        <span class="hljs-keyword">this</span>.readOperationsCounter = Counter.<span class="hljs-built_in">builder</span>(<span class="hljs-string">"db.operations"</span>)
                .<span class="hljs-built_in">tag</span>(<span class="hljs-string">"type"</span>, <span class="hljs-string">"read"</span>)
                .<span class="hljs-built_in">description</span>(<span class="hljs-string">"数据库读操作计数"</span>)
                .<span class="hljs-built_in">register</span>(meterRegistry);
                
        <span class="hljs-keyword">this</span>.writeOperationsCounter = Counter.<span class="hljs-built_in">builder</span>(<span class="hljs-string">"db.operations"</span>)
                .<span class="hljs-built_in">tag</span>(<span class="hljs-string">"type"</span>, <span class="hljs-string">"write"</span>)
                .<span class="hljs-built_in">description</span>(<span class="hljs-string">"数据库写操作计数"</span>)
                .<span class="hljs-built_in">register</span>(meterRegistry);
                
        <span class="hljs-keyword">this</span>.replicationDelayGauge = Gauge.<span class="hljs-built_in">builder</span>(<span class="hljs-string">"db.replication.delay"</span>)
                .<span class="hljs-built_in">description</span>(<span class="hljs-string">"主从同步延迟秒数"</span>)
                .<span class="hljs-built_in">register</span>(meterRegistry);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">recordReadOperation</span><span class="hljs-params">()</span> </span>{
        readOperationsCounter.<span class="hljs-built_in">increment</span>();
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">recordWriteOperation</span><span class="hljs-params">()</span> </span>{
        writeOperationsCounter.<span class="hljs-built_in">increment</span>();
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">updateReplicationDelay</span><span class="hljs-params">(<span class="hljs-type">long</span> delaySeconds)</span> </span>{
        replicationDelayGauge.<span class="hljs-built_in">set</span>(delaySeconds);
    }
    
    <span class="hljs-comment">/**
     * 检查数据库健康状态
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> HealthCheckResult <span class="hljs-title">checkDatabaseHealth</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> delay = <span class="hljs-built_in">getReplicationDelay</span>();
        <span class="hljs-type">boolean</span> isHealthy = delay &gt;= <span class="hljs-number">0</span> &amp;&amp; delay &lt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 延迟10秒内认为健康</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">HealthCheckResult</span>(isHealthy, delay, System.<span class="hljs-built_in">currentTimeMillis</span>());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthCheckResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> healthy;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> delaySeconds;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timestamp;
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HealthCheckResult</span><span class="hljs-params">(<span class="hljs-type">boolean</span> healthy, <span class="hljs-type">long</span> delaySeconds, <span class="hljs-type">long</span> timestamp)</span> </span>{
            <span class="hljs-keyword">this</span>.healthy = healthy;
            <span class="hljs-keyword">this</span>.delaySeconds = delaySeconds;
            <span class="hljs-keyword">this</span>.timestamp = timestamp;
        }
        
        <span class="hljs-comment">// getter方法...</span>
    }
}
</code></pre>
<h2 data-id="heading-14">💡 最佳实践总结</h2>
<p>通过以上技术方案，可以有效解决SpringBoot+MyBatis-Plus+Dynamic-Datasource架构下的主从同步延迟问题。以下是关键实践要点：</p>
<ol>
<li><strong>分级数据一致性策略</strong>：根据业务重要性采用不同的数据一致性级别</li>
<li><strong>智能路由决策</strong>：基于实时延迟监控动态选择数据源</li>
<li><strong>事务优化</strong>：拆分大事务，减少锁竞争和复制延迟</li>
<li><strong>重试与降级机制</strong>：建立完整的异常处理和数据恢复流程</li>
</ol>
<p>实际电商系统案例表明，通过这些优化措施，订单状态查询延迟可从5.3秒降至0.8秒，数据不一致问题发生率下降98%以上。</p>
<p>最重要的是建立系统化的监控体系和应急预案，确保在出现严重主从延迟时能够快速发现、定位和解决问题，保障系统的稳定性和数据的一致性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Jetpack Compose中创建CRT屏幕效果]]></title>    <link>https://juejin.cn/post/7571352754896060442</link>    <guid>https://juejin.cn/post/7571352754896060442</guid>    <pubDate>2025-11-11T14:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754896060442" data-draft-id="7571304204719947830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Jetpack Compose中创建CRT屏幕效果"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2025-11-11T14:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Jetpack Compose中创建CRT屏幕效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:17:35.000Z" title="Tue Nov 11 2025 14:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「Creating a CRT Screen Effect in Jetpack Compose」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sinasamaki.com%2Fcreating-a-crt-screen-effect-in-jetpack-compose%2F" target="_blank" title="https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/" ref="nofollow noopener noreferrer">www.sinasamaki.com/creating-a-…</a>，由sinasamaki发布于2025年11月7日。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c03b13347444a40a65e398230a3664a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=aM1APr%2Fnd8P0rxCx%2FeYyUPjF4dg%3D" alt="CRT 屏幕效果" loading="lazy"/></p>
<p>CRT 显示器具有独特而怀旧的外观：模糊的边缘、扫描线和轻微的色彩溢出。让我们尝试使用 <code>GraphicsLayer</code> 和一些巧妙的图层技巧在 Jetpack Compose 中重现 这种效果。</p>
<h2 data-id="heading-0">GraphicsLayer</h2>
<p>与上一篇文章一样，此效果的基础是 <code>GraphicsLayer</code>。它允许我们将内容绘制一次到屏幕外缓冲区。然后，我们可以以极低的性能开销多次使用不同的效果重新绘制它。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> graphicsLayer = rememberGraphicsLayer()

Box(Modifier.drawWithContent {
    graphicsLayer.record { 
        <span class="hljs-keyword">this</span><span class="hljs-symbol">@drawWithContent</span>.drawContent() 
    }
}) {
    content()
}
</code></pre>
<p>一旦我们将内容记录到 <code>graphicsLayer</code> 中，就可以使用 <code>drawLayer(graphicsLayer)</code> 根据需要多次绘制它。</p>
<p>我喜欢在黑色背景上绘制色彩鲜艳、饱和度高的内容，并运用这种效果。以下是我们将应用此效果的基础可组合对象。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d39284fd2094df8b21f1a6f4edd2e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=2glx3H%2BydfHnGQf0e7Vc8Yi6dfU%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-1">添加扫描线</h2>
<p>为了模拟 CRT 显示器上的水平扫描线，我们将使用重复渐变。让我们将其放入一个扩展函数中，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawScanLines</span><span class="hljs-params">(alpha: <span class="hljs-type">Float</span>, blendMode: <span class="hljs-type">BlendMode</span>)</span></span> {
    <span class="hljs-keyword">val</span> color = Colors.Black.copy(alpha = alpha)
    drawRect(
        brush = Brush.verticalGradient(
            <span class="hljs-number">0f</span> to color,
            <span class="hljs-number">0.4f</span> to color,
            <span class="hljs-number">0.4f</span> to Colors.Transparent,
            <span class="hljs-number">1f</span> to Colors.Transparent,
            tileMode = TileMode.Repeated,
            startY = <span class="hljs-number">0f</span>,
            endY = <span class="hljs-number">10f</span>,
        ),
        blendMode = blendMode
    )
    drawRect(
        brush = Brush.horizontalGradient(
            <span class="hljs-number">0f</span> to color,
            <span class="hljs-number">0.1f</span> to color,
            <span class="hljs-number">0.1f</span> to Colors.Transparent,
            <span class="hljs-number">1f</span> to Colors.Transparent,
            tileMode = TileMode.Repeated,
            startX = <span class="hljs-number">0f</span>,
            endX = <span class="hljs-number">10f</span>,
        ),
        blendMode = blendMode
    )
}
</code></pre>
<p>我们手动定义颜色停止点，以便在颜色之间形成清晰的边缘，然后将 <code>tileMode</code> 设置为 <code>Repeated</code>。这样，再加上较短的起点和终点，就能得到许多重复的平行线。</p>
<p>扩展函数还会接收我们所需的透明度和 <code>BlendMode</code> 参数。</p>
<p>然后，我们可以使用此函数在 <code>graphicsLayer</code> 上绘制扫描线。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">.drawBehind {
    layer {
        drawLayer(graphicsLayer)
        drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)
    }
}
</code></pre>
<p>将混合模式设置为 <code>DstOut</code> 会从绘制的内容中“减去”我们的渐变，从而产生这种效果。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28d91b6dd34844b1bea2ebe831da791e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=x7IQ35n0Md8ld%2FbcOmq6yESR%2F2o%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-2">构建模糊图层</h2>
<p>为了实现 CRT 屏幕常见的发光效果，我们将多次绘制 <code>graphicsLayer</code> 图层，每次绘制时分别设置不同的模糊半径、透明度和缩放比例。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> blurLayers = remember {
    listOf(
        Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">0.2f</span>, <span class="hljs-number">1.02f</span> to <span class="hljs-number">1.03f</span>),
        Triple(<span class="hljs-number">0.</span>dp, <span class="hljs-number">.2f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">0.9f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">10.</span>dp, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">40.</span>dp, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
    )
}
</code></pre>
<p>我们将使用一个 <code>Triple</code> 列表来存储每个图层的数据。该列表的顺序也定义了它们的绘制顺序。我建议你尝试调整这些值和顺序，以获得所需的效果。但这是我目前使用的方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">blurLayers.forEach { (blur, alpha, scale) -&gt;  
    Box(  
        Modifier  
            .matchParentSize()  
            .blur(blur, BlurredEdgeTreatment.Unbounded)  
            .graphicsLayer {  
                scaleX = scale.first  
                scaleY = scale.second  
                <span class="hljs-keyword">this</span>.alpha = alpha  
            }  
            .drawBehind {  
                layer {  
                    drawLayer(graphicsLayer)  
                    drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)  
                }  
            }    
    )  
}
</code></pre>
<p>然后，我们使用列表中的值绘制每个图层。在 <code>drawBehind</code> 修改器上方，我们将图层大小设置为与父图层匹配，并应用模糊、缩放和透明度。请记住将模糊设置为 <code>Unbounded</code>，使其超出包含它的可组合对象的边界。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb287da9548d4c8599ccafef052673af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=YY17IWzj47KP6nLWcJnlTRyaR1U%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-3">屏幕抖动</h2>
<p>最后，我们来添加屏幕抖动效果，以模拟 CRT 显示器特有的抖动。我们可以通过创建一个 <code>Offset</code> 对象，并用 -1 到 1 之间的随机浮点值来更新它。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> shake <span class="hljs-keyword">by</span> remember { mutableStateOf(Offset.Zero) }

LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        shake = Offset(
            Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),
            Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),
        )
        delay(<span class="hljs-number">32</span>)
    }
}
</code></pre>
<p>这里只需在一个 while 循环中即可完成。可以调整延迟时间来控制闪烁的间隔频率。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">modifier = modifier  
    .graphicsLayer {  
        translationX = shake.x  
        translationY = shake.y  
    }
</code></pre>
<p>然后可以使用修饰符来应用此偏移量。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08daadbb6efd45cc981fb077e23d6b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=bSgkKe2ddTbuZyvzMGmA75jfjxM%3D" alt="crt_opt.gif" loading="lazy"/></p>
## 整合所有功能
<p>让我们将所有这些功能组合成一个可轻松使用的组合。它会接收 <code>content</code> 参数以及 <code>flickerDelay</code> 参数，后者用于控制闪烁频率。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CRTBox</span><span class="hljs-params">(  
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  
    flickerDelay: <span class="hljs-type">Int</span> = <span class="hljs-number">32</span>,  
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>,  
)</span></span> {  
    <span class="hljs-keyword">var</span> shake <span class="hljs-keyword">by</span> remember { mutableStateOf(Offset.Zero) }  
  
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {  
        <span class="hljs-keyword">while</span> (flickerDelay &gt; <span class="hljs-number">0</span>) {  
            shake = Offset(  
                Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),  
                Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),  
            )  
            delay(flickerDelay.toLong())  
        }  
    }  
  
    <span class="hljs-keyword">val</span> graphicsLayer = rememberGraphicsLayer()  
  
    Box(  
        modifier = modifier  
            .graphicsLayer {  
                translationX = shake.x  
                translationY = shake.y  
            }  
    ) {  
        Box(Modifier.drawWithContent {  
            graphicsLayer.record { <span class="hljs-keyword">this</span><span class="hljs-symbol">@drawWithContent</span>.drawContent() }  
        }) {  
            content()  
        }  
  
        <span class="hljs-keyword">val</span> blurLayers = remember {  
            listOf(  
                Triple(<span class="hljs-number">5.</span>dp, <span class="hljs-number">.3f</span>, <span class="hljs-number">1.02f</span> to <span class="hljs-number">1.03f</span>),  
                Triple(<span class="hljs-number">0.</span>dp, <span class="hljs-number">.8f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">.9f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">10.</span>dp, <span class="hljs-number">.6f</span>, <span class="hljs-number">1.001f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">40.</span>dp, <span class="hljs-number">.7f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
            )  
        }  
  
        blurLayers.forEach { (blur, alpha, scale) -&gt;  
            Box(  
                Modifier  
                    .matchParentSize()  
                    .blur(blur, BlurredEdgeTreatment.Unbounded)  
                    .graphicsLayer {  
                        scaleX = scale.first  
                        scaleY = scale.second  
                        <span class="hljs-keyword">this</span>.alpha = alpha  
                    }  
                    .drawBehind {  
                        layer {  
                            drawLayer(graphicsLayer)  
                            drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)  
                        }  
                    }            
            )  
        }  
    }}  
  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">layer</span><span class="hljs-params">(  
    bounds: <span class="hljs-type">Rect</span> = size.toRect()</span></span>,  
    block: DrawScope.() -&gt; <span class="hljs-built_in">Unit</span>  
) =  
    drawIntoCanvas { canvas -&gt;  
        canvas.withSaveLayer(  
            bounds = bounds,  
            paint = Paint(),  
        ) { block() }  
    }  
  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawScanLines</span><span class="hljs-params">(alpha: <span class="hljs-type">Float</span>, blendMode: <span class="hljs-type">BlendMode</span>)</span></span> {  
    <span class="hljs-keyword">val</span> color = Colors.Black.copy(alpha = alpha)  
    drawRect(  
        brush = Brush.verticalGradient(  
            <span class="hljs-number">0f</span> to color,  
            <span class="hljs-number">0.4f</span> to color,  
            <span class="hljs-number">0.4f</span> to Colors.Transparent,  
            <span class="hljs-number">1f</span> to Colors.Transparent,  
            tileMode = TileMode.Repeated,  
            startY = <span class="hljs-number">0f</span>,  
            endY = <span class="hljs-number">10f</span>,  
        ),  
        blendMode = blendMode  
    )  
    drawRect(  
        brush = Brush.horizontalGradient(  
            <span class="hljs-number">0f</span> to color,  
            <span class="hljs-number">0.1f</span> to color,  
            <span class="hljs-number">0.1f</span> to Colors.Transparent,  
            <span class="hljs-number">1f</span> to Colors.Transparent,  
            tileMode = TileMode.Repeated,  
            startX = <span class="hljs-number">0f</span>,  
            endX = <span class="hljs-number">10f</span>,  
        ),  
        blendMode = blendMode  
    )  
}
</code></pre>
<p>然后，你可以像使用其他可组合组件一样使用它：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">CRTBox {
    Text(<span class="hljs-string">"GAME OVER"</span>)
}
</code></pre>
<h2 data-id="heading-4">Sweeper 更新</h2>
<p>如果你想查看实际效果，请查看最新的 Sweeper 更新，该更新使用 CRT 效果创建了一个令人毛骨悚然的万圣节主题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c135b0abf04a7a88d83881ba6bad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=fJO3ZjvcXhYG0mt6uzjwA%2Be7QTE%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.google.com%2Fstore%2Fapps%2Fdetails%3Fid%3Dcom.sinasamaki.chroma.sweeper%26ref%3Dsinasamaki.com" target="_blank" title="https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper&amp;ref=sinasamaki.com" ref="nofollow noopener noreferrer">play.google.com/store/apps/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2Fapp%2Fsweeper-by-sinasamaki%2Fid6752220495%3Fref%3Dsinasamaki.com" target="_blank" title="https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495?ref=sinasamaki.com" ref="nofollow noopener noreferrer">apps.apple.com/us/app/swee…</a></p>
<p>感谢阅读，祝你好运！</p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Meta ASR新篇章：当AI学会了全世界的语言]]></title>    <link>https://juejin.cn/post/7571306072422940714</link>    <guid>https://juejin.cn/post/7571306072422940714</guid>    <pubDate>2025-11-11T14:49:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422940714" data-draft-id="7571299394345746474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Meta ASR新篇章：当AI学会了全世界的语言"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-11T14:49:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Meta ASR新篇章：当AI学会了全世界的语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:49:50.000Z" title="Tue Nov 11 2025 14:49:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>在人工智能的浩瀚星辰中，语音识别无疑是最璀璨、也最富有挑战性性的一颗。我们曾惊叹于AI能听懂指令，将口语转化为文本。然而，这光鲜的背后，一直横亘着一道巨大的鸿沟——语言多样性。全球数千种语言，尤其是那些使用人数稀少、缺乏数字化资源的“低资源语言”和濒危方言，在AI的面前常常陷入“数字静默”。它们的数据匮乏、模型训练成本高昂，仿佛注定要被主流技术遗忘在角落。这就像一座AI领域的“巴别塔”，让不同语言间的沟通变得异常艰难。</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.40.50-1024x297.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.40.50-1024x297.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4239c63a5efc440a9e50013b4c65fd6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=Hkujg3bUSaRV2E%2F%2B50OQnwc8lpw%3D" alt="iShot_2025-11-11_22.40.50" loading="lazy"/></a></p>
<p>长久以来，我们都在期待一个能打破这种壁垒的解决方案。而就在最近，AI巨头Meta扔出了一枚重磅炸弹，其影响力足以震动整个AI界。</p>
<p>2025年11月10日，Meta基础人工智能研究（FAIR）团队正式揭开了他们最新力作——“Omnilingual ASR”语音识别系统的神秘面纱。这个名字本身就充满野心，意为“通晓万语”。而其公布的数字，更是令人瞠目结舌：<strong>原生支持超过1600种语言</strong>！更令人惊喜的是，这其中有<strong>500种语言是首次被任何AI语音识别系统所覆盖</strong>。这意味着，那些曾经“隐形”在AI世界里的语言，终于有了被听见的可能。</p>
<p>但这还不是全部。Omnilingual ASR最革命性的地方，在于其创新的“零样本学习”（Zero-shot Learning）能力。你可以把它想象成一种魔法：用户只需提供少量音频-文本配对样本，系统就能瞬间学会转录一种全新的语言或方言，无需耗费海量数据和算力去重新训练模型。这意味着，Omnilingual ASR理论上能将覆盖范围扩展至<strong>5400多种语言</strong>。这一能力，彻底颠覆了传统语音识别模型对海量标注数据的过度依赖，为成千上万的“小语种”和“地方方言”带来了前所未有的机遇。一个偏远村落的口述历史，一句濒危语言的古老歌谣，不再需要漫长的等待和巨大的投入，就能被AI轻易捕捉、数字化、被保存，让其文化得以延续。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.40.56-1024x240.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.40.56-1024x240.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c883763e9f474fdda500a789d38802ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=VAzHWojAQ%2BMtzWTzKrSVI5CLFTU%3D" alt="iShot_2025-11-11_22.40.56" loading="lazy"/></a></p>
<p>这种“魔法”并非空穴来风，其背后是Meta深厚的技术积累和前瞻性的架构设计。Omnilingual ASR不仅仅是在语言数量上的简单堆砌，其核心在于一个精妙的模型家族。它以Meta自研的wav2vec 2.0模型作为语音表示的“基石”，这是一个强大的自监督模型，能够从海量未标注语音数据中学习语言的深层特征。在此之上，Omnilingual ASR引入了两种不同的解码器：传统的CTC（Connectionist Temporal Classification）解码器，以及更令人兴奋的、受大语言模型启发的LLM解码器——“LLM-ASR”。</p>
<p>是的，你没听错，是<strong>大语言模型</strong>！这种设计思路，让语音识别系统能够借鉴大语言模型在理解上下文、处理复杂序列方面的强大能力，从而实现了前所未有的“零样本”学习和泛化能力。其中，规模最大的模型拥有<strong>70亿参数</strong>，庞大的身躯和精妙的智慧相结合，使得它能够在面对陌生语言时，也能基于已学习到的通用语音模式，进行有效的推断和转录。在实际性能上，Omnilingual ASR的表现也足以令人信服：在78%的测试语言中，字符错误率（CER）都能保持在10%以下，这对于大规模多语言系统而言是一个相当出色的成绩。对于那些训练音频≥10小时的“资源丰富型”语言，这一比例更是高达95%。这意味着，无论是主流语言还是许多此前被忽略的语言，用户都能期待获得高质量的转录服务。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.41.03-1024x431.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.41.03-1024x431.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4c0c0b84d134b8caae7d99e28e99490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=S8pjh%2BoLdnIpNwHjXqXfpnqNx0o%3D" alt="iShot_2025-11-11_22.41.03" loading="lazy"/></a></p>
<p>然而，Meta的抱负远不止于此。Omnilingual ASR的发布，不仅仅是技术的胜利，更是一场深刻的普惠与包容行动。Meta通过其<strong>开源策略</strong>，为全球社区带来了真正的福祉：模型采用友好的<strong>Apache 2.0许可证</strong>，而配套的<strong>Omnilingual ASR Corpus数据集则采用CC-BY许可</strong>，两者均可免费用于商业用途。这个“Omnilingual ASR语料库”具有历史性的意义。它包含了针对<strong>350种欠服务语言</strong>的转录语音，是Meta与全球各地组织（如Mozilla Common Voice、Lanfrica）以及本土说话者通力合作的结晶。这是一个全球合作的典范，旨在打破数据壁垒，为那些曾因数据匮乏而无法被AI识别的“小语种”和“地方方言”提供坚实的基础。</p>
<p>Meta此举，旨在<strong>弥合数字语言鸿沟</strong>，为少数民族、濒危语言群体提供强大的技术支撑。想象一下，在全球偏远地区，教育、医疗、公共服务等领域，那些使用小众语言的人们，将能够通过这项技术，更便捷地获取信息、表达自我。这不仅是对语言多样性的尊重，更是赋予他们被听见的权利，为人类文化遗产的保护和传承注入了新的活力。</p>
<p>凭借其广泛的语言覆盖和灵活的扩展能力，Omnilingual ASR无疑将在多个领域开辟全新的应用场景。对于充满想象力的开发者、研究者和社会服务机构而言，这无疑是一个巨大的宝库。它将为全球大量使用非主流语言的群体提供语音助手、实时字幕、语音输入法等数字服务，让技术不再是少数人的特权。它能高效地数字化保存那些濒危语言的口述历史档案、民间故事、传统歌谣，为文化遗产的留存提供前所未有的技术工具，让语言不再随着时间的流逝而消亡。开发者可以利用该模型，为特定地区或语言社区定制开发语音转录工具和应用程序，例如为粤语、四川话等方言提供更精准的识别服务，推动更本地化的商业和公共服务。在教育和公共服务领域，它能为使用少数民族语言的人们提供更便利的信息获取方式和沟通渠道，例如提供多语言的医疗咨询、法律援助等。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.41.41-1024x560.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.41.41-1024x560.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/714c5351bedd4ea98659645110cd02b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=oYDbKXbdXw5frgZ2H2NihUFa1q8%3D" alt="iShot_2025-11-11_22.41.41" loading="lazy"/></a></p>
<p>Omnilingual ASR的出现，不仅仅是技术进步的体现，更开启了构建一个真正多语言、多文化数字世界的全新篇章。Meta的Omnilingual ASR，无疑是AI语音识别发展史上的一个里程碑事件。它不仅以惊人的数量和创新的技术，打破了困扰AI多年的语言壁垒，更通过开源策略，将这一前沿技术推向全球，赋能无数此前被忽视的语言社区。这不只是一套模型，更是一种理念的胜利——即技术应当是普惠的，应当服务于全人类的语言和文化多样性。当AI真正学会了全世界的语言，我们所构建的数字世界，也将变得更加开放、包容和充满活力。Omnilingual ASR吹响了号角，我们共同见证，共同创造，一个语言AI的新纪元正向我们走来。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📜 `<script>`脚本元素 - 从加载策略到安全性与性能的完整指南]]></title>    <link>https://juejin.cn/post/7571102074038485033</link>    <guid>https://juejin.cn/post/7571102074038485033</guid>    <pubDate>2025-11-11T09:11:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038485033" data-draft-id="7571102074038452265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📜 `&lt;script&gt;`脚本元素 - 从加载策略到安全性与性能的完整指南"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:11:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📜 `&lt;script&gt;`脚本元素 - 从加载策略到安全性与性能的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:11:06.000Z" title="Tue Nov 11 2025 09:11:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握<code>&lt;script&gt;</code>脚本元素的加载与执行模型、模块化用法、安全配置（CSP/SRI/CORS），并能在实际项目中选用正确策略，避免性能与安全坑。</p>
<p>📊 <strong>难度等级</strong>：中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#script</code> <code>#defer</code> <code>#async</code> <code>#module</code> <code>#CSP</code> <code>#SRI</code><br/>
⏱️ <strong>阅读时间</strong>：约14分钟</p>
</blockquote>
<h2 data-id="heading-0">🌟 引言</h2>
<p>在前端开发中，<code>&lt;script&gt;</code>脚本的使用几乎无处不在：业务代码、第三方SDK、监控上报、AB测试、广告、埋点……但常见问题也层出不穷：</p>
<ul>
<li>同步脚本阻塞渲染，首屏白屏时间长。</li>
<li>混用<code>async/defer</code>导致执行顺序不可控，依赖打乱引发线上事故。</li>
<li>模块脚本与经典脚本相互引用，兼容性问题频发。</li>
<li>跨域脚本报错只有“Script error”，无法定位问题。</li>
<li>未配置<code>CSP nonce</code>/<code>SRI integrity</code>，安全审计不通过。</li>
</ul>
<p>本文从加载、执行到安全与性能的完整维度，结合实际踩坑案例，给出可落地的最佳实践与测试方法。</p>
<h2 data-id="heading-1">核心技巧详解</h2>
<h3 data-id="heading-2">1）加载与执行模型：同步、defer、async 与事件时序</h3>
<h4 data-id="heading-3">应用场景</h4>
<p>需要同时引入多个脚本，并确保：不阻塞解析、执行顺序可控、与<code>DOMContentLoaded</code>/<code>load</code>事件时序配合。</p>
<h4 data-id="heading-4">常见问题</h4>
<ul>
<li>在<code>&lt;head&gt;</code>中放同步脚本，阻塞HTML解析与渲染。</li>
<li>将存在依赖关系的脚本设置为<code>async</code>，出现随机时序问题。</li>
<li>误以为<code>defer</code>作用于内联脚本（仅对外链脚本生效）。</li>
</ul>
<h4 data-id="heading-5">推荐方案</h4>
<ul>
<li>有依赖和顺序要求：使用<code>defer</code>并保持引入顺序。</li>
<li>无依赖、独立的第三方脚本：使用<code>async</code>。</li>
<li>现代代码优先使用<code>type="module"</code>（天生类似<code>defer</code>，更易管理依赖）。</li>
</ul>
<h4 data-id="heading-6">核心要点</h4>
<ul>
<li><code>async</code>：下载不阻塞解析，下载完成立即执行，彼此之间顺序不确定。</li>
<li><code>defer</code>：下载不阻塞解析，按引入顺序在解析完成后执行，早于<code>DOMContentLoaded</code>。</li>
<li><code>type="module"</code>：模块脚本默认延后执行，按依赖图加载，<code>DOMContentLoaded</code>会等待其完成。</li>
</ul>
<h4 data-id="heading-7">实际应用（顺序可视化示例）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐：存在依赖关系的脚本使用 defer，保证按声明顺序执行 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/vendor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 独立的第三方脚本使用 async，不影响解析与渲染，也不会卡住其他脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 现代项目：优先使用模块脚本，依赖管理更清晰（默认延后执行，DOM解析完成后运行） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">2）模块脚本与回退：<code>type="module"</code>/<code>nomodule</code>/动态导入</h3>
<h4 data-id="heading-9">应用场景</h4>
<p>在现代浏览器中使用ESM模块；为老旧浏览器准备兼容回退；按需加载分包。</p>
<h4 data-id="heading-10">常见问题</h4>
<ul>
<li>经典脚本与模块脚本相互调用导致作用域混乱。</li>
<li>使用<code>nomodule</code>错误，现代浏览器也执行了回退脚本。</li>
</ul>
<h4 data-id="heading-11">推荐方案</h4>
<ul>
<li>现代浏览器：主入口使用<code>type="module"</code>。</li>
<li>老旧浏览器回退：提供<code>nomodule</code>的经典脚本版本（通过构建产物区分）。</li>
<li>大页面：使用<code>import()</code>进行按需加载，减小首包体积。</li>
</ul>
<h4 data-id="heading-12">核心要点</h4>
<ul>
<li><code>nomodule</code>脚本仅在“不支持模块”的浏览器中执行；现代浏览器会忽略。</li>
<li>模块脚本是<code>strict mode</code>，顶层不会污染全局作用域。</li>
<li>动态导入返回<code>Promise</code>，友好配合路由/交互触发。</li>
</ul>
<h4 data-id="heading-13">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 现代入口 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// @description 页面主入口：模块脚本（默认延后执行）</span>
  <span class="hljs-comment">/**
   * 记录模块初始化
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">msg</span> - 文本信息
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logInit</span> = (<span class="hljs-params">msg</span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[module] <span class="hljs-subst">${msg}</span>`</span>);
  <span class="hljs-title function_">logInit</span>(<span class="hljs-string">'bootstrap'</span>);

  <span class="hljs-comment">// 动态导入，按需加载非关键功能</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { initFeature } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'/assets/feature.js'</span>);
    <span class="hljs-title function_">initFeature</span>();
  };
  <span class="hljs-comment">// 交互触发</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadFeature</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 旧浏览器回退（仅不支持模块的浏览器执行） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/app-legacy.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">3）安全与跨域：CSP nonce、SRI integrity 与 <code>crossorigin</code></h3>
<h4 data-id="heading-15">应用场景</h4>
<p>严格的安全审计要求；CDN脚本完整性校验；跨域加载脚本并需要捕获详细错误。</p>
<h4 data-id="heading-16">常见问题</h4>
<ul>
<li>直接写内联脚本被CSP拦截，页面功能失效。</li>
<li>使用<code>integrity</code>但未设置<code>crossorigin</code>，SRI校验被忽略。</li>
<li>跨域脚本错误只有“Script error”，无法定位堆栈与消息。</li>
</ul>
<h4 data-id="heading-17">推荐方案</h4>
<ul>
<li>启用CSP并为内联脚本设置<code>nonce</code>（服务器动态生成）。</li>
<li>CDN脚本配合<code>integrity</code>与<code>crossorigin="anonymous"</code>确保完整性与错误可见性。</li>
<li>服务器允许跨域并设置<code>Access-Control-Allow-Origin</code>与<code>Timing-Allow-Origin</code>以提升可观测性。</li>
</ul>
<h4 data-id="heading-18">核心要点</h4>
<ul>
<li><code>Content-Security-Policy: script-src 'self' 'nonce-&lt;随机值&gt;' https://cdn.example.com</code>。</li>
<li><code>integrity</code>需与<code>crossorigin</code>配合，跨域资源不然可能跳过校验。</li>
<li>设置<code>window.addEventListener('error', ...)</code>与<code>unhandledrejection</code>捕获错误。</li>
</ul>
<h4 data-id="heading-19">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 服务端需下发一致的 nonce 值（示例：nonce-xyz） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"script-src 'self' 'nonce-xyz' https://cdn.example.com"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 内联脚本加 nonce，避免被CSP拦截 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"xyz"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * 上报错误（示例）
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">type</span> - 错误类型
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">msg</span> - 错误消息
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reportError</span> = (<span class="hljs-params">type, msg</span>) =&gt; {
    <span class="hljs-comment">// 真实项目中调用监控SDK或自建上报接口</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[error] <span class="hljs-subst">${type}</span>: <span class="hljs-subst">${msg}</span>`</span>);
  };
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reportError</span>(<span class="hljs-string">'onerror'</span>, e.<span class="hljs-property">message</span>));
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reportError</span>(<span class="hljs-string">'promise'</span>, <span class="hljs-title class_">String</span>(e.<span class="hljs-property">reason</span>)));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- CDN脚本完整性 + 可见错误堆栈（需服务端允许跨域） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/sdk.min.js"</span>
        <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-BASE64_HASH"</span>
        <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
        <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-20">4）错误监控与可观测性：从“Script error”到可定位</h3>
<h4 data-id="heading-21">应用场景</h4>
<p>跨域脚本导致错误信息缺失；需要在生产环境获取完整堆栈与来源。</p>
<h4 data-id="heading-22">常见问题</h4>
<ul>
<li>未设置<code>crossorigin</code>导致错误被屏蔽。</li>
<li>监控系统只收到了通用的“Script error”。</li>
</ul>
<h4 data-id="heading-23">推荐方案</h4>
<ul>
<li>对外链脚本统一加<code>crossorigin="anonymous"</code>。</li>
<li>服务器返回<code>Access-Control-Allow-Origin: *</code>或你的域名；并提供<code>Timing-Allow-Origin</code>以开放性能指标。</li>
<li>对于私有CDN，确保响应头携带正确的CORS与缓存策略。</li>
</ul>
<h4 data-id="heading-24">实际应用（最小上报器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 发送错误到监控平台
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{type:string,message:string,stack?:string</span>}} payload - 错误信息
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendError</span> = (<span class="hljs-params">payload</span>) =&gt; {
  <span class="hljs-comment">// 示例：仅打印；实际项目应调用后端接口</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📮 error-report'</span>, payload);
};

<span class="hljs-comment">/**
 * 初始化错误监听
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initErrorListener</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">sendError</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">message</span>: e.<span class="hljs-property">message</span>, <span class="hljs-attr">stack</span>: e.<span class="hljs-property">error</span>?.<span class="hljs-property">stack</span> });
  });
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">sendError</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'promise'</span>, <span class="hljs-attr">message</span>: <span class="hljs-title class_">String</span>(e.<span class="hljs-property">reason</span>) });
  });
};

<span class="hljs-title function_">initErrorListener</span>();
</code></pre>
<h3 data-id="heading-25">5）性能与加载优化：位置、拆分、预加载、优先级</h3>
<h4 data-id="heading-26">应用场景</h4>
<p>首屏加载优化、减少阻塞、合理拆分产物、控制网络优先级。</p>
<h4 data-id="heading-27">常见问题</h4>
<ul>
<li>将大型同步脚本放在<code>&lt;head&gt;</code>导致阻塞。</li>
<li>所有代码打成一个包，影响首屏与可缓存性。</li>
<li>关键脚本加载优先级过低导致交互延迟。</li>
</ul>
<h4 data-id="heading-28">推荐方案</h4>
<ul>
<li>非必要脚本置底或使用<code>defer</code>；第三方独立脚本用<code>async</code>。</li>
<li>按路由/功能拆分产物；模块脚本配合<code>import()</code>实现懒加载。</li>
<li>对真正关键脚本使用<code>fetchpriority="high"</code>（实验性特性，评估后再用）。</li>
</ul>
<h4 data-id="heading-29">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 关键脚本：提升获取优先级并延后执行（避免阻塞） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/critical.js"</span> <span class="hljs-attr">fetchpriority</span>=<span class="hljs-string">"high"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 辅助脚本：按需加载（路由/交互触发） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * 懒加载非关键功能
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">lazyFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { mount } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'/assets/chart.js'</span>);
    <span class="hljs-title function_">mount</span>(<span class="hljs-string">'#chart'</span>);
  };
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#btn'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lazyFeature</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-30">📊 技巧对比总结</h2>









































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>同步脚本（不推荐）</td><td>早期简单页面</td><td>立即执行</td><td>阻塞解析与渲染，影响首屏</td></tr><tr><td>defer</td><td>有依赖且需保持顺序</td><td>不阻塞解析；按引入顺序执行</td><td>仅外链脚本生效；在解析完成后执行</td></tr><tr><td>async</td><td>独立第三方脚本</td><td>不阻塞解析；最快可用</td><td>顺序不确定；不适合有依赖脚本</td></tr><tr><td>type="module"</td><td>现代项目主入口与分包</td><td>依赖图管理；默认延后执行</td><td>需考虑旧浏览器；配合 nomodule 回退</td></tr><tr><td>nomodule</td><td>旧浏览器回退</td><td>保证兼容</td><td>仅旧浏览器执行；与模块入口配套</td></tr></tbody></table>
<h2 data-id="heading-31">🎯 实战应用建议</h2>
<h3 data-id="heading-32">最佳实践</h3>
<ol>
<li>同时输出 <code>esm</code> 与 <code>legacy</code> 产物；模板中注入 <code>type="module"</code> 与 <code>nomodule</code> 入口。</li>
<li>第三方独立脚本统一使用 <code>async</code>；有依赖的业务脚本使用 <code>defer</code> 保序。</li>
<li>模块化按需拆分：非关键功能通过 <code>import()</code> 懒加载，降低首包体积。</li>
<li>安全策略到位：开启 CSP（<code>nonce</code>/<code>hash</code>/<code>strict-dynamic</code>）与 SRI（<code>integrity</code> + <code>crossorigin</code>）。</li>
</ol>
<h3 data-id="heading-33">性能考虑</h3>
<ul>
<li>关键脚本提升网络优先级（<code>fetchpriority</code>）并使用 <code>defer</code> 避免阻塞。</li>
<li>大页面进行路由/功能拆分；CDN 缓存策略与版本化确保命中率。</li>
<li>错误与性能可观测性：启用 <code>crossorigin</code> 与 <code>Timing-Allow-Origin</code>，便于采集与诊断。</li>
</ul>
<h2 data-id="heading-34">💡 总结</h2>
<p>这5个脚本治理技巧覆盖了加载模型、模块化、跨域安全、错误监控与性能优化：</p>
<ol>
<li>加载与执行模型：明确 <code>defer/async/module</code> 的时序与适用场景。</li>
<li>模块脚本与回退：<code>type="module"</code> + <code>nomodule</code> 兼顾现代与旧环境。</li>
<li>安全与跨域：CSP <code>nonce</code>、SRI <code>integrity</code> 与 CORS 正确配合。</li>
<li>错误监控与可观测性：统一监听与跨域头，避免“Script error”。</li>
<li>性能与加载优化：拆分、预加载与优先级，降低阻塞时间。</li>
</ol>
<p>掌握以上技巧能让你的前端应用更稳定、更安全、更高效。建议在团队内形成统一的脚本治理规范，并提供测试页面验证关键场景，持续迭代优化。</p>
<h2 data-id="heading-35">相关资源</h2>
<ul>
<li>MDN：HTML <code>&lt;script&gt;</code> 元素（参考与属性说明）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fscript" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Elements/script" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>CSP 指南：Content Security Policy
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FCSP" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>SRI 指南：Subresource Integrity
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>Priority Hints（fetchpriority）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fpriority-hints" target="_blank" title="https://web.dev/articles/priority-hints" ref="nofollow noopener noreferrer">web.dev/articles/pr…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：掌握了脚本加载与执行的5个核心技巧，含安全与性能的最佳实践，这些知识点在实际前端项目中非常实用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript为何在AI时代登顶：Anders Hejlsberg 的十二年演化论]]></title>    <link>https://juejin.cn/post/7571278865516576818</link>    <guid>https://juejin.cn/post/7571278865516576818</guid>    <pubDate>2025-11-11T09:12:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865516576818" data-draft-id="7571281406509596723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript为何在AI时代登顶：Anders Hejlsberg 的十二年演化论"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:12:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript为何在AI时代登顶：Anders Hejlsberg 的十二年演化论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:12:05.000Z" title="Tue Nov 11 2025 09:12:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文访谈：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fdeveloper-skills%2Fprogramming-languages-and-frameworks%2Ftypescripts-rise-in-the-ai-era-insights-from-lead-architect-anders-hejlsberg%2F" target="_blank" title="https://github.blog/developer-skills/programming-languages-and-frameworks/typescripts-rise-in-the-ai-era-insights-from-lead-architect-anders-hejlsberg/" ref="nofollow noopener noreferrer">github.blog/developer-s…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4a4d83875a462da6e652b941371838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457124&amp;x-signature=7Hx3ZWByJZnlcIPUITcV160phbc%3D" alt="" loading="lazy"/></p>
<p><strong>当 Anders Hejlsberg 在 2012 年开始着手 TypeScript 时，他并不是在构想一个要与 JavaScript 竞争的新语言。</strong> 他试图解决一个非常现实的问题：JavaScript 已经成为整个 Web 的基石，但它并不适合大型、多开发者协作的代码库。团队们正在交付数百万行弱类型代码，而当系统复杂到难以推理时，这门语言几乎提供不了任何帮助。</p>
<p><strong>这项起初的务实修补最终重塑了现代开发。</strong> 在 2025 年，TypeScript 成为 GitHub 上使用量最高的语言，首次超过了 JavaScript 与 Python。仅今年，就有超过一百万名开发者以 TypeScript 参与贡献——这是 Octoverse 统计的 66% 的增长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ce0dd85ad8437d91cbdf63cc7caf69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457124&amp;x-signature=0LSbTaWzOLR%2FRBYeOGecGOymyrw%3D" alt="" loading="lazy"/></p>
<p>他说：“我记得当时心里想，也许我们能让 25% 的 JavaScript 社区产生兴趣——那就算成功了。但看到现在的情况？我完全惊呆了。”</p>
<p><strong>在 2025 年，TypeScript 成为 GitHub 上使用量最多的语言，首次超过 JavaScript 和 Python。</strong> 根据今年的 Octoverse 报告，仅今年就有超过一百万名开发者开始用 TypeScript 贡献代码（同比增长 66%）。</p>
<p>那么，一个 JavaScript 的类型化超集是如何成为 AI 时代的主导语言的？我们与 Anders 坐下来，聊了演化、性能，以及为什么一门为更好的人类协作而设计的语言，如今正在为机器辅助编码提供动力。</p>
<hr/>
<h2 data-id="heading-0">“我们原以为 25% 的采用率就算成功。”</h2>
<p>“项目刚启动时，”Anders 说，“我估计如果我们能让 25% 的 JavaScript 社区表现出兴趣，那就赢了。但现在，看着每天有这么多人依赖它……我和整个团队都惊呆了。”</p>
<p>回到 2012 年，JavaScript 已经根深蒂固。TypeScript 的赌注不是取代它，而是通过添加类型、工具链和可重构性，让大规模 JavaScript 开发变得“可理性”。</p>
<blockquote>
<p><strong>“做一件你知道真的能带来改变的事，是一种喜悦。我们没打算无处不在。我们只是想让开发者能更有信心地构建大型系统。”</strong> ——TypeScript 创作者 Anders Hejlsberg</p>
</blockquote>
<p>十年后，这个赌注成为默认。几乎所有现代前端框架——React、Next.js、Angular、SvelteKit——都默认提供 TypeScript 脚手架。结果是：更安全的代码库、更好的自动补全、更少凌晨 3 点因为一个 undefined 而调试崩溃。</p>
<p>“Anders 说：“魔力就在于让 TypeScript 感觉像 JavaScript，但拥有超能力。”</p>
<hr/>
<h2 data-id="heading-1">⚙️ TypeScript 到底是什么？</h2>
<p>TypeScript 是一个开源的、带类型标注的 JavaScript 超集，它会编译成普通 JavaScript。它添加静态类型检查、接口、泛型和现代语言特性——并在编译时把它们抹去，使输出能在任何 JavaScript 能运行的地方运行。</p>
<p>开发者使用它的理由：</p>
<ul>
<li>在运行前捕获类型错误</li>
<li>提升 IDE 自动补全与重构能力</li>
<li>让大型代码库在团队协作下仍可维护</li>
<li>与框架和 AI 辅助工具无缝集成</li>
</ul>
<p>它用于：前端框架（React, Angular, Vue）、后端系统（Node.js, Deno）、SDK、设计系统，以及越来越多需要强类型来确保生成代码安全的 AI 代理框架。</p>
<hr/>
<h2 data-id="heading-2">为未来重写编译器</h2>
<p>TypeScript 发布时著名的“自托管”特性：用 TypeScript 自己编写。这让编译器便携、可修改。但性能最终成为问题。</p>
<p>“Anders 说：“放弃自托管让我们很痛苦，但我们知道性能已经挤不出更多了。”</p>
<p>我们尝试了 C#、其他语言，最后选择 Go。性能提升达到了 10 倍。一半来自原生速度，一半来自共享内存并发。这种 10 倍提升是不能忽视的。</p>
<p>重写带来了一个更快、更轻、更适合企业规模代码库的编译器——但功能上与旧版本完全一致。</p>
<p>Anders 谈到：“我们现在有一个原生编译器，从怪癖到行为都与旧的完全一致。社区不需要丢掉任何东西。”</p>
<p>这种<strong>在提升性能的同时保留行为一致性</strong>的理念，是开发者信任 TypeScript 的原因之一。它不是每隔几年来一次“从零开始”的重写，而是一个保持兼容、不断演化的系统。</p>
<hr/>
<h2 data-id="heading-3">“开源是被捕捉在代码里的演化。”</h2>
<p>Anders 把开源看作一种类似自然选择的生态系统。</p>
<p>“Anders 说：“开源本来是个巨大的实验。没人真正搞清楚如何为它提供资金——但我们现在看到，它比以往更大，也不会消失。那就是被捕捉在代码里的演化。”</p>
<p>今年的 Octoverse 数据验证了这一点：开发者在 2025 年提交了近 10 亿次提交（同比 +25%），其中 11.2 亿次提交到公共和开源仓库。这是用一次次 PR 写下的“演化记录”。</p>
<p>拥有 12 年 issues、PR 与设计文档的 TypeScript 仓库，本身已经成为语言演化的活档案。“我们有 12 年的历史被记录在 GitHub 上，”Anders 说。“所有内容都可搜索。那就是你能 grep 的演化。”</p>
<hr/>
<h2 data-id="heading-4">AI 效应：为什么 TypeScript 在现在的时代更强盛？</h2>
<p>Octoverse 2025 最突出的数据之一显示 AI 正在改变语言偏好。开发者正转向能让 AI 辅助编码更可靠、更可维护的类型语言。</p>
<p>Anders 解释道：</p>
<blockquote>
<p><strong>“AI 在一门语言上写代码的能力，与它见过的该语言数量成正比。它是一个巨大的复述器，带些外推。AI 看过大量的 JavaScript、Python 和 TypeScript，所以它在写这些语言时特别强。新语言反而处于劣势。”</strong></p>
</blockquote>
<p>这种数据优势，加上 TypeScript 的静态类型系统，使其非常契合 AI 优先的工作流。</p>
<p>“Anders 说：“如果你让 AI 翻译 50 万行代码，它可能会产生幻觉。但如果你让它生成一个程序，以确定性方式完成同样的翻译，你就能得到可靠结果。这就是类型系统被设计出来要解决的问题。”</p>
<p>结论：在一个代码由人类和机器共同编写的世界里，类型不是官僚主义，而是真相校验器。</p>
<hr/>
<h2 data-id="heading-5">从 IDE 到 Agent</h2>
<p>大型语言模型的兴起也在改变“开发工具”的定义。IDE 正在从为人类服务，变成同时为 agents 服务的环境。</p>
<blockquote>
<p>“AI 一开始是助手。现在它在做工作，而你在监督。它不需要我们那种 IDE。它需要的是各种服务。这就是 Model Context Protocol 令人兴奋的地方。”</p>
</blockquote>
<p>Octoverse 报告描述这种变化：“AI 不只是重塑代码，而是在重塑选择。”</p>
<p>像 TypeScript 这样的类型语言，为 agents 提供了安全重构、语义查询和对代码库进行确定性推理的结构化基础。</p>
<p>“Anders 补充说：“目标是为 AI 工作流设定恰到好处的确定性，让它们保持有用而不至于脱轨。”</p>
<hr/>
<h2 data-id="heading-6">这门持续演化的语言</h2>
<p>从 Turbo Pascal 到 C#，再到 TypeScript，Anders 的工作跨越数十年。但令人惊讶的是，他始终保持一致：构建能让复杂软件更易理解的语言。</p>
<blockquote>
<p>“没有什么比做一件确实能带来改变的事情更令人满足的了。TypeScript 不断变化，但始终围绕同一件事：帮助开发者清晰表达意图。”</p>
</blockquote>
<p>这种清晰，或许正是为什么 2025 年平均每秒就有至少一个新开发者加入 GitHub，而其中越来越多人选择从 TypeScript 开始。</p>
<p>TypeScript 的故事不仅仅是语言设计的故事；</p>
<p>它是演化的故事——一个起初为修补 JavaScript 扩展性而生的项目，如今成为开发者与 AI 共同写代码的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端高频面试题之Vue（初、中级篇）]]></title>    <link>https://juejin.cn/post/7571303808115769396</link>    <guid>https://juejin.cn/post/7571303808115769396</guid>    <pubDate>2025-11-11T13:31:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571303808115769396" data-draft-id="7571278865517805618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端高频面试题之Vue（初、中级篇）"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T13:31:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端高频面试题之Vue（初、中级篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:31:42.000Z" title="Tue Nov 11 2025 13:31:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、说说你对 Vue.js 的理解？</h2>
<p><code>Vue.js</code> 是一个用于创建用户界面的开源 <code>JavaScript</code> 框架，它的特点如下：</p>
<h3 data-id="heading-1">1.1 声明式框架</h3>
<ul>
<li>早在JQ的时代编写的代码都是命令式的，命令式框架重要特点就是关注过程。</li>
<li>声明式框架更加关注结果。命令式的代码封装到了框架内部，过程靠框架来实现。</li>
</ul>
<h3 data-id="heading-2">1.2 数据驱动/响应式数据</h3>
<p>通过 <code>Object.defineProperty（Vue 2）</code> 或 <code>Proxy（Vue 3）</code> 实现数据劫持，数据变化时自动更新视图，开发者无需手动操作 DOM。</p>
<h3 data-id="heading-3">1.3 虚拟DOM</h3>
<p>通过高效的 <code>Diff</code> 算法比对虚拟 <code>DOM</code> 的变化，最小化真实 <code>DOM</code> 操作，提升性能。</p>
<h3 data-id="heading-4">1.4 组件化</h3>
<p>将 UI 拆分为独立可复用的组件，每个组件包含自己的模板、逻辑和样式，通过组合组件构建复杂应用。</p>
<h3 data-id="heading-5">1.5 指令系统</h3>
<p>提供 <code>v-if</code>、<code>v-for</code>、<code>v-bind</code>、<code>v-on</code> 等指令，以声明式方式增强 HTML 的功能。</p>
<h3 data-id="heading-6">1.6 渐进式框架</h3>
<ul>
<li><strong>渐进集成</strong>：可以从小规模功能（如静态页面交互）逐步扩展到完整的单页应用（SPA）。</li>
<li><strong>灵活生态</strong>：核心库只关注视图层，但配合官方路由（Vue Router）、状态管理（Vuex/Pinia）、构建工具（Vite）等，能轻松扩展为全功能框架。</li>
</ul>
<p>就是你可以单独用 <code>vue</code> 的响应式构建静态页面，如果你需要状态管理，就用官方的状态管理工具 <code>Vuex/Pinia</code>，如果你需要构建一个应用，有多个页面，可以用官方路由 <code>Vue-router</code>，如果你需要一键生成项目，可以用官方的 <code>vue-cli</code> 或者使用 <code>vite</code> 的 <code>npm create vue@latest</code> 命令一键创建项目。</p>
<h2 data-id="heading-7">2、请说一下对 Vue.js 响应式数据的理解？</h2>
<p><code>vue</code> 是通过数据驱动视图的，响应式指的是当数据发生变化时，使用到该数据的页面会自动更新。在表单中，可以通过响应式实现<strong>双向绑定</strong>，实现表单值和数据的<strong>双向同步</strong>。</p>
<h3 data-id="heading-8">2.1 基本原理</h3>
<ol>
<li><strong>数据劫持</strong>：<code>vue2</code> 中使用 <code>Object.defineProperty</code> 对对象属性进行劫持，对数组则采用重写数组的七个方法<code>（push,shift,pop,splice,unshift,sort,reverse）</code>来实现劫持，而 <code>vue3</code> 则通过 <code>Proxy</code> API 可以天然对对象和数组实现数据劫持。</li>
<li><strong>依赖收集</strong>：在 <code>getter</code> 中收集依赖(谁在使用这个数据)。</li>
<li><strong>派发更新</strong>：在 <code>setter</code> 中通知所有依赖进行更新，更新页面。</li>
</ol>
<h3 data-id="heading-9">2.2 特点</h3>
<ol>
<li><strong>自动更新</strong>：数据变化时，依赖该数据的视图会自动更新。</li>
<li><strong>深度监听</strong>：嵌套对象也会被递归转为响应式。</li>
<li><strong>异步更新</strong>：Vue 会异步执行 DOM 更新，提高性能。</li>
</ol>
<h3 data-id="heading-10">2.3 Vue3 响应式改进</h3>
<p>使用 <code>Proxy</code> 代替 <code>Object.defineProperty</code>：</p>
<ul>
<li>可以检测到对象属性的添加和删除。</li>
<li>对数组的变化无需特殊处理，天然可以监听到通过数组索引修改元素和修改 <code>length</code> 属性的行为。</li>
<li>性能更好。</li>
</ul>
<h3 data-id="heading-11">2.4 扩展：针对响应式可以做的性能优化（vue2）：</h3>
<ul>
<li>对象层级过深，性能就会差，所以响应式尽量扁平化。</li>
<li>不需要响应数据的内容不要放到 data 中。</li>
<li>不需要更新的静态数据可以用 <code>Object.freeze()</code> 冻结数据。</li>
</ul>
<h3 data-id="heading-12">2.5 注意事项</h3>
<ol>
<li>对象新增属性：<code>vue 2</code> 中需要使用 <code>Vue.set</code> 或 <code>this.$set</code> 方法。</li>
<li>数组变化：<code>vue 2</code> 中直接通过索引修改或修改 <code>length</code> 属性不会触发响应，应使用变异方法(<code>push/pop/shift</code>等)或 <code>Vue.set、this.$set</code>。</li>
<li>性能考量：响应式系统需要追踪依赖，大型对象可能会有性能开销。</li>
</ol>
<p>响应式系统让开发者可以专注于数据逻辑，而无需手动处理 DOM 更新，大大提高了开发效率。</p>
<h2 data-id="heading-13">3、Vue3 的升级点？</h2>
<h3 data-id="heading-14">3.1 架构升级</h3>
<p>Vue3 源码采用 <strong>monorepo</strong> 方式进行管理，将模块拆分到packages中，这样做的好处如下：</p>
<ol>
<li>将多个模块集合到一个仓库，方便维护。</li>
<li>方便版本管理和依赖管理，各模块间相互引用也比较方便。</li>
<li>各个包可以单独安装使用，不需要导入整个 vue。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31a6b97686e45ed9d72c15d8ccb71d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472701&amp;x-signature=0AclC2F9tzfQzEnHYn14jB7MBnY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">3.2 组合式API -&gt; Composition API</h3>
<p>vue2 中 <code>Options API</code>（即提供props、methods、data、computed、watch等属性供用户使用）的问题：</p>
<ol>
<li>复用性比较差，虽然提供 mixins 和 extends，但会出现数据来源不明确和重名问题。</li>
<li>需要使用带有副作用<code>this</code>，存在this指向问题，同时对 <code>tree-shaking</code> 也不友好。</li>
<li>对于上百行的大型组件来说，当你了解某段逻辑时，你需要不断上下移动阅读，体验很差。</li>
</ol>
<p>vue3<code>Composition API</code>特点：</p>
<ol>
<li>方便抽离，复用性强，可以把干净的逻辑提取到一个单独函数或者文件中，让开发者专注于逻辑内聚问题。</li>
<li>抛弃this，tree-shaking 友好，打包出来体积更小。</li>
</ol>
<h3 data-id="heading-16">3.3 响应式系统</h3>
<p>vue3采用<code>proxy</code>替代了<code>Object.defineProperty</code>:</p>
<ol>
<li>提升了性能，不再需要一次性全部递归拦截。</li>
<li>能拦截到对象属性的新增和删除。</li>
<li>能拦截原生数组的索引、length操作。</li>
</ol>
<h3 data-id="heading-17">3.4 diff算法</h3>
<p>全量 <code>diff</code> 算法中采用<strong>最长递增子序列</strong>减少节点的移动。在非全量 <code>diff</code> 算法中只比较动态节点，通过 <code>PatchFlag</code> 标记更新动态的部分。</p>
<h3 data-id="heading-18">3.5 渲染优化</h3>
<p>在渲染方面，vue3提供了<strong>自定义渲染器</strong>，大大提升了扩展能力。</p>
<h3 data-id="heading-19">3.6 编译优化</h3>
<ul>
<li><strong><code>Block</code>和 <code>patchFlag</code></strong>：为动态节点打上补丁标志，即 <code>patchFlag</code>，同时还提出了 <code>block</code> 的概念，<code>block</code> 本质上是一个虚拟节点，但它会多出一个 <code>dynamicChildren</code> 数组，会收集它所有的动态子代节点，比对的时候会忽略DOM层级结构的，所以对于带有 <code>v-if</code>、<code>v-for</code> 等结构化指令的节点也作为 <code>block</code> 的角色。</li>
<li><strong>静态提升</strong>：将静态虚拟的节点提升到render函数之外，这样能够减少更新时创建虚拟DOM带来的性能开销和内存占用。</li>
<li><strong>预字符串化</strong>：在静态提升的基础上，当模板中包含大量连续纯静态的标签节点时，将这样静态节点序列化成字符串，然后通过innerHTML进行设置，这样做能够减少创建虚拟节点产生的性能开销和内存占用。</li>
<li><strong>缓存内联事件处理函数</strong>：可以避免不必要的更新。</li>
<li><strong>v-once指令</strong>：缓存虚拟节点，避免组件更新时重新创建虚拟DOM的性能开销，同时带有v-once指令的节点不会被父级block收集，所以不会参与diff操作，避免无用的diff开销。</li>
</ul>
<h3 data-id="heading-20">3.7 新增组件</h3>
<ul>
<li>Teleport：可以将指定内容渲染到特定容器中，而不受DOM层级的限制。</li>
</ul>
<h3 data-id="heading-21">3.8 对TypeScript支持更加友好</h3>
<p>vue2源码采用Flow做类型检测，对TypeScript支持并不友好，而Vue3采用TypeScript进行重写，对TS的支持更加友好。</p>
<h3 data-id="heading-22">3.9 体积更小（移除了不常用的 API）</h3>
<ul>
<li>移除 inline-template (Vue2 中就不推荐使用)。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>n</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">on、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">、</span></span></span></span></span>off、$once （如果有需要可以采用 mitt 库来实现）。</li>
<li>删除过滤器 filter （可以通过计算属性或者方法来实现）。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>h</mi><mi>i</mi><mi>l</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>n</mi><mtext>移除（可以通过</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>v</mi><mi>i</mi><mi>d</mi><mi>e</mi><mtext>，</mtext><mi>i</mi><mi>n</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mtext>方法构建</mtext></mrow><annotation encoding="application/x-tex">children移除 （可以通过provide，inject方法构建</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">hi</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal">re</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">移除（可以通过</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">，</span><span class="mord mathnormal" style="margin-right:0.05724em;">inj</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">方法构建</span></span></span></span></span>children）。</li>
<li>移除.sync .native 修饰符 (.sync通过 v-model:xxx实现，.native为 Vue3 中的默认行为) 以及不在支持 keycode 作为v-on修饰符（@keyup.13 不再支持）。</li>
<li>移除全局 API。Vue.component、Vue.use、Vue.directive (将这些 api 挂载到实例上)。</li>
<li>通过构建工具 Tree-shaking 机制实现按需引入，减少用户打包后体积。</li>
</ul>
<h2 data-id="heading-23">4、Vue.js 为什么需要虚拟DOM？</h2>
<p>虚拟DOM（Virtual DOM）就是用 js 对象来描述真实 DOM，是对真实 DOM 的抽象。</p>
<h3 data-id="heading-24">4.1 性能优化</h3>
<ul>
<li><strong>直接操作 DOM 代价高昂</strong>：浏览器 DOM 操作是非常消耗性能的。</li>
<li><strong>最小差异更新</strong>：通过比对新旧虚拟 DOM 节点，找出最小差异进行更新。</li>
<li><strong>批量更新</strong>：在数据修改后，异步批量更新。</li>
</ul>
<blockquote>
<p>虚拟DOM并不一定能提升性能，比如你就改了一个数据，vue还要走一遍 DOM diff 比对完后再去调用原生 DOM API去更新，这时候其实你直接通过原生DOM API 去更新肯定性能更高，但是虚拟 DOM 能保证性能的下限，在你的应用复杂且庞大的时候，不至于性能太差。</p>
</blockquote>
<h3 data-id="heading-25">4.2 跨平台</h3>
<ul>
<li><strong>抽象层作用</strong>：虚拟 DOM 是对真实 DOM 的抽象表示。</li>
<li><strong>多端渲染</strong>：同一套虚拟 DOM 可以渲染到不同平台（Web、Native、Canvas等）。</li>
<li><strong>服务端渲染(SSR)</strong>：在没有真实 DOM 的环境下也能生成页面结构。</li>
</ul>
<h3 data-id="heading-26">4.3 声明式编程的优势</h3>
<ul>
<li><strong>开发者友好</strong>：开发者只需关心数据状态，不必手动操作 DOM。</li>
<li><strong>自动优化</strong>：框架层面负责最高效的更新策略，开发者无需微观管理。</li>
</ul>
<h3 data-id="heading-27">4.4 与响应式系统的协同</h3>
<ul>
<li><strong>依赖追踪</strong>：虚拟 DOM 与 Vue 的响应式系统紧密结合。</li>
<li><strong>组件级更新</strong>：数据更改后，在组件级别进行页面更新。</li>
</ul>
<h2 data-id="heading-28">5、Vue.js 组件间传值的方式</h2>
<p><strong>vue2</strong>：</p>
<ul>
<li>一、父子通信
<ol>
<li><code>props</code></li>
<li><code>$emit</code></li>
<li><code>$attrs、$listeners</code></li>
<li><code>$parent、$children</code></li>
<li><code>$ref</code></li>
<li><code>作用域插槽</code></li>
<li><code>v-model</code></li>
</ol>
</li>
<li>二、兄弟组件通信
<ol>
<li><code>mitt</code></li>
<li><code>$parent</code></li>
<li><code>vuex/pinia</code></li>
<li><code>app.config.globalProperties</code></li>
</ol>
</li>
<li>三、跨层级通信
<ol>
<li><code>vuex</code></li>
<li><code>provide/inject</code></li>
<li><code>event bus</code></li>
</ol>
</li>
</ul>
<p><strong>vue3</strong>：</p>
<ul>
<li>一、父子通信
<ol>
<li><code>props</code></li>
<li><code>defineEmits</code></li>
<li><code>$attrs</code></li>
<li><code>$ref + defineExpose</code></li>
<li><code>$parent</code></li>
<li><code>作用域插槽</code></li>
<li><code>v-model</code></li>
</ol>
</li>
<li>二、兄弟组件通信
<ol>
<li><code>mitt</code></li>
<li><code>$parent</code></li>
<li><code>vuex/pinia</code></li>
<li><code>app.config.globalProperties</code></li>
</ol>
</li>
<li>三、跨层级通信
<ol>
<li><code>mitt</code></li>
<li><code>vuex/pinia</code></li>
<li><code>provide/inject</code></li>
</ol>
</li>
</ul>
<p><strong>扩展：其它通信方式</strong>：</p>
<ul>
<li>浏览器本地存储<code>storage</code>。</li>
<li>全局<code>window</code>对象。</li>
<li>ES6模块化 import/export。</li>
</ul>
<h2 data-id="heading-29">6、v-show 和 v-if 有什么区别？使用场景分别是什么？</h2>
<p><strong>相同点</strong>：控制元素在页面是否显示。</p>
<p><strong>不同点</strong>：</p>
<ul>
<li><strong>控制手段不同</strong>：<code>v-show</code> 控制的是 <code>css</code> 的 <code>display</code> 属性是否为 <code>none</code> 来控制元素的是否隐藏，而 <code>v-if</code> 是直接不渲染 DOM 元素或者直接删除 DOM 元素。</li>
<li><strong>控制过程区别</strong>：<code>v-if</code> 切换有一个局部编译/卸载的过程，切换过程中合适地销毁和重建内部的事件监听和子组件，如果控制的是组件，也会执行组件的生命周期钩子；而<code>v-show</code> 只是简单的基于css切换。</li>
<li><strong>编译区别</strong>：<code>v-if</code> 在编译过程中会被转化成<strong>三元表达式</strong>,条件不满足时不渲染此节点。<code>v-show</code> 会被编译成指令，条件不满足时控制样式将对应节点隐藏 （内部其他指令依旧会继续执行）。</li>
<li><strong>性能消耗</strong>：<code>v-if</code> 比 <code>v-show</code> 有更高的性能消耗。</li>
</ul>
<p><strong>使用场景</strong>：频繁切换 + 不需要销毁状态用 <code>v-show</code>，反之用 <code>v-if</code>。</p>
<h2 data-id="heading-30">7、v-if 和 v-for  哪个优先级更高？</h2>
<ul>
<li>vue2 中 <code>v-for</code> 的优先级比 <code>v-if</code> 高，它们作用于一个节点上会导致先循环后对每一项进行判断，浪费性能。</li>
<li>vue3 中 <code>v-if</code> 的优先级比 <code>v-for</code> 高，这就会导致 <code>v-if</code> 中的条件无法访问 <code>v-for</code> 作用域名中定义的变量别名。</li>
</ul>
<p>所以不管是 <code>vue2</code> 还是 <code>vue3</code>，都不推荐同时使用 <code>v-if</code> 和 <code>v-for</code>，更好的方案是采用计算属性，或者在外层再包裹一个容器元素，将 <code>v-if</code> 作用在容器元素上。</p>
<p>不推荐用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;li v-for="item in arr" v-if="item.visible"&gt;
  {{ item}}
&lt;/li&gt;
</code></pre>
<p>推荐用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- visibleArr为计算属性 --&gt;
&lt;li v-for="item in visibleArr"&gt;
    {{ item}}
  &lt;/li&gt;
</code></pre>
<h2 data-id="heading-31">8、Vue.js 的 nextTick 是什么？有什么使用场景？</h2>
<p>Vue.js 中的 nextTick（或实例方法 this.$nextTick）是一个 Vue 提供的一个 API，用于在响应式状态变更后等待下一个 DOM 更新周期完成后再执行代码。由于 Vue 的 DOM 更新是异步的：当你修改响应式数据时，Vue 内部会缓冲这些变更，并在<code>“下一个 tick”</code>中一次性应用到 DOM，用这种批量更新的方式提高性能。所以这意味着数据变更后立即访问 DOM 可能获取到旧值，而 nextTick 确保回调在 DOM 实际更新后运行。</p>
<p>其使用场景如下：</p>
<ul>
<li><strong>数据更新后立即操作 DOM</strong>：如获取元素尺寸、焦点设置或第三方库初始化。如果不使用 nextTick，你可能拿到的是未更新的 DOM，导致错误。</li>
<li><strong>避免多次渲染</strong>：Vue.js 内部用它批量更新 DOM，提高性能。</li>
<li><strong>与异步操作结合</strong>：如在 Promise 或 setTimeout 后更新数据，然后 await nextTick 来处理后续 DOM 依赖的任务。</li>
<li><strong>组件生命周期钩子中</strong>：在 mounted 或 updated 钩子中，如果需要基于更新后的 DOM 执行代码，使用 nextTick 确保安全。</li>
<li><strong>测试和调试</strong>：在单元测试中，确保 DOM 已同步更新后再断言。</li>
</ul>
<h2 data-id="heading-32">9、Vue中 computed 和 watch 的区别</h2>








































<table><thead><tr><th>特性</th><th>computed (计算属性)</th><th>watch (侦听器)</th></tr></thead><tbody><tr><td>设计目的</td><td>派生新数据</td><td>观察数据变化执行副作用</td></tr><tr><td>返回值</td><td>必须返回一个值</td><td>不需要返回值</td></tr><tr><td>缓存</td><td>有缓存，依赖不变时不重新计算</td><td>无缓存，每次变化都执行</td></tr><tr><td>异步操作</td><td>不能包含异步操作</td><td>可以执行异步操作</td></tr><tr><td>初始执行</td><td>立即执行</td><td>默认不立即执行(配置 immediate: true后会立即执行)</td></tr><tr><td>使用场景</td><td>模板中使用的派生数据</td><td>数据变化时需要执行的操作(如API调用、复杂逻辑)</td></tr></tbody></table>
<h2 data-id="heading-33">10、Vue2 的生命周期方法有哪些？一般在哪一步发起请求及原因</h2>
<ul>
<li><strong>beforeCreate</strong>：在实例初始化之后，数据观测(data observer) 和 event/watcher 事件配置之前被调用。</li>
<li><strong>created</strong>：实例已经创建完成之后被调用。在这一步，实例已完成以下的配置：数据观测(data observer)，属性和方法的运算， watch/event 事件回调。这里没有$el</li>
<li><strong>beforeMount</strong>：在挂载开始之前被调用：相关的 render 函数首次被调用。</li>
<li><strong>mounted</strong>：el 被新创建的 vm.$el 替换，并挂载到实例上去之后调用该钩子。</li>
<li><strong>beforeUpdate</strong>：数据更新时调用，发生在虚拟 DOM 重新渲染和打补丁之前。</li>
<li><strong>updated</strong>：由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子。</li>
<li><strong>beforeDestroy</strong>：实例销毁之前调用。在这一步，实例仍然完全可用。</li>
<li><strong>destroyed</strong>：Vue 实例销毁后调用。调用后，Vue 实例指示的所有东西都会解绑定，所有的事件监听器会被移除，所有的子实例也会被销毁。 该钩子在服务器端渲染期间不被调用。</li>
</ul>
<p><strong>钩子函数的作用</strong>：</p>
<ul>
<li><strong>created</strong>：实例已经创建完成，因为它是最早触发的原因可以进行一些数据，资源的请求。(服务端渲染支持created方法)</li>
<li><strong>mounted</strong>：实例已经挂载完成，可以进行一些DOM操作</li>
<li><strong>beforeUpdate</strong>：可以在这个钩子中进一步地更改状态，这不会触发附加的重渲染过程。</li>
<li><strong>updated</strong>：可以执行依赖于 DOM 的操作。然而在大多数情况下，你应该避免在此期间更改状态，因为这可能会导致更新无限循环。 该钩子在服务器端渲染期间不被调用。</li>
<li><strong>destroyed</strong>：可以执行一些优化操作,清空定时器，解除绑定事件</li>
</ul>
<p>在哪发送请求都可以，主要看具体你要做什么事，一般会在 <code>created</code> 和 <code>mounted</code> 发起请求，但注意服务端渲染不执行 <code>mounted</code> 钩子。</p>
<h2 data-id="heading-34">11、Vue.js 中组件中的 data 为什么是一个函数?</h2>
<p>每次使用组件时都会对组件进行实例化操作，并且调用 <code>data</code> 函数返回一个对象作为组件的数据源。这样可以保证多个组件间数据互不影响。</p>
<h2 data-id="heading-35">12、谈谈对 Vue.js 组件化的理解？</h2>
<p>在 Vue.js 中，每一个 <code>.vue</code> 文件即一个 vue 组件，组件化的核心包括模板 template、属性 props、事件、插槽 slot、生命周期等。</p>
<p>组件化好处: 高内聚、可重用、可组合。</p>
<ul>
<li>组件化开发能大幅提高应用开发效率、测试性、复用性等;</li>
<li>降低更新范围，只重新渲染变化的组件。</li>
</ul>
<h2 data-id="heading-36">13、谈谈对 Vue.js 单向数据流的理解？</h2>
<p>Vue.js 的单向数据流是其核心设计原则之一，它确保数据在组件间流动时具有<strong>可预测性</strong>和<strong>一致性</strong>，便于调试和追踪 bug。</p>
<p>数据总是从父组件向下流动到子组件（通过 <code>props</code> 传递），而子组件不能直接修改从父组件接收到的数据。如果子组件需要更新数据，只能通过触发事件（<code>emits</code> 或自定义事件）通知父组件，由父组件负责实际的更新。</p>
<h2 data-id="heading-37">14、Vue.js 父组件如何监听子组件的生命周期？</h2>
<ul>
<li>vue2 用 @hook:mounted。</li>
<li>vue3 用 @vue:mounted。</li>
</ul>
<p>下面演示 vue3 的写法，vue2 同理。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- parent.vue --&gt;
&lt;template&gt;
  &lt;Child @vue:mounted="fn" /&gt;
&lt;/template&gt;


&lt;script lang="ts" setup&gt;
import Child from './Child.vue'
const afterChildMounted = () =&gt; {
  console.log('after child mounted')
}
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Child.vue --&gt;
&lt;script setup&gt;
import { onMounted } from 'vue'

onMounted(() =&gt; {
  console.log('child mounted')
})

&lt;/script&gt;

</code></pre>
<h2 data-id="heading-38">15、请说一下 Vue.js 中 key 的作用？</h2>
<p>在 Vue.js 中，<code>key</code> 属性主要用于优化列表渲染，特别是与 <code>v-for</code> 指令结合使用时。它为列表中的每个元素提供一个唯一的标识符，帮助 Vue 跟踪节点的身份，从而在数据变化时更高效地更新 DOM。</p>
<ul>
<li><strong>提升渲染效率</strong>：Vue 默认使用“就地更新”（in-place patch）策略来处理列表变化，即不移动 DOM 元素，而是直接更新现有元素的内容。如果列表项的顺序发生变化，这种策略可能导致问题（如状态丢失）。<code>key</code> 允许 Vue 复用和重新排序现有的 DOM 元素，确保更新更精确。</li>
<li><strong>保留组件状态</strong>：当列表项包含有状态的组件（如表单输入框）时，<code>key</code> 确保组件的内部状态（如输入值）不会在数据重排时丢失或错位。</li>
<li><strong>优化 diff 算法</strong>：Vue 的虚拟 DOM diff 过程依赖 <code>key</code> 来比较新旧节点。如果没有 key，Vue 会按索引比较，可能导致不必要的重新渲染。</li>
</ul>
<h2 data-id="heading-39">16、Vue.use 是干什么的？</h2>
<p><code>Vue.use</code> 方法是用于安装（注册）Vue 插件的全局方法。它允许开发者在 Vue 应用中引入第三方插件或自定义插件，从而扩展 Vue 的功能，如添加全局组件、指令、混入（mixins）或其他特性。
主要作用</p>
<ul>
<li><strong>插件安装机制</strong>：当调用 Vue.use(plugin) 时，Vue 会检查插件是否有一个 install 方法。如果有，它会调用 plugin.install(Vue, options)，其中 Vue 是 Vue 构造函数，options 是可选参数。这使得插件可以修改 Vue 的行为或添加新功能。</li>
<li><strong>避免重复安装</strong>：Vue.use 会自动检查插件是否已安装，如果已安装，则不会重复调用 install 方法。</li>
<li><strong>使用时机</strong>：通常在创建 Vue 实例之前调用，例如在 main.js 中引入插件。</li>
</ul>
<h2 data-id="heading-40">17、Vue.js 常用的修饰符及其作用？</h2>
<ol>
<li>事件修饰符</li>
</ol>
<ul>
<li><strong>.stop</strong>：阻止事件冒泡，相当于 <code>event.stopPropagation()</code>。</li>
<li><strong>.prevent</strong>：阻止默认行为，相当于 <code>event.preventDefault()</code>。</li>
<li><strong>.capture</strong>：使用捕获模式而非冒泡模式触发事件。</li>
<li><strong>.self</strong>：只在事件从元素本身触发时执行（忽略子元素冒泡）。</li>
<li><strong>.once</strong>：事件只触发一次（相当于 addEventListener 的 once 选项）。</li>
<li><strong>.passive</strong>：改善滚动事件的性能（不阻塞 UI 线程）。</li>
<li><strong>.native</strong>：在自定义组件上监听原生 DOM 事件。</li>
</ul>
<ol start="2">
<li>v-model表单修饰符</li>
</ol>
<ul>
<li><strong>.lazy</strong>：在 change 事件后更新数据，而不是 input 事件（延迟更新）。</li>
<li><strong>.number</strong>：将输入值自动转换为数字类型。</li>
<li><strong>.trim</strong>：自动去除输入值的首尾空格。</li>
</ul>
<ol start="3">
<li>按键修饰符（Key Modifiers）</li>
</ol>
<ul>
<li><strong>.enter</strong>：监听 Enter 键。</li>
<li><strong>.tab</strong>：监听 Tab 键。</li>
<li><strong>.delete</strong>：监听 Delete 或 Backspace 键。</li>
<li><strong>.esc</strong>：监听 Esc 键。</li>
<li><strong>.space</strong>：监听空格键。</li>
<li><strong>.up / .down / .left / .right</strong>：监听方向键。</li>
</ul>
<ol start="4">
<li>.sync 修饰符</li>
</ol>
<p><code>.sync</code> 修饰符主要是为了简化组件间的双向数据绑定，它是一种语法糖，允许子组件通过特定事件更新父组件的 prop，而无需手动编写事件监听器。</p>
<h2 data-id="heading-41">18、vue3 中 ref 和 reactive 的区别？</h2>
<p>相同点：<code>ref</code> 和 <code>reactive</code> 都可以创建响应式数据。</p>
<p>不同点：</p>
<ol>
<li>入参不同：</li>
</ol>
<ul>
<li><strong>ref</strong>：可以传基本数据类型（primitive values，如number、string、Symbol、undefined、null、bigInt、boolean），也可以包括对象。</li>
<li><strong>reactive</strong>：只能传入引用数据(object、array等)。</li>
</ul>
<ol start="2">
<li>访问和修改方式不同：</li>
</ol>
<ul>
<li><strong>ref</strong>：必须使用 .value 来读写。</li>
<li><strong>reactive</strong>：像普通对象一样直接访问属性，无需额外后缀。</li>
</ul>
<ol start="3">
<li>实现上不同：</li>
</ol>
<ul>
<li><strong>ref</strong>：如果传入基础数据类型，直接用 RefImpl 类的 get set, 但如果传入的是引用数据类型，内部是借助 reactive 实现。</li>
<li><strong>reactive</strong>：内部采用 Proxy 进行代理实现的响应式。</li>
</ul>
<h2 data-id="heading-42">19、Vue3 中如何获取当前组件实例？</h2>
<p>通过 <code>getCurrentInstance</code> 函数可以获取当前组件实例。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { getCurrentInstance } from 'vue';
const instance = getCurrentInstance();
console.log('instance: ', instance);
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-43">20、如何使用异步组件？</h2>
<p>vue3:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { defineAsyncComponent } from 'vue';
const AsyncCom = defineAsyncComponent(() =&gt; import('./MyComponent.vue'));
&lt;/script&gt;
</code></pre>
<p>vue2:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  components: {
    AsyncCom: () =&gt; import('./MyComponent.vue')
  }
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-44">21、Vue.js 父子组件生命周期钩子的执行流程？</h2>
<ol>
<li><strong>组件创建阶段</strong>： 父 beforeCreate → 父 created → 父 beforeMount → 子 beforeCreate → 子 created → 子 beforeMount → 子 mounted → 父 mounted。</li>
<li><strong>组件更新阶段</strong>：父 beforeUpdate → 子 beforeUpdate → 子 updated → 父 updated。</li>
<li><strong>组件销毁阶段</strong>：父 beforeDestroy → 子 beforeDestroy → 子 destroyed → 父 destroyed。</li>
</ol>
<h2 data-id="heading-45">结语</h2>
<p>以上是整理的 20+ Vue 初、中级的高频面试题，如有错误或者可以优化的地方欢迎评论区指正，后续还会更新 Vue 面试题高级篇。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么我的react项目启动后，dom上的类名里没有代码位置信息]]></title>    <link>https://juejin.cn/post/7571279513247825946</link>    <guid>https://juejin.cn/post/7571279513247825946</guid>    <pubDate>2025-11-11T13:35:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571279513247825946" data-draft-id="7571351275976015923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么我的react项目启动后，dom上的类名里没有代码位置信息"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-11-11T13:35:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么我的react项目启动后，dom上的类名里没有代码位置信息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:35:54.000Z" title="Tue Nov 11 2025 13:35:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在写一个新的 React 项目，打开浏览器开发者工具，发现个有意思的事：之前团队一起写的项目在 Elements 面板里，每个 DOM 元素都带着一堆 <code>data-component-*</code> 属性，能直接看到是哪个文件的哪一行代码。而这个我自己新起的项目就只有普通的 HTML 标签。</p>
<p>这到底咋回事？是不是有什么调试神器？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1941db24d5df4402a5a59b95bf33328a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472954&amp;x-signature=mWHd1MY8FRhsr9Xm6Yqzpj%2F1NEs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">React 的 DOM 为啥看不到组件名？</h2>
<p>先说个基础知识：React 组件最终会被编译成普通 HTML。你在 Elements 面板看到的是<strong>真实 DOM</strong>，不是 React 的虚拟 DOM。</p>
<p>比如这个组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"my-btn"</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<p>浏览器里只会看到：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-btn"</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>组件名 <code>MyButton</code> 根本不会出现在 DOM 里，因为它只是个 JavaScript 函数，最后返回的就是这个 <code>button</code> 元素。</p>
<h2 data-id="heading-1">那些能看到组件信息的项目是怎么做到的？</h2>
<p>看了别人的项目代码，发现都用了 Vite 调试插件。这类插件会给每个 React 元素注入调试属性：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">data-inspector</span>=<span class="hljs-string">"src/pages/HomePage.tsx:42:7"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>
&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>属性格式是 <code>文件路径:行号:列号</code>，一眼就能看出组件来源。</p>
<p>更强大的是，有些插件还支持<strong>点击页面元素直接跳转到 VS Code 源码</strong>！这才是真正的效率神器。</p>
<h2 data-id="heading-2">解决方案：vite-plugin-react-inspector</h2>
<p><code>vite-plugin-react-inspector</code> 是专门为 Vite + React 项目设计的调试工具，功能强大且易用。</p>
<h3 data-id="heading-3">安装</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-react-inspector
<span class="hljs-comment"># 或</span>
npm install -D vite-plugin-react-inspector
</code></pre>
<h3 data-id="heading-4">配置很简单</h3>
<p>在 <code>vite.config.ts</code> 里添加：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Inspector</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-react-inspector'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> ({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(),
    <span class="hljs-comment">// 只在开发模式启用</span>
    mode === <span class="hljs-string">'development'</span> &amp;&amp;
      <span class="hljs-title class_">Inspector</span>({
        <span class="hljs-attr">toggleButtonVisibility</span>: <span class="hljs-string">'always'</span>,
        <span class="hljs-attr">toggleComboKey</span>: <span class="hljs-string">'alt-shift'</span>,
      }),
  ].<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>),
}));
</code></pre>
<p>配置说明：</p>
<ul>
<li><code>toggleButtonVisibility: 'always'</code> - 始终显示检查器按钮</li>
<li><code>toggleComboKey: 'alt-shift'</code> - 使用 Alt+Shift 快捷键激活</li>
<li><code>mode === 'development'</code> - 生产环境自动禁用</li>
</ul>
<h3 data-id="heading-5">实际效果</h3>
<p>启动开发服务器后，在浏览器里看到的 DOM：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1221e687568c4d508cbee6eb65abca39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472954&amp;x-signature=1Mnmxe%2BvP%2BBax%2FqeBL4mUT9T%2FMg%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-inspector</span>=<span class="hljs-string">"src/pages/HomePage.tsx:42:7"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>属性格式是 <code>文件路径:行号:列号</code>，一眼就能看出来源。</p>
<p>然后复制在vscode搜索，直接就跳转到源码位置了。</p>
<h3 data-id="heading-6">仓库地址</h3>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsudongyuer%2Fvite-plugin-react-inspector" target="_blank" title="https://github.com/sudongyuer/vite-plugin-react-inspector" ref="nofollow noopener noreferrer">vite-plugin-react-inspector</a></strong> - GitHub 仓库，查看完整文档</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏗️ Spring Boot 3实现MySQL读写分离完整指南]]></title>    <link>https://juejin.cn/post/7571304204754649142</link>    <guid>https://juejin.cn/post/7571304204754649142</guid>    <pubDate>2025-11-11T13:35:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754649142" data-draft-id="7571306072422793258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏗️ Spring Boot 3实现MySQL读写分离完整指南"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-11T13:35:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏗️ Spring Boot 3实现MySQL读写分离完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:35:49.000Z" title="Tue Nov 11 2025 13:35:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✨ 读写分离的核心价值</h2>
<p>在高并发场景下，数据库往往成为系统瓶颈。读写分离通过将写操作定向到主库、读操作分发到从库，显著提升系统读性能和数据可用性。当主库出现故障时，从库可以继续提供读服务，提高系统的稳定性。</p>
<h2 data-id="heading-1">⚙️ 项目依赖配置</h2>
<p>首先在<code>pom.xml</code>中添加必要依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">📁 核心实现代码详解</h2>
<h3 data-id="heading-3">1. 配置文件设置（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 主库配置（写操作）</span>
    <span class="hljs-attr">master:</span>
      <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/master_db?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">master_password</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-comment"># Hikari连接池配置</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-comment"># 从库配置（读操作）</span>
    <span class="hljs-attr">slave:</span>
      <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/slave_db?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">slave_password</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">15</span>  <span class="hljs-comment"># 从库可以配置更多连接，因为读操作通常更频繁</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-4">2. 数据源枚举定义</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 数据源类型枚举
 * 用于标识当前操作应使用主库还是从库
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DataSourceType</span> {
    MASTER,  <span class="hljs-comment">// 主库：用于写操作（INSERT、UPDATE、DELETE）</span>
    SLAVE    <span class="hljs-comment">// 从库：用于读操作（SELECT）</span>
}
</code></pre>
<h3 data-id="heading-5">3. 数据源上下文管理器</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 数据源上下文管理器（基于ThreadLocal实现线程隔离）
 * 功能：保存当前线程使用的数据源类型，确保多线程环境下数据源切换不会相互干扰
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceContextHolder</span> {
    
    <span class="hljs-comment">// 使用ThreadLocal保证线程安全，每个线程有独立的数据源上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;DataSourceType&gt; CONTEXT_HOLDER = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 设置当前线程的数据源类型
     * @param dataSourceType 数据源类型（MASTER或SLAVE）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDataSourceType</span>(<span class="hljs-params">DataSourceType dataSourceType</span>)</span> {
        CONTEXT_HOLDER.<span class="hljs-keyword">set</span>(dataSourceType);
    }
    
    <span class="hljs-comment">/**
     * 获取当前线程的数据源类型
     * @return 当前数据源类型，默认为MASTER（保证写操作可靠性）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSourceType <span class="hljs-title">getDataSourceType</span>()</span> {
        <span class="hljs-keyword">return</span> CONTEXT_HOLDER.<span class="hljs-keyword">get</span>() == <span class="hljs-literal">null</span> ? DataSourceType.MASTER : CONTEXT_HOLDER.<span class="hljs-keyword">get</span>();
    }
    
    <span class="hljs-comment">/**
     * 清除当前线程的数据源类型
     * 防止内存泄漏，特别是在线程池场景下
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearDataSourceType</span>()</span> {
        CONTEXT_HOLDER.<span class="hljs-keyword">remove</span>();
    }
}
</code></pre>
<h3 data-id="heading-6">4. 动态路由数据源</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/**
 * 动态路由数据源（继承Spring的AbstractRoutingDataSource）
 * 核心功能：根据当前上下文动态选择主库或从库
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-comment">/**
     * 决定当前数据源查找键（Spring在每次数据库操作前调用此方法）
     * @return 数据源查找键（MASTER或SLAVE）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-type">DataSourceType</span> dataSourceType = <span class="hljs-type">DataSourceContextHolder</span>.getDataSourceType();
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"当前使用的数据源: "</span> + dataSourceType);
        <span class="hljs-keyword">return</span> dataSourceType;
    }
}
</code></pre>
<h3 data-id="heading-7">5. 数据源配置类</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 数据源配置类（核心配置）
 * 配置主从数据源并初始化路由数据源
 */</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableTransactionManagement</span>
<span class="hljs-variable">@EnableJpaRepositories</span>(
    basePackages = <span class="hljs-string">"com.example.repository"</span>,
    entityManagerFactoryRef = <span class="hljs-string">"entityManagerFactory"</span>,
    transactionManagerRef = <span class="hljs-string">"transactionManager"</span>
)
public class DataSourceConfig {
    
    <span class="hljs-comment">/**
     * 主库数据源（写操作）
     */</span>
    <span class="hljs-variable">@Bean</span>(name = <span class="hljs-string">"masterDataSource"</span>)
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.master"</span>)
    public DataSource <span class="hljs-built_in">masterDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 从库数据源（读操作）
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"slaveDataSource"</span>)
    @<span class="hljs-selector-tag">ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.slave"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">slaveDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 动态路由数据源（优先级最高，作为主数据源）
     */</span>
    @<span class="hljs-selector-tag">Primary</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"routingDataSource"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">routingDataSource</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"masterDataSource"</span>) DataSource masterDataSource,
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"slaveDataSource"</span>) DataSource slaveDataSource) {
        
        <span class="hljs-selector-tag">DynamicRoutingDataSource</span> <span class="hljs-selector-tag">routingDataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicRoutingDataSource</span>();
        
        <span class="hljs-comment">// 配置目标数据源映射</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">targetDataSources</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(DataSourceType.MASTER, masterDataSource);
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(DataSourceType.SLAVE, slaveDataSource);
        
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setTargetDataSources</span>(targetDataSources);
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setDefaultTargetDataSource</span>(masterDataSource); <span class="hljs-comment">// 默认使用主库</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">routingDataSource</span>;
    }
    
    <span class="hljs-comment">/**
     * 实体管理器工厂
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"entityManagerFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-selector-tag">entityManagerFactory</span>(
            EntityManagerFactoryBuilder builder, 
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"routingDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">builder</span>
            <span class="hljs-selector-class">.dataSource</span>(dataSource)
            <span class="hljs-selector-class">.packages</span>(<span class="hljs-string">"com.example.entity"</span>)
            <span class="hljs-selector-class">.persistenceUnit</span>(<span class="hljs-string">"mysqlUnit"</span>)
            <span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 事务管理器
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"transactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">transactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"entityManagerFactory"</span>) EntityManagerFactory entityManagerFactory) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-8">6. AOP切面实现自动路由</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 数据源切面配置（基于AOP自动切换数据源）
 * 通过方法名自动识别读写操作，实现数据源动态路由
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(1)</span> <span class="hljs-comment">// 确保在事务切面之前执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    
    <span class="hljs-comment">/**
     * 写操作切点（insert、update、delete、save开头的方法）
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service..*.create*(..)) || " +
            "execution(* com.example.service..*.update*(..)) || " +
            "execution(* com.example.service..*.delete*(..)) || " +
            "execution(* com.example.service..*.save*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWriteDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.setDataSourceType(DataSourceType.MASTER);
        System.out.println(<span class="hljs-string">"切换到主库（写操作）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 读操作切点（select、get、find、query开头的方法）
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service..*.select*(..)) || " +
            "execution(* com.example.service..*.get*(..)) || " +
            "execution(* com.example.service..*.find*(..)) || " +
            "execution(* com.example.service..*.query*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.setDataSourceType(DataSourceType.SLAVE);
        System.out.println(<span class="hljs-string">"切换到从库（读操作）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 后置处理：清理数据源上下文
     */</span>
    <span class="hljs-meta">@After("execution(* com.example.service..*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.clearDataSourceType();
        System.out.println(<span class="hljs-string">"清理数据源上下文"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">7. 业务层使用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 用户服务实现类
 * 演示读写分离的实际应用
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserRepository</span> userRepository;
    
    <span class="hljs-comment">/**
     * 新增用户（写操作自动路由到主库）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 方法名以"create"开头，AOP会自动切换到MASTER数据源</span>
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">save</span>(user);
    }
    
    <span class="hljs-comment">/**
     * 根据ID查询用户（读操作自动路由到从库）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>) <span class="hljs-comment">// 只读事务优化性能</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-comment">// 方法名以"get"开头，AOP会自动切换到SLAVE数据源</span>
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findById</span>(id).<span class="hljs-title function_">orElse</span>(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">/**
     * 查询所有用户（读操作）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findAll</span>();
    }
    
    <span class="hljs-comment">/**
     * 更新用户信息（写操作）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">save</span>(user);
    }
}
</code></pre>
<h2 data-id="heading-10">🔍 测试与验证</h2>
<h3 data-id="heading-11">单元测试类</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 读写分离测试类
 */</span>
<span class="hljs-keyword">@SpringBootTest</span>
class ReadWriteSeparationTest {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;
    
    <span class="hljs-comment">/**
     * 测试写操作（应路由到主库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testWriteOperation() {
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("testUser");
        user<span class="hljs-selector-class">.setPassword</span>("password");
        
        User savedUser = userService<span class="hljs-selector-class">.createUser</span>(user);
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(savedUser.getId());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("写操作测试通过（路由到主库）");
    }
    
    <span class="hljs-comment">/**
     * 测试读操作（应路由到从库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadOperation() {
        List&lt;User&gt; users = userService<span class="hljs-selector-class">.getAllUsers</span>();
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(users);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("读操作测试通过（路由到从库）");
    }
    
    <span class="hljs-comment">/**
     * 测试读写混合操作
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadWriteMix() {
        <span class="hljs-comment">// 写操作</span>
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("mixUser");
        userService<span class="hljs-selector-class">.createUser</span>(user);
        
        <span class="hljs-comment">// 读操作</span>
        User foundUser = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(foundUser);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("读写混合操作测试通过");
    }
}
</code></pre>
<h2 data-id="heading-12">⚠️ 关键注意事项</h2>
<h3 data-id="heading-13">1. 主从同步延迟处理</h3>
<p>在读写分离架构中，主从同步存在延迟可能性。刚写入主库的数据可能不会立即在从库中可用。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 强制读主库的场景
 */</span>
<span class="hljs-keyword">@Service</span>
public class CriticalService {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserRepository userRepository;
    
    <span class="hljs-comment">/**
     * 重要业务：写入后立即读取，强制走主库
     */</span>
    public User <span class="hljs-built_in">createAndGetUser</span>(User user) {
        <span class="hljs-comment">// 写入主库</span>
        User savedUser = userRepository<span class="hljs-selector-class">.save</span>(user);
        
        <span class="hljs-comment">// 强制从主库读取（避免同步延迟）</span>
        DataSourceContextHolder<span class="hljs-selector-class">.setDataSourceType</span>(DataSourceType.MASTER);
        try {
            return userRepository<span class="hljs-selector-class">.findById</span>(savedUser.getId())<span class="hljs-selector-class">.orElse</span>(null);
        } finally {
            DataSourceContextHolder<span class="hljs-selector-class">.clearDataSourceType</span>();
        }
    }
}
</code></pre>
<h3 data-id="heading-14">2. 事务中的数据处理</h3>
<p>在事务中，所有操作应使用同一数据源。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalService</span> {
    
    <span class="hljs-comment">/**
     * 事务内强制使用主库
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">complexBusinessOperation</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 方法开始时显式设置主库，确保事务内一致性</span>
        <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSourceType</span>(<span class="hljs-title class_">DataSourceType</span>.<span class="hljs-property">MASTER</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 一系列数据库操作...</span>
            <span class="hljs-comment">// 所有这些操作都在同一事务中，使用同一数据源</span>
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 事务结束后清理</span>
            <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">clearDataSourceType</span>();
        }
    }
}
</code></pre>
<h2 data-id="heading-15">📊 方案优缺点分析</h2>

























<table><thead><tr><th>优势</th><th>挑战</th><th>应对策略</th></tr></thead><tbody><tr><td>提升读性能：将读请求分发到从库</td><td>主从同步延迟</td><td>关键业务强制读主库</td></tr><tr><td>提高可用性：主库故障时从库可读</td><td>事务内数据源一致性</td><td>事务中强制使用主库</td></tr><tr><td>减轻主库压力</td><td>复杂SQL路由</td><td>明确的读写操作分离</td></tr></tbody></table>
<h2 data-id="heading-16">💎 总结</h2>
<p>通过以上完整的Spring Boot 3实现方案，你可以成功配置MySQL读写分离。关键在于理解动态数据源路由原理，合理处理主从同步延迟和事务一致性等挑战。这种架构能显著提升系统性能，特别适合读多写少的应用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI 核心命令指南，让工作从从容容游刃有余]]></title>    <link>https://juejin.cn/post/7571281406509711411</link>    <guid>https://juejin.cn/post/7571281406509711411</guid>    <pubDate>2025-11-11T09:27:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509711411" data-draft-id="7571279513246826522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI 核心命令指南，让工作从从容容游刃有余"/> <meta itemprop="keywords" content="程序员,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-11-11T09:27:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI 核心命令指南，让工作从从容容游刃有余
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:27:43.000Z" title="Tue Nov 11 2025 09:27:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>让我看看，谁还没有用上 Gemini CLI？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe596921c2f43609e36f51287920e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458062&amp;x-signature=yQQgn8QmJ6CnzmzgJVVXWln0Ppk%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>免费额度</strong>：个人 Google 账户可享受每分钟 60 次请求的免费额度，足以满足日常开发中的交互需求。</p>
</li>
<li>
<p><strong>强大的模型支持</strong>：由 Gemini 2.5 Pro 模型驱动，拥有高达一百万 token 的上下文窗口，能够处理和理解大型代码库或复杂的文档。</p>
</li>
<li>
<p><strong>内置工具集</strong>：集成了多种实用工具，包括使用 Google 搜索来提供有时效性的回答、执行文件系统操作、运行 shell 命令以及获取网页内容。</p>
</li>
<li>
<p><strong>可扩展性</strong>：支持模型上下文协议（Model Context Protocol, MCP），为开发者创建自定义工具集成提供了可能。</p>
</li>
<li>
<p><strong>终端优先设计</strong>：完全为那些以命令行作为主要工作环境的开发者量身打造。</p>
</li>
<li>
<p><strong>开源许可</strong>：项目基于 Apache 2.0 许可证开源，保证了其透明度和社区参与度。</p>
</li>
</ul>
<p>Gemini CLI 部署起来也很容易，用 ServBay 一键安装好 Node.js 20或者更高的版本，直接通过<code>npm</code>就可以安装Gemini CLI。</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli
</code></pre>
<p>之所以推荐 ServBay ，是因为它提供了一个隔离的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fnodejs" target="_blank" title="https://www.servbay.com/features/nodejs" ref="nofollow noopener noreferrer">集成开发环境</a>，允许开发者通过图形化界面一键部署和管理包括 Node.js、Rust 在内的多种服务。这种方式避免了使用版本管理器（如 nvm）在系统全局范围内频繁切换的复杂性，也杜绝了传统包管理器（如 Homebrew）可能带来的依赖混乱，干净又卫生。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6d3171396dd42e88a1fb945dc7a8b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458062&amp;x-signature=nDvT%2F6aoMXp7lMG234hEFhWJbDs%3D" alt="" loading="lazy"/></p>
<p>安装完毕，便可以开始探索 Gemini CLI 的功能。</p>
<h3 data-id="heading-0">初始配置：建立与项目的连接</h3>
<p>首次在项目中使用 Gemini CLI，需要执行几个基础命令来完成初始化和配置。</p>
<ul>
<li>
<p><strong>/init：</strong> 在项目根目录执行此命令，是与 Gemini CLI 建立联系的第一步。它会分析项目结构，为后续的交互提供上下文基础。</p>
</li>
<li>
<p><strong>/auth：</strong> 此命令用于处理身份验证。首次执行时，它会引导用户完成 Google 账户的登录与授权流程，确保 CLI 拥有访问 AI 服务的权限。</p>
</li>
<li>
<p><strong>/about：</strong> 查询当前 Gemini CLI 的版本、所使用的底层模型以及配置的身份验证方法。这个命令有助于了解工具的当前状态。</p>
</li>
<li>
<p><strong>/help</strong> &amp; <strong>/docs：</strong> 遇到疑问时，<code>/help</code> 提供了一个快速的命令列表。而 <code>/docs</code> 则会在浏览器中打开官方文档，供查阅更详尽的信息。</p>
</li>
</ul>
<h3 data-id="heading-1">核心功能：日常工作流中的命令</h3>
<p>熟悉基本配置后，以下这些命令将成为日常开发中的得力工具。</p>
<ul>
<li>
<p><strong>! (Shell 命令前缀)</strong> ：这是一个极为实用的功能。在输入框中以 <code>!</code> 开头，可以直接执行 shell 命令。更进一步，可以结合自然语言让 Gemini 解释或生成命令，这对于处理那些复杂或不常用的命令尤为有效。</p>
</li>
<li>
<p><strong>/tools：</strong> 执行此命令可以列出 Gemini 当前可用的所有工具集。了解其能力边界，有助于提出更精准、更有效的问题。</p>
</li>
<li>
<p><strong>/editor</strong>：对于需要输入大段代码或复杂问题的场景，终端的单行输入框显得捉襟见肘。通过 <code>/editor</code> 命令配置一个外部文本编辑器（如 VS Code 或 Vim），之后使用 <code>Ctrl+X</code> 快捷键即可在熟悉的环境中编写提示，完成后保存退出，内容便会自动发送。</p>
</li>
</ul>
<h3 data-id="heading-2">会话管理：保存与追溯思路</h3>
<p>与 Gemini 的交互是一个连续的对话过程，保留这些上下文对于解决复杂问题非常有价值。</p>
<ul>
<li>
<p><strong>/chat</strong>：这是一个功能强大的会话管理命令。使用 <code>/chat save &lt;name&gt;</code> 可以将当前的对话保存下来，以便日后通过 <code>/chat resume &lt;name&gt;</code> 继续。它还支持 <code>list</code> 和 <code>delete</code> 等操作来管理所有已保存的会话。</p>
</li>
<li>
<p><strong>/clear</strong>：当需要开始一个全新的话题时，此命令可以清空当前的对话历史和屏幕，提供一个干净的交互界面。</p>
</li>
</ul>
<h3 data-id="heading-3">实际应用场景</h3>
<p>下面通过几个具体的例子，展示 Gemini CLI 在实际工作中的应用。</p>
<h4 data-id="heading-4"><strong>代码重构建议</strong></h4>
<p>假设有一个用于数据验证的函数，其逻辑虽然正确但不够简洁。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// file: validation.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkUserAccess</span>(<span class="hljs-params">userObject</span>) {
  <span class="hljs-keyword">if</span> (userObject &amp;&amp; userObject.<span class="hljs-property">isActive</span> &amp;&amp; userObject.<span class="hljs-property">permissions</span>.<span class="hljs-property">level</span> &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>可以向 Gemini CLI 提出请求：</p>
<p><code>@validation.js Please refactor the checkUserAccess function to be more concise.</code></p>
<p>Gemini 可能会返回一个更精炼的版本：</p>
<pre><code class="hljs language-ini" lang="ini">// Suggested refactoring
const <span class="hljs-attr">checkUserAccess</span> = (userObject) =&gt;
  !!userObject &amp;&amp; userObject.isActive &amp;&amp; userObject.permissions.level &gt; 1<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5"><strong>生成 Git 提交信息</strong></h4>
<p>编写规范的 Git commit message 是一项耗时的任务。可以借助 Gemini CLI 自动化这个过程。首先，查看暂存区的代码变更：</p>
<p><code>!git diff --staged</code></p>
<p>然后，基于这些变更请求生成提交信息：</p>
<p><code>From the diff above, write a Conventional Commit message.</code></p>
<p>这将产出一条格式良好、内容准确的提交信息，大大节省了思考和撰写的时间。</p>
<h4 data-id="heading-6"><strong>解释复杂的 Shell 命令</strong></h4>
<p>当遇到一段从网络上复制的、不甚明了的 shell 命令时，直接运行存在风险。可以让 Gemini 先行解释。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">&gt; Explain <span class="hljs-keyword">this</span> command: awk -F<span class="hljs-string">','</span> <span class="hljs-string">'{print $1, $3}'</span> <span class="hljs-keyword">data</span>.csv
</code></pre>
<p>Gemini 会提供一个清晰的逐段解释：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">✦ Certainly. This command uses `awk` <span class="hljs-keyword">to</span> process a CSV file. Here <span class="hljs-built_in">is</span> a breakdown:

  * `awk`: This <span class="hljs-built_in">is</span> the command-line utility being invoked, designed <span class="hljs-keyword">for</span> <span class="hljs-keyword">text</span> processing.
  * `-F<span class="hljs-comment">','`: The `-F` option sets the field separator. Here, it's set to a comma (`,`), which means `awk` will treat each line as a series of comma-separated fields.</span>
  * `<span class="hljs-comment">'{print $1, $3}'`: This is the action `awk` will perform on each line of the input. It instructs `awk` to print the first field (`$1`) followed by a space, and then the third field (`$3`).</span>
  * `data.csv`: This <span class="hljs-built_in">is</span> the input file <span class="hljs-keyword">for</span> the command.

  <span class="hljs-keyword">In</span> summary, the command reads the `data.csv` file, splits <span class="hljs-keyword">each</span> line <span class="hljs-keyword">by</span> commas, <span class="hljs-built_in">and</span> prints the first <span class="hljs-built_in">and</span> third columns <span class="hljs-keyword">from</span> <span class="hljs-keyword">each</span> line <span class="hljs-keyword">to</span> the standard output.
</code></pre>
<h3 data-id="heading-7">结语</h3>
<p>将 Gemini CLI 集成到开发工作流中，让你的开发工作从从容容游刃有余。使用 ServBay 搭建一个可靠的运行环境开始，到熟练运用其核心命令解决编码、代码管理和系统操作中的实际问题，开发者可以获得更流畅、更专注的工作体验。掌握这些工具，你就不会匆匆忙忙连滚带爬。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则]]></title>    <link>https://juejin.cn/post/7571299394345680938</link>    <guid>https://juejin.cn/post/7571299394345680938</guid>    <pubDate>2025-11-11T13:41:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345680938" data-draft-id="7571306072422809642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-11-11T13:41:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:41:13.000Z" title="Tue Nov 11 2025 13:41:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring Boot中实现数据源切换，除了AOP切面，还有几种非常灵活的策略。下面我用一个表格对比各种方案，然后重点介绍两种最实用的方法：</p>








































<table><thead><tr><th>策略类型</th><th>实现方式</th><th>灵活性</th><th>代码侵入性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>注解驱动</strong></td><td>使用<code>@DS</code>等注解标记方法/类</td><td>高</td><td>低</td><td>精确到方法级别的数据源控制</td></tr><tr><td><strong>手动编程</strong></td><td>在代码中调用API动态切换</td><td>最高</td><td>高</td><td>复杂业务逻辑、同一方法内多数据源</td></tr><tr><td><strong>请求特征路由</strong></td><td>基于HTTP头、参数等自动路由</td><td>中高</td><td>低</td><td>多租户、按客户分库等场景</td></tr><tr><td><strong>方法规则路由</strong></td><td>基于方法名约定自动切换</td><td>中</td><td>低</td><td>有固定命名规范的读写分离</td></tr></tbody></table>
<h2 data-id="heading-0">🔁 注解驱动切换</h2>
<p>这是目前<strong>最流行且优雅</strong>的方案，MyBatis-Plus的动态数据源组件提供了开箱即用的支持。</p>
<h3 data-id="heading-1">配置依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
-   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
-   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">配置文件</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>  <span class="hljs-comment"># 默认数据源</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>    <span class="hljs-comment"># 是否严格匹配数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/master</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">master_password</span>
        <span class="hljs-attr">slave:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/slave</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave_password</span>
</code></pre>
<h3 data-id="heading-3">使用@DS注解</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">// 默认使用主库（写操作）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
    
    <span class="hljs-comment">// 显式指定从库（读操作）</span>
    <span class="hljs-meta">@DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectById</span>(id);
    }
    
    <span class="hljs-comment">// 在Mapper层直接指定数据源</span>
    <span class="hljs-meta">@DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">findActiveUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectActiveUsers</span>();
    }
}
</code></pre>
<p><strong>优点</strong>：声明式配置，代码侵入性低，支持类级别和方法级别的精细控制。</p>
<h2 data-id="heading-4">⚙️ 手动编程切换</h2>
<p>对于需要<strong>在同一方法内使用多个数据源</strong>的复杂场景，手动控制提供了最大灵活性。</p>
<h3 data-id="heading-5">基本API使用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 第一阶段：从主库读取订单</span>
        DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
            <span class="hljs-comment">// 业务处理...</span>
        } <span class="hljs-keyword">finally</span> {
            DynamicDataSourceContextHolder.poll();
        }
        
        <span class="hljs-comment">// 第二阶段：写入从库进行数据分析</span>
        DynamicDataSourceContextHolder.push(<span class="hljs-string">"slave"</span>);
        <span class="hljs-keyword">try</span> {
            analysisMapper.insertOrderAnalysis(order);
        } <span class="hljs-keyword">finally</span> {
            DynamicDataSourceContextHolder.poll();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">基于HTTP请求的自动切换</h3>
<p>通过过滤器或拦截器实现基于请求特征的路由：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@WebFilter</span>(urlPatterns = <span class="hljs-string">"/*"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">doFilter</span>(<span class="hljs-title class_">ServletRequest</span> request, <span class="hljs-title class_">ServletResponse</span> response, 
                         <span class="hljs-title class_">FilterChain</span> chain) throws <span class="hljs-title class_">IOException</span>, <span class="hljs-title class_">ServletException</span> {
        <span class="hljs-title class_">HttpServletRequest</span> httpRequest = (<span class="hljs-title class_">HttpServletRequest</span>) request;
        
        <span class="hljs-comment">// 从请求头获取数据源标识（如多租户场景）</span>
        <span class="hljs-title class_">String</span> tenantId = httpRequest.<span class="hljs-title function_">getHeader</span>(<span class="hljs-string">"X-Tenant-Id"</span>);
        <span class="hljs-comment">// 或从请求参数判断业务类型</span>
        <span class="hljs-title class_">String</span> businessType = httpRequest.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">"bizType"</span>);
        
        <span class="hljs-title class_">String</span> dataSourceKey = <span class="hljs-title function_">determineDataSource</span>(tenantId, businessType);
        
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">push</span>(dataSourceKey);
        <span class="hljs-keyword">try</span> {
            chain.<span class="hljs-title function_">doFilter</span>(request, response);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">poll</span>();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">determineDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> tenantId, <span class="hljs-built_in">String</span> businessType</span>) {
        <span class="hljs-comment">// 复杂的路由逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"report"</span>.<span class="hljs-title function_">equals</span>(businessType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"report_db"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tenantId != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"tenant_"</span> + tenantId;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"master"</span>; <span class="hljs-comment">// 默认数据源</span>
    }
}
</code></pre>
<h2 data-id="heading-7">🧠 自定义路由规则</h2>
<p>通过继承<code>AbstractRoutingDataSource</code>并重写<code>determineCurrentLookupKey()</code>方法，可以实现基于<strong>业务逻辑的复杂路由</strong>。</p>
<h3 data-id="heading-8">基于方法名的路由示例</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusinessRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 获取当前方法名进行路由决策</span>
        <span class="hljs-type">String</span> methodName = getCurrentMethodName();
        
        <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"find"</span>) || methodName.startsWith(<span class="hljs-string">"query"</span>) 
            || methodName.startsWith(<span class="hljs-string">"select"</span>) || methodName.startsWith(<span class="hljs-string">"get"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"slave"</span>; <span class="hljs-comment">// 读操作路由到从库</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"insert"</span>) || methodName.startsWith(<span class="hljs-string">"update"</span>) 
                 || methodName.startsWith(<span class="hljs-string">"delete"</span>) || methodName.startsWith(<span class="hljs-string">"save"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"master"</span>; <span class="hljs-comment">// 写操作路由到主库</span>
        }
        
        <span class="hljs-comment">// 默认路由策略</span>
        <span class="hljs-keyword">return</span> isReadOperation(methodName) ? <span class="hljs-string">"slave"</span> : <span class="hljs-string">"master"</span>;
    }
}
</code></pre>
<h3 data-id="heading-9">基于参数值的路由</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParameterBasedRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 从线程上下文或参数中获取路由信息</span>
        <span class="hljs-type">String</span> businessUnit = <span class="hljs-type">RequestContextHolder</span>.getBusinessUnit();
        <span class="hljs-type">String</span> dataType = <span class="hljs-type">RequestContextHolder</span>.getDataType();
        
        <span class="hljs-comment">// 组合路由逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"finance"</span>.equals(businessUnit) &amp;&amp; <span class="hljs-string">"sensitive"</span>.equals(dataType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"finance_secure_db"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"report"</span>.equals(dataType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"reporting_db"</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"default_db"</span>;
    }
}
</code></pre>
<h2 data-id="heading-10">⚠️ 实战注意事项</h2>
<ol>
<li><strong>事务管理</strong>：在手动切换数据源时，确保<strong>同一个事务内使用同一数据源</strong>，避免跨数据源事务导致的数据不一致问题。</li>
<li><strong>资源清理</strong>：使用<code>try-finally</code>确保每次数据源切换后都能正确清理上下文，防止<strong>内存泄漏</strong>和<strong>数据源污染</strong>。</li>
<li><strong>性能考量</strong>：频繁的数据源切换会带来性能开销，在高性能场景下应考虑<strong>批量操作</strong>或<strong>连接复用</strong>。</li>
<li><strong>降级策略</strong>：始终配置合理的<strong>主从延迟处理</strong>和<strong>故障降级</strong>机制，确保主库不可用时系统的可用性。</li>
</ol>
<h2 data-id="heading-11">💎 总结</h2>
<p>选择合适的数据源切换策略需要权衡灵活性和复杂性。对于大多数场景，<strong>注解驱动方案</strong>提供了最佳实践；对于复杂业务逻辑，<strong>手动编程控制</strong>不可或缺；而对于有固定路由规则的场景，<strong>自定义路由策略</strong>能够提供最优雅的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PAI Physical AI Notebook详解2：基于Cosmos世界模型的操作动作数据扩增与模仿学习]]></title>    <link>https://juejin.cn/post/7571285984088686644</link>    <guid>https://juejin.cn/post/7571285984088686644</guid>    <pubDate>2025-11-11T09:36:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984088686644" data-draft-id="7571176484514447375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PAI Physical AI Notebook详解2：基于Cosmos世界模型的操作动作数据扩增与模仿学习"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-11T09:36:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PAI Physical AI Notebook详解2：基于Cosmos世界模型的操作动作数据扩增与模仿学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:36:14.000Z" title="Tue Nov 11 2025 09:36:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上期Notebook详解系列中，我们介绍了《基于Isaac仿真的操作动作数据扩增与模仿学习》，本期我们将介绍一套类似的方案，同样可以完成人工演示、数据扩增、模仿学习、模型测评这几个环节，但完全使用Cosmos世界模型作为内核。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f474261b28e74a3c827534205e6e9993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=IqQCAUAZekvwtGmLdPIWEj9%2BgNI%3D" alt="image.png" loading="lazy"/></p>
<p>相比基于Isaac仿真的方案，使用Cosmos世界模型的方案具有以下特点：</p>
<ul>
<li>人工演示、数据扩增环节无需仿真算力（RT Core），全流程使用AI算力（CUDA Core/Tensor Core）</li>
<li>无需对人工演示数据进行动作打标处理，直接使用视频数据即可实现扩增</li>
<li>无需单独的数据增强环节，可在数据扩增环节通过调整提示词实现数据增强</li>
<li>需要额外的拒绝采样步骤以过滤不合理的生成内容，以及额外的IDM逆解算步骤以补齐视频中缺少的action序列</li>
</ul>
<p>在PAI的Notebook Gallery中，我们已经预置了一个最佳实践，就是这个过程的一个具体示例：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.pai-ml.com%2F%23%2Fpreview%2FdeepLearning%2Fcv%2Fisaac_gr00t_wf2" target="_blank" title="https://gallery.pai-ml.com/#/preview/deepLearning/cv/isaac_gr00t_wf2" ref="nofollow noopener noreferrer">gallery.pai-ml.com/#/preview/d…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ee023d780a04e15982cd2ac7d8aa47f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=ATG%2B1iVhlKgK7KOSPf5VBw7DjCM%3D" alt="image.png" loading="lazy"/></p>
<p>下面我们来详细解读这个示例。</p>
<h2 data-id="heading-0">人工少量演示</h2>
<p>与基于仿真的数据扩增相同，人工演示可以在真实空间或仿真空间中进行，但无需进行动作打标，仅需录制视频即可
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FrO6y913mSC_E0Y1aGBnsF0FGjfTgkyCmulBHQ39j4lk.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/rO6y913mSC_E0Y1aGBnsF0FGjfTgkyCmulBHQ39j4lk.mp4" ref="nofollow noopener noreferrer">查看演示 &gt;&gt;</a></p>
<p>在视频中，左上角的操控者远程控制机器人本体，对蔬菜进行了“Pick and Place”的动作。同时，由操控者对视频内容进行文字描述，例如：</p>
<blockquote>
<p>Use the right hand to pick up green bok choy from tan table right side to bottom level of wire basket.</p>
</blockquote>
<p>采集类似的视频数据，直至满足Cosmos-Predict模型微调的要求（本样例中为100条）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f99326a209b410b92672b8fe49af307~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=4zxkvBNFgeZpXpq0fymXsvz2Fms%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">数据扩增</h2>
<p>利用Cosmos世界模型进行数据扩增，首先要使用人工演示数据对Cosmos-Predict模型进行微调。本例中使用Cosmos-Predict2-2B-Video2World模型，在4*GU8T机型中进行微调：</p>
<pre><code class="hljs language-python" lang="python">!torchrun --nproc_per_node=<span class="hljs-number">4</span> --master_port=<span class="hljs-number">12341</span> -m scripts.train --config=cosmos_predict2/configs/base/config.py -- experiment=predict2_video2world_training_2b_groot_gr1_480
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/845a0b8c341e4c79ac7dd366aa02417a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=gvoPzDFiNP4PtAcwKmZbe1%2BoDEg%3D" alt="image.png" loading="lazy"/></p>
<p>对于更大的世界模型，例如Cosmos-Predict2-14B-Video2World，可以在DLC中，使用4节点 × 8*GU8T的机型中进行微调：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">from</span> alibabacloud_tea_openapi.models <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">from</span> alibabacloud_credentials.client <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> CredClient
<span class="hljs-keyword">from</span> alibabacloud_credentials.models <span class="hljs-keyword">import</span> Config <span class="hljs-keyword">as</span> CredConfig
<span class="hljs-keyword">from</span> alibabacloud_pai_dlc20201203.client <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> DLCClient
<span class="hljs-keyword">from</span> alibabacloud_pai_dlc20201203.models <span class="hljs-keyword">import</span> (
    CreateJobRequest,
    GetJobRequest,
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">wait_for_job_to_terminate</span>(<span class="hljs-params">client, job_id</span>):
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        job = client.get_job(job_id, GetJobRequest()).body
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'job({}) is {}'</span>.<span class="hljs-built_in">format</span>(job_id, job.status))
        <span class="hljs-keyword">if</span> job.status <span class="hljs-keyword">in</span> (<span class="hljs-string">'Succeeded'</span>, <span class="hljs-string">'Failed'</span>, <span class="hljs-string">'Stopped'</span>):
            <span class="hljs-keyword">return</span> job.status
        time.sleep(<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    current_time_tuple = time.localtime()
    year = current_time_tuple.tm_year
    month = current_time_tuple.tm_mon
    day = current_time_tuple.tm_mday
    hour = current_time_tuple.tm_hour
    minute = current_time_tuple.tm_min
    <span class="hljs-comment"># 请确认您的主账号已授权DLC，且拥有足够的权限。</span>
    display_name = <span class="hljs-string">f"train_cosmos-predict2_14b_<span class="hljs-subst">{day}</span>_<span class="hljs-subst">{hour}</span>-<span class="hljs-subst">{minute}</span>"</span>  <span class="hljs-comment">#设置任务名称 </span>
    region_id = os.environ.get(<span class="hljs-string">"dsw_region"</span>) <span class="hljs-comment">#设置regionid</span>
    workspace_id = os.environ.get(<span class="hljs-string">'PAI_WORKSPACE_ID'</span>) <span class="hljs-comment">#设置成用户自己的工作空间id</span>
    image_uri = <span class="hljs-string">f"dsw-registry.<span class="hljs-subst">{region_id}</span>.cr.aliyuncs.com/pai-training-algorithm/isaac-sim:gr00t-dreams-v9"</span> <span class="hljs-comment">#使用官方镜像</span>
    ecs_spec = <span class="hljs-string">"ecs.gn8v-8x.16xlarge"</span>
    num_gpus = <span class="hljs-number">8</span> <span class="hljs-comment"># 与资源规格保持一致</span>
    num_nodes = <span class="hljs-number">4</span>
    <span class="hljs-comment">#########训练任务相关配置#############</span>
    config = <span class="hljs-string">"cosmos_predict2/configs/base/config.py"</span>
    exp = <span class="hljs-string">"predict2_video2world_training_14b_groot_gr1_480"</span>
    <span class="hljs-comment">#########训练任务相关配置#############</span>

    <span class="hljs-comment"># 本示例通过Credentials SDK默认从环境变量中读取AccessKey，来实现身份验证。</span>
    credentialsConfig = CredConfig(
        <span class="hljs-built_in">type</span>=<span class="hljs-string">'credentials_uri'</span>   <span class="hljs-comment"># 选填。若您未配置其他“默认凭据链”访问方式，您无需再显式指定，Credentials SDK会通过uri方式获取临时凭证</span>
    )
    cred = CredClient(credentialsConfig)

    <span class="hljs-comment"># 1. create client;</span>
    dlc_client = DLCClient(
         config=Config(
            credential=cred,
            region_id=region_id,
            endpoint=<span class="hljs-string">'pai-dlc.{}.aliyuncs.com'</span>.<span class="hljs-built_in">format</span>(region_id),
         )
    )
        
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'-------- Create Job ----------'</span>)
    <span class="hljs-comment"># 创建DLC作业。</span>
    create_job_resp = dlc_client.create_job(CreateJobRequest().from_map({
        <span class="hljs-string">'WorkspaceId'</span>: workspace_id,
        <span class="hljs-string">'DisplayName'</span>: display_name,
        <span class="hljs-string">'JobType'</span>: <span class="hljs-string">'PyTorchJob'</span>,
        <span class="hljs-comment"># 'ResourceId': resource_quota_id,</span>
        <span class="hljs-string">'JobSpecs'</span>: [
            {
                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"Worker"</span>,
                <span class="hljs-string">"Image"</span>: image_uri,
                <span class="hljs-string">"PodCount"</span>: num_nodes,
                <span class="hljs-string">"EcsSpec"</span>: ecs_spec,
            },
        ],
        <span class="hljs-string">'DataSources'</span>: [
            {
                <span class="hljs-string">"DataSourceId"</span>: dataset_id,
            },
        ],
       <span class="hljs-string">'UserVpc'</span>: {
            <span class="hljs-string">"VpcId"</span>: vpc_id,  <span class="hljs-comment"># 替换为实际 VPC ID</span>
            <span class="hljs-string">"SwitchId"</span>: switch_id,  <span class="hljs-comment"># 替换为实际交换机 ID</span>
            <span class="hljs-string">"SecurityGroupId"</span>: security_groupid  <span class="hljs-comment"># 替换为实际安全组 ID</span>
        },
        <span class="hljs-string">"UserCommand"</span>: <span class="hljs-string">f" export NVTE_FUSED_ATTN=0 &amp;&amp; \
            rm -rf /workspace/cosmos-predict2/checkpoints &amp;&amp; \
            rm -rf /workspace/cosmos-predict2/datasets/benchmark_train/gr1 &amp;&amp; \
            ln -s /mnt/data/notebook2/checkpoints /workspace/cosmos-predict2/checkpoints &amp;&amp; \
            ln -s /mnt/data/notebook2/gr1 /workspace/cosmos-predict2/datasets/benchmark_train/gr1 &amp;&amp; \
            cd /workspace/cosmos-predict2 &amp;&amp; \
            torchrun --nproc_per_node=<span class="hljs-subst">{num_gpus}</span> --nnodes=<span class="hljs-subst">{num_nodes}</span> --rdzv_id 123 --rdzv_backend c10d --rdzv_endpoint $MASTER_ADDR:1234 -m \
            scripts.train --config=<span class="hljs-subst">{config}</span> \
            -- experiment=<span class="hljs-subst">{exp}</span> \
            model.config.fsdp_shard_size=0"</span>
    }))
    job_id = create_job_resp.body.job_id

    wait_for_job_to_terminate(dlc_client, job_id)

    <span class="hljs-keyword">pass</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()

</code></pre>
<p>完成微调后，即可使用微调后的模型进行推理：</p>
<pre><code class="hljs language-python" lang="python">!torchrun --nproc_per_node=<span class="hljs-number">4</span> --master_port=<span class="hljs-number">12341</span> -m examples.video2world_gr00t \
--num_gpus <span class="hljs-number">4</span>   --model_size 14B   --gr00t_variant gr1   \
--batch_input_json dream_gen_benchmark/gr1_object/batch_input.json   --disable_guardrail
</code></pre>
<p>在上述代码中，使用batch_input.json来记录推理所需的prompts与起始帧：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/675f8ea1bbb543dc9294c80bda78eea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=qtV9CMXiLHUpTrMQgQdTdAo8TGU%3D" alt="image.png" loading="lazy"/></p>
<p>执行上述推理过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04048b76c47f4d1682b25fcf3053193f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=fDb5ygam614P3j4LIK3HVs3vPio%3D" alt="image.png" loading="lazy"/></p>
<p>按照batch_input.json，脚本会输出一系列推理结果，实现数据扩增。扩增的数量取决于batch_input.json的prompt数量。以下是输出结果示例,<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FJquGeKxcghzoa16tlkGc97cp9bbbwu9Rc_KRtPp6v2Q.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/JquGeKxcghzoa16tlkGc97cp9bbbwu9Rc_KRtPp6v2Q.mp4" ref="nofollow noopener noreferrer">查看演示 &gt;&gt;</a></p>
<p>从上述结果中可以看出，右上角的水壶出现了明显的变形，不符合真实物理规律。在实际生产中，我们需要剔除这类视频，因此需要使用Cosmos-Reason1模型进行拒绝采样。</p>
<h2 data-id="heading-2">拒绝采样</h2>
<p>拒绝采样的原理是：生成多个候选视频，然后使用Cosmos-Reason1对这些视频进行评分，选择评分最高的视频作为最终输出。评分将从以下几个方面进行考量：</p>
<ul>
<li>运动连贯性: 物体移动是否自然流畅</li>
<li>时间一致性: 帧与帧之间是否存在突兀变化</li>
<li>物理合理性: 重力、光影、材质是否符合物理规律</li>
<li>视觉质量: 是否存在伪影、模糊、扭曲等问题</li>
<li>内容逻辑: 场景元素之间的关系是否合理</li>
</ul>
<p>可以使用以下脚本进行拒绝采样：</p>
<pre><code class="hljs language-python" lang="python">!torchrun --nproc_per_node=<span class="hljs-number">4</span> --master_port=<span class="hljs-number">12341</span>   -m examples.video2world_bestofn   \
--model_size 14B   --gr00t_variant gr1   \
--prompt <span class="hljs-string">"Use the right hand to pick up rubik's cube from from the bottom of the three-tiered wooden shelf to to the top of the three-tiered wooden shelf."</span>   \
--input_path assets/sample_gr00t_dreams_gr1/8_Use_the_right_hand_to_pick_up_rubik\<span class="hljs-string">'s_cube_from_from_the_bottom_of_the_three-tiered_wooden_shelf_to_to_the_top_of_the_three-tiered_wooden_shelf..png   \
--num_gpus 2   --num_generations 4   --prompt_prefix ""   \
--disable_guardrail   --save_path output/best-of-n-gr00t-gr1
</span></code></pre>
<p>该脚本会使用相同的prompt生成4条视频，然后通过Cosmos-Reason1进行打分，以下分别是0分和100分的视频，以示对比：</p>

















<table><thead><tr><th>0分</th><th>100分</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FbLbanLWVx_S3xeTnZuDeKANYJBSNIhAUMVtPXKNU284.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/bLbanLWVx_S3xeTnZuDeKANYJBSNIhAUMVtPXKNU284.mp4" ref="nofollow noopener noreferrer">0分视频演示 &gt;&gt;</a></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FP8TaehO-WgL-ocS05rNjRnCzsHCV9YfcMV3A0FDmh-4.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/P8TaehO-WgL-ocS05rNjRnCzsHCV9YfcMV3A0FDmh-4.mp4" ref="nofollow noopener noreferrer">100分视频演示 &gt;&gt;</a></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77152b3349ca4a628df49c16d6ede171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=z7SHavZPcAB0vDn0XfKzcFubATk%3D" alt="image.png" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b53a025a4aa4d43b19591ebcf01dd4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=W3JUkR3cCVUSQrOpQJXV3SXKn2w%3D" alt="image.png" loading="lazy"/></td></tr></tbody></table>
<h2 data-id="heading-3">IDM逆解算</h2>
<p>上述数据扩增和拒绝采样的结果，为一系列的“prompt-视频”数据对。一般来说，如果用于VLA模型的模仿学习，仅有这样的数据对是不够的，还需给出视频内容中的action序列。但由于Cosmos-Predict2模型直接输出了视频，没有action序列，我们需要通过IDM（Inverse Dynamics Model，逆向动力学模型）对视频进行处理，逆向解析出其中的action序列。</p>
<p>可以使用以下脚本进行IDM逆解算：</p>
<pre><code class="hljs language-python" lang="python">!PYTHONPATH=. CUDA_VISIBLE_DEVICES=<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> python IDM_dump/dump_idm_actions.py \
    --checkpoint <span class="hljs-string">"seonghyeonye/IDM_gr1"</span> \
    --dataset <span class="hljs-string">"IDM_dump/data/gr1_unified.data"</span> \
    --output_dir <span class="hljs-string">"IDM_dump/data/gr1_unified.data_idm"</span> \
    --num_gpus <span class="hljs-number">4</span> \
    --video_indices <span class="hljs-string">"0 8"</span>
</code></pre>
<p>由于需要使用huggingface获取IDM模型，在国内的网络环境中，执行上述命令可能出现网络问题，可以使用以下环境变量进行代理加速：</p>
<pre><code class="hljs language-python" lang="python">HF_ENDPOINT=https://hf-mirror.com 
</code></pre>
<p>逆解算结果以parquet格式保存，可以通过以下命令查看：</p>
<pre><code class="hljs language-python" lang="python">!uv pip install parquet-tools
!parquet-tools csv IDM_dump/data/gr1_unified.data_idm/data/chunk-<span class="hljs-number">000</span>/episode_000000.parquet
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff9f33f769b742e78ce70cd6e0ab3d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=dxT5%2Fu6kECSl3IHg25kJUor9B5E%3D" alt="image.png" loading="lazy"/></p>
<p>如果需要使用自定义机器人本体构型，也可以自定义微调IDM模型：</p>
<pre><code class="hljs language-python" lang="python">cd /workspace/GR00T-Dreams/
export HF_HOME=/mnt/data/notebook2
PYTHONPATH=. WANDB_MODE=disabled CUDA_VISIBLE_DEVICES=<span class="hljs-number">0</span> torchrun scripts/idm_training.py \
    --dataset-path demo_data/robot_sim.PickNPlace/ \
    --embodiment_tag gr1
</code></pre>
<h2 data-id="heading-4">模仿学习</h2>
<p>使用上述过程得到的扩增数据，可以用与GR00T-N1模型的模仿学习：</p>
<pre><code class="hljs language-python" lang="python">!cd /workspace/GR00T-Dreams/
!export HF_HOME=/mnt/data/notebook2 &amp;&amp; export WANDB_MODE=offline &amp;&amp; \
bash IDM_dump/scripts/finetune/gr1.sh
</code></pre>
<p>详细训练脚本gr1.sh如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> tyro
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments

<span class="hljs-keyword">from</span> gr00t.data.dataset <span class="hljs-keyword">import</span> LeRobotSingleDataset
<span class="hljs-keyword">from</span> gr00t.data.schema <span class="hljs-keyword">import</span> EmbodimentTag
<span class="hljs-keyword">from</span> gr00t.experiment.data_config <span class="hljs-keyword">import</span> DATA_CONFIG_MAP
<span class="hljs-keyword">from</span> gr00t.experiment.runner <span class="hljs-keyword">import</span> TrainRunner
<span class="hljs-keyword">from</span> gr00t.model.gr00t_n1 <span class="hljs-keyword">import</span> GR00T_N1
<span class="hljs-keyword">from</span> gr00t.utils.peft <span class="hljs-keyword">import</span> get_lora_model


<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
    <span class="hljs-string">"""Configuration for GR00T model fine-tuning."""</span>

    <span class="hljs-comment"># Dataset parameters</span>
    dataset_path: <span class="hljs-built_in">str</span>
    <span class="hljs-string">"""Path to the dataset directory."""</span>

    output_dir: <span class="hljs-built_in">str</span> = <span class="hljs-string">"/tmp/gr00t"</span>
    <span class="hljs-string">"""Directory to save model checkpoints."""</span>

    data_config: <span class="hljs-built_in">str</span> = <span class="hljs-string">"gr1_arms_only"</span>
    <span class="hljs-string">"""Data configuration name from DATA_CONFIG_MAP."""</span>

    <span class="hljs-comment"># Training parameters</span>
    batch_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">16</span>
    <span class="hljs-string">"""Batch size per GPU for training."""</span>

    max_steps: <span class="hljs-built_in">int</span> = <span class="hljs-number">10000</span>
    <span class="hljs-string">"""Maximum number of training steps."""</span>

    num_gpus: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>
    <span class="hljs-string">"""Number of GPUs to use for training."""</span>

    save_steps: <span class="hljs-built_in">int</span> = <span class="hljs-number">500</span>
    <span class="hljs-string">"""Number of steps between saving checkpoints."""</span>

    <span class="hljs-comment"># Model parameters</span>
    base_model_path: <span class="hljs-built_in">str</span> = <span class="hljs-string">"nvidia/GR00T-N1-2B"</span>
    <span class="hljs-string">"""Path or HuggingFace model ID for the base model."""</span>

    tune_llm: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    <span class="hljs-string">"""Whether to fine-tune the language model backbone."""</span>

    tune_visual: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-string">"""Whether to fine-tune the vision tower."""</span>

    tune_projector: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-string">"""Whether to fine-tune the projector."""</span>

    tune_diffusion_model: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-string">"""Whether to fine-tune the diffusion model."""</span>

    resume: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    <span class="hljs-string">"""Whether to resume from a checkpoint."""</span>

    <span class="hljs-comment"># Advanced training parameters</span>
    learning_rate: <span class="hljs-built_in">float</span> = <span class="hljs-number">1e-4</span>
    <span class="hljs-string">"""Learning rate for training."""</span>

    weight_decay: <span class="hljs-built_in">float</span> = <span class="hljs-number">1e-5</span>
    <span class="hljs-string">"""Weight decay for AdamW optimizer."""</span>

    warmup_ratio: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.05</span>
    <span class="hljs-string">"""Ratio of total training steps used for warmup."""</span>

    lora_rank: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    <span class="hljs-string">"""Rank for the LORA model."""</span>

    lora_alpha: <span class="hljs-built_in">int</span> = <span class="hljs-number">16</span>
    <span class="hljs-string">"""Alpha value for the LORA model."""</span>

    lora_dropout: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.1</span>
    <span class="hljs-string">"""Dropout rate for the LORA model."""</span>

    dataloader_num_workers: <span class="hljs-built_in">int</span> = <span class="hljs-number">8</span>
    <span class="hljs-string">"""Number of workers for data loading."""</span>

    report_to: <span class="hljs-built_in">str</span> = <span class="hljs-string">"wandb"</span>
    <span class="hljs-string">"""Where to report training metrics (e.g., 'wandb', 'tensorboard')."""</span>

    <span class="hljs-comment"># Data loading parameters</span>
    embodiment_tag: <span class="hljs-built_in">str</span> = <span class="hljs-string">"new_embodiment"</span>
    <span class="hljs-string">"""Embodiment tag to use for training. e.g. 'new_embodiment', 'gr1'"""</span>

    video_backend: <span class="hljs-built_in">str</span> = <span class="hljs-string">"decord"</span>
    <span class="hljs-string">"""Video backend to use for training. [decord, torchvision_av]"""</span>


<span class="hljs-comment">#####################################################################################</span>
<span class="hljs-comment"># main training function</span>
<span class="hljs-comment">#####################################################################################</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">config: Config</span>):
    <span class="hljs-string">"""Main training function."""</span>
    <span class="hljs-comment"># ------------ step 1: load dataset ------------</span>
    embodiment_tag = EmbodimentTag(config.embodiment_tag)

    <span class="hljs-comment"># 1.1 modality configs and transforms</span>
    data_config_cls = DATA_CONFIG_MAP[config.data_config]
    modality_configs = data_config_cls.modality_config()
    transforms = data_config_cls.transform()

    <span class="hljs-comment"># 1.2 data loader</span>
    train_dataset = LeRobotSingleDataset(
        dataset_path=config.dataset_path,
        modality_configs=modality_configs,
        transforms=transforms,
        embodiment_tag=embodiment_tag,  <span class="hljs-comment"># This will override the dataset's embodiment tag to "new_embodiment"</span>
        video_backend=config.video_backend,
    )

    <span class="hljs-comment"># ------------ step 2: load model ------------</span>
    model = GR00T_N1.from_pretrained(
        pretrained_model_name_or_path=config.base_model_path,
        tune_llm=config.tune_llm,  <span class="hljs-comment"># backbone's LLM</span>
        tune_visual=config.tune_visual,  <span class="hljs-comment"># backbone's vision tower</span>
        tune_projector=config.tune_projector,  <span class="hljs-comment"># action head's projector</span>
        tune_diffusion_model=config.tune_diffusion_model,  <span class="hljs-comment"># action head's DiT</span>
    )

    <span class="hljs-comment"># Set the model's compute_dtype to bfloat16</span>
    model.compute_dtype = <span class="hljs-string">"bfloat16"</span>
    model.config.compute_dtype = <span class="hljs-string">"bfloat16"</span>

    <span class="hljs-keyword">if</span> config.lora_rank &gt; <span class="hljs-number">0</span>:
        model = get_lora_model(
            model,
            rank=config.lora_rank,
            lora_alpha=config.lora_alpha,
            lora_dropout=config.lora_dropout,
        )

    <span class="hljs-comment"># 2.1 modify training args</span>
    training_args = TrainingArguments(
        output_dir=config.output_dir,
        run_name=<span class="hljs-literal">None</span>,
        remove_unused_columns=<span class="hljs-literal">False</span>,
        deepspeed=<span class="hljs-string">""</span>,
        gradient_checkpointing=<span class="hljs-literal">False</span>,
        bf16=<span class="hljs-literal">True</span>,
        tf32=<span class="hljs-literal">True</span>,
        per_device_train_batch_size=config.batch_size,
        gradient_accumulation_steps=<span class="hljs-number">1</span>,
        dataloader_num_workers=config.dataloader_num_workers,
        dataloader_pin_memory=<span class="hljs-literal">False</span>,
        dataloader_persistent_workers=<span class="hljs-literal">True</span>,
        optim=<span class="hljs-string">"adamw_torch"</span>,
        adam_beta1=<span class="hljs-number">0.95</span>,
        adam_beta2=<span class="hljs-number">0.999</span>,
        adam_epsilon=<span class="hljs-number">1e-8</span>,
        learning_rate=config.learning_rate,
        weight_decay=config.weight_decay,
        warmup_ratio=config.warmup_ratio,
        lr_scheduler_type=<span class="hljs-string">"cosine"</span>,
        logging_steps=<span class="hljs-number">10.0</span>,
        num_train_epochs=<span class="hljs-number">300</span>,
        max_steps=config.max_steps,
        save_strategy=<span class="hljs-string">"steps"</span>,
        save_steps=config.save_steps,
        save_total_limit=<span class="hljs-number">8</span>,
        report_to=config.report_to,
        seed=<span class="hljs-number">42</span>,
        do_eval=<span class="hljs-literal">False</span>,
        ddp_find_unused_parameters=<span class="hljs-literal">False</span>,
        ddp_bucket_cap_mb=<span class="hljs-number">100</span>,
        torch_compile_mode=<span class="hljs-literal">None</span>,
    )

    <span class="hljs-comment"># 2.2 run experiment</span>
    experiment = TrainRunner(
        train_dataset=train_dataset,
        model=model,
        training_args=training_args,
        resume_from_checkpoint=config.resume,
    )

    <span class="hljs-comment"># 2.3 run experiment</span>
    experiment.train()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># Parse arguments using tyro</span>
    config = tyro.cli(Config)

    <span class="hljs-comment"># Print the tyro config</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"GR00T FINE-TUNING CONFIGURATION:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">vars</span>(config).items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span> + <span class="hljs-string">"\n"</span>)

    available_gpus = torch.cuda.device_count() <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>

    <span class="hljs-comment"># Validate GPU configuration</span>
    <span class="hljs-keyword">assert</span> (
        config.num_gpus &lt;= available_gpus
    ), <span class="hljs-string">f"Number of GPUs requested (<span class="hljs-subst">{config.num_gpus}</span>) is greater than the available GPUs (<span class="hljs-subst">{available_gpus}</span>)"</span>
    <span class="hljs-keyword">assert</span> config.num_gpus &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"Number of GPUs must be greater than 0"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Using <span class="hljs-subst">{config.num_gpus}</span> GPUs"</span>)

    <span class="hljs-keyword">if</span> config.num_gpus == <span class="hljs-number">1</span>:
        <span class="hljs-comment"># Single GPU mode - set CUDA_VISIBLE_DEVICES=0</span>
        os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="hljs-string">"0"</span>
        <span class="hljs-comment"># Run the script normally</span>
        main(config)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"IS_TORCHRUN"</span>, <span class="hljs-string">"0"</span>) == <span class="hljs-string">"1"</span>:
            main(config)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Multi-GPU mode - use torchrun</span>
            script_path = Path(__file__).absolute()
            <span class="hljs-comment"># Remove any existing CUDA_VISIBLE_DEVICES from environment</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span> <span class="hljs-keyword">in</span> os.environ:
                <span class="hljs-keyword">del</span> os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>]

            <span class="hljs-comment"># Use subprocess.run instead of os.system</span>
            cmd = [
                <span class="hljs-string">"torchrun"</span>,
                <span class="hljs-string">"--standalone"</span>,
                <span class="hljs-string">f"--nproc_per_node=<span class="hljs-subst">{config.num_gpus}</span>"</span>,
                <span class="hljs-string">"--nnodes=1"</span>,  <span class="hljs-comment"># default to 1 node for now</span>
                <span class="hljs-built_in">str</span>(script_path),
            ]

            <span class="hljs-comment"># Convert config to command line arguments</span>
            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">vars</span>(config).items():
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, <span class="hljs-built_in">bool</span>):
                    <span class="hljs-comment"># For boolean values, use --flag or --no-flag format</span>
                    <span class="hljs-keyword">if</span> value:
                        cmd.append(<span class="hljs-string">f"--<span class="hljs-subst">{key.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'-'</span>)}</span>"</span>)
                    <span class="hljs-keyword">else</span>:
                        cmd.append(<span class="hljs-string">f"--no-<span class="hljs-subst">{key.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'-'</span>)}</span>"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># For non-boolean values, use --key value format</span>
                    cmd.append(<span class="hljs-string">f"--<span class="hljs-subst">{key.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'-'</span>)}</span>"</span>)
                    cmd.append(<span class="hljs-built_in">str</span>(value))
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Running torchrun command: "</span>, cmd)
            env = os.environ.copy()
            env[<span class="hljs-string">"IS_TORCHRUN"</span>] = <span class="hljs-string">"1"</span>
            sys.exit(subprocess.run(cmd, env=env).returncode)

</code></pre>
<p>建议在实际训练中，将 batch size 尽可能调大，并训练 20k steps。请在 DreamGen 环境中运行相应命令。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c7d6668bcb147a8b0ab3cb5f3248bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=chFnH8e4qMu1YQhmL1pn7BWYP9s%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">模型测评</h2>
<p>在本例中，使用真实的GR1机器人进行模型效果验证，得到结果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7531acca2fb4feea76627c5dafad9f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=3PovAunOoaexObe57bjk5qyKklo%3D" alt="image.png" loading="lazy"/></p>
<p>从结果中可以看到：</p>
<ul>
<li>
<p>在已知场景中执行全新的动作，未使用扩增数据微调的GR00T N1模型仅有11.2%的成功率，使用扩增数据微调后可以达到43.2%的成功率</p>
</li>
<li>
<p>在未知场景中执行已知或未知动作，未使用扩增数据微调的GR00T N1模型全部失败，但是使用扩增数据微调后可以达到28.5%的成功率</p>
</li>
</ul>
<h2 data-id="heading-6">总结</h2>
<p>在本最佳实践中，基于阿里云 PAI 平台的特性，我们实现了基于Cosmos世界模型的操作动作数据扩增与模仿学习，包含从人工少量演示、数据扩增、拒绝采样、IDM逆解算、模仿学习再到模型测评的端到端实现</p>
<p>与基于Isaac仿真的数据扩增技术一样，Cosmos 数据扩增后训练的模型在各个场景下的成功率均有较高提升。相比于Isaac仿真，Cosmos数据扩增有以下特点：</p>
<ul>
<li>
<p>人工演示、数据扩增环节无需仿真算力（RT Core），全流程使用同构算力（CUDA Core/Tensor Core）</p>
</li>
<li>
<p>无需对人工演示数据进行动作打标处理，直接使用视频数据即可实现扩增</p>
</li>
<li>
<p>无需单独的数据增强环节，可在数据扩增环节通过调整提示词实现数据增强</p>
</li>
<li>
<p>需要额外的拒绝采样步骤以过滤不合理的生成内容，以及额外的IDM逆解算步骤以补齐视频中缺少的action序列</p>
</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown">!torchrun --nproc<span class="hljs-emphasis">_per_</span>node=4 --master<span class="hljs-emphasis">_port=12341 -m examples.video2world_</span>gr00t \
--num<span class="hljs-emphasis">_gpus 4   --model_</span>size 14B   --gr00t<span class="hljs-emphasis">_variant gr1   \
--batch_</span>input<span class="hljs-emphasis">_json dream_</span>gen<span class="hljs-emphasis">_benchmark/gr1_</span>object/batch<span class="hljs-emphasis">_input.json   
--disable_</span>guardrail
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？]]></title>    <link>https://juejin.cn/post/7571306072422826026</link>    <guid>https://juejin.cn/post/7571306072422826026</guid>    <pubDate>2025-11-11T13:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422826026" data-draft-id="7571299394345697322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:45:03.000Z" title="Tue Nov 11 2025 13:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构下，实现动态数据源路由是应对多租户、分库分表、读写分离等复杂场景的关键技术。它能显著提升系统的灵活性、可扩展性和数据处理能力。下面我将为您详细讲解几种主流的实现方案。</p>
<p>下表对比了三种主要的动态数据源路由方案，帮助您快速了解其核心特点：</p>

































<table><thead><tr><th>方案类型</th><th>核心机制</th><th>适用场景</th><th>优点</th><th>考虑因素</th></tr></thead><tbody><tr><td><strong>基于<code>AbstractRoutingDataSource</code>的自定义路由</strong></td><td>继承Spring抽象类，通过ThreadLocal上下文和AOP/注解动态路由</td><td>多租户（按租户ID分库）、业务分库、需要高度定制化路由逻辑的场景</td><td>灵活性极高，与Spring框架原生集成好，可完全掌控路由逻辑</td><td>需自行实现大部分代码（如AOP、上下文管理），复杂度较高</td></tr><tr><td><strong>基于<code>dynamic-datasource-spring-boot-starter</code>组件</strong></td><td>使用<code>@DS</code>注解在方法或类上声明式切换数据源</td><td>读写分离、一主多从、多种类型数据库混合连接</td><td>开箱即用，配置简单，内置负载均衡，极大减少编码量</td><td>路由逻辑的定制能力不如自定义方案灵活</td></tr><tr><td><strong>集成ShardingSphere进行分库分表</strong></td><td>作为客户端中间件，在JDBC层对SQL进行解析、路由、重写和结果归并</td><td>大规模数据分片、分库分表、读写分离+数据分片等复杂场景</td><td>功能强大，屏蔽底层数据库复杂性，支持分布式事务</td><td>架构较重，学习曲线较陡，对SQL有一定限制（如不支持跨库关联）</td></tr></tbody></table>
<h3 data-id="heading-0">💡 方案一：基于 <code>AbstractRoutingDataSource</code>的自定义路由</h3>
<p>这是Spring框架提供的基础能力，非常适合需要精细控制路由逻辑的场景，例如根据登录用户信息或特定的业务规则来选择数据库。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>
<p><strong>定义数据源上下文持有者</strong>：使用<code>ThreadLocal</code>来确保每个线程的数据源选择是隔离的，这是实现动态路由的核心。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ThreadLocal</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-variable constant_">CONTEXT_HOLDER</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setDataSourceType</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceType</span>) {
        <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">set</span>(dataSourceType);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDataSourceType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">get</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearDataSourceType</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">remove</span>();
    }
}
</code></pre>
</li>
<li>
<p><strong>创建动态路由数据源</strong>：继承<code>AbstractRoutingDataSource</code>并重写<code>determineCurrentLookupKey</code>方法。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 该方法会在每次数据库操作前被调用，决定使用哪个数据源</span>
        <span class="hljs-keyword">return</span> <span class="hljs-type">DataSourceContextHolder</span>.getDataSourceType();
    }
}
</code></pre>
</li>
<li>
<p><strong>配置多个数据源并启用路由</strong>：在配置类中，将多个目标数据源（如<code>masterDataSource</code>, <code>slaveDataSource</code>) 注入到一个Map中，并设置为动态数据源的目标数据源。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
public class DataSourceConfig {
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@Primary</span>
    public DataSource <span class="hljs-built_in">dynamicDataSource</span>(DataSource masterDataSource, DataSource slaveDataSource) {
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">targetDataSources</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"master"</span>, masterDataSource);
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"slave"</span>, slaveDataSource);

        <span class="hljs-selector-tag">DynamicRoutingDataSource</span> <span class="hljs-selector-tag">routingDataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicRoutingDataSource</span>();
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setDefaultTargetDataSource</span>(masterDataSource); <span class="hljs-comment">// 设置默认数据源</span>
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setTargetDataSources</span>(targetDataSources);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">routingDataSource</span>;
    }
}
</code></pre>
</li>
<li>
<p><strong>使用AOP和自定义注解切换数据源</strong>：可以定义一个注解（如<code>@DataSource</code>），然后通过AOP切面，在方法执行前根据注解值切换数据源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    <span class="hljs-meta">@Before("@annotation(dataSource)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSwitchDataSource</span><span class="hljs-params">(JoinPoint joinPoint, DataSource dataSource)</span> {
        DataSourceContextHolder.setDataSourceType(dataSource.value());
    }
    <span class="hljs-meta">@After("@annotation(dataSource)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterSwitchDataSource</span><span class="hljs-params">(JoinPoint joinPoint, DataSource dataSource)</span> {
        DataSourceContextHolder.clearDataSourceType(); <span class="hljs-comment">// 清理，防止内存泄漏</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-1">🚀 方案二：使用 <code>dynamic-datasource-spring-boot-starter</code>组件</h3>
<p>对于常见的读写分离、一主多从场景，这是一个非常高效的选择，它能让你通过简单的配置和注解完成工作。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>
<p><strong>引入依赖</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请使用最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>配置数据源</strong>：在<code>application.yml</code>中配置主从数据源。配置项以下划线<code>_</code>分割，相同前缀的数据源会被自动分组。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span> <span class="hljs-comment"># 设置默认数据源</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment"># 是否严格匹配数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip1:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">slave_1:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip2:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">slave_2:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip3:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
</code></pre>
</li>
<li>
<p><strong>使用<code>@DS</code>注解切换</strong>：在Service层的方法或类上使用<code>@DS</code>注解，即可轻松切换。组件内置了同组数据源的负载均衡。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
<span class="hljs-variable">@DS</span>(<span class="hljs-string">"slave"</span>) <span class="hljs-comment">// 类级别注解，此类下所有方法默认使用slave组（随机选择slave_1或slave_2）</span>
public class UserServiceImpl implements UserService {
    <span class="hljs-variable">@Override</span>
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>) <span class="hljs-comment">// 方法级别注解优先，此方法使用master数据源</span>
    public void <span class="hljs-built_in">updateUser</span>(User user) {
        <span class="hljs-comment">// ... 更新操作</span>
    }
    <span class="hljs-variable">@Override</span>
    <span class="hljs-comment">// 未标注，使用类注解，即slave组</span>
    public User <span class="hljs-built_in">getUserById</span>(Long id) {
        <span class="hljs-comment">// ... 查询操作</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">🔧 方案三：集成 ShardingSphere 进行分库分表</h3>
<p>当单库单表成为性能瓶颈时，ShardingSphere提供了强大的分库分表、读写分离及分布式事务能力。</p>
<p><strong>核心配置示例</strong></p>
<p>其配置核心是定义分片规则，例如根据用户ID（<code>user_id</code>）进行分库分表：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-comment"># 指定实际的数据节点，表示数据分布在ds0和ds1两个库，每个库有t_user0到t_user3四张表</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user$-&gt;{0..3}</span>
            <span class="hljs-comment"># 分库策略</span>
            <span class="hljs-attr">database-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">database-inline</span>
            <span class="hljs-comment"># 分表策略</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">table-inline</span>
        <span class="hljs-comment"># 定义分片算法</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">database-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">ds$-&gt;{user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">2</span><span class="hljs-string">}</span> <span class="hljs-comment"># 分库算法：user_id % 2</span>
          <span class="hljs-attr">table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">t_user$-&gt;{user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">4</span><span class="hljs-string">}</span> <span class="hljs-comment"># 分表算法：user_id % 4</span>
</code></pre>
<h3 data-id="heading-3">⚠️ 关键注意事项与实践建议</h3>
<p>无论选择哪种方案，以下几点都需要特别关注：</p>
<ul>
<li><strong>事务管理</strong>：在使用了动态数据源切换的方法中，尤其是跨不同物理数据库的操作，<strong>需要谨慎处理事务</strong>。Spring的<code>@Transactional</code>注解通常在一个事务内会使用同一个数据源连接。如果需要在事务中切换数据源，可能需要更复杂的处理，例如使用分布式事务（JTA）。</li>
<li><strong>连接池配置</strong>：为每个数据源配置合适的连接池参数（如<code>HikariCP</code>或<code>Druid</code>的<code>maximum-pool-size</code>, <code>connection-timeout</code>），这对系统性能和稳定性至关重要。</li>
<li><strong>配置信息加密与安全</strong>：生产环境中，数据库密码等敏感信息不应明文写在配置文件中。可以使用<code>Jasypt</code>等工具进行加密，或结合Spring Cloud Config、Nacos等<strong>配置中心</strong>统一管理加密后的配置。</li>
<li><strong>链路追踪与监控</strong>：在微服务架构下，一个请求可能涉及多个数据源的操作。可以集成<strong>Spring Cloud Sleuth</strong>等组件，将数据源切换的关键信息（如数据源名称）添加到链路追踪的Span标签中，便于问题排查和性能分析。</li>
</ul>
<h3 data-id="heading-4">💎 总结与选择</h3>
<p>选择哪种方案，最终取决于您的具体业务需求和技术考量：</p>
<ul>
<li>如果只是简单的<strong>读写分离</strong>或<strong>一主多从</strong>，追求快速实现，<strong><code>dynamic-datasource-spring-boot-starter</code>组件是首选</strong>。</li>
<li>如果路由逻辑非常<strong>个性化</strong>（如根据复杂业务规则选择数据库），那么基于 <strong><code>AbstractRoutingDataSource</code>的自定义路由</strong>提供了最大的灵活性。</li>
<li>如果面临<strong>海量数据</strong>，需要进行<strong>分库分表</strong>，那么<strong>ShardingSphere</strong>是更专业和强大的选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[动态数据源切换与Seata分布式事务如何协同工作？]]></title>    <link>https://juejin.cn/post/7571304204754698294</link>    <guid>https://juejin.cn/post/7571304204754698294</guid>    <pubDate>2025-11-11T13:47:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754698294" data-draft-id="7571299394345713706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="动态数据源切换与Seata分布式事务如何协同工作？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:47:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            动态数据源切换与Seata分布式事务如何协同工作？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:47:13.000Z" title="Tue Nov 11 2025 13:47:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构中，动态数据源切换与Seata分布式事务的协同工作，确实是一个既重要又精妙的话题。简单来说，<strong>动态数据源切换解决了“去哪儿操作”的问题，而Seata则确保了在不同“地方”的操作能保持原子性</strong>。下面我们深入探讨它们是如何协同工作的。</p>
<p>为了帮助你快速构建起整体认知，下表概括了协同工作的核心机制与关键点。</p>

























<table><thead><tr><th>协同层面</th><th>核心机制</th><th>关键实现点</th></tr></thead><tbody><tr><td><strong>数据源管理</strong></td><td><strong>代理与路由结合</strong></td><td>Seata通过<code>DataSourceProxy</code>代理底层物理数据源，而动态数据源路由器（如<code>AbstractRoutingDataSource</code>）负责管理多个被代理的数据源，并根据规则选择。</td></tr><tr><td><strong>事务上下文传播</strong></td><td><strong>XID链路传递</strong></td><td>通过拦截器将Seata的全局事务ID（XID）在服务调用链路（如通过Feign）中传递，确保多个数据源操作属于同一全局事务。</td></tr><tr><td><strong>分支事务管理</strong></td><td><strong>RM自动注册</strong></td><td>当业务方法通过动态数据源切换到某个具体数据源并执行SQL时，该数据源对应的Seata <code>Resource Manager</code>(RM) 会自动向事务协调器(TC)注册为一个分支事务。</td></tr></tbody></table>
<h3 data-id="heading-0">⚙️ 协同工作原理详解</h3>
<p>理解了整体框架后，我们来看看它们内部是如何具体配合的。</p>
<ol>
<li>
<p><strong>数据源代理：Seata介入的基石</strong></p>
<p>Seata（通常是AT模式）能够管理一个数据库操作的前提，是它能够“看到”并“记录”这个操作。这是通过<code>DataSourceProxy</code>实现的。它包装了真实的数据源，从而可以拦截所有SQL语句，自动生成回滚日志（<code>undo_log</code>）并与TC交互。在多数据源场景下，<strong>每一个物理数据源（无论是master还是slave）都需要被Seata的<code>DataSourceProxy</code>代理</strong>。</p>
</li>
<li>
<p><strong>动态路由：正确选择的保障</strong></p>
<p>你的业务代码上可能通过<code>@DS("slave")</code>这样的注解，或通过AOP逻辑，在运行时决定使用哪个数据源标识（例如"master", "slave1"）。动态数据源路由器（如继承<code>AbstractRoutingDataSource</code>的自定义类）的<code>determineCurrentLookupKey()</code>方法会返回这个标识，并从目标数据源Map中取出对应的数据源。关键在于，这个Map里存放的<strong>不是原始的<code>DataSource</code>，而是已经被Seata代理后的<code>DataSourceProxy</code></strong>。这样就确保了无论路由到哪个数据源，其操作都能被Seata管理。</p>
</li>
<li>
<p><strong>全局事务：统一协调的框架</strong></p>
<p>在业务入口方法上标注的<code>@GlobalTransactional</code>注解，是全局事务的“开关”。它会告诉Seata的<code>Transaction Manager</code>(TM)开始一个全局事务，并生成全局唯一的XID。这个XID会通过线程上下文传播。</p>
</li>
</ol>
<h3 data-id="heading-1">🔧 实现步骤与配置要点</h3>
<p>要将两者成功集成，以下步骤和配置是关键：</p>
<ol>
<li>
<p><strong>配置Seata TC Server</strong>：需要先启动Seata的服务端（Transaction Coordinator），它负责协调所有全局事务。通常需要配置其注册中心和配置中心（如Nacos、File等）。</p>
</li>
<li>
<p><strong>引入客户端依赖</strong>：在微服务项目中引入Seata的Spring Cloud Starter依赖。</p>
</li>
<li>
<p><strong>配置多数据源与代理</strong>：这是最核心的一步。在你的配置类中，需要创建多个真实数据源，然后分别用<code>DataSourceProxy</code>对它们进行包装，最后将这些代理后的数据源设置到动态数据源的路由目标Map中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">dynamicDataSource</span>(<span class="hljs-params">DataSource masterDataSource, DataSource slaveDataSource</span>) {
    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt; targetDataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">// 关键：将真实数据源包装为Seata的代理数据源</span>
    targetDataSources.<span class="hljs-title function_">put</span>(<span class="hljs-string">"master"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(masterDataSource));
    targetDataSources.<span class="hljs-title function_">put</span>(<span class="hljs-string">"slave"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(slaveDataSource));

    <span class="hljs-title class_">YourDynamicRoutingDataSource</span> dynamicDataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">YourDynamicRoutingDataSource</span>();
    dynamicDataSource.<span class="hljs-title function_">setTargetDataSources</span>(targetDataSources);
    dynamicDataSource.<span class="hljs-title function_">setDefaultTargetDataSource</span>(targetDataSources.<span class="hljs-title function_">get</span>(<span class="hljs-string">"master"</span>));
    <span class="hljs-keyword">return</span> dynamicDataSource;
}
</code></pre>
</li>
<li>
<p><strong>创建Undo_log表</strong>：在Seata的AT模式下，每一个业务数据库中都需要创建<code>undo_log</code>表，用于记录数据修改前的镜像，以便回滚。</p>
</li>
<li>
<p><strong>使用注解</strong>：在需要开启分布式事务的业务入口方法上使用<code>@GlobalTransactional</code>。在需要切换数据源的方法或类上使用相应的注解（如<code>@DS</code>）。</p>
</li>
</ol>
<h3 data-id="heading-2">⚠️ 常见问题与解决方案</h3>
<p>协同工作过程中，可能会遇到一些“坑”，以下是最常见的几种及应对方法：</p>

























<table><thead><tr><th>常见问题</th><th>现象</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>数据源切换后事务不生效</strong></td><td>事务上下文与数据源绑定关系丢失，部分操作未回滚。</td><td>确保数据源切换操作在<code>@GlobalTransactional</code>注解的方法内部进行，并检查数据源代理配置是否正确。</td></tr><tr><td><strong>全局异常被“吞掉”</strong></td><td>服务内部异常被全局异常处理器（<code>@RestControllerAdvice</code>）捕获并返回友好信息，导致上游服务无法感知异常，全局事务不回滚。</td><td>在全局异常处理器中，对于需要分布式事务回滚的异常，需要再次抛出原始异常或调用<code>TransactionContextHolder.clear()</code>并抛出业务异常。</td></tr><tr><td><strong>多数据源配置冲突</strong></td><td>与MyBatis-Plus的<code>dynamic-datasource-spring-boot-starter</code>等组件集成时，事务管理器配置不当导致失效。</td><td>确保使用了支持多数据源事务的注解（如Seata的<code>@GlobalTransactional</code>），并正确配置了Seata的数据源代理。</td></tr></tbody></table>
<h3 data-id="heading-3">💎 核心总结</h3>
<p>总而言之，动态数据源切换与Seata的协同，本质上是<strong>将动态路由能力置于Seata的全局事务管辖之下</strong>。Seata通过代理数据源来“监控”和“管理”所有数据库操作，而动态数据源则确保操作被路由到正确的、已被代理的数据源上。实现此集成的关键在于<strong>正确代理所有数据源</strong>，并<strong>妥善处理事务上下文的传播</strong>，同时留意常见的配置陷阱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm命令详解]]></title>    <link>https://juejin.cn/post/7571191453126115354</link>    <guid>https://juejin.cn/post/7571191453126115354</guid>    <pubDate>2025-11-11T09:47:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126115354" data-draft-id="7571278865516724274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm命令详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T09:47:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm命令详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:47:18.000Z" title="Tue Nov 11 2025 09:47:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>牛逼视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1Nx4118788%3Fspm_id_from%3D333.788.videopod.episodes%26vd_source%3Da27417abea09816580246ed454cd87e0" target="_blank" title="https://www.bilibili.com/video/BV1Nx4118788?spm_id_from=333.788.videopod.episodes&amp;vd_source=a27417abea09816580246ed454cd87e0" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Nx…</a></p>
<h3 data-id="heading-0">1. 什么是 npm？</h3>
<p><strong>npm</strong> 有两层含义：</p>
<ol>
<li><strong>一个在线仓库</strong>：全球最大的开源 JavaScript 代码库，开发者可以分享和借用各种代码包（package）。</li>
<li><strong>一个命令行工具</strong>：Node.js 的默认包管理器，用于与这个在线仓库交互，帮助你安装、管理项目依赖。</li>
</ol>
<p>当你安装 Node.js 时，npm 会自动被一起安装。</p>
<hr/>
<h3 data-id="heading-1">2. 核心概念</h3>
<ul>
<li><strong><code>package.json</code></strong>：项目的“身份证”和“菜单”，记录了项目名称、版本、依赖包等信息。它是 npm 操作的核心。</li>
<li><strong><code>node_modules</code></strong>：一个文件夹，所有通过 npm 安装的包及其依赖都会存放在这里。通常不需要手动修改，也不应该提交到版本控制系统（如 Git）。</li>
<li><strong><code>package-lock.json</code></strong> 或 <strong><code>npm-shrinkwrap.json</code></strong>：精确描述当前安装的依赖树版本，确保团队协作和部署时安装完全一致的包。<strong>建议提交到版本库</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. npm 命令详解（按功能分类）</h3>
<h4 data-id="heading-3">A. 项目初始化与配置</h4>

























<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm init</code></td><td>交互式地创建一个新的 <code>package.json</code> 文件。</td><td><code>npm init</code></td></tr><tr><td><code>npm init -y</code> / <code>--yes</code></td><td>使用默认值快速创建 <code>package.json</code>，跳过所有提问。</td><td><code>npm init -y</code></td></tr><tr><td><code>npm config</code></td><td>管理 npm 的配置。</td><td>- <code>npm config list</code>：查看当前配置 - <code>npm config set &lt;key&gt; &lt;value&gt;</code>：设置配置，如 <code>npm config set registry https://registry.npmmirror.com</code>（设置淘宝镜像） - <code>npm config get &lt;key&gt;</code>：获取配置</td></tr></tbody></table>
<h4 data-id="heading-4">B. 包（依赖）的安装</h4>
<p>这是 npm 最核心的功能。依赖分为两种：</p>
<ul>
<li><strong>生产依赖</strong>：项目运行时必须的包（如 <code>react</code>, <code>express</code>），会出现在 <code>dependencies</code> 字段。</li>
<li><strong>开发依赖</strong>：仅在开发阶段需要的包（如 <code>webpack</code>, <code>eslint</code>, <code>jest</code>），会出现在 <code>devDependencies</code> 字段。</li>
</ul>













































<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm install</code> (或 <code>npm i</code>)</td><td>根据 <code>package.json</code> 安装所有依赖。</td><td>在项目根目录执行，会创建 <code>node_modules</code> 并安装所有 <code>dependencies</code> 和 <code>devDependencies</code>。</td></tr><tr><td><code>npm install &lt;package_name&gt;</code></td><td>安装一个包，并自动添加到 <code>package.json</code> 的 <code>dependencies</code>。</td><td><code>npm install lodash</code></td></tr><tr><td><code>npm install &lt;package_name&gt; --save-dev</code> (或 <code>-D</code>)</td><td>安装一个包，并添加到 <code>package.json</code> 的 <code>devDependencies</code>。</td><td><code>npm install eslint --save-dev</code></td></tr><tr><td><code>npm install &lt;package_name&gt; --global</code> (或 <code>-g</code>)</td><td><strong>全局安装</strong>一个包（通常是命令行工具）。</td><td><code>npm install @vue/cli -g</code>（之后可以在任何地方使用 <code>vue</code> 命令）</td></tr><tr><td><code>npm install &lt;package_name&gt;@&lt;version&gt;</code></td><td>安装指定版本的包。</td><td><code>npm install react@18.2.0</code></td></tr><tr><td><code>npm install &lt;package_name&gt;@latest</code></td><td>安装包的最新版本。</td><td><code>npm install webpack@latest</code></td></tr><tr><td><code>npm ci</code></td><td><strong>清洁安装</strong>，用于自动化环境（如 CI/CD）。它依赖 <code>package-lock.json</code>，安装速度更快、更严格，但不会更新锁文件。</td><td><code>npm ci</code></td></tr></tbody></table>
<h4 data-id="heading-5">C. 依赖管理与更新</h4>



































<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm update</code></td><td>更新所有包到 <code>package.json</code> 中允许的最新版本（遵循语义化版本规则）。</td><td><code>npm update</code></td></tr><tr><td><code>npm update &lt;package_name&gt;</code></td><td>更新指定的包。</td><td><code>npm update lodash</code></td></tr><tr><td><code>npm outdated</code></td><td>检查有哪些过时的包。</td><td>会列出当前版本、期望版本和最新版本。</td></tr><tr><td><code>npm uninstall &lt;package_name&gt;</code> (或 <code>npm un</code>)</td><td>卸载一个包，并从 <code>package.json</code> 中移除。</td><td><code>npm uninstall lodash</code></td></tr><tr><td><code>npm uninstall &lt;package_name&gt; --save-dev</code></td><td>卸载一个开发依赖包。</td><td><code>npm uninstall eslint --save-dev</code></td></tr></tbody></table>
<h4 data-id="heading-6">D. 运行脚本</h4>
<p><code>package.json</code> 中有一个 <code>"scripts"</code> 字段，可以定义自定义命令。</p>






























<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm run &lt;script_name&gt;</code></td><td>运行在 <code>package.json</code> 的 <code>scripts</code> 中定义的脚本。</td><td>如果 <code>scripts</code> 中有 <code>"start": "node app.js"</code>，则 <code>npm run start</code> 会执行它。</td></tr><tr><td><code>npm start</code></td><td><code>npm run start</code> 的快捷方式。</td><td><code>npm start</code></td></tr><tr><td><code>npm test</code> (或 <code>npm t</code>)</td><td><code>npm run test</code> 的快捷方式。</td><td><code>npm test</code></td></tr><tr><td><code>npm run</code></td><td>列出所有可用的脚本。</td><td><code>npm run</code></td></tr></tbody></table>
<h4 data-id="heading-7">E. 信息查看与审计</h4>













































<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm list</code> (或 <code>npm ls</code>)</td><td>查看当前项目安装的包及其依赖树。</td><td>- <code>npm list</code>：查看顶级依赖 - <code>npm list --depth=0</code>：只查看直接依赖，更清晰 - <code>npm list -g</code>：查看全局安装的包</td></tr><tr><td><code>npm info &lt;package_name&gt;</code></td><td>查看某个包的详细信息（版本、依赖、描述等）。</td><td><code>npm info react</code></td></tr><tr><td><code>npm search &lt;keyword&gt;</code></td><td>在 npm 仓库中搜索包。</td><td><code>npm search http server</code></td></tr><tr><td><code>npm audit</code></td><td><strong>安全检查</strong>，扫描项目依赖中的已知漏洞。</td><td><code>npm audit</code></td></tr><tr><td><code>npm audit fix</code></td><td>自动修复可自动修复的漏洞。</td><td><code>npm audit fix</code></td></tr><tr><td><code>npm audit fix --force</code></td><td>强制修复漏洞，可能会进行破坏性更新（大版本升级）。</td><td><code>npm audit fix --force</code></td></tr><tr><td><code>npm view &lt;package_name&gt; versions</code></td><td>查看一个包所有可用的历史版本。</td><td><code>npm view webpack versions</code></td></tr></tbody></table>
<h4 data-id="heading-8">F. 发布与管理包（针对包开发者）</h4>






























<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm login</code></td><td>登录到你的 npm 账户。</td><td><code>npm login</code></td></tr><tr><td><code>npm publish</code></td><td>将当前目录的包发布到 npm 仓库。</td><td>在项目根目录执行，前提是已登录且有合法的 <code>package.json</code>。</td></tr><tr><td><code>npm version &lt;update_type&gt;</code></td><td>更新包的版本号，并自动创建一个 Git tag。</td><td>- <code>npm version patch</code> (小版本，如 1.0.0 -&gt; 1.0.1) - <code>npm version minor</code> (次版本，如 1.0.0 -&gt; 1.1.0) - <code>npm version major</code> (主版本，如 1.0.0 -&gt; 2.0.0)</td></tr><tr><td><code>npm unpublish &lt;package_name&gt;@&lt;version&gt;</code></td><td><strong>取消发布</strong>某个版本的包（有严格限制）。</td><td><code>npm unpublish my-package@1.0.1</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">4. 常用工作流示例</h3>
<h4 data-id="heading-10">1. 启动一个新项目</h4>
<p>bash</p>
<pre><code class="hljs language-csharp" lang="csharp">mkdir my-<span class="hljs-keyword">new</span>-project
cd my-<span class="hljs-keyword">new</span>-project
npm <span class="hljs-keyword">init</span> -y                <span class="hljs-meta"># 快速创建 package.json</span>
npm install express        <span class="hljs-meta"># 安装生产依赖 express</span>
npm install nodemon --save-dev <span class="hljs-meta"># 安装开发依赖 nodemon</span>
</code></pre>
<p>然后，在 <code>package.json</code> 的 <code>scripts</code> 中添加：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node app.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon app.js"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>之后就可以使用 <code>npm run dev</code> 来启动开发服务器了。</p>
<h4 data-id="heading-11">2. 克隆并运行一个已有项目</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;project-url&gt;
<span class="hljs-built_in">cd</span> &lt;project-folder&gt;
npm install          <span class="hljs-comment"># 安装所有依赖</span>
npm start            <span class="hljs-comment"># 启动项目</span>
</code></pre>
<h4 data-id="heading-12">3. 更新项目依赖</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">npm outdated         <span class="hljs-comment"># 检查哪些包过时了</span>
npm update           <span class="hljs-comment"># 更新所有包到允许的最新版本</span>
npm audit            <span class="hljs-comment"># 检查安全性</span>
npm audit fix        <span class="hljs-comment"># 修复漏洞</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">5. 实用技巧与最佳实践</h3>
<ol>
<li>
<p><strong>使用 <code>npx</code></strong>：<code>npx</code> 随 npm 一起安装，用于临时执行包。它无需全局安装，非常方便。</p>
<ul>
<li><code>npx create-react-app my-app</code> （临时下载并运行 <code>create-react-app</code>）</li>
<li><code>npx eslint .</code> （运行项目本地安装的 <code>eslint</code>）</li>
</ul>
</li>
<li>
<p><strong>使用 <code>.npmrc</code> 文件</strong>：可以在项目根目录创建此文件来定义项目特定的 npm 配置，例如设置私有仓库地址。</p>
</li>
<li>
<p><strong>理解语义化版本</strong>：</p>
<ul>
<li><code>^1.2.3</code>：允许更新次版本和修订号，如 1.2.4, 1.3.0，但不包括 2.0.0。</li>
<li><code>~1.2.3</code>：只允许更新修订号，如 1.2.4。</li>
<li>这就是 <code>package-lock.json</code> 重要的原因，它锁定了确切的版本。</li>
</ul>
</li>
<li>
<p><strong>不要手动修改 <code>node_modules</code></strong>：任何修改都会在下次 <code>npm install</code> 时丢失。</p>
</li>
<li>
<p><strong>将 <code>package-lock.json</code> 提交到 Git</strong>：这是保证团队一致性的关键。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在高并发场景下，动态数据源切换与Seata全局事务锁管理如何协同避免性能瓶颈？]]></title>    <link>https://juejin.cn/post/7571306072422842410</link>    <guid>https://juejin.cn/post/7571306072422842410</guid>    <pubDate>2025-11-11T13:49:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422842410" data-draft-id="7571304204754714678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在高并发场景下，动态数据源切换与Seata全局事务锁管理如何协同避免性能瓶颈？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:49:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在高并发场景下，动态数据源切换与Seata全局事务锁管理如何协同避免性能瓶颈？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:49:51.000Z" title="Tue Nov 11 2025 13:49:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高并发场景下，将动态数据源切换与Seata全局事务锁管理有效结合，确实是一个既关键又具有挑战性的架构设计问题。下面这个表格概括了核心的协同优化策略，帮助你快速建立整体认知。</p>

























<table><thead><tr><th>优化维度</th><th>核心策略</th><th>预期收益</th></tr></thead><tbody><tr><td><strong>数据源路由优化</strong></td><td>精细化路由（如读写分离）、连接池隔离、预检机制</td><td>降低不必要的跨库操作，减少连接等待，提升单点处理能力</td></tr><tr><td><strong>Seata事务锁优化</strong></td><td>锁粒度控制（如分库分表）、混合事务模式（AT/TCC）、参数调优</td><td>缓解全局锁竞争，提高系统并发度</td></tr><tr><td><strong>协同工作机制</strong></td><td>事务边界与数据源生命周期对齐、异常处理与回滚策略</td><td>保证数据一致性的同时，避免资源悬挂和死锁</td></tr></tbody></table>
<h3 data-id="heading-0">💡 动态数据源路由的性能优化</h3>
<p>在高并发下，数据源切换本身不能成为瓶颈。优化的核心在于 <strong>“快、准、稳”</strong> 。</p>
<ol>
<li><strong>精细化路由策略</strong>：避免在单个事务或紧密关联的操作链中频繁切换数据源。例如，在设计上尽量让一个业务逻辑单元内的数据库操作集中于同一个数据源，如果必须跨源，应确保其必要性。采用清晰的<strong>读写分离</strong>策略，将绝大多数查询操作路由到从库，是减轻主库压力、提升并发读取能力的有效手段。</li>
<li><strong>连接池隔离与配置</strong>：为不同的数据源（如主库、从库、报表库）配置独立的、大小合适的数据库连接池。这能有效避免慢查询或某个数据源的异常拖垮整个应用的所有数据库操作。根据并发压力调整连接池参数（如 <code>maximumPoolSize</code>, <code>connectionTimeout</code>）也至关重要。</li>
<li><strong>路由预检与缓存</strong>：对于基于复杂规则（如租户ID、业务类型）的路由，可以引入缓存机制，避免每次请求都进行昂贵的规则计算。同时，在执行路由前，可以对目标数据源进行简单的健康检查（如连接测试），避免将请求路由到不可用或高延迟的节点。</li>
</ol>
<h3 data-id="heading-1">⚙️ Seata全局事务锁的深度优化</h3>
<p>Seata的AT模式在高并发下最主要的瓶颈是<strong>全局锁竞争</strong>。以下是关键优化方向：</p>
<ol>
<li>
<p><strong>控制锁粒度与热点数据</strong>：</p>
<ul>
<li><strong>库存分桶</strong>：对于像库存扣减这样的典型热点场景，可以考虑“库存分桶”方案。将一个SKU的总库存分散到多条记录中，扣减时通过特定算法（如哈希）选择一条记录操作，将竞争一把全局锁变为竞争多把锁，显著提升并发能力。</li>
<li><strong>业务键设计</strong>：在业务设计阶段，尽量避免让大量并发事务操作同一条数据记录。例如，生成订单号时加入用户ID哈希或时间戳分量，使写入尽量分散。</li>
</ul>
</li>
<li>
<p><strong>采用混合事务模式</strong>：这是应对极高并发场景的“杀手锏”。针对业务链路中的不同操作，灵活选用Seata提供的多种事务模式。例如，在电商下单场景中，对不会产生竞争的用户优惠券锁定操作使用<strong>AT模式</strong>，而对热点库存扣减操作采用<strong>TCC模式</strong>。TCC模式在Try阶段进行资源预留，Confirm/Cancel阶段才进行最终操作，避免了AT模式在整个事务周期内持有全局锁，从而大大减少了锁竞争时间。</p>
</li>
<li>
<p><strong>调整Seata客户端参数</strong>：根据业务可接受的延迟，适当调整Seata客户端的相关参数。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">seata:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">tm:</span>
      <span class="hljs-attr">commit-retry-count:</span> <span class="hljs-number">3</span>           <span class="hljs-comment"># 提交重试次数</span>
      <span class="hljs-attr">rollback-retry-count:</span> <span class="hljs-number">3</span>         <span class="hljs-comment"># 回滚重试次数</span>
    <span class="hljs-attr">lock:</span>
      <span class="hljs-attr">retry-interval:</span> <span class="hljs-number">10</span>              <span class="hljs-comment"># 锁重试间隔(ms)</span>
      <span class="hljs-attr">retry-times:</span> <span class="hljs-number">30</span>                 <span class="hljs-comment"># 锁获取重试次数</span>
</code></pre>
<p>增加重试次数和减少重试间隔可以在出现短暂锁竞争时提高成功率，但需注意这会增加单个事务的耗时。</p>
</li>
</ol>
<h3 data-id="heading-2">🔗 二者协同工作流程与策略</h3>
<p>动态数据源路由和Seata事务管理必须协同工作，才能确保在高性能下的一致性。</p>
<ol>
<li><strong>事务边界与数据源生命周期的对齐</strong>：务必确保在带有 <code>@GlobalTransactional</code>注解的方法内部进行数据源切换时，Seata的事务上下文（XID）能正确传递。最佳实践是，在方法开始时就明确设置好后续操作所需的数据源，避免在事务进行中频繁切换。如果必须在事务中切换，应通过编程方式（如 <code>DynamicDataSourceContextHolder.push()</code>）完成，并确保在finally块中清理上下文，防止污染后续操作。</li>
<li><strong>异常处理与回滚策略</strong>：在协同工作中，必须对数据源切换失败或Seata全局锁获取超时等异常有明确的处理策略。一旦发生此类异常，应确保Seata的全局事务能正确回滚，并且动态数据源的上下文也被及时清理。例如，在捕获到全局锁获取失败异常时，不应简单重试，而应结合业务考虑是直接失败快速返回，还是使用异步重试机制。</li>
<li><strong>降级与熔断机制</strong>：在监控到数据库节点故障或Seata事务协调器(TC)出现问题时，系统应具备降级能力。例如，在从库不可用时，动态数据源路由器应能自动将读请求全部指向主库。当Seata不可用时，可能需要降级到使用本地事务+最终一致性方案（如消息队列）来保证核心流程的可用性。</li>
</ol>
<h3 data-id="heading-3">📊 监控与应急处理</h3>
<p>建立完善的监控体系是保障高可用的前提。</p>
<ul>
<li><strong>监控指标</strong>：需要重点关注<strong>动态数据源切换的频率和成功率</strong>、<strong>Seata全局锁的获取时间、等待数量和超时率</strong>、<strong>数据库连接池的使用率</strong>等指标。</li>
<li><strong>应急措施</strong>：当出现性能瓶颈或死锁时，除了常规的重启、扩容，还应具备<strong>主动kill阻塞事务</strong>、<strong>动态禁用某个数据源路由</strong>、<strong>手动清理Seata全局锁</strong>（需极端谨慎）等应急能力。</li>
</ul>
<h3 data-id="heading-4">💎 总结与选型建议</h3>
<p>面对高并发场景，没有一劳永逸的银弹，关键在于根据业务特性进行权衡和选择。</p>
<ul>
<li><strong>对于一致性要求极高且并发热点集中的业务</strong>（如金融核心交易）：优先考虑使用 <strong>TCC模式</strong>或 <strong>Saga模式</strong>来避免全局锁，尽管实现成本较高。</li>
<li><strong>对于并发量高但允许短暂不一致的互联网业务</strong>（如普通电商下单）：可以采用 <strong>AT模式 + 库存分桶等业务设计 + 参数调优</strong>的组合方案，在保证基本一致性的前提下追求性能。</li>
<li><strong>对于读多写少的场景</strong>：充分利用<strong>动态数据源读写分离</strong>，将读压力分散，这是提升整体吞吐量最有效且成本最低的手段之一。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么需要垂直领域的SFT微调？垂直领域SFT微调怎么做？]]></title>    <link>https://juejin.cn/post/7571304204753977398</link>    <guid>https://juejin.cn/post/7571304204753977398</guid>    <pubDate>2025-11-11T10:04:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753977398" data-draft-id="7571077686108618815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么需要垂直领域的SFT微调？垂直领域SFT微调怎么做？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-11T10:04:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么需要垂直领域的SFT微调？垂直领域SFT微调怎么做？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:04:33.000Z" title="Tue Nov 11 2025 10:04:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着人工智能的日益火爆，大语言模型（LLM）的应用正变得无处不在。在垂直领域的SFT微调（Supervised Fine-Tuning）作为提升模型专业能力的关键技术，更是引人瞩目。</p>
<p>但你是否注意到一个奇怪的现象：相比经验丰富的专家，新手似乎对尝试SFT微调表现出了更大的热情？这究竟是为什么？是新手无畏的冒险精神，还是专家深思熟虑后的保留态度？</p>
<p>那么，什么是SFT微调？为什么它这么重要？具体怎么做？又该从哪个模型开始着手？别急，这篇文章将一步步为你解答。</p>
<p><strong>一、为什么需要垂直领域的SFT微调？</strong></p>
<p>通俗来讲，SFT微调是通过垂直领域数据对现有大语言模型进行二次训练，使其在特定领域表现得更精准、更专业。这一步骤的必要性主要体现在以下方面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/114ac4f97a9a41e5972bf18039fe5760~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460272&amp;x-signature=9HfyAS%2BZYSyRm7eMffPthlDaM4k%3D" alt="图片" loading="lazy"/></p>
<p><strong>弥补专业领域认知不足‌</strong></p>
<p>通用大语言模型基于海量互联网数据训练，具备广泛的知识覆盖，但在特定专业领域缺乏深度。</p>
<p>例如，当医生询问某种疾病的临床诊断标准，或律师咨询特定法规条款时，通用模型可能因知识局限而给出模糊甚至错误的回答。</p>
<p>通过SFT微调，引入领域专业数据（如医学期刊、法律案例）可强化模型对专业术语和核心知识的掌握，显著提升回答的准确性和权威性。</p>
<p><strong>‌掌握行业特定规范‌</strong></p>
<p>各行业均有其独特的操作准则。例如，医疗行业需严格遵守患者隐私保护，法律领域必须坚持程序公正原则，这些要求对专业性极为严苛。</p>
<p>通用模型可能因不熟悉行业潜规则而出现疏漏。SFT微调通过注入行业规范数据，使模型能够精准理解垂直场景下的合规要求，避免低级错误。</p>
<p><strong>‌精准匹配多样化任务‌</strong></p>
<p>不同领域的任务需求差异显著：临床医生需要生成结构化病历，法律从业者需审核合同条款，金融从业者则依赖市场趋势分析。</p>
<p>通用模型在面对此类细分任务时往往表现泛化。通过SFT微调，利用实际任务样本（如"指令-输出"对）训练模型，可使其深入理解任务流程，实现"专业对口"的高效输出。</p>
<p><strong>‌优化交互体验‌</strong></p>
<p>即使通用模型能完成基础领域任务，SFT微调仍可进一步优化表现。微调后的模型输出更贴合行业用语习惯，文本连贯性和专业性提升，从而大幅改善用户体验。</p>
<p>‌总结‌：SFT微调如同为通用模型提供"职业特训"，将其从"通才"转化为特定领域的"专家"，实现能力与场景的深度适配。</p>
<p><strong>二、垂直领域SFT微调怎么做？</strong></p>
<p>SFT微调并不是随便拿点数据丢给模型就行，它有一套清晰的流程。下面我们来一步步拆解：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6592c24eae7d4521a5d636b300ec208c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460272&amp;x-signature=hSfBy5ltjN%2BSMasOWrYdJTG5gZg%3D" alt="图片" loading="lazy"/></p>
<p><strong>领域数据准备‌</strong></p>
<p><strong>‌数据采集‌</strong>：获取高价值的专业领域文本，例如临床病历、合同条款、财经报道等，数据形式可包含结构化表格或非结构化文档。</p>
<p><strong>‌数据净化‌</strong>：剔除文本中的干扰项（如错别字、冗余信息）及隐私内容（如个人身份信息），保障数据纯净度。</p>
<p><strong>‌数据标注‌</strong>：按任务需求将数据转换为定向格式，例如“问句-回复”对、“原文-精要”对等，以适配模型训练需求。</p>
<p><strong>‌微调样本构建‌</strong></p>
<p><strong>‌模板设计‌</strong>：依据模型特性与任务目标，制定输入输出范例。例如在医疗场景中，输入为“主诉症状”，输出为“诊疗方案”。</p>
<p><strong>‌内容增强‌</strong>：结合领域知识库或行业标准文件，为输入样本补充上下文说明与规则限制。</p>
<p><strong>‌数据集整合‌</strong>：将样本系统化整理为统一数据集，供后续训练调用。</p>
<p><strong>‌微调策略制定‌</strong></p>
<p><strong>‌模型选择‌</strong>：优先选用与任务匹配度高的基础模型，可显著提升微调效率。</p>
<p><strong>‌目标设定‌</strong>：除语言生成能力外，需纳入任务专项指标（如精确度、合规性等）。</p>
<p><strong>‌参数优化‌</strong>：调整学习率、迭代次数等参数，实现效果与资源消耗的最优配比。</p>
<p><strong>‌模型训练实施‌</strong></p>
<p><strong>‌启动训练‌</strong>：利用预处理数据对选定模型进行训练。</p>
<p><strong>‌实时监控‌</strong>：训练过程中动态评估效果，及时调整参数以确保模型性能持续优化。</p>
<p><strong>‌版本筛选‌</strong>：从多个训练版本中通过测试选出最优模型。</p>
<p>‌<strong>模型效果评估‌</strong></p>
<p><strong>‌多维测试‌</strong>：使用独立测试集验证模型，兼顾语言流畅度与任务达成度。</p>
<p><strong>‌专家验证‌</strong>：邀请领域专家审核输出结果，识别改进点。</p>
<p><strong>‌迭代优化‌</strong>：基于测试反馈调整数据或模型结构，进行多轮精进。</p>
<p><strong>‌实际应用部署‌</strong></p>
<p><strong>‌系统上线‌</strong>：将优化后的模型投入实际业务场景，提供智能化服务。</p>
<p><strong>‌交互设计‌</strong>：开发易用的操作界面，降低用户使用门槛。</p>
<p><strong>‌长效更新‌</strong>：持续收集用户反馈，定期迭代模型以适应领域知识演进。</p>
<p><strong>三、从哪个模型开始微调？基座模型 vs 对话模型</strong></p>
<p>在进行SFT微调时，一个核心决策点是：从哪个起点开始？是选择预训练的基础模型（即基座模型），还是对话模型（例如聊天模型）？这两种路径各有其优势和局限性，我们一起来探讨一下：</p>
<p><strong>1、基于预训练基础模型的微调</strong></p>
<p><strong>优势</strong>：</p>
<p>‌语言能力深厚‌：基座模型经过海量数据训练，具备扎实的语言理解和生成能力，为后续任务奠定了良好基础。</p>
<p>‌可塑性强‌：未针对特定任务固化，可根据实际需求灵活调整微调方向。</p>
<p>‌经济性高‌：相比对话模型，微调过程所需的计算资源和时间成本显著降低。</p>
<p><strong>不足</strong>：</p>
<p>‌领域知识匮乏‌：对专业领域的认知近乎空白，需通过大量数据填补知识缺口。</p>
<p>‌对话适应性差‌：更适合处理独立文本，在多轮对话场景中可能表现生硬。</p>
<p><strong>2、基于对话模型的微调</strong></p>
<p><strong>优势</strong>：</p>
<p>‌对话基础成熟‌：已掌握对话交互的基本模式，能更快适应特定领域的对话需求。</p>
<p>‌上下文连贯性‌：对对话逻辑和语境的把握更精准，输出更自然流畅。</p>
<p>‌交互体验优化‌：生成的响应更贴近人类交流习惯，提升用户满意度。</p>
<p><strong>不足</strong>：</p>
<p>‌潜在偏差‌：可能继承通用对话中的某些倾向性，与垂直领域需求存在冲突。</p>
<p>‌知识深度有限‌：侧重对话交互能力，对专业复杂知识的理解可能不足。</p>
<p>‌资源消耗大‌：模型复杂度更高，微调过程需要更多算力和数据支持。</p>
<p><strong>3、决策建议</strong></p>
<p>若目标是构建高度专业的对话系统，且具备充足的数据和算力资源，建议优先选择对话模型作为起点，能快速实现领域适配并优化用户体验。</p>
<p>若数据有限或任务偏向通用性，从基座模型起步更具性价比，能以较低成本获得合格的基础模型。</p>
<p><strong>混合策略也是可行方案</strong>：先通过基座模型建立领域知识基础，再通过对话模型优化交互体验；或尝试"提示工程"（Prompt Engineering），借助精心设计的输入模板实现快速适配。</p>
<p>最终选择需综合考量三个关键因素：任务特性、数据规模、预算限制。通过系统权衡，才能找到最优解决方案。</p>
<p><strong>四、SFT微调有哪些实际应用？</strong></p>
<p>当基础模型能力不足且RAG技术仍无法满足需求时，SFT微调将成为必要选择。其跨行业适用性极强，以下为典型领域案例：</p>
<p><strong>1、医疗健康领域</strong></p>
<p><strong>‌智能问诊系统‌</strong>：基于患者症状描述，输出初步诊断或健康管理方案。</p>
<p><strong>‌自动化报告生成‌</strong>：整合检验数据，一键生成标准化病历或影像分析报告。</p>
<p><strong>‌新药研发支持‌</strong>：通过分子结构模拟，评估药物活性并加速研发流程。</p>
<p><strong>2、法律司法领域</strong></p>
<p><strong>‌普法智能助手‌</strong>：面向公众提供法律知识解答与诉讼流程指导。</p>
<p><strong>‌合同风险检测‌</strong>：自动识别条款中的法律漏洞并给出优化建议。</p>
<p><strong>‌司法案例挖掘‌</strong>：从判决文书中提取裁判规则，辅助类案分析。</p>
<p><strong>3、金融经济领域</strong></p>
<p><strong>‌财经快讯生成‌</strong>：实时聚合新闻关键信息，产出市场动态简报。</p>
<p><strong>‌量化投资分析‌</strong>：融合财务数据与市场指标，构建股价预测模型。</p>
<p><strong>‌行业研究报告‌</strong>：自动生成细分领域洞察或宏观经济趋势分析。</p>
<p>上述案例仅为SFT微调实际应用的局部展现，其价值边界仍在持续拓展中。</p>
<p><strong>五、总结</strong></p>
<p>垂直领域的SFT微调，是一把打开大语言模型潜力的钥匙。通过它，我们可以把通用的“全能选手”变成某个行业的“顶尖专家”。</p>
<p>无论是医疗诊断、法律咨询，还是金融分析、教育辅导，只要用对了方法，SFT微调都能让模型大放异彩。</p>
<p>总的来说，新手对垂直领域SFT微调的热情源于他们对技术的好奇、对成果的渴望以及对风险的相对无感，而专家则因丰富的经验和对技术边界的清醒认识而更显谨慎。</p>
<p>不管你是初入AI领域的新手，还是深耕多年的专家，理解SFT微调的价值与局限都至关重要。愿这篇文章点燃你的思考火花，激励你在垂直领域的AI探索中找到属于自己的答案。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[访问宝塔面板安全入口404？SSH命令轻松解决]]></title>    <link>https://juejin.cn/post/7571285984088850484</link>    <guid>https://juejin.cn/post/7571285984088850484</guid>    <pubDate>2025-11-11T10:18:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984088850484" data-draft-id="7571156741398052879" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="访问宝塔面板安全入口404？SSH命令轻松解决"/> <meta itemprop="keywords" content="运维,Linux,安全"/> <meta itemprop="datePublished" content="2025-11-11T10:18:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云动雨颤"/> <meta itemprop="url" content="https://juejin.cn/user/772323170591859"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            访问宝塔面板安全入口404？SSH命令轻松解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/772323170591859/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云动雨颤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:18:20.000Z" title="Tue Nov 11 2025 10:18:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文系转载，转载链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwoolyun.com%2Fbt-404%2F" target="_blank" title="https://woolyun.com/bt-404/" ref="nofollow noopener noreferrer">访问宝塔面板安全入口404？SSH命令轻松解决</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在我们的Linux云服务器中安装好宝塔面板后，将宝塔面板的入口链接存进浏览器的收藏夹中，本想随用随开，再次访问时却突然弹出“404 Not Found”，而且在历史记录中打开同样会出现404错误。今天就给大家分享一些解决方案。</p>
<h2 data-id="heading-1">一、404问题到底是什么样的？</h2>
<p>为了方便管理服务器，我们一般会把宝塔面板的公网地址添加到浏览器收藏夹。但过一段时间再点开，页面会显示“404 not found”错误，哪怕从浏览器历史记录里打开，结果也一样——这不是服务器出了大问题，多半是面板的“访问地址或安全入口变了”，按旧地址找自然会扑空。</p>
<h2 data-id="heading-2">二、解决方案</h2>
<p>遇到404不用慌，通过SSH远程连接服务器，执行简单命令就能找回访问地址：</p>
<h3 data-id="heading-3">第一步：通过SSH远程连接服务器</h3>
<p>首先要进入服务器的后台——用SSH工具（比如Xshell、FinalShell、PuTTY、云服务器控制台）连接你的Linux服务器：</p>
<ul>
<li>打开SSH工具，输入服务器的公网IP、端口（默认22）、用户名（比如root）和密码（或密钥）；</li>
<li>点击“连接”，如果出现类似“[root@localhost ~]#”的命令行提示符，就说明连接成功了。</li>
</ul>
<h3 data-id="heading-4">第二步：执行命令，重新获取面板访问信息</h3>
<p>这一步是查询新的面板入口，有两种简单方式，选一种执行即可：</p>
<h4 data-id="heading-5">方式一：一步到位执行命令</h4>
<p>在命令行输入以下代码，按回车：</p>
<pre><code class="hljs">bt 14
</code></pre>
<h4 data-id="heading-6">方式二：分步执行命令</h4>
<p>如果想看清每一步操作，也可以分两步来：</p>
<ol>
<li>先输入 <code>bt</code> 并回车，此时会弹出宝塔面板的命令菜单；</li>
<li>在菜单中输入数字 <code>14</code> 并回车（<code>14</code> 对应的功能就是“查看面板默认信息”）。</li>
</ol>
<p>执行完命令后，终端会显示新的宝塔面板访问地址（比如 <code>https://新IP:新端口/新安全入口</code>）和安全入口验证信息，把这个新地址记下来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69708427e24441bcb07dfe364d36be4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5Yqo6Zuo6aKk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763461099&amp;x-signature=m6Z0jPQx5uq8Gr6bboyae%2BSTz2A%3D" alt="宝塔4041" loading="lazy"/></p>
<h3 data-id="heading-7">第三步：用新地址访问面板</h3>
<p>打开浏览器，把刚获取的新地址粘贴到地址栏，按回车——不出意外，就能正常进入宝塔面板的登录页面，404问题也就解决了。</p>
<h2 data-id="heading-8">三、彻底避免：设置固定安全入口，再也不怕地址变动</h2>
<p>这次解决了，下次还可能遇到？其实只要给宝塔面板“固定入口”，就能一劳永逸：</p>
<h3 data-id="heading-9">第一步：进入宝塔面板</h3>
<p>用刚获取的新地址登录宝塔面板，输入用户名和密码，进入面板管理界面。</p>
<h3 data-id="heading-10">第二步：找到“面板设置”</h3>
<p>在面板左侧的菜单栏中，找到并点击“面板设置”选项。</p>
<h3 data-id="heading-11">第三步：修改并固定安全入口</h3>
<p>在“面板设置”页面中，往下滑动找到“安全入口”设置项：</p>
<ul>
<li>默认的安全入口是随机生成的（比如 <code>randomentry123</code>），容易变动；</li>
<li>把它修改成你容易记住且独特的内容（比如 <code>mybaotaentry</code>，建议包含字母和数字，避免太简单被猜测）；</li>
<li>点击“保存”按钮，此时宝塔面板的访问地址就固定为 <code>https://你的服务器IP:面板端口/你设置的安全入口</code>，以后不管怎么变动，这个地址都能正常访问。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec8dcce637bc47f281f154b8da6618f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5Yqo6Zuo6aKk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763461099&amp;x-signature=VXamsE%2B%2Bu%2FBSt5gdePD7uCrEkUQ%3D" alt="宝塔4042" loading="lazy"/></p>
<h2 data-id="heading-12">四、总结</h2>
<p>宝塔Linux面板出现404，最大原因可能是“访问地址或安全入口变动”，那么解决思路久很清晰了：</p>
<ol>
<li>用SSH连接服务器，执行 <code>bt 14</code> 找到新地址；</li>
<li>登录面板后，在“面板设置”中固定安全入口，避免后续变动。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CI/CD集成工程师前景分析：与开发岗位的全面对比]]></title>    <link>https://juejin.cn/post/7571338749197566002</link>    <guid>https://juejin.cn/post/7571338749197566002</guid>    <pubDate>2025-11-11T13:56:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197566002" data-draft-id="7571352754895994906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CI/CD集成工程师前景分析：与开发岗位的全面对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:56:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CI/CD集成工程师前景分析：与开发岗位的全面对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:56:08.000Z" title="Tue Nov 11 2025 13:56:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在当今快速迭代的软件开发环境中，CI/CD集成工程师已成为众多科技公司不可或缺的角色，但人们常好奇：这一新兴岗位与传统开发相比究竟孰优孰劣？</p>
</blockquote>
<p>随着 DevOps 理念的普及，CI/CD（持续集成/持续交付）已成为现代软件开发的<strong>核心实践</strong>。CI/CD集成工程师作为这一过程的构建者和维护者，在当前的IT行业中需求越来越大，因为软件开发的速度和质量已成为<strong>企业竞争的重要因素</strong>之一。</p>
<p>与此同时，随着云计算和 DevOps 的兴起，更多企业开始采用 CI/CD 来提高软件交付效率。</p>
<hr/>
<h2 data-id="heading-0">01 CI/CD集成工程师的角色与职责</h2>
<p>CI/CD 集成工程师主要负责设计和实施自动化流程，使软件能够更加高效、可靠地构建、测试和部署。</p>
<p><strong>持续集成</strong>（CI）是一种软件开发实践，开发人员频繁地将代码变更合并到共享仓库中，每次变更都会触发<strong>自动化构建和测试</strong>。</p>
<p><strong>持续交付</strong>（CD）则是在此基础上，自动将代码变更部署到各种环境，确保软件随时可以发布到生产环境。</p>
<p>具体来说，CI/CD集成工程师需要确保团队使用的持续集成工具和流程能够顺利地自动化构建、测试和部署软件。</p>
<p>他们需要熟练掌握 <strong>Jenkins、GitLab CI、GitHub Actions</strong> 等工具，并能够运用 Docker 和 Kubernetes 等容器化技术进行自动化部署。</p>
<p>在职责方面，CI/CD集成工程师需要开发和构建自动化框架，包括持续集成和持续部署流程。</p>
<p>他们还要洞察开发、测试和部署中的难点和瓶颈，持续改进以保证项目顺利进行。</p>
<h2 data-id="heading-1">02 开发工程师的角色与职责</h2>
<p>开发工程师主要负责软件的设计、编码和单元测试，是软件产品的<strong>直接创造者</strong>。</p>
<p>与CI/CD工程师不同，开发工程师更关注代码的实现、算法的优化以及功能的完整性和正确性。</p>
<p>开发工程师需要根据产品需求编写高质量的代码，并参与系统架构设计。他们通常会专注于特定的技术栈，如前端、后端或移动端开发。</p>
<p>除了编写代码，开发工程师还需要修复系统中的缺陷，进行代码审查，以及与团队成员协作解决技术难题。</p>
<h2 data-id="heading-2">03 职业前景对比：市场需求与发展空间</h2>
<p><strong>CI/CD集成工程师前景广阔</strong>。随着企业对软件交付速度和质量要求的不断提高，CI/CD集成工程师的需求呈现出<strong>增长趋势</strong>。</p>
<p>在招聘市场上，可以看到众多企业正在招聘CI/CD集成工程师，提供的薪资也颇具竞争力。</p>
<p>例如，来自1111人力银行的招聘信息显示，CI/CD相关职位的月薪在台湾地区可达<strong>6万到10万新台币</strong>。</p>
<p>而猎聘网的招聘信息则显示，北京的CI/CD集成工程师薪资可达<strong>15-25k</strong>人民币。</p>
<p>开发工程师虽然市场需求量大，但由于从业人数众多，<strong>竞争也更为激烈</strong>。相比之下，CI/CD集成工程师作为相对专业的领域，竞争程度较低，且由于缺乏资深人才，高级职位的薪资潜力更大。</p>
<p>随着云原生和微服务架构的普及，CI/CD集成工程师的重要性将进一步凸显，职业发展空间持续看好。</p>
<h2 data-id="heading-3">04 技能要求对比：技术栈与知识体系</h2>
<p>CI/CD集成工程师需要掌握多样化的技术栈。首先，他们需要熟悉 <strong>CI/CD工具链</strong>，如Jenkins、GitLab CI、GitHub Actions等。</p>
<p>其次，他们需要掌握 <strong>Docker和Kubernetes等容器化技术</strong>，以及自动化部署技巧。</p>
<p>此外，他们还需要了解<strong>基础设施即代码</strong>（IaC）工具，如Terraform、Ansible等。</p>
<p>对版本控制系统（尤其是Git）的深入理解也是必不可少的。与开发工程师相比，CI/CD集成工程师更需要<strong>系统架构视角</strong>和<strong>跨环境问题解决能力</strong>。</p>
<p>开发工程师则更需要<strong>深厚的编程功底</strong>，<strong>对算法和数据结构的理解</strong>，以及<strong>特定技术栈的专业知识</strong>。</p>
<p>例如，Java开发工程师需要掌握Spring框架，前端开发工程师需要熟悉React或Vue等框架。</p>
<p>开发工程师通常更专注于代码层面，而CI/CD集成工程师则需要更广泛的系统级知识和自动化能力。</p>
<h2 data-id="heading-4">05 工作内容与团队协作差异</h2>
<p>CI/CD集成工程师的工作内容主要集中在<strong>自动化流程的构建和优化</strong>上。他们需要设计CI/CD流水线，实现自动化构建、静态代码检查、自动化测试等。</p>
<p>他们还需要处理部署过程中的各种问题，确保部署的可靠性和效率。在团队协作方面，CI/CD集成工程师需要与开发人员、测试人员和运维人员密切合作，是** DevOps 文化的关键实践者**。</p>
<p>开发工程师则主要专注于<strong>功能实现和代码编写</strong>。他们需要参与需求分析，进行软件设计，编写代码，完成单元测试，并修复测试过程中发现的问题。</p>
<p>开发工程师通常按产品功能或技术模块划分职责，与产品经理和测试工程师的协作更为紧密。</p>
<p>从工作性质来看，CI/CD集成工程师的工作更偏向<strong>流程和质量保障</strong>，而开发工程师的工作更偏向<strong>功能实现和创新</strong>。</p>
<h2 data-id="heading-5">06 薪资待遇与职业发展路径</h2>
<p>在薪资待遇方面，两类岗位都有不错的表现。根据招聘信息显示，CI/CD集成工程师的薪资普遍较高，特别是拥有多年经验的高级工程师。</p>
<p>开发工程师的薪资范围较为广泛，初级开发工程师的起薪可能相对较低，但随着经验积累和技术提升，高级开发工程师和架构师的薪资也非常可观。</p>
<p>职业发展路径方面，CI/CD集成工程师可以向<strong>DevOps架构师</strong>、<strong>平台工程师</strong>或<strong>SRE</strong>（站点可靠性工程师）方向发展。</p>
<p>他们还可以成为<strong>CI/CD专家</strong>，负责更复杂和大型的系统架构。</p>
<p>开发工程师则可以向<strong>高级开发工程师</strong>、<strong>系统架构师</strong>或<strong>技术负责人</strong>方向发展，也有机会转型为<strong>技术经理</strong>或<strong>产品经理</strong>。</p>
<p>值得注意的是，CI/CD集成工程师的职业发展路径相对较新，机会可能更多，因为这一领域的专业人才仍然相对稀缺。</p>
<h2 data-id="heading-6">07 如何选择：根据个人特质与兴趣</h2>
<p>选择成为CI/CD集成工程师还是开发工程师，应基于个人技术偏好和职业规划。</p>
<p>如果你对<strong>自动化、系统架构和流程优化</strong>感兴趣，喜欢看到自己的工作带来效率的显著提升，那么CI/CD集成工程师可能是更好的选择。</p>
<p>这一岗位需要<strong>较强的逻辑思维</strong>和<strong>系统分析能力</strong>，以及<strong>解决复杂问题的耐心</strong>。</p>
<p>如果你更享受<strong>代码编写和功能实现</strong>的过程，喜欢从零开始构建产品，并具备<strong>较强的创造力</strong>，那么开发工程师可能更适合你。</p>
<p>这一岗位需要<strong>持续学习新技术</strong>的能力和<strong>对细节的关注</strong>。</p>
<p>无论选择哪条路径，都需要不断学习新知识和技能。对于初学者，建议先积累一定的开发经验，再向CI/CD领域发展，这样会有更扎实的基础和更全面的视角。</p>
<hr/>
<p><strong>未来已来</strong>，随着云原生、人工智能等技术的不断发展，CI/CD集成工程师的工作内容将进一步丰富，他们将在<strong>智能运维、自动化测试优化</strong>等领域发挥更大价值。</p>
<p>而对于开发工程师来说，<strong>掌握CI/CD知识</strong>也将从“加分项”变为“必需项”，只有理解完整软件交付流程的开发工程师，才能在未来的团队中发挥更大作用。</p>
<p>无论选择哪条路径，<strong>持续学习</strong>和<strong>实践验证</strong>都是不可或缺的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++中的线程同步机制浅析]]></title>    <link>https://juejin.cn/post/7571338749197598770</link>    <guid>https://juejin.cn/post/7571338749197598770</guid>    <pubDate>2025-11-11T13:57:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197598770" data-draft-id="7571332468897775643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++中的线程同步机制浅析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:57:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++中的线程同步机制浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:57:30.000Z" title="Tue Nov 11 2025 13:57:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 为什么需要线程同步？</h3>
<p>当多个线程并发访问共享数据（内存、文件、网络连接等）时，如果不进行任何同步控制，可能会引发一系列问题，最典型的是：</p>
<ul>
<li><strong>数据竞争</strong>：一个线程在读数据时，另一个线程在写数据，导致读到的数据是“脏的”、不完整的或逻辑错误的。</li>
<li><strong>破坏不变量</strong>：对象在修改过程中，其内部状态可能暂时是不一致的（例如，修改一个链表时）。如果另一个线程在此时访问该对象，会看到这个破碎的状态，导致未定义行为。</li>
</ul>
<p>线程同步的核心目的是：<strong>通过强制特定代码段的互斥访问或执行顺序，来保证多线程环境下程序行为的正确性和可预测性。</strong></p>
<hr/>
<h3 data-id="heading-1">2. C++标准库提供的同步机制</h3>
<p>C++11在标准库中引入了 <code>&lt;thread&gt;</code> 和 <code>&lt;mutex&gt;</code> 等头文件，提供了丰富的同步原语。</p>
<h4 data-id="heading-2">2.1 互斥量 - 保证互斥访问</h4>
<p>互斥量是最基础的同步工具，它确保同一时间只有一个线程可以进入被保护的代码段（临界区）。</p>
<p><strong>a) <code>std::mutex</code></strong>
最基本的互斥量，不可递归。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::mutex g_mutex;
<span class="hljs-type">int</span> shared_data = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        g_mutex.<span class="hljs-built_in">lock</span>(); <span class="hljs-comment">// 加锁</span>
        ++shared_data;  <span class="hljs-comment">// 临界区</span>
        g_mutex.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 解锁</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment)</span></span>;
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    std::cout &lt;&lt; <span class="hljs-string">"Final value: "</span> &lt;&lt; shared_data &lt;&lt; std::endl; <span class="hljs-comment">// 一定是 200000</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>注意</strong>：直接使用 <code>lock()</code> 和 <code>unlock()</code> 是危险的，如果临界区代码抛出异常，可能导致互斥量无法解锁，引发死锁。<strong>永远优先使用RAII包装器</strong>。</p>
<p><strong>b) <code>std::lock_guard</code></strong>
最简单的RAII包装器，在构造时加锁，析构时自动解锁。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>; <span class="hljs-comment">// 构造时加锁</span>
        ++shared_data; <span class="hljs-comment">// 临界区</span>
    } <span class="hljs-comment">// 作用域结束，lock析构，自动解锁</span>
}
</code></pre>
<p><strong>c) <code>std::unique_lock</code></strong>
比 <code>lock_guard</code> 更灵活，但开销稍大。它允许延迟加锁、提前解锁、条件变量配合使用等。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flexible_increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex, std::defer_lock)</span></span>; <span class="hljs-comment">// 延迟加锁</span>
        <span class="hljs-comment">// ... 一些不涉及共享数据的操作 ...</span>
        lock.<span class="hljs-built_in">lock</span>(); <span class="hljs-comment">// 手动加锁</span>
        ++shared_data;
        lock.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 可以手动提前解锁</span>
        <span class="hljs-comment">// ... 其他操作 ...</span>
    }
}
</code></pre>
<p><strong>d) <code>std::recursive_mutex</code></strong>
允许同一个线程多次获取同一个互斥量而不会死锁。用于可能递归调用或需要多次加锁的场景。<strong>应谨慎使用，通常表明设计可能有问题。</strong></p>
<h4 data-id="heading-3">2.2 条件变量 - 线程间的通信与等待</h4>
<p>条件变量允许线程阻塞等待某个条件成立，或在条件成立时通知其他线程。它必须与互斥量配合使用。</p>
<ul>
<li><code>std::condition_variable</code> （推荐，通常更高效）</li>
<li><code>std::condition_variable_any</code> （可与任何满足基本互斥量概念的类型一起使用，但开销更大）</li>
</ul>
<p><strong>典型生产者-消费者模型：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>

std::queue&lt;<span class="hljs-type">int</span>&gt; g_queue;
std::mutex g_mutex;
std::condition_variable g_cv;
<span class="hljs-type">bool</span> g_done = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) {
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
        {
            <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>;
            g_queue.<span class="hljs-built_in">push</span>(i);
            std::cout &lt;&lt; <span class="hljs-string">"Produced: "</span> &lt;&lt; i &lt;&lt; std::endl;
        }
        g_cv.<span class="hljs-built_in">notify_one</span>(); <span class="hljs-comment">// 通知一个等待的消费者</span>
    }
    {
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>;
        g_done = <span class="hljs-literal">true</span>;
    }
    g_cv.<span class="hljs-built_in">notify_all</span>(); <span class="hljs-comment">// 通知所有消费者结束</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>;
        <span class="hljs-comment">// 等待条件：队列不为空或生产结束</span>
        g_cv.<span class="hljs-built_in">wait</span>(lock, [] { <span class="hljs-keyword">return</span> !g_queue.<span class="hljs-built_in">empty</span>() || g_done; });

        <span class="hljs-comment">// 被唤醒后，需要重新检查条件</span>
        <span class="hljs-keyword">if</span> (g_done &amp;&amp; g_queue.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-comment">// 消费数据</span>
        <span class="hljs-type">int</span> data = g_queue.<span class="hljs-built_in">front</span>();
        g_queue.<span class="hljs-built_in">pop</span>();
        lock.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 尽早释放锁</span>

        std::cout &lt;&lt; <span class="hljs-string">"Consumer "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" consumed: "</span> &lt;&lt; data &lt;&lt; std::endl;
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>wait</code> 操作会原子地释放互斥锁并使线程休眠。</li>
<li>被唤醒时，它会重新获取互斥锁，然后检查条件（使用提供的谓词）。<strong>必须使用循环或带谓词的wait来防止“虚假唤醒”</strong>。</li>
</ul>
<h4 data-id="heading-4">2.3 信号量 - C++20</h4>
<p>信号量是一个更底层的同步原语，它维护一个计数器，用于控制对特定数量资源的访问。</p>
<ul>
<li><code>std::counting_semaphore</code>：允许至少 <code>LeastMaxValue</code> 个并发访问。</li>
<li><code>std::binary_semaphore</code>：是 <code>std::counting_semaphore&lt;1&gt;</code> 的别名，类似于互斥量，但可由不同线程进行锁和解锁。</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore&gt;</span></span>

<span class="hljs-function">std::binary_semaphore <span class="hljs-title">smph</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// 初始值为0</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">waiter</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"Waiting...\n"</span>;
    smph.<span class="hljs-built_in">acquire</span>(); <span class="hljs-comment">// 等待信号量值&gt;0，然后减1</span>
    std::cout &lt;&lt; <span class="hljs-string">"Finished waiting!\n"</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">notifier</span><span class="hljs-params">()</span> </span>{
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
    std::cout &lt;&lt; <span class="hljs-string">"Notifying...\n"</span>;
    smph.<span class="hljs-built_in">release</span>(); <span class="hljs-comment">// 信号量值加1，唤醒等待者</span>
}
</code></pre>
<h4 data-id="heading-5">2.4 锁存器和屏障 - C++20</h4>
<p>用于管理一组线程的同步点。</p>
<ul>
<li><strong><code>std::latch</code></strong>：一次性使用的倒计时门闩。线程在 <code>arrive_and_wait</code> 上阻塞，直到内部计数器减为0，所有阻塞线程被同时释放。不可重复使用。</li>
<li><strong><code>std::barrier</code></strong>：可重复使用的同步机制。它允许一组线程执行一系列阶段。在每个阶段，线程到达屏障并阻塞，直到所有线程都到达，然后所有线程被释放，屏障进入下一个阶段。</li>
</ul>
<hr/>
<h3 data-id="heading-6">3. 高级话题与底层原理</h3>
<h4 data-id="heading-7">3.1 死锁与预防</h4>
<p>死锁通常发生在两个或以上线程互相等待对方持有的资源时。</p>
<p><strong>产生条件（四个必要条件）</strong>：</p>
<ol>
<li><strong>互斥访问</strong></li>
<li><strong>持有并等待</strong></li>
<li><strong>不可剥夺</strong></li>
<li><strong>循环等待</strong></li>
</ol>
<p><strong>预防策略</strong>：</p>
<ul>
<li><strong>固定顺序上锁</strong>：所有线程都按照相同的全局顺序获取锁。</li>
<li><strong>使用 <code>std::lock</code> 或 <code>std::scoped_lock</code> (C++17)</strong>：一次性锁定多个互斥量，避免死锁。
<pre><code class="hljs language-cpp" lang="cpp">std::mutex mutex1, mutex2;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_lock</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// std::lock 使用死锁避免算法（如Dijkstra算法）来同时锁定多个互斥量</span>
    std::<span class="hljs-built_in">lock</span>(mutex1, mutex2);
    <span class="hljs-comment">// 使用 std::adopt_lock 表示互斥量已被锁定，lock_guard只需接管所有权</span>
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock1</span><span class="hljs-params">(mutex1, std::adopt_lock)</span></span>;
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock2</span><span class="hljs-params">(mutex2, std::adopt_lock)</span></span>;
    <span class="hljs-comment">// ...</span>
}
<span class="hljs-comment">// C++17 更简洁的方式：</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safer_lock</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::scoped_lock <span class="hljs-title">lock</span><span class="hljs-params">(mutex1, mutex2)</span></span>; <span class="hljs-comment">// 自动使用死锁避免算法</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
</li>
<li><strong>避免嵌套锁</strong>：如果可能，尽量只持有一个锁。</li>
<li><strong>使用层次锁</strong>：为锁分配层级编号，只允许以编号递减的顺序获取锁。</li>
</ul>
<h4 data-id="heading-8">3.2 性能考量</h4>
<ul>
<li><strong>锁的粒度</strong>：锁保护的临界区应尽可能小。在临界区内不要进行耗时操作（如I/O）。</li>
<li><strong>锁竞争</strong>：当多个线程频繁尝试获取同一个锁时，会发生激烈竞争，导致大量线程在用户态和内核态之间切换，严重降低性能。
<ul>
<li><strong>解决方案</strong>：使用无锁数据结构、减少共享数据、使用读写锁（<code>std::shared_mutex</code>）、或者将数据分区（每个线程处理自己的数据副本，最后再合并）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">3.3 内存模型与原子操作</h4>
<p>同步机制的底层与C++内存模型紧密相关。</p>
<ul>
<li><strong><code>std::atomic</code></strong>：提供了无需互斥锁的线程安全访问。对于基本数据类型（如 <code>int</code>, <code>bool</code>, <code>pointer</code>），使用 <code>std::atomic</code> 通常比 <code>mutex</code> 效率更高，因为它直接在CPU指令级别保证操作的原子性。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">atomic_counter</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">atomic_increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        atomic_counter.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
    }
}
</code></pre>
</li>
<li><strong>内存序</strong>：<code>std::memory_order</code> 允许你控制原子操作周围的非原子内存访问的可见性顺序。这是为了在保证正确性的前提下，追求极致的性能。
<ul>
<li><code>memory_order_seq_cst</code>（顺序一致性）：最强保证，默认选项，性能开销最大。</li>
<li><code>memory_order_acquire</code>/<code>memory_order_release</code>/<code>memory_order_acq_rel</code>：用于实现“同步于”关系。</li>
<li><code>memory_order_relaxed</code>：只保证原子性，不提供同步和顺序保证。</li>
</ul>
</li>
</ul>
<p><strong>除非你是专家，否则请使用 <code>std::atomic</code> 的默认内存序（<code>memory_order_seq_cst</code>）。</strong></p>
<hr/>
<h3 data-id="heading-10">4. 总结与最佳实践</h3>
<ol>
<li><strong>优先使用RAII</strong>：始终使用 <code>std::lock_guard</code>, <code>std::unique_lock</code>, <code>std::scoped_lock</code>，避免手动 <code>lock/unlock</code>。</li>
<li><strong>用互斥量保护数据，而非代码</strong>：清晰地知道哪些数据是共享的，并用最小的锁粒度来保护它。</li>
<li><strong>慎用递归锁</strong>：递归锁通常意味着糟糕的设计。</li>
<li><strong>使用条件变量进行事件等待</strong>：不要使用忙等待（<code>while (!condition) {}</code>），这会浪费CPU资源。</li>
<li><strong>警惕死锁</strong>：使用锁顺序、<code>std::lock</code> 等策略来预防。</li>
<li><strong>性能瓶颈在于锁竞争</strong>：优化方向是减少共享和缩小临界区，而非盲目追求“无锁”。无锁编程极其复杂且容易出错。</li>
<li><strong>简单场景用 <code>atomic</code>，复杂同步用 <code>mutex</code></strong>：对于简单的计数器或标志位，<code>std::atomic</code> 是更好的选择。对于复杂的对象或需要等待条件的情况，使用 <code>mutex</code> 和 <code>condition_variable</code>。</li>
<li><strong>理解工具适用场景</strong>：
<ul>
<li><code>mutex</code>：互斥访问。</li>
<li><code>condition_variable</code>：等待条件成立。</li>
<li><code>semaphore</code>：控制资源池访问。</li>
<li><code>latch/barrier</code>：多线程分阶段协同。</li>
</ul>
</li>
</ol>
<p>通过深入理解这些同步机制的原理、代价和适用场景，你才能写出既正确又高效的多线程C++程序。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南]]></title>    <link>https://juejin.cn/post/7571299394345730090</link>    <guid>https://juejin.cn/post/7571299394345730090</guid>    <pubDate>2025-11-11T14:00:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345730090" data-draft-id="7571258854901399595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-11-11T14:00:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:00:54.000Z" title="Tue Nov 11 2025 14:00:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在SpringBoot项目中，使用MyBatis-Plus和Dynamic-Datasource实现读写分离是一种常见且高效的架构选择。下面我将为你详细讲解完整的实现方案，包括环境准备、配置、代码实现以及注意事项。</p>
<h2 data-id="heading-0">1. 读写分离概述与核心概念</h2>
<p>读写分离是一种常见的数据库优化方案，其核心思想是将数据库的写操作（INSERT、UPDATE、DELETE）和读操作（SELECT）分发到不同的数据库节点上。主数据库（Master）负责处理所有写操作，而从数据库（Slave）负责处理读操作，通过数据库的主从复制机制保持数据同步。</p>
<h3 data-id="heading-1">1.1 核心价值</h3>
<ul>
<li><strong>提升并发性能</strong>：将读请求分散到多个从库，减轻主库压力</li>
<li><strong>提高系统可用性</strong>：单个从库故障不影响读服务</li>
<li><strong>优化响应速度</strong>：专库专用，避免读写操作相互阻塞</li>
</ul>
<h3 data-id="heading-2">1.2 技术架构</h3>
<pre><code class="hljs language-markdown" lang="markdown">应用程序 → Dynamic-Datasource → 主库（写操作）
<span class="hljs-code">                     ↓
                   从库（读操作）
</span></code></pre>
<p><em>图：读写分离架构示意图</em></p>
<h2 data-id="heading-3">2. 环境准备与依赖配置</h2>
<h3 data-id="heading-4">2.1 添加Maven依赖</h3>
<p>首先在项目的<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis-Plus 启动器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Dynamic-Datasource 启动器（核心依赖） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MySQL 驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 连接池（可选，HikariCP已内置） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p><em>citation:2][citation:3</em></p>
<h3 data-id="heading-5">2.2 配置文件设置</h3>
<p>在<code>application.yml</code>中配置主从数据源：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>  <span class="hljs-comment"># 设置默认数据源为主库</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment"># 是否严格匹配数据源，false时未匹配到指定数据源则使用默认数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-comment"># 主库配置（写操作）</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://master-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">master@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-comment"># 从库配置（读操作）- 支持多个从库</span>
        <span class="hljs-attr">slave1:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://slave1-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">readonly</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">slave2:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://slave2-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">readonly</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      
      <span class="hljs-comment"># 负载均衡策略配置（多个从库时生效）</span>
      <span class="hljs-attr">strategy:</span> 
        <span class="hljs-attr">slave:</span> <span class="hljs-string">round_robin</span>  <span class="hljs-comment"># 从库负载均衡策略：random(随机)/round_robin(轮询)</span>
      
      <span class="hljs-comment"># 连接池配置（HikariCP）</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">max-pool-size:</span> <span class="hljs-number">20</span>      <span class="hljs-comment"># 最大连接数</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span>           <span class="hljs-comment"># 最小空闲连接</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 连接超时时间(ms)</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>  <span class="hljs-comment"># 空闲连接超时时间(ms)</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span> <span class="hljs-comment"># 连接最大生命周期(ms)</span>

<span class="hljs-comment"># MyBatis-Plus 配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启驼峰命名转换</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>  <span class="hljs-comment"># 打印SQL日志(调试用)</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>  <span class="hljs-comment"># 主键策略自增</span>
</code></pre>
<p><em>citation:2][citation:6</em></p>
<h2 data-id="heading-6">3. 数据源与MyBatis-Plus配置类</h2>
<h3 data-id="heading-7">3.1 动态数据源自动配置</h3>
<p>Dynamic-Datasource starter已经提供了自动配置，大多数情况下无需额外配置。但如果需要自定义，可以创建配置类：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)  <span class="hljs-comment">// 指定MyBatis mapper接口的扫描路径</span>
public class DataSourceConfig {
    
    <span class="hljs-comment">/**
     * 配置动态数据源
     * Dynamic-Datasource会自动根据application.yml的配置创建数据源
     * 此处可以添加自定义配置
     */</span>
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.dynamic"</span>)
    public DynamicDataSourceProperties <span class="hljs-built_in">dynamicDataSourceProperties</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicDataSourceProperties</span>();
    }
    
    <span class="hljs-comment">/**
     * 配置MyBatis-Plus拦截器（分页插件等）
     */</span>
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">MybatisPlusInterceptor</span> <span class="hljs-selector-tag">mybatisPlusInterceptor</span>() {
        <span class="hljs-selector-tag">MybatisPlusInterceptor</span> <span class="hljs-selector-tag">interceptor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 添加分页插件</span>
        <span class="hljs-selector-tag">PaginationInnerInterceptor</span> <span class="hljs-selector-tag">paginationInterceptor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">PaginationInnerInterceptor</span>(DbType.MYSQL);
        <span class="hljs-selector-tag">paginationInterceptor</span><span class="hljs-selector-class">.setMaxLimit</span>(<span class="hljs-number">1000</span>L);  <span class="hljs-comment">// 设置最大分页限制</span>
        <span class="hljs-selector-tag">interceptor</span><span class="hljs-selector-class">.addInnerInterceptor</span>(paginationInterceptor);
        
        <span class="hljs-comment">// 可以添加其他插件，如乐观锁插件等</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">interceptor</span>;
    }
}
</code></pre>
<p><em>citation:1][citation:5</em></p>
<h2 data-id="heading-8">4. 业务层实现读写分离</h2>
<h3 data-id="heading-9">4.1 使用@DS注解手动切换数据源</h3>
<p>最直接的方式是在Service层使用<code>@DS</code>注解指定数据源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">/**
     * 写操作：使用<span class="hljs-doctag">@DS</span>("master")指定主库
     * 注意：写操作建议都使用主库，确保数据一致性
     */</span>
    <span class="hljs-meta">@DS("master")</span>  <span class="hljs-comment">// 指定使用主库</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 添加事务管理</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || StringUtils.isBlank(user.getUsername())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户信息不完整"</span>);
        }
        
        <span class="hljs-comment">// 设置创建时间</span>
        user.setCreateTime(LocalDateTime.now());
        user.setUpdateTime(LocalDateTime.now());
        
        <span class="hljs-comment">// 执行插入操作，这里会使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> save(user);
        
        <span class="hljs-comment">// 这里可以添加其他业务逻辑</span>
        log.info(<span class="hljs-string">"创建用户成功，用户ID: {}"</span>, user.getId());
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 读操作：使用<span class="hljs-doctag">@DS</span>("slave")指定从库
     * 框架会根据负载均衡策略选择slave1或slave2
     */</span>
    <span class="hljs-meta">@DS("slave")</span>  <span class="hljs-comment">// 指定使用从库（负载均衡）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        <span class="hljs-comment">// 查询用户信息，这里会使用从库</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(id);
        
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"未找到对应用户，用户ID: {}"</span>, id);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在"</span>);
        }
        
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-comment">/**
     * 批量查询：同样使用从库
     */</span>
    <span class="hljs-meta">@DS("slave")</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">listUsersByCondition</span><span class="hljs-params">(UserQuery query)</span> {
        <span class="hljs-comment">// 构建查询条件</span>
        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        
        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(query.getUsername())) {
            wrapper.like(User::getUsername, query.getUsername());
        }
        
        <span class="hljs-keyword">if</span> (query.getStatus() != <span class="hljs-literal">null</span>) {
            wrapper.eq(User::getStatus, query.getStatus());
        }
        
        <span class="hljs-comment">// 添加排序</span>
        wrapper.orderByDesc(User::getCreateTime);
        
        <span class="hljs-comment">// 执行查询，使用从库</span>
        <span class="hljs-keyword">return</span> list(wrapper);
    }
    
    <span class="hljs-comment">/**
     * 更新操作：必须使用主库
     */</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户信息不完整"</span>);
        }
        
        <span class="hljs-comment">// 设置更新时间</span>
        user.setUpdateTime(LocalDateTime.now());
        
        <span class="hljs-comment">// 执行更新，使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> updateById(user);
        
        <span class="hljs-keyword">if</span> (result) {
            log.info(<span class="hljs-string">"更新用户成功，用户ID: {}"</span>, user.getId());
        } <span class="hljs-keyword">else</span> {
            log.error(<span class="hljs-string">"更新用户失败，用户ID: {}"</span>, user.getId());
        }
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 删除操作：必须使用主库
     */</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        <span class="hljs-comment">// 执行删除，使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> removeById(id);
        
        <span class="hljs-keyword">if</span> (result) {
            log.info(<span class="hljs-string">"删除用户成功，用户ID: {}"</span>, id);
        } <span class="hljs-keyword">else</span> {
            log.warn(<span class="hljs-string">"删除用户失败，用户ID: {}"</span>, id);
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><em>citation:2][citation:8</em></p>
<h3 data-id="heading-10">4.2 基于AOP的自动数据源切换（推荐）</h3>
<p>对于大型项目，手动添加<code>@DS</code>注解比较繁琐，可以通过AOP自动根据方法类型切换数据源：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DataSourceAspect {
    
    <span class="hljs-comment">/**
     * 定义切点：拦截Service层的所有方法
     */</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service..*.*(..))"</span>)
    public void <span class="hljs-built_in">servicePointcut</span>() {}
    
    <span class="hljs-comment">/**
     * 前置通知：在方法执行前选择数据源
     */</span>
    <span class="hljs-variable">@Before</span>(<span class="hljs-string">"servicePointcut()"</span>)
    public void <span class="hljs-built_in">before</span>(JoinPoint joinPoint) {
        <span class="hljs-comment">// 获取方法名</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">methodName</span> = <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.getSignature</span>()<span class="hljs-selector-class">.getName</span>();
        
        <span class="hljs-comment">// 根据方法名前缀判断是读操作还是写操作</span>
        <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isReadOperation</span>(methodName)) {
            <span class="hljs-comment">// 读操作使用从库</span>
            <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.push</span>(<span class="hljs-string">"slave"</span>);
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"切换数据源到从库，方法名: {}"</span>, methodName);
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-comment">// 写操作使用主库</span>
            <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.push</span>(<span class="hljs-string">"master"</span>);
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"切换数据源到主库，方法名: {}"</span>, methodName);
        }
    }
    
    <span class="hljs-comment">/**
     * 后置通知：清理数据源上下文
     */</span>
    @<span class="hljs-selector-tag">After</span>(<span class="hljs-string">"servicePointcut()"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">after</span>() {
        <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.clear</span>();
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"清除数据源上下文"</span>);
    }
    
    <span class="hljs-comment">/**
     * 判断是否为读操作
     * 可以根据方法名前缀进行判断
     */</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">isReadOperation</span>(String methodName) {
        <span class="hljs-comment">// 常见的读操作方法前缀</span>
        <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">readPrefixes</span> = {"<span class="hljs-selector-tag">get</span>", "<span class="hljs-selector-tag">select</span>", "<span class="hljs-selector-tag">list</span>", "<span class="hljs-selector-tag">query</span>", "<span class="hljs-selector-tag">find</span>", "<span class="hljs-selector-tag">search</span>", "<span class="hljs-selector-tag">count</span>", "<span class="hljs-selector-tag">check</span>"};
        
        <span class="hljs-selector-tag">for</span> (String <span class="hljs-attribute">prefix </span>: readPrefixes) {
            <span class="hljs-selector-tag">if</span> (methodName.<span class="hljs-built_in">startsWith</span>(prefix)) {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">true</span>;
            }
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">false</span>;
    }
}
</code></pre>
<p><em>citation:3][citation:7</em></p>
<p>使用AOP后，Service层的代码可以简化为：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Service</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl&lt;UserMapper</span>, <span class="hljs-title">User&gt;</span> <span class="hljs-title">implements</span> <span class="hljs-title">UserService</span> </span>{
    
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-type">Exception</span>.<span class="hljs-keyword">class</span>)
    <span class="hljs-meta">@Override</span>
    public boolean createUser(<span class="hljs-type">User</span> user) {
        <span class="hljs-comment">// 自动使用主库（AOP根据方法名判断）</span>
        user.setCreateTime(<span class="hljs-type">LocalDateTime</span>.now());
        <span class="hljs-keyword">return</span> save(user);
    }
    
    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">User</span> getUserById(<span class="hljs-type">Long</span> id) {
        <span class="hljs-comment">// 自动使用从库（AOP根据方法名前缀"get"判断）</span>
        <span class="hljs-keyword">return</span> getById(id);
    }
    
    <span class="hljs-comment">// 其他方法无需添加@DS注解，由AOP自动处理</span>
}
</code></pre>
<h2 data-id="heading-11">5. 事务处理策略</h2>
<p>事务处理是读写分离中的关键问题，需要特别注意：</p>
<h3 data-id="heading-12">5.1 单数据源事务</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class OrderServiceImpl extends ServiceImpl&lt;OrderMapper, Order&gt; implements OrderService {
    
    <span class="hljs-comment">/**
     * 单数据源事务：所有操作都在主库执行
     * 使用@DS("master")确保即使有AOP配置也使用主库
     */</span>
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>)  <span class="hljs-comment">// 显式指定主库</span>
    <span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)  <span class="hljs-comment">// 声明式事务</span>
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">createOrder</span>(Order order) {
        <span class="hljs-comment">// 1. 保存订单主信息（主库）</span>
        <span class="hljs-selector-tag">save</span>(order);
        
        <span class="hljs-comment">// 2. 更新库存（主库）</span>
        <span class="hljs-selector-tag">updateStock</span>(order);
        
        <span class="hljs-comment">// 3. 记录操作日志（主库）</span>
        <span class="hljs-selector-tag">logOrderOperation</span>(order);
        
        <span class="hljs-comment">// 如果任何一步失败，整个事务回滚</span>
    }
    
    <span class="hljs-comment">/**
     * 只读事务：可以指定从库
     */</span>
    @<span class="hljs-selector-tag">DS</span>(<span class="hljs-string">"slave"</span>)
    @<span class="hljs-selector-tag">Transactional</span>(readOnly = true)  <span class="hljs-comment">// 只读事务，有优化效果</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">getOrderDetail</span>(Long orderId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">getById</span>(orderId);
    }
}
</code></pre>
<h3 data-id="heading-13">5.2 多数据源事务处理</h3>
<p>对于涉及多个数据源的复杂事务，需要使用分布式事务解决方案：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTransactionService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-comment">/**
     * 使用<span class="hljs-doctag">@DSTransactional</span>实现多数据源分布式事务
     * 注意：需要集成Seata等分布式事务框架
     */</span>
    <span class="hljs-comment">// @DSTransactional  // 分布式事务注解（需要额外配置）</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(Order order, User user)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 用户操作（主库）</span>
            userService.updateUser(user);
            
            <span class="hljs-comment">// 2. 订单操作（主库）</span>
            orderService.createOrder(order);
            
            <span class="hljs-comment">// 模拟业务异常</span>
            <span class="hljs-keyword">if</span> (order.getAmount() == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单金额不能为空"</span>);
            }
            
            log.info(<span class="hljs-string">"下单成功"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"下单失败，已回滚"</span>, e);
            <span class="hljs-keyword">throw</span> e;  <span class="hljs-comment">// 抛出异常触发回滚</span>
        }
    }
}
</code></pre>
<p><em>citation:7</em></p>
<h2 data-id="heading-14">6. 高级功能与优化策略</h2>
<h3 data-id="heading-15">6.1 多从库负载均衡</h3>
<p>当配置多个从库时，Dynamic-Datasource支持多种负载均衡策略：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-comment"># 主库配置...</span>
        <span class="hljs-attr">slave1:</span>
          <span class="hljs-comment"># 从库1配置...</span>
        <span class="hljs-attr">slave2:</span>
          <span class="hljs-comment"># 从库2配置...</span>
        <span class="hljs-attr">slave3:</span>
          <span class="hljs-comment"># 从库3配置...</span>
      <span class="hljs-attr">strategy:</span>
        <span class="hljs-attr">slave:</span> <span class="hljs-string">round_robin</span>  <span class="hljs-comment"># 负载均衡策略</span>
        <span class="hljs-comment"># 可选值:</span>
        <span class="hljs-comment"># random - 随机选择（默认）</span>
        <span class="hljs-comment"># round_robin - 轮询</span>
        <span class="hljs-comment"># weight_round_robin - 加权轮询（需要额外配置权重）</span>
</code></pre>
<p>负载均衡策略对比：</p>

























<table><thead><tr><th>策略类型</th><th>描述</th><th>适用场景</th></tr></thead><tbody><tr><td>random</td><td>随机选择从库</td><td>简单的读负载均衡</td></tr><tr><td>round_robin</td><td>轮询选择从库</td><td>从库配置相近，需要均匀分布</td></tr><tr><td>weight_round_robin</td><td>根据权重选择</td><td>从库配置不同，按性能分配负载</td></tr></tbody></table>
<p><em>citation:3][citation:7</em></p>
<h3 data-id="heading-16">6.2 健康检查与故障转移</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DataSourceHealthCheck {
    
    <span class="hljs-variable">@Autowired</span>
    private DataSource dataSource;
    
    <span class="hljs-comment">/**
     * 定时检查从库健康状态
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedRate = <span class="hljs-number">60000</span>)  <span class="hljs-comment">// 每分钟执行一次</span>
    public void <span class="hljs-built_in">checkSlaveHealth</span>() {
        <span class="hljs-comment">// 这里可以实现从库健康检查逻辑</span>
        <span class="hljs-comment">// 如果某个从库不可用，可以动态将其从负载均衡池中移除</span>
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"执行从库健康检查..."</span>);
        <span class="hljs-comment">// 实际实现中可以使用JDBC测试连接或查询数据库状态</span>
    }
    
    <span class="hljs-comment">/**
     * 获取从库同步延迟
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">getReplicationDelay</span>(String slaveName) {
        <span class="hljs-comment">// 执行SQL查询从库同步状态</span>
        <span class="hljs-comment">// SHOW SLAVE STATUS 可以获取Seconds_Behind_Master等信息</span>
        <span class="hljs-comment">// 如果延迟过大，可以临时将该从库标记为不可用</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span><span class="hljs-selector-tag">L</span>;  <span class="hljs-comment">// 返回延迟秒数</span>
    }
}
</code></pre>
<p><em>citation:2</em></p>
<h2 data-id="heading-17">7. 测试与验证</h2>
<h3 data-id="heading-18">7.1 单元测试</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@SpringBootTest</span>
<span class="hljs-keyword">@Slf</span>4j
class ReadWriteSeparationTest {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;
    
    <span class="hljs-comment">/**
     * 测试写操作（应该路由到主库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testWriteOperation() {
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("testUser");
        user<span class="hljs-selector-class">.setEmail</span>("test@example.com");
        
        boolean result = userService<span class="hljs-selector-class">.createUser</span>(user);
        
        <span class="hljs-built_in">assertTrue</span>(result);
        log<span class="hljs-selector-class">.info</span>("写操作测试通过，应路由到主库");
    }
    
    <span class="hljs-comment">/**
     * 测试读操作（应该路由到从库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadOperation() {
        User user = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        
        <span class="hljs-built_in">assertNotNull</span>(user);
        log<span class="hljs-selector-class">.info</span>("读操作测试通过，应路由到从库");
    }
    
    <span class="hljs-comment">/**
     * 测试事务内的数据源选择
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testTransactionalOperation() {
        <span class="hljs-comment">// 测试事务方法，应始终使用主库</span>
        User user = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        <span class="hljs-built_in">assertNotNull</span>(user);
        
        log<span class="hljs-selector-class">.info</span>("事务内操作测试完成");
    }
}
</code></pre>
<h3 data-id="heading-19">7.2 验证数据源路由</h3>
<p>在<code>application.yml</code>中开启SQL日志，验证读写分离是否生效：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 开启MyBatis SQL日志</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">com.example.mapper:</span> <span class="hljs-string">debug</span>  <span class="hljs-comment"># Mapper接口的包路径</span>
    <span class="hljs-attr">com.baomidou.dynamic.datasource:</span> <span class="hljs-string">debug</span>  <span class="hljs-comment"># Dynamic-Datasource日志</span>
</code></pre>
<p>观察控制台输出，应该能看到类似日志：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-operator">|</span> Master DataSource  <span class="hljs-operator">|</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> ...
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span> <span class="hljs-operator">|</span> Slave DataSource   <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> ...
</code></pre>
<p><em>citation:3</em></p>
<h2 data-id="heading-20">8. 生产环境注意事项</h2>
<h3 data-id="heading-21">8.1 主从同步延迟处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticalReadService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">/**
     * 对于一致性要求高的读操作，强制走主库
     */</span>
    <span class="hljs-meta">@DS(<span class="hljs-string">"master"</span>)</span>  <span class="hljs-comment">// 强制使用主库，避免读取旧数据</span>
    <span class="hljs-keyword">public</span> User getCriticalUserInfo(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 例如：账户余额、订单状态等关键信息</span>
        <span class="hljs-keyword">return</span> userMapper.selectById(userId);
    }
    
    <span class="hljs-comment">/**
     * 检查数据是否已同步
     */</span>
    <span class="hljs-keyword">public</span> boolean waitForReplication(<span class="hljs-built_in">Long</span> userId, int maxWaitSeconds) {
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; maxWaitSeconds; i++) {
            User masterUser = getFromMaster(userId);
            User slaveUser = getFromSlave(userId);
            
            <span class="hljs-keyword">if</span> (Objects.equals(masterUser, slaveUser)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 数据已同步</span>
            }
            
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 等待1秒</span>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 同步超时</span>
    }
}
</code></pre>
<h3 data-id="heading-22">8.2 监控与告警</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 连接池监控配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">druid:</span>
        <span class="hljs-comment"># 开启监控统计</span>
        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j</span>
        <span class="hljs-attr">web-stat-filter:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">stat-view-servlet:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/druid/*</span>
          <span class="hljs-attr">reset-enable:</span> <span class="hljs-literal">false</span>
          <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span>
          <span class="hljs-attr">login-password:</span> <span class="hljs-string">admin</span>
</code></pre>
<h2 data-id="heading-23">9. 常见问题与解决方案</h2>
<h3 data-id="heading-24">9.1 事务内数据源切换失效</h3>
<p><strong>问题</strong>：在<code>@Transactional</code>方法内，数据源在方法开始时确定，方法内部调用无法切换数据源。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class TransactionalService {
    
    <span class="hljs-variable">@Autowired</span>
    private ApplicationContext applicationContext;
    
    <span class="hljs-variable">@Transactional</span>
    public void <span class="hljs-built_in">transactionalMethod</span>() {
        <span class="hljs-comment">// 方法内需要切换数据源时，通过代理对象调用</span>
        <span class="hljs-selector-tag">TransactionalService</span> <span class="hljs-selector-tag">self</span> = <span class="hljs-selector-tag">applicationContext</span><span class="hljs-selector-class">.getBean</span>(TransactionalService.class);
        
        <span class="hljs-comment">// 通过代理对象调用，可以正常切换数据源</span>
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.readOperation</span>();  <span class="hljs-comment">// 使用从库</span>
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.writeOperation</span>();  <span class="hljs-comment">// 使用主库</span>
    }
    
    @<span class="hljs-selector-tag">DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">readOperation</span>() {
        <span class="hljs-comment">// 读操作</span>
    }
    
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>)
    public void <span class="hljs-built_in">writeOperation</span>() {
        <span class="hljs-comment">// 写操作</span>
    }
}
</code></pre>
<h3 data-id="heading-25">9.2 动态增减数据源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSourceService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">DynamicDataSourceProvider</span> dataSourceProvider;
    
    <span class="hljs-comment">/**
     * 运行时动态添加数据源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceName, DataSourceProperty property</span>) {
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">addDataSource</span>(dataSourceName, property);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"动态添加数据源: {}"</span>, dataSourceName);
    }
    
    <span class="hljs-comment">/**
     * 运行时移除数据源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceName</span>) {
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">removeDataSource</span>(dataSourceName);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"动态移除数据源: {}"</span>, dataSourceName);
    }
}
</code></pre>
<h2 data-id="heading-26">总结</h2>
<p>通过SpringBoot + MyBatis-Plus + Dynamic-Datasource实现读写分离，可以显著提升数据库读性能和高可用性。关键点包括：</p>
<ol>
<li><strong>正确配置</strong>：确保主从数据源配置正确，负载均衡策略合理</li>
<li><strong>合理使用注解</strong>：在适当的方法上使用<code>@DS</code>注解或通过AOP自动切换</li>
<li><strong>事务管理</strong>：注意事务内的数据源行为，关键操作强制走主库</li>
<li><strong>监控告警</strong>：建立完善的监控体系，及时发现主从延迟等问题</li>
<li><strong>故障处理</strong>：实现从库故障自动转移和恢复机制</li>
</ol>
<p>这种架构在读写比例高的应用中能带来显著的性能提升，但也需要处理好主从同步延迟等一致性问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『OpenGL学习滤镜相机』- Day9: CameraX 基础集成]]></title>    <link>https://juejin.cn/post/7571299394345435178</link>    <guid>https://juejin.cn/post/7571299394345435178</guid>    <pubDate>2025-11-11T12:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345435178" data-draft-id="7571102074039238697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『OpenGL学习滤镜相机』- Day9: CameraX 基础集成"/> <meta itemprop="keywords" content="Android,OpenGL"/> <meta itemprop="datePublished" content="2025-11-11T12:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下位子"/> <meta itemprop="url" content="https://juejin.cn/user/2313028193761389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『OpenGL学习滤镜相机』- Day9: CameraX 基础集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028193761389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下位子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T12:16:40.000Z" title="Tue Nov 11 2025 12:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://juejin.cn/post/7567889397497528383" target="_blank" title="https://juejin.cn/post/7567889397497528383">前言: 『OpenGL学习』 从零打造 Android 滤镜相机</a></p>
<p><a href="https://juejin.cn/post/7570534000718495807" target="_blank" title="https://juejin.cn/post/7570534000718495807">上一篇:『OpenGL学习滤镜相机』- Day8: 多重纹理与混合</a></p>
<p>Github: <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest" target="_blank" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest">OpenGLTest</a></p>
<h2 data-id="heading-0">📚 今日目标</h2>
<ul>
<li>理解 CameraX 架构和核心概念</li>
<li>掌握相机权限的申请和处理</li>
<li>学习 PreviewView 的使用</li>
<li>实现相机预览功能</li>
<li>了解生命周期绑定机制</li>
</ul>
<p><strong>运行效果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca3cffb78f4b400aa6640201f07f882b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5L2N5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763468200&amp;x-signature=aRTmiieyDTszq9fB2fam%2BEg6y98%3D" alt="Day9.gif" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 学习内容</h2>
<h3 data-id="heading-2">1. CameraX 简介</h3>
<p><strong>CameraX</strong> 是 Google 推出的 Jetpack 库，用于简化 Android 相机开发。</p>
<h4 data-id="heading-3">为什么使用 CameraX？</h4>

























<table><thead><tr><th>传统 Camera2 API</th><th>CameraX</th></tr></thead><tbody><tr><td>代码复杂，API 繁琐</td><td>简单易用，代码量少</td></tr><tr><td>需要处理设备差异</td><td>自动处理兼容性问题</td></tr><tr><td>生命周期管理困难</td><td>自动绑定生命周期</td></tr><tr><td>预览、拍照、录像需要大量代码</td><td>几行代码即可实现</td></tr></tbody></table>
<h4 data-id="heading-4">CameraX 的优势</h4>
<ul>
<li>✅ <strong>简单易用</strong>：几行代码实现预览和拍照</li>
<li>✅ <strong>兼容性好</strong>：自动处理不同设备的差异</li>
<li>✅ <strong>生命周期感知</strong>：自动管理相机的打开和关闭</li>
<li>✅ <strong>向后兼容</strong>：支持 Android 5.0+（API 21）</li>
<li>✅ <strong>扩展支持</strong>：美颜、夜景、HDR 等厂商扩展</li>
</ul>
<h3 data-id="heading-5">2. CameraX 架构</h3>
<h4 data-id="heading-6">核心组件</h4>
<pre><code class="hljs language-scss" lang="scss">CameraX 架构
├── Use Cases (用例)
│   ├── Preview (预览)
│   ├── ImageCapture (拍照)
│   ├── ImageAnalysis (图像分析)
│   └── VideoCapture (录像)
├── CameraSelector (相机选择器)
│   ├── LENS_FACING_BACK (后置)
│   └── LENS_FACING_FRONT (前置)
├── ProcessCameraProvider (相机提供者)
│   └── 管理相机的生命周期
└── PreviewView (预览视图)
    └── 显示相机预览画面
</code></pre>
<h4 data-id="heading-7">工作流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 获取 ProcessCameraProvider
   ↓
<span class="hljs-bullet">2.</span> 创建 Use Cases (Preview, ImageCapture 等)
   ↓
<span class="hljs-bullet">3.</span> 选择相机 (CameraSelector)
   ↓
<span class="hljs-bullet">4.</span> 绑定到生命周期 (bindToLifecycle)
   ↓
<span class="hljs-bullet">5.</span> 显示预览 / 拍照 / 分析
</code></pre>
<h3 data-id="heading-8">3. 相机权限处理</h3>
<h4 data-id="heading-9">3.1 在 AndroidManifest.xml 中声明权限</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 相机权限（必需） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CAMERA"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 存储权限（拍照保存需要） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>
    <span class="hljs-attr">android:maxSdkVersion</span>=<span class="hljs-string">"28"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 相机特性 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-feature</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.hardware.camera"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-feature</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.hardware.camera.autofocus"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-10">3.2 运行时权限申请（Android 6.0+）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day09Activity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> REQUEST_CODE_PERMISSIONS = <span class="hljs-number">10</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> REQUIRED_PERMISSIONS = arrayOf(Manifest.permission.CAMERA)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// 检查权限</span>
        <span class="hljs-keyword">if</span> (allPermissionsGranted()) {
            startCamera()
        } <span class="hljs-keyword">else</span> {
            ActivityCompat.requestPermissions(
                <span class="hljs-keyword">this</span>, REQUIRED_PERMISSIONS, REQUEST_CODE_PERMISSIONS
            )
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">allPermissionsGranted</span><span class="hljs-params">()</span></span> = REQUIRED_PERMISSIONS.all {
        ContextCompat.checkSelfPermission(
            baseContext, it
        ) == PackageManager.PERMISSION_GRANTED
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onRequestPermissionsResult</span><span class="hljs-params">(
        requestCode: <span class="hljs-type">Int</span>,
        permissions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;,
        grantResults: <span class="hljs-type">IntArray</span>
    )</span></span> {
        <span class="hljs-keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults)
        <span class="hljs-keyword">if</span> (requestCode == REQUEST_CODE_PERMISSIONS) {
            <span class="hljs-keyword">if</span> (allPermissionsGranted()) {
                startCamera()
            } <span class="hljs-keyword">else</span> {
                Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"权限被拒绝"</span>, Toast.LENGTH_SHORT).show()
                finish()
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-11">4. 实现相机预览</h3>
<h4 data-id="heading-12">4.1 布局文件</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>
    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 相机预览视图 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.camera.view.PreviewView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/preview_view"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">app:layout_constraintBottom_toTopOf</span>=<span class="hljs-string">"@id/control_panel"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- 控制面板 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/control_panel"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:background</span>=<span class="hljs-string">"#80000000"</span>
        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>
        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">"16dp"</span>
        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 拍照按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/btn_capture"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"拍照"</span> /&gt;</span>

        <span class="hljs-comment">&lt;!-- 切换相机按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/btn_switch_camera"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">"8dp"</span>
            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"切换相机"</span> /&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">4.2 启动相机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCamera</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 获取 ProcessCameraProvider 的 Future</span>
    <span class="hljs-keyword">val</span> cameraProviderFuture = ProcessCameraProvider.getInstance(<span class="hljs-keyword">this</span>)

    cameraProviderFuture.addListener({
        <span class="hljs-comment">// 获取 CameraProvider</span>
        <span class="hljs-keyword">val</span> cameraProvider: ProcessCameraProvider = cameraProviderFuture.<span class="hljs-keyword">get</span>()

        <span class="hljs-comment">// 创建 Preview Use Case</span>
        <span class="hljs-keyword">val</span> preview = Preview.Builder()
            .build()
            .also {
                <span class="hljs-comment">// 设置 Surface Provider</span>
                it.setSurfaceProvider(previewView.surfaceProvider)
            }

        <span class="hljs-comment">// 选择后置相机</span>
        <span class="hljs-keyword">val</span> cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 解绑之前的 Use Cases</span>
            cameraProvider.unbindAll()

            <span class="hljs-comment">// 绑定 Use Cases 到生命周期</span>
            cameraProvider.bindToLifecycle(
                <span class="hljs-keyword">this</span>,      <span class="hljs-comment">// LifecycleOwner</span>
                cameraSelector,
                preview
            )

        } <span class="hljs-keyword">catch</span> (exc: Exception) {
            Log.e(TAG, <span class="hljs-string">"Use case binding failed"</span>, exc)
        }

    }, ContextCompat.getMainExecutor(<span class="hljs-keyword">this</span>))
}
</code></pre>
<h3 data-id="heading-14">5. CameraSelector 详解</h3>
<h4 data-id="heading-15">5.1 选择前置/后置相机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 后置相机</span>
<span class="hljs-keyword">val</span> backCameraSelector = CameraSelector.DEFAULT_BACK_CAMERA

<span class="hljs-comment">// 前置相机</span>
<span class="hljs-keyword">val</span> frontCameraSelector = CameraSelector.DEFAULT_FRONT_CAMERA

<span class="hljs-comment">// 自定义选择器</span>
<span class="hljs-keyword">val</span> customSelector = CameraSelector.Builder()
    .requireLensFacing(CameraSelector.LENS_FACING_BACK)
    .build()
</code></pre>
<h4 data-id="heading-16">5.2 切换相机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lensFacing = CameraSelector.LENS_FACING_BACK

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 切换前后摄像头</span>
    lensFacing = <span class="hljs-keyword">if</span> (lensFacing == CameraSelector.LENS_FACING_BACK) {
        CameraSelector.LENS_FACING_FRONT
    } <span class="hljs-keyword">else</span> {
        CameraSelector.LENS_FACING_BACK
    }
    
    <span class="hljs-comment">// 重新启动相机</span>
    startCamera()
}
</code></pre>
<h3 data-id="heading-17">6. 拍照功能</h3>
<h4 data-id="heading-18">6.1 创建 ImageCapture Use Case</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建 ImageCapture</span>
imageCapture = ImageCapture.Builder()
    .setCaptureMode(ImageCapture.CAPTURE_MODE_MINIMIZE_LATENCY)
    .build()

<span class="hljs-comment">// 绑定时同时绑定 Preview 和 ImageCapture</span>
cameraProvider.bindToLifecycle(
    <span class="hljs-keyword">this</span>,
    cameraSelector,
    preview,
    imageCapture  <span class="hljs-comment">// 添加拍照功能</span>
)
</code></pre>
<h4 data-id="heading-19">6.2 拍照并保存</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> imageCapture = imageCapture ?: <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 创建保存文件</span>
    <span class="hljs-keyword">val</span> photoFile = File(
        getOutputDirectory(),
        SimpleDateFormat(FILENAME_FORMAT, Locale.US)
            .format(System.currentTimeMillis()) + <span class="hljs-string">".jpg"</span>
    )

    <span class="hljs-comment">// 配置输出选项</span>
    <span class="hljs-keyword">val</span> outputOptions = ImageCapture.OutputFileOptions.Builder(photoFile).build()

    <span class="hljs-comment">// 拍照</span>
    imageCapture.takePicture(
        outputOptions,
        ContextCompat.getMainExecutor(<span class="hljs-keyword">this</span>),
        <span class="hljs-keyword">object</span> : ImageCapture.OnImageSavedCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(exc: <span class="hljs-type">ImageCaptureException</span>)</span></span> {
                Log.e(TAG, <span class="hljs-string">"拍照失败: <span class="hljs-subst">${exc.message}</span>"</span>, exc)
            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onImageSaved</span><span class="hljs-params">(output: <span class="hljs-type">ImageCapture</span>.<span class="hljs-type">OutputFileResults</span>)</span></span> {
                <span class="hljs-keyword">val</span> msg = <span class="hljs-string">"拍照成功: <span class="hljs-subst">${photoFile.absolutePath}</span>"</span>
                Toast.makeText(baseContext, msg, Toast.LENGTH_SHORT).show()
                Log.d(TAG, msg)
            }
        }
    )
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOutputDirectory</span><span class="hljs-params">()</span></span>: File {
    <span class="hljs-keyword">val</span> mediaDir = externalMediaDirs.firstOrNull()?.let {
        File(it, resources.getString(R.string.app_name)).apply { mkdirs() }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (mediaDir != <span class="hljs-literal">null</span> &amp;&amp; mediaDir.exists())
        mediaDir <span class="hljs-keyword">else</span> filesDir
}
</code></pre>
<h3 data-id="heading-20">7. PreviewView 配置</h3>
<h4 data-id="heading-21">7.1 缩放模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 填充整个视图（可能裁剪）</span>
previewView.scaleType = PreviewView.ScaleType.FILL_CENTER

<span class="hljs-comment">// 适应视图大小（可能有黑边）</span>
previewView.scaleType = PreviewView.ScaleType.FIT_CENTER
</code></pre>
<h4 data-id="heading-22">7.2 实现模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 SurfaceView（性能更好）</span>
previewView.implementationMode = PreviewView.ImplementationMode.PERFORMANCE

<span class="hljs-comment">// 使用 TextureView（兼容性更好）</span>
previewView.implementationMode = PreviewView.ImplementationMode.COMPATIBLE
</code></pre>
<h3 data-id="heading-23">8. 生命周期管理</h3>
<p>CameraX 会自动管理相机的生命周期：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CameraX 自动处理</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResume</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onResume()
    <span class="hljs-comment">// 相机自动恢复（如果已绑定）</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPause</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onPause()
    <span class="hljs-comment">// 相机自动暂停</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onDestroy()
    <span class="hljs-comment">// 相机自动释放</span>
}
</code></pre>
<p><strong>注意</strong>：使用 <code>bindToLifecycle()</code> 时，CameraX 会自动处理相机的打开、关闭和暂停。</p>
<h3 data-id="heading-24">9. 相机配置选项</h3>
<h4 data-id="heading-25">9.1 分辨率配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetResolution(Size(<span class="hljs-number">1280</span>, <span class="hljs-number">720</span>))  <span class="hljs-comment">// 设置目标分辨率</span>
    .build()
</code></pre>
<h4 data-id="heading-26">9.2 宽高比配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetAspectRatio(AspectRatio.RATIO_16_9)  <span class="hljs-comment">// 16:9</span>
    .build()
</code></pre>
<h4 data-id="heading-27">9.3 旋转配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetRotation(Surface.ROTATION_0)  <span class="hljs-comment">// 设置目标旋转角度</span>
    .build()
</code></pre>
<h3 data-id="heading-28">10. 错误处理</h3>
<h4 data-id="heading-29">10.1 常见错误</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">try</span> {
    cameraProvider.bindToLifecycle(<span class="hljs-keyword">this</span>, cameraSelector, preview)
} <span class="hljs-keyword">catch</span> (exc: Exception) {
    <span class="hljs-keyword">when</span> (exc) {
        <span class="hljs-keyword">is</span> CameraInfoUnavailableException -&gt; {
            Log.e(TAG, <span class="hljs-string">"相机信息不可用"</span>)
        }
        <span class="hljs-keyword">is</span> IllegalArgumentException -&gt; {
            Log.e(TAG, <span class="hljs-string">"Use Case 绑定参数错误"</span>)
        }
        <span class="hljs-keyword">else</span> -&gt; {
            Log.e(TAG, <span class="hljs-string">"Use Case 绑定失败"</span>, exc)
        }
    }
}
</code></pre>
<h4 data-id="heading-30">10.2 检查相机可用性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasCameraPermission</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> ContextCompat.checkSelfPermission(
        <span class="hljs-keyword">this</span>,
        Manifest.permission.CAMERA
    ) == PackageManager.PERMISSION_GRANTED
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasCamera</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> packageManager.hasSystemFeature(PackageManager.FEATURE_CAMERA_ANY)
}
</code></pre>
<h2 data-id="heading-31">💻 代码实践</h2>
<h3 data-id="heading-32">今日任务</h3>
<p>实现一个简单的相机预览应用：</p>
<ol>
<li><strong>权限申请</strong>：请求相机权限</li>
<li><strong>相机预览</strong>：使用 PreviewView 显示实时画面</li>
<li><strong>拍照功能</strong>：点击按钮拍照并保存</li>
<li><strong>切换相机</strong>：前置/后置相机切换</li>
</ol>
<h3 data-id="heading-33">实现效果</h3>
<ul>
<li>📷 实时相机预览</li>
<li>📸 拍照并保存到相册</li>
<li>🔄 前后摄像头切换</li>
<li>⚙️ 自动处理生命周期</li>
</ul>
<h3 data-id="heading-34">核心代码结构</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day09Activity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> previewView: PreviewView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> imageCapture: ImageCapture? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lensFacing = CameraSelector.LENS_FACING_BACK

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_day09)

        previewView = findViewById(R.id.preview_view)

        <span class="hljs-comment">// 检查权限</span>
        <span class="hljs-keyword">if</span> (allPermissionsGranted()) {
            startCamera()
        } <span class="hljs-keyword">else</span> {
            requestPermissions()
        }

        <span class="hljs-comment">// 拍照按钮</span>
        findViewById&lt;Button&gt;(R.id.btn_capture).setOnClickListener {
            takePhoto()
        }

        <span class="hljs-comment">// 切换相机按钮</span>
        findViewById&lt;Button&gt;(R.id.btn_switch_camera).setOnClickListener {
            switchCamera()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCamera</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 实现相机启动逻辑</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 实现拍照逻辑</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 实现切换相机逻辑</span>
    }
}
</code></pre>
<h2 data-id="heading-35">🧪 练习任务</h2>
<h3 data-id="heading-36">基础任务</h3>
<ol>
<li>✅ 实现相机权限申请</li>
<li>✅ 实现相机预览功能</li>
<li>✅ 实现拍照并保存到相册</li>
</ol>
<h3 data-id="heading-37">进阶任务</h3>
<ol>
<li>📊 显示拍照成功的缩略图</li>
<li>🎨 添加拍照动画效果（闪光）</li>
<li>📏 支持捏合缩放（Pinch to Zoom）</li>
<li>🔦 添加闪光灯控制</li>
</ol>
<h3 data-id="heading-38">挑战任务</h3>
<ol>
<li>🎬 实现录像功能（VideoCapture）</li>
<li>📐 添加网格线辅助构图</li>
<li>💾 实现连拍功能</li>
<li>🖼️ 支持不同宽高比切换（4:3, 16:9, 1:1）</li>
</ol>
<h2 data-id="heading-39">📖 知识点总结</h2>
<h3 data-id="heading-40">CameraX 核心概念</h3>





























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>Use Case</strong></td><td>相机的使用场景（预览、拍照、分析、录像）</td></tr><tr><td><strong>CameraSelector</strong></td><td>选择使用哪个相机（前置/后置）</td></tr><tr><td><strong>ProcessCameraProvider</strong></td><td>管理相机生命周期的提供者</td></tr><tr><td><strong>PreviewView</strong></td><td>显示相机预览的视图</td></tr><tr><td><strong>LifecycleOwner</strong></td><td>生命周期拥有者（通常是 Activity）</td></tr></tbody></table>
<h3 data-id="heading-41">Use Cases 对比</h3>






























<table><thead><tr><th>Use Case</th><th>用途</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Preview</strong></td><td>实时预览</td><td>相机取景</td></tr><tr><td><strong>ImageCapture</strong></td><td>拍照</td><td>拍摄照片</td></tr><tr><td><strong>ImageAnalysis</strong></td><td>图像分析</td><td>二维码扫描、人脸识别</td></tr><tr><td><strong>VideoCapture</strong></td><td>录像</td><td>录制视频</td></tr></tbody></table>
<h3 data-id="heading-42">最佳实践</h3>
<ol>
<li>✅ <strong>使用 bindToLifecycle()</strong>：自动管理相机生命周期</li>
<li>✅ <strong>在主线程使用 CameraX API</strong>：避免线程问题</li>
<li>✅ <strong>复用 CameraProvider</strong>：不要频繁获取</li>
<li>✅ <strong>处理配置变更</strong>：屏幕旋转时正确更新</li>
<li>✅ <strong>及时解绑 Use Cases</strong>：切换相机前调用 <code>unbindAll()</code></li>
</ol>
<h2 data-id="heading-43">🐛 常见问题</h2>
<h3 data-id="heading-44">Q1: 相机预览画面是黑色的？</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>权限未授予</li>
<li>PreviewView 未正确设置 SurfaceProvider</li>
<li>Use Case 未绑定到生命周期</li>
</ol>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 确认权限已授予</span>
<span class="hljs-keyword">if</span> (!allPermissionsGranted()) {
    requestPermissions()
    <span class="hljs-keyword">return</span>
}

<span class="hljs-comment">// 2. 正确设置 SurfaceProvider</span>
preview.setSurfaceProvider(previewView.surfaceProvider)

<span class="hljs-comment">// 3. 确保绑定到生命周期</span>
cameraProvider.bindToLifecycle(<span class="hljs-keyword">this</span>, cameraSelector, preview)
</code></pre>
<h3 data-id="heading-45">Q2: 应用崩溃，提示 "Camera is being used"？</h3>
<p><strong>原因</strong>：同一个相机被多次绑定。</p>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 绑定前先解绑所有 Use Cases</span>
cameraProvider.unbindAll()
cameraProvider.bindToLifecycle(<span class="hljs-keyword">this</span>, cameraSelector, preview)
</code></pre>
<h3 data-id="heading-46">Q3: 切换前后相机时闪烁？</h3>
<p><strong>原因</strong>：切换时没有正确处理。</p>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
    lensFacing = <span class="hljs-keyword">if</span> (lensFacing == CameraSelector.LENS_FACING_BACK) {
        CameraSelector.LENS_FACING_FRONT
    } <span class="hljs-keyword">else</span> {
        CameraSelector.LENS_FACING_BACK
    }
    
    <span class="hljs-comment">// 重新启动相机（会自动解绑旧的）</span>
    startCamera()
}
</code></pre>
<h3 data-id="heading-47">Q4: 拍照的图片方向不对？</h3>
<p>CameraX 会自动处理图片旋转，但如果遇到问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> imageCapture = ImageCapture.Builder()
    .setTargetRotation(previewView.display.rotation)  <span class="hljs-comment">// 设置旋转角度</span>
    .build()
</code></pre>
<h2 data-id="heading-48">🔗 参考资料</h2>
<h3 data-id="heading-49">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fcamerax" target="_blank" title="https://developer.android.com/training/camerax" ref="nofollow noopener noreferrer">CameraX 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fcamerax%2Farchitecture" target="_blank" title="https://developer.android.com/training/camerax/architecture" ref="nofollow noopener noreferrer">CameraX 架构</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fcamerax%2Fbest-practices" target="_blank" title="https://developer.android.com/training/camerax/best-practices" ref="nofollow noopener noreferrer">CameraX 最佳实践</a></li>
</ul>
<h3 data-id="heading-50">示例代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcamera-samples" target="_blank" title="https://github.com/android/camera-samples" ref="nofollow noopener noreferrer">CameraX 官方示例</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodelabs.developers.google.com%2Fcodelabs%2Fcamerax-getting-started" target="_blank" title="https://codelabs.developers.google.com/codelabs/camerax-getting-started" ref="nofollow noopener noreferrer">Google Codelabs - CameraX</a></li>
</ul>
<h3 data-id="heading-51">相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fpermissions%2Frequesting" target="_blank" title="https://developer.android.com/training/permissions/requesting" ref="nofollow noopener noreferrer">Android 相机权限处理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Fcamera%2Fview%2FPreviewView" target="_blank" title="https://developer.android.com/reference/androidx/camera/view/PreviewView" ref="nofollow noopener noreferrer">PreviewView API 文档</a></li>
</ul>
<h2 data-id="heading-52">📝 今日总结</h2>
<p>今天我们学习了 CameraX 的基础知识：</p>
<ol>
<li>✅ 理解了 CameraX 的架构和核心概念</li>
<li>✅ 掌握了相机权限的申请和处理</li>
<li>✅ 学会了使用 PreviewView 显示相机预览</li>
<li>✅ 实现了拍照和保存功能</li>
<li>✅ 了解了生命周期管理机制</li>
</ol>
<p><strong>关键要点</strong>：</p>
<ul>
<li>CameraX 简化了相机开发，自动处理兼容性问题</li>
<li>Use Cases 是 CameraX 的核心，代表不同的使用场景</li>
<li><code>bindToLifecycle()</code> 会自动管理相机的生命周期</li>
<li>PreviewView 提供了简单易用的预览功能</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">下一篇</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端渲染大体积 多页面pdf]]></title>    <link>https://juejin.cn/post/7571278865517051954</link>    <guid>https://juejin.cn/post/7571278865517051954</guid>    <pubDate>2025-11-11T10:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865517051954" data-draft-id="7571279513246695450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端渲染大体积 多页面pdf"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无名小兵"/> <meta itemprop="url" content="https://juejin.cn/user/1772869560048312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端渲染大体积 多页面pdf
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772869560048312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无名小兵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:41:35.000Z" title="Tue Nov 11 2025 10:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">示例</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d690d584981a40688984f792c5da578b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5ZCN5bCP5YW1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462494&amp;x-signature=QTyb7S2hwoUVMbcoGkON1dlt8uM%3D" alt="20251111183906_rec_.gif" loading="lazy"/></p>
<h2 data-id="heading-1">介绍</h2>
<p>首先使用的是 vue-pdf-embed渲染pdf，前段时间测试测出一个bug，当pdf文档页码过多(500页，7M)时，会出现页面卡死现象。首先尝试使用loading解决，css position解决，worker但是无济于事。然后开始研究vue-pdf-embed，发现内部是基于的pdfjs封装了一层，vue-pdf-embed内容是一次性渲染全部pdf。其实也是可以使用翻页的方式，那么就是一页一页的渲染，不会同时渲染很多页pdf。</p>
<h2 data-id="heading-2">技术栈</h2>
<p>vue3 pdfjs</p>
<h2 data-id="heading-3">解决方案</h2>
<p>有一个重要的点是：pdfjs 可以获取到pdf的总页数，以及每一页的pdf的高度。那么先使用一个div撑起父容器，然后滚动父容器，根据scrollTop/pdfHeight 获取到当前视口该展示哪一页 currentPage。</p>
<p>要解决的问题：<strong>向下滚动(相对简单)，向上滚动，快速下拉，快速上拉</strong>。</p>
<p>以下有5种方案，为什么会有这么多种方案呢，都是做着做着 发现更好的方案，以及一些pdfjs的限制问题。最终方案是最后2种。</p>
<ol>
<li>1个canvas渲染，分别渲染前一张pdf的上半部分和后一张pdf的下半部分（放弃，pdfjs不允许使用同一个canvas重复渲染）</li>
<li>2个canvas渲染，例如先绘制第1页和第1页，然后currentPage到2的时候 删除2个canvas，第1个canvas绘制第2页，第2个canvas绘制第3页。以此类推。（放弃每次切换页数的时候，页面都会一闪一闪的）</li>
<li>多个canvas  弊端 向上滚动一页 全部要重新绘制</li>
<li>每滚动一页 将最上面的canvas删除 在最后面添加新的canvas，其中还有边界值需要处理，比如pdf本来就只有1页，pdf 到最后一页和首页。</li>
<li>维护一个数组 数组长度为3（或者5），数组中的每个值对应pageindex,currentPage变化后，更新数组，然后和dom对比，做diff操作。</li>
</ol>
<p>方案5的好处，无须考虑那么多其他的,第4种方案还要解决快速拉动的问题。每次切换pageIndex,前面的canvas被删除掉了(其实不做删除操作也是可以的，因为每个canvas所在的位置是固定的，且不会重叠)，后面的canvas新增了，不会让用户看见一闪的现象。</p>
<h2 data-id="heading-4">全部代码</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  &lt;!-- <span class="hljs-title class_">Canvas</span> 显示区域 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"canvas-container"</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"canvasContainer"</span>
    @<span class="hljs-attr">scroll.passive</span>=<span class="hljs-string">"handleScroll"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ overflow: 'auto' }"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mark"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: totalHeight + 'px' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> pdfjsLib <span class="hljs-keyword">from</span> <span class="hljs-string">"pdfjs-dist/build/pdf"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PdfWorker</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"pdfjs-dist/build/pdf.worker.mjs?url"</span>;

<span class="hljs-keyword">import</span> { onMounted, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
pdfjsLib.<span class="hljs-property">GlobalWorkerOptions</span>.<span class="hljs-property">workerSrc</span> = <span class="hljs-title class_">PdfWorker</span>; <span class="hljs-comment">// 使用woker</span>

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">url</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">""</span>,
  },

});
<span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 总高度</span>
<span class="hljs-keyword">const</span> totalPages = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 总页码</span>
<span class="hljs-keyword">const</span> pageHeight = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 一页高度</span>
<span class="hljs-keyword">let</span> currentPage = <span class="hljs-number">1</span>; <span class="hljs-comment">// 当前page</span>
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">let</span> pdfDoc = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不能使用ref  会报错</span>
<span class="hljs-keyword">let</span> renderIndex = <span class="hljs-number">0</span>;
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props.<span class="hljs-property">url</span>, <span class="hljs-string">"props.url"</span>);
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">url</span>) {
    <span class="hljs-title function_">loadPdf</span>(props.<span class="hljs-property">url</span>, renderIndex);
  }
});

<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">url</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (canvasContainer.<span class="hljs-property">value</span>) {
      canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> canvases = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">"canvas"</span>);
      canvases.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(item);
      });
    }
    <span class="hljs-keyword">if</span> (newVal) {
      <span class="hljs-comment">// console.log("newVal", newVal);</span>
      renderIndex++;
      currentPage = <span class="hljs-number">1</span>;
      allCanvasIndex = [];
      <span class="hljs-title function_">loadPdf</span>(newVal, renderIndex);
    }
  }
);
<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">"error"</span>]);
<span class="hljs-keyword">const</span> canvasContainer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">let</span> allCanvas = [];
<span class="hljs-keyword">let</span> allCanvasIndex = [];
<span class="hljs-comment">// 一次性渲染多少张pdf</span>
<span class="hljs-keyword">let</span> canvasMaxNum = <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
<span class="hljs-keyword">let</span> t = <span class="hljs-number">0</span>;

<span class="hljs-keyword">let</span> lastScrollTop = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> renderPartialIndex = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentIndexs</span>(<span class="hljs-params">nindex</span>) {
  <span class="hljs-keyword">let</span> currentIndexs = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; canvasMaxNum; i++) {
    <span class="hljs-keyword">if</span> (nindex + i &lt;= totalPages.<span class="hljs-property">value</span>) {
      currentIndexs.<span class="hljs-title function_">push</span>(nindex + i);
    }
  }
  <span class="hljs-keyword">return</span> currentIndexs;
}
<span class="hljs-comment">// 新增单个canvas</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addCanvas</span>(<span class="hljs-params">npageIndex</span>) {
  <span class="hljs-keyword">let</span> ncanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
  ncanvas.<span class="hljs-property">classList</span> = [<span class="hljs-string">"canvasshow"</span>];
  canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(ncanvas);

  ncanvas.<span class="hljs-property">id</span> = <span class="hljs-string">"topCanvas"</span> + npageIndex;
  ncanvas.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${pageHeight.value * (npageIndex - <span class="hljs-number">1</span>)}</span>px`</span>;
  <span class="hljs-title function_">renderPartialA</span>(pdfDoc, npageIndex, ncanvas);
}
<span class="hljs-comment">//监听滚动</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-comment">// console.log(e,'eee');</span>
  
  <span class="hljs-keyword">const</span> canvasContainer0 = e.<span class="hljs-property">target</span>;
  <span class="hljs-keyword">const</span> scrollTop = canvasContainer0.<span class="hljs-property">scrollTop</span>;
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"scroll"</span>, scrollTop);
  <span class="hljs-built_in">clearTimeout</span>(t);
  <span class="hljs-comment">// 防抖</span>
  t = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (totalPages.<span class="hljs-property">value</span> &lt;= canvasMaxNum) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">let</span> page = scrollTop / pageHeight.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">let</span> npage = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, page)); <span class="hljs-comment">// 当前视图</span>

    <span class="hljs-keyword">if</span> (npage != currentPage) {
    <span class="hljs-comment">// 获取视图应该展示的pageIndex</span>
      <span class="hljs-keyword">let</span> currentIndexs = <span class="hljs-title function_">getCurrentIndexs</span>(npage);
      currentIndexs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!allCanvasIndex.<span class="hljs-title function_">includes</span>(item)) {
          <span class="hljs-keyword">if</span> (item &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_">addCanvas</span>(item);
          }
        }
      });
      <span class="hljs-comment">//移除操作</span>
      allCanvasIndex.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!currentIndexs.<span class="hljs-title function_">includes</span>(item)) {
          <span class="hljs-keyword">let</span> canvas = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#topCanvas"</span> + item);
          <span class="hljs-keyword">if</span> (canvas) {
            canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(canvas);
          }
        }
      });
      allCanvasIndex = currentIndexs;
    }
    currentPage = npage;
  },<span class="hljs-number">50</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPdf</span>(<span class="hljs-params">url, renderIndex1</span>) {
  <span class="hljs-comment">//   if (!url) return;</span>
  <span class="hljs-keyword">try</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

    pdfDoc = <span class="hljs-keyword">await</span> pdfjsLib.<span class="hljs-title function_">getDocument</span>({ <span class="hljs-attr">url</span>: url }).<span class="hljs-property">promise</span>;
    <span class="hljs-keyword">if</span> (renderIndex1 !== renderIndex) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// this.pdfDoc=pdfDoc</span>
    totalPages.<span class="hljs-property">value</span> = pdfDoc.<span class="hljs-property">numPages</span>;
    <span class="hljs-comment">// 先渲染全部或者canvasMaxNum</span>
    allCanvas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(totalPages.<span class="hljs-property">value</span>, canvasMaxNum))
      .<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-comment">// 维护allCanvasIndex</span>
        allCanvasIndex.<span class="hljs-title function_">push</span>(index + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">let</span> ncanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
        ncanvas.<span class="hljs-property">id</span> = <span class="hljs-string">"topCanvas"</span> + (index + <span class="hljs-number">1</span>);
        ncanvas.<span class="hljs-property">classList</span> = [<span class="hljs-string">"canvasshow"</span>];
        <span class="hljs-keyword">return</span> ncanvas;
      });
    renderPartialIndex++;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderPartial</span>(pdfDoc, <span class="hljs-literal">true</span>, renderPartialIndex);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"PDF 加载失败:"</span>, error);
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">"error"</span>, error);
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
}
<span class="hljs-keyword">let</span> scale0=<span class="hljs-number">1</span>
<span class="hljs-comment">// 绘制单个pdf页</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartialA</span>(<span class="hljs-params">pdfDoc, pageIndex, canvas</span>) {
  <span class="hljs-keyword">if</span> (!pdfDoc) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">getPage</span>(pageIndex);

    <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale0 });

    <span class="hljs-keyword">const</span> fullWidth = viewport.<span class="hljs-property">width</span>;
    <span class="hljs-keyword">const</span> fullHeight = viewport.<span class="hljs-property">height</span>;


           canvas.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = fullWidth
        canvas.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = fullHeight
           canvas.<span class="hljs-property">width</span> = fullWidth
        canvas.<span class="hljs-property">height</span> = fullHeight
    <span class="hljs-title function_">renderPartialArea</span>(page, clipParamsTop, canvas);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">//  Cannot read private member #pagePromises from an object whose class did not declare it</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"渲染失败:"</span>, error);
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getPageDimensions</span> = (<span class="hljs-params">ratio</span>) =&gt; {
  <span class="hljs-keyword">let</span> width
  <span class="hljs-keyword">let</span> height

  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">height</span> &amp;&amp; !props.<span class="hljs-property">width</span>) {
    height = props.<span class="hljs-property">height</span>
    width = height / ratio
  } <span class="hljs-keyword">else</span> {
    width = props.<span class="hljs-property">width</span> ?? canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>
    height = width * ratio
  }

  <span class="hljs-keyword">return</span> [width, height]
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartial</span>(<span class="hljs-params">pdfDoc, init, renderPartialIndex1</span>) {
  <span class="hljs-keyword">if</span> (!pdfDoc) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> ps = allCanvas.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> pdfDoc.<span class="hljs-title function_">getPage</span>(<span class="hljs-number">1</span> + index);
    });
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ps).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pages</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (renderPartialIndex1 !== renderPartialIndex) {
        <span class="hljs-keyword">return</span>; 
      }
      <span class="hljs-keyword">let</span> page = pages[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">let</span> w = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>;
          <span class="hljs-keyword">const</span> viewWidth = page.<span class="hljs-property">view</span>[<span class="hljs-number">2</span>] - page.<span class="hljs-property">view</span>[<span class="hljs-number">0</span>]
           <span class="hljs-keyword">const</span> viewHeight = page.<span class="hljs-property">view</span>[<span class="hljs-number">3</span>] - page.<span class="hljs-property">view</span>[<span class="hljs-number">1</span>]
          <span class="hljs-keyword">let</span> isTransposed=<span class="hljs-literal">false</span>  
           <span class="hljs-keyword">const</span> pageWidth = isTransposed ? viewHeight : viewWidth
            <span class="hljs-keyword">const</span> [actualWidth, actualHeight] = <span class="hljs-title function_">getPageDimensions</span>(
          isTransposed ? viewWidth / viewHeight : viewHeight / viewWidth
        )
    <span class="hljs-keyword">let</span> scale=actualWidth  * <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>/ pageWidth
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(scale,<span class="hljs-string">'scale'</span>);
      scale0=scale
      <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale});
      <span class="hljs-keyword">const</span> fullWidth = viewport.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> fullHeight = viewport.<span class="hljs-property">height</span>;
      pageHeight.<span class="hljs-property">value</span> = (fullHeight * (w - <span class="hljs-number">10</span>)) / fullWidth;
      totalHeight.<span class="hljs-property">value</span> = totalPages.<span class="hljs-property">value</span> * pageHeight.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">if</span> (init) {
        allCanvas.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
            item.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">0</span>}</span>px`</span>;
          } <span class="hljs-keyword">else</span> {
            item.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${pageHeight.value * index}</span>px`</span>;
          }
          canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(item);
        });
      }

      <span class="hljs-comment">// 根据预设计算裁剪参数</span>
 

      pages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">page, index</span>) =&gt;</span> {
          allCanvas[index].<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = fullWidth
        allCanvas[index].<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = fullHeight
          allCanvas[index].<span class="hljs-property">width</span> = fullWidth
        allCanvas[index].<span class="hljs-property">height</span> = fullHeight
        <span class="hljs-title function_">renderPartialArea</span>(page, clipParamsTop, allCanvas[index]);
      });
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">//  Cannot read private member #pagePromises from an object whose class did not declare it</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"渲染失败:"</span>, error);
  }
}

<span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartialArea</span>(<span class="hljs-params">page, clipParams, canvas</span>) {
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);

  <span class="hljs-keyword">const</span> { clipX, clipY, clipWidth, clipHeight } = clipParams;
  
  <span class="hljs-keyword">const</span> partialViewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale0 }).<span class="hljs-title function_">clone</span>({
    <span class="hljs-attr">scale</span>: scale0,
  });

  <span class="hljs-comment">// 应用裁剪和渲染</span>
  ctx.<span class="hljs-title function_">save</span>();
  ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

  <span class="hljs-keyword">const</span> renderContext = {
    <span class="hljs-attr">canvasContext</span>: ctx,
    <span class="hljs-attr">viewport</span>: partialViewport,
  };

  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">render</span>(renderContext).<span class="hljs-property">promise</span>;
  ctx.<span class="hljs-title function_">restore</span>();
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.canvasshow</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.partial-pdf-viewer</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-comment">/* border-radius: 8px; */</span>
  <span class="hljs-comment">/* padding: 16px; */</span>
}

<span class="hljs-selector-class">.control-panel</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.control-group</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.clip-controls</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.clip-controls</span> &gt; <span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"number"</span>]</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.canvas-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">background</span>: white;
}
<span class="hljs-selector-class">.canvas-container</span>::-webkit-scrollbar {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.canvas-container</span>::-webkit-scrollbar-thumb {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#c1c1c1</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}
<span class="hljs-selector-class">.mark</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">10</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
}
<span class="hljs-selector-tag">canvas</span> {
  <span class="hljs-attribute">display</span>: block;
}

<span class="hljs-selector-class">.loading</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.info-panel</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f0f0</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战]]></title>    <link>https://juejin.cn/post/7570271574348447753</link>    <guid>https://juejin.cn/post/7570271574348447753</guid>    <pubDate>2025-11-10T00:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348447753" data-draft-id="7554198278955712538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-10T00:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:30:22.000Z" title="Mon Nov 10 2025 00:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么 Swift 5.7 再次“颠覆”协议</h2>
<p>在 Swift 5.7 之前，带关联类型的协议只能当约束 <code>&lt;T: Sequence&gt;</code>，不能当类型 <code>Sequence</code>。</p>
<p>这导致两个老大难：</p>
<ol>
<li>声明变量/参数/返回值时，必须再包一层类型擦除（<code>AnySequence&lt;Int&gt;</code>）。</li>
<li>泛型函数无法“一眼看出”序列里到底是什么元素。</li>
</ol>
<p>Swift 5.7 一次性给出三把新钥匙：</p>

























<table><thead><tr><th>特性</th><th>关键词</th><th>解决痛点</th></tr></thead><tbody><tr><td>主要关联类型</td><td><code>protocol Sequence&lt;Element&gt;</code></td><td>把最常用的关联类型“提级”到协议名上</td></tr><tr><td>不透明参数</td><td><code>some Sequence&lt;Int&gt;</code></td><td>直接当参数类型，编译期确定，零运行时开销</td></tr><tr><td>存在性类型</td><td><code>any Sequence&lt;Int&gt;</code></td><td>真·变量类型，运行时盒子，语法终于可读</td></tr></tbody></table>
<h2 data-id="heading-1">Primary Associated Type：把“泛型参数”搬到协议头上</h2>
<ol>
<li>标准库示例</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Swift 5.7 标准库定义</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Sequence</span>&lt;<span class="hljs-title class_">Element</span>&gt; {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Iterator</span>: <span class="hljs-type">IteratorProtocol</span> <span class="hljs-keyword">where</span> <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span>
}
</code></pre>
<p><code>Element</code> 被写到协议名后面，成为主要关联类型。</p>
<p>于是我们可以像泛型结构体一样，直接写：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">sum</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">numbers</span>: <span class="hljs-keyword">some</span> <span class="hljs-type">Sequence</span>&lt;<span class="hljs-type">Int</span>&gt;) -&gt; <span class="hljs-type">Int</span> {   <span class="hljs-comment">// ① 参数类型</span>
    numbers.reduce(<span class="hljs-number">0</span>, <span class="hljs-operator">+</span>)
}

<span class="hljs-keyword">let</span> total <span class="hljs-operator">=</span> sum([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-operator">+</span> [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])            <span class="hljs-comment">// ② 数组拼接也适用</span>
</code></pre>
<ol start="2">
<li>为自己协议添加“主关联类型”</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span>&lt;<span class="hljs-title class_">Element</span>&gt; {          <span class="hljs-comment">// ① 把最常用的关联类型提出来</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IteratorFeed</span>: <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Int</span>? {
        <span class="hljs-keyword">let</span> next <span class="hljs-operator">=</span> a
        a <span class="hljs-operator">=</span> b
        b <span class="hljs-operator">=</span> next <span class="hljs-operator">+</span> a
        <span class="hljs-keyword">return</span> next
    }
}

<span class="hljs-comment">// ② 立刻享受 some/any 语法</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIntFeed</span>() -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt; {
    <span class="hljs-type">IteratorFeed</span>()
}

<span class="hljs-keyword">var</span> feeds: [<span class="hljs-keyword">any</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt;] <span class="hljs-operator">=</span> []   <span class="hljs-comment">// ③ 数组里放不同实现，无需再包 AnyFeed</span>
</code></pre>
<p>规则</p>
<ul>
<li>只能把一个或多个 <code>associatedtype</code> 声明为“主要”，不强制全部。</li>
<li>主要关联类型顺序不影响使用，但建议按“常用度”排序。</li>
<li>一旦声明，协议就获得“泛型形参”资格，可直接写 <code>Feed&lt;Int&gt;</code>。</li>
</ul>
<h2 data-id="heading-2">some vs. any：一句话区分</h2>



































<table><thead><tr><th>维度</th><th><code>some P</code></th><th><code>any P</code></th></tr></thead><tbody><tr><td>语义</td><td>编译期确定的<strong>某个</strong>具体类型</td><td>运行时存在的<strong>任何</strong>具体类型</td></tr><tr><td>内存布局</td><td>无间接寻址，内联存储</td><td>存在性容器（Box），通过指针引用</td></tr><tr><td>主要用法</td><td>返回值、泛型约束</td><td>变量、集合元素、函数参数</td></tr><tr><td>性能</td><td>零额外开销</td><td>轻微运行时开销（Box管理）</td></tr><tr><td>使用限制</td><td>不能用于<code>var</code>/集合类型声明</td><td>无显式限制</td></tr></tbody></table>
<p>示例对比</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span>&lt;<span class="hljs-title class_">Element</span>&gt; {          <span class="hljs-comment">// ① 把最常用的关联类型提出来</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IteratorFeed</span>&lt;<span class="hljs-title class_">Iterator</span>: <span class="hljs-title class_">IteratorProtocol</span>&gt;: <span class="hljs-title class_">Feed</span>  {
    <span class="hljs-keyword">var</span> iterator: <span class="hljs-type">Iterator</span>
    <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">iterator</span>: <span class="hljs-type">Iterator</span>) {
        <span class="hljs-keyword">self</span>.iterator <span class="hljs-operator">=</span> iterator
    }
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span>? {
        iterator.next()
    }
}

<span class="hljs-comment">// 1. 返回值：编译期就知道真实类型</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">uniqueElements</span>&lt;<span class="hljs-type">S</span>: <span class="hljs-type">Sequence</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">seq</span>: <span class="hljs-type">S</span>) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Sequence</span>&lt;<span class="hljs-type">S</span>.<span class="hljs-type">Element</span>&gt;
<span class="hljs-keyword">where</span> <span class="hljs-type">S</span>.<span class="hljs-type">Element</span>: <span class="hljs-type">Hashable</span> &amp; <span class="hljs-type">Comparable</span> {
    <span class="hljs-type">Set</span>(seq).sorted()
}

<span class="hljs-comment">// 2. 数组：运行期才知道真实类型</span>
<span class="hljs-keyword">var</span> parsers: [<span class="hljs-keyword">any</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt;] <span class="hljs-operator">=</span> [
    <span class="hljs-type">IteratorFeed</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].makeIterator()),
    <span class="hljs-type">IteratorFeed</span>(<span class="hljs-built_in">stride</span>(from: <span class="hljs-number">0</span>, to: <span class="hljs-number">10</span>, by: <span class="hljs-number">2</span>).makeIterator())
]
</code></pre>
<h2 data-id="heading-3">实战：一行代码写“泛型” SwiftUI View</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Charts

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChartView</span>&lt;<span class="hljs-title class_">Data</span>: <span class="hljs-title class_">RandomAccessCollection</span>&gt;: <span class="hljs-title class_">View</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Data</span>.<span class="hljs-title class_">Element</span> == <span class="hljs-title class_">Double</span> {
    <span class="hljs-keyword">let</span> data: <span class="hljs-type">Data</span>
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-comment">// 老写法：调用方必须写冗长泛型参数</span>
    }
}

<span class="hljs-comment">// ✅ 新写法：直接不透明返回，调用方无感知</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeChart</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-keyword">some</span> <span class="hljs-type">RandomAccessCollection</span>&lt;<span class="hljs-type">Double</span>&gt;) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
    
    <span class="hljs-type">Chart</span> {
        <span class="hljs-type">ForEach</span>(data.enumerated(), id: \.offset) { idx,value <span class="hljs-keyword">in</span>
            <span class="hljs-type">LineMark</span>(x: .value(<span class="hljs-string">"x"</span>, idx), y: .value(<span class="hljs-string">"y"</span>, value))
        }
    }
}
</code></pre>
<h2 data-id="heading-4">迁移旧代码：把 AnySequence 换成 any Sequence</h2>





















<table><thead><tr><th>旧代码</th><th>新代码</th></tr></thead><tbody><tr><td><code>AnySequence&lt;Int&gt;</code></td><td><code>any Sequence&lt;Int&gt;</code></td></tr><tr><td><code>AnyPublisher&lt;Int, Never&gt;</code></td><td><code>any Publisher&lt;Int, Never&gt;</code></td></tr><tr><td><code>AnyView</code></td><td><code>any View</code>（iOS 17+ 可用，仍需权衡性能）</td></tr></tbody></table>
<p>步骤</p>
<ol>
<li>在协议名后加 <code>&lt;Element&gt;</code>。</li>
<li>把 <code>eraseToAnyPublisher()</code> / <code>AnySequence(...)</code> 改成 <code>any Sequence&lt;Int&gt;</code>。</li>
<li>若返回值无需运行时多态，直接用 <code>some Sequence&lt;Int&gt;</code> 获得零开销。</li>
</ol>
<h2 data-id="heading-5">性能与二进制大小小贴士</h2>
<ul>
<li><code>some P&lt;T&gt;</code> 完全静态派发，零额外内存。</li>
<li><code>any P&lt;T&gt;</code> 引入存在性容器，16 字节 inline + 外挂堆（若值过大）。</li>
<li>滥用 <code>any</code> 会让二进制出现大量“协议见证表”，release 模式下编译器会优化，但debug 增量编译可能变慢。</li>
<li>对 SwiftUI <code>body</code> 这种超高频调用，优先 <code>some View</code>；只在需要运行时异构数组时才用 <code>any View</code>。</li>
</ul>
<h2 data-id="heading-6">总结</h2>

























<table><thead><tr><th>关键词</th><th>适用场景</th><th>记忆口诀</th></tr></thead><tbody><tr><td><code>protocol P&lt;Element&gt;</code></td><td>给自己协议“提级”</td><td>“协议也能带泛参”</td></tr><tr><td><code>some P&lt;T&gt;</code></td><td>返回值、泛型约束</td><td>“编译期就确定”</td></tr><tr><td><code>any P&lt;T&gt;</code></td><td>变量、数组、字典</td><td>“运行期多态盒子”</td></tr></tbody></table>
<p>一句话总结</p>
<p>Swift 5.7 让协议第一次真正拥有了“泛型形参”能力：</p>
<ul>
<li>写库的人：给协议加 <code>&lt;Element&gt;</code>，调用方立刻享受 <code>some/any</code> 语法糖。</li>
<li>写业务的人：用 <code>some Sequence&lt;Int&gt;</code> 替代冗长泛型约束，用 <code>any Sequence&lt;Int&gt;</code> 替代 <code>AnySequence</code>，代码短一半、可读性翻倍。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂]]></title>    <link>https://juejin.cn/post/7570271574348333065</link>    <guid>https://juejin.cn/post/7570271574348333065</guid>    <pubDate>2025-11-10T00:07:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348333065" data-draft-id="7554225547145461798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-10T00:07:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:07:19.000Z" title="Mon Nov 10 2025 00:07:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么“关联类型”是协议的分水岭</h2>
<p>在上面，我们接触的协议都属于“无关联类型协议”——编译期无需知道协议里的泛型占位符具体是什么。</p>
<p>一旦协议里出现了 <code>associatedtype</code>，它就不再是普通类型，而变成了协议泛型：只能当作约束使用，不能当作变量/参数/返回值类型直接出现。</p>
<h2 data-id="heading-1">关联类型基础语法</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>                     <span class="hljs-comment">// ① 声明一个占位符</span>
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { <span class="hljs-keyword">get</span> }
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Item</span>)      <span class="hljs-comment">// ② 在方法里使用占位符</span>
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Item</span> { <span class="hljs-keyword">get</span> }   <span class="hljs-comment">// ③ 在下标里使用占位符</span>
}
</code></pre>
<p>实现者决定真实类型</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">Int</span>]()
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>      <span class="hljs-comment">// 可省略，编译器自动推断</span>
    
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Int</span>) { items.append(item) }
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> { items[index] }
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { items.count }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">StringQueue</span>: <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">String</span>]()
    <span class="hljs-comment">// 不写 typealias，编译器也能从 append 参数推断 Item == String</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">String</span>) { items.append(item) }
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">String</span> { items[index] }
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { items.count }
}
</code></pre>
<h2 data-id="heading-2">带约束的关联类型</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">//  继承Container，只接收Item是Numeric的类型</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">SummableContainer</span>: <span class="hljs-title class_">Container</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Item</span>: <span class="hljs-title class_">Numeric</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">total</span>() -&gt; <span class="hljs-type">Item</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">SummableContainer</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">total</span>() -&gt; <span class="hljs-type">Item</span> {
        <span class="hljs-keyword">var</span> sum: <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>count { sum <span class="hljs-operator">=</span> sum <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>[i] }
        <span class="hljs-keyword">return</span> sum
    }
}
</code></pre>
<p>使用</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">SummableContainer</span> {}   <span class="hljs-comment">// Int 符合 Numeric，自动获得 total()</span>
<span class="hljs-keyword">var</span> s <span class="hljs-operator">=</span> <span class="hljs-type">IntStack</span>()
s.append(<span class="hljs-number">1</span>)
s.append(<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(s.total()) <span class="hljs-comment">// 3</span>
</code></pre>
<h2 data-id="heading-3">Self 出现在协议里：返回自身类型的需求</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>() -&gt; <span class="hljs-keyword">Self</span>        <span class="hljs-comment">// 要求返回“真实类型”本身</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">init</span>() {}         <span class="hljs-comment">// 必须保证子类也能初始化</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>() -&gt; <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> new <span class="hljs-operator">=</span> <span class="hljs-keyword">Self</span>()       <span class="hljs-comment">// Self 在运行期代表真实动态类型</span>
        new.name <span class="hljs-operator">=</span> name
        <span class="hljs-keyword">return</span> new
    }
}

<span class="hljs-keyword">let</span> husky <span class="hljs-operator">=</span> <span class="hljs-type">Dog</span>()
husky.name <span class="hljs-operator">=</span> <span class="hljs-string">"Husky"</span>
<span class="hljs-keyword">let</span> another <span class="hljs-operator">=</span> husky.copy()     <span class="hljs-comment">// 类型推断为 Dog</span>
</code></pre>
<p>注意</p>
<ul>
<li><code>Self</code> 只能出现在“协议内”或“协议扩展”中，不能出现在普通结构体/类的方法签名里。</li>
<li>如果协议用 <code>associatedtype</code>，<code>Self</code> 就是该类型的别名。</li>
</ul>
<h2 data-id="heading-4">泛型递归约束：where 子句的魔法</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Value</span>
    <span class="hljs-keyword">var</span> value: <span class="hljs-type">Value</span> { <span class="hljs-keyword">get</span> }
    <span class="hljs-keyword">var</span> children: [<span class="hljs-keyword">Self</span>] { <span class="hljs-keyword">get</span> }        <span class="hljs-comment">// 递归引用自身</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Node</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Value</span>: <span class="hljs-title class_">Numeric</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sumTree</span>() -&gt; <span class="hljs-type">Value</span> {
        value <span class="hljs-operator">+</span> children.reduce(<span class="hljs-number">0</span>) { <span class="hljs-variable">$0</span> <span class="hljs-operator">+</span> <span class="hljs-variable">$1</span>.sumTree() }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntNode</span>: <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">let</span> value: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> children: [<span class="hljs-type">IntNode</span>]
}

<span class="hljs-keyword">let</span> tree <span class="hljs-operator">=</span> <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">10</span>, children: [
    <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">3</span>, children: []),
    <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">5</span>, children: [
        <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">1</span>, children: [])
    ])
])
<span class="hljs-built_in">print</span>(tree.sumTree())  <span class="hljs-comment">// 10+3+5+1 = 19</span>
</code></pre>
<h2 data-id="heading-5">真实案例：Swift 标准库里的 Sequence</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Sequence</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Iterator</span>: <span class="hljs-type">IteratorProtocol</span> <span class="hljs-keyword">where</span> <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span>
    
    __consuming <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span>
}

<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">IteratorProtocol</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}
</code></pre>
<p>自定义序列</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Fibonacci</span>: <span class="hljs-title class_">Sequence</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Iterator</span>: <span class="hljs-title class_">IteratorProtocol</span> {
        <span class="hljs-keyword">var</span> a <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Int</span>? {
            <span class="hljs-keyword">let</span> next <span class="hljs-operator">=</span> a
            a <span class="hljs-operator">=</span> b
            b <span class="hljs-operator">=</span> next <span class="hljs-operator">+</span> a
            <span class="hljs-keyword">return</span> next
        }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span> { <span class="hljs-type">Iterator</span>() }
}

<span class="hljs-keyword">for</span> (i, n) <span class="hljs-keyword">in</span> <span class="hljs-type">Fibonacci</span>().enumerated().prefix(<span class="hljs-number">10</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"F<span class="hljs-subst">\(i)</span> = <span class="hljs-subst">\(n)</span>"</span>)
}
</code></pre>
<h2 data-id="heading-6">类型擦除（Type Erasure）：解决“关联类型协议不能当返回类型”</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Item</span>?
}

<span class="hljs-comment">// 1. 包装类擦除具体 Item 类型</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnyFeed</span>&lt;<span class="hljs-title class_">Item</span>&gt;: <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _next: () -&gt; <span class="hljs-type">Item</span>?
    <span class="hljs-keyword">init</span>&lt;<span class="hljs-type">F</span>: <span class="hljs-type">Feed</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">real</span>: <span class="hljs-type">F</span>) <span class="hljs-keyword">where</span> <span class="hljs-type">F</span>.<span class="hljs-type">Item</span> <span class="hljs-operator">==</span> <span class="hljs-type">Item</span> {
        _next <span class="hljs-operator">=</span> { real.next() }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Item</span>? { _next() }
}

<span class="hljs-comment">// 2. 使用处不再出现关联类型</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIntFeed</span>() -&gt; <span class="hljs-type">AnyFeed</span>&lt;<span class="hljs-type">Int</span>&gt; {
    <span class="hljs-keyword">let</span> fib <span class="hljs-operator">=</span> <span class="hljs-type">Fibonacci</span>().makeIterator()
    <span class="hljs-keyword">return</span> <span class="hljs-type">AnyFeed</span>(<span class="hljs-type">IteratorFeed</span>(fib))
}
</code></pre>
<p>标准库已有</p>
<ul>
<li><code>AnySequence&lt;Element&gt;</code></li>
<li><code>AnyPublisher&lt;Output, Failure&gt;</code> (Combine)</li>
<li><code>AnyView</code> (SwiftUI)</li>
</ul>
<h2 data-id="heading-7">实战技巧清单</h2>





























<table><thead><tr><th>技巧场景</th><th>具体实现技巧</th></tr></thead><tbody><tr><td>想返回“某个遵守协议的对象”</td><td>用泛型 <code>&lt;T: Protocol&gt;</code> 或 <code>some Protocol</code></td></tr><tr><td>协议中定义 <code>associatedtype</code></td><td>仅能作为类型约束，无法直接当作变量类型；需通过“类型擦除”后暴露</td></tr><tr><td>要求子类必须实现指定初始化器</td><td>协议中声明 <code>init()</code>，类侧配合写 <code>required init()</code></td></tr><tr><td>让扩展方法仅对满足部分约束的类型可见</td><td>使用 <code>where</code> 子句，例如 <code>extension Container where Item: Comparable</code></td></tr><tr><td>禁止类型隐式标记为 <code>Sendable</code></td><td>声明 <code>struct File: ~Sendable</code>，或通过 <code>@available(*, unavailable) extension File: Sendable</code> 禁用</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『OpenGL学习滤镜相机』- Day8: 多重纹理与混合]]></title>    <link>https://juejin.cn/post/7570534000718495807</link>    <guid>https://juejin.cn/post/7570534000718495807</guid>    <pubDate>2025-11-10T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570534000718495807" data-draft-id="7570534000718479423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『OpenGL学习滤镜相机』- Day8: 多重纹理与混合"/> <meta itemprop="keywords" content="Android,OpenGL"/> <meta itemprop="datePublished" content="2025-11-10T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下位子"/> <meta itemprop="url" content="https://juejin.cn/user/2313028193761389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『OpenGL学习滤镜相机』- Day8: 多重纹理与混合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028193761389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下位子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T08:19:05.000Z" title="Mon Nov 10 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://juejin.cn/post/7567889397497528383" target="_blank" title="https://juejin.cn/post/7567889397497528383">前言: 『OpenGL学习』 从零打造 Android 滤镜相机</a></p>
<p><a href="https://juejin.cn/post/7569871848793948179" target="_blank" title="https://juejin.cn/post/7569871848793948179">上一篇:『OpenGL学习滤镜相机』- Day7: FBO（帧缓冲对象）</a></p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest" target="_blank" title="https://github.com/xiaweizi/OpenGLTest" ref="nofollow noopener noreferrer">OpenGLTest</a></p>
</blockquote>
<h2 data-id="heading-0">📚 今日目标</h2>
<ul>
<li>理解多纹理单元的概念和使用</li>
<li>掌握纹理混合模式（Blend Modes）</li>
<li>学习 Alpha 通道处理和透明度</li>
<li>实现图片水印、纹理叠加等实用效果</li>
</ul>
<p><strong>运行效果：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d0fe85223524f6d85e34d84847cfa31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5L2N5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763367544&amp;x-signature=NEY23PHhtHVaLDDj%2FvZ28hR8j1M%3D" alt="Day8.gif" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 学习内容</h2>
<h3 data-id="heading-2">1. 多纹理单元简介</h3>
<p>在 OpenGL ES 中，<strong>纹理单元（Texture Unit）</strong> 允许我们在一次绘制调用中使用多个纹理。</p>
<h4 data-id="heading-3">什么是纹理单元？</h4>
<p>纹理单元是 OpenGL 中的"纹理槽位"，每个槽位可以绑定一个纹理对象。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">GPU</span> <span class="hljs-string">纹理单元</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE0</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">123</span><span class="hljs-string">（底图）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE1</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">456</span><span class="hljs-string">（水印）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE2</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">789</span><span class="hljs-string">（遮罩）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">...</span>
<span class="hljs-string">└──</span> <span class="hljs-string">GL_TEXTURE31（OpenGL</span> <span class="hljs-string">ES</span> <span class="hljs-string">至少支持</span> <span class="hljs-number">8</span> <span class="hljs-string">个，通常支持</span> <span class="hljs-number">16</span><span class="hljs-number">-32</span> <span class="hljs-string">个）</span>
</code></pre>
<h4 data-id="heading-4">为什么需要多纹理？</h4>





























<table><thead><tr><th>应用场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>水印效果</strong></td><td>底图 + 水印图</td></tr><tr><td><strong>遮罩效果</strong></td><td>原图 + 遮罩图</td></tr><tr><td><strong>光照贴图</strong></td><td>颜色纹理 + 法线贴图 + 光照贴图</td></tr><tr><td><strong>视频特效</strong></td><td>视频帧 + 滤镜纹理（LUT）</td></tr><tr><td><strong>粒子效果</strong></td><td>粒子纹理 + 渐变纹理</td></tr></tbody></table>
<h3 data-id="heading-5">2. 多纹理的使用流程</h3>
<h4 data-id="heading-6">2.1 激活纹理单元</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 激活纹理单元 0</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
<span class="hljs-comment">// 绑定第一个纹理</span>
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)

<span class="hljs-comment">// 激活纹理单元 1</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
<span class="hljs-comment">// 绑定第二个纹理</span>
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
</code></pre>
<h4 data-id="heading-7">2.2 传递给着色器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 将纹理单元索引传递给着色器的 sampler2D</span>
GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 使用 GL_TEXTURE0</span>
GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 使用 GL_TEXTURE1</span>
</code></pre>
<h4 data-id="heading-8">2.3 着色器中采样</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;  // 底图
uniform sampler2D uTexture2;  // 水印

varying vec2 vTexCoord;

void main() {
    vec4 color1 = texture2D(uTexture1, vTexCoord);  // 采样底图
    vec4 color2 = texture2D(uTexture2, vTexCoord);  // 采样水印
    
    // 混合两个纹理
    gl_FragColor = mix(color1, color2, color2.a);
}
</code></pre>
<h3 data-id="heading-9">3. 纹理混合模式</h3>
<h4 data-id="heading-10">3.1 常见混合算法</h4>








































<table><thead><tr><th>混合模式</th><th>公式</th><th>效果</th></tr></thead><tbody><tr><td><strong>正常（Normal）</strong></td><td><code>color2</code></td><td>完全覆盖</td></tr><tr><td><strong>Alpha 混合</strong></td><td><code>mix(color1, color2, alpha)</code></td><td>透明叠加</td></tr><tr><td><strong>相加（Add）</strong></td><td><code>color1 + color2</code></td><td>增亮效果</td></tr><tr><td><strong>相乘（Multiply）</strong></td><td><code>color1 * color2</code></td><td>变暗效果</td></tr><tr><td><strong>屏幕（Screen）</strong></td><td><code>1.0 - (1.0 - color1) * (1.0 - color2)</code></td><td>柔光增亮</td></tr><tr><td><strong>叠加（Overlay）</strong></td><td>根据亮度混合相乘和屏幕模式</td><td>保留高光和阴影</td></tr></tbody></table>
<h4 data-id="heading-11">3.2 着色器实现</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;  // 底图
uniform sampler2D uTexture2;  // 叠加图
uniform int uBlendMode;       // 混合模式（0-5）
uniform float uAlpha;         // 透明度（0.0 - 1.0）

varying vec2 vTexCoord;

// 正常混合
vec3 blendNormal(vec3 base, vec3 blend) {
    return blend;
}

// 相加混合
vec3 blendAdd(vec3 base, vec3 blend) {
    return min(base + blend, vec3(1.0));
}

// 相乘混合
vec3 blendMultiply(vec3 base, vec3 blend) {
    return base * blend;
}

// 屏幕混合
vec3 blendScreen(vec3 base, vec3 blend) {
    return 1.0 - (1.0 - base) * (1.0 - blend);
}

// 叠加混合
vec3 blendOverlay(vec3 base, vec3 blend) {
    vec3 result;
    result.r = base.r &lt; 0.5 ? (2.0 * base.r * blend.r) : (1.0 - 2.0 * (1.0 - base.r) * (1.0 - blend.r));
    result.g = base.g &lt; 0.5 ? (2.0 * base.g * blend.g) : (1.0 - 2.0 * (1.0 - base.g) * (1.0 - blend.g));
    result.b = base.b &lt; 0.5 ? (2.0 * base.b * blend.b) : (1.0 - 2.0 * (1.0 - base.b) * (1.0 - blend.b));
    return result;
}

// 柔光混合
vec3 blendSoftLight(vec3 base, vec3 blend) {
    vec3 result;
    result.r = blend.r &lt; 0.5 ? (2.0 * base.r * blend.r + base.r * base.r * (1.0 - 2.0 * blend.r)) 
                              : (sqrt(base.r) * (2.0 * blend.r - 1.0) + 2.0 * base.r * (1.0 - blend.r));
    result.g = blend.g &lt; 0.5 ? (2.0 * base.g * blend.g + base.g * base.g * (1.0 - 2.0 * blend.g)) 
                              : (sqrt(base.g) * (2.0 * blend.g - 1.0) + 2.0 * base.g * (1.0 - blend.g));
    result.b = blend.b &lt; 0.5 ? (2.0 * base.b * blend.b + base.b * base.b * (1.0 - 2.0 * blend.b)) 
                              : (sqrt(base.b) * (2.0 * blend.b - 1.0) + 2.0 * base.b * (1.0 - blend.b));
    return result;
}

void main() {
    vec4 base = texture2D(uTexture1, vTexCoord);
    vec4 blend = texture2D(uTexture2, vTexCoord);
    
    vec3 result;
    
    if (uBlendMode == 0) {
        // 正常混合（Alpha 混合）
        result = mix(base.rgb, blend.rgb, blend.a * uAlpha);
    } else if (uBlendMode == 1) {
        // 相加
        result = blendAdd(base.rgb, blend.rgb * uAlpha);
    } else if (uBlendMode == 2) {
        // 相乘
        result = mix(base.rgb, blendMultiply(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 3) {
        // 屏幕
        result = mix(base.rgb, blendScreen(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 4) {
        // 叠加
        result = mix(base.rgb, blendOverlay(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 5) {
        // 柔光
        result = mix(base.rgb, blendSoftLight(base.rgb, blend.rgb), uAlpha);
    } else {
        result = base.rgb;
    }
    
    gl_FragColor = vec4(result, 1.0);
}
</code></pre>
<h3 data-id="heading-12">4. Alpha 通道处理</h3>
<h4 data-id="heading-13">4.1 什么是 Alpha 通道？</h4>
<p><strong>Alpha 通道</strong>表示像素的不透明度：</p>
<ul>
<li><code>alpha = 0.0</code>：完全透明</li>
<li><code>alpha = 0.5</code>：半透明</li>
<li><code>alpha = 1.0</code>：完全不透明</li>
</ul>
<h4 data-id="heading-14">4.2 启用 Alpha 混合</h4>
<p>OpenGL 提供了硬件级别的 Alpha 混合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 启用混合</span>
GLES20.glEnable(GLES20.GL_BLEND)

<span class="hljs-comment">// 设置混合函数</span>
GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA)
</code></pre>
<p><strong>混合公式</strong>：</p>
<pre><code class="hljs language-css" lang="css">最终颜色 = 源颜色 × 源因子 + 目标颜色 × 目标因子
       = <span class="hljs-attribute">src</span><span class="hljs-selector-class">.rgb</span> × <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span> + dst<span class="hljs-selector-class">.rgb</span> × (<span class="hljs-number">1.0</span> - <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span>)
</code></pre>
<h4 data-id="heading-15">4.3 常见混合函数</h4>






























<table><thead><tr><th>源因子</th><th>目标因子</th><th>效果</th></tr></thead><tbody><tr><td><code>GL_SRC_ALPHA</code></td><td><code>GL_ONE_MINUS_SRC_ALPHA</code></td><td>标准 Alpha 混合（透明叠加）</td></tr><tr><td><code>GL_ONE</code></td><td><code>GL_ONE</code></td><td>相加混合（增亮）</td></tr><tr><td><code>GL_DST_COLOR</code></td><td><code>GL_ZERO</code></td><td>相乘混合（变暗）</td></tr><tr><td><code>GL_ONE</code></td><td><code>GL_ONE_MINUS_SRC_ALPHA</code></td><td>预乘 Alpha 混合</td></tr></tbody></table>
<h3 data-id="heading-16">5. 实用效果实现</h3>
<h4 data-id="heading-17">5.1 水印效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">// 水印着色器
precision mediump float;

uniform sampler2D uTexture;    // 底图
uniform sampler2D uWatermark;  // 水印
uniform vec2 uWatermarkPos;    // 水印位置（0.0 - 1.0）
uniform vec2 uWatermarkSize;   // 水印大小（0.0 - 1.0）
uniform float uWatermarkAlpha; // 水印透明度

varying vec2 vTexCoord;

void main() {
    vec4 baseColor = texture2D(uTexture, vTexCoord);
    
    // 计算水印区域
    vec2 watermarkCoord = (vTexCoord - uWatermarkPos) / uWatermarkSize;
    
    // 判断是否在水印区域
    if (watermarkCoord.x &gt;= 0.0 &amp;&amp; watermarkCoord.x &lt;= 1.0 &amp;&amp;
        watermarkCoord.y &gt;= 0.0 &amp;&amp; watermarkCoord.y &lt;= 1.0) {
        
        vec4 watermarkColor = texture2D(uWatermark, watermarkCoord);
        
        // Alpha 混合水印
        gl_FragColor = mix(baseColor, watermarkColor, watermarkColor.a * uWatermarkAlpha);
    } else {
        gl_FragColor = baseColor;
    }
}
</code></pre>
<h4 data-id="heading-18">5.2 双重曝光效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;
uniform sampler2D uTexture2;
uniform float uMixRatio;  // 混合比例

varying vec2 vTexCoord;

void main() {
    vec4 color1 = texture2D(uTexture1, vTexCoord);
    vec4 color2 = texture2D(uTexture2, vTexCoord);
    
    // 屏幕混合模式（双重曝光常用）
    vec3 result = 1.0 - (1.0 - color1.rgb) * (1.0 - color2.rgb * uMixRatio);
    
    gl_FragColor = vec4(result, 1.0);
}
</code></pre>
<h4 data-id="heading-19">5.3 遮罩效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture;  // 原图
uniform sampler2D uMask;     // 遮罩（黑白图）

varying vec2 vTexCoord;

void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec4 mask = texture2D(uMask, vTexCoord);
    
    // 使用遮罩的亮度作为 Alpha
    float maskAlpha = dot(mask.rgb, vec3(0.299, 0.587, 0.114));
    
    gl_FragColor = vec4(color.rgb, color.a * maskAlpha);
}
</code></pre>
<h3 data-id="heading-20">6. 性能优化</h3>
<h4 data-id="heading-21">6.1 纹理单元管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextureManager</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_BASE = <span class="hljs-number">0</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_BLEND = <span class="hljs-number">1</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_WATERMARK = <span class="hljs-number">2</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindTextures</span><span class="hljs-params">(baseTexture: <span class="hljs-type">Int</span>, blendTexture: <span class="hljs-type">Int</span>, watermarkTexture: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 底图</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_BASE)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, baseTexture)
        
        <span class="hljs-comment">// 混合图</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_BLEND)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, blendTexture)
        
        <span class="hljs-comment">// 水印</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_WATERMARK)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, watermarkTexture)
    }
}
</code></pre>
<h4 data-id="heading-22">6.2 减少纹理切换</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不好的做法：频繁切换纹理单元</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderObjects</span><span class="hljs-params">(objects: <span class="hljs-type">List</span>&lt;<span class="hljs-type">RenderObject</span>&gt;)</span></span> {
    objects.forEach { obj -&gt;
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, obj.texture)
        obj.draw()
    }
}

<span class="hljs-comment">// ✅ 好的做法：批量渲染相同纹理的对象</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderObjectsBatched</span><span class="hljs-params">(objects: <span class="hljs-type">List</span>&lt;<span class="hljs-type">RenderObject</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> grouped = objects.groupBy { it.texture }
    grouped.forEach { (texture, objs) -&gt;
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture)
        objs.forEach { it.draw() }
    }
}
</code></pre>
<h4 data-id="heading-23">6.3 纹理压缩</h4>
<p>对于水印等辅助纹理，可以使用较低分辨率或压缩格式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 调整水印尺寸</span>
<span class="hljs-keyword">val</span> watermarkSize = <span class="hljs-number">256</span>  <span class="hljs-comment">// 不需要很高分辨率</span>
<span class="hljs-keyword">val</span> scaledWatermark = Bitmap.createScaledBitmap(
    originalWatermark, 
    watermarkSize, 
    watermarkSize, 
    <span class="hljs-literal">true</span>
)
</code></pre>
<h3 data-id="heading-24">7. 多纹理的限制</h3>
<h4 data-id="heading-25">7.1 查询纹理单元数量</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> maxTextureUnits = IntArray(<span class="hljs-number">1</span>)
GLES20.glGetIntegerv(GLES20.GL_MAX_TEXTURE_IMAGE_UNITS, maxTextureUnits, <span class="hljs-number">0</span>)
Log.d(TAG, <span class="hljs-string">"设备支持的最大纹理单元数: <span class="hljs-subst">${maxTextureUnits[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<p>OpenGL ES 2.0 规范要求至少支持 8 个纹理单元，大多数设备支持 16-32 个。</p>
<h4 data-id="heading-26">7.2 纹理内存管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 监控纹理内存使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">estimateTextureMemory</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>, format: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">val</span> bytesPerPixel = <span class="hljs-keyword">when</span> (format) {
        GLES20.GL_RGBA -&gt; <span class="hljs-number">4</span>
        GLES20.GL_RGB -&gt; <span class="hljs-number">3</span>
        GLES20.GL_LUMINANCE_ALPHA -&gt; <span class="hljs-number">2</span>
        GLES20.GL_LUMINANCE -&gt; <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">4</span>
    }
    <span class="hljs-keyword">return</span> width * height * bytesPerPixel
}

<span class="hljs-comment">// 示例：1920x1080 RGBA 纹理 = 8.3 MB</span>
<span class="hljs-keyword">val</span> memory = estimateTextureMemory(<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>, GLES20.GL_RGBA)
Log.d(TAG, <span class="hljs-string">"纹理内存占用: <span class="hljs-subst">${memory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span> MB"</span>)
</code></pre>
<h2 data-id="heading-27">💻 代码实践</h2>
<h3 data-id="heading-28">今日任务</h3>
<p>实现一个多纹理混合应用：</p>
<ol>
<li><strong>加载两张图片</strong></li>
<li><strong>实现多种混合模式</strong>：
<ul>
<li>Alpha 混合</li>
<li>相加</li>
<li>相乘</li>
<li>屏幕</li>
<li>叠加</li>
<li>柔光</li>
</ul>
</li>
<li><strong>添加水印功能</strong></li>
<li><strong>提供透明度调节</strong></li>
</ol>
<h3 data-id="heading-29">实现效果</h3>
<ul>
<li>🖼️ 同时加载两张纹理</li>
<li>🎨 6 种混合模式实时切换</li>
<li>💧 透明度 SeekBar 调节</li>
<li>🏷️ 水印位置和透明度控制</li>
</ul>
<h3 data-id="heading-30">核心代码结构</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day08Renderer</span>(context: Context) : GLSurfaceView.Renderer {

    <span class="hljs-comment">// 多纹理 ID</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> texture1: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment">// 底图</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> texture2: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment">// 叠加图</span>

    <span class="hljs-comment">// 混合模式</span>
    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlendMode</span> {
        ALPHA,      <span class="hljs-comment">// Alpha 混合</span>
        ADD,        <span class="hljs-comment">// 相加</span>
        MULTIPLY,   <span class="hljs-comment">// 相乘</span>
        SCREEN,     <span class="hljs-comment">// 屏幕</span>
        OVERLAY,    <span class="hljs-comment">// 叠加</span>
        SOFT_LIGHT  <span class="hljs-comment">// 柔光</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentBlendMode = BlendMode.ALPHA
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> blendAlpha = <span class="hljs-number">0.5f</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {
        <span class="hljs-comment">// 激活纹理单元 0</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)
        GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)

        <span class="hljs-comment">// 激活纹理单元 1</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
        GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)

        <span class="hljs-comment">// 设置混合模式</span>
        GLES20.glUniform1i(blendModeLocation, currentBlendMode.ordinal)
        GLES20.glUniform1f(alphaLocation, blendAlpha)

        <span class="hljs-comment">// 绘制</span>
        drawQuad()
    }
}
</code></pre>
<h2 data-id="heading-31">🧪 练习任务</h2>
<h3 data-id="heading-32">基础任务</h3>
<ol>
<li>✅ 实现两个纹理的加载和绑定</li>
<li>✅ 实现至少 3 种混合模式</li>
<li>✅ 添加透明度调节功能</li>
</ol>
<h3 data-id="heading-33">进阶任务</h3>
<ol>
<li>🎨 实现水印功能（可调节位置和大小）</li>
<li>🖼️ 实现遮罩效果</li>
<li>🌈 实现双重曝光效果</li>
<li>📸 添加预设混合效果（复古、电影、梦幻等）</li>
</ol>
<h3 data-id="heading-34">挑战任务</h3>
<ol>
<li>🚀 实现三个纹理的混合（底图 + 叠加图 + 水印）</li>
<li>🎭 实现动态混合（混合比例随时间变化）</li>
<li>🎬 实现分区域混合（不同区域不同混合模式）</li>
<li>💾 保存混合后的图片到相册</li>
</ol>
<h2 data-id="heading-35">📖 知识点总结</h2>
<h3 data-id="heading-36">纹理单元 vs 纹理对象</h3>






























<table><thead><tr><th>特性</th><th>纹理单元</th><th>纹理对象</th></tr></thead><tbody><tr><td><strong>概念</strong></td><td>GPU 的"纹理槽位"</td><td>实际的纹理数据</td></tr><tr><td><strong>数量</strong></td><td>有限（通常 8-32 个）</td><td>可以创建很多</td></tr><tr><td><strong>操作</strong></td><td><code>glActiveTexture()</code></td><td><code>glBindTexture()</code></td></tr><tr><td><strong>类比</strong></td><td>USB 接口</td><td>U 盘</td></tr></tbody></table>
<h3 data-id="heading-37">混合模式对比</h3>








































<table><thead><tr><th>模式</th><th>视觉效果</th><th>常用场景</th></tr></thead><tbody><tr><td><strong>Alpha</strong></td><td>透明叠加</td><td>水印、UI 叠加</td></tr><tr><td><strong>Add</strong></td><td>增亮、发光</td><td>光效、粒子</td></tr><tr><td><strong>Multiply</strong></td><td>变暗、阴影</td><td>阴影、色彩校正</td></tr><tr><td><strong>Screen</strong></td><td>柔和增亮</td><td>柔光、氛围</td></tr><tr><td><strong>Overlay</strong></td><td>对比增强</td><td>照片滤镜</td></tr><tr><td><strong>Soft Light</strong></td><td>柔和混合</td><td>肖像美化</td></tr></tbody></table>
<h3 data-id="heading-38">最佳实践</h3>
<ol>
<li>✅ <strong>复用纹理单元</strong>：不要每帧都重新激活和绑定</li>
<li>✅ <strong>批量渲染</strong>：相同纹理的对象一起渲染</li>
<li>✅ <strong>纹理压缩</strong>：对辅助纹理使用较低分辨率</li>
<li>✅ <strong>及时释放</strong>：不再使用的纹理要删除</li>
<li>✅ <strong>检查限制</strong>：查询设备支持的最大纹理单元数</li>
</ol>
<h2 data-id="heading-39">🐛 常见问题</h2>
<h3 data-id="heading-40">Q1: 纹理显示是黑色的？</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>纹理单元索引错误</li>
<li><code>glUniform1i</code> 传递的值不对应激活的纹理单元</li>
</ol>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 纹理单元 0</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)
GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 传递 0，不是 GL_TEXTURE0</span>

<span class="hljs-comment">// 纹理单元 1</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 传递 1，不是 GL_TEXTURE1</span>
</code></pre>
<h3 data-id="heading-41">Q2: 混合效果不正确？</h3>
<p>检查是否启用了 OpenGL 混合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果使用硬件混合</span>
GLES20.glEnable(GLES20.GL_BLEND)
GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA)

<span class="hljs-comment">// 如果使用着色器混合</span>
<span class="hljs-comment">// 不需要启用 glBlend，直接在片段着色器中计算即可</span>
</code></pre>
<h3 data-id="heading-42">Q3: 水印位置不对？</h3>
<p>OpenGL 坐标系原点在左下角，而 UI 坐标系在左上角：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// UI 坐标（左上角为原点）</span>
<span class="hljs-keyword">val</span> uiY = <span class="hljs-number">100f</span>

<span class="hljs-comment">// 转换为 OpenGL 坐标（左下角为原点）</span>
<span class="hljs-keyword">val</span> glY = screenHeight - uiY - watermarkHeight
</code></pre>
<h3 data-id="heading-43">Q4: 如何实现圆形水印？</h3>
<p>在着色器中使用距离函数：</p>
<pre><code class="hljs language-glsl" lang="glsl">void main() {
    vec2 center = vec2(0.5, 0.5);
    float dist = distance(watermarkCoord, center);
    
    // 圆形遮罩
    float alpha = smoothstep(0.5, 0.48, dist);
    
    vec4 watermarkColor = texture2D(uWatermark, watermarkCoord);
    watermarkColor.a *= alpha;
    
    gl_FragColor = mix(baseColor, watermarkColor, watermarkColor.a);
}
</code></pre>
<h2 data-id="heading-44">🔗 参考资料</h2>
<h3 data-id="heading-45">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fopengl%2Fwiki%2FTexture" target="_blank" title="https://www.khronos.org/opengl/wiki/Texture" ref="nofollow noopener noreferrer">OpenGL ES Texture Units</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fopengl%2Fwiki%2FSampler_(GLSL)" target="_blank" title="https://www.khronos.org/opengl/wiki/Sampler_(GLSL)" ref="nofollow noopener noreferrer">GLSL Sampler Types</a></li>
</ul>
<h3 data-id="heading-46">混合模式参考</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fphotoblogstop.com%2Fphotoshop%2Fphotoshop-blend-modes-explained" target="_blank" title="https://photoblogstop.com/photoshop/photoshop-blend-modes-explained" ref="nofollow noopener noreferrer">Photoshop Blend Modes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjamieowen%2Fglsl-blend" target="_blank" title="https://github.com/jamieowen/glsl-blend" ref="nofollow noopener noreferrer">WebGL Blend Modes</a></li>
</ul>
<h3 data-id="heading-47">推荐阅读</h3>
<ul>
<li>《Real-Time Rendering》- Chapter 5: Visual Appearance</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Fgpugems%2Fgpugems3%2Fpart-iv-image-effects" target="_blank" title="https://developer.nvidia.com/gpugems/gpugems3/part-iv-image-effects" ref="nofollow noopener noreferrer">GPU Gems - Image Processing</a></li>
</ul>
<h2 data-id="heading-48">📝 今日总结</h2>
<p>今天我们深入学习了多重纹理和混合技术：</p>
<ol>
<li>✅ 理解了纹理单元的概念：GPU 中的"纹理槽位"</li>
<li>✅ 掌握了多纹理的使用流程：激活 → 绑定 → 传递索引</li>
<li>✅ 学习了 6 种常用混合模式：Alpha、Add、Multiply、Screen、Overlay、Soft Light</li>
<li>✅ 实现了实用效果：水印、双重曝光、遮罩</li>
</ol>
<p><strong>关键要点</strong>：</p>
<ul>
<li>纹理单元允许我们在一次绘制中使用多个纹理</li>
<li><code>glActiveTexture()</code> 激活纹理单元，<code>glUniform1i()</code> 传递索引（不是 GL_TEXTURE 常量）</li>
<li>混合模式本质是不同的颜色计算公式</li>
<li>Alpha 通道是实现透明效果的关键</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">下一篇</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案]]></title>    <link>https://juejin.cn/post/7570579125154725898</link>    <guid>https://juejin.cn/post/7570579125154725898</guid>    <pubDate>2025-11-10T07:58:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570579125154725898" data-draft-id="7570564840429305883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-10T07:58:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T07:58:21.000Z" title="Mon Nov 10 2025 07:58:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、理论来源于实践</h2>
<p><strong>现象</strong>：于2025-08-13 21:45:35，事实逻辑表将自身的指标与维度同步到原子服务的实现时，出现同步过来的指标与维度丢失。</p>
<p><strong>核心原因</strong>：两次重复的事实逻辑表同步时间非常相近，导致同步过来的指标与维度丢失。</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2997262148d24d5eb0167adf0eaa43d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=1VD8L2kEcgSenUN%2F%2FvANMxfw%2Bm4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-1">2、倒带进事故现场</h2>
<p>逻辑表向原子服务同步的核心逻辑是 “先删后增”：删除旧数据→对比新老数据→插入新增数据，具体流程如下：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6649acaff23477fbc1cb6d5647fb50b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=5npYZVg7NlOPfHpPaeAoFn1CjtI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>整体业务代码精简逻辑如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
public Map&lt;String, Object&gt; driveToAtomService(Map logicTableData, String erp) {
<span class="hljs-comment">//获得环境信息</span>
String env = driveLogicTable<span class="hljs-selector-class">.getString</span>(DRIVE_LOGIC_TABLE_ENV);
<span class="hljs-comment">//获取/更新实现id</span>
 Long logicTableId = <span class="hljs-built_in">getOrAddLogicTableId</span>(atomicServiceId, driveLogicTable, erp, EnvType.of(env));
<span class="hljs-comment">//删除关联指标</span>
 metricImplMapper<span class="hljs-selector-class">.deleteByLogicTableIds</span>(Collections.singletonList(logicId));
<span class="hljs-comment">//获取请求中的所有的指标信息</span>
List&lt;MetricImplBO&gt; metricList = <span class="hljs-built_in">getMetricImpls</span>(logicTableData, logicTableId);
<span class="hljs-comment">//获取需要新增的指标实现(包含了查询库里现有的指标实现)</span>
List&lt;MetricImplRelBO&gt; metricImpls = metricImplMapper<span class="hljs-selector-class">.getMetricImpls</span>(logicTableId);
Set&lt;Long&gt; metricDefIdSet = metricImpls<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(MetricImplRelBO::getMetricDefId)<span class="hljs-selector-class">.collect</span>(Collectors.toSet());
List&lt;MetricImplBO&gt; addList = metricList<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(s -&gt; !metricDefIdSet.contains(s.getMetricDefId()))<span class="hljs-selector-class">.collect</span>(Collectors.toList());
<span class="hljs-comment">//将需要新增的指标实现插入数据库</span>
 <span class="hljs-built_in">addMetricImpl</span>(addList);

}
</code></pre>
<p>用一个请求进行举例：</p>
<pre><code class="hljs language-ruby" lang="ruby">{<span class="hljs-string">"header"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"appKey"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"uuid"</span><span class="hljs-symbol">:<span class="hljs-string">"ce7cef2d-c417-464a-a519-311599fddfca"</span></span>,<span class="hljs-string">"serviceName"</span><span class="hljs-symbol">:<span class="hljs-string">"driveToAtomService"</span></span>,<span class="hljs-string">"context"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"PIN"</span><span class="hljs-symbol">:<span class="hljs-string">"wanyue3"</span></span>}},<span class="hljs-string">"body"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"dimList"</span><span class="hljs-symbol">:</span>[{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">72</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2501</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2484</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2502</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4591</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3822</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4523</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4524</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">76</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1767</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1907</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1598</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4620</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4621</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4622</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2504</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2485</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2486</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2487</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2488</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3077</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3080</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3081</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2483</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2482</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3082</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3083</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4851</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2503</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5070</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5044</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5087</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5144</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5145</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3089</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3680</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2223</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5428</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5101</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1315</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5247</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3318</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5262</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4646</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2252</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2254</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2959</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2958</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2728</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2618</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5061</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6032</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6375</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6388</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6389</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1316</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1081</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1351</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1082</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1499</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"COMBINE"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1596</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1606</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1083</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1108</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>}],<span class="hljs-string">"dimCombineList"</span><span class="hljs-symbol">:[]</span>,<span class="hljs-string">"metricList"</span><span class="hljs-symbol">:</span>[{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19872</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19873</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19875</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19945</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">17263</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"COUNT_DISTINCT"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">28017</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">20242</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18450</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">20276</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18452</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18453</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18456</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19866</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">21691</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19871</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>}],<span class="hljs-string">"driveLogicTable"</span><span class="hljs-symbol">:<span class="hljs-string">"{"</span>dimensionType<span class="hljs-string">":"</span>DETAIL<span class="hljs-string">","</span>oldNameCn<span class="hljs-string">":"</span></span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>atomicAliasProd<span class="hljs-string">":"</span>prod<span class="hljs-string">","</span>implServiceTypeKey<span class="hljs-string">":"</span>realtime<span class="hljs-string">","</span>originPhysicDataSourceId<span class="hljs-string">":0,"</span>nameCn<span class="hljs-string">":"</span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>description<span class="hljs-string">":"</span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>driveLogicTableId<span class="hljs-string">":9881,"</span>driveLogicTableEnv<span class="hljs-string">":"</span><span class="hljs-variable constant_">DEV</span><span class="hljs-string">","</span>commonDecorateIdList<span class="hljs-string">":"</span><span class="hljs-number">9665</span>,<span class="hljs-number">3269</span>,<span class="hljs-number">3270</span>,<span class="hljs-number">3271</span>,<span class="hljs-number">4556</span>,<span class="hljs-number">8012</span>,<span class="hljs-number">8270</span>,<span class="hljs-number">6030</span>,<span class="hljs-number">7247</span>,<span class="hljs-number">6031</span>,<span class="hljs-number">7248</span>,<span class="hljs-number">6032</span>,<span class="hljs-number">7249</span>,<span class="hljs-number">6033</span>,<span class="hljs-number">7250</span>,<span class="hljs-number">6034</span>,<span class="hljs-number">6035</span>,<span class="hljs-number">2134</span>,<span class="hljs-number">7254</span>,<span class="hljs-number">7255</span>,<span class="hljs-number">2085</span>,<span class="hljs-number">619</span>,<span class="hljs-number">620</span>,<span class="hljs-number">5997</span>,<span class="hljs-number">1586</span>,<span class="hljs-number">7867</span>,<span class="hljs-number">6845</span><span class="hljs-string">","</span>atomicAliasPre<span class="hljs-string">":"</span>pre<span class="hljs-string">","</span>committer<span class="hljs-string">":"</span>panjingrong<span class="hljs-string">","</span>physicDataSourceId<span class="hljs-string">":9494,"</span>storageType<span class="hljs-string">":"</span><span class="hljs-variable constant_">ONLINE</span><span class="hljs-string">","</span>atomicAliasDev<span class="hljs-string">":"</span>pre<span class="hljs-string">"}"</span>,<span class="hljs-string">"atomicServiceId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1088</span>},<span class="hljs-string">"pin"</span><span class="hljs-symbol">:<span class="hljs-string">"wanyue3"</span></span>}
</code></pre>
<p>共计15个指标，64个维度</p>


















































































<table><thead><tr><th>请求1(事务)</th><th>请求2(事务)</th><th>﻿</th><th/><th/></tr></thead><tbody><tr><td>21:06:17.262</td><td>进入同步方法</td><td>21:06:17.263</td><td>进入同步方法</td><td>﻿</td></tr><tr><td>21:06:17.063</td><td>select unify_metric_impl where logic_id = 3245 查询出15条数据(快照读，readview1)</td><td>21:06:17.363</td><td>select unify_metric_impl where logic_id = 3245 查询出15条数据(快照读，readview2)</td><td>﻿</td></tr><tr><td>21:06:17.363</td><td>delete from unify_metric_impl where logic_id = 3245</td><td>21:06:17.372</td><td>delete from unify_metric_impl where logic_id = 3245</td><td>﻿</td></tr><tr><td>21:06:17.459</td><td>select unify_metric_impl where logic_id = 3245 查询出0条数据</td><td>﻿</td><td>delete 由于logic_id不是索引，会表锁阻塞</td><td>﻿</td></tr><tr><td>21:06:18.459</td><td>insert into unify_metric_impl 插入的logic_id = 3245的数据，15条</td><td>﻿</td><td>﻿</td><td>﻿</td></tr><tr><td>21:06:19.408</td><td>方法结束</td><td>﻿</td><td>﻿</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:19.529</td><td>删除成功</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:20.362</td><td>select unify_metric_impl where logic_id = 3245 得到 15条数据</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:20.435</td><td>读出15条数据，比较本次是否有新增指标， 得出没有新增指标，因此不进行新增。addAtomicMetricNameForDrive addList empty</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:21.435</td><td>方法结束</td><td>﻿</td></tr></tbody></table>
<p>﻿</p>
<p><strong>核心结论点</strong>：</p>
<p>1.请求2的删除操作被阻塞了，直到请求1执行完整个方法。</p>
<p>2.请求2中去查看当前实现的指标的时候，发现库里已经存在所有指标不会进行新增，与上一步删除的逻辑相悖。</p>
<p>﻿</p>
<h2 data-id="heading-2">3、结论点深度剖析</h2>
<h3 data-id="heading-3">3.1 分析结论一</h3>
<p>请求2的删除操作被阻塞了，直到请求1执行完整个方法。</p>
<h4 data-id="heading-4">3.1.1 复习mysql的InnoDB锁机制</h4>
<h5 data-id="heading-5">3.1.1.1 不是“一把锁”，而是 “锁矩阵”</h5>



































<table><thead><tr><th>锁粒度</th><th>共享锁（S 锁） （读锁，允许多读）</th><th>排他锁（X 锁） （写锁，独占）</th><th>意向锁（表级，辅助判断）</th></tr></thead><tbody><tr><td><strong>表级</strong></td><td>表 S 锁（极少用，如<code>LOCK TABLES ... READ</code>）</td><td>表 X 锁（极少用，如<code>LOCK TABLES ... WRITE</code>）</td><td>意向 S 锁（IS）、意向 X 锁（IX）</td></tr><tr><td><strong>行级</strong></td><td>行 S 锁（<code>SELECT ... FOR SHARE</code>）</td><td>行 X 锁（<code>UPDATE/DELETE/INSERT</code>默认加）</td><td>（行锁无需意向锁）</td></tr><tr><td><strong>间隙级</strong></td><td>间隙 S 锁（无，间隙只防插入）</td><td>间隙 X 锁（防其他事务插入相同间隙）</td><td>无</td></tr><tr><td><strong>Next-Key</strong></td><td>无</td><td>Next-Key 锁（行锁 + 间隙锁，默认行锁算法）</td><td>无</td></tr></tbody></table>
<p>﻿</p>
<h5 data-id="heading-6">3.1.1.2 一张图总结：InnoDB 锁的 “决策逻辑”</h5>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a63fcb8e5894899b983a55a5591fa44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=fE70zOi0aQzyezxUrKWq8xYzwMc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-7">3.1.2 理论应用实践</h4>
<h5 data-id="heading-8">3.1.2.1 本次事故的物料：</h5>
<p>mysql表：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">CREATE</span> <span class="hljs-selector-tag">TABLE</span> `<span class="hljs-selector-tag">unify_metric_impl</span>` (
  <span class="hljs-built_in">`id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">50</span>) unsigned <span class="hljs-keyword">NOT</span> NULL AUTO_INCREMENT COMMENT <span class="hljs-string">'自增ID'</span>,
  <span class="hljs-built_in">`metric_def_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'指标定义id'</span>,
  <span class="hljs-built_in">`logic_table_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'逻辑表id'</span>,
  <span class="hljs-built_in">`name_en_atomic`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'真实指标名'</span>,
  <span class="hljs-built_in">`committer`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'负责人'</span>,
  <span class="hljs-built_in">`create_time`</span> timestamp <span class="hljs-keyword">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="hljs-string">'开始时间'</span>,
  <span class="hljs-built_in">`update_time`</span> timestamp <span class="hljs-keyword">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT <span class="hljs-string">'修改时间'</span>,
  <span class="hljs-built_in">`metric_atomic_name_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'原子指标id'</span>,
  <span class="hljs-built_in">`decorate_id_list_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'修饰列表'</span>,
  <span class="hljs-built_in">`name_cn_alias_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'中文别名'</span>,
  <span class="hljs-built_in">`metric_type_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标类型：DERIVE 衍生指标，FORMULA 复合指标'</span>,
  <span class="hljs-built_in">`description_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标说明'</span>,
  <span class="hljs-built_in">`data_type_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'数据类型：STRING，DOUBLE, LONG, INT'</span>,
  <span class="hljs-built_in">`data_accuracy_temp`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'2'</span> COMMENT <span class="hljs-string">'数据精度-小数点后几位'</span>,
  <span class="hljs-built_in">`security_level_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">'-1'</span> COMMENT <span class="hljs-string">'安全等级'</span>,
  <span class="hljs-built_in">`logic_table_id_excel_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">'-1'</span> COMMENT <span class="hljs-string">'模型excelId'</span>,
  <span class="hljs-built_in">`implement_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标实现类型：APP、ATOMIC 原子服务'</span>,
  <span class="hljs-built_in">`app_ori_metric_name_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'所依赖的app层原始名字（适用于导数任务改变字段的情况）'</span>,
  <span class="hljs-built_in">`name_en_depend_atomic`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标依赖字段'</span>,
  <span class="hljs-built_in">`name_en_depend_app`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'所依赖的app层原始名字（适用于导数任务改变字段的情况）'</span>,
  <span class="hljs-built_in">`update_status`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'信息更新状态 0-未完成更新，1-完成更新'</span>,
  <span class="hljs-built_in">`status`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'信息更新状态 0-未完成更新，1-完成更新'</span>,
  <span class="hljs-built_in">`light_decorate_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'点灯修饰id列表'</span>,
  <span class="hljs-built_in">`extend_decorate_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的动态修饰id列表'</span>,
  <span class="hljs-built_in">`extend_function_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的原子服务函数id列表'</span>,
  <span class="hljs-built_in">`aggregation_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'聚合类型:ORIGINAL 原值 COUNT 计数 DISTINCT 指定字段去重 SUM 求和 AVG  均值 MIN 求最大值 MAX 求最小值 QUANTITLE 求分位数'</span>,
  <span class="hljs-built_in">`middle_aggregation_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'中间层类型,UNKNOWN:未知,AGG_BY_FIELD:按聚合字段分组后聚合,AGG_BY_DAY:按天去重后累加'</span>,
  <span class="hljs-built_in">`static_decorate_id_list_combination`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的固化修饰id列表组合,[[d1,d2],[d2]]'</span>,
  PRIMARY KEY (<span class="hljs-built_in">`id`</span>),
  KEY <span class="hljs-built_in">`idx_metric_def_id`</span> (<span class="hljs-built_in">`metric_def_id`</span>,<span class="hljs-built_in">`logic_table_id`</span>)
) <span class="hljs-selector-tag">ENGINE</span>=<span class="hljs-selector-tag">InnoDB</span> <span class="hljs-selector-tag">DEFAULT</span> <span class="hljs-selector-tag">CHARSET</span>=<span class="hljs-selector-tag">utf8</span> <span class="hljs-selector-tag">COMMENT</span>='指标实现';
</code></pre>
<h5 data-id="heading-9">3.1.2.2 实践分析</h5>
<p>通过mysql的innoDB的锁决策，可以得出</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">//删除关联指标</span>
 <span class="hljs-selector-tag">metricImplMapper</span><span class="hljs-selector-class">.deleteByLogicTableIds</span>(Collections.<span class="hljs-built_in">singletonList</span>(logicId));
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">delete <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-number">45631</span></span>)</span>;
</code></pre>
<p>mysql的索引：KEY <code>idx_metric_def_id</code> (<code>metric_def_id</code>,<code>logic_table_id</code>)</p>
<p>删除写操作，不符合最左匹配原则，因此为表x锁。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99194a4d15d54c0191109be0686aee3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=0yUr5CBGAqfBkmNs%2F%2Fhvd9R7yVg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>因此请求2的删除操作需要等待请求1的事务释放表锁后才可继续进行，符合当时场景。</p>
<p>﻿</p>
<h3 data-id="heading-10">3.2 分析结论二</h3>
<p>请求2中去查看当前实现的指标的时候，发现库里已经存在所有指标不会进行新增，与上一步删除的逻辑相悖。</p>
<h4 data-id="heading-11">3.2.1 复习Mysql的事务</h4>
<h5 data-id="heading-12">3.2.1.1 ACID 不是 "四个独立特性"，而是 "因果链"</h5>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd42117c88e478ca165db2bec4947f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=GauWe4zg0sQbWvYSqOG%2FMF6Mm4Q%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>一句话</strong>：ACID 的核心是<strong>一致性</strong>，其他三个特性都是为了实现它的手段。</p>
<p>•<strong>一致性</strong>（Consistency）：一致性确保事务将数据库从一个一致的状态转变到另一个一致的状态。即使在多个事务同时执行的情况下，数据库也能保持数据的一致性。</p>
<p>•<strong>原子性</strong>（Atomicity）：事务是 "不可分割的工作单元"（要么全成，要么全败），是一致性的<strong>前提</strong>（如果步骤能拆分，中间失败就会破坏一致性）。</p>
<p>•<strong>隔离性</strong>（Isolation）：通过控制多事务并发规则，避免互相干扰，是一致性的<strong>保障</strong>（并发混乱会直接破坏一致性）。</p>
<p>•<strong>耐久性</strong>（Durability）：事务提交后结果永久保存，是一致性的<strong>最终落点</strong>（否则重启后数据丢失，之前的一致性白搭）。</p>
<p>﻿</p>
<h5 data-id="heading-13">3.2.1.2 隔离级别：不是 "越严越好"，而是 "成本与需求的平衡术"</h5>
<p>InnoDB 的 4 种隔离级别，本质是用 "数据可见性" 换 "并发性能"的选择：</p>








































<table><thead><tr><th>隔离级别</th><th>解决的问题</th><th>无法解决的问题</th><th>性能消耗</th><th>典型场景</th></tr></thead><tbody><tr><td>读未提交（RU）</td><td>无</td><td>脏读、不可重复读、幻读</td><td>极低</td><td>实时监控（允许脏数据）</td></tr><tr><td>读已提交（RC）</td><td>脏读</td><td>不可重复读、幻读</td><td>低</td><td>互联网普通业务</td></tr><tr><td>可重复读（RR，默认）</td><td>脏读、不可重复读</td><td>幻读（被 Next-Key 锁解决）</td><td>中</td><td>金融交易、库存管理</td></tr><tr><td>串行化（Serializable）</td><td>所有并发问题</td><td>无</td><td>极高</td><td>银行对账（无并发需求）</td></tr></tbody></table>
<p>﻿</p>
<h5 data-id="heading-14">3.2.1.3 MVCC：事务的 "平行宇宙" 机制（为什么读写不冲突？）</h5>
<p>InnoDB 的<strong>多版本并发控制</strong>是 "无锁读" 的核心，它让读和写像在平行宇宙中运行：</p>
<p><strong>底层逻辑（用 "时间戳" 理解</strong>）：</p>
<p>•每个事务启动时，会拿到一个<strong>全局递增的事务 ID（trx_id）</strong> 。</p>
<p>•每行数据隐藏 3 个字段：</p>
<p>◦<code>DB_TRX_ID</code>：最后修改该行的事务 ID；</p>
<p>◦<code>DB_ROLL_PTR</code>：指向 undo 日志的指针（存储历史版本）；</p>
<p>◦<code>DB_DELETED</code>：标记是否删除（逻辑删除）。</p>
<p><strong>读操作的 "幻术"</strong> ：</p>
<p>•<strong>快照读</strong>（普通 SELECT）：只看 "事务 ID ≤ 自己 ID" 且 "未被删除" 的版本，完全不加锁。 例：事务 A（ID=100）查询时，会忽略所有被 ID&gt;100 的事务修改的数据。</p>
<p>包含 4 个核心字段：</p>
<p>•<code>m_ids</code>：生成 Read View 时，<strong>当前活跃的事务 ID 列表</strong>（未提交的事务）。</p>
<p>•<code>min_trx_id</code>：<code>m_ids</code>中最小的事务 ID。</p>
<p>•<code>max_trx_id</code>：下一个将要分配的事务 ID（非活跃事务 ID，仅用于判断 “未来事务”）。</p>
<p>•<code>creator_trx_id</code>：生成该 Read View 的事务自身 ID。</p>
<p><strong>可见性判断规则</strong>（一条记录是否对当前事务可见，取决于其 “最后修改事务 ID”，记为<code>db_trx_id</code>）：</p>
<p>1.若db_trx_id == creator_trx_id：可见（自己修改的自己可见）。</p>
<p>2.若db_trx_id &lt; min_trx_id：可见（修改记录的事务在当前快照生成前已提交）。</p>
<p>3.若db_trx_id &gt;= max_trx_id：不可见（修改记录的事务在当前快照生成后才启动）。</p>
<p>4.若min_trx_id ≤ db_trx_id &lt; max_trx_id：</p>
<p>◦若db_trx_id在m_ids中：不可见（该事务仍活跃，未提交）。</p>
<p>◦若db_trx_id不在m_ids中：可见（该事务已提交）。</p>
<p>5.当前读（加锁读 / 写操作）：读取最新版本，并加锁防止其他事务修改。</p>
<h5 data-id="heading-15">3.2.1.4 事务日志：InnoDB 的 "安全与性能" 平衡术</h5>
<p>事务能既保证 durability 又不慢，全靠两大日志：</p>
<p>1.<strong>redo log（重做日志）</strong> ：</p>
<p>◦作用：崩溃后恢复未写入磁盘的数据（保证 durability）。</p>
<p>◦反直觉：事务提交时，数据先写 redo log（内存 + 磁盘），再异步刷到数据文件（这叫 WAL 技术）。</p>
<p>◦为什么快？redo log 是<strong>顺序写</strong>（磁盘顺序写比随机写快 100 倍 +）。</p>
<p>2.<strong>undo log（回滚日志）</strong> ：</p>
<p>◦作用：保存数据修改前的版本，用于事务回滚（保证 atomicity）和 MVCC 快照读。</p>
<p>◦注意：undo log 会被 purge 线程定期清理（当没有事务需要旧版本时）。</p>
<h5 data-id="heading-16">3.2.1.5 终极心法：事务设计的 "3 个凡是"</h5>
<p>1.<strong>凡是不需要事务的操作，坚决不用</strong>（如日志插入可关闭自动提交，批量提交）。</p>
<p>2.<strong>凡是能在 RC 解决的，绝不升 RR</strong>（互联网业务优先选 RC，用业务逻辑防不可重复读）。</p>
<p>3.<strong>凡是大事务，必拆分成 "读 - 算 - 写" 三步</strong>（读阶段不加锁，算阶段在应用层，写阶段用最短事务加锁）。</p>
<p>记住：事务的本质不是 "约束"，而是 "工具"—— 能解决问题的最简单事务，才是最好的事务。</p>
<p>﻿</p>
<h4 data-id="heading-17">3.2.2 理论应用实践</h4>
<h5 data-id="heading-18">3.2.2.1 本次事故的物料：</h5>
<p>表的事务等级：</p>
<pre><code class="hljs language-scss" lang="scss">SELECT @<span class="hljs-keyword">@transaction</span>_isolation;
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e9bed606d5345bb811ff2d41995659f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=S8WVV%2FOWw9D4Y6lUA3hODMHPyDE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>需要删除的指标实现(根据实现id):</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">delete <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-number">45631</span></span>)</span>;
</code></pre>
<p>需要插入的指标实现：</p>
<pre><code class="hljs language-go" lang="go">INSERT INTO <span class="hljs-string">`unify_metric_impl`</span> (<span class="hljs-string">`id`</span>, <span class="hljs-string">`metric_def_id`</span>, <span class="hljs-string">`logic_table_id`</span>, <span class="hljs-string">`name_en_atomic`</span>, <span class="hljs-string">`committer`</span>, <span class="hljs-string">`create_time`</span>, <span class="hljs-string">`update_time`</span>, <span class="hljs-string">`metric_atomic_name_temp`</span>, <span class="hljs-string">`decorate_id_list_temp`</span>, <span class="hljs-string">`name_cn_alias_temp`</span>, <span class="hljs-string">`metric_type_temp`</span>, <span class="hljs-string">`description_temp`</span>, <span class="hljs-string">`data_type_temp`</span>, <span class="hljs-string">`data_accuracy_temp`</span>, <span class="hljs-string">`security_level_temp`</span>, <span class="hljs-string">`logic_table_id_excel_temp`</span>, <span class="hljs-string">`implement_type`</span>, <span class="hljs-string">`app_ori_metric_name_temp`</span>, <span class="hljs-string">`name_en_depend_atomic`</span>, <span class="hljs-string">`name_en_depend_app`</span>, <span class="hljs-string">`update_status`</span>, <span class="hljs-string">`status`</span>, <span class="hljs-string">`light_decorate_id_list`</span>, <span class="hljs-string">`extend_decorate_id_list`</span>, <span class="hljs-string">`extend_function_id_list`</span>, <span class="hljs-string">`aggregation_type`</span>, <span class="hljs-string">`middle_aggregation_type`</span>, <span class="hljs-string">`static_decorate_id_list_combination`</span>)
VALUES
	(<span class="hljs-number">1358195</span>, <span class="hljs-number">19872</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358196</span>, <span class="hljs-number">19873</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358197</span>, <span class="hljs-number">19875</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358198</span>, <span class="hljs-number">19945</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_sku_deal_ord_sku_dis_qtty_main_img_video_num'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358199</span>, <span class="hljs-number">17263</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358200</span>, <span class="hljs-number">28017</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_bd_bd_attendance_offline__store_cnt_bd_attendance_cnt'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'COUNT_DISTINCT'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358201</span>, <span class="hljs-number">20242</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358202</span>, <span class="hljs-number">18450</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358203</span>, <span class="hljs-number">20276</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_cnt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358204</span>, <span class="hljs-number">18452</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358205</span>, <span class="hljs-number">18453</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358206</span>, <span class="hljs-number">18456</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358207</span>, <span class="hljs-number">19866</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358208</span>, <span class="hljs-number">21691</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_include_moutai'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358209</span>, <span class="hljs-number">19871</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>);
</code></pre>
<h5 data-id="heading-19">3.2.2.2 实践分析：</h5>
<p>用sql模拟两个事务的执行过程：</p>
<p>事务1：</p>
<pre><code class="hljs language-javascript" lang="javascript">begin;

select * <span class="hljs-keyword">from</span> unify_metric_impl umi where logic_table_id =  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> unify_metric_impl where logic_table_id <span class="hljs-keyword">in</span> (<span class="hljs-number">45631</span>);

<span class="hljs-variable constant_">SELECT</span> trx_id, trx_query <span class="hljs-variable constant_">FROM</span> <span class="hljs-variable constant_">INFORMATION_SCHEMA</span>.<span class="hljs-property">INNODB_TRX</span>;

select * <span class="hljs-keyword">from</span> unify_metric_impl umi where logic_table_id =  <span class="hljs-number">45631</span>;

<span class="hljs-variable constant_">INSERT</span> <span class="hljs-variable constant_">INTO</span> <span class="hljs-string">`unify_metric_impl`</span> ( <span class="hljs-string">`metric_def_id`</span>, <span class="hljs-string">`logic_table_id`</span>, <span class="hljs-string">`name_en_atomic`</span>, <span class="hljs-string">`committer`</span>, <span class="hljs-string">`create_time`</span>, <span class="hljs-string">`update_time`</span>, <span class="hljs-string">`metric_atomic_name_temp`</span>, <span class="hljs-string">`decorate_id_list_temp`</span>, <span class="hljs-string">`name_cn_alias_temp`</span>, <span class="hljs-string">`metric_type_temp`</span>, <span class="hljs-string">`description_temp`</span>, <span class="hljs-string">`data_type_temp`</span>, <span class="hljs-string">`data_accuracy_temp`</span>, <span class="hljs-string">`security_level_temp`</span>, <span class="hljs-string">`logic_table_id_excel_temp`</span>, <span class="hljs-string">`implement_type`</span>, <span class="hljs-string">`app_ori_metric_name_temp`</span>, <span class="hljs-string">`name_en_depend_atomic`</span>, <span class="hljs-string">`name_en_depend_app`</span>, <span class="hljs-string">`update_status`</span>, <span class="hljs-string">`status`</span>, <span class="hljs-string">`light_decorate_id_list`</span>, <span class="hljs-string">`extend_decorate_id_list`</span>, <span class="hljs-string">`extend_function_id_list`</span>, <span class="hljs-string">`aggregation_type`</span>, <span class="hljs-string">`middle_aggregation_type`</span>, <span class="hljs-string">`static_decorate_id_list_combination`</span>)
<span class="hljs-variable constant_">VALUES</span>
	(<span class="hljs-number">19872</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19873</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19875</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19945</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_sku_deal_ord_sku_dis_qtty_main_img_video_num'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">17263</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">28017</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_bd_bd_attendance_offline__store_cnt_bd_attendance_cnt'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'COUNT_DISTINCT'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">20242</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18450</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">20276</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_cnt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18452</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18453</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18456</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19866</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">21691</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_include_moutai'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19871</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>);

commit;
</code></pre>
<p>﻿</p>
<p>事务2：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">begin</span>;

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> unify_metric_impl umi <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-operator">=</span>  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-keyword">in</span> (<span class="hljs-number">45631</span>);

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> unify_metric_impl umi <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-operator">=</span>  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">commit</span>;
</code></pre>
<p>﻿</p>
<p>流程图(用一行数据进行演示版本控制)：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259104ee5b684d4cad1073bfca57cde9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=FLMhTrOT5MG0zGyr571kYG0R7X4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>为何事务1的select查询出“为空”，事务2的select查询出“不为空”：</p>






























<table><thead><tr><th>对比维度</th><th>事务 1 查询（读自己的删除版本 V2）</th><th>事务 2 查询（读readview前的V1版本）</th></tr></thead><tbody><tr><td>自己生成的版本</td><td>V2（trx_id=17190，已删除）</td><td>V4（trx_id=17191，已删除）</td></tr><tr><td>对自己版本的处理</td><td>可见，且<strong>事务内需反映自己的删除操作</strong>，所以不追溯前驱 V1</td><td>不可见，但<strong>当前删除的版本是由其他事务得到(V3)</strong> ，并非在readview之前的数据。</td></tr><tr><td>追溯的终止条件</td><td>遇到自己生成的版本，即使已删除，也终止追溯</td><td>遇到自己生成的已删除版本，但不符合"有效删除"，需继续追溯</td></tr><tr><td>最终返回结果</td><td>v2（已删除版本，反映自己的删除操作）</td><td>V1（readview之前有效的版本）</td></tr></tbody></table>
<p>﻿</p>
<h2 data-id="heading-20">4.解决办法</h2>
<p>为了解决事务2的查询"不为空"的问题，分别列出以下方案：</p>

































<table><thead><tr><th>﻿</th><th>解决办法</th><th>优点</th><th>缺点</th><th>倾向</th></tr></thead><tbody><tr><td>方式1</td><td>针对同一个逻辑表的同步添加分布式锁</td><td>实现成本低，影响范围小</td><td>存在长事务的问题</td><td>短期解法</td></tr><tr><td>方式2</td><td>将事务2的select改为当前读(使用slecet...for update)，这样就能查询出最新的数据为空</td><td>实现成本低，</td><td>存在长事务的问题，影响范围大(长事务涉及逻辑多)</td><td>不推荐</td></tr><tr><td>方式3</td><td>将长事务拆分， <strong>"读 - 算 - 写" 三步</strong> 1. 读：无锁读取原子服务与实现数据； 2. 算：在应用层对比新增 / 删除数据； 3. 写：仅对差异数据执行短事务操作</td><td>从根源解决问题</td><td>实现成本大，重构该方法</td><td>长期解法</td></tr></tbody></table>
<p><strong>当前落地情况</strong>：已通过 “分布式锁控制同一逻辑表同步并发” 的短期方案解决事故，后续将在业务迭代中推进 “读 - 算 - 写” 拆分的长期优化，进一步降低事务粒度与锁冲突风险。</p>
<h2 data-id="heading-21">5.附录</h2>
<h3 data-id="heading-22">5.1名词解释</h3>
<p>事实逻辑表：由物理数仓中的事实表和维度逻辑表关联形成的语义表，可以描述业务过程的详细信息，是指标的数据来源。</p>
<p>原子服务：指标的实现方式，一个指标可以有多个实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KuiklyUI的ViewRef设计]]></title>    <link>https://juejin.cn/post/7570902804450934794</link>    <guid>https://juejin.cn/post/7570902804450934794</guid>    <pubDate>2025-11-10T09:55:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570902804450934794" data-draft-id="7570902804450836490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KuiklyUI的ViewRef设计"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-10T09:55:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KuiklyUI的ViewRef设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T09:55:33.000Z" title="Mon Nov 10 2025 09:55:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer的关系分析</h2>
<p>本文将深入分析KuiklyUI框架中nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer与ViewRef之间的关系，帮助您全面理解视图引用系统的设计与实现。</p>
<h3 data-id="heading-1">一、nativeRef的本质与工作机制</h3>
<h4 data-id="heading-2">1.1 nativeRef的定义与生成机制</h4>
<p>nativeRef是KuiklyUI中每个视图实例的唯一标识符，定义在AbstractBaseView类中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt">abstract class AbstractBaseView&lt;A : Attr, E : Event&gt; : BaseObject(), IViewPublicApi&lt;A, E&gt;, IModuleAccessor, IPagerId {
    val nativeRef: Int = ++nativeRefProducer
    // ...
    companion object {
        var nativeRefProducer = 0
    }
}
</code></pre>
<p>nativeRef通过一个静态计数器<code>nativeRefProducer</code>自增生成，确保每个视图实例拥有全局唯一的标识符。这种设计使得框架可以在整个应用生命周期内精确识别每一个视图。</p>
<h4 data-id="heading-3">1.2 nativeRef在视图系统中的核心作用</h4>
<p>nativeRef在KuiklyUI框架中扮演着多重关键角色：</p>
<ol>
<li><strong>视图身份标识</strong>：作为视图实例的唯一身份标识</li>
<li><strong>视图引用传递</strong>：在父子视图之间传递引用关系</li>
<li><strong>跨层通信桥梁</strong>：连接Kotlin层与原生渲染层</li>
<li><strong>属性与事件绑定</strong>：在创建Attr和Event对象时被注入，用于后续属性更新和事件分发</li>
</ol>
<p>在AbstractBaseView的内部实现中，我们可以看到nativeRef被注入到Attr和Event对象中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt">private fun internalCreateEvent(): E {
    val event = createEvent()
    event.init(pagerId,nativeRef)  // 将nativeRef注入到Event对象
    return event
}

protected fun internalCreateAttr(): A {
    val attr = createAttr()
    attr.pagerId = pagerId
    attr.nativeRef = nativeRef  // 将nativeRef注入到Attr对象
    attr.flexNode = flexNode
    return attr
}
</code></pre>
<h3 data-id="heading-4">二、ViewRef与nativeRef的关系</h3>
<h4 data-id="heading-5">2.1 ViewRef的定义与实现</h4>
<p>ViewRef是一个轻量级的引用封装类，定义在DeclarativeBaseView.kt中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/DeclarativeBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/DeclarativeBaseView.kt">class ViewRef&lt;T : DeclarativeBaseView&lt;*, *&gt;&gt;(val pagerId: String, val nativeRef: Int) {
    val view: T?
        get() = PagerManager.getPager(pagerId)
            .getViewWithNativeRef(nativeRef) as? T
}
</code></pre>
<h4 data-id="heading-6">2.2 ViewRef与nativeRef的协作关系</h4>
<p>ViewRef与nativeRef之间存在着紧密的协作关系：</p>
<ol>
<li><strong>组成关系</strong>：ViewRef封装了pagerId和nativeRef两个核心属性</li>
<li><strong>定位机制</strong>：ViewRef通过pagerId和nativeRef组合定位到具体的视图实例</li>
<li><strong>延迟查找</strong>：ViewRef的<code>view</code>属性采用懒加载方式，只有在需要时才通过PagerManager查找视图</li>
<li><strong>类型安全</strong>：ViewRef使用泛型确保返回的视图类型正确</li>
</ol>
<h3 data-id="heading-7">三、ViewRef与AbstractBaseView的关系</h3>
<h4 data-id="heading-8">3.1 ref扩展函数的实现</h4>
<p>在DeclarativeBaseView中，实现了<code>ref</code>扩展函数，作为创建ViewRef的入口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : DeclarativeBaseView&lt;*, *&gt;</span>&gt; T.<span class="hljs-title">ref</span><span class="hljs-params">(ref: (<span class="hljs-type">viewRef</span>: <span class="hljs-type">ViewRef</span>&lt;<span class="hljs-type">T</span>&gt;) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    ref(ViewRef&lt;T&gt;(pagerId, nativeRef))
}
</code></pre>
<h4 data-id="heading-9">3.2 AbstractBaseView与ViewRef的交互流程</h4>
<p>AbstractBaseView与ViewRef的交互流程如下：</p>
<ol>
<li>AbstractBaseView实例创建时生成唯一的nativeRef</li>
<li>通过ref扩展函数，将当前视图的pagerId和nativeRef传递给ViewRef构造函数</li>
<li>ViewRef持有这些引用信息，但不直接持有视图实例</li>
<li>当需要访问视图时，通过ViewRef的<code>view</code>属性间接获取</li>
</ol>
<p>这种设计实现了视图引用的解耦，使框架能够更灵活地管理视图生命周期和内存。</p>
<h3 data-id="heading-10">四、ViewRef与Pager的协作机制</h3>
<h4 data-id="heading-11">4.1 Pager的视图引用管理</h4>
<p>Pager类实现了IPager接口，负责管理视图引用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Pager中管理视图引用的关键代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nativeRefViewMap = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, AbstractBaseView&lt;*, *&gt;&gt;()

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">putNativeViewRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>, view: <span class="hljs-type">AbstractBaseView</span>&lt;*, *&gt;)</span></span> {
    nativeRefViewMap[nativeRef] = view
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeNativeViewRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>)</span></span> {
    nativeRefViewMap.remove(nativeRef)
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewWithNativeRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>)</span></span>: AbstractBaseView&lt;*, *&gt;? {
    <span class="hljs-keyword">return</span> nativeRefViewMap[nativeRef]
}
</code></pre>
<h4 data-id="heading-12">4.2 ViewRef与Pager的协作流程</h4>
<p>ViewRef与Pager的协作流程如下：</p>
<ol>
<li>ViewRef持有pagerId和nativeRef信息</li>
<li>当调用ViewRef的<code>view</code>属性时，通过PagerManager获取对应pagerId的Pager实例</li>
<li>调用Pager的<code>getViewWithNativeRef</code>方法，通过nativeRef查找视图实例</li>
<li>将找到的视图实例转换为泛型T类型并返回</li>
</ol>
<p>这种设计使得ViewRef可以安全地在任何地方访问视图，而不需要直接持有视图实例的强引用，有利于内存管理和视图生命周期控制。</p>
<h3 data-id="heading-13">五、ViewContainer与ViewRef的关系</h3>
<h4 data-id="heading-14">5.1 ViewContainer的视图层次管理</h4>
<p>ViewContainer是所有容器视图的基类，负责管理子视图层次结构：</p>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">abstract class ViewContainer&lt;A : ContainerAttr, E : Event&gt; : DeclarativeBaseView&lt;A, E&gt;() {
    protected val children = fastArrayListOf&lt;DeclarativeBaseView&lt;*, *&gt;&gt;()
    // ...
}
</code></pre>
<h4 data-id="heading-15">5.2 ViewContainer中nativeRef的应用</h4>
<p>在ViewContainer中，nativeRef主要用于以下几个方面：</p>
<ol>
<li><strong>父视图引用传递</strong>：在添加子视图时，设置子视图的parentRef为当前容器的nativeRef</li>
</ol>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">private fun internalAddChild(child: DeclarativeBaseView&lt;*, *&gt;, index: Int) {
    child.pagerId = pagerId
    child.willMoveToParentComponent()
    if (index &lt; 0) { // append when index -1
        children.add(child)
    } else {
        children.add(index, child)
    }
    child.parentRef = nativeRef  // 设置父视图引用
    child.didMoveToParentView()
}
</code></pre>
<ol start="2">
<li><strong>渲染视图管理</strong>：在创建和移除渲染视图时，使用nativeRef标识视图</li>
</ol>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">override fun createRenderView() {
    createRenderViewing = true
    super.createRenderView()
    createRenderViewing = false
    var index = 0
    renderChildren().forEach { child -&gt;
        child.createRenderView()
        renderView?.insertSubRenderView(child.nativeRef, index++)  // 使用nativeRef标识子视图
        child.renderViewDidMoveToParentRenderView()
    }
}
</code></pre>
<ol start="3">
<li><strong>视图引用链建立</strong>：通过nativeRef和parentRef建立完整的视图引用链</li>
</ol>
<h4 data-id="heading-16">5.3 ViewContainer中ViewRef的使用场景</h4>
<p>在ViewContainer中，ViewRef主要用于以下场景：</p>
<ol>
<li><strong>子视图引用获取</strong>：通过ViewRef安全地获取子视图引用，进行操作或通信</li>
<li><strong>跨层级视图访问</strong>：在复杂布局中，通过ViewRef实现跨层级的视图访问</li>
<li><strong>视图生命周期管理</strong>：在视图添加、移除等生命周期事件中，通过ViewRef传递引用信息</li>
</ol>
<h3 data-id="heading-17">六、整体架构与数据流</h3>
<h4 data-id="heading-18">6.1 核心组件关系图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+      +------------------+      +------------------+</span>
|                  |      |                  |      |                  |
|  AbstractBaseView|&lt;<span class="hljs-comment">-----&gt;|    ViewRef       |&lt;-----&gt;|     Pager        |</span>
|                  |      |                  |      |                  |
+<span class="hljs-comment">--------^---------+      +------------------+      +------------------+</span>
         |
         |
+<span class="hljs-comment">--------+---------+      +------------------+</span>
|                  |      |                  |
|  ViewContainer   |&lt;<span class="hljs-comment">-----&gt;|   Declarative   |</span>
|                  |      |     BaseView     |
+<span class="hljs-comment">------------------+      +------------------+</span>
</code></pre>
<h4 data-id="heading-19">6.2 数据流向与交互模式</h4>
<p>在KuiklyUI的视图引用系统中，数据流向和交互模式如下：</p>
<ol>
<li><strong>创建阶段</strong>：视图实例创建时生成nativeRef，Pager注册视图引用</li>
<li><strong>引用封装</strong>：通过ref扩展函数创建ViewRef对象，封装pagerId和nativeRef</li>
<li><strong>引用访问</strong>：通过ViewRef的view属性，间接访问视图实例</li>
<li><strong>生命周期管理</strong>：在视图添加到容器或从容器移除时，更新parentRef和视图引用注册状态</li>
<li><strong>销毁阶段</strong>：视图销毁时，从Pager中移除视图引用</li>
</ol>
<h3 data-id="heading-20">七、设计优势与技术亮点</h3>
<h4 data-id="heading-21">7.1 设计优势</h4>
<ol>
<li><strong>解耦视图引用</strong>：ViewRef通过间接引用机制，实现了视图引用与视图实例的解耦</li>
<li><strong>内存优化</strong>：避免了不必要的强引用，有利于内存管理和垃圾回收</li>
<li><strong>类型安全</strong>：泛型设计确保了类型安全，减少了运行时类型转换错误</li>
<li><strong>灵活的视图访问</strong>：可以在任何地方通过ViewRef安全地访问视图，不受生命周期限制</li>
</ol>
<h4 data-id="heading-22">7.2 技术亮点</h4>
<ol>
<li><strong>唯一标识符生成机制</strong>：通过静态计数器生成全局唯一的nativeRef</li>
<li><strong>延迟查找策略</strong>：ViewRef的view属性采用懒加载方式，只有在需要时才查找视图</li>
<li><strong>引用链管理</strong>：通过nativeRef和parentRef建立完整的视图层次引用链</li>
<li><strong>跨平台兼容性</strong>：设计考虑了跨平台需求，nativeRef作为统一的视图标识符</li>
</ol>
<h3 data-id="heading-23">八、代码优化建议</h3>
<p>基于对ViewRef和nativeRef系统的分析，提出以下优化建议：</p>
<ol>
<li>
<p><strong>引用有效性检查增强</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在ViewRef的view属性中添加更完善的有效性检查</span>
<span class="hljs-keyword">val</span> view: T?
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">val</span> pager = PagerManager.getPager(pagerId)
        <span class="hljs-keyword">if</span> (pager == <span class="hljs-literal">null</span> || !pager.isActive()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">val</span> view = pager.getViewWithNativeRef(nativeRef) <span class="hljs-keyword">as</span>? T
        <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span> &amp;&amp; view.isDestroyed()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">return</span> view
    }
</code></pre>
</li>
<li>
<p><strong>弱引用优化</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在Pager中考虑使用WeakReference存储视图引用，避免内存泄漏</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nativeRefViewMap = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, WeakReference&lt;AbstractBaseView&lt;*, *&gt;&gt;&gt;()
</code></pre>
</li>
<li>
<p><strong>引用缓存机制</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为频繁访问的ViewRef添加缓存机制</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRef</span>&lt;<span class="hljs-type">T : DeclarativeBaseView&lt;*, *</span>&gt;&gt;(<span class="hljs-keyword">val</span> pagerId: String, <span class="hljs-keyword">val</span> nativeRef: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cachedView: T? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastCacheTime: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">val</span> view: T?
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
            <span class="hljs-comment">// 缓存有效期100ms</span>
            <span class="hljs-keyword">if</span> (cachedView != <span class="hljs-literal">null</span> &amp;&amp; currentTime - lastCacheTime &lt; <span class="hljs-number">100</span>) {
                <span class="hljs-keyword">return</span> cachedView
            }
            cachedView = PagerManager.getPager(pagerId)
                .getViewWithNativeRef(nativeRef) <span class="hljs-keyword">as</span>? T
            lastCacheTime = currentTime
            <span class="hljs-keyword">return</span> cachedView
        }
}
</code></pre>
</li>
</ol>
<p>总结来看，nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer之间形成了一套完整、高效的视图引用管理体系，为KuiklyUI框架提供了灵活、安全的视图访问机制。通过这种设计，框架能够有效地管理视图生命周期、优化内存使用，并提供一致的跨平台体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>