<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[「腾讯云NoSQL」技术之MongoDB篇:MongoDB 5.0→8.0 balance性能提升40%内幕揭秘]]></title>    <link>https://juejin.cn/post/7571379089991417910</link>    <guid>https://juejin.cn/post/7571379089991417910</guid>    <pubDate>2025-11-12T02:40:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991417910" data-draft-id="7571281406510596147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「腾讯云NoSQL」技术之MongoDB篇:MongoDB 5.0→8.0 balance性能提升40%内幕揭秘"/> <meta itemprop="keywords" content="NoSQL,数据库"/> <meta itemprop="datePublished" content="2025-11-12T02:40:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云数据库"/> <meta itemprop="url" content="https://juejin.cn/user/3227821871466094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「腾讯云NoSQL」技术之MongoDB篇:MongoDB 5.0→8.0 balance性能提升40%内幕揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821871466094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云数据库
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:40:51.000Z" title="Wed Nov 12 2025 02:40:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">「腾讯云NoSQL」技术之MongoDB篇:MongoDB 5.0→8.0 balance性能提升40%内幕揭秘</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57f63e77e10c4b49975aa368f55b2b70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=doKY%2BunJz%2FFAOrvnTsQuEtg6Y0s%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>在分布式数据库架构中，数据自动均衡（Balance）机制是分片集群良好运行的基石，它确保分片的优势——性能、可扩展性和可用得到充分发挥。腾讯云NoSQL和内核团队在内核性能基准测试中发现：MongoDB 6.0.3 及后续版本，其 Balance 数据迁移效率相比5.0版本获得了30%至45%的显著提升，这一性能的提升意味着 MongoDB 在面对数据不均时具备更强的自我调节能力，更好地防止某些分片上出现热点，从而提升整个集群的吞吐量和查询速度，为了更好地了解 MongoDB 性能提升背后的技术原理，腾讯云 NoSQL 和内核团队对 MongoDB 内核发起了源码级深度剖析，本文将系统性阐释balance的触发机制、迁移流程与性能调优方法，并对 7.0、8.0 版本 balance 的调优进行剖析。 希望本文能为各位同事在架构设计、性能优化和客户业务问题排查上提供有力的理论支持与实践指导。</p>
<p>在 MongoDB 分片集群中，均衡器（Balance）的重要性在于通过自动在分片间移动数据（块）来确保数据均匀分布。这个过程对于维持最佳性能和可扩展性至关重要，因为它能防止某些分片上出现热点，从而提升整个集群的吞吐量和查询速度。若禁用均衡器会导致分片数据不均，进而降低集群性能，因此持续运行均衡器对于维护健康高效的分片系统至关重要，确保分片的性能、可扩展性和可用性得到充分发挥。腾讯云MongoDB和内核团队对 MongoDB 内核 balance 性能测试时，发现<strong>6.0.3及其以后版本的 balance 数据迁移性能整体比 5.0 好大约 30% - 45%</strong> 。为什么 6.0 及其以上版本 balance 性能提升这么大？为何高版本 chunk 分布不均衡？为何高版本 split 对业务无影响？带着这些疑惑，<strong>腾讯云 MongoDB 和内核团队</strong>结合 MongoDB 内核 (包括 6.0、7.0、8.0 )源码对 balance 原理做了一次深入的研究分析。本文主要以 MongoDB 8.0.10 内核代码进行原理分析。</p>
<p>本文作者：萌哥（杨亚洲）、尹超</p>
</blockquote>
<h2 data-id="heading-1"><strong>1 balance 触发条件及其实现</strong></h2>
<p>当 config server 选出主节点后会创建一个“Balancer”线程，该线程负责判断集群中所有分片表数据是否均衡，是否需要触发做数据迁移操作</p>
<h3 data-id="heading-2"/>
<h3 data-id="heading-3">1.1 数据不均衡判断</h3>
<h4 data-id="heading-4">1.1.1 获取分片表信息</h4>
<p>由于启用分片功能的表信息存储在 config.collections 中， config server通过内部的 local client 来获取 config.collections 表中的信息。获取表中内容sql如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/952588f1e2344d74b721dcd773b3b2ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=0D4g1Mn2Zv1xRwa2C89%2FL3DJn2E%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">1.1.2 获取分片表在每个分片的stats信息</h4>
<p>config server会向分片集群的所有shard广播发送 _shardsvrGetStatsForBalancing 命令来获取表的 stats 统计。</p>
<p>● 单分片表场景</p>
<p>假设只有一个分片表 collection1，则 _shardsvrGetStatsForBalancing 广播到所有分片：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e53b0d899d33431b888c46c11cafca27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=jXTKEM%2FSl%2FUPGs%2BsDepzzPz%2BWZ0%3D" alt="image.png" loading="lazy"/></p>
<p>各个 shard 收到后，本地获取该表的数据大小返回给 config server ，内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18ea02048a724990b9701115eb45b434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=cENZxtkadILBHMONDUc5GXGC2YE%3D" alt="image.png" loading="lazy"/></p>
<p>● 多分片表场景</p>
<p>如果该分片集群有多个分片表，“Blancer”线程按照100个分片表一组在一个 _shardsvrGetStatsForBalancing 请求中携带所有分片表广播给所有shard，各个 shard 收到该请求后，会一次性把本节点上这一批表的 stats 信息返回。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13b8398b434f4db69bb2d31d7b9f7ec0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=4WkCpdSW0tdzq6CPAGEeFVMpwic%3D" alt="image.png" loading="lazy"/></p>
<p>一次批量获取100个表 stats 信息，内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcd13c8731854648a79fcf66560d6cfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=9kfms8%2BO5PTfToOAgxGpWjaSJu8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">1.2 迁移场景及迁移优先级</h3>
<p>获取到各个 shard 的 stats 数据后，config server 在以下场景会触发数据迁移：</p>
<p>迁移场景</p>
<ol>
<li>draining 分片迁移：</li>
</ol>
<p>该表在某些 shard 有数据，如果该 shard 从分片集群中移除，这个场景比较好理解。</p>
<ol start="2">
<li>zone 约束违规：</li>
</ol>
<p>约束违规，主要在 addTagRange 调整的时候容易触发，具体举例详见附录详情文档。</p>
<p>3 <strong>.</strong> 普通数据表不均衡场景：</p>
<p>普通分片表各个 shard 数据差异大，这是最常见的 balance 迁移场景。</p>
<p>以上三种场景有优先级限制，draining 分片优先级最高，zone 约束违规次之，普通数据不均衡场景优先级最低。只有在高优先级场景的 chunk 数据迁移完成后，才会执行低优先级场景的 chunk 数据迁移。</p>
<h3 data-id="heading-7">1.3 确定需要迁移的源分片和目标分片</h3>
<p>Config server 获取到分片表在每个分片上的 stats (表数据量)信息后，会选出表数据量最大的分片和最小的分片，下面举例说明确定源和目标分片的步骤：</p>
<p>● 确定各分片数据分布</p>
<p>假设某 collection 在四个分片的数据分布如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b0e0d3ff4a74f4db499d39592ec7e42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=gR8A8yHpVNucAoeaytVk78at8rw%3D" alt="image.png" loading="lazy"/></p>
<p>集群4个 shard，数据分布从1G – 4G，分片间数据存在不均衡现象。</p>
<p>● 计算理想数据分布</p>
<p>根据各个分片的 stats 信息计算理想数据分布，以计算过程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b7eb103b4164b6f8925091e74d18009~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=dKhImLy9vqO1jO%2B73F6xLjhkj1Y%3D" alt="image.png" loading="lazy"/></p>
<p>numShardsInZone：代表分片数，4个分片</p>
<p>totalDataSizeOfShardsWithZone：代表数据总和 = 4G + 1G+ 2G + 3G = 10G</p>
<p>idealDataSizePerShardForZone：代表各个shard理想分布 = totalDataSizeOfShardsWithZone / numShardsInZone = 10G / 4 = 2.5G</p>
<p>● 源分片和目标分片选择</p>
<p>获取到每个 shard 的数据量，从而可以计算出 shard0001 数据量最多，所以选择 shard0001 作为源分片。</p>
<p>同理，因为 shard0002 数据量最少，因此被选为目标分片。选择算法举例参考附录详情。</p>
<h3 data-id="heading-8">1.4 生成迁移任务，通知源分片开始数据迁移</h3>
<p>● 迁移条件判断</p>
<p>选出源分片和目标分片后，还需要满足以下3个条件才会生成迁移任务：</p>
<p>1.源分片表数据量 &gt; idealDataSizePerShardForZone。</p>
<p>2.目标分片表数据量 &lt;  idealDataSizePerShardForZone</p>
<p>3.目标分片表数据量 &gt; 源分片表数据量 + 3 * maxChunkSizeBytes(默认128M)</p>
<p>当源分片的数据量比目标分片数据量多3个 chunk(3*128=484M) 的时候，会生成迁移任务。</p>
<p>●  Chunk 选择及迁移任务生成</p>
<p>chunk 选择主要通过 ChunkManager 的 forEachOverlappingChunk 接口完成，通过遍历该表路由信息属于源分片的第一个 chunk ，然后生成 migrations 任务。遍历过程会跳过 jumbo chunk ，只会选择非 jumbo chunk 。</p>
<p>注意这里构造的迁移任务的 max 字段设置为 boost::none ，这个很关键，因为在源分片会识别 max 是否有值，如果没有的话就会进入 split chunk 自动拆分逻辑，请参考后面的S(T2)章节。</p>
<p>如果该shard全是 jumbo chunk ，则会给出 warning 信息，详见附录。</p>
<p>● 迁移任务入队</p>
<p>迁移任务生成后，config server 根据迁移任务构建 _shardsvrMoveRange 请求对象。</p>
<p>构建好请求对象后，会为该对象分配一个唯一“requesid”,然后把该re questid 和请求对象作为 kv 加入到 _requests(unordered_map) 中,同时把 requestid 加入到一个 fifo 先进先出队列_unsubmittedRequestIds中。入队完成后通过_stateUpdatedCV条件变量唤醒消费者线程 (BalancerCommandsScheduler) ,消费者线程被唤醒后开始执行迁移任务。</p>
<p>_requests 数据结构：</p>
<p>requestid 作为 key ，请求对象作为 value 存储到该 unordered_map 中。</p>
<p>_unsubmittedRequestIds 队列：</p>
<p>一个 fifo 结构的队列，只存储“requested”，主要保障迁移任务的顺序执行。</p>
<p>如果有多个分片表数据不均衡，则每个分片表都会生成一个迁移任务入队：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4f6600119cb4afca08aa20038ef8d70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=58hi8T%2Fsl%2B5%2FnFXWlbF%2BlyXimCE%3D" alt="image.png" loading="lazy"/></p>
<p>● 迁移任务异步处理</p>
<p>Config server的“BalancerCommandsScheduler”线程检测到_unsubmittedRequestIds队列有待执行的迁移任务，最终会通过“Sharding-Fixed”线程池调度把构造的 _ShardsvrMoveRange 命令发送给源分片，通知源分片开始数据迁移，如果候选迁移任务对象只有一个分片表，其交互流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff41b8e00824bf584fdb522ec4190f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=g9ZBklhYdR6Su23PTEMor%2FD37gU%3D" alt="image.png" loading="lazy"/></p>
<p>如果有多个表数据不均衡，则“BalancerCommandsScheduler”线程会把这些表对应的迁移任务对象一起发送给源分片，通知源分片对这些表进行并行迁移，然后异步等待 chunk 数据迁移完成，如下图:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ce7433f220c4ab5802134d5a2e3ec93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=ricLDpDTNRfnME5zN1MAmeuMjgU%3D" alt="image.png" loading="lazy"/></p>
<p>“Balancer”和“BalancerCommandsScheduler”线程不会阻塞等待，当源分片迁移 chunk 数据完成后，激活条件变量 _stateUpdatedCV 。由于“Balancer”和“BalancerCommandsScheduler”线程都会等待这个条件变量，因此这两个线程会被激活唤醒，然后开始下一轮的任务处理，这样就可以实现多表的并发迁移。</p>
<p>为了更好的理解，请参考附录中的异步并发调度举例。</p>
<h3 data-id="heading-9">1.5 总结</h3>
<ol>
<li>
<p>Config server 选主成功后，会创建一个“Balancer”线程，该线程会获取所有分片表在所有 shard 上 stats 数据量统计信息，然后为不均衡的分片表生成对应的迁移任务入队到队列。</p>
</li>
<li>
<p>“BalancerCommandsScheduler”线程从队列中获取任务，然后交由“Sharding-Fixed”线程池异步调度。</p>
</li>
<li>
<p>“Sharding-Fixed”线程池获取到源分片的应答后，会通过条件变量 _stateUpdatedCV激活“Balancer”和“BalancerCommandsScheduler”线程进行下一轮处理，继续选择和生成新的 chunk 迁移任务。</p>
</li>
<li>
<p>所有分片表迁移任务批量生成和提交，因此可以实现多个不均衡分片表的并行迁移。</p>
</li>
<li>
<p>一个表数据迁移慢不会影响其他表迁移任务的执行。</p>
</li>
</ol>
<h2 data-id="heading-10"><strong>2 数据迁移过程及其实现</strong></h2>
<hr/>
<p>源分片收到 config server 发送过来的 _ShardsvrMoveRange 请求后，会标记该接受请求的线程为"MoveChunk"线程，该线程会负责整个源分片数据迁移管理。源分片把迁移过程拆分为6个过程，每个过程都通过 _moveTimingHelper 来跟踪每个过程中的耗时。</p>
<p>目标分片数据迁移流程主要由 MigrationDestinationManager 类实现，目标分片把整个迁移拆分为8个阶段( _migrateDriver 中的 timing-&gt;done(x) ,x取值1-8 )，并记录每个阶段耗时。</p>
<p>为了更好地理解迁移过程，下面主要以时间线结合代码进行说明，例如：</p>
<p>S(T1)：代表源分片第一阶段的代码实现。</p>
<p>S(Tn): 代表源分片第n阶段的代码实现</p>
<p>D(T1)：代表目标分片第一阶段的代码实现。</p>
<p>D(Tn)：代表目标分片第n阶段的代码实现。</p>
<h3 data-id="heading-11">2.1 S(T1): MigrationSourceManager 类初始化</h3>
<p>源分片T1阶段主要完成 MigrationSourceManager 类构造函数的基础初始化和锁验证，该阶段几乎不耗时，理论上耗时为0ms。</p>
<h3 data-id="heading-12">2.2 S(T2): 元数据获取及chunk高效拆分</h3>
<p>该阶段是分片迁移的准备阶段，主要是从 config server 获取最新路由信息、 chunk 边界检查计算、冲突检测、 chunk 版本获取等。此外，该阶段有个很重要的功能逻辑是做 chunk 数据 split 拆分，下面重点分析该阶段 split 拆分及其原理：</p>
<h4 data-id="heading-13">2.2.1 触发源分片进行 split 拆分的条件</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c0884bcda6241adb4c75b307e2288a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=1Sq7XUaPJubcvBZxzng2YMiJcxQ%3D" alt="image.png" loading="lazy"/></p>
<p>前面2.4章节生成迁移任务的时候max字段设置为空，因此 balance 会进入上面的流程，最终在 autoSplitVector 中触发 chunk 拆分。</p>
<h4 data-id="heading-14"><strong>2.2.2 Chunk 高效 split 拆分核心实现原理</strong></h4>
<p>由于迁移 chunk 可能是一个大 chunk (大于128M)，因此需要对该 chunk 进行拆分，其核心实现如下:</p>
<p>● 预估一个目标 chunk 的文档数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e4bc0e4f2e74ad8ba908d70b8671d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=Tk9uVbKfjEo5%2BrZoetMl8h%2FBXGQ%3D" alt="image.png" loading="lazy"/></p>
<p>源分片首先获取该分片表在该分片的数据总行数( totalLocalCollDocuments )，同时获取该分片上该表的总数据大小( dataSize )，就可以得出单个文档的平均大小( avgDocSize ), 最后用一个目标chunk的大小( maxChunkSizeBytes )除以单个文档平均大小( avgDocSize )即可得到一个目标chunk内预期的文档行数( maxDocsPerChunk )。</p>
<p>● 确定 chunk 是否可分裂</p>
<p>根据片键索引生成扫描器，然后获取该 chunk[min, max&gt;范围内的第一个最小的数据 key ,再获取该范围内的最后一个最大的数据 key ,如果两个 key 相等，说明这个范围只有一个键值，也就是该 chunk 不可分裂。</p>
<p>● 确定 chunk 分裂点</p>
<p>确定分裂点借助扫描器，通过扫描器的 getNext 接口从该 chunk 的 min 边界开始一行一行获取索引数据，当获取到的数据行数达到 maxDocsPerChunk  时即可确认分界点和一个子 chunk 。假设某源chunk 有1000条数据，maxDocsPerChunk 为100，从该 chunk 获取3个分裂点，其核心算法如下图所示:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96df6bf8553940af9d1d6f7df4a398b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=nKJT2HaST5S14FGX7zz113BZ0%2Fw%3D" alt="image.png" loading="lazy"/></p>
<p>从上面的代码中可以看出分裂点获取采用“均匀间隔采样策略”，这样可以确保每个每个拆分后的 chunk 大小均匀。</p>
<p>● 优化：拆分后避免小 chunk</p>
<p>一个大 chunk 拆分为多个 maxChunkSizeBytes(128M) 大小的 chunk 时，会优先保证前面的多个子 chunk 达到128M,这样就可能引起一个问题：例如某个 chunk 有10001条数据，每100条数据可以组成一个128M的子 chunk ，前面的1000条数据刚好可以拆分为10个128M的子chunk，最后的第11个 chunk 就只会有1条数据，这样就会引起 chunk 不均衡。</p>
<p>MongoDB 为了避免小 chunk 的产生，如果发现某个chunk的文档数小于maxDocsPerChunk*0.8 ,则会对拆分出来的最后面的3个分裂点(也就是最后的4个子chunk)进行重新均衡，最终保证后面4个 chunk 的数据均衡。为了让最后4个 chunk 均衡，这里有两种策略：简单策略和公平策略。最终选择哪种策略由以下算法决定：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f95afd997c043639f0757bd60039caf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=HCEx14ty0MUOHEaBqduIaoR9lWg%3D" alt="image.png" loading="lazy"/></p>
<p>对该算法的举例说明请参考附录详情。</p>
<p>● 自动 balance 引起的 chunk 拆分总结</p>
<p>当源分片进入S(T2)阶段发现 chunk 没有 max 信息，因此会调用 autoSplitVector 函数对接受到的 chunk 进行拆分，自动 balance 引起的 split 限制 limit 限制为1，也就是只中拆分出1个子 chunk，这个子 chunk 的拆分点就是子 chunk 的 max ，这样 chunk 的[min, max&gt;范围也就确认了。</p>
<p>说明：为了避免拆分点后的 chunk 过小，自动 balance 引起的 chunk split 会扫描1+1=2个子 chunk 。</p>
<h3 data-id="heading-15">2.3 S(T3): 获取迁移 chunk 的数据 RecordId 列表并通知目标分片开始数据迁移</h3>
<p>该阶段主要确定要迁移的 chunk 对应的所有数据 RecordId 和通知目标分片开始数据迁移。</p>
<p>● 获取迁移 chunk 的所属数据 RecordId 列表</p>
<p>为了确定迁移 chunk 有哪些 RecordId ，首先在 _storeCurrentRecordId 函数中通过分片键索引生成执行器，然后通过执行器 getNext 接口获取该属于该 chunk 范围的所有 RecordId 存入 _cloneList类的_recordIds 克隆列表中(std::set容器管理),存入 _recordIds 的 RecordId 将在后续的D(T4)中使用，获取RecordId克隆列表核心代码详见附录文档。</p>
<p>如果迁移 chunk 的大小超过了2倍 maxChunk 的大小，则会把该 chunk 标记为 jumbo chunk 。如果我们配置中不允许迁移 jumbo chunk 则会迁移失败，并且日志中会有 ChunkTooBig 相关报错日志，可以通过如下配置启用 jumbo chunk 迁移：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c0906b259734f77ba542f92602ac5e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=v0PcwZ%2FJ%2B3VMrXrcfmTO4oqOtlg%3D" alt="image.png" loading="lazy"/></p>
<p>● 通知目标分片开始数据迁移</p>
<p>注册 _coordinator 迁移协调器( MigrationCoordinator )和 _cloneDriver 源克隆驱动器( MigrationChunkClonerSource )，然后源克隆驱动器通知目标集群可以开始数据迁移了，通知过程如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dccdfe1c38945d9befe53efe4913f46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=HrGnSX57WLutKxueHWrP0o7PEFM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">2.4 D(T1): 目标分片迁移工作启动及旧数据清理</h3>
<p>目标分片接收到 _recvChunkStart 请求后解析请求中的各种参数信息然后赋值给 MigrationDestinationManager (目标分片负责接收数据和状态管理的类)的各个成员, 同时创建"migrateThread"线程，该线程负责接收 chunk 数据。</p>
<p>"migrateThread"线程创建完成后，进入目标分片数据迁移8阶段的第1阶段。该阶段获取迁移表的创建参数、uuid、表索引信息，然后检查当前分片是否有影响本次迁移的待删除任务，如果有则删除该任务中对应的脏数据。</p>
<h3 data-id="heading-17">2.5 D(T2): 创建集合及其索引</h3>
<p>该阶段主要根据上面D(T1)获取到的集合参数信息、索引信息，然后在目标分片创建一致的集合及其索引等，确保集合结构( options + indexes )与源分片的完全一致。</p>
<h3 data-id="heading-18">2.6 D(T3): 创建删除任务并持久化</h3>
<p>该阶段初始化构造 recipientDeletionTask 任务，然后把该删除任务写入 config.rangeDeletions 集合中，后续如果 chunk 迁移失败或者异常，就可以通过持久化到 rangeDeletions 集合中的删除任务来删除已经写入到目标分片的数据。</p>
<p>如果 chunk 迁移中途失败，则后台 delete 线程会根据该集合中的这条 chunk 范围记录删除已经迁移到该目标 shard 的脏数据。</p>
<h3 data-id="heading-19">2.7 D(T4): 目标分片从源分片获取 chunk 数据应用到本地</h3>
<p>目标分片从源分片获取数据写入本分片采用生产者-消费者双线程池模式实现并发数据获取及并发写入。生产者负责从源分片获取数据，由"ChunkMigrationFetchers"线程池管理，消费者负责把生产者获取的数据写入本地分片，消费逻辑由"ChunkMigrationInserters"线程池管理，通过该架构实现了一个分片表的并发数据迁移，架构图如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1832dd1f3c454ca18f3b5ec839f8de37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=LdBdDdi%2FJiiRnGGrcpY2cU3b9IU%3D" alt="image.png" loading="lazy"/>
● 线程池大小</p>
<p>生产者线程池和消费者线程池大小可由同一个配置( chunkMigrationConcurrency )调整，该配置默认为1，调整命令如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2863736516c64dd998cd842834fb0e9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=AzEC9NxQw%2FnQ14N%2B2zyWYrV%2BCbc%3D" alt="image.png" loading="lazy"/>
说明：最新 MongoDB 内核已经取消了该配置，只会由一个线程来 fetcher 和 insert 数据。</p>
<p>● 缓冲队列大小</p>
<p>缓冲队列中的每一个 inserter 中记录了一个 fetcher 线程从源分片获取到的一批数据，如果 inserter 线程池写入比 fetcher 线程池慢，那么缓冲队列就会一直增长，这样就会引起内存的持续增加。为了限制内存的过度消耗，MongoDB 通过 chunkMigrationFetcherMaxBufferedSizeBytesPerThread 配置来限制每个 fetcher 线程在 chunk 迁移过程中缓冲到队列中的文档字节数，该配置默认值为约64.06MB，计算方法如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a08038e966f041aa8e161dc89f2669c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=L4yR48fPdBEskVr78bb7CH5Ksd4%3D" alt="image.png" loading="lazy"/>
一批数据大约16M,也就是一个 fetcher 线程大约可以拉取4批数据存到队列中。如果一个 insert 线程池消费数据写入目标分片过慢，则队列中的 inserter 就会积压，当每个 fetcher 线程挤压大约4批数据后，fetcher 线程就会阻塞等待。</p>
<p>● Fetcher 线程从源分片拉数据核心实现原理</p>
<p>Fetcher 线程构造“_migrateClone”请求发送给源分片，源分片收到“_migrateClone”请求后，根据S(T3)预记录的 _recordIds 克隆列表中的 recordId 从存储引擎获取真实 doc 文档，其核心代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bfee041250343c894d2fbbde89178e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=GVf6MU9YR3BAMsXDHXmWB%2FHz7yk%3D" alt="image.png" loading="lazy"/>
为了解决多线程并发获取的问题，MongoDB 通过互斥锁来实现，保证不同线程获取不同的 recordId , 最终实现多线程并发分配 recordId ，其核心代码及举例如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25ecdcc9b86b424a9d585b9babf7c3c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=uJ936YYsOR%2F7Ye3gDfJTsb7JGZY%3D" alt="image.png" loading="lazy"/>
此外，MongoDB 内核批量数据传输有 BSONObjMaxUserSize(16M) 限制，为了尽量填充满16M空间到 arrBuilder 中，因此每次获取到真实 doc 后需要进行判断，如果最新获取的一条 doc 填充后长度超过16M,则最后一条 doc 不会填充到arrBuilder，而是临时存入 _cloneList._overflowDocs 队列中，在下一批数据获取的时候会优先把 _cloneList._overflowDocs 队列中的数据填充到 arrBuilder ，核心代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ea272173ac4f5aa5fb74b17506a1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=rDqxsux3NrqsaL6Gp0rcbxwJgo8%3D" alt="image.png" loading="lazy"/></p>
<p>目标分片收到源分片应答后，会把接收到的一批数据封装成 inserter 入队。</p>
<p>● Inserter 线程获取队列数据写入本地节点</p>
<p>目标分片从队列获取 inserter 分批写入本地主节点，单批次写入的文档数可配置，假设配置的单批次文档数为100条，则分批次写入本地如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cd741902880413cbb51dfaa10ea3e06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=ho66Fs4q3SWbzhnPWiaRIkDN4%2Bo%3D" alt="image.png" loading="lazy"/></p>
<p>单批次写入文档数由 migrateCloneInsertionBatchSize 限制，该值默认为0，也就是把 fetcher 从源分片获取到的 inserter 数据一次性写入主分片，该配置修改方法如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fde4fc64ef1740e98c68df310b8b5602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=1scUH71%2FDv%2Fw2KVDYg5GH0AV15I%3D" alt="image.png" loading="lazy"/></p>
<p>从源分片获取到的数据在客户端 driver 写入源分片的时候已经做了 schema 校验，为了提升目标分片批量写入性能，performInserts 批量写入数据之前目标端提前禁用了 SchemaValidation 功能。</p>
<p>此外，如果长时间高负载迁移数据到目标分片，可能引起目标分片负载高(例如 dirty 持续性增加)。为了降低持续迁移写入对目标分片的影响，一批数据写入完成后可以延迟一段时间，延迟时间到才继续下一批数据写入。延迟时间可通过 migrateCloneInsertionBatchDelayMS 参数配置，该配置参数默认为0，也就是默认一批数据写入后不会 sleep ，修改方法如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2bb66e7481b4be78eed15474220fa4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=cf%2FzObDRP1uhIzGLCNntVH2NEBY%3D" alt="image.png" loading="lazy"/></p>
<p>此外，由于迁移期间，迁移 chunk 数据还没正式归属于目标分片，因此这部分数据属于孤儿文档，需要对孤儿文档计数。每应用一批数据到本地成功，就通过persistUpdatedNumOrphans函数对 config.rangeDeletions 表中的 numOrphanDocs 字段做“$inc”累加操作，例如这批数据写入了100条，则会对表中的字段增加100。</p>
<p>● Chunk 迁移过程中增量数据收集</p>
<p>Chunk 迁移过程中，客户端可能写或者修改该 chunk 中的数据，这部分写除了会应用到源分片外，还会记录到源分片的内存队列中，队列中只会保存迁移期间的增量写 oplog 的 _id 信息，其中 delete 删除操作记录到 MigrationChunkClonerSource 类的 _deleted 队列，insert 和 update 则记录在 _reload 队列中。</p>
<p>写入源分片内存队列中的 oplog 增量数据将在后面的D(T5)阶段由源分片消费后发送给目标分片， _reload 队列生产和消费逻辑如下图所示(说明：下图中的 oplog 实际上是 oplog 中的_id内容):
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b39e429c9964778b6700f0586054b01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=B9POWDITucwBuN0YvUfhzaMOBNc%3D" alt="image.png" loading="lazy"/></p>
<p>同理，_deleted 队列生产和消费逻辑如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/758477ff24af4caca24fbeeb904da63f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=0Fs2hlTLL9NnSETg7foJbGhJRmo%3D" alt="image.png" loading="lazy"/></p>
<p>本阶段D(T4)只负责生产 oplog 入队，队列中 oplog 消费流程在下面的D(T5)阶段实现。</p>
<h3 data-id="heading-20">2.8 D(T5): 目标分片从源分片获取增量数据应用到本地</h3>
<p>D(T4)获取到一个 chunk 的数据写入目标分片完成后进入该阶段，进入该阶段后状态会更新为 kCatchup ，该阶段首先发送"_transferMods"请求到源分片。</p>
<p>源分片收到该请求后，通过 TransferModsCommand::run 处理请求，run 中调用nextModsBatch接口获取上面D(T4)阶段 _reload 和 _deleted 队列中的 oplog 。</p>
<h4 data-id="heading-21">2.8.1 源分片返回增量 oplog 数据给目标分片</h4>
<p>● 原子性接管队列 oplog</p>
<p>在接管两个队列前通过加锁保证，核心代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a93495f7c4945159fb624ccc85c9528~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=8fvlCeXFoDOHU%2BXvEC3vGVDVtAE%3D" alt="image.png" loading="lazy"/>
如上代码可以看出，使用 splice 操作可以避免拷贝开销，最终 _deleted 队列中的 oplog(delete) 由 deleteList 接管， _reload 队列中的 oplog(insert/update) 由 updateLis t接管。</p>
<p>● delete 操作封包</p>
<p>删除操作封包流程主要是从 deleteList 列表中获取 delete 操作的 oplog ，由于删除操作只需要确定 _id 即可定位对应数据，因此 delete 操作只提取其中的 _id 字段添加到封包中</p>
<p>封包后的内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e705239f87e452bb8a4bef0e1361e24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=V5cUfxyBz49%2BOturTIBXZSl9XQg%3D" alt="image.png" loading="lazy"/></p>
<p>● insert/update 操作封包</p>
<p>当 deleteList 列表中的 oplog 全部填充到 bson 包完成后，deleteList 列表为空，这时候才会进行 updateList 列表中的 insert/update 相关 oplog 的填充。Insert/update 操作首先通过 oplog 中的 _id 来查询完整文档，然后把完整文档填充到封包中。</p>
<p>xferModes 遍历 updateList 列表填充 bson 包的时候，会根据 _id 去重，避免同一个 _id 的整文档多次添加到 bson 包中。Insert/update 相关 oplog 封包后的内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4b31519e9b24e20b33297050211ded5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=bF6vPmGSPSKfkacpbQvC3kP%2BtFE%3D" alt="image.png" loading="lazy"/></p>
<p>● 因果顺序一致性保障机制</p>
<p>上面 delete、insert/update 封包流程可以看出，增量数据会优先对delete相关操作进行封包处理。业务写入数据生成 oplog 到 oplog.rs 表后是有序的，但是这里却投递到了两个队列，oplog 到两个队列如何保证数据的一致性？下面以两个场景举例:</p>
<p>场景1: 先删后改</p>
<p>鉴于篇幅，详解附录文档查看详细场景举例。</p>
<p>场景2: 先改后删</p>
<p>鉴于篇幅，详解附录文档查看详细场景举例。</p>
<p>● 批量传输限制</p>
<p>由于内核单次请求应答的 bson 包体大小最大16M, 如果增量数据过多，则需要分批次返回给目标分片。如果一批数据封装完成后，剩余的数据重新还给 _deleted 和 _reload 队列，下次继续从队列消费剩余增量数据封装。</p>
<p>假设一批数据中既有 delete 数据也有 reload 数据，则传输的数据内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36637161ad8b47c8830231dedf42b2ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=XL%2BlReT3T8oaLDqlM9CnBn0UXUc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-22">2.8.2 目标分片应用增量数据</h4>
<p>目标分片"migrateThread"线程接收到增量数据后，在 fetchAndApplyBatch 中采用生产者-消费者双线程并发协作模式把增量数据应用到本地。生产者线程负责从源分片获取增量数据写入队列，消费者线程从队列消费数据应用到本地，队列大小固定为1。整体架构如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5bcb6d6b7aa4893b2b845892678a649~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=aolGdZjqBzX2fWlnjNBO2wn65fo%3D" alt="image.png" loading="lazy"/></p>
<p>● 生产者线程循环从源分片获取增量数据入队</p>
<p>生产者线程主要通过“_transferMods”从源分片获取增量数据，收到源分片返回的内容后，把返回的一批 batch 数据入队到 batches 队列，然后继续从源分片获取数据，直到源分片返回的 size 为0，说明增量数据拉取完毕。</p>
<p>● 消费者线程从队列消费数据应用到本地</p>
<p>消费者线程从队列中获取 batch 数据后，通过 applyModsFn 回掉接口把数据应用到本地，先处理源分片返回的 deleted 相关增量 oplog 数据，deleted 增量数据应用原理: 根据返回的 deleted 列表中的 _id 获取整个文档，然后结合 shardkey 检查该数据是否属于这个 chunk ，如果检查通过则根据 _id 执行删除操作。</p>
<p>Deleted 列表中的_id数据处理完毕后，开始处理 reload 列表( insert/update )中的数据，应用 reload 列表中的数据原理和 deleted 类似，先根据 reload 列表中获取的整文档检查是否属于这个 chunk，如果属于迁移的 chunk 则对整文档执行 upsert 操作。</p>
<p>为了提升应用增量数据的性能，和D(T4)章节全量 chunk 回放一样禁用 schemaValidate 检查。此外，在应用增量数据流程中还会对孤儿文档进行计数，每应用一条 delete 对应 oplog 删除一条数据则孤儿文档数 changeInOrphans 减1，从 reload 队列每 upsert 写一条数据成功则孤儿文档数加1。</p>
<h3 data-id="heading-23">2.9 S(T4)[D(T1) – D(T5)]: 源分片不定期检查增量数据迁移进度</h3>
<p>源分片S(T4)和目标分片D(T1)–D(T5)处于同一时间段，因此这里用S(T4)[ D(T1)–D(T5)]表示。</p>
<p>在目标分片从源分片迁移增量数据期间[ D(T1)–D(T5)]，源分片在这期间进行第4阶段的功能处理，源分片第4阶段主要功能是通过远程调用，周期性检查目标分片当前的克隆进度和状态，判断是否可以安全进入提交阶段 startCommit 。</p>
<p>● 进度查询交互过程</p>
<p>源分片向目标分片发送“_recvChunkStatus”命令请求向目标分片获取增量数据克隆迁移进度，请求内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd0e0039a77945d48f65d172258155be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=Ozt4RpJy1u4Baz4l6jg2v%2FROj%2Bs%3D" alt="image.png" loading="lazy"/>
请求中的 waitForSteadyOrDone 字段内容为 true ，因此目标分片会在条件变量上等待，条件满足或者1秒超时后才会返回源分片。</p>
<p>“_recvChunkStatus”获取进度交互过程如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/104ca70190374b66a1c0f13f60a238f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=4xi97EwBEKYZo76aUhBar7ZgNmY%3D" alt="image.png" loading="lazy"/></p>
<p>● 进入关键临界区(阻止用户写)判断条件</p>
<p>如果源分片收到目标分片应答的 stat 状态为 catchup (也就是增量数据获取中)或者 steady (增量数据已获取完成)，并且未传输的增量数据占 chunk 最大值的百分比低于 maxCatchUpPercentageBeforeBlockingWrites (默认10%，即128*10%=12.8M)配置时将进入关键阶段。未传输的增量数据计算方法详解附录文档。</p>
<p>调整配置方法如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/138b89d767024e909cb8d11ced51c8b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=boXSEL1C70c20UPj6JQG77holIA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-24">2.10.S(T5): 进入关键临界区</h3>
<p>● 源分片进入临界区并阻塞用户写</p>
<p>进入临界区，也就是数据迁移的关键阶段，在 MigrationSourceManager::enterCriticalSection() 中会进入临界区，对应代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8781c84c7b443818cff0a3b577aacf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=cCI7wmpH8jmR4TV65ku65yZd5qc%3D" alt="image.png" loading="lazy"/></p>
<p>通过 _critSec.emplace() 最终会创建  ShardingMigrationCriticalSection 对象，该对象包含：</p>
<p>_critSecCtx：关键区域上下文。</p>
<p>critSecSignal：一个SharedPromise 用于阻塞操作。</p>
<p>reason：阻塞原因（迁移相关信息）。</p>
<p>进入临界区后，当用户写迁移 chunk 数据到源分片如果发现当前处于临界区则需要阻塞等待，对应阻塞等待伪代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b62b0656f2c4cf2b9db48956c2f169a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=uYTLpBY8lj%2BfMxLuBqFfC%2BnLxFw%3D" alt="image.png" loading="lazy"/></p>
<p>● 向目标分片发出提交信号，驱动目标分片进入提交收尾流程</p>
<p>进入临界区后，源分片向目标分片发送"_recvChunkCommit"请求，同时阻塞等待目标分片返回进度内容，请求内容如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2a7fe1ec3894cb2bd1c7acab6fdd2b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=8tlP1EbLl60OzNNoXE0OZF0YaZg%3D" alt="image.png" loading="lazy"/></p>
<p>目标分片收到该请求后，需要等待 “migrateThread”迁移线程完成增量数据迁移及一些收尾工作，然后进入 kCommitStart 状态，同时唤醒目标分片的“migrateThread”线程进入下一阶段处理，对应代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64982d7fe9cc41e085933b6cf0a7a047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=tD2Jd99UHxUol%2BwqYOoX8JOAroA%3D" alt="image.png" loading="lazy"/>
唤醒目标分片 migrateThread 线程后，处理"_recvChunkCommit"请求的线程会阻塞等待，等待“migrateThread”数据迁移线程进入临界关键区，等待该迁移线程把状态推进到 kEnteredCritSec，等待超时时间 defaultConfigCommandTimeoutMS(默认30秒) 可配置，配置方式如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72b496d14e524d8aab8d688e0b2e35dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=SCGUYmrPkkBgy20DVZaEU306k0Y%3D" alt="image.png" loading="lazy"/></p>
<p>当 migrateThread 线程第8阶段进入 kEnteredCritSec 状态后，会唤醒处理"_recvChunkCommit"请求的线程，该请求线程返回目标分片迁移状态。源分片收到返回的迁移状态内容后会进入S(T6)阶段。</p>
<h3 data-id="heading-25">2.11 D(T6): 源分片禁写后目标分片再次继续获取增量数据</h3>
<p>到这里目标分片已经进入 kCommitStart 状态，同时源已经禁写，但是D(T5)-D(T6)期间源可能还有写入，因此 migrateThread 需要再次从源分片 fetch 一次数据，如果源分片返回的响应内容为空 (size=0) 则说明禁写期间的增量数据也获取完成。</p>
<h3 data-id="heading-26">2.12 D(T7): 等待会话数据迁移完成并校验结果</h3>
<p>该阶段主要确保所有与迁移 chunk 相关的会话数据(如事务、可重试写等)都已从源分片同步到本地, 这一步保证了迁移后目标分片能够正确处理与该 chunk 相关的分布式事务和会话操作。只有在会话数据全部迁移完成后，目标分片才会进入迁移流程的最终阶段(如关键区域解除、迁移完成)，防止事务丢失或会话状态不一致，核心代码实现参考附录。</p>
<h3 data-id="heading-27">2.13 D(T8): 目标分片临界区关键阶段处理</h3>
<p>第8阶段是临界区关键阶段，主要工作如下:</p>
<p>● 持久化恢复文档</p>
<p>在目标分片进入关键区域前，将迁移的关键信息（迁移ID、命名空间、会话ID、chunk范围、源分片等）持久化到 config.migrationRecipients 集合。</p>
<p>如果目标分片的主节点在临界关键区域期间发生故障，新主节点可以根据持久化的文档恢复迁移状态, 确保迁移流程不会因故障而中断或丢失。</p>
<p>● 目标分片通知源分片数据迁移完成</p>
<p>前面的工作处理完成后，目标分片 migrateThread 唤醒S(T5)中的处理 _recvChunkCommit 请求的线程，该线程被唤醒后返回源分片目标分片已进入临界区状态，返回内容参考前面S(T4)章节。唤醒代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29e36d14066744bd90a48fd1823152b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=KeQpFEUDe0ASPLtI2D96w1EXz4E%3D" alt="image.png" loading="lazy"/></p>
<p>● 目标分片阻塞等待源分片通知自己退出临界区</p>
<p>到这里，目标分片阻塞等待源分片通知自己退出临界区的通知, 该通知由下面的S(T6)阶段实现，对应代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6ee496d928e405bae77570b4e4fbe8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=Xl604aYCxA%2BrCwbCdPhtaczlMU8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-28">2.14.S(T6): 进入关键临界区</h3>
<p>目标分片第8阶段进入 kEnteredCritSec 状态后，源分片进入S(T6)阶段，该阶段主要作用如下:</p>
<p>● 进入关键临界区提交阶段</p>
<p>源分片将集合临界区域从只阻塞chunk数据写操作升级为阻塞 chunk 读写操作，进入迁移的最终提交阶段。核心代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08f84c8a77b44e5db8b9db0278196b05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=FHbifutTg83R37Yeu9f0oBmx%2FGw%3D" alt="image.png" loading="lazy"/>
● 修改 config server 的 chunk 元数据</p>
<p>Chunk 已经从源分片迁移到目标分片了，修改 config.chunks 表中对应已迁移 chunk 元数据属于目标分片。</p>
<p>● 通知目标分片释放临界区</p>
<p>修改 chunk 元数据完成后，源分片发送 _recvChunkReleaseCritSec 请求给目标分片。目标分片处理该请求的线程通过下面代码通知D(T8)阶段阻塞的 migrateThread 线程释放临界区:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c884a151b25428bb3dee447bff66d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=35EJB2Cqsz%2F7X0a%2BGAYDQPcje4M%3D" alt="image.png" loading="lazy"/></p>
<p>目标分片 migrateThread 线程退出临界区后，会从 config server 获取最新的 chunk 元数据。至此，目标分片正式接管新 chunk，写入该 chunk 的数据将由新分片接收。</p>
<p>migrateThread 线程退出临界区后，处理 _recvChunkReleaseCritSec 请求的线程返回成功应答给源分片，如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef95ed089ea4de5b1a4c746a5f7e447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=aXJDTB5knq59g%2FCE5K3gOEYm%2FCo%3D" alt="image.png" loading="lazy"/>
● 源分片退出临界区</p>
<p>源分片收到目标分片退出临界区完成的应答后，源分片退出临界区，核心代码如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16ff4a342e624ef3a0fdeb33d0f6928c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=dlXEemvPGAeo1DQqiGYSUzfh5%2Fk%3D" alt="image.png" loading="lazy"/>
调用 reset() 方法会清理关键临界区状态，从而解除对迁移集合的读写操作阻塞。此外，清除临界区状态后，同时向 config.changelog 表中记录一条“moveChunk.commit”日志。</p>
<h3 data-id="heading-29">2.15 总结</h3>
<p>Chunk 数据迁移过程按照时间线总结如下:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa82b2dd8cbd4773bd2ff7a837950b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=JT5zBhhJXk018wJGh8uFUCqW%2B2s%3D" alt="image.png" loading="lazy"/></p>
<p><strong>迁移异常处理及诊断统计</strong></p>
<h3 data-id="heading-30">3.1 脏数据清理</h3>
<p>如果迁移异常，例如迁移一部分数据写入目标分片后，因为某种原因迁移失败，就需要对目标分片的脏数据做清理操作。此外，如果 chunk 数据迁移成功，源分片需要清理该 chunk 的数据，这部分数据也是脏数据。</p>
<p>鉴于篇幅，本文不再做脏数据清理相关分析，脏数据清理原理以后单独分享。</p>
<h3 data-id="heading-31">3.2 迁移诊断统计</h3>
<p>MongoDB 会对迁移过程中重要环节进行统计，可通过 db.serverStatus().shardingStatistics </p>
<p>命令查看:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd2067c8ba346b6b06a0cf8248d08b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=NKXCfiUv3TWOn8UEPYdHoiFkWko%3D" alt="image.png" loading="lazy"/></p>
<p>各统计的含义总结如下:</p>
<p>● 源分片迁移相关统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba2e6b63c8674ce58634c0b89d6e7f67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=bPb7aoCeewQaIiyTuuPD%2B5inn%2B4%3D" alt="image.png" loading="lazy"/>
● 目标分片迁移统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0446b296fe124c8aa4937662fc4fa1b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=O%2Flr4Sq7s6D22x7RUvkKoGZ6Zyc%3D" alt="image.png" loading="lazy"/></p>
<p>● 关键临界区域相关统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28262a23bc84f748b0bcab296f1531f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=8aEcMIqVyFcuk4Wrg2ddzlEyCkg%3D" alt="image.png" loading="lazy"/></p>
<p>● 数据克隆相关统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d56f39f9c3540ee92a81a7e3c3388f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=HbOjIfL1qaxvolIEm3xp6CouJaE%3D" alt="image.png" loading="lazy"/></p>
<p>● 范围删除相关统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbee436f8c8e4a6fba4820a36afd585d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=46Ykz8MDFgJ0Uh%2FPzrMcD%2Bq0vZw%3D" alt="image.png" loading="lazy"/>
● 迁移失败相关统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06e4ba1fe11d4b34b0c2d13db5c75b2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=UNaoeQHvuGAXpctcI1BAMYYm6Jk%3D" alt="image.png" loading="lazy"/></p>
<p>● 其他统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/681612c6acee44c5a323202c56671d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520051&amp;x-signature=RtSnEU%2Fl%2FengivWmjoYq%2BMmq0ro%3D" alt="image.png" loading="lazy"/></p>
<p><strong>性能调优</strong></p>
<hr/>
<p>为了适应不同场景，balance 过程支持配置参数在线调整，调优总结如下:</p>
<p>●  chunkMigrationConcurrency</p>
<p>该参数主要负责单个表迁移的并发度调整，默认为1。如果迁移过程中源分片和目标分片负载都不高，可以适当的调大该值；如果迁移过程中，系统负载高，不建议调大该值。该配置 5.0.15, 6.0.5 及其以上版本支持调整。</p>
<p>说明: 由于调大该值会增加系统负载，并且可能增加孤儿文档的产生，因此从 8.0.5, 7.0.23 开始的版本不再支持调整该参数。</p>
<p>●  chunkMigrationFetcherMaxBufferedSizeBytesPerThread</p>
<p>每个迁移线程缓冲文档的最大字节数，0表示无限制，默认值4  BSONObjMaxInternalSize (约等于464M)，具体作用请参考前面D(T4)。不建议修改该值。</p>
<p>●  migrateCloneInsertionBatchSize</p>
<p>克隆阶段目标分片每批插入的最大文档数，该配置默认值0，也就是不限制一批写入的文档数。如果目标分片压力很大影响业务，建议适当调整该值，例如调整为100，一次批量写入100条数据。</p>
<p>●  migrateCloneInsertionBatchDelayMS</p>
<p>克隆阶段目标分片批次插入之间的等待时间，也就是每写一批数据后都延迟一段时间，这样就可以减少目标分片负载。该配置默认值为0，也就是不 sleep 延迟。如果目标分片因为数据迁移压力很大，可以调大该值减少对业务的影响。</p>
<p>●  migrationLockAcquisitionMaxWaitMS</p>
<p>迁移操作获取集合锁的最大等待时间，默认值500ms，不建议修改该值。</p>
<p>●  maxCatchUpPercentageBeforeBlockingWrites</p>
<p>进入关键临界区时的判断条件，也就是允许未传输的增量数据占 chunk 最大值的百分比，默认值10%，也就是当未传输的增量数据大约为12.8M( chunk 默认128M * 10%)时，可以参考S(T4)章节获取更多细节。</p>
<p>如果存在热点 chunk ，例如迁移该 chunk 过程中业务持续在修改该 chunk ，这时候可能迁移速度没有业务写入速度快，这时候可能增量数据长时间超过12.8M,这种场景可以适当调大该值。</p>
<p>●  rangeDeleterBatchSize</p>
<p>清理数据时每批删除的最大文档数，默认值 INT_MAX ，也就是不限制。如果发现有大量删除操作引起负载高或者影响业务，建议调小该值，例如100。</p>
<p>●  rangeDeleterBatchDelayMS</p>
<p>一批数据删除后，是否做 sleep ，默认值20ms。如果系统负载很低，建议调小该值，如果系统负载高，建议调大该值。</p>
<p>●  rangeDeleterHighPriority</p>
<p>是否优先执行范围删除操作（高于用户操作），默认值 false ，不建议修改该值。</p>
<p>●  orphanCleanupDelaySecs</p>
<p>延迟多久后开始正式删除数据，默认值900秒。不建议修改该值。</p>
<p>●  receiveChunkWaitForRangeDeleterTimeoutMS</p>
<p>该参数控制目标分片在接收新的 chunk 迁移请求时，等待与迁移范围重叠的范围删除任务完成的最大时间。默认值10000ms，如果重叠范围太多可以适当调大该值。</p>
<p>●  persistedChunkCacheUpdateMaxBatchSize</p>
<p>控制分片本地持久化 chunk 缓存更新时的批处理大小，即每次更新操作最多处理的 chunk 元数据记录数，默认值1000，不建议修改该值。</p>
<p><strong>不同内核版本性能及功能总结</strong></p>
<hr/>
<p>由于 MongoDB 内核 6.0～8.0 代码 balance 整体原理差异不大，鉴于篇幅，这里重点总结高版本相比 5.0 及以下版本的几个核心差异：</p>
<p>● 性能相关</p>
<p>实测 5.0 和 8.0 的整体迁移速度，8.0 性能相比 5.0 好大约 30% - 45%。性能提升原理总结如下:</p>
<ol>
<li>
<p>6.0开始的版本 chunksize 大小由默认64M增加到128M, 网络IO处理开销更小，整体网络传输效率、读写吞吐更高。</p>
</li>
<li>
<p>Chunk 路由总量更少，路由查询处理效率更高，网络交互更少。</p>
</li>
<li>
<p>高版本批量写性能的提升进一步提升迁移速度。</p>
</li>
<li>
<p>相比低版本 split 由用户线程实现，6.0.3 高版本 split 由源分片 MoveChun 后台线程完成，因此 split 对业务无影响，参考S(T2)章节。</p>
</li>
</ol>
<p>●  Chunk 和 split 差异</p>
<p>5.0及以下版本，当 chunk 大小达到 chunksize 配置大小后会触发 split 。6.0.3 开始的高版本 split 在做 balance 的过程中由源分片“moveChunk”后台线程进行拆分，具体请参考S(T2)章节，因此高版本一个 chunk 可以很大，甚至到T级别。</p>
<p>基于上面的原因，6.0.3 开始版本不能再通过每个分片的 chunk 数量来判断数据是否均衡，而是通过 db.xxxx.getShardDistribution() 命令获取每个分片的实际数据量来判断数据是否均衡。</p>
<p>●  Chunksize 默认大小调整</p>
<p>6.0开始版本 chunksize 大小默认由64M调整到128M。</p>
<p>● 新功能相关</p>
<p>从MongoDB 7.0 开始，新增 automerge、更详细的诊断统计、 Defragmentation 碎片整理等功能。</p>
<blockquote>
<p>腾讯云数据库 MongoDB（TencentDB for MongoDB） 是腾讯云基于全球广受欢迎的 MongoDB 打造的高性能 NoSQL 数据库，100% 完全兼容 MongoDB 协议，提供稳定丰富的监控管理，弹性可扩展、自动容灾，适用于文档型数据库场景，使您无需自建灾备体系及控制管理系统。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Charles抓包工具详解，开发者必备的网络调试与流量分析神器]]></title>    <link>https://juejin.cn/post/7571351275977523251</link>    <guid>https://juejin.cn/post/7571351275977523251</guid>    <pubDate>2025-11-12T02:49:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571351275977523251" data-draft-id="7571360278971203593" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Charles抓包工具详解，开发者必备的网络调试与流量分析神器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T02:49:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Charles抓包工具详解，开发者必备的网络调试与流量分析神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:49:39.000Z" title="Wed Nov 12 2025 02:49:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>无论你是Web前端、后端工程师，还是移动端开发或测试工程师，在调试接口、排查Bug、分析请求时，都绕不开一个关键词——<strong>抓包</strong>。</p>
<p>而在众多抓包软件中，<strong>Charles抓包工具</strong> 被誉为“开发者的流量显微镜”。</p>
<p>它能让原本隐藏在网络层的通信过程变得透明，让你轻松定位接口异常、分析请求逻辑、验证响应数据。</p>
<p>这篇文章将带你系统了解：</p>
<blockquote>
<p>什么是Charles抓包工具，它能做什么，为什么几乎每个开发者都离不开它。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、Charles抓包工具是什么？</h2>
<p><strong>Charles</strong> 是一款专业的 <strong>HTTP/HTTPS 抓包与网络调试工具</strong>，
最早由Karl von Randow开发，目前广泛应用于前端调试、移动应用测试与API开发中。</p>
<p>它的核心功能包括：</p>
<ul>
<li><strong>实时抓取HTTP/HTTPS请求与响应</strong></li>
<li><strong>分析请求头、参数、Cookies与状态码</strong></li>
<li><strong>断点调试与请求修改</strong></li>
<li><strong>Mock接口与重写响应</strong></li>
<li><strong>移动端抓包</strong>（支持iOS/Android）</li>
<li><strong>带宽限制与弱网模拟</strong></li>
</ul>
<p>一句话总结：</p>
<blockquote>
<p>Charles让“网络请求”不再是黑盒，而是你可以观察、修改、掌控的过程。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、Charles抓包工具的工作原理</h2>
<p>要理解Charles的强大，就要先理解它<strong>如何抓包</strong>。</p>
<p>Charles的核心机制是 <strong>代理（Proxy）转发</strong>：</p>
<ol>
<li>Charles在本地运行后，会启动一个HTTP代理服务器（默认端口8888）；</li>
<li>系统或App的所有网络请求都会经过Charles转发；</li>
<li>Charles截获这些请求与响应，并将数据可视化展示。</li>
</ol>
<p>简单来说，数据流动变成了这样：</p>
<pre><code class="hljs">客户端 → Charles代理 → 实际服务器
</code></pre>
<p>Charles站在中间，就能完整地“观察”每一个数据包。</p>
<hr/>
<h2 data-id="heading-2">三、Charles如何抓取HTTPS流量</h2>
<p>HTTPS的特点是“加密通信”，那么Charles是如何“看见”加密内容的呢？</p>
<p>这要归功于它的 <strong>SSL Proxying（中间人代理）机制</strong>。</p>
<p>Charles通过安装自己的根证书（Charles Root CA），在请求与服务器之间建立“双向信任连接”：</p>
<ul>
<li>与客户端建立一条加密通道；</li>
<li>同时与服务器建立另一条加密通道；</li>
<li>然后在中间“翻译”并展示明文数据。</li>
</ul>
<p>这也是为什么你必须信任Charles证书，否则客户端会拒绝通信。</p>
<p><strong>配置方法：</strong></p>
<ol>
<li>打开菜单：<code>Help → SSL Proxying → Install Charles Root Certificate</code></li>
<li>安装证书后设置为“始终信任”；</li>
<li>在 <code>Proxy → SSL Proxying Settings</code> 中启用 <code>*:*</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-3">四、Charles抓取手机App流量</h2>
<p>Charles不仅能抓取电脑浏览器请求，还能抓取移动端App的数据包。</p>
<h3 data-id="heading-4"><strong>配置流程：</strong></h3>
<h4 data-id="heading-5"><strong>① 确保手机与电脑在同一Wi-Fi下</strong></h4>
<p>因为Charles作为代理服务器，需要两端处于同一局域网。</p>
<h4 data-id="heading-6"><strong>② 手机配置Wi-Fi代理</strong></h4>
<ul>
<li>服务器地址：电脑IP（Charles底部状态栏可查看）</li>
<li>端口号：8888</li>
</ul>
<h4 data-id="heading-7"><strong>③ 安装移动端证书</strong></h4>
<p>在手机浏览器访问：<code>chls.pro/ssl</code>
下载并安装证书。</p>
<blockquote>
<p>iOS用户需前往“设置 → 通用 → 证书信任设置”中信任Charles证书。</p>
</blockquote>
<p>完成后，Charles即可实时显示App的HTTP与HTTPS请求。</p>
<hr/>
<h2 data-id="heading-8">五、Charles抓包工具的核心功能与使用场景</h2>
<h3 data-id="heading-9"><strong>Breakpoints（断点调试）</strong></h3>
<p>允许拦截请求，在发送前或响应后修改数据。</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>测试接口的异常情况；</li>
<li>模拟后端错误返回；</li>
<li>修改请求参数验证安全性。</li>
</ul>
<hr/>
<h3 data-id="heading-10"><strong>Map Local（本地Mock）</strong></h3>
<p>将请求映射到本地文件，替代服务器响应。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>后端接口未完成；</li>
<li>前端独立联调；</li>
<li>测试静态响应。</li>
</ul>
<p>例如：
将 <code>/api/user/info</code> 映射到 <code>mock/user.json</code>，
即可离线返回测试数据。</p>
<hr/>
<h3 data-id="heading-11"><strong>Rewrite（请求与响应重写）</strong></h3>
<p>自动批量修改请求或响应内容。</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>替换Header或参数；</li>
<li>调试新API版本；</li>
<li>批量切换测试环境。</li>
</ul>
<hr/>
<h3 data-id="heading-12"><strong>Throttle（限速功能）</strong></h3>
<p>模拟不同网络环境：
3G、4G、Wi-Fi或自定义带宽。</p>
<p><strong>使用场景：</strong></p>
<ul>
<li>测试App弱网表现；</li>
<li>分析接口超时问题。</li>
</ul>
<hr/>
<h3 data-id="heading-13"><strong>Map Remote（远程映射）</strong></h3>
<p>将请求重定向到不同环境，例如：</p>
<pre><code class="hljs">api.test.com → api.pre.com
</code></pre>
<p>方便在多个服务器环境间快速切换。</p>
<hr/>
<h2 data-id="heading-14">六、真实案例：Charles如何帮我解决一个棘手Bug</h2>
<p>在一次移动端项目中，测试反馈：</p>
<blockquote>
<p>“Android版本的支付接口返回超时，但iOS正常。”</p>
</blockquote>
<p>我们使用Charles抓包分析：</p>
<ul>
<li>请求路径一致；</li>
<li>参数相同；</li>
<li>但Android请求耗时异常，延迟近2秒。</li>
</ul>
<p>进一步分析Timeline后发现：
Android端在请求Header中多带了一个 <code>X-Request-ID</code>，导致CDN缓存未命中。</p>
<p>修改Header后，请求恢复正常。</p>
<blockquote>
<p>这就是Charles的威力：它不仅帮你“看到问题”，还让你“理解问题”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">七、Charles抓包的高效使用技巧</h2>



































<table><thead><tr><th>功能</th><th>操作路径</th><th>典型用途</th></tr></thead><tbody><tr><td><strong>Session Filter</strong></td><td>View → Filter</td><td>只看目标接口请求</td></tr><tr><td><strong>Repeat / Advanced Repeat</strong></td><td>右键请求 → Repeat</td><td>接口重放或压力测试</td></tr><tr><td><strong>Export Session</strong></td><td>File → Export</td><td>导出日志复现问题</td></tr><tr><td><strong>No Caching</strong></td><td>Proxy → No Caching</td><td>禁止缓存获取真实请求</td></tr><tr><td><strong>Focus</strong></td><td>Command + F</td><td>快速搜索关键字</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">八、Charles抓包常见问题</h2>






























<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>无法抓取HTTPS</td><td>未安装信任证书</td><td>重新安装Charles Root CA</td></tr><tr><td>手机连接失败</td><td>不同Wi-Fi或端口错误</td><td>检查代理设置与防火墙</td></tr><tr><td>请求乱码</td><td>响应被压缩</td><td>启用“Decode compressed content”</td></tr><tr><td>App无法信任</td><td>SSL Pinning机制</td><td>使用开发包或关闭证书校验</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">九、延伸阅读与中文资源</h2>
<p>更多Charles教程、实战案例与图文配置指南请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fcharlesproxy.net%2F" target="_blank" title="https://charlesproxy.net/" ref="nofollow noopener noreferrer">Charles中文网</a></p>
<p>提供：</p>
<ul>
<li>中文安装教程</li>
<li>HTTPS证书配置说明</li>
<li>Rewrite与Mock模板</li>
<li>移动端抓包图文流程</li>
</ul>
<hr/>
<h2 data-id="heading-18">Charles，是开发者的“系统听诊器”</h2>
<p>现代软件系统越来越复杂，但网络层的每一次请求、每一个延迟、每一条Header，都隐藏着问题的线索。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ本地消息表：生产环境下的分布式事务最佳实践]]></title>    <link>https://juejin.cn/post/7571334572769427499</link>    <guid>https://juejin.cn/post/7571334572769427499</guid>    <pubDate>2025-11-12T01:49:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572769427499" data-draft-id="7571334572769411115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ本地消息表：生产环境下的分布式事务最佳实践"/> <meta itemprop="keywords" content="RocketMQ"/> <meta itemprop="datePublished" content="2025-11-12T01:49:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ本地消息表：生产环境下的分布式事务最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:49:02.000Z" title="Wed Nov 12 2025 01:49:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RocketMQ本地消息表：生产环境下的分布式事务最佳实践</h2>
<h3 data-id="heading-1">前言</h3>
<p>在微服务架构下，分布式事务一直是个让人头疼的问题。RocketMQ虽然提供了事务消息机制，但在某些场景下，本地消息表方案反而更加稳定可靠。这篇文章会从实战角度，和大家聊聊我在生产环境中使用本地消息表的经验，包括踩过的坑和总结的最佳实践。</p>
<h3 data-id="heading-2">一、为什么需要本地消息表？</h3>
<h4 data-id="heading-3">1.1 RocketMQ事务消息的局限性</h4>
<p>先说说RocketMQ自带的事务消息。它的流程是这样的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 业务系统
    participant MQ生产者
    participant MQ服务器
    participant MQ消费者
    
    业务系统-&gt;&gt;MQ生产者: 1.发送半消息
    MQ生产者-&gt;&gt;MQ服务器: 2.半消息(Send OK)
    MQ服务器--&gt;&gt;MQ生产者: 3.半消息已存储
    
    MQ生产者-&gt;&gt;业务系统: 4.执行本地事务
    
    alt 本地事务成功
        业务系统-&gt;&gt;MQ生产者: 5.Commit
        MQ生产者-&gt;&gt;MQ服务器: 6.提交消息
        MQ服务器-&gt;&gt;MQ消费者: 7.投递消息
    else 本地事务失败
        业务系统-&gt;&gt;MQ生产者: 5.Rollback
        MQ生产者-&gt;&gt;MQ服务器: 6.回滚消息
    end
    
    Note over MQ服务器,MQ生产者: 回查机制：如果长时间未收到确认
    MQ服务器-&gt;&gt;MQ生产者: 7.回查事务状态
    MQ生产者-&gt;&gt;业务系统: 8.查询本地事务
    业务系统--&gt;&gt;MQ生产者: 9.返回事务状态
</code></pre>
<p>看起来挺完美，但实际用下来有几个问题：</p>
<p><strong>问题一：回查机制不够灵活</strong></p>
<p>我们有个订单系统，下单后需要发消息给库存系统扣减库存。用RocketMQ事务消息时，遇到了一个尴尬的场景：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这种情况下回查会很麻烦</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> {
    <span class="hljs-comment">// 1. 插入订单</span>
    orderMapper.insert(order);
    
    <span class="hljs-comment">// 2. 插入订单明细（可能有多条）</span>
    orderDetailMapper.batchInsert(details);
    
    <span class="hljs-comment">// 3. 扣减优惠券</span>
    couponService.deduct(dto.getCouponId());
    
    <span class="hljs-comment">// 4. 发送消息</span>
    <span class="hljs-comment">// 问题来了：回查时怎么判断这一堆操作都成功了？</span>
}
</code></pre>
<p>回查函数需要判断订单、明细、优惠券都处理完了，写起来很别扭。</p>
<p><strong>问题二：HALF消息主题替换，导致业务逻辑混乱</strong></p>
<p>RocketMQ的HALF消息会把原topic替换成<code>RMQ_SYS_TRANS_HALF_TOPIC</code>，这在某些监控场景下会很麻烦。我们的APM系统是按topic统计消息量的，HALF消息会被统计到系统topic下，业务topic的数据就对不上了。</p>
<p><strong>问题三：OP消息只记录不重新投递</strong></p>
<p>OP消息（操作消息）在Commit后会重新投递，但Rollback时只记录日志，不会重试。这意味着如果你的业务需要支持消息补偿，RocketMQ事务消息帮不上忙。</p>
<h4 data-id="heading-4">1.2 本地消息表的优势</h4>
<p>基于这些问题，我们转向了本地消息表方案。核心思路很简单：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[业务操作] --&gt;|同一事务| B[插入消息表]
    B --&gt; C[后台任务扫描]
    C --&gt; D[发送到MQ]
    D --&gt; E[更新消息状态]
    
    style A fill:#e1f5ff
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#fff4e1
    style E fill:#e8f5e9
</code></pre>
<p><strong>把消息发送和业务操作放在同一个本地事务里，利用数据库的ACID特性保证一致性</strong>。</p>
<p>相比RocketMQ事务消息，它有这些好处：</p>
<ol>
<li><strong>事务保证更彻底</strong>：业务数据和消息数据要么一起成功，要么一起失败</li>
<li><strong>回查逻辑简单</strong>：直接查消息表状态就行，不需要反推业务状态</li>
<li><strong>支持消息补偿</strong>：消息表可以记录详细的发送历史，方便排查和重试</li>
<li><strong>降低MQ依赖</strong>：MQ暂时不可用时，消息会积压在表里，不影响业务主流程</li>
</ol>
<h3 data-id="heading-5">二、本地消息表的核心原理</h3>
<h4 data-id="heading-6">2.1 整体架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 服务层
        A[订单服务] 
    end
    
    subgraph 数据库
        B[业务表&lt;br/&gt;orders] 
        C[消息表&lt;br/&gt;mq_messages]
    end
    
    subgraph 消息发送层
        D[消息发送队列&lt;br/&gt;内存队列]
        E[消息处理器&lt;br/&gt;MsgProcessor]
    end
    
    subgraph MQ集群
        F[RocketMQ&lt;br/&gt;Broker]
    end
    
    subgraph 补偿机制
        G[定时任务&lt;br/&gt;扫描超时消息]
    end
    
    A --&gt;|1.写入| B
    A --&gt;|2.写入| C
    C --&gt;|3.放入| D
    D --&gt;|4.异步发送| E
    E --&gt;|5.发送| F
    F --&gt;|6.响应| E
    E --&gt;|7.更新状态| C
    G --&gt;|8.扫描| C
    G --&gt;|9.重新发送| D
    
    style A fill:#e3f2fd
    style B fill:#fff3e0
    style C fill:#fff3e0
    style D fill:#f3e5f5
    style E fill:#f3e5f5
    style F fill:#e8f5e9
    style G fill:#fce4ec
</code></pre>
<p>整个流程分为三个阶段：</p>
<p><strong>阶段一：业务+消息写入（同步）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> Long <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> {
    <span class="hljs-comment">// 1. 写业务表</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> buildOrder(dto);
    orderMapper.insert(order);
    
    <span class="hljs-comment">// 2. 写消息表（同一事务）</span>
    <span class="hljs-type">MqMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MqMessage</span>();
    msg.setTopic(<span class="hljs-string">"order_created"</span>);
    msg.setContent(JSON.toJSONString(order));
    msg.setStatus(<span class="hljs-number">0</span>); <span class="hljs-comment">// 待发送</span>
    mqMessageMapper.insert(msg);
    
    <span class="hljs-comment">// 3. 放入内存队列（不阻塞主流程）</span>
    msgQueue.offer(msg);
    
    <span class="hljs-keyword">return</span> order.getId();
}
</code></pre>
<p><strong>阶段二：异步发送MQ</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 后台线程不断从队列取消息发送</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-type">MqMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> msgQueue.poll(<span class="hljs-number">1</span>, TimeUnit.SECONDS);
    <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            producer.send(msg);
            <span class="hljs-comment">// 发送成功，更新状态</span>
            mqMessageMapper.updateStatus(msg.getId(), <span class="hljs-number">1</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 发送失败，增加重试次数</span>
            mqMessageMapper.incrRetryCount(msg.getId());
        }
    }
}
</code></pre>
<p><strong>阶段三：兜底补偿（定时任务）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(cron = "0 */5 * * * ?")</span> <span class="hljs-comment">// 每5分钟执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">retryFailedMessages</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 查询状态=0且超过5分钟的消息</span>
    List&lt;MqMessage&gt; list = mqMessageMapper.selectTimeout(<span class="hljs-number">5</span>);
    <span class="hljs-keyword">for</span> (MqMessage msg : list) {
        msgQueue.offer(msg); <span class="hljs-comment">// 重新放入队列</span>
    }
}
</code></pre>
<h4 data-id="heading-7">2.2 消息状态流转</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; 待发送: 创建消息
    待发送 --&gt; 发送中: 取出发送
    发送中 --&gt; 已发送: 发送成功
    发送中 --&gt; 待发送: 发送失败(重试)
    待发送 --&gt; 发送失败: 超过最大重试次数
    发送失败 --&gt; 待发送: 人工介入重试
    已发送 --&gt; [*]
    
    note right of 待发送
        status=0
        可以被定时任务扫描
    end note
    
    note right of 已发送
        status=1
        最终状态
    end note
    
    note right of 发送失败
        status=2
        需要人工排查
    end note
</code></pre>
<h3 data-id="heading-8">三、核心代码实现</h3>
<h4 data-id="heading-9">3.1 消息表设计</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> mq_messages (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键'</span>,
    content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息内容'</span>,
    topic <span class="hljs-type">CHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息主题'</span>,
    tag <span class="hljs-type">CHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'消息标签'</span>,
    status TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'状态：0-待发送 1-已发送 2-发送失败'</span>,
    retry_count <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'重试次数'</span>,
    max_retry <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">3</span> COMMENT <span class="hljs-string">'最大重试次数'</span>,
    next_retry_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'下次重试时间'</span>,
    create_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (id),
    INDEX idx_status_next_retry (status, next_retry_time)
) COMMENT <span class="hljs-string">'事务消息表'</span>;
</code></pre>
<p>几个设计要点：</p>
<ol>
<li><strong>status字段</strong>：用TINYINT节省空间，0/1/2三个状态足够</li>
<li><strong>retry_count</strong>：记录重试次数，避免无限重试</li>
<li><strong>next_retry_time</strong>：采用延迟递增策略（0秒、5秒、10秒、25秒...）</li>
<li><strong>索引设计</strong>：<code>(status, next_retry_time)</code> 联合索引，定时任务扫描效率高</li>
</ol>
<h4 data-id="heading-10">3.2 消息客户端封装</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisTransactionMsgClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TransactionMsgClient</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SqlSessionTemplate sessionTemplate;
    
    <span class="hljs-comment">/**
     * 发送消息（核心方法）
     * 1. 检查事务状态
     * 2. 插入消息表
     * 3. 发送到MQ
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">sendMsg</span><span class="hljs-params">(Connection con, String content, 
                        String topic, String tag)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 1. 校验事务状态</span>
        <span class="hljs-keyword">if</span> (!con.getAutoCommit()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"连接不在事务中"</span>);
        }
        
        <span class="hljs-comment">// 2. 校验参数</span>
        <span class="hljs-keyword">if</span> (content == <span class="hljs-literal">null</span> || content.isEmpty() || 
            topic == <span class="hljs-literal">null</span> || topic.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"消息内容或主题为空"</span>);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 插入消息记录</span>
            Map&lt;Long, String&gt; idUrlPair = 
                MsgStorage.insertMsg(con, content, topic, tag);
            id = idUrlPair.getKey();
            
            <span class="hljs-comment">// 4. 放入内存队列（非阻塞）</span>
            <span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Msg</span>(id, idUrlPair.getValue());
            putMsg(msg);
            
            <span class="hljs-keyword">return</span> id;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"发送消息失败 topic={} tag={}"</span>, topic, tag, e);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-comment">/**
     * 消息处理线程
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MsgProcessorRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 从队列取消息（带超时）</span>
                    <span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> msgQueue.poll(
                        getTimeoutMs(), TimeUnit.MILLISECONDS);
                    
                    <span class="hljs-keyword">if</span> (msg == <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">continue</span>;
                    }
                    
                    <span class="hljs-comment">// 查询消息详情</span>
                    <span class="hljs-type">MsgInfo</span> <span class="hljs-variable">msgInfo</span> <span class="hljs-operator">=</span> MsgStorage.getMsgById(msg);
                    <span class="hljs-keyword">if</span> (msgInfo == <span class="hljs-literal">null</span>) {
                        log.warn(<span class="hljs-string">"消息不存在 msgId={}"</span>, msg.getIdUrlPair());
                        <span class="hljs-keyword">continue</span>;
                    }
                    
                    <span class="hljs-comment">// 构建MQ消息</span>
                    <span class="hljs-type">Message</span> <span class="hljs-variable">mqMsg</span> <span class="hljs-operator">=</span> buildMsg(msgInfo);
                    
                    <span class="hljs-comment">// 发送到MQ</span>
                    <span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.send(mqMsg);
                    
                    <span class="hljs-comment">// 根据结果更新状态</span>
                    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span> &amp;&amp; 
                        result.getSendStatus() == SendStatus.SEND_OK) {
                        <span class="hljs-comment">// 成功，更新为已发送</span>
                        MsgStorage.updateMsgStatus(msg);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 失败，计算下次重试时间</span>
                        handleSendFailure(msg, msgInfo);
                    }
                    
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    log.error(<span class="hljs-string">"消息处理线程被中断"</span>, e);
                    <span class="hljs-keyword">break</span>;
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"处理消息异常"</span>, e);
                }
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 处理发送失败的消息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSendFailure</span><span class="hljs-params">(Msg msg, MsgInfo msgInfo)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">dealedTime</span> <span class="hljs-operator">=</span> msgInfo.getHaveDealtimes() + <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">if</span> (dealedTime &lt; MAX_DEAL_TIME) {
            <span class="hljs-comment">// 还没超过最大重试次数，计算下次重试时间</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">nextExpireTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() + 
                timeOutData[dealedTime] * <span class="hljs-number">1000</span>;
            
            msgInfo.setNextExpireTime(nextExpireTime);
            msgInfo.setHaveDealtimes(dealedTime);
            
            <span class="hljs-comment">// 放入时间轮等待</span>
            timewheelQueue.put(msg);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 超过最大重试次数，标记为失败</span>
            log.error(<span class="hljs-string">"消息发送失败超过最大次数 msgId={}"</span>, 
                msg.getIdUrlPair());
            MsgStorage.updateMsgStatus(msg, <span class="hljs-number">2</span>); <span class="hljs-comment">// 状态改为失败</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-11">3.3 时间轮实现（延迟重试）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 时间轮线程
 * 负责扫描需要重试的消息，并放回发送队列
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MsgTimewheelRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!state.get().equals(State.RUNNING)) {
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> timewheelQueue.peek();
            
            <span class="hljs-comment">// 检查消息是否到达重试时间</span>
            <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; 
                   msg.getNextExpireTime() &lt;= currentTime) {
                
                msg = timewheelQueue.poll();
                log.trace(<span class="hljs-string">"时间轮取出消息 msgId={}"</span>, msg);
                
                <span class="hljs-comment">// 重新放入发送队列</span>
                msgQueue.put(msg);
                
                msg = timewheelQueue.peek();
            }
            
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            log.error(<span class="hljs-string">"时间轮处理异常"</span>, ex);
        }
    }
}
</code></pre>
<h4 data-id="heading-12">3.4 业务代码集成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MybatisTransactionMsgClient transactionMsgClient;
    
    <span class="hljs-comment">/**
     * 创建订单
     * 业务数据和消息在同一事务中
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> <span class="hljs-keyword">throws</span> Exception {
        
        <span class="hljs-comment">// 1. 插入订单（业务数据）</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setContent(dto.getContent());
        <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orderMapper.insertOrder(order);
        
        <span class="hljs-comment">// 2. 发送消息（同一事务）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">msgContent</span> <span class="hljs-operator">=</span> JSON.toJSONString(order);
        <span class="hljs-type">Long</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> transactionMsgClient.sendMsg(
            msgContent, 
            <span class="hljs-string">"order_created_topic"</span>, 
            <span class="hljs-literal">null</span>
        );
        
        log.info(<span class="hljs-string">"订单创建成功 orderId={} msgId={}"</span>, orderId, msgId);
        
        <span class="hljs-keyword">return</span> orderId;
    }
}
</code></pre>
<h3 data-id="heading-13">四、生产环境踩过的坑</h3>
<h4 data-id="heading-14">坑1：消息表和业务表不在同一数据库</h4>
<p><strong>场景复现</strong></p>
<p>最开始我们是这样设计的：</p>
<ul>
<li>订单库：<code>order_db</code></li>
<li>消息表：<code>common_db.mq_messages</code>（放在公共库）</li>
</ul>
<p>想法很美好：所有业务共用一张消息表，统一管理。结果上线第一天就出事了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> {
    <span class="hljs-comment">// 1. 写订单库</span>
    orderMapper.insert(order); <span class="hljs-comment">// 操作 order_db</span>
    
    <span class="hljs-comment">// 2. 写消息表</span>
    msgMapper.insert(msg); <span class="hljs-comment">// 操作 common_db</span>
    
    <span class="hljs-comment">// 问题：两个库的操作无法保证原子性！</span>
}
</code></pre>
<p><strong>表现</strong>：</p>
<ul>
<li>订单创建成功，但消息没发出去</li>
<li>或者消息发了，但订单回滚了</li>
</ul>
<p><strong>根本原因</strong>：</p>
<p>Spring的<code>@Transactional</code>默认只能管理单个数据源的事务。跨库操作需要分布式事务（XA、Seata），但那样又把架构搞复杂了。</p>
<p><strong>解决方案</strong>：</p>
<p>把消息表和业务表放到同一个数据库：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 每个业务库都建一张消息表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_db.mq_messages (...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> inventory_db.mq_messages (...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> payment_db.mq_messages (...);
</code></pre>
<p>虽然有点冗余，但换来了事务的强一致性，这个代价是值得的。</p>
<p><strong>最佳实践</strong>：</p>
<ol>
<li>消息表必须和业务表在同一个数据库</li>
<li>如果实在要跨库，建议用Spring的<code>ChainedTransactionManager</code>，但要注意它不是真正的两阶段提交</li>
<li>或者改用Seata的AT模式，但会增加系统复杂度</li>
</ol>
<hr/>
<h4 data-id="heading-15">坑2：内存队列OOM</h4>
<p><strong>场景复现</strong></p>
<p>我们的订单系统在大促期间挂了，看日志发现是OOM：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">java.lang.OutOfMemoryError: Java heap space</span>
    at java.util.concurrent.LinkedBlockingQueue.offer
</code></pre>
<p><strong>原因分析</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 内存队列无界，消息积压导致OOM</span>
<span class="hljs-keyword">private</span> BlockingQueue&lt;Msg&gt; msgQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;();

<span class="hljs-comment">// 大促期间：</span>
<span class="hljs-comment">// 1. 订单量暴增：10万/分钟</span>
<span class="hljs-comment">// 2. MQ发送变慢：网络抖动</span>
<span class="hljs-comment">// 3. 队列积压：几十万条消息</span>
<span class="hljs-comment">// 4. 内存爆了：每条消息1KB，几百MB就没了</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>改用有界队列</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置队列上限</span>
<span class="hljs-keyword">private</span> BlockingQueue&lt;Msg&gt; msgQueue = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10000</span>);

<span class="hljs-comment">// 队列满时的处理策略</span>
<span class="hljs-keyword">if</span> (!msgQueue.offer(msg, <span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
    log.warn(<span class="hljs-string">"消息队列已满，消息将由定时任务补偿 msgId={}"</span>, msg.getId());
    <span class="hljs-comment">// 不放入队列，靠定时任务兜底</span>
}
</code></pre>
<ol start="2">
<li><strong>监控队列积压</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedRate = 60000)</span> <span class="hljs-comment">// 每分钟检查</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorQueueSize</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> msgQueue.size();
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">8000</span>) { <span class="hljs-comment">// 80%阈值告警</span>
        log.error(<span class="hljs-string">"消息队列积压严重 size={}"</span>, size);
        <span class="hljs-comment">// 发送告警</span>
        alertService.send(<span class="hljs-string">"MQ队列积压"</span>, size);
    }
}
</code></pre>
<ol start="3">
<li><strong>增加消费线程</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 根据队列积压情况动态调整线程数</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">5</span>,  <span class="hljs-comment">// 核心线程数</span>
    <span class="hljs-number">20</span>, <span class="hljs-comment">// 最大线程数</span>
    <span class="hljs-number">60</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy() <span class="hljs-comment">// 队列满时调用者执行</span>
);
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ol>
<li>内存队列必须设置上限，推荐值：<code>1万 ~ 5万</code></li>
<li>设置告警阈值，及时发现问题</li>
<li>队列满时允许丢弃，依赖定时任务补偿</li>
<li>重要消息可以考虑持久化队列（如磁盘队列）</li>
</ol>
<hr/>
<h4 data-id="heading-16">坑3：消息重复发送</h4>
<p><strong>场景复现</strong></p>
<p>有个用户投诉说收到了5条重复的优惠券，查日志发现消息确实发了5次。</p>
<p><strong>原因分析</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processMsg</span><span class="hljs-params">(Msg msg)</span> {
    <span class="hljs-comment">// 1. 发送到MQ</span>
    producer.send(mqMsg);
    
    <span class="hljs-comment">// 2. 更新消息状态</span>
    msgMapper.updateStatus(msg.getId(), <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 问题：如果第1步成功，第2步失败（网络超时、数据库宕机）</span>
    <span class="hljs-comment">// 定时任务会认为消息没发送，再次发送</span>
}
</code></pre>
<p><strong>时序图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 发送线程
    participant MQ
    participant 数据库
    participant 定时任务
    
    发送线程-&gt;&gt;MQ: 1. 发送消息
    MQ--&gt;&gt;发送线程: 2. 发送成功
    发送线程-&gt;&gt;数据库: 3. 更新状态
    Note over 数据库: 数据库假死，更新失败
    
    定时任务-&gt;&gt;数据库: 4. 查询status=0的消息
    数据库--&gt;&gt;定时任务: 5. 返回该消息
    定时任务-&gt;&gt;MQ: 6. 再次发送（重复）
</code></pre>
<p><strong>解决方案</strong>：</p>
<p>方案一：<strong>消费端做幂等</strong>（推荐）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CouponConsumer</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;
    
    <span class="hljs-meta">@RocketMQMessageListener(
        topic = "coupon_issue",
        consumerGroup = "coupon_consumer"
    )</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String msgId, String content)</span> {
        <span class="hljs-comment">// 1. 检查是否已处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"coupon:processed:"</span> + msgId;
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isProcessed</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
            .setIfAbsent(key, <span class="hljs-string">"1"</span>, <span class="hljs-number">7</span>, TimeUnit.DAYS);
        
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(isProcessed)) {
            log.warn(<span class="hljs-string">"消息已处理，跳过 msgId={}"</span>, msgId);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 2. 业务处理</span>
        <span class="hljs-keyword">try</span> {
            couponService.issue(content);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 处理失败，删除标记，允许重试</span>
            redisTemplate.delete(key);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>方案二：<strong>发送前先查状态</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processMsg</span><span class="hljs-params">(Msg msg)</span> {
    <span class="hljs-comment">// 1. 先查询消息状态</span>
    <span class="hljs-type">MsgInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> msgMapper.selectById(msg.getId());
    <span class="hljs-keyword">if</span> (info.getStatus() == <span class="hljs-number">1</span>) {
        log.info(<span class="hljs-string">"消息已发送，跳过 msgId={}"</span>, msg.getId());
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 2. 发送到MQ</span>
    producer.send(mqMsg);
    
    <span class="hljs-comment">// 3. 更新状态</span>
    msgMapper.updateStatus(msg.getId(), <span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>消费端做幂等是王道</strong>，用Redis或数据库唯一约束</li>
<li>发送端尽量避免重复，但不强求100%去重</li>
<li>业务上要容忍少量重复，设计时考虑幂等性</li>
</ol>
<hr/>
<h4 data-id="heading-17">坑4：定时任务扫描压力大</h4>
<p><strong>场景复现</strong></p>
<p>上线一个月后，DBA找我说数据库慢查询告警，定位到是定时任务的扫描SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 每5分钟执行一次</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> mq_messages 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">5</span> <span class="hljs-keyword">MINUTE</span>)
LIMIT <span class="hljs-number">1000</span>;
</code></pre>
<p>表里有300万条消息，这个查询扫描了几十万行，数据库CPU飙到80%。</p>
<p><strong>原因分析</strong>：</p>
<ol>
<li>消息表数据量太大，历史消息没清理</li>
<li><code>create_time</code>字段没加索引</li>
<li>扫描范围太大</li>
</ol>
<p><strong>解决方案</strong>：</p>
<p>方案一：<strong>优化索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加联合索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> mq_messages 
<span class="hljs-keyword">ADD</span> INDEX idx_status_time (status, create_time);

<span class="hljs-comment">-- 查询改写</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> mq_messages 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">AND</span> next_retry_time <span class="hljs-operator">&lt;=</span> NOW()  <span class="hljs-comment">-- 改用 next_retry_time</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> next_retry_time
LIMIT <span class="hljs-number">1000</span>;
</code></pre>
<p>方案二：<strong>分区表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按月分区</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> mq_messages (
    ...
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (TO_DAYS(create_time)) (
    <span class="hljs-keyword">PARTITION</span> p202401 <span class="hljs-keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="hljs-string">'2024-02-01'</span>)),
    <span class="hljs-keyword">PARTITION</span> p202402 <span class="hljs-keyword">VALUES</span> LESS THAN (TO_DAYS(<span class="hljs-string">'2024-03-01'</span>)),
    ...
);

<span class="hljs-comment">-- 定时删除旧分区</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> mq_messages <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">PARTITION</span> p202401;
</code></pre>
<p>方案三：<strong>定时归档</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(cron = "0 0 3 * * ?")</span> <span class="hljs-comment">// 每天凌晨3点</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">archiveMessages</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 归档7天前的已发送消息</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> msgMapper.archiveOldMessages(<span class="hljs-number">7</span>);
    log.info(<span class="hljs-string">"归档消息 count={}"</span>, count);
    
    <span class="hljs-comment">// 2. 删除30天前的失败消息（人工介入后）</span>
    msgMapper.deleteOldFailedMessages(<span class="hljs-number">30</span>);
}
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ol>
<li>消息表按<code>status + next_retry_time</code>建索引</li>
<li>已发送的消息定期归档或删除</li>
<li>失败消息超过一定时间后人工介入</li>
<li>表数据量控制在100万以内</li>
</ol>
<hr/>
<h4 data-id="heading-18">坑5：大消息存储问题</h4>
<p><strong>场景复现</strong></p>
<p>有个业务场景需要发送商品详情，包含十几张图片的URL，消息体有50KB。一开始没注意，后来发现：</p>
<ol>
<li>数据库写入变慢：<code>VARCHAR(255)</code> 存不下，改成 <code>TEXT</code> 后行格式变大</li>
<li>内存队列占用高：1万条消息就占了500MB</li>
<li>MQ发送超时：RocketMQ单消息限制4MB，虽然没超，但网络传输慢</li>
</ol>
<p><strong>解决方案</strong>：</p>
<p>方案一：<strong>消息瘦身</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不要发送完整对象</span>
<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> JSON.toJSONString(product);

<span class="hljs-comment">// ✅ 正确：只发ID，消费端自己查</span>
<span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> JSON.toJSONString(
    Map.of(<span class="hljs-string">"productId"</span>, product.getId())
);
</code></pre>
<p>方案二：<strong>大消息分片</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendLargeMsg</span><span class="hljs-params">(String content)</span> {
    <span class="hljs-keyword">if</span> (content.length() &gt; <span class="hljs-number">10000</span>) { <span class="hljs-comment">// 超过10KB</span>
        <span class="hljs-comment">// 1. 上传到OSS</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> ossService.upload(content);
        
        <span class="hljs-comment">// 2. 发送OSS地址</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">miniMsg</span> <span class="hljs-operator">=</span> JSON.toJSONString(
            Map.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"oss"</span>, <span class="hljs-string">"url"</span>, url)
        );
        transactionMsgClient.sendMsg(miniMsg, topic, tag);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 直接发送</span>
        transactionMsgClient.sendMsg(content, topic, tag);
    }
}
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ol>
<li>消息体控制在1KB以内，最多不超过10KB</li>
<li>大数据用OSS等外部存储，消息只传地址</li>
<li>数据库字段用 <code>VARCHAR(1000)</code>，够用就好</li>
<li>定期检查消息体大小分布，发现异常及时处理</li>
</ol>
<h3 data-id="heading-19">五、与RocketMQ事务消息对比</h3>
<h4 data-id="heading-20">5.1 功能对比</h4>













































<table><thead><tr><th>维度</th><th>本地消息表</th><th>RocketMQ事务消息</th></tr></thead><tbody><tr><td><strong>事务保证</strong></td><td>✅ 强一致（依赖DB事务）</td><td>⚠️ 最终一致（依赖回查）</td></tr><tr><td><strong>实现复杂度</strong></td><td>🟡 中等（需要写代码）</td><td>🟢 简单（SDK封装好）</td></tr><tr><td><strong>MQ依赖</strong></td><td>🟢 低（MQ宕机不影响写入）</td><td>🔴 高（MQ宕机无法发送半消息）</td></tr><tr><td><strong>回查逻辑</strong></td><td>🟢 简单（查消息表状态）</td><td>🔴 复杂（需要反推业务状态）</td></tr><tr><td><strong>消息补偿</strong></td><td>✅ 支持（消息表可重试）</td><td>❌ 不支持（Rollback不重试）</td></tr><tr><td><strong>性能</strong></td><td>🟡 中等（多一次DB写入）</td><td>🟢 高（直接发MQ）</td></tr><tr><td><strong>监控</strong></td><td>🟢 容易（查消息表）</td><td>🟡 一般（需要看MQ控制台）</td></tr></tbody></table>
<h4 data-id="heading-21">5.2 适用场景</h4>
<p><strong>选择本地消息表的场景</strong>：</p>
<ol>
<li>
<p><strong>业务逻辑复杂</strong>：多表操作，难以通过回查判断状态</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：订单系统</span>
- 插入订单主表
- 插入订单明细表（多条）
- 更新库存表
- 扣减优惠券
- 发送消息
<span class="hljs-comment">// 回查时很难判断这一堆操作都成功了</span>
</code></pre>
</li>
<li>
<p><strong>需要消息补偿</strong>：业务要求失败的消息能重试</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：支付回调通知</span>
- 通知失败需要不断重试
- 直到商户返回成功
</code></pre>
</li>
<li>
<p><strong>对一致性要求高</strong>：不允许消息丢失</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：资金流水</span>
- 每一笔资金变动必须有对应的消息
</code></pre>
</li>
</ol>
<p><strong>选择RocketMQ事务消息的场景</strong>：</p>
<ol>
<li>
<p><strong>业务逻辑简单</strong>：单表操作，回查容易</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：用户注册送积分</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
    userMapper.insert(user);
    <span class="hljs-comment">// 回查：查用户表是否存在</span>
}
</code></pre>
</li>
<li>
<p><strong>性能要求高</strong>：不想增加DB写入开销</p>
</li>
<li>
<p><strong>团队经验丰富</strong>：熟悉RocketMQ事务消息的各种坑</p>
</li>
</ol>
<h4 data-id="heading-22">5.3 混合方案</h4>
<p>在实际项目中，我们采用了混合方案：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 核心业务用本地消息表</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 订单、库存、优惠券...复杂逻辑</span>
        <span class="hljs-comment">// 用本地消息表保证强一致</span>
    }
}

<span class="hljs-comment">// 简单业务用RocketMQ事务消息</span>
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 单表插入用户</span>
        <span class="hljs-comment">// 用RocketMQ事务消息，性能更好</span>
    }
}
</code></pre>
<h3 data-id="heading-23">六、最佳实践总结</h3>
<h4 data-id="heading-24">6.1 架构设计</h4>
<ol>
<li>
<p><strong>消息表必须和业务表在同一个数据库</strong></p>
<ul>
<li>利用数据库事务保证强一致性</li>
<li>避免分布式事务的复杂性</li>
</ul>
</li>
<li>
<p><strong>内存队列设置合理上限</strong></p>
<ul>
<li>推荐值：1万 ~ 5万</li>
<li>防止OOM</li>
<li>依赖定时任务兜底</li>
</ul>
</li>
<li>
<p><strong>时间轮实现延迟重试</strong></p>
<ul>
<li>失败消息延迟递增：5s、10s、25s、50s、100s</li>
<li>避免频繁重试打垮系统</li>
</ul>
</li>
<li>
<p><strong>定时任务作为兜底机制</strong></p>
<ul>
<li>扫描超时未发送的消息</li>
<li>间隔建议：5分钟</li>
<li>注意扫描性能</li>
</ul>
</li>
</ol>
<h4 data-id="heading-25">6.2 数据库设计</h4>
<ol>
<li>
<p><strong>表结构设计</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 核心字段</span>
status TINYINT          <span class="hljs-comment">-- 状态</span>
retry_count <span class="hljs-type">INT</span>         <span class="hljs-comment">-- 重试次数</span>
next_retry_time <span class="hljs-type">TIMESTAMP</span>  <span class="hljs-comment">-- 下次重试时间</span>

<span class="hljs-comment">-- 索引</span>
INDEX idx_status_retry (status, next_retry_time)
</code></pre>
</li>
<li>
<p><strong>消息体大小</strong></p>
<ul>
<li>控制在1KB以内</li>
<li>最多不超过10KB</li>
<li>大消息用OSS存储</li>
</ul>
</li>
<li>
<p><strong>数据归档</strong></p>
<ul>
<li>已发送消息定期归档（7天）</li>
<li>失败消息人工介入后删除（30天）</li>
<li>表数据量控制在100万以内</li>
</ul>
</li>
</ol>
<h4 data-id="heading-26">6.3 代码实现</h4>
<ol>
<li>
<p><strong>事务管理</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">businessMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 业务操作</span>
    bizMapper.insert(...);
    
    <span class="hljs-comment">// 2. 发送消息（同一事务）</span>
    msgClient.sendMsg(...);
}
</code></pre>
</li>
<li>
<p><strong>消息发送</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 同步写入消息表</span>
<span class="hljs-comment">// 2. 异步放入内存队列</span>
<span class="hljs-comment">// 3. 后台线程发送到MQ</span>
<span class="hljs-comment">// 4. 定时任务兜底补偿</span>
</code></pre>
</li>
<li>
<p><strong>消费端幂等</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用Redis或数据库唯一约束</span>
<span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"msg:processed:"</span> + msgId;
<span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> redis.setIfAbsent(key, <span class="hljs-string">"1"</span>, <span class="hljs-number">7</span>, TimeUnit.DAYS);
<span class="hljs-keyword">if</span> (Boolean.FALSE.equals(success)) {
    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 已处理，跳过</span>
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-27">6.4 监控告警</h4>
<ol>
<li>
<p><strong>消息积压告警</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 队列大小超过80%告警</span>
<span class="hljs-keyword">if</span> (msgQueue.size() &gt; <span class="hljs-number">8000</span>) {
    alert(<span class="hljs-string">"消息队列积压"</span>);
}
</code></pre>
</li>
<li>
<p><strong>发送失败告警</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 失败消息超过阈值告警</span>
<span class="hljs-type">int</span> <span class="hljs-variable">failCount</span> <span class="hljs-operator">=</span> msgMapper.countFailedMsg();
<span class="hljs-keyword">if</span> (failCount &gt; <span class="hljs-number">100</span>) {
    alert(<span class="hljs-string">"消息发送失败过多"</span>);
}
</code></pre>
</li>
<li>
<p><strong>处理延迟告警</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 消息处理时长超过5分钟告警</span>
<span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> now - msg.getCreateTime();
<span class="hljs-keyword">if</span> (delay &gt; <span class="hljs-number">300000</span>) {
    alert(<span class="hljs-string">"消息处理延迟"</span>);
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-28">6.5 容量规划</h4>
<ol>
<li>
<p><strong>数据库</strong></p>
<ul>
<li>消息表行数：&lt; 100万</li>
<li>单行大小：&lt; 1KB</li>
<li>总大小：&lt; 1GB</li>
</ul>
</li>
<li>
<p><strong>内存队列</strong></p>
<ul>
<li>队列长度：1万 ~ 5万</li>
<li>单条消息：&lt; 1KB</li>
<li>总内存：&lt; 50MB</li>
</ul>
</li>
<li>
<p><strong>MQ集群</strong></p>
<ul>
<li>TPS：按业务峰值 × 1.5</li>
<li>存储：按消息量 × 7天</li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">七、总结</h3>
<p>本地消息表是一种经过生产验证的分布式事务解决方案。相比RocketMQ事务消息，它在复杂业务场景下更加稳定可靠。</p>
<p>核心要点回顾：</p>
<ol>
<li><strong>强一致性</strong>：利用数据库事务保证业务和消息的原子性</li>
<li><strong>简单回查</strong>：直接查消息表状态，不需要反推业务状态</li>
<li><strong>消息补偿</strong>：支持失败消息重试，可靠性更高</li>
<li><strong>降低耦合</strong>：MQ暂时不可用时不影响业务主流程</li>
</ol>
<p>当然，它也有一些代价：</p>
<ol>
<li>需要额外的表存储和代码维护</li>
<li>多一次数据库写入，性能略低</li>
<li>需要定时任务兜底，增加了系统复杂度</li>
</ol>
<p>在实际项目中，建议根据业务场景灵活选择：</p>
<ul>
<li>复杂业务、高一致性要求 → 本地消息表</li>
<li>简单业务、高性能要求 → RocketMQ事务消息</li>
<li>混合使用，各取所长</li>
</ul>
<p>希望这篇文章能帮到正在做分布式事务选型的你。如果有任何问题，欢迎留言交流！</p>
<hr/>
<p><strong>参考资料</strong>：</p>
<ol>
<li>RocketMQ官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2F" target="_blank" title="https://rocketmq.apache.org/zh/docs/" ref="nofollow noopener noreferrer">rocketmq.apache.org/zh/docs/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官笑了：我用这套方案搞定了“2000w vs 20w”的Redis难题！]]></title>    <link>https://juejin.cn/post/7571342319893839907</link>    <guid>https://juejin.cn/post/7571342319893839907</guid>    <pubDate>2025-11-12T02:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571342319893839907" data-draft-id="7571404524792266787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官笑了：我用这套方案搞定了“2000w vs 20w”的Redis难题！"/> <meta itemprop="keywords" content="后端,面试,Redis"/> <meta itemprop="datePublished" content="2025-11-12T02:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件求生"/> <meta itemprop="url" content="https://juejin.cn/user/1038379932466263"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官笑了：我用这套方案搞定了“2000w vs 20w”的Redis难题！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1038379932466263/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件求生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:10:24.000Z" title="Wed Nov 12 2025 02:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那天我在一家互联网大厂面试，被问了一个看似简单、实则杀伤力极强的问题：</p>
<blockquote>
<p>“小米，假如MySQL里有2000万条数据，Redis里只能存20万条，你该怎么保证Redis中的数据都是热点数据？”</p>
</blockquote>
<p>当场我笑出了声，心想这题是“送命题”吧！但笑归笑，能不能答好，真能看出你是不是一个“实战派”的程序员。</p>
<p>今天这篇文章，就带你把这道题拆开、揉碎、讲透。</p>
<h2 data-id="heading-0">故事从一个“假想项目”开始</h2>
<p>那天，面试官给了我一个场景：</p>
<blockquote>
<p>“我们公司做电商系统，商品表有2000万条数据。商品详情页访问量巨大，但Redis内存有限，只能放20万条。</p>
<p>请你设计一个机制，保证Redis中的数据始终是<strong>最热的那部分</strong>。”</p>
</blockquote>
<p>我当时想起了一个词——<strong>冷热分层缓存</strong>。</p>
<p>于是我就从用户行为开始分析。</p>
<h2 data-id="heading-1">从用户行为说起：热点数据的本质</h2>
<p>在实际系统中，数据访问有一个著名规律：</p>
<blockquote>
<p><strong>二八法则（80/20原则）</strong> —— 20%的数据，承载了80%的访问量。</p>
</blockquote>
<p>也就是说，2000万条商品里，可能有几十万条才是真正被频繁访问的“热数据”。</p>
<p>这些热数据有几个特征：</p>
<ol>
<li><strong>高访问频率</strong>：比如热门商品、活动商品。</li>
<li><strong>时间敏感性强</strong>：比如“秒杀商品”、“热榜”。</li>
<li><strong>生命周期短</strong>：热点会变动，今天火的明天可能凉。</li>
</ol>
<p>明白了这些特征，我们才能思考“如何动态维护Redis中的20万条”。</p>
<h2 data-id="heading-2">错误的开始：最容易掉坑的两个思路</h2>
<p>在我刚工作那几年，也遇到过类似问题。那时我天真地以为，只要在Redis里设置个LRU（最近最少使用）策略就行。</p>
<p>事实证明：</p>
<blockquote>
<p>想靠Redis自己搞定热点维护，基本等于让仓库管理员“凭感觉”去挑畅销品。</p>
</blockquote>
<p>问题有三：</p>
<ol>
<li><strong>Redis LRU是局部淘汰</strong>：它只在达到内存上限时才淘汰，不是全局最优。</li>
<li><strong>访问波动太快</strong>：热点可能几分钟就变了，Redis反应太慢。</li>
<li><strong>热点穿透/击穿/雪崩问题</strong>：一旦热点没命中，数据库就遭殃。</li>
</ol>
<p>所以，仅靠Redis配置不够，我们得有一套完整的策略体系。</p>
<h2 data-id="heading-3">正确的思路：分层 + 动态 + 指标驱动</h2>
<p>我当时的回答思路是这样的（后来面试官很满意）：</p>
<blockquote>
<p>“我会设计一个<strong>冷热分层缓存架构</strong>，配合访问统计与异步更新机制，让Redis自动只保存真正的热点数据。”</p>
</blockquote>
<p>具体拆解成三层：</p>
<p><strong>第1层：读请求分层缓存架构</strong></p>
<p>先从读请求入手，我们分三层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04a48f53a35847ae802dee0995c99876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518224&amp;x-signature=AsvKLhAtSHjBtMb3DuCcCNChAAw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>请求流程：</p>
<blockquote>
<p>先查本地 → 不命中查Redis → 仍不命中查MySQL并回填。</p>
</blockquote>
<p>这样能减少Redis压力，同时也为“热点更新”打基础。</p>
<p><strong>第2层：热度统计与异步上报</strong></p>
<p>想知道哪些数据是热点，不能靠猜，要靠<strong>访问统计</strong>。</p>
<p>我们在应用层引入一个“热度计数器”，每次用户访问商品详情时，就上报一次访问记录。这里有两种实现方式：</p>
<p>1、方案A：本地统计 + 定时上报</p>
<ul>
<li>每台服务实例维护一个 ConcurrentHashMap&lt;id, count&gt;；</li>
<li>每隔1分钟，把统计结果异步汇总上报到MQ或Kafka；</li>
<li>消费端定时计算最近5分钟的访问量TopN。</li>
</ul>
<p>2、方案B：滑动窗口 + Redis计数器</p>
<ul>
<li>在Redis中使用 INCR 记录访问次数；</li>
<li>设置过期时间（比如10分钟），形成滑动时间窗口；</li>
<li>定时计算最近窗口内访问量TopN。</li>
</ul>
<p>最后得到的TopN列表，就是当前“热点数据候选集”。</p>
<p><strong>第3层：Redis热点数据维护策略</strong></p>
<p>有了TopN数据，就可以动态维护Redis了。</p>
<p>思路是：</p>
<blockquote>
<p>热点上升 → 自动写入Redis；</p>
<p>热点下降 → 自动淘汰。</p>
</blockquote>
<p>可以用一个简单的后台任务来实现：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5f9a2c79de45fda01de15a9563c414~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518224&amp;x-signature=8Y8dQ%2F8eAWwo%2Bqy0UjLeomcGElo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>这样，Redis就能“自动呼吸”，始终保持最有价值的数据。</p>
<h2 data-id="heading-4">加速策略：让Redis命中率更高</h2>
<p>到这里，我们已经有了冷热分层 + 热度更新机制。但想让系统“更丝滑”，还有一些优化小技巧：</p>
<p><strong>1、热点预测预热</strong></p>
<p>在大型活动（如双十一）前，可以根据历史访问日志提前预测哪些商品会热，然后批量加载入Redis。</p>
<p>这样一上线就能防止“冷启动”导致的击穿。</p>
<p><strong>2、热点降级机制</strong></p>
<p>当某一类数据突然暴涨，比如明星商品访问量暴增时，可以启用本地缓存或返回静态化数据页面，防止Redis被打爆。</p>
<p><strong>3、异步更新 + 双写一致性</strong></p>
<p>写操作时不要直接同步更新Redis，可以采用<strong>延迟双删策略</strong>：</p>
<ol>
<li>删除缓存；</li>
<li>更新数据库；</li>
<li>延迟1秒再删一次缓存，防止并发脏数据。</li>
</ol>
<p><strong>4、Redis Key 设计与分片</strong></p>
<p>为了防止单节点热点，可以给Key加前缀哈希分片，比如：</p>
<blockquote>
<p>product:{hash(id)%10}:{id}</p>
</blockquote>
<p>保证访问更均衡。</p>
<p><strong>5、Bloom Filter 防止穿透</strong></p>
<p>对于不存在的数据，用布隆过滤器提前拦截，减少数据库压力。</p>
<h2 data-id="heading-5">关键指标：让热点机制“看得见”</h2>
<p>很多人做完缓存策略就结束了，但真正的高手，会<strong>监控数据热度变化</strong>。</p>
<p>你可以用Prometheus + Grafana监控：</p>
<ul>
<li>Redis命中率；</li>
<li>热点数据更新频率；</li>
<li>MySQL QPS变化；</li>
<li>热度榜TopN曲线。</li>
</ul>
<p>一旦发现热点变动趋势异常，就能提前扩容或预热。</p>
<h2 data-id="heading-6">面试官的追问：那如果“热点突发”怎么办？</h2>
<p>面试官继续追我问：</p>
<blockquote>
<p>“如果某个新商品突然爆红，系统来不及同步进Redis怎么办？”</p>
</blockquote>
<p>我答：</p>
<blockquote>
<p>“可以结合消息队列 + 异步监听机制，让访问日志实时触发热点检测。”</p>
</blockquote>
<p>举个例子：</p>
<ol>
<li>用户访问详情 → 上报消息队列；</li>
<li>消费端监听访问流量；</li>
<li>当某个商品的访问量在1分钟内暴涨超过阈值（比如1000次）；</li>
<li>立即触发预加载入Redis。</li>
</ol>
<p>这样热点突发也能“秒级响应”。</p>
<h2 data-id="heading-7">延伸：还能用哪些“黑科技”？</h2>
<p>一些大厂更进一步，甚至会用到：</p>
<ul>
<li><strong>LFU (Least Frequently Used)</strong> 策略替代LRU；</li>
<li><strong>Redis + Caffeine 双缓存协同</strong>；</li>
<li><strong>基于滑动时间窗口的热度模型</strong>；</li>
<li><strong>流式计算（Flink）实时统计访问量</strong>；</li>
<li><strong>AI 热点预测</strong>（例如基于历史访问序列训练模型）。</li>
</ul>
<p>这些都能让热点数据维护更智能。</p>
<h2 data-id="heading-8">总结复盘：这道题到底考什么？</h2>
<p>其实，这道题考的并不是“你背了多少Redis命令”，而是考察你能不能从<strong>业务逻辑、系统设计、数据波动</strong>三个维度综合思考。</p>
<p>我后来总结了一句口诀：</p>
<blockquote>
<p><strong>“冷热分层是骨架，热度统计是灵魂，动态更新是血液。”</strong></p>
</blockquote>
<p>能把这三点讲清楚，你不仅能拿下面试，还能写出真正可落地的方案。</p>
<h2 data-id="heading-9">写在最后</h2>
<p>那次面试我顺利过了，面试官笑着说：</p>
<blockquote>
<p>“你这回答不是背书，是讲了个能跑起来的系统。”</p>
</blockquote>
<p>我回到家后，心里还挺有成就感。其实每次面试题背后，都藏着真实的工程智慧。它逼你去思考系统的本质，而不是死记硬背。如果你正准备面Java社招面试，记住这点：</p>
<blockquote>
<p>技术不是堆叠，而是思考。</p>
</blockquote>
<p>最后送你一句话：</p>
<blockquote>
<p><strong>“热数据永远有限，但聪明的人能让有限的资源发挥无限的价值。”</strong></p>
</blockquote>
<h2 data-id="heading-10">要点复盘（方便收藏）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fadda191f02425b8251bc5f36e0cadf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518224&amp;x-signature=MMYD90xE%2FnvKR5xbWDlFSkeukFk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-11">END</h2>
<p>我是小米，一个喜欢分享技术的31岁程序员。如果你喜欢我的文章，欢迎关注我的微信公众号“<strong>软件求生</strong>”，获取更多技术干货！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[经验贴：Agent实战落地踩坑六大经验教训，保姆教程。]]></title>    <link>https://juejin.cn/post/7571399272495857727</link>    <guid>https://juejin.cn/post/7571399272495857727</guid>    <pubDate>2025-11-12T05:41:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571399272495857727" data-draft-id="7571402480966811684" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="经验贴：Agent实战落地踩坑六大经验教训，保姆教程。"/> <meta itemprop="keywords" content="前端,JavaScript,产品"/> <meta itemprop="datePublished" content="2025-11-12T05:41:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="华洛"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474430190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            经验贴：Agent实战落地踩坑六大经验教训，保姆教程。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474430190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    华洛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:41:47.000Z" title="Wed Nov 12 2025 05:41:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>麦肯锡报告解读：《One year of agentic AI: Six lessons from the people doing the work》</p>
<p>报告我帮你们看过了，我将报告核心洞察与我的亲身实践相融合，整理了6000字干货。</p>
<p>无论您是正在规划首个Agent（智能体）项目的决策者，还是身处一线的AI产品经理或开发者，希望这些内容为您拨开迷雾，指引方向。</p>
<p>内容与麦肯锡报告中的六大经验教训相结合，无论是你否在开发Agent都值得一看。</p>
<h2 data-id="heading-0">一：与智能体无关、与工作流程有关</h2>
<p>我们希望落地的智能体，通常有这样的一个定义：</p>
<p>智能体是一种基于生成式人工智能基础模型的系统，能够在现实世界中行动并执行多步骤流程。</p>
<p>智能体可以自动化执行复杂任务，而这些任务通常需要运用自然语言处理，且<strong>原本需要人类执行和处理</strong>。</p>
<p>让智能体代替人工，这就是我们追求的结果。</p>
<p>而在追求这个结果的过程中，我们更应该关注的是流程的变革，而不是智能体的落地。</p>
<p>再说一遍，不要着急落地智能体！流程不够完善的情况下，大概率会得到一个智障，而不是一个智能体。</p>
<p><strong>真正实现业务价值的关键是变革工作流</strong>。</p>
<p>错误思路：做个Agent实现企业当前的业务工作流程。</p>
<p>正确思路：围绕Agent把企业业务工作流程重新设计。</p>
<p>我们需重新设计涵盖人、流程、技术的完整工作流，先梳理流程、识别用户痛点，并设计智能体与人类的反馈协同机制。</p>
<ul>
<li>例如保险行业可通过规则系统、分析型 AI、生成式 AI 与智能体的组合，重构理赔等复杂工作流。</li>
</ul>
<p>在重新设计工作流程时，一个重要起点是<strong>绘制流程图</strong>并<strong>识别用户的痛点</strong>。</p>
<p>这一步在设计智能体系统时至关重要，这类系统能够减少不必要的工作，让智能体和人类得以协作，更高效、更有效地实现业务目标。</p>
<p>这种协作可以通过学习循环和反馈机制来实现，从而构建一个完善的Agent。</p>
<p>在Agent的众多落地应用技术中，能让团队在恰当的节点使用合适的技术，这在对复杂、多步骤的工作流程进行重新设计时尤为重要。</p>
<ul>
<li>如何设计提示词工程，大量提示词的组合、联动、迭代</li>
<li>要如何设计工具列表，function call 和 提示词如何结合</li>
<li>RAG系统如何在Agent中落地，应用在哪些节点，是否需要和function call结合使用</li>
<li>workflow应该如何设计，</li>
<li>微调是否有必要加入，要如何抉择</li>
</ul>
<p>等等内容，在恰当的节点使用合适的技术，我们的Agent才能达到我们的预期效果。</p>
<p>画三个重点，来说明一下Agent流程设计对于AI产品经理的重要性：</p>
<ol>
<li>
<p>对于AI产品经理来说，“这个需求我就要，怎么实现我不管”的年代彻底过去了。AI产品你必须要告知开发明确的流程实现，否则你什么都得不到。</p>
</li>
<li>
<p>AI产品经理要对AI产品的结果负责，在整个流程中的任意一个节点出现问题，都会导致输出结果差异巨大。所以清晰的指导智能体中每一个步骤的执行逻辑，更有助于对结果进行优化。</p>
</li>
<li>
<p>由于延续了大模型的特性，AI产品也具有一定的不可解释性，对于错误的结果，我们修正Agent流程，通常都是我们最后的手段。</p>
</li>
</ol>
<h2 data-id="heading-1">二：智能体并非总能解决问题（智能体的选择与协作）</h2>
<p>认真思考：<code>高方差（结果不稳定、不统一）、低标准化的任务</code>和<code>低方差、高标准化的任务</code>，哪一类任务更适合用Agent来代替人工。</p>
<p>我在做1V1培训的时候，AI产品的需求挖掘环节，一定要再三强调的一句话：<strong>当需求能用AI且只能用AI完成时，才是一个AI的需求</strong></p>
<p>这里有两个重点：能用AI 和 只能用AI</p>
<p>例如：</p>
<p><code>把固定格式的文案转换成JSON格式的信息</code>。这就是一个能用AI但不是只能用AI的需求，这就不是一个AI需求</p>
<p><code>把用户随机输入的query进行分类，然后按照不同类型转换成JSON格式的信息</code>。这就是一个真正的AI需求</p>
<p>当一个任务足够标准化的时候，我们应该更倾向于用固定的程序来执行，既保证准确性，又可以保证执行速度。</p>
<p>所以我们需根据任务特性选择工具，避免盲目使用智能体。</p>
<p><strong>低方差、高标准化的任务适合规则式自动化，高方差、低标准化的任务更适配智能体。</strong></p>
<p>此外，真正的生产环境中，任务通常不是非黑即白的，并不是要么有智能体，要么没有智能体的。</p>
<p>智能体的两层作用：帮助我们完成特定任务、帮助我们更好的开展工作。</p>
<p><strong>千万不要忽略协作的重要性</strong></p>
<ol>
<li>有些任务如果单纯的用程序实现，可能会耗费很多人力和时间成本。</li>
<li>有些任务无法完全使用程序实现，需要结合一小部分的大模型能力。</li>
</ol>
<p>在决策时需明确任务的标准化程度，考虑更简单的自动化方案（如 LLM 提示词），而非陷入 “非智能体即无智能体” 的二元思维。</p>
<h2 data-id="heading-2">三：杜绝 “AI 糟粕”，重视评估与信任</h2>
<p>很多智能体在演示中表现亮眼，但实际使用中输出质量低（即 “AI 糟粕”），导致用户信任流失。</p>
<p>是的，相信大家一定见过非常多了了，推广软文看了觉得这可太NB了，等体验完就发现不过又是一个垃圾桶里的东西罢了。</p>
<p>麦肯锡报告表示：AI产品需要有持续的测试、监督才能确保效果，保证不断进步，需像培养员工一样培育智能体，明确其 “岗位职责”，通过细化的评估标准（如任务成功率、检索准确率、幻觉率）持续优化，专家需全程参与测试，避免 “一上线就不管”。</p>
<p><strong>以下是在决定为不同任务使用哪种人工智能工具时的指南：</strong></p>
<ul>
<li>如果任务是基于规则且重复性的，并且有结构化输入（例如数据录入），请使用基于规则的自动化。</li>
<li>如果输入是非结构化的（例如，冗长的文档），但任务仍然是抽取式或生成式的，请使用生成式人工智能、自然语言处理或预测分析。</li>
<li>如果任务涉及根据过往数据进行分类或预测，请使用预测分析或生成式人工智能。</li>
<li>如果输出需要综合、判断或创造性解读，请使用生成式人工智能。</li>
<li>如果任务涉及多步骤决策，并且存在大量输入和上下文高度可变的情况，请使用AI智能体。</li>
</ul>
<p><strong>以下是一些用于评估智能体性能的典型评估方法：</strong></p>
<ol>
<li>任务成功率（端到端）。任务成功率衡量的是无需升级处理或人工干预即可正确完成的工作流所占的百分比，这反映了实际应用价值。</li>
</ol>
<ul>
<li>F1分数/精确率和召回率。该指标平衡了假阳性和假阴性，使其在分类、提取以及具有明确可衡量结果（即是或否）的决策准确性任务中非常有用。</li>
<li>检索准确性。检索准确性是指检索到的正确文档、事实或证据相对于基准数据集的百分比，这对于检索增强型工作流程至关重要。</li>
<li>语义相似度。语义相似度是通过生成输出与参考输出之间基于嵌入的余弦相似度来衡量的，它捕捉的是超越精确词语匹配的意义对齐。</li>
</ul>
<ol start="2">
<li>将大语言模型（LLM）用作评判者，就是根据黄金标准或人类偏好来评估输出结果。这一指标在用于评估清晰度、有用性和推理合理性等主观性判断时，具有很好的可扩展性。</li>
</ol>
<ul>
<li>偏差检测（通过混淆矩阵）。偏差检测利用混淆矩阵来衡量不同用户群体在结果上的系统性差异，这些矩阵能凸显偏差的表现之处（例如，假阴性对某一群体的影响过大）。</li>
<li>幻觉率。该指标用于跟踪事实错误或无依据声明的出现频率，以确保智能体输出内容的可信度。</li>
<li>校准误差（置信度与准确度）。校准误差用于衡量智能体的置信度分数是否与实际正确性相符，这在对风险敏感的工作流程中十分重要。</li>
</ul>
<h2 data-id="heading-3">四：让追踪和验证每一步都变得简单</h2>
<p>当企业仅部署少数智能体时，人工排查错误尚可应对；但随着智能体数量增至数百、数千个，仅追踪最终结果的传统方式，会让错误定位变得如同 “大海捞针”。</p>
<p>因此我们需在工作流中嵌入监控与评估机制，实时验证每一步表现。</p>
<p>这里我们额外说说，如何实现一个AI产品的评估反馈系统。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc8dbb6b78ec448389f5996a2665c9f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763530906&amp;x-signature=ZGYSwO9AaVlyfI6IpdAxCxAOY5c%3D" alt="pinggu.jpg" width="100%" loading="lazy"/>
<p>评估反馈系统是AI产品的三个辅助系统之一，主要目标是长期持续的监控我们的AI产品。</p>
<p>为什么会有这样的一个辅助系统？</p>
<p>主要原因是：AI产品出现问题后具有非常强的隐蔽性。</p>
<p>例如：现在线上跑着我们调试好的客服机器人，但是假设当前时间我们的机器人出问题了，它在跟我们的用户闲聊、扯淡，但是就是不回答它应该回答的问题。</p>
<ul>
<li>我们的客服是否还在正常回复问题</li>
<li>我们的客服是否越权了</li>
<li>我们的客服是否泄露隐私信息了</li>
<li>等等....</li>
</ul>
<p>如果没有反馈，我们就无法知道是否发生了这样的事情。</p>
<p>就像传统的产品，404了、502了、程序崩溃了，这些都有监控系统随时通知，我们AI对话也需要有监控系统。</p>




























































<table><thead><tr><th>维度</th><th>细分指标/场景</th><th>具体说明/工具/指标</th></tr></thead><tbody><tr><td>准确性</td><td>明确的答案</td><td>测试数据集的query与answer直接比对</td></tr><tr><td/><td>非明确答案</td><td>测试数据集的query、参考文案、打分体系；使用BLEU（词汇匹配度）、ROUGE（摘要质量）评估</td></tr><tr><td>响应时间</td><td>首包响应时间</td><td>大模型最终回复的模型，影响用户体验</td></tr><tr><td/><td>平均响应时长</td><td>宏观把控响应效率</td></tr><tr><td/><td>报警逻辑</td><td>一段时间内，出现的百分比累计出现次数（如5分钟内，出现了50%/80次）</td></tr><tr><td>执行节点信息</td><td>错误原因分析</td><td>保留每个节点的执行信息，分为大模型原因（错误码、提示词）、程序原因（json格式兼容）、环境原因（502）</td></tr><tr><td>消耗</td><td>调用次数</td><td>成功次数、失败次数</td></tr><tr><td/><td>RPM</td><td>每分钟请求数，体现单位时间请求负载</td></tr><tr><td/><td>TPM</td><td>每分钟Token数，衡量文本处理吞吐量</td></tr><tr><td/><td>tokens</td><td>文本处理的基础单元消耗数量，关联成本与性能</td></tr></tbody></table>
<h2 data-id="heading-4">五：优先打造可复用智能体</h2>
<p>为单个任务单独开发智能体会造成冗余浪费，应聚焦可复用性。</p>
<p>识别重复出现的任务，构建集中化的资源平台（含验证服务、可复用代码、训练材料等），让智能体组件能跨工作流使用，可减少 30%-50% 的非必要工作。</p>
<p>识别重复性任务是一个很好的起点。企业可以开发能在不同工作流中轻松复用的智能体及智能体组件，并让开发者能便捷地使用它们。</p>
<p>这包括开发一套集中化的经过验证的服务（如大模型可观测性或预先批准的提示词）和资产（例如，应用模式、可复用代码和培训材料），这些服务和资产要易于查找和使用。</p>
<p>将这些功能整合到一个单一平台中至关重要。根据我们的经验，这有助于减少通常所需的30%到50%的非必要工作。</p>
<p><strong>哦豁，中台再次浮出水面，世界果然是个圈</strong></p>
<p>还是建议大家利用中台来统一管理大模型、提示词、知识库、function call、智能体、测试、评估、日志、权限等。</p>
<p>无论是单部门要开发多智能体、还是多部门要各自开发智能体或者使用大模型。都由中台统一提供大模型的基础能力。</p>
<p>提示词的版本迭代，测试，等操作也完全又提示词工程师在中台完成即可，一套做完，全公司可用。</p>
<h2 data-id="heading-5">六：人类仍不可或缺，角色与规模将改变</h2>
<p><strong>人类尚有存在的必要。工作流的设计，一定要考虑人类加入工作的便捷性</strong></p>
<p>随着人工智能智能体的不断增多，人类将扮演何种角色这一问题引发了诸多焦虑，</p>
<p>一方面是对工作安全性的担忧，另一方面则是对生产力提升的过高期望。</p>
<p>这导致人们对当今许多工作中人类的角色产生了截然不同的看法。</p>
<p>智能体无法完全替代人类，人类需负责监督模型准确性、处理边缘案例、确保合规等。</p>
<p>工作流变革后，特定流程的人力规模可能下降，但<strong>需重新设计人机协作模式</strong>，</p>
<p>比如通过简洁的可视化界面提升交互效率，明确人类在关键决策中的最终把控权（如律师审核智能体整理的案件核心信息）。</p>
<p>人机协作设计的一个重要部分是开发简单的可视化用户界面，让人们能够轻松与智能体交互。</p>
<p>回到最开始，我们说过要围绕Agent把企业业务工作流程重新设计。现在要再加上一句话工作流程重新设计时，要充分考虑人机协作的必要性和便利性。</p>
<h2 data-id="heading-6">结语</h2>
<p>Agent的成功，绝非仅仅是技术模型的胜利，而是一场关于工作流程、人机协作与组织变革的系统性工程。</p>
<p>Agent的规模化落地将不再是少数科技巨头的游戏，而是每一个致力于智能化转型企业的必修课。 前方的道路已然清晰：</p>
<p>对于决策者，首要任务是为这场变革扫清障碍，投资于可复用的平台建设，并推动跨部门的流程重塑。</p>
<p>对于AI产品经理与开发者，需要兼具技术理解与业务洞察，成为连接智能世界与真实需求的桥梁，用严谨的流程设计和细致的评估体系，将Agent的潜力转化为实实在在的业务价值。</p>
<p>这场由Agent引领的变革，其终点并非一个“无人化”的工厂，而是一个人机协同、高效共进的新工作范式。</p>
<p>现在，正是我们放下对技术的盲目崇拜，回归业务本质，用智慧和匠心去设计和构建这一新范式的最佳时机。</p>
<p>我是华洛，关注我，学习更多AI落地的实战经验与技巧。</p>
<p>加油，共勉。</p>
<blockquote>
<p>☺️你好，我是<strong>华洛</strong>，All in AI多年，专注于AI在产品侧的落地与应用和全自动化AI员工的研发。</p>
<p>你可以在这里联系我👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fhualuo-fztnr%2Frnkfkn%2Fhgg1ai826tm55vxs%3FsingleDoc%23" title="https://link.juejin.cn?target=https%3A%2F%2Fwww.yuque.com%2Fhualuo-fztnr%2Frnkfkn%2Fhgg1ai826tm55vxs%3FsingleDoc%23" target="_blank">www.yuque.com/hualuo-fztn…</a></p>
</blockquote>
<h2 data-id="heading-7">专栏文章</h2>
<p><a href="https://juejin.cn/post/7512332419203727371" target="_blank" title="https://juejin.cn/post/7512332419203727371"># 聊聊我们公司的AI应用工程师每天都干啥？</a></p>
<p><a href="https://juejin.cn/post/7547051639740743721" target="_blank" title="https://juejin.cn/post/7547051639740743721"># SEO还没死，GEO之战已经开始</a></p>
<p><a href="https://juejin.cn/post/7497890801348821055" title="https://juejin.cn/post/7497890801348821055" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南二：RAG工程落地之数据处理篇🧐</a></p>
<p><a href="https://juejin.cn/post/7496397558358900790" title="https://juejin.cn/post/7496397558358900790" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南一：根据产品需求和定位进行agent流程设计🧐</a></p>
<p><a href="https://juejin.cn/post/7492271537010671635" title="https://juejin.cn/post/7492271537010671635" target="_blank"># 聊一下MCP，希望能让各位清醒一点吧🧐</a></p>
<p><a href="https://juejin.cn/post/7485727472999579659" title="https://juejin.cn/post/7485727472999579659" target="_blank"># 实战派！百万PV的AI产品如何搭建RAG系统？</a></p>
<p><a href="https://juejin.cn/post/7482695183477047315" title="https://juejin.cn/post/7482695183477047315" target="_blank"># 团队落地AI产品的全流程</a></p>
<p><a href="https://juejin.cn/post/7474925725662969883" title="https://juejin.cn/post/7474925725662969883" target="_blank"># 5000字长文，AI时代下程序员的巨大优势！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教：LangChain+Qwen3搭建本地RAG问答系统，从0到1全流程]]></title>    <link>https://juejin.cn/post/7571355146771497002</link>    <guid>https://juejin.cn/post/7571355146771497002</guid>    <pubDate>2025-11-12T02:54:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146771497002" data-draft-id="7571378103281565702" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教：LangChain+Qwen3搭建本地RAG问答系统，从0到1全流程"/> <meta itemprop="keywords" content="LangChain,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-12T02:54:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教：LangChain+Qwen3搭建本地RAG问答系统，从0到1全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:54:25.000Z" title="Wed Nov 12 2025 02:54:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在大模型这个时期，“私有化部署”以及“个性化问答”成了企业和开发者的关键需求。要是想让AI根据特定的文档（像公司手册、技术文档、学术论文等）来回答问题，并且还担忧数据隐私会被泄漏出去，那检索增强生成（RAG就是最棒的解决办法。</p>
<p>本文将带大家从零开始，用LangChain框架整合Qwen3大模型与BGE-M3嵌入模型，手戳一个可本地运行的端到端RAG系统。无需复杂云服务，只需一台带GPU的电脑，就能拥有专属的“文档问答机器人”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39cc0e9c2ed743a0bde6c57fe6892759~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=k5w4J37SHJ5oRcxWF82rbfgbaPs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/382cb81d47f044539768ddbf5521f99f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=Ccg%2F43YYDV9Iocj6tAJbdMzQ7d4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 为什么选择RAG？聊聊大模型的“知识痛点”</h2>
<p>在正式动手前，我们先搞懂一个核心问题：为什么需要RAG？</p>
<p>大模型像GPT-4和Qwen这类的呢，虽然可以应对很多很多的通用问题，可是它们有两个特别要命的缺点：</p>
<p>1.知识时效性不太好：训练数据截止到某个特定的时间（就像Qwen3训练数据截止到2024年初那样），没办法获取最新的信息；</p>
<p>2.个性化能力弱：无法理解企业内部文档、个人笔记等私有数据；</p>
<p>3.易产生“幻觉”：对不确定的问题会编造看似合理的答案，无法溯源信息来源。</p>
<p>而RAG通过“检索生成”的组合完美解决这些问题：</p>
<ul>
<li>检索：从本地文档库中精准找到与问题相关的片段；</li>
<li>生成：让大模型基于检索到的“事实依据”回答问题，确保答案准确、可溯源</li>
</ul>
<p>直接讲RAG就像是给大模型安上了一个本地的知识仓库，既能让大模型具备语言理解的能力，又能把数据隐私和知识专属的问题给解决了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de2a9aebc76a479c810c67789c6c69cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=5eFrAFQZhGyVRcgTJsxFoSCuYpI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">02 技术选型：为什么是LangChain+Qwen3+BGEM3？</h2>
<p>搭建RAG系统得有三大关键组件，分别是文档处理框架、大语言模型（LLM以及嵌入模型（Embedding）。我们在选择这些组件时，主要从“本地化、对中文友好、资源消耗低”这个方面去考虑的：</p>






























<table><thead><tr><th>组件类型</th><th>选型</th><th>核心优势</th></tr></thead><tbody><tr><td>文档处理框架</td><td>LangChain</td><td>一站式整合文档加载、分割、向量存储、检索链，降低开发门槛</td></tr><tr><td>大语言模型（LLM）</td><td>Qwen3-7B-Instruct</td><td>阿里达摩院开源模型，中文处理能力强，7B 参数支持 4 位量化，本地 GPU 可运行</td></tr><tr><td>嵌入模型（Embedding）</td><td>BAAI/bge-m3</td><td>中科院自动化所开源，中文嵌入效果顶尖，支持检索优化指令，精度高于传统模型</td></tr><tr><td>向量数据库</td><td>Chroma</td><td>轻量级本地向量库，无需复杂部署，支持持久化存储，适配 LangChain</td></tr></tbody></table>
<p>除此之外，我们还用到BitsAndBytes量化技术，将Qwen3-7B模型压缩到4位精度，原本需要24GB显存的模型，现在8GB显存就能运行，大大降低硬件门槛。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cface5fffa14b8d9ac0add514c4bef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=VfW0PXYGsIKLRnUhrh%2F%2BXIkWjnI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">03 手把手搭建：从环境准备到代码实现</h2>
<p>接着开始实战部分啦，咱们把RAG系统搭建分成4步来进行，每一步都有着详细的讲解呢，就算是新手也能够很顺畅地跟得上哟。</p>
<p>3.1 环境准备：安装依赖库</p>
<p>先确定你的电脑已安装了Python3.8以及更高版本，与此同时拥有NVIDIAGPU（显存最好大于或等于8GB）。接着打开终端，接着执行以下这些命令来安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础依赖  </span>
pip install langchain chromadb transformers torch  
  
<span class="hljs-comment"># 文档加载与处理  </span>
pip install sentence-transformers python-dotenv  
  
<span class="hljs-comment"># 量化相关（4位量化需要）  </span>
pip install bitsandbytes accelerate  
  
<span class="hljs-comment"># 可选：如果需要处理PDF/Word文档，安装额外加载器  </span>
pip install pypdf python-docx
</code></pre>
<p>3.2 核心代码解析：从配置到问答的全流程</p>
<p>我们的代码分为5个核心模块：配置类、RAG系统初始化、文档处理、向量库加载、问答交互。下面逐模块拆解，理解每个环节的作用。</p>
<ol>
<li>配置类：统一管理参数，便于修改</li>
</ol>
<p>先对Config类进行定义，把文档路径、模型名称、量化配置等这些参数都集中到一起进行管理，这样之后要是需要修改的话，就不用到处去寻找代码啦：</p>
<pre><code class="hljs language-ini" lang="ini">classConfig:  
    <span class="hljs-comment"># 文档相关：指定文档存放目录、分块大小  </span>
    <span class="hljs-attr">DOCUMENTS_DIR</span> = <span class="hljs-string">"documents"</span><span class="hljs-comment"># 本地文档目录（需手动创建）  </span>
    <span class="hljs-attr">CHUNK_SIZE</span> = <span class="hljs-number">500</span>             <span class="hljs-comment"># 每个文本块的字符数（中文适配）  </span>
    <span class="hljs-attr">CHUNK_OVERLAP</span> = <span class="hljs-number">50</span>           <span class="hljs-comment"># 块间重叠字符数（避免分割丢失上下文）  </span>
      
    <span class="hljs-comment"># 模型相关：指定嵌入模型和LLM  </span>
    <span class="hljs-attr">EMBEDDING_MODEL_NAME</span> = <span class="hljs-string">"BAAI/bge-m3"</span><span class="hljs-comment"># 中文嵌入效果顶尖  </span>
    <span class="hljs-attr">LLM_MODEL_NAME</span> = <span class="hljs-string">"Qwen/Qwen3-7B-Instruct"</span><span class="hljs-comment"># 中文友好的7B模型  </span>
      
    <span class="hljs-comment"># 检索相关：向量库存储路径、检索数量  </span>
    <span class="hljs-attr">VECTOR_DB_DIR</span> = <span class="hljs-string">"vector_db_qwen_bge_m3"</span><span class="hljs-comment"># 向量库持久化目录  </span>
    <span class="hljs-attr">TOP_K</span> = <span class="hljs-number">3</span>                               <span class="hljs-comment"># 每次检索返回3个相关片段  </span>
      
    <span class="hljs-comment"># 量化配置：降低显存占用  </span>
    <span class="hljs-attr">USE_4BIT_QUANTIZATION</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 启用4位量化（8GB显存必备）</span>
</code></pre>
<p>2.  RAG系统初始化：加载嵌入模型与LLM</p>
<p>RAGSystem类是核心，负责初始化嵌入模型和LLM，这是系统的“大脑”和“眼睛”：</p>
<p>. 嵌入模型BGEM3）：将文本转化为向量数字），用于后续检索</p>
<ul>
<li>LLM（Qwen3）：基于检索到的文本片段生成自然语言回答</li>
</ul>
<p>（1）初始化嵌入模型：给文本“编数字”</p>
<p>BGEM3有一个关键优化：支持查询指令，能让查询向量更精准。例如在生成查询向量时，添加“为这个句子生成表示以用于检索相关文章：”前缀提升检索命中率：</p>
<pre><code class="hljs language-ini" lang="ini">def_init_embeddings(self):  
    print(f"加载BGE-M3嵌入模型: {self.config.EMBEDDING_MODEL_NAME}")  
    <span class="hljs-comment"># BGE-M3专属查询指令，优化中文检索效果  </span>
    <span class="hljs-attr">query_instruction</span> = <span class="hljs-string">"为这个句子生成表示以用于检索相关文章："</span>  
    return HuggingFaceBgeEmbeddings(  
        <span class="hljs-attr">model_name</span>=self.config.EMBEDDING_MODEL_NAME,  
        <span class="hljs-attr">model_kwargs</span>={<span class="hljs-string">'device'</span>: <span class="hljs-string">'cuda'</span>if torch.cuda.is_available() else<span class="hljs-string">'cpu'</span>},  
        <span class="hljs-attr">encode_kwargs</span>={<span class="hljs-string">'normalize_embeddings'</span>: <span class="hljs-literal">True</span>}, <span class="hljs-comment"># 向量归一化，提升检索精度  </span>
        <span class="hljs-attr">query_instruction</span>=query_instruction  
    )
</code></pre>
<p>（2）初始化LLM：给系统“装大脑”</p>
<p>Qwen3-7B模型默认需要24GB显存，我们通过4位量化将其压缩到8GB以内。这个时候Qwen有专属的提示词格式（<code>&lt;|im_start|&gt;</code>/<code>&lt;|im_end|&gt;</code>），需要自定义格式函数适配：</p>
<pre><code class="hljs language-ini" lang="ini">def_init_llm(self):  
    print(f"加载Qwen3模型: {self.config.LLM_MODEL_NAME}")  
      
    <span class="hljs-comment"># 4位量化配置：关键优化，降低显存占用  </span>
    <span class="hljs-attr">quantization_config</span> = None  
    if self.config.USE_4BIT_QUANTIZATION and torch.cuda.is_available():  
        <span class="hljs-attr">quantization_config</span> = BitsAndBytesConfig(  
            <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  
            <span class="hljs-attr">bnb_4bit_use_double_quant</span>=<span class="hljs-literal">True</span>, <span class="hljs-comment"># 双重量化，进一步压缩  </span>
            <span class="hljs-attr">bnb_4bit_quant_type</span>=<span class="hljs-string">"nf4"</span>, <span class="hljs-comment"># 适配大模型的量化类型  </span>
            <span class="hljs-attr">bnb_4bit_compute_dtype</span>=torch.float16  
        )  
      
    <span class="hljs-comment"># 加载tokenizer和模型（device_map="auto"自动分配GPU/CPU）  </span>
    <span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(self.config.LLM_MODEL_NAME)  
    <span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(  
        self.config.LLM_MODEL_NAME,  
        <span class="hljs-attr">quantization_config</span>=quantization_config,  
        <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,  
        <span class="hljs-attr">torch_dtype</span>=torch.float16,  
        <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span><span class="hljs-comment"># 加载Qwen的自定义代码  </span>
    )  
      
    <span class="hljs-comment"># Qwen专属提示词格式：必须严格遵循，否则模型无法正常响应  </span>
    defqwen_prompt_format(prompt):  
        returnf"&lt;|im_start|&gt;system\n你是一个 helpful 的助手，基于提供的上下文回答问题。&lt;|im_end|&gt;\n&lt;|im_start|&gt;user\n{prompt}&lt;|im_end|&gt;\n&lt;|im_start|&gt;assistant\n"  
      
    <span class="hljs-comment"># 创建文本生成pipeline，包装成LangChain的LLM  </span>
    <span class="hljs-attr">pipe</span> = pipeline(  
        "text-generation",  
        <span class="hljs-attr">model</span>=model,  
        <span class="hljs-attr">tokenizer</span>=tokenizer,  
        <span class="hljs-attr">max_new_tokens</span>=<span class="hljs-number">500</span>, <span class="hljs-comment"># 最大生成500个字符  </span>
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.7</span>, <span class="hljs-comment"># 随机性：0=严谨，1=灵活  </span>
        <span class="hljs-attr">repetition_penalty</span>=<span class="hljs-number">1.1</span>, <span class="hljs-comment"># 避免重复生成  </span>
        <span class="hljs-attr">pad_token_id</span>=tokenizer.pad_token_id,  
        <span class="hljs-attr">eos_token_id</span>=tokenizer.eos_token_id,  
        <span class="hljs-attr">prompt_format_template</span>=qwen_prompt_format  
    )  
      
    return HuggingFacePipeline(<span class="hljs-attr">pipeline</span>=pipe)
</code></pre>
<p>3.  文档处理：从“原始文档”到“向量库”</p>
<p>文档处理是RAG的“地基”，直接影响检索精度。这一步分为3个关键操作：加载文档→分割文档→创建向量库。</p>
<p>(1) 加载文档：支持多格式（TXT/PDF/Word）</p>
<p>我们用<code>DirectoryLoader</code>批量加载<code>documents</code>目录下的文档，默认支持TXT格式，若需处理PDF/Word，只需替换<code>loader_cls</code>为<code>PyPDFLoader/Docx2txtLoader</code>：</p>
<pre><code class="hljs language-ini" lang="ini">defload_and_process_documents(self):  
    <span class="hljs-attr">start_time</span> = time.time()  
      
    <span class="hljs-comment"># 加载文档：glob="*.txt"指定只加载TXT文件  </span>
    <span class="hljs-attr">loader</span> = DirectoryLoader(  
        self.config.DOCUMENTS_DIR,  
        <span class="hljs-attr">glob</span>=<span class="hljs-string">"*.txt"</span>,  
        <span class="hljs-attr">loader_cls</span>=TextLoader,  
        <span class="hljs-attr">loader_kwargs</span>={<span class="hljs-string">"encoding"</span>: <span class="hljs-string">"utf-8"</span>} <span class="hljs-comment"># 解决中文乱码问题  </span>
    )  
    <span class="hljs-attr">documents</span> = loader.load()  
      
    ifnot documents:  
        raise ValueError(f"请在 {self.config.DOCUMENTS_DIR} 目录中添加文档")  
    print(f"成功加载 {len(documents)} 个文档")
</code></pre>
<p>（2）分割文档：中文适配的“黄金分割点”</p>
<p>大模型有上下文长度限制（如Qwen3-7B支持8k tokens），若直接将长文档传入，会丢失上下文。我们用<code>RecursiveCharacterTextSplitter</code>按中文标点分割，避免将完整句子切散：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 分割文档：按“段落→句子→标点”分层分割，保留中文语义  </span>
<span class="hljs-attr">text_splitter</span> = RecursiveCharacterTextSplitter(  
    <span class="hljs-attr">chunk_size</span>=self.config.CHUNK_SIZE,  
    <span class="hljs-attr">chunk_overlap</span>=self.config.CHUNK_OVERLAP,  
    <span class="hljs-attr">separators</span>=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"。"</span>, <span class="hljs-string">"，"</span>, <span class="hljs-string">"；"</span>, <span class="hljs-string">"、"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>] <span class="hljs-comment"># 中文优先分割符  </span>
)  
<span class="hljs-attr">texts</span> = text_splitter.split_documents(documents)  
print(f"文档分割完成，得到 {len(texts)} 个文本块")
</code></pre>
<p>（3）创建向量库：将文本块“存入数据库”</p>
<p>用Chroma向量库存储文本块的向量，后续检索时，只需将问题转化为向量，与库中的向量计算相似度，就能快速找到相关片段：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建并持久化向量库：下次运行可直接加载，无需重新处理  </span>
<span class="hljs-attr">self.vector_db</span> = Chroma.from_documents(  
    <span class="hljs-attr">documents</span>=texts,  
    <span class="hljs-attr">embedding</span>=self.embeddings,  
    <span class="hljs-attr">persist_directory</span>=self.config.VECTOR_DB_DIR  
)  
self.vector_db.persist()  
  
<span class="hljs-comment"># 创建检索链：将“检索”与“生成”串联  </span>
<span class="hljs-attr">self.qa_chain</span> = RetrievalQA.from_chain_type(  
    <span class="hljs-attr">llm</span>=self.llm,  
    <span class="hljs-attr">chain_type</span>=<span class="hljs-string">"stuff"</span>, <span class="hljs-comment"># 简单高效：将所有相关片段传入LLM  </span>
    <span class="hljs-attr">retriever</span>=self.vector_db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: self.config.TOP_K}),  
    <span class="hljs-attr">return_source_documents</span>=<span class="hljs-literal">True</span><span class="hljs-comment"># 返回源文档，便于溯源  </span>
)  
  
<span class="hljs-attr">end_time</span> = time.time()  
print(f"文档处理完成，耗时 {end_time - start_time:.2f} 秒")
</code></pre>
<p>4.  问答交互：从“问题”到“答案”的闭环</p>
<p>最后，实现<code>query</code>方法，接收用户问题，调用检索链生成答案，并返回源文档片段（便于验证答案准确性）：</p>
<pre><code class="hljs language-python" lang="python">defquery(self, question: <span class="hljs-built_in">str</span>):  
    ifnot self.qa_chain:  
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"请先加载文档或向量库"</span>)  
      
    start_time = time.time()  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理查询: <span class="hljs-subst">{question}</span>"</span>)  
      
    <span class="hljs-comment"># 执行检索增强生成：先检索相关片段，再生成答案  </span>
    result = self.qa_chain({<span class="hljs-string">"query"</span>: question})  
      
    end_time = time.time()  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询处理完成，耗时 <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span> 秒"</span>)  
      
    <span class="hljs-keyword">return</span> result
</code></pre>
<p>5.  主函数：一键运行系统</p>
<p>在<code>if name == "main":</code>中，我们实现“自动创建示例文档→初始化系统→加载向量库→测试问答”的全流程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    os.environ[<span class="hljs-string">"TOKENIZERS_PARALLELISM"</span>] = <span class="hljs-string">"false"</span><span class="hljs-comment"># 避免tokenizer并行警告  </span>
      
    <span class="hljs-comment"># 初始化配置与系统  </span>
    config = Config()  
    rag_system = RAGSystem(config)  
      
    <span class="hljs-comment"># 首次运行：创建示例文档（数据科学、LLM应用相关）  </span>
    ifnot os.listdir(config.DOCUMENTS_DIR):  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"创建示例文档..."</span>)  
        create_sample_documents(config.DOCUMENTS_DIR)  
      
    <span class="hljs-comment"># 加载向量库：存在则直接加载，不存在则重新处理文档  </span>
    ifnot rag_system.load_existing_vector_db():  
        rag_system.load_and_process_documents()  
      
    <span class="hljs-comment"># 测试中文问答  </span>
    test_questions = [  
        <span class="hljs-string">"数据科学工作流包括哪些步骤？"</span>,  
        <span class="hljs-string">"大语言模型有哪些主要应用场景？"</span>  
    ]  
      
    <span class="hljs-comment"># 输出结果：包含答案和源文档片段  </span>
    <span class="hljs-keyword">for</span> question <span class="hljs-keyword">in</span> test_questions:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">80</span>)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{question}</span>"</span>)  
        result = rag_system.query(question)  
          
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n回答:"</span>)  
        <span class="hljs-built_in">print</span>(result[<span class="hljs-string">"result"</span>])  
          
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n相关文档片段:"</span>)  
        <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(result[<span class="hljs-string">"source_documents"</span>], <span class="hljs-number">1</span>):  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n文档 <span class="hljs-subst">{i}</span>:"</span>)  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"来源: <span class="hljs-subst">{doc.metadata[<span class="hljs-string">'source'</span>]}</span>"</span>)  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"内容: <span class="hljs-subst">{doc.page_content[:<span class="hljs-number">200</span>]}</span>..."</span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6fb3a938b574b2bbb96cf755f1ab02b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=bhOZiK1DK6JO3fKyhBhPYCVJkfw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">04 运行测试：看看系统实际效果</h2>
<p>将代码保存为<code>rag_qwe_bge.py</code>，执行以下命令运行：</p>
<pre><code class="hljs">python rag_qwen_bge.py
</code></pre>
<p>首次运行时，系统会自动：</p>
<ol>
<li>在<code>documents</code>目录创建2个示例文档（数据科学、LLM应用）；</li>
<li>下载BGE-M3和Qwen3-7B模型（约10GB，需耐心等待）；</li>
<li>处理文档并创建向量库，存入<code>vector*db*qwen*bge*m3</code>目录。</li>
</ol>
<p>运行成功后，会输出如下结果（以“数据科学工作流包括哪些步骤？”为例）：</p>
<p>================================</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">问题: 数据科学工作流包括哪些步骤？  </span>
<span class="hljs-section">处理查询: 数据科学工作流包括哪些步骤？  </span>
<span class="hljs-section">回答:  </span>
数据科学工作流通常包括以下9个步骤：  
问题定义：明确业务问题和分析目标，这是整个工作流的基础，确保后续工作围绕核心需求展开；  
数据收集：获取相关的结构化（如数据库表）和非结构化（如文本、图片）数据；  
数据清洗：处理数据中的缺失值、异常值和重复数据，保证数据质量，避免影响后续分析结果；  
探索性数据分析：通过统计方法和可视化工具，理解数据分布、变量关系等，挖掘数据潜在规律；  
特征工程：对原始数据进行转换、筛选或创建新特征，生成适合机器学习模型输入的特征；  
模型构建：根据问题类型（如分类、回归）选择适当的机器学习模型，并使用清洗后的数据集进行训练；  
模型评估：使用准确率、召回率、RMSE等指标评估模型性能，判断模型是否满足业务需求；  
结果部署：将训练好的模型集成到业务流程中（如API接口、业务系统），实现实际应用；  
监控与更新：持续监控模型在实际场景中的性能，当数据分布或业务需求变化时，定期更新模型。  
  
<span class="hljs-section">相关文档片段:  </span>
文档 1:  
<span class="hljs-section">来源: documents/data_science.txt  </span>
<span class="hljs-section">内容: 数据科学是一个跨学科领域，结合了统计学、机器学习、数据可视化和领域知识，  </span>
用于从结构化和非结构化数据中提取有价值的 insights。  
数据科学工作流通常包括以下步骤：  
问题定义：明确业务问题和分析目标  
数据收集：获取相关的结构化和非结构化数据  
数据清洗：处理缺失值、异常值和重复数据  
探索性数据分析：理解数据分布和变量关系  
特征工程：创建适合建模的特征  
模型构建：选择和训练适当的机器学习模型  
模型评估：使用合适的指标评估模型性能  
结果部署：将模型集成到业务流程中  
监控与更新：持续监控模型性能并定期更新
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95d11bbd3e2b4fc487ac488539659b36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=mC8zwmhu3cPgQY9Aaj5CWa2%2F0eY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">05 总结：展望，一点建议</h2>
<ol>
<li>本文针对企业私有化、个性化问答需求，提供了基于LangChain+Qwen3+BGEM3的本地RAG系统搭建全流程，通过4位量化技术降低硬件门槛至8GB显存，新手也能落地。</li>
<li>这个方案通过“检索生成”这种方式，把大模型存在的知识会过时、容易产生“幻觉”以及没法适应私有数据这些难题给解决了，既保障了数据的安全，又保证了回答的准确性。</li>
<li>以后本地RAG会朝着更轻、更多种模式的方向去发展呢，给新手的建议是先从最基本的文本开始，把流程熟悉起来，等过了这一步之后呢，就可以去摸索参数的优化以及多种技术融合这样更高级的东西啦。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/672ce22d989a4f1f8f4e4124bfc0ccc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763520864&amp;x-signature=6EStMAexj5jmQm7CozNYjqRLA8I%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[Java] 用 Swing 生成一个最大公约数计算器（展示计算过程）]]></title>    <link>https://juejin.cn/post/7571396053879750708</link>    <guid>https://juejin.cn/post/7571396053879750708</guid>    <pubDate>2025-11-12T05:06:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571396053879750708" data-draft-id="7571272874847076404" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[Java] 用 Swing 生成一个最大公约数计算器（展示计算过程）"/> <meta itemprop="keywords" content="后端,Java,数学"/> <meta itemprop="datePublished" content="2025-11-12T05:06:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="金銀銅鐵"/> <meta itemprop="url" content="https://juejin.cn/user/747323638159757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [Java] 用 Swing 生成一个最大公约数计算器（展示计算过程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323638159757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    金銀銅鐵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:06:30.000Z" title="Wed Nov 12 2025 05:06:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 <code>Swing</code> 生成一个最大公约数计算器（展示计算过程）</h2>
<h3 data-id="heading-1">背景</h3>
<p>在 <a href="https://juejin.cn/post/7569876592920854543" target="_blank" title="https://juejin.cn/post/7569876592920854543">[Java] 用 Swing 生成一个最大公约数计算器</a> 一文中，我们完成了一个简单的最大公约数计算器。示例效果如下图所示 ⬇️</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad38e3e6786b4d139549d1f2a28e1eca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=4IJWmyDwdMoNG%2BD0g78Ab4ztjPg%3D" alt="image.png" loading="lazy"/></p>
<p>它虽然可以计算出两个整数的最大公约数（<strong>两个整数不能同时为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></strong>），但是并没有展示计算过程。有的时候，我们也关心计算的过程，例如我们利用欧几里得算法计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>210</mn><mo separator="true">,</mo><mn>135</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(210, 135)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">210</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">135</span><span class="mclose">)</span></span></span></span></span> 时，计算过程可以这样表示</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>210</mn><mo>=</mo><mn>1</mn><mo>×</mo><mn>135</mn><mo>+</mo><mn>75</mn><mspace linebreak="newline"/><mn>135</mn><mo>=</mo><mn>1</mn><mo>×</mo><mn>75</mn><mo>+</mo><mn>60</mn><mspace linebreak="newline"/><mn>75</mn><mo>=</mo><mn>1</mn><mo>×</mo><mn>60</mn><mo>+</mo><mn>15</mn><mspace linebreak="newline"/><mn>60</mn><mo>=</mo><mn>4</mn><mo>×</mo><mn>15</mn><mo>+</mo><mn>0</mn><mspace linebreak="newline"/></mrow><annotation encoding="application/x-tex">210 = 1 \times 135 + 75\\
135 = 1 \times 75 + 60\\
75 = 1 \times 60 + 15\\
60 = 4 \times 15 + 0\\</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">210</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">135</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">75</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">135</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">75</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">60</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">75</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">60</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">15</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">60</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">15</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span><span class="mspace newline"/></span></span></span></div>
<p>所以</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>210</mn><mo separator="true">,</mo><mn>135</mn><mo stretchy="false">)</mo><mspace linebreak="newline"/><mo>=</mo><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>135</mn><mo separator="true">,</mo><mn>75</mn><mo stretchy="false">)</mo><mspace linebreak="newline"/><mo>=</mo><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>75</mn><mo separator="true">,</mo><mn>60</mn><mo stretchy="false">)</mo><mspace linebreak="newline"/><mo>=</mo><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>60</mn><mo separator="true">,</mo><mn>15</mn><mo stretchy="false">)</mo><mspace linebreak="newline"/><mo>=</mo><mn>15</mn></mrow><annotation encoding="application/x-tex">gcd(210, 135)\\
= gcd(135, 75)\\
= gcd(75, 60)\\
= gcd(60, 15)\\
= 15</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">210</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">135</span><span class="mclose">)</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">135</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">75</span><span class="mclose">)</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">75</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">60</span><span class="mclose">)</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">60</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">15</span><span class="mclose">)</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">15</span></span></span></span></span></div>
<p>如果最大公约数计算器可以把上述过程展示出来，那就方便多了。所以我们的目标是做出下图这样的界面 ⬇️</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cff5d47cabca42389748ee517c914035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=mQdD3uFvM7kGTM9pUTvbDanE3jQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">正文</h3>
<h4 data-id="heading-3">需要保存哪些数据</h4>
<p>我们先看看如果需要展示完整的计算过程，需要保存哪些数据。以计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>210</mn><mo separator="true">,</mo><mn>135</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(210, 135)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">210</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">135</span><span class="mclose">)</span></span></span></span></span> 为例，它的计算过程如下 ⬇️</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>210</mn><mo>=</mo><mn>1</mn><mo>×</mo><mn>135</mn><mo>+</mo><mn>75</mn><mspace linebreak="newline"/><mn>135</mn><mo>=</mo><mn>1</mn><mo>×</mo><mn>75</mn><mo>+</mo><mn>60</mn><mspace linebreak="newline"/><mn>75</mn><mo>=</mo><mn>1</mn><mo>×</mo><mn>60</mn><mo>+</mo><mn>15</mn><mspace linebreak="newline"/><mn>60</mn><mo>=</mo><mn>4</mn><mo>×</mo><mn>15</mn><mo>+</mo><mn>0</mn><mspace linebreak="newline"/></mrow><annotation encoding="application/x-tex">210 = 1 \times 135 + 75\\
135 = 1 \times 75 + 60\\
75 = 1 \times 60 + 15\\
60 = 4 \times 15 + 0\\</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">210</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">135</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">75</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">135</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">75</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">60</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">75</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">60</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">15</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">60</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">15</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span><span class="mspace newline"/></span></span></span></div>
<p>每一行都可以看成是 ⬇️ （<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 行的 <strong>商</strong>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">r_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 行的 <strong>余数</strong>）</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo>=</mo><msub><mi>q</mi><mi>i</mi></msub><mo>×</mo><msub><mi>b</mi><mi>i</mi></msub><mo>+</mo><msub><mi>r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i = q_i \times b_i + r_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>看来我们只需要将所有的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>q</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>b</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>r</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i, q_i, b_i, r_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都保存下来（<strong>计算结束的条件是出现某个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">r_i=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></strong>），就可以将完整的计算过程展示出来。</p>
<h4 data-id="heading-4">输入的标准化</h4>
<h5 data-id="heading-5">只使用非负数</h5>
<p>对非负整数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 而言，不难验证 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mo>−</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(a, b) = gcd(-a, b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">−</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>，所以如果用户输入了 <strong>负整数</strong>，我们总是可以将其先转化为 <strong>非负整数</strong>，然后再进行计算。也就是说我们只要计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi mathvariant="normal">∣</mi><mi>a</mi><mi mathvariant="normal">∣</mi><mo separator="true">,</mo><mi mathvariant="normal">∣</mi><mi>b</mi><mi mathvariant="normal">∣</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(|a|, |b|)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">∣</span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">∣</span><span class="mord mathnormal">b</span><span class="mord">∣</span><span class="mclose">)</span></span></span></span></span>，就可以得到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(a, b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span> 的值。</p>
<h5 data-id="heading-6">参数顺序的调整</h5>
<p>由于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi>b</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(a, b) = gcd(b, a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>，所以可以调整参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo separator="true">,</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a, b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span></span></span></span></span> 的顺序。我们可以通过计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(\max(a,b), \min(a, b))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">min</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">))</span></span></span></span></span> 从而得到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(a, b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>。</p>
<h4 data-id="heading-7">代码</h4>
<h5 data-id="heading-8">计算最大公约数的代码</h5>
<p>基于上文的讨论，可以写出保存了计算过程中所有数据的 <code>GCDCalculator</code> 类 ⬇️</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GCDCalculator</span> {

    <span class="hljs-keyword">record</span> <span class="hljs-title class_">CalculationDetails</span><span class="hljs-params">(
            BigInteger a,
            BigInteger b,
            BigInteger gcd,
            java.util.List&lt;Equation&gt; equationHolders
    )</span> {
        <span class="hljs-comment">/**
         * A holder class for equation a = q * b + r
         */</span>
        <span class="hljs-keyword">record</span> <span class="hljs-title class_">Equation</span><span class="hljs-params">(
                BigInteger a,
                BigInteger q,
                BigInteger b,
                BigInteger r
        )</span> {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s = %s × %s + %s"</span>, a, q, b, r);
            }
        }
    }

    <span class="hljs-keyword">private</span> BigInteger <span class="hljs-title function_">toBigInteger</span><span class="hljs-params">(String num)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(num.trim());
    }

    <span class="hljs-keyword">public</span> CalculationDetails <span class="hljs-title function_">calculateGCD</span><span class="hljs-params">(String a, String b)</span> {
        <span class="hljs-keyword">return</span> calculateGCD(toBigInteger(a), toBigInteger(b));
    }

    <span class="hljs-keyword">public</span> CalculationDetails <span class="hljs-title function_">calculateGCD</span><span class="hljs-params">(BigInteger a, BigInteger b)</span> {
        a = a.abs();
        b = b.abs();

        BigInteger biggerOne;
        BigInteger smallerOne;
        <span class="hljs-keyword">if</span> (a.compareTo(b) &gt;= <span class="hljs-number">0</span>) {
            biggerOne = a;
            smallerOne = b;
        } <span class="hljs-keyword">else</span> {
            biggerOne = b;
            smallerOne = a;
        }

        <span class="hljs-keyword">if</span> (biggerOne.equals(BigInteger.ZERO)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"两个整数不能都是0！"</span>);
        }
        <span class="hljs-type">var</span> <span class="hljs-variable">equations</span> <span class="hljs-operator">=</span> doCalculateGCD(biggerOne, smallerOne);
        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">gcd</span> <span class="hljs-operator">=</span> smallerOne.equals(BigInteger.ZERO) ? biggerOne : equations.getFirst().b;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalculationDetails</span>(biggerOne, smallerOne, gcd, equations);
    }

    <span class="hljs-keyword">private</span> java.util.List&lt;CalculationDetails.Equation&gt; doCalculateGCD(BigInteger a, BigInteger b) {
        <span class="hljs-keyword">if</span> (b.equals(BigInteger.ZERO)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        }

        <span class="hljs-type">var</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> doCalculateGCD(b, a.mod(b));
        result.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CalculationDetails</span>.Equation(a, a.divide(b), b, a.mod(b)));
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">GCDCalculator</span> <span class="hljs-variable">gcdCalculator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GCDCalculator</span>();
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"0"</span>, <span class="hljs-string">"1"</span>).gcd); <span class="hljs-comment">// should be 1</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"1"</span>, <span class="hljs-string">"0"</span>).gcd); <span class="hljs-comment">// should be 1</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"100"</span>, <span class="hljs-string">"20"</span>).gcd); <span class="hljs-comment">// should be 20</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"10"</span>, <span class="hljs-string">"12"</span>).gcd); <span class="hljs-comment">// should be 2</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"233"</span>, <span class="hljs-string">"144"</span>).gcd); <span class="hljs-comment">// should be 1</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"12345"</span>, <span class="hljs-string">"67890"</span>).gcd); <span class="hljs-comment">// should be 15</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"54321"</span>, <span class="hljs-string">"9876"</span>).gcd); <span class="hljs-comment">// should be 3</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"1160718174"</span>, <span class="hljs-string">"316258250"</span>).gcd); <span class="hljs-comment">// should be 1078</span>
    }
}
</code></pre>
<p>它的 <code>main</code> 函数里做了一些测试，最大公约数的计算结果结果符合预期。</p>
<h4 data-id="heading-9">完整的代码</h4>
<p>既然我们的代码已经可以保存在计算最大公约数的过程中用到的所有数据，那么再添加一些和 <code>Swing</code> 相关的代码就可以将计算过程展示出来了。由于 <code>Swing</code> 的知识体系比较复杂，而它的知识点也比较零散，我自己也只是学了点皮毛，和 <code>Swing</code> 相关的代码就不展开说了。完整的代码如下 ⬇️</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.swing.*;
<span class="hljs-keyword">import</span> java.awt.*;
<span class="hljs-keyword">import</span> java.awt.event.ActionEvent;
<span class="hljs-keyword">import</span> java.awt.event.ActionListener;
<span class="hljs-keyword">import</span> java.math.BigInteger;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.StringJoiner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DetailedGCDCalculator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        EventQueue.invokeLater(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcGreatestCommonDivisor</span>().show());
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CalcGreatestCommonDivisor</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SimpleFrame</span> <span class="hljs-variable">frame</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleFrame</span>(<span class="hljs-string">"最大公约数计算器"</span>);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setVisible(<span class="hljs-literal">true</span>);

        <span class="hljs-type">JPanel</span> <span class="hljs-variable">northPanel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JPanel</span>();
        northPanel.setLayout(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GridLayout</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>));
        <span class="hljs-type">JTextField</span> <span class="hljs-variable">textField1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextField</span>();
        northPanel.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JLabel</span>(<span class="hljs-string">"请输入第一个整数："</span>, SwingConstants.RIGHT));
        northPanel.add(textField1);
        northPanel.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JLabel</span>(<span class="hljs-string">"请输入第二个整数："</span>, SwingConstants.RIGHT));
        <span class="hljs-type">JTextField</span> <span class="hljs-variable">textField2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextField</span>();
        northPanel.add(textField2);

        <span class="hljs-type">JTextArea</span> <span class="hljs-variable">textArea</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JTextArea</span>(<span class="hljs-number">8</span>, <span class="hljs-number">20</span>);
        textArea.setText(<span class="hljs-string">"这里用于展示最大公约数的计算过程"</span>);
        textArea.setEditable(<span class="hljs-literal">false</span>);
        textArea.setLineWrap(<span class="hljs-literal">true</span>);
        <span class="hljs-type">JScrollPane</span> <span class="hljs-variable">scrollPane</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JScrollPane</span>(textArea);
        frame.add(scrollPane, BorderLayout.CENTER);

        frame.add(northPanel, BorderLayout.NORTH);
        <span class="hljs-type">JButton</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JButton</span>(<span class="hljs-string">"计算最大公约数"</span>);
        button.addActionListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionListener</span>() {
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">GCDCalculator</span> <span class="hljs-variable">calculator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GCDCalculator</span>();

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">actionPerformed</span><span class="hljs-params">(ActionEvent e)</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">rawA</span> <span class="hljs-operator">=</span> textField1.getText();
                <span class="hljs-type">String</span> <span class="hljs-variable">rawB</span> <span class="hljs-operator">=</span> textField2.getText();
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">var</span> <span class="hljs-variable">calculationDetails</span> <span class="hljs-operator">=</span> calculator.calculateGCD(rawA, rawB);
                    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> buildText(calculationDetails);
                    textArea.setText(text);
                } <span class="hljs-keyword">catch</span> (NumberFormatException exception) {
                    textArea.setText(<span class="hljs-string">"Exception found "</span> + exception.getMessage());
                } <span class="hljs-keyword">catch</span> (IllegalArgumentException exception) {
                    textArea.setText(exception.getMessage());
                }
            }
        });
        frame.add(button, BorderLayout.SOUTH);
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildText</span><span class="hljs-params">(GCDCalculator.CalculationDetails calculationDetails)</span> {
        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> calculationDetails.a();
        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> calculationDetails.b();
        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">gcd</span> <span class="hljs-operator">=</span> calculationDetails.gcd();
        List&lt;GCDCalculator.CalculationDetails.Equation&gt; equations = calculationDetails.equationHolders();

        <span class="hljs-type">StringJoiner</span> <span class="hljs-variable">joiner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringJoiner</span>(System.lineSeparator());
        <span class="hljs-keyword">if</span> (equations.isEmpty()) { <span class="hljs-comment">// then b is 0 (so gcd(a, b) = a)</span>
            joiner.add(String.format(<span class="hljs-string">"%s = 0 × %s"</span>, b, a));
            joiner.add(String.format(<span class="hljs-string">"%s = 1 × %s"</span>, a, a));
            joiner.add(String.format(<span class="hljs-string">"所以 gcd(%s, %s) = %s"</span>, a, b, gcd));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">firstLine</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"通过使用欧几里得算法，可以计算出 gcd(%s, %s) = %s"</span>, a, b, gcd.toString());
            joiner.add(firstLine);
            joiner.add(<span class="hljs-string">"具体过程如下"</span>);
            joiner.add(<span class="hljs-string">""</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> equation : equations.reversed()) {
                joiner.add(equation.toString());
            }
            joiner.add(<span class="hljs-string">""</span>);
            joiner.add(<span class="hljs-string">"所以"</span>);
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isFirstLine</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> equation : equations.reversed()) {
                <span class="hljs-keyword">if</span> (isFirstLine) {
                    joiner.add(String.format(<span class="hljs-string">"gcd(%s, %s)"</span>, equation.a(), equation.b()));
                    isFirstLine = <span class="hljs-literal">false</span>;
                } <span class="hljs-keyword">else</span> {
                    joiner.add(String.format(<span class="hljs-string">"= gcd(%s, %s)"</span>, equation.a(), equation.b()));
                }
            }
            joiner.add(<span class="hljs-string">"= "</span> + gcd);
        }
        <span class="hljs-keyword">return</span> joiner.toString();
    }
}


<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleFrame</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JFrame</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleFrame</span><span class="hljs-params">(String title)</span> {
        setTitle(title);
        setSize(<span class="hljs-number">600</span>, <span class="hljs-number">400</span>);
    }
}


<span class="hljs-keyword">class</span> <span class="hljs-title class_">GCDCalculator</span> {

    <span class="hljs-keyword">record</span> <span class="hljs-title class_">CalculationDetails</span><span class="hljs-params">(
            BigInteger a,
            BigInteger b,
            BigInteger gcd,
            java.util.List&lt;Equation&gt; equationHolders
    )</span> {
        <span class="hljs-comment">/**
         * A holder class for equation a = q * b + r
         */</span>
        <span class="hljs-keyword">record</span> <span class="hljs-title class_">Equation</span><span class="hljs-params">(
                BigInteger a,
                BigInteger q,
                BigInteger b,
                BigInteger r
        )</span> {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s = %s × %s + %s"</span>, a, q, b, r);
            }
        }
    }

    <span class="hljs-keyword">private</span> BigInteger <span class="hljs-title function_">toBigInteger</span><span class="hljs-params">(String num)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(num.trim());
    }

    <span class="hljs-keyword">public</span> CalculationDetails <span class="hljs-title function_">calculateGCD</span><span class="hljs-params">(String a, String b)</span> {
        <span class="hljs-keyword">return</span> calculateGCD(toBigInteger(a), toBigInteger(b));
    }

    <span class="hljs-keyword">public</span> CalculationDetails <span class="hljs-title function_">calculateGCD</span><span class="hljs-params">(BigInteger a, BigInteger b)</span> {
        a = a.abs();
        b = b.abs();

        BigInteger biggerOne;
        BigInteger smallerOne;
        <span class="hljs-keyword">if</span> (a.compareTo(b) &gt;= <span class="hljs-number">0</span>) {
            biggerOne = a;
            smallerOne = b;
        } <span class="hljs-keyword">else</span> {
            biggerOne = b;
            smallerOne = a;
        }

        <span class="hljs-keyword">if</span> (biggerOne.equals(BigInteger.ZERO)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"两个整数不能都是0！"</span>);
        }
        <span class="hljs-type">var</span> <span class="hljs-variable">equations</span> <span class="hljs-operator">=</span> doCalculateGCD(biggerOne, smallerOne);
        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">gcd</span> <span class="hljs-operator">=</span> smallerOne.equals(BigInteger.ZERO) ? biggerOne : equations.getFirst().b;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalculationDetails</span>(biggerOne, smallerOne, gcd, equations);
    }

    <span class="hljs-keyword">private</span> java.util.List&lt;CalculationDetails.Equation&gt; doCalculateGCD(BigInteger a, BigInteger b) {
        <span class="hljs-keyword">if</span> (b.equals(BigInteger.ZERO)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        }

        <span class="hljs-type">var</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> doCalculateGCD(b, a.mod(b));
        result.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CalculationDetails</span>.Equation(a, a.divide(b), b, a.mod(b)));
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">GCDCalculator</span> <span class="hljs-variable">gcdCalculator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GCDCalculator</span>();
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"0"</span>, <span class="hljs-string">"1"</span>).gcd); <span class="hljs-comment">// should be 1</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"1"</span>, <span class="hljs-string">"0"</span>).gcd); <span class="hljs-comment">// should be 1</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"100"</span>, <span class="hljs-string">"20"</span>).gcd); <span class="hljs-comment">// should be 20</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"10"</span>, <span class="hljs-string">"12"</span>).gcd); <span class="hljs-comment">// should be 2</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"233"</span>, <span class="hljs-string">"144"</span>).gcd); <span class="hljs-comment">// should be 1</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"12345"</span>, <span class="hljs-string">"67890"</span>).gcd); <span class="hljs-comment">// should be 15</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"54321"</span>, <span class="hljs-string">"9876"</span>).gcd); <span class="hljs-comment">// should be 3</span>
        System.out.println(gcdCalculator.calculateGCD(<span class="hljs-string">"1160718174"</span>, <span class="hljs-string">"316258250"</span>).gcd); <span class="hljs-comment">// should be 1078</span>
    }
}
</code></pre>
<p>请将以上代码保存为 <code>DetailedGCDCalculator.java</code>。
用下方的命令可以编译 <code>DetailedGCDCalculator.java</code> 并运行其中的 <code>main</code> 函数。</p>
<pre><code class="hljs language-bash" lang="bash">javac DetailedGCDCalculator.java
java DetailedGCDCalculator
</code></pre>
<h4 data-id="heading-10">运行示例</h4>
<h5 data-id="heading-11">刚启动时</h5>
<p>刚启动时，还没有任何输入
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70dbdb5ddef48ae91232f50f0895bdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=Lo3%2FZgC0Mu159omB%2BoKBJqqFVLg%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-12">测试用例 <code>1</code>: 计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(1, 0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">)</span></span></span></span></span></h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4813103088504f6c85749819b001d775~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=PZ%2BfvVNrUDO78wmv8CNVACk2y7g%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-13">测试用例 <code>2</code>: 计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>31415</mn><mo separator="true">,</mo><mn>92653</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(31415, 92653)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">31415</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">92653</span><span class="mclose">)</span></span></span></span></span></h5>
<p>完整的计算步骤比较长，我将窗口放大后，截图如下 ⬇️</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4099ecac3ea45bf97dc081735d95604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=KeiZpSrUz2s8hNEnHI09SjPJPo0%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-14">测试用例 <code>3</code>: 计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>2584</mn><mo separator="true">,</mo><mn>1597</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(2584, 1597)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">2584</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1597</span><span class="mclose">)</span></span></span></span></span> （<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1597</mn></mrow><annotation encoding="application/x-tex">1597</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1597</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2584</mn></mrow><annotation encoding="application/x-tex">2584</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2584</span></span></span></span></span> 是 <code>Fibonacci</code> 数列中相邻的两项，而 <code>Fibonacci</code> 数列中相邻两项的最大公约数总是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>）</h5>
<p>完整的计算步骤比较长，我将窗口放大后，截图如下 ⬇️</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3f2d463c01c4fb0924a445e9bd9b919~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=TLZVqVFaCkJBcqPgiKSfyHtflww%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-15">测试用例 <code>4</code>: 计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>c</mi><mi>d</mi><mo stretchy="false">(</mo><mn>210</mn><mo separator="true">,</mo><mn>135</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">gcd(210, 135)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">c</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord">210</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">135</span><span class="mclose">)</span></span></span></span></span></h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b99a86737e458a96ba53ac375f2d70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763529223&amp;x-signature=YqwGwhz%2F%2FjU8o3pEhLIvsMR1Qkk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">参考资料</h3>
<ul>
<li><a href="https://juejin.cn/post/7569876592920854543" target="_blank" title="https://juejin.cn/post/7569876592920854543">[Java] 用 Swing 生成一个最大公约数计算器</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 正则表达式：REGEXP 和 RLIKE 操作符详解]]></title>    <link>https://juejin.cn/post/7571402480966828068</link>    <guid>https://juejin.cn/post/7571402480966828068</guid>    <pubDate>2025-11-12T05:46:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571402480966828068" data-draft-id="7571378103282548742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 正则表达式：REGEXP 和 RLIKE 操作符详解"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-11-12T05:46:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 正则表达式：REGEXP 和 RLIKE 操作符详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:46:21.000Z" title="Wed Nov 12 2025 05:46:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、MySQL 正则表达式概述</h3>
<p>在[数据库查询]中，我们经常需要进行复杂的模式匹配。虽然 MySQL 提供了 LIKE 操作符进行简单的模糊匹配（使用 <code>%</code> 和 <code>_</code>），但对于更复杂的[模式匹配]需求，正则表达式是更强大的工具。</p>
<p>MySQL 通过 <code>REGEXP</code> 和 <code>RLIKE</code> [操作符]支持正则表达式匹配，其语法与 Perl 兼容的正则表达式（PCRE）类似，为开发者提供了强大的模式匹配能力。</p>
<p>MySQL 模式匹配</p>
<p>简单模式匹配 LIKE</p>
<p>正则表达式匹配</p>
<p>REGEXP</p>
<p>RLIKE</p>
<p>正则表达式模式</p>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、REGEXP/RLIKE 基础语法</h3>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1 基本语法结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> column1, column2, ...
<span class="hljs-keyword">FROM</span> table_name
<span class="hljs-keyword">WHERE</span> column_name REGEXP <span class="hljs-string">'pattern'</span>;

<span class="hljs-comment">-- 或者使用 RLIKE（两者完全等效）</span>
<span class="hljs-keyword">SELECT</span> column1, column2, ...
<span class="hljs-keyword">FROM</span> table_name
<span class="hljs-keyword">WHERE</span> column_name RLIKE <span class="hljs-string">'pattern'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">12345678</span>
</code></pre>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2 简单示例</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找 name 字段中以 'st' 开头的所有数据</span>
<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> person_tbl <span class="hljs-keyword">WHERE</span> name REGEXP <span class="hljs-string">'^st'</span>;

<span class="hljs-comment">-- 查找 name 字段中以 'ok' 结尾的所有数据</span>
<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> person_tbl <span class="hljs-keyword">WHERE</span> name REGEXP <span class="hljs-string">'ok$'</span>;

<span class="hljs-comment">-- 查找 name 字段中包含 'mar' 字符串的所有数据</span>
<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> person_tbl <span class="hljs-keyword">WHERE</span> name REGEXP <span class="hljs-string">'mar'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">12345678</span>
</code></pre>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、正则表达式模式详解</h3>
<p>MySQL 支持丰富的正则表达式元字符和模式，以下是完整的参考表：</p>





























































<table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td><code>^</code></td><td>匹配输入字符串的开始位置</td></tr><tr><td><code>$</code></td><td>匹配输入字符串的结束位置</td></tr><tr><td><code>.</code></td><td>匹配除 “\n” 之外的任何单个字符</td></tr><tr><td><code>[...]</code></td><td>字符集合，匹配所包含的任意一个字符</td></tr><tr><td><code>[^...]</code></td><td>负值字符集合，匹配未包含的任意字符</td></tr><tr><td>p1 / p2 / p3</td><td>匹配 p1 或 p2 或 p3</td></tr><tr><td><code>*</code></td><td>匹配前面的子表达式零次或多次</td></tr><tr><td><code>+</code></td><td>匹配前面的子表达式一次或多次</td></tr><tr><td><code>{n}</code></td><td>匹配确定的 n 次</td></tr><tr><td><code>{n,m}</code></td><td>最少匹配 n 次且最多匹配 m 次</td></tr><tr><td><code>\w</code></td><td>匹配字母、数字或下划线字符</td></tr><tr><td><code>\s</code></td><td>匹配任何空白字符，包括空格、制表符、换页符等</td></tr><tr><td><code>\d</code></td><td>匹配一个数字字符，等价于 [0-9]</td></tr></tbody></table>
<p>是</p>
<p>否</p>
<p>是</p>
<p>否</p>
<p>开始匹配</p>
<p>是否^开头?</p>
<p>从字符串开头检查</p>
<p>从任意位置检查</p>
<p>检查模式</p>
<p>是否$结尾?</p>
<p>检查到字符串末尾</p>
<p>检查子字符串</p>
<p>匹配成功</p>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、高级正则表达式技巧</h3>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 字符类匹配</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 匹配元音字母开头的名字</span>
<span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name REGEXP <span class="hljs-string">'^[aeiou]'</span>;

<span class="hljs-comment">-- 匹配非数字开头的产品编号</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_code REGEXP <span class="hljs-string">'^[^0-9]'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">12345</span>
</code></pre>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 量词使用</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 匹配连续2-3个数字</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> data <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">value</span> REGEXP <span class="hljs-string">'[0-9]{2,3}'</span>;

<span class="hljs-comment">-- 匹配"a"出现至少2次</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> words <span class="hljs-keyword">WHERE</span> word REGEXP <span class="hljs-string">'a{2,}'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">12345</span>
</code></pre>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3 或操作和分组</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 匹配<span class="hljs-string">"Smith"</span>或<span class="hljs-string">"Johnson"</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> last_name REGEXP <span class="hljs-comment">'Smith|Johnson';</span>

-- 匹配<span class="hljs-string">"color"</span>或<span class="hljs-string">"colour"</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">text</span> REGEXP <span class="hljs-comment">'col(o|ou)r';</span>

AI写代码sql
<span class="hljs-number">12345</span>
</code></pre>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、实际应用案例</h3>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.1 数据验证</h4>
<pre><code class="hljs language-ini" lang="ini">-- 验证电子邮件格式
SELECT email FROM users 
WHERE email REGEXP '^<span class="hljs-section">[A-Za-z0-9._%-]</span>+@<span class="hljs-section">[A-Za-z0-9.-]</span>+\.<span class="hljs-section">[A-Za-z]</span>{2,4}$'<span class="hljs-comment">;</span>

-- 验证电话号码格式
SELECT phone FROM contacts 
WHERE phone REGEXP '^\+?<span class="hljs-section">[0-9]</span>{1,3}?<span class="hljs-section">[-. ]</span>?<span class="hljs-section">[0-9]</span>{2,3}<span class="hljs-section">[-. ]</span>?<span class="hljs-section">[0-9]</span>{3,4}<span class="hljs-section">[-. ]</span>?<span class="hljs-section">[0-9]</span>{3,4}$'<span class="hljs-comment">;</span>

AI写代码sql
1234567
</code></pre>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.2 数据提取</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 提取包含价格的数据</span>
<span class="hljs-keyword">SELECT</span> description <span class="hljs-keyword">FROM</span> products 
<span class="hljs-keyword">WHERE</span> description REGEXP <span class="hljs-string">'[0-9]+\.[0-9]{2}'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">123</span>
</code></pre>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.3 数据清洗</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找包含多余空格的数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> documents 
<span class="hljs-keyword">WHERE</span> content REGEXP <span class="hljs-string">'[[:space:]]{2,}'</span>;

<span class="hljs-comment">-- 查找非ASCII字符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> international_data 
<span class="hljs-keyword">WHERE</span> text REGEXP <span class="hljs-string">'[^\x00-\x7F]'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">1234567</span>
</code></pre>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>六、性能优化建议</h3>
<p>虽然正则表达式功能强大，但在大数据集上使用时可能会影响性能：</p>
<ol>
<li><strong>避免前导通配符</strong>：如 <code>.*pattern</code>，这会导致全表扫描</li>
<li><strong>尽量具体</strong>：越具体的模式通常执行越快</li>
<li><strong>考虑使用索引</strong>：正则表达式通常无法利用索引，对于关键查询考虑其他方案</li>
<li><strong>测试不同模式</strong>：复杂模式可能需要更多测试</li>
</ol>
<p>是</p>
<p>否</p>
<p>是</p>
<p>否</p>
<p>查询需求</p>
<p>简单模式?</p>
<p>使用LIKE</p>
<p>使用REGEXP</p>
<p>性能可接受?</p>
<p>实施</p>
<p>考虑其他方案</p>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>七、REGEXP 与 LIKE 的比较</h3>








































<table><thead><tr><th>特性</th><th>REGEXP/RLIKE</th><th>LIKE</th></tr></thead><tbody><tr><td>匹配能力</td><td>强大，支持复杂模式</td><td>有限，仅支持简单通配符</td></tr><tr><td>语法</td><td>使用正则表达式语法</td><td>使用 % 和 _ 通配符</td></tr><tr><td>性能</td><td>通常较慢</td><td>通常较快</td></tr><tr><td>索引使用</td><td>通常不能使用索引</td><td>某些情况下可以使用索引</td></tr><tr><td>大小写敏感</td><td>取决于排序规则</td><td>取决于排序规则</td></tr><tr><td>复杂模式</td><td>支持 (如范围、重复、选择等)</td><td>不支持</td></tr></tbody></table>
<h3 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>八、常见问题解答</h3>
<p><strong>Q: REGEXP 和 RLIKE 有什么区别？</strong></p>
<p>A: 在 MySQL 中，<code>REGEXP</code> 和 <code>RLIKE</code> 是完全相同的操作符，可以互换使用。</p>
<p><strong>Q: 如何使正则表达式匹配区分大小写？</strong></p>
<p>A: 使用 <code>BINARY</code> 关键字：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_name REGEXP <span class="hljs-type">BINARY</span> <span class="hljs-string">'Apple'</span>;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">1</span>
</code></pre>
<p><strong>Q: 正则表达式会影响查询性能吗？</strong></p>
<p>A: 是的，复杂的正则表达式在大表上可能显著降低查询速度，应谨慎使用。</p>
<p><strong>Q: 可以在索引列上使用 REGEXP 吗？</strong></p>
<p>A: 可以，但正则表达式匹配通常会使索引失效，导致全表扫描。</p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>九、总结</h3>
<p>MySQL 的正则表达式功能通过 <code>REGEXP</code> 和 <code>RLIKE</code> 操作符提供，为数据查询提供了强大的模式匹配能力。掌握这些技术可以让你：</p>
<ol>
<li>执行复杂的字符串匹配和搜索</li>
<li>验证数据格式和质量</li>
<li>提取特定模式的文本</li>
<li>进行高级数据清洗和转换</li>
</ol>
<p>虽然功能强大，但应当注意合理使用，避免在大型表上频繁使用复杂正则表达式影响性能。对于简单的模式匹配，优先考虑使用 <code>LIKE</code> 操作符。</p>
<p>通过本文的学习，你应该能够熟练地在 MySQL 中使用正则表达式来解决各种字符串匹配问题，提升数据查询和处理的灵活性和效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手带你阅读vue2源码]]></title>    <link>https://juejin.cn/post/7571378103282073606</link>    <guid>https://juejin.cn/post/7571378103282073606</guid>    <pubDate>2025-11-12T03:40:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103282073606" data-draft-id="7571348736154468388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手带你阅读vue2源码"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T03:40:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="彩虹下面"/> <meta itemprop="url" content="https://juejin.cn/user/2392146486762894"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手带你阅读vue2源码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392146486762894/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    彩虹下面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:40:07.000Z" title="Wed Nov 12 2025 03:40:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手带你阅读Vue2源码</h2>
<h3 data-id="heading-1">前言</h3>
<p>Vue.js 作为目前最流行的前端框架之一，其源码设计精妙，架构清晰。通过阅读Vue2的源码，我们不仅能深入理解其工作原理，还能学习到很多优秀的设计模式和编程思想。本文将带你从零开始，深入Vue2的核心源码，理解其实现原理。</p>
<h3 data-id="heading-2">Vue2源码结构</h3>
<p>首先，让我们了解一下Vue2的源码目录结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">src/
├── core/                    <span class="hljs-meta"># 核心代码</span>
│   ├── instance/           <span class="hljs-meta"># Vue实例相关</span>
│   │   ├── index.ts        <span class="hljs-meta"># Vue构造函数</span>
│   │   ├── <span class="hljs-keyword">init</span>.ts         <span class="hljs-meta"># 实例初始化</span>
│   │   ├── state.ts        <span class="hljs-meta"># 状态管理（data、props、computed等）</span>
│   │   ├── render.ts       <span class="hljs-meta"># 渲染相关</span>
│   │   ├── lifecycle.ts    <span class="hljs-meta"># 生命周期</span>
│   │   └── ...
│   ├── observer/           <span class="hljs-meta"># 响应式系统</span>
│   │   ├── index.ts        <span class="hljs-meta"># Observer类</span>
│   │   ├── dep.ts          <span class="hljs-meta"># 依赖收集</span>
│   │   ├── watcher.ts      <span class="hljs-meta"># 观察者</span>
│   │   ├── scheduler.ts    <span class="hljs-meta"># 调度器</span>
│   │   └── array.ts        <span class="hljs-meta"># 数组响应式处理</span>
│   ├── vdom/               <span class="hljs-meta"># 虚拟DOM</span>
│   └── util/               <span class="hljs-meta"># 工具函数</span>
├── compiler/               <span class="hljs-meta"># 模板编译</span>
└── platforms/              <span class="hljs-meta"># 平台相关代码</span>
</code></pre>
<h3 data-id="heading-3">一、Vue构造函数与实例初始化</h3>
<h4 data-id="heading-4">1.1 Vue构造函数</h4>
<p>Vue的入口在 <code>src/core/instance/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Vue</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">if</span> (__DEV__ &amp;&amp; !(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Vue</span>)) {
    <span class="hljs-title function_">warn</span>(<span class="hljs-string">'Vue is a constructor and should be called with the `new` keyword'</span>)
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_init</span>(options)
}

<span class="hljs-comment">// 通过Mixin模式扩展Vue原型</span>
<span class="hljs-title function_">initMixin</span>(<span class="hljs-title class_">Vue</span>)      <span class="hljs-comment">// 初始化相关</span>
<span class="hljs-title function_">stateMixin</span>(<span class="hljs-title class_">Vue</span>)     <span class="hljs-comment">// 状态相关</span>
<span class="hljs-title function_">eventsMixin</span>(<span class="hljs-title class_">Vue</span>)    <span class="hljs-comment">// 事件相关</span>
<span class="hljs-title function_">lifecycleMixin</span>(<span class="hljs-title class_">Vue</span>) <span class="hljs-comment">// 生命周期相关</span>
<span class="hljs-title function_">renderMixin</span>(<span class="hljs-title class_">Vue</span>)    <span class="hljs-comment">// 渲染相关</span>
</code></pre>
<p>Vue采用了<strong>Mixin模式</strong>来组织代码，将不同功能的代码分别通过不同的Mixin注入到Vue原型上，这样既保持了代码的模块化，又避免了单一文件过大。</p>
<h4 data-id="heading-5">1.2 实例初始化流程</h4>
<p>当执行 <code>new Vue(options)</code> 时，会调用 <code>_init</code> 方法，定义在 <code>src/core/instance/init.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_init</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">options?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span> = <span class="hljs-variable language_">this</span>
  
  <span class="hljs-comment">// 1. 唯一标识</span>
  vm.<span class="hljs-property">_uid</span> = uid++
  
  <span class="hljs-comment">// 2. 标记为Vue实例</span>
  vm.<span class="hljs-property">_isVue</span> = <span class="hljs-literal">true</span>
  
  <span class="hljs-comment">// 3. 合并选项</span>
  vm.<span class="hljs-property">$options</span> = <span class="hljs-title function_">mergeOptions</span>(
    <span class="hljs-title function_">resolveConstructorOptions</span>(vm.<span class="hljs-property">constructor</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>),
    options || {},
    vm
  )
  
  <span class="hljs-comment">// 4. 初始化代理（开发环境）</span>
  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-title function_">initProxy</span>(vm)
  } <span class="hljs-keyword">else</span> {
    vm.<span class="hljs-property">_renderProxy</span> = vm
  }
  
  <span class="hljs-comment">// 5. 初始化生命周期</span>
  <span class="hljs-title function_">initLifecycle</span>(vm)
  
  <span class="hljs-comment">// 6. 初始化事件</span>
  <span class="hljs-title function_">initEvents</span>(vm)
  
  <span class="hljs-comment">// 7. 初始化渲染</span>
  <span class="hljs-title function_">initRender</span>(vm)
  
  <span class="hljs-comment">// 8. 调用beforeCreate钩子</span>
  <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'beforeCreate'</span>)
  
  <span class="hljs-comment">// 9. 初始化injections</span>
  <span class="hljs-title function_">initInjections</span>(vm)
  
  <span class="hljs-comment">// 10. 初始化状态（data、props、methods、computed、watch）</span>
  <span class="hljs-title function_">initState</span>(vm)
  
  <span class="hljs-comment">// 11. 初始化provide</span>
  <span class="hljs-title function_">initProvide</span>(vm)
  
  <span class="hljs-comment">// 12. 调用created钩子</span>
  <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'created'</span>)
  
  <span class="hljs-comment">// 13. 如果有el选项，自动挂载</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>) {
    vm.$mount(vm.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>)
  }
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>初始化顺序很重要：<code>beforeCreate</code> → <code>injections</code> → <code>state</code> → <code>provide</code> → <code>created</code></li>
<li>这样设计是为了确保在 <code>created</code> 钩子中能够访问到 <code>data</code>、<code>props</code> 等状态</li>
<li><code>injections</code> 在 <code>state</code> 之前初始化，<code>provide</code> 在 <code>state</code> 之后初始化，符合依赖注入的设计</li>
</ul>
<h3 data-id="heading-6">二、响应式系统核心原理</h3>
<p>Vue2的响应式系统是其核心特性，基于 <code>Object.defineProperty</code> 实现。主要包含三个核心类：<code>Observer</code>、<code>Dep</code>、<code>Watcher</code>。</p>
<h4 data-id="heading-7">2.1 Observer（观察者）</h4>
<p><code>Observer</code> 类负责将普通对象转换为响应式对象，定义在 <code>src/core/observer/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-attr">dep</span>: <span class="hljs-title class_">Dep</span>
  <span class="hljs-attr">vmCount</span>: <span class="hljs-built_in">number</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> value: <span class="hljs-built_in">any</span>, <span class="hljs-keyword">public</span> shallow = <span class="hljs-literal">false</span>, <span class="hljs-keyword">public</span> mock = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = mock ? mockDep : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vmCount</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 在对象上添加 __ob__ 属性，指向Observer实例</span>
    <span class="hljs-title function_">def</span>(value, <span class="hljs-string">'__ob__'</span>, <span class="hljs-variable language_">this</span>)
    
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArray</span>(value)) {
      <span class="hljs-comment">// 数组：重写数组方法</span>
      <span class="hljs-keyword">if</span> (hasProto) {
        value.<span class="hljs-property">__proto__</span> = arrayMethods
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, l = arrayKeys.<span class="hljs-property">length</span>; i &lt; l; i++) {
          <span class="hljs-title function_">def</span>(value, arrayKeys[i], arrayMethods[arrayKeys[i]])
        }
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(value)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 对象：遍历属性，转换为getter/setter</span>
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(value)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-title function_">defineReactive</span>(value, keys[i], <span class="hljs-variable constant_">NO_INITIAL_VALUE</span>, <span class="hljs-literal">undefined</span>, shallow, mock)
      }
    }
  }
}
</code></pre>
<p><strong>核心机制：</strong></p>
<ul>
<li>为对象添加 <code>__ob__</code> 属性，存储Observer实例</li>
<li>数组通过重写原型方法实现响应式</li>
<li>对象通过 <code>defineReactive</code> 将属性转换为getter/setter</li>
</ul>
<h4 data-id="heading-8">2.2 defineReactive（定义响应式属性）</h4>
<p><code>defineReactive</code> 是响应式系统的核心函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">
  obj: <span class="hljs-built_in">object</span>,
  key: <span class="hljs-built_in">string</span>,
  val?: <span class="hljs-built_in">any</span>,
  customSetter?: <span class="hljs-built_in">Function</span> | <span class="hljs-literal">null</span>,
  shallow?: <span class="hljs-built_in">boolean</span>,
  mock?: <span class="hljs-built_in">boolean</span>
</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>() <span class="hljs-comment">// 每个属性都有独立的Dep实例</span>

  <span class="hljs-keyword">const</span> property = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(obj, key)
  <span class="hljs-keyword">if</span> (property &amp;&amp; property.<span class="hljs-property">configurable</span> === <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> getter = property &amp;&amp; property.<span class="hljs-property">get</span>
  <span class="hljs-keyword">const</span> setter = property &amp;&amp; property.<span class="hljs-property">set</span>

  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> value = getter ? getter.<span class="hljs-title function_">call</span>(obj) : val
      
      <span class="hljs-comment">// 依赖收集：如果当前有Watcher，将其添加到Dep中</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
        dep.<span class="hljs-title function_">depend</span>()
        <span class="hljs-keyword">if</span> (childOb) {
          childOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArray</span>(value)) {
            <span class="hljs-title function_">dependArray</span>(value)
          }
        }
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newVal</span>) {
      <span class="hljs-keyword">const</span> value = getter ? getter.<span class="hljs-title function_">call</span>(obj) : val
      
      <span class="hljs-comment">// 值没有变化，直接返回</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">hasChanged</span>(value, newVal)) {
        <span class="hljs-keyword">return</span>
      }
      
      <span class="hljs-keyword">if</span> (setter) {
        setter.<span class="hljs-title function_">call</span>(obj, newVal)
      } <span class="hljs-keyword">else</span> {
        val = newVal
      }
      
      <span class="hljs-comment">// 新值也需要变成响应式</span>
      childOb = <span class="hljs-title function_">observe</span>(newVal, <span class="hljs-literal">false</span>, mock)
      
      <span class="hljs-comment">// 通知所有依赖更新</span>
      dep.<span class="hljs-title function_">notify</span>()
    }
  })
}
</code></pre>
<p><strong>工作流程：</strong></p>
<ol>
<li><strong>getter</strong>：当访问属性时，如果当前有 <code>Dep.target</code>（Watcher），调用 <code>dep.depend()</code> 收集依赖</li>
<li><strong>setter</strong>：当修改属性时，调用 <code>dep.notify()</code> 通知所有依赖更新</li>
</ol>
<h4 data-id="heading-9">2.3 Dep（依赖收集器）</h4>
<p><code>Dep</code> 类负责管理依赖，定义在 <code>src/core/observer/dep.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-keyword">static</span> target?: <span class="hljs-title class_">DepTarget</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">subs</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">DepTarget</span> | <span class="hljs-literal">null</span>&gt;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = uid++
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-comment">// 添加订阅者</span>
  <span class="hljs-title function_">addSub</span>(<span class="hljs-params">sub: DepTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(sub)
  }

  <span class="hljs-comment">// 移除订阅者</span>
  <span class="hljs-title function_">removeSub</span>(<span class="hljs-params">sub: DepTarget</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">indexOf</span>(sub)] = <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">// 依赖收集：将当前Watcher添加到subs中</span>
  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>.<span class="hljs-title function_">addDep</span>(<span class="hljs-variable language_">this</span>)
    }
  }

  <span class="hljs-comment">// 通知所有订阅者更新</span>
  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> subs = <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DepTarget</span>[]
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, l = subs.<span class="hljs-property">length</span>; i &lt; l; i++) {
      subs[i].<span class="hljs-title function_">update</span>()
    }
  }
}

<span class="hljs-comment">// 全局唯一的当前Watcher</span>
<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">targetStack</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">DepTarget</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>&gt; = []

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">pushTarget</span>(<span class="hljs-params">target?: DepTarget | <span class="hljs-literal">null</span></span>) {
  targetStack.<span class="hljs-title function_">push</span>(target)
  <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = target
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">popTarget</span>(<span class="hljs-params"/>) {
  targetStack.<span class="hljs-title function_">pop</span>()
  <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = targetStack[targetStack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
}
</code></pre>
<p><strong>设计亮点：</strong></p>
<ul>
<li><code>Dep.target</code> 是全局唯一的，同一时间只能有一个Watcher在收集依赖</li>
<li>使用栈结构 <code>targetStack</code> 处理嵌套Watcher的情况</li>
</ul>
<h4 data-id="heading-10">2.4 Watcher（观察者）</h4>
<p><code>Watcher</code> 是连接响应式数据和视图更新的桥梁，定义在 <code>src/core/observer/watcher.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DepTarget</span> {
  vm?: <span class="hljs-title class_">Component</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">expression</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">cb</span>: <span class="hljs-title class_">Function</span>
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">deps</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Dep</span>&gt;
  <span class="hljs-attr">newDeps</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Dep</span>&gt;
  <span class="hljs-attr">getter</span>: <span class="hljs-title class_">Function</span>
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    vm: Component | <span class="hljs-literal">null</span>,
    expOrFn: <span class="hljs-built_in">string</span> | (() =&gt; <span class="hljs-built_in">any</span>),
    cb: <span class="hljs-built_in">Function</span>,
    options?: WatcherOptions | <span class="hljs-literal">null</span>,
    isRenderWatcher?: <span class="hljs-built_in">boolean</span>
  </span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-keyword">if</span> (isRenderWatcher) {
      vm.<span class="hljs-property">_watcher</span> = <span class="hljs-variable language_">this</span>
    }
    
    <span class="hljs-comment">// 将表达式转换为getter函数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isFunction</span>(expOrFn)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">getter</span> = expOrFn
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">getter</span> = <span class="hljs-title function_">parsePath</span>(expOrFn)
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span> ? <span class="hljs-literal">undefined</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
  }

  <span class="hljs-comment">// 获取值，触发依赖收集</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">pushTarget</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-comment">// 设置当前Watcher为Dep.target</span>
    <span class="hljs-keyword">let</span> value
    <span class="hljs-keyword">const</span> vm = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>
    <span class="hljs-keyword">try</span> {
      value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">getter</span>.<span class="hljs-title function_">call</span>(vm, vm) <span class="hljs-comment">// 执行getter，触发属性的get</span>
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-title function_">handleError</span>(e, vm, <span class="hljs-string">`getter for watcher "<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.expression}</span>"`</span>)
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">deep</span>) {
        <span class="hljs-title function_">traverse</span>(value) <span class="hljs-comment">// 深度遍历，收集所有嵌套属性的依赖</span>
      }
      <span class="hljs-title function_">popTarget</span>() <span class="hljs-comment">// 恢复之前的Watcher</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupDeps</span>() <span class="hljs-comment">// 清理不再需要的依赖</span>
    }
    <span class="hljs-keyword">return</span> value
  }

  <span class="hljs-comment">// 依赖更新时调用</span>
  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sync</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>() <span class="hljs-comment">// 同步执行</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">queueWatcher</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-comment">// 异步执行，加入队列</span>
    }
  }

  <span class="hljs-comment">// 执行回调</span>
  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span>) {
      <span class="hljs-keyword">const</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
      <span class="hljs-keyword">if</span> (
        value !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> ||
        <span class="hljs-title function_">isObject</span>(value) ||
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">deep</span>
      ) {
        <span class="hljs-keyword">const</span> oldValue = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>, value, oldValue)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>, value, oldValue)
        }
      }
    }
  }
}
</code></pre>
<p><strong>Watcher类型：</strong></p>
<ul>
<li><strong>Render Watcher</strong>：每个组件实例都有一个，用于更新视图</li>
<li><strong>User Watcher</strong>：用户通过 <code>$watch</code> 或 <code>watch</code> 选项创建的</li>
<li><strong>Computed Watcher</strong>：计算属性的Watcher，具有 <code>lazy</code> 特性</li>
</ul>
<h4 data-id="heading-11">2.5 响应式系统流程图</h4>
<pre><code class="hljs language-scss" lang="scss">访问属性 (getter)
    ↓
Dep<span class="hljs-selector-class">.target</span> 存在？
    ↓ 是
dep<span class="hljs-selector-class">.depend</span>() → watcher<span class="hljs-selector-class">.addDep</span>(dep) → dep<span class="hljs-selector-class">.addSub</span>(watcher)
    ↓
依赖收集完成

修改属性 (setter)
    ↓
dep<span class="hljs-selector-class">.notify</span>()
    ↓
遍历 subs，调用 watcher<span class="hljs-selector-class">.update</span>()
    ↓
<span class="hljs-built_in">queueWatcher</span>(watcher)
    ↓
<span class="hljs-built_in">nextTick</span>(flushSchedulerQueue)
    ↓
watcher<span class="hljs-selector-class">.run</span>() → watcher<span class="hljs-selector-class">.get</span>() → 重新渲染/执行回调
</code></pre>
<h3 data-id="heading-12">三、渲染系统</h3>
<h4 data-id="heading-13">3.1 render函数</h4>
<p>每个Vue组件都有一个render函数，定义在 <code>src/core/instance/render.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_render</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>): <span class="hljs-title class_">VNode</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span> = <span class="hljs-variable language_">this</span>
  <span class="hljs-keyword">const</span> { render, _parentVnode } = vm.<span class="hljs-property">$options</span>

  <span class="hljs-comment">// 设置父vnode</span>
  vm.<span class="hljs-property">$vnode</span> = _parentVnode
  
  <span class="hljs-comment">// 执行render函数，生成vnode</span>
  <span class="hljs-keyword">let</span> vnode
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setCurrentInstance</span>(vm)
    currentRenderingInstance = vm
    vnode = render.<span class="hljs-title function_">call</span>(vm.<span class="hljs-property">_renderProxy</span>, vm.<span class="hljs-property">$createElement</span>)
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-built_in">any</span>) {
    <span class="hljs-title function_">handleError</span>(e, vm, <span class="hljs-string">`render`</span>)
    vnode = vm.<span class="hljs-property">_vnode</span>
  } <span class="hljs-keyword">finally</span> {
    currentRenderingInstance = prevRenderInst
    <span class="hljs-title function_">setCurrentInstance</span>(prevInst)
  }
  
  <span class="hljs-comment">// 确保返回单个根节点</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArray</span>(vnode) &amp;&amp; vnode.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
    vnode = vnode[<span class="hljs-number">0</span>]
  }
  
  <span class="hljs-keyword">if</span> (!(vnode <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">VNode</span>)) {
    vnode = <span class="hljs-title function_">createEmptyVNode</span>()
  }
  
  vnode.<span class="hljs-property">parent</span> = _parentVnode
  <span class="hljs-keyword">return</span> vnode
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>render</code> 函数接收 <code>createElement</code> 作为参数</li>
<li><code>vm._renderProxy</code> 在开发环境下是Proxy，用于警告未定义的属性</li>
<li>render函数执行时会访问响应式数据，触发依赖收集</li>
</ul>
<h4 data-id="heading-14">3.2 渲染Watcher</h4>
<p>在组件挂载时，会创建一个Render Watcher：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mountComponent</span>(<span class="hljs-params">
  vm: Component,
  el: Element | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>,
  hydrating?: <span class="hljs-built_in">boolean</span>
</span>): <span class="hljs-title class_">Component</span> {
  <span class="hljs-comment">// ...</span>
  
  <span class="hljs-keyword">let</span> <span class="hljs-title function_">updateComponent</span> = (<span class="hljs-params"/>) =&gt; {
    vm.<span class="hljs-title function_">_update</span>(vm.<span class="hljs-title function_">_render</span>(), hydrating)
  }

  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(
    vm,
    updateComponent,
    noop,
    {
      <span class="hljs-title function_">before</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">_isMounted</span> &amp;&amp; !vm.<span class="hljs-property">_isDestroyed</span>) {
          <span class="hljs-title function_">callHook</span>(vm, <span class="hljs-string">'beforeUpdate'</span>)
        }
      }
    },
    <span class="hljs-literal">true</span> <span class="hljs-comment">/* isRenderWatcher */</span>
  )
  
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>当响应式数据变化时：</p>
<ol>
<li>触发属性的setter</li>
<li>调用 <code>dep.notify()</code></li>
<li>Render Watcher的 <code>update()</code> 被调用</li>
<li>加入更新队列，在 <code>nextTick</code> 中执行</li>
<li>执行 <code>updateComponent</code>，重新渲染</li>
</ol>
<h3 data-id="heading-15">四、调度器（Scheduler）</h3>
<p>Vue使用调度器来批量处理更新，避免频繁的DOM操作，定义在 <code>src/core/observer/scheduler.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Watcher</span>&gt; = []
<span class="hljs-keyword">let</span> <span class="hljs-attr">has</span>: { [<span class="hljs-attr">key</span>: <span class="hljs-built_in">number</span>]: <span class="hljs-literal">true</span> | <span class="hljs-literal">undefined</span> | <span class="hljs-literal">null</span> } = {}
<span class="hljs-keyword">let</span> waiting = <span class="hljs-literal">false</span>
<span class="hljs-keyword">let</span> flushing = <span class="hljs-literal">false</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queueWatcher</span>(<span class="hljs-params">watcher: Watcher</span>) {
  <span class="hljs-keyword">const</span> id = watcher.<span class="hljs-property">id</span>
  
  <span class="hljs-comment">// 去重：同一个Watcher只添加一次</span>
  <span class="hljs-keyword">if</span> (has[id] != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span>
  }
  
  has[id] = <span class="hljs-literal">true</span>
  
  <span class="hljs-keyword">if</span> (!flushing) {
    queue.<span class="hljs-title function_">push</span>(watcher)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 如果正在刷新，按id插入到正确位置</span>
    <span class="hljs-keyword">let</span> i = queue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (i &gt; index &amp;&amp; queue[i].<span class="hljs-property">id</span> &gt; watcher.<span class="hljs-property">id</span>) {
      i--
    }
    queue.<span class="hljs-title function_">splice</span>(i + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, watcher)
  }
  
  <span class="hljs-comment">// 确保只调用一次nextTick</span>
  <span class="hljs-keyword">if</span> (!waiting) {
    waiting = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">nextTick</span>(flushSchedulerQueue)
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushSchedulerQueue</span>(<span class="hljs-params"/>) {
  currentFlushTimestamp = <span class="hljs-title function_">getNow</span>()
  flushing = <span class="hljs-literal">true</span>
  
  <span class="hljs-comment">// 排序：确保父组件先于子组件更新</span>
  queue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>)
  
  <span class="hljs-keyword">for</span> (index = <span class="hljs-number">0</span>; index &lt; queue.<span class="hljs-property">length</span>; index++) {
    watcher = queue[index]
    <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">before</span>) {
      watcher.<span class="hljs-title function_">before</span>() <span class="hljs-comment">// 调用beforeUpdate钩子</span>
    }
    has[id] = <span class="hljs-literal">null</span>
    watcher.<span class="hljs-title function_">run</span>() <span class="hljs-comment">// 执行更新</span>
  }
  
  <span class="hljs-title function_">resetSchedulerState</span>()
  <span class="hljs-title function_">callUpdatedHooks</span>(updatedQueue)
}
</code></pre>
<p><strong>设计优势：</strong></p>
<ol>
<li><strong>批量更新</strong>：同一事件循环中的多次数据变化，只会触发一次更新</li>
<li><strong>去重</strong>：同一个Watcher不会重复添加</li>
<li><strong>排序</strong>：确保父组件先于子组件更新，避免不必要的子组件更新</li>
</ol>
<h3 data-id="heading-16">五、数组的响应式处理</h3>
<p>由于 <code>Object.defineProperty</code> 无法监听数组索引的变化，Vue2通过重写数组方法来实现响应式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/core/observer/array.ts</span>
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)

<span class="hljs-keyword">const</span> methodsToPatch = [
  <span class="hljs-string">'push'</span>,
  <span class="hljs-string">'pop'</span>,
  <span class="hljs-string">'shift'</span>,
  <span class="hljs-string">'unshift'</span>,
  <span class="hljs-string">'splice'</span>,
  <span class="hljs-string">'sort'</span>,
  <span class="hljs-string">'reverse'</span>
]

methodsToPatch.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">method</span>) {
  <span class="hljs-keyword">const</span> original = arrayProto[method]
  <span class="hljs-title function_">def</span>(arrayMethods, method, <span class="hljs-keyword">function</span> <span class="hljs-title function_">mutator</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> result = original.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    <span class="hljs-keyword">const</span> ob = <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>
    <span class="hljs-keyword">let</span> inserted
    <span class="hljs-keyword">switch</span> (method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'push'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'unshift'</span>:
        inserted = args
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'splice'</span>:
        inserted = args.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)
        <span class="hljs-keyword">break</span>
    }
    <span class="hljs-keyword">if</span> (inserted) ob.<span class="hljs-title function_">observeArray</span>(inserted)
    ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>() <span class="hljs-comment">// 通知更新</span>
    <span class="hljs-keyword">return</span> result
  })
})
</code></pre>
<p><strong>实现原理：</strong></p>
<ul>
<li>创建新对象继承 <code>Array.prototype</code></li>
<li>重写会改变数组的方法</li>
<li>在方法中调用 <code>ob.dep.notify()</code> 通知更新</li>
<li>对新添加的元素进行响应式处理</li>
</ul>
<h3 data-id="heading-17">六、总结</h3>
<p>通过阅读Vue2源码，我们可以学到：</p>
<ol>
<li><strong>Mixin模式</strong>：通过Mixin组织代码，保持模块化</li>
<li><strong>观察者模式</strong>：Observer、Dep、Watcher的经典实现</li>
<li><strong>依赖收集</strong>：通过getter/setter实现自动依赖收集</li>
<li><strong>批量更新</strong>：使用调度器优化性能</li>
<li><strong>数组处理</strong>：通过重写原型方法实现数组响应式</li>
</ol>
<p>Vue2的响应式系统虽然基于 <code>Object.defineProperty</code>，存在一些局限性（如无法监听新增属性、数组索引等），但其设计思想仍然值得学习。Vue3改用Proxy实现，解决了这些问题，但核心的依赖收集和更新机制仍然类似。</p>
<p>希望这篇文章能帮助你更好地理解Vue2的工作原理。如果你对某个部分有疑问，建议直接阅读源码，结合调试工具，会有更深入的理解。</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.vuejs.org%2F" target="_blank" title="https://v2.vuejs.org/" ref="nofollow noopener noreferrer">Vue2 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue" target="_blank" title="https://github.com/vuejs/vue" ref="nofollow noopener noreferrer">Vue2 源码仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fustbhuangyi.github.io%2Fvue-analysis%2F" target="_blank" title="https://ustbhuangyi.github.io/vue-analysis/" ref="nofollow noopener noreferrer">Vue技术揭秘</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue是怎么实现双向绑定的]]></title>    <link>https://juejin.cn/post/7571429745230561316</link>    <guid>https://juejin.cn/post/7571429745230561316</guid>    <pubDate>2025-11-12T05:46:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571429745230561316" data-draft-id="7571379089992450102" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue是怎么实现双向绑定的"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T05:46:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue是怎么实现双向绑定的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:46:28.000Z" title="Wed Nov 12 2025 05:46:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Vue 的 <strong>双向绑定（v-model）</strong> 核心是 <strong>“数据响应式 + 视图事件监听”的联动机制</strong>——本质是语法糖，底层通过「数据劫持」监听数据变化，同步更新视图；同时通过「事件监听」捕获视图操作（如输入框输入），反向同步更新数据，最终实现 ​<code>​数据 ↔ 视图​</code>​ 双向自动同步。</p>
<p>不同 Vue 版本的实现原理有差异，以下分 <strong>Vue 2.x</strong> 和 <strong>Vue 3.x</strong> 详细说明（面试高频考点）：</p>
<h3 data-id="heading-0">一、核心概念铺垫</h3>
<p>双向绑定的核心依赖 3 个核心模块，无论 Vue 2 还是 3 都离不开这个逻辑：</p>
<ol>
<li><strong>响应式数据</strong>：对数据进行“劫持”，数据变化时能主动触发更新；</li>
<li><strong>视图更新</strong>：数据变化后，自动找到依赖该数据的 DOM 并更新；</li>
<li><strong>事件监听</strong>：监听视图的用户操作（如 input 输入、select 选择），将操作结果同步回数据。</li>
</ol>
<h3 data-id="heading-1">二、Vue 2.x 双向绑定实现原理（Object.defineProperty）</h3>
<p>Vue 2 核心通过 ​<code>​Object.defineProperty​</code>​<strong>​ 劫持数据的 getter/setter</strong>，配合「依赖收集」和「发布-订阅模式」实现双向绑定，具体流程如下：</p>
<h4 data-id="heading-2">1. 核心步骤拆解</h4>
<h5 data-id="heading-3">（1）数据劫持：Object.defineProperty</h5>
<p>Vue 2 会对组件 ​<code>​data​</code>​ 中的数据进行递归遍历，给每个属性通过 ​<code>​Object.defineProperty​</code>​ 重写 ​<code>​getter​</code>​ 和 ​<code>​setter​</code>​：</p>
<ul>
<li><strong>getter</strong>：当数据被访问时（如视图渲染用到 ​<code>​{{ msg }}​</code>​），触发 getter，进行「依赖收集」（记录当前组件的 Watcher）；</li>
<li><strong>setter</strong>：当数据被修改时（如 ​<code>​this.msg = 'new'​</code>​），触发 setter，通知所有依赖该数据的 Watcher 执行更新。</li>
</ul>
<p>示例代码（简化版）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-comment">// 递归处理嵌套对象（如 data: { user: { name: 'xxx' } }）</span>
  <span class="hljs-title function_">observe</span>(value);

  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 可枚举</span>
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 可配置</span>
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 依赖收集：记录当前 Watcher</span>
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> &amp;&amp; dep.<span class="hljs-title function_">addSub</span>(<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>);
      <span class="hljs-keyword">return</span> value;
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (newValue === value) <span class="hljs-keyword">return</span>;
      value = newValue;
      <span class="hljs-title function_">observe</span>(newValue); <span class="hljs-comment">// 新值是对象时，继续劫持</span>
      dep.<span class="hljs-title function_">notify</span>(); <span class="hljs-comment">// 发布通知：触发所有依赖的 Watcher 更新</span>
    }
  });
}

<span class="hljs-comment">// 递归劫持 data 所有属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span> || obj === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(obj);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) {
      <span class="hljs-comment">// 处理数组：重写 push/pop/splice 等方法（Vue 2 数组劫持特殊处理）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(obj);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 处理对象：遍历属性劫持</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> <span class="hljs-title function_">defineReactive</span>(obj, key, obj[key]));
    }
  }
  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">arr</span>) {
    arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">observe</span>(item));
  }
}
</code></pre>
<h5 data-id="heading-4">（2）依赖收集：Dep 类（发布者）</h5>
<p>每个响应式属性都会对应一个 ​<code>​Dep​</code>​ 实例（发布者），用于管理依赖该属性的所有 ​<code>​Watcher​</code>​（订阅者）：</p>
<ul>
<li>​<code>​addSub(watcher)​</code>​：添加订阅者（Watcher）；</li>
<li>​<code>​notify()​</code>​：发布更新通知，触发所有订阅者的 ​<code>​update​</code>​ 方法。</li>
</ul>
<pre><code class="hljs language-perl" lang="perl">class Dep {
  constructor() {
    this.subs = []; <span class="hljs-regexp">//</span> 存储所有依赖的 Watcher
  }
  addSub(<span class="hljs-function"><span class="hljs-keyword">sub</span>) </span>{
    this.subs.push(<span class="hljs-function"><span class="hljs-keyword">sub</span>)</span>;
  }
  notify() {
    this.subs.forEach(<span class="hljs-string">sub =&gt;</span> sub.update()); <span class="hljs-regexp">//</span> 通知所有 Watcher 更新
  }
}
</code></pre>
<h5 data-id="heading-5">（3）视图更新：Watcher 类（订阅者）</h5>
<p>​<code>​Watcher​</code>​ 是连接数据和视图的桥梁，每个组件对应一个 ​<code>​Watcher​</code>​（或多个）：</p>
<ul>
<li>初始化时，会触发数据的 ​<code>​getter​</code>​，将自身添加到 ​<code>​Dep​</code>​ 的订阅列表；</li>
<li>当数据变化触发 ​<code>​Dep.notify()​</code>​ 时，​<code>​Watcher​</code>​ 的 ​<code>​update​</code>​ 方法会被调用，最终触发组件的重新渲染（​<code>​render​</code>​ 函数）。</li>
</ul>
<h5 data-id="heading-6">（4）双向绑定：v-model 语法糖</h5>
<p>​<code>​v-model​</code>​ 本质是 ​<code>​:value​</code>​（数据 → 视图）和 ​<code>​@input​</code>​（视图 → 数据）的语法糖，例如：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 等价于 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"msg"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"msg"</span> @<span class="hljs-attr">input</span>=<span class="hljs-string">"msg = $event.target.value"</span> /&gt;</span>
</code></pre>
<ul>
<li>数据 → 视图：​<code>​msg​</code>​ 变化时，通过响应式机制触发 ​<code>​input​</code>​ 元素的 ​<code>​value​</code>​ 更新；</li>
<li>视图 → 数据：用户输入时，触发 ​<code>​input​</code>​ 事件，将输入值赋值给 ​<code>​msg​</code>​，触发 ​<code>​msg​</code>​ 的 ​<code>​setter​</code>​，完成数据同步。</li>
</ul>
<h4 data-id="heading-7">2. Vue 2 双向绑定完整流程</h4>
<ol>
<li>组件初始化时，​<code>​data​</code>​ 被 ​<code>​observe​</code>​ 劫持所有属性的 ​<code>​getter/setter​</code>​；</li>
<li>组件渲染时，触发数据的 ​<code>​getter​</code>​，将组件的 ​<code>​Watcher​</code>​ 添加到 ​<code>​Dep​</code>​ 订阅列表（依赖收集）；</li>
<li>数据变化时，触发 ​<code>​setter​</code>​ → ​<code>​Dep.notify()​</code>​ → 所有依赖的 ​<code>​Watcher.update()​</code>​ → 组件重新渲染（数据 → 视图）；</li>
<li>视图操作（如输入框输入）触发 ​<code>​input​</code>​ 事件 → 赋值给数据（​<code>​this.msg = 新值​</code>​）→ 触发 ​<code>​setter​</code>​ → 重复步骤 3（视图 → 数据）。</li>
</ol>
<h4 data-id="heading-8">3. Vue 2 双向绑定的局限性</h4>
<ul>
<li>无法劫持数组的索引修改（如 ​<code>​arr[0] = 1​</code>​）和长度修改（如 ​<code>​arr.length = 0​</code>​），需通过 Vue 提供的 ​<code>​$set​</code>​ 或数组方法（​<code>​push/splice​</code>​ 等）触发更新；</li>
<li>无法劫持对象的新增属性（如 ​<code>​this.user.age = 18​</code>​），需通过 ​<code>​this.$set(this.user, 'age', 18)​</code>​ 添加响应式属性；</li>
<li>​<code>​Object.defineProperty​</code>​ 需递归遍历对象，性能开销较大（尤其深层嵌套对象）。</li>
</ul>
<h3 data-id="heading-9">三、Vue 3.x 双向绑定实现原理（Proxy + Reflect）</h3>
<p>Vue 3 废弃了 ​<code>​Object.defineProperty​</code>​，改用 ​<code>​Proxy​</code>​<strong>​ 代理数据</strong> + ​<code>​Reflect​</code>​<strong>​ 反射操作</strong>，解决了 Vue 2 的局限性，同时性能更优，具体流程如下：</p>
<h4 data-id="heading-10">1. 核心改进点</h4>
<ul>
<li><strong>Proxy 优势</strong>：</li>
</ul>
<ol>
<li>可直接代理整个对象（无需递归遍历属性），新增属性自动响应；</li>
<li>支持代理数组的索引修改、长度修改（如 ​<code>​arr[0] = 1​</code>​、​<code>​arr.length = 0​</code>​）；</li>
<li>支持 13 种拦截操作（如 ​<code>​get​</code>​、​<code>​set​</code>​、​<code>​deleteProperty​</code>​ 等），功能更强大。</li>
</ol>
<ul>
<li><strong>Reflect 作用</strong>：</li>
</ul>
<ol>
<li>统一对象操作的返回值（如 ​<code>​Reflect.set​</code>​ 成功返回 ​<code>​true​</code>​，失败返回 ​<code>​false​</code>​）；</li>
<li>避免直接操作对象的副作用（如 ​<code>​delete obj.key​</code>​ 会报错，​<code>​Reflect.deleteProperty​</code>​ 返回布尔值）；</li>
<li>与 Proxy 拦截方法一一对应，便于代码统一管理。</li>
</ol>
<h4 data-id="heading-11">2. 核心步骤拆解</h4>
<h5 data-id="heading-12">（1）数据代理：Proxy + reactive</h5>
<p>Vue 3 中通过 ​<code>​reactive​</code>​ 函数创建对象的 Proxy 代理，递归处理嵌套对象（仅在访问嵌套对象时才代理，懒加载优化）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-comment">// 仅代理对象/数组（基础类型用 ref 处理）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span> || obj === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> obj;

  <span class="hljs-comment">// 创建 Proxy 代理</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, {
    <span class="hljs-comment">// 拦截属性访问（getter）</span>
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      <span class="hljs-comment">// 依赖收集：与 Vue 2 Dep 类似，记录 Watcher</span>
      <span class="hljs-title function_">track</span>(target, key);
      <span class="hljs-comment">// 递归代理嵌套对象（懒加载）</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">isObject</span>(result) ? <span class="hljs-title function_">reactive</span>(result) : result;
    },
    <span class="hljs-comment">// 拦截属性修改/新增（setter）</span>
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
      <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
      <span class="hljs-comment">// 只有值变化时才触发更新</span>
      <span class="hljs-keyword">if</span> (oldValue !== value &amp;&amp; success) {
        <span class="hljs-comment">// 发布通知：触发依赖更新</span>
        <span class="hljs-title function_">trigger</span>(target, key);
      }
      <span class="hljs-keyword">return</span> success;
    },
    <span class="hljs-comment">// 拦截属性删除</span>
    <span class="hljs-title function_">deleteProperty</span>(<span class="hljs-params">target, key</span>) {
      <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">deleteProperty</span>(target, key);
      <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-title function_">trigger</span>(target, key);
      }
      <span class="hljs-keyword">return</span> success;
    }
  });
}

<span class="hljs-comment">// 判断是否为对象/数组</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isObject</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value !== <span class="hljs-literal">null</span>;
}
</code></pre>
<h5 data-id="heading-13">（2）基础类型响应式：ref</h5>
<p>​<code>​Proxy​</code>​ 无法代理基础类型（如 ​<code>​string​</code>​、​<code>​number​</code>​），Vue 3 用 ​<code>​ref​</code>​ 包装基础类型，通过 ​<code>​value​</code>​ 属性访问/修改：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">ref</span>(<span class="hljs-params"><span class="hljs-keyword">value</span></span>)</span> {
  <span class="hljs-comment">// 创建包含 value 属性的对象</span>
  <span class="hljs-keyword">const</span> refObj = {
    <span class="hljs-function"><span class="hljs-keyword">get</span> <span class="hljs-title">value</span>()</span> {
      track(refObj, <span class="hljs-string">'value'</span>); <span class="hljs-comment">// 依赖收集</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;
    },
    <span class="hljs-function"><span class="hljs-keyword">set</span> <span class="hljs-title">value</span>(<span class="hljs-params">newValue</span>)</span> {
      <span class="hljs-keyword">if</span> (newValue === <span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">value</span> = newValue;
      trigger(refObj, <span class="hljs-string">'value'</span>); <span class="hljs-comment">// 发布通知</span>
    }
  };
  <span class="hljs-keyword">return</span> refObj;
}
</code></pre>
<h5 data-id="heading-14">（3）依赖收集与更新：track + trigger</h5>
<p>Vue 3 用 ​<code>​track​</code>​ 替代 Vue 2 的 ​<code>​Dep.addSub​</code>​，用 ​<code>​trigger​</code>​ 替代 ​<code>​Dep.notify​</code>​，逻辑更简洁：</p>
<ul>
<li>​<code>​track(target, key)​</code>​：在 ​<code>​get​</code>​ 拦截时调用，记录“目标对象 + 属性”对应的依赖（Watcher）；</li>
<li>​<code>​trigger(target, key)​</code>​：在 ​<code>​set​</code>​/​<code>​deleteProperty​</code>​ 拦截时调用，触发“目标对象 + 属性”的所有依赖更新。</li>
</ul>
<h5 data-id="heading-15">（4）双向绑定：v-model 语法糖（兼容 Vue 2，新增优化）</h5>
<p>Vue 3 的 ​<code>​v-model​</code>​ 仍为语法糖，但支持更多场景：</p>
<ul>
<li>普通输入框：​<code>​v-model="msg"​</code>​ → ​<code>​:modelValue="msg" @update:modelValue="msg = $event"​</code>​（Vue 3 统一了自定义组件的绑定逻辑）；</li>
<li>自定义组件：无需再区分 ​<code>​props​</code>​ 和 ​<code>​$emit​</code>​，直接通过 ​<code>​v-model​</code>​ 绑定，支持多个 ​<code>​v-model​</code>​（如 ​<code>​v-model:name="name" v-model:age="age"​</code>​）。</li>
</ul>
<p>示例（自定义组件双向绑定）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 父组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">v-model:name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">v-model:age</span>=<span class="hljs-string">"age"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 子组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"name"</span> @<span class="hljs-attr">input</span>=<span class="hljs-string">"$emit('update:name', $event.target.value)"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"age"</span> @<span class="hljs-attr">input</span>=<span class="hljs-string">"$emit('update:age', $event.target.value)"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>([<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>]);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">3. Vue 3 双向绑定完整流程</h4>
<ol>
<li>调用 ​<code>​reactive​</code>​/​<code>​ref​</code>​ 对数据进行 Proxy 代理；</li>
<li>组件渲染时，访问数据触发 ​<code>​Proxy.get​</code>​ → 调用 ​<code>​track​</code>​ 收集依赖（记录 Watcher）；</li>
<li>数据变化时（如 ​<code>​obj.key = 新值​</code>​、​<code>​arr[0] = 新值​</code>​），触发 ​<code>​Proxy.set​</code>​ → 调用 ​<code>​trigger​</code>​ 通知依赖更新 → 组件重新渲染（数据 → 视图）；</li>
<li>视图操作触发 ​<code>​update:modelValue​</code>​ 事件（或 ​<code>​input​</code>​ 事件）→ 赋值给代理数据 → 触发 ​<code>​Proxy.set​</code>​ → 重复步骤 3（视图 → 数据）。</li>
</ol>
<h3 data-id="heading-17">四、Vue 2 vs Vue 3 双向绑定核心差异</h3>








































<table><thead><tr><th>对比维度</th><th>Vue 2.x</th><th>Vue 3.x</th></tr></thead><tbody><tr><td>核心 API</td><td>​<code>​Object.defineProperty​</code>​</td><td>​<code>​Proxy + Reflect​</code>​</td></tr><tr><td>数据劫持范围</td><td>仅属性，需递归遍历</td><td>整个对象，懒加载代理嵌套对象</td></tr><tr><td>数组支持</td><td>不支持索引/长度修改，需特殊处理</td><td>原生支持索引/长度修改</td></tr><tr><td>对象新增属性</td><td>需 ​<code>​$set​</code>​ 手动添加响应式</td><td>自动响应新增属性</td></tr><tr><td>基础类型响应式</td><td>需嵌套在对象中（如 ​<code>​data: { num: 0 }​</code>​）</td><td>直接用 ​<code>​ref​</code>​​ 包装（如 ​<code>​const num = ref(0)​</code>​）</td></tr><tr><td>性能</td><td>递归遍历开销大，深层对象性能差</td><td>懒加载代理，性能更优</td></tr></tbody></table>
<h3 data-id="heading-18">五、面试必背总结</h3>
<ol>
<li><strong>双向绑定本质</strong>：​<code>​数据响应式（数据→视图） + 事件监听（视图→数据）​</code>​ 的语法糖（v-model）；</li>
<li><strong>Vue 2 核心</strong>：​<code>​Object.defineProperty​</code>​ 劫持 getter/setter + Dep（发布者）+ Watcher（订阅者），局限性是不支持数组索引/对象新增属性；</li>
<li><strong>Vue 3 核心</strong>：​<code>​Proxy + Reflect​</code>​ 代理数据 + track（依赖收集）+ trigger（更新触发），解决 Vue 2 局限性，性能更优；</li>
<li><strong>v-model 原理</strong>：Vue 2 是 ​<code>​:value + @input​</code>​，Vue 3 是 ​<code>​:modelValue + @update:modelValue​</code>​，支持多字段绑定。</li>
</ol>
<p>掌握以上核心逻辑，就能清晰回答 Vue 双向绑定的实现原理，同时覆盖版本差异（面试高频考点）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[兼容 Android Q+ 实现 WebView 图片长按保存与复制]]></title>    <link>https://juejin.cn/post/7571378103282237446</link>    <guid>https://juejin.cn/post/7571378103282237446</guid>    <pubDate>2025-11-12T04:23:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103282237446" data-draft-id="7571402480966582308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="兼容 Android Q+ 实现 WebView 图片长按保存与复制"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-12T04:23:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4165967369355"/> <meta itemprop="url" content="https://juejin.cn/user/1146150492576877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            兼容 Android Q+ 实现 WebView 图片长按保存与复制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1146150492576877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4165967369355
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T04:23:55.000Z" title="Wed Nov 12 2025 04:23:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Android 应用中，许多功能依赖于内嵌的 <code>WebView</code>。其中一个常见需求是：用户长按 <code>WebView</code> 中的图片时，能够将图片保存到系统相册或复制到剪切板。</p>
<p>这个需求在 Android 10 (Q) 引入 <strong>Scoped Storage (分区存储)</strong> 后变得复杂。本文将提供一个完整的 Kotlin 解决方案，通过扩展方法和统一的存储管理，完美兼容所有 Android 版本。</p>
<h2 data-id="heading-0">一、捕获长按事件：WebView 扩展方法</h2>
<p>首先，我们需要一个优雅的方式来捕获长按事件，并筛选出只有图片命中的情况。我们采用 Kotlin 扩展方法 <code>onImageLongClick</code> 来封装 <code>HitTestResult</code> 的检查逻辑。</p>
<h3 data-id="heading-1">1. 扩展方法 <code>onImageLongClick</code></h3>
<p>我们将图片源（URL 或 Base64 Data URL）作为回调参数返回，简化 Activity/Fragment 的逻辑。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// WebViewExtensions.kt</span>

<span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.webkit.WebView.HitTestResult

<span class="hljs-comment">/**
 * 为 WebView 添加图片长按事件处理器。
 * 只有当长按命中的是图片或图片链接时，才执行回调。
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> WebView.<span class="hljs-title">onImageLongClick</span><span class="hljs-params">(callback: (<span class="hljs-type">imageUrl</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">this</span>.setOnLongClickListener { v -&gt;
        <span class="hljs-keyword">val</span> hitTestResult = <span class="hljs-keyword">this</span>.hitTestResult
        
        <span class="hljs-comment">// 检查是否命中图片或图片链接</span>
        <span class="hljs-keyword">if</span> (hitTestResult.type == HitTestResult.IMAGE_TYPE ||
            hitTestResult.type == HitTestResult.SRC_IMAGE_ANCHOR_TYPE
        ) {
            <span class="hljs-keyword">val</span> sourceUrl = hitTestResult.extra
            
            <span class="hljs-keyword">if</span> (sourceUrl != <span class="hljs-literal">null</span> &amp;&amp; sourceUrl.isNotBlank()) {
                callback.invoke(sourceUrl)
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnLongClickListener</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 消耗事件</span>
            }
        }
        
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnLongClickListener</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// 未命中图片，不消费事件</span>
    }
}
</code></pre>
<h2 data-id="heading-2">二、统一存储管理：FileDownloadManager</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">package</span> com.yourpackage.utils

<span class="hljs-keyword">import</span> android.content.ClipData
<span class="hljs-keyword">import</span> android.content.ClipboardManager
<span class="hljs-keyword">import</span> android.content.ContentValues
<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.net.Uri
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> android.os.Environment
<span class="hljs-keyword">import</span> android.provider.MediaStore
<span class="hljs-keyword">import</span> android.util.Base64
<span class="hljs-keyword">import</span> android.webkit.MimeTypeMap
<span class="hljs-keyword">import</span> android.widget.Toast
<span class="hljs-keyword">import</span> kotlinx.coroutines.Dispatchers
<span class="hljs-keyword">import</span> kotlinx.coroutines.withContext
<span class="hljs-keyword">import</span> okhttp3.OkHttpClient
<span class="hljs-keyword">import</span> okhttp3.Request
<span class="hljs-keyword">import</span> java.io.File
<span class="hljs-keyword">import</span> java.io.IOException

<span class="hljs-keyword">object</span> FileDownloadManager {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> client = OkHttpClient()

    <span class="hljs-comment">// --- 公共入口方法 ---</span>

    <span class="hljs-comment">/**
     * (公共) 将 Base64 Data URL 保存到公共 MediaStore
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveBase64DataUrl</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, dataUrl: <span class="hljs-type">String</span>)</span></span>: Uri? {
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> (mimeType, base64Data) = parseDataUrl(context, dataUrl) ?: <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
                <span class="hljs-keyword">val</span> extension = getExtensionFromMimeType(mimeType)
                <span class="hljs-keyword">val</span> fileName = <span class="hljs-string">"image_<span class="hljs-subst">${System.currentTimeMillis()}</span>.<span class="hljs-variable">$extension</span>"</span>

                <span class="hljs-keyword">val</span> imageBytes = Base64.decode(base64Data, Base64.DEFAULT)

                <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> saveBytesToMediaStore(context, imageBytes, mimeType, fileName)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                e.printStackTrace()
                showToast(context, <span class="hljs-string">"Base64 保存失败: <span class="hljs-subst">${e.message}</span>"</span>)
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
            }
        }
    }

    <span class="hljs-comment">/**
     * (公共) 将网络 URL 文件下载并保存到公共 MediaStore
     */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">downloadAndSaveFile</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, fileUrl: <span class="hljs-type">String</span>)</span></span>: Uri? {
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> request = Request.Builder().url(fileUrl).build()
                <span class="hljs-keyword">val</span> response = client.newCall(request).execute()
                <span class="hljs-keyword">if</span> (!response.isSuccessful) {
                    showToast(context, <span class="hljs-string">"下载失败: <span class="hljs-subst">${response.code}</span>"</span>)
                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
                }
                
                <span class="hljs-keyword">val</span> contentType = response.header(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/octet-stream"</span>)
                <span class="hljs-keyword">val</span> mimeType = contentType ?: <span class="hljs-string">"application/octet-stream"</span>
                <span class="hljs-keyword">val</span> extension = getExtensionFromMimeType(mimeType)
                <span class="hljs-keyword">val</span> fileName = <span class="hljs-string">"download_<span class="hljs-subst">${System.currentTimeMillis()}</span>.<span class="hljs-variable">$extension</span>"</span>
                <span class="hljs-keyword">val</span> imageBytes = response.body?.bytes()
                
                <span class="hljs-keyword">if</span> (imageBytes != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> saveBytesToMediaStore(context, imageBytes, mimeType, fileName)
                } <span class="hljs-keyword">else</span> {
                    showToast(context, <span class="hljs-string">"下载内容为空"</span>)
                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
                }
            } <span class="hljs-keyword">catch</span> (e: IOException) {
                e.printStackTrace()
                showToast(context, <span class="hljs-string">"下载异常: <span class="hljs-subst">${e.message}</span>"</span>)
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
            }
        }
    }

    <span class="hljs-comment">/**
     * (公共) 将 Content URI 复制到系统剪切板
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">copyImageToClipboard</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, imageUri: <span class="hljs-type">Uri</span>)</span></span> {
        <span class="hljs-keyword">val</span> clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) <span class="hljs-keyword">as</span> ClipboardManager
        <span class="hljs-keyword">val</span> clip = ClipData.newUri(context.contentResolver, <span class="hljs-string">"Image"</span>, imageUri)
        clipboard.setPrimaryClip(clip)
        showToast(context, <span class="hljs-string">"图片已复制到剪切板"</span>)
    }

    <span class="hljs-comment">// --- 内部核心逻辑 ---</span>

    <span class="hljs-comment">/**
     * (私有-核心) 保存字节到公共 MediaStore (兼容 P- 和 Q+)
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveBytesToMediaStore</span><span class="hljs-params">(
        context: <span class="hljs-type">Context</span>,
        imageBytes: <span class="hljs-type">ByteArray</span>,
        mimeType: <span class="hljs-type">String</span>,
        fileName: <span class="hljs-type">String</span>
    )</span></span>: Uri? {
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {
            <span class="hljs-keyword">val</span> resolver = context.contentResolver
            <span class="hljs-keyword">val</span> values = ContentValues()
            <span class="hljs-keyword">var</span> fileUri: Uri? = <span class="hljs-literal">null</span>

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
                    <span class="hljs-comment">// --- Q+ 逻辑：使用 Scoped Storage ---</span>
                    <span class="hljs-keyword">val</span> collectionUri: Uri
                    <span class="hljs-keyword">if</span> (mimeType.startsWith(<span class="hljs-string">"image/"</span>)) {
                        values.put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_PICTURES)
                        collectionUri = MediaStore.Images.Media.getContentUri(MediaStore.VOLUME_EXTERNAL_PRIMARY)
                    } <span class="hljs-keyword">else</span> {
                        values.put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS)
                        collectionUri = MediaStore.Downloads.getContentUri(MediaStore.VOLUME_EXTERNAL_PRIMARY)
                    }
                    values.put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)
                    values.put(MediaStore.MediaColumns.MIME_TYPE, mimeType)
                    values.put(MediaStore.MediaColumns.IS_PENDING, <span class="hljs-number">1</span>)

                    fileUri = resolver.insert(collectionUri, values)
                    fileUri?.let { uri -&gt;
                        resolver.openOutputStream(uri).use { it?.write(imageBytes) }
                        values.clear()
                        values.put(MediaStore.MediaColumns.IS_PENDING, <span class="hljs-number">0</span>)
                        resolver.update(uri, values, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// --- P- 逻辑：使用 Legacy Storage 和 _DATA 字段 ---</span>
                    <span class="hljs-keyword">val</span> publicDir: File
                    <span class="hljs-keyword">val</span> collectionUri: Uri
                    <span class="hljs-keyword">if</span> (mimeType.startsWith(<span class="hljs-string">"image/"</span>)) {
                        publicDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES)
                        collectionUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI
                    } <span class="hljs-keyword">else</span> {
                        publicDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)
                        collectionUri = MediaStore.Files.getContentUri(<span class="hljs-string">"external"</span>)
                    }
                    <span class="hljs-keyword">if</span> (!publicDir.exists()) publicDir.mkdirs()

                    <span class="hljs-keyword">val</span> file = File(publicDir, fileName)
                    values.put(MediaStore.MediaColumns.DISPLAY_NAME, fileName)
                    values.put(MediaStore.MediaColumns.MIME_TYPE, mimeType)
                    values.put(MediaStore.MediaColumns.DATA, file.absolutePath)

                    fileUri = resolver.insert(collectionUri, values)
                    fileUri?.let { uri -&gt;
                        resolver.openOutputStream(uri).use { it?.write(imageBytes) }
                    }
                }

                <span class="hljs-keyword">if</span> (fileUri != <span class="hljs-literal">null</span>) {
                    showToast(context, <span class="hljs-string">"图片已保存到相册"</span>)
                } <span class="hljs-keyword">else</span> {
                    showToast(context, <span class="hljs-string">"保存失败"</span>)
                }
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> fileUri

            } <span class="hljs-keyword">catch</span> (e: Exception) {
                e.printStackTrace()
                <span class="hljs-keyword">if</span> (fileUri != <span class="hljs-literal">null</span> &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
                    resolver.delete(fileUri, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
                }
                showToast(context, <span class="hljs-string">"保存异常: <span class="hljs-subst">${e.message}</span>"</span>)
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-literal">null</span>
            }
        }
    }

    <span class="hljs-comment">// --- 辅助方法 ---</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseDataUrl</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, dataUrl: <span class="hljs-type">String</span>)</span></span>: Pair&lt;String, String&gt;? {
        <span class="hljs-keyword">if</span> (!dataUrl.startsWith(<span class="hljs-string">"data:"</span>)) {
            showToast(context, <span class="hljs-string">"非 Data URL 格式"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">val</span> commaIndex = dataUrl.indexOf(<span class="hljs-string">','</span>)
        <span class="hljs-keyword">if</span> (commaIndex == -<span class="hljs-number">1</span>) {
            showToast(context, <span class="hljs-string">"Data URL 格式错误"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">val</span> metadataPart = dataUrl.substring(<span class="hljs-number">5</span>, commaIndex)
        <span class="hljs-keyword">val</span> base64Data = dataUrl.substring(commaIndex + <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> mimeType = metadataPart.split(<span class="hljs-string">';'</span>).firstOrNull() ?: <span class="hljs-string">"application/octet-stream"</span>
        <span class="hljs-keyword">return</span> Pair(mimeType, base64Data)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getExtensionFromMimeType</span><span class="hljs-params">(mimeType: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> MimeTypeMap.getSingleton().getExtensionFromMimeType(mimeType) ?:
            <span class="hljs-keyword">when</span> (mimeType) {
                <span class="hljs-string">"image/jpeg"</span> -&gt; <span class="hljs-string">"jpg"</span>
                <span class="hljs-string">"image/png"</span> -&gt; <span class="hljs-string">"png"</span>
                <span class="hljs-string">"image/webp"</span> -&gt; <span class="hljs-string">"webp"</span>
                <span class="hljs-string">"image/gif"</span> -&gt; <span class="hljs-string">"gif"</span>
                <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"bin"</span>
            }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showToast</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, message: <span class="hljs-type">String</span>)</span></span> {
        Toast.makeText(context, message, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-3">三、集成与权限</h2>
<p>这是将所有组件集成在一起的 Activity 代码，它处理了长按监听、流程分发和运行时权限请求。</p>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">package</span> com.yourpackage

<span class="hljs-keyword">import</span> android.Manifest
<span class="hljs-keyword">import</span> android.content.pm.PackageManager
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.widget.Toast
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity
<span class="hljs-keyword">import</span> androidx.core.app.ActivityCompat
<span class="hljs-keyword">import</span> androidx.core.content.ContextCompat
<span class="hljs-keyword">import</span> androidx.lifecycle.lifecycleScope
<span class="hljs-keyword">import</span> com.yourpackage.utils.FileDownloadManager
<span class="hljs-keyword">import</span> com.yourpackage.utils.onImageLongClick <span class="hljs-comment">// 导入扩展方法</span>
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebViewActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> webView: WebView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> pendingSaveUrl: String? = <span class="hljs-literal">null</span> <span class="hljs-comment">// 用于权限回调后存储 URL</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> REQUEST_WRITE_STORAGE = <span class="hljs-number">1001</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        <span class="hljs-comment">// 假设您的布局包含一个 id 为 webview 的 WebView 组件</span>
        webView = WebView(<span class="hljs-keyword">this</span>)
        setContentView(webView)
        
        setupWebViewLongClick()
        webView.loadUrl(<span class="hljs-string">"https://example.com/page_with_images"</span>) <span class="hljs-comment">// 加载测试页面</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupWebViewLongClick</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 使用扩展方法设置长按监听</span>
        webView.onImageLongClick { imageUrl -&gt;
            <span class="hljs-comment">// 提示用户选择操作 (这里简化为直接走保存流程)</span>
            Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"发现图片，准备保存..."</span>, Toast.LENGTH_SHORT).show()
            checkStoragePermissionAndSave(imageUrl) 
        }
    }

    <span class="hljs-comment">// --- 权限检查与流程启动 ---</span>

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkStoragePermissionAndSave</span><span class="hljs-params">(sourceUrl: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// API 29+ (Android 10+) 不需要权限</span>
        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
            startSaveProcess(sourceUrl)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// API 28- (Android 9-) 需要检查权限</span>
        <span class="hljs-keyword">if</span> (ContextCompat.checkSelfPermission(
                <span class="hljs-keyword">this</span>,
                Manifest.permission.WRITE_EXTERNAL_STORAGE
            ) == PackageManager.PERMISSION_GRANTED
        ) {
            startSaveProcess(sourceUrl)
        } <span class="hljs-keyword">else</span> {
            pendingSaveUrl = sourceUrl
            ActivityCompat.requestPermissions(
                <span class="hljs-keyword">this</span>,
                arrayOf(Manifest.permission.WRITE_EXTERNAL_STORAGE),
                REQUEST_WRITE_STORAGE
            )
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onRequestPermissionsResult</span><span class="hljs-params">(
        requestCode: <span class="hljs-type">Int</span>,
        permissions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;,
        grantResults: <span class="hljs-type">IntArray</span>
    )</span></span> {
        <span class="hljs-keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults)
        <span class="hljs-keyword">if</span> (requestCode == REQUEST_WRITE_STORAGE) {
            <span class="hljs-keyword">if</span> (grantResults.isNotEmpty() &amp;&amp; grantResults[<span class="hljs-number">0</span>] == PackageManager.PERMISSION_GRANTED) {
                pendingSaveUrl?.let {
                    startSaveProcess(it)
                    pendingSaveUrl = <span class="hljs-literal">null</span>
                }
            } <span class="hljs-keyword">else</span> {
                Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"保存文件需要存储权限"</span>, Toast.LENGTH_SHORT).show()
                pendingSaveUrl = <span class="hljs-literal">null</span>
            }
        }
    }

    <span class="hljs-comment">// --- 核心保存流程 ---</span>

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startSaveProcess</span><span class="hljs-params">(imageUrl: <span class="hljs-type">String</span>)</span></span> {
        lifecycleScope.launch {
            <span class="hljs-keyword">val</span> savedUri = <span class="hljs-keyword">if</span> (imageUrl.startsWith(<span class="hljs-string">"data:"</span>)) {
                <span class="hljs-comment">// Base64 链接</span>
                FileDownloadManager.saveBase64DataUrl(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MyWebViewActivity</span>, imageUrl)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 网络链接</span>
                FileDownloadManager.downloadAndSaveFile(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MyWebViewActivity</span>, imageUrl)
            }

            <span class="hljs-keyword">if</span> (savedUri != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 保存成功后，复制图片到剪切板</span>
                FileDownloadManager.copyImageToClipboard(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MyWebViewActivity</span>, savedUri)
            }
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安卓编译: 2.native层定制修改(上)]]></title>    <link>https://juejin.cn/post/7571372478803951631</link>    <guid>https://juejin.cn/post/7571372478803951631</guid>    <pubDate>2025-11-12T02:19:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803951631" data-draft-id="7571060853353578506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安卓编译: 2.native层定制修改(上)"/> <meta itemprop="keywords" content="逆向"/> <meta itemprop="datePublished" content="2025-11-12T02:19:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三喵223"/> <meta itemprop="url" content="https://juejin.cn/user/54318049787980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安卓编译: 2.native层定制修改(上)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/54318049787980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三喵223
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:19:16.000Z" title="Wed Nov 12 2025 02:19:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">2.1 添加libc库日志打印方法</h2>
<p>目的
提供打印函数，方便日志打印以及参数分析</p>
<p>修改步骤
<code>bionic\libc\async_safe\include\async_safe\log.h</code>
新增</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 新增libc打印函数</span>
<span class="hljs-selector-id">#define</span> SAMUEL_TAG "SamuelHookTagLogC"
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">CLOGI</span>(...) <span class="hljs-built_in">async_safe_format_log</span>(ANDROID_LOG_INFO, SAMUEL_TAG, __VA_ARGS__);
<span class="hljs-selector-id">#define</span> <span class="hljs-built_in">CLOGE</span>(...) <span class="hljs-built_in">async_safe_format_log</span>(ANDROID_LOG_ERROR, SAMUEL_TAG, __VA_ARGS__);


创建文件 bionic\libc\bionic\clog<span class="hljs-selector-class">.cpp</span>

<span class="hljs-selector-id">#include</span> &lt;unistd<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;async_safe/log<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;string<span class="hljs-selector-class">.h</span>&gt;
<span class="hljs-selector-id">#include</span> &lt;stdio<span class="hljs-selector-class">.h</span>&gt;
  
  
void <span class="hljs-built_in">clogi</span>(const char* method, const char* info) {
    int pid = <span class="hljs-built_in">getpid</span>();
    if (pid &lt; <span class="hljs-number">2000</span>) {
        return;
    }
 
    char sPid<span class="hljs-selector-attr">[32]</span> = {<span class="hljs-number">0</span>};
    <span class="hljs-built_in">snprintf</span>(sPid, sizeof(sPid), "\"PID\":\<span class="hljs-string">"%d\",\"UID\":\"%d\""</span>, pid, <span class="hljs-built_in">getuid</span>());
 
    char sinfo<span class="hljs-selector-attr">[1024]</span> = {<span class="hljs-number">0</span>};
    size_t lenInfo = <span class="hljs-built_in">strlen</span>(info);
    if (lenInfo &gt; <span class="hljs-number">1023</span>) {
        <span class="hljs-built_in">strncpy</span>(sinfo, info, <span class="hljs-number">1023</span>);
        sinfo<span class="hljs-selector-attr">[1023]</span> = '\<span class="hljs-number">0</span>';  <span class="hljs-comment">// Ensure null-termination</span>
    } else {
        <span class="hljs-built_in">strncpy</span>(sinfo, info, lenInfo);
        sinfo<span class="hljs-selector-attr">[lenInfo]</span> = '\<span class="hljs-number">0</span>';  <span class="hljs-comment">// Ensure null-termination</span>
    }
 
    <span class="hljs-built_in">CLOGI</span>("{\"Type\":\"NativeLog\",%s,\"Info\":\"&lt;%s&gt;:%s\"}", sPid, method, sinfo);
}
  
void <span class="hljs-built_in">cloge</span>(const char* method, const char* info){
  int pid = <span class="hljs-built_in">getpid</span>();
  if (pid &lt; <span class="hljs-number">2000</span>){
    return;
  }
   
  char sPid<span class="hljs-selector-attr">[32]</span> = {<span class="hljs-number">0</span>};
    <span class="hljs-built_in">snprintf</span>(sPid, sizeof(sPid), "\"PID\":\<span class="hljs-string">"%d\",\"UID\":\"%d\""</span>, pid, <span class="hljs-built_in">getuid</span>());
 
    char sinfo<span class="hljs-selector-attr">[1024]</span> = {<span class="hljs-number">0</span>};
    size_t lenInfo = <span class="hljs-built_in">strlen</span>(info);
    if (lenInfo &gt; <span class="hljs-number">1023</span>) {
        <span class="hljs-built_in">strncpy</span>(sinfo, info, <span class="hljs-number">1023</span>);
        sinfo<span class="hljs-selector-attr">[1023]</span> = '\<span class="hljs-number">0</span>';  <span class="hljs-comment">// Ensure null-termination</span>
    } else {
        <span class="hljs-built_in">strncpy</span>(sinfo, info, lenInfo);
        sinfo<span class="hljs-selector-attr">[lenInfo]</span> = '\<span class="hljs-number">0</span>';  <span class="hljs-comment">// Ensure null-termination</span>
    }
 
    <span class="hljs-built_in">CLOGE</span>("{\"Type\":\"NativeLog\",%s,\"Error\":\"&lt;%s&gt;:%s\"}", sPid, method, sinfo);
  
}
 
void <span class="hljs-built_in">clogif</span>(const char* method, const char* format, ...){
     <span class="hljs-comment">// 构建可变参数的格式化信息</span>
    char sinfo<span class="hljs-selector-attr">[1024]</span> = {<span class="hljs-number">0</span>};
    va_list args;
    <span class="hljs-built_in">va_start</span>(args, format);
    <span class="hljs-built_in">vsnprintf</span>(sinfo, sizeof(sinfo), format, args);
    <span class="hljs-built_in">va_end</span>(args);
    <span class="hljs-built_in">clogi</span>(method, sinfo);
}
 
void <span class="hljs-built_in">clogef</span>(const char* method, const char* format, ...) {
    char sinfo<span class="hljs-selector-attr">[1024]</span> = {<span class="hljs-number">0</span>};
    va_list args;
    <span class="hljs-built_in">va_start</span>(args, format);
    <span class="hljs-built_in">vsnprintf</span>(sinfo, sizeof(sinfo), format, args);
    <span class="hljs-built_in">va_end</span>(args);
    <span class="hljs-built_in">cloge</span>(method, sinfo);
}
 
int <span class="hljs-built_in">isuseruid</span>(void) {
    if ( getuid() &gt; <span class="hljs-number">10000</span>) {
        return <span class="hljs-number">1</span>;
    }  
    return <span class="hljs-number">0</span>;
}
</code></pre>
<p>新增 <code>bionic\libc\include\unistd.h</code></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 新增日志libc打印函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clogi</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* method, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* info)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">cloge</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* method, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* error)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clogif</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* method, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clogef</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* method, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* format, ...)</span></span>;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">isuseruid</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;
</code></pre>
<p>修改 <code>bionic\libc\Android.bp</code> , 添加clog.cpp到编译链</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ========================================================</span>
<span class="hljs-comment">// libc_tzcode.a - upstream 'tzcode' code</span>
<span class="hljs-comment">// ========================================================</span>
 
cc_library_static {
 
    defaults: [<span class="hljs-string">"libc_defaults"</span>],
    srcs: [
        <span class="hljs-string">"tzcode/**/*.c"</span>,
        <span class="hljs-string">"tzcode/bionic.cpp"</span>,
        <span class="hljs-string">"upstream-openbsd/lib/libc/time/wcsftime.c"</span>, <span class="hljs-comment">// tzcode doesn't include wcsftime, so we use the OpenBSD one.</span>
        <span class="hljs-string">"bionic/clog.cpp"</span>, <span class="hljs-comment">// 增加链接库编译, 用于libc日志打印</span>
    ],
</code></pre>
<p>调用方式</p>
<p>引入 unistd.h 头文件
Demo</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">#include&lt;unistd.h&gt;</span>
<span class="hljs-keyword">int</span> main() { 
     clogi(<span class="hljs-string">"函数名称"</span>, <span class="hljs-string">"日志内容"</span>);
     cloge(<span class="hljs-string">"函数名称"</span>, <span class="hljs-string">"日志内容"</span>);
     clogif(<span class="hljs-string">"函数名称"</span>, <span class="hljs-string">"日志内容格式: value=%s, number=%d"</span>, <span class="hljs-string">"value"</span>, <span class="hljs-number">12</span>);
     clogef(<span class="hljs-string">"函数名称"</span>, <span class="hljs-string">"日志内容格式: value=%s, number=%d"</span>, <span class="hljs-string">"value"</span>, <span class="hljs-number">12</span>);
}
</code></pre>
<h2 data-id="heading-1">2.2 修改strstr实现字符串特征绕过</h2>
<h3 data-id="heading-2">背景</h3>
<p>当前市场上针对 Frida、Xposed 和 Root 的检测方法种类繁多，但它们的核心逻辑大多基于特定特征字符串的检测。例如，通过查询目标进程内存、文件路径或动态链接库中的关键字来判断系统状态。这些方法通常依赖以下函数：</p>
<p>strstr：用于查找字符串中是否包含目标特征。
strcmp：用于比较两个字符串是否相等。
为绕过这些检测机制，可以通过修改 strstr 和 strcmp 函数的行为来隐藏特征信息。有以下两种修改思路</p>
<p>直接修改系统函数行为</p>
<p>修改 AOSP 系统源码，将 strstr 修改为始终返回 NULL，或对关键字的判断进行特殊处理（如跳过检测特定特征）。
将 strcmp 修改为对特定字符串返回假值（即认为字符串不相等）。
Hook 系统函数
使用 Hook 技术自定义 strstr 和 strcmp 的实现逻辑，例如对检测关键字返回自定义值。
可灵活调整返回值，动态适应不同的检测逻辑。</p>
<p>相比 Hook 技术，直接修改系统源码的方法具有以下优势：</p>
<p>规避二次检测 Hook 技术本身可能会引入新的特征（如 Frida 或 Xposed 的加载路径、动态库等），从而被检测机制发现。通过修改系统源码，避免额外工具的引入，降低被检测的风险。</p>
<p>性能开销低 修改源码后，系统函数的行为在底层实现中直接改变，不需要额外的 Hook 调用，运行效率更高，适合长期使用。</p>
<p>持久性强 系统源码修改后生成的固件可以直接刷入设备，具备持久性，即使设备重启或更新应用也能保持生效。</p>
<p>隐蔽性好 系统源码的修改不依赖第三方框架或工具，特征难以被检测，尤其适用于对抗高级检测手段。</p>
<h3 data-id="heading-3">修改方式</h3>
<p>修改以及新增函数 <code>bionic\libc\upstream-openbsd\lib\libc\string\strstr.c</code>  新增函数myStrstr，contains_keyword</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 新增如下代码，实现自己strstr函数</span>
#define MAX_KEYWORDS <span class="hljs-number">8</span>
 
<span class="hljs-comment">/* 特定关键词 */</span>
<span class="hljs-keyword">const</span> char* keywords[MAX_KEYWORDS] = {<span class="hljs-string">"libfrida"</span>, <span class="hljs-string">"frida-"</span>,<span class="hljs-string">"/sbin/.magisk"</span>, <span class="hljs-string">"/sbin/.core/mirror"</span>, <span class="hljs-string">"/magisk.db"</span>, <span class="hljs-string">" su"</span>, <span class="hljs-string">"bin/su"</span>, <span class="hljs-string">"lsposed"</span>};
 
char *
myStrstr(<span class="hljs-keyword">const</span> char *h, <span class="hljs-keyword">const</span> char *n)
{
    <span class="hljs-comment">/* Return immediately on empty needle */</span>
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> (char *)h;
 
    <span class="hljs-comment">/* Use faster algorithms for short needles */</span>
    h = strchr(h, *n);
    <span class="hljs-keyword">if</span> (!h || !n[<span class="hljs-number">1</span>]) <span class="hljs-keyword">return</span> (char *)h;
    <span class="hljs-keyword">if</span> (!h[<span class="hljs-number">1</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">2</span>]) <span class="hljs-keyword">return</span> twobyte_strstr((void *)h, (void *)n);
    <span class="hljs-keyword">if</span> (!h[<span class="hljs-number">2</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">3</span>]) <span class="hljs-keyword">return</span> threebyte_strstr((void *)h, (void *)n);
    <span class="hljs-keyword">if</span> (!h[<span class="hljs-number">3</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">4</span>]) <span class="hljs-keyword">return</span> fourbyte_strstr((void *)h, (void *)n);
 
    <span class="hljs-keyword">return</span> twoway_strstr((void *)h, (void *)n);
}
 
<span class="hljs-comment">/* 检查是否包含特定关键词 */</span>
int contains_keyword(<span class="hljs-keyword">const</span> char *str) {
    <span class="hljs-comment">// ALOGI("full-keyword %s", str);</span>
    clogi(<span class="hljs-string">"contains_keyword"</span>, str);
    <span class="hljs-keyword">if</span> (isuseruid() == <span class="hljs-number">0</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; MAX_KEYWORDS; i++) {
        <span class="hljs-keyword">if</span> (myStrstr(str, keywords[i])) {
            char buffer[<span class="hljs-number">256</span>];
            snprintf(buffer, sizeof(buffer), <span class="hljs-string">"%s detect keyword: %s return null"</span>, str, keywords[i]);
            clogi(<span class="hljs-string">"contains_keyword"</span>, buffer);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 找到关键词</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 未找到关键词</span>
}
 
<span class="hljs-comment">// 修改函数行为，当遇到对应关键词则返回0 以此脱离敏感词查询</span>
char *
strstr(<span class="hljs-keyword">const</span> char *h, <span class="hljs-keyword">const</span> char *n)
{
    <span class="hljs-comment">/* Return immediately on empty needle */</span>
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> (char *)h;
 
    <span class="hljs-comment">// 这里添加上字符串判断</span>
    <span class="hljs-keyword">if</span> (contains_keyword(n)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
 
    <span class="hljs-comment">/* Use faster algorithms for short needles */</span>
    h = strchr(h, *n);
    <span class="hljs-keyword">if</span> (!h || !n[<span class="hljs-number">1</span>]) <span class="hljs-keyword">return</span> (char *)h;
    <span class="hljs-keyword">if</span> (!h[<span class="hljs-number">1</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">2</span>]) <span class="hljs-keyword">return</span> twobyte_strstr((void *)h, (void *)n);
    <span class="hljs-keyword">if</span> (!h[<span class="hljs-number">2</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">3</span>]) <span class="hljs-keyword">return</span> threebyte_strstr((void *)h, (void *)n);
    <span class="hljs-keyword">if</span> (!h[<span class="hljs-number">3</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!n[<span class="hljs-number">4</span>]) <span class="hljs-keyword">return</span> fourbyte_strstr((void *)h, (void *)n);
 
    <span class="hljs-keyword">return</span> twoway_strstr((void *)h, (void *)n);
}
DEF_STRONG(strstr);
</code></pre>
<p>修改string.h头文件声明, <code>bionic\libc\include\string.h</code> 增加</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">strdup</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* __s)</span></span>;
<span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">myStrstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* __haystack, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* __needle)</span></span>; <span class="hljs-comment">//新增 </span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">contains_keyword</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)</span></span>; <span class="hljs-comment">// 新增</span>
<span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">strstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* __haystack, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* __needle)</span> __attribute_pure__</span>;
</code></pre>
<p>执行编译 <code>make -j4</code></p>
<p>最终实现效果
libc.so文件新增符号myStrstr，contains_keyword</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e359fce5b4842ada88271b3248bc620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Za1MjIz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518756&amp;x-signature=yEtxj8W5AOw6mDVy13QB0i9siu4%3D" alt="image.png" loading="lazy"/></p>
<p>日志打印</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddff6bfd4bf54e7aaf5938a847c1ea63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Za1MjIz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518756&amp;x-signature=BpsUsAAZudF6Jlpra9wXkOCl9NU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">2.3 添加exec有关函数进行参数打印</h2>
<h3 data-id="heading-5">目的</h3>
<p>打印命令行执行函数 ，用于方便定位调试</p>
<p>修改步骤
路径 <code>&lt;aosp&gt;\bionic\libc\bionic\exec.cpp</code></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/uio.h&gt;</span></span>
 
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;paths.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span> <span class="hljs-comment">// 新增</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> <span class="hljs-comment">// 新增</span></span>
 
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"private/__bionic_get_shell_path.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"private/FdPath.h"</span></span>
 
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-type">char</span>** environ;
 
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExecVariant</span> { kIsExecL, kIsExecLE, kIsExecLP };
 
<span class="hljs-comment">// 单纯打印命令执行函数，用于调试定位分析</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">log_argv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* func_name, <span class="hljs-type">char</span>* <span class="hljs-type">const</span>* argv)</span> </span>{
  <span class="hljs-keyword">if</span> (argv == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">return</span>;
 
  <span class="hljs-built_in">clogi</span>(func_name, <span class="hljs-string">"called with argv:"</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; argv[i] != <span class="hljs-literal">nullptr</span>; ++i) {
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">256</span>];
    <span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-string">"  argv[%zu]: %s"</span>, i, argv[i]);
    <span class="hljs-built_in">clogi</span>(func_name, buffer);
  }
}
 
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __execl(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* argv0, ExecVariant variant, va_list ap) {
  <span class="hljs-comment">// Count the arguments.</span>
  va_list count_ap;
  <span class="hljs-built_in">va_copy</span>(count_ap, ap);
  <span class="hljs-type">size_t</span> n = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">va_arg</span>(count_ap, <span class="hljs-type">char</span>*) != <span class="hljs-literal">nullptr</span>) {
    ++n;
  }
  <span class="hljs-built_in">va_end</span>(count_ap);
 
  <span class="hljs-comment">// Construct the new argv.</span>
  <span class="hljs-type">char</span>* argv[n + <span class="hljs-number">1</span>];
  argv[<span class="hljs-number">0</span>] = <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(argv0);
  n = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> ((argv[n] = <span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">char</span>*)) != <span class="hljs-literal">nullptr</span>) {
    ++n;
  }
 
  <span class="hljs-comment">// Collect the argp too.</span>
  <span class="hljs-type">char</span>** argp = (variant == kIsExecLE) ? <span class="hljs-built_in">va_arg</span>(ap, <span class="hljs-type">char</span>**) : environ;
 
  <span class="hljs-built_in">va_end</span>(ap);
  <span class="hljs-comment">// 新增</span>
  <span class="hljs-built_in">log_argv</span>(<span class="hljs-string">"__execl"</span>, argv);
  <span class="hljs-keyword">return</span> (variant == kIsExecLP) ? <span class="hljs-built_in">execvp</span>(name, argv) : <span class="hljs-built_in">execve</span>(name, argv, argp);
}
 
 
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">execv</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">char</span>* <span class="hljs-type">const</span>* argv)</span> </span>{
  <span class="hljs-built_in">log_argv</span>(<span class="hljs-string">"execv"</span>, argv); <span class="hljs-comment">// 新增</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">execve</span>(name, argv, environ);
}
 
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">execvp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name, <span class="hljs-type">char</span>* <span class="hljs-type">const</span>* argv)</span> </span>{
  <span class="hljs-built_in">log_argv</span>(<span class="hljs-string">"execvp"</span>, argv); <span class="hljs-comment">// 新增</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">execvpe</span>(name, argv, environ);
}
</code></pre>
<p>实现效果</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c1797d0faf5491d919ccf14435b1011~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Za1MjIz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518756&amp;x-signature=XK42pg0X7kZpKf7Hfd6zjABAU7A%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI吞噬软件]]></title>    <link>https://juejin.cn/post/7571404524792741923</link>    <guid>https://juejin.cn/post/7571404524792741923</guid>    <pubDate>2025-11-12T03:21:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571404524792741923" data-draft-id="7571404524792660003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI吞噬软件"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2025-11-12T03:21:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI吞噬软件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:21:14.000Z" title="Wed Nov 12 2025 03:21:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dtlarson.com%2Ffeed-the-beast" target="_blank" title="https://www.dtlarson.com/feed-the-beast" ref="nofollow noopener noreferrer">转载</a></p>
<p><strong>作者：Derek Larson</strong></p>
<p>我在布鲁克林和朋友一起吃越南河粉。</p>
<p>他告诉我，他的CEO——一个从未写过一行代码的人——正在用AI代码编辑器运营他们的公司。</p>
<p>我差点从椅子上摔下来。</p>
<p>当然。我怎么没想到这一点。</p>
<p>从那以后，我几乎抛弃了所有的生产力工具。</p>
<p>ChatGPT、Notion、Todoist、Airtable、Google Keep、Perplexity、我的CRM。全都不要了。</p>
<p>起初感觉像是失去了一只肢体。其中一些工具我用了将近十年。</p>
<p>现在，我的工作围绕着文本文件展开。</p>
<h3 data-id="heading-0">旧方式：适应软件</h3>
<p>软件界面强迫我们接受它们的思维方式。</p>
<p>Notion要求层次结构，CRM要求结构化字段，ChatGPT有聊天线程。</p>
<p>所有这些都需要点击、学习界面，以及在工具之间复制粘贴。</p>
<h3 data-id="heading-1">新方式：饲养猛兽</h3>
<p>"我使用AI" -&gt; "AI使用我的数据"。</p>
<p>Claude Code是我组织工作生活的核心。</p>
<p>一个可以在我的电脑上读写文件的AI。</p>
<p>我的角色是确保它拥有所需的数据。</p>
<p>待办事项、会议记录、路线图、规格说明、理念、邮件、文章等等。</p>
<p>我给予的越多，AI就能提供越多的帮助。</p>
<p>人们高估了AI在写作方面的价值，低估了它在阅读方面的价值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5369168cbc4c47b0943ab1c519247f48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522474&amp;x-signature=vpg8FAlpYABEMl3EYmKbCvvwUSU%3D" alt="Claude Code in action" loading="lazy"/></p>
<p>每个文件都是@符号的距离。Claude读取、推理和编辑</p>
<h3 data-id="heading-2">示例1：我应该向谁寻求帮助？</h3>
<p>网络搜索是我最喜欢的Claude Code用例之一。</p>
<p>我创建了一个自定义斜杠命令来搜索我的人脉网络。</p>
<p>步骤1：我在命令行中输入"/network"</p>
<p>然后Claude：</p>
<ol>
<li>读取我的待办事项和路线图</li>
<li>预测我需要什么帮助</li>
<li>在我的人脉网络中搜索匹配项</li>
<li>建议我应该联系谁</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fef45006e6154a2caa5255ca24bb369f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522474&amp;x-signature=rQqhu%2FcJpI5SjPczx%2FNIClhCTOM%3D" alt="Network search results showing matching contacts and their overlap" loading="lazy"/></p>
<p>Claude读取我的任务，然后在我的人脉网络中搜索相关联系</p>
<p>然后我得到一个包含10-20个首选联系人、他们如何重叠以及联系信息的列表。</p>
<h3 data-id="heading-3">示例2：每周回顾</h3>
<p>在使用Claude Code之前，我讨厌做每周回顾。</p>
<p>80%的时间我都会跳过，尽管它们能带来清晰度。</p>
<h4 data-id="heading-4">旧方式</h4>
<p>在5个软件工具之间切换来找到我需要的数据。</p>
<p>在Notion文档中写作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb2753b89544f72a7c2a69873400f28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522474&amp;x-signature=xFRA%2F6cJXF0BxXUylg22omPvCHE%3D" alt="Weekly review in Notion showing scattered data across tools" loading="lazy"/></p>
<h4 data-id="heading-5">新方式</h4>
<p>我从Claude Code运行"/weekly"。</p>
<ol>
<li>Claude查看自上周以来的每个文件变更</li>
<li>Claude评估项目、任务和路线图的状态</li>
<li>我们进行对话深入探讨并做出决策</li>
<li>Claude生成一个文档，总结我们商定的周回顾和计划</li>
</ol>
<h4 data-id="heading-6">运行/weekly</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29296dbb320144ad843f414d8456f611~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522474&amp;x-signature=dEhN%2B1RowBP099lUNrQvqPN9jTM%3D" alt="Claude Code running the weekly review command" loading="lazy"/></p>
<p>Claude分析一周的文件变更和任务</p>
<p>Claude发现我遗漏的事情、我拖延的工作，并创建一个空间来倾倒我脑海中的一切。</p>
<p>然后它更新文件为新的一周做准备。</p>
<h4 data-id="heading-7">输出回顾：</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8754b7497f5841e2a1f941259cfbc2fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522474&amp;x-signature=FmSuFXtgWmxExMw8ABz9f8nGnzk%3D" alt="Generated weekly review document with insights and action items" loading="lazy"/></p>
<p>每周回顾文档被写入我的项目文件夹</p>
<p>现在每周回顾成了我期待的事情。</p>
<h3 data-id="heading-8">示例3：夜间助理</h3>
<p>常见惯例：醒来，检查邮件、Slack、日历、CRM、Linear、产品指标、Github PR等。</p>
<p>然后分心和不知所措。</p>
<p>相反，Claude在我睡觉时检查一切（通过Github Actions + MCPs）：</p>
<p>• 准备会议简报（过去的对话 + 公司研究 + 邮件历史）
• 筛选可能表明问题的产品指标和支持工单
• 查看所有入站数据和现有任务，帮助确定当天优先级</p>
<p>当Claude完成综合分析后，它会创建一个包含其发现和建议后续步骤的pull request。</p>
<h3 data-id="heading-9">失败模式</h3>
<h4 data-id="heading-10">1：早期阶段，粗糙边缘</h4>
<p>"AI队友"还没有到来。</p>
<p>AI基础设施仍然处于萌芽阶段，设置通常很痛苦。</p>
<p>我将Claude限制在面向内部的操作（例如，起草邮件是可以的，但发送就不行）。</p>
<h4 data-id="heading-11">2：无差别的放大器</h4>
<p>有了AI，你可以以创纪录的速度跑下悬崖（或进入应许之地）。</p>
<p>不需要编辑、联合创始人、治疗师或员工。</p>
<p>如果你在创造没人想要的东西，AI会加速这个过程。</p>
<p>如果你朝着正确的方向前进，AI会加速这个过程。</p>
<h4 data-id="heading-12">3：AI黑洞</h4>
<p>如果我连续45分钟问一个人"这封邮件草稿好吗"，他们会把我的电脑扔到墙上。AI会毫无怨言地配合。</p>
<p>解决方案不是要求"诚实的反馈"——而是认识到你何时陷入了AI黑洞并抽身而出。</p>
<h3 data-id="heading-13">入门指南</h3>
<ol>
<li><strong>安装Claude Code</strong> - 每月20美元起</li>
<li><strong>创建本地项目文件夹</strong> - Cursor和/或Obsidian非常适合编辑文件</li>
<li><strong>将所有内容倾倒入文件夹</strong> - 将文档、笔记、待办事项复制到.md文件中</li>
<li><strong>从终端初始化Claude</strong> - 导航到文件夹，在终端中输入"claude"，按回车</li>
<li><strong>示例第一个命令</strong>："读取所有这些文件并解释我在做什么"</li>
<li><strong>从那里扩展</strong> - 要求Claude组织、编写CLAUDE.md文件、创建斜杠命令、Git/Obsidian同步、schedule tasks等</li>
<li><strong>通过MCP接入外部数据</strong> - Slack、HubSpot、Gmail、Stripe等。我喜欢Rube</li>
</ol>
<p>你可以在这个Github Repo中复制我的命令和文件结构</p>
<h3 data-id="heading-14">AI代理即将到来</h3>
<p>我启发了一位CEO（40人创业公司）用文本文件运营他的业务。</p>
<p>他的整个团队都在使用Claude Code。</p>
<p>客户反馈、销售电话、支持工单、用户研究、错误报告——所有内容都被扔进大锅中。AI负责组织和连接数据。</p>
<p>他的评论："我们正在赋能有朝一日会运营公司的AI代理"</p>
<h3 data-id="heading-15">自主代理</h3>
<p>"我使用软件" → "我使用AI" → "AI使用我的数据"</p>
<p>对大多数人来说，他们仍然是催化剂。</p>
<p>他们醒来，搜索文件，编写提示，复制粘贴数据，观察AI工作，提供反馈，复制粘贴结果。</p>
<p>但这正在改变。</p>
<p>AI进步的一个衡量标准：AI可以在没有监督的情况下做有用工作多长时间？</p>
<p>自从有了Claude Code：</p>
<p>• 拥有我所有的数据
• 可以搜索互联网
• 了解我的待办事项和目标
• 可以规划和查找文件</p>
<p>它可以在没有我的情况下开始我的任务。</p>
<p>在我早上醒来之前。</p>
<p>猛兽饥饿。好好饲养它。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[faster-whisper本地转录简单方案]]></title>    <link>https://juejin.cn/post/7571427088071376922</link>    <guid>https://juejin.cn/post/7571427088071376922</guid>    <pubDate>2025-11-12T05:50:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571427088071376922" data-draft-id="7571278865516904498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="faster-whisper本地转录简单方案"/> <meta itemprop="keywords" content="OpenAI,GitHub,开源"/> <meta itemprop="datePublished" content="2025-11-12T05:50:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mortimer"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704623992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            faster-whisper本地转录简单方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704623992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mortimer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:50:19.000Z" title="Wed Nov 12 2025 05:50:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你正在寻找一个完全免费、在自己电脑上运行、并且转录效果顶尖的语音转字幕工具，那么你来对地方了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eae44428689947a3a52eeee4728ddba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=J4osJbAk3Rc3%2F%2FH6Gn847tQ5UyY%3D" alt="效果和使用如图" loading="lazy"/></p>
<p>这份教程会手把手带你完成所有设置，过程非常简单！</p>
<h2 data-id="heading-0">第一部分：准备工作（如果已有uv和ffmpeg可跳过该部分）</h2>
<p>在正式开始前，我们需要给电脑请来两位“小助手”：<code>uv</code> 和 <code>ffmpeg</code>。别担心，这很简单！</p>
<h3 data-id="heading-1"><strong>步骤 1：安装 uv</strong></h3>
<p><code>uv</code> 就像一个聪明的管家，它能帮我们自动搞定所有复杂的程序配置，我们只需要一个简单的命令就行。</p>
<ul>
<li>
<p><strong>下载地址：</strong>
Windows 用户请点击这里下载 <code>uv</code>：
<code>https://github.com/astral-sh/uv/releases/download/0.9.8/uv-x86_64-pc-windows-msvc.zip</code></p>
</li>
<li>
<p><strong>操作步骤：</strong></p>
<ol>
<li>下载后，解压这个 <code>uv-x86_64-pc-windows-msvc.zip</code> 压缩包。你会看到 <code>uv.exe</code> 等几个文件。</li>
<li>现在，我们需要把这个“管家”放到一个系统能随时找到的地方。打开电脑的任意文件夹，在顶部的地址栏里，<strong>清空原有路径</strong>，然后输入 <code> %userprofile%\.local\bin</code> 并按回车键。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e68779e635d2491687b7b332bfcb27fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=6lFurqZAeFaZ3Aat7KPmkue8U%2BQ%3D" alt="在文件地址栏输入特定路径" loading="lazy"/></li>
<li>把刚才解压出来的 <code>uv.exe</code> 等所有文件，<strong>全部复制粘贴</strong>到这个新打开的文件夹里。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6b2b39678164787b277346f3109fed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=tfrW9Ws2FKcanOnojODtZYItIvo%3D" alt="将uv.exe文件粘贴到指定路径" loading="lazy"/></li>
</ol>
</li>
<li>
<p><strong>小贴士：</strong> 这一步是为了让电脑“记住” <code>uv</code> 在哪里，以后我们就能在任何地方直接使唤它了！</p>
</li>
<li>
<p><em>（如果你是 Mac 用户，操作更简单，只需在终端里运行 <code>wget -qO- https://astral.sh/uv/install.sh | sh</code> 即可。）</em></p>
</li>
</ul>
<h3 data-id="heading-2"><strong>步骤 2：安装 ffmpeg</strong></h3>
<p><code>ffmpeg</code> 是一个处理音视频的万能工具，我们的程序需要用它来读取你上传的任何音频或视频文件。</p>
<ul>
<li>
<p><strong>下载地址：</strong>
Windows 用户请点击这里下载 <code>ffmpeg</code>：
<code>https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full.7z</code></p>
</li>
<li>
<p><strong>操作步骤：</strong></p>
<ol>
<li>下载后，解压这个 <code>ffmpeg-release-full.7z</code> 压缩包。</li>
<li>进入解压后的文件夹（名字类似 <code>ffmpeg-x.x.x-full_build</code>），找到里面的 <code>bin</code> 文件夹。</li>
<li>在 <code>bin</code> 文件夹里，你会看到一个 <code>ffmpeg.exe</code> 文件。把它<strong>复制</strong>出来。</li>
<li>将这个 <code>ffmpeg.exe</code> 文件，粘贴到我们刚才存放 <code>uv.exe</code> 的<strong>同一个文件夹</strong>里（也就是 <code>%userprofile%\.local\bin</code> 那个）。</li>
</ol>
</li>
<li>
<p><em>（如果你是 Mac 用户，同样很简单，在终端里运行 <code>brew install ffmpeg</code> 就行了。）</em></p>
</li>
</ul>
<h3 data-id="heading-3">仍然提示 uv 或 ffmpeg 未找到怎么办？</h3>
<blockquote>
<p>打开一个新的cmd，输入<code>uv</code>，如果提示未找到，说明 <code>%userprofile%/.local/bin</code>不在环境变量中</p>
</blockquote>
<p>点开左下角“开始菜单”找到 "命令行提示符"，右键--&gt;更多---&gt;以管理员身份运行，粘贴这个命令，回车执行</p>
<p><code>reg add "HKCU\Environment" /v Path /t REG_EXPAND_SZ /d "%PATH%;%USERPROFILE%\.local\bin" /f</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7ee9ed103aa4059a54843b299eec2ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=cIZFPZXUIwbKepZ9VzT%2FZWD9M4k%3D" alt="" loading="lazy"/></p>
<p><strong>太棒了！</strong> 最关键的准备工作已经完成。这两个工具只需要安装这一次，以后就再也不用管了。</p>
<h2 data-id="heading-4">第二部分：下载程序与模型</h2>
<p>现在，我们来下载转录工具本身。</p>
<h3 data-id="heading-5"><strong>步骤 1：下载主程序</strong></h3>
<ul>
<li>
<p><strong>下载地址：</strong> <code>https://pyvideotrans.com/stt.7z</code> (约600KB)</p>
</li>
<li>
<p><strong>操作步骤：</strong></p>
<ol>
<li>点击上面的链接下载 <code>stt.7z</code> 压缩包。</li>
<li>把它解压到你喜欢的位置，比如桌面。解压后你会得到一个文件夹<code>models</code>和 <code>app.py</code> 、 <code>index.html</code> 文件。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ccef29a1991417dbce0f613ee7045d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=%2F450GVP74tUIhV8hs55aPXpDcNk%3D" alt="" loading="lazy"/></li>
</ol>
</li>
</ul>
<h3 data-id="heading-6"><strong>步骤 2：下载核心模型</strong></h3>
<p>模型就是这个工具的“大脑”，负责识别语音。</p>
<ul>
<li><strong>下载模型国内：</strong> <code>https://hf-mirror.com/dropbox-dash/faster-whisper-large-v3-turbo/resolve/main/model.bin?download=true</code></li>
<li><strong>下载模型墙外：</strong> <code>https://huggingface.co/dropbox-dash/faster-whisper-large-v3-turbo/resolve/main/model.bin?download=true</code></li>
<li><strong>操作步骤：</strong>
<ol>
<li>点击链接下载这个 <code>model.bin</code> 文件（文件1.6G，请耐心等待）。</li>
<li>下载完成后，把它移动到我们刚才解压的程序文件夹里。具体路径是：进入程序文件夹 -&gt; 进入 <code>models</code> 文件夹 -&gt; 进入 <code>turbo</code> 文件夹，然后把 <code>model.bin</code> <strong>放进这个 <code>turbo</code> 文件夹里</strong>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec0f443bc8540d9a0b0a21ab9135ef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=Bqe%2FXcA9iBQpU3EYjodCjzG0fj8%3D" alt="" loading="lazy"/></li>
</ol>
</li>
</ul>
<h2 data-id="heading-7">第三部分：启动与使用</h2>
<ol>
<li>
<p>打开我们刚才解压的程序文件夹。</p>
</li>
<li>
<p>在文件夹顶部的地址栏里，<strong>清空所有内容</strong>，输入 <code>cmd</code>，然后按回车键。这会弹出一个黑色窗口。</p>
</li>
<li>
<p>在黑色窗口里，输入下面的命令，然后按回车键：
uv run app.py
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14760a7cac9448e18dfbf3adade41e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=LnJNUNtSTOLKdHvNjIL48C%2BmWu8%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>稍等片刻，当窗口里显示出类似下面的信息时，就代表服务启动成功了！<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba4fc658b06f4fc39bd228ee11394a23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=vHHBRoROtxp7BUqOTVH0cSWK9gY%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>同时，你的默认浏览器会自动打开一个新页面，这就是我们的语音转录工具界面！<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0bacb4b03b04f5e841e9e1a3b873374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9ydGltZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763531419&amp;x-signature=O5gkvjGK1z40wq%2BhGSmAWC1Rplc%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<p>现在，你就可以点击或拖拽你的音频/视频文件上去，调整参数，然后点击“提交转录”来体验了！祝你使用愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0智能体开发：人机协作]]></title>    <link>https://juejin.cn/post/7571429745230266404</link>    <guid>https://juejin.cn/post/7571429745230266404</guid>    <pubDate>2025-11-12T03:53:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571429745230266404" data-draft-id="7571404524792807459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0智能体开发：人机协作"/> <meta itemprop="keywords" content="Agent,LangChain,Python"/> <meta itemprop="datePublished" content="2025-11-12T03:53:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0智能体开发：人机协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:53:42.000Z" title="Wed Nov 12 2025 03:53:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>智能体能自主决策任务的执行，但有时人工介入是必要的。LangChain提供了人工协作中间件支持智能体的人工介入功能。阅读本文您将获得：</p>
<ul>
<li>LangChain人工协作中断支持的决策类型</li>
<li>LangChain人工协作如何配置中断</li>
<li>LangChain人工协作如何响应中断</li>
<li>LangChain人工协作的执行生命周期</li>
<li>LangChain自定义人工协作逻辑</li>
</ul>
</blockquote>
<p>LangChain提供了人工协作<code>HumanInTheLoopMiddleware</code>中间件。
人工协作（Human-in-the-Loop，简称 HITL）中间件可让你在【智能体工具调用过程中】加入人工监督环节。当模型提出可能需要审核的操作（例如写入文件或执行SQL语句）时，该中间件能够暂停执行流程，等待人工决策。
其实现原理是通过可配置策略对每一次工具调用进行检查。若需要人工介入，中间件会触发【中断信号】以终止当前执行。此时，图状态会通过LangGraph的持久化层保存，确保执行流程可安全暂停，并在后续重新启动。
之后，人工决策将决定后续操作方向：该行动可按原计划批准执行（“批准”）、修改后再运行（“编辑”），或结合反馈意见予以拒绝（“拒绝”）。</p>
<h2 data-id="heading-0">1、中断决策类型</h2>
<p>人工协作中间件定义了三种内置的人工响应中断的方式：</p>

























<table><thead><tr><th>决策类型</th><th>说明</th><th>示例场景</th></tr></thead><tbody><tr><td>✅ 批准（approve）</td><td>行动按原样获批并直接执行，无需修改</td><td>完全按照撰写内容发送邮件草稿</td></tr><tr><td>✏️ 编辑（edit）</td><td>工具调用经修改后执行</td><td>发送邮件前修改收件人</td></tr><tr><td>❌ 拒绝（reject）</td><td>工具调用被拒绝，且需在对话中添加拒绝说明</td><td>拒绝某封邮件草稿，并说明应如何重写</td></tr></tbody></table>
<p>每种工具可用的决策类型，取决于你在 “interrupt_on”（中断触发条件）中配置的策略。当多个工具调用同时处于暂停状态时，每个行动都需要单独决策。决策的提供顺序必须与中断请求中行动的显示顺序一致。在编辑工具参数时，应谨慎修改。对原始参数进行大幅调整，可能会导致模型重新评估其执行思路，进而可能出现工具被多次执行或触发意外操作的情况。</p>
<h2 data-id="heading-1">2、配置中断</h2>
<p>若要使用人工协作（HITL）功能，需在创建智能体时，将该中间件添加到智能体的中间件列表中。
你需要通过一种 “工具操作 - 决策类型” 映射关系来配置该中间件：为每种工具操作指定允许的决策类型。当某次工具调用与映射关系中的某一操作匹配时，中间件就会中断执行流程。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> HumanInTheLoopMiddleware 
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver 

agent = create_agent(
    model=<span class="hljs-string">"gpt-4o"</span>,
    tools=[write_file_tool, execute_sql_tool, read_data_tool],
    middleware=[
        HumanInTheLoopMiddleware( 
            interrupt_on={
                <span class="hljs-string">"write_file"</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># All decisions (approve, edit, reject) allowed</span>
                <span class="hljs-string">"execute_sql"</span>: {<span class="hljs-string">"allowed_decisions"</span>: [<span class="hljs-string">"approve"</span>, <span class="hljs-string">"reject"</span>]},  <span class="hljs-comment"># No editing allowed</span>
                <span class="hljs-comment"># Safe operation, no approval needed</span>
                <span class="hljs-string">"read_data"</span>: <span class="hljs-literal">False</span>,
            },
            <span class="hljs-comment"># Prefix for interrupt messages - combined with tool name and args to form the full message</span>
            <span class="hljs-comment"># e.g., "Tool execution pending approval: execute_sql with query='DELETE FROM...'"</span>
            <span class="hljs-comment"># Individual tools can override this by specifying a "description" in their interrupt config</span>
            description_prefix=<span class="hljs-string">"Tool execution pending approval"</span>,
        ),
    ],
    <span class="hljs-comment"># Human-in-the-loop requires checkpointing to handle interrupts.</span>
    <span class="hljs-comment"># In production, use a persistent checkpointer like AsyncPostgresSaver.</span>
    checkpointer=InMemorySaver(),  
)
</code></pre>
<p>必须配置一个检查点（checkpointer），以在中断期间持久化保存图状态（graph state）。在生产环境中，应使用具备持久化功能的检查点工具，例如AsyncPostgresSaver；若用于测试或原型开发，可使用InMemorySaver。调用智能体时，需传入包含线程ID（thread ID）的配置，使执行流程与对话线程相关联。</p>
<h2 data-id="heading-2">3、响应中断（Responding to Interrupts）</h2>
<p>调用智能体后，智能体将持续运行，直至任务完成或触发中断。当某次工具调用与你在 “interrupt_on”（中断触发条件）中配置的策略相匹配时，中断即会被触发。在此情况下，调用结果中将包含一个 “interrupt” 字段，该字段内会列出需要审核的操作。之后，你可将这些操作呈现给审核人员，待获取决策意见后，即可恢复执行流程。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> HumanInTheLoopMiddleware
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base

<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>():
    model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0.7</span>,
    )
    <span class="hljs-keyword">return</span> model

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_email</span>(<span class="hljs-params">recipient: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Send an email to the specified recipient."""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Email sent to <span class="hljs-subst">{recipient}</span> with content: <span class="hljs-subst">{content}</span>"</span>

agent = create_agent(
            model=init_model(),
            tools=[send_email], 
            middleware=[HumanInTheLoopMiddleware(
                interrupt_on={
                    <span class="hljs-comment"># Require approval for sensitive operations</span>
                    <span class="hljs-string">"send_email"</span>: <span class="hljs-literal">True</span>,
                    <span class="hljs-string">"delete_database"</span>: <span class="hljs-literal">True</span>,
                    <span class="hljs-comment"># Auto-approve safe operations</span>
                    <span class="hljs-string">"search"</span>: <span class="hljs-literal">False</span>,
                })
                ],
            <span class="hljs-comment"># Persist the state across interrupts</span>
            checkpointer=InMemorySaver(),
)

<span class="hljs-comment"># Human-in-the-loop requires a thread ID for persistence</span>
config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"001"</span>}}

<span class="hljs-comment"># Agent will pause and wait for approval before executing sensitive tools</span>
result = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Send an email to the team, tell them we will be back in 2 hours"</span>}]},
    config=config
)
interrupts = result.get(<span class="hljs-string">"__interrupt__"</span>, <span class="hljs-string">"No interrupt"</span>)
<span class="hljs-keyword">if</span> interrupts != <span class="hljs-string">"No interrupt"</span>:
    <span class="hljs-keyword">for</span> interrupt <span class="hljs-keyword">in</span> interrupts:
        action_requests = interrupt.value.get(<span class="hljs-string">"action_requests"</span>, [])
        review_configs = interrupt.value.get(<span class="hljs-string">"review_configs"</span>, [])
        <span class="hljs-keyword">for</span> action_request <span class="hljs-keyword">in</span> action_requests:
            tool_name = action_request[<span class="hljs-string">'name'</span>]
            tool_args = action_request[<span class="hljs-string">'args'</span>]
            msg = action_request[<span class="hljs-string">'description'</span>]
            <span class="hljs-built_in">print</span>(msg)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"需要审批的操作: <span class="hljs-subst">{tool_name}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"操作参数: <span class="hljs-subst">{tool_args}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">30</span> + <span class="hljs-string">"人工审批"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">40</span> )
human_decision = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的审批意见（approve/reject/edit）: "</span>)

<span class="hljs-keyword">if</span> human_decision == <span class="hljs-string">"approve"</span>:
    <span class="hljs-comment"># 批准</span>
    result = agent.invoke(
        Command(resume={<span class="hljs-string">"decisions"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"approve"</span>}]}),
        config=config  <span class="hljs-comment"># Same thread ID to resume the paused conversation</span>
    )
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">'messages'</span>])
<span class="hljs-keyword">elif</span> human_decision == <span class="hljs-string">"edit"</span>:
    <span class="hljs-comment"># 编辑</span>
    result = agent.invoke(
        Command(resume={<span class="hljs-string">"decisions"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"edit"</span>, <span class="hljs-string">"edited_action"</span>: {
                            <span class="hljs-comment"># Tool name to call. Will usually be the same as the original action.</span>
                            <span class="hljs-string">"name"</span>: <span class="hljs-string">"send_email"</span>,
                            <span class="hljs-comment"># Arguments to pass to the tool.</span>
                            <span class="hljs-string">"args"</span>: {<span class="hljs-string">"recipient"</span>: <span class="hljs-string">"team@xxxx.com"</span>, <span class="hljs-string">"content"</span>: tool_args[<span class="hljs-string">'content'</span>]},}
                            }]}),
        config=config  <span class="hljs-comment"># Same thread ID to resume the paused conversation</span>
    )
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">'messages'</span>])
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># 拒绝</span>
    result = agent.invoke(
        Command(resume={<span class="hljs-string">"decisions"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"reject"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">"已拒绝执行发送邮件。"</span>}]}),
        config=config  <span class="hljs-comment"># Same thread ID to resume the paused conversation</span>
    )
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">'messages'</span>])
</code></pre>
<h2 data-id="heading-3">4、执行生命周期（Execution Lifecycle）</h2>
<p>人工协作中间件定义了一个模型后钩子（after_model hook），此钩子会在模型生成响应之后、任何工具调用执行之前运行，具体流程如下：</p>
<ul>
<li>智能体调用模型以生成响应。</li>
<li>中间件检查响应中是否包含工具调用。</li>
<li>若存在任何需要人工输入的调用，中间件会构建一个包含 “操作请求”（action_requests）和 “审核配置”（review_configs）的 HITL 请求（HITLRequest），并触发中断。</li>
<li>智能体等待人工决策。</li>
<li>根据HITL响应（HITLResponse）中的决策结果，中间件执行已批准（approved）或已编辑（edited）的调用，为已拒绝（rejected）的调用生成工具消息（ToolMessage），随后恢复执行流程。</li>
</ul>
<h2 data-id="heading-4">5、自定义HITL逻辑</h2>
<p>对于更具特殊性的工作流，你可以直接借助 “中断原语”（interrupt primitive）和 “中间件抽象层”（middleware abstraction）构建自定义HITL逻辑。
请先参考上文所述的 “执行生命周期”，理解如何将中断功能集成到智能体的运行流程中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第四章(路由导航)]]></title>    <link>https://juejin.cn/post/7571427088071393306</link>    <guid>https://juejin.cn/post/7571427088071393306</guid>    <pubDate>2025-11-12T05:52:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571427088071393306" data-draft-id="7571427088071360538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第四章(路由导航)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T05:52:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第四章(路由导航)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:52:19.000Z" title="Wed Nov 12 2025 05:52:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">路由导航</h2>
<p>路由导航是指我们在Next.js中跳转页面的方式，例如原始的<code>&lt;a&gt;</code>标签，等。</p>
<p>在Next.js中，共有四种方式提供跳转:</p>
<ul>
<li><code>Link</code>组件</li>
<li><code>useRouter</code> Hook (客户端组件)</li>
<li><code>redirect</code>函数 (服务端组件)</li>
<li><code>History API</code> (浏览器API <strong>本文略过用的不多</strong> 了解即可)</li>
</ul>
<h3 data-id="heading-1">Link组件</h3>
<p><code>&lt;Link&gt;</code>是一个内置组件，在a标签的基础上扩展了功能，并且还能用来实现预获取(prefetching)，以及保持滚动位置(scroll)等。</p>
<h4 data-id="heading-2">基本用法</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span> <span class="hljs-comment">//引入Link组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/about"</span>&gt;</span>跳转About页面<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{{pathname:</span> "/<span class="hljs-attr">about</span>", <span class="hljs-attr">query:</span> {<span class="hljs-attr">name:</span> "<span class="hljs-attr">张三</span>"}}}&gt;</span>跳转About并且传入参数<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/page"</span> <span class="hljs-attr">prefetch</span>=<span class="hljs-string">{true}</span>&gt;</span>预获取page页面<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/xm"</span> <span class="hljs-attr">scroll</span>=<span class="hljs-string">{true}</span>&gt;</span>保持滚动位置<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/daman"</span> <span class="hljs-attr">replace</span>=<span class="hljs-string">{true}</span>&gt;</span>替换当前页面<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-3">支持动态渲染</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">page</span>/${<span class="hljs-attr">item</span>}`}&gt;</span>动态渲染的Link<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
    ))
}
</code></pre>
<h3 data-id="heading-4">useRouter Hook</h3>
<p>useRouter 可以在代码中根据逻辑跳转页面，例如根据用户权限跳转不同的页面。</p>
<p>使用该hook需要在客户端组件中。需要在顶层编写 <code>'use client'</code> 声明这是客户端组件。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/navigation"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push("/page")}&gt;跳转page页面<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.replace("/page")}&gt;替换当前页面<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.back()}&gt;返回上一页<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.forward()}&gt;跳转下一页<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.refresh()}&gt;刷新当前页面<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.prefetch("/about")}&gt;预获取about页面<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<h3 data-id="heading-5">redirect 函数</h3>
<p>redirect 函数可以用于服务端组件/客户端组件中跳转页面，例如根据用户权限跳转不同的页面。</p>
<p><strong>在Next.js中 redirect的状态是：307临时重定向</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { redirect } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/navigation"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
   <span class="hljs-keyword">const</span> checkLogin = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkLogin</span>()
   <span class="hljs-comment">//如果用户未登录，则跳转到登录页面</span>
   <span class="hljs-keyword">if</span> (!checkLogin) {
    <span class="hljs-title function_">redirect</span>(<span class="hljs-string">"/login"</span>)
   }
   <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
   )
}
</code></pre>
<h3 data-id="heading-6">permanentRedirect 函数</h3>
<p>permanentRedirect 跟上面的redirect的区别是：permanentRedirect是永久重定向，而redirect是临时重定向。</p>
<p><strong>在Next.js中 permanentRedirect的状态是：308永久重定向</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//用法跟redirect一样，只是状态码不同</span>
<span class="hljs-keyword">import</span> { permanentRedirect } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/navigation"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
   <span class="hljs-keyword">const</span> checkLogin = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkLogin</span>()
   <span class="hljs-keyword">if</span> (!checkLogin) {
    <span class="hljs-title function_">permanentRedirect</span>(<span class="hljs-string">"/login"</span>)
   }
}
</code></pre>
<h4 data-id="heading-7">permanentRedirect / redirect 注意事项</h4>
<ul>
<li><code>path</code> 字符串类型，表示重定向的 URL，可以是相对路径，也可以是绝对路径</li>
<li><code>type</code> 值为 <code>replace</code> （默认）或者 <code>push</code>（Server Actions 中默认），表示重定向的类型</li>
</ul>
<p><code>permanentRedirect</code> 和 <code>redirect</code> 在 Sever Actions 中会用 <code>push</code>添加到浏览器历史，在其他地方用 <code>replace</code>在浏览器历史栈中替换当前的 URL。你可以通过指定 <code>type</code>参数覆盖此行为。</p>
<p>注意：在服务端组件中使用 <code>type</code>参数没有效果。</p>
<p><strong>预计学习时间</strong>: 5 分钟<br/>
<strong>难度级别</strong>: 初级 🟢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 重大更新：支持一键原生安装，彻底别了 Node.js，附Claudecode国内使用最新方式！]]></title>    <link>https://juejin.cn/post/7571378103281844230</link>    <guid>https://juejin.cn/post/7571378103281844230</guid>    <pubDate>2025-11-12T03:10:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103281844230" data-draft-id="7571348736154157092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 重大更新：支持一键原生安装，彻底别了 Node.js，附Claudecode国内使用最新方式！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T03:10:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="挽安学长"/> <meta itemprop="url" content="https://juejin.cn/user/961451815613625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 重大更新：支持一键原生安装，彻底别了 Node.js，附Claudecode国内使用最新方式！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/961451815613625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    挽安学长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:10:14.000Z" title="Wed Nov 12 2025 03:10:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Claude Code 官方最新推出原生安装方式，大大简化安装流程，让所有用户都能轻松快捷地部署这款强大的 AI 编程工具。</p>
<p>从此，您无需再为繁琐的 Node.js 环境配置而烦恼。一个安装包，一个命令，即可开启您的高效 AI 编程之旅。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ec7df8deecd4d6cad3a558c0be2a8e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oy95a6J5a2m6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521813&amp;x-signature=V7w%2F9vfEY5tYSYT7Txhv7m%2BMkWw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">原生安装：告别 Node.js</h2>
<p>原生安装依然也是官方最推荐的安装方法，并且这样安装还有多个优势：</p>
<ul>
<li>一个自包含的可执行文件，跟其他工具互不干扰</li>
<li>无 Node.js 依赖，启动速度更快</li>
<li>改进的自动更新程序稳定性更高</li>
</ul>
<p>对于已经安装 Node.js 使用 npm 方式装过 Claude Code 的用户可以用下面这行命令实现一键迁移:</p>
<pre><code class="hljs">claude install
</code></pre>
<p>如果您是初次接触 Claude Code，请根据您的操作系统选择以下对应的安装方式：</p>
<p><strong>1. macOS/Linux/WSL 用户（通用安装脚本）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//claude.ai/install.sh | bash</span>
</code></pre>
<p><strong>2. macOS/Linux 用户（使用 Homebrew）</strong></p>
<pre><code class="hljs language-css" lang="css">brew install <span class="hljs-attr">--cask</span> claude-<span class="hljs-selector-tag">code</span>
</code></pre>
<h2 data-id="heading-1"><strong>Windows</strong> 安装教程</h2>
<p><strong>步骤 1：安装 Git For Windows</strong></p>
<p>在 Windows 上原生安装 Claude Code 需要通过 Git Bash</p>
<p>Git For Windows 下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Finstall%2Fwindows" target="_blank" title="https://git-scm.com/install/windows" ref="nofollow noopener noreferrer">git-scm.com/install/win…</a></p>
<p>下载系统对应版本默认选项安装即可，验证安装命令：</p>
<pre><code class="hljs language-css" lang="css">git <span class="hljs-attr">--version</span>
</code></pre>
<p><strong>步骤 2：安装 Claude Code</strong></p>
<p>之后打开 PowerShell 或 CMD 终端运行以下安装命令即可</p>
<p>Windows PowerShell 安装命令:</p>
<pre><code class="hljs language-arduino" lang="arduino">irm https:<span class="hljs-comment">//claude.ai/install.ps1 | iex</span>
</code></pre>
<p>Windows CMD 安装命令:</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//claude.ai/install.cmd -o install.cmd &amp;&amp; install.cmd &amp;&amp; del install.cmd</span>
</code></pre>
<p><strong>步骤 3：添加 PATH 环境变量</strong></p>
<p>Claude 可执行文件所在的目录需要加入系统 PATH，否则 PowerShell 目前无法识别 claude 命令，</p>
<p>参考路径：<code>C:\Users\ 你的用户名 .local\bin</code></p>
<p>可通过以下步骤添加：打开系统属性 → 环境变量 → 编辑用户 PATH → 新建 → 添加上方的 Claude 安装路径。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca4849771db489ea6b6c5deafabb402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oy95a6J5a2m6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521813&amp;x-signature=1YJU6lUEtzmGg51ld%2FCWeNTRGsQ%3D" alt="" loading="lazy"/></p>
<p>配置完成后，重启所有终端窗口，即可通过 claude 命令启动新版 Claude Code 客户端。</p>
<h2 data-id="heading-2">配置并开始使用</h2>
<p><strong>1、注册并登录</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgaccode.com%2Fsignup%3Fref%3D19EOB4I5" target="_blank" title="https://gaccode.com/signup?ref=19EOB4I5" ref="nofollow noopener noreferrer"><strong>gaccode.com</strong></a> <strong>，创建Key。</strong></p>
<p>注册登录控制台后在 <code>API密钥</code> 页面点击 <code>右上角</code> 创建一个专属自己的 API 令牌，创建令牌时的 <strong>建议设置</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16ce7af2efed4c6abc981296ab22edec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oy95a6J5a2m6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521813&amp;x-signature=%2F%2BUj92%2F4P%2Fs6xmQY%2FpsAKov2hiU%3D" alt="" loading="lazy"/></p>
<ul>
<li>名称：随意命名</li>
<li>其他选项：全部保持默认设置</li>
</ul>
<p><strong>2、在</strong> <strong>C盘/用户/用户名/.claude路径下，修改或新建【settings.json】文件，</strong> <strong>配置文件一般位于以下目录：</strong></p>
<ul>
<li>Windows: C:\Users\ 用户文件夹 \ .claude\settings.json</li>
<li>Mac: ~/.claude/settings.json 或 .claude/settings.json</li>
<li>Linux: ~/.claude/settings.json</li>
</ul>
<p>其中写入以下配置信息，<code>ANTHROPIC_API_KEY </code>替换为你的 API 令牌。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://gaccode.com/claudecode"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"您的API秘钥"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Ubuntu/macOS 用户可通过 vi 或者 vim 命令直接创建或者修改 vim <code>settings.json</code> 文件</p>
<pre><code class="hljs language-javascript" lang="javascript">vim  ~<span class="hljs-regexp">/.claude/</span>settings.<span class="hljs-property">json</span>
</code></pre>
<p>然后在您的项目目录下输入 Claude 即可启动并运行 Claude Code：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /path/to/your/project
claude
</code></pre>
<p><strong>3、配置jq（git bash内配置，需要科学上网，大部分电脑非必须配置，若配置完第3步可正常使用claude服务，则可忽略此步）</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -L https://github.com/stedolan/jq/releases/latest/download/jq-win64.exe -o /tmp/jq.exe
<span class="hljs-built_in">mkdir</span> -p ~/bin
<span class="hljs-built_in">mv</span> /tmp/jq.exe ~/bin/jq.exe
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:~/bin
jq --version
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/505ce6bfd3fd436898e035d3ee3bcc16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oy95a6J5a2m6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521813&amp;x-signature=1fSDbZz1nwNJQBvmgUBYzF%2BAm3k%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">ANTHROPIC_BASE_URL</span>=https://gaccode.com/claudecode
export <span class="hljs-attr">ANTHROPIC_API_KEY</span>=您的API密钥
</code></pre>

<pre><code class="hljs language-bash" lang="bash">(<span class="hljs-built_in">cat</span> ~/.claude.json 2&gt;/dev/null || <span class="hljs-built_in">echo</span> <span class="hljs-string">'null'</span>) | jq --arg key <span class="hljs-string">"<span class="hljs-variable">${ANTHROPIC_API_KEY: -20}</span>"</span> <span class="hljs-string">'(. // {}) | .customApiKeyResponses.approved |= ([.[]?, $key] | unique)'</span> &gt; ~/.claude.json.tmp &amp;&amp; <span class="hljs-built_in">mv</span> ~/.claude.json.tmp ~/.claude.json
</code></pre>
<p><strong>4、运行使用Claudecode</strong></p>
<p>然后在您的项目目录下输入 Claude 即可启动并运行 Claude Code：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /path/to/your/project
claude
</code></pre>
<p>运行后如报错403提示出现“<strong>No Active Subscription</strong>” 提示联系请发送任意邮件到<a href="https://link.juejin.cn?target=mailto%3AClaudeCode%40163.com" target="_blank" title="mailto:ClaudeCode@163.com" ref="nofollow noopener noreferrer">ClaudeCode@163.com</a>即可获取权限。运行后如报错403提示出现“<strong>No Active Subscription</strong>” 提示联系请发送任意邮件到<a href="https://link.juejin.cn?target=mailto%3AClaudeCode%40163.com" target="_blank" title="mailto:ClaudeCode@163.com" ref="nofollow noopener noreferrer">ClaudeCode@163.com</a>即可获取权限。</p>
<p>要升级 Claude Code 到最新版本，只需运行相同的安装命令：</p>
<p>更新方法：npm install -g <a href="https://link.juejin.cn?target=https%3A%2F%2Fgaccode.com%2Fclaudecode%2Finstall" target="_blank" title="https://gaccode.com/claudecode/install" ref="nofollow noopener noreferrer">gaccode.com/claudecode/…</a> --registry=<a href="https://link.juejin.cn?target=https%3A%2F%2Fregistry.npmmirror.com" target="_blank" title="https://registry.npmmirror.com" ref="nofollow noopener noreferrer">registry.npmmirror.com</a></p>
<p>我们建议定期升级，定期更新可确保您获得最新功能、性能改进和错误修复。</p>
<p>此次更新清除了所有基础环境配置障碍，将 Claude Code 的安装过程简化为一步操作。我们相信，强大的 AI 工具不应有使用门槛。立即选择适合您系统的命令，体验前所未有的流畅与便捷吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 CSS4 新特性：CSS 变量]]></title>    <link>https://juejin.cn/post/7571379089992532022</link>    <guid>https://juejin.cn/post/7571379089992532022</guid>    <pubDate>2025-11-12T05:52:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089992532022" data-draft-id="7571334572768739371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 CSS4 新特性：CSS 变量"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-12T05:52:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 CSS4 新特性：CSS 变量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:52:11.000Z" title="Wed Nov 12 2025 05:52:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发的不断演进中，CSS 从最初的静态样式语言，逐渐成长为可编程、可动态更新的“样式系统”。在 <strong>CSS4（即 CSS Level 4 Modules）</strong> 的发展中，一个非常实用且颠覆传统的语法特性——<strong>CSS变量（Custom Properties）</strong> 被正式引入。<br/>
它不仅大幅提升了样式的可维护性和动态性，更为 CSS 与 JavaScript 的协作打开了新局面。</p>
<p>本文将通过示例代码，带你全面了解 CSS 变量的使用方式、原理与应用技巧。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 CSS 变量？</h2>
<p>在传统 CSS 中，我们经常会遇到类似这样的重复样式定义：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff6600</span>;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff6600</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ff6600</span>;
}
</code></pre>
<p>如果有一天需要修改颜色，就必须手动查找并替换所有出现的地方。这种重复既容易出错，又难以维护。</p>
<p>而 <strong>CSS 变量（Custom Properties）</strong> 的出现，完美解决了这个问题。<br/>
它允许我们像在 JavaScript 或 Sass 中那样，<strong>定义并复用变量</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--theme-color</span>: <span class="hljs-number">#ff6600</span>;
}

<span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--theme-color);
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--theme-color);
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--theme-color);
}
</code></pre>
<p>只要修改一次 <code>--theme-color</code> 的值，所有引用它的地方都会自动更新。</p>
<hr/>
<h2 data-id="heading-1">二、CSS 变量的基本语法</h2>
<p>CSS 变量的定义和使用都非常直观：</p>
<h3 data-id="heading-2">1. 定义变量</h3>
<p>变量需要以 <code>--</code> 开头，并且必须定义在某个选择器中，最常见的是在 <code>:root</code> 根元素上定义：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--spacing</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attr">--blur</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attr">--base</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">239</span>, <span class="hljs-number">167</span>, <span class="hljs-number">25</span>);
}
</code></pre>
<blockquote>
<p><code>:root</code> 相当于 HTML 文档的根元素（<code>&lt;html&gt;</code>），在这里定义的变量是<strong>全局变量</strong>，可在任何地方使用。</p>
</blockquote>
<h3 data-id="heading-3">2. 调用变量</h3>
<p>使用时通过 <code>var()</code> 函数访问：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">img</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">var</span>(--spacing);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--base);
  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-built_in">var</span>(--blur));
}
</code></pre>
<h3 data-id="heading-4">3. 设置默认值</h3>
<p>如果变量未定义，可以指定一个备用值：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--theme, <span class="hljs-number">#333</span>);
</code></pre>
<p>这在大型项目中非常实用，可避免由于变量未定义导致的样式错误。</p>
<hr/>
<h2 data-id="heading-5">三、CSS 变量与 JavaScript 的结合</h2>
<p>CSS 变量的另一大亮点，是可以通过 <strong>JavaScript 动态修改</strong>。<br/>
这意味着我们可以在不重新加载 CSS 文件的前提下，实现样式的实时变化。</p>
<p>以下是一个完整的示例：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;h2&gt;Update CSS Variables with &lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"hl"</span>&gt;JS&lt;/span&gt;&lt;/h2&gt;
&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;
  &lt;label <span class="hljs-attr">for</span>=<span class="hljs-string">"spacing"</span>&gt;Spacing:&lt;/label&gt;
  &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> id=<span class="hljs-string">"spacing"</span> name=<span class="hljs-string">"spacing"</span> min=<span class="hljs-string">"10"</span> max=<span class="hljs-string">"200"</span> value=<span class="hljs-string">"10"</span> data-sizing=<span class="hljs-string">"px"</span>&gt;

  &lt;label <span class="hljs-attr">for</span>=<span class="hljs-string">"blur"</span>&gt;Blur:&lt;/label&gt;
  &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> id=<span class="hljs-string">"blur"</span> name=<span class="hljs-string">"blur"</span> min=<span class="hljs-string">"0"</span> max=<span class="hljs-string">"25"</span> value=<span class="hljs-string">"10"</span> data-sizing=<span class="hljs-string">"px"</span>&gt;

  &lt;label <span class="hljs-attr">for</span>=<span class="hljs-string">"base"</span>&gt;Base Color:&lt;/label&gt;
  &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"color"</span> id=<span class="hljs-string">"base"</span> name=<span class="hljs-string">"base"</span> value=<span class="hljs-string">"#ffc600"</span>&gt;
&lt;/div&gt;

&lt;img <span class="hljs-attr">src</span>=<span class="hljs-string">"https://img1.baidu.com/it/u=1286495993,1977676821&amp;fm=253"</span>&gt;
</code></pre>
<p>在 JavaScript 中，我们可以使用 <code>document.documentElement.style.setProperty()</code> 动态修改变量：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inputs = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.controls input'</span>);
inputs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">input</span> =&gt;</span> input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, handleUpdate));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUpdate</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> suffix = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">sizing</span> || <span class="hljs-string">''</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">`--<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> + suffix);
}
</code></pre>
<p>通过这个逻辑，滑动条可以实时改变图片的间距、模糊度、背景颜色——<br/>
这在传统 CSS 中几乎是不可能做到的。</p>
<hr/>
<h2 data-id="heading-6">四、CSS 变量的优势</h2>
<h3 data-id="heading-7">1. <strong>可复用性强</strong></h3>
<p>在大型项目中，CSS 变量可以集中管理主题样式，如颜色、字号、间距等。<br/>
只需修改一处，即可影响全局，极大减少维护成本。</p>
<h3 data-id="heading-8">2. <strong>支持运行时修改</strong></h3>
<p>与 Sass 或 Less 不同，CSS 变量并不是编译时变量，而是 <strong>运行时变量</strong>。<br/>
这意味着我们可以在浏览器中动态修改它，甚至根据用户行为实时更新 UI。</p>
<h3 data-id="heading-9">3. <strong>作用域灵活</strong></h3>
<p>CSS 变量可定义在任意选择器中，不同选择器之间的变量会自动继承或覆盖：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--text-color</span>: black;
}

<span class="hljs-selector-class">.dark-mode</span> {
  <span class="hljs-attr">--text-color</span>: white;
}

<span class="hljs-selector-tag">p</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color);
}
</code></pre>
<p>切换 <code>.dark-mode</code> 类后，页面即可自动进入暗色主题模式。</p>
<h3 data-id="heading-10">4. <strong>与预处理器兼容</strong></h3>
<p>CSS 变量可以与 Sass、Less 等预处理器混用，充分结合两者的优点：<br/>
Sass 提供编译时计算，而 CSS 变量则提供运行时控制。</p>
<hr/>
<h2 data-id="heading-11">五、CSS4 的发展方向与变量的地位</h2>
<p>虽然“CSS4”并非一个正式版本号（W3C 已停止使用版本号命名规范），<br/>
但它象征着 CSS 技术向模块化、动态化迈进的新时代。</p>
<p>CSS Variables 正是其中的代表之一，其他新特性还包括：</p>
<ul>
<li><code>@property</code> 声明语法（为变量定义类型和初始值）；</li>
<li>新的选择器（如 <code>:is()</code>, <code>:where()</code>）；</li>
<li>原生嵌套规则（类似 Sass 的嵌套语法）；</li>
<li>新的颜色函数（如 <code>color-mix()</code>, <code>lab()</code>, <code>lch()</code>）等。</li>
</ul>
<p>例如，未来我们可以这样声明类型安全的变量：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@property</span> --angle {
  syntax: <span class="hljs-string">"&lt;angle&gt;"</span>;
  inherits: false;
  initial-value: <span class="hljs-number">0deg</span>;
}

<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-built_in">var</span>(--angle));
}
</code></pre>
<hr/>
<h2 data-id="heading-12">六、实践与总结</h2>
<p>CSS 变量为前端开发带来了三个重要变化：</p>
<ol>
<li><strong>样式动态化</strong> —— 不再需要切换样式表文件；</li>
<li><strong>结构语义化</strong> —— 样式逻辑更清晰；</li>
<li><strong>主题系统化</strong> —— 轻松实现暗色模式、个性皮肤等功能。</li>
</ol>
<p>通过 HTML5 的输入控件与 JavaScript 的事件绑定，我们可以用极少的代码，打造一个可交互的“在线滤镜调节器”，这正是 CSS4 时代带来的灵活性与创造力的体现。</p>
<hr/>
<h2 data-id="heading-13">七、结语</h2>
<p>CSS4 变量的出现，不仅是对样式表语言的补强，更是一次思想的革新。<br/>
它让 CSS 具备了“编程”的能力，让设计与交互更紧密融合。</p>
<p>在未来的前端开发中，<strong>掌握并善用 CSS 变量，将是每位开发者的基本功。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PyTorch：AI深度学习开源框架]]></title>    <link>https://juejin.cn/post/7571396053879947316</link>    <guid>https://juejin.cn/post/7571396053879947316</guid>    <pubDate>2025-11-12T05:43:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571396053879947316" data-draft-id="7571372478804721679" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PyTorch：AI深度学习开源框架"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-12T05:43:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深圳蔓延科技"/> <meta itemprop="url" content="https://juejin.cn/user/1919099566570249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PyTorch：AI深度学习开源框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1919099566570249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深圳蔓延科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:43:36.000Z" title="Wed Nov 12 2025 05:43:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果把构建一个AI模型比作搭建一个复杂的乐高城堡，那么 <strong>PyTorch 就是一个为你提供了各种基础积木，并且让你能非常自由、顺手地去拼接它们的工具箱。</strong></p>
<p>它不像一些已经搭好的成品玩具（比如一些封装好的软件），你只能看不能改。PyTorch 的魅力在于它的 <strong>“动态”</strong> 和 <strong>“直观”</strong>。</p>
<h4 data-id="heading-0"><strong>1. 核心概念一：张量 - 其实就是“数据容器”</strong></h4>
<p>你可能听过一个词叫 <strong>“张量”（Tensor）</strong>。听起来很高深，但其实它就是 PyTorch 里最基本的数据容器。</p>
<p>你可以这样理解：</p>
<ul>
<li><strong>标量（一个数）</strong>：就是一个零维张量。比如：<code>5</code></li>
<li><strong>向量（一维数组）</strong>：就是一个一维张量。比如：<code>[1, 2, 3]</code></li>
<li><strong>矩阵（二维数组）</strong>：就是一个二维张量。比如：<code>[[1,2], [3,4]]</code></li>
<li><strong>更高维的数组</strong>：就是三维、四维...的张量。比如，一张彩色图片通常可以用 <code>[高度， 宽度， 颜色通道]</code> 的三维张量表示。</li>
</ul>
<p><strong>一句话总结：在 PyTorch 的世界里，所有的数据，无论是图片、文字还是声音，最终都会被转换成张量来进行计算。</strong> 它就是AI模型吃的“粮食”的统一包装。</p>
<h4 data-id="heading-1"><strong>2. 核心概念二：动态计算图 - “边搭边看”的魔力</strong></h4>
<p>这是 PyTorch 最核心、也最与众不同的特点。我们还是用搭乐高来比喻。</p>
<p>有些工具（比如早期的 TensorFlow）是 <strong>“静态图”</strong>：</p>
<blockquote>
<p>你需要先把整个城堡的设计蓝图（计算流程）完全画好，才能交给工具去搭建。如果想改一下城堡的一个小窗户，你可能需要重新画整个蓝图。这个过程比较麻烦，不灵活。</p>
</blockquote>
<p>而 PyTorch 采用的是 <strong>“动态计算图”</strong>：</p>
<blockquote>
<p><strong>你可以一边搭积木，城堡就一边在你眼前呈现出来。</strong> 你每进行一步操作（比如把两块积木拼在一起），这个操作就会立刻被记录和执行。你想在哪儿加个窗户，直接动手就行，马上就能看到效果。</p>
</blockquote>
<p><strong>这对我们有什么好处？</strong></p>
<ul>
<li><strong>调试异常方便</strong>：如果你的模型出错了，你可以像调试普通程序一样，一步一步地执行，看看是哪一块“积木”（哪一步计算）出了问题。这大大降低了找bug的难度。</li>
<li><strong>非常灵活</strong>：对于像处理自然语言（句子长短不一）、或者一些结构会变化的模型，这种“边搭边看”的模式天生就具有优势。因为每个样本的计算流程都可以不一样。</li>
</ul>
<h4 data-id="heading-2"><strong>3. 一个极简的模型训练流程</strong></h4>
<p>假设我们要训练一个模型来区分猫和狗的图片。用 PyTorch 通常包含以下几个步骤：</p>
<p><strong>步骤一：准备“粮食”（数据）</strong>
把你的猫和狗的图片加载进来，转换成张量，并整理成一个个小批次（batch）。PyTorch 提供了 <code>Dataset</code> 和 <code>DataLoader</code> 这样的工具来帮你自动化这个过程。</p>
<p><strong>步骤二：设计“城堡图纸”（定义模型）</strong>
用 PyTorch 提供的“积木”（比如各种网络层 <code>nn.Linear</code>, <code>nn.Conv2d</code>）来搭建你的神经网络结构。这就像用乐高块拼出一个过滤器和分类器。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

<span class="hljs-comment"># 这是一个非常简单的模型例子</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCatDogModel</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.fc = nn.Linear(<span class="hljs-number">3</span>*<span class="hljs-number">224</span>*<span class="hljs-number">224</span>, <span class="hljs-number">2</span>) <span class="hljs-comment"># 假设输入是3通道的224x224图片，输出是2类（猫/狗）</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 定义数据是如何从输入流到输出的</span>
        <span class="hljs-keyword">return</span> self.fc(x)

model = MyCatDogModel()
</code></pre>
<p><strong>步骤三：制定“验收标准”（定义损失函数和优化器）</strong></p>
<ul>
<li><strong>损失函数（Criterion）</strong>：用来衡量模型的预测结果和真实答案（是猫还是狗）相差多远。比如 <code>nn.CrossEntropyLoss</code>。</li>
<li><strong>优化器（Optimizer）</strong>：根据损失的大小，来告诉模型该如何调整它内部的“积木”结构（参数），从而让下次预测得更准。最常用的是 <code>torch.optim.Adam</code>。</li>
</ul>
<pre><code class="hljs language-python" lang="python">criterion = nn.CrossEntropyLoss()
optimizer = torch.optim.Adam(model.parameters(), lr=<span class="hljs-number">0.001</span>) <span class="hljs-comment"># lr是学习步长</span>
</code></pre>
<p><strong>步骤四：开始“反复练习”（训练循环）</strong>
这是最核心的一步，也是一个循环往复的过程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs): <span class="hljs-comment"># 把所有数据反复学习多遍</span>
    <span class="hljs-keyword">for</span> images, labels <span class="hljs-keyword">in</span> dataloader: <span class="hljs-comment"># 从数据加载器中取出一批数据</span>
        <span class="hljs-comment"># 1. 前向传播：把图片送入模型，得到预测结果</span>
        outputs = model(images)
        <span class="hljs-comment"># 2. 计算损失：看看预测结果和真实标签差多少</span>
        loss = criterion(outputs, labels)

        <span class="hljs-comment"># 3. 反向传播：这是关键！计算损失对于模型每一个参数的梯度</span>
        optimizer.zero_grad() <span class="hljs-comment"># 清空上一轮的梯度</span>
        loss.backward()       <span class="hljs-comment"># 自动计算梯度</span>

        <span class="hljs-comment"># 4. 更新参数：优化器根据梯度来调整模型参数，让它变得更准一点</span>
        optimizer.step()

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Epoch [<span class="hljs-subst">{epoch+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{num_epochs}</span>], Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>'</span>)
</code></pre>
<p>这个 <code>loss.backward()</code> 是 PyTorch 的“魔法”，它帮你自动完成了所有复杂的微积分计算，你只需要调用这一行代码就行。</p>
<h4 data-id="heading-3"><strong>总结：为什么大家爱用 PyTorch？</strong></h4>
<ol>
<li><strong>Pythonic，写起来像在写普通Python代码</strong>，非常符合程序员的直觉。</li>
<li><strong>动态图让调试和研究变得异常简单</strong>，对初学者和研究者非常友好。</li>
<li><strong>社区非常活跃</strong>，几乎任何最新的AI研究成果，你都能在PyTorch上找到开源的实现。</li>
<li><strong>生态完整</strong>，从数据加载、模型训练到部署，都有很好的工具支持（如 TorchServe）。</li>
</ol>
<p><strong>所以，PyTorch 不是一个神秘的“黑盒子”，而是一个灵活、强大且诚实的工具。</strong> 它把构建AI模型的能力，以一种相对直观的方式交到了每一个程序员和研究员的手中。你不需要完全理解其背后的所有数学，但通过它，你可以亲手实现并触摸到AI的脉络。</p>
<p>希望这篇文章能帮你拨开一些迷雾，对 PyTorch 有一个更实在的感受。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 MateChat发布V1.10.0版本，支持附件上传及体验问题修复，欢迎体验~]]></title>    <link>https://juejin.cn/post/7571379549370368051</link>    <guid>https://juejin.cn/post/7571379549370368051</guid>    <pubDate>2025-11-12T03:26:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379549370368051" data-draft-id="7570243451725299739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 MateChat发布V1.10.0版本，支持附件上传及体验问题修复，欢迎体验~"/> <meta itemprop="keywords" content="前端,Vue.js,人工智能"/> <meta itemprop="datePublished" content="2025-11-12T03:26:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DevUI团队"/> <meta itemprop="url" content="https://juejin.cn/user/712139267650141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 MateChat发布V1.10.0版本，支持附件上传及体验问题修复，欢迎体验~
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930890095402844163/posts" data-v-d326b38e=""><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6975547f58f744ae8fa9c79ba0a60c3b~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930890095402844163/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="DevUI团队" class="title" data-v-d326b38e="">DevUI团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-11-12T03:26:50.000Z" title="Wed Nov 12 2025 03:26:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-11-12
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读3分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              前端解决方案集 @华为
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✨ 本期亮点</h2>
<p>最新发布的 MateChat V1.10.0 版本新增<strong>文件列表组件</strong>和<strong>重新生成功能</strong>等特性，希望这个版本为你带来全新的体验！</p>
<h2 data-id="heading-1">🎯 核心功能升级（新特性）</h2>
<h3 data-id="heading-2">🔄 新增文件列表组件</h3>
<h4 data-id="heading-3">1、基本用法</h4>
<p><code>McFileList</code> 组件的核心功能是接收一个文件对象数组，并将它们渲染为信息卡片。通过 <code>fileItems</code> 属性传入数据，并可使用 <code>context</code> 属性控制其在不同场景下的外观，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fcomponents%2FfileList%2Fdemo.html" target="_blank" title="https://matechat.gitcode.com/components/fileList/demo.html" ref="nofollow noopener noreferrer">详情点击文件列表组件Demo</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c388bfbf4d14caf9b11b83fff7f8ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522810&amp;x-signature=%2FIS5v6J7zf%2B%2BNY6FZXX3rEdkSIs%3D" alt="文件列表组件最新.PNG" loading="lazy"/></p>
<h4 data-id="heading-4">2、不同上下文与状态</h4>
<p><code>McFileList</code> 提供了两种上下文模式和多种文件状态，以适应不同业务场景。</p>
<ul>
<li><code>input</code>: 通常用于文件上传选择器下方，每个文件项右上角会显示删除按钮。</li>
<li><code>dialog</code>: 通常用于对话历史记录中展示已发送的文件，外观更简洁。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145ff214f40b43b0a7b7b6d42aa3ac2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522810&amp;x-signature=W6cu3B6aisv5SiHzkSHqEHJz0t8%3D" alt="不同上下文与状态最新.PNG" loading="lazy"/></p>
<h4 data-id="heading-5">3、事件处理与交互</h4>
<p><code>McFileList</code> 通过触发事件来响应用户交互，允许你轻松实现自定义逻辑。</p>
<ul>
<li><strong><code>@remove</code></strong>: 在 <code>context="input"</code> 模式下，点击删除按钮时触发。</li>
<li><strong><code>@preview</code></strong>: 点击可预览文件时触发。</li>
<li><strong><code>@download</code></strong>: 点击下载按钮时触发。</li>
<li><strong><code>@retry-upload</code></strong>: 点击上传失败文件的“重试”按钮时触发。</li>
<li><strong><code>@retry-download</code></strong>: 点击下载失败文件的“重试”按钮时触发</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fdca32326544be3accf6fcd98530423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522810&amp;x-signature=6BJePUBJFlFBildo5XmEf8OpPDo%3D" alt="事件处理与交互.PNG" loading="lazy"/></p>
<h3 data-id="heading-6">📊 支持重新生成答案</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd566753560f417f8e6182cddc5766a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522810&amp;x-signature=jRZSUo3od8cADaTZ0RDcDosG%2F8U%3D" alt="重新生成新5.PNG" loading="lazy"/></p>
<h3 data-id="heading-7">📊 支持McInput组件在点击发送按钮或者回车后是否清空输入框</h3>
<h3 data-id="heading-8">📊 头像支持插槽</h3>
<h3 data-id="heading-9">📊 输入框可配置高度自适应</h3>
<h2 data-id="heading-10">🛠 优化与修复</h2>
<ul>
<li>⚡ 块级公式 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.1056em;"/><span class="mord">...</span></span></span></span></span> 无法正确渲染，被code渲染视图抢先渲染成为 math 标签</li>
<li>⚡ 聊天窗体展示布局有问题</li>
<li>⚡ 公式插件渲染公式无效果</li>
<li>⚡ 模型输出过程中，滚动条会一直滚动到底部</li>
<li>⚡ 使用demo生成的演示效果，”加载中效果“没有显示</li>
<li>⚡ McInput，在safari浏览器中，在中文输入法下按 Enter 时，消息会被发送</li>
<li>⚡ 输入框回车事件无法根据逻辑来确定是否执行</li>
<li>⚡ html元素渲染丢失</li>
<li>⚡ 当渲染的数学公式特别多的时候，界面下方会出现大量空间</li>
</ul>
<h2 data-id="heading-11">🏆 贡献者荣誉</h2>
<p>感谢这些优秀的贡献者（GitCode ID）：</p>
<ul>
<li><strong>@八角螃蟹_lzh</strong>（新增文件列表组件）</li>
<li><strong>@行言</strong>（支持重新生成功能）</li>
<li><strong>@Zhangfuchuan</strong>（支持McInput组件在点击发送按钮或者回车后，是否自动清空输入）</li>
<li><strong>@LovableCat</strong>（头像支持插槽）</li>
<li><strong>@xbghc</strong>（输入框可配置高度自适应）</li>
</ul>
<h2 data-id="heading-12">🚀 立即体验</h2>
<p><strong>两种方式快速上手体验：</strong></p>
<ol>
<li><strong>Web端直接访问官网示例项目</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fvue-starter%2F" target="_blank" title="https://matechat.gitcode.com/vue-starter/" ref="nofollow noopener noreferrer">matechat.com演示</a></li>
<li><strong>MateChat本地应用集成</strong>：使用 MateChat cli快速集成到你的应用中，可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fintroduction.html" target="_blank" title="https://matechat.gitcode.com/use-guide/introduction.html" ref="nofollow noopener noreferrer">使用指南</a></li>
</ol>
<h2 data-id="heading-13">📣 加入我们</h2>
<p>MateChat 正在快速发展，我们欢迎更多开发者加入：</p>
<ul>
<li>💬 DevUI微信小助手：devui-official（添加时请备注MateChat）</li>
<li>🌟 代码仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Freleases%3FpresetConfig%3D%257B%2522tags%2522%3A12%2C%2522release%2522%3A11%257D" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/releases?presetConfig=%7B%22tags%22:12,%22release%22:11%7D" ref="nofollow noopener noreferrer">gitcode.com/DevCloudFE/…</a></li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21f25f459a984f3f864807f5ced93d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763522810&amp;x-signature=kkfUSY3KU3K46X5XfZ6EsfuiSSo%3D" height="150px" loading="lazy"/> 
<blockquote>
<p>广纳贤士：AI赋能各行各业，MateChat期待更多感兴趣的小伙伴加入我们~</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Fissues" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/issues" ref="nofollow noopener noreferrer">欢迎大家前来提交Issue，认领Issue；</a></li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角]]></title>    <link>https://juejin.cn/post/7571338749198303282</link>    <guid>https://juejin.cn/post/7571338749198303282</guid>    <pubDate>2025-11-12T00:54:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198303282" data-draft-id="7571295102851317786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-11-12T00:54:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:54:04.000Z" title="Wed Nov 12 2025 00:54:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>现在的世界是越来越魔幻，早就超出了常人的理解范畴。</p>
<p>我最近老刷淘宝，昨天不知哪来的兴致，没什么特定缘由，纯粹好奇当下的相关生态，便鬼使神差在搜索栏敲了 “DeepSeek”。翻了没两下，一家店的标题瞬间抓住了他的眼球 ——“无需部署、打开即用，全程不卡顿”，售价才 10 块钱，付款人数却已经破了 1000。</p>
<p>盯着页面琢磨了半天，越想越纳闷：不用买家本地部署，还能保证立刻响应，这到底是什么神仙操作？</p>
<p>要知道，DeepSeek 的热度虽已过去半年，但直到现在，偶尔还是能见到这玩意儿的身影，甚至可能让人猛地想起当初被它支配的日子。</p>
<p>于是点进去了，这数据还确实挺好的，DeepSeek的需求还是旺。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a209f806f0154bbfb32cc2d7dd9ba25d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=NDkVqg8rQo16YNI0ERxxdKa7dxk%3D" alt="图片" loading="lazy"/></p>
<p>按捺不住满心的好奇，我干脆直接下了单、付了款。</p>
<h2 data-id="heading-1">收到货后</h2>
<p>可等卖家发来所谓的 “产品”，当场就懵了 —— 那瞬间的冲击感，让差点以为自己不小心闯进了平行宇宙，满脑子都是 “这到底是啥？！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75f2ae0dc9264087a0122291675f78e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=%2F8SGW97Z2fXHFZZDTt6Goa5g9jk%3D" alt="图片" loading="lazy"/></p>
<p>我第一反应直接懵了：这难道是遇到活菩萨了？居然自己部署了 DeepSeek，还开了公网供大家免费似的用？这算力得有多足啊？</p>
<p>有这资源，哥们儿直接去卖算力不比这 10 块钱一单赚得多？</p>
<p>可等定睛一看，瞬间愣住了 —— 这网址怎么这么眼熟？再仔细瞅了瞅，好家伙，居然是<a href="https://link.juejin.cn?target=https%3A%2F%2Fn.cn%2F" target="_blank" title="https://n.cn/" ref="nofollow noopener noreferrer">n.cn</a>？！</p>
<p>**这不是...360的纳米搜索？？？<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a77e83579646e5ba19dc849c5b140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=HfC4lQjs6JD4y7vk1f7AIloJDp4%3D" alt="图片" loading="lazy"/></p>
<p>我点开另一个网址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88340c9955a44ceca2e324c3e127abdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=r5wsvrq1SIP9YD7QqPsvQwC3Hxo%3D" alt="图片" loading="lazy"/></p>
<p>我一时间无语凝噎，我的大脑宕机了整整10秒钟。我想到了这个事情比较抽象，但是，我没想到能抽象到这种地步。因为，反差感极强，我本来会以为，哥们就卖链接，肯定不少差评，但，事情不太一样了起来。这个评论区，几乎全是好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ec1059d5084f5b85b83a2b5a766179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=j4nNOmXv0cCHDdZ1720j%2BbM%2Femo%3D" alt="图片" loading="lazy"/></p>
<p>甚至有300个88VIP的好评。我一条一条的看了下去，我感觉，这个世界在我的脑中，好像更魔幻，更立体了。有用户留言说，确实不卡，输出的代码很规范。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133b1ffd54194746ba0cd58f44f05fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=MmMvPL9DXnEpNCY3MM1ARye3wIY%3D" alt="图片" loading="lazy"/></p>
<p>“可以啊，是免费的r1，跟描述一致，性价比很高，不用买会员了也。”
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c99efd8b8b49968351e3a7fa2096e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=TqbzdKi0xiRUWGwq%2FJt7oOqx2NU%3D" alt="图片" loading="lazy"/></p>
<p>**不用买会员了。我不知道你们是什么感受，我突然鼻子一酸。我看到的，忽然是一个个非常活生生、立体形象的人。</p>
<p>或许对于这些Ta们来说：白天在公司，他得忍着老板的 PUA 强撑着干活，连反驳的底气都没有 —— 这份薪资微薄的工作，是他在四五线小城唯一的糊口依靠。</p>
<p>晚上回到十几平米的出租屋，狭小的空间里塞满了不甘。他太想改变命运了，太怕一辈子困在原地，所以总琢磨着学门新本事，抓住点什么。</p>
<p>AI、大模型、席卷时代的技术革命，这些词像针一样扎着他的心。他知道这是翻身的机会，可每一次听说，都伴随着深深的恐慌 —— 怕自己追不上这股浪潮，怕被时代彻底抛弃。</p>
<p>可真要迈出脚步，才发现前路全是望不到头的坎：官网得靠 “魔法上网” 才能访问，他摸不着门道；会员订阅几十上百块一个月，抵得上他好几天的饭钱，根本舍不得花；那些部署教程里的术语，像天书一样晦涩，硬生生把他挡在门外，连入门的缝隙都不给留。</p>
<p>好不容易扒到 DeepSeek 和 ChatGPT 的官网，他咬碎了牙才掏出不便宜的会员费，以为终于摸到了门槛。可实际用起来，却满是失望 —— 不仅卡顿得让人抓狂，历史记录里还莫名冒出不属于自己的内容，钱花得冤枉又憋屈。</p>
<p>一次次尝试，一次次被现实打回原形。他就像个被遗弃在站台外的人，眼睁睁看着时代的列车呼啸而过，自己却连上车的资格都没有。那种求而不得的无力感，沉甸甸压在胸口，让他喘不过气。</p>
<p>直到那天在淘宝刷到那个 9.9 元的商品，<code>“无需部署”“打开即用”“立刻响应” </code>这几个字，像黑夜里的一束光，瞬间照亮了他的渴望。</p>
<p>他反复看了好几遍商品页面，纠结了很久 —— 兜里的钱每一分都要算计，他怕这又是一场骗局，怕最后连这两顿拼好饭的钱都打了水漂。可对改变的渴望，终究压过了所有顾虑。</p>
<p>下单后，他攥着手机等回复，收到可直接点开的链接时，手指都带着点颤抖。怀着忐忑点进去，居然真的能用，还异常流畅。</p>
<p>那一刻，他紧绷的肩膀突然垮了下来，长长舒了一口气，眼眶甚至有点发热。他觉得自己终于花最少的钱，攥住了那张三寸见方的、通往新世界的船票。</p>
<p><strong>满心欢喜地跑到评论区，他认认真真打下 “性价比很高，不用买会员了”，字里行间全是满足。他甚至偷偷窃喜，觉得自己占了天大的便宜，用 9.9 元就撬动了原本遥不可及的生产力工具。</strong></p>
<p>他把这个链接小心翼翼收进浏览器书签，像珍藏一件稀世珍宝。这是他在残酷生活里，拼尽全力才抓住的小小捷径，是支撑他继续往前走的一点希望。</p>
<p>可他不知道，这份被他视若珍宝的 “机会”，本就明晃晃摊在阳光下，对所有人免费开放。他只是恰好站在了信息的阴影里，没见过那片触手可及的光明，只能靠着这点 “微光”，笨拙又执着地追赶着时代的脚步。</p>
<p><strong>AI的发展，永不止步。</strong> <code>愿所有人都能跟上时代的洪流</code>，用自己信息差打出一片新的天地！</p>
<h3 data-id="heading-2">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot邮件发送怎么玩？比官方自带的Mail更好用的三方工具]]></title>    <link>https://juejin.cn/post/7571338749198467122</link>    <guid>https://juejin.cn/post/7571338749198467122</guid>    <pubDate>2025-11-12T01:17:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198467122" data-draft-id="7571351275976900659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot邮件发送怎么玩？比官方自带的Mail更好用的三方工具"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-11-12T01:17:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot邮件发送怎么玩？比官方自带的Mail更好用的三方工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:17:39.000Z" title="Wed Nov 12 2025 01:17:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00b0b7f6e0fd42b28d96fc45514e02b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=wGbwLkGOTBaXNlYc9IYngb2MgVY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>官方自带的<code>spring-boot-starter-mail</code>针对普通的文本邮件已经很方便了，但是针对附件、<code>html</code>等还是不太友好的。<code>SpringBoot</code>如果开启了监控<code>spring-boot-starter-actuator</code>，服务器会实时检测邮件服务器是否正常，如果服务器异常，就会反复重试，从而引起服务器的崩溃，不要问我怎么知道的，说多了都是泪。</p>
<p>而今天要介绍的三方库，针对复杂的邮件类型，应对起来游刃有余。</p>
<h2 data-id="heading-1">02 Simple Java Mail</h2>
<h3 data-id="heading-2">2.1 简介</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f94d092557442b980e5555aa139b0a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=z4pNzxAQ%2FbdoEdI4%2B2XfPnQSnPY%3D" alt="" loading="lazy"/></p>
<p>Simple Java Mail 是一个拥有超简洁 <code>API</code> 的邮件库。它是世界上使用起来最简便的（<code>Java</code>）邮件库，可通过 <code>SMTP</code> 发送电子邮件。这个库让你无需处理诸如<code>MimeMessage</code>之类的底层<code>API</code>、繁琐的<code>trycatch</code>结构、内部类以及其他无用的东西。它是一个功能强大、特性完备的邮件库，同时又小巧且轻量。</p>
<p>核心模块：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e0be45ac0e4328b57ece16dc9fd9bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=AytfTNYq5Q5skysqxgwOoNKd81c%3D" alt="" loading="lazy"/></p>
<p>核心依赖：</p>
<ul>
<li><code>org.slf4j:slf4j-api</code></li>
<li><code>com.sun.mail:jakarta.mail</code></li>
<li><code>com.sun.activation:jakarta.activation</code></li>
<li><code>jakarta.xml.bind:jakarta.xml.bind-api</code></li>
<li><code>jakarta.annotation:jakarta.annotation-api</code></li>
<li><code>com.sanctionco.jmail:jmail (address validation)</code></li>
<li><code>com.pivovarit:throwing-function (improved Streams api)</code></li>
</ul>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbbottema%2Fsimple-java-mail" target="_blank" title="https://github.com/bbottema/simple-java-mail" ref="nofollow noopener noreferrer">github.com/bbottema/si…</a></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.simplejavamail.org%2F" target="_blank" title="https://www.simplejavamail.org/" ref="nofollow noopener noreferrer">www.simplejavamail.org/</a></p>
<h3 data-id="heading-3">2.2 Maven依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.simplejavamail<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>simple-java-mail<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.12.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2.3 案例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Mailer</span> <span class="hljs-variable">mailer</span> <span class="hljs-operator">=</span> MailerBuilder
            .withSMTPServer(<span class="hljs-string">"smtp.163.com"</span>, <span class="hljs-number">465</span>, 
                    <span class="hljs-string">"xxxx@163.com"</span>, <span class="hljs-string">"授权码"</span>
            )
            .withTransportStrategy(TransportStrategy.SMTPS)
            .buildMailer();


    <span class="hljs-type">Email</span> <span class="hljs-variable">email</span> <span class="hljs-operator">=</span> EmailBuilder.startingBlank()
            .from( <span class="hljs-string">"xxxxx@163.com"</span>)
            .to( <span class="hljs-string">"xxxx@126.com"</span>)
            .withSubject(<span class="hljs-string">"测试邮件"</span>)
            .withHTMLText(<span class="hljs-string">"&lt;h1&gt;测试邮件123&lt;/h1&gt;"</span>)
            .buildEmail();


    mailer.sendMail(email);
}
</code></pre>
<p>通过<code>MailerBuilder</code>构建发送的客户端，通过<code>EmailBuilder</code>构建发送邮件的具体信息。</p>
<p>内容更是支持丰富：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84eff267d1e3445e86e59b50f35008c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=QIrA2kkESrMkevQ1vL%2FyC04Uvdk%3D" alt="" loading="lazy"/></p>
<p>还有其他的特性，可以自行探索。</p>
<h3 data-id="heading-5">2.4 注意事项</h3>
<p>如果在项目中正常使用，客户端没有必要每次都创建，只需要注册到<code>Spring</code>容器中，随用随取。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Mailer <span class="hljs-title function_">inhouseMailer</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> MailerBuilder
        .withSMTPServer(...)
        .buildMailer();
}
</code></pre>
<h3 data-id="heading-6">2.5 避坑指南</h3>
<p>小编在使用<code>8.12.6</code>版本时，出现了一些包找不到的问题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/907f4b0ea6da42db9e997ae83dfe1760~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=aha8RdsjqB8gsCJ%2FX6fotd7%2FCFo%3D" alt="" loading="lazy"/></p>
<p>由于又引入两个依赖才解决问题：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>jakarta.mail<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jakarta.mail-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>jakarta.activation<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jakarta.activation-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>从更新日志来看，<code>v8.11.0</code>已经升级了但部分依赖的版本：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f7d6e211f9346dda30425ec4d978c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=XWgkxBRygOlmfuRxQNmdnj9vMDk%3D" alt="" loading="lazy"/></p>
<p>但是，实际发现版本并没有升上去。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c4771f9a6df43b7a74f7914320f6b39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=5Pwaw3WbcfH8JFNaHO3ecDVaZP4%3D" alt="" loading="lazy"/></p>
<p>也有可能小编本地<code>JDK</code>的问题，这里就不细说了。总之问题通过升级版本可以解决。</p>
<h2 data-id="heading-7">03 SMS4J</h2>
<h3 data-id="heading-8">3.1 简介</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41018f9b3fcd412fa9b19b0cf403c386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=pVKd74Lw%2FdSIpySVc%2Ff5Qm3tRgg%3D" alt="" loading="lazy"/></p>
<p><code>SMS4J</code>为短信聚合框架，帮您轻松集成多家短信服务，解决接入多个短信<code>SDK</code>的繁琐流程。 <code>SMS4J</code>着重解决短信发送的问题，但是作者也将邮件的发送也融合了进去。并且拥有独立依赖。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/028322b53dbd4715a0105755fbe2b82c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=eV3JBmZ7HMqWxBZcQjjHJ1xHCOo%3D" alt="" loading="lazy"/></p>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdromara%2Fsms4j" target="_blank" title="https://github.com/dromara/sms4j" ref="nofollow noopener noreferrer">github.com/dromara/sms…</a></p>
<p><code>Gitee</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2Fsms4j" target="_blank" title="https://gitee.com/dromara/sms4j" ref="nofollow noopener noreferrer">gitee.com/dromara/sms…</a></p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsms4j.com" target="_blank" title="https://sms4j.com" ref="nofollow noopener noreferrer">sms4j.com</a></p>
<h3 data-id="heading-9">3.2 Maven依赖</h3>
<p>因为小编的本地<code>JDK</code>是<code>17</code>，所以使用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dromara.sms4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sms4j-email-jakarta-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">3.3 案例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span> {
    <span class="hljs-type">MailSmtpConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> MailSmtpConfig.builder()
            .fromAddress(<span class="hljs-string">"xxxx@163.com"</span>)
            .smtpServer(<span class="hljs-string">"smtp.163.com"</span>)
            .port(<span class="hljs-string">"465"</span>)
            .username(xxx@<span class="hljs-number">163.</span>com<span class="hljs-string">")
            .password("</span>授权码<span class="hljs-string">")
            .build();

    MailFactory.put("</span>mailClient<span class="hljs-string">", config);

    MailMessage message = MailMessage.Builder()
            .mailAddress("</span>xxxxx@<span class="hljs-number">126.</span>com<span class="hljs-string">")
            .title("</span>测试邮件<span class="hljs-number">2</span><span class="hljs-string">")
            .htmlContent("</span>&lt;h1&gt;测试邮件  <span class="hljs-built_in">this</span> is body&lt;/h1&gt;<span class="hljs-string">")
            .build();

    // 发送邮件：指定黑名单
    MailFactory.createMailClient("</span>mailClient<span class="hljs-string">", () -&gt; List.of("</span><span class="hljs-string">")).send(message);
}
</span></code></pre>
<p><code>MailSmtpConfig</code>构建客户端的配置，通过<code>MailFactory</code>创建客户端。<code>MailMessage</code>构建邮件内容。邮件发送还支持黑名单。邮件内容支持多种模式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0ad4d1bfb25468faf19ed330fc809d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=wR6%2FYh1g4vLuM3opEmwsEs6MlXk%3D" alt="" loading="lazy"/></p>
<p>使用的注意事项同上面的案例。</p>
<h3 data-id="heading-11">3.4 邮箱监听</h3>
<p>邮箱监听可以监听到某个<code>IMAP</code>协议邮箱中收到的邮件，并对其进行一定的处理。小编在测试发现了异常。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">MailImapConfig</span> <span class="hljs-variable">config2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MailImapConfig</span>();
    config2.setImapServer(<span class="hljs-string">"imap.163.com"</span>);
    config2.setAccessToken(<span class="hljs-string">"授权码"</span>);
    config2.setUsername(<span class="hljs-string">"xxxx@163.com"</span>);

    MonitorFactory.put(<span class="hljs-string">"ws_Monitor"</span>, config2, monitorMessage -&gt; {
        System.out.println(JSON.toJSONString(monitorMessage));
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });
    MonitorFactory.start(<span class="hljs-string">"ws_Monitor"</span>);
    <span class="hljs-comment">// MonitorFactory.stop("ws_Monitor");</span>

    System.in.read();
}
</code></pre>
<p>但是执行的时候：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8551b85836544b6bdac198a238a3555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515059&amp;x-signature=cY90KT%2BIu8iFHuB2fsrUCvVjSkI%3D" alt="" loading="lazy"/></p>
<p>该问题未能解决。查阅资料，是因为邮箱因为安全问题被拒绝了。</p>
<h2 data-id="heading-12">04 小结</h2>
<p><code>Spring Boot</code>提供了强大的邮件发送支持，而<code>SMS4j</code>和<code>Simple Java Mail</code>则在此基础上提供了更多高级功能和更简洁的<code>API</code>。</p>
<p>大家使用的时候，有没有遇到小编的问题呢？评论区留言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis 高并发实战：我从 5000QPS 优化到 5W+ 的7个核心策略]]></title>    <link>https://juejin.cn/post/7571396053879701556</link>    <guid>https://juejin.cn/post/7571396053879701556</guid>    <pubDate>2025-11-12T04:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571396053879701556" data-draft-id="7571477608392179712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis 高并发实战：我从 5000QPS 优化到 5W+ 的7个核心策略"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-12T04:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis 高并发实战：我从 5000QPS 优化到 5W+ 的7个核心策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T04:17:20.000Z" title="Wed Nov 12 2025 04:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis 高并发实战：我从 5000QPS 优化到 5W+ 的7个核心策略</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在当今的互联网架构中，Redis 作为高性能的内存数据库，已经成为解决高并发问题的关键组件。然而，随着业务规模的扩大，许多开发者会发现 Redis 的性能瓶颈逐渐显现。本文将分享一个真实的优化案例：如何通过7个核心策略，将 Redis 的 QPS（每秒查询率）从最初的 5000提升到5W+。这些策略不仅涵盖了 Redis 的基本配置优化，还包括了高级的数据结构选择、集群化部署以及客户端优化等实战经验。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>选择合适的 Redis 数据结构</strong></h3>
<p>Redis 提供了多种数据结构（如 String、Hash、List、Set、Sorted Set等），选择合适的数据结构可以显著提升性能。</p>
<ul>
<li>
<p><strong>场景分析</strong>：在我们的案例中，最初使用 String 类型存储用户会话信息，每个用户的会话数据包含多个字段（如 userId、sessionId、lastActiveTime等）。这种设计导致大量的小 Key-Value对，增加了内存碎片和网络开销。</p>
</li>
<li>
<p><strong>优化方案</strong>：改用 Hash 结构存储用户会话信息。Hash结构允许将多个字段存储在一个 Key中，减少了 Key的数量和内存占用。实测结果显示，QPS提升了约30%。</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Before: String类型</span>
SET user:1000:sessionId <span class="hljs-string">"abc123"</span>
SET user:1000:lastActiveTime <span class="hljs-string">"1625097600"</span>

<span class="hljs-comment"># After: Hash类型</span>
HSET user:1000 sessionId <span class="hljs-string">"abc123"</span> lastActiveTime <span class="hljs-string">"1625097600"</span>
</code></pre>
<h3 data-id="heading-4">2. <strong>Pipeline批量操作减少网络开销</strong></h3>
<p>在高并发场景下，频繁的网络请求会成为性能瓶颈。Redis Pipeline技术可以将多个命令一次性发送给服务器，减少网络往返时间（RTT）。</p>
<ul>
<li><strong>实测效果</strong>：在一次批量写入100条数据的测试中：
<ul>
<li>Without Pipeline：耗时约50ms。</li>
<li>With Pipeline：耗时约5ms。</li>
</ul>
吞吐量提升了近10倍！</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python示例代码</span>
<span class="hljs-keyword">import</span> redis

r = redis.Redis()
pipe = r.pipeline()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    pipe.<span class="hljs-built_in">set</span>(<span class="hljs-string">f'key_<span class="hljs-subst">{i}</span>'</span>, <span class="hljs-string">f'value_<span class="hljs-subst">{i}</span>'</span>)
pipe.execute()
</code></pre>
<h3 data-id="heading-5">3. <strong>合理设置过期时间和内存淘汰策略</strong></h3>
<p>Redis的内存是有限的，合理设置过期时间和内存淘汰策略可以避免内存溢出并提高缓存命中率。</p>
<ul>
<li>
<p><strong>过期时间</strong>：为缓存数据设置合理的 TTL（Time-To-Live），避免冷数据长期占用内存。</p>
</li>
<li>
<p><strong>内存淘汰策略</strong>：默认的 <code>noeviction</code>策略会在内存不足时拒绝写入操作。对于高并发场景，建议使用 <code>allkeys-lru</code>或 <code>volatile-lru</code>：</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf配置示例</span>
maxmemory-policy allkeys-lru
</code></pre>
<h3 data-id="heading-6">4. <strong>使用 Lua脚本减少原子性操作的网络开销</strong></h3>
<p>对于需要原子性执行的复杂操作（如扣减库存），可以使用 Lua脚本将多个命令合并为一个原子操作。</p>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>原子性</strong>：Lua脚本的执行是原子的。</li>
<li><strong>减少网络开销</strong>：避免了多次请求的开销。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本示例：扣减库存</span>
<span class="hljs-keyword">local</span> stock = <span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>]))
<span class="hljs-keyword">if</span> stock &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    redis.call(<span class="hljs-string">'DECR'</span>, KEYS[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 data-id="heading-7">5. <strong>集群化部署与读写分离</strong></h3>
<p>当单机 Redis无法满足性能需求时，可以通过集群化部署和读写分离来扩展性能。</p>
<ul>
<li>
<p><strong>Redis Cluster</strong>：</p>
<ol>
<li><strong>分片存储</strong>：数据分散存储在多个节点上。</li>
<li><strong>高可用性</strong>：支持主从复制和故障转移。</li>
</ol>
</li>
<li>
<p><strong>读写分离</strong>：</p>
<ol>
<li>Master节点处理写请求。</li>
<li>Slave节点处理读请求。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Redis Cluster配置示例</span>
redis-cli --cluster create node1:6379 node2:6379 node3:6379 --cluster-replicas 1
</code></pre>
<h3 data-id="heading-8">6. <strong>客户端连接池优化</strong></h3>
<p>客户端的连接管理对性能影响巨大。不当的连接池配置可能导致连接泄漏或资源浪费。</p>
<ul>
<li><strong>推荐配置</strong>：
<ol>
<li><strong>最大连接数</strong>：根据业务需求调整。</li>
<li><strong>空闲连接超时时间</strong>：避免长时间占用资源。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Jedis连接池配置示例（Java）</span>
<span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();
poolConfig.setMaxTotal(<span class="hljs-number">100</span>); <span class="hljs-comment">//最大连接数</span>
poolConfig.setMaxIdle(<span class="hljs-number">20</span>); <span class="hljs-comment">//最大空闲连接数</span>

<span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedisPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig, <span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>);
</code></pre>
<h3 data-id="heading-9">7. <strong>监控与慢查询分析</strong></h3>
<p>持续的监控和慢查询分析可以帮助发现潜在的性能问题。</p>
<ul>
<li><strong>监控工具推荐</strong>：
<ol>
<li><code>redis-cli --stat</code> ：实时监控 Redis状态。</li>
<li><code>slowlog get</code> ：查看慢查询日志。</li>
</ol>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># slowlog配置示例（记录超过5ms的查询）</span>
config <span class="hljs-built_in">set</span> slowlog-log-slower-than 5000 
config <span class="hljs-built_in">set</span> slowlog-max-len 128 
slowlog get 
</code></pre>
<hr/>
<h2 data-id="heading-10">总结</h2>
<p>通过上述7个核心策略的组合应用（数据结构优化、Pipeline批量操作、过期与淘汰策略调优、Lua脚本原子化操作、集群化部署与读写分离、客户端连接池优化以及监控与慢查询分析），我们成功地将 Redis的 QPS从5000提升到5W+。这些经验不仅适用于类似的高并发场景，也为其他分布式缓存系统的优化提供了参考思路。希望本文能为你在实际项目中遇到的 Redis性能问题提供启发！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-150 Apache Druid 单机部署实战：架构速览、启动清单与故障速修]]></title>    <link>https://juejin.cn/post/7571332468898414619</link>    <guid>https://juejin.cn/post/7571332468898414619</guid>    <pubDate>2025-11-12T01:24:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571332468898414619" data-draft-id="7571338749198565426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-150 Apache Druid 单机部署实战：架构速览、启动清单与故障速修"/> <meta itemprop="keywords" content="后端,大数据,Apache"/> <meta itemprop="datePublished" content="2025-11-12T01:24:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-150 Apache Druid 单机部署实战：架构速览、启动清单与故障速修
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:24:44.000Z" title="Wed Nov 12 2025 01:24:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：在本机/单机快速体验 Apache Druid 30.0.0，验证实时与历史查询与控制台访问。</li>
<li>结论：按 single-server quickstart 配置可平滑起服；端口与内存/JVM 是最易踩的坑。</li>
<li>产出：下载解压与环境变量清单、各启动命令对照、访问入口与常见错误速查卡。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f187c4108f545a5a5a71e63db90aa05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=yvCCkcABDiZwmddFIz7vtWxu8no%3D" alt="大数据-150 Apache Druid 单机部署实战：架构速览、启动清单与故障速修" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>


















































<table><thead><tr><th>目标</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>Druid 30.0.0 下载与解压</td><td>是</td><td>按文中命令与截图完成</td></tr><tr><td>环境变量（DRUID_HOME/PATH）</td><td>是</td><td>/etc/profile 写入并刷新生效</td></tr><tr><td>单机 nano-quickstart 启动</td><td>是</td><td>bin/start-nano-quickstart，用于最低配验证</td></tr><tr><td>控制台访问 8888</td><td>是</td><td>提供示例地址；注意放行端口/安全组/防火墙</td></tr><tr><td>micro-quickstart（4C/16G）</td><td>待确认</td><td>建议同步调大 jvm.config 堆与处理线程数</td></tr><tr><td>small/medium/large/xlarge</td><td>待确认</td><td>需按机器规格与数据量评估 JVM 与处理/缓存参数</td></tr><tr><td>ZooKeeper 2181 冲突处理</td><td>是</td><td>已通过停止占用进程规避；也可改端口/外置 ZK</td></tr><tr><td>批/流摄取（Kafka/HDFS/S3）</td><td>待确认</td><td>单机验证可先跳过，集群/生产再配置</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d79a5f03ba564196a7a29bdd48c5f150~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=BMBswjf77CRMSpFA7wvqjDGDHWQ%3D" alt="Apache Druid" loading="lazy"/></p>
<h2 data-id="heading-2">系统架构</h2>
<p>Apache Druid 是一个开源的、分布式的高性能实时分析数据库系统，专为快速聚合和查询大规模数据集而设计。它特别适合处理时间序列数据、事件数据和日志数据等场景，广泛应用于互联网广告分析、在线交易监控、网络安全日志分析等领域。</p>
<p>Druid 的核心架构采用模块化设计，主要由以下几个关键组件构成：</p>
<ol>
<li>
<p>协调节点(Coordinator Node)</p>
<ul>
<li>负责数据分片(segment)的生命周期管理</li>
<li>监控数据节点状态</li>
<li>执行数据平衡和复制策略</li>
</ul>
</li>
<li>
<p>历史节点(Historical Node)</p>
<ul>
<li>存储和查询不可变的数据分片</li>
<li>使用内存映射文件实现高效查询</li>
<li>支持多种压缩格式(如LZ4、Zstandard)</li>
</ul>
</li>
<li>
<p>查询节点(Broker Node)</p>
<ul>
<li>接收客户端查询请求</li>
<li>将查询路由到相关节点</li>
<li>聚合和返回最终结果</li>
</ul>
</li>
<li>
<p>摄取节点(Ingestion Node)</p>
<ul>
<li>实时数据摄取</li>
<li>支持批处理和流式两种模式</li>
<li>提供多种数据格式支持(JSON、CSV等)</li>
</ul>
</li>
<li>
<p>深度存储(Deep Storage)</p>
<ul>
<li>持久化存储层</li>
<li>支持HDFS、S3等分布式文件系统</li>
<li>确保数据高可用性</li>
</ul>
</li>
</ol>
<p>这些组件协同工作，使得Druid能够实现亚秒级的查询响应时间，并支持高达每秒百万级事件的数据摄入能力。典型部署方案中，每个组件都可以独立扩展，以满足不同的性能和容量需求。</p>
<h3 data-id="heading-3">核心组件</h3>
<h4 data-id="heading-4">数据摄取层 (Ingestion Layer)</h4>
<ul>
<li>数据源: Druid 支持多种数据源，如 Kafka、HDFS、Amazon S3 等。数据摄取可以是批处理（Batch）或实时流处理（Streaming）。</li>
<li>任务管理: 使用任务协调器来管理数据摄取任务，确保数据流的顺畅和高可用性。</li>
</ul>
<h4 data-id="heading-5">数据存储层 (Storage Layer)</h4>
<p>Segment: Druid 将数据分为多个小块，称为“段”（Segment）。每个段通常包含一段时间内的数据，并被优化以支持快速查询。
时间分区: Druid 根据时间将数据分区，以提高查询性能。数据按时间戳索引，有助于高效的时间范围查询。</p>
<h4 data-id="heading-6">查询层 (Query Layer)</h4>
<ul>
<li>Broker: 负责接收用户的查询请求并将其路由到相应的数据节点（如历史节点和实时节点）。</li>
<li>查询执行: Druid 支持多种查询类型，包括聚合查询、过滤查询和分组查询。查询结果会通过 Broker 返回给用户。</li>
</ul>
<h4 data-id="heading-7">历史节点 (Historical Node)</h4>
<ul>
<li>存储并管理长时间的数据段，负责处理对历史数据的查询。</li>
</ul>
<h4 data-id="heading-8">实时节点 (Real-time Node)</h4>
<ul>
<li>用于实时摄取数据，实时处理并生成可查询的段。适合需要低延迟数据访问的应用。</li>
</ul>
<h4 data-id="heading-9">协调节点 (Coordinator Node)</h4>
<ul>
<li>负责管理 Druid 集群的各个节点，监控节点的健康状态、数据分布和负载均衡。</li>
</ul>
<h3 data-id="heading-10">数据流动</h3>
<ul>
<li>数据摄取: 数据从外部源流入 Druid（如 Kafka 消息队列），经过任务管理和转换后被摄取。</li>
<li>数据存储: 数据被分段并存储在历史节点和实时节点中，按时间分区和压缩以优化存储。</li>
<li>查询处理: 用户通过查询接口（如 SQL 或 Druid 特定的查询语言）发送查询请求，Broker 节点将请求分发到相应的数据节点，聚合和处理查询结果后返回。</li>
</ul>
<h3 data-id="heading-11">查询优化</h3>
<ul>
<li>列式存储: Druid 采用列式存储格式，提高了压缩率和查询性能。</li>
<li>索引: Druid 会为每个字段建立索引，加速过滤和聚合操作。</li>
<li>预聚合: 对常用的聚合操作进行预计算，以减少实时查询的计算负担。</li>
</ul>
<h3 data-id="heading-12">可扩展性与高可用性</h3>
<ul>
<li>Druid 支持横向扩展，可以根据需求添加更多的节点来处理更大的数据集和更高的查询负载。</li>
<li>数据冗余和节点监控机制确保了系统的高可用性。</li>
</ul>
<h2 data-id="heading-13">下载解压</h2>
<p>官方目前已经到了版本30了</p>
<pre><code class="hljs language-shell" lang="shell">wget https://dlcdn.apache.org/druid/30.0.0/apache-druid-30.0.0-bin.tar.gz
</code></pre>
<p>直接结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a3405af00774c2f9ab2935e5c650d00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=lBz8JO7dDzd8LrI7UAwuzYSVS44%3D" alt="下载 Apache Druid" loading="lazy"/>
进行解压：</p>
<pre><code class="hljs language-shell" lang="shell">tar -zxvf apache-druid-30.0.0-bin.tar.gz
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae2d25d508bf4a12884daa6031864c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=qzWNVjcM6I%2FAkG6WA%2B52umQk8t4%3D" alt="Apache Druid 解压" loading="lazy"/>
移动到目标目录：</p>
<pre><code class="hljs language-shell" lang="shell">mv apache-druid-30.0.0 /opt/servers/
cd /opt/servers/apache-druid-30.0.0
ls
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cc1691cbbae40b1bbea91cb59e14d70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=9gavC1XcXmzqeflRQjtvhSJHKaQ%3D" alt="准备安装 Apache Druid" loading="lazy"/></p>
<h2 data-id="heading-14">单机部署</h2>
<h3 data-id="heading-15">配置文件</h3>
<p>单服务器部署的配置文件如下：</p>
<pre><code class="hljs language-shell" lang="shell">conf/druid/single-server/
├── large
├── medium
├── micro-quickstart
├── nano-quickstart
├── small
└── xlarge
</code></pre>
<p>文件的路径如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75af77abb2c44739a1268207f9a0f806~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=ndbBHS9C7TviQ4SPNyynWqttenE%3D" alt="查看目录" loading="lazy"/></p>
<h2 data-id="heading-16">启动要求</h2>
<p>单服务器的要求如下：</p>
<pre><code class="hljs language-shell" lang="shell">Nano-Quickstart：1个CPU，4GB RAM
启动命令： bin/start-nano-quickstart
配置目录： conf/druid/single-server/nano-quickstart/*
微型快速入门：4个CPU，16GB RAM
启动命令： bin/start-micro-quickstart
配置目录： conf/druid/single-server/micro-quickstart/*
小型：8 CPU，64GB RAM（〜i3.2xlarge）
启动命令： bin/start-small
配置目录： conf/druid/single-server/small/*
中：16 CPU，128GB RAM（〜i3.4xlarge）
启动命令： bin/start-medium
配置目录： conf/druid/single-server/medium/*
大型：32 CPU，256GB RAM（〜i3.8xlarge）
启动命令： bin/start-large
配置目录： conf/druid/single-server/large/*
大型X：64 CPU，512GB RAM（〜i3.16xlarge）
启动命令： bin/start-xlarge
配置目录： conf/druid/single-server/xlarge/*
</code></pre>
<h2 data-id="heading-17">环境变量</h2>
<pre><code class="hljs language-shell" lang="shell">vim /etc/profile
</code></pre>
<p>写入如下的内容，记得刷新环境变量:</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">druid</span>
export DRUID_HOME=/opt/servers/apache-druid-30.0.0
export PATH=$PATH:$DRUID_HOME/bin
</code></pre>
<p>写入内容如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3240caa6fc140f689abb761acdf0328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=qZ4H2k96pRnWQUj5KYpAMNAGJ4A%3D" alt="配置环境变量" loading="lazy"/>
(这里注意，要关闭其他的服务，比如ZK什么的，不然会提示2181端口会占用)</p>
<pre><code class="hljs language-shell" lang="shell">zkServer.sh stop
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc80f6607b9d4d7cb0c82de29bbe559d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=rJQw8C8ArH1DhMzUG5KZY39d3TQ%3D" alt="配置ZooKeeper" loading="lazy"/>
接着进行启动，启动结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15e713dfcde34c908675c5d4ecaf3dad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=gJFjK%2BlGgZReOj1XXtJseDcPiMI%3D" alt="启动服务" loading="lazy"/></p>
<h2 data-id="heading-18">查看页面</h2>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:8888/
</code></pre>
<p>页面结果显示如下图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8da9c1303654dd69cac0a4ba0496830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=CM352LNM39pN1lpzF2JB%2FASGn4A%3D" alt="访问 Druid 的服务" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f799169886646598567dcfad0896ae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763515484&amp;x-signature=odTvWNS%2BwDYisMHUXQhIW8BybJ0%3D" alt="Druid 服务访问" loading="lazy"/>
PS：官方建议大型系统采用集群模式部署，以此来实现容错和减少资源的争抢。</p>
<h2 data-id="heading-19">错误速查</h2>







































































<table><thead><tr><th>症状</th><th>根因</th><th>定位方法</th><th>修复方案</th></tr></thead><tbody><tr><td>8888 无法访问</td><td>端口未放行或仅监听本地</td><td><code>ss -lntp</code>/防火墙规则、日志无异常</td><td>放行 8888/改绑定地址；确认反向代理与安全组</td></tr><tr><td>启动报 OOM/GC 过高</td><td>JVM 堆过小、处理线程过多</td><td><code>var/sv/*/logs</code> 中 <code>OutOfMemoryError</code></td><td>调整 <code>conf/**/jvm.config</code> 的 <code>-Xms/-Xmx</code> 与处理线程</td></tr><tr><td>2181 端口占用</td><td>本机已有 ZK 或其他进程</td><td><code>lsof -i :2181</code></td><td>停止占用进程或调整 Druid/ZK 端口并重启</td></tr><tr><td>控制台 "No datasource found"</td><td>未完成摄取或段未加载</td><td>Coordinator/Historical 日志与 Segments 页签</td><td>等待任务完成；检查 Deep Storage 与 Historical 可用性</td></tr><tr><td>查询很慢/超时</td><td>时间分区/过滤未命中、堆外内存不足</td><td>Broker/Historical 日志、查询计划</td><td>优化时间过滤与维度索引；增大处理线程与内存缓冲</td></tr><tr><td>Kafka 流摄取失败</td><td>Topic 不可达或鉴权错误</td><td>Indexing Service 日志含连接/鉴权报错</td><td>校验 <code>bootstrap.servers</code> 与 SASL/SSL 配置，独立 <code>kcat</code> 连通性测试</td></tr><tr><td>时间范围错位</td><td>时区/时间戳解析不一致</td><td>采集与查询的时区/格式检查</td><td>统一 <code>ingestion timestampSpec</code> 与查询时区；必要时做 <code>transform</code></td></tr><tr><td>权限/可执行报错</td><td>可执行位/目录权限不足</td><td><code>ls -l bin/</code>、系统日志</td><td><code>chmod +x bin/*</code>；确保运行用户对安装目录可读写</td></tr><tr><td>"找不到配置"/参数不生效</td><td>修改后未刷新环境/路径错误</td><td><code>echo $DRUID_HOME/which druid</code></td><td>重新 <code>source /etc/profile</code>，核对配置目录与实际启动脚本</td></tr><tr><td>段未分配/查询缺数据</td><td>Historical 离线或负载不均</td><td>Coordinator UI 的 Segment 分配状态</td><td>启动/扩容 Historical；检查存储可达与副本均衡策略</td></tr></tbody></table>
<h2 data-id="heading-20">其他系列</h2>
<h3 data-id="heading-21">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI-调查研究-108-具身智能 机器人模型训练全流程详解：从预训练到强化学习与人类反馈</strong></p>
<h3 data-id="heading-22">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-154 深入浅出 MongoDB 用Java访问 MongoDB 数据库 从环境搭建到CRUD完整示例</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务正在更新！深入浅出助你打牢基础！</p>
<h3 data-id="heading-23">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面向 LLM 的 GPU 系统工程方法论]]></title>    <link>https://juejin.cn/post/7571355146770907178</link>    <guid>https://juejin.cn/post/7571355146770907178</guid>    <pubDate>2025-11-12T01:40:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146770907178" data-draft-id="7571334572769247275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面向 LLM 的 GPU 系统工程方法论"/> <meta itemprop="keywords" content="人工智能,面试,GPU"/> <meta itemprop="datePublished" content="2025-11-12T01:40:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面向 LLM 的 GPU 系统工程方法论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:40:46.000Z" title="Wed Nov 12 2025 01:40:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 我们今天为大家带来的文章，作者的观点是：GPU 工程的核心不在于手写内核的能力，而在于构建系统设计思维 —— 理解从模型定义到硬件层的完整技术栈如何协同工作。</p>
<p>作者提出了一个五层渐进式调试框架：从模型定义（Model Definition）入手，识别计算与内存瓶颈；进入并行化（Parallelization）阶段，解决多卡同步问题；深入运行时编排（Runtime Orchestration），优化集群资源利用率；通过编译与优化（Compilation &amp; Optimization）提升生产环境性能；最终触及硬件层的物理极限。文章阐释了每一层级的典型瓶颈与解决思路，强调 80% 的问题可通过前三层的系统设计解决，内核工程仅在边缘场景中才真正发挥作用。</p>
</blockquote>
<p><strong>作者 | Abi Aryan</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>最近有条推文在 X 平台爆火——</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfa75c1ae76941dd885ba87aefbe60bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=8p3stJNvwRxEsxe5c0CSJcAoN%2BM%3D" alt="image.png" loading="lazy"/></p>
<p>大多数人看到后的想法是：我得学会 CUDA 内核开发才能体现自身价值。</p>
<p>但事实并非如此。</p>
<blockquote>
<p>即便投入毕生精力，你大概率也挤不进那个百人左右的精英圈子。</p>
</blockquote>
<p>内核开发固然重要，但不应作为入门起点。首要的是理解整个系统应该如何协同运作。</p>
<p>你或许读过无数关于 Triton 内核、将 PCIe 与 NVLink 进行对比、或是 DeepSpeed ZeRO 的帖子，但作为 GPU 工程师，真正的核心问题不是“我能手写内核吗”，而是“这些模块如何衔接？何时需要关注哪个环节？”因为行业真正的短板并非工具使用能力，而是系统设计能力。</p>
<p>极少有人能真正将模型视为硬件中流动的字节，将张量看作内存中的布局排列 —— 这正是内核工程师的思维境界。但若想进入这个精英群体，你首先得理解一切是如何映射的。</p>
<p>今天这篇文章，我就来帮你建立这种系统设计的认知框架。</p>
<p>当你的模型分布在几十甚至上百块 GPU 上时，你问的就不再只是“我的代码对不对？”，而是“我的 GPU 们是否高效协同工作，还是在互相拖后腿？”</p>
<p>真正的瓶颈往往出现在同步、通信、调度和资源利用率上。</p>
<p>为了理解这一点，我们先退一步，看看所有模型都会经历的系统工作流程（从左向右）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1379340274c478db9d2b1f0a0db3d37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=R%2FAHCr%2FlAIrLrGR1skOmJ7Ny0DE%3D" alt="image.png" loading="lazy"/></p>
<p>我们总是从模型定义层（Model Definition）入手。这一步更快速、更简单，且杠杆效应更高。只有当你无法在此层解决问题时，才需要逐级深入后续环节。</p>
<h2 data-id="heading-0"><strong>01 第一层：模型定义（Model Definition）</strong></h2>
<p>这是大多数机器学习工程师起步并投入最多时间的地方：定义 Transformer 层、将其接入 PyTorch、依赖自动微分系统，并将一系列张量运算串联起来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5105e58eb9124247a970c36bcfeed139~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=y%2BgOL0%2F6e%2Ftt%2BNW%2BuJq2cCSCRmI%3D" alt="image.png" loading="lazy"/></p>
<p>这一阶段出现问题，通常源于：</p>
<ul>
<li>稠密矩阵乘法受计算限制，使 GPU 算术逻辑单元达到或接近最大工作负荷。</li>
<li>注意力层受内存带宽制约，卡在等待数据传输，而非计算本身。</li>
<li>启动了过多的小型计算内核，导致调度开销过大。</li>
</ul>
<p>在这一阶段调试，意味着使用 PyTorch 或 JAX 工具进行性能分析，并思考： <strong>“这属于计算问题、内存问题，还是框架效率问题？”</strong></p>
<p>现在让我们看个实例——</p>
<p>当你的大语言模型规模暴增时，限制训练速度的不只是计算能力，更关键的是内存带宽。</p>
<p>当 GPT 这类模型的参数规模变得极其庞大时，限制训练速度的主要因素不再是 GPU 的计算能力，而是数据搬运的速度（即内存带宽）。特别是在计算自注意力机制中的 Q（查询）、K（键）、V（值）矩阵时，需要频繁地在显存中存取海量数据，这个“搬运数据”的过程成为了整个系统的瓶颈。解决方案是什么？FlashAttention —— 一种通过重新组织计算顺序来减少内存延迟的融合核函数。若不理解系统原理，你根本无法解释 GPU 为何处于闲置状态。</p>
<p>你的职责是确保模型运行，尝试优化，继而进行调试。</p>
<p>掌握每层对应的工具和框架，能帮你解决 80% 的问题，kernel engineering 则能帮你榨取剩下的 20%。但若妄想绕过基础直接攻克那 20%，很遗憾，我的结论依然成立。</p>
<blockquote>
<p>即便投入毕生精力，你大概率也挤不进那个百人左右的精英圈子。</p>
</blockquote>
<p>在调试过程中，你会循着下图所示的层级链条，依次逐层深入排查问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d77aeae97614db9a656593744fdef59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=FrisOyQ2ua3vQvLpPXRwmzvWMaE%3D" alt="image.png" loading="lazy"/></p>
<p>请将 GPU 协同调度工作想象成楼梯。每一级台阶都对应技术栈中的不同层级，每层都对应着独特的性能瓶颈与故障模式。只要某一层没处理好，整体性能就会下降。请从最顶层开始，仅在必要时才向下深入。</p>
<p>接下来，让我们看向下一层级——</p>
<h2 data-id="heading-1"><strong>02 第二层：并行化（Parallelization）</strong></h2>
<p>假设单块 GPU 已无法满足你的大语言模型（LLM）训练需求——这几乎是常态。于是你开始横向扩展，这时你就进入了并行化（Parallelization）阶段。这时，核心挑战往往不再是单卡的计算能力，而是多卡间的同步问题：梯度必须在 GPU 之间流动，模型参数需要分片，优化器状态也得拆分。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06305ed18cab4487b884326fd680cbcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=pwxNUqRXnDllSExNfHsRpD8q2RQ%3D" alt="image.png" loading="lazy"/></p>
<p>在这一层，瓶颈通常来自于：</p>
<ul>
<li>同步式全规约核函数因少数几个速度慢的 GPU 而陷入等待。</li>
<li>PCIe 或 NVLink 带宽限制，或是</li>
<li>异步更新虽提升了吞吐量，却可能引入过时梯度（stale gradients）的风险。</li>
</ul>
<p>到了这一层，你的<strong>核心问题就从“我的计算内核是否高效？”转变为“我的 GPU 集群是否在高效交换信息？”</strong> 。DeepSpeed ZeRO 能帮助你对状态和梯度进行分片，但同时也会引入通信开销。</p>
<p>此时，瓶颈不再是 GPU 计算核心，而是网络互联架构（network fabric）。你需要在强同步（稳定但较慢）和宽松的异步更新（更快但有风险）之间做权衡。</p>
<p>如果性能分析显示通信与计算的重叠程度不佳，或许可采用融合核函数（fused kernels）或自定义核函数来降低传输期间的计算开销，但这类情况较为罕见，通常 DeepSpeed ZeRO 或 Megatron-LM 已经内置了这类优化。</p>
<p>接下来我们继续深入下一层级——</p>
<h2 data-id="heading-2"><strong>03 第三层：运行时编排（Runtime Orchestration）</strong></h2>
<p>当你从单一模型训练任务扩展到大规模任务集群时，就进入了运行时编排（Runtime Orchestration）阶段。<strong>此时，你不再纠结于“我的注意力核函数高效吗？”，转而追问：“为什么我有 30% 的 GPU 处于空闲状态？”</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e49d9f780340aeab62d168aef45dd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=4mALTNIEg614NDiwIns9%2F%2B%2Fayck%3D" alt="image.png" loading="lazy"/></p>
<p>在这一层，问题通常表现为：</p>
<ul>
<li>半数 GPU 因某个计算节点延迟而集体闲置。</li>
<li>因调度策略不公导致任务在队列中阻塞。</li>
<li>大量零散小任务导致资源碎片化，造成集群资源浪费。</li>
</ul>
<p>在此层级调试，意味着你要问： <strong>“我是否有效地编排了资源，让 GPU 把时间花在训练上，而不是等待上？”</strong></p>
<p>来看一个例子 —— 我们在演讲中讨论过的 DeepMind 案例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98dc028ff8f14d58bfb9835b17a7e0da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=%2BLAra4zwTNR5UINFDSi7n5ru7LE%3D" alt="image.png" loading="lazy"/></p>
<p>TLDR：DeepMind 报告称，即使拥有数千块 GPU，分布式训练仍会卡顿，因为少数慢节点拖慢了全局同步。在数据并行训练中，整个任务必须等待最慢的那个工作节点。Ray 和 Kubernetes 通过弹性管理（节点故障时重新分配任务）和调度优化（避免 GPU 在队列中闲置）来缓解这类问题。</p>
<p>但编排系统无法凭空修复糟糕的同步逻辑——你必须同时调优编排策略和并行化设计。</p>
<p>一旦这些基础工作到位，你才可能去写融合核函数（fused kernels），或是优化集合通信核函数（比如自定义的 all-reduce 实现），以略微减少 GPU 在等待通信时的计算空窗期；或者预取张量、对齐数据来适配 DMA 传输；又或者实现能感知调度的自定义核函数，在 Ray/Kubernetes 等编排器调度任务的同时，更充分地利用 GPU 流水线。</p>
<p>但再次强调：<strong>kernel engineering 仅适用于边缘场景，且是否需要它，完全取决于调试过程中遇到的具体问题类型。</strong></p>
<h2 data-id="heading-3"><strong>04 第四层：编译与优化</strong> <strong>（Compilation &amp; Optimization）</strong></h2>
<p>训练完成后，大语言模型（LLMs）需要服务数百万请求，此时你关注的是生产环境中的延迟（latency）和吞吐量（throughput）。在这个阶段，每一毫秒都至关重要。编译器通过融合核函数、优化数据在内存中的存放和访问方式以及降低精度等方式来解决这些问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69e0279a094840d5a50a2970431ee682~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=tvca3HqU0PphoIgXKRENHpMQgL4%3D" alt="image.png" loading="lazy"/></p>
<p>因此，该层级的主要挑战在于：</p>
<ul>
<li>过多小型操作导致的核函数启动开销。</li>
<li>程序运行时间主要被内存数据传输所占据（例如嵌入向量查询）。</li>
<li>缺乏融合或量化技术导致性能潜力未被释放。</li>
</ul>
<p>此时的瓶颈已不再是训练速度，而是在真实流量下的吞吐量与延迟表现。在此层级调试，意味着你要对推理负载进行性能分析，并思考： <strong>“我是否在每一块 GPU 算力上榨取了最大吞吐收益？”</strong></p>
<p>以 ChatGPT 推理为例：其推理过程通常涉及大量小型操作（即逐 token 生成）。如果每个操作都单独启动一个核函数，那么核函数启动开销就会成为性能瓶颈。</p>
<p>像 TorchInductor 这样的编译器会将多个操作融合成更大的核函数，而 TensorRT 则通过将模型量化为 FP16 或 INT8 来节省计算和内存开销。随后，Triton Server 对多个推理请求进行动态批处理（batching），从而让 GPU 能够高效地同时处理成千上万的请求。</p>
<p>正是在这一层，kernel engineering 才真正变得重要。与 Layer 1–3 不同，Layer 4 是手写调优或编译器级干预能显著影响延迟和吞吐的阶段。不过，通常只有在现有编译器能力已被充分挖掘之后，你才会考虑编写自定义核函数。自定义核函数适用于那些在单次推理或训练步骤中被调用数百万甚至数十亿次的高频率操作。</p>
<p>因此，核心要旨在于——</p>
<blockquote>
<p>Layers 1–3：聚焦系统设计、资源编排与并行化策略，核函数编写在此层面基本无关紧要。</p>
<p>Layer 4：运用编译器优化、批处理、量化与融合技术，大多数现实场景的瓶颈在此即可解决。</p>
<p>而定制核函数仅当性能分析证实现有优化仍不足，且存在值得手工调优的高杠杆操作时才能真正派上用场。</p>
</blockquote>
<h2 data-id="heading-4"><strong>05 第五层：硬件层</strong></h2>
<p>这是整个系统的基石。所有核函数、同步操作与分片策略，最终都受限于 GPU 及互联硬件的物理极限。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5c5444fe9fd4ea284f79778fed31ce2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=git%2F%2BqLT6uwba3826OJkpgAeQXA%3D" alt="image.png" loading="lazy"/></p>
<p>这一层级的瓶颈表现为：</p>
<ul>
<li>模型并行时达到 NVLink 带宽上限。</li>
<li>跨节点扩展时 PCIe 成为性能瓶颈。</li>
<li>GPU 显存容量不足，被迫将数据卸载（offload）到 NVMe 存储。</li>
</ul>
<p>这些问题无法通过框架层面的优化来“修复”。你只能通过重构工作负载、降低精度（如使用 FP16/INT8），或直接升级硬件来规避。</p>
<p>在大规模训练中，当数千块 GPU 同步梯度时，InfiniBand 网络链路常常会被打满。这种瓶颈无法靠写代码绕过去——PCIe 和 NVLink 的带宽是有限的。也正是在这里，AI 工程开始与硬件工程深度融合。</p>
<p>唯一的解决方案来自架构层面：采用更先进的互联技术、降低同步频率，或重新设计算法以减少通信量。</p>
<p>此处引入我们讨论过的另一个案例研究——</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01cdbfa558244d9a97e7b804f36e0fee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516445&amp;x-signature=vnVs9%2Bj0A2cGiKpBR%2F0fKW5fUR4%3D" alt="image.png" loading="lazy"/></p>
<p>Spectrum X 能够分析 GPU 显存使用率、互联带宽（NVLink/PCIe/InfiniBand）及核函数执行情况，精准定位瓶颈所在。</p>
<h2 data-id="heading-5"><strong>06 The Key Lesson</strong></h2>
<p>每一层都是模块化的，但又相互依赖：</p>
<ul>
<li>如果在模型定义层（Model Definition）内存管理不当，就会在并行化层（Parallelization）引发通信瓶颈。</li>
<li>如果在并行化层（Parallelization）同步配置错误，就会导致运行时编排层（Runtime Orchestration）GPU 大量闲置。</li>
<li>如果在编译层（Compilation）忽视核函数融合（kernel fusion），就会在生产环境中因延迟过高而白白烧钱。</li>
</ul>
<p>因此，当你的模型：</p>
<blockquote>
<p><strong>受计算限制（Compute-bound）</strong>  → 通过模型或核函数优化来解决。</p>
<p><strong>受内存限制（Memory-bound）</strong>  → 通过分片（sharding）、重计算（recomputation）和核函数融合来缓解。</p>
<p><strong>受通信限制（Communication-bound）</strong>  → 依靠并行化（parallelization）和运行时编排（orchestration）来应对。</p>
</blockquote>
<p>一旦你掌握了这张系统地图，那些零散的博客文章、论文和争论就不再杂乱无章 —— 它们会立刻各归其位，成为整个大系统中清晰可辨的组成部分。</p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓你在训练或推理中遇到的性能瓶颈，更多来自计算、内存，还是通信？是怎么发现的？</strong></p>
<p><strong>本文经原作者授权，由</strong> <strong>Baihai IDP</strong> <strong>编译。如需转载译文，请联系获取授权。</strong></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcraft.substack.com%2Fp%2Ffundamentals-of-gpu-engineering" target="_blank" title="https://modelcraft.substack.com/p/fundamentals-of-gpu-engineering" ref="nofollow noopener noreferrer">modelcraft.substack.com/p/fundament…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[服务器大量请求超时？从网络到代码的全链路排查指南]]></title>    <link>https://juejin.cn/post/7571332468898480155</link>    <guid>https://juejin.cn/post/7571332468898480155</guid>    <pubDate>2025-11-12T01:41:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571332468898480155" data-draft-id="7571338749198630962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="服务器大量请求超时？从网络到代码的全链路排查指南"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-12T01:41:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            服务器大量请求超时？从网络到代码的全链路排查指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:41:28.000Z" title="Wed Nov 12 2025 01:41:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">服务器大量请求超时？从网络到代码的全链路排查指南</h2>
<p>做后端开发或运维时，最棘手的问题莫过于 “服务器突然大量请求超时”—— 客户端报 504 Gateway Timeout、浏览器显示 “连接超时”，服务端日志刷满超时错误，但不知道从哪下手排查。可能是网络断了，可能是服务崩了，也可能是数据库卡住了，盲目重启服务往往治标不治本。</p>
<p>本文结合 10 + 年运维与开发经验，总结出一套 “分层排查、工具落地、根因定位” 的标准化流程，覆盖请求链路的每一个环节，帮你快速找到超时根源。</p>
<h3 data-id="heading-1">一、先明确：请求超时的 “表象与范围”（避免盲目排查）</h3>
<p>排查前先搞清楚两个核心问题，缩小排查范围：</p>
<ol>
<li><strong>超时的具体表现</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>客户端：是 “连接超时”（无法建立 TCP 连接，如 telnet 不通）还是 “读取超时”（能连接但没响应，如 curl 卡住）？</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>服务端：是 “所有请求超时” 还是 “部分接口超时”？是 “特定客户端超时” 还是 “全量客户端超时”？</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>超时的时间节点</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>是突然发生（如运维操作后、流量突增时）还是逐渐恶化（如内存泄漏导致缓慢超时）？</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>是否有规律（如每天固定时段超时，可能是定时任务抢占资源）？</li>
</ul>
</li>
</ul>
<p><strong>举例</strong>：若 “只有北京地区客户端超时，其他地区正常”，大概率是网络链路问题；若 “只有调用数据库的接口超时，静态接口正常”，则聚焦数据库层排查。</p>
<h3 data-id="heading-2">二、分层排查：从 “请求链路” 拆解问题（从外到内，逐步缩小范围）</h3>
<p>请求从客户端到服务端的完整链路是：客户端 → 网络 → 负载均衡（Nginx/HAProxy） → 应用服务 → 中间件（数据库/Redis/MQ），超时必然发生在某一层，按 “从外到内” 顺序排查，效率最高。</p>
<h4 data-id="heading-3">第一层：网络层排查（先排除 “物理链路” 问题）</h4>
<p>网络是最容易被忽略但最基础的环节，若网络不通，后面的排查都是白费。</p>
<h5 data-id="heading-4">1. 验证 “客户端到负载均衡” 的连通性</h5>
<p>用「基础网络工具」测试链路是否通畅、延迟与丢包率是否正常：</p>



































<table><thead><tr><th>工具</th><th>作用</th><th>命令示例（以目标 IP 10.0.0.1，端口 8080 为例）</th><th>异常判断标准</th></tr></thead><tbody><tr><td>ping</td><td>测试 IP 层连通性</td><td>ping 10.0.0.1 -c 10（发送 10 个包）</td><td>丢包率 &gt; 5%，或延迟 &gt; 100ms（非跨地域）</td></tr><tr><td>telnet</td><td>测试 TCP 端口是否开放</td><td>telnet 10.0.0.1 8080 或 nc -zv 10.0.0.1 8080（nc 更简洁）</td><td>提示 “Connection refused”（端口未开）或 “timeout”（链路不通）</td></tr><tr><td>traceroute</td><td>定位链路中哪个节点卡顿</td><td>traceroute 10.0.0.1（Linux）或 tracert 10.0.0.1（Windows）</td><td>某一跳延迟突然从 50ms 升至 500ms，或出现 “* * *”（节点不可达）</td></tr><tr><td>tcpdump</td><td>抓包分析 TCP 连接是否正常建立</td><td>tcpdump -i eth0 host 10.0.0.1 and port 8080 -w timeout.pcap</td><td>没有 TCP 三次握手包（SYN→SYN+ACK→ACK），或握手后无数据传输</td></tr></tbody></table>
<p><strong>案例</strong>：某电商平台突然大量超时，用traceroute发现 “运营商骨干节点故障”，导致客户端到负载均衡的链路丢包率达 30%，联系运营商修复后恢复正常。</p>
<h5 data-id="heading-5">2. 排查 “负载均衡到应用服务” 的内网连通性</h5>
<p>若客户端到负载均衡正常，再检查内网链路（避免内网交换机、防火墙问题）：</p>
<ul>
<li>登录负载均衡服务器，执行telnet 应用服务IP 应用端口（如telnet <a href="https://link.juejin.cn?target=http%3A%2F%2F10.0.0.2" target="_blank" title="http://10.0.0.2" ref="nofollow noopener noreferrer">10.0.0.2</a> 9000）；</li>
</ul>

<ul>
<li>若内网不通，检查：</li>
</ul>
<p>① 应用服务是否启动（端口是否监听）；</p>
<p>② 内网防火墙是否拦截（如 iptables 规则、安全组）；</p>
<p>③ 内网路由是否配置正确（尤其跨网段部署时）。</p>
<h4 data-id="heading-6">第二层：负载均衡层排查（Nginx/HAProxy 常见问题）</h4>
<p>负载均衡是请求的 “入口网关”，若配置不当或过载，会直接导致请求超时。</p>
<h5 data-id="heading-7">1. 先看 “负载均衡是否存活与过载”</h5>
<ul>
<li><strong>存活检查</strong>：访问负载均衡的健康检查页面（如 Nginx 的/nginx_status），确认负载均衡本身是否正常运行；</li>
</ul>

<ul>
<li><strong>过载判断</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>Nginx：查看top命令中 Nginx 进程的 CPU / 内存使用率（若 CPU&gt;80% 或内存持续增长，可能过载）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>查看连接数：netstat -an | grep :80 | wc -l（对比 Nginx 配置的worker_connections，若接近上限，说明连接数满了）。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-8">2. 再查 “负载均衡配置与转发逻辑”</h5>
<p>常见导致超时的配置问题：</p>
<ul>
<li><strong>超时时间配置过短</strong>：</li>
</ul>
<p>Nginx 默认的proxy_connect_timeout（与后端连接超时）是 60 秒，proxy_read_timeout（等待后端响应超时）是 60 秒，若后端接口处理慢（如大数据查询），需调大：</p>
<pre><code class="hljs language-bash" lang="bash">location /api/ {
  proxy_pass http://app_servers;
  proxy_connect_timeout 120s;  <span class="hljs-comment"># 连接超时120秒</span>
  proxy_read_timeout 120s;     <span class="hljs-comment"># 读取响应超时120秒</span>
}
</code></pre>
<ul>
<li><strong>后端服务健康检查失效</strong>：</li>
</ul>
<p>若负载均衡仍向 “已宕机的应用服务” 转发请求，会导致大量超时。检查 Nginx 的upstream配置是否开启健康检查：</p>
<pre><code class="hljs language-ini" lang="ini">upstream app_servers {
  server 10.0.0.2:9000 <span class="hljs-attr">max_fails</span>=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s<span class="hljs-comment">;  # 3次失败后，30秒内不转发</span>
  server 10.0.0.3:9000 <span class="hljs-attr">max_fails</span>=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">30</span>s<span class="hljs-comment">;</span>
  health_check <span class="hljs-attr">interval</span>=<span class="hljs-number">5</span>s rise=<span class="hljs-number">2</span> fall=<span class="hljs-number">3</span><span class="hljs-comment">;  # 每5秒检查，2次成功恢复，3次失败标记宕机</span>
}
</code></pre>
<ul>
<li><strong>请求排队堆积</strong>：</li>
</ul>
<p>查看 Nginx 的access.log，若大量请求的响应时间（$request_time）超过 10 秒，且后端服务 CPU 不高，可能是负载均衡的worker_processes配置不足（建议设为与 CPU 核心数一致）。</p>
<h4 data-id="heading-9">第三层：应用服务层排查（代码与 JVM / 进程问题）</h4>
<p>若负载均衡转发正常，问题大概率在应用服务本身 —— 可能是代码卡住、线程池满了、JVM 内存溢出等。</p>
<h5 data-id="heading-10">1. 快速判断 “应用服务是否存活”</h5>
<ul>
<li><strong>端口监听检查</strong>：netstat -tulpn | grep 应用端口（如grep 9000），若没有进程监听，说明服务已宕机；</li>
</ul>

<ul>
<li><strong>基础接口测试</strong>：调用服务的 “健康检查接口”（如/actuator/health），若无法访问或返回非 200，说明服务异常。</li>
</ul>
<h5 data-id="heading-11">2. 排查 “应用服务是否过载或卡住”</h5>
<ul>
<li><strong>系统资源监控</strong>：用top/vmstat查看 CPU、内存、IO 是否异常：</li>
</ul>

<ul>
<li>
<ul>
<li>CPU：top命令中，若应用进程的%CPU持续 100%，可能是死循环或计算密集型任务过载；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>内存：free -m查看内存是否耗尽（available接近 0），或jstat -gc 进程ID 1000查看 JVM GC 是否频繁（Full GC 每秒多次，会导致服务卡顿）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>IO：iostat -x 1查看磁盘 IO 使用率（%util接近 100%，说明磁盘读写卡住，如日志刷盘过频繁）。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>线程状态分析</strong>：</li>
</ul>
<p>若 CPU / 内存正常，但请求仍超时，可能是线程池满了或线程死锁。以 Java 服务为例：</p>
<p>① 用jstack 进程ID &gt; thread.log导出线程栈；</p>
<p>② 分析thread.log：</p>
<ul>
<li>
<ul>
<li>若大量线程处于WAITING状态（如等待数据库连接），说明资源不足；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>若存在BLOCKED状态且持有锁的线程长期不释放，说明死锁。</li>
</ul>
</li>
</ul>
<p><strong>案例</strong>：某 Java 服务超时，jstack发现 100 个线程都卡在 “获取数据库连接”（WAITING on com.alibaba.druid.pool.DruidDataSource），检查发现数据库连接池配置的maxActive=50，而并发请求达 100，导致线程排队超时。</p>
<h5 data-id="heading-12">3. 查看 “应用日志中的具体错误”</h5>
<p>应用日志是定位代码问题的关键，重点看：</p>
<ul>
<li><strong>错误日志</strong>：如 Java 的error.log、Python 的logging.error，是否有 “数据库连接超时”“第三方接口超时”“空指针异常导致服务卡住” 等错误；</li>
</ul>

<ul>
<li><strong>请求日志</strong>：记录每个请求的 “请求参数、处理时间、响应状态”，若某接口的处理时间突然从 100ms 升至 5000ms，说明该接口的代码逻辑有问题（如 SQL 优化失效、缓存穿透）。</li>
</ul>
<h4 data-id="heading-13">第四层：中间件层排查（数据库 / Redis/MQ 等依赖问题）</h4>
<p>应用服务本身没问题时，要排查 “服务依赖的中间件”—— 很多超时是因为中间件卡住，导致应用服务等待超时。</p>
<h5 data-id="heading-14">1. 数据库超时（最常见的依赖超时）</h5>
<ul>
<li><strong>先验证数据库连通性</strong>：登录应用服务服务器，执行mysql -h 数据库IP -u 用户名 -p（MySQL）或psql -h 数据库IP -U 用户名 -d 数据库名（PostgreSQL），看是否能正常连接；</li>
</ul>

<ul>
<li><strong>再查数据库是否过载</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>CPU：top查看数据库进程（如 mysqld）的 CPU 使用率，若 &gt; 80%，可能是慢查询导致；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>连接数：MySQL 执行show global status like 'Threads_connected';，对比max_connections配置，若接近上限，说明连接数满了；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>慢查询：查看 MySQL 的慢查询日志（需开启slow_query_log），执行show slow logs;，若大量 SQL 的执行时间 &gt; 1000ms，需优化 SQL（加索引、分表等）；</li>
</ul>
</li>
</ul>

<ul>
<li><strong>锁等待问题</strong>：</li>
</ul>
<p>MySQL 执行show engine innodb status\G;，查看是否有 “长事务锁等待”（如某事务持有行锁未释放，导致其他请求等待超时）。</p>
<h5 data-id="heading-15">2. Redis 超时</h5>
<ul>
<li><strong>连通性测试</strong>：redis-cli -h RedisIP -p 6379 ping，若返回PONG说明连通，返回timeout说明网络或 Redis 服务问题；</li>
</ul>

<ul>
<li><strong>Redis 过载检查</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>执行info stats，查看instantaneous_ops_per_sec（每秒操作数），若远超 Redis 性能上限（单实例建议 &lt; 10 万 / 秒），需扩容；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>执行info memory，查看used_memory_rss（Redis 占用物理内存），若接近服务器内存，可能导致 Swap 使用，变慢超时。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-16">3. 第三方接口超时</h5>
<p>若应用服务调用了外部接口（如支付接口、短信接口），需排查：</p>
<ul>
<li><strong>直接调用测试</strong>：在应用服务服务器上用curl调用第三方接口（如curl -v <a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.thirdparty.com%2Fpay" target="_blank" title="https://api.thirdparty.com/pay" ref="nofollow noopener noreferrer">api.thirdparty.com/pay</a>），看是否超时；</li>
</ul>

<ul>
<li><strong>超时时间配置</strong>：检查应用代码中调用第三方接口的超时时间是否过短（如设置 1 秒，而第三方接口正常响应需 2 秒），建议设为 3-5 秒，并加重试机制。</li>
</ul>
<h3 data-id="heading-17">三、排查工具汇总：高效定位问题的 “武器库”</h3>
<p>不同环节对应不同工具，整理成表方便查阅：</p>









































<table><thead><tr><th>排查环节</th><th>核心工具</th><th>作用</th><th>关键指标 / 命令</th></tr></thead><tbody><tr><td>网络层</td><td>ping/traceroute/tcpdump</td><td>链路连通性、丢包、延迟</td><td>丢包率、延迟、TCP 三次握手</td></tr><tr><td>负载均衡</td><td>Nginx status/HAProxy stats</td><td>连接数、转发状态、健康检查</td><td>proxy_read_timeout、upstream状态</td></tr><tr><td>应用服务</td><td>top/jstack/jstat/netstat</td><td>系统资源、线程状态、JVM GC</td><td>CPU 使用率、线程 BLOCKED 数、Full GC 次数</td></tr><tr><td>数据库</td><td>show status/show slow logs</td><td>连接数、慢查询、锁等待</td><td>Threads_connected、慢查询数</td></tr><tr><td>全链路监控</td><td>SkyWalking/Pinpoint</td><td>跟踪请求在全链路的耗时分布</td><td>各环节耗时（网络→应用→数据库）</td></tr></tbody></table>
<h3 data-id="heading-18">四、常见超时根因与解决方案（查找到问题后怎么解决）</h3>








































<table><thead><tr><th>超时根因</th><th>解决方案</th><th>预防措施</th></tr></thead><tbody><tr><td>网络链路丢包 / 延迟高</td><td>更换运营商链路、使用专线 / CDN</td><td>部署多链路冗余，监控链路丢包率</td></tr><tr><td>负载均衡连接数满 / 超时短</td><td>调大worker_connections/ 超时配置</td><td>配置健康检查，过载时自动扩容</td></tr><tr><td>应用线程池满 / 死锁</td><td>调大线程池、修复死锁代码</td><td>监控线程池状态，超时告警</td></tr><tr><td>数据库慢查询 / 连接满</td><td>优化 SQL、加索引、调大连接池</td><td>开启慢查询日志，定期优化 SQL</td></tr><tr><td>Redis 过载 / 内存满</td><td>扩容 Redis 集群、清理过期数据</td><td>监控 Redis ops 和内存，提前扩容</td></tr><tr><td>第三方接口超时</td><td>调大超时时间、加重试 + 熔断</td><td>接入多第三方服务商，超时降级</td></tr></tbody></table>
<h3 data-id="heading-19">五、排查流程总结：3 步快速定位</h3>
<ol>
<li><strong>先看 “外层”</strong> ：用 ping/telnet 排查网络，用负载均衡状态排查转发，排除基础链路问题；</li>
</ol>

<ol start="2">
<li><strong>再查 “中层”</strong> ：用 top/jstack 看应用服务资源与线程，用日志看具体错误，定位应用是否卡住；</li>
</ol>

<ol start="3">
<li><strong>最后追 “依赖”</strong> ：检查数据库 / Redis / 第三方接口，看是否依赖导致应用等待超时。</li>
</ol>
<p><strong>关键原则</strong>：不要上来就重启服务（可能丢失日志），不要盲目修改配置（可能引入新问题），先定位根因，再动手解决。</p>
<h3 data-id="heading-20">六、预防措施：避免下次再出现大量超时</h3>
<ol>
<li><strong>全链路监控</strong>：部署 SkyWalking/Pinpoint，实时监控各环节耗时，超时提前告警（如接口耗时 &gt; 3 秒告警）；</li>
</ol>

<ol start="2">
<li><strong>压测与容量规划</strong>：上线前用 JMeter/LoadRunner 压测，确认服务能承受峰值流量，避免过载；</li>
</ol>

<ol start="3">
<li><strong>冗余与降级</strong>：关键服务部署多实例，中间件用集群，第三方接口加熔断降级（如 Sentinel），避免单点故障导致全量超时；</li>
</ol>

<ol start="4">
<li><strong>日志规范</strong>：确保应用日志记录 “请求参数、耗时、错误栈”，方便后续排查。</li>
</ol>
<h3 data-id="heading-21">总结</h3>
<p>服务器大量请求超时不是 “绝症”，而是 “有迹可循的链路问题”。核心是 “分层排查、工具落地”—— 从网络到应用，从系统到依赖，每一步都用工具验证，避免凭感觉猜测。记住：排查的速度取决于 “是否掌握标准化流程”，而解决的质量取决于 “是否找到根因”。</p>
<p>下次遇到超时，按本文流程一步步来，你会发现：原来定位问题比解决问题更简单。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CANN训练营实战指南：从算子分析到核函数定义的完整开发流程]]></title>    <link>https://juejin.cn/post/7571355146770939946</link>    <guid>https://juejin.cn/post/7571355146770939946</guid>    <pubDate>2025-11-12T01:48:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146770939946" data-draft-id="7571299394346696746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CANN训练营实战指南：从算子分析到核函数定义的完整开发流程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T01:48:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_摘星_"/> <meta itemprop="url" content="https://juejin.cn/user/2228036358374227"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CANN训练营实战指南：从算子分析到核函数定义的完整开发流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2228036358374227/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _摘星_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:48:44.000Z" title="Wed Nov 12 2025 01:48:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CANN训练营实战指南：从算子分析到核函数定义的完整开发流程</h2>
<h3 data-id="heading-1">训练营简介</h3>
<p>2025年昇腾CANN训练营第二季，基于CANN开源开放全场景，推出0基础入门系列、码力全开特辑、开发者案例等专题课程，助力不同阶段开发者快速提升算子开发技能。 完成Ascend C算子中级认证，即可领取精美证书，完成社区任务更有机会赢取华为手机，平板、开发板等大奖。 本次训练营依托CANN全面开源开放，推出四大定制化专题课程，满足开发者不同阶段的学习需求，快速提升Ascend C算子开发技术。</p>
<p><strong>报名链接：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f06d3602f49e48f59ba3b47735f18792~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-aRmOaYn18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516923&amp;x-signature=TwQUXcNazH8bfhWzUCZBsP94YbM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">摘要</h3>
<p>本文详细解析昇腾CANN训练营中Ascend C算子开发的完整流程，从算子分析到核函数定义，再到实现与验证。通过系统化的步骤分解和实战代码示例，帮助开发者掌握昇腾AI处理器自定义算子开发的核心技能，为参与CANN训练营和获得Ascend C算子中级认证打下坚实基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96d8528c50f24ea29b94cccc7b41f93a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-aRmOaYn18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516923&amp;x-signature=i9ZsWv2Jbk46EwJ2wF%2Fi3bPqv8g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">1. Ascend C算子开发概述</h3>
<h4 data-id="heading-4">1.1 Ascend C技术背景</h4>
<p>Ascend C是CANN针对算子开发场景推出的编程语言，原生支持C和C++标准规范，最大化匹配用户开发习惯；通过多层接口抽象、自动并行计算、孪生调试等关键技术，极大提高算子开发效率。 作为昇腾AI处理器的核心开发工具，Ascend C为开发者提供了从基础到高阶的完整API体系，使得开发者能够充分发挥昇腾硬件的计算性能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e05538eede4f1699c2c6bde7d42ab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-aRmOaYn18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516923&amp;x-signature=O2Ri9Ws2X4zTOrTtISpD46xk8Bk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">1.2 算子开发完整流程</h4>
<p>Ascend C算子开发遵循一套标准化流程，主要包括以下几个关键环节：</p>
<ul>
<li><strong>算子分析</strong>：分析算子的数学表达式、输入、输出以及计算逻辑的实现，明确需要调用的Ascend C接口。</li>
<li><strong>核函数定义</strong>：定义Ascend C算子入口函数，确定函数原型和参数。</li>
<li><strong>算子类实现</strong>：根据矢量编程或矩阵编程范式实现算子类的具体逻辑。</li>
<li><strong>编译部署</strong>：将算子代码编译为可在昇腾设备上运行的格式。</li>
<li><strong>调试验证</strong>：通过孪生调试等技术验证算子功能正确性。</li>
</ul>
<p>这个流程确保了算子开发的系统性和可维护性，是CANN训练营重点教授的核心内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50af8993d1164506b686a099b0a7a7c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-aRmOaYn18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763516923&amp;x-signature=bRlgSVBLPJXqFw0e0JJJAJxzk2M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2. 算子分析阶段</h3>
<h4 data-id="heading-7">2.1 算子需求分析</h4>
<p>在开始编码前，必须对目标算子进行深入分析。以Add算子为例，其数学表达式为<code>z = x + y</code>，其中x和y为输入张量，z为输出张量。 算子分析需要明确以下关键点：</p>
<ul>
<li><strong>输入输出规格</strong>：数据类型、形状、排布格式</li>
<li><strong>计算逻辑</strong>：数学公式、算法复杂度、性能瓶颈</li>
<li><strong>硬件特性</strong>：昇腾AI处理器的计算单元特性、内存访问模式</li>
<li><strong>接口选择</strong>：基础API还是高阶API，矢量编程还是矩阵编程</li>
</ul>
<h4 data-id="heading-8">2.2 算子规格定义</h4>
<p>完成分析后，需要将需求转化为具体的开发规格。以下是一个典型算子规格定义表：</p>













































<table><thead><tr><th>规格项</th><th>Add算子示例</th><th>Matmul算子示例</th></tr></thead><tbody><tr><td>输入数量</td><td>2个 (x, y)</td><td>2个 (a, b)</td></tr><tr><td>输出数量</td><td>1个 (z)</td><td>1个 (c)</td></tr><tr><td>支持数据类型</td><td>float16, float32</td><td>float16</td></tr><tr><td>数据排布格式</td><td>ND</td><td>ND</td></tr><tr><td>计算公式</td><td>z = x + y</td><td>c = a × b</td></tr><tr><td>访存模式</td><td>顺序读写</td><td>分块读写</td></tr><tr><td>并行策略</td><td>元素级并行</td><td>矩阵分块并行</td></tr></tbody></table>
<p>通过这样结构化的规格定义，开发者可以清晰地理解算子需求，为后续开发奠定基础。</p>
<h3 data-id="heading-9">3. 核函数定义阶段</h3>
<h4 data-id="heading-10">3.1 核函数基础概念</h4>
<p>核函数（Kernel Function）是Ascend C算子设备侧实现的入口。Ascend C允许用户使用C/C++函数的语法扩展来编写设备端的运行代码，用户在核函数中进行数据访问和计算。 核函数的正确定义是算子开发的关键第一步。</p>
<h4 data-id="heading-11">3.2 核函数原型设计</h4>
<p>核函数的原型设计需要考虑输入输出参数、内存地址传递等关键要素。以下是一个Add算子的核函数定义示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Add算子核函数定义</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(
    __gm__ <span class="hljs-type">float16_t</span>* x, 
    __gm__ <span class="hljs-type">float16_t</span>* y, 
    __gm__ <span class="hljs-type">float16_t</span>* z, 
    <span class="hljs-type">uint32_t</span> totalElements
)</span> </span>{
    <span class="hljs-comment">// 核函数实现</span>
    KernelAdd addOp;
    addOp.<span class="hljs-built_in">Init</span>(x, y, z, totalElements);
    addOp.<span class="hljs-built_in">Process</span>();
}
</code></pre>
<p>这段代码定义了一个名为<code>add_custom</code>的核函数，包含三个全局内存指针参数（x, y, z）和一个元素总数参数。<code>__global__</code>和<code>__aicore__</code>关键字指定了函数在设备端的执行位置，<code>__gm__</code>关键字表示全局内存访问。</p>
<h4 data-id="heading-12">3.3 核函数命名规范</h4>
<p>核函数名称可以自定义，但需要遵循一定的命名规范。例如，在Matmul算子示例中，核函数被命名为<code>matmul_leakyrelu_custom</code>，清晰地表达了算子功能。 良好的命名规范有助于代码的可读性和维护性。</p>
<h3 data-id="heading-13">4. 算子类实现阶段</h3>
<h4 data-id="heading-14">4.1 矢量编程范式</h4>
<p>对于元素级操作的算子（如Add、Sinh等），通常采用矢量编程范式。实现步骤包括：</p>
<ol>
<li><strong>定义算子类</strong>：继承自Ascend C的基础类</li>
<li><strong>实现Init方法</strong>：初始化内存地址和计算参数</li>
<li><strong>实现Process方法</strong>：核心计算逻辑</li>
<li><strong>实现内存访问</strong>：使用Ascend C提供的内存操作API</li>
</ol>
<p>以下是一个Sinh算子的算子类实现示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelSinh</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelSinh</span><span class="hljs-params">()</span> </span>{}
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, <span class="hljs-type">uint32_t</span> totalElements)</span> </span>{
        <span class="hljs-keyword">this</span>-&gt;x = x;
        <span class="hljs-keyword">this</span>-&gt;y = y;
        <span class="hljs-keyword">this</span>-&gt;totalElements = totalElements;
        <span class="hljs-comment">// 初始化片上内存</span>
        <span class="hljs-keyword">this</span>-&gt;tile.<span class="hljs-built_in">SetBuffer</span>(<span class="hljs-number">0</span>, inputBuffer.buffer, inputBuffer.buffer_size);
        <span class="hljs-keyword">this</span>-&gt;tile.<span class="hljs-built_in">SetBuffer</span>(<span class="hljs-number">1</span>, outputBuffer.buffer, outputBuffer.buffer_size);
    }
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 计算需要处理的块数</span>
        <span class="hljs-type">uint32_t</span> loopCount = totalElements / BUFFER_NUM;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; loopCount; i++) {
            <span class="hljs-comment">// 从全局内存加载数据到片上内存</span>
            <span class="hljs-built_in">DataCopy</span>(inputBuffer, x + i * BUFFER_NUM, BUFFER_NUM);
            <span class="hljs-comment">// 执行Sinh计算</span>
            <span class="hljs-built_in">SinhCompute</span>();
            <span class="hljs-comment">// 将结果写回全局内存</span>
            <span class="hljs-built_in">DataCopy</span>(y + i * BUFFER_NUM, outputBuffer, BUFFER_NUM);
        }
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">SinhCompute</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 获取输入和输出指针</span>
        <span class="hljs-type">float16_t</span>* src = inputBuffer.<span class="hljs-keyword">template</span> <span class="hljs-built_in">Get</span>&lt;<span class="hljs-type">float16_t</span>&gt;();
        <span class="hljs-type">float16_t</span>* dst = outputBuffer.<span class="hljs-keyword">template</span> <span class="hljs-built_in">Get</span>&lt;<span class="hljs-type">float16_t</span>&gt;();
        <span class="hljs-comment">// 逐元素计算Sinh</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; BUFFER_NUM; i++) {
            dst[i] = <span class="hljs-built_in">sinh</span>(src[i]); <span class="hljs-comment">// sinh计算</span>
        }
    }
    
    GM_ADDR x;            <span class="hljs-comment">// 输入地址</span>
    GM_ADDR y;            <span class="hljs-comment">// 输出地址</span>
    <span class="hljs-type">uint32_t</span> totalElements; <span class="hljs-comment">// 总元素数</span>
    TPipe pipe;           <span class="hljs-comment">// 数据管道</span>
    TBuf&lt;QuePosition::VECIN&gt; inputBuffer;  <span class="hljs-comment">// 输入缓冲区</span>
    TBuf&lt;QuePosition::VECOUT&gt; outputBuffer; <span class="hljs-comment">// 输出缓冲区</span>
    Tiling&lt;<span class="hljs-number">1</span>&gt; tile;       <span class="hljs-comment">// 内存分片</span>
};
</code></pre>
<p>这个实现展示了Sinh算子的核心逻辑，通过分块处理大张量数据，充分利用昇腾AI处理器的片上内存和计算资源。</p>
<h4 data-id="heading-15">4.2 矩阵编程范式</h4>
<p>对于矩阵运算类算子（如Matmul），需要采用矩阵编程范式。其实现流程更加复杂，通常包括：</p>
<ul>
<li><strong>核函数定义</strong>：定义Ascend C算子入口函数。</li>
<li><strong>算子类实现</strong>：根据矩阵编程范式实现算子类，调用私有成员函数<code>CopyIn</code>、<code>SplitA</code>、<code>SplitB</code>、<code>Compute</code>、<code>Aggregate</code>、<code>CopyOut</code>完成完整计算流程。</li>
</ul>
<p>以下是一个Matmul算子的核心实现框架：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelMatmul</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelMatmul</span><span class="hljs-params">()</span> </span>{}
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(GM_ADDR a, GM_ADDR b, GM_ADDR c, 
                               <span class="hljs-type">uint32_t</span> m, <span class="hljs-type">uint32_t</span> n, <span class="hljs-type">uint32_t</span> k)</span> </span>{
        <span class="hljs-comment">// 初始化矩阵维度和内存地址</span>
        <span class="hljs-keyword">this</span>-&gt;a = a; <span class="hljs-keyword">this</span>-&gt;b = b; <span class="hljs-keyword">this</span>-&gt;c = c;
        <span class="hljs-keyword">this</span>-&gt;m = m; <span class="hljs-keyword">this</span>-&gt;n = n; <span class="hljs-keyword">this</span>-&gt;k = k;
        
        <span class="hljs-comment">// 初始化片上内存</span>
        <span class="hljs-keyword">this</span>-&gt;tiling.<span class="hljs-built_in">SetBuffer</span>(<span class="hljs-number">0</span>, aLocal.buffer, aLocal.buffer_size);
        <span class="hljs-keyword">this</span>-&gt;tiling.<span class="hljs-built_in">SetBuffer</span>(<span class="hljs-number">1</span>, bLocal.buffer, bLocal.buffer_size);
        <span class="hljs-keyword">this</span>-&gt;tiling.<span class="hljs-built_in">SetBuffer</span>(<span class="hljs-number">2</span>, cLocal.buffer, cLocal.buffer_size);
    }
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 矩阵乘法分块计算</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; m; i += BLOCK_SIZE) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>; j &lt; n; j += BLOCK_SIZE) {
                <span class="hljs-comment">// 加载A矩阵块</span>
                <span class="hljs-built_in">CopyInA</span>(i, j);
                <span class="hljs-comment">// 加载B矩阵块</span>
                <span class="hljs-built_in">CopyInB</span>(i, j);
                <span class="hljs-comment">// 计算分块结果</span>
                <span class="hljs-built_in">ComputeBlock</span>();
                <span class="hljs-comment">// 聚合结果</span>
                <span class="hljs-built_in">AggregateResult</span>();
                <span class="hljs-comment">// 写回C矩阵</span>
                <span class="hljs-built_in">CopyOutC</span>(i, j);
            }
        }
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyInA</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> i, <span class="hljs-type">uint32_t</span> j)</span> </span>{
        <span class="hljs-comment">// 从全局内存加载A矩阵到片上内存</span>
        <span class="hljs-comment">// 实现矩阵分块加载逻辑</span>
    }
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyInB</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> i, <span class="hljs-type">uint32_t</span> j)</span> </span>{
        <span class="hljs-comment">// 从全局内存加载B矩阵到片上内存</span>
    }
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">ComputeBlock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 执行矩阵乘法核心计算</span>
        <span class="hljs-comment">// 利用昇腾AI处理器的矩阵计算单元</span>
    }
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">AggregateResult</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 聚合分块计算结果</span>
    }
    
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">CopyOutC</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> i, <span class="hljs-type">uint32_t</span> j)</span> </span>{
        <span class="hljs-comment">// 将计算结果写回全局内存</span>
    }
    
    <span class="hljs-comment">// 成员变量定义</span>
    GM_ADDR a, b, c;
    <span class="hljs-type">uint32_t</span> m, n, k;
    Tiling&lt;<span class="hljs-number">3</span>&gt; tiling;
    <span class="hljs-comment">// 其他缓冲区定义...</span>
};
</code></pre>
<p>矩阵乘法的实现需要考虑数据分块、内存访问优化、计算单元利用率等多个维度，是CANN训练营中的高阶内容。</p>
<h3 data-id="heading-16">5. 算子开发完整流程图</h3>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[算子需求分析]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[算子规格定义]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[核函数原型设计]</span>
    C --&gt; D<span class="hljs-selector-attr">[算子类实现]</span>
    D --&gt; E<span class="hljs-selector-attr">[内存访问优化]</span>
    E --&gt; F<span class="hljs-selector-attr">[编译部署]</span>
    F --&gt; G<span class="hljs-selector-attr">[功能验证]</span>
    G --&gt; H<span class="hljs-selector-attr">[性能调优]</span>
    H --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[文档编写]</span>
    
    subgraph 算子分析阶段
        <span class="hljs-selector-tag">A</span>
        <span class="hljs-selector-tag">B</span>
    end
    
    subgraph 核函数定义阶段
        C
    end
    
    subgraph 算子实现阶段
        D
        E
    end
    
    subgraph 部署验证阶段
        F
        G
        H
        <span class="hljs-selector-tag">I</span>
    end
</code></pre>
<p>上图展示了Ascend C算子开发的完整流程，从需求分析到最终部署，每个阶段都有其特定的技术要求和最佳实践。参与CANN训练营的开发者需要系统掌握这一完整流程。</p>
<h3 data-id="heading-17">6. 实战案例：Add算子完整实现</h3>
<h4 data-id="heading-18">6.1 项目结构设计</h4>
<p>一个完整的Ascend C算子项目通常包含以下文件结构：</p>
<pre><code class="hljs language-bash" lang="bash">add_operator/
├── CMakeLists.txt          <span class="hljs-comment"># 编译配置文件</span>
├── src/
│   ├── add_custom.cpp      <span class="hljs-comment"># 核函数实现</span>
│   └── kernel_add.cpp      <span class="hljs-comment"># 算子类实现</span>
├── include/
│   └── kernel_add.h        <span class="hljs-comment"># 算子类头文件</span>
├── <span class="hljs-built_in">test</span>/
│   └── test_add.py         <span class="hljs-comment"># Python测试脚本</span>
└── build/                  <span class="hljs-comment"># 编译输出目录</span>
</code></pre>
<h4 data-id="heading-19">6.2 完整代码实现</h4>
<p>以下是Add算子的核心实现代码：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/add_custom.cpp</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"kernel_add.h"</span></span>

<span class="hljs-comment">// 核函数定义</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">__global__ __aicore__ <span class="hljs-type">void</span> <span class="hljs-title">add_custom</span><span class="hljs-params">(
    __gm__ <span class="hljs-type">float16_t</span>* x, 
    __gm__ <span class="hljs-type">float16_t</span>* y, 
    __gm__ <span class="hljs-type">float16_t</span>* z, 
    <span class="hljs-type">uint32_t</span> totalElements
)</span> </span>{
    KernelAdd addOp;
    addOp.<span class="hljs-built_in">Init</span>(x, y, z, totalElements);
    addOp.<span class="hljs-built_in">Process</span>();
}

<span class="hljs-comment">// include/kernel_add.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> KERNEL_ADD_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> KERNEL_ADD_H</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"ascendc.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"common.h"</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> AscendC;

<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> BUFFER_NUM = <span class="hljs-number">128</span>; <span class="hljs-comment">// 每次处理128个元素</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> BUFFER_SIZE = BUFFER_NUM * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float16_t</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">KernelAdd</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-title">KernelAdd</span><span class="hljs-params">()</span> </span>{}
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Init</span><span class="hljs-params">(GM_ADDR x, GM_ADDR y, GM_ADDR z, <span class="hljs-type">uint32_t</span> totalElements)</span></span>;
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">Process</span><span class="hljs-params">()</span></span>;
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function">__aicore__ <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">AddCompute</span><span class="hljs-params">()</span></span>;
    
    GM_ADDR x_;
    GM_ADDR y_;
    GM_ADDR z_;
    <span class="hljs-type">uint32_t</span> totalElements_;
    TPipe pipe_;
    TBuf&lt;QuePosition::VECIN&gt; inQueueX_;
    TBuf&lt;QuePosition::VECIN&gt; inQueueY_;
    TBuf&lt;QuePosition::VECOUT&gt; outQueue_;
    Tiling&lt;<span class="hljs-number">3</span>&gt; tiling_;
};

<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// KERNEL_ADD_H</span></span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini">// src/kernel_add.cpp
<span class="hljs-comment">#include "kernel_add.h"</span>

__aicore__ inline void KernelAdd::Init(GM_ADDR x, GM_ADDR y, GM_ADDR z, uint32_t totalElements) {
    <span class="hljs-attr">x_</span> = x<span class="hljs-comment">;</span>
    <span class="hljs-attr">y_</span> = y<span class="hljs-comment">;</span>
    <span class="hljs-attr">z_</span> = z<span class="hljs-comment">;</span>
    <span class="hljs-attr">totalElements_</span> = totalElements<span class="hljs-comment">;</span>
    
    // 设置内存分片
    tiling_.SetGlobalBuffer(0, x_, totalElements_ * sizeof(float16_t))<span class="hljs-comment">;</span>
    tiling_.SetGlobalBuffer(1, y_, totalElements_ * sizeof(float16_t))<span class="hljs-comment">;</span>
    tiling_.SetGlobalBuffer(2, z_, totalElements_ * sizeof(float16_t))<span class="hljs-comment">;</span>
    
    // 设置片上内存
    pipe_.InitBuffer(inQueueX_, 1, BUFFER_SIZE)<span class="hljs-comment">;</span>
    pipe_.InitBuffer(inQueueY_, 1, BUFFER_SIZE)<span class="hljs-comment">;</span>
    pipe_.InitBuffer(outQueue_, 1, BUFFER_SIZE)<span class="hljs-comment">;</span>
}

__aicore__ inline void KernelAdd::Process() {
    uint32_t <span class="hljs-attr">loopCount</span> = totalElements_ / BUFFER_NUM<span class="hljs-comment">;</span>
    
    for (uint32_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; loopCount; i++) {</span>
        // 从全局内存加载数据
        pipe_.RecvTensor(inQueueX_, x_ + i * BUFFER_NUM, BUFFER_NUM, 0)<span class="hljs-comment">;</span>
        pipe_.RecvTensor(inQueueY_, y_ + i * BUFFER_NUM, BUFFER_NUM, 1)<span class="hljs-comment">;</span>
        
        // 执行计算
        AddCompute()<span class="hljs-comment">;</span>
        
        // 将结果写回全局内存
        pipe_.SendTensor(z_ + i * BUFFER_NUM, outQueue_, BUFFER_NUM, 2)<span class="hljs-comment">;</span>
    }
}

__aicore__ inline void KernelAdd::AddCompute() {
    // 获取输入数据指针
    float16_t* <span class="hljs-attr">srcX</span> = inQueueX_.GetData()<span class="hljs-comment">;</span>
    float16_t* <span class="hljs-attr">srcY</span> = inQueueY_.GetData()<span class="hljs-comment">;</span>
    float16_t* <span class="hljs-attr">dst</span> = outQueue_.GetData()<span class="hljs-comment">;</span>
    
    // 逐元素执行加法运算
    for (uint32_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; BUFFER_NUM; i++) {</span>
        dst<span class="hljs-section">[i]</span> = srcX<span class="hljs-section">[i]</span> + srcY<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这个完整实现展示了Add算子的核心逻辑，包括内存管理、数据加载、计算执行和结果回写等关键环节。</p>
<h4 data-id="heading-20">6.3 编译与部署</h4>
<p>算子开发完成后，需要通过CANN提供的编译工具链进行编译部署。典型的编译命令如下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建编译目录</span>
<span class="hljs-built_in">mkdir</span> -p build &amp;&amp; <span class="hljs-built_in">cd</span> build

<span class="hljs-comment"># 配置CMake</span>
cmake .. -DCANN_PACKAGE_PATH=/usr/local/Ascend/ascend-toolkit/latest

<span class="hljs-comment"># 编译算子</span>
make -j8

<span class="hljs-comment"># 部署算子</span>
<span class="hljs-built_in">cp</span> libadd_custom.so /usr/local/Ascend/ascend-toolkit/latest/opp/op_impl/built-in/ai_core/tbe/op_lib/
</code></pre>
<p>编译成功后，算子就可以在昇腾AI处理器上运行了。CANN训练营提供了完整的开发环境和免费算力，帮助开发者顺利完成这一过程。</p>
<h3 data-id="heading-21">7. 调试与验证技巧</h3>
<h4 data-id="heading-22">7.1 孪生调试技术</h4>
<p>Ascend C提供了强大的孪生调试功能，可以在CPU上模拟设备端的执行行为。使用<code>ICPU_RUN_KF</code> CPU调测宏可以完成算子核函数CPU侧调试，极大提高了开发效率。 以下是调试示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 启用CPU调试模式</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ICPU_RUN_KF</span>

<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> ICPU_RUN_KF</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"icpu_run_kf.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">// 在main函数中调用核函数</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 初始化测试数据</span>
    <span class="hljs-type">float16_t</span> x[<span class="hljs-number">256</span>], y[<span class="hljs-number">256</span>], z[<span class="hljs-number">256</span>];
    <span class="hljs-comment">// 填充测试数据...</span>
    
    <span class="hljs-comment">// 调用核函数</span>
    <span class="hljs-built_in">add_custom</span>(x, y, z, <span class="hljs-number">256</span>);
    
    <span class="hljs-comment">// 验证结果</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(z[i] - (x[i] + y[i])) &gt; <span class="hljs-number">1e-3</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error at index %d: expected %f, got %f\n"</span>, 
                   i, x[i] + y[i], z[i]);
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"All tests passed!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-23">7.2 性能分析工具</h4>
<p>CANN提供了丰富的性能分析工具，帮助开发者优化算子性能。关键指标包括：</p>
<ul>
<li><strong>计算效率</strong>：计算单元利用率</li>
<li><strong>内存带宽</strong>：数据加载/存储效率</li>
<li><strong>并行度</strong>：任务并行执行程度</li>
<li><strong>延迟</strong>：单次计算耗时</li>
</ul>
<p>通过系统化的性能分析和优化，开发者可以将算子性能提升到接近硬件极限的水平，这也是CANN训练营的重要教学内容。</p>
<h3 data-id="heading-24">8. CANN训练营学习建议</h3>
<h4 data-id="heading-25">8.1 学习路径规划</h4>
<p>参与2025年昇腾CANN训练营第二季的开发者，建议按照以下路径学习：</p>
<ol>
<li><strong>0基础入门系列</strong>：掌握Ascend C基础语法和编程模型</li>
<li><strong>码力全开特辑</strong>：挑战复杂算子开发任务</li>
<li><strong>开发者案例</strong>：学习实际项目中的最佳实践</li>
<li><strong>中级认证准备</strong>：系统复习核心知识点</li>
</ol>
<h4 data-id="heading-26">8.2 实战经验分享</h4>
<p>根据往期训练营学员的经验，以下几点对成功完成学习目标至关重要：</p>
<ul>
<li><strong>动手实践</strong>：每个知识点都要通过编码验证</li>
<li><strong>社区参与</strong>：积极参与社区讨论，解决疑难问题</li>
<li><strong>文档精读</strong>：深入理解CANN官方文档，掌握核心概念</li>
<li><strong>性能优化</strong>：不仅实现功能，更要追求高性能</li>
</ul>
<h3 data-id="heading-27">9. 总结与展望</h3>
<p>本文详细介绍了CANN训练营中Ascend C算子开发的完整流程，从算子分析到核函数定义，再到具体实现和验证。通过系统化的步骤分解和实战代码示例，开发者可以全面掌握昇腾AI处理器自定义算子开发的核心技能。</p>
<p>昇腾CANN训练营为开发者提供了高质量AI学习课程、开发环境和免费算力，助力开发者从0基础学习到AI技术落地。 通过参与训练营，完成Ascend C算子中级认证，开发者不仅可以获得专业认证证书，还有机会赢取华为手机、平板、开发板等丰厚奖品。</p>
<p>随着AI技术的快速发展，掌握底层算子开发技能将成为AI工程师的核心竞争力。昇腾CANN通过开源开放的全场景能力，为开发者提供了广阔的创新空间。我们期待更多开发者加入2025年昇腾CANN训练营第二季，共同构筑昇腾AI算力新生态。</p>
<h3 data-id="heading-28">参考资料</h3>
<h3 data-id="heading-29">标签</h3>
<p>#AscendC #CANN训练营 #算子开发 #昇腾AI #AI加速 #深度学习 #华为昇腾 #高性能计算</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[外科医生离手术世界模型还有多远？首次提出SurgVeo基准，揭示AI生成手术视频的惊人差距]]></title>    <link>https://juejin.cn/post/7571372478803656719</link>    <guid>https://juejin.cn/post/7571372478803656719</guid>    <pubDate>2025-11-12T01:55:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803656719" data-draft-id="7571272874846470196" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="外科医生离手术世界模型还有多远？首次提出SurgVeo基准，揭示AI生成手术视频的惊人差距"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-12T01:55:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            外科医生离手术世界模型还有多远？首次提出SurgVeo基准，揭示AI生成手术视频的惊人差距
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:55:29.000Z" title="Wed Nov 12 2025 01:55:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>外科医生离手术世界模型还有多远？首次提出<strong>SurgVeo基准</strong>，揭示AI生成手术视频的惊人差距</p>
<p>近年来，视频生成领域的基石模型展现出作为潜在“世界模型”模拟物理世界的惊人能力。谷歌的Veo等模型已经能够生成逼真的日常场景视频，让我们仿佛看到了通用物理世界模拟器的雏形。</p>
<p>然而，当这些技术被应用于外科手术这样高风险、需要深度专业知识的领域时，其表现如何？这是一个至关重要却尚未被深入探索的问题。</p>
<h2 data-id="heading-0"><strong>通用世界模型遭遇专业领域挑战</strong></h2>
<p>“世界模型”的核心是让机器建立关于世界如何运作的内部表征，理解环境演变和行为后果。但在外科手术领域，仅理解日常物理规则是远远不够的。</p>
<p>外科手术充满了需要“专家直觉”的知识——解剖学、生理学、生物力学。一个真正有用的“手术世界模型”必须理解手术刀切开不同组织时的反应，理解特定操作背后的战略意图。</p>
<p>为模拟“常识物理”而设计的模型，能否驾驭需要“专家知识”的手术领域？耶鲁大学、诺丁汉大学等机构的研究者们进行了一项开创性研究，试图回答这个问题。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f5072c035aa4c359b25cb4b5be4f9ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=bIQfqz6sEh%2FjlUYTOAXeVQTXNwE%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.01775" target="_blank" title="https://arxiv.org/abs/2511.01775" ref="nofollow noopener noreferrer">arxiv.org/abs/2511.01…</a></p>
<p><strong>Benchmark（未开源）：</strong></p>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffranciszchen%2FSurgVeo" target="_blank" title="https://github.com/franciszchen/SurgVeo" ref="nofollow noopener noreferrer">github.com/franciszche…</a></strong></p>
</blockquote>
<h2 data-id="heading-1"><strong>SurgVeo基准与手术合理性金字塔</strong></h2>
<p>研究者构建了完整的评测体系来解决这一挑战。他们提出了SurgVeo——首个由专家策划的、用于评估手术视频生成模型的基准，包含腹腔镜子宫切除术和内窥镜垂体手术两种代表性手术视频。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27ceaf910b0403cb29c11e586b22e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=%2F5MqTo%2FJUe7QN%2F8OE50rU8qhYm8%3D" alt="图片2.png" loading="lazy"/></p>
<p>更重要的是，团队设计了一个新颖的四层评估框架——手术合理性金字塔，从四个层面系统评估生成内容的质量：</p>
<ul>
<li>视觉感知合理性：评估最基本的画面质量，如清晰度、光照、组织纹理</li>
<li>器械操作合理性：评估手术器械的运动轨迹是否符合手术规范</li>
<li>环境反馈合理性：评估组织、器官对器械操作的反应是否真实</li>
<li>手术意图合理性：评估系列动作是否展现出符合手术阶段的战略目标</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d4eb30467f04664bbfbc9664c594248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=pRQjrOAgvwLtnnPCaalc4wgWxu4%3D" alt="图片3.png" loading="lazy"/></p>
<p>研究邀请了四位执业外科医生组成专家小组，使用SPP框架对Veo-3模型生成的视频进行打分。模型执行的是零样本预测任务：给定手术场景的起始帧和文本提示，生成接下来8秒的手术视频。</p>
<h2 data-id="heading-2"><strong>惊人的“合理性差距”</strong></h2>
<p>研究结果揭示了一个深刻的断层——“合理性差距”：尽管模型在生成视觉上令人信服的手术场景方面表现出色，但在SPP框架的更高层级上却严重失败。</p>
<ul>
<li><strong>量化数据揭示的真相</strong></li>
</ul>
<p>在腹腔镜手术中，视觉感知合理性的初始得分为3.72分（满分5分），表明生成的图像“清晰得惊人”。然而，分数在SPP金字塔的更高层级急剧下降：</p>
<p>环境反馈合理性从1秒时的3.06分骤降至8秒时的1.64分</p>
<p>手术意图合理性从2.83分降至1.52分</p>
<p>器械操作合理性从3.13分降至1.68分</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ad897b357114451985636b8bff13aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=5Yk8fjWgHwWR4HmXdw8qPArUhTU%3D" alt="图片4.png" loading="lazy"/></p>
<p>神经外科手术中也观察到同样的趋势，视觉感知得分3.88分，而其他维度得分均低于2.5分，且随时间推移迅速恶化。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af3f51f9cbe145adbc30c5db798a431a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=FikyUx%2BwYBIewalcqLmmgwpx8SE%3D" alt="图片5.png" loading="lazy"/></p>
<ul>
<li><strong>典型失败案例触目惊心</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/278149f660b144da82d583322efd079b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=qdwsZBQTJW1d%2FwyZpYNJa0axMSk%3D" alt="图片6.png" loading="lazy"/></p>
<p>定性分析让这些数字变得更加直观：</p>
<ul>
<li>视觉质量失真：生成的视频画面亮度发生突兀且不自然的变化</li>
<li>器械错误：模型“幻觉”出现实中不存在的手术器械</li>
<li>操作不当：真实操作需要向左移动，模型却生成了向右的错误动作</li>
<li>环境反馈错误：吸引器违反物理定律，像提拉固体一样将整块明胶海绵吸走</li>
<li>意图错误：真实意图是在硬脑膜上注射生物胶水，模型却预测用棉片擦拭</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61f3fa2de2644cd89f51264465154bc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517329&amp;x-signature=uuHpjdNL2mhdT3HdukfZahxvJ2M%3D" alt="图片7.png" loading="lazy"/></p>
<p>错误类型的量化分布显示，与高层手术逻辑相关的错误占了绝大多数（腹腔镜93.8%，神经外科97.2%），而底层视觉质量问题仅占一小部分。</p>
<h2 data-id="heading-3"><strong>研究意义与未来方向</strong></h2>
<p>这项研究首次提供了量化证据，揭示当前最先进视频生成模型在手术AI领域中，令人信服的视觉模仿与真正的因果理解之间存在巨大鸿沟。</p>
<p>研究发现，为模型提供更明确的“阶段感知”提示并不能显著改善表现，证明问题不在于缺少上下文信息，而在于模型根本无法理解和运用专业领域知识。</p>
<p>这项工作为未来研究指明了方向：仅仅依靠在通用数据上进行大规模训练，可能不足以让模型掌握专家领域的复杂规则。未来的“手术世界模型”可能需要新的架构范式，能够整合结构化的领域知识，并在生成过程中强制执行严格的物理和逻辑约束。</p>
<p>SurgVeo基准和SPP评估框架为开发真正可靠的手术AI系统奠定了重要基础。虽然通往真正的手术世界模型道阻且长，但这项研究无疑是迈出的清醒而关键的一步。</p>
<p>对于AI在医疗领域的发展，这项研究提醒我们：外观的逼真绝不等于内在的合理，在关乎人命的高风险领域，模型的深度理解比表面完美更为重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[服务器有哪些功能？网站托管/CDN加速/云计算部署必知方案]]></title>    <link>https://juejin.cn/post/7571355989133197327</link>    <guid>https://juejin.cn/post/7571355989133197327</guid>    <pubDate>2025-11-12T02:03:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355989133197327" data-draft-id="7571156741398102031" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="服务器有哪些功能？网站托管/CDN加速/云计算部署必知方案"/> <meta itemprop="keywords" content="服务器,CDN,云计算"/> <meta itemprop="datePublished" content="2025-11-12T02:03:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云动雨颤"/> <meta itemprop="url" content="https://juejin.cn/user/772323170591859"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            服务器有哪些功能？网站托管/CDN加速/云计算部署必知方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/772323170591859/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云动雨颤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:03:45.000Z" title="Wed Nov 12 2025 02:03:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文系转载，转载链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ffy.com%2Flatest-news%2F1917106730248966144" target="_blank" title="https://www.ffy.com/latest-news/1917106730248966144" ref="nofollow noopener noreferrer">服务器有哪些功能？网站托管/CDN加速/云计算部署必知方案</a></p>
<p>在数字经济蓬勃发展的今天，服务器作为支撑现代互联网服务的数字中枢，其功能已渗透到商业运营和个人生活的各个领域。本文将从技术实现到应用场景，系统解析服务器在数字化转型中的关键作用。</p>
<h3 data-id="heading-0">一、网站托管的技术演进</h3>
<h4 data-id="heading-1">1.基础架构支撑</h4>
<p>网站托管作为服务器最基础的应用场景，经历了从物理服务器到云原生的演进。现代服务器集群通过负载均衡技术，可轻松应对百万级并发请求，支持WordPress、Magento等主流CMS系统的稳定运行。</p>
<h4 data-id="heading-2">2.性能优化方案</h4>
<ul>
<li>CDN节点加速：通过全球分布式缓存提升静态资源加载速度</li>
<li>HTTP/3协议支持：降低网络延迟30%以上</li>
<li>智能缓存机制：采用Redis、Memcached等内存数据库提升动态内容响应</li>
</ul>
<h3 data-id="heading-3">二、应用服务的运行支撑体系</h3>
<h4 data-id="heading-4">1.移动互联网生态支持</h4>
<p>服务器为移动应用提供RESTful API接口支持，处理日均千万级用户请求。实时消息推送系统可保障99.99%的消息到达率，支持WebSocket长连接技术实现即时通讯。</p>
<h4 data-id="heading-5">2.游戏服务架构</h4>
<ul>
<li>分布式服务器集群：解决MMORPG类游戏的区域同步难题</li>
<li>物理引擎计算：支持Unity3D、Unreal等引擎的实时物理模拟</li>
<li>反作弊系统：基于机器学习的行为分析模型</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bac3d3ce64bc4b8ca38684eeafa557e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5Yqo6Zuo6aKk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517825&amp;x-signature=5hAFApouI1JJj4M57pcHz%2BfXTmo%3D" alt="服务器有哪些功能" loading="lazy"/></p>
<h3 data-id="heading-6">三、数据管理解决方案</h3>
<h4 data-id="heading-7">1.数据库服务架构</h4>
<p>服务器支持MySQL、PostgreSQL等关系型数据库与MongoDB、Redis等NoSQL数据库的混合部署。通过主从复制架构实现读写分离，查询效率提升可达400%。</p>
<h4 data-id="heading-8">2.大数据处理能力</h4>
<ul>
<li>分布式文件系统：支持HDFS、Ceph等存储架构</li>
<li>实时流处理：Kafka+Spark Streaming组合处理能力达百万条/秒</li>
<li>OLAP分析：ClickHouse列式数据库实现TB级数据秒级响应</li>
</ul>
<h3 data-id="heading-9">四、协同办公的技术实现</h3>
<h4 data-id="heading-10">1.企业级文件管理</h4>
<ul>
<li>分布式存储架构：支持PB级文件存储</li>
<li>版本控制系统：Git集成实现代码协同</li>
<li>权限管理体系：基于RBAC模型的细粒度控制</li>
</ul>
<h4 data-id="heading-11">2.实时协作支持</h4>
<p>WebRTC技术实现音视频会议系统，支持1080P高清传输，端到端加密保障数据安全。</p>
<h3 data-id="heading-12">五、虚拟化与资源优化</h3>
<h4 data-id="heading-13">1.硬件虚拟化技术</h4>
<ul>
<li>KVM/Xen实现CPU资源隔离</li>
<li>SR-IOV网络虚拟化提升吞吐量</li>
<li>GPU虚拟化支持AI计算场景</li>
</ul>
<h4 data-id="heading-14">2.容器化部署</h4>
<p>Docker集群配合Kubernetes编排系统，资源利用率提升至85%以上，支持蓝绿部署、金丝雀发布等DevOps实践。</p>
<h3 data-id="heading-15">六、云架构转型路径</h3>
<h4 data-id="heading-16">1.混合云部署模型</h4>
<p>通过OpenStack等平台实现私有云与公有云的无缝衔接，关键数据本地化存储结合云端弹性计算资源。</p>
<h4 data-id="heading-17">2.成本优化策略</h4>
<ul>
<li>自动伸缩组应对流量波峰波谷</li>
<li>竞价实例降低计算成本40%-60%</li>
<li>冷热数据分层存储方案</li>
</ul>
<h3 data-id="heading-18">七、网络安全防护体系</h3>
<h4 data-id="heading-19">1.主动防御机制</h4>
<ul>
<li>Web应用防火墙（WAF）实时拦截OWASP Top10攻击</li>
<li>DDoS防护系统抵御T级流量攻击</li>
<li>漏洞扫描系统实现分钟级威胁检测</li>
</ul>
<h4 data-id="heading-20">2.数据安全保障</h4>
<ul>
<li>AES-256加密算法保护静态数据</li>
<li>TLS 1.3协议保障传输安全</li>
<li>区块链存证实现操作审计</li>
</ul>
<h3 data-id="heading-21">行业趋势洞察</h3>
<p>根据报告查询，全球云服务器市场规模预计年复合增长率达18.7%，容器化部署占比已突破65%。边缘计算服务器的部署量同比增长120%，AI推理工作负载的服务器采购量增长89%。</p>
<p>通过上述技术解析可见，现代服务器已从单一的计算设备进化为支撑数字化转型的智能基础设施。随着5G、物联网、人工智能等技术的融合发展，服务器将持续推动各行业的技术革新，其功能边界也在不断拓展延伸。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[本地部署vLLM+Qwen3：高性能大模型推理引擎，比Ollama强在哪？]]></title>    <link>https://juejin.cn/post/7571334572769984555</link>    <guid>https://juejin.cn/post/7571334572769984555</guid>    <pubDate>2025-11-12T03:11:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572769984555" data-draft-id="7571378103281713158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="本地部署vLLM+Qwen3：高性能大模型推理引擎，比Ollama强在哪？"/> <meta itemprop="keywords" content="LLM,程序员,Agent"/> <meta itemprop="datePublished" content="2025-11-12T03:11:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            本地部署vLLM+Qwen3：高性能大模型推理引擎，比Ollama强在哪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:11:43.000Z" title="Wed Nov 12 2025 03:11:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在人工智能快速发展的今天，越来越多企业开始部署自己的大语言模型。然而面对动辄数十亿参数的大模型，如何高效稳定地运行它们成为技术团队面临的共同挑战。今天我们就来深入解析两款主流的大模型推理引擎——vLLM和Ollama，帮助您做出正确的技术选型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c7e4fdb95f541b3b68e56440402cb03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=O%2FB5O%2F%2BQrM%2FdsAWFS4EI3rZ5x9Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">什么是vLLM？它为何如此高效？</h2>
<p>vLLM（Vectorized Large Language Model）是由加州大学伯克利分校团队开发的高性能大语言模型推理引擎，专门用于提升大模型推理的效率和速度</p>
<p><strong>vLLM的核心突破在于其创新的PagedAttention技术</strong>，这项技术巧妙地借鉴了操作系统的虚拟内存分页机制 传统推理框架在处理大模型时，需要为每个请求分配一块<strong>连续的显存空间</strong>来存储注意力机制的键值对（KV Cache）。这就像停车场要求每辆车必须停靠在连续的车位中，即使只剩零散车位也无法使用，导致显存利用率通常只有60%左右</p>
<p>而vLLM的PagedAttention技术将KV Cache划分为固定大小的"块"，这些块可以<strong>非连续地存储在显存中</strong>，并通过页表管理它们的映射关系。这种方法就像让车辆可以分散停放在停车场的任何空位，极大提升了显存利用率，可达到<strong>95%以上</strong> 除了PagedAttention外，vLLM还有两大核心技术：</p>
<p><strong>连续批处理（Continuous Batching）</strong> ：传统批处理需要等待一批请求全部完成后才能处理下一批，而vLLM允许新请求随时加入处理队列，确保GPU持续工作，显著提高吞吐量</p>
<p><strong>前缀共享（Prefix Sharing）</strong> ：当多个请求有相同提示前缀时，vLLM可以共享这部分计算的KV Cache，避免重复计算</p>
<p>这些技术使得vLLM在相同硬件上能同时服务<strong>5-10倍</strong>的请求量，成为企业级高并发场景的理想选择</p>
<h2 data-id="heading-1">2.vLLM与Ollama</h2>
<p>虽然vLLM和Ollama都是大模型推理框架，但它们在设计理念和适用场景上有着显著差异。</p>
<h3 data-id="heading-2">2.1定位与核心优势</h3>
<p><strong>Ollama</strong>是一个轻量级的本地推理平台，主打<strong>简单易用和快速部署</strong>。它基于Go语言实现，将模型权重、依赖库和运行环境整合为统一容器，用户只需一条命令即可启动模型服务。Ollama特别适合个人开发者、教育演示和本地测试场景</p>
<p><strong>vLLM</strong>则专注于<strong>高性能推理和服务端扩展</strong>，面向需要处理高并发请求的生产环境。它通过先进的内存管理和调度算法，最大化GPU利用率，适合企业级的大规模部署</p>
<h3 data-id="heading-3">2.2性能表现对比</h3>
<p>从性能数据来看，两个框架有明显差异。以DeepSeek-R1-Distill-Qwen-32B模型为例:</p>
<p><strong>显存占用</strong>：Ollama（4-bit量化）为19-24GB，而vLLM（FP16）为64-96GB</p>
<p><strong>推理速度</strong>：Ollama为5-15 tokens/秒，vLLM可达30-60 tokens/秒</p>
<p><strong>硬件需求</strong>：Ollama可在高端消费级GPU（≥24GB）上运行，vLLM需要多卡专业级GPU</p>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>Ollama</strong></th><th><strong>vLLM</strong></th></tr></thead><tbody><tr><td><strong>核心优势</strong></td><td>易用性、快速启动</td><td>高性能、高并发</td></tr><tr><td><strong>显存管理</strong></td><td>动态分块加载</td><td>PagedAttention分页管理</td></tr><tr><td><strong>批处理</strong></td><td>基础批处理</td><td>连续动态批处理</td></tr><tr><td><strong>硬件需求</strong></td><td>消费级GPU即可</td><td>需要专业级GPU</td></tr><tr><td><strong>部署复杂度</strong></td><td>简单，一条命令</td><td>相对复杂，需要调优</td></tr></tbody></table>
<blockquote>
<p>简单来说，选择标准很清晰：<strong>个人开发测试用Ollama，企业生产部署用vLLM</strong>。</p>
</blockquote>
<h2 data-id="heading-4">3.vLLM的软硬件要求与部署实践</h2>
<h3 data-id="heading-5">3.1硬件要求</h3>
<p>vLLM对硬件有较高要求，<strong>推荐使用专业级GPU</strong>，<strong>显存需求</strong>：至少能容纳模型参数和KV Cache，例如70B模型需要140-210GB显存，<strong>支持张量并行</strong>：通过多GPU并行计算加速推理</p>
<blockquote>
<p>本次实验采用一张魔改的 2080显卡，22G现存</p>
</blockquote>
<h3 data-id="heading-6">3.2软件环境</h3>
<p><strong>操作系统</strong>：Linux（Ubuntu 20.04+或Rocky Linux 9+），<strong>驱动要求</strong>：NVIDIA驱动版本535+</p>
<blockquote>
<p>本次实验环境采用 Rocky Linux 10 版本</p>
</blockquote>
<h3 data-id="heading-7">3.3操作系统基础安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更换镜像源为阿里云镜像源  </span>
sed -e <span class="hljs-string">'s|^mirrorlist=|[#mirrorlist]()=|g'</span> \  
    -e <span class="hljs-string">'s|^[#baseurl]()=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> \  
    -i.bak \  
    /etc/yum.repos.d/[Rr]ocky*.repo  
  
<span class="hljs-comment"># 安装EPEL 仓库  </span>
dnf install -y epel-release  
  
 <span class="hljs-comment"># 和yum是一样的  </span>
dnf clean all  
dnf makecache  
  
  
<span class="hljs-comment"># 更新系统软件(非必要)  </span>
yum -y update  
  
<span class="hljs-comment"># 禁用 SELinux  </span>
setenforce 0  
sed -i <span class="hljs-string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config  
<span class="hljs-comment"># 获取 SELinux 状态  </span>
getenforce   
  
<span class="hljs-comment"># 关闭防火墙(生产环境慎重)  </span>
systemctl stop firewalld  
systemctl <span class="hljs-built_in">disable</span> firewalld  
  
<span class="hljs-comment"># 设置时区  </span>
timedatectl set-timezone Asia/Shanghai  
  
<span class="hljs-comment"># 配置时间同步服务  </span>
systemctl status chronyd  
  
<span class="hljs-comment"># 查看时间是否同步 V 大写  </span>
chronyc sources -V  
MS Name/IP address         Stratum Poll Reach LastRx Last sample                 
===============================================================================  
^+ ntp8.flashdance.cx            2   7   377   104  +2245us[+2245us] +/-  104ms  
^* 211.68.71.26                  3   7   377   105  -8679us[-9888us] +/-  124ms  
^- mail.moe.cat                  2   8    61    94    -14ms[  -14ms] +/-  101ms  
^+ ntp1.flashdance.cx            2   7   377    40   +215us[ +215us] +/-  102ms  
  
<span class="hljs-comment"># 安装常用插件  </span>
yum install -y vim wget telnet net-tools lrzsz unzip gcc numactl  bind-utils tar tar perl pciutils
</code></pre>
<blockquote>
<p>显卡检查时会用到 lspci命令，该命令在 pciutils包中</p>
</blockquote>
<h3 data-id="heading-8">3.4 显卡相关</h3>
<h4 data-id="heading-9">3.4.1 确认显卡型号</h4>
<pre><code class="hljs language-makefile" lang="makefile">lspci | grep -i nvidia  
<span class="hljs-section">01:00.0 VGA compatible controller: NVIDIA Corporation TU102 [GeForce RTX 2080 Ti Rev. A] (rev a1)  </span>
<span class="hljs-section">01:00.1 Audio device: NVIDIA Corporation TU102 High Definition Audio Controller (rev a1)  </span>
<span class="hljs-section">01:00.2 USB controller: NVIDIA Corporation TU102 USB 3.1 Host Controller (rev a1)  </span>
<span class="hljs-section">01:00.3 Serial bus controller: NVIDIA Corporation TU102 USB Type-C UCSI Controller (rev a1)  </span>
  
<span class="hljs-comment"># 确认你运行的内核版本，然后安装对应的开发包：  </span>
<span class="hljs-comment"># 查看当前运行的内核版本  </span>
uname -r  
<span class="hljs-comment"># 安装对应版本的内核开发包  </span>
sudo dnf install kernel-devel-<span class="hljs-variable">$(uname -r)</span> kernel-headers-<span class="hljs-variable">$(uname -r)</span>
</code></pre>
<blockquote>
<p>确认内核版本以及安装对应版本内核开发包很重要，要不然驱动无法安装</p>
</blockquote>
<h4 data-id="heading-10">3.4.2 检查是否存在开源驱动 nouveau</h4>
<pre><code class="hljs language-perl" lang="perl">lsmod | <span class="hljs-keyword">grep</span> nouveau
</code></pre>
<blockquote>
<p>有输出说明存在。 开源驱动会与NVIDA 驱动冲突。我的是有输出的</p>
</blockquote>
<p>如果存在，则需要关闭 nouveau 驱动</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"blacklist nouveau"</span> | sudo <span class="hljs-built_in">tee</span> /etc/modprobe.d/blacklist-nouveau.conf  
<span class="hljs-built_in">echo</span> <span class="hljs-string">"options nouveau modeset=0"</span> | sudo <span class="hljs-built_in">tee</span> -a /etc/modprobe.d/blacklist-nouveau.conf  
sudo dracut --force  
<span class="hljs-comment"># 重启  </span>
sudo reboot  
  
<span class="hljs-comment"># 重启后确认,如果没有输出则表示已经关闭了  </span>
lsmod | grep nouveau
</code></pre>
<h4 data-id="heading-11">3.4.3 下载驱动</h4>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nvidia.com%2Fen-us%2Fdrivers%2F" target="_blank" title="https://www.nvidia.com/en-us/drivers/" ref="nofollow noopener noreferrer">www.nvidia.com/en-us/drive…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47772dde6ae34e60a56ec2c7ef29f37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=kTqPs0U7oO2aqhX%2BU2O7EyCdPok%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/423018693a6743f8a9065eea31e6b83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=QpJarPRKo5N2d4oXGZh6jEMgv7k%3D" alt="" loading="lazy"/></p>
<p>选择一个版本下载</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef4827896d048e5a46fe714613b995a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=22hmoPwYNqf47p9y0kYyu5H8eyg%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>将下载的文件存放到 <code>/usr/local/src</code>目录备用</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce300dc352e34d4c8ea8f50114dcd8b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=8bevRhRyVTmhxKeMM%2BgSmIr8CJo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">3.4.4 执行安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/src  
<span class="hljs-comment"># 添加可执行权限  </span>
 <span class="hljs-built_in">chmod</span> +x NVIDIA-Linux-x86_64-580.105.08.run  
<span class="hljs-comment"># 执行安装  </span>
 sudo ./NVIDIA-Linux-x86_64-580.105.08.run
</code></pre>
<p>安装的时候，会让你选择许可证，我们直接选择 <code>**NVIDIA Proprietary**</code><strong>即可</strong></p>























<table><thead><tr><th>选项</th><th>许可证</th><th>特点</th><th>推荐选择</th></tr></thead><tbody><tr><td><strong>NVIDIA Proprietary</strong></td><td>专有许可证</td><td>• 传统的NVIDIA专有驱动 • 经过长期测试，稳定性高 • 与各种NVIDIA功能完全兼容</td><td><strong>大多数用户</strong></td></tr><tr><td><strong>MIT/GPL</strong></td><td>开源许可证</td><td>• 较新的开源内核模块 • 更好的内核兼容性 • 遵循开源协议</td><td>特定场景用户</td></tr></tbody></table>
<p>如果操作系统安装的是字符界面，则会出现一个警告:</p>
<blockquote>
<p>WARNING: nvidia-installer was forced to guess the X library path '/usr/lib64' and X module path '/usr/lib64/xorg/modules';</p>
</blockquote>
<p>这个警告信息表明NVIDIA安装程序无法自动检测到X Window系统的开发文件位置,解决这个警告你需要安装X.Org的开发包和pkg-config工具，</p>
<p>这个警告<strong>不会影响CUDA计算功能</strong>，只会影响图形显示，如果你只在字符界面使用Rocky Linux进行计算任务，可以暂时忽略这个警告</p>
<h4 data-id="heading-13">3.4.5 验证驱动是否安装成功</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#  若输出显示显卡信息、驱动版本，则安装成功nvidia-smi</span>

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09c250b097f842c381eb44cf16ca4fae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=YWyDUUNyFDbHjuPw24VJZ9gJcLQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">3.5.安装CUDA</h3>
<p><strong>CUDA</strong> 是 <strong>Compute Unified Device Architecture</strong> 的缩写，是NVIDIA推出的<strong>并行计算平台和编程模型</strong>。</p>
<p><strong>本质：</strong> 让GPU不仅能处理图形，还能进行通用计算的平台</p>
<p><strong>作用：</strong> 允许开发者使用C/C++等语言直接在GPU上编写程序</p>
<p><strong>应用领域：</strong> AI/深度学习、科学计算、数据分析、图形渲染等</p>
<blockquote>
<p>前提条件，需要先安装 NVIDIA 驱动</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">nvidia-smi  <span class="hljs-comment"># 有输出，则确认驱动正常工作</span>
</code></pre>
<h4 data-id="heading-15">3.5.1 下载<strong>CUDA Toolkit并安装</strong></h4>
<p>RTX 2080 Ti 的最优 CUDA 版本为 <strong>11.7 或 11.8</strong>，我们选择 11.8 版本下载，下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Fcuda-toolkit-archive" target="_blank" title="https://developer.nvidia.com/cuda-toolkit-archive" ref="nofollow noopener noreferrer">developer.nvidia.com/cuda-toolki…</a> ，找到对应的版本，选择合适的环境下载。下载后，文件存放到 <code>/usr/local/src</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81734e00293a42468339fdb1a5810e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=CD3w1H0F7shF1p9IG5kAt64avIo%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/src  
  
wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run  
  
sudo sh cuda_11.8.0_520.61.05_linux.run
</code></pre>
<blockquote>
<p>安装的时候，会出现错误：unsupported compiler version: 14.2.1. Use --override to override this check. 此时使用下面命令跳过检查。 原因是当前系统版本的gcc版本过高 ，cuda_11.8.0 不识别这个gcc版本。生产环境可以降低 gcc版本，比如gcc 10 版本。因为现在是测试，直接跳过检查</p>
<p>sudo sh cuda_11.8.0_520.61.05_linux.run --override</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8481b25cbe1a44ccbd22a84b321aa7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=zPRzOxVh3GUWsRfs6qHlm7qpgUQ%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>因为驱动已经安装了，所以这里需要将 "Driver" 选项去掉</p>
<p>安装完毕后，Toolkit 被安装在了 <code>/usr/local/cuda-11.8</code>, 同时有个链接文件 <code>/usr/local/cuda</code>指向了这个目录</p>
</blockquote>
<h4 data-id="heading-16">3.5.2 配置环境变量</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑bash配置文件  </span>
vim ~/.bashrc  
  
<span class="hljs-comment"># 添加以下内容（版本号根据实际安装调整）  </span>
<span class="hljs-built_in">export</span> PATH=/usr/local/cuda/bin<span class="hljs-variable">${PATH:+:<span class="hljs-variable">${PATH}</span>}</span>  
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/usr/local/cuda/lib64<span class="hljs-variable">${LD_LIBRARY_PATH:+:<span class="hljs-variable">${LD_LIBRARY_PATH}</span>}</span>  
<span class="hljs-built_in">export</span> CUDA_HOME=/usr/local/cuda  
  
<span class="hljs-comment"># 使配置生效  </span>
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
<h4 data-id="heading-17">3.5.3 验证安装</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查CUDA编译器  </span>
<span class="hljs-string">nvcc</span> <span class="hljs-string">--version</span>  
<span class="hljs-attr">nvcc:</span> <span class="hljs-string">NVIDIA</span> <span class="hljs-string">(R)</span> <span class="hljs-string">Cuda</span> <span class="hljs-string">compiler</span> <span class="hljs-string">driver</span>  
<span class="hljs-string">Copyright</span> <span class="hljs-string">(c)</span> <span class="hljs-number">2005</span><span class="hljs-number">-2022</span> <span class="hljs-string">NVIDIA</span> <span class="hljs-string">Corporation</span>  
<span class="hljs-string">Built</span> <span class="hljs-string">on</span> <span class="hljs-string">Wed_Sep_21_10:33:58_PDT_2022</span>  
<span class="hljs-string">Cuda</span> <span class="hljs-string">compilation</span> <span class="hljs-string">tools,</span> <span class="hljs-string">release</span> <span class="hljs-number">11.8</span><span class="hljs-string">,</span> <span class="hljs-string">V11.8.89</span>  
<span class="hljs-string">Build</span> <span class="hljs-string">cuda_11.8.r11.8/compiler.31833905_0</span>  
  
<span class="hljs-comment"># 检查CUDA工具包版本  </span>
<span class="hljs-string">nvidia-smi</span>  <span class="hljs-comment"># 查看右上角的CUDA Version</span>

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fc0278708474cf8a6d4ceaadf2a126f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=OaIugtasg%2FVKFEhcLujDLjlVmf8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>nvidia-smi 显示的CUDA版本是驱动程序支持的最高 CUDA版本，不是实际安装的CUDA版本，使用 <code>nvcc --version</code>显示的才是实际安装的版本。</p>
</blockquote>
<p>3.6 安装Conda</p>
<p>Conda 是一个开源的包管理和环境管理系统，最初由 Anaconda 公司开发，主要用于 Python 及其他语言（如 R、Ruby、Lua、Perl、Haskell、C/C++）的包管理和环境管理。它可以安装、更新、卸载软件包，并创建隔离的虚拟环境，使得不同项目之间的依赖不会相互干扰。Conda与pip的区别：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55b061a69b6436987d2561b8a68f631~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521903&amp;x-signature=%2F9vYkXsiZTNJRvOHrtXyXvGLX8I%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/src   
<span class="hljs-comment"># 下载安装脚本  </span>
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh  
  
 <span class="hljs-comment"># 执行安装  </span>
 sh Miniconda3-latest-Linux-x86_64.sh  
  
<span class="hljs-comment"># 手动激活 base环境  </span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(/root/miniconda3/bin/conda shell.bash hook)</span>"</span>  
  
<span class="hljs-comment"># 接收许可  </span>
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main  
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r  
  
<span class="hljs-comment"># 查看源  </span>
conda config --show-sources  
==&gt; /root/miniconda3/.condarc &lt;==  
channels:  
  - defaults  
  
conda config --<span class="hljs-built_in">set</span> show_channel_urls <span class="hljs-built_in">yes</span>  
  
conda config --show channels  
  
 <span class="hljs-comment"># 关闭自动激活base环境  </span>
conda config --<span class="hljs-built_in">set</span> auto_activate_base <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-18">3.7 安装vLLM GPU版本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建vllm虚拟环境  </span>
conda create -n vllm_env python=3.11 -y  
<span class="hljs-comment"># 激活vllm虚拟环境  </span>
conda activate vllm_env  
  
<span class="hljs-comment"># 查看已创建的所有Conda环境  </span>
conda <span class="hljs-built_in">env</span> list  
  
<span class="hljs-comment"># 安装vllm 包  </span>
pip install vllm  
  
<span class="hljs-comment"># 检查vLLM命令行工具是否可用  </span>
vllm --<span class="hljs-built_in">help</span>  
  
<span class="hljs-comment"># 在Python交互环境中尝试导入vLLM的核心模块  </span>
python -c <span class="hljs-string">"from vllm import LLM; print('vLLM导入成功！')"</span>
</code></pre>
<h3 data-id="heading-19">3.8 模型下载</h3>
<p>这里先试用国内的 魔搭ModelScope社区 提供的SDK 来下载模型</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装ModelScope SDK  </span>
pip install modelscope  
  
<span class="hljs-comment"># 创建模型存放目录  </span>
<span class="hljs-built_in">mkdir</span> -p /home/models/modelscope/Qwen/Qwen3-0.6B  
<span class="hljs-comment"># 下载模型  </span>
modelscope download --model Qwen/Qwen3-0.6B --local_dir /home/models/modelscope/Qwen/Qwen3-0.6B
</code></pre>
<h3 data-id="heading-20">3.9 加载本地模型</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 加载。完全启动过后，会打开 8000 端口对外提供服务  </span>
vllm serve /home/models/modelscope/Qwen/Qwen3-0.6B
</code></pre>
<p>GET <a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.6.133%3A8000%2Fv1%2Fmodels" target="_blank" title="http://192.168.6.133:8000/v1/models" ref="nofollow noopener noreferrer">http://192.168.6.133:8000/v1/models</a> 此时会显示模型信息</p>
<p>单独开启一个窗口，执行命令：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8000/v1/completions -H <span class="hljs-string">"Content-Type: application/json"</span> -d <span class="hljs-string">'{"prompt": "请介绍一下你自己"}'</span>
</code></pre>
<p>有相应则加载成功</p>
<blockquote>
<p>注意：控制台上按 <code>Ctrl +C</code>服务将会停止，回到命令行</p>
</blockquote>
<h3 data-id="heading-21">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust :裸函数 naked functions]]></title>    <link>https://juejin.cn/post/7571379549370351667</link>    <guid>https://juejin.cn/post/7571379549370351667</guid>    <pubDate>2025-11-12T03:25:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379549370351667" data-draft-id="7571395183943663625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust :裸函数 naked functions"/> <meta itemprop="keywords" content="Rust,嵌入式"/> <meta itemprop="datePublished" content="2025-11-12T03:25:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust :裸函数 naked functions
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:25:36.000Z" title="Wed Nov 12 2025 03:25:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F07%2F03%2Fstabilizing-naked-functions%2F" target="_blank" title="https://blog.rust-lang.org/2025/07/03/stabilizing-naked-functions/" ref="nofollow noopener noreferrer">原文</a></p>
<p>一、什么是“裸函数”（naked functions）</p>
<ul>
<li>裸函数用 #[unsafe(naked)] 标注，函数体只能是一个 naked_asm! 调用。</li>
<li>“裸”的含义是：编译器不会为它自动生成常规函数的“前奏/尾声”（prologue/epilogue）代码，也不会帮你处理参数传递或返回值；函数体完全由你写的汇编指令决定。</li>
<li>这和普通的 asm! 不同：普通函数里即便用了 asm!，编译器仍会生成函数的栈帧、保存寄存器等；而 naked 函数则完全不加这些“包装”。</li>
</ul>
<p>二、为什么需要它（和 global_asm! 相比有什么优势）<br/>
过去如果你要写“完全由汇编控制的函数”，常见的做法是用 global_asm! 直接把一段全局汇编塞进目标文件。这样做有几个痛点：</p>
<ol>
<li>
<p>符号/平台指令的样板代码繁琐且平台相关</p>
<ul>
<li>你得自己写 .section/.globl/.type/.size/.p2align 等指令来“声明一个函数”，而且不同目标平台（ELF、Mach-O、COFF）写法不同，机械又容易错。</li>
<li>裸函数会自动生成这些平台相关的指令，你只写核心汇编逻辑即可。</li>
</ul>
</li>
<li>
<p>符号名与名称修饰（name mangling）问题</p>
<ul>
<li>
<p>用 global_asm! 时你往往把函数名硬编码成裸符号，不参与 Rust 的名称修饰。这会引起：</p>
<ul>
<li>跨平台兼容性差（比如 macOS x86_64 符号前缀有 _，Linux 没有）。</li>
<li>需要让符号全局可见，易发生符号冲突。</li>
</ul>
</li>
<li>
<p>用裸函数时，函数名按 Rust 规则处理、参与名称修饰，减少这些问题。</p>
</li>
</ul>
</li>
<li>
<p>泛型支持受限</p>
<ul>
<li>global_asm! 定义的函数无法像正常 Rust 函数一样使用（尤其是 const generics 等）。裸函数因为是“正常函数签名 + 特殊宏体”，可以更自然地结合一些泛型场景（受限于汇编可接受的操作数种类）。</li>
</ul>
</li>
<li>
<p>统一的文档与安全注释位置</p>
<ul>
<li>裸函数只有一个定义点，你可以在它的注释里集中写明安全性约束（非常重要）。global_asm! 往往需要额外的 extern 声明和分散文档，更容易过时或不一致。</li>
</ul>
</li>
</ol>
<p>三、它解决的核心问题与使用场景<br/>
裸函数的典型使用场景都是“非常低层”的地方，你需要绝对控制指令序列与 ABI 交互，不希望编译器插手（如保存/恢复寄存器、栈帧布局等）。</p>
<p>常见场景：</p>
<ul>
<li>
<p>启动代码、引导程序、上下文切换</p>
<ul>
<li>比如在操作系统内核、引导加载器、裸机（embedded）环境，函数需要用特定寄存器传参/返回，不希望任何多余指令。</li>
</ul>
</li>
<li>
<p>异常/中断入口、陷入处理（trampoline）</p>
<ul>
<li>必须手动保存/恢复寄存器、切换栈等，常规函数前后序会干扰。</li>
</ul>
</li>
<li>
<p>编译器内建（compiler-builtins）、特定 ABI 粘合层</p>
<ul>
<li>一些平台或架构有非标准 ABI 的库函数（例如 ARM EABI 的 _*aeabi** 例程），需要“用你自己定义的调用约定”来衔接其他 C 例程或汇编。</li>
</ul>
</li>
<li>
<p>极致性能和确定性</p>
<ul>
<li>某些关键路径上希望精确到每条指令的控制。</li>
</ul>
</li>
</ul>
<p>四、为什么是“unsafe”</p>
<ul>
<li>
<p>裸函数跳过了编译器的 ABI 与栈帧安全网，意味着：</p>
<ul>
<li>你必须确保你写的汇编与声明的 ABI、函数签名完全一致（参数在哪些寄存器、谁来保存哪些寄存器、如何返回值等）。</li>
<li>稍有不当就可能破坏栈、寄存器约定，导致未定义行为或崩溃。</li>
</ul>
</li>
<li>
<p>因此 #[unsafe(naked)] 明确标示“这是不安全接口”，需要配套完整的 SAFETY 注释说明不变量与约定。</p>
</li>
</ul>
<p>五、naked_asm! 是什么</p>
<ul>
<li>
<p>它是专门给裸函数用的汇编宏，介于 asm! 与 global_asm! 之间：</p>
<ul>
<li>写在函数体里（像 asm!），但只接受部分操作数类型（像 global_asm!）。</li>
<li>编译器将裸函数“下沉”为全局汇编，从而保证函数体“只包含你写的指令”，避免 LLVM 等后端偷偷插入额外指令，并且适配非 LLVM 后端。</li>
</ul>
</li>
</ul>
<p>六、和未来相关的两个扩展（实验中）</p>
<ul>
<li>
<p>extern "custom"（feature: abi_custom）</p>
<ul>
<li>现实中很多裸函数并不真遵循 C 或 sysv64 之类标准 ABI，而是“自定义调用约定”。通过 extern "custom" 能把这种事实表达清楚。</li>
<li>重要限制：这类函数不能被普通 Rust 调用表达式直接调用（编译器不知道怎么生成正确调用序列），只能通过内联汇编去“跳”过去。</li>
</ul>
</li>
<li>
<p>cfg_asm（feature: cfg_asm）</p>
<ul>
<li>允许对汇编块内的“某几行”加 #[cfg(...)] 条件编译。便于按目标/特性开关精细裁剪汇编，而不是复制整段汇编。</li>
</ul>
</li>
</ul>
<p>七、一个简化的示例对比</p>
<ul>
<li>
<p>裸函数写法（更简洁、可移植）：</p>
<ul>
<li>#[unsafe(naked)]<br/>
pub extern "sysv64" fn wrapping_add(a: u64, b: u64) -&gt; u64 {<br/>
core::arch::naked_asm!(<br/>
"lea rax, [rdi + rsi]",<br/>
"ret",<br/>
);<br/>
}</li>
</ul>
</li>
<li>
<p>如果用 global_asm!，你得写一堆 .section/.globl/.type/.size 等平台相关指令，还要处理符号名修饰和可见性问题。</p>
</li>
</ul>
<p>八、我该不该用？</p>
<ul>
<li>
<p>如果你在写普通应用（Web 服务、CLI、桌面程序），几乎不需要。</p>
</li>
<li>
<p>如果你在写：</p>
<ul>
<li>OS 内核/引导、嵌入式启动代码/中断向量、</li>
<li>需要完全掌控寄存器与栈的上下文切换、</li>
<li>与非标准 ABI 的底层粘合层、</li>
<li>或想在极少数路径上精确控制指令序<br/>
那么裸函数会显著提升可读性、可维护性与可移植性，同时减少 global_asm! 的样板与坑点。</li>
</ul>
</li>
</ul>
<p>九、使用时的注意事项</p>
<ul>
<li>必写清晰的 SAFETY 注释：说明所遵循的 ABI、寄存器约定、被破坏/保存的寄存器、栈使用方式、返回值规则等。</li>
<li>确保签名、ABI、实现一致。例如 extern "sysv64" 时，x86_64 的参数寄存器是 rdi、rsi、rdx、rcx、r8、r9，返回值在 rax（必要时 rdx）。</li>
<li>谨慎处理被调用者保存（callee-saved）与调用者保存（caller-saved）寄存器。</li>
<li>在嵌入式/无操作系统环境，留意栈指针初始化、中断屏蔽、内存栅栏等。</li>
</ul>
<p>一句话总结：</p>
<ul>
<li>裸函数把“完全由汇编控制函数体”的需求变得更安全、更清晰、更可移植，替代过去繁琐且容易出错的 global_asm! 方案，主要服务于内核、嵌入式、编译器内建等极低层场景。如果你不写这类底层代码，基本用不到；但在需要它的地方，这是一个非常重要的可维护性和健壮性提升。Pomelo_刘金.</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？]]></title>    <link>https://juejin.cn/post/7571372478803820559</link>    <guid>https://juejin.cn/post/7571372478803820559</guid>    <pubDate>2025-11-12T02:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803820559" data-draft-id="7571280402964922403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-11-12T02:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:06:17.000Z" title="Wed Nov 12 2025 02:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：代丽 货拉拉/技术中心/质量保障部/履约组</p>
</blockquote>
<p>当一个数据平台的工具量突破3000+、日均调用超50万次，是该庆祝规模化的胜利，还是警惕效率的陷阱？</p>
<p>货拉拉数据工厂就曾站在这样的十字路口——依托高效的"协议编程"架构，我们实现了工具的爆发式增长，却也迎来了用户最真实的抱怨："工具太多选不出""串流程要记半天""新手上手太费劲"。</p>
<p>于是，一场从"平台化"到"AI智能化"的跃迁就此启动。今天，我们就聊聊这场转型背后的痛点、方案与收获。</p>
<h2 data-id="heading-0">一、3k+工具的甜蜜烦恼：高效架构下的使用困局</h2>
<p>在聊转型前，必须先说说支撑我们走到今天的核心底气——"协议编程"架构，简单来说就是：</p>
<blockquote>
<p>工具开发者只需写Java工具类（遵循统一规范），平台通过自研解析引擎自动提取功能描述、输入输出参数等元信息，前端再自动生成可视化界面。</p>
</blockquote>
<p>这个模式的威力有多强？开发者不用管前端交互、权限控制这些"杂事"，专注业务逻辑就行，<strong>工具开发成本直接降低60%以上</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4dbf418904fce8705fb9f3cca9d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=CwN1EYRKuEZUhzLPIf5V%2FU6YhOw%3D" alt="" loading="lazy"/></p>
<p>靠着这套打法，数据工厂迅速成为内部造数的核心基础设施：工具总量突破3k+，日均调用超50万次。但规模上去了，新问题也找上门了，集中在两个核心痛点：</p>
<h3 data-id="heading-1">1. 工具太多，选得发愁</h3>
<p>为了鼓励提效，我们采用"全局核心工具+业务线自定义工具"的运营策略，这就导致很多功能相似的工具并存。比如"账号信息查询"这个简单场景，平台上就有3个主流版本：</p>
<ul>
<li>账号中台：通用版（支持全账户类型）</li>
<li>司机业务线：专属版（仅支持司机账户）</li>
<li>用户业务线：专属版（仅支持用户账户）</li>
</ul>
<p>实际使用中，70%的用户会优先选本业务线工具，导致通用工具复用率不足30%；更糟的是，新用户得花<strong>3分钟对比测试</strong>才能找到合适的工具，提升了使用门槛。</p>
<h3 data-id="heading-2">2. 步骤太繁，操作耗时</h3>
<p>我们的工具大多是"原子化"的，一个工具只干一件事。但真实业务场景往往需要多工具串联，比如"下单并给指定司机流转至完单"这个高频操作，用户得手动走三步：</p>
<ol>
<li>用"获取司机信息"工具查车型</li>
<li>用"下单"工具完成创建</li>
<li>用"订单流转"工具更新状态</li>
</ol>
<p>整个流程平均要5分钟，中间还要手动记结果、切工具，不仅麻烦，还容易出错。</p>
<h2 data-id="heading-3">二、升级目标：让造数像"说话"一样简单</h2>
<p>针对这些痛点，我们明确了AI升级的核心方向：<strong>打造一个能理解自然语言、自主调度工具的智能体（Agent）</strong> ，彻底改变用户与数据工厂的交互方式。</p>
<p>具体来说，就是要实现三个核心能力，让用户从"工具操作者"变成"需求提出者"：</p>
<ul>
<li><strong>精准懂需求</strong>：不用记工具名，用日常话描述需求就行（比如"查一下司机张三的账号信息并履约完单"）</li>
<li><strong>智能配工具</strong>：系统自动选最优工具，多步骤场景自动串联，不用手动组合</li>
<li><strong>自动跑流程</strong>：参数传递、工具调用、结果整合全自动化，直接给最终结果</li>
</ul>
<p>我们的愿景很直接： <strong>"所想即所得，所造皆能成"</strong> 。初期目标更是明确：造数效率提升50%以上，新用户上手时间缩短到1分钟内。</p>
<h2 data-id="heading-4">三、技术方案：AI+数据工厂的三重协同落地</h2>
<h3 data-id="heading-5">3.1 技术决策：从理论最优到落地可行</h3>
<p>智能体的核心技术选型，我们围绕业务特性做了多轮评估。常见的与LLM结合方案有三种：RAG（检索增强生成）、MCP（执行引擎）和Fine-tuning（模型微调）。</p>
<p>从理论上看，Fine-tuning似乎是最优解——数据工厂覆盖货运、小拉出行、国际化等全业务线，沉淀了大量特有领域知识，微调能让模型深度融合这些知识，减少上下文输入量，提升稳定性。</p>
<p>但早期简易尝试后，我们发现了实际障碍：微调需要大量标注数据，且对算法团队的技术能力要求极高，同时持续迭代的成本也难以承受。综合落地难度与效果反馈，我们最终确定了 <strong>“LLM+RAG+MCP”的协同路径</strong>，兼顾效果、成本与落地效率。</p>
<h3 data-id="heading-6">3.2 技术方案：三大模块构筑智能体能力</h3>
<p>我们将智能体拆解为“大脑（LLM）-知识库（RAG）-手脚（MCP）”三个核心模块，分别负责“理解决策”“知识储备”“执行落地”，形成完整工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1f66e63fa8b4a7daaa8ba3779f0d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=zN%2BsUd4%2BP4VMhzj13z0lz3lz0os%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.2.1 LLM：智能体的“决策大脑”</h4>
<p>LLM是智能体的核心决策层，使用到LLM的共有6处，出于成本与调优效果做了如下组合与配置（精选3个展示）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d498042d0c40f291357121e167093d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=FrB3C63EgMES2AmvEf6YYtYT4MU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2 RAG：智能体的“知识储备库”</h4>
<p>LLM 具备强大的通用能力，但对我们内部 3000 + 工具的具体信息 “一无所知”。若直接输入全量工具信息，会导致上下文过载。因此，我们通过 RAG 技术构建 “精准检索 - 高效赋能” 的知识库体系，助力智能体精准 “认知” 所需工具。</p>
<p>实践中，我们选用 bge_base_zh_1.5 作为 Embedding 模型，以适配中文语义理解场景；同时，为提升检索的精度与全面性，搭建了双层知识库筛选策略，并将其与固定原子工具列表组合，最终形成 toolList给到LLM使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f53877a952443b8546e0d3c8ae4a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=iqw4Ihwf3tHrg38zrItumGLOBvw%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>全量工具详情知识库</strong>：数据直接同步平台工具数据库，细分为“线上”“线下”两个子库——线上库对应生产环境工具，线下库对应测试环境工具，避免智能体误调用测试工具影响线上业务，保障执行安全性。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97aa3aebd49240b4ad3ff99c42da5aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=6e%2BriJkIPo57AXC09Ie8kq%2BZi2M%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li><strong>自然语言与工具映射知识库</strong>：人工维护多语义映射关系，解决“用户表述≠工具描述”的匹配难题。比如“下单”“开单”“创建订单”等不同说法，均映射到同一工具，大幅提升模糊需求的匹配准确率。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10109254d5fb4aa3ba78f23fe5e012c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=jZll3THBqBe2PxPi4hfBGz7%2FMPA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3 MCP：智能体的“执行手脚”</h4>
<p>工具组合方案确定后，就需要MCP（执行引擎）负责“落地执行”，核心解决“按序执行、参数传递、失败处理、结果解析”四大问题，让智能体“会用”工具。</p>
<p>此处tool仅有一个，功能是单个工具运行，其执行逻辑依赖于prompt，prompt大纲设计：</p>
<ul>
<li><strong>核心任务定位</strong>：按工具序列依次执行，保障前序结果向后续传递，失败自动重试；提取执行结果并匹配用户诉求，用自然语言呈现。</li>
<li><strong>核心执行规则</strong>： - 顺序执行：严格遵循工具列表顺序，前序工具执行成功是后序执行的前提； - 参数关联：动态参数从历史执行结果中自动提取，固定参数保持预设值不变； - 失败处理：执行失败触发重试机制（默认3次），重试失败则终止流程并记录失败状态与原因。</li>
<li><strong>结果解析规范</strong>：根据执行状态码（如ret值）判断成败；成功则筛选核心信息分点呈现，失败则明确标注状态码、失败环节及可能原因，便于用户排查。</li>
</ul>
<h2 data-id="heading-10">四、阶段性成果：上线三月，效率与口碑双丰收</h2>
<p>今年8月AI智能体正式上线，作为内部工具的智能化升级尝试，经过一段时间的推广与迭代，在核心效率指标与用户口碑方面已取得显著成效，验证了升级方向的可行性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be704eafbb134285b0a6eb90522d2dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=W1ynp356ITusJ312zFBXhobXtWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">4.1 核心数据：用户渗透良好，效率提升显著</h3>
<p>上线至今，智能体的用户接纳度逐步提升，核心效率指标达到预期目标：</p>
<ul>
<li><strong>用户渗透</strong>：累计吸引500+内部用户使用，涵盖测试、产品、开发等关键技术岗位；</li>
<li><strong>调用表现</strong>：当前支持工具100+，累计调用次数3k+，受限于部分用户使用习惯尚未完全转变和支持工具数量有限，但高频用户的周均调用频次达10次，使用粘性较高；</li>
<li><strong>效率提升</strong>：核心业务场景的造数效率提升效果明显，以“下单并流转至完单”为例，操作时间从原有的5分钟缩短至1.5分钟左右，效率提升70%；</li>
<li><strong>使用门槛</strong>：新用户上手适应时间从原有的3分钟压缩至1分钟内，自然语言交互方式有效降低了工具使用的学习成本；</li>
</ul>
<h3 data-id="heading-12">4.2 用户反馈：跨岗位认可，痛点解决明确</h3>
<p>尽管当前使用规模仍在拓展，但智能体精准解决了用户的核心痛点，获得了实际使用者的广泛认可，积累了不少正面反馈：</p>
<ul>
<li><strong>研发岗位</strong>：“这个太牛了，不用去数据工厂找工具了，研发联调的时候很受用”——某开发反馈；</li>
<li><strong>产岗位</strong>：“说实话，有AI*数据工厂，产品验收轻松多了”——某产品反馈；</li>
<li><strong>测试岗位</strong>：“太好用了，测试经常要批量造数，和它说，它可以一次完成，原来我还得在页面点多次”——某测试反馈。</li>
</ul>
<h3 data-id="heading-13">4.3 成果价值：验证方向，沉淀经验</h3>
<p>此次阶段性成果的核心价值，不仅在于效率数据的提升，更在于验证了“AI+数据工厂”模式的可行性：一方面，通过智能化手段解决了平台规模化后的核心痛点，为后续推广积累了真实使用案例；另一方面，基于用户反馈沉淀了模型调优、交互设计的经验，为进一步提升调用频次、扩大使用范围奠定了基础。</p>
<h2 data-id="heading-14">五、未来规划：在迭代中持续精进</h2>
<p>AI智能体的初步落地验证了方向的可行性，但在实际应用中，我们也发现了需要持续优化的核心痛点。基于当前反馈，后续将聚焦问题解决与能力升级，稳步推进智能化深化。</p>
<h3 data-id="heading-15">5.1 现存核心痛点</h3>
<p>结合用户使用数据与反馈收集，目前主要存在两类待解决的问题，也是后续优化的方向：</p>
<ul>
<li><strong>表述习惯差异导致的适配问题</strong>：不同岗位、不同使用经验的用户，对同一业务场景的表述存在差异。以“小b下单”场景为例，用户可能表述为“小b下单”“货运下单”“APP创建小b订单”等多种形式。尽管当前通过持续丰富RAG知识库已实现问题可控，但知识库更新存在一定后置性，未能从源头减少歧义。</li>
<li><strong>LLM</strong> <strong>上下文过载与幻觉问题</strong>：数据工厂工具覆盖货拉拉货运、小拉出行、国际化等全业务线，为保障LLM对业务场景的理解精度，需在上下文中外挂大量业务知识与工具信息，导致上下文内容过载。这一问题直接引发LLM幻觉现象频发（如工具选错、生成逻辑有误的执行序列等），单纯通过精简上下文内容已难以有效缓解。</li>
</ul>
<h3 data-id="heading-16">5.2 后续优化路径</h3>
<p>针对上述痛点，我们制定了明确的分阶段优化计划，兼顾短期问题解决与长期能力提升：</p>
<h4 data-id="heading-17">1. 前置化引导，降低表述歧义</h4>
<p>为解决表述差异问题，后续将从“后置知识库补充”转向“前置输入引导”。计划在交互界面增加场景化引导模块：基于历史调用数据梳理高频业务场景（如订单创建、账号查询、状态流转等），为每个场景配置标准化话术模板与关键词提示。用户输入时，系统可根据初步语义识别推荐对应场景模板，用户仅需补充关键参数即可完成需求提交，从源头降低歧义表述概率。</p>
<h4 data-id="heading-18"><strong>2. 职责拆分 + 场景固化，从架构层面降低幻觉概率</strong></h4>
<p>针对上下文过载引发的幻觉问题，采用 “现有平台交互改造 + 智能体职责拆分” 双轮驱动策略，具体如下：</p>
<ul>
<li><strong>现有平台交互改造</strong>：将现有平台执行底层升级为智能体执行模式，前端除了结果展示采用智能体输出效果，其他不变。该方式既能适配用户现有使用习惯，又能规避 LLM 动态组装工具带来的幻觉风险。</li>
<li><strong>智能体职责拆分</strong>：当前智能体核心决策依赖 “工具组装” 单一 LLM，导致其同时承载业务知识存储、工具匹配判断、执行序列生成等多重职责。后续将核心职责拆分为 “业务知识解析”“工具匹配筛选”“执行序列生成” 三个独立模块，通过 “轻量化 LLM + 专用 RAG 知识库” 协同实现（如专用 RAG 承载业务知识、独立 LLM 负责工具匹配）。此举可显著降低单个模型的上下文负载，从架构层面减少幻觉发生概率。</li>
</ul>
<h4 data-id="heading-19">3. 长期技术探索：微调路径持续验证</h4>
<p>尽管初期因数据、成本等因素放弃了Fine-tuning方案，但随着业务数据的积累与技术成本的优化，我们将持续小范围验证微调可行性。计划选取高频业务场景（如订单全链路相关工具），构建专属微调数据集，探索“基础模型+场景微调”的混合模式，进一步提升模型对特定场景的理解精度与决策稳定性。</p>
<h3 data-id="heading-20">5.3 转型感悟：AI落地是场长期修行</h3>
<p>在智能体落地过程中，我们深刻体会到：LLM的强大之处在于其泛化能力，但相较于传统工程代码的强可控性，它更像一个“需要持续调教的伙伴”。AI赋能并非一蹴而就，而是循序渐进的迭代过程——既要接受初期的不完美，通过实际场景反馈持续调优；也要保持对新技术的敏感度，及时将成熟的技术方案融入现有体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用第三方库处理多线程请求接口结果顺序问题？]]></title>    <link>https://juejin.cn/post/7571409339362770971</link>    <guid>https://juejin.cn/post/7571409339362770971</guid>    <pubDate>2025-11-12T03:25:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571409339362770971" data-draft-id="7571360278971547657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用第三方库处理多线程请求接口结果顺序问题？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T03:25:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户22176592792"/> <meta itemprop="url" content="https://juejin.cn/user/4461135061323432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用第三方库处理多线程请求接口结果顺序问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4461135061323432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户22176592792
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:25:46.000Z" title="Wed Nov 12 2025 03:25:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用第三方库处理多线程（或更高效的<strong>协程/异步</strong>）请求接口的结果顺序问题，核心思路是 <strong>“利用库的内置机制，让结果顺序与请求提交顺序一致”</strong> ——无需手动处理排序、锁或队列，库已封装好线程安全和有序逻辑。以下是 <strong>3个最常用的第三方库（grequests、httpx、trio）</strong> 的实战教程，覆盖不同场景，步骤清晰且可直接复用：</p>
<h3 data-id="heading-0">核心前提</h3>
<p>所有方案的“有序”本质：<strong>请求提交顺序 → 任务列表顺序 → 结果列表顺序</strong> 一一对应，库内部通过协程调度、异步事件循环或线程池管理，确保结果不会乱序。<br/>
优先选择 <strong>协程/异步库</strong>（而非纯多线程），因为IO密集型接口请求中，协程效率更高（无线程切换开销、无GIL限制）。</p>
<h3 data-id="heading-1">一、方案1：grequests（最快上手，requests+协程）</h3>
<h4 data-id="heading-2">特点</h4>
<ul>
<li>基于 ​<code>​requests​</code>​（完全兼容其API）和 ​<code>​gevent​</code>​（协程），无需修改原有requests代码；</li>
<li>一行代码实现并发，​<code>​grequests.map()​</code>​ 天然保证结果顺序；</li>
<li>适合快速替换requests实现高并发+有序结果。</li>
</ul>
<h4 data-id="heading-3">步骤&amp;代码</h4>
<h5 data-id="heading-4">1. 安装依赖</h5>
<pre><code class="hljs">pip install grequests
</code></pre>
<h5 data-id="heading-5">2. 完整实现（有序结果）</h5>
<pre><code class="hljs language-ini" lang="ini">import grequests
import time

<span class="hljs-comment"># 配置参数</span>
<span class="hljs-attr">API_URL</span> = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>  <span class="hljs-comment"># 测试接口</span>
<span class="hljs-attr">TOTAL_REQUESTS</span> = <span class="hljs-number">20</span>  <span class="hljs-comment"># 总请求数</span>
<span class="hljs-attr">TIMEOUT</span> = <span class="hljs-number">5</span>  <span class="hljs-comment"># 超时时间</span>
<span class="hljs-attr">CONCURRENT_NUM</span> = <span class="hljs-number">10</span>  <span class="hljs-comment"># 并发数（类似线程池大小）</span>

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-attr">start_time</span> = time.time()

    <span class="hljs-comment"># 1. 构造请求列表（按顺序提交，索引0~19）</span>
    <span class="hljs-comment"># 每个请求对应一个索引，确保结果能追溯到原始请求顺序</span>
    <span class="hljs-attr">requests_list</span> = [
        grequests.get(
            API_URL.format(i % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>),  <span class="hljs-comment"># 循环请求1~10的测试接口</span>
            timeout=TIMEOUT,
            headers={<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"grequests-test"</span>}
        )
        for i in range(TOTAL_REQUESTS)
    ]

    <span class="hljs-comment"># 2. 并发执行，map() 保证结果顺序与请求顺序一致</span>
    <span class="hljs-comment"># size=CONCURRENT_NUM：控制最大并发数，避免压垮接口</span>
    <span class="hljs-attr">responses</span> = grequests.map(requests_list, size=CONCURRENT_NUM)

    <span class="hljs-comment"># 3. 按顺序处理结果（responses顺序 = 请求提交顺序）</span>
    print("grequests 有序结果输出：")
    print("-" * 60)
    for idx, response in enumerate(responses):
        if response and <span class="hljs-attr">response.status_code</span> == <span class="hljs-number">200</span>:
            <span class="hljs-comment"># 成功：提取响应数据</span>
            <span class="hljs-attr">title</span> = response.json()[<span class="hljs-string">"title"</span>][:<span class="hljs-number">20</span>]  <span class="hljs-comment"># 截取标题前20字</span>
            print(f"任务<span class="hljs-section">[{idx}]</span>：✅ 成功 - 响应标题：{title}...")
        else:
            <span class="hljs-comment"># 失败：输出错误信息</span>
            <span class="hljs-attr">err_msg</span> = response.reason if response else <span class="hljs-string">"请求超时/连接失败"</span>
            print(f"任务<span class="hljs-section">[{idx}]</span>：❌ 失败 - 原因：{err_msg<span class="hljs-section">[:30]</span>}")

    <span class="hljs-comment"># 统计耗时</span>
    <span class="hljs-attr">total_cost</span> = round(time.time() - start_time, <span class="hljs-number">3</span>)
    print("-" * 60)
    print(f"总耗时：{total_cost}s，总请求数：{TOTAL_REQUESTS}")
</code></pre>
<h5 data-id="heading-6">关键说明</h5>
<ul>
<li>​<code>​grequests.map(requests_list, size=...)​</code>​：核心函数，并发执行请求列表，返回结果列表（顺序与请求列表一致）；</li>
<li>即使某个请求耗时久，结果列表仍会按原始请求顺序排列（如任务3比任务2先完成，但结果列表中任务2的位置仍在任务3前面）；</li>
<li>兼容requests的所有参数（如 ​<code>​data​</code>​、​<code>​json​</code>​、​<code>​headers​</code>​），支持POST请求。</li>
</ul>
<h3 data-id="heading-7">二、方案2：httpx（高性能，同步/异步双模式）</h3>
<h4 data-id="heading-8">特点</h4>
<ul>
<li>新一代HTTP客户端，可替代requests，支持同步+异步两种模式；</li>
<li>异步模式基于 ​<code>​asyncio​</code>​，并发效率高，​<code>​asyncio.gather()​</code>​ 天然保证结果顺序；</li>
<li>支持HTTP/2、连接池复用，稳定性优于requests。</li>
</ul>
<h4 data-id="heading-9">步骤&amp;代码</h4>
<h5 data-id="heading-10">1. 安装依赖</h5>
<pre><code class="hljs">pip install httpx
</code></pre>
<h5 data-id="heading-11">2. 完整实现（异步并发+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> sys

<span class="hljs-comment"># 配置参数</span>
API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>
CONCURRENT_NUM = <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大并发连接数</span>

<span class="hljs-comment"># 单个异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params">client: httpx.AsyncClient, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""返回 (索引, 是否成功, 结果信息)，确保顺序追溯"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = <span class="hljs-keyword">await</span> client.get(url, timeout=TIMEOUT)
        response.raise_for_status()  <span class="hljs-comment"># 4xx/5xx状态码抛出异常</span>
        data = response.json()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应标题：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"原因：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-comment"># 主异步函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步客户端（复用连接池，提升效率）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(
        limits=httpx.Limits(max_connections=CONCURRENT_NUM)  <span class="hljs-comment"># 限制并发连接数</span>
    ) <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 2. 构造异步任务列表（按顺序提交，索引0~19）</span>
        tasks = [fetch_data(client, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]
        
        <span class="hljs-comment"># 3. 并发执行任务，gather() 保证结果顺序与任务顺序一致</span>
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)

    <span class="hljs-comment"># 4. 按顺序输出结果（results顺序 = 任务提交顺序）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"httpx 异步有序结果输出："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-comment"># 统计耗时</span>
    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{total_cost}</span>s，总请求数：<span class="hljs-subst">{TOTAL_REQUESTS}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 兼容Windows系统（解决asyncio事件循环问题）</span>
    <span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">"win32"</span>:
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    asyncio.run(main())  <span class="hljs-comment"># 启动异步事件循环</span>
</code></pre>
<h5 data-id="heading-12">关键说明</h5>
<ul>
<li>​<code>​asyncio.gather(*tasks)​</code>​：核心函数，并发执行所有异步任务，返回结果列表（顺序与任务列表完全一致）；</li>
<li>异步客户端 ​<code>​httpx.AsyncClient​</code>​ 支持连接池复用，比单个请求创建连接效率高得多；</li>
<li>支持POST请求：将 ​<code>​client.get()​</code>​ 改为 ​<code>​client.post()​</code>​，传入 ​<code>​json={"key": "value"}​</code>​ 即可。</li>
</ul>
<h3 data-id="heading-13">三、方案3：trio（结构化并发，简洁优雅）</h3>
<h4 data-id="heading-14">特点</h4>
<ul>
<li>基于“结构化并发”的异步库，API比asyncio更简洁，错误处理更优雅；</li>
<li>天然支持结果顺序与请求顺序一致，无需额外配置；</li>
<li>适合追求代码简洁性的异步编程场景。</li>
</ul>
<h4 data-id="heading-15">步骤&amp;代码</h4>
<h5 data-id="heading-16">1. 安装依赖</h5>
<pre><code class="hljs language-arduino" lang="arduino">pip install trio httpx-trio  <span class="hljs-meta"># httpx-trio：httpx适配trio的插件</span>
</code></pre>
<h5 data-id="heading-17">2. 完整实现（异步并发+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 配置参数</span>
API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>
CONCURRENT_NUM = <span class="hljs-number">10</span>

<span class="hljs-comment"># 单个异步请求函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params">client: httpx.AsyncClient, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = <span class="hljs-keyword">await</span> client.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        data = response.json()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应标题：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"原因：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-comment"># 主函数（trio的结构化并发）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步客户端（结合trio）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(
        limits=httpx.Limits(max_connections=CONCURRENT_NUM)
    ) <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 2. 构造任务列表（按顺序提交）</span>
        <span class="hljs-comment"># trio.gather() 与 asyncio.gather() 用法一致，保证结果顺序</span>
        results = <span class="hljs-keyword">await</span> trio.gather(*[fetch_data(client, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)])

    <span class="hljs-comment"># 3. 按顺序输出结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"trio 异步有序结果输出："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-comment"># 统计耗时</span>
    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{total_cost}</span>s，总请求数：<span class="hljs-subst">{TOTAL_REQUESTS}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    trio.run(main())  <span class="hljs-comment"># trio自带事件循环，直接运行主函数</span>
</code></pre>
<h5 data-id="heading-18">关键说明</h5>
<ul>
<li>​<code>​trio.gather(*tasks)​</code>​：核心函数，功能与 ​<code>​asyncio.gather()​</code>​ 一致，保证结果顺序；</li>
<li>代码比asyncio更简洁，无需手动处理事件循环兼容（如Windows系统）；</li>
<li>结构化并发特性：如果某个任务报错，会自动取消其他未完成任务，避免资源泄漏（可通过 ​<code>​trio.CancelScope​</code>​ 灵活控制）。</li>
</ul>
<h3 data-id="heading-19">四、方案4：tenacity（重试+多线程/异步，有序+高可用）</h3>
<h4 data-id="heading-20">特点</h4>
<ul>
<li>并非HTTP库，而是<strong>重试库</strong>，可与任意并发方案（ThreadPoolExecutor、httpx、aiohttp）结合；</li>
<li>支持失败自动重试（指定重试条件、间隔、次数），不破坏结果顺序；</li>
<li>适合接口不稳定场景（如超时、连接错误），确保有序结果的同时提升成功率。</li>
</ul>
<h4 data-id="heading-21">步骤&amp;代码（结合ThreadPoolExecutor）</h4>
<h5 data-id="heading-22">1. 安装依赖</h5>
<pre><code class="hljs">pip install tenacity requests
</code></pre>
<h5 data-id="heading-23">2. 完整实现（多线程+重试+有序结果）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_exponential, retry_if_exception_type
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 配置参数</span>
API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
THREAD_NUM = <span class="hljs-number">10</span>  <span class="hljs-comment"># 线程池大小</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-comment"># 配置重试策略：仅对超时/连接错误重试，最多重试2次，间隔1s、2s</span>
<span class="hljs-meta">@retry(<span class="hljs-params">
    stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">2</span></span>),  <span class="hljs-comment"># 最大重试次数</span>
    wait=wait_exponential(<span class="hljs-params">multiplier=<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">5</span></span>),  <span class="hljs-comment"># 指数退避间隔</span>
    retry=retry_if_exception_type(<span class="hljs-params">(<span class="hljs-params">requests.exceptions.Timeout, requests.exceptions.ConnectionError</span>)</span>)  <span class="hljs-comment"># 重试条件</span>
</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_data</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应标题：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"原因：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建线程池，提交任务（Future列表顺序与请求顺序一致）</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=THREAD_NUM) <span class="hljs-keyword">as</span> executor:
        future_list = [executor.submit(fetch_data, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]

        <span class="hljs-comment"># 2. 按Future列表顺序获取结果（保证有序）</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"ThreadPoolExecutor + tenacity 有序结果输出："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> future_list:
            idx, is_success, msg = future.result()  <span class="hljs-comment"># 按提交顺序阻塞等待</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-comment"># 统计耗时</span>
    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{total_cost}</span>s，总请求数：<span class="hljs-subst">{TOTAL_REQUESTS}</span>"</span>)
</code></pre>
<h5 data-id="heading-24">关键说明</h5>
<ul>
<li>​<code>​@retry(...)​</code>​：装饰器配置重试策略，不影响结果顺序（重试仅在当前任务内部执行）；</li>
<li>按 ​<code>​future_list​</code>​ 顺序调用 ​<code>​future.result()​</code>​：核心是“按提交顺序等待结果”，即使线程执行无序，结果获取顺序仍固定；</li>
<li>可与httpx、aiohttp结合：将 ​<code>​requests.get()​</code>​ 替换为异步请求，重试逻辑不变，仍保证有序。</li>
</ul>
<h3 data-id="heading-25">五、选型建议&amp;面试重点</h3>
<h4 data-id="heading-26">1. 选型优先级</h4>






























<table><thead><tr><th>场景</th><th>推荐库</th><th>核心原因</th></tr></thead><tbody><tr><td>快速上手、兼容requests</td><td>grequests</td><td>语法极简，无需学习新API</td></tr><tr><td>高性能、支持HTTP/2</td><td>httpx</td><td>同步/异步双模式，稳定性强</td></tr><tr><td>追求代码简洁、结构化并发</td><td>trio</td><td>API优雅，错误处理友好</td></tr><tr><td>接口不稳定、需要重试</td><td>tenacity</td><td>可与任意并发方案结合，提升成功率</td></tr></tbody></table>
<h4 data-id="heading-27">2. 面试关键要点</h4>
<ul>
<li><strong>有序的核心原理</strong>：第三方库通过“任务列表与结果列表绑定”实现有序，无需手动排序；</li>
<li><strong>协程vs多线程</strong>：IO密集型接口请求优先选协程（grequests/httpx/trio），效率高于多线程（无GIL限制、无线程切换开销）；</li>
<li><strong>线程安全</strong>：所有推荐库均内置线程安全机制（如协程调度、异步锁），无需手动加锁；</li>
<li><strong>扩展能力</strong>：支持POST请求、请求头配置、超时控制、重试机制，满足工业级需求。</li>
</ul>
<h4 data-id="heading-28">3. 避坑指南</h4>
<ul>
<li>控制并发数：避免设置过大的并发数（如超过50），否则可能被服务端限流或封禁IP；</li>
<li>超时必须配置：防止单个请求阻塞导致整体任务卡住；</li>
<li>异常捕获：必须捕获HTTP错误（4xx/5xx）、超时、连接错误，避免单个任务报错影响整体。</li>
</ul>
<p>以上方案均可直接运行，只需替换 ​<code>​API_URL​</code>​ 为实际接口地址，即可快速实现“多线程/并发请求+有序结果”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初识预加载]]></title>    <link>https://juejin.cn/post/7571352754897551386</link>    <guid>https://juejin.cn/post/7571352754897551386</guid>    <pubDate>2025-11-12T03:27:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754897551386" data-draft-id="7571378103281926150" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初识预加载"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T03:27:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李志278"/> <meta itemprop="url" content="https://juejin.cn/user/3370420524565547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初识预加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3370420524565547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李志278
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:27:11.000Z" title="Wed Nov 12 2025 03:27:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0"> 背景： </h2>
<p>在实习项目中，我遇到了一个典型的视频加载性能问题。页面上有三四个十几秒的视频，只有在满足特定条件时才会播放。最初没有做任何预加载，结果播放时偶尔会出现卡顿。于是我在 <code>&lt;video&gt;</code> 标签中添加了 <code>rel="prefetch"</code> 属性，但由于这些视频共用同一个标签、仅动态切换 <code>src</code>，实际效果并不明显。后来我尝试在组件挂载时通过 JavaScript 手动预加载，但在低速网络下首屏渲染依旧很差。经过查阅 MDN 文档并向 ChatGPT 请教，学习总结了一下预加载。（文末附本人的解决方案）</p>
<h2 data-id="heading-1">一、什么是“预加载”（Preloading）</h2>
<p><strong>预加载</strong>指的是在资源<strong>还未被使用前</strong>，<strong>提前加载进浏览器缓存或内存</strong>，以便在真正需要时能<strong>瞬间可用</strong>。<br/>
核心目标：<strong>减少用户感知的等待时间（Perceived Latency）</strong> 。</p>
<p>浏览器的下载队列和渲染主线程都是有限资源，预加载的设计哲学就是：</p>
<p>“先把带宽用在未来要用的内容上，但不要妨碍当前页面渲染。”</p>
<hr/>
<h2 data-id="heading-2"> 二、requestIdleCallback 的本质</h2>
<p><code>requestIdleCallback(callback[, options])</code><br/>
是一个<strong>任务调度 API</strong>，允许开发者在浏览器<strong>空闲帧</strong>期间执行非关键逻辑。</p>
<p>浏览器每 16.6ms（约 60FPS）会重新绘制一次。<br/>
当主线程完成布局、绘制、事件处理后，若本帧仍有空闲时间，就会执行 <code>requestIdleCallback</code> 注册的回调。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function"><span class="hljs-params">deadline</span> =&gt;</span> {
  <span class="hljs-keyword">while</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 执行轻量任务</span>
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>关键点：</p>
<ul>
<li> 不保证立即执行（由浏览器调度）</li>
<li> 可通过 <code>deadline.timeRemaining()</code> 判断剩余时间</li>
<li> 低优先级任务（浏览器可能跳过）</li>
<li> 适用于“可延迟的预加载逻辑”</li>
</ul>
<p>换句话说：<br/>
<code>requestIdleCallback</code> 是**“让预加载不干扰主线程的调度器”**，不是预加载本身。</p>
<hr/>
<h2 data-id="heading-3"> 三、预加载的四种核心方式（+ 浏览器底层优先级）</h2>















































<table><thead><tr><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td>方法</td><td>优先级</td><td>触发时机</td><td>适用场景</td><td>浏览器行为</td></tr><tr><td><code>&lt;link rel="preload"&gt;</code></td><td><strong>高</strong></td><td>立即加载</td><td>首屏关键资源</td><td>主线程立刻发起请求，占带宽</td></tr><tr><td><code>&lt;link rel="prefetch"&gt;</code></td><td><strong>低</strong></td><td>空闲时加载</td><td>可能会用到的下个页面资源</td><td>放入低优先级下载队列</td></tr><tr><td>JS 手动加载 (<code>new Image()</code>, <code>video.load()</code>)</td><td>中</td><td>可控</td><td>精确控制加载逻辑</td><td>由 JS 主动创建请求</td></tr><tr><td><code>requestIdleCallback()</code></td><td>调度层</td><td>空闲帧执行</td><td>调度非关键任务（如上报、缓存）</td><td>不加载资源，仅负责“何时执行”</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4"> 四、组合优化策略（实战建议）</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义资源</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">prefetchVideo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'link'</span>)
  link.<span class="hljs-property">rel</span> = <span class="hljs-string">'prefetch'</span>
  link.<span class="hljs-property">as</span> = <span class="hljs-string">'video'</span>
  link.<span class="hljs-property">href</span> = <span class="hljs-string">'/assets/intro.mp4'</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(link)
}

<span class="hljs-comment">// 调度执行</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'requestIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-title function_">requestIdleCallback</span>(prefetchVideo)
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// Safari fallback</span>
  <span class="hljs-built_in">setTimeout</span>(prefetchVideo, <span class="hljs-number">2000</span>)
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>组合优势：</strong></p>
<ul>
<li><code>prefetch</code> → 利用空闲带宽；</li>
<li><code>requestIdleCallback</code> → 避免主线程忙碌时添加 <code>&lt;link&gt;</code>；</li>
<li>整体节奏平衡：<strong>CPU 不阻塞，网络不浪费。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-5"> 五、HTTP 层与浏览器调度机制</h2>
<p>浏览器内部有<strong>资源优先级系统</strong>，会根据资源类型分配网络带宽：</p>





























<table><thead><tr><th/><th/></tr></thead><tbody><tr><td>类型</td><td>优先级</td></tr><tr><td>HTML / CSS / JS (首屏)</td><td>Highest</td></tr><tr><td>preload</td><td>High</td></tr><tr><td>prefetch</td><td>Low</td></tr><tr><td>img / video / font (非首屏)</td><td>Medium / Low</td></tr></tbody></table>
<p>在 HTTP/2 / HTTP/3 下，<code>preload</code> 可以直接让服务端提前推送（Server Push 已废弃但仍有影响），<br/>
而 <code>prefetch</code> 只是<strong>提示浏览器</strong>：“这资源可能未来用到”，是否加载由浏览器决定。</p>
<hr/>
<h2 data-id="heading-6"> 六、更多高级预加载技巧</h2>
<ol>
<li><strong>DNS Prefetch / Preconnect</strong><br/>
提前建立 DNS 或 TCP/TLS 连接，加速外部资源。</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">&lt;link <span class="hljs-attr">rel</span>=<span class="hljs-string">"dns-prefetch"</span> href=<span class="hljs-string">"//cdn.example.com"</span>&gt;
  &lt;link <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> href=<span class="hljs-string">"https://cdn.example.com"</span>&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ol>
<li><strong>模块预加载（ESM 动态导入）</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">'./nextPage.js'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Webpack 自动生成 <code>&lt;link rel="prefetch"&gt;</code>，用于懒加载页面的提前下载。</p>
<ol>
<li><strong>Service Worker 缓存预加载</strong><br/>
可以结合 Cache API，在空闲时缓存页面资源：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">self.addEventListener('message', <span class="hljs-attr">e</span> =&gt; {
  caches.open('v1').then(<span class="hljs-attr">cache</span> =&gt; cache.addAll([<span class="hljs-string">'/next.html'</span>, <span class="hljs-string">'/next.js'</span>]))
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7"> 七、总结（逻辑关系图）</h2>
<pre><code class="hljs language-lua" lang="lua">预加载 = 提前加载 + 合理调度
└── <span class="hljs-built_in">preload</span>：立即加载，关键资源
└── prefetch：未来资源，低优先级
└── JS手动加载：精准控制加载时机
└── requestIdleCallback：优化执行时机（CPU层）
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>底层机制：</p>
<ul>
<li>浏览器有独立的网络调度系统；</li>
<li>各种 rel 属性影响资源优先级；</li>
<li><code>requestIdleCallback</code> 属于 <strong>任务调度层</strong>，用于协调 CPU 资源；</li>
<li>组合使用时，能最大化性能与体验。</li>
</ul>
<h2 data-id="heading-8">八、解决方案</h2>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">preloadVideos</span> = () =&gt; {
  const <span class="hljs-attr">videoUrls</span> = [
  //视频链接
]<span class="hljs-comment">;</span>

  videoUrls.forEach((url) =&gt; {
    const <span class="hljs-attr">link</span> = document.createElement(<span class="hljs-string">"link"</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">link.rel</span> = <span class="hljs-string">"prefetch"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">link.as</span> = <span class="hljs-string">"video"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">link.href</span> = url<span class="hljs-comment">;</span>
    document.head.appendChild(link)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">scheduleVideoPreload</span> = () =&gt; {
  if (typeof <span class="hljs-attr">window</span> === <span class="hljs-string">"undefined"</span>) return<span class="hljs-comment">;</span>
  const <span class="hljs-attr">idleCallback</span> = (window as any).requestIdleCallback<span class="hljs-comment">;</span>

  if (typeof <span class="hljs-attr">idleCallback</span> === <span class="hljs-string">"function"</span>) {
    idleCallback(() =&gt; {
      preloadVideos()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  } else {
    requestAnimationFrame(() =&gt; {
      preloadVideos()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
// 组件挂载时预加载视频
onMounted(() =&gt; {
  requestAnimationFrame(() =&gt; {
    scheduleVideoPreload()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>有更好的解决方案欢迎评论区交流。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[结项报告完整版：Apache SeaTunnel 支持 Flink 引擎 Schema Evolution 功能]]></title>    <link>https://juejin.cn/post/7571334572769968171</link>    <guid>https://juejin.cn/post/7571334572769968171</guid>    <pubDate>2025-11-12T03:10:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572769968171" data-draft-id="7571355146771595306" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="结项报告完整版：Apache SeaTunnel 支持 Flink  引擎 Schema Evolution 功能"/> <meta itemprop="keywords" content="大数据,Flink,开源"/> <meta itemprop="datePublished" content="2025-11-12T03:10:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白鲸开源"/> <meta itemprop="url" content="https://juejin.cn/user/3870725052049454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            结项报告完整版：Apache SeaTunnel 支持 Flink  引擎 Schema Evolution 功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3870725052049454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白鲸开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:10:50.000Z" title="Wed Nov 12 2025 03:10:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>过去两周，我们对开源之夏活动中表现优异的开发者们进行了简单的采访，初步粗略地了解了一下他们的开发过程和心得体会。今天，我们将通过同学们的完整结项报告，深入了解项目的开发技术细节，希望能够帮助大家更好地了解 Apache SeaTunnel 项目的最新进展。</p>
<p>接下来是关于<em><strong>在 Flink  引擎上对 Schema Evolution 功能的支持</strong></em>这一项目的完整报告：</p>
<h2 data-id="heading-0">一. 已完成工作</h2>
<p>根据原定方案（<a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FQTxYwPcytiG4bxku0vQcrvtlnlb%25EF%25BC%2589%25E5%2592%258C%25E6%2597%25B6%25E9%2597%25B4%25E8%25A7%2584" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/QTxYwPcytiG4bxku0vQcrvtlnlb%EF%BC%89%E5%92%8C%E6%97%B6%E9%97%B4%E8%A7%84" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/QTxYwP…</a>  划，已完成在 Flink  引擎上对 Schema Evolution 功能的支持，目前  Sink 端已支持在  Flink 引擎   上进行流式变更的有：  JdbcSinkWriter ， JdbcExactlyOnceSinkWriter ， ConsoleSinkWriter ，已 经测试完毕，目前没有发现在 Schema Evolution 流程中有明显 bug。</p>
<p>✅在 source 和 transform 之间动态插入算子，如果检测到实现了 SupportSchemaEvolution 的类， 并且开启了 schema evolution 的配置，则插入SchemaOperator。</p>
<p>✅实现 SchemaCoordiantor 协调器，接收 sink 端上报的刷写信息，同时接收 SchemaOperator 上 报的 Schema 变更请求。</p>
<p>✅扩展 SchemaChangeEvent子类，支持 FlushEvent 事件流转。</p>
<p>✅扩展 SupportSchemaEvolutionSinkWriter 方法，支持上报刷写成功信息，处理 FlushEvent。</p>
<p>✅实现 SchemaOperator 算子，检测被 source 端发出的变更事件并处理，支持变更事件透传到下 游。</p>
<p>✅重写 SupportSchemaEvolutionSinkWriter 关于 Schema evolution方法，目前支持
JdbcSinkWriter，JdbcExactlyOnceSinkWriter ，ConsoleSinkWriter，测试完毕，符合预期。</p>
<p>✅扩展 FlinkRowCollector 的 collect 方法，支持变更事件的收集。</p>
<p>✅扩展 FlinkSinkWriter 方法，支持检测变更事件并处理。</p>
<p>✅扩展 SchemaEvolution 错误码和异常体系，变更出现异常时支持详细异常信息上报。</p>
<p>✅变更任务出现异常后，自动抛出异常，交给重试机制处理。</p>
<h2 data-id="heading-1">二. 遇到的问题及解决方案</h2>
<h3 data-id="heading-2">1. 事件流转问题</h3>
<p>在 source 端和 transform 中间插入一个 operator时，需要在内部判断流转过来的元素是否是事 件，如果是事件，就阻塞，等待刷写变更之后再次流转；否则就继续向下流转，有两种方案：</p>
<ul>
<li>和 Zeta 引擎保持一致，创建类似 Record 的类 StreamElement  ，但是从 source 到 transform 到 sink 端的所有链路，关于 SeatunnelRow 的都要修改为 StreamElement，入侵性极高，且非常危 险，影响面大。</li>
<li>在 SeatunnelRow 中添加特殊标记，比如在 options 里面添加一个选项，如果遇到事件，存储到额 外信息里面，这样对链路入侵性不高，但是违反单一设计原则，按理来说 SeatunnelRow 不应该关 心事件，只负责数据流转，之后如果架构升级可以重构，目前以实现功能为主，减小风险。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079f9f2b39b24eada7bbfb86230a5c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=hsbWVb95cNzbcF75DJ9d3Z7JWXE%3D" alt="" loading="lazy"/></p>
<p>之后就可以在 SchemaOperator 算子里面检测到这个标记了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6ac829d7356463dbefb3c8482ca725a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=S3sHgHigfn8AdlptQzoccz9%2F4Aw%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c07cc0ac534085af0c8eb37492b4a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=zkJVwIgn5huXvZH%2FrxUPrYci%2Bno%3D" alt="" loading="lazy"/></p>
<p>但是这样同样会带来一个问题，就是我们 new 了一个空行，会导致 sink 端的写入报错，所以需要 在 sink 端检测：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1afc9fc4172c4b05b9c5ed1ffea5b86f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=R0%2FKRHx1RnUs6yIUpyo4%2FtM4lrs%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de18a34c0e304a15b0fa011b9704f076~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=Md1HPg%2FpivmAuhrHYpbXB%2BcEfNU%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38dfdffb3e1144fcbeda72a0de30619d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=8zzFfzKZaUnxZSX9T%2BnzoKpLmfE%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f7b5d84ad741a3af1ca3afc9333d5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=qm4OVdvYJ4A%2B86b9LTpyNGb2qts%3D" alt="" loading="lazy"/></p>
<p>这样就能解决事件透传的问题。</p>
<h3 data-id="heading-3">2. 多并行度问题</h3>
<p>实际上在 Flink CDC 的实现中，增量快照阶段，按照用户定义并行度开启任务，读取快照数据；进 入增量阶段后，为了保证顺序，只会保留一个任务来读取，所以我们不需要给协调器多么复杂的实现， 让它正常接收 sink 端响应即可，也不用考虑多个分区重复上报以及顺序问题：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae3b6aa001e04fc795f157501289f1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=rPitoyMbYb6IQFoZQva3eUQoWAg%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98caa9a7213242479855b6f8e176c159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=7LZ74KDac%2FRY814rZIndN9z8OmM%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a34a1d46d02e415496d6ced799f11b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=eBTepOGONlvCEhaMtHZNqca%2BzSc%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8c2acc314fc483badabc812098b999d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=N6%2B3OEARI0h9Eyu4EWo9MzrrGII%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cc6411a2adc4707b949c637e6ceef36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=5G9g1yDEWgxj2C%2F1Cg%2BitWAclDw%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b3acdace704494baf07f61c1530c685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=dxYGqKy1T8l0Ien5vcjdXkt3tNg%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4c8fb3ba7e143fbaf2467e48e09f506~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=giQhCcyTeNo6PNPFHm549Z9Qgqc%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4269a236c344d45bcb6a863a2b7193f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=L8W%2FknAGV4ioVqWIHOOHVkpYsxA%3D" alt="" loading="lazy"/></p>
<p>关于 source 端明明是一个任务，但是 sink 可能是多个任务的问题，看了下 flink cdc 相关源码， CDC source 确实是由一个任务来读取 binlog，但之后数据通过 KeyGroupStreamPartitioner 按主键 hash分发，不同的 key 被发送到不同的 sink 任务，每个 sink 任务处理分配给它的 key 范围的数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc3d2beaa38d47a1bfbba5029f3bc677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=OlKycwAxBOfoY1cyI1iJeJZ8sls%3D" alt="" loading="lazy"/></p>
<p>具体实现里面，会先检查 sink 端和 input 的并行度是否相同，如果不同，会采取 primary key shuffle 的手段：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed72fe10d32b49fca469040e7ef99503~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=e8VaLFOcdLLpMy1RWAuKbblSJJY%3D" alt="" loading="lazy"/></p>
<p>sink 配置了自定义并行度且不等于输入并行度时， Flink 会进行特殊处理：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37997a27d3c0490385b711143309d8aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=STsZdwwZCUIQGG1PuDvJuMLIHR4%3D" alt="" loading="lazy"/></p>
<p>如果 sink 并行度与 input 并行度不同，会通过 primary key 进行 shuffle：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a5d1953567e42049006d2cb0e4da9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=ggBrwN27pCgqQ3EtTErWY6iqADk%3D" alt="" loading="lazy"/></p>
<p>Flink  自己应该支持这种 sink 端的多并行度，但是我有几个考虑的点：</p>
<ol>
<li>如果真要实现这种机制， Shuffle 的实现对我来说有难度。</li>
<li>如果多个并行度同时收到变更命令，对于幂等性的数据库来说，变更可能不受影响，但是像
StarRocks 这种 OLAP 数据库没有幂等性，所以有困难，当然这种也有解决办法，就是收到几个分   区的刷写完成响应之后，协调器收到 ack，让协调器来变更，同样也很麻烦，不如让 source 和 sink 使用相同并行度，在一条算子链里面，也不用 shuffle，但是还有一个点是，数据量大的情况下可能 影响性能。</li>
</ol>
<p>所以，我目前检测到 cdc 变更之后强制指定 sink 端并行度就是1，这样也不会有上面的问题，之后 可以进行迭代来支持 sink 端的需求：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5aecfd3e9864d11bdcab75bdfacdc45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=wrGsRjjXRGyhWeTT8FVw%2BrB0LvY%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6750294350054a369c1687ffc3847d6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=eeUyrWg%2B%2FE0JMHKVacwdGdGnLaA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3. 刷写与请求的执行顺序问题</h3>
<p>之前在 SchemaOperator 算子里面处理变更事件的时候，我先发送了刷写事件，之后才请求协调器 进行变更，这样会有一个问题，协调器内部的 SchemaChangeState 还没有进行初始化，所以之后协调  器迟迟获取不到 State，先一步到的 FluEvent 也没有被成功接收， 一直阻塞，之后任务超过了我设定的 超时时间，任务就失败了。
分析日志后发现：</p>
<ul>
<li>12:33:36,597  - FlushEvent 被处理， Sink 立即上报了 flush 成功</li>
<li>12:33:36,597  - 协调器警告： "No schema change state found"</li>
<li>12:33:36,598  - 协调器才创建 schema change state</li>
</ul>
<p>再次查看我写的代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e3daa0ad4b49369ff27a91bbfcad36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=jKK3mhEdnzWlu4sqkstnhUkfWik%3D" alt="" loading="lazy"/></p>
<p>所以问题就比较明显， Sink 的 flush 通知比协调器的 requestSchemaChange 更早到达，导致通知 被丢弃，我们只需要修改执行顺序即可解决此问题：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aa038e4deaa40b583f422ebdf2cf5b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=QuqNjtsoGUgY4we5mA12luyW0xg%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5523f20407a446728f7092d24346c552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=8xb%2Fx9bMpf2YOSNXkql1BoKfexA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4. FlushData 和 变更问题</h3>
<p>之前我在实现的时候， FlushEvent  内部包裹着 SchemaChangeEvent，在 FlushData 的同时就把表 变更了，这样有一个问题就是职责不清晰，比较混乱，之后就把职责分开，刷写数据就只刷写数据，之   后上报协调器，再次发送变更事件，真正进行变更：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75851029b8e546f497187ac9eb3fea48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=1zEaY5E6a7PzAYxXCQZmexs%2BaDk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">5. 默认实现与接口职责问题</h3>
<p>目前为了向前兼容，SupportSchemaEvolutionSinkWriter 中新增方法均被标记为 default，之后再 进行迭代。迭代完毕之后，即可取消 default 关键字：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5218845c2fa2486198be8e4b90e72dae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=3wl2hNCfnAVOlF0sX10IQvSuuJA%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24aedb34b41f4794a49fb9a235683499~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=FKqIIALl2TNUb8RF0whr6azoMpk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">6. 变更失败后标记失败 or 回滚问题</h3>
<p>有一个问题是，假设说因为网络问题或者其他问题，作业失败了，那么应该直接标记作业失败，让 Flink  自己从检查点拉起作业，还是让其直接回滚？</p>
<p>Flink CDC 的实现是直接标记失败，之后从检查点恢复，目前我采用的是标记失败的策略，考虑的点 是，主动回滚开发相当麻烦，可能还需要 flink ck 进行适配，直接让 schema 变更失败时抛出异常，让现 有的重试机制处理就行，而且也观察到 SeaTunnel 这边做了重试相关的机制， Flink自己有全局重试策略，no ，fixed-delay ，failure-rate（已实现，已测试）。</p>
<p>因为要抛出异常，直接抛出 RuntimeException 对开发者定位问题和用户都不是很友好，所以增强 了异常机制，实现了自己的异常类，错误码和异常方法。
异常处理示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a36ac38976840dba3f1ed28fdb6622a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=vkqASvvDosAvSEB5bNQaQ5jyifU%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e7d6901ff94ea8b27c99051c12fa1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96bK45byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763521850&amp;x-signature=4Q173eoHYsWx0b3QXTlw2Ewcpao%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">三. 测试用例与结果</h2>
<p>关于 MySQLCDC to MySQL 场景测试报告如下：</p>
<p>✅add column 场景测试报告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FXYotwQ7QeiJqsikiTEscBXwcn" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/XYotwQ7QeiJqsikiTEscBXwcn" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/XYotwQ…</a><br/>
✅drop column 场景测试报告： <a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FQU73wXqTpirfZmk6NDCc1i" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/QU73wXqTpirfZmk6NDCc1i" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/QU73wX…</a>
1wnDf
✅modify column 场景测试报告： <a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FNXVwwTLf8iWUiFk6nGgcv" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/NXVwwTLf8iWUiFk6nGgcv" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/NXVwwT…</a> GJGnmd
✅change column 场景测试报告： <a href="https://link.juejin.cn?target=https%3A%2F%2Fycn2sw1zdz0c.feishu.cn%2Fwiki%2FUoIvwdUcJiutXSkyvm1ceb" target="_blank" title="https://ycn2sw1zdz0c.feishu.cn/wiki/UoIvwdUcJiutXSkyvm1ceb" ref="nofollow noopener noreferrer">ycn2sw1zdz0c.feishu.cn/wiki/UoIvwd…</a>
LcnUh</p>
<h2 data-id="heading-9">四. 后续工作计划</h2>
<ul>
<li>目前并不是所有支持 schema evolution 的 sink 端均实现了，后续支持SupportSchemaEvolutionSinkWriter 相关子类的实现。</li>
<li>测试不同数据源之间的流转情况，修复可能的小 bug。</li>
<li>测试大量数据情况下是否会出现严重阻塞问题。</li>
<li>测试高并发情况下是否有不一致性问题。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust : Trusted Publishing（受信发布）]]></title>    <link>https://juejin.cn/post/7571379549370417203</link>    <guid>https://juejin.cn/post/7571379549370417203</guid>    <pubDate>2025-11-12T03:35:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379549370417203" data-draft-id="7571395183943712777" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust : Trusted Publishing（受信发布）"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-12T03:35:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust : Trusted Publishing（受信发布）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:35:51.000Z" title="Wed Nov 12 2025 03:35:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F07%2F11%2Fcrates-io-development-update-2025-07%2F" target="_blank" title="https://blog.rust-lang.org/2025/07/11/crates-io-development-update-2025-07/" ref="nofollow noopener noreferrer">原文</a></p>
<p>crates.io：开发进展
2025 年 7 月 11 日 · crates.io 团队</p>
<p>最近 crates.io 做了几件对开发者很实用的更新，核心看这几项：</p>
<ol>
<li>Trusted Publishing（受信发布）：不再在 CI 里存放发布密钥</li>
</ol>
<ul>
<li>
<p>解决的问题：以前用 GitHub Actions 发布到 crates.io，要在仓库里配置长期有效的 API Token（有泄漏风险、也不好轮换）。</p>
</li>
<li>
<p>现在怎么做：在 crates.io 上把你的 GitHub 仓库设为“受信任”。发布时，GitHub Actions 通过 OIDC 临时换取一个短期 token，用完就失效，不用你自己管理长效密钥。</p>
</li>
<li>
<p>现状与前置：目前支持 GitHub Actions；未来可能支持其他 CI（如 GitLab CI）。首次发布仍需要手动，之后可切换为受信发布。</p>
</li>
<li>
<p>上手步骤（简化）：</p>
<ul>
<li>
<p>第一次用 cargo publish 手动发版。</p>
</li>
<li>
<p>在 crates.io 的你的 crate 页面里绑定受信仓库。</p>
</li>
<li>
<p>GitHub Actions 配置：</p>
<ul>
<li>给 workflow 开 id-token: write 权限。</li>
<li>使用 rust-lang/crates-io-auth-action@v1 获取临时 token。</li>
<li>用获取的 token 执行 cargo publish。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcrates.io%2Fdocs%2Ftrusted-publishing" target="_blank" title="https://crates.io/docs/trusted-publishing" ref="nofollow noopener noreferrer">crates.io/docs/truste…</a></p>
</li>
</ul>
<ol start="2">
<li>更“能打”的 OpenGraph 分享图</li>
</ol>
<ul>
<li>
<p>以前：所有 crate 分享出去都是同一张图，信息量低。</p>
</li>
<li>
<p>现在：每个 crate 都有自动生成的专属图片（发布新版本时会重新生成），包含：</p>
<ul>
<li>crate 名称、关键词、描述</li>
<li>默认展示的版本、总发布次数</li>
<li>许可证、crate 体积</li>
</ul>
</li>
<li>
<p>场景：你把 crates.io 链接贴到微信群、Twitter、论坛，预览图会更“信息密集”。</p>
</li>
<li>
<p>技术点：功能独立为 crates_io_og_image（开源），使用 Typst 做排版、oxipng 做压缩；还在给 docs.rs 做主题复用。</p>
</li>
</ul>
<ol start="3">
<li>一键触发 docs.rs 重建</li>
</ol>
<ul>
<li>解决的问题：文档构建失败，或想让旧版本文档享受 docs.rs 新功能，不想专门发一个无意义的小版本。</li>
<li>现在：在 crates.io 的“版本列表”里可以直接点按钮触发该版本的 docs.rs 重建。</li>
</ul>
<ol start="4">
<li>README 支持 GitHub 风格“警示块”</li>
</ol>
<ul>
<li>
<p>现在在 README 里写如下内容，会在 crates.io 上被正确渲染并带样式：</p>
<ul>
<li>
<blockquote>
<p>[!NOTE]</p>
</blockquote>
</li>
<li>
<blockquote>
<p>[!WARNING]</p>
</blockquote>
</li>
<li>
<blockquote>
<p>[!CAUTION]</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7257253692f641b98b064c165cfd6fe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523562&amp;x-signature=ZGH3u35anT8P1BN93ju6Xq5kRsA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>场景：在 README 里加“重要提示/注意/警告”更显眼，省去自定义 HTML/CSS 的麻烦。</li>
</ul>
<ol start="5">
<li>一些“看不见但有感知”的底层优化</li>
</ol>
<ul>
<li>
<p>邮件系统改为模板化（minijinja）：</p>
<ul>
<li>以前用字符串拼接，难维护且风格不统一。</li>
<li>现在改为模板引擎，支持模板继承，后续也更容易支持 HTML 邮件。</li>
</ul>
</li>
<li>
<p>语义化版本（SemVer）排序下推到数据库：</p>
<ul>
<li>以前 API 服务器把所有版本拉出来再排序，版本一多就慢。</li>
<li>现在利用 PostgreSQL 的 JSONB 和 btree 规则在数据库侧排序，API 服务器压力更小，响应更快。</li>
</ul>
</li>
</ul>
<p>该关心哪一项？</p>
<ul>
<li>有持续发布需求、且用 GitHub Actions：优先关注“受信发布”（安全性与易用性大幅提升）。</li>
<li>想让分享更像“产品卡片”：OpenGraph 新图提升链接传播视觉效果。</li>
<li>文档偶尔构建失败或想拿到 docs.rs 新特性：直接在 crates.io 触发重建即可。</li>
<li>README 常写“注意/警告”：用 GitHub 风格警示块更清晰。</li>
<li>维护超多版本的热门 crate：数据库侧 SemVer 排序会让接口更快、更稳。</li>
</ul>
<p>给一个最小可用的受信发布 workflow 模板</p>
<ul>
<li>
<p>前提：在 crates.io 绑定你的 GitHub 仓库；本仓库首发已手动完成一次。</p>
</li>
<li>
<p>workflow 核心要点：</p>
<ul>
<li>触发条件：推送以 v 开头的 tag（比如 v1.2.3）</li>
<li>权限：id-token: write（OIDC 必需）</li>
<li>用 crates-io-auth-action 取临时 token，传给 cargo publish</li>
</ul>
</li>
</ul>
<p>示例（可直接用，按需改 tag 规则）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Publish</span> <span class="hljs-string">to</span> <span class="hljs-string">crates.io</span>  
<span class="hljs-attr">on:</span>  
<span class="hljs-attr">push:</span>  
<span class="hljs-attr">tags:</span> [<span class="hljs-string">'v*'</span>] <span class="hljs-comment"># 推送以 v 开头的 tag 时触发  </span>
<span class="hljs-attr">jobs:</span>  
<span class="hljs-attr">publish:</span>  
<span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>  
<span class="hljs-attr">environment:</span> <span class="hljs-string">release</span> <span class="hljs-comment"># 可选：环境保护  </span>
<span class="hljs-attr">permissions:</span>  
<span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span> <span class="hljs-comment"># OIDC 交换所需  </span>
<span class="hljs-attr">steps:</span>  
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>  
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">rust-lang/crates-io-auth-action@v1</span>  
<span class="hljs-attr">id:</span> <span class="hljs-string">auth</span>  
<span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">cargo</span> <span class="hljs-string">publish</span>  
<span class="hljs-attr">env:</span>  
<span class="hljs-attr">CARGO_REGISTRY_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.auth.outputs.token</span> <span class="hljs-string">}}</span>
</code></pre>
<p>在哪里反馈？</p>
<ul>
<li>有建议或问题，可以到 Zulip 或 GitHub 交流。团队很欢迎反馈。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 抓包工具有哪些，工具矩阵、职责分工与工程化选型建议]]></title>    <link>https://juejin.cn/post/7571348736154435620</link>    <guid>https://juejin.cn/post/7571348736154435620</guid>    <pubDate>2025-11-12T03:36:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736154435620" data-draft-id="7571334572770066475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 抓包工具有哪些，工具矩阵、职责分工与工程化选型建议"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T03:36:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 抓包工具有哪些，工具矩阵、职责分工与工程化选型建议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:36:18.000Z" title="Wed Nov 12 2025 03:36:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在排查 iOS 网络问题时，选对抓包工具能省下大量时间。不同工具各有侧重：有的适合交互式调试（能看到明文、断点修改），有的用于底层证据采集（pcap 分析），还有些工具在代理受限或加密链路复杂时提供替代采集与过滤导出能力。下面按<strong>功能责任</strong>把主流方案拆清，给出选型与实战建议，便于团队在工单里快速决策与交付。</p>
<h2 data-id="heading-0">工具矩阵（按功能划分）</h2>
<ul>
<li><strong>代理式交互调试（HTTP/HTTPS 解密）</strong>
<ul>
<li>Charles / Fiddler / Proxyman / mitmproxy：界面友好或脚本化强，能断点修改、Mock 回包、查看请求/响应体。适合开发联调、前端与后端联动调试。限制是需要在终端信任代理 CA，对于启用了证书 pinning 的应用无效。</li>
</ul>
</li>
<li><strong>底层抓包与协议分析</strong>
<ul>
<li>tcpdump / tshark / Wireshark：在网关或服务器抓取完整 pcap（<code>-s 0</code>），用于定位 TCP 三次握手、重传、TLS 握手细节与 UDP（QUIC）流量。是判断请求是否到达后端的权威方法。</li>
</ul>
</li>
<li><strong>安全与渗透测试</strong>
<ul>
<li>Burp Suite：侧重请求篡改、自动化扫描与插件生态，适合安全团队做深度测试。</li>
</ul>
</li>
<li><strong>脚本化与自动化工具</strong>
<ul>
<li>mitmproxy（脚本插件）、pyshark、scapy：适合把抓包、解析与统计流程脚本化，便于在 CI 或回归测试中自动复现与告警。</li>
</ul>
</li>
<li><strong>替代性采集与按应用/域名过滤导出</strong>
<ul>
<li>当代理不可用、系统信任限制或 QUIC/HTTP3 等边界协议导致抓包难度增大时，需要能按应用或域名精准筛选并导出 pcap 的方案。抓包大师（Sniffmaster）在工程实践中被作为此类场景下的补充工具：它支持无须改动应用即可抓取 iOS 的 TCP/HTTPS 流量、按 App/域名过滤、导出 Wireshark 兼容的 pcap 与单包二进制，并提供拦截器与 JavaScript 脚本用于请求/响应的动态修改。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">选型建议（场景驱动）</h2>
<ol>
<li><strong>本地开发联调（快速复现、断点修改）</strong>：优先 Charles / Proxyman；用代理查看明文请求，临时修改 header 或 body 来验证后端容错。</li>
<li><strong>自动化测试 / 批量统计</strong>：用 mitmproxy + 脚本或 pyshark 自动化提取 TLS Alert、重传统计并纳入回归。</li>
<li><strong>生产问题定位（是否到达后端）</strong>：在网关或源站抓 tcpdump，然后用 Wireshark 做深度分析；这是判断网络/运维问题的首选证据。</li>
<li><strong>代理受限 / 应用信任限制 / QUIC 场景</strong>：当代理抓不到包或无法解密时，使用能按 App/域名导出的方案（如抓包大师 Sniffmaster）把目标流量导出为 pcap，再与服务器端 pcap 做逐帧比对，快速判断流量在何处被阻断或替换。</li>
</ol>
<h2 data-id="heading-2">常见问题与应对模板</h2>
<ul>
<li><strong>现象：浏览器能抓、App 抓不到</strong> → 排查证书 pinning、自定义 TLS 或 App 内部网络实现；短期让开发提供调试构建，或用按 App/域名导出 pcap 做比对定位。</li>
<li><strong>现象：只有某些网络/运营商失败</strong> → 收集受影响的 ASN/地域，抓取该网络下的边缘 pcap，与客户端导出的 pcap 对比证书 Issuer 以判断是否存在透明代理。</li>
<li><strong>现象：HTTP/3（QUIC）流量不可见</strong> → 临时在客户端或服务端强制退回 TCP+HTTP/2 进行抓包验证，或在服务端抓 UDP/443 的流量。</li>
</ul>
<h2 data-id="heading-3">工程化交付清单（每次抓包分析应包含）</h2>
<ol>
<li>复现时间窗（精确到秒）与 request-id / trace-id；2. 抓包位置说明（代理/网关/后端/导出文件）与 pcap 文件（加密存储）；3. Wireshark 关键帧截图（ClientHello / tls.alert / 关键 HTTP header）；4. 分析结论（客户端 / 网络中间件 / 服务端）与可执行修复建议（如补 fullchain、调整 pin 策略、放通 QUIC）。</li>
</ol>
<hr/>
<h2 data-id="heading-4">把抓包能力工程化</h2>
<p>抓包不是单一工具的竞争，而是<strong>工具组合+流程化能力</strong>的竞争。代理工具负责交互式调试，tcpdump/Wireshark 提供权威证据，脚本化工具实现自动化指标和回放，而在代理受限或信任链复杂的边界场景，应引入按应用/域名过滤并导出 pcap 的补充方案（抓包大师 Sniffmaster）以完成端到端的比对分析。</p>
<p>将这些工具与标准化交付模板结合起来，能把“无法复现”的问题变成可验证、可修复的工程任务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 Apifox 中使用「模块」合理地组织接口]]></title>    <link>https://juejin.cn/post/7571352754897600538</link>    <guid>https://juejin.cn/post/7571352754897600538</guid>    <pubDate>2025-11-12T03:39:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754897600538" data-draft-id="7571395183943254025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 Apifox 中使用「模块」合理地组织接口"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-11-12T03:39:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Apifox"/> <meta itemprop="url" content="https://juejin.cn/user/2766843870448222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 Apifox 中使用「模块」合理地组织接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2766843870448222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Apifox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:39:45.000Z" title="Wed Nov 12 2025 03:39:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Apifox 项目中，接口按照「模块 → 目录 → 接口」的层级结构进行管理。</p>
<p>模块对应独立的 OpenAPI 文件，通常按服务或业务进行划分；目录用于在模块内进行功能分类；接口则是具体的 API 定义。理解这种层级化的设计是合理组织接口的基础，下面是一个简单的层级示例图：</p>
<pre><code class="hljs language-Bash" lang="Bash">Apifox 项目
│
├── 模块: 用户服务 (按服务或业务划分)
│   │
│   ├── 目录: 用户认证 (功能分类)
│   │   │
│   │   ├── 接口: POST /login (登录)
│   │   └── 接口: POST /register (注册)
│   │
│   └── 目录: 用户信息
│       │
│       └── 接口: GET /users/{<span class="hljs-built_in">id</span>} (获取用户信息)
│
└── 模块: 订单服务
    │
    ├── 目录: 订单管理
    │   │
    │   ├── 接口: POST /orders (创建订单)
    │   └── 接口: GET /orders/{<span class="hljs-built_in">id</span>} (查询订单详情)
    │
    └── 目录: 支付
        │
        └── 接口: POST /payment/submit (提交支付)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a68a6d8e10ea4cc2b2b037c5c84e74b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=gakOGb4C05oAWmugjqJ5DTCcQ5U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">理解 Apifox 的「模块」</h2>
<p>了解了项目的层级结构之后，我们首先应思考的问题是：<strong>是不是每个项目都要用到模块？又该在哪种情况下拆出新的模块？</strong></p>
<p>当你创建一个新项目时，Apifox 会自动为你创建一个“默认模块”。如果你的项目只包含一个后端服务或接口集合，默认模块通常就足够使用。但如果你需要管理多个不同的 API 服务，就可以为每个服务创建独立的模块。</p>
<p>比如某个项目，后端可能包含用户服务、商品服务、订单服务、物流服务等，每个服务负责不同的业务模块，且往往部署在不同的服务地址上。在 Apifox 中，就推荐为这些服务分别创建模块，相对独立地管理各自的接口。</p>
<p>在项目里点击目录树上方的 <code>+</code> 按钮，即可在下拉菜单中看到「模块」的入口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b34bba263b64e568e7a22eb6e59d944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=CRVFLr4D4aDQnRk08jw3B8JraHc%3D" alt="" loading="lazy"/></p>
<p>创建模块后，它会在左侧项目树中与其他模块并列显示，拥有独立的接口和目录空间，可根据需要添加接口和目录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36cc42b68eeb43ba8310daeb8bcae8af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=RVSJvARbknBx8zfZFX8rldy6b8s%3D" alt="" loading="lazy"/></p>
<p>不同模块之间相对独立，拥有各自的接口、数据模型、组件库和模块变量等，其中“数据模型”可以在模块间互相引用。不同的模块也共享项目级别的配置，如环境变量、数据库连接和公共脚本等。</p>
<p>每个模块对应一份完整的 OpenAPI 规范文件，在导出 OpenAPI Spec 数据时，就可以看到是按“模块”分别导出的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69f2a0b4cd8348f59b834a30ea3a62b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=D2t5mcpyTGlukNtVdyKS%2F38SqmU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">理解模块内的「目录」</h2>
<p>确定模块划分后，下一步就是规划模块内部的结构：接口如何分类、如何设计目录层级，才能让接口更易管理？</p>
<p>每个模块下都有一个默认的根目录，所有接口和子目录都归属于该根目录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c01ffb82427433d9f3051b378a21003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=N3vL7WOvHHBgbTYjpOJEFH8xQmM%3D" alt="" loading="lazy"/></p>
<p>创建新目录时，可以在根目录上新建，也可以在任意现有目录下创建子目录。</p>
<p>目录层级的设计应结合该模块的复杂程度来考虑。如果模块仅包含十几个接口，一层目录通常就足够，直接按功能分类即可；但如果模块较为复杂，一般就需要设计更清晰的多级目录结构。</p>
<p>以“用户服务”模块为例，可以按功能创建用户认证、用户信息、权限管理等一级目录，然后在用户认证目录下直接添加登录、注册、密码重置等接口。</p>
<p>当发现某个目录下的接口数量过多、逻辑上应独立管理时，可以将该目录转换为模块。点击目录右侧的<code>...</code>，在菜单中选择「转换为新模块」即可。这个功能有助于在业务扩展或接口增多时，对项目结构进行更合理的重构。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9553e36ddafa4cb28af5e74745769c17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=5TxUukkBDK8wXvucvs%2Fx%2B77BA0A%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">环境管理与模块的关系</h2>
<p>除了接口的结构化组织，不同模块通常对应不同的服务地址和部署环境，这就需要通过环境管理来统一配置，让接口在不同环境下能顺利调用。</p>
<p>在环境设置中，每个模块的“前置 URL”可单独配置。例如在测试环境中，用户服务模块的前置 URL 可以设置为 <code>http://user-service:8001</code>，订单服务模块则为 <code>http://order-service:8002</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8dc37bbe34142439d4a1edceda5910d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=RvNt6ptQKBbEeKZRttg91Cocu48%3D" alt="" loading="lazy"/></p>
<p>按模块来组织接口的项目，在切换环境时，各模块的服务地址都会随之更新。例如，从开发环境切换到测试环境时，用户服务模块的地址会从 <code>http://localhost:8001</code> 切换到 <code>http://user-service:8001</code>，订单服务模块的地址则会从 <code>http://localhost:8002</code> 切换到 <code>http://order-service:8002</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ccc81ae4d2e4d1a9ac3547ff623afd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=w5T7LFixpCZYhRDLdJPgUv5AXOU%3D" alt="" loading="lazy"/></p>
<p>环境变量可在所有模块中共享，适合存放不同环境的配置项；而模块变量则适用于每个模块独有的配置，如各自的 API Key 或 Token，可在对应模块的接口中引用。</p>
<h2 data-id="heading-3">数据模型的管理与复用</h2>
<p>除了接口和环境的管理，合理规划数据模型同样重要。通过复用数据模型，可以避免重复定义接口参数和响应结构，让接口在模块之间的组织更清晰。</p>
<p>每个模块都有独立的数据模型管理功能，你可以在模块内创建和维护与业务相关的数据结构。这些数据模型不仅能在当前模块中使用，还可以被其他模块引用，从而实现跨模块的数据复用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cdb7d82192848caa8fc1444134527ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=sRRyhSN8EzDV%2BN8VVrD5laT50bc%3D" alt="" loading="lazy"/></p>
<p>例如，用户相关的数据模型可以定义在「用户服务」模块中，订单相关的模型则定义在「订单服务」模块中。当订单模块需要引用用户信息时，只需直接选择「用户服务」模块中的用户数据模型即可，无需重复创建。</p>
<h2 data-id="heading-4">拓展：从 Postman 导入的接口怎么组织？</h2>
<p>如果团队之前使用 Postman 管理接口，也可以将已有接口直接迁移到 Apifox。</p>
<p>在导入时，每个 Postman Collection 会对应一个模块，文件夹结构会映射为目录。接口和数据模型的组织关系在 Apifox 中能够完整保留，这样既可以沿用原有的接口层级和分类，同时也可以继续在 Apifox 中按照模块、目录和数据模型管理接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d100acaf90544f5bccccab15b24d908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763523585&amp;x-signature=kZJQeu7JZyaMr5Phj342XvzcWOc%3D" alt="" loading="lazy"/></p>
<p>通过合理的模块划分、清晰的目录组织、规范的数据模型设计，项目的接口结构会更加清晰，也更便于协作和维护。理解 Apifox 的设计理念，并按照这种层级化的方式组织项目，才能让后续的接口管理更高效、更有条理。</p>
<p>欢迎各位用户对 Apifox 继续提出使用反馈和优化意见，我们会持续优化更新，致力于为用户提供更优秀的产品功能和更极致的使用体验！</p>
<p><strong>有任何问题欢迎在</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fdoc-5751209%23%25E7%2594%25A8%25E6%2588%25B7%25E7%25BE%25A4%2F" target="_blank" title="https://docs.apifox.com/doc-5751209#%E7%94%A8%E6%88%B7%E7%BE%A4/" ref="nofollow noopener noreferrer"> <strong>Apifox 用户群</strong></a><em><em>与我们交流沟通</em>！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain智能体核心组件概述]]></title>    <link>https://juejin.cn/post/7571391088947953702</link>    <guid>https://juejin.cn/post/7571391088947953702</guid>    <pubDate>2025-11-12T03:50:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571391088947953702" data-draft-id="7569946369991344191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain智能体核心组件概述"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-11-12T03:50:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALLINAI"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056639549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain智能体核心组件概述
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056639549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALLINAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:50:17.000Z" title="Wed Nov 12 2025 03:50:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>智能体（Agent）</strong> 是将 <strong>大语言模型（LLM）</strong> 与工具相结合，创建能够 <strong>对任务进行推理、决定使用哪些工具并迭代地寻求解决方案</strong> 的系统。</p>
<p align="left"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9445e64649724f4fbeec6013cbc49218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUxMSU5BSQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763524270&amp;x-signature=DEKXp1%2B6ln9aq89nHFSNh%2FbGC8I%3D" alt="LangChainAgent.png" loading="lazy"/></p>
<p>LLM智能体循环运行各种工具以实现目标。智能体持续运行，直到满足停止条件为止——即模型发出最终输出或达到迭代次数限制。</p>
<hr/>
<h3 data-id="heading-0">1. 模型（Model）</h3>
<p>模型是智能体的 <strong>推理引擎</strong>。它可以通过多种方式进行指定，支持静态和动态选择模型。</p>
<ul>
<li>
<p><strong>静态模型</strong></p>
<p>静态模型在创建智能体时配置一次，并在整个执行过程中保持不变。这是最常见、最直接的方法。</p>
</li>
<li>
<p><strong>动态模型</strong></p>
<p>动态模型的选择是在运行时环境基于当前状态以及上下文信息。这使得复杂的路由逻辑和成本优化成为可能。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 工具（Tools）</h3>
<p>工具赋予智能体执行操作的能力。</p>
<ul>
<li>基于单个提示词的连续调用工具</li>
<li>在适当时并行调用工具</li>
<li>根据先前结果动态选择工具</li>
<li>工具的重试逻辑和错误处理</li>
<li>跨工具调用保持状态持久性</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 系统提示词</h3>
<p>系统提示词是智能体的核心操控杆，通过给智能体提供系统提示词来控制智能体处理任务的方式。可以动态设置系统提示词。</p>
<hr/>
<h3 data-id="heading-3">4. 结构化输出</h3>
<p>在某些情况下，您可能希望智能体以特定格式返回输出。LangChain 通过<code>response_format</code>参数提供了结构化输出的策略。</p>
<hr/>
<h3 data-id="heading-4">5. 记忆</h3>
<p>智能体通过 <strong>消息状态</strong> 自动维护对话历史。存储在状态中的信息可以视为智能体的短期记忆。</p>
<hr/>
<h3 data-id="heading-5">6. 中间件</h3>
<p>中间件给智能体提供了强大的扩展性，可用于在执行的不同阶段自定义智能体的行为。</p>
<ul>
<li>在调用模型之前处理状态（例如，消息修剪、上下文注入）</li>
<li>修改或验证模型的响应（例如，防护措施、内容过滤）</li>
<li>使用自定义逻辑处理工具执行错误</li>
<li>基于状态或上下文实现动态模型选择</li>
<li>添加自定义日志记录、监控或分析功能</li>
</ul>
<p>中间件可以无缝集成到智能体的执行图中，使开发者能够在关键点拦截和修改数据流，而无需更改智能体核心逻辑。</p>
<hr/>
<h3 data-id="heading-6">7. 调用</h3>
<p>可以通过向智能体的状态传递一个更新来调用它。所有智能体的状态中都包含一个消息序列；要调用智能体，只需传递一条新消息。可以进行流式调用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[某东电商平台的MySQL面试知识点分析]]></title>    <link>https://juejin.cn/post/7571409339362918427</link>    <guid>https://juejin.cn/post/7571409339362918427</guid>    <pubDate>2025-11-12T03:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571409339362918427" data-draft-id="7571360278971678729" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="某东电商平台的MySQL面试知识点分析"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-12T03:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="360_go_php"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498956695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            某东电商平台的MySQL面试知识点分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498956695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    360_go_php
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:54:26.000Z" title="Wed Nov 12 2025 03:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在如今互联网电商的业务环境中，数据库作为基础设施扮演着至关重要的角色。特别是对于某东这样的互联网大厂，MySQL作为主要的数据库管理系统，常常是面试过程中的一个重要考察内容。以下文章将基于MySQL的常见面试问题进行详细阐述，为准备MySQL相关职位的面试者提供帮助。</p>
<hr/>
<h4 data-id="heading-0">1. <strong>数据库了解吗，聊一下？</strong></h4>
<p>数据库是用于存储、管理和操作数据的软件系统。常见的数据库系统有关系型数据库（如MySQL、PostgreSQL）和非关系型数据库（如MongoDB、Redis）。关系型数据库遵循结构化查询语言（SQL），数据存储在表格中，并且通过外键等关系连接。MySQL是开源的、支持高并发、事务性强、成本低的关系型数据库，广泛应用于电商平台、社交网络等高流量的场景。</p>
<h4 data-id="heading-1">2. <strong>知道MVCC吗，聊一下</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a54f8d5759e48ecb3a254bd2e3072d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763524466&amp;x-signature=SJ5RyIYGa0vAwlU3pZxAgwERacM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</h4>
<p>MVCC（多版本并发控制）是一种数据库管理并发事务的技术。在MySQL中，MVCC通常与InnoDB存储引擎相关，用于支持高并发的事务管理。其主要原理是：在数据库中为每个数据记录维护多个版本，每个事务看到的是数据的不同版本，确保不同事务不会互相干扰。通过时间戳或事务ID来标识不同版本的记录，达到避免锁的竞争，提高并发度的目的。MVCC的关键优势是读操作不需要加锁，极大提高了并发性能。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fb342c25db4406a81c78344fe5ee845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMzYwX2dvX3BocA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763524466&amp;x-signature=pE8c8T%2BGpVkQZA%2FCRscigK0mB2g%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-2">3. <strong>数据库引擎相关</strong></h4>
<p>在MySQL中，常见的存储引擎有InnoDB、MyISAM、Memory、CSV等。其中最常用的是：</p>
<ul>
<li><strong>InnoDB</strong>：支持ACID事务、行级锁、外键约束，适用于高并发、需要事务管理的场景。</li>
<li><strong>MyISAM</strong>：不支持事务和外键，适用于读取较多的场景，查询性能较好，但不能保证数据一致性。</li>
<li><strong>Memory</strong>：数据存储在内存中，访问速度非常快，适合做缓存数据的存储，但数据会在服务器重启后丢失。</li>
<li><strong>CSV</strong>：每个表存储为CSV文件，适用于轻量级的数据交换。</li>
</ul>
<h4 data-id="heading-3">4. <strong>索引类型</strong></h4>
<p>在MySQL中，常见的索引类型有：</p>
<ul>
<li><strong>BTREE索引</strong>：InnoDB和MyISAM存储引擎默认的索引类型。适用于范围查询（&gt;、&lt;、BETWEEN等）。</li>
<li><strong>HASH索引</strong>：只支持等值查询（=），在Memory存储引擎中使用较多，查询效率高，但不支持范围查询。</li>
<li><strong>FULLTEXT索引</strong>：用于文本数据的全文索引，支持快速的全文搜索。</li>
<li><strong>空间索引</strong>：用于空间数据类型（如GIS数据），支持地理信息系统应用。</li>
</ul>
<h4 data-id="heading-4">5. <strong>乐观锁和悲观锁</strong></h4>
<ul>
<li><strong>乐观锁</strong>：假设不会发生冲突，每次读取数据时不会加锁，而是在更新时进行检查，通常通过版本号或时间戳进行控制。如果检测到版本号不一致，则抛出异常，进行重试。</li>
<li><strong>悲观锁</strong>：假设会发生冲突，在读取数据时就加锁，直到事务完成后才释放锁。悲观锁通常使用行级锁（SELECT FOR UPDATE）或表级锁。</li>
</ul>
<h4 data-id="heading-5">6. <strong>数据库优化</strong></h4>
<p>数据库优化是提高数据库性能的关键手段。主要的优化方法有：</p>
<ul>
<li><strong>查询优化</strong>：使用索引、优化SQL语句、避免全表扫描、合理使用JOIN等。</li>
<li><strong>表结构优化</strong>：规范化数据库表，减少冗余数据，合理设计索引。</li>
<li><strong>缓存优化</strong>：使用缓存技术（如Redis）减少数据库访问压力。</li>
<li><strong>数据库分库分表</strong>：将数据分散到多个数据库或表中，避免单一数据库过载。</li>
</ul>
<h4 data-id="heading-6">7. <strong>索引的最左匹配原则</strong></h4>
<p>在多列索引中，查询时必须遵循最左匹配原则。即查询条件中必须从索引的最左边开始，依次匹配索引的列，才能有效利用复合索引。例如，对于一个索引（A, B, C），查询条件应该至少包含A列，才会利用到该索引。如果查询条件只包含B列或C列，索引将无法被使用。</p>
<h4 data-id="heading-7">8. <strong>事务的隔离级别，MySQL默认是重复读</strong></h4>
<p>MySQL支持四种事务隔离级别：</p>
<ol>
<li><strong>读未提交（Read Uncommitted）</strong>：事务可以读取其他事务未提交的数据，容易产生脏读。</li>
<li><strong>读已提交（Read Committed）</strong>：事务只能读取其他事务已提交的数据，避免脏读，但可能会产生不可重复读。</li>
<li><strong>重复读（Repeatable Read）</strong>：保证事务内读取的数据在整个事务过程中一致，防止不可重复读。MySQL的默认隔离级别。</li>
<li><strong>串行化（Serializable）</strong>：事务以串行方式执行，防止幻读，但性能开销较大。</li>
</ol>
<h4 data-id="heading-8">9. <strong>数据库连接池种类</strong></h4>
<p>常见的数据库连接池有：</p>
<ul>
<li><strong>HikariCP</strong>：轻量级、性能高，广泛用于Spring Boot等框架。</li>
<li><strong>C3P0</strong>：较老的连接池，功能较全，但性能不如HikariCP。</li>
<li><strong>Druid</strong>：阿里巴巴开源的数据库连接池，性能和监控功能优秀，适用于大规模分布式应用。</li>
</ul>
<h4 data-id="heading-9">10. <strong>MySQL的事务</strong></h4>
<p>MySQL的事务遵循ACID特性：</p>
<ul>
<li><strong>原子性</strong>：事务中的所有操作要么全成功，要么全失败。</li>
<li><strong>一致性</strong>：事务执行前后，数据库的状态是有效的。</li>
<li><strong>隔离性</strong>：多个事务并发执行时，彼此隔离，不互相影响。</li>
<li><strong>持久性</strong>：事务一旦提交，数据的变更会永久保存。</li>
</ul>
<h4 data-id="heading-10">11. <strong>MySQL最大连接数有了解过吗</strong></h4>
<p>MySQL的最大连接数默认是151，可以通过修改<code>max_connections</code>参数来调整该值。该参数决定了在任意时刻，MySQL服务器能够接受的最大并发连接数。</p>
<h4 data-id="heading-11">12. <strong>MySQL CPU过高怎么排查</strong></h4>
<p>如果MySQL的CPU使用率过高，可以通过以下方式排查：</p>
<ul>
<li>查看MySQL的<strong>error log</strong>，检查是否有异常。</li>
<li>使用<code>SHOW PROCESSLIST</code>命令查看当前的SQL执行情况，定位是否有长时间运行的查询。</li>
<li>使用<code>EXPLAIN</code>命令分析慢查询，查看是否存在查询优化的空间。</li>
</ul>
<h4 data-id="heading-12">13. <strong>binlog存的什么</strong></h4>
<p>MySQL的<strong>binlog</strong>（二进制日志）记录了所有对数据库进行修改操作的SQL语句或事件，如INSERT、UPDATE、DELETE等。binlog是MySQL进行数据恢复、主从复制的核心机制。</p>
<h4 data-id="heading-13">14. <strong>谈谈EXPLAIN结果中比较关键的指标，以及指标的含义</strong></h4>
<p><code>EXPLAIN</code>命令用于分析SQL语句的执行计划，关键指标包括：</p>
<ul>
<li><strong>id</strong>：查询的标识符，表示查询的顺序。</li>
<li><strong>select_type</strong>：查询的类型，表示是简单查询、联合查询、子查询等。</li>
<li><strong>table</strong>：表示查询操作涉及的表。</li>
<li><strong>type</strong>：连接类型，代表了查询表之间的连接方式。常见的值有<code>ALL</code>（全表扫描）、<code>index</code>（索引扫描）、<code>range</code>（范围扫描）等。</li>
<li><strong>rows</strong>：表示扫描的行数，越小越好。</li>
<li><strong>Extra</strong>：补充信息，表示查询的附加信息，如是否使用了文件排序等。</li>
</ul>
<h4 data-id="heading-14">15. <strong>聚簇索引和非聚簇索引</strong></h4>
<ul>
<li><strong>聚簇索引</strong>：数据存储在索引结构中，数据行和索引叶子节点是一起存储的。InnoDB使用聚簇索引，每个表默认有一个聚簇索引。</li>
<li><strong>非聚簇索引</strong>：数据存储在独立的索引结构中，索引中存储的是指向数据的指针。MyISAM和InnoDB的非主键索引是非聚簇索引。</li>
</ul>
<h4 data-id="heading-15">16. <strong>B树和B+树</strong></h4>
<ul>
<li><strong>B树</strong>：每个节点可以有多个子节点，适用于顺序查找和范围查找，但叶子节点不一定在同一层次。</li>
<li><strong>B+树</strong>：B+树是B树的一种变种，所有数据都存储在叶子节点中，非叶子节点只存储键值，用于提高查询效率。MySQL的InnoDB使用B+树作为索引。</li>
</ul>
<hr/>
<p>通过对以上面试问题的详细解答，面试者可以更好地准备MySQL相关职位的面试，同时为自己提供深入理解Mysql打下坚实的基础</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust : 新版本 1.89.0]]></title>    <link>https://juejin.cn/post/7571391088947986470</link>    <guid>https://juejin.cn/post/7571391088947986470</guid>    <pubDate>2025-11-12T03:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571391088947986470" data-draft-id="7571416207971090482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust : 新版本 1.89.0 "/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-12T03:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust : 新版本 1.89.0 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T03:57:06.000Z" title="Wed Nov 12 2025 03:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/" ref="nofollow noopener noreferrer">原文</a></p>
<p>2025年8月7日 · Rust 发布团队</p>
<p>Rust 团队很高兴地宣布推出 Rust 新版本 1.89.0。Rust 是一种编程语言，它使每个人都能构建可靠高效的软件。</p>
<p>如果您之前通过 apt 安装了 Rust 的旧版本<code>rustup</code>，则可以使用以下命令获取 1.89.0 版本：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>rustup update stable
</code></pre>
<p>如果您还没有，您可以从我们网站上的相应页面<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rust-lang.org%2Finstall.html" target="_blank" title="https://www.rust-lang.org/install.html" ref="nofollow noopener noreferrer">获取<code>rustup</code></a>，并查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Freleases.html%23version-1890-2025-08-07" target="_blank" title="https://doc.rust-lang.org/stable/releases.html#version-1890-2025-08-07" ref="nofollow noopener noreferrer">1.89.0 的详细发行说明</a>。</p>
<p>如果您想帮助我们测试未来的版本，可以考虑在本地更新到 beta 版（<code>rustup default beta</code>）或 nightly 版（<code>rustup default nightly</code>）。请<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/rust-lang/rust/issues/new/choose" ref="nofollow noopener noreferrer">报告</a>您遇到的任何错误！</p>
<h2 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23what-s-in-1-89-0-stable" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#what-s-in-1-89-0-stable" ref="nofollow noopener noreferrer"/>1.89.0 稳定版包含哪些内容？</h2>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23explicitly-inferred-arguments-to-const-generics" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#explicitly-inferred-arguments-to-const-generics" ref="nofollow noopener noreferrer"/>显式推断常量泛型的参数</h3>
<p>Rust 现在支持<code>_</code>将 <code>const</code> 作为泛型参数的参数，并从上下文推断其值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">all_false</span>&lt;<span class="hljs-keyword">const</span> LEN: <span class="hljs-type">usize</span>&gt;() <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">bool</span>; LEN] {
  [<span class="hljs-literal">false</span>; _]
}
</code></pre>
<p><code>_</code>与允许将其作为类型使用的规则类似，<code>_</code>当在签名中时，不允许将其作为常量泛型的参数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// This is not allowed</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">all_false</span>&lt;<span class="hljs-keyword">const</span> LEN: <span class="hljs-type">usize</span>&gt;() <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">bool</span>; _] {
  [<span class="hljs-literal">false</span>; LEN]
}

<span class="hljs-comment">// Neither is this</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> ALL_FALSE: [<span class="hljs-type">bool</span>; _] = all_false::&lt;<span class="hljs-number">10</span>&gt;();
</code></pre>
<ul>
<li>
<p>这是给 const 泛型加的“表达式位置的下划线推断”糖衣语法。</p>
</li>
<li>
<p>之前必须重复写常量（如 LEN），现在在实现体的一些地方可以写“_”，由编译器从类型/上下文推断，减少样板与错误。</p>
</li>
<li>
<p>但在签名等声明处仍必须显式写出常量，保证 API 的清晰性与可读性。</p>
</li>
</ul>
<h3 data-id="heading-2">生命周期语法不匹配 lint、</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2F1.89%2Fbook%2Fch10-03-lifetime-syntax.html%23lifetime-elision" target="_blank" title="https://doc.rust-lang.org/1.89/book/ch10-03-lifetime-syntax.html#lifetime-elision" ref="nofollow noopener noreferrer">函数签名中的生命周期省略</a>是 Rust 语言的一个符合人体工程学的特性，但它也可能成为新手和专家都可能遇到的绊脚石。当类型中生命周期被推断出来，而语法上又不明显表明存在生命周期时，这种情况尤其如此：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// The returned type `std::slice::Iter` has a lifetime, </span>
<span class="hljs-comment">// but there's no visual indication of that.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Lifetime elision infers the lifetime of the return </span>
<span class="hljs-comment">// type to be the same as that of `scores`.</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">items</span>(scores: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> std::slice::Iter&lt;<span class="hljs-type">u8</span>&gt; {
   scores.<span class="hljs-title function_ invoke__">iter</span>()
}
</code></pre>
<p>现在，类似这样的代码默认会产生警告：</p>
<pre><code class="hljs language-rust" lang="rust">warning: hiding a lifetime that<span class="hljs-symbol">'s</span> elided elsewhere is confusing
 -<span class="hljs-punctuation">-&gt;</span> src/lib.rs:<span class="hljs-number">1</span>:<span class="hljs-number">18</span>
  |
<span class="hljs-number">1</span> | <span class="hljs-keyword">fn</span> <span class="hljs-title function_">items</span>(scores: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> std::slice::Iter&lt;<span class="hljs-type">u8</span>&gt; {
  |                  ^^^^^     -------------------- the same lifetime is hidden here
  |                  |
  |                  the lifetime is elided here
  |
  = help: the same lifetime is referred to <span class="hljs-keyword">in</span> inconsistent ways, making the signature confusing
  = note: `<span class="hljs-meta">#[warn(mismatched_lifetime_syntaxes)]</span>` on by default
help: <span class="hljs-keyword">use</span> `<span class="hljs-symbol">'_</span>` <span class="hljs-keyword">for</span> <span class="hljs-title class_">type</span> paths
  |
<span class="hljs-number">1</span> | <span class="hljs-keyword">fn</span> <span class="hljs-title function_">items</span>(scores: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> std::slice::Iter&lt;<span class="hljs-symbol">'_</span>, <span class="hljs-type">u8</span>&gt; {
  |                                             +++
</code></pre>
<p>我们<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F46254" target="_blank" title="https://github.com/rust-lang/rust/pull/46254" ref="nofollow noopener noreferrer">早</a>在 2018 年就尝试改进这种情况，当时我们参与了<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F54910" target="_blank" title="https://github.com/rust-lang/rust/issues/54910" ref="nofollow noopener noreferrer"><code>rust_2018_idioms</code></a>lint 小组的工作，但关于lint<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F131725" target="_blank" title="https://github.com/rust-lang/rust/issues/131725" ref="nofollow noopener noreferrer">强烈反馈</a><code>elided_lifetimes_in_paths</code>表明，这种方法过于简单粗暴，因为它警告的寿命对于理解功能来说并不重要：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fmt;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Greeting</span>;

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">fmt</span>::Display <span class="hljs-keyword">for</span> <span class="hljs-title class_">Greeting</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> fmt::Formatter) <span class="hljs-punctuation">-&gt;</span> fmt::<span class="hljs-type">Result</span> {
        <span class="hljs-comment">//                -----^^^^^^^^^ expected lifetime parameter</span>
        <span class="hljs-comment">// Knowing that `Formatter` has a lifetime does not help the programmer</span>
        <span class="hljs-string">"howdy"</span>.<span class="hljs-title function_ invoke__">fmt</span>(f)
    }
}
</code></pre>
<p>我们随后意识到，我们想要消除的困惑发生在以下两种情况同时发生时：</p>
<ol>
<li>生命周期省略推理规则将输入生命周期与输出生命周期<em>关联起来。</em></li>
<li>从语法角度来看，生命是否存在这一点并不显而易见。</li>
</ol>
<p>Rust 语法中有两种表示生命周期的语法：<code>[i]``&amp;</code>和<code>[i]</code> <code>'</code>，其中<code>[i]``'</code>又细分为推断生命周期<code>'_</code>和命名生命周期<code>'a</code>。当类型使用命名生命周期时，生命周期省略将不会为该类型推断生命周期。基于这些标准，我们可以构建三个组：</p>

























<table><thead><tr><th>不言而喻，它有其生命周期。</th><th>允许省略生命周期以推断生命周期</th><th>示例</th></tr></thead><tbody><tr><td>不</td><td>是的</td><td><code>ContainsLifetime</code></td></tr><tr><td>是的</td><td>是的</td><td><code>&amp;T</code>，，<code>&amp;'_ T</code>​<code>ContainsLifetime&lt;'_&gt;</code></td></tr><tr><td>是的</td><td>不</td><td><code>&amp;'a T</code>，<code>ContainsLifetime&lt;'a&gt;</code></td></tr></tbody></table>
<p>代码检查工具<code>mismatched_lifetime_syntaxes</code>会检查函数的输入和输出是否属于同一组。对于上面最初的示例，<code>a``&amp;[u8]</code>属于第二组，而 <code>b``std::slice::Iter&lt;u8&gt;</code>属于第一组。我们称第一组中的生命周期是<em>隐藏的</em>。</p>
<p>因为输入和输出的生命周期属于不同的组，所以 lint 会对此函数发出警告，从而减少对某个值具有有意义的生命周期（但视觉上并不明显）时的困惑。</p>
<p>lint<code>mismatched_lifetime_syntaxes</code>取代了<code>elided_named_lifetimes</code>lint，后者专门针对命名的生命周期做了类似的事情。</p>
<p>未来对该代码检查工具<code>elided_lifetimes_in_paths</code>（lint）的改进计划是将其拆分为更专注的子代码检查工具，并最终针对其中一部分发出警告。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23more-x86-target-features" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#more-x86-target-features" ref="nofollow noopener noreferrer"/>更多 x86 目标功能</h3>
<p>该<code>target_feature</code>属性现在支持x86 上的<code>sha512``, </code>sm3<code>、`sm4</code>,``kl<code>和目标特性。此外，x86 上还支持</code>widekl<code>一些内部函数和目标特性：</code>avx512`</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[target_feature(enable = <span class="hljs-string">"avx512bw"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">cool_simd_code</span>(<span class="hljs-comment">/* .. */</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-comment">/* ... */</span> {
    <span class="hljs-comment">/* ... */</span>
}
</code></pre>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23cross-compiled-doctests" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#cross-compiled-doctests" ref="nofollow noopener noreferrer"/>交叉编译的文档测试</h3>
<p>现在运行时会测试 doctest <code>cargo test --doc --target other_target</code>，这可能会导致一些故障，因为原本会失败的 doctest 现在也会被测试。</p>
<p>可以通过在 doctest 中添加<code>ignore-&lt;target&gt;</code>( <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustdoc%2Fwrite-documentation%2Fdocumentation-tests.html%23ignoring-targets" target="_blank" title="https://doc.rust-lang.org/stable/rustdoc/write-documentation/documentation-tests.html#ignoring-targets" ref="nofollow noopener noreferrer">docs</a> ) 注解来禁用失败的测试：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment"><span class="hljs-doctag">///</span> ```ignore-x86_64</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> panic!("something")</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> ```</span>
<span class="hljs-function">pub fn <span class="hljs-title">my_function</span>()</span> { }
</code></pre>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23i128-and-u128-in-extern-c-functions" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#i128-and-u128-in-extern-c-functions" ref="nofollow noopener noreferrer"/><code>i128</code>以及<code>u128</code>函数<code>extern "C"</code>​</h3>
<p><code>i128</code>这样<code>u128</code>就不会再触发<code>improper_ctypes_definitions</code>代码检查，这意味着可以在函数中使用这些类型<code>extern "C"</code>而不会收到警告。但这也有一些需要注意的地方：</p>
<ul>
<li>Rust 类型在 ABI 和布局上与<code>__int128</code>C 中的（无符号）类型兼容（当该类型可用时）。</li>
<li>在某些平台上，<code>__int128</code>此功能不可用，<code>i128</code>并且<code>u128</code>不一定与任何 C 类型一致。</li>
<li><code>i128</code>不一定与任何平台上的程序兼容，因为<em>程序</em>和程序可能不具有相同的 ABI（例如在 x86-64 上的情况）。<code>_BitInt(128)``_BitInt(128)``__int128</code></li>
</ul>
<p>这是对去年布局更改的最后一部分后续说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2024%2F03%2F30%2Fi128-layout-update" target="_blank" title="https://blog.rust-lang.org/2024/03/30/i128-layout-update" ref="nofollow noopener noreferrer">https</a> ://blog.rust-lang.org/2024/03/30/i128-layout-update 。</p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23demoting-x86-64-apple-darwin-to-tier-2-with-host-tools" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#demoting-x86-64-apple-darwin-to-tier-2-with-host-tools" ref="nofollow noopener noreferrer"/>使用主机工具降级<code>x86_64-apple-darwin</code>到二级</h3>
<p>GitHub 即将<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fchangelog%2F2025-07-11-upcoming-changes-to-macos-hosted-runners-macos-latest-migration-and-xcode-support-policy-updates%2F%23macos-13-is-closing-down" target="_blank" title="https://github.blog/changelog/2025-07-11-upcoming-changes-to-macos-hosted-runners-macos-latest-migration-and-xcode-support-policy-updates/#macos-13-is-closing-down" ref="nofollow noopener noreferrer">停止</a>为公共代码库提供免费的 macOS x86_64 运行器。苹果公司也已宣布<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FMac_transition_to_Apple_silicon%23Timeline" target="_blank" title="https://en.wikipedia.org/wiki/Mac_transition_to_Apple_silicon#Timeline" ref="nofollow noopener noreferrer">计划</a>停止对 x86_64 架构的支持。</p>
<p>根据这些变更，Rust 项目正在将<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frfcs%2Fpull%2F3841" target="_blank" title="https://github.com/rust-lang/rfcs/pull/3841" ref="nofollow noopener noreferrer">目标平台</a>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-1-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-1-with-host-tools" ref="nofollow noopener noreferrer">包含宿主工具的 Tier 1</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frfcs%2Fpull%2F3841" target="_blank" title="https://github.com/rust-lang/rfcs/pull/3841" ref="nofollow noopener noreferrer">降级<code>x86_64-apple-darwin</code></a>为<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-2-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-2-with-host-tools" ref="nofollow noopener noreferrer">包含宿主工具的 Tier 2。</a>这意味着包含诸如和 等工具的目标平台将保证能够构建，但不能保证能够通过我们的自动化测试套件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-1-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-1-with-host-tools" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Frustc%2Fplatform-support.html%23tier-2-with-host-tools" target="_blank" title="https://doc.rust-lang.org/stable/rustc/platform-support.html#tier-2-with-host-tools" ref="nofollow noopener noreferrer"/><code>rustc``cargo</code></p>
<p>我们预计，将主机工具降级到 Tier 2 的 RFC 将在 Rust 1.89 和 1.90 版本之间被接受，这意味着 Rust 1.89 将是最后<code>x86_64-apple-darwin</code>一个 Tier 1 目标的 Rust 版本。</p>
<p>对于用户而言，此变更不会立即产生影响。<code>rustup</code>在目标平台仍处于 Tier 2 级别期间，Rust 项目仍将分发标准库和编译器的构建版本，供用户通过其他安装方式使用。随着时间的推移，该目标平台的测试覆盖率降低可能会导致一些问题或兼容性下降，届时将不会另行通知。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23standards-compliant-c-abi-on-the-wasm32-unknown-unknown-target" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#standards-compliant-c-abi-on-the-wasm32-unknown-unknown-target" ref="nofollow noopener noreferrer"/>符合标准的 C ABI<code>wasm32-unknown-unknown</code>目标</h3>
<p><code>extern "C"</code>目标平台上的函数<code>wasm32-unknown-unknown</code>现在具有符合标准的 ABI。有关更多信息，请参阅此博客文章： https: <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F04%2F04%2Fc-abi-changes-for-wasm32-unknown-unknown" target="_blank" title="https://blog.rust-lang.org/2025/04/04/c-abi-changes-for-wasm32-unknown-unknown" ref="nofollow noopener noreferrer">//blog.rust-lang.org/2025/04/04/c-abi-changes-for-wasm32-unknown-unknown</a>。</p>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23platform-support" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#platform-support" ref="nofollow noopener noreferrer"/>平台支持</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frfcs%2Fpull%2F3841" target="_blank" title="https://github.com/rust-lang/rfcs/pull/3841" ref="nofollow noopener noreferrer"><code>x86_64-apple-darwin</code>正在被降级为二级主机工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F142053" target="_blank" title="https://github.com/rust-lang/rust/pull/142053" ref="nofollow noopener noreferrer">新增三级<code>loongarch32-unknown-none</code>目标<code>loongarch32-unknown-none-softfloat</code></a></li>
</ul>
<p>有关 Rust 分级平台支持的更多信息，请参阅 Rust 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Frustc%2Fplatform-support.html" target="_blank" title="https://doc.rust-lang.org/rustc/platform-support.html" ref="nofollow noopener noreferrer">平台支持页面。</a></p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23stabilized-apis" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#stabilized-apis" ref="nofollow noopener noreferrer"/>稳定的API</h3>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fnum%2Fstruct.NonZero.html" target="_blank" title="https://doc.rust-lang.org/stable/std/num/struct.NonZero.html" ref="nofollow noopener noreferrer"><code>NonZero&lt;char&gt;</code></a></p>
</li>
<li>
<p>这里未列举许多 x86 的内部函数。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F111137" target="_blank" title="https://github.com/rust-lang/rust/issues/111137" ref="nofollow noopener noreferrer">AVX512固有频率</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F126624" target="_blank" title="https://github.com/rust-lang/rust/issues/126624" ref="nofollow noopener noreferrer"><code>SHA512</code>以及<code>SM3</code>内在<code>SM4</code>属性</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.lock" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.lock" ref="nofollow noopener noreferrer"><code>File::lock</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.lock_shared" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.lock_shared" ref="nofollow noopener noreferrer"><code>File::lock_shared</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.try_lock" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.try_lock" ref="nofollow noopener noreferrer"><code>File::try_lock</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.try_lock_shared" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.try_lock_shared" ref="nofollow noopener noreferrer"><code>File::try_lock_shared</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Ffs%2Fstruct.File.html%23method.unlock" target="_blank" title="https://doc.rust-lang.org/stable/std/fs/struct.File.html#method.unlock" ref="nofollow noopener noreferrer"><code>File::unlock</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.from_ref" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.from_ref" ref="nofollow noopener noreferrer"><code>NonNull::from_ref</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.from_mut" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.from_mut" ref="nofollow noopener noreferrer"><code>NonNull::from_mut</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.without_provenance" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.without_provenance" ref="nofollow noopener noreferrer"><code>NonNull::without_provenance</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.with_exposed_provenance" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.with_exposed_provenance" ref="nofollow noopener noreferrer"><code>NonNull::with_exposed_provenance</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fptr%2Fstruct.NonNull.html%23method.expose_provenance" target="_blank" title="https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.expose_provenance" ref="nofollow noopener noreferrer"><code>NonNull::expose_provenance</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fffi%2Fstruct.OsString.html%23method.leak" target="_blank" title="https://doc.rust-lang.org/stable/std/ffi/struct.OsString.html#method.leak" ref="nofollow noopener noreferrer"><code>OsString::leak</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fpath%2Fstruct.PathBuf.html%23method.leak" target="_blank" title="https://doc.rust-lang.org/stable/std/path/struct.PathBuf.html#method.leak" ref="nofollow noopener noreferrer"><code>PathBuf::leak</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fresult%2Fenum.Result.html%23method.flatten" target="_blank" title="https://doc.rust-lang.org/stable/std/result/enum.Result.html#method.flatten" ref="nofollow noopener noreferrer"><code>Result::flatten</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fos%2Flinux%2Fnet%2Ftrait.TcpStreamExt.html%23tymethod.quickack" target="_blank" title="https://doc.rust-lang.org/stable/std/os/linux/net/trait.TcpStreamExt.html#tymethod.quickack" ref="nofollow noopener noreferrer"><code>std::os::linux::net::TcpStreamExt::quickack</code></a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fos%2Flinux%2Fnet%2Ftrait.TcpStreamExt.html%23tymethod.set_quickack" target="_blank" title="https://doc.rust-lang.org/stable/std/os/linux/net/trait.TcpStreamExt.html#tymethod.set_quickack" ref="nofollow noopener noreferrer"><code>std::os::linux::net::TcpStreamExt::set_quickack</code></a></p>
</li>
</ul>
<p>这些先前稳定的 API 现在在 const 上下文中也保持稳定：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fprimitive.array.html%23method.as_mut_slice" target="_blank" title="https://doc.rust-lang.org/stable/std/primitive.array.html#method.as_mut_slice" ref="nofollow noopener noreferrer"><code>&lt;[T; N]&gt;::as_mut_slice</code></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fprimitive.slice.html%23impl-%255Bu8%255D%2Fmethod.eq_ignore_ascii_case" target="_blank" title="https://doc.rust-lang.org/stable/std/primitive.slice.html#impl-%5Bu8%5D/method.eq_ignore_ascii_case" ref="nofollow noopener noreferrer"><code>&lt;[u8]&gt;::eq_ignore_ascii_case</code></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstable%2Fstd%2Fprimitive.str.html%23impl-str%2Fmethod.eq_ignore_ascii_case" target="_blank" title="https://doc.rust-lang.org/stable/std/primitive.str.html#impl-str/method.eq_ignore_ascii_case" ref="nofollow noopener noreferrer"><code>str::eq_ignore_ascii_case</code></a></li>
</ul>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23other-changes" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#other-changes" ref="nofollow noopener noreferrer"/>其他变化</h3>
<p>来看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Freleases%2Ftag%2F1.89.0" target="_blank" title="https://github.com/rust-lang/rust/releases/tag/1.89.0" ref="nofollow noopener noreferrer">Rust</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fnightly%2Fcargo%2FCHANGELOG.html%23cargo-189-2025-08-07" target="_blank" title="https://doc.rust-lang.org/nightly/cargo/CHANGELOG.html#cargo-189-2025-08-07" ref="nofollow noopener noreferrer">Cargo</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust-clippy%2Fblob%2Fmaster%2FCHANGELOG.md%23rust-189" target="_blank" title="https://github.com/rust-lang/rust-clippy/blob/master/CHANGELOG.md#rust-189" ref="nofollow noopener noreferrer">Clippy</a>中发生了哪些变化。</p>
<h2 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F08%2F07%2FRust-1.89.0%2F%23contributors-to-1-89-0" target="_blank" title="https://blog.rust-lang.org/2025/08/07/Rust-1.89.0/#contributors-to-1-89-0" ref="nofollow noopener noreferrer"/>1.89.0 版本的贡献者</h2>
<p>Rust 1.89.0 的开发离不开许多人的共同努力。没有你们，我们不可能完成这项工作。<a href="https://link.juejin.cn?target=https%3A%2F%2Fthanks.rust-lang.org%2Frust%2F1.89.0%2F" target="_blank" title="https://thanks.rust-lang.org/rust/1.89.0/" ref="nofollow noopener noreferrer">谢谢！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重温 Java 21 之禁用代理的动态加载]]></title>    <link>https://juejin.cn/post/7571299394346205226</link>    <guid>https://juejin.cn/post/7571299394346205226</guid>    <pubDate>2025-11-12T00:44:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394346205226" data-draft-id="7571334572768854059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重温 Java 21 之禁用代理的动态加载"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T00:44:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重温 Java 21 之禁用代理的动态加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:44:17.000Z" title="Wed Nov 12 2025 00:44:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java Agent 通常被直译为 Java 代理，它是一个 jar 包，这个 jar 包很特别，不能独立运行，而是要依附到我们的目标 JVM 进程中。它利用 JVM 提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F21%2Fdocs%2Fapi%2Fjava.instrument%2Fjava%2Flang%2Finstrument%2FInstrumentation.html" target="_blank" title="https://docs.oracle.com/en/java/javase/21/docs/api/java.instrument/java/lang/instrument/Instrumentation.html" ref="nofollow noopener noreferrer">Instrumentation API</a> 来修改已加载到 JVM 中的字节码，从而实现很多高级功能，比如：</p>
<ul>
<li>Eclipse、IntelliJ 等 IDE 的调试功能；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jrebel.com%2Fproducts%2Fjrebel" target="_blank" title="https://www.jrebel.com/products/jrebel" ref="nofollow noopener noreferrer">JRebel</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-loaded" target="_blank" title="https://github.com/spring-projects/spring-loaded" ref="nofollow noopener noreferrer">spring-loaded</a> 等工具的热加载功能；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2F" target="_blank" title="https://arthas.aliyun.com/" ref="nofollow noopener noreferrer">Arthas</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbtraceio%2Fbtrace" target="_blank" title="https://github.com/btraceio/btrace" ref="nofollow noopener noreferrer">Btrace</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foldmanpushcart%2Fgreys-anatomy" target="_blank" title="https://github.com/oldmanpushcart/greys-anatomy" ref="nofollow noopener noreferrer">Greys</a> 等工具的线上诊断功能；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvisualvm.github.io%2F" target="_blank" title="https://visualvm.github.io/" ref="nofollow noopener noreferrer">Visual VM</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenjdk.org%2Ftools%2Fsvc%2Fjconsole%2F" target="_blank" title="https://openjdk.org/tools/svc/jconsole/" ref="nofollow noopener noreferrer">JConsole</a> 等工具的性能分析功能；</li>
<li>此外，<a href="https://link.juejin.cn?target=https%3A%2F%2Fskywalking.apache.org%2F" target="_blank" title="https://skywalking.apache.org/" ref="nofollow noopener noreferrer">SkyWalking</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpinpoint-apm%2Fpinpoint" target="_blank" title="https://github.com/pinpoint-apm/pinpoint" ref="nofollow noopener noreferrer">Pinpoint</a> 等 APM 系统也是基于 Java Agent 实现的；</li>
</ul>
<h2 data-id="heading-0">Java Agent 简单示例</h2>
<p>为了对 Java Agent 的概念有一个更直观的认识，我们从一个简单的示例入手，从零开始实现一个 Java Agent。先创建如下目录结构：</p>
<pre><code class="hljs language-css" lang="css">├── pom<span class="hljs-selector-class">.xml</span>
└── <span class="hljs-attribute">src</span>
  └── <span class="hljs-selector-tag">main</span>
    ├── java
    │   └── com
    │     └── example
    │       └── AgentDemo<span class="hljs-selector-class">.java</span>
    └── resources
      └── META-INF
        └── MANIFEST<span class="hljs-selector-class">.MF</span>
</code></pre>
<p>包含三个主要文件：</p>
<ul>
<li><code>pom.xml</code> - Maven 项目的配置文件</li>
<li><code>AgentDemo.java</code> - Java Agent 的入口类</li>
<li><code>MANIFEST.MF</code> - 元数据文件，用于描述打包的 JAR 文件中的各种属性和信息</li>
</ul>
<p>Java Agent 的入口类定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example;

<span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentDemo</span> {

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> {
    System.out.println(<span class="hljs-string">"premain"</span>);
  }
}
</code></pre>
<p>我们知道，常规 Java 程序的入口方法是 <code>main</code> 函数，而 Java Agent 的入口方法是 <code>premain</code> 函数。其中，<code>String agentArgs</code> 是传递给 Agent 的参数，比如当我们运行 <code>java -javaagent:agent-demo.jar=some-args app.jar</code> 命名时，参数 <code>agentArgs</code> 的值就是字符串 <code>some-args</code>；另一个参数 <code>Instrumentation inst</code> 是 JVM 提供的修改字节码的接口，我们可以通过这个接口定位到希望修改的类并做出修改。</p>
<p><strong>Instrumentation API</strong> 是 Java Agent 的核心，它可以在加载 class 文件之前做拦截，对字节码做修改（<code>addTransformer</code>），也可以在运行时对已经加载的类的字节码做变更（<code>retransformClasses</code> 或 <code>redefineClasses</code>）；Instrumentation 的英文释义是插桩或植入，所以这个操作又被称为 <strong>字节码插桩</strong>，由于这个操作非常的底层，一般会配合一些字节码修改的库，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fasm.ow2.io%2F" target="_blank" title="https://asm.ow2.io/" ref="nofollow noopener noreferrer">ASM</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javassist.org%2F" target="_blank" title="https://www.javassist.org/" ref="nofollow noopener noreferrer">Javassist</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytebuddy.net%2F" target="_blank" title="https://bytebuddy.net/" ref="nofollow noopener noreferrer">Byte Buddy</a> 等。关于 Instrumentation API 是一个较为艰深复杂的话题，本文为简单起见，没有深入展开，感兴趣的同学可以自行查找相关资料。</p>
<p>有了 Java Agent 的入口类之后，我们还需要告诉 JVM 这个入口类的位置，可以在 <code>MANIFEST.MF</code> 元数据文件中通过 <code>Premain-Class</code> 参数来描述：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Premain-Class: com.example.AgentDemo</span>
</code></pre>
<p>打包的时候，要注意将 <code>MANIFEST.MF</code> 文件一起打到 jar 包里，这可以通过打包插件 <code>maven-assembly-plugin</code> 来实现：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRefs</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRef</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRefs</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">manifestFile</span>&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span class="hljs-tag">&lt;/<span class="hljs-name">manifestFile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>single<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<p>最后，执行 <code>mvn clean package</code> 打包命令，生成 <code>target/agent-demo-1.0-SNAPSHOT-jar-with-dependencies.jar</code> 文件，我们就得到了一个最简单的 Java Agent 了。</p>
<h2 data-id="heading-1">Java Agent 的两种加载方式</h2>
<p>Java Agent 最常见的使用方式是在运行 <code>java</code> 命令时通过 <code>-javaagent</code> 参数指定要加载的 Agent 文件：</p>
<pre><code class="hljs language-csharp" lang="csharp">$ java -javaagent:agent-demo<span class="hljs-number">-1.0</span>-SNAPSHOT-jar-<span class="hljs-keyword">with</span>-dependencies.jar Hello.java
</code></pre>
<p>这种方式被称为 <strong>静态加载（static loading）</strong>。在这种情况下，Java Agent 和应用程序一起启动，并在运行主程序的 <code>main</code> 方法之前先调用 Java Agent 的 <code>premain</code> 方法，下面是程序的运行结果：</p>
<pre><code class="hljs">premain
Hello
</code></pre>
<p>既然有静态加载，自然就有动态加载。<strong>动态加载（dynamic loading）</strong> 指的是将 Java Agent 动态地加载到已运行的 JVM 进程中，当我们不希望中断生产环境中已经运行的应用程序时，这个特性非常有用。</p>
<p>我们先正常启动一个 Java 应用程序：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>java <span class="hljs-title class_">Hello</span>.java
<span class="hljs-title class_">Hello</span>
</code></pre>
<p>通过 <code>jps</code> 得到该程序的 PID，然后使用 Java 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F21%2Fdocs%2Fapi%2Fjdk.attach%2Fcom%2Fsun%2Ftools%2Fattach%2FVirtualMachine.html" target="_blank" title="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.attach/com/sun/tools/attach/VirtualMachine.html" ref="nofollow noopener noreferrer">Attach API</a> <strong>附加（attach）</strong> 到该程序上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">pidOfOtherJVM</span> <span class="hljs-operator">=</span> <span class="hljs-string">"3378"</span>;
<span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(pidOfOtherJVM);
</code></pre>
<p>附加成功后得到 <code>VirtualMachine</code> 实例，<code>VirtualMachine</code> 提供了一个 <code>loadAgent()</code> 方法用于动态加载 Java Agent：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">File</span> <span class="hljs-variable">agentJar</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"/com.docker.devenvironments.code/agent-demo-1.0-SNAPSHOT-jar-with-dependencies.jar"</span>);
vm.loadAgent(agentJar.getAbsolutePath());

<span class="hljs-comment">// do other works</span>

vm.detach();
</code></pre>
<p>查看应用程序的日志，可以发现如下报错：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Failed <span class="hljs-keyword">to</span> find Agent-<span class="hljs-keyword">Class</span> manifest attribute <span class="hljs-keyword">from</span> /com.docker.devenvironments.code/agent-demo.jar
</code></pre>
<p>这是因为目前我们这个 Java Agent 还不支持动态加载，动态加载的入口并不是 <code>premain</code> 函数，而是 <code>agentmain</code> 函数，我们在 <code>AgentDemo</code> 类中新增代码如下：</p>
<pre><code class="hljs language-java" lang="java">...
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> {
    System.out.println(<span class="hljs-string">"agentmain"</span>);
  }
...
</code></pre>
<p>并在 <code>MANIFEST.MF</code> 文件中新增 <code>Agent-Class</code> 参数：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Agent-Class: com.example.AgentDemo</span>
</code></pre>
<p>重新打包，并再次动态加载，可以在应用程序中看到日志如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">WARNING:</span> A Java agent has been loaded dynamically (/com.docker.devenvironments.code/agent-demo-<span class="hljs-number">1.0</span>-SNAPSHOT-jar-<span class="hljs-keyword">with</span>-dependencies.jar)
<span class="hljs-symbol">WARNING:</span> <span class="hljs-keyword">If</span> a serviceability tool <span class="hljs-built_in">is</span> <span class="hljs-keyword">in</span> use, please run <span class="hljs-keyword">with</span> -XX:+EnableDynamicAgentLoading <span class="hljs-keyword">to</span> hide this warning
<span class="hljs-symbol">WARNING:</span> <span class="hljs-keyword">If</span> a serviceability tool <span class="hljs-built_in">is</span> <span class="hljs-built_in">not</span> <span class="hljs-keyword">in</span> use, please run <span class="hljs-keyword">with</span> -Djdk.instrument.traceUsage <span class="hljs-keyword">for</span> more information
<span class="hljs-symbol">WARNING:</span> Dynamic loading <span class="hljs-keyword">of</span> agents will be disallowed <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">in</span> a future release
agentmain
</code></pre>
<p>可以看到 <code>agentmain</code> 函数被成功执行，动态加载生效了。</p>
<h2 data-id="heading-2">禁用 Java Agent 的动态加载</h2>
<p>在上面的应用程序日志中，我们可以看到几行 WARNING 提示，这其实就是 Java 21 引入的新内容了，当 JVM 检测到有 Java Agent 被动态加载，就会打印这几行警告信息，告知用户动态加载机制将在未来的版本中默认禁用。如果不想看到这样的日志，可以在启动应用程序时加上 <code>-XX:+EnableDynamicAgentLoading</code> 选项：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>java -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+EnableDynamicAgentLoading</span> <span class="hljs-title class_">Hello</span>.java
</code></pre>
<p>那么 Java 21 为什么要禁用 Java Agent 的动态加载呢？这就要提到 Java 所追求的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenjdk.org%2Fjeps%2F8305968" target="_blank" title="https://openjdk.org/jeps/8305968" ref="nofollow noopener noreferrer">Integrity by Default</a> 原则了。Integrity 一般被翻译为 <strong>完整性</strong>，片面的理解就是要保证我们程序中的任何内容，包括数据或代码都是完整的、没有被篡改的。而 Instrumentation API 通过修改已加载到 JVM 中的字节码来改变现有应用程序，在不更改源代码的情况下改变应用程序的行为。当我们静态加载 Java Agent 时，这并不是什么大问题，因为这是用户明确且有意的使用；然而，动态加载则是间接的，它超出了用户的控制范围，可能对用户的应用程序造成严重破坏，很显然并不符合完整性原则。</p>
<p>因此，作为应用程序的所有者，必须有意识地、明确地决定允许和加载哪些 Java Agent：要么使用静态加载，要么通过 <code>-XX:+EnableDynamicAgentLoading</code> 选项允许动态加载。</p>
<h2 data-id="heading-3">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WeaveFox 深度体验：AI 时代的全栈开发神器，让创意秒变现实]]></title>    <link>https://juejin.cn/post/7571348736153157668</link>    <guid>https://juejin.cn/post/7571348736153157668</guid>    <pubDate>2025-11-12T00:44:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571348736153157668" data-draft-id="7571334572768870443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WeaveFox 深度体验：AI 时代的全栈开发神器，让创意秒变现实"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-11-12T00:44:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WeaveFox 深度体验：AI 时代的全栈开发神器，让创意秒变现实
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:44:21.000Z" title="Wed Nov 12 2025 00:44:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：告别技术门槛，拥抱创意自由</h2>
<p>你是否曾有过这样的经历：脑海中闪现一个绝妙的 App 想法，却因为不懂后端、数据库而只能望洋兴叹？或者看到一张精美的设计稿，想要快速实现却被复杂的前端代码拦住去路？</p>
<p>作为一名长期关注 AI 开发工具的体验者，我最近深度试用了 WeaveFox 这款 AI 全栈开发平台。经过一段时间的实际使用，我可以毫不夸张地说：<strong>WeaveFox 正在重新定义"从想法到产品"的距离</strong>。</p>
<h2 data-id="heading-1">🎯 核心亮点：三大突破性能力</h2>
<h3 data-id="heading-2">1. 图片转代码：行业最准的 1:1 还原</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e7e2b7b66224aae86a18c98acbe8c80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=RdYUihv%2FnTkMPQcP6%2BdtOxPqqbY%3D" alt="image.png" loading="lazy"/></p>
<p>在众多 AI 代码生成工具中，WeaveFox 的图片转代码能力可以说是独树一帜。我专门做了一个对比测试：</p>
<p><strong>测试场景</strong>：上传一张包含复杂布局的设计稿</p>
<p><strong>WeaveFox 表现</strong>：</p>
<ul>
<li>✅ <strong>布局精准度</strong>：几乎 100% 还原设计稿布局</li>
<li>✅ <strong>样式细节</strong>：圆角半径、阴影效果、颜色值都高度一致</li>
<li>✅ <strong>响应式适配</strong>：自动生成适配不同屏幕的代码</li>
<li>✅ <strong>代码质量</strong>：生成的 HTML/CSS 结构清晰，易于维护</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c086af4c4499485a9527bea80a0e3884~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=LDgxT4X1sSpTT5MXKXk64eSnHBs%3D" alt="image.png" loading="lazy"/></p>
<p>相比其他同类工具，WeaveFox 在细节还原度上明显领先。特别是对于复杂的 UI 组件，其他工具往往只能生成大致框架，而 WeaveFox 能够精确到像素级别的还原。</p>
<h3 data-id="heading-3">2. 全栈开发：打破"仅能做前端"的局限</h3>
<p>这是 WeaveFox 最让我惊喜的地方。传统的 AI 代码工具大多只能生成前端页面，而 WeaveFox 实现了真正的<strong>全栈一体化开发</strong>。</p>
<p><strong>实战案例：制作一个"健身打卡记录"应用</strong></p>
<p>我用一句话描述需求：<em>"做一个个人健身记录应用，用户可以添加每日运动记录，包括运动类型、时长、消耗卡路里，支持数据统计和进度可视化。"</em></p>
<p><strong>WeaveFox 的完整交付</strong>：</p>
<h4 data-id="heading-4">🗄️ 数据库层</h4>
<ul>
<li>自动创建用户表和运动记录表</li>
<li>包含运动类型、时长、卡路里、日期等字段</li>
<li>建立合理的表关联关系，无需手写 SQL</li>
</ul>
<h4 data-id="heading-5">⚙️ 后端服务</h4>
<ul>
<li>自动生成完整的 API 接口</li>
<li>实现运动记录的增删改查功能</li>
<li>包含数据统计计算（周/月运动总时长、卡路里消耗等）</li>
<li>自动处理数据验证和异常情况</li>
</ul>
<h4 data-id="heading-6">🎨 前端界面</h4>
<ul>
<li>简洁的运动记录添加表单</li>
<li>直观的数据统计图表展示</li>
<li>个人运动历史记录列表</li>
<li>响应式设计适配移动端</li>
</ul>
<h4 data-id="heading-7">🚀 一键部署</h4>
<ul>
<li>自动打包构建</li>
<li>免运维托管</li>
<li>立即获得可分享的访问链接</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0afec5164f6e4c4683a48b31e297c09e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=nFLsOxhOz0Yms7kvzLTsjqUAKLM%3D" alt="0350b87f32c2772852bd600e60eb0525.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abb20225309443888febc0e6e811b00a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=x%2FlhaktEC6Jh44kNTRFxvp94hrQ%3D" alt="b1e738a28d5f7ce1a5f8f1231bc2cffb.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c4a6dd4f1db49cdb6e118859f1ffb12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=kRrkZEbIOFIZKFl3leW7lcbaSeg%3D" alt="" loading="lazy"/></p>
<p>整个过程不到 10 分钟，从想法到可用的产品，这种效率是传统开发方式无法想象的。</p>
<h3 data-id="heading-8">3. 持续迭代：指哪打哪的精准优化</h3>
<p>更令人印象深刻的是，WeaveFox 支持通过自然语言进行持续优化：</p>
<ul>
<li>🔄 <strong>局部修改</strong>："完善运动目标设置功能，用户可以设定每月每周运动时长目标" → 自动增加目标管理模块</li>
<li>🎨 <strong>样式调整</strong>："图表颜色改为健康绿色主题，增加运动激励感" → 立即更新视觉风格</li>
<li>⚡ <strong>功能增强</strong>："支持运动类型自定义，用户可以添加新的运动项目" → 自动完成扩展逻辑</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f14a8421c1d48caadfa4d0ef934599c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=DnYqAIxHNEGsfXk%2FbR2L3Wdmaak%3D" alt="a06c0b2bcd5a4c11fecf9d46aac20786.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7cc5701351340b39459296f11e26075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513061&amp;x-signature=4yZvUTfVQZ%2BOLLsLZ0ouylz6Onw%3D" alt="image.png" loading="lazy"/></p>
<p>这种"对话式开发"的体验，让产品迭代变得前所未有的简单。</p>
<h2 data-id="heading-9">🏆 实际应用价值：解决真实痛点</h2>
<h3 data-id="heading-10">对个人开发者</h3>
<ul>
<li><strong>降低技术门槛</strong>：无需掌握复杂的后端技术栈</li>
<li><strong>提升开发效率</strong>：从几周缩短到几分钟</li>
<li><strong>专注创意本身</strong>：把时间花在产品设计而非技术实现</li>
</ul>
<h3 data-id="heading-11">对小团队/初创公司</h3>
<ul>
<li><strong>快速验证想法</strong>：低成本制作 MVP 产品</li>
<li><strong>节省人力成本</strong>：一个人完成全栈开发工作</li>
<li><strong>加速产品迭代</strong>：快速响应用户反馈</li>
</ul>
<h3 data-id="heading-12">对设计师</h3>
<ul>
<li><strong>设计稿直接变产品</strong>：无需等待开发排期</li>
<li><strong>交互效果实时预览</strong>：设计想法立即可视化</li>
<li><strong>与开发无缝协作</strong>：减少沟通成本</li>
</ul>
<h2 data-id="heading-13">💡 使用建议与最佳实践</h2>
<p>基于我的使用经验，分享几个实用建议：</p>
<h3 data-id="heading-14">1. 需求描述要具体</h3>
<ul>
<li>❌ 模糊："做一个健身应用"</li>
<li>✅ 具体："做一个个人健身记录应用，支持添加运动记录、卡路里统计、进度图表展示和目标设定"</li>
</ul>
<h3 data-id="heading-15">2. 善用迭代优化</h3>
<ul>
<li>先生成基础版本</li>
<li>通过对话逐步完善功能</li>
<li>重点关注用户体验细节</li>
</ul>
<h3 data-id="heading-16">3. 充分利用全栈能力</h3>
<ul>
<li>不要局限于前端页面</li>
<li>考虑数据存储和业务逻辑</li>
<li>规划完整的用户流程</li>
</ul>
<h2 data-id="heading-17">🚀 总结：AI 时代的开发新范式</h2>
<p>经过深度体验，我认为 WeaveFox 代表了 AI 辅助开发的一个重要里程碑。它不仅仅是一个代码生成工具，更是一个<strong>创意实现平台</strong>。</p>
<p><strong>核心优势</strong>：</p>
<ul>
<li>🎯 <strong>精准度领先</strong>：图片转代码行业最准</li>
<li>🔧 <strong>能力完整</strong>：真正的全栈一体化开发</li>
<li>⚡ <strong>效率极高</strong>：从想法到产品几分钟搞定</li>
<li>🎨 <strong>体验友好</strong>：自然语言交互，零技术门槛</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>快速原型验证</li>
<li>个人项目开发</li>
<li>小团队产品迭代</li>
<li>创意想法实现</li>
</ul>
<p>在 AI 技术快速发展的今天，WeaveFox 让我们看到了"人人都是全栈开发者"的可能性。它降低了技术门槛，释放了创意潜能，让更多有想法的人能够将创意转化为现实产品。</p>
<p>如果你也有一个一直想要实现的 App 想法，不妨试试 WeaveFox。也许下一个改变世界的产品，就诞生在你的一句话描述中。</p>
<hr/>
<p><strong>体验地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.weavefox.cn%2F" target="_blank" title="https://www.weavefox.cn/" ref="nofollow noopener noreferrer">www.weavefox.cn/</a></p>
<p><em>用 AI 编织创意，让代码服务于人。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NodeJS创建流式接口&AI大模型接口流式调用记录]]></title>    <link>https://juejin.cn/post/7571378103282204678</link>    <guid>https://juejin.cn/post/7571378103282204678</guid>    <pubDate>2025-11-12T04:03:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103282204678" data-draft-id="7571348736154140708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NodeJS创建流式接口&amp;AI大模型接口流式调用记录"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-12T04:03:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端君"/> <meta itemprop="url" content="https://juejin.cn/user/395479919102856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NodeJS创建流式接口&amp;AI大模型接口流式调用记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479919102856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T04:03:29.000Z" title="Wed Nov 12 2025 04:03:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>什么是流式文本传输？</strong></p>
<p>流式文本传输是一种在数据生成后立即传输，而不是等待所有数据生成完毕再一次性传输的技术。这种传输方式可以显著提升用户体验，特别是在处理大量数据或需要实时响应的场景中。</p>
<p>流式传输的主要优势：</p>
<ul>
<li><strong>实时响应</strong>：用户可以立即看到部分结果，而不必等待整个过程完成</li>
<li><strong>减少内存占用</strong>：数据可以边生成边传输，避免在内存中缓存大量数据</li>
<li><strong>更好的用户体验</strong>：特别是在AI生成内容、长文本处理等场景下</li>
</ul>
<h3 data-id="heading-0">NodeJS + Koa 流式接口示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Readable</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();

<span class="hljs-comment">// 流式响应中间件</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx) =&gt; {
  <span class="hljs-comment">// 设置响应头</span>
  ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);
  ctx.<span class="hljs-title function_">set</span>(<span class="hljs-string">'Transfer-Encoding'</span>, <span class="hljs-string">'chunked'</span>);
  
  <span class="hljs-comment">// 创建一个可读流</span>
  <span class="hljs-keyword">const</span> readableStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Readable</span>({
    <span class="hljs-title function_">read</span>(<span class="hljs-params">size</span>) {
      <span class="hljs-comment">// 这个方法会在流需要更多数据时被调用</span>
    }
  });
  
  <span class="hljs-comment">// 模拟异步生成数据的过程</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-string">'这是,第一部分,数据,\n这是,第二部分,数据\n这是,第三部分,数据,\n这是,第四部分,数据,\n这是最后一部分数据\n'</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> data) {
      <span class="hljs-comment">// 模拟处理延迟</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
      <span class="hljs-comment">// 将数据推入流中</span>
      readableStream.<span class="hljs-title function_">push</span>(chunk);
    }
    
    <span class="hljs-comment">// 结束流</span>
    readableStream.<span class="hljs-title function_">push</span>(<span class="hljs-literal">null</span>);
  }
  
  <span class="hljs-comment">// 启动数据生成</span>
  <span class="hljs-title function_">generateData</span>();
  
  <span class="hljs-comment">// 将流管道到响应对象</span>
  ctx.<span class="hljs-property">body</span> = readableStream;
});

<span class="hljs-comment">// 启动服务器</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器运行在 http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
});
</code></pre>
<h3 data-id="heading-1">NodeJS 发送流式请求</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-comment">/**
 * Node.js版本的流式查询函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} options.params - 请求参数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onStart] - 开始回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onChange] - 数据变化回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onFinish] - 完成回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.onError] - 错误回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} [options.chunkTransform] - 数据块转换函数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">streamRequest</span> = (<span class="hljs-params">{
  params,
  onStart,
  onChange,
  onFinish,
  onError,
  chunkTransform,
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, headers = {} } = params;
  <span class="hljs-keyword">const</span> { searchParams } = params;
  <span class="hljs-keyword">const</span> { body } = params;
  <span class="hljs-keyword">const</span> parsedUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);
  <span class="hljs-keyword">const</span> isHttps = parsedUrl.<span class="hljs-property">protocol</span> === <span class="hljs-string">'https:'</span>;
  <span class="hljs-keyword">const</span> requestModule = isHttps ? https : http;

  <span class="hljs-keyword">if</span> (searchParams) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(searchParams).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      parsedUrl.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">set</span>(key, value);
    });
  }

  <span class="hljs-keyword">const</span> requestOptions = {
    <span class="hljs-attr">hostname</span>: parsedUrl.<span class="hljs-property">hostname</span>,
    <span class="hljs-attr">port</span>: parsedUrl.<span class="hljs-property">port</span> || (isHttps ? <span class="hljs-number">443</span> : <span class="hljs-number">80</span>),
    <span class="hljs-attr">path</span>: parsedUrl.<span class="hljs-property">pathname</span> + parsedUrl.<span class="hljs-property">search</span>,
    method,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...headers,
    },
  };

  <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> aborted = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">const</span> req = requestModule.<span class="hljs-title function_">request</span>(requestOptions, <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> !== <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">let</span> errorData = <span class="hljs-string">''</span>;
      res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
        errorData += chunk.<span class="hljs-title function_">toString</span>();
      });
      res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${res.statusMessage}</span>\n<span class="hljs-subst">${errorData}</span>`</span>);
        onError?.(error);
      });
      <span class="hljs-keyword">return</span>;
    }

    res.<span class="hljs-title function_">setEncoding</span>(<span class="hljs-string">'utf8'</span>);

    <span class="hljs-comment">// 监听第一个数据块</span>
    res.<span class="hljs-title function_">once</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">() =&gt;</span> {
      onStart?.();
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (aborted) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> chunkStr = chunk?.<span class="hljs-title function_">toString</span>();
      <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(chunkStr) : chunkStr;
      fullText += transformedChunk;
      onChange?.(transformedChunk, fullText);
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!aborted) {
        onFinish?.(fullText);
      }
    });

    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onError !== <span class="hljs-string">'function'</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
          <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (!aborted) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Response error:'</span>, error);
        onError?.(error);
      }
    });
  });

  req.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!aborted) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Request error:'</span>, error);
      onError?.(error);
    }
  });

  <span class="hljs-comment">// 发送请求体（如果是POST请求）</span>
  <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'POST'</span> &amp;&amp; body) {
    req.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body));
  }

  req.<span class="hljs-title function_">end</span>();

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">abort</span>: <span class="hljs-function">() =&gt;</span> {
      aborted = <span class="hljs-literal">true</span>;
      req.<span class="hljs-title function_">destroy</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request aborted'</span>);
    },
  };
};
</code></pre>
<h3 data-id="heading-2">浏览器中发送流式请求</h3>
<ul>
<li>基于 <code>fetch</code> 实现</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 浏览器版本的流式查询函数
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@returns</span> 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">browserStreamRequest</span> = (<span class="hljs-params">{
  params,
  onStart,
  onChange,
  onFinish,
  onError,
  chunkTransform,
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, headers = {} } = params;
  <span class="hljs-keyword">const</span> { searchParams } = params;
  <span class="hljs-keyword">const</span> { body } = params;
  
  <span class="hljs-keyword">let</span> controller = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> isStarted = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">let</span> isFinished = <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildFetchUrl</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!searchParams) <span class="hljs-keyword">return</span> url;
    
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(searchParams).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      urlObj.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">set</span>(key, value);
    });
    <span class="hljs-keyword">return</span> urlObj.<span class="hljs-title function_">toString</span>();
  };
  
  <span class="hljs-keyword">const</span> fetchOptions = {
    method,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...headers,
    },
    <span class="hljs-comment">// 允许跨域凭证</span>
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
  };
  
  <span class="hljs-comment">// 设置信号用于中断请求</span>
  controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  fetchOptions.<span class="hljs-property">signal</span> = controller.<span class="hljs-property">signal</span>;
  
  <span class="hljs-comment">// 添加请求体（如果是POST请求）</span>
  <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'POST'</span> &amp;&amp; body) {
    fetchOptions.<span class="hljs-property">body</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body);
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">processStream</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-title function_">buildFetchUrl</span>(), fetchOptions);
      
      <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
        <span class="hljs-keyword">let</span> errorData = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">try</span> {
          errorData = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">text</span>();
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-comment">// 忽略解析错误</span>
        }
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${response.status}</span> <span class="hljs-subst">${response.statusText}</span>\n<span class="hljs-subst">${errorData}</span>`</span>);
        onError?.(error);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 检查响应是否支持流式处理</span>
      <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">body</span>) {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Response body is not streamable'</span>);
        onError?.(error);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 创建TextDecoder用于解码二进制流</span>
      <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
      <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
      
      <span class="hljs-comment">// 流式处理数据</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">readStream</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
          
          <span class="hljs-keyword">if</span> (done) {
            <span class="hljs-keyword">if</span> (!isFinished) {
              isFinished = <span class="hljs-literal">true</span>;
              onFinish?.(fullText);
            }
            <span class="hljs-keyword">return</span>;
          }
          
          <span class="hljs-comment">// 首次收到数据时触发onStart</span>
          <span class="hljs-keyword">if</span> (!isStarted) {
            isStarted = <span class="hljs-literal">true</span>;
            onStart?.();
          }
          
          <span class="hljs-comment">// 解码并处理数据块</span>
          <span class="hljs-keyword">const</span> chunkStr = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
          <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(chunkStr) : chunkStr;
          fullText += transformedChunk;
          onChange?.(transformedChunk, fullText);
          
          <span class="hljs-comment">// 继续读取流</span>
          <span class="hljs-title function_">readStream</span>();
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">if</span> (!isFinished &amp;&amp; !controller?.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Stream processing error:'</span>, error);
            onError?.(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-title class_">String</span>(error)));
          }
        }
      };
      
      <span class="hljs-title function_">readStream</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (!isFinished &amp;&amp; !controller?.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch request error:'</span>, error);
        onError?.(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-title class_">String</span>(error)));
      }
    }
  };
  
  <span class="hljs-comment">// 立即开始处理流</span>
  <span class="hljs-title function_">processStream</span>();
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">abort</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (controller) {
        controller.<span class="hljs-title function_">abort</span>();
        isFinished = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request aborted'</span>);
      }
    },
  };
};

</code></pre>
<ul>
<li>低版本浏览器（如 IE11）不支持 <code>fetch</code> 流式传输，需要使用 XHR 实现</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">/**
 * 浏览器兼容性检查
 * <span class="hljs-doctag">@returns</span> 是否支持流式请求
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">isStreamSupported</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> !!(<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> &amp;&amp; 
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ReadableStream</span> &amp;&amp; 
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">TextDecoder</span> &amp;&amp; 
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">AbortController</span>);
};

<span class="hljs-comment">/**
 * 降级版本的请求函数（当浏览器不支持流式处理时使用）
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@returns</span> 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fallbackRequest</span> = (<span class="hljs-params">{
  params,
  onStart,
  onChange,
  onFinish,
  onError,
  chunkTransform,
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, headers = {} } = params;
  <span class="hljs-keyword">const</span> { searchParams } = params;
  <span class="hljs-keyword">const</span> { body } = params;
  
  <span class="hljs-keyword">let</span> xhr = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> fullText = <span class="hljs-string">''</span>;
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildUrl</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!searchParams) <span class="hljs-keyword">return</span> url;
    
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(searchParams).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      urlObj.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">set</span>(key, value);
    });
    <span class="hljs-keyword">return</span> urlObj.<span class="hljs-title function_">toString</span>();
  };
  
  <span class="hljs-keyword">try</span> {
    xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
    xhr.<span class="hljs-title function_">open</span>(method, <span class="hljs-title function_">buildUrl</span>(), <span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// 设置响应类型为文本</span>
    xhr.<span class="hljs-property">responseType</span> = <span class="hljs-string">'text'</span>;
    
    <span class="hljs-comment">// 设置请求头</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>({
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...headers,
    }).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      xhr?.<span class="hljs-title function_">setRequestHeader</span>(key, value);
    });
    
    <span class="hljs-comment">// 监听进度事件（非标准流式处理）</span>
    xhr.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span> || xhr?.<span class="hljs-property">responseText</span>) {
        <span class="hljs-keyword">const</span> currentText = xhr?.<span class="hljs-property">responseText</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">const</span> newChunk = currentText.<span class="hljs-title function_">substring</span>(fullText.<span class="hljs-property">length</span>);
        
        <span class="hljs-keyword">if</span> (newChunk &amp;&amp; fullText.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-comment">// 首次收到数据</span>
          onStart?.();
        }
        
        <span class="hljs-keyword">if</span> (newChunk) {
          <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(newChunk) : newChunk;
          fullText += transformedChunk;
          onChange?.(transformedChunk, fullText);
        }
      }
    };
    
    xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr?.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 确保处理完所有数据</span>
        <span class="hljs-keyword">const</span> currentText = xhr.<span class="hljs-property">responseText</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (currentText !== fullText) {
          <span class="hljs-keyword">const</span> newChunk = currentText.<span class="hljs-title function_">substring</span>(fullText.<span class="hljs-property">length</span>);
          <span class="hljs-keyword">const</span> transformedChunk = chunkTransform ? <span class="hljs-title function_">chunkTransform</span>(newChunk) : newChunk;
          fullText += transformedChunk;
          onChange?.(transformedChunk, fullText);
        }
        onFinish?.(fullText);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${xhr?.status}</span> <span class="hljs-subst">${xhr?.statusText}</span>\n<span class="hljs-subst">${xhr?.responseText || <span class="hljs-string">''</span>}</span>`</span>);
        onError?.(error);
      }
    };
    
    xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Network error occurred'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'XHR error:'</span>, error);
      onError?.(error);
    };
    
    <span class="hljs-comment">// 发送请求</span>
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'POST'</span> &amp;&amp; body) {
      xhr.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body));
    } <span class="hljs-keyword">else</span> {
      xhr.<span class="hljs-title function_">send</span>();
    }
    
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fallback request initialization error:'</span>, error);
    onError?.(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-title class_">String</span>(error)));
  }
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">abort</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr) {
        xhr.<span class="hljs-title function_">abort</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Request aborted'</span>);
      }
    },
  };
};

<span class="hljs-comment">/**
 * 智能流式请求函数 - 根据浏览器支持情况自动选择实现方式
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - 配置选项
 * <span class="hljs-doctag">@returns</span> 返回包含abort方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">smartStreamRequest</span> = (<span class="hljs-params">options</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isStreamSupported</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Using native fetch stream implementation'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">browserStreamRequest</span>(options);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Using fallback XHR implementation'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackRequest</span>(options);
  }
};
</code></pre>
<h3 data-id="heading-3">浏览器端流式请求使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本使用示例</span>
<span class="hljs-keyword">const</span> streamInstance = <span class="hljs-title function_">smartStreamRequest</span>({
  <span class="hljs-attr">params</span>: {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/stream'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: {
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">'Tell me a story'</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-attr">onStart</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Stream started'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>)?.<span class="hljs-title function_">textContent</span>(<span class="hljs-string">'Streaming...'</span>);
  },
  <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">chunk, fullText</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Received chunk: <span class="hljs-subst">${chunk}</span>`</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>)?.<span class="hljs-title function_">textContent</span>(fullText);
  },
  <span class="hljs-attr">onFinish</span>: <span class="hljs-function">(<span class="hljs-params">fullText</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Stream finished, total text: <span class="hljs-subst">${fullText.length}</span> characters`</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>)?.<span class="hljs-title function_">textContent</span>(<span class="hljs-string">'Completed'</span>);
  },
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Stream error:'</span>, error);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>)?.<span class="hljs-title function_">textContent</span>(<span class="hljs-string">`Error: <span class="hljs-subst">${error.message}</span>`</span>);
  },
  <span class="hljs-comment">// 可选的数据转换函数</span>
  <span class="hljs-attr">chunkTransform</span>: <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
    <span class="hljs-comment">// 例如处理特定格式的流式数据</span>
    <span class="hljs-keyword">return</span> chunk.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^data: /</span>, <span class="hljs-string">''</span>);
  }
});

<span class="hljs-comment">// 中断请求的示例</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  streamInstance.<span class="hljs-title function_">abort</span>();
}, <span class="hljs-number">5000</span>);
</code></pre>
<h4 data-id="heading-4">常见问题处理</h4>
<ol>
<li><strong>CORS 问题</strong>：确保服务器端正确配置了 CORS 响应头，特别是当需要流式传输时</li>
<li><strong>超时处理</strong>：可以通过 <code>setTimeout</code> 和 <code>abort()</code> 方法实现请求超时控制</li>
<li><strong>内存管理</strong>：对于长时间运行的流，注意监控内存使用情况，避免内存泄漏</li>
<li><strong>错误恢复</strong>：可以实现重试逻辑，在 <code>onError</code> 回调中重新发起请求</li>
</ol>
<h2 data-id="heading-5">案例: 流式调用免费的AI大模型接口（来自硅基流动）</h2>
<blockquote>
<p>备注：硅基流动（SiliconFlow）是一家提供免费AI大模型服务的公司，其API接口支持流式传输。其中token可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fme%2Faccount%2Fak" target="_blank" title="https://cloud.siliconflow.cn/me/account/ak" ref="nofollow noopener noreferrer">硅基流动API密钥管理</a> 处创建。API介绍见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.siliconflow.cn%2Fcn%2Fapi-reference%2Fchat-completions%2Fchat-completions" target="_blank" title="https://docs.siliconflow.cn/cn/api-reference/chat-completions/chat-completions" ref="nofollow noopener noreferrer">API手册</a></p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callSiliconFlowAPI</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> options = {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'https://api.siliconflow.cn/v1/chat/completions'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer &lt;token&gt;'</span>, <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: {
      <span class="hljs-attr">model</span>: <span class="hljs-string">'Qwen/Qwen2.5-7B-Instruct'</span>,
      <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'你好'</span> }],
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    },
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">streamRequest</span>({
      <span class="hljs-attr">params</span>: options,
      <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">chunk, fullText</span>) =&gt;</span> {
        process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk);
      },
      <span class="hljs-attr">chunkTransform</span>: extractContentFromSiliconFlowChunk,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
  }
}
<span class="hljs-comment">/**
 * 从 SiliconFlow 模型的响应 chunk 中提取实际内容
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">chunk</span> - 包含 SiliconFlow 响应的 chunk 字符串
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} - 提取后的实际内容
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractContentFromSiliconFlowChunk</span> (chunk) {
  <span class="hljs-keyword">return</span> chunk?.<span class="hljs-title function_">trim</span>()
    .<span class="hljs-title function_">split</span>(<span class="hljs-string">'data: '</span>)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item &amp;&amp; !item.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'[DONE]'</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(item.<span class="hljs-title function_">trim</span>());
      <span class="hljs-keyword">const</span> delta = json?.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">message</span> || json?.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>;
      <span class="hljs-keyword">const</span> res = delta?.<span class="hljs-property">content</span> ?? delta?.<span class="hljs-property">reasoning_content</span> ?? <span class="hljs-string">''</span>;
      <span class="hljs-keyword">return</span> res;
    })
    .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VonaJS: I18n如何支持Swagger多语言]]></title>    <link>https://juejin.cn/post/7571378103281336326</link>    <guid>https://juejin.cn/post/7571378103281336326</guid>    <pubDate>2025-11-12T02:03:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571378103281336326" data-draft-id="7571306072424071210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VonaJS: I18n如何支持Swagger多语言"/> <meta itemprop="keywords" content="TypeScript,Node.js,NestJS"/> <meta itemprop="datePublished" content="2025-11-12T02:03:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="濮水大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1119781972622208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VonaJS: I18n如何支持Swagger多语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1119781972622208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    濮水大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:03:25.000Z" title="Wed Nov 12 2025 02:03:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>VonaJS提供的I18n支持模块化体系。每个业务模块都可以单独提供自己的 I18n 语言资源。我们先了解I18n的一般用法，然后再看看如何支持Swagger多语言</p>
<h2 data-id="heading-0">初始化代码骨架</h2>
<p>我们先在模块<code>demo-student</code>中初始化I18n的代码骨架</p>
<h3 data-id="heading-1">1. Cli命令</h3>
<pre><code class="hljs language-bash" lang="bash">$ vona :init:locale demo-student
</code></pre>
<h3 data-id="heading-2">2. 菜单命令</h3>
<pre><code class="hljs language-bash" lang="bash">右键菜单 - [模块路径]: `Vona Init/Locale`
</code></pre>
<h2 data-id="heading-3">定义语言资源</h2>
<p>以模块<code>demo-student</code>为例，定义模块的语言资源：</p>
<ul>
<li>英文</li>
</ul>
<p><code>src/module/demo-student/src/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ StudentName: 'Student Name',</span>
};
</code></pre>
<ul>
<li>中文</li>
</ul>
<p><code>src/module/demo-student/src/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ StudentName: '学生名称',</span>
};
</code></pre>
<h2 data-id="heading-4">使用语言资源</h2>
<p>可以通过 Scope 实例提供的<code>locale</code>对象获取模块的语言资源，支持类型化提示</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-meta">@Web</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'test'</span>)
  <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// use current locale</span>
    <span class="hljs-keyword">const</span> message1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">StudentName</span>();
    <span class="hljs-comment">// use locale en-us</span>
    <span class="hljs-keyword">const</span> message2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'en-us'</span>);
    <span class="hljs-comment">// use locale zh-cn</span>
    <span class="hljs-keyword">const</span> message3 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'zh-cn'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message1, message2, message3);
  }
}  
</code></pre>
<h2 data-id="heading-5">跨模块使用语言资源</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerStudent</span> {
  <span class="hljs-meta">@Web</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'test'</span>)
  <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// use current locale</span>
    <span class="hljs-keyword">const</span> message1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">demoStudent</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">StudentName</span>();
    <span class="hljs-comment">// use locale en-us</span>
    <span class="hljs-keyword">const</span> message2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">demoStudent</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'en-us'</span>);
    <span class="hljs-comment">// use locale zh-cn</span>
    <span class="hljs-keyword">const</span> message3 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">demoStudent</span>.<span class="hljs-property">locale</span>.<span class="hljs-property">StudentName</span>.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'zh-cn'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message1, message2, message3);
  }
}  
</code></pre>
<h2 data-id="heading-6">覆盖语言资源</h2>
<p>可以使用<code>项目级别</code>的语言资源覆盖<code>模块级别</code>的语言资源</p>
<ul>
<li>英文</li>
</ul>
<p><code>src/backend/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
  modules: {
<span class="hljs-addition">+   'demo-student': {</span>
<span class="hljs-addition">+     StudentName: 'Student Name!',</span>
<span class="hljs-addition">+   },</span>
  },
};
</code></pre>
<ul>
<li>中文</li>
</ul>
<p><code>src/backend/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
  modules: {
<span class="hljs-addition">+   'demo-student': {</span>
<span class="hljs-addition">+     StudentName: '学生名称!',</span>
<span class="hljs-addition">+   },</span>
  },
};
</code></pre>
<h2 data-id="heading-7">当前locale</h2>
<h3 data-id="heading-8">1. 获取当前locale</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> locale = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span>;
</code></pre>
<h3 data-id="heading-9">2. 设置当前locale</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span> = <span class="hljs-string">'en-us'</span>;
</code></pre>
<h3 data-id="heading-10">3. 获取缺省locale</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> localeDefault = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$scope</span>.<span class="hljs-property">i18n</span>.<span class="hljs-property">config</span>.<span class="hljs-property">defaultLocale</span>;
</code></pre>
<h2 data-id="heading-11">获取当前locale的规则</h2>
<p>当用户访问后端 API 时，后端会自动根据规则获取当前 locale</p>
<h3 data-id="heading-12">1. 模块配置</h3>
<p>I18n 是由模块 a-i18n 提供的核心能力，可以在 App config 中修改模块的配置：</p>
<p><code>src/backend/config/config/config.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// modules</span>
config.<span class="hljs-property">modules</span> = {
  <span class="hljs-string">'a-i18n'</span>: {
    <span class="hljs-attr">defaultLocale</span>: <span class="hljs-string">'en-us'</span>,
    <span class="hljs-attr">queryField</span>: <span class="hljs-string">'x-vona-locale'</span>,
    <span class="hljs-attr">headerField</span>: <span class="hljs-string">'x-vona-locale'</span>,
    <span class="hljs-attr">cookieField</span>: <span class="hljs-string">'locale'</span>,
  },
};
</code></pre>

























<table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>defaultLocale</td><td>Default locale</td></tr><tr><td>queryField</td><td>从request query中获取当前locale，query key默认为<code>x-vona-locale</code></td></tr><tr><td>headerField</td><td>从request header中获取当前locale，header key默认为<code>x-vona-locale</code></td></tr><tr><td>cookieField</td><td>从request cookie中获取当前locale，cookie key默认为<code>locale</code></td></tr></tbody></table>
<h3 data-id="heading-13">2. 规则次序</h3>
<p>系统按以下次序，依次判断当前 locale</p>
<p><code>queryField</code> &gt; <code>headerField</code> &gt; <code>cookieField</code> &gt; <code>Header: Accept-Language</code> &gt; <code>defaultLocale</code></p>
<h2 data-id="heading-14">添加新语言</h2>
<p>VonaJS 默认提供了两个语言:<code>en-us</code>和<code>zh-cn</code>。下面演示如何添加新语言<code>zh-tw</code></p>
<h3 data-id="heading-15">1. 添加类型定义</h3>
<p>采用接口合并机制添加新语言的类型定义</p>
<p>在 VSCode 编辑器中，输入代码片段<code>recordlocale</code>，自动生成代码骨架:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'vona'</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ILocaleRecord</span> {
    : <span class="hljs-built_in">never</span>;
  }
}
</code></pre>
<p>调整代码，然后添加<code>zh-tw</code></p>
<pre><code class="hljs language-diff" lang="diff">declare module 'vona' {
  export interface ILocaleRecord {
<span class="hljs-addition">+   'zh-tw': never;</span>
  }
}
</code></pre>
<h3 data-id="heading-16">2. 添加语言资源</h3>
<p>新建语言文件<code>zh-tw.ts</code>，然后添加语言资源</p>
<p><code>src/module/demo-student/src/config/locale/zh-tw.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title class_">StudentName</span>: <span class="hljs-string">'學生名稱'</span>,
};
</code></pre>
<h2 data-id="heading-17">复数</h2>
<h3 data-id="heading-18">1. 定义语言资源</h3>
<p><code>src/module/demo-student/src/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestApples_: '%d apples',</span>
<span class="hljs-addition">+ TestApples_0: 'no apples',</span>
<span class="hljs-addition">+ TestApples_1: 'one apple',</span>
};
</code></pre>
<p><code>src/module/demo-student/src/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestApples_: '%d个苹果',</span>
<span class="hljs-addition">+ TestApples_0: '没有苹果',</span>
};
</code></pre>
<h3 data-id="heading-19">2. 使用语言资源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span> = <span class="hljs-string">'en-us'</span>;
<span class="hljs-keyword">const</span> apple0 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestApples</span>_(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> apple1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestApples</span>_(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> apple2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestApples</span>_(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${apple0}</span>, <span class="hljs-subst">${apple1}</span>, <span class="hljs-subst">${apple2}</span>`</span>);
</code></pre>
<p>控制台输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">no apples, one apple, 2 apples
</code></pre>
<ul>
<li><code>TestApples_</code>: 缺省语言资源。语言资源添加后缀<code>_</code>，可以提示开发者该语言资源需要传入参数</li>
<li><code>TestApples_{n}</code>: 可以针对任何具体的<code>n</code>提供独立的语言资源。系统在进行语言翻译时，如果找不到具体<code>n</code>的语言资源，就使用缺省语言资源<code>TestApples_</code></li>
</ul>
<h2 data-id="heading-20">复数: 多参数</h2>
<p>如果语言资源支持多参数，那么可以明确指定哪个参数支持复数</p>
<h3 data-id="heading-21">1. 定义语言资源</h3>
<p><code>src/module/demo-student/src/config/locale/en-us.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestNameApples_: '%s has %d apples',</span>
<span class="hljs-addition">+ TestNameApples_0_1: '%s has no apples',</span>
<span class="hljs-addition">+ TestNameApples_1_1: '%s has one apple',</span>
};
</code></pre>
<p><code>src/module/demo-student/src/config/locale/zh-cn.ts</code></p>
<pre><code class="hljs language-diff" lang="diff">export default {
<span class="hljs-addition">+ TestNameApples_: '%s有%d个苹果',</span>
<span class="hljs-addition">+ TestNameApples_0_1: '%s没有苹果',</span>
};
</code></pre>
<h3 data-id="heading-22">2. 使用语言资源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">locale</span> = <span class="hljs-string">'en-us'</span>;
<span class="hljs-keyword">const</span> apple0 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestNameApples</span>_(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> apple1 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestNameApples</span>_(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> apple2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scope</span>.<span class="hljs-property">locale</span>.<span class="hljs-title class_">TestNameApples</span>_(<span class="hljs-string">'Tom'</span>, <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${apple0}</span>, <span class="hljs-subst">${apple1}</span>, <span class="hljs-subst">${apple2}</span>`</span>);
</code></pre>
<p>控制台输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">Tom has no apples, Tom has one apple, Tom has 2 apples
</code></pre>
<ul>
<li><code>TestNameApples_</code>: 缺省语言资源。语言资源添加后缀<code>_</code>，可以提示开发者该语言资源需要传入参数</li>
<li><code>TestNameApples_{n}_{ordinal}</code>: <code>ordinal</code>代表参数序数</li>
</ul>
<h2 data-id="heading-23">Swagger/Openapi</h2>
<p>VonaJS 提供了一组工具函数，为 Swagger/Openapi 实现 I18n 国际化</p>
<p>比如，为<code>EntityStudent</code>的字段<code>name</code>提供国际化的<code>title</code>信息</p>
<h3 data-id="heading-24">1. $localeScope</h3>
<p>在设置字段 title 信息时，要使用<code>语言资源FullKey</code>。在实际生成 Swagger/Openapi 元数据时，系统会自动将<code>语言资源FullKey</code>翻译为指定的语言</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ import { $localeScope } from 'vona';</span>

class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.title($localeScope('demo-student', 'Name')))</span>
  name: string;
}
</code></pre>
<ul>
<li><code>v.title</code>: 设置 title 信息</li>
<li><code>$localeScope</code>: 传入<code>模块名称</code>和<code>语言资源Key</code>，从而生成<code>语言资源FullKey</code>: <code>demo-student::Name</code></li>
</ul>
<h3 data-id="heading-25">2. $locale</h3>
<p>VonaJS 还提供了一个简化的工具函数<code>$locale</code></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ import { $locale } from '../.metadata/index.ts';</span>

class EntityStudent {
<span class="hljs-addition">+ @Api.field(v.title($locale('Name')))</span>
  name: string;
}
</code></pre>
<ul>
<li><code>$locale</code>: 传入<code>语言资源Key</code>，从而生成<code>语言资源FullKey</code>: <code>demo-student::Name</code>
<ul>
<li>每个模块都提供了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mtext>函数，因此，使用本模块的</mtext></mrow><annotation encoding="application/x-tex">locale 函数，因此，使用本模块的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">函数，因此，使用本模块的</span></span></span></span></span>locale 函数就可以取得模块名称</li>
</ul>
</li>
</ul>
<h2 data-id="heading-26">资源</h2>
<ul>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvonajs%2Fvona" target="_blank" title="https://github.com/vonajs/vona" ref="nofollow noopener noreferrer">github.com/vonajs/vona</a></li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvona.js.org" target="_blank" title="https://vona.js.org" ref="nofollow noopener noreferrer">vona.js.org</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Claude Agent SDK 开发一个 Agent 原来这么简单]]></title>    <link>https://juejin.cn/post/7571372478803787791</link>    <guid>https://juejin.cn/post/7571372478803787791</guid>    <pubDate>2025-11-12T02:03:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803787791" data-draft-id="7571372478803771407" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Claude Agent SDK 开发一个 Agent 原来这么简单"/> <meta itemprop="keywords" content="前端,JavaScript,Agent"/> <meta itemprop="datePublished" content="2025-11-12T02:03:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="liruifengv李瑞丰"/> <meta itemprop="url" content="https://juejin.cn/user/237150239994471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Claude Agent SDK 开发一个 Agent 原来这么简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/237150239994471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    liruifengv李瑞丰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:03:17.000Z" title="Wed Nov 12 2025 02:03:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>最近在学习 AI Agent 开发，本文将使用 Claude Agent SDK 的 TypeScript 版本, 构建一个 AI Agent Demo。</p>
<p>全部代码在我的 GitHub 仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliruifengv%2Fclaude-agent-demo" target="_blank" title="https://github.com/liruifengv/claude-agent-demo" ref="nofollow noopener noreferrer">liruifengv/claude-agent-demo</a>。</p>
<h2 data-id="heading-0">Claude Agent SDK 介绍</h2>
<p>Claude Agent SDK 的前身是 Claude Code SDK，是 Claude Code 的底层框架，现在改为通用的 Agent SDK，其中具备了 Claude Code 所拥有的一些基础能力，包括上下文管理，内置丰富的工具，权限控制等，如果你也想构建一个 Agent，使用这个 SDK 能快速搭建起来。更多详情请看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fdocs%2Fagent-sdk%2Foverview" target="_blank" title="https://docs.claude.com/en/docs/agent-sdk/overview" ref="nofollow noopener noreferrer">Claude Agent SDK 的文档</a></p>
<h2 data-id="heading-1">环境配置</h2>
<p>首先我们需要初始化一个 Node.js 的空项目。</p>
<p>其次是环境变量，需要配置 Claude 的模型的 BASE_URL 和 API_KEY</p>
<p>两种方式：</p>
<ul>
<li>可以在系统的环境变量里配置：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ANTHROPIC_BASE_URL=ANTHROPIC_BASE_URL
ANTHROPIC_API_KEY=ANTHROPIC_API_KEY
</code></pre>
<ul>
<li>或者在项目的 <code>.env</code> 文件中配置：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ANTHROPIC_BASE_URL=ANTHROPIC_BASE_URL
ANTHROPIC_API_KEY=ANTHROPIC_API_KEY
</code></pre>
<p>然后安装 <code>@anthropic-ai/claude-agent-sdk</code> 这个 npm 包：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @anthropic-ai/claude-agent-sdk
</code></pre>
<h2 data-id="heading-2">基础用法</h2>
<p>首先是 <code>query</code> 函数，他是跟 Agent 交互的主要函数，用于向 Agent 发送请求。</p>
<p>我们来看下用法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { query, <span class="hljs-title class_">Query</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">basicExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// query 函数接受一个 prompt 参数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({<span class="hljs-attr">prompt</span>: <span class="hljs-string">"你好"</span>})

    <span class="hljs-comment">// 这里使用 for await of 循环 result</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result){
      <span class="hljs-comment">// message.type 有几种：'assistant', 'user', 'system', 'result' 等</span>
      <span class="hljs-comment">// 根据不同的消息类型做业务逻辑</span>
      <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>){
        <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
          <span class="hljs-comment">// message.message.content 是一个数组，我们循环所有的 msg</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
            <span class="hljs-comment">// 打印 text 类型的输出</span>
            <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg.<span class="hljs-property">text</span>)
            }
          }
      }
    }
  }
</code></pre>
<p>在 <code>index.ts</code> 中调用 <code>basicExample</code> 函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { basicExample } <span class="hljs-keyword">from</span> <span class="hljs-string">"./core/basic-example"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Starting Claude Agent Demo...'</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">basicExample</span>();
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>执行 <code>tsx src/index.ts</code></p>
<p>可以在终端看到</p>
<pre><code class="hljs language-bash" lang="bash">&gt; claude-agent-demo@1.0.0 dev
&gt; tsx src/index.ts

Starting Claude Agent Demo...
你好！很高兴见到你！我是 Claude，一个 AI 助手。我可以帮助你：

- 编写和调试代码
- 搜索和分析代码库
- 执行命令和运行脚本
- 管理文件和项目
- 回答技术问题

有什么我可以帮助你的吗？
</code></pre>
<h2 data-id="heading-3">Session 会话管理</h2>
<p>Claude Agent SDK 自带了会话管理功能，当新建一个 query 时，它会返回一个 session ID，你可以使用这个 ID 来保存和恢复会话。例如，你可以将 session ID 存储在数据库中，以便在用户下次登录时恢复会话。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> {query, <span class="hljs-title class_">Query</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sessionExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

    <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">"你好"</span>,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-comment">// options 的 resume 参数传入记录的 sessionId，就可以继续对话了</span>
          <span class="hljs-attr">resume</span>: sessionId
      }
  })

  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result) {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-comment">// message.type === 'assistant' &amp;&amp; message.subtype === 'init' 的时候</span>
      <span class="hljs-comment">// 会返回一个 session_id，需要把这个 session_id 存下来</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'system'</span>:
        <span class="hljs-keyword">if</span> (message.<span class="hljs-property">subtype</span> === <span class="hljs-string">'init'</span>) {
          sessionId = message.<span class="hljs-property">session_id</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Current Session ID: <span class="hljs-subst">${sessionId}</span>`</span>)
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Assistant: <span class="hljs-subst">${msg.text}</span>`</span>)
          }
        }
        <span class="hljs-keyword">break</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-4">实现连续对话</h2>
<p>接下来我们会在终端使用 node 做一下简单的交互，使得用户可输入内容，然后使用 session ID 实现连续对话。</p>
<p>创建一个 <code>tui-chat.ts</code>:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tuiChat</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> rl = readline.<span class="hljs-title function_">createInterface</span>({
        <span class="hljs-attr">input</span>: process.<span class="hljs-property">stdin</span>,
        <span class="hljs-attr">output</span>: process.<span class="hljs-property">stdout</span>,
        <span class="hljs-attr">prompt</span>: <span class="hljs-string">'User: '</span>
    })

    rl.<span class="hljs-title function_">prompt</span>()

    rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'line'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>) =&gt; {
        <span class="hljs-keyword">const</span> userInput = input.<span class="hljs-title function_">trim</span>()
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`User: <span class="hljs-subst">${userInput}</span>`</span>)
        rl.<span class="hljs-title function_">prompt</span>()
    })


    rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"exit the chat"</span>)
        process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
    });

}
</code></pre>
<p>以上代码就能实现用户在终端连续输入内容。
接着写 AI 对话的代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 这个函数接收两个参数，一个 prompt 用户输入，一个当前会话 id</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatExample</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span>, sessionId: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) {

  <span class="hljs-comment">// 函数内部定义会话 id</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">_sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({
    <span class="hljs-attr">prompt</span>: prompt,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-comment">// options 的 resume 参数传入记录的 sessionId，就可以继续对话了</span>
      <span class="hljs-attr">resume</span>: sessionId
    }
  })
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result) {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'system'</span>:
        <span class="hljs-keyword">if</span> (message.<span class="hljs-property">subtype</span> === <span class="hljs-string">'init'</span>) {
          <span class="hljs-comment">// 系统初始化时记录会话ID</span>
          _sessionId = message.<span class="hljs-property">session_id</span>
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Assistant: <span class="hljs-subst">${msg.text}</span>`</span>)
          }
        }
        <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-comment">// 把当前会话 id 返回给调用者</span>
  <span class="hljs-keyword">return</span> _sessionId
}
</code></pre>
<p>然后调用这个 <code>chatExample</code> 就行：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tuiChat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 记录 sessionId</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> rl = readline.<span class="hljs-title function_">createInterface</span>({
    <span class="hljs-attr">input</span>: process.<span class="hljs-property">stdin</span>,
    <span class="hljs-attr">output</span>: process.<span class="hljs-property">stdout</span>,
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">'User: '</span>
  })

  rl.<span class="hljs-title function_">prompt</span>()

  rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'line'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>) =&gt; {
    <span class="hljs-keyword">const</span> userInput = input.<span class="hljs-title function_">trim</span>()
    <span class="hljs-comment">// 赋值返回的 sessionId</span>
    sessionId = <span class="hljs-keyword">await</span> <span class="hljs-title function_">chatExample</span>(userInput, sessionId)

    rl.<span class="hljs-title function_">prompt</span>()
  })


  rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"exit the chat"</span>)
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
  });
}
</code></pre>
<p>好的，现在我们来执行一下看看效果：</p>
<pre><code class="hljs language-bash" lang="bash">Starting Claude Agent Demo...
User: hello
Assistant: Hello! 👋 How can I <span class="hljs-built_in">help</span> you today? I<span class="hljs-string">'m Claude, and I can assist you with a variety of tasks like:

- Writing, editing, or reviewing code
- Searching through codebases and files
- Running commands and tests
- Creating pull requests and managing git operations
- Answering questions about your project
- And much more!

What would you like to work on?
User: 你是谁
Assistant: 你好！我是 Claude，由 Anthropic 开发的 AI 助手。

在这个环境中，我是 Claude Code - 一个专门用于编程和开发任务的版本。我可以帮助你：

- 编写、编辑和审查代码
- 搜索和分析代码库
- 运行命令和测试
- 管理 Git 操作和创建 Pull Request
- 回答关于项目的问题
- 还有更多其他功能！

有什么我可以帮助你的吗？
User: 我跟你说的上一句话是什么
Assistant: 你上一句话是"你是谁"。
</span></code></pre>
<p>完美，我们可以在终端和 Agent 连续对话了，它能记住我们上一句话，说明当前会话是有效的。</p>
<h2 data-id="heading-5">工具调用</h2>
<p>接下来我们会自定义一个用于数学计算的工具，和一个 MCP Server。</p>
<p>先安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmathjs.org%2F" target="_blank" title="https://mathjs.org/" ref="nofollow noopener noreferrer"><code>mathjs</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzod.dev%2F" target="_blank" title="https://zod.dev/" ref="nofollow noopener noreferrer"><code>zod</code></a></p>
<pre><code class="hljs language-bash" lang="bash">npm install mathjs
npm install zod@3.25.76
</code></pre>
<p>Claude Agent SDK 内部使用的 zod 还是 3.25 版本，而最新版已经是 4.1.12，会有兼容问题，所以我们安装了指定版本。</p>
<p><code>mathjs</code> 是一个数学计算的库，他有一个 <code>evaluate</code> 方法，可以执行字符串表达式，例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> math <span class="hljs-keyword">from</span> <span class="hljs-string">'mathjs'</span>;

math.evaluate(<span class="hljs-string">'1.2 * (2 + 4.5)'</span>)
</code></pre>
<p>创建一个 <code>tools/calc-tool.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;

<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>
<span class="hljs-keyword">import</span> { calculator } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/calculator"</span>;

<span class="hljs-comment">// 使用 tool 函数创建一个工具</span>
<span class="hljs-comment">// 前两个参数是工具名称和描述</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> calcTool = <span class="hljs-title function_">tool</span>(
  <span class="hljs-string">"calculator"</span>,
  <span class="hljs-string">"Perform a calculation using an expression string. The strings used here are executed using mathjs evaluate function. eg  "</span> + <span class="hljs-string">"1.2 * (2 + 4.5)"</span>,
  <span class="hljs-comment">// 第三个参数是 inputSchema，使用 zod 来定义</span>
  {
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"The expression to be evaluated"</span>)
  },
  <span class="hljs-keyword">async</span> (args) =&gt;{
    <span class="hljs-comment">// 回调函数里执行工具的具体业务逻辑</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculator</span>(args.<span class="hljs-property">expression</span>)

    <span class="hljs-comment">// 返回这个结构即可</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-attr">text</span>: result
        }
      ]
    }
  }
)
</code></pre>
<p>创建一个 <code>utils/calculator.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> math <span class="hljs-keyword">from</span> <span class="hljs-string">'mathjs'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression:<span class="hljs-built_in">string</span></span>) : <span class="hljs-built_in">string</span>{
  <span class="hljs-keyword">const</span> result = math.evaluate(expression)
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toString</span>()
}
</code></pre>
<p>工具定义完毕，Claude Agent SDK 要求我们必须定义一个 MCP Server 来使用工具。</p>
<p>我们创建一个 <code>mcps/mcp-example-server.ts</code> 文件：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createSdkMcpServer } <span class="hljs-keyword">from</span> <span class="hljs-string">"@anthropic-ai/claude-agent-sdk"</span>;
<span class="hljs-keyword">import</span> { calcTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"../tools/calc-tool"</span>;

<span class="hljs-comment">// createSdkMcpServer 是定义 MCP Server 的函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> utilitiesServer = <span class="hljs-title function_">createSdkMcpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"utilities"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-attr">tools</span>: [calcTool],
})

</code></pre>
<p>好的，MCP Server 创建完毕。</p>
<p>接我们回到 <code>chatExample</code> 函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { utilitiesServer } <span class="hljs-keyword">from</span> <span class="hljs-string">"../mcps/mcp-example-server"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatExample</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span>, sessionId: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">_sessionId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Query</span> = <span class="hljs-title function_">query</span>({
    <span class="hljs-attr">prompt</span>: prompt,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-attr">resume</span>: sessionId,
      <span class="hljs-comment">// systemPrompt 可以自定义系统提示词</span>
      <span class="hljs-attr">systemPrompt</span>: <span class="hljs-string">"You are a helpful assistant that can use tools to get information. You can use the following tools: calculator"</span>,
      <span class="hljs-comment">// mcpServers 是一个对象参数，传入自定义的 MCP utilitiesServer</span>
      <span class="hljs-attr">mcpServers</span>: {
        <span class="hljs-attr">utilities</span>: utilitiesServer
      },
      <span class="hljs-comment">// 必须在 allowedTools 里指定的工具才能使用</span>
      <span class="hljs-comment">// 工具的命名格式是固定的：mcp__{server_name}__{tool_name}</span>
      <span class="hljs-comment">// 这里就是 mcp__utilities__calculator</span>
      <span class="hljs-attr">allowedTools</span>: [
        <span class="hljs-string">"mcp__utilities__calculator"</span>,
      ]
    }
  })
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> result) {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'system'</span>:
        <span class="hljs-keyword">if</span> (message.<span class="hljs-property">subtype</span> === <span class="hljs-string">'init'</span>) {
          _sessionId = message.<span class="hljs-property">session_id</span>
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'assistant'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Assistant: <span class="hljs-subst">${msg.text}</span>`</span>)
          }
          <span class="hljs-comment">// 打印 tool_use 类型的的消息</span>
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"tool_use"</span>) {
            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">`Using tool:  <span class="hljs-subst">${msg.name}</span> `</span>)
            <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">input</span>) {
                <span class="hljs-comment">// tool 得到的表达式</span>
                process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">` - Input: <span class="hljs-subst">${msg.input.expression}</span> `</span>)
            }

            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n'</span>)
          }
        }
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'user'</span>:
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> msg <span class="hljs-keyword">of</span> message.<span class="hljs-property">message</span>.<span class="hljs-property">content</span>) {
          <span class="hljs-comment">// 打印 tool_result 类型的消息</span>
          <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"tool_result"</span>) {
            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"Tool Results: "</span>)
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> result <span class="hljs-keyword">of</span> msg.<span class="hljs-property">content</span>) {
              <span class="hljs-keyword">if</span> (result.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) {
                process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(result.<span class="hljs-property">text</span>)
                process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">" - "</span>)
              }
            }
            process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n'</span>)
          }
        }
        <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-keyword">return</span> _sessionId
}
</code></pre>
<p>我们运行看看效果：</p>
<pre><code class="hljs language-bash" lang="bash">Starting Claude Agent Demo...
User: 你好
Assistant: 你好！很高兴见到你。我是 Claude，一个 AI 助手。我可以帮你进行计算、回答问题、解决问题等。有什么我可以帮助你的吗？
User: 2454+23546，再平方，再除以 32，等于多少？
Assistant: 我来帮你计算这个问题。
Using tool:  mcp__utilities__calculator  - Input: (2454 + 23546)^2 / 32
Tool Results: 21125000 -
Assistant: 计算结果是：**21,125,000**

让我展示一下计算步骤：
1. 首先：2454 + 23546 = 26000
2. 然后平方：26000² = 676,000,000
3. 最后除以 32：676,000,000 ÷ 32 = 21,125,000
</code></pre>
<p>我们提问了一个数学问题，它把他解析为工具需要的表达式，然后使用了工具，得到了正确结果，完美！</p>
<h2 data-id="heading-6">结尾</h2>
<p>使用 Claude Agent SDK，我们用很少的代码就写了一个简单的 Agent，这个 SDK 应该是学习 Agent 开发起手比较简单的工具了，当然还有很多优秀的 Agent 框架，比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fdocs%2Fai-sdk" target="_blank" title="https://vercel.com/docs/ai-sdk" ref="nofollow noopener noreferrer">Vercel AI SDK</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" target="_blank" title="https://mastra.ai/" ref="nofollow noopener noreferrer">Mastra</a>, 等等，后续也会学习使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gogs迁移到Gitea不完全指南]]></title>    <link>https://juejin.cn/post/7571272874847354932</link>    <guid>https://juejin.cn/post/7571272874847354932</guid>    <pubDate>2025-11-11T16:36:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874847354932" data-draft-id="7571285984089554996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gogs迁移到Gitea不完全指南"/> <meta itemprop="keywords" content="Git,后端"/> <meta itemprop="datePublished" content="2025-11-11T16:36:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tianming2019"/> <meta itemprop="url" content="https://juejin.cn/user/1750078243746087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gogs迁移到Gitea不完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078243746087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tianming2019
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T16:36:01.000Z" title="Tue Nov 11 2025 16:36:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Gogs迁移到Gitea不完全指南</h2>
<p>大家如果有用过<code>Gogs</code>就会发现它已经很久没有啥版本更新了，相比较而言，<code>Gitea</code>的更新频率相对较高一些，社区文档也更完善。但有一点比较头疼的是老旧仓库迁移一是比较琐碎；二则commit activities 等等都消失了，今天就给大家分享一个野路子, 基本思路如下：</p>
<ul>
<li>从gogs 导出数据并解压、提取导出数据中的<code>repositories.zip</code></li>
<li>上传<code>repositories.zip</code>文件到<code>Gitea</code>容器并解压</li>
<li>通过<code>Gitea</code>的管理页面识别并重新关联仓库</li>
</ul>
<p>本文以两者环境均为docker容器为例,主要涉及容器版本：</p>
<ul>
<li>gogs/gogs:latest
<ul>
<li>version: 0.14.0+</li>
<li>sha256: b9b164e0dc299185af6079adde3eed693da55b920887aee92eda19d36030d416</li>
</ul>
</li>
<li>docker.gitea.com/gitea:1.25.1
<ul>
<li>version: 1.25.1</li>
<li>sha256: dbb4b148024bc4462c39332acbdeace8f12cee5646a4e46db75c1d16aa4eaf4b</li>
</ul>
</li>
</ul>
<h3 data-id="heading-1">Gogs数据导出</h3>
<p>进入gogs容器后，默认情况下数据文件在 <code>/data</code>目录下，实际的文件结构如下</p>
<pre><code class="hljs language-plaintext" lang="plaintext">data
├── git
│   └── gogs-repositories
│       ├── gogs
│       │   ├── download.git
│       │   ├── electron-vite-vue.git
│       │   ├── gogs.git
│       └── nobody
├── gogs
│   ├── conf
│   │   └── app.ini
│   ├── custom
│   │   └── conf
│   │       └── app.ini
│   ├── data
│   │   ├── avatars
│   │   │   └── 3
│   │   └── sessions
│   └── log
│       ├── gogs.log
│       ├── gorm.log
│       ├── hooks
│       │   ├── post-receive.log
│       │   ├── pre-receive.log
│       │   ├── update.log
│       │   └── xorm.log
│       └── xorm.log
└── ssh
    ├── ssh_host_dsa_key
    ├── ssh_host_dsa_key.pub
    ├── ssh_host_ecdsa_key
    ├── ssh_host_ecdsa_key.pub
    ├── ssh_host_ed25519_key
    ├── ssh_host_ed25519_key.pub
    ├── ssh_host_rsa_key
    └── ssh_host_rsa_key.pub

43 directories, 18 files
</code></pre>
<p>通过 gogs的 backup 命令进行备份的话默认目录结构如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">gogs-backup
├── custom
│   ├── conf
│   │   └── app.ini
│   ├── custom
│   │   └── conf
│   │       └── app.ini
│   └── log
│       ├── gogs.log
│       ├── gogs.log.2022-11-06
│       ├── gorm.log
│       ├── gorm.log.2022-11-06
│       ├── hooks
│       │   ├── post-receive.log
│       │   ├── pre-receive.log
│       │   ├── update.log
│       │   └── xorm.log
│       ├── xorm.log
│       ├── xorm.log.2022-11-06
├── data
│   └── avatars
│       └── 3
├── db
│   ├── TeamRepo.json
│   ├── TeamUser.json
├── metadata.ini
└── repositories.zip
10 directories, 49 files
</code></pre>
<blockquote>
<p>如果指定了 command options ,则会删减部分内容，大致如下：</p>
<ul>
<li>exclude-mirror-repos 不备份外部仓库</li>
<li>exclude-repos 完全不备份 仓库</li>
<li>database-only 只备份db数据</li>
</ul>
</blockquote>
<pre><code class="hljs language-shell" lang="shell">mkdir -p /backup/file
su git
cd /backup
c94803f5f8bf:/backup$ /app/gogs/gogs backup -v --tempdir ./tmp --target ./file 
<span class="hljs-meta prompt_"># </span><span class="bash">exclude-mirror-repos</span>
<span class="hljs-meta prompt_"># </span><span class="bash">c94803f5f8bf:/backup$ /app/gogs/gogs backup -v --tempdir ./tmp --target ./file --exclude-mirror-repos</span>
</code></pre>
<p>导出文件的命名格式为: <code>gogs-backup-20251111070003.zip</code> ,我们解压文件后可以看到两种备份方式的主要区别是有无ssh密钥配置，建议备份数据后通过此方式再次进行备份，避免数据丢失</p>
<pre><code class="hljs language-shell" lang="shell">cd /backup/file
tar -cf tar_data_20251111.tar /data
</code></pre>
<p>完成备份之后退出容器，并通过 <code>docker cp</code> 复制文件到宿主机即可</p>
<h3 data-id="heading-2">Gitea数据导入</h3>
<p>创建容器后首次进入页面需要配置<code>Gitea</code>,<strong>注册Gitea账号时建议使用gogs的管理员账号,导入数据后可任意添加</strong></p>
<p>通过<code>docker cp</code> 复制<code>gogs-backup-20251111070003.zip</code> 文件中的 <code>repositories.zip</code>
登录gitea容器并切换到<code>/app/gitea</code> 或者 <code>/tmp</code>目录下</p>
<ul>
<li>解压缩<code>repositories.zip</code>文件
<ul>
<li><code>unzip repositories.zip</code></li>
</ul>
</li>
<li>修改文件权限
<ul>
<li><code>chown -R git:git gogs-repositories</code></li>
</ul>
</li>
<li>挪动文件到<code>/data/git/repositories</code>目录
<ul>
<li><strong>一定要确认目录下是否为空，避免覆盖数据</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">通过Gitea管理页面添加仓库</h3>
<ul>
<li>
<p>通过ip或者配置的域名登录管理员账号，按图示进入gitea 仓库管理面板-未收录仓库</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c7f58fb3d0544579348d6f7bae78596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=UwqkwlwTmoS1g2WO6JkCYBaqhak%3D" alt="enter dashboard" loading="lazy"/></p>
</li>
<li>
<p>搜索指定账号(即为<code>repositories.zip</code>下的一级文件夹名称)，逐个添加仓库</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52826e5a22804c6199ed1bcb6ab03a66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=9mKOCXiYMxM%2FGtDBb9TTcw4z32k%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>随意进入其中一个仓库验证</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8429388300a407f9fdae80427860f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=HjQOYRoVRkojJXt9X8ULH0I5fQ8%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>随意下载仓库验证
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f6cf7e8dcd744b9b54dea102e3b1632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGlhbm1pbmcyMDE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763483761&amp;x-signature=LvV%2BudChtGkA2OdXRHTOZKAOQRw%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE AI 真强，连外国人都在用这些AI技巧]]></title>    <link>https://juejin.cn/post/7571342319893741603</link>    <guid>https://juejin.cn/post/7571342319893741603</guid>    <pubDate>2025-11-12T01:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571342319893741603" data-draft-id="7568425510792609792" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE AI 真强，连外国人都在用这些AI技巧"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T01:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE AI 真强，连外国人都在用这些AI技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:50:31.000Z" title="Wed Nov 12 2025 01:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你还在手动敲 <code>for</code> 循环、查 Stack Overflow、部署网站时手抖点错按钮……那你真的该试试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.datacamp.com%2Ftutorial%2Ftrae-ai" target="_blank" title="https://www.datacamp.com/tutorial/trae-ai" ref="nofollow noopener noreferrer"><strong>Trae AI</strong></a> 了。截至 <strong>2025 年 10 月</strong>，它已经登顶 <strong>SWE-bench</strong>（一个用 500 个真实 GitHub Issue 测评 AI 编程能力的权威榜单）第一，而且是唯一一个作为完整 IDE 参赛并夺冠的工具！</p>
<p>下面我们就用<strong>轻松好玩 + 实战截图</strong>的方式，带你快速上手 Trae AI 的那些超实用技巧。</p>
<hr/>
<h2 data-id="heading-0">🧠 Trae AI 是啥？——你的 AI 工程师助理</h2>
<p>Trae 自称 “<strong>The Real AI Engineer</strong>”（真正的 AI 工程师），听起来有点狂？但它确实干了工程师该干的活：</p>
<ul>
<li>听你用自然语言描述需求（比如：“给我写个 4x4 井字棋”）</li>
<li>自动规划代码结构、生成文件、写文档</li>
<li>能联网查资料、调接口、用工具（靠 MCP）</li>
<li>甚至能一键部署网站到 Vercel！</li>
<li>还支持<strong>语音输入</strong>——边喝奶茶边说“加个登录页”，它就干了！</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bab136c723e74fc2a6e27343414f53b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=US4jfRY7vgMuSfhxdeXk0kgRM2g%3D" alt="Trae AI 界面" loading="lazy"/><br/>
<em>👉 界面清爽，左边聊天 + 中间代码 + 下方终端，VS Code 用户秒上手</em></p>
<hr/>
<h2 data-id="heading-1">💰 价格香到离谱：首月只要 3 美元！</h2>
<p>Trae AI 月费 <strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext>（约</mtext><mn>72</mn><mtext>元人民币）</mtext><mo>∗</mo><mo>∗</mo><mtext>，</mtext><mo>∗</mo><mo>∗</mo><mtext>首月只要</mtext></mrow><annotation encoding="application/x-tex">10（约 72 元人民币）**，**首月只要 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">10</span><span class="mord cjk_fallback">（约</span><span class="mord">72</span><span class="mord cjk_fallback">元人民币）</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">，</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∗</span><span class="mord cjk_fallback">首月只要</span></span></span></span></span>3</strong>！对比 Cursor（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mtext>）、</mtext><mi>W</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>s</mi><mi>u</mi><mi>r</mi><mi>f</mi><mtext>（</mtext></mrow><annotation encoding="application/x-tex">20）、Windsurf（</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">20</span><span class="mord cjk_fallback">）、</span><span class="mord mathnormal">Win</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord cjk_fallback">（</span></span></span></span></span>15+），简直白菜价！</p>
<p>你还会获得：</p>
<ul>
<li><strong>600 次“快请求”</strong>（用 Claude 4 Sonnet、Gemini 2.5 Pro 等顶级模型）</li>
<li><strong>无限次“慢请求”</strong>（适合不着急的任务）</li>
</ul>
<blockquote>
<p>⚠️ 小提醒：它的“请求计数”是按“次数”而非“token 数”，复杂任务和简单修改算一样的次数——这模式可能撑不久，<strong>趁便宜快上车</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🛠️ 实战技巧 1：用 Builder 写个彩色井字棋游戏</h2>
<p>我们来试试它的核心功能：<strong>Builder 模式</strong>。</p>
<p>在空白项目里输入：</p>
<pre><code class="hljs language-text" lang="text">我想用 Python 做一个 4x4 的井字棋终端游戏，支持两人轮流下棋，
能判断行、列、对角线获胜，还要支持平局。
界面要有颜色，但别太花，简洁清新就好。
</code></pre>
<p><strong>结果？99% 完美！</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d570cd4dda7343778386f2df5461170a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=KJEAzc9cnEN0njQhbUnIebl6zAc%3D" alt="Trae 生成的彩色井字棋" loading="lazy"/></p>
<p>它不仅写了代码，还：</p>
<ul>
<li>自动生成 <code>README.md</code></li>
<li>自动运行 <code>python tictactoe.py</code> 测试</li>
<li>用了 <code>colorama</code> 库实现彩色输出</li>
<li>逻辑完全正确，连边界情况都处理了！</li>
</ul>
<hr/>
<h2 data-id="heading-3">🔍 实战技巧 2：内置浏览器 + 联网搜索，不用切窗口！</h2>
<p>以前写代码时，总得在 IDE 和 Chrome 之间来回跳。Trae 直接在聊天框里<strong>内置网页搜索</strong>！</p>
<p>试试输入：</p>
<pre><code class="hljs language-text" lang="text">搜一下别人是怎么做井字棋游戏的？有没有加 AI 对战或 undo 功能？
</code></pre>
<p>它会自动联网，整理出结构化结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0796981af6704dd0abd129e416a6b3e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=EAlwObpOxoKw57z2uXmlwNtRDk4%3D" alt="Trae 内置搜索结果" loading="lazy"/></p>
<p>你可以直接让它：“根据这个加个‘悔棋’功能”，它马上改代码！</p>
<hr/>
<h2 data-id="heading-4">📋 实战技巧 3：用 <code>#</code> 和 <code>@</code> 精准控制上下文</h2>
<ul>
<li><code>#filename.py</code> → 把这个文件内容喂给 AI</li>
<li><code>#rulename</code> → 引用你写的规则文件（比如 <code>#design_philosophy</code>）</li>
<li><code>@DocAgent</code> → 切换到“文档专用 AI 助手”</li>
</ul>
<p>你甚至可以创建自己的规则文件，比如 <code>.trae/rules/architecture.md</code>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目必须用 Flask，前端用 HTMX，不许用 React。</span>
所有 API 返回 JSON，状态码要规范。
</code></pre>
<p>下次你写后端时，只要说 <code>#architecture</code>，AI 就自动遵守！</p>
<hr/>
<h2 data-id="heading-5">🧩 实战技巧 4：用 MCP 连数据库、API、Git……</h2>
<p><strong>MCP（Model Context Protocol）</strong> 是 Trae 的“外挂插件系统”。比如：</p>
<ul>
<li>连 PostgreSQL 查表结构</li>
<li>调公司内部 API 自动生成 SDK</li>
<li>读取 Jira 工单自动写代码</li>
</ul>
<p>它还有个 <strong>MCP 市场</strong>，一键安装常用工具：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e710c1ded024714b601351468d1d99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=LsThH5ZGjH5HCFTqKHVFTSbgCmY%3D" alt="MCP 市场" loading="lazy"/></p>
<p>装完后，切换到 <strong>“Builder with MCP”</strong> 模式，AI 就能“操作真实世界”了！</p>
<hr/>
<h2 data-id="heading-6">🤖 隐藏大招：自定义 AI 代理（Custom Agents）</h2>
<p>不想每次都解释“要写类型注解 + Google 风格 docstring”？<br/>
那就造一个专属 AI：</p>
<ul>
<li>叫它 <strong>@CodeReviewer</strong>：专找 bug、安全漏洞、性能问题</li>
<li>叫它 <strong>@FrontendGuru</strong>：只写 Tailwind + Vue，拒绝 jQuery</li>
</ul>
<p>创建后，在聊天框顶部下拉选择，或直接 <code>@FrontendGuru 做个登录页</code>，它就按你的规矩干活！</p>
<hr/>
<h2 data-id="heading-7">🚀 终极黑科技：SOLO 模式</h2>
<p>SOLO 模式才是 Trae 的“王炸”：你只说“我要做个待办清单网站”，它会：</p>
<ol>
<li>自动规划技术栈（Flask + SQLite + HTMX）</li>
<li>生成所有文件 + 测试用例</li>
<li>写好 README 和部署文档</li>
<li><strong>一键部署到 Vercel</strong></li>
<li>浏览器里直接预览！</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e98fb130d0149e2bc19722721940404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763517031&amp;x-signature=9ILqk8cVwqgzg6ru60mi%2BJaksjk%3D" alt="SOLO 模式" loading="lazy"/></p>
<blockquote>
<p>❗ 目前 SOLO 仅限邀请用户，连付费用户都未必能用。但<strong>首月 $3 的机会成本太低</strong>，值得一试！</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">🆚 Trae vs Cursor：谁更香？</h2>













































<table><thead><tr><th>功能</th><th>Trae AI</th><th>Cursor</th></tr></thead><tbody><tr><td>价格</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mtext>（首月</mtext></mrow><annotation encoding="application/x-tex">10（首月 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">10</span><span class="mord cjk_fallback">（首月</span></span></span></span></span>3）</td><td>$20</td></tr><tr><td>自定义代理</td><td>✅</td><td>❌</td></tr><tr><td>一键部署</td><td>✅（Vercel）</td><td>❌</td></tr><tr><td>内置浏览器</td><td>✅</td><td>❌</td></tr><tr><td>背景运行</td><td>❌</td><td>✅</td></tr><tr><td>移动端/Slack</td><td>❌</td><td>✅</td></tr><tr><td>界面颜值</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr></tbody></table>
<p><strong>结论</strong>：如果你想要<strong>新潮、便宜、功能强</strong>的 AI IDE，Trae 是当前性价比之王！</p>
<hr/>
<p><strong>彩蛋</strong>：Trae 还支持从 VS Code / Cursor <strong>一键导入设置</strong>，迁移成本几乎为零！</p>
<p>快去试试吧，说不定你的下一个项目，就是 AI 和你一起“结对编程”完成的 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ubuntu24.02安装python库以及部署python项目]]></title>    <link>https://juejin.cn/post/7571334572768935979</link>    <guid>https://juejin.cn/post/7571334572768935979</guid>    <pubDate>2025-11-12T00:57:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571334572768935979" data-draft-id="7571306072422924330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ubuntu24.02安装python库以及部署python项目"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-12T00:57:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ubuntu24.02安装python库以及部署python项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:57:05.000Z" title="Wed Nov 12 2025 00:57:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. 问题引入</h2>
<p>在服务器的系统镜像换到最新的Ubuntu24.02后，原先的python安装机制发生了改变，之前的pip安装的方式变得不可用。</p>
<h2 data-id="heading-1">二. 问题及解决记录</h2>
<h3 data-id="heading-2">1.  python指令不可用</h3>
<p>执行python指令报错:</p>
<pre><code class="hljs language-bash" lang="bash">python --version
    Command <span class="hljs-string">'python'</span> not found, did you mean:
    <span class="hljs-built_in">command</span> <span class="hljs-string">'python3'</span> from deb python3
    <span class="hljs-built_in">command</span> <span class="hljs-string">'python'</span> from deb python-is-python3
</code></pre>
<p>原因:Ubuntu24.02自带python3
解决方法: <code>python3 --version</code></p>
<h3 data-id="heading-3">2. 未安装pip</h3>
<p>执行pip指令报错未安装:</p>
<pre><code class="hljs language-bash" lang="bash">pip list packages
Command <span class="hljs-string">'pip'</span> not found, but can be installed with:
sudo apt install python3-pip
</code></pre>
<p>原因:未安装pip
解决方法:</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt install python-pip
</code></pre>
<h3 data-id="heading-4">3. 部署python项目</h3>
<p><strong>在较新的 Ubuntu 版本中，系统 Python 环境被标记为"外部管理环境"，不再支持直接使用pip安装卸载python库，这是为了保护系统完整性。</strong></p>
<h4 data-id="heading-5">方法1，使用apt install 安装相应的python库(不推荐)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查是否有 FastAPI 的包</span>
apt search fastapi
sudo apt install python3-venv
sudo apt install python3-pip
</code></pre>
<h4 data-id="heading-6">方法2. 使用虚拟环境安装相应的python库(推荐)</h4>
<p><strong>推荐使用方案2.（虚拟环境）</strong> ，这是 Python 开发的最佳实践，可以避免包冲突和系统环境污染。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装虚拟环境工具</span>
sudo apt install python3.12-venv

<span class="hljs-comment"># 创建虚拟环境</span>
python3 -m venv myenv

<span class="hljs-comment"># 激活虚拟环境</span>
<span class="hljs-built_in">source</span> myenv/bin/activate

<span class="hljs-comment"># 在虚拟环境中安装 FastAPI</span>
pip install fastapi uvicorn

<span class="hljs-comment"># 使用完成后退出虚拟环境</span>
<span class="hljs-comment"># deactivate</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>