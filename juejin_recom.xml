<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[IntentService和JobIntentService解析]]></title>    <link>https://juejin.cn/post/7600704706550513704</link>    <guid>https://juejin.cn/post/7600704706550513704</guid>    <pubDate>2026-01-30T02:53:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706550513704" data-draft-id="7600670417858281506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IntentService和JobIntentService解析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T02:53:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IntentService和JobIntentService解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:53:35.000Z" title="Fri Jan 30 2026 02:53:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.IntentService</h3>
<p>(1).介绍Service
Android中的Service是用于后台服务的，当应用程序被挂起到后台或者启动Service的Activity被销毁时，为了保证应用某些组件仍然可以工作而引入了Service这个概念，但是Service既不是独立的进程，也不是独立的线程，它是依赖于应用程序的主线程的，在大部分时候不建议在Service中编写耗时的逻辑和操作，否则会引起ANR。（阻塞主线程5s，会导致ANR）
(2).IntentService||JobIntentService应用场景
如果我们编写的耗时逻辑，不得不被service来管理的时候，就需要使用IntentService，IntentService是继承Service的，那么它包含了Service的所有特性，当然也包含service的生命周期，那么与service不同的是，IntentService在执行onCreate操作的时候，内部开了一个线程，去你执行你的耗时操作。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> void onHandleIntent(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent);
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
        public <span class="hljs-type">ServiceHandler</span>(<span class="hljs-type">Looper</span> looper) {
            <span class="hljs-keyword">super</span>(looper);
        }

        <span class="hljs-meta">@Override</span>
        public void handleMessage(<span class="hljs-type">Message</span> msg) {
            onHandleIntent((<span class="hljs-type">Intent</span>)msg.obj); <span class="hljs-comment">//运行在子线程中</span>
            stopSelf(msg.arg1);
        }
    }
   public void onCreate() {
        <span class="hljs-keyword">super</span>.onCreate();
        <span class="hljs-type">HandlerThread</span> thread = <span class="hljs-keyword">new</span> <span class="hljs-type">HandlerThread</span>(<span class="hljs-string">"IntentService["</span> + mName + <span class="hljs-string">"]"</span>);
        thread.start();
        mServiceLooper = thread.getLooper();
        mServiceHandler = <span class="hljs-keyword">new</span> <span class="hljs-type">ServiceHandler</span>(mServiceLooper);
    }
   <span class="hljs-meta">@Override</span>
    public void onStart(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent, int startId) {
        <span class="hljs-type">Message</span> msg = mServiceHandler.obtainMessage();
        msg.arg1 = startId;
        msg.obj = intent;
        mServiceHandler.sendMessage(msg);
    }
}
</code></pre>
<p>(3).继承抽象类IntentService，然后实现handleIntent方法即可.</p>
<pre><code class="hljs language-scala" lang="scala">public  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IntentService</span> </span>{
    public <span class="hljs-type">TestService</span>(<span class="hljs-type">String</span> name) {
        <span class="hljs-keyword">super</span>(name);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onHandleIntent(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent) {
    }
}
</code></pre>
<p>(4).HandleThread实现
继承了Thread，Looper.prepare()将当前线程和Looper对象存储到ThreadLocalMap中，然后提供getLooper方法。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HandlerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>{
    public void run(){
      <span class="hljs-type">Looper</span>.prepare();
        synchronized (<span class="hljs-keyword">this</span>) {
            mLooper = <span class="hljs-type">Looper</span>.myLooper();
            notifyAll();
        }
    }
   public <span class="hljs-type">Looper</span> getLooper() {
      <span class="hljs-keyword">return</span> mLooper;
   }
}
</code></pre>
<h3 data-id="heading-1">2.JobIntentService</h3>
<p>(1).通过内部的AysncTask来处理耗时操作</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JobIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>{
     <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> void onHandleWork(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Intent</span> intent);
      public int onStartCommand(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent, int flags, int startId) {
          ensureProcessorRunningLocked(<span class="hljs-literal">true</span>);
     }
     void ensureProcessorRunningLocked(boolean reportStarted) {
        <span class="hljs-keyword">if</span> (mCurProcessor == <span class="hljs-literal">null</span>) {
            mCurProcessor = <span class="hljs-keyword">new</span> <span class="hljs-type">CommandProcessor</span>();
            <span class="hljs-keyword">if</span> (mCompatWorkEnqueuer != <span class="hljs-literal">null</span> &amp;&amp; reportStarted) {
                mCompatWorkEnqueuer.serviceProcessingStarted();
            }
            mCurProcessor.executeOnExecutor(<span class="hljs-type">AsyncTask</span>.<span class="hljs-type">THREAD_POOL_EXECUTOR</span>);
       }
    }
   <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AsyncTask&lt;Void</span>, <span class="hljs-title">Void</span>, <span class="hljs-title">Void&gt;</span> </span>{
        <span class="hljs-keyword">protected</span> <span class="hljs-type">Void</span> doInBackground(<span class="hljs-type">Void</span>... params) {
            <span class="hljs-type">GenericWorkItem</span> work;

            <span class="hljs-keyword">if</span> (<span class="hljs-type">DEBUG</span>) <span class="hljs-type">Log</span>.d(<span class="hljs-type">TAG</span>, <span class="hljs-string">"Starting to dequeue work..."</span>);

            <span class="hljs-keyword">while</span> ((work = dequeueWork()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (<span class="hljs-type">DEBUG</span>) <span class="hljs-type">Log</span>.d(<span class="hljs-type">TAG</span>, <span class="hljs-string">"Processing next work: "</span> + work);
                 onHandleWork(work.getIntent());<span class="hljs-comment">//回调onHandlerWork方法</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-type">DEBUG</span>) <span class="hljs-type">Log</span>.d(<span class="hljs-type">TAG</span>, <span class="hljs-string">"Completing work: "</span> + work);
                work.complete();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> void onPostExecute(<span class="hljs-type">Void</span> aVoid) {
            processorFinished();
        }
    }
}

</code></pre>
<p>(2).使用继承抽象类JobIntentService，实现onHandleWork来处理耗时操作</p>
<pre><code class="hljs language-scala" lang="scala">public  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JobIntentService</span> </span>{
    <span class="hljs-meta">@Override</span> 
    <span class="hljs-keyword">protected</span> void onHandleWork(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Intent</span> intent) { 
        <span class="hljs-comment">//在AsyncTask启动的异步线程中执行</span>
    }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin核心基础之高阶函数，协程基本用法]]></title>    <link>https://juejin.cn/post/7600670487409344564</link>    <guid>https://juejin.cn/post/7600670487409344564</guid>    <pubDate>2026-01-30T02:59:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487409344564" data-draft-id="7600681071714304000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin核心基础之高阶函数，协程基本用法"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T02:59:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin核心基础之高阶函数，协程基本用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:59:14.000Z" title="Fri Jan 30 2026 02:59:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fmaoning20080808%2Farticle%2Fdetails%2F143663152" target="_blank" title="https://blog.csdn.net/maoning20080808/article/details/143663152" ref="nofollow noopener noreferrer">kotlin-协程基本操作_kotlin mainscope-CSDN博客</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Flaiqun789%2Farticle%2Fdetails%2F133937972" target="_blank" title="https://blog.csdn.net/laiqun789/article/details/133937972" ref="nofollow noopener noreferrer">怎么理解kotlin的挂起函数？</a>
<a href="https://juejin.cn/post/7121132393922035720?searchId=202412231443022336D913A7863105656C" target="_blank" title="https://juejin.cn/post/7121132393922035720?searchId=202412231443022336D913A7863105656C">Kotlin协程进阶使用</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3ODY2MzU2MQ%3D%3D%26mid%3D2247490102%26idx%3D6%26sn%3D501c2975d1595ab021b750bd39f409bc%26chksm%3Dcf1118d0f86691c64ea7e86071d4fd02748a7efbad4513a1709aff141ca3bbc3ce45fc6f20de%26token%3D1436311520%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3ODY2MzU2MQ==&amp;mid=2247490102&amp;idx=6&amp;sn=501c2975d1595ab021b750bd39f409bc&amp;chksm=cf1118d0f86691c64ea7e86071d4fd02748a7efbad4513a1709aff141ca3bbc3ce45fc6f20de&amp;token=1436311520&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">Kotlin协程在工作中有用过吗？ (qq.com)</a></p>
<h3 data-id="heading-0">1.kotlin和java编译后都是java字节码，相对于java有啥优势和劣势？</h3>
<p>(1).kotlin优势</p>
<ul>
<li>
<p>代码简洁，开发效率更高
不用使用findViewById，支减少冗余代码，支持空安全，扩展函数，属性，高阶函数和lambda表达式，内联函数。</p>
</li>
<li>
<p>内存消耗更少
由于空安全特性和内联函数优化，它能够生成更高效的字节码，从而减少内存的使用。kotlin协程提供了一中轻量级的并发处理方式，可以进一步降低内存的占用。</p>
</li>
<li>
<p>kotlin是未来Android开发主流的语言，一些Android的新特性，新组件都会优先支持kotlin版本。</p>
</li>
</ul>
<p>(2).kotlin劣势
kotlin编译速度相对java较慢，因为她需要进行额外的类型检查（空安全），和代码转换（kotlin-java-java字节码，复杂，耗性能）</p>
<p>备注：Kotlin与Java在运行时性能方面基本相当，由于kotlin支持inline函数，lambda表达式，在某些情况下性能还要由于java.</p>
<h3 data-id="heading-1">2.Kotlin内置的高阶函数run的原理是什么，与let函数有啥区别？</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">(<span class="hljs-number">1</span>).<span class="hljs-keyword">inline</span> :表示这是一个内联函数，将函数代码直接插入调用处，避免了调用普通方法时，栈帧的创建，销毁所带来的开销。
(<span class="hljs-number">2</span>).&lt;T,R&gt; T.run :T代表要为T扩展出一个名为run的函数，R表示lambda表达式最后一行返回的类型。
(<span class="hljs-number">3</span>).block:T.()-&gt;R:
block：表示lambda的名称
T.():表示输入参数是T本身，让lambda表达式持有了<span class="hljs-keyword">this</span>表示(T)调用者本身
R:表示lambda最后一行返回的类型.
(T) :表示输入参数是T本身，让lambda表达式持有了it表示(T)调用者本身

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span><span class="hljs-type">&lt;T,R&gt;</span> T.<span class="hljs-title">let</span><span class="hljs-params">(block:(<span class="hljs-type">T</span>)-&gt;<span class="hljs-type">R</span>)</span></span>{
    <span class="hljs-keyword">return</span> block(<span class="hljs-keyword">this</span>)
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span><span class="hljs-type">&lt;T,R&gt;</span> T.<span class="hljs-title">run</span><span class="hljs-params">(block:<span class="hljs-type">T</span>.()-&gt;<span class="hljs-type">R</span>)</span></span>:R{
      <span class="hljs-keyword">return</span> block()
}
<span class="hljs-comment">//with不是泛型的扩展方法，而是全局方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> <span class="hljs-title">with</span><span class="hljs-params">(receiver: <span class="hljs-type">T</span>, block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">R</span>)</span></span>: R {
    <span class="hljs-keyword">return</span> receiver.block()
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">also</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T {
    block(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T {
    block()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}



<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
   <span class="hljs-keyword">var</span>  result1=<span class="hljs-string">"778"</span>.run{  
         <span class="hljs-literal">true</span>
        length
    }
   println(result1)   <span class="hljs-comment">//3</span>
  <span class="hljs-keyword">var</span> result2=<span class="hljs-string">"778"</span>.let{
         <span class="hljs-number">999</span>
         <span class="hljs-string">"<span class="hljs-variable">$it</span>"</span> <span class="hljs-comment">//778</span>
  }
}
</code></pre>
<p>为啥所有的类型都可以使用run或者let，那是因为高阶函数let和run是对泛型进行扩展，意味着所有类型都等于泛型，所以任何地方都可以使用.run和let的区别在于lambda表达式一个持有this表示调用者本身，一个持有it表示调用者本身。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> inline &lt;T&gt; T.<span class="hljs-title function_ invoke__">apply</span>(<span class="hljs-attr">block</span>:T.()-&gt;unit):T
<span class="hljs-keyword">public</span> inline &lt;T&gt; T.<span class="hljs-title function_ invoke__">also</span>(<span class="hljs-attr">block</span>:(T)-&gt;unit):T
<span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> &lt;T,R&gt; <span class="hljs-title function_ invoke__">with</span>(<span class="hljs-attr">receiver</span>:T,<span class="hljs-attr">block</span>:T.()-&gt;R):R
</code></pre>
<h3 data-id="heading-2">3.kotlin语言泛型的形变是什么？【PECS原则 extends out || super in】</h3>
<ul>
<li>不变：指的是此泛型既可以是消费者，可以是生产者，没有任何继承相关的概念.</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>&lt;<span class="hljs-title">T</span>&gt; {}   
</code></pre>
<ul>
<li>协变 ： 指的是此泛型只能是生产者 ，泛型类型只能是T或者T的子类，只能get数据，无法add数据.</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">ArrayList&lt;<span class="hljs-keyword">out</span> T&gt;            
</code></pre>
<ul>
<li>逆变：指的是此泛型只能是消费者，泛型类型只能是T类型，或者T的父类，只能add数据，无法get【如果get数据，数据类型只能是Object】</li>
</ul>

<pre><code class="hljs language-r" lang="r">ArrayList<span class="hljs-operator">&lt;</span><span class="hljs-keyword">in</span> <span class="hljs-built_in">T</span><span class="hljs-operator">&gt;</span>     
</code></pre>
<h3 data-id="heading-3">4.协程的基本使用.</h3>
<p>#####(1).启动协程的几种方式.</p>
<ul>
<li>launch{}  CoroutineScope接口的扩展方法，启动一个携程，不阻塞当前线程，返回一个Job对象协程.</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">launch</span><span class="hljs-params">(
     context:<span class="hljs-type">CoroutineScope</span>=EmptyCoroutineContext,
     start:<span class="hljs-type">CoroutineStart</span> = CoroutineStart.DEFAULT,
     block:<span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.()-&gt;<span class="hljs-type">Unit</span>
)</span></span>:Job {  <span class="hljs-comment">//Job是返回值， {} 是launch的方法体实现 【不要搞混淆了】</span>
 <span class="hljs-comment">//launch方法体实现，返回Job对象</span>
      <span class="hljs-keyword">val</span> newcontenxt=newCoroutineContext(context)
     <span class="hljs-keyword">val</span> coroutine=<span class="hljs-keyword">if</span>(start.isLazy){
          LazyStandaloneCoroutine(newContext,block);<span class="hljs-comment">//实现了job接口</span>
     }<span class="hljs-keyword">else</span>{
        StandaloneCoroutine(newContext,active=<span class="hljs-literal">true</span>)  <span class="hljs-comment">//实现了job接口</span>
    }
     coroutine.start(start,coroutine,block)  <span class="hljs-comment">//启动job</span>
    <span class="hljs-keyword">return</span>  coroutine；<span class="hljs-comment">//返回实现了Job接口的协程对象</span>
}
</code></pre>
<p>Job.cancel()可以用来取消协程，控制协程的生命周期.</p>
<ul>
<li>async{} CoroutienScope接口的扩展方法，启动一个协程，不阻塞当前线程，返回一个Deferred类，可以通过wait获取T对象.</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> CoroutineScope.<span class="hljs-title">async</span><span class="hljs-params">(
    context: <span class="hljs-type">CoroutineContext</span> = EmptyCoroutineContext,
    start: <span class="hljs-type">CoroutineStart</span> = CoroutineStart.DEFAULT,
    block: <span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.() -&gt; <span class="hljs-type">T</span>
)</span></span>: Deferred&lt;T&gt; {
    <span class="hljs-keyword">val</span> newContext = newCoroutineContext(context)
    <span class="hljs-keyword">val</span> coroutine= <span class="hljs-keyword">if</span> (start.isLazy){
        LazyDeferredCoroutine&lt;T&gt;(newContext, block)  <span class="hljs-comment">//实现了Deferred接口</span>
    } <span class="hljs-keyword">else</span>{
       DeferredCoroutine&lt;T&gt;(newContext, active = <span class="hljs-literal">true</span>) <span class="hljs-comment">//实现了Deferred接口</span>
    }
    coroutine.start(start, coroutine, block)   <span class="hljs-comment">//启动协程</span>
    <span class="hljs-keyword">return</span> coroutine <span class="hljs-comment">//返回实现了Deferred接口的协程对象</span>
}
</code></pre>
<ul>
<li>runBlocking{}  全局方法,创建并启动协程,返回值是lambda表达式block的最后一行的返回值.(Unit或者其他具体类型)</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">public fun &lt;T&gt; <span class="hljs-built_in">runBlocking</span>(context: CoroutineContext = EmptyCoroutineContext, block: suspend CoroutineScope.() -&gt; T): T {
    val currentThread = Thread<span class="hljs-selector-class">.currentThread</span>()
    val contextInterceptor = context<span class="hljs-selector-attr">[ContinuationInterceptor]</span>
    val eventLoop: EventLoop?
    val newContext: CoroutineContext
    if (contextInterceptor == null) {
        eventLoop = ThreadLocalEventLoop<span class="hljs-selector-class">.eventLoop</span>
        newContext = GlobalScope<span class="hljs-selector-class">.newCoroutineContext</span>(context + eventLoop)
    } else {
        eventLoop = (contextInterceptor as? EventLoop)?<span class="hljs-selector-class">.takeIf</span> { it<span class="hljs-selector-class">.shouldBeProcessedFromContext</span>() }
            ?: ThreadLocalEventLoop.<span class="hljs-built_in">currentOrNull</span>()
        newContext = GlobalScope.<span class="hljs-built_in">newCoroutineContext</span>(context)
    }
    val coroutine = BlockingCoroutine&lt;T&gt;(newContext, currentThread, eventLoop)
    coroutine<span class="hljs-selector-class">.start</span>(CoroutineStart.DEFAULT, coroutine, block)
    return coroutine<span class="hljs-selector-class">.joinBlocking</span>()
}
<span class="hljs-comment">//这一段代码会阻塞主线程，直接导致黑屏。</span>
runBlocking {
     <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>)
 }
<span class="hljs-comment">//即使指定启动的协程运行在IO线程，也会阻塞主线程，导致黑屏</span>
<span class="hljs-built_in">runBlocking</span>(Dispatchers.IO) {
   <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>L)
}
<span class="hljs-comment">//依然会阻塞主线程导致黑屏</span>
 GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.Main){
       runBlocking {
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>)
        }

 }
<span class="hljs-comment">//不会阻塞主线程</span>
 GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.IO){
       runBlocking {
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>)
        }
 }
</code></pre>
<h5 data-id="heading-4">(2).withContext() suspend修饰，并不会启动协程，返回结果是lambda表达式最后一行的返回值，只能在suspend挂起方法或者协程中调用，用于切换线程，并挂起协程。（暂停协程，但是执行协程的线程可以继续执行其他任务，不会阻塞，等到协程恢复，该线程可以继续执行）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">withContext</span><span class="hljs-params">(
    context: <span class="hljs-type">CoroutineContext</span>,
    block: <span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.() -&gt; <span class="hljs-type">T</span>
)</span></span>: T
   
 lifecycleScope.launch(Dispatchers.IO) {
            delay(<span class="hljs-number">1000</span>)
            withContext(Dispatchers.Main){ <span class="hljs-comment">//返回值是Unit 也就是void  //切换到主线程 ，此时协程的IO线程可以去执行其他任务</span>
                println(<span class="hljs-string">"Test001:withContext:<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
            }
        }
</code></pre>
<h5 data-id="heading-5">(3).coroutineScope()  suspend修饰，并不会启动协程，只能在suspend挂起方法或者协程中调用，创建一个新的协程作用域【或者说可以在已有的协程内部创建一个新协程】</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">coroutineScope</span><span class="hljs-params">(block: <span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.() -&gt; <span class="hljs-type">R</span>)</span></span>: R =
    suspendCoroutineUninterceptedOrReturn { uCont -&gt;
        <span class="hljs-keyword">val</span> coroutine = ScopeCoroutine(uCont.context, uCont)
        coroutine.startUndispatchedOrReturn(coroutine, block)
 }


coroutineScope {  }  <span class="hljs-comment">//报错 ，不能直接用，只能在协程里面使用</span>

runBlocking { <span class="hljs-comment">//非suspend全局方法，直接启动协程</span>
   coroutineScope {  }   <span class="hljs-comment">//正常使用，因为runBlocking创建了协程//创建一个新的协程作用域</span>
  delay(<span class="hljs-number">1000L</span>) 
}
</code></pre>
<p>(4).协程上下文，一般用调度器Dispatchers来切换线程，它是CoroutineContext接口的实现类.</p>
<ul>
<li>Dispatchers.Main    协程代码执行在Android主线程</li>
<li>Dispatchers.Unconfined  不限制协程代码执行在哪个线程【主线程或者其他空闲线程】</li>
<li>Dispatcher.Default        JVM共享线程池分配线程执行协程代码</li>
<li>Dispatcher.IO                IO线程池分配线程执行协程代码</li>
</ul>
<h5 data-id="heading-6">注意：await() 只有在 async 未执行完成返回结果时，才会挂起协程。若 async 已经有结果了，await() 则直接获取其结果并赋值给变量，此时不会挂起协程。</h5>
<h3 data-id="heading-7">5.协程的挂起和阻塞</h3>
<h5 data-id="heading-8">(1).suspend非阻塞式挂起函数</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76b28b70e00d4649847e770a05e5824e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=oyzhpOzmyb9WVYkF1G%2F5FgSRySs%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">fun <span class="hljs-built_in">testCoroutineInActivity</span>() {
       GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.Main) { <span class="hljs-comment">//1.启动协程1</span>
           <span class="hljs-built_in">println</span>("Test001:执行在协程中...")
           GlobalScope<span class="hljs-selector-class">.launch</span> (Dispatchers.IO){<span class="hljs-comment">//2.启动协程2</span>
               <span class="hljs-built_in">println</span>("Test001:异步执行result1")
               <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>)   
               <span class="hljs-built_in">println</span>("Test001:result1:<span class="hljs-number">1234</span>")
           }
           GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.IO) {<span class="hljs-comment">//3.启动协程3</span>
               <span class="hljs-built_in">println</span>("Test001:异步执行result2.")
               <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>) 
               <span class="hljs-built_in">println</span>("Test001:result2:<span class="hljs-number">123456</span>")
           }
           <span class="hljs-built_in">println</span>("Test001:执行完毕...")
       }
}
</code></pre>
<h5 data-id="heading-9">注意：协程2和协程3中的delay函数只是挂起了协程2和协程3，不会影响协程1中的主线程的执行.</h5>
<p>执行结果如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d78c31c310b4077bcb1b73d635494ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=gr05XSakSSnACaJNzofeEGQZVP8%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-10">(2).协程都被挂起了，那么挂起函数的函数体由谁执行呢？</h5>
<p>当协程执行到挂起函数式，协程的执行会被暂停（即协程被挂起），但它并不会阻塞执行该挂起函数的线程，挂起函数的函数体任然由当前线程继续执行。
为了更清楚的解释这一点，我们可以使用一下步骤：
(1).协程启动:当一个协程开始运行时，它会在某个线程(Dispatchers.Main)上执行。
(2).遇到挂起函数：当协程遇到挂起函数时，协程的执行会被暂停。
(3).挂起函数执行：尽管协程被暂停了，挂起函数的函数体任然会在原始线程上执行。（除非该挂起函数明确指定了其他的执行上下文）
(4).挂起函数完成：一旦挂起函数完成其工作，它会通知协程库，然后协程会恢复执行。
注意：当协程被挂起时，主线程并没有被阻塞，而是可以执行其他的任务，等到挂起函数执行完毕，协程恢复时，又可以在主线程中继续执行。
总结一下：在协程中使用挂起函数时，任何可能得"阻塞"操作都会转移到其他线程上执行，这样启动协程的原始线程(例如主线程)就不会被实际阻塞，这样使得协程特别适合UI线程编程，因为它可以确保UI线程保持响应。</p>
<h3 data-id="heading-11">6.kotlin协程在工作中有用过吗？</h3>
<p>kotlin协程是一个线程框架，提供了一种轻量级的并发处理方式，通过非阻塞挂起和恢复实现了用同步代码的方式编写异步代码，把原本运行在不同线程的代码写在一个代码块{}里面，看起来就像是同步代码。
协程的目的是，简化复杂的异步代码逻辑，用同步的代码编写方式实现复杂异步代码逻辑。</p>
<h5 data-id="heading-12">(1).几种封装好的协程</h5>
<ul>
<li>
<p>CoroutineScope(Dispatchers.IO)构造函数启动协程 ,通过Dispatchers指定运行的线程。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfa01d72f3eb4ddb88db3dc626c0937b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=sg53wvH15hdT1EVqI2wMQ0CYCsE%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>GlobalScope启动协程（默认不是主线程，是一个静态单例，和应用的生命周期相同,一般不使用，容易导致内存泄漏）</p>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span> GlobalScope : CoroutineScope {
    <span class="hljs-keyword">override</span> val coroutineContext: <span class="hljs-function">CoroutineContext
        <span class="hljs-title">get</span>()</span> = EmptyCoroutineContext
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31634d42d8e446d8bc75cc8214db254b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=qoEK5QpmoD232cT6o9KqElgV3iA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>MainScope()启动协程（默认运行在主线程，是Activity或者Fragment中的一个成员变量，Activity或者Fragment销毁时，就会销毁）</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainScope</span><span class="hljs-params">()</span></span>: CoroutineScope = ContextScope(SupervisorJob() + Dispatchers.Main)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea75a5c3eead4067a5e5c7d37f6ae6d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=sihutifPfrNg9QXsJkWhfhNekBA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>viewModelScope启动协程(默认运行在主线程，生命周期和ViewModel绑定)</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> ViewModel.viewModelScope: CoroutineScope
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> scope: CoroutineScope? = <span class="hljs-keyword">this</span>.getTag(JOB_KEY)
            <span class="hljs-keyword">if</span> (scope != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> scope
            }
            <span class="hljs-keyword">return</span> setTagIfAbsent(JOB_KEY,
                CloseableCoroutineScope(SupervisorJob() + Dispatchers.Main.immediate))
        }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c073ed644fe49b59b303914de472977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=XRxcQPnhjiZcsBWvLDP5CQRzk0E%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>lifecycleScope启动协程(默认运行在主线程,生命周期和Activity或者Fragment绑定,实现了LifeycleOwner接口)</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">val LifecycleOwner.lifecycleScope: <span class="hljs-function">LifecycleCoroutineScope
    <span class="hljs-title">get</span>()</span> = lifecycle.coroutineScope

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/058235a96f56441999113e0d3b2dc280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=ZitxQT6q6Knbq3QMeo6ObbC66iQ%3D" alt="image.png" loading="lazy"/></p>
<p>协程就是一个线程框架，是对线程的封装，提供了一种轻量并发的处理方式，通过非阻塞式挂起和恢复的方式，用同步代码的方编写式实现复杂的异步代码逻辑，把原本运行在不同线程的代码写在一个代码块里面，看起来就像同步代码。</p>
<h5 data-id="heading-13">(2).如果一个页面需要同时并发请求多个接口，当所有的接口都请求完成需要做一些合并处理，然后更新UI，如何并发处理呢？</h5>
<ul>
<li>
<p>方法一：为每个接口设置一个boolean值，每当接口请求成功，boolean值设置为true,当最后一个接口请求成功后，在更新UI，这样就达到了并发的目的 【管理多个boolean值，不够优雅，太累了】</p>
</li>
<li>
<p>方法二：RXjava的zip操作符【达到发射一次，将结果合并处理的目的】</p>
</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin">   <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testRxjavaZip</span><span class="hljs-params">()</span></span>{
        println(<span class="hljs-string">"-------------"</span>)
        <span class="hljs-keyword">val</span> observable1: Observable&lt;HttpResult&lt;List&lt;Banner&gt;&gt;&gt; = HttpRetrofit.apiService.getBanners().subscribeOn(Schedulers.io()).observeOn(
            AndroidSchedulers.mainThread())
        <span class="hljs-keyword">val</span> observable2:Observable&lt;HttpResult&lt;ArrayList&lt;HomeData.DatasBean&gt;&gt;&gt; =HttpRetrofit.apiService.getTopArticles().subscribeOn(Schedulers.io()).observeOn(
            AndroidSchedulers.mainThread())
        <span class="hljs-keyword">val</span> observable3: Observable&lt;HttpResult&lt;List&lt;KnowledgeData&gt;&gt;&gt; = HttpRetrofit.apiService.getKnowledgeTree().subscribeOn(Schedulers.io()).observeOn(
            AndroidSchedulers.mainThread())
        <span class="hljs-keyword">var</span> result1: HttpResult&lt;List&lt;Banner&gt;&gt;? =<span class="hljs-literal">null</span>
        <span class="hljs-keyword">var</span> result2: HttpResult&lt;ArrayList&lt;HomeData.DatasBean&gt;&gt;? =<span class="hljs-literal">null</span>
        <span class="hljs-keyword">var</span> result3: HttpResult&lt;List&lt;KnowledgeData&gt;&gt;? =<span class="hljs-literal">null</span>
        Observable.zip(observable1, observable2, observable3,
            <span class="hljs-keyword">object</span>: Function3&lt;
                    HttpResult&lt;List&lt;Banner&gt;&gt;,
                    HttpResult&lt;ArrayList&lt;HomeData.DatasBean&gt;&gt;,
                    HttpResult&lt;List&lt;KnowledgeData&gt;&gt;,
                    <span class="hljs-built_in">Boolean</span>&gt;{
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(t1: <span class="hljs-type">HttpResult</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">Banner</span>&gt;&gt;, t2: <span class="hljs-type">HttpResult</span>&lt;<span class="hljs-type">ArrayList</span>&lt;<span class="hljs-type">HomeData</span>.<span class="hljs-type">DatasBean</span>&gt;&gt;, t3: <span class="hljs-type">HttpResult</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">KnowledgeData</span>&gt;&gt;)</span></span>: <span class="hljs-built_in">Boolean</span> {
                    result1=t1
                    result2=t2
                    result3=t3
                    <span class="hljs-keyword">return</span> t1!=<span class="hljs-literal">null</span>&amp;&amp;t2!=<span class="hljs-literal">null</span>&amp;&amp;t3!=<span class="hljs-literal">null</span>
                }
            }).subscribe(<span class="hljs-keyword">object</span>:Observer&lt;<span class="hljs-built_in">Boolean</span>&gt;{
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSubscribe</span><span class="hljs-params">(d: <span class="hljs-type">Disposable</span>)</span></span> {

            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(e: <span class="hljs-type">Throwable</span>)</span></span> {

            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onComplete</span><span class="hljs-params">()</span></span> {

            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onNext</span><span class="hljs-params">(t: <span class="hljs-type">Boolean</span>)</span></span> {
                <span class="hljs-keyword">if</span>(t){<span class="hljs-comment">//对结果进行处理</span>
                    println(<span class="hljs-string">"成功获取结果"</span>);
                    println(Gson().toJson(result1))
                    println(Gson().toJson(result2))
                    println(Gson().toJson(result3))
                }
            }
        });

    }
</code></pre>
<ul>
<li>kotlin协程提供了一种轻量级的并发处理方式</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">    fun <span class="hljs-built_in">testCoroutineInActivity</span>() {
      <span class="hljs-comment">//1.launch启动协程，返回Job对象，通过job.cancel()取消任务</span>
     val job:Job=<span class="hljs-built_in">CoroutineScope</span>(Dispatchers.IO).<span class="hljs-built_in">launch</span>() { 
            <span class="hljs-built_in">println</span>("Test001:查看运行的线程<span class="hljs-number">1</span>："+Thread.currentThread()<span class="hljs-selector-class">.name</span>)
            val start= System<span class="hljs-selector-class">.currentTimeMillis</span>()
            val result1=async {<span class="hljs-comment">//运行在主线程，非异步</span>
                <span class="hljs-built_in">println</span>("Test001:查看运行的线程<span class="hljs-number">2</span>："+Thread.currentThread()<span class="hljs-selector-class">.name</span>)
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>)
                "<span class="hljs-number">123</span>"
            }
         <span class="hljs-comment">//2.async  启动协程，得到有返回值的Deferred对象</span>
            val result2:Deferred&lt;String&gt; = <span class="hljs-built_in">async</span>(Dispatchers.IO) { <span class="hljs-comment">//异步 </span>
                <span class="hljs-built_in">println</span>("Test001:查看运行的线程<span class="hljs-number">3</span>："+Thread.currentThread()<span class="hljs-selector-class">.name</span>)
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">2000</span>)
                 "<span class="hljs-number">456</span>"

            }
            val result3=result1<span class="hljs-selector-class">.await</span>()+result2<span class="hljs-selector-class">.await</span>();
            <span class="hljs-built_in">println</span>("Test001:并发耗时："+ (System.currentTimeMillis() - start)+"||result3:<span class="hljs-string">"+result3)
            withContext(Dispatchers.IO){
                println("</span>Test001:查看运行的线程<span class="hljs-number">4</span>：<span class="hljs-string">"+ Thread.currentThread().name)
                delay(1000)
            }
            println("</span>Test001:查看运行的线程<span class="hljs-number">5</span>：<span class="hljs-string">"+ Thread.currentThread().name)
        }
    }
</span></code></pre>
<ul>
<li>kotlin协程解决地狱回调问题【先调用接口1获取数据，然后拿到接口1的结果作为参数调用接口2】</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 注意：在真实开发过程中，MainScope作用域用的非常常用</span>
MainScope().launch(){     <span class="hljs-comment">// 注意：此协程块默认是在UI线程中启动协程</span>
    <span class="hljs-comment">// 下面的代码看起来会以同步的方式一行行执行（异步代码同步获取结果）</span>
    <span class="hljs-keyword">val</span> token = apiService.getToken()   <span class="hljs-comment">// 网络请求：IO线程，获取用户token</span>
    <span class="hljs-keyword">val</span> user = apiService.getUser(token)<span class="hljs-comment">// 网络请求：IO线程，获取用户信息</span>
    nameTv.text = user.name             <span class="hljs-comment">// 更新 UI：主线程，展示用户名</span>
    <span class="hljs-keyword">val</span> articleList = apiService.getArticleList(user.id)<span class="hljs-comment">// 网络请求：IO线程，根据用户id获取用户的文章集合哦</span>
    articleTv.text = <span class="hljs-string">"用户<span class="hljs-subst">${user.name}</span>的文章页数是:<span class="hljs-subst">${articleList.size}</span>页"</span>   <span class="hljs-comment">// 更新 UI：主线程</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Okhttp3.11.0框架原理分析]]></title>    <link>https://juejin.cn/post/7600670487409803316</link>    <guid>https://juejin.cn/post/7600670487409803316</guid>    <pubDate>2026-01-30T03:30:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487409803316" data-draft-id="7600665529113247744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Okhttp3.11.0框架原理分析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T03:30:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Okhttp3.11.0框架原理分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:30:05.000Z" title="Fri Jan 30 2026 03:30:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.OkHttp用法</h3>
<p>(1).Get请求
new OkHttpClient ，构造Request对象，调用newCall方法获取Call对象，通过call#enqueue或者excute来提交请求。</p>
<pre><code class="hljs language-vbscript" lang="vbscript">String url = <span class="hljs-string">"http://wwww.baidu.com"</span>;
OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
          //POST提交表单
        FormBody formBody = <span class="hljs-keyword">new</span> FormBody.Builder()
                .add(<span class="hljs-string">"username"</span>, <span class="hljs-string">"your_username"</span>)
                .add(<span class="hljs-string">"password"</span>, <span class="hljs-string">"your_password"</span>)
                .build();
        <span class="hljs-built_in">Request</span> request1=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().url(<span class="hljs-string">"url"</span>).post(formBody).build();
        //POST提交JSON
        MediaType mediaType = MediaType.<span class="hljs-keyword">get</span>(<span class="hljs-string">"application/json; charset=utf-8"</span>);
        String jsonBody = <span class="hljs-string">"{\"</span>key\<span class="hljs-string">":\"</span>value\<span class="hljs-string">"}"</span>;
        RequestBody body = RequestBody.create(mediaType,jsonBody);
        <span class="hljs-built_in">Request</span> request2=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().url(<span class="hljs-string">""</span>).post(body).build();

<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span> = okHttpClient.newCall(request1);
<span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span>);
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});

</code></pre>
<p>(2).Post请求
在构建Request对象的时候，需要多构造一个RequestBody对象，同时指定MediaType用于描述请求/响应body的内容类型
Post提交String</p>
<pre><code class="hljs language-vbscript" lang="vbscript">MediaType mediaType = MediaType.parse(<span class="hljs-string">"text/x-markdown; charset=utf-8"</span>);
String requestBody = <span class="hljs-string">"I am Jdqm."</span>;
<span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
        .url(<span class="hljs-string">"https://api.github.com/markdown/raw"</span>)
        .post(RequestBody.create(mediaType, requestBody))
        .build();
OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
okHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-built_in">response</span>.protocol() + <span class="hljs-string">" "</span> +<span class="hljs-built_in">response</span>.code() + <span class="hljs-string">" "</span> + <span class="hljs-built_in">response</span>.message());
        Headers headers = <span class="hljs-built_in">response</span>.headers();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});

</code></pre>
<p>Post提交流</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">RequestBody</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestBody</span>() {
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> MediaType <span class="hljs-title function_">contentType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> MediaType.parse(<span class="hljs-string">"text/x-markdown; charset=utf-8"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeTo</span><span class="hljs-params">(BufferedSink sink)</span> <span class="hljs-keyword">throws</span> IOException {
        sink.writeUtf8(<span class="hljs-string">"I am Jdqm."</span>);
    }
};

<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
        .url(<span class="hljs-string">"https://api.github.com/markdown/raw"</span>)
        .post(requestBody)
        .build();
<span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">okHttpClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();
okHttpClient.newCall(request).enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
        Log.d(TAG, response.protocol() + <span class="hljs-string">" "</span> +response.code() + <span class="hljs-string">" "</span> + response.message());
        <span class="hljs-type">Headers</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> response.headers();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + response.body().string());
    }
});

</code></pre>
<p>Post提交文件</p>
<pre><code class="hljs language-vbscript" lang="vbscript">MediaType mediaType = MediaType.parse(<span class="hljs-string">"text/x-markdown; charset=utf-8"</span>);
OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"test.md"</span>);
<span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
        .url(<span class="hljs-string">"https://api.github.com/markdown/raw"</span>)
        .post(RequestBody.create(mediaType, file))
        .build();
okHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-built_in">response</span>.protocol() + <span class="hljs-string">" "</span> +<span class="hljs-built_in">response</span>.code() + <span class="hljs-string">" "</span> + <span class="hljs-built_in">response</span>.message());
        Headers headers = <span class="hljs-built_in">response</span>.headers();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});

</code></pre>
<p>Post提交表单</p>
<pre><code class="hljs language-vbscript" lang="vbscript">HttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
RequestBody requestBody = <span class="hljs-keyword">new</span> FormBody.Builder()
        .add(<span class="hljs-string">"search"</span>, <span class="hljs-string">"Jurassic Park"</span>)
        .build();
<span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
        .url(<span class="hljs-string">"https://en.wikipedia.org/w/index.php"</span>)
        .post(requestBody)
        .build();

okHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-built_in">response</span>.protocol() + <span class="hljs-string">" "</span> +<span class="hljs-built_in">response</span>.code() + <span class="hljs-string">" "</span> + <span class="hljs-built_in">response</span>.message());
        Headers headers = <span class="hljs-built_in">response</span>.headers();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});
</code></pre>
<p>Post提交分块请求</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMGUR_CLIENT_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"..."</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MediaType</span> <span class="hljs-variable">MEDIA_TYPE_PNG</span> <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">"image/png"</span>);

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postMultipartBody</span><span class="hljs-params">()</span> {
    <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();


    <span class="hljs-comment">// Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image</span>
    <span class="hljs-type">MultipartBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultipartBody</span>.Builder(<span class="hljs-string">"AaB03x"</span>)
            .setType(MultipartBody.FORM)
            .addPart(
                    Headers.of(<span class="hljs-string">"Content-Disposition"</span>, <span class="hljs-string">"form-data; name=\"title\""</span>),
                    RequestBody.create(<span class="hljs-literal">null</span>, <span class="hljs-string">"Square Logo"</span>))
            .addPart(
                    Headers.of(<span class="hljs-string">"Content-Disposition"</span>, <span class="hljs-string">"form-data; name=\"image\""</span>),
                    RequestBody.create(MEDIA_TYPE_PNG, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"website/static/logo-square.png"</span>)))
            .build();

    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
            .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Client-ID "</span> + IMGUR_CLIENT_ID)
            .url(<span class="hljs-string">"https://api.imgur.com/3/image"</span>)
            .post(body)
            .build();

    <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> client.newCall(request);
    call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {

        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
            System.out.println(response.body().string());

        }

    });
}

</code></pre>
<h3 data-id="heading-1">2.OkHttp原理</h3>
<h5 data-id="heading-2">(2.1).初步流程图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53d150a26c59448197b5dec9a22a5a64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348605&amp;x-signature=ZznPvO2Ve3QszU9EI4iKAqPcGE8%3D" alt="eff4d373e7e0a05fb515b1639ada95f.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd78e0211e348129d6b4c766ad6f1e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348605&amp;x-signature=rVmGj%2BT4g6T0e3MKux1H54b9dHw%3D" alt="d5257a27653fd67774db4ed837d9ce7.jpg" loading="lazy"/></p>
<h5 data-id="heading-3">(2.2). OkHttp.newCall()流程分析</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//基本使用</span>
 OkHttpClient okHttpClient=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>().newBuilder().build();
        Request request=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder().build();
        Call realCall= okHttpClient.newCall(request);
        realCall.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() { 
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {

            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {

            }
        });

 <span class="hljs-keyword">static</span> RealCall <span class="hljs-title function_">newRealCall</span><span class="hljs-params">(OkHttpClient client, Request originalRequest, <span class="hljs-type">boolean</span> forWebSocket)</span> {
    <span class="hljs-comment">// Safely publish the Call instance to the EventListener.</span>
    <span class="hljs-type">RealCall</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealCall</span>(client, originalRequest, forWebSocket); <span class="hljs-comment">//实例化一个RealCall对象</span>
    call.eventListener = client.eventListenerFactory().create(call);
    <span class="hljs-keyword">return</span> call;
  }
 <span class="hljs-comment">//RealCall构造函数</span>
 <span class="hljs-keyword">private</span> <span class="hljs-title function_">RealCall</span><span class="hljs-params">(OkHttpClient client, Request originalRequest, <span class="hljs-type">boolean</span> forWebSocket)</span> {
    <span class="hljs-built_in">this</span>.client = client;
    <span class="hljs-built_in">this</span>.originalRequest = originalRequest; <span class="hljs-comment">//初始化Request</span>
    <span class="hljs-built_in">this</span>.forWebSocket = forWebSocket;
    <span class="hljs-comment">//初始化重试（重定向）拦截器</span>
    <span class="hljs-built_in">this</span>.retryAndFollowUpInterceptor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RetryAndFollowUpInterceptor</span>(client, forWebSocket);
  }
</code></pre>
<h5 data-id="heading-4">2.3.enqueue流程分析</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//RealCall中</span>
 public void <span class="hljs-built_in">enqueue</span>(Callback responseCallback) {
   <span class="hljs-comment">//调用Dispatcher把AsyncCall加入队列</span>
    client<span class="hljs-selector-class">.dispatcher</span>()<span class="hljs-selector-class">.enqueue</span>(new AsyncCall(responseCallback)); 
  }

<span class="hljs-comment">//Dispatcher中</span>
  synchronized void <span class="hljs-built_in">enqueue</span>(AsyncCall call) {
    <span class="hljs-comment">//如果请求数小于64且同一域名请求小于5个，就把AsyncCall加入runningAsyncCalls队列，然后启动线程池执行，否则就把AsyncCall放入readAsyncCalls队列。</span>
    if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; <span class="hljs-built_in">runningCallsForHost</span>(call) &lt; maxRequestsPerHost) {
      runningAsyncCalls<span class="hljs-selector-class">.add</span>(call);
      <span class="hljs-built_in">executorService</span>()<span class="hljs-selector-class">.execute</span>(call);
    } else {
      readyAsyncCalls<span class="hljs-selector-class">.add</span>(call);
    }
  }
<span class="hljs-comment">//线程池创建</span>
  public synchronized ExecutorService <span class="hljs-built_in">executorService</span>() {
    if (executorService == null) {
      executorService = new <span class="hljs-built_in">ThreadPoolExecutor</span>(<span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60</span>, TimeUnit.SECONDS,
          new SynchronousQueue&lt;Runnable&gt;(), Util<span class="hljs-selector-class">.threadFactory</span>("OkHttp Dispatcher", false));
    }
    return executorService;
  }

</code></pre>
<h5 data-id="heading-5">2.4.AsyncCall</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncCall</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NamedRunnable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callback responseCallback;
    AsyncCall(Callback responseCallback) {
      <span class="hljs-built_in">super</span>(<span class="hljs-string">"OkHttp %s"</span>, redactedUrl());
      <span class="hljs-built_in">this</span>.responseCallback = responseCallback;
    }

  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
      <span class="hljs-type">boolean</span> <span class="hljs-variable">signalledCallback</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> getResponseWithInterceptorChain();
        <span class="hljs-keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) {
          signalledCallback = <span class="hljs-literal">true</span>;
          responseCallback.onFailure(RealCall.<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"Canceled"</span>));
        } <span class="hljs-keyword">else</span> {
          signalledCallback = <span class="hljs-literal">true</span>;
          responseCallback.onResponse(RealCall.<span class="hljs-built_in">this</span>, response);
        }
      } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">if</span> (signalledCallback) {
          Platform.get().log(INFO, <span class="hljs-string">"Callback failure for "</span> + toLoggableString(), e);
        } <span class="hljs-keyword">else</span> {
          eventListener.callFailed(RealCall.<span class="hljs-built_in">this</span>, e);
          responseCallback.onFailure(RealCall.<span class="hljs-built_in">this</span>, e);
        }
      } <span class="hljs-keyword">finally</span> {
        client.dispatcher().finished(<span class="hljs-built_in">this</span>); 
      }
    }
  }
 <span class="hljs-comment">//把请求队列从runningAsyncCalls中移除，</span>
 <span class="hljs-keyword">void</span> <span class="hljs-title function_">finished</span><span class="hljs-params">(AsyncCall call)</span> {
    finished(runningAsyncCalls, call, <span class="hljs-literal">true</span>);
  }

 <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">finished</span><span class="hljs-params">(Deque&lt;T&gt; calls, T call, <span class="hljs-type">boolean</span> promoteCalls)</span> {
    <span class="hljs-type">int</span> runningCallsCount;
    Runnable idleCallback;
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
     <span class="hljs-comment">//把AsyncCall从runningAsyncCalsl中移除</span>
      <span class="hljs-keyword">if</span> (!calls.remove(call)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">"Call wasn't in-flight!"</span>);
      <span class="hljs-keyword">if</span> (promoteCalls) promoteCalls();
      runningCallsCount = runningCallsCount();
      idleCallback = <span class="hljs-built_in">this</span>.idleCallback;
    }
    <span class="hljs-keyword">if</span> (runningCallsCount == <span class="hljs-number">0</span> &amp;&amp; idleCallback != <span class="hljs-literal">null</span>) {
          idleCallback.run();
    }
  }

<span class="hljs-comment">//然后遍历readyAsyncCalls队列，取出AysncCall加入到runningAsyncs队列，启动线程池立即执行。</span>
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">promoteCalls</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (runningAsyncCalls.size() &gt;= maxRequests) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Already running max capacity.</span>
    <span class="hljs-keyword">if</span> (readyAsyncCalls.isEmpty()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// No ready calls to promote.</span>
    <span class="hljs-keyword">for</span> (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) {
      <span class="hljs-type">AsyncCall</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> i.next();
      <span class="hljs-keyword">if</span> (runningCallsForHost(call) &lt; maxRequestsPerHost) {
        i.remove();
        runningAsyncCalls.add(call);
        executorService().execute(call);
      }
      <span class="hljs-keyword">if</span> (runningAsyncCalls.size() &gt;= maxRequests) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Reached max capacity.</span>
    }
  }
</code></pre>
<h5 data-id="heading-6">2.5.getResponseWithInterceptorChain()流程分析</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6664c0f87d0248b7be2b70668bb5c42c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348605&amp;x-signature=Fm5JDnEQVaLzyi7ps9rG1cVRL4Y%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-function">Response <span class="hljs-title">getResponseWithInterceptorChain</span>() throws IOException</span> {
    <span class="hljs-comment">// Build a full stack of interceptors.</span>
    List&lt;Interceptor&gt; interceptors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    interceptors.addAll(client.interceptors());<span class="hljs-comment">//自定义拦截器</span>
<span class="hljs-comment">/* 重试拦截器，判断用户是否取消了请求，在获得结果之后，会根据响应码判断是否需要重定向*/</span>
    interceptors.<span class="hljs-keyword">add</span>(retryAndFollowUpInterceptor);
<span class="hljs-comment">/* 桥接拦截器，负责在http协议中加入必备字段如：host:192.168..0.1:8080,accept encodeing:gzip,connection:keep alive ,在获得结果之后，调用保存cookie接口并解析Gzip数据.*/</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> BridgeInterceptor(client.cookieJar()));
<span class="hljs-comment">/*发起http请求的时候，会尝试读取缓存的响应数据，如果缓存存在有效数据，并满足缓存策略，则直接
返回缓存的数据，避免再次进行网络请求，如果不存在，会生成一个缓存策略，根据缓存策略指示，是否需要网络请求 */</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> CacheInterceptor(client.internalCache()));
<span class="hljs-comment">/*负责建立一个新的tcp/ip连接，并获得对应的socket流*/</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> ConnectInterceptor(client));
    <span class="hljs-keyword">if</span> (!forWebSocket) {
      interceptors.addAll(client.networkInterceptors());
    }
<span class="hljs-comment">/*利用得到的socket.getOutputStream 向服务器发送Http请求,解析读取的响应数据，并将数据封装成response对象返回.*/</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> CallServerInterceptor(forWebSocket));

    Interceptor.Chain chain = <span class="hljs-keyword">new</span> RealInterceptorChain(interceptors, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>,
        originalRequest, <span class="hljs-keyword">this</span>, eventListener, client.connectTimeoutMillis(),
        client.readTimeoutMillis(), client.writeTimeoutMillis());

    <span class="hljs-keyword">return</span> chain.proceed(originalRequest);
  }
</code></pre>
<h5 data-id="heading-7">2.6.Interceptor接口</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Interceptor</span> {
  <span class="hljs-function">Response <span class="hljs-title">intercept</span>(<span class="hljs-params">Chain chain</span>)</span> ;
  <span class="hljs-keyword">interface</span> <span class="hljs-title">Chain</span> {
    <span class="hljs-function">Request <span class="hljs-title">request</span>()</span>;
    <span class="hljs-function">Response <span class="hljs-title">proceed</span>(<span class="hljs-params">Request request</span>)</span> ;
}

</code></pre>
<h5 data-id="heading-8">2.7.RealInterceptors实现类</h5>
<pre><code class="hljs language-ini" lang="ini">public final class RealInterceptorChain implements Interceptor.Chain {

     public RealInterceptorChain(List&lt;Interceptor&gt; interceptors, int index, Request request){
             <span class="hljs-attr">this.interceptors</span> = interceptors<span class="hljs-comment">;</span>
             <span class="hljs-attr">this.index</span> = index<span class="hljs-comment">; </span>
             <span class="hljs-attr">this.request</span> = request<span class="hljs-comment">;</span>
     }
     public Response proceed(Request request){
          //index+1,可以在RealInterceptorChain中调用下一个Interceptor
          RealInterceptorChain <span class="hljs-attr">next</span> = new RealInterceptorChain(interceptors,  index + <span class="hljs-number">1</span>, request）<span class="hljs-comment">;</span>
          Interceptor <span class="hljs-attr">interceptor</span> = interceptors.get(index)<span class="hljs-comment">;//得到当前责任人</span>
          Response <span class="hljs-attr">response</span> = interceptor.intercept(next)<span class="hljs-comment">;</span>
          return    response<span class="hljs-comment">;    </span>
     }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemServer启动AMS,ATMS,WMS,PMS流程]]></title>    <link>https://juejin.cn/post/7600665529113051136</link>    <guid>https://juejin.cn/post/7600665529113051136</guid>    <pubDate>2026-01-30T03:06:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600665529113051136" data-draft-id="7600704706550612008" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemServer启动AMS,ATMS,WMS,PMS流程"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T03:06:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemServer启动AMS,ATMS,WMS,PMS流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:06:21.000Z" title="Fri Jan 30 2026 03:06:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=http%3A%2F%2Fliuwangshu.cn%2Fframework%2Fbooting%2F3-syetemserver.html" target="_blank" title="http://liuwangshu.cn/framework/booting/3-syetemserver.html" ref="nofollow noopener noreferrer">解析SyetemServer进程启动过程</a></p>
<h3 data-id="heading-0">1.解析SystemServer进程</h3>
<p>我们来看下SystemServer的mai函数</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">mian</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
     <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemServer</span>().<span class="hljs-title function_">run</span>();
}
</code></pre>
<p>main函数只调用了run函数</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">run</span>() {
       ...
           System<span class="hljs-selector-class">.loadLibrary</span>("android_servers");<span class="hljs-comment">//1.加载so库</span>
       ...
           <span class="hljs-comment">//2.创建 SystemServiceManager， 创建并启动系统的各种服务 </span>
           mSystemServiceManager = new <span class="hljs-built_in">SystemServiceManager</span>(mSystemContext);
           LocalServices<span class="hljs-selector-class">.addService</span>(SystemServiceManager.class, mSystemServiceManager);
       ...    
        try {
           Trace<span class="hljs-selector-class">.traceBegin</span>(Trace.TRACE_TAG_SYSTEM_SERVER, "StartServices");
           <span class="hljs-built_in">startBootstrapServices</span>();<span class="hljs-comment">//3.启动了AMS ,ATMS,PMS ...</span>
           <span class="hljs-built_in">startCoreServices</span>();<span class="hljs-comment">//4.启动BatteryService，WebViewUpdateService,GpuService...</span>
       <span class="hljs-comment">//5.启动WMS,CameraService,BluetoothService,AudioService,LocationManagerService</span>
           <span class="hljs-built_in">startOtherServices</span>();
       } catch (Throwable ex) {
           Slog<span class="hljs-selector-class">.e</span>("System", "******************************************");
           Slog<span class="hljs-selector-class">.e</span>("System", "************ Failure starting system services", ex);
           throw ex;
       } finally {
           Trace<span class="hljs-selector-class">.traceEnd</span>(Trace.TRACE_TAG_SYSTEM_SERVER);
       }
       ...
   }
</code></pre>
<p>看下startBootstrapServices函数</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">startBootstrapServices</span>(<span class="hljs-variable">@NonNull</span> TimingsTraceAndSlog t) {
   <span class="hljs-comment">//1.创建并启动ATMS ,ServiceManager.addService("activity_task",atm)</span>
     <span class="hljs-selector-tag">ActivityTaskManagerService</span> <span class="hljs-selector-tag">atm</span> = <span class="hljs-selector-tag">mSystemServiceManager</span><span class="hljs-selector-class">.startService</span>(
    ActivityTaskManagerService.Lifecycle.class)<span class="hljs-selector-class">.getService</span>();
   <span class="hljs-comment">// 2.创建并启动AMS </span>
   <span class="hljs-selector-tag">mActivityManagerService</span> = <span class="hljs-selector-tag">ActivityManagerService</span><span class="hljs-selector-class">.Lifecycle</span><span class="hljs-selector-class">.startService</span>(
               mSystemServiceManager, atm);
 <span class="hljs-comment">// 注册binder,ServiceManager.addService("activity",mActivityManagerService)</span>
   <span class="hljs-selector-tag">mActivityManagerService</span><span class="hljs-selector-class">.setSystemProcess</span>();
<span class="hljs-comment">//3.创建并注册PMS,  注册binder, ServiceManager.addService("package", iPackageManager);</span>
<span class="hljs-selector-tag">PackageManagerService</span><span class="hljs-selector-class">.main</span>()
}
</code></pre>
<p>看下startOtherServices函数</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">startOtherServices</span>(<span class="hljs-variable">@NonNull</span> TimingsTraceAndSlog t) {
   <span class="hljs-comment">//创建WMS，并启动</span>
    <span class="hljs-selector-tag">wm</span> = <span class="hljs-selector-tag">WindowManagerService</span><span class="hljs-selector-class">.main</span>(context, inputManager, !mFirstBoot, mOnlyCore,
                    new <span class="hljs-built_in">PhoneWindowManager</span>(), mActivityManagerService.mActivityTaskManager);
    <span class="hljs-comment">//注册binder服务</span>
   <span class="hljs-selector-tag">ServiceManager</span><span class="hljs-selector-class">.addService</span>(Context.WINDOW_SERVICE, wm, false,
                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);
  <span class="hljs-comment">// AMS和WMS关联上</span>
    <span class="hljs-selector-tag">mActivityManagerService</span><span class="hljs-selector-class">.setWindowManager</span>(wm);
}

</code></pre>
<h3 data-id="heading-1">2.ATMS和AMS的区别</h3>
<p>AMS以前是管理四大组件，太庞大了,所以为了给AMS减压，把对Activity的管理抽到了ATMS.</p>
<h3 data-id="heading-2">3.AMS,WMS,PMS添加到SErviceManager</h3>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> ACTIVITY_SERVICE = <span class="hljs-string">"activity"</span>;  
<span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> WINDOW_SERVICE = <span class="hljs-string">"window"</span>;  
<span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> PACKAGE_SERVICE = <span class="hljs-string">"package"</span>;  
<span class="hljs-comment">//添加到ServiceManager</span>
AMS:ServiceManager.<span class="hljs-built_in">addService</span>(Context.ACTIVITY_SERVICE, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>); 
WMS: ServiceManager.<span class="hljs-built_in">addService</span>(Context.WINDOW_SERVICE, wm);  
PMS:ServiceManager.<span class="hljs-built_in">addService</span>(<span class="hljs-string">"PACKAGE_SERVICE"</span>, m);
<span class="hljs-comment">//通过ServiceManager获取服务</span>
ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">"activity"</span>));
ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">"window"</span>));
ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">"package"</span>));

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[图文] 手把手教你Windows安装ClaudeCode，接入方舟CodingPlan的kimi-k2.5和glm-4.7]]></title>    <link>https://juejin.cn/post/7600629210156171270</link>    <guid>https://juejin.cn/post/7600629210156171270</guid>    <pubDate>2026-01-29T16:42:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600629210156171270" data-draft-id="7600637595944927274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[图文] 手把手教你Windows安装ClaudeCode，接入方舟CodingPlan的kimi-k2.5和glm-4.7"/> <meta itemprop="keywords" content="Claude,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T16:42:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洪哥等风来"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402390749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [图文] 手把手教你Windows安装ClaudeCode，接入方舟CodingPlan的kimi-k2.5和glm-4.7
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402390749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洪哥等风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T16:42:19.000Z" title="Thu Jan 29 2026 16:42:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文将指导你在 Windows 系统上安装 <code>ClaudeCode</code>，并配置接入火山方舟 CodingPlan 中的 <code>kimi-k2.5</code> 和 <code>glm-4.7</code>。全程不需要魔法梯子，也不需要安装 WSL 虚拟机，大家按教程步骤走就好。</p>
<p>本教程适合 0 基础小白逐步对照配置，也适合编程老手直接扫一眼该教程，大概就懂了怎么配置。</p>
<hr/>
<h3 data-id="heading-1">1. 推荐配置</h3>
<p>就像打游戏有推荐配置一样，ClaudeCode 的推荐配置比较简单：</p>
<ul>
<li><strong>操作系统</strong>：推荐 <code>Win11</code>，最低支持 <code>Win10</code>（Win7 不适用）</li>
<li><strong>Node.js</strong>：推荐版本 <code>v22.20.0 LTS</code>，最低支持到 <code>v18.20.8</code>（需要 npm 工具）</li>
<li><strong>Git</strong>：推荐最新版</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 安装 Node.js</h3>
<h4 data-id="heading-3">2.1 下载 Node.js</h4>
<p>进入 Node.js 官方下载界面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">nodejs.org/zh-cn/downl…</a></p>
<h4 data-id="heading-4">2.2 选择版本并下载</h4>
<p>选择 Node.js 版本 + 操作系统 + 架构，把 msi 文件下载到本地：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7610c3c51953447e8455f59e8d5c93d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=OJlwoHk5LuzMLNq3n4Fw9zsQPhc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">2.3 安装 Node.js</h4>
<p>下载完后双击安装，无脑 Next 直到安装完成点击 Finish：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d8454182d8e4a8ea5d5f9f0a1f7fd53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=mGc9L0zdizz9ZHYhoY3cAIzHs7c%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">2.4 验证安装并解决权限问题</h4>
<ol>
<li>
<p>搜索 PowerShell 并打开，输入以下命令检查 npm 版本：</p>
<pre><code class="hljs language-powershell" lang="powershell">npm -v
</code></pre>
</li>
<li>
<p>可能会遇到 PowerShell 执行策略错误：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">npm :</span> <span class="hljs-string">无法加载文件</span> <span class="hljs-string">C:\Program</span> <span class="hljs-string">Files\nodejs\npm.ps1，因为在此系统上禁止运行脚本。</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfa86698d63044d9a644fe657d9b8723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=jNZijRaCrkt4JjB%2FE1EUIH48%2Bd0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>解决方法：运行以下命令解除限制（需要输入 <code>Y</code> 确认）：</p>
<pre><code class="hljs language-powershell" lang="powershell">Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b10f6e3528a943fe80beb8b4f0a76eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=N5jFAuGH89gr6R2tiTADebgP%2F8o%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<h4 data-id="heading-7">2.5 备选方案：使用 CMD</h4>
<p>如果在公司电脑上不允许更改安全策略，可以使用 CMD 替代 PowerShell，后续步骤将 PowerShell 换成 CMD 即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ded24de385426aac9a3f66061901c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=kcL%2BOExuVnw4dILg%2F9sbnLcph0s%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">3. 安装 Git</h3>
<h4 data-id="heading-9">3.1 下载 Git</h4>
<p>进入 Git 官方下载界面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdownloads%2Fwin" target="_blank" title="https://git-scm.com/downloads/win" ref="nofollow noopener noreferrer">git-scm.com/downloads/w…</a></p>
<h4 data-id="heading-10">3.2 选择版本并下载</h4>
<p>选择适合自己的版本进行下载，一般选择 "Git for Windows/x64 Setup"。</p>
<h4 data-id="heading-11">3.3 安装 Git</h4>
<p>双击安装，也是无脑下一步直到最后 Finish。</p>
<h4 data-id="heading-12">3.4 验证安装</h4>
<p>在 PowerShell 中输入以下命令检查 Git 版本：</p>
<pre><code class="hljs language-powershell" lang="powershell">git -v
</code></pre>
<p>有版本号输出就证明安装成功：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78f03a9e99a454dbf783d8ac803f4a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=5HJDU0uPPSXkdWO2UmBSzMgwSRM%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-13">4. 安装 Claude Code</h3>
<h4 data-id="heading-14">4.1 安装命令</h4>
<p>在 PowerShell 中使用 npm 工具安装 ClaudeCode：</p>
<pre><code class="hljs language-powershell" lang="powershell">npm install -g @anthropic-ai/claude-code
</code></pre>
<h4 data-id="heading-15">4.2 验证安装成功</h4>
<p>安装成功后会看到相应的提示信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b47fc993b84bb48cf21a1524debd0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=LIdsji5Ur8LsB7r2FSmTdtOtSG8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">4.3 首次启动测试</h4>
<p>打开 PowerShell，输入以下命令尝试进入 Claude Code：</p>
<pre><code class="hljs language-powershell" lang="powershell">claude
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53721fc46d9f4916a7be5187fab4717a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=Z7IeALX1U45qa0wkUPAMOit76MU%3D" alt="" loading="lazy"/></p>
<p>如果显示如下界面，证明安装成功了。红色报错是因为 Claude 禁止中国访问，我们在下面的步骤中会把模型替换为 <code>kimi-k2.5</code> 和 <code>glm-4.7</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7edd872dbcec41fca6e2bed99fea3f45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=K2FQXD0SKWj%2FzUMeSRHht4j9zsE%3D" alt="" loading="lazy"/></p>
<p>到这里可以先把窗口关闭掉了，我们去申请模型的 API Key。</p>
<hr/>
<h3 data-id="heading-17">5. 获取火山 CodingPlan 的 API Key</h3>
<h4 data-id="heading-18">5.1 访问方舟 CodingPlan 页面</h4>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvolcengine.com%2FL%2FvAgAgZgPA80%2F" target="_blank" title="https://volcengine.com/L/vAgAgZgPA80/" ref="nofollow noopener noreferrer">方舟 CodingPlan</a> 页面，按需订阅套餐。</p>
<h4 data-id="heading-19">5.2 创建 API Key</h4>
<ol>
<li>注册后进入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.volcengine.com%2Fark%2Fregion%3Aark%2Bcn-beijing%2FopenManagement%3FLLM%3D%257B%257D%26advancedActiveKey%3Dsubscribe" target="_blank" title="https://console.volcengine.com/ark/region:ark+cn-beijing/openManagement?LLM=%7B%7D&amp;advancedActiveKey=subscribe" ref="nofollow noopener noreferrer">火山方舟管理控制台</a></li>
<li>按顺序点击：<code>API Key管理</code> -&gt; <code>创建API Key</code> -&gt; <code>输入一个名字来标识这个key</code> -&gt; <code>创建</code></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a213d773c534a0cb95269ac3e7cd988~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=phmMZjzeoyowzdD2GYxA5ncRz6Y%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20">5.3 查看 API Key</h4>
<p>申请成功后就能看到这个 API Key 了，后续我们就用这个 API Key 来访问模型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c49d2319cc9410187ab86e0c9e0e288~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=bp3g4HFNEyaM0wEva5Hofw7f1Fw%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-21">6. 配置 kimi-k2.5 或 glm-4.7 到 ClaudeCode</h3>
<h4 data-id="heading-22">6.1 打开系统环境变量设置</h4>
<p>在 Windows 搜索栏中输入 <code>环境变量</code>，并选择 <code>编辑系统环境变量</code>。</p>
<h4 data-id="heading-23">6.2 进入环境变量配置</h4>
<p>在 <code>系统属性</code> 窗口中，点击 <code>环境变量...</code>。</p>
<h4 data-id="heading-24">6.3 添加环境变量</h4>
<p>在 <code>用户变量</code> 区域，点击 <code>新建...</code>，并依次添加以下 3 个新变量：</p>

























<table><thead><tr><th>变量名</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td><strong>ANTHROPIC_AUTH_TOKEN</strong></td><td><code>bb24267b-xxxx-xxxx-xxxx-dcadfb91eec9</code></td><td>需要替换成你刚才申请好的 API Key</td></tr><tr><td><strong>ANTHROPIC_BASE_URL</strong></td><td><code>https://ark.cn-beijing.volces.com/api/coding</code></td><td>访问模型的固定网址</td></tr><tr><td><strong>ANTHROPIC_MODEL</strong></td><td><code>kimi-k2.5</code></td><td>可选值：<code>kimi-k2.5</code>、<code>glm-4.7</code>、<code>deepseek-v3.2</code>、<code>kimi-k2-thinking</code>、<code>doubao-seed-code</code>，推荐填写 <code>kimi-k2.5</code> 或 <code>glm-4.7</code></td></tr></tbody></table>
<p>配置好后如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5617069e34564575afb404f96efbd34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=0btkf2f%2Bm5q55oVs9FMF3Q8CIyM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-25">6.4 验证配置</h4>
<p>保存所有的环境变量后，<strong>新打开一个 PowerShell（注意要新打开，否则环境变量可能没更新）</strong>，再次进入 <code>claude</code>，如果不再报错并进入到初始化设置，就证明成功了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6907491cdb64731aa79cc9f3e675d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=9Pa9Zwo8ENprhaPG03ELNCLTE9c%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-26">6.5 初始化设置</h4>
<p>初始化设置可以无脑回车，直到出现对话框，并有 <code>kimi-k2.5</code> 或你刚才配置好的模型的字样，就证明完全进来了。我们可以让他自我介绍一下，如果能收到回复就说明完全 ok 了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/decbaaad2f47470bb3bfb3167296d8b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=FU8ChITDtlZnwW2aBlzzFaF4cvM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-27">6.6 安全提示</h4>
<p>后续就可以切换到自己的项目路径下，然后启动 Claude 工具了。<em><strong>注意教程中的演示有一些在 C 盘，这是危险的操作，最多让 AI 自我介绍一下，不要给他发其他命令！</strong></em></p>
<hr/>
<h3 data-id="heading-28">7. 使用 Claude Code VSCode 插件</h3>
<h4 data-id="heading-29">7.1 安装插件</h4>
<p>打开 VSCode，在扩展市场搜索 <code>claude code</code> 进行安装：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9e2cfde10284401b5a1de059791b866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=pPDJthLpMbFB4HTdvosPXTXIzqU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-30">7.2 开始使用</h4>
<p>安装完成后，点击 VSCode 右上角的 Claude Code 图标，进入 Claude Code 页面，待初始化完成后即可开始使用：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bdada187a45471689a5b21d4d7cf9f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=UofmyAesuDKZjXrxzmJtWIhLeJ4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chatbot 开发入门指南：从零构建智能对话机器人]]></title>    <link>https://juejin.cn/post/7600629210156072966</link>    <guid>https://juejin.cn/post/7600629210156072966</guid>    <pubDate>2026-01-29T16:10:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600629210156072966" data-draft-id="7600663744192921636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chatbot 开发入门指南：从零构建智能对话机器人"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T16:10:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hahaniu666"/> <meta itemprop="url" content="https://juejin.cn/user/3227821870678023"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chatbot 开发入门指南：从零构建智能对话机器人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821870678023/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hahaniu666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T16:10:28.000Z" title="Thu Jan 29 2026 16:10:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Chatbot 正在改变人机交互</h2>
<p>从客服机器人到智能助手，从代码助手到知识问答，Chatbot 已经成为现代应用不可或缺的一部分。2025 年，随着大语言模型（LLM）的普及，构建一个智能 Chatbot 变得前所未有的简单。</p>
<p>本文将带你从零开始，了解 Chatbot 的核心原理，掌握主流开发框架，并动手构建一个基于 RAG（检索增强生成）的智能问答机器人。</p>
<hr/>
<h2 data-id="heading-1">一、Chatbot 的核心技术栈</h2>
<h3 data-id="heading-2">1.1 基础架构</h3>
<p>一个现代 Chatbot 通常包含以下组件：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户输入 → 意图识别 → 上下文管理 → 响应生成 → 输出回复
<span class="hljs-code">    ↑                                              ↓
    └────────────── 记忆存储 ←─────────────────────┘
</span></code></pre>
<h3 data-id="heading-3">1.2 主流技术方案</h3>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>技术难度</th><th>代表框架</th></tr></thead><tbody><tr><td>基于规则</td><td>固定流程、简单问答</td><td>低</td><td>正则表达式、状态机</td></tr><tr><td>基于检索</td><td>FAQ、知识库问答</td><td>中</td><td>Elasticsearch、向量数据库</td></tr><tr><td>基于生成</td><td>开放式对话、创意写作</td><td>高</td><td>GPT、Claude、Llama</td></tr><tr><td>RAG 混合</td><td>企业知识库、专业问答</td><td>中</td><td>LangChain、LlamaIndex</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、快速上手：用 Python 构建基础 Chatbot</h2>
<h3 data-id="heading-5">2.1 环境准备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python -m venv chatbot-env
<span class="hljs-built_in">source</span> chatbot-env/bin/activate  <span class="hljs-comment"># Linux/Mac</span>
<span class="hljs-comment"># chatbot-env\Scripts\activate  # Windows</span>

<span class="hljs-comment"># 安装依赖</span>
pip install openai langchain streamlit
</code></pre>
<h3 data-id="heading-6">2.2 最简单的 Chatbot</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key</span>):
        self.client = openai.OpenAI(api_key=api_key)
        self.history = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-comment"># 添加用户消息到历史</span>
        self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})
        
        <span class="hljs-comment"># 调用大模型</span>
        response = self.client.chat.completions.create(
            model=<span class="hljs-string">"gpt-3.5-turbo"</span>,
            messages=self.history
        )
        
        <span class="hljs-comment"># 获取回复并添加到历史</span>
        reply = response.choices[<span class="hljs-number">0</span>].message.content
        self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: reply})
        
        <span class="hljs-keyword">return</span> reply

<span class="hljs-comment"># 使用示例</span>
bot = SimpleChatbot(api_key=<span class="hljs-string">"your-api-key"</span>)
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"你: "</span>)
    <span class="hljs-keyword">if</span> user_input.lower() == <span class="hljs-string">"exit"</span>:
        <span class="hljs-keyword">break</span>
    reply = bot.chat(user_input)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"机器人: <span class="hljs-subst">{reply}</span>"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-7">三、进阶：使用 LangChain 构建 RAG Chatbot</h2>
<p>RAG（Retrieval-Augmented Generation，检索增强生成）让 Chatbot 能够基于私有知识库回答问题，是企业级应用的首选方案。</p>
<h3 data-id="heading-8">3.1 完整代码示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> TextLoader
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> OpenAIEmbeddings, ChatOpenAI
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> ConversationalRetrievalChain
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key, knowledge_file</span>):
        <span class="hljs-comment"># 1. 加载知识库文档</span>
        loader = TextLoader(knowledge_file)
        documents = loader.load()
        
        <span class="hljs-comment"># 2. 文档切分</span>
        <span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> CharacterTextSplitter
        text_splitter = CharacterTextSplitter(
            chunk_size=<span class="hljs-number">1000</span>,
            chunk_overlap=<span class="hljs-number">200</span>
        )
        texts = text_splitter.split_documents(documents)
        
        <span class="hljs-comment"># 3. 创建向量数据库</span>
        embeddings = OpenAIEmbeddings(openai_api_key=api_key)
        self.vectorstore = FAISS.from_documents(texts, embeddings)
        
        <span class="hljs-comment"># 4. 初始化对话记忆</span>
        self.memory = ConversationBufferMemory(
            memory_key=<span class="hljs-string">"chat_history"</span>,
            return_messages=<span class="hljs-literal">True</span>
        )
        
        <span class="hljs-comment"># 5. 创建对话链</span>
        llm = ChatOpenAI(
            openai_api_key=api_key,
            model=<span class="hljs-string">"gpt-3.5-turbo"</span>,
            temperature=<span class="hljs-number">0.7</span>
        )
        
        self.qa_chain = ConversationalRetrievalChain.from_llm(
            llm=llm,
            retriever=self.vectorstore.as_retriever(),
            memory=self.memory
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">self, question</span>):
        <span class="hljs-string">"""提问并获取回答"""</span>
        response = self.qa_chain.invoke({<span class="hljs-string">"question"</span>: question})
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">"answer"</span>]

<span class="hljs-comment"># 使用示例</span>
bot = RAGChatbot(
    api_key=<span class="hljs-string">"your-api-key"</span>,
    knowledge_file=<span class="hljs-string">"knowledge.txt"</span>  <span class="hljs-comment"># 你的知识库文件</span>
)

<span class="hljs-comment"># 开始对话</span>
<span class="hljs-built_in">print</span>(bot.ask(<span class="hljs-string">"公司的年假政策是什么？"</span>))
<span class="hljs-built_in">print</span>(bot.ask(<span class="hljs-string">"我需要准备什么材料？"</span>))
</code></pre>
<h3 data-id="heading-9">3.2 代码解析</h3>

































<table><thead><tr><th>组件</th><th>作用</th></tr></thead><tbody><tr><td>Document Loader</td><td>加载各种格式的文档（PDF、TXT、Markdown）</td></tr><tr><td>Text Splitter</td><td>将长文档切分成小块，便于检索</td></tr><tr><td>Embeddings</td><td>将文本转换为向量，用于语义搜索</td></tr><tr><td>Vector Store</td><td>存储和检索向量化的文档</td></tr><tr><td>Memory</td><td>保存对话历史，支持多轮对话</td></tr><tr><td>LLM Chain</td><td>将检索结果输入大模型生成回答</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">四、部署：打造 Web 版 Chatbot</h2>
<p>使用 Streamlit 快速构建 Web 界面：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st
<span class="hljs-keyword">from</span> rag_chatbot <span class="hljs-keyword">import</span> RAGChatbot  <span class="hljs-comment"># 上面的代码保存为 rag_chatbot.py</span>

<span class="hljs-comment"># 页面配置</span>
st.set_page_config(page_title=<span class="hljs-string">"智能客服机器人"</span>, page_icon=<span class="hljs-string">"🤖"</span>)
st.title(<span class="hljs-string">"🤖 企业智能问答助手"</span>)

<span class="hljs-comment"># 初始化 Chatbot</span>
<span class="hljs-meta">@st.cache_resource</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chatbot</span>():
    <span class="hljs-keyword">return</span> RAGChatbot(
        api_key=st.secrets[<span class="hljs-string">"OPENAI_API_KEY"</span>],
        knowledge_file=<span class="hljs-string">"knowledge.txt"</span>
    )

<span class="hljs-comment"># 会话状态管理</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state.messages = []

<span class="hljs-comment"># 显示历史消息</span>
<span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> st.session_state.messages:
    <span class="hljs-keyword">with</span> st.chat_message(message[<span class="hljs-string">"role"</span>]):
        st.markdown(message[<span class="hljs-string">"content"</span>])

<span class="hljs-comment"># 用户输入</span>
<span class="hljs-keyword">if</span> prompt := st.chat_input(<span class="hljs-string">"请输入你的问题..."</span>):
    <span class="hljs-comment"># 显示用户消息</span>
    st.session_state.messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})
    <span class="hljs-keyword">with</span> st.chat_message(<span class="hljs-string">"user"</span>):
        st.markdown(prompt)
    
    <span class="hljs-comment"># 获取机器人回复</span>
    <span class="hljs-keyword">with</span> st.chat_message(<span class="hljs-string">"assistant"</span>):
        bot = get_chatbot()
        response = bot.ask(prompt)
        st.markdown(response)
    
    st.session_state.messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response})
</code></pre>
<p>运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">streamlit run app.py
</code></pre>
<hr/>
<h2 data-id="heading-11">五、最佳实践与优化技巧</h2>
<h3 data-id="heading-12">5.1 提升回答质量</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 优化提示词模板</span>
custom_template = <span class="hljs-string">"""基于以下上下文回答问题：
{context}

问题：{question}

要求：
- 如果上下文中没有相关信息，请明确说明
- 回答要简洁，控制在200字以内
- 使用中文回答

回答："""</span>

<span class="hljs-comment"># 2. 调整检索参数</span>
retriever = vectorstore.as_retriever(
    search_type=<span class="hljs-string">"similarity_score_threshold"</span>,
    search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"score_threshold"</span>: <span class="hljs-number">0.7</span>}
)
</code></pre>
<h3 data-id="heading-13">5.2 性能优化</h3>

























<table><thead><tr><th>优化方向</th><th>具体方法</th></tr></thead><tbody><tr><td>响应速度</td><td>使用缓存、预加载模型、异步处理</td></tr><tr><td>成本控制</td><td>选择合适的模型、限制上下文长度</td></tr><tr><td>准确性</td><td>优化文档切分策略、调整检索阈值</td></tr><tr><td>可扩展性</td><td>使用向量数据库（Pinecone、Milvus）</td></tr></tbody></table>
<h3 data-id="heading-14">5.3 常见问题处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 处理模型超时</span>
<span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_exponential

<span class="hljs-meta">@retry(<span class="hljs-params">stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">3</span></span>), wait=wait_exponential(<span class="hljs-params">multiplier=<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">4</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">10</span></span>)</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_chat</span>(<span class="hljs-params">bot, question</span>):
    <span class="hljs-keyword">return</span> bot.ask(question)

<span class="hljs-comment"># 敏感内容过滤</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_content</span>(<span class="hljs-params">text</span>):
    blocked_keywords = [<span class="hljs-string">"密码"</span>, <span class="hljs-string">"密钥"</span>, <span class="hljs-string">"token"</span>]
    <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> blocked_keywords:
        <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> text:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"内容包含敏感信息"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">""</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">六、扩展：添加更多功能</h2>
<h3 data-id="heading-16">6.1 多模态支持</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 支持图片输入</span>
<span class="hljs-keyword">from</span> langchain_community.utilities <span class="hljs-keyword">import</span> GoogleVisionAPIWrapper

vision = GoogleVisionAPIWrapper()
image_description = vision.describe_image(<span class="hljs-string">"image.jpg"</span>)
</code></pre>
<h3 data-id="heading-17">6.2 工具调用（Agent）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> Tool, AgentType, initialize_agent

tools = [
    Tool(
        name=<span class="hljs-string">"Search"</span>,
        func=search_function,
        description=<span class="hljs-string">"用于搜索最新信息"</span>
    ),
    Tool(
        name=<span class="hljs-string">"Calculator"</span>,
        func=calculator_function,
        description=<span class="hljs-string">"用于数学计算"</span>
    )
]

agent = initialize_agent(
    tools,
    llm,
    agent=AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION
)
</code></pre>
<hr/>
<h2 data-id="heading-18">结语</h2>
<p>构建一个 Chatbot 不再是一件复杂的事情。借助现代 LLM 和开发框架，你可以：</p>
<ul>
<li>✅ 30 分钟搭建基础对话机器人</li>
<li>✅ 2 小时实现基于知识库的 RAG 系统</li>
<li>✅ 1 天部署生产级 Web 应用</li>
</ul>
<p>下一步，你可以尝试：</p>
<ol>
<li>接入更多数据源（数据库、API、网页）</li>
<li>优化对话体验（添加语音、富文本）</li>
<li>集成到现有系统（微信、钉钉、Slack）</li>
</ol>
<p>开始你的 Chatbot 开发之旅吧！</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li>LangChain 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com" target="_blank" title="https://python.langchain.com" ref="nofollow noopener noreferrer">python.langchain.com</a></li>
<li>Streamlit 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.streamlit.io" target="_blank" title="https://docs.streamlit.io" ref="nofollow noopener noreferrer">docs.streamlit.io</a></li>
<li>OpenAI API 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs" target="_blank" title="https://platform.openai.com/docs" ref="nofollow noopener noreferrer">platform.openai.com/docs</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ollama 快速上手指南：开发者的本地 LLM 利器]]></title>    <link>https://juejin.cn/post/7600642904382455814</link>    <guid>https://juejin.cn/post/7600642904382455814</guid>    <pubDate>2026-01-29T16:06:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600642904382455814" data-draft-id="7600637595944845354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ollama 快速上手指南：开发者的本地 LLM 利器"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T16:06:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hahaniu666"/> <meta itemprop="url" content="https://juejin.cn/user/3227821870678023"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ollama 快速上手指南：开发者的本地 LLM 利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821870678023/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hahaniu666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T16:06:07.000Z" title="Thu Jan 29 2026 16:06:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么开发者需要 Ollama？</h2>
<p>想象一下：你正在开发一个需要 AI 功能的应用，但每次调用 API 都要担心网络延迟、数据隐私和调用成本。或者你想在飞机上、咖啡馆里离线调试 AI 功能，却发现没有网络寸步难行。</p>
<p>这就是 <strong>Ollama</strong> 的价值所在——它让你能在本地机器上轻松运行大语言模型（LLM），无需复杂的配置，一条命令就能启动。</p>
<p>Ollama 是一个开源的本地化大模型运行框架，专为开发者设计。它支持 Llama、Qwen、DeepSeek 等主流模型，提供 REST API 和 Python SDK，让你可以像调用云服务一样使用本地模型，但数据完全留在本地。</p>
<hr/>
<h2 data-id="heading-1">一、安装：一分钟搞定</h2>
<h3 data-id="heading-2">macOS / Windows</h3>
<p>直接下载安装包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS</span>
curl -fsSL https://ollama.com/install.sh | sh

<span class="hljs-comment"># 或访问官网下载：https://ollama.com/download</span>
</code></pre>
<h3 data-id="heading-3">Linux（推荐用于服务器部署）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装</span>
curl -fsSL https://ollama.com/install.sh | sh

<span class="hljs-comment"># 启动服务</span>
ollama serve
</code></pre>
<p>安装完成后，Ollama 默认在 <code>http://localhost:11434</code> 运行。</p>
<hr/>
<h2 data-id="heading-4">二、运行你的第一个模型</h2>
<p>Ollama 的命令设计非常简洁。运行模型只需：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行 Llama 3.2（轻量级，适合大多数机器）</span>
ollama run llama3.2

<span class="hljs-comment"># 运行 Qwen 2.5（中文表现优秀）</span>
ollama run qwen2.5

<span class="hljs-comment"># 运行 DeepSeek-R1（推理能力强）</span>
ollama run deepseek-r1
</code></pre>
<p>首次运行会自动下载模型。下载完成后，你就进入了一个交互式对话界面，可以直接和模型聊天。</p>
<p><strong>常用命令速查：</strong></p>

























<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>ollama list</code></td><td>查看已下载的模型</td></tr><tr><td><code>ollama pull &lt;model&gt;</code></td><td>下载模型但不运行</td></tr><tr><td><code>ollama rm &lt;model&gt;</code></td><td>删除模型</td></tr><tr><td><code>ollama ps</code></td><td>查看运行中的模型</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">三、在代码中调用 Ollama</h2>
<h3 data-id="heading-6">方式一：REST API</h3>
<p>Ollama 提供了完整的 REST API，任何语言都可以调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成文本</span>
curl http://localhost:11434/api/generate -d <span class="hljs-string">'{
  "model": "llama3.2",
  "prompt": "用 Python 写一个快速排序算法",
  "stream": false
}'</span>

<span class="hljs-comment"># 对话模式</span>
curl http://localhost:11434/api/chat -d <span class="hljs-string">'{
  "model": "llama3.2",
  "messages": [
    {"role": "user", "content": "你好"}
  ]
}'</span>
</code></pre>
<h3 data-id="heading-7">方式二：Python SDK（推荐）</h3>
<p>安装 Python 库：</p>
<pre><code class="hljs language-bash" lang="bash">pip install ollama
</code></pre>
<p>基础用法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ollama

<span class="hljs-comment"># 简单生成</span>
response = ollama.generate(
    model=<span class="hljs-string">'llama3.2'</span>,
    prompt=<span class="hljs-string">'解释什么是递归函数'</span>
)
<span class="hljs-built_in">print</span>(response[<span class="hljs-string">'response'</span>])

<span class="hljs-comment"># 对话模式</span>
chat = ollama.chat(
    model=<span class="hljs-string">'llama3.2'</span>,
    messages=[
        {<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">'你好'</span>}
    ]
)
<span class="hljs-built_in">print</span>(chat[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>])
</code></pre>
<p>流式输出（适合实时显示）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ollama

stream = ollama.chat(
    model=<span class="hljs-string">'llama3.2'</span>,
    messages=[{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">'讲个笑话'</span>}],
    stream=<span class="hljs-literal">True</span>,
)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> stream:
    <span class="hljs-built_in">print</span>(chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>], end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<hr/>
<h2 data-id="heading-8">四、进阶：自定义模型配置</h2>
<p>你可以通过 <code>Modelfile</code> 创建自定义模型配置：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># Modelfile
FROM llama3.2

# 系统提示词
SYSTEM """你是一个专业的 Python 开发助手，擅长编写简洁高效的代码。"""

# 参数设置
PARAMETER temperature 0.7
PARAMETER num_ctx 4096
</code></pre>
<p>创建并运行：</p>
<pre><code class="hljs language-bash" lang="bash">ollama create my-assistant -f Modelfile
ollama run my-assistant
</code></pre>
<hr/>
<h2 data-id="heading-9">五、模型选择建议</h2>



































<table><thead><tr><th>模型</th><th>参数规模</th><th>适用场景</th><th>显存需求</th></tr></thead><tbody><tr><td>llama3.2</td><td>3B</td><td>轻量级任务、快速响应</td><td>4GB+</td></tr><tr><td>qwen2.5</td><td>7B</td><td>中文对话、代码生成</td><td>8GB+</td></tr><tr><td>deepseek-r1</td><td>7B/14B</td><td>复杂推理、数学问题</td><td>8GB+/16GB+</td></tr><tr><td>codellama</td><td>7B</td><td>代码补全、编程辅助</td><td>8GB+</td></tr></tbody></table>
<p><strong>提示：</strong> 如果显存有限，可以使用量化版本（如 <code>qwen2.5:4b</code>），在模型名后加 <code>:4b</code> 即可。</p>
<hr/>
<h2 data-id="heading-10">六、集成到开发工作流</h2>
<h3 data-id="heading-11">在 VS Code 中使用</h3>
<p>安装 <strong>Continue</strong> 插件，配置本地 Ollama：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Local Llama"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ollama"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llama3.2"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-12">作为后端服务</h3>
<p>启动 Ollama 服务后，你的应用可以像调用 OpenAI API 一样使用本地模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

client = openai.OpenAI(
    base_url=<span class="hljs-string">"http://localhost:11434/v1"</span>,
    api_key=<span class="hljs-string">"ollama"</span>  <span class="hljs-comment"># 任意值即可</span>
)

response = client.chat.completions.create(
    model=<span class="hljs-string">"llama3.2"</span>,
    messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello"</span>}]
)
</code></pre>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p>Ollama 让本地运行大模型变得前所未有的简单。对于开发者来说，它不仅是保护数据隐私的解决方案，更是加速开发迭代的利器——无需网络、无需 API Key、零调用成本。</p>
<p>现在就开始你的本地 AI 之旅吧：</p>
<pre><code class="hljs language-bash" lang="bash">ollama run llama3.2
</code></pre>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li>Ollama 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">ollama.com</a></li>
<li>模型库：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Flibrary" target="_blank" title="https://ollama.com/library" ref="nofollow noopener noreferrer">ollama.com/library</a></li>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama" target="_blank" title="https://github.com/ollama/ollama" ref="nofollow noopener noreferrer">github.com/ollama/olla…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vscode提示找不到名称“Map”的解决方案]]></title>    <link>https://juejin.cn/post/7600705962248372233</link>    <guid>https://juejin.cn/post/7600705962248372233</guid>    <pubDate>2026-01-30T03:33:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600705962248372233" data-draft-id="7600764857768886322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vscode提示找不到名称“Map”的解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T03:33:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vscode提示找不到名称“Map”的解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:33:12.000Z" title="Fri Jan 30 2026 03:33:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">错误提示</h3>
<p>“编辑器报错：找不到名称“Map”。是否需要更改目标库? 请尝试将 “lib” 编译器选项更改为“es2015”或更高版本。”</p>
<h3 data-id="heading-1">原因：</h3>
<p><code>Map</code> 是 ES2015（ES6）引入的新特性，而 TS 默认的 <code>lib</code> 配置可能只包含 <code>ES5</code> 相关的类型定义（ES5 中没有 <code>Map</code>），因此编译器不认识 <code>Map</code>，从而抛出 “找不到名称‘Map’” 的错误。</p>
<h2 data-id="heading-2">解决方案（两种方式，任选其一）</h2>
<h4 data-id="heading-3">方式 1：修改 tsconfig.json 配置（推荐，全局生效）</h4>
<p>这是最规范的做法，通过配置文件指定 TS 编译时使用的库版本：</p>
<ol>
<li>找到项目根目录的 <code>tsconfig.json</code> 文件（如果没有，执行 <code>tsc --init</code> 生成）；</li>
<li>找到 <code>compilerOptions</code> 中的 <code>lib</code> 字段，添加 <code>ES2015</code> 或更高版本（如 <code>ES2020</code>），同时保留必要的 <code>DOM</code>（如果涉及浏览器环境）；</li>
<li>保存后重启编辑器（如 VS Code），报错会自动消失。</li>
</ol>
<p><strong>完整的 tsconfig.json 示例</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2015"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 编译目标版本，建议和 lib 版本匹配</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ES2015"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心：添加 ES2015 及以上</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CommonJS"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开启严格模式，增强类型检查</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>
<p><code>lib</code> 字段说明：</p>
<ul>
<li><code>ES2015</code>：包含 ES6 所有新特性（Map、Set、Promise 等）的类型定义；</li>
<li><code>DOM</code>：包含浏览器环境的类型定义（如 <code>document</code>、<code>window</code>），如果是 Node.js 项目可省略。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">方式 2：临时指定文件级别的 lib（仅当前文件生效）</h4>
<p>如果不想修改全局配置，可在使用 <code>Map</code> 的 TS 文件顶部添加一行注释，强制指定该文件使用的库版本：</p>
<p>typescript</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/// &lt;reference lib="es2015" /&gt;</span>

<span class="hljs-comment">// 此时 Map 就能被识别</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();
</code></pre>
<h3 data-id="heading-5">验证是否解决问题</h3>
<p>修改配置后，编写以下代码测试：</p>
<p>typescript</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> <span class="hljs-built_in">map</span> = new Map&lt;<span class="hljs-built_in">string</span>, number&gt;();
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-string">"test"</span>, <span class="hljs-number">123</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-built_in">map</span>.get(<span class="hljs-string">"test"</span>));
</code></pre>
<ul>
<li>如果编辑器不再报 “找不到名称‘Map’” 的错误，且代码能正常编译（执行 <code>tsc</code> 无报错），说明配置生效。</li>
</ul>
<h3 data-id="heading-6">补充说明</h3>
<ul>
<li>
<p><code>target</code> vs <code>lib</code>：</p>
<ul>
<li><code>target</code>：指定 TS 编译后生成的 JS 版本（如 ES5、ES2015）；</li>
<li><code>lib</code>：指定 TS 编译时参考的类型定义库版本（决定 TS 认识哪些内置对象 / 方法）；</li>
<li>建议 <code>target</code> 和 <code>lib</code> 版本保持一致（如都设为 ES2015），避免类型和编译结果不匹配。</li>
</ul>
</li>
<li>
<p>若项目是 Node.js 环境：除了 <code>ES2015</code>，还可根据 Node 版本选择 <code>ES2020</code>、<code>ESNext</code> 等，无需添加 <code>DOM</code>。</p>
</li>
</ul>
<h3 data-id="heading-7">总结</h3>
<ol>
<li>报错核心原因：TS 编译器的 <code>lib</code> 配置未包含 ES2015，导致无法识别 <code>Map</code> 类型；</li>
<li>最优解决方案：在 <code>tsconfig.json</code> 的 <code>compilerOptions.lib</code> 中添加 <code>ES2015</code>（或更高版本）；</li>
<li>关键配置：<code>lib</code> 字段控制 TS 能识别的内置 API 类型，<code>target</code> 控制编译后的 JS 版本，两者建议匹配。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain v1.x Models 完全指南：从入门到精通]]></title>    <link>https://juejin.cn/post/7600622813457661967</link>    <guid>https://juejin.cn/post/7600622813457661967</guid>    <pubDate>2026-01-30T01:24:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622813457661967" data-draft-id="7600622813457629199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain v1.x Models 完全指南：从入门到精通"/> <meta itemprop="keywords" content="LangChain,Agent"/> <meta itemprop="datePublished" content="2026-01-30T01:24:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈暖秋"/> <meta itemprop="url" content="https://juejin.cn/user/493019579297533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain v1.x Models 完全指南：从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/493019579297533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈暖秋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:24:41.000Z" title="Fri Jan 30 2026 01:24:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="darcula">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#bababa}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#6896ba}.hljs-code,.hljs-selector-class{color:#a6e22e}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#cb7832}.hljs-params{color:#b9b9b9}.hljs-string{color:#6a8759}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-type{color:#e0c46c}.hljs-comment,.hljs-deletion,.hljs-meta{color:#7f7f7f}</style><blockquote>
<p>本文将深入探讨 LangChain 中的 Models 模块，涵盖基础使用、工具调用、结构化输出、多模态处理等核心功能，并提供丰富的代码示例。</p>
</blockquote>
<h2 data-id="heading-0">📚 目录</h2>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-langchain-models" title="#%E4%BB%80%E4%B9%88%E6%98%AF-langchain-models">什么是 LangChain Models</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95" title="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a></li>
<li><a href="#%E4%B8%89%E7%A7%8D%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F" title="#%E4%B8%89%E7%A7%8D%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F">三种调用方式</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8tool-calling" title="#%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8tool-calling">工具调用（Tool Calling）</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA" title="#%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA">结构化输出</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" title="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">高级特性</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B">实战案例</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">什么是 LangChain Models</h2>
<p><strong>Large Language Models (LLMs)</strong> 是强大的 AI 工具，能够像人类一样理解和生成文本。它们足够versatile（多才多艺），可以编写内容、翻译语言、总结文本和回答问题，而无需针对每个任务进行专门训练。</p>
<h3 data-id="heading-2">核心能力</h3>
<p>现代 LLM 除了文本生成外，还支持：</p>






























<table><thead><tr><th>能力</th><th>描述</th><th>应用场景</th></tr></thead><tbody><tr><td>🔨 <strong>工具调用</strong></td><td>调用外部工具（如数据库查询或API调用）并在响应中使用结果</td><td>数据查询、API集成</td></tr><tr><td>📐 <strong>结构化输出</strong></td><td>模型响应遵循定义的格式</td><td>数据提取、表单填充</td></tr><tr><td>🖼️ <strong>多模态</strong></td><td>处理和返回文本以外的数据（图像、音频、视频）</td><td>图像识别、语音处理</td></tr><tr><td>🧠 <strong>推理</strong></td><td>执行多步推理得出结论</td><td>复杂问题解决</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[用户输入] --&gt; B[LangChain Models]
    B --&gt; C[文本生成]
    B --&gt; D[工具调用]
    B --&gt; E[结构化输出]
    B --&gt; F[多模态处理]
    B --&gt; G[推理分析]
    C --&gt; H[最终响应]
    D --&gt; H
    E --&gt; H
    F --&gt; H
    G --&gt; H
</code></pre>
<hr/>
<h2 data-id="heading-3">基础用法</h2>
<h3 data-id="heading-4">1. 初始化模型</h3>
<p>LangChain 提供了统一的 <code>init_chat_model</code> 接口，支持多个主流模型提供商：</p>
<h4 data-id="heading-5">OpenAI 模型</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 设置 API Key</span>
os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = <span class="hljs-string">"sk-..."</span>

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 简单调用</span>
response = model.invoke(<span class="hljs-string">"为什么鹦鹉会说话?"</span>)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h4 data-id="heading-6">Anthropic Claude 模型</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

os.environ[<span class="hljs-string">"ANTHROPIC_API_KEY"</span>] = <span class="hljs-string">"sk-..."</span>

model = init_chat_model(<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>)
response = model.invoke(<span class="hljs-string">"解释量子计算的基本原理"</span>)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h4 data-id="heading-7">Google Gemini 模型</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

os.environ[<span class="hljs-string">"GOOGLE_API_KEY"</span>] = <span class="hljs-string">"..."</span>

model = init_chat_model(<span class="hljs-string">"google_genai:gemini-2.5-flash-lite"</span>)
response = model.invoke(<span class="hljs-string">"总结人工智能的发展历史"</span>)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h3 data-id="heading-8">2. 配置模型参数</h3>
<pre><code class="hljs language-python" lang="python">model = init_chat_model(
    <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    <span class="hljs-comment"># 模型参数配置</span>
    temperature=<span class="hljs-number">0.7</span>,      <span class="hljs-comment"># 控制输出的随机性 (0-1)</span>
    timeout=<span class="hljs-number">30</span>,           <span class="hljs-comment"># 超时时间（秒）</span>
    max_tokens=<span class="hljs-number">1000</span>,      <span class="hljs-comment"># 最大输出token数</span>
)

response = model.invoke(<span class="hljs-string">"写一首关于春天的诗"</span>)
</code></pre>
<p><strong>参数说明：</strong></p>








































<table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>model</code></td><td>string</td><td>模型名称或标识符</td></tr><tr><td><code>api_key</code></td><td>string</td><td>API密钥（通常通过环境变量设置）</td></tr><tr><td><code>temperature</code></td><td>number</td><td>控制输出随机性，越高越有创意</td></tr><tr><td><code>max_tokens</code></td><td>number</td><td>限制输出的最大token数</td></tr><tr><td><code>timeout</code></td><td>number</td><td>请求超时时间（秒）</td></tr><tr><td><code>max_retries</code></td><td>number</td><td>请求失败时的最大重试次数</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">三种调用方式</h2>
<h3 data-id="heading-10">1. Invoke - 标准调用</h3>
<p>最直接的调用方式，等待完整响应后返回：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 单条消息</span>
response = model.invoke(<span class="hljs-string">"鹦鹉为什么有彩色的羽毛?"</span>)
<span class="hljs-built_in">print</span>(response.content)

<span class="hljs-comment"># 对话历史</span>
conversation = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个翻译助手，将英文翻译成法语。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"翻译: I love programming."</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"J'adore la programmation."</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"翻译: I love building applications."</span>}
]

response = model.invoke(conversation)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<p><strong>使用消息对象格式：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage

conversation = [
    SystemMessage(<span class="hljs-string">"你是一个专业的Python编程助手。"</span>),
    HumanMessage(<span class="hljs-string">"如何在Python中创建装饰器?"</span>),
]

response = model.invoke(conversation)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h3 data-id="heading-11">2. Stream - 流式输出</h3>
<p>实时显示生成的内容，改善用户体验：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基础文本流式输出</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"AI: "</span>, end=<span class="hljs-string">""</span>)
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"为什么鹦鹉有彩色的羽毛?"</span>):
    <span class="hljs-built_in">print</span>(chunk.content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>()

<span class="hljs-comment"># 流式输出并构建完整消息</span>
full_message = <span class="hljs-literal">None</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"天空是什么颜色?"</span>):
    full_message = chunk <span class="hljs-keyword">if</span> full_message <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> full_message + chunk
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前累积: <span class="hljs-subst">{full_message.content}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n完整消息: <span class="hljs-subst">{full_message.content}</span>"</span>)
</code></pre>
<p><strong>流式处理工具调用和推理：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"天空是什么颜色?"</span>):
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> chunk.content_blocks:
        <span class="hljs-keyword">if</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"推理: <span class="hljs-subst">{block.get(<span class="hljs-string">'reasoning'</span>)}</span>"</span>)
        <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"tool_call_chunk"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具调用: <span class="hljs-subst">{block}</span>"</span>)
        <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"text"</span>:
            <span class="hljs-built_in">print</span>(block[<span class="hljs-string">"text"</span>], end=<span class="hljs-string">""</span>)
</code></pre>
<h3 data-id="heading-12">3. Batch - 批量处理</h3>
<p>并行处理多个独立请求，提高性能和降低成本：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 批量调用</span>
questions = [
    <span class="hljs-string">"为什么鹦鹉有彩色的羽毛?"</span>,
    <span class="hljs-string">"飞机是如何飞行的?"</span>,
    <span class="hljs-string">"什么是量子计算?"</span>
]

responses = model.batch(questions)
<span class="hljs-keyword">for</span> question, response <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(questions, responses):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{question}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回答: <span class="hljs-subst">{response.content}</span>\n"</span>)
</code></pre>
<p><strong>批量流式处理（按完成顺序返回）：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> response <span class="hljs-keyword">in</span> model.batch_as_completed(questions):
    index = response.index  <span class="hljs-comment"># 原始输入的索引</span>
    result = response.result
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题 <span class="hljs-subst">{index}</span>: <span class="hljs-subst">{questions[index]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回答: <span class="hljs-subst">{result.content}</span>\n"</span>)
</code></pre>
<p><strong>控制并发数：</strong></p>
<pre><code class="hljs language-python" lang="python">responses = model.batch(
    questions,
    config={
        <span class="hljs-string">'max_concurrency'</span>: <span class="hljs-number">5</span>,  <span class="hljs-comment"># 限制为5个并行调用</span>
    }
)
</code></pre>
<hr/>
<h2 data-id="heading-13">工具调用（Tool Calling）</h2>
<p>工具调用是 LLM 最强大的功能之一，允许模型调用外部工具来执行特定任务。</p>
<h3 data-id="heading-14">工具调用流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant M as 模型
    participant T as 工具

    U-&gt;&gt;M: "旧金山和纽约的天气如何?"
    M-&gt;&gt;M: 分析请求并决定需要的工具

    par 并行工具调用
        M-&gt;&gt;T: get_weather("San Francisco")
        M-&gt;&gt;T: get_weather("New York")
    end

    par 工具执行
        T--&gt;&gt;M: 旧金山天气数据
        T--&gt;&gt;M: 纽约天气数据
    end

    M-&gt;&gt;M: 处理结果并生成响应
    M-&gt;&gt;U: "旧金山: 72°F晴天, 纽约: 68°F多云"
</code></pre>
<h3 data-id="heading-15">1. 定义和绑定工具</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-comment"># 定义工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定地点的天气信息。
    
    Args:
        location: 城市和州，例如 San Francisco, CA
    """</span>
    <span class="hljs-comment"># 实际应用中这里会调用天气API</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{location}</span>当前天气晴朗，温度22°C。"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_population</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""获取指定地点的人口数量。
    
    Args:
        location: 城市和州，例如 San Francisco, CA
    """</span>
    <span class="hljs-comment"># 实际应用中这里会查询数据库</span>
    populations = {
        <span class="hljs-string">"San Francisco, CA"</span>: <span class="hljs-number">873965</span>,
        <span class="hljs-string">"New York, NY"</span>: <span class="hljs-number">8336817</span>,
        <span class="hljs-string">"Los Angeles, CA"</span>: <span class="hljs-number">3979576</span>
    }
    <span class="hljs-keyword">return</span> populations.get(location, <span class="hljs-number">0</span>)

<span class="hljs-comment"># 绑定工具到模型</span>
model_with_tools = model.bind_tools([get_weather, get_population])

<span class="hljs-comment"># 调用模型</span>
response = model_with_tools.invoke(<span class="hljs-string">"波士顿的天气如何?"</span>)

<span class="hljs-comment"># 查看模型生成的工具调用</span>
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{tool_call[<span class="hljs-string">'id'</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-16">2. 工具执行循环</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""计算数学表达式。
    
    Args:
        expression: 数学表达式，如 "2 + 2" 或 "10 * 5"
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(expression)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"计算错误"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_database</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在数据库中搜索信息。
    
    Args:
        query: 搜索查询
    """</span>
    <span class="hljs-comment"># 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"找到关于'<span class="hljs-subst">{query}</span>'的相关信息"</span>

<span class="hljs-comment"># 绑定工具</span>
model_with_tools = model.bind_tools([calculator, search_database])

<span class="hljs-comment"># 步骤1: 模型生成工具调用</span>
messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"计算 (15 + 25) * 2 的结果"</span>}]
ai_msg = model_with_tools.invoke(messages)
messages.append(ai_msg)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"模型请求调用工具: <span class="hljs-subst">{ai_msg.tool_calls}</span>"</span>)

<span class="hljs-comment"># 步骤2: 执行工具并收集结果</span>
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
    <span class="hljs-keyword">if</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'calculator'</span>:
        result = calculator.invoke(tool_call)
        messages.append(result)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具执行结果: <span class="hljs-subst">{result.content}</span>"</span>)

<span class="hljs-comment"># 步骤3: 将结果传回模型生成最终响应</span>
final_response = model_with_tools.invoke(messages)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终回答: <span class="hljs-subst">{final_response.content}</span>"</span>)
</code></pre>
<h3 data-id="heading-17">3. 强制工具调用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 强制使用任意工具</span>
model_with_tools = model.bind_tools(
    [get_weather, get_population], 
    tool_choice=<span class="hljs-string">"any"</span>
)

<span class="hljs-comment"># 强制使用特定工具</span>
model_with_tools = model.bind_tools(
    [get_weather, get_population], 
    tool_choice=<span class="hljs-string">"get_weather"</span>
)

response = model_with_tools.invoke(<span class="hljs-string">"今天天气怎么样?"</span>)
</code></pre>
<h3 data-id="heading-18">4. 并行工具调用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模型可以同时调用多个工具</span>
model_with_tools = model.bind_tools([get_weather, get_population])

response = model_with_tools.invoke(
    <span class="hljs-string">"比较波士顿和东京的天气，并告诉我哪个城市人口更多"</span>
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"工具调用列表:"</span>)
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>(<span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>)"</span>)

<span class="hljs-comment"># 输出可能是:</span>
<span class="hljs-comment"># - get_weather({'location': 'Boston'})</span>
<span class="hljs-comment"># - get_weather({'location': 'Tokyo'})</span>
<span class="hljs-comment"># - get_population({'location': 'Boston'})</span>
<span class="hljs-comment"># - get_population({'location': 'Tokyo'})</span>
</code></pre>
<h3 data-id="heading-19">5. 流式工具调用</h3>
<pre><code class="hljs language-python" lang="python">model_with_tools = model.bind_tools([get_weather])

<span class="hljs-built_in">print</span>(<span class="hljs-string">"流式接收工具调用:"</span>)
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model_with_tools.stream(<span class="hljs-string">"北京和上海的天气如何?"</span>):
    <span class="hljs-keyword">for</span> tool_chunk <span class="hljs-keyword">in</span> chunk.tool_call_chunks:
        <span class="hljs-keyword">if</span> name := tool_chunk.get(<span class="hljs-string">"name"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n工具: <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">if</span> args := tool_chunk.get(<span class="hljs-string">"args"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数片段: <span class="hljs-subst">{args}</span>"</span>, end=<span class="hljs-string">""</span>)
</code></pre>
<hr/>
<h2 data-id="heading-20">结构化输出</h2>
<p>结构化输出确保模型的响应遵循预定义的格式，这对于数据提取和后续处理非常有用。</p>
<h3 data-id="heading-21">1. 使用 Pydantic 模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Actor</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""演员信息"""</span>
    name: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"演员姓名"</span>)
    role: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"角色名称"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Movie</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""电影详细信息"""</span>
    title: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"电影标题"</span>)
    year: <span class="hljs-built_in">int</span> = Field(..., description=<span class="hljs-string">"上映年份"</span>)
    director: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"导演姓名"</span>)
    rating: <span class="hljs-built_in">float</span> = Field(..., description=<span class="hljs-string">"评分（满分10分）"</span>)
    cast: <span class="hljs-type">List</span>[Actor] = Field(..., description=<span class="hljs-string">"主要演员列表"</span>)
    genres: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(..., description=<span class="hljs-string">"电影类型"</span>)
    budget: <span class="hljs-built_in">float</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"预算（百万美元）"</span>)

<span class="hljs-comment"># 绑定结构化输出</span>
model_with_structure = model.with_structured_output(Movie)

<span class="hljs-comment"># 调用模型</span>
response = model_with_structure.invoke(
    <span class="hljs-string">"提供电影《盗梦空间》的详细信息"</span>
)

<span class="hljs-comment"># 输出是强类型的 Pydantic 对象</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"标题: <span class="hljs-subst">{response.title}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"年份: <span class="hljs-subst">{response.year}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"导演: <span class="hljs-subst">{response.director}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"评分: <span class="hljs-subst">{response.rating}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"主演:"</span>)
<span class="hljs-keyword">for</span> actor <span class="hljs-keyword">in</span> response.cast:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{actor.name}</span> 饰演 <span class="hljs-subst">{actor.role}</span>"</span>)
</code></pre>
<h3 data-id="heading-22">2. 使用 TypedDict</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict, Annotated

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MovieDict</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""电影信息字典"""</span>
    title: Annotated[<span class="hljs-built_in">str</span>, ..., <span class="hljs-string">"电影标题"</span>]
    year: Annotated[<span class="hljs-built_in">int</span>, ..., <span class="hljs-string">"上映年份"</span>]
    director: Annotated[<span class="hljs-built_in">str</span>, ..., <span class="hljs-string">"导演姓名"</span>]
    rating: Annotated[<span class="hljs-built_in">float</span>, ..., <span class="hljs-string">"评分（满分10分）"</span>]

model_with_structure = model.with_structured_output(MovieDict)
response = model_with_structure.invoke(<span class="hljs-string">"介绍电影《星际穿越》"</span>)

<span class="hljs-comment"># 输出是字典</span>
<span class="hljs-built_in">print</span>(response)
<span class="hljs-comment"># {'title': '星际穿越', 'year': 2014, 'director': '克里斯托弗·诺兰', 'rating': 8.6}</span>
</code></pre>
<h3 data-id="heading-23">3. 使用 JSON Schema</h3>
<pre><code class="hljs language-python" lang="python">json_schema = {
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Product"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"产品信息"</span>,
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
    <span class="hljs-string">"properties"</span>: {
        <span class="hljs-string">"name"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"产品名称"</span>
        },
        <span class="hljs-string">"price"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"价格"</span>
        },
        <span class="hljs-string">"in_stock"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"boolean"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"是否有货"</span>
        },
        <span class="hljs-string">"tags"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"array"</span>,
            <span class="hljs-string">"items"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>},
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"产品标签"</span>
        }
    },
    <span class="hljs-string">"required"</span>: [<span class="hljs-string">"name"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"in_stock"</span>]
}

model_with_structure = model.with_structured_output(
    json_schema,
    method=<span class="hljs-string">"json_schema"</span>,
)

response = model_with_structure.invoke(
    <span class="hljs-string">"提供iPhone 15 Pro的产品信息"</span>
)

<span class="hljs-built_in">print</span>(response)
</code></pre>
<h3 data-id="heading-24">4. 包含原始消息</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BookInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""书籍信息"""</span>
    title: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"书名"</span>)
    author: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"作者"</span>)
    year: <span class="hljs-built_in">int</span> = Field(..., description=<span class="hljs-string">"出版年份"</span>)

<span class="hljs-comment"># 设置 include_raw=True 以获取原始消息</span>
model_with_structure = model.with_structured_output(
    BookInfo, 
    include_raw=<span class="hljs-literal">True</span>
)

response = model_with_structure.invoke(<span class="hljs-string">"介绍《三体》这本书"</span>)

<span class="hljs-comment"># 响应包含三个字段</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析结果: <span class="hljs-subst">{response[<span class="hljs-string">'parsed'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始消息: <span class="hljs-subst">{response[<span class="hljs-string">'raw'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析错误: <span class="hljs-subst">{response[<span class="hljs-string">'parsing_error'</span>]}</span>"</span>)

<span class="hljs-comment"># 访问token使用情况</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用的tokens: <span class="hljs-subst">{response[<span class="hljs-string">'raw'</span>].usage_metadata}</span>"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-25">高级特性</h2>
<h3 data-id="heading-26">1. 多模态处理</h3>
<p>某些模型可以处理图像、音频和视频等非文本数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 初始化支持多模态的模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 发送图像</span>
message = {
    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"content"</span>: [
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"这张图片中有什么?"</span>},
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://example.com/image.jpg"</span>
            }
        }
    ]
}

response = model.invoke([message])
<span class="hljs-built_in">print</span>(response.content)

<span class="hljs-comment"># 处理Base64编码的图像</span>
<span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"local_image.jpg"</span>, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
    base64_image = base64.b64encode(image_file.read()).decode()

message = {
    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"content"</span>: [
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"描述这张图片"</span>},
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
            }
        }
    ]
}

response = model.invoke([message])
</code></pre>
<h3 data-id="heading-27">2. 推理过程可见化</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 流式显示推理过程</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"解释为什么鹦鹉有彩色的羽毛?"</span>):
    reasoning_steps = [
        r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> chunk.content_blocks 
        <span class="hljs-keyword">if</span> r[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>
    ]
    <span class="hljs-keyword">if</span> reasoning_steps:
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> reasoning_steps:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"推理: <span class="hljs-subst">{step[<span class="hljs-string">'reasoning'</span>]}</span>"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(chunk.content, end=<span class="hljs-string">""</span>)

<span class="hljs-comment"># 获取完整推理过程</span>
response = model.invoke(<span class="hljs-string">"为什么鹦鹉有彩色的羽毛?"</span>)
reasoning_steps = [
    b <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> response.content_blocks 
    <span class="hljs-keyword">if</span> b[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>
]
full_reasoning = <span class="hljs-string">" "</span>.join(
    step[<span class="hljs-string">"reasoning"</span>] <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> reasoning_steps
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"完整推理过程: <span class="hljs-subst">{full_reasoning}</span>"</span>)
</code></pre>
<h3 data-id="heading-28">3. Token 使用统计</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> get_usage_metadata_callback

model_1 = init_chat_model(model=<span class="hljs-string">"gpt-4o-mini"</span>)
model_2 = init_chat_model(model=<span class="hljs-string">"claude-haiku-4-5-20251001"</span>)

<span class="hljs-comment"># 使用上下文管理器追踪token使用</span>
<span class="hljs-keyword">with</span> get_usage_metadata_callback() <span class="hljs-keyword">as</span> cb:
    model_1.invoke(<span class="hljs-string">"你好"</span>)
    model_2.invoke(<span class="hljs-string">"你好"</span>)
    <span class="hljs-built_in">print</span>(cb.usage_metadata)

<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#     'gpt-4o-mini-2024-07-18': {</span>
<span class="hljs-comment">#         'input_tokens': 8,</span>
<span class="hljs-comment">#         'output_tokens': 10,</span>
<span class="hljs-comment">#         'total_tokens': 18</span>
<span class="hljs-comment">#     },</span>
<span class="hljs-comment">#     'claude-haiku-4-5-20251001': {</span>
<span class="hljs-comment">#         'input_tokens': 8,</span>
<span class="hljs-comment">#         'output_tokens': 21,</span>
<span class="hljs-comment">#         'total_tokens': 29</span>
<span class="hljs-comment">#     }</span>
<span class="hljs-comment"># }</span>
</code></pre>
<h3 data-id="heading-29">4. 可配置模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 创建运行时可配置的模型</span>
configurable_model = init_chat_model(temperature=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 使用不同的模型运行</span>
configurable_model.invoke(
    <span class="hljs-string">"你的名字是什么?"</span>,
    config={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"model"</span>: <span class="hljs-string">"gpt-4o-mini"</span>}},
)

configurable_model.invoke(
    <span class="hljs-string">"你的名字是什么?"</span>,
    config={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"model"</span>: <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>}},
)

<span class="hljs-comment"># 配置默认值和可配置字段</span>
model = init_chat_model(
    model=<span class="hljs-string">"gpt-4o-mini"</span>,
    temperature=<span class="hljs-number">0</span>,
    configurable_fields=(
        <span class="hljs-string">"model"</span>, 
        <span class="hljs-string">"model_provider"</span>, 
        <span class="hljs-string">"temperature"</span>, 
        <span class="hljs-string">"max_tokens"</span>
    ),
    config_prefix=<span class="hljs-string">"first"</span>,
)

<span class="hljs-comment"># 运行时覆盖配置</span>
model.invoke(
    <span class="hljs-string">"你好"</span>,
    config={
        <span class="hljs-string">"configurable"</span>: {
            <span class="hljs-string">"first_model"</span>: <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
            <span class="hljs-string">"first_temperature"</span>: <span class="hljs-number">0.5</span>,
            <span class="hljs-string">"first_max_tokens"</span>: <span class="hljs-number">100</span>,
        }
    },
)
</code></pre>
<h3 data-id="heading-30">5. 速率限制</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.rate_limiters <span class="hljs-keyword">import</span> InMemoryRateLimiter
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 创建速率限制器</span>
rate_limiter = InMemoryRateLimiter(
    requests_per_second=<span class="hljs-number">0.1</span>,        <span class="hljs-comment"># 每10秒1个请求</span>
    check_every_n_seconds=<span class="hljs-number">0.1</span>,      <span class="hljs-comment"># 每100ms检查一次</span>
    max_bucket_size=<span class="hljs-number">10</span>,             <span class="hljs-comment"># 控制最大突发大小</span>
)

<span class="hljs-comment"># 应用速率限制</span>
model = init_chat_model(
    model=<span class="hljs-string">"gpt-4o"</span>,
    model_provider=<span class="hljs-string">"openai"</span>,
    rate_limiter=rate_limiter
)

<span class="hljs-comment"># 批量请求会被限速</span>
responses = model.batch([
    <span class="hljs-string">"问题1"</span>,
    <span class="hljs-string">"问题2"</span>,
    <span class="hljs-string">"问题3"</span>,
])
</code></pre>
<hr/>
<h2 data-id="heading-31">实战案例</h2>
<h3 data-id="heading-32">案例1: 智能客服助手</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-comment"># 定义工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_order_status</span>(<span class="hljs-params">order_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询订单状态
    
    Args:
        order_id: 订单编号
    """</span>
    <span class="hljs-comment"># 模拟查询订单</span>
    orders = {
        <span class="hljs-string">"ORD001"</span>: <span class="hljs-string">"已发货，预计明天送达"</span>,
        <span class="hljs-string">"ORD002"</span>: <span class="hljs-string">"正在处理中"</span>,
        <span class="hljs-string">"ORD003"</span>: <span class="hljs-string">"已送达"</span>
    }
    <span class="hljs-keyword">return</span> orders.get(order_id, <span class="hljs-string">"未找到该订单"</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_product_stock</span>(<span class="hljs-params">product_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""查询产品库存
    
    Args:
        product_name: 产品名称
    """</span>
    stock = {
        <span class="hljs-string">"iPhone 15"</span>: {<span class="hljs-string">"available"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">50</span>},
        <span class="hljs-string">"MacBook Pro"</span>: {<span class="hljs-string">"available"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">30</span>},
        <span class="hljs-string">"AirPods"</span>: {<span class="hljs-string">"available"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">0</span>}
    }
    <span class="hljs-keyword">return</span> stock.get(product_name, {<span class="hljs-string">"available"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">0</span>})

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, temperature=<span class="hljs-number">0.3</span>)
model_with_tools = model.bind_tools([
    query_order_status, 
    check_product_stock
])

<span class="hljs-comment"># 客服对话</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">customer_service_chat</span>(<span class="hljs-params">user_message: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""处理客户咨询"""</span>
    messages = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, 
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个专业的客服助手，帮助用户查询订单和产品信息。"</span>
        },
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_message}
    ]
    
    <span class="hljs-comment"># 模型生成工具调用</span>
    ai_msg = model_with_tools.invoke(messages)
    messages.append(ai_msg)
    
    <span class="hljs-comment"># 执行工具</span>
    <span class="hljs-keyword">if</span> ai_msg.tool_calls:
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
            <span class="hljs-keyword">if</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'query_order_status'</span>:
                result = query_order_status.invoke(tool_call)
            <span class="hljs-keyword">elif</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'check_product_stock'</span>:
                result = check_product_stock.invoke(tool_call)
            messages.append(result)
        
        <span class="hljs-comment"># 获取最终响应</span>
        final_response = model_with_tools.invoke(messages)
        <span class="hljs-keyword">return</span> final_response.content
    
    <span class="hljs-keyword">return</span> ai_msg.content

<span class="hljs-comment"># 测试</span>
<span class="hljs-built_in">print</span>(customer_service_chat(<span class="hljs-string">"我的订单ORD001什么时候能送到?"</span>))
<span class="hljs-built_in">print</span>(customer_service_chat(<span class="hljs-string">"iPhone 15还有货吗?"</span>))
</code></pre>
<h3 data-id="heading-33">案例2: 数据提取系统</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 定义数据结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""联系信息"""</span>
    email: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"邮箱地址"</span>)
    phone: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"电话号码"</span>)
    address: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"地址"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""公司信息"""</span>
    name: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"公司名称"</span>)
    industry: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"行业"</span>)
    founded_year: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"成立年份"</span>)
    employees: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"员工数量"</span>)
    contact: ContactInfo = Field(..., description=<span class="hljs-string">"联系方式"</span>)

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)
extractor = model.with_structured_output(Company)

<span class="hljs-comment"># 待提取的文本</span>
text = <span class="hljs-string">"""
科技创新公司是一家成立于2015年的人工智能公司。
公司目前有超过500名员工，专注于开发企业级AI解决方案。
联系方式: info@techinnov.com, 电话: 400-888-8888
总部位于北京市海淀区中关村大街1号
"""</span>

<span class="hljs-comment"># 提取结构化数据</span>
company_info = extractor.invoke(<span class="hljs-string">f"从以下文本中提取公司信息:\n<span class="hljs-subst">{text}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"公司名称: <span class="hljs-subst">{company_info.name}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"行业: <span class="hljs-subst">{company_info.industry}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"成立年份: <span class="hljs-subst">{company_info.founded_year}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"员工数: <span class="hljs-subst">{company_info.employees}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"邮箱: <span class="hljs-subst">{company_info.contact.email}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"电话: <span class="hljs-subst">{company_info.contact.phone}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"地址: <span class="hljs-subst">{company_info.contact.address}</span>"</span>)
</code></pre>
<h3 data-id="heading-34">案例3: 多步骤任务执行器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在网络上搜索信息
    
    Args:
        query: 搜索查询
    """</span>
    <span class="hljs-comment"># 模拟网络搜索</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"关于'<span class="hljs-subst">{query}</span>'的搜索结果: [相关信息...]"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_text</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""总结文本内容
    
    Args:
        text: 要总结的文本
    """</span>
    <span class="hljs-comment"># 模拟文本总结</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"总结: <span class="hljs-subst">{text[:<span class="hljs-number">100</span>]}</span>..."</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_to_database</span>(<span class="hljs-params">data: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""保存数据到数据库
    
    Args:
        data: 要保存的数据
    """</span>
    <span class="hljs-comment"># 模拟数据库保存</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据已保存: <span class="hljs-subst">{data[:<span class="hljs-number">50</span>]}</span>..."</span>

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0</span>)
model_with_tools = model.bind_tools([
    search_web,
    summarize_text,
    save_to_database
])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_complex_task</span>(<span class="hljs-params">task_description: <span class="hljs-built_in">str</span>, max_iterations: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
    <span class="hljs-string">"""执行复杂的多步骤任务"""</span>
    messages = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个任务执行助手，可以搜索信息、总结内容和保存数据。"</span>
        },
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: task_description}
    ]
    
    iteration = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> iteration &lt; max_iterations:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 迭代 <span class="hljs-subst">{iteration + <span class="hljs-number">1</span>}</span> ---"</span>)
        
        <span class="hljs-comment"># 模型决定下一步操作</span>
        ai_msg = model_with_tools.invoke(messages)
        messages.append(ai_msg)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ai_msg.tool_calls:
            <span class="hljs-comment"># 没有工具调用，任务完成</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务完成: <span class="hljs-subst">{ai_msg.content}</span>"</span>)
            <span class="hljs-keyword">return</span> ai_msg.content
        
        <span class="hljs-comment"># 执行所有工具调用</span>
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
            tool_name = tool_call[<span class="hljs-string">'name'</span>]
            tool_args = tool_call[<span class="hljs-string">'args'</span>]
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用工具: <span class="hljs-subst">{tool_name}</span>(<span class="hljs-subst">{tool_args}</span>)"</span>)
            
            <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">'search_web'</span>:
                result = search_web.invoke(tool_call)
            <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">'summarize_text'</span>:
                result = summarize_text.invoke(tool_call)
            <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">'save_to_database'</span>:
                result = save_to_database.invoke(tool_call)
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具结果: <span class="hljs-subst">{result.content}</span>"</span>)
            messages.append(result)
        
        iteration += <span class="hljs-number">1</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">"达到最大迭代次数"</span>

<span class="hljs-comment"># 执行复杂任务</span>
task = <span class="hljs-string">"""
请帮我完成以下任务:
1. 搜索"人工智能最新发展趋势"
2. 总结搜索结果
3. 将总结保存到数据库
"""</span>

result = execute_complex_task(task)
</code></pre>
<h3 data-id="heading-35">案例4: 图像分析助手</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_image</span>(<span class="hljs-params">image_path: <span class="hljs-built_in">str</span>, question: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""分析图像并回答问题"""</span>
    <span class="hljs-comment"># 读取图像并转换为base64</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
        base64_image = base64.b64encode(image_file.read()).decode()
    
    <span class="hljs-comment"># 初始化支持视觉的模型</span>
    model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)
    
    <span class="hljs-comment"># 构建消息</span>
    message = {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: question},
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
                }
            }
        ]
    }
    
    <span class="hljs-comment"># 调用模型</span>
    response = model.invoke([message])
    <span class="hljs-keyword">return</span> response.content

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-comment"># result = analyze_image("product.jpg", "这个产品有什么特点?")</span>
<span class="hljs-comment"># print(result)</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">最佳实践</h2>
<h3 data-id="heading-37">1. 选择合适的模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 快速任务使用较小的模型</span>
quick_model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, temperature=<span class="hljs-number">0.3</span>)

<span class="hljs-comment"># 复杂任务使用更强大的模型</span>
advanced_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0.7</span>)

<span class="hljs-comment"># 根据任务类型选择</span>
<span class="hljs-keyword">if</span> task_complexity == <span class="hljs-string">"simple"</span>:
    model = quick_model
<span class="hljs-keyword">else</span>:
    model = advanced_model
</code></pre>
<h3 data-id="heading-38">2. 合理设置temperature</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需要确定性输出（如数据提取）</span>
deterministic_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 需要创造性输出（如写作）</span>
creative_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0.9</span>)

<span class="hljs-comment"># 平衡方案</span>
balanced_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0.5</span>)
</code></pre>
<h3 data-id="heading-39">3. 错误处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, max_retries=<span class="hljs-number">3</span>, timeout=<span class="hljs-number">30</span>)

<span class="hljs-keyword">try</span>:
    response = model.invoke(<span class="hljs-string">"你的问题"</span>)
    <span class="hljs-built_in">print</span>(response.content)
<span class="hljs-keyword">except</span> TimeoutError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求超时，请稍后重试"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-40">4. 成本优化</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用批处理减少API调用</span>
questions = [<span class="hljs-string">"问题1"</span>, <span class="hljs-string">"问题2"</span>, <span class="hljs-string">"问题3"</span>]
responses = model.batch(questions, config={<span class="hljs-string">'max_concurrency'</span>: <span class="hljs-number">3</span>})

<span class="hljs-comment"># 使用缓存（如果提供商支持）</span>
<span class="hljs-keyword">from</span> langchain.cache <span class="hljs-keyword">import</span> InMemoryCache
<span class="hljs-keyword">from</span> langchain.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_llm_cache

set_llm_cache(InMemoryCache())

<span class="hljs-comment"># 重复查询会从缓存返回</span>
response1 = model.invoke(<span class="hljs-string">"什么是AI?"</span>)  <span class="hljs-comment"># API调用</span>
response2 = model.invoke(<span class="hljs-string">"什么是AI?"</span>)  <span class="hljs-comment"># 从缓存返回</span>
</code></pre>
<hr/>
<h2 data-id="heading-41">总结</h2>
<p>LangChain Models 提供了强大而灵活的接口来使用各种大语言模型：</p>
<p>✅ <strong>统一接口</strong> - 支持多个模型提供商（OpenAI、Anthropic、Google等）</p>
<p>✅ <strong>多种调用方式</strong> - Invoke、Stream、Batch满足不同场景需求</p>
<p>✅ <strong>工具调用</strong> - 让模型能够调用外部工具和API</p>
<p>✅ <strong>结构化输出</strong> - 确保输出格式符合预期</p>
<p>✅ <strong>高级特性</strong> - 多模态、推理、速率限制等</p>
<p>✅ <strong>易于集成</strong> - 与LangChain生态系统无缝集成</p>
<p>通过本文的学习，你应该能够：</p>
<ul>
<li>初始化和配置各种模型</li>
<li>使用不同的调用方式处理任务</li>
<li>实现工具调用和结构化输出</li>
<li>应用高级特性解决实际问题</li>
</ul>
<hr/>
<h2 data-id="heading-42">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmodels" target="_blank" title="https://docs.langchain.com/oss/python/langchain/models" ref="nofollow noopener noreferrer">LangChain 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">LangChain GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs" target="_blank" title="https://platform.openai.com/docs" ref="nofollow noopener noreferrer">OpenAI API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2F" target="_blank" title="https://docs.anthropic.com/" ref="nofollow noopener noreferrer">Anthropic API 文档</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[个人本地部署大模型和调用的常用方式]]></title>    <link>https://juejin.cn/post/7600670487408869428</link>    <guid>https://juejin.cn/post/7600670487408869428</guid>    <pubDate>2026-01-30T01:38:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487408869428" data-draft-id="7599586891084300322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="个人本地部署大模型和调用的常用方式"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-30T01:38:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄粱梦醒"/> <meta itemprop="url" content="https://juejin.cn/user/471062436386135"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            个人本地部署大模型和调用的常用方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/471062436386135/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄粱梦醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:38:29.000Z" title="Fri Jan 30 2026 01:38:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>部署大模型的方式有很多，比如ollama、vllm，个人常用的部署方式是使用ollama框架进行部署。</p>
<h2 data-id="heading-0">1 ollama</h2>
<h3 data-id="heading-1">1.1 ollama本地部署大模型</h3>
<p>步骤1:下载ollama软件</p>
<pre><code class="hljs language-linux" lang="linux"># download ollama software
curl -fsSL https://ollama.com/install.sh | sh
</code></pre>
<p>步骤2: 加载模型</p>
<ul>
<li>方法1:官网下载，优点方便，缺点仅支持官网列出来的模型</li>
</ul>
<pre><code class="hljs language-linux" lang="linux"># download model
ollama run kimi-k2.5:cloud # function1
ollama pull bge-m3  # function2
</code></pre>
<ul>
<li>方法2:个性化加载
去huggingface 下载gguf格式的模型，同时下载原生模型的其他配置文件放在一起
通过导入到ollama的model list里面</li>
</ul>
<p>如果有多卡的情况下，进行模型部署会优先进行单卡的显存占用，会出现负载不均衡的情况，这时候可以进行系统配置
<code>systemctl edit ollama.service</code>
进行如下修改</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Service]</span>
...
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"CUDA_VISIBLE_DEVICES=0,1,2,3"</span>  <span class="hljs-comment"># 指定要使用的GPU编号</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"OLLAMA_SCHED_SPREAD=1"</span>         <span class="hljs-comment"># 关键：启用跨GPU调度，负载均衡的关键</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"OLLAMA_KEEP_ALIVE=-1"</span>          <span class="hljs-comment"># 可选：模型常驻内存，避免频繁加载</span>
</code></pre>
<p>重启systemd服务
<strong><code>systemctl daemon-reload</code></strong></p>
<p>重启ollama服务
<code>systemctl restart ollama</code></p>
<h3 data-id="heading-2">1.2 调用ollama部署大模型</h3>
<p>相同服务器调用的方式，直接采用localhost的；不同服务器，需要进行如下操作：</p>
<ul>
<li>设置ollama的系统配置：和上面进行系统设置一样，需要加一个<code>Environment="OLLAMA_HOST=0.0.0.0:11434" </code></li>
<li>需要知道ollama部署的服务器可以公网访问的ip地址
查看方式<code>netstat -tn | grep ESTABLISHED</code>可以查看已经建立的访问端口设置，里面会涉及到公网ip可以找到</li>
<li>在下面用到url的地方使用该公网ip就可以正常进行远程访问了</li>
</ul>
<h4 data-id="heading-3">1.2.1 ollama rest api</h4>
<p><code>OpenAI</code> 的 <code>API</code> 接口是大模型应用开发中最常用、且集成度最高的 <code>API</code> 接口规范，其兼容接口主要包括：</p>
<ul>
<li><code>chat/completions</code></li>
<li><code>completions</code></li>
<li><code>models</code></li>
<li><code>embeddings</code></li>
</ul>
<p>下面的1.2.2和1.2.3中<code>/api/generate</code> 和 <code>/api/chat</code> 接口，其实就是 <code>Ollama</code> 兼容 <code>OpenAI</code> 的 <code>REST API</code> 接口的底层实现。其中:</p>
<ul>
<li><code>/api/generate</code> 接口对应 <code>OpenAI</code> 的 <code>completions</code> 接口；</li>
<li><code>/api/chat</code> 接口对应 <code>OpenAI</code> 的 <code>chat/completions</code> 接口；</li>
</ul>
<p>使用方式(流失输出)</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

client = OpenAI(
    base_url=<span class="hljs-string">'http://192.168.110.131:11434/v1/'</span>,
    api_key=<span class="hljs-string">'ollama'</span>,
)

messages = [
    {
        <span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-string">'content'</span>: <span class="hljs-string">'你好，请你介绍一下什么是人工智能？'</span>,
    }
]

<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 调用聊天接口</span>
    stream = client.chat.completions.create(
        model=<span class="hljs-string">'deepseek-r1:8b'</span>,
        messages=messages,
        stream=<span class="hljs-literal">True</span>
    )
    
    <span class="hljs-comment"># 处理流式响应</span>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> stream:
        <span class="hljs-keyword">if</span> chunk.choices[<span class="hljs-number">0</span>].delta.content <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-built_in">print</span>(chunk.choices[<span class="hljs-number">0</span>].delta.content, end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
            
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
</code></pre>
<h4 data-id="heading-4">1.2.2 generate的API</h4>
<p>对于<code>endpoints</code>来说，如果使用代码调用，常规的调用方式是通<code>requests</code>库进行调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests <span class="hljs-comment"># type: ignore</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 设置 API 端点</span>
generate_url = <span class="hljs-string">"http://192.168.110.131:11434/api/generate"</span>    <span class="hljs-comment"># 这里需要根据实际情况进行修改</span>

<span class="hljs-comment"># 示例数据</span>
generate_payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"deepseek-r1:7b"</span>,   <span class="hljs-comment"># 这里需要根据实际情况进行修改</span>
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"请生成一个关于人工智能的简短介绍。"</span>,  <span class="hljs-comment"># 这里需要根据实际情况进行修改</span>
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,       <span class="hljs-comment"># 默认使用的是True，如果设置为False，则返回的是一个完整的响应，而不是一个流式响应</span>
}

<span class="hljs-comment"># 调用生成接口</span>
response_generate = requests.post(generate_url, json=generate_payload)
<span class="hljs-keyword">if</span> response_generate.status_code == <span class="hljs-number">200</span>:
    generate_response = response_generate.json()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成响应:"</span>, json.dumps(generate_response, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>))
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成请求失败:"</span>, response_generate.status_code, response_generate.text)
</code></pre>
<p>重要参数及其解释：</p>
<ul>
<li><code>model</code>:模型的名称，一定要是ollama上展示的模型的名称</li>
<li><code>prompt</code>:字符串，用户的提问</li>
<li><code>format</code>:</li>
<li><code>options</code>:对输入输出进行控制的参数，类型是字典
<ul>
<li><code>num_ctx</code>：输入的文本的token长度限制</li>
<li><code>num_predict</code>：输出文本的token限制长度(think模型的think部分也会计算在内)</li>
<li><code>temperature</code>,<code>top_k</code>, <code>top_p</code>：文本生成多样性的控制，temperature一般在0.5-0.7可以有效避免循环生成。</li>
<li><code>stop</code>：停止控制，遇到给定的字符串就停止继续生成文本。</li>
</ul>
</li>
<li><code>system</code>:系统提示词</li>
<li><code>stream</code>:是否流式打印，其中，是否流失对于需要的代码是不一样的</li>
<li><code>keep_alive</code>:模型加载在显存中如果长期不使用会浪费资源，ollama不设置该参数的话，通常保存5分钟加载，限定时间的话可以设置“10m”等，如果想永久加载就设置负数</li>
</ul>
<h4 data-id="heading-5">1.2.3 chat的API</h4>
<p>与generate参数基本一致，但是在使用上更符合chat用户的对话习惯，如使用messages传参而不是prompt，支持tools
调用方法和generate大部分一致，只是在url和传参是messages有一点不同</p>
<pre><code class="hljs language-python" lang="python">
generate_url = <span class="hljs-string">"http://localhost:11434/api/chat"</span>
generate_payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"llama-2-7b-chat-q4_0"</span>,
    <span class="hljs-string">"messages"</span>: [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"You are a helpful assistant."</span>
        },
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"What is the meaning of transformers?"</span>
        }
    ],
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>
}
</code></pre>
<h4 data-id="heading-6">1.2.4 总结</h4>
<p>openai兼容的接口，但是可使用的参数相对较少一些；
generate和chat这种原生api可控制性和灵活性更强。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎]]></title>    <link>https://juejin.cn/post/7600710943249580074</link>    <guid>https://juejin.cn/post/7600710943249580074</guid>    <pubDate>2026-01-30T01:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600710943249580074" data-draft-id="7600670487408738356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎"/> <meta itemprop="keywords" content="Rust,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T01:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rust知行社"/> <meta itemprop="url" content="https://juejin.cn/user/4186572019737624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186572019737624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rust知行社
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:50:50.000Z" title="Fri Jan 30 2026 01:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎</h2>
<p><strong>导读</strong>：上一篇我们聊了 Rust + Wasm + AI 的宏大愿景，这次我们真的把 BERT 模型塞进了浏览器。当用户在输入框敲下"这服务太棒了"的瞬间，模型已经完成推理，驱动满屏粒子爆发出青色光晕。全程零服务器请求，数据不出本地，甚至断网都能用。</p>
<h3 data-id="heading-1">1. 引言：打破 请求-响应 的旧枷锁</h3>
<h4 data-id="heading-2">算力的南水北调</h4>
<p>传统 AI 部署像南水北调 —— 把用户数据千里迢迢送到 GPU 集群，再把结果运回来。这种模式有三个问题：</p>
<ol>
<li><strong>延迟陷阱</strong>：网络抖动100ms就能毁掉输入流畅感，复杂推理直奔秒级。</li>
<li><strong>隐私裸奔</strong>：每一句私密输入都在公网<strong>裸奔</strong>，数据必须出域。</li>
<li><strong>成本黑洞</strong>：简单分类任务也在消耗昂贵GPU显存，断网即服务死亡。</li>
</ol>
<p>但算力格局正在发生剧变。M2 Max 的神经网络引擎已达 15.8 TOPS，高端安卓机的 NPU 也轻松突破 5 TOPS。</p>
<p><strong>Rust + Wasm 的出现，让我们能够实施算力突围：</strong> 将推理任务下放到用户的 CPU/GPU。这不仅是成本的节约，更是人机交互体验的质变。</p>
<h4 data-id="heading-3">端侧 AI 的杀手锏</h4>
<p>本次情感分析引擎在 MacBook Pro M1 的浏览器环境中可实现即时响应。</p>
<ul>
<li><strong>零延迟</strong>：用户松开键盘的瞬间，情感分数已出现在屏幕。</li>
<li><strong>隐私设计</strong>：数据不出内存，连本地存储都不沾。</li>
<li><strong>离线优先</strong>：一次加载，永久可用。</li>
</ul>
<h4 data-id="heading-4">本篇核心</h4>
<p>深度拆解如何利用 Rust 生态，让 <strong>uer/roberta-base-finetuned-jd-binary-chinese</strong> 模型在浏览器里实现毫秒级读心术。</p>
<h3 data-id="heading-5">2. 演示效果</h3>
<p>先展示一下在浏览器中的运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34886ec669124d06a4dc683c31efeb72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdOefpeihjOekvg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770342649&amp;x-signature=Yuh4ytNj%2FCzfc3pG%2BqqrOvUBJHQ%3D" alt="output1.jpg" loading="lazy"/></p>
<h3 data-id="heading-6">3. 技术选型：为什么是 Candle？</h3>
<h4 data-id="heading-7">Candle 的极致主义</h4>
<p><strong>Candle</strong> 是 HuggingFace 出品的纯 Rust 框架，专为<strong>轻量化推理</strong>而生， 关键优势在于：</p>
<ol>
<li><strong>真正的按需加载</strong>：模型结构代码编译进 Wasm，权重按需 fetch，无冗余运行时。</li>
<li><strong>零拷贝架构</strong>：通过 <code>Safetensors</code> 格式，Rust 可以直接将 Wasm 内存映射为张量，无需在 JS 和 Rust 之间进行昂贵的序列化。</li>
<li><strong>Wasm 友好</strong>：纯 Rust 实现，无 C++ FFI，编译产物干净利落。</li>
</ol>
<h4 data-id="heading-8">Safetensors：Wasm 时代的权重协议</h4>
<p>传统 PyTorch 的 <code>.bin</code> 格式，本质是 Pickle——<strong>可以执行任意代码</strong>，在浏览器里加载等于引狼入室。</p>
<p><strong>Safetensors</strong> 是新标准，核心优势在于：</p>
<ul>
<li><strong>零拷贝加载</strong>：内存映射后直接算，无需反序列化。</li>
<li><strong>安全</strong>：纯数据，无代码执行风险。</li>
<li><strong>自描述</strong>：JSON 头信息让浏览器提前知道内存布局。</li>
</ul>
<h3 data-id="heading-9">3. 架构设计：四层流水线</h3>
<p>整个引擎分为四层，每层都是性能战场：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────┐
│  资源层(fetch) │ ← 模型/分词器加载
├─────────────┤
│  转换层(Wasm)  │ ← 二进制流注入内存
├─────────────┤
│  计算层(Candle)│ ← 动态图构建与推理
├─────────────┤
│  交互层(Canvas)│ ← 粒子渲染与反馈
└─────────────┘
</code></pre>
<p><strong>关键设计决策</strong>：</p>
<ol>
<li><strong>Tokenizer 预处理</strong>：将 <code>tokenizer.json</code> 提前序列化为静态数组，避免运行时 JSON 解析开销。</li>
<li><strong>零拷贝张量映射 (Zero-copy Mapping)</strong>：利用 <code>Safetensors</code> 内存对齐 特性，将模型权重直接从 <code>ArrayBuffer</code> 映射为 <code>Candle</code> 张量，实现首屏启动零内存拷贝。</li>
<li><strong>内存池复用</strong>：推理中间结果复用同一块 Wasm 内存，避免 GC 压力。</li>
</ol>
<hr/>
<h3 data-id="heading-10">4. 工程实战：从零构建 Wasm 推理核</h3>
<h4 data-id="heading-11">Python 端：模型选择与转换</h4>
<p>最初选择的模型是 <code>jackietung/bert-base-chinese-finetuned-sentiment</code>，因为此模型支持  <code>.safetensors</code> 文件格式且支持中文环境。
但是试用过后，发现推理能力明显不行，比如输入 “难过”，结果推理结果为 “正向”。</p>
<p><code>uer/roberta-base-finetuned-jd-binary-chinese</code> 模型, 对中文的情感分析能力更加强大，并且在京东真实评论数据上微调，电商场景准。</p>
<p>但是此模型好久没有更新过，没有提供 <code>.safetensors</code> 格式的文件，所以只能自己进行转换。</p>
<p>转换代码在 <code>candle-senti-pulse/model2safetensor</code> 目录中，是使用 <code>uv</code> 进行管理的Python脚本，用于将<code>uer/roberta-base-finetuned-jd-binary-chinese</code>模型转换为Safetensors格式。</p>
<p>代码实现如下：</p>
<pre><code class="hljs language-python" lang="python">MODEL_NAME = <span class="hljs-string">"uer/roberta-base-finetuned-jd-binary-chinese"</span>
SAVE_DIR = <span class="hljs-string">"./converted_model"</span>

<span class="hljs-comment"># 强制使用镜像</span>
os.environ[<span class="hljs-string">"HF_ENDPOINT"</span>] = <span class="hljs-string">"https://hf-mirror.com"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>():
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(SAVE_DIR):
        os.makedirs(SAVE_DIR)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 加载</span>
        model = AutoModelForSequenceClassification.from_pretrained(MODEL_NAME, trust_remote_code=<span class="hljs-literal">True</span>)
        tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME, trust_remote_code=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># 1. 导出 config</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📦 正在生成 config.json..."</span>)
        config = model.config.to_dict()
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(SAVE_DIR, <span class="hljs-string">"config.json"</span>), <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            json.dump(config, f, indent=<span class="hljs-number">2</span>, ensure_ascii=<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># 2. 导出 tokenizer</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 正在生成 tokenizer.json..."</span>)
        tokenizer.save_pretrained(SAVE_DIR)

        <span class="hljs-comment"># 3. 导出权重</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"💾 正在生成 model.safetensors..."</span>)
        state_dict = model.state_dict()

        <span class="hljs-comment"># 移除可能存在的 _orig_mod 等前缀（如果使用了 torch.compile）</span>
        clean_state_dict = {k.replace(<span class="hljs-string">"_orig_mod."</span>, <span class="hljs-string">""</span>): v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> state_dict.items()}

        save_file(clean_state_dict, os.path.join(SAVE_DIR, <span class="hljs-string">"model.safetensors"</span>))

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 下载失败: <span class="hljs-subst">{e}</span>"</span>)

</code></pre>
<p>转换完成后，就可以将模型复制到 <code>www/models</code> 目录下。</p>
<h4 data-id="heading-12">Rust 侧：SentiPulseEngine 设计</h4>
<p>通过 Candle 加载模型的权重， 并使用 <code>VarBuilder</code> 构建计算图。</p>
<p>核心代码如下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> candle_core::{DType, Device, Tensor};
<span class="hljs-keyword">use</span> candle_nn::VarBuilder;
<span class="hljs-keyword">use</span> candle_transformers::models::bert::{BertModel, Config};
<span class="hljs-keyword">use</span> tokenizers::Tokenizer;
<span class="hljs-keyword">use</span> wasm_bindgen::prelude::*;

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SentiPulseResult</span> {
    negative: <span class="hljs-type">f32</span>,
    positive: <span class="hljs-type">f32</span>,
    neutral: <span class="hljs-type">f32</span>,
}

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SentiPulseResult</span> {
    <span class="hljs-meta">#[wasm_bindgen(getter)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">negative</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        <span class="hljs-keyword">self</span>.negative
    }
    <span class="hljs-meta">#[wasm_bindgen(getter)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">positive</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        <span class="hljs-keyword">self</span>.positive
    }
    <span class="hljs-meta">#[wasm_bindgen(getter)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">neutral</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        <span class="hljs-keyword">self</span>.neutral
    }
}

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SentiPulseEngine</span> {
    model: BertModel,
    tokenizer: Tokenizer,
    <span class="hljs-comment">// 分类头</span>
    w_out: Tensor,
    b_out: Tensor,
    <span class="hljs-comment">// 新增：Pooler 层 (用于处理 CLS 向量)</span>
    w_pooler: <span class="hljs-type">Option</span>&lt;Tensor&gt;,
    b_pooler: <span class="hljs-type">Option</span>&lt;Tensor&gt;,
}

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SentiPulseEngine</span> {
    <span class="hljs-meta">#[wasm_bindgen(constructor)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(
        weights: &amp;[<span class="hljs-type">u8</span>],
        tokenizer_data: &amp;[<span class="hljs-type">u8</span>],
        config_str: &amp;<span class="hljs-type">str</span>,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;SentiPulseEngine, JsError&gt; {
        console_error_panic_hook::<span class="hljs-title function_ invoke__">set_once</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">device</span> = &amp;Device::Cpu;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tokenizer</span> =
            Tokenizer::<span class="hljs-title function_ invoke__">from_bytes</span>(tokenizer_data).<span class="hljs-title function_ invoke__">map_err</span>(|e| JsError::<span class="hljs-title function_ invoke__">new</span>(&amp;e.<span class="hljs-title function_ invoke__">to_string</span>()))?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span>: Config =
            serde_json::<span class="hljs-title function_ invoke__">from_str</span>(config_str).<span class="hljs-title function_ invoke__">map_err</span>(|e| JsError::<span class="hljs-title function_ invoke__">new</span>(&amp;e.<span class="hljs-title function_ invoke__">to_string</span>()))?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">vb</span> = VarBuilder::<span class="hljs-title function_ invoke__">from_buffered_safetensors</span>(weights.<span class="hljs-title function_ invoke__">to_vec</span>(), DType::F32, device)?;

        <span class="hljs-comment">// 1. 加载 BERT</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">model</span> = BertModel::<span class="hljs-title function_ invoke__">load</span>(vb.<span class="hljs-title function_ invoke__">pp</span>(<span class="hljs-string">"bert"</span>), &amp;config)?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">w_pooler</span> = vb
            .<span class="hljs-title function_ invoke__">pp</span>(<span class="hljs-string">"bert"</span>)
            .<span class="hljs-title function_ invoke__">get</span>(
                (config.hidden_size, config.hidden_size),
                <span class="hljs-string">"pooler.dense.weight"</span>,
            )
            .<span class="hljs-title function_ invoke__">ok</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">b_pooler</span> = vb
            .<span class="hljs-title function_ invoke__">pp</span>(<span class="hljs-string">"bert"</span>)
            .<span class="hljs-title function_ invoke__">get</span>(config.hidden_size, <span class="hljs-string">"pooler.dense.bias"</span>)
            .<span class="hljs-title function_ invoke__">ok</span>();

        <span class="hljs-comment">// 3. 加载 Classifier (带兼容逻辑)</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">num_labels</span> = <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 使用 or_else 链式尝试不同的 Key 名</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">w_out</span> = vb
            .<span class="hljs-title function_ invoke__">get</span>((num_labels, config.hidden_size), <span class="hljs-string">"classifier.weight"</span>)
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| {
                vb.<span class="hljs-title function_ invoke__">get</span>(
                    (num_labels, config.hidden_size),
                    <span class="hljs-string">"classifier.out_proj.weight"</span>,
                )
            })
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| vb.<span class="hljs-title function_ invoke__">get</span>((num_labels, config.hidden_size), <span class="hljs-string">"classifier.dense.weight"</span>))
            .<span class="hljs-title function_ invoke__">map_err</span>(|_| JsError::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"权重文件中缺少分类层 (classifier weight)"</span>))?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">b_out</span> = vb
            .<span class="hljs-title function_ invoke__">get</span>(num_labels, <span class="hljs-string">"classifier.bias"</span>)
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| vb.<span class="hljs-title function_ invoke__">get</span>(num_labels, <span class="hljs-string">"classifier.out_proj.bias"</span>))
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| vb.<span class="hljs-title function_ invoke__">get</span>(num_labels, <span class="hljs-string">"classifier.dense.bias"</span>))
            .<span class="hljs-title function_ invoke__">map_err</span>(|_| JsError::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"权重文件中缺少分类层偏置 (classifier bias)"</span>))?;

        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">Self</span> {
            model,
            tokenizer,
            w_out,
            b_out,
            w_pooler,
            b_pooler,
        })
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">predict</span>(&amp;<span class="hljs-keyword">self</span>, text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;SentiPulseResult, JsError&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">device</span> = &amp;Device::Cpu;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tokens</span> = <span class="hljs-keyword">self</span>
            .tokenizer
            .<span class="hljs-title function_ invoke__">encode</span>(text, <span class="hljs-literal">true</span>)
            .<span class="hljs-title function_ invoke__">map_err</span>(|e| JsError::<span class="hljs-title function_ invoke__">new</span>(&amp;e.<span class="hljs-title function_ invoke__">to_string</span>()))?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">input_ids</span> = Tensor::<span class="hljs-title function_ invoke__">new</span>(tokens.<span class="hljs-title function_ invoke__">get_ids</span>(), device)?.<span class="hljs-title function_ invoke__">unsqueeze</span>(<span class="hljs-number">0</span>)?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">token_type_ids</span> = Tensor::<span class="hljs-title function_ invoke__">new</span>(tokens.<span class="hljs-title function_ invoke__">get_type_ids</span>(), device)?.<span class="hljs-title function_ invoke__">unsqueeze</span>(<span class="hljs-number">0</span>)?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">enc</span> = <span class="hljs-keyword">self</span>.model.<span class="hljs-title function_ invoke__">forward</span>(&amp;input_ids, &amp;token_type_ids, <span class="hljs-literal">None</span>)?;

        <span class="hljs-comment">// 取出 [CLS] (原始向量)</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cls_token</span> = enc.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0</span>)?.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0</span>)?.<span class="hljs-title function_ invoke__">unsqueeze</span>(<span class="hljs-number">0</span>)?;

        <span class="hljs-comment">// --- 执行 Pooler (如果存在) ---</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> (<span class="hljs-title function_ invoke__">Some</span>(w), <span class="hljs-title function_ invoke__">Some</span>(b)) = (&amp;<span class="hljs-keyword">self</span>.w_pooler, &amp;<span class="hljs-keyword">self</span>.b_pooler) {
            <span class="hljs-comment">// Pooler 逻辑: Tanh( Linear(CLS) )</span>
            cls_token = cls_token.<span class="hljs-title function_ invoke__">matmul</span>(&amp;w.<span class="hljs-title function_ invoke__">t</span>()?)?.<span class="hljs-title function_ invoke__">broadcast_add</span>(b)?.<span class="hljs-title function_ invoke__">tanh</span>()?;
        }

        <span class="hljs-comment">// 执行分类计算</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">logits</span> = cls_token
            .<span class="hljs-title function_ invoke__">matmul</span>(&amp;<span class="hljs-keyword">self</span>.w_out.<span class="hljs-title function_ invoke__">t</span>()?)?
            .<span class="hljs-title function_ invoke__">broadcast_add</span>(&amp;<span class="hljs-keyword">self</span>.b_out)?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scale_factor</span> = <span class="hljs-number">1.0</span>;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scaled_logits</span> = (logits * scale_factor <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>)?;

        <span class="hljs-comment">// 进行 Softmax</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pr</span> = candle_nn::ops::<span class="hljs-title function_ invoke__">softmax</span>(&amp;scaled_logits.<span class="hljs-title function_ invoke__">flatten_all</span>()?, <span class="hljs-number">0</span>)?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scores</span> = pr.to_vec1::&lt;<span class="hljs-type">f32</span>&gt;()?;

        <span class="hljs-comment">// 自动适配二分类或三分类</span>
        <span class="hljs-keyword">let</span> (neg, pos, neu) = <span class="hljs-keyword">if</span> scores.<span class="hljs-title function_ invoke__">len</span>() &gt;= <span class="hljs-number">3</span> {
            (scores[<span class="hljs-number">0</span>], scores[<span class="hljs-number">1</span>], scores[<span class="hljs-number">2</span>])
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">n</span> = scores[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">p</span> = scores[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">diff</span> = (n - p).<span class="hljs-title function_ invoke__">abs</span>();

            <span class="hljs-comment">// 基础中性分：当差距很大时，直接设为 0</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">m</span> = <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0.2</span> {
                <span class="hljs-number">0.8</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0.4</span> {
                <span class="hljs-number">0.3</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-number">0.0</span> <span class="hljs-comment">// 情绪明确，中性归零</span>
            };

            <span class="hljs-comment">// 执行归一化</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">total</span> = n + p + m;
            <span class="hljs-keyword">if</span> total &gt; <span class="hljs-number">0.0</span> {
                n = n / total;
                p = p / total;
                m = m / total;
                (n, p, m)
            } <span class="hljs-keyword">else</span> {
                (<span class="hljs-number">0.33</span>, <span class="hljs-number">0.33</span>, <span class="hljs-number">0.34</span>) <span class="hljs-comment">// 兜底：防止除以零</span>
            }
        };
        <span class="hljs-comment">// 它们可能长这样：[0.1, 0.2, 0.5] -&gt; 放大后 -&gt; [0.5, 1.0, 2.5]</span>
        web_sys::console::<span class="hljs-title function_ invoke__">log_1</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Raw Text: {}, Raw Scores: {:?}"</span>, text, scores).<span class="hljs-title function_ invoke__">into</span>());
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = SentiPulseResult {
            negative: neg,
            positive: pos,
            neutral: neu,
        };
        web_sys::console::<span class="hljs-title function_ invoke__">log_1</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Raw Text: {}, result: {:?}"</span>, text, result).<span class="hljs-title function_ invoke__">into</span>());

        <span class="hljs-title function_ invoke__">Ok</span>(result)
    }
}

</code></pre>
<p><strong>关键行解析：</strong></p>
<ul>
<li><strong><code>VarBuilder::from_buffered_safetensors</code></strong>: 避免了将巨大的模型文件在内存中反复 Copy，直接在内存池中构建权重。</li>
<li><strong><code>Result&lt;T, JsValue&gt;</code></strong>: 这是 Rust 与 JS 交互的最佳实践，能够让 JS 端的 <code>try-catch</code> 捕获到详细的 Rust 错误。</li>
<li><strong><code>unsqueeze(0)</code></strong>: 将一维 <code>Token</code> 序列升维为模型所需的 <code>Batch</code> 张量。</li>
</ul>
<h4 data-id="heading-13">JS 侧：模型推理与粒子风暴</h4>
<p><strong>粒子风暴系统</strong>：
用于根据情感分析分数, 动态渲染不同的粒子颜色和速度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// =========================================</span>
<span class="hljs-comment">// PART 1: 粒子风暴系统 (Particle System)</span>
<span class="hljs-comment">// =========================================</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"particle-canvas"</span>);
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);

<span class="hljs-comment">// 设置画布大小</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resizeCanvas</span>(<span class="hljs-params"/>) {
  canvas.<span class="hljs-property">width</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
  canvas.<span class="hljs-property">height</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
}
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, resizeCanvas);
<span class="hljs-title function_">resizeCanvas</span>();

<span class="hljs-comment">// 粒子参数全局状态 (受 AI 情绪驱动)</span>
<span class="hljs-keyword">let</span> globalMood = {
  <span class="hljs-attr">neg</span>: <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 初始平静状态</span>
  <span class="hljs-attr">pos</span>: <span class="hljs-number">0.9</span>,
  <span class="hljs-attr">neu</span>: <span class="hljs-number">0.1</span>,
  <span class="hljs-attr">targetSpeed</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attr">currentSpeed</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attr">chaos</span>: <span class="hljs-number">0.2</span>, <span class="hljs-comment">// 混乱度</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Particle</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reset</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * canvas.<span class="hljs-property">height</span>; <span class="hljs-comment">// 初始随机分布</span>
  }

  <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * canvas.<span class="hljs-property">width</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = canvas.<span class="hljs-property">height</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>; <span class="hljs-comment">// 从底部生成</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
    <span class="hljs-comment">// 基础速度 + 随机扰动</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">baseSpeedY</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1</span> + <span class="hljs-number">0.5</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vx</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.5</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vy</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">baseSpeedY</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">alpha</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.2</span>;
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 根据全局情绪平滑调整当前速度</span>
    globalMood.<span class="hljs-property">currentSpeed</span> +=
      (globalMood.<span class="hljs-property">targetSpeed</span> - globalMood.<span class="hljs-property">currentSpeed</span>) * <span class="hljs-number">0.05</span>;

    <span class="hljs-comment">// 情绪越消极，速度越快，水平扰动越大(混乱)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">vx</span> * (<span class="hljs-number">1</span> + globalMood.<span class="hljs-property">chaos</span> * <span class="hljs-number">5</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">vy</span> * globalMood.<span class="hljs-property">currentSpeed</span>;

    <span class="hljs-comment">// 边界检查，循环利用</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> &lt; -<span class="hljs-number">10</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reset</span>();
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">/// 强化颜色计算：确保 neg 占主导时 R 通道强制拉满</span>
    <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(globalMood.<span class="hljs-property">neg</span> * <span class="hljs-number">255</span> + globalMood.<span class="hljs-property">neu</span> * <span class="hljs-number">168</span>);
    <span class="hljs-keyword">const</span> g = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(globalMood.<span class="hljs-property">pos</span> * <span class="hljs-number">242</span> + globalMood.<span class="hljs-property">neu</span> * <span class="hljs-number">85</span>);
    <span class="hljs-keyword">const</span> b = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(globalMood.<span class="hljs-property">pos</span> * <span class="hljs-number">255</span> + globalMood.<span class="hljs-property">neu</span> * <span class="hljs-number">247</span>);

    <span class="hljs-comment">// 氛围补偿：负面越高，粒子稍微变大一点，增加压迫感</span>
    <span class="hljs-keyword">const</span> dynamicSize = <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> * (<span class="hljs-number">1</span> + globalMood.<span class="hljs-property">neg</span> * <span class="hljs-number">1.5</span>);

    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">`rgba(<span class="hljs-subst">${r}</span>, <span class="hljs-subst">${g}</span>, <span class="hljs-subst">${b}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.alpha + globalMood.neg * <span class="hljs-number">0.3</span>}</span>)`</span>;
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span>, dynamicSize, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
  }
}

<span class="hljs-keyword">const</span> particles = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">150</span> }, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Particle</span>());

<span class="hljs-keyword">function</span> <span class="hljs-title function_">animateParticles</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用半透明黑色清空画布，制造拖尾效果</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"rgba(10, 11, 16, 0.2)"</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

  particles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    p.<span class="hljs-title function_">update</span>();
    p.<span class="hljs-title function_">draw</span>();
  });
  <span class="hljs-title function_">requestAnimationFrame</span>(animateParticles);
}

<span class="hljs-comment">// 启动粒子动画</span>
<span class="hljs-title function_">animateParticles</span>();
</code></pre>
<p><strong>模型初始化</strong>：</p>
<p>通过 <code>fetch</code> 加载模型资源，并实例化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 中文模型资源</span>
<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"./model/uer/roberta-base-finetuned-jd-binary-chinese/"</span>;

<span class="hljs-comment">// 注意：文件名可能需要根据仓库实际情况调整</span>
<span class="hljs-keyword">const</span> [weights, tokenizer, config] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title function_">fetch</span>(baseUrl + <span class="hljs-string">"model.safetensors"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">arrayBuffer</span>()),
  <span class="hljs-title function_">fetch</span>(baseUrl + <span class="hljs-string">"tokenizer.json"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">arrayBuffer</span>()),
  <span class="hljs-title function_">fetch</span>(baseUrl + <span class="hljs-string">"config.json"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">text</span>()),
]);


<span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SentiPulseEngine</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(weights),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(tokenizer),
  config,
);
</code></pre>
<h5 data-id="heading-14">模型推理</h5>
<p>通过输入中文评论，调用 Rust Wasm 模块进行情感分析, 并返回情感分数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> t0 = performance.<span class="hljs-title function_">now</span>();
<span class="hljs-comment">// 1. 调用 Rust Wasm (返回对象包含 neg, pos, neu)</span>
<span class="hljs-keyword">const</span> result = engine.<span class="hljs-title function_">predict</span>(text);
<span class="hljs-keyword">const</span> { <span class="hljs-attr">negative</span>: neg, <span class="hljs-attr">positive</span>: pos, <span class="hljs-attr">neutral</span>: neu } = result;
<span class="hljs-keyword">const</span> t1 = performance.<span class="hljs-title function_">now</span>();
</code></pre>
<h3 data-id="heading-15">5. 运行情感分析推理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 模型下载及转换</span>
<span class="hljs-built_in">cd</span> model2safetensor &amp;&amp; uv run main.py
<span class="hljs-comment"># 2. 构建 Wasm 模块</span>
cargo build --target web --release
<span class="hljs-comment"># 3. 启动本地服务器</span>
miniserve .
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8080%2Fwww%2Findex.html" target="_blank" title="http://127.0.0.1:8080/www/index.html" ref="nofollow noopener noreferrer">http://127.0.0.1:8080/www/index.html</a> ，在输入框输入中文评论，就可以看到情感分析分数及情绪粒子风暴的变化了。</p>
<h3 data-id="heading-16">6. 总结：开启 Web 推理的新纪元</h3>
<p>从 调包侠 到 推理架构师, 这一步的跨越在于：我们已可以<strong>掌控算力的分配权。</strong> 通过 Rust + Wasm，我们证明了即使是复杂的 Transformer 模型，也能在用户的指尖轻盈跃动。</p>
<p>下一步，我们将引入 <strong>WebGPU</strong>，探索如何在浏览器里运行 3B 参数量级的端侧大模型（LLM）。</p>
<p><strong>源代码地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDoomking%2Frust-zhixingshe-examples%2Ftree%2Fmain%2Fwasm%2Fcandle-senti-pulse" target="_blank" title="https://github.com/Doomking/rust-zhixingshe-examples/tree/main/wasm/candle-senti-pulse" ref="nofollow noopener noreferrer">github.com/Doomking/ru…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教大家解析与部署Moltbot技术]]></title>    <link>https://juejin.cn/post/7600706866784763947</link>    <guid>https://juejin.cn/post/7600706866784763947</guid>    <pubDate>2026-01-30T02:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600706866784763947" data-draft-id="7600674821308137508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教大家解析与部署Moltbot技术"/> <meta itemprop="keywords" content="GitHub,API"/> <meta itemprop="datePublished" content="2026-01-30T02:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Smoothcloud_润云"/> <meta itemprop="url" content="https://juejin.cn/user/2948233128844891"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教大家解析与部署Moltbot技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948233128844891/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Smoothcloud_润云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:17:35.000Z" title="Fri Jan 30 2026 02:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Moltbot技术解析与部署实战指南</h2>
<blockquote>
<p>整合72.1K+ Stars开源项目的核心技术细节，从个人开发到企业生产环境全覆盖</p>
</blockquote>
<h3 data-id="heading-1">项目概述</h3>
<p><strong>Moltbot</strong>（原Clawdbot，2026年1月完成品牌升级）是一款基于Transformer架构的高性能AI对话引擎，兼具个人助手的轻量化特性与生产级系统的高并发处理能力。项目以“本地优先、多端协同、动态进化”为核心设计理念，支持WhatsApp、Telegram等多平台集成，提供浏览器控制、定时任务调度等自动化功能。</p>
<p><strong>项目亮点</strong>：</p>
<ul>
<li>GitHub 72.1K+ Stars，开发者社区热门开源项目</li>
<li>2.1.0版本已通过生产环境验证，支持日均千万级对话请求</li>
<li>微服务混合架构，支持独立扩展与热升级</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dee51607efc4ffcb30172fa93543797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU21vb3RoY2xvdWRf5ram5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344255&amp;x-signature=iWb4kQlW96udh%2Bc4m0nlQNFpQVo%3D" alt="f5788c3c2a72df6b0a9848b72edd6ef0.png" loading="lazy"/></p>
<h3 data-id="heading-2">一、核心架构深度解析</h3>
<h4 data-id="heading-3">1.1 四大核心组件设计</h4>
<h5 data-id="heading-4">1.1.1 对话理解引擎（DUE）</h5>
<p>采用多层级意图识别架构，融合字符级与词级联合编码技术：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 核心意图识别实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiIntentUnderstanding</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.tokenizer = BertTokenizer.from_pretrained(<span class="hljs-string">'bert-base-multilingual'</span>)
        self.encoder = TransformerEncoder(
            num_layers=<span class="hljs-number">12</span>, 
            hidden_size=<span class="hljs-number">768</span>, 
            attention_heads=<span class="hljs-number">12</span>, 
            dropout=<span class="hljs-number">0.1</span>
        )
        self.intent_classifier = HierarchicalClassifier(
            coarse_labels=<span class="hljs-number">32</span>,      <span class="hljs-comment"># 粗粒度意图</span>
            fine_grained_labels=<span class="hljs-number">256</span> <span class="hljs-comment"># 细粒度意图</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_seq</span>):
        <span class="hljs-comment"># 字符级+词级联合编码</span>
        char_emb = self.char_cnn(input_seq)
        word_emb = self.word_embedding(input_seq)
        combined = torch.cat([char_emb, word_emb], dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 上下文感知编码</span>
        contextualized = self.encoder(combined)
        
        <span class="hljs-comment"># 分层意图识别</span>
        coarse_intent = self.intent_classifier.coarse_layer(contextualized[:, <span class="hljs-number">0</span>, :])
        fine_intent = self.intent_classifier.fine_layer(contextualized[:, <span class="hljs-number">0</span>, :] + coarse_intent)
        
        <span class="hljs-keyword">return</span> coarse_intent, fine_intent
</code></pre>
<p><strong>关键技术特性</strong>：</p>
<ul>
<li>32类粗粒度意图 + 256类细粒度意图识别</li>
<li>动态注意力门控机制，提升长文本理解能力</li>
<li>混合精度推理（FP16/INT8自适应），推理速度提升3.2倍</li>
</ul>
<h5 data-id="heading-5">1.1.2 响应生成模块（RGM）</h5>
<p>基于T5-XL（3B参数）构建，集成以下优化：</p>
<ul>
<li><strong>前缀缓存机制</strong>：常见对话模式KV-cache预计算</li>
<li><strong>动态束宽调整</strong>：平衡生成质量与速度</li>
<li><strong>对抗过滤网络</strong>：无效响应过滤准确率99.7%</li>
</ul>
<h5 data-id="heading-6">1.1.3 知识检索系统（KRS）与上下文管理（CMS）</h5>
<ul>
<li>分层缓存策略：智能分配GPU显存与系统内存</li>
<li>多轮对话关联：支持最长128轮上下文记忆</li>
<li>向量化检索：基于FAISS的百万级知识库毫秒级检索</li>
</ul>
<h4 data-id="heading-7">1.2 四层运行架构</h4>






























<table><thead><tr><th align="left">层级</th><th align="left">核心功能</th><th align="left">技术实现</th></tr></thead><tbody><tr><td align="left"><strong>环境感知层</strong></td><td align="left">系统状态监控</td><td align="left">硬件/软件快照捕获，多OS兼容</td></tr><tr><td align="left"><strong>核心决策层</strong></td><td align="left">意图识别与路由</td><td align="left">惊奇度计算，动态注意力门控</td></tr><tr><td align="left"><strong>能力注册层</strong></td><td align="left">功能扩展管理</td><td align="left">动态扫描加载，混合精度推理</td></tr><tr><td align="left"><strong>网关通信层</strong></td><td align="left">消息路由处理</td><td align="left">Apache Kafka异步通信，多平台适配</td></tr></tbody></table>
<h3 data-id="heading-8">二、全场景部署方案</h3>
<h4 data-id="heading-9">2.1 环境准备</h4>
<h5 data-id="heading-10">2.1.1 个人开发环境（Node.js方案）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. Node.js环境配置（推荐nvm管理）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 22 &amp;&amp; nvm use 22

<span class="hljs-comment"># 2. 验证环境</span>
node --version  <span class="hljs-comment"># 应显示 v22.x.x</span>
npm --version   <span class="hljs-comment"># 应显示 10.x.x</span>
</code></pre>
<h5 data-id="heading-11">2.1.2 生产环境要求</h5>
<ul>
<li><strong>硬件</strong>：2× NVIDIA GPU，32GB+ 内存，8核CPU</li>
<li><strong>软件</strong>：Docker 20.10+，Kubernetes 1.24+，NVIDIA驱动470+</li>
<li><strong>网络</strong>：公网IP，SSL证书，防火墙端口开放（8443）</li>
</ul>
<h4 data-id="heading-12">2.2 部署方式选择</h4>
<h5 data-id="heading-13">方式一：全局安装（适合快速体验）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装</span>
npm install -g moltbot@latest

<span class="hljs-comment"># 初始化配置</span>
moltbot onboard --install-daemon

<span class="hljs-comment"># 启动服务</span>
moltbot gateway --port 18789 --verbose
</code></pre>
<p><strong>访问测试</strong>：<code>http://localhost:18789</code></p>
<h5 data-id="heading-14">方式二：源码安装（适合二次开发）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git
<span class="hljs-built_in">cd</span> moltbot

<span class="hljs-comment"># 依赖安装（使用pnpm加速）</span>
pnpm install

<span class="hljs-comment"># 构建项目</span>
pnpm build

<span class="hljs-comment"># 启动服务</span>
pnpm moltbot onboard --install-daemon
</code></pre>
<h4 data-id="heading-15">2.3 生产级容器化部署</h4>
<h5 data-id="heading-16">2.3.1 Docker Compose方案（中小规模）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.prod.yml</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">moltbot-api:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">moltbot/core:2.1.0-gpu</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">reservations:</span>
          <span class="hljs-attr">devices:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">driver:</span> <span class="hljs-string">nvidia</span>
              <span class="hljs-attr">count:</span> <span class="hljs-number">2</span>
              <span class="hljs-attr">capabilities:</span> [<span class="hljs-string">gpu</span>]
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">CUDA_VISIBLE_DEVICES=0,1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MODEL_PRECISION=mixed</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">CACHE_STRATEGY=hierarchical</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./model_cache:/app/models:rw</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./quantized_models:/app/quantized:ro</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8443:8443"</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> [<span class="hljs-string">"CMD"</span>, <span class="hljs-string">"curl"</span>, <span class="hljs-string">"-f"</span>, <span class="hljs-string">"https://localhost:8443/health"</span>]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">3</span>
</code></pre>
<p>启动命令：</p>
<pre><code class="hljs language-bash" lang="bash">docker-compose -f docker-compose.prod.yml up -d
docker-compose logs -f moltbot-api
</code></pre>
<h5 data-id="heading-17">2.3.2 Kubernetes部署方案（大规模生产）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># helm/values.yaml 关键配置</span>
<span class="hljs-attr">replicaCount:</span> <span class="hljs-number">3</span>
<span class="hljs-attr">resources:</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">32Gi</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-number">8</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">16Gi</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-number">4</span>

<span class="hljs-attr">autoscaling:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">targetCPUUtilizationPercentage:</span> <span class="hljs-number">70</span>
  <span class="hljs-attr">targetMemoryUtilizationPercentage:</span> <span class="hljs-number">80</span>
</code></pre>
<p>部署命令：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 添加Helm仓库</span>
<span class="hljs-string">helm</span> <span class="hljs-string">repo</span> <span class="hljs-string">add</span> <span class="hljs-string">moltbot</span> <span class="hljs-string">https://charts.moltbot.io</span>
<span class="hljs-string">helm</span> <span class="hljs-string">repo</span> <span class="hljs-string">update</span>

<span class="hljs-comment"># 安装Release</span>
<span class="hljs-string">helm</span> <span class="hljs-string">install</span> <span class="hljs-string">moltbot-prod</span> <span class="hljs-string">moltbot/moltbot</span> <span class="hljs-string">\</span>
  <span class="hljs-string">--namespace</span> <span class="hljs-string">moltbot-production</span> <span class="hljs-string">\</span>
  <span class="hljs-string">--create-namespace</span> <span class="hljs-string">\</span>
  <span class="hljs-string">--values</span> <span class="hljs-string">values.yaml</span>
</code></pre>
<h3 data-id="heading-18">三、监控运维与优化</h3>
<h4 data-id="heading-19">3.1 监控体系搭建</h4>
<h5 data-id="heading-20">3.1.1 Prometheus监控指标</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># custom_metrics.yaml</span>
<span class="hljs-attr">custom_metrics:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_inference_latency</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">histogram</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"推理延迟分布（毫秒）"</span>
    <span class="hljs-attr">buckets:</span> [<span class="hljs-number">10</span>, <span class="hljs-number">25</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">250</span>, <span class="hljs-number">500</span>, <span class="hljs-number">1000</span>]
    
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_gpu_utilization</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">gauge</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"GPU利用率百分比"</span>
    
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_concurrent_users</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">counter</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"并发用户数"</span>
    
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_error_rate</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">gauge</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"错误率（百分比）"</span>
</code></pre>
<h5 data-id="heading-21">3.1.2 Grafana仪表板配置</h5>
<p>导入Dashboard ID：<code>18643</code>（官方模板）
关键面板：</p>
<ol>
<li><strong>实时QPS监控</strong></li>
<li><strong>GPU内存使用率</strong></li>
<li><strong>P95/P99延迟</strong></li>
<li><strong>缓存命中率</strong></li>
</ol>
<h4 data-id="heading-22">3.2 性能调优建议</h4>
<h5 data-id="heading-23">3.2.1 Nginx优化配置</h5>
<pre><code class="hljs language-nginx" lang="nginx">http {
    upstream moltbot_backend {
        least_conn;
        server moltbot-1:8443 max_fails=3 fail_timeout=30s;
        server moltbot-2:8443 max_fails=3 fail_timeout=30s;
        keepalive 32;
        keepalive_timeout 60s;
    }
    
    server {
        listen 443 ssl http2;
        
        # SSL优化
        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        
        location /api/v1/chat {
            proxy_pass https://moltbot_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # 超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 300s;
        }
    }
}
</code></pre>
<h4 data-id="heading-24">3.3 高级运维功能</h4>
<h5 data-id="heading-25">3.3.1 模型热更新</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># hot_swap_model.sh</span>

<span class="hljs-comment"># 1. 预加载新模型</span>
curl -X POST http://localhost:8443/admin/model/load \
  -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$ADMIN_TOKEN</span>"</span> \
  -d <span class="hljs-string">'{
    "model_path": "/app/models/v2.2.0",
    "warmup": true,
    "warmup_requests": 1000
  }'</span>

<span class="hljs-comment"># 2. 流量切换（渐进式）</span>
<span class="hljs-keyword">for</span> percent <span class="hljs-keyword">in</span> 10 30 50 80 100; <span class="hljs-keyword">do</span>
  curl -X POST http://localhost:8443/admin/traffic \
    -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$ADMIN_TOKEN</span>"</span> \
    -d <span class="hljs-string">"{\"new_model_weight\": <span class="hljs-variable">$percent</span>}"</span>
  <span class="hljs-built_in">sleep</span> 300  <span class="hljs-comment"># 每5分钟增加流量</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h5 data-id="heading-26">3.3.2 健康检查与自愈</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动恢复脚本</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
  response=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> http://localhost:8443/health)
  
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> != <span class="hljs-string">"200"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: 服务异常，尝试重启..."</span>
    docker-compose restart moltbot-api
    <span class="hljs-built_in">sleep</span> 60
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: 服务正常"</span>
  <span class="hljs-keyword">fi</span>
  
  <span class="hljs-built_in">sleep</span> 30
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-27">四、性能基准与最佳实践</h3>
<h4 data-id="heading-28">4.1 性能基准数据</h4>













































<table><thead><tr><th align="left">场景</th><th align="left">QPS</th><th align="left">P95延迟</th><th align="left">GPU显存</th><th align="left">准确率</th><th align="left">推荐配置</th></tr></thead><tbody><tr><td align="left">短文本对话</td><td align="left">1200</td><td align="left">85ms</td><td align="left">8GB</td><td align="left">96.3%</td><td align="left">1×GPU, 16GB内存</td></tr><tr><td align="left">长上下文对话</td><td align="left">450</td><td align="left">210ms</td><td align="left">12GB</td><td align="left">94.7%</td><td align="left">2×GPU, 32GB内存</td></tr><tr><td align="left">多轮复杂对话</td><td align="left">280</td><td align="left">350ms</td><td align="left">14GB</td><td align="left">92.1%</td><td align="left">2×GPU, 32GB内存+NVLink</td></tr><tr><td align="left">批处理模式</td><td align="left">3200</td><td align="left">120ms</td><td align="left">16GB</td><td align="left">95.8%</td><td align="left">2×GPU, 64GB内存</td></tr></tbody></table>
<h4 data-id="heading-29">4.2 最佳实践建议</h4>
<h5 data-id="heading-30">4.2.1 硬件选型指南</h5>
<ol>
<li><strong>个人开发</strong>：M2/M3 MacBook Pro（统一内存架构优化最佳）</li>
<li><strong>中小生产</strong>：NVIDIA RTX 4090 × 2，64GB内存</li>
<li><strong>大规模生产</strong>：NVIDIA A100/H100，NVLink互联，256GB+内存</li>
</ol>
<h5 data-id="heading-31">4.2.2 网络优化</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 调整内核参数</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.core.somaxconn = 65535"</span> &gt;&gt; /etc/sysctl.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.tcp_max_syn_backlog = 65535"</span> &gt;&gt; /etc/sysctl.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.tcp_tw_reuse = 1"</span> &gt;&gt; /etc/sysctl.conf
sysctl -p
</code></pre>
<h5 data-id="heading-32">4.2.3 安全配置</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># security-policy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">policy/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodSecurityPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot-psp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">requiredDropCapabilities:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'configMap'</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'emptyDir'</span>
  <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">hostIPC:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">hostPID:</span> <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-33">五、故障排除与升级</h3>
<h4 data-id="heading-34">5.1 常见问题解决</h4>
<h5 data-id="heading-35">5.1.1 服务启动失败</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查依赖</span>
moltbot doctor

<span class="hljs-comment"># 查看详细日志</span>
journalctl -u moltbot.service -f

<span class="hljs-comment"># 端口冲突检测</span>
sudo lsof -i :18789
</code></pre>
<h5 data-id="heading-36">5.1.2 GPU相关问题</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证CUDA环境</span>
nvidia-smi
python -c <span class="hljs-string">"import torch; print(torch.cuda.is_available())"</span>

<span class="hljs-comment"># 清理GPU缓存</span>
sudo nvidia-smi --gpu-reset
</code></pre>
<h4 data-id="heading-37">5.2 版本升级指南</h4>
<h5 data-id="heading-38">5.2.1 从Clawdbot升级</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 备份配置</span>
<span class="hljs-built_in">cp</span> -r ~/.clawdbot ~/.clawdbot_backup

<span class="hljs-comment"># 2. 卸载旧版本</span>
npm uninstall -g clawdbot

<span class="hljs-comment"># 3. 安装新版本</span>
npm install -g moltbot@latest

<span class="hljs-comment"># 4. 迁移配置（自动兼容）</span>
moltbot migrate --from-clawdbot
</code></pre>
<h5 data-id="heading-39">5.2.2滚动升级（生产环境）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Kubernetes环境</span>
kubectl <span class="hljs-built_in">set</span> image deployment/moltbot-api \
  moltbot-api=moltbot/core:2.2.0 \
  -n moltbot-production

<span class="hljs-comment"># 监控升级过程</span>
kubectl rollout status deployment/moltbot-api -w
</code></pre>
<h3 data-id="heading-40">六、资源与社区</h3>
<h4 data-id="heading-41">6.1 官方资源</h4>
<ul>
<li><strong>GitHub仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></li>
<li><strong>文档中心</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moltbot.io%2F" target="_blank" title="https://docs.moltbot.io/" ref="nofollow noopener noreferrer">docs.moltbot.io</a></li>
<li><strong>Discord社区</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fmoltbot" target="_blank" title="https://discord.gg/moltbot" ref="nofollow noopener noreferrer">discord.gg/moltbot</a></li>
<li><strong>Docker镜像</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fr%2Fmoltbot%2Fcore" target="_blank" title="https://hub.docker.com/r/moltbot/core" ref="nofollow noopener noreferrer">hub.docker.com/r/moltbot/c…</a></li>
</ul>
<h4 data-id="heading-42">6.2 学习资源</h4>
<ol>
<li><strong>入门教程</strong>：《10分钟部署你的第一个AI助手》</li>
<li><strong>进阶指南</strong>：《Moltbot生产环境调优手册》</li>
<li><strong>API文档</strong>：REST API / WebSocket 完整参考</li>
<li><strong>案例研究</strong>：电商客服、智能办公等实际应用场景</li>
</ol>
<h3 data-id="heading-43">七、结语</h3>
<p>Moltbot凭借其轻量化架构与生产级特性的完美结合，为开发者提供了从个人项目到企业级应用的全栈解决方案。通过本文的详细指南，相信您已经掌握了Moltbot的核心技术、部署方法和优化策略。如果你在实际中遇到过相关问题，欢迎在评论区分享交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML代码规范]]></title>    <link>https://juejin.cn/post/7600990891205476379</link>    <guid>https://juejin.cn/post/7600990891205476379</guid>    <pubDate>2026-01-30T03:39:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891205476379" data-draft-id="7600675515150417947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML代码规范"/> <meta itemprop="keywords" content="HTML"/> <meta itemprop="datePublished" content="2026-01-30T03:39:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypnos_xy"/> <meta itemprop="url" content="https://juejin.cn/user/1259383317872089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML代码规范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259383317872089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypnos_xy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:39:58.000Z" title="Fri Jan 30 2026 03:39:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTML代码规范</h2>
<h3 data-id="heading-1">缩进</h3>
<p>建议缩进<strong>4个字符</strong>,在现代前端工程化,缩进4个字符比2字符更好的可读性。也不影响最终的结果</p>
<h3 data-id="heading-2">DOCTYPE 声明</h3>
<p>统一使用HTML5声明<code>&lt;!DOCTYPE html&gt;</code></p>
<h3 data-id="heading-3">meta 标签</h3>
<ul>
<li>编码格式</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span>
</code></pre>
<ul>
<li>SEO优化</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 网页标题 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 页面关键词 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span> =<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span> =<span class="hljs-string">""</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- 页面描述 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span> =<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span> =<span class="hljs-string">""</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- 网页作者 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span> =<span class="hljs-string">"author"</span> <span class="hljs-attr">content</span> =<span class="hljs-string">""</span>/&gt;</span>
</code></pre>
<ul>
<li>优先使用 IE 最新版本和 Chrome</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE = edge，chrome = 1"</span>/&gt;</span>
</code></pre>
<ul>
<li>为移动设备添加视口</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- device-width 是指这个设备最理想的 viewport 宽度 --&gt;</span>
<span class="hljs-comment">&lt;!-- initial-scale=1.0 是指初始化的时候缩放大小是1，也就是不缩放 --&gt;</span>
<span class="hljs-comment">&lt;!-- user-scalable=no 是指禁止用户进行缩放 yes 允许缩放--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0, user-scalable=no"</span>/&gt;</span>
</code></pre>
<ul>
<li>禁止自动识别页面中有可能是电话格式的数字</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>/&gt;</span>
</code></pre>
<blockquote>
<p>pc端建议</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your keywords"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your description"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"author"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"author,email address"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=Edge,chrome=1"</span>/&gt;</span>
</code></pre>
<blockquote>
<p>移动端建议</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your keywords"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your description"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0, user-scalable=no"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>/&gt;</span>
</code></pre>
<h3 data-id="heading-4">标签</h3>
<ul>
<li>所有标签都统一使用小写字母</li>
<li>自闭合标签：写法<code>&lt;br/&gt;</code>后面的/不要省略，常用的自闭合标签：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">base</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">source</span>/&gt;</span>
</code></pre>
<ul>
<li>非自闭合标签必须有结束标签，且不要省略：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">iframe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 普通标签 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">audio</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">video</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 语义化标签 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">menu</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">menu</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">aside</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">figure</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">figure</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">figcatption</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">figcaption</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">address</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">address</span>&gt;</span>
</code></pre>
<ul>
<li>尽量减少标签数量：如果设计到div装饰的小物件，尽量使用伪元素实现，而不是先建立一个元素实现</li>
<li>vue组件自定义标签: 如果设计到多个单词便签不要使用驼峰法，而是使用<code>-</code>分割。且需要闭合标签</li>
<li>对于<code>&lt;span&gt;</code>、<code>&lt;a&gt;</code>、等行内元素不要在嵌套其他块级元素。</li>
<li>块元素不要和行内元素并列</li>
</ul>
<h3 data-id="heading-5">转移字符</h3>
<ol>
<li><code>&amp;nbsp;</code>空格</li>
<li><code>&amp;lt;</code>小于</li>
<li><code>&amp;gt;</code>大于</li>
<li><code>&amp;amp;</code>和</li>
<li><code>&amp;quot;</code>引号</li>
</ol>
<h3 data-id="heading-6">元素属性</h3>
<ul>
<li>元素属性值使用双引号语法</li>
<li>自定义数据属性<code>data-*</code>,使用小写字符，避免使用特殊字符，多单词使用<code>-</code>分割</li>
</ul>
<blockquote>
<p>js 使用</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取属性data-user-id="123"</span>
<span class="hljs-keyword">let</span> userId = userDiv.<span class="hljs-property">dataset</span>.<span class="hljs-property">userId</span>
userId = userDiv.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-user-id'</span>);
<span class="hljs-comment">// 修改</span>
userDiv.<span class="hljs-property">dataset</span>.<span class="hljs-property">userId</span> = <span class="hljs-string">"456"</span>;
userDiv.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-user-id'</span>, <span class="hljs-string">'789'</span>);
<span class="hljs-comment">// 删除属性</span>
<span class="hljs-keyword">delete</span> userDiv.<span class="hljs-property">dataset</span>.<span class="hljs-property">userRole</span>;
userDiv.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'data-user-id'</span>);
<span class="hljs-comment">//访问所有data</span>
<span class="hljs-keyword">const</span> allData = element.<span class="hljs-property">dataset</span>; <span class="hljs-comment">// 返回一个 DOMStringMap 对象</span>
</code></pre>
<blockquote>
<p>css 使用</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-role=<span class="hljs-string">"admin"</span>]</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffebee</span>;
}
<span class="hljs-selector-class">.tooltip</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">attr</span>(data-tooltip);
  <span class="hljs-comment">/* 其他样式 */</span>
}
</code></pre>
<h3 data-id="heading-7">其他规范</h3>
<ol>
<li><code>img</code>必须（尽量）要使用<code>alt</code>属性</li>
<li>多个表单组合应该放入<code>form</code>表单内</li>
<li>html 注释必须要单独一行，不能和任何标签同行</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Comment Text --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ol start="4">
<li>单行字数限制120字符比较合适</li>
<li>多属性建议分行写(属性超过3个建议分行）</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
       <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span>
       <span class="hljs-attr">id</span>=<span class="hljs-string">"exampleInputEmail1"</span>
       <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter email"</span>
       <span class="hljs-attr">data-attribute1</span>=<span class="hljs-string">"value1"</span>
       <span class="hljs-attr">data-attribute2</span>=<span class="hljs-string">"value2"</span>/&gt;</span>
</code></pre>
<h3 data-id="heading-8">.prettier 配置</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 1. 行长度限制：单行字数限制120字符比较合适</span>
  printWidth<span class="hljs-punctuation">:</span> <span class="hljs-number">120</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 2. 缩进规则：建议缩进4个字符</span>
  tabWidth<span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 3. 使用空格而非制表符缩进</span>
  useTabs<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 4. 使用双引号包裹属性值</span>
  singleQuote<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 5. 多行HTML元素的闭合标签放在新行</span>
  bracketSameLine<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 6. 严格处理HTML空白字符</span>
  htmlWhitespaceSensitivity<span class="hljs-punctuation">:</span> 'strict'<span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 7. 使用HTML解析器</span>
  parser<span class="hljs-punctuation">:</span> 'html'<span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 8. 每个属性单独一行（属性超过3个时分行显示）</span>
  singleAttributePerLine<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 9. 换行符：使用LF（Unix风格），跨平台一致性</span>
  endOfLine<span class="hljs-punctuation">:</span> 'lf'<span class="hljs-punctuation">,</span>
 <span class="hljs-punctuation">}</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）]]></title>    <link>https://juejin.cn/post/7600674821307711524</link>    <guid>https://juejin.cn/post/7600674821307711524</guid>    <pubDate>2026-01-30T00:53:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600674821307711524" data-draft-id="7600705405594845247" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）"/> <meta itemprop="keywords" content="后端,Linux,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T00:53:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:53:26.000Z" title="Fri Jan 30 2026 00:53:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）</h2>
<p>大家好，我是专注 Linux 技术分享的小杨。上一篇给大家拆解了文件读写和时间编程，今天接着 Linux 文件系统核心技能，聚焦 “目录操作” 和 “文件属性获取”—— 这两个是嵌入式开发、服务器运维的高频需求，比如创建目录、遍历文件夹、修改文件权限、获取文件大小 / 创建时间等场景都离不开。结合《文件属性及目录操作》PDF 资料，从核心函数解析到实战案例，手把手教你用 C 语言操控 Linux 目录和文件属性，新手直接套用代码！</p>
<h3 data-id="heading-1">一、先理清：目录操作与文件属性的核心应用场景</h3>
<p>在 Linux 开发中，目录操作和文件属性获取是 “文件系统操控” 的基础，常见应用场景包括：</p>
<ul>
<li>目录管理：创建项目目录（如<code>mkdir -p src/include</code>）、切换工作目录、删除空目录；</li>
<li>文件夹遍历：批量处理文件（如遍历日志目录、批量修改后缀）、统计目录下文件个数；</li>
<li>文件属性查询：获取文件大小、创建时间、权限、类型（普通文件 / 目录 / 设备文件）；</li>
<li>权限管理：动态修改文件 / 目录权限（如给可执行程序添加执行权限）。</li>
</ul>
<p>下面按 “目录操作→文件属性” 的顺序，拆解每个核心函数的用法和实战代码。</p>
<h3 data-id="heading-2">二、实战 1：目录操作核心 API（创建 / 切换 / 遍历 / 删除）</h3>
<p>Linux 目录操作的核心函数都封装在<code>&lt;unistd.h&gt;</code>和<code>&lt;dirent.h&gt;</code>头文件中，按 “打开→操作→关闭” 的流程使用，与文件操作逻辑一致。</p>
<h4 data-id="heading-3">1. 核心函数详解（按使用频率排序）</h4>



























































<table><thead><tr><th>函数</th><th>功能</th><th>核心参数 / 返回值</th><th>类比 Shell 命令</th></tr></thead><tbody><tr><td><code>getcwd</code></td><td>获取当前工作目录路径</td><td>参数 1：存储路径的缓冲区；参数 2：缓冲区大小；返回值：成功返回缓冲区地址，失败返回<code>NULL</code></td><td><code>pwd</code></td></tr><tr><td><code>mkdir</code></td><td>创建空目录</td><td>参数 1：目录路径（如<code>"test_dir"</code>）；参数 2：目录权限（如<code>0755</code>）；返回值：0 成功，-1 失败</td><td><code>mkdir</code></td></tr><tr><td><code>chdir</code></td><td>切换工作目录</td><td>参数：目标路径（绝对 / 相对路径）；返回值：0 成功，-1 失败</td><td><code>cd</code></td></tr><tr><td><code>rmdir</code></td><td>删除空目录</td><td>参数：目录路径；返回值：0 成功，-1 失败（仅能删除空目录）</td><td><code>rmdir</code></td></tr><tr><td><code>opendir</code></td><td>打开目录</td><td>参数：目录路径；返回值：目录描述符指针（<code>DIR *</code>），失败返回<code>NULL</code></td><td>无（打开目录准备遍历）</td></tr><tr><td><code>readdir</code></td><td>读取目录内容</td><td>参数：<code>opendir</code>返回的目录指针；返回值：<code>struct dirent *</code>（文件信息），读取完毕返回<code>NULL</code></td><td><code>ls</code></td></tr><tr><td><code>closedir</code></td><td>关闭目录</td><td>参数：<code>opendir</code>返回的目录指针；返回值：0 成功，-1 失败</td><td>无（关闭目录释放资源）</td></tr><tr><td><code>chmod</code></td><td>修改文件 / 目录权限</td><td>参数 1：路径；参数 2：目标权限（如<code>0777</code>）；返回值：0 成功，-1 失败</td><td><code>chmod</code></td></tr></tbody></table>
<h4 data-id="heading-4">2. 实战案例 1：目录创建 + 切换 + 获取当前路径</h4>
<p>模拟项目初始化流程：创建<code>project/src</code>和<code>project/include</code>目录，切换到该目录，打印当前路径：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 创建多级目录（需先创建project，再创建子目录）</span>
    <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"project"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"mkdir project failed"</span>);
        <span class="hljs-comment">// 目录已存在时不影响后续操作，继续执行</span>
    }
    <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"project/src"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"mkdir project/src failed"</span>);
    }
    <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"project/include"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"mkdir project/include failed"</span>);
    }

    <span class="hljs-comment">// 2. 切换到project目录</span>
    <span class="hljs-keyword">if</span> (chdir(<span class="hljs-string">"project"</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"chdir failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 3. 获取当前工作目录并打印</span>
    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];
    <span class="hljs-keyword">if</span> (getcwd(buf, <span class="hljs-keyword">sizeof</span>(buf)) == <span class="hljs-literal">NULL</span>) {
        perror(<span class="hljs-string">"getcwd failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"当前工作目录：%s\n"</span>, buf); <span class="hljs-comment">// 输出：xxx/project</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-5">3. 实战案例 2：目录遍历（统计目录下文件个数）</h4>
<p>遍历<code>project</code>目录，打印所有文件 / 目录名称，统计普通文件和目录的个数：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 打开目录</span>
    DIR *dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">"project"</span>);
    <span class="hljs-keyword">if</span> (dir == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"opendir failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 2. 读取目录内容（循环读取所有文件）</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;
    <span class="hljs-type">int</span> file_count = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 普通文件计数</span>
    <span class="hljs-type">int</span> dir_count = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 目录计数</span>

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"project目录下的内容：\n"</span>);
    <span class="hljs-keyword">while</span> ((entry = <span class="hljs-built_in">readdir</span>(dir)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 跳过当前目录（.）和上级目录（..）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 打印文件名和文件类型</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"名称：%s\t"</span>, entry-&gt;d_name);
        <span class="hljs-keyword">switch</span> (entry-&gt;d_type) {
            <span class="hljs-keyword">case</span> DT_REG:  <span class="hljs-comment">// 普通文件</span>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：普通文件\n"</span>);
                file_count++;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> DT_DIR:  <span class="hljs-comment">// 目录文件</span>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：目录\n"</span>);
                dir_count++;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> DT_LNK:  <span class="hljs-comment">// 链接文件</span>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：链接文件\n"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：其他\n"</span>);
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-comment">// 3. 关闭目录</span>
    <span class="hljs-built_in">closedir</span>(dir);

    <span class="hljs-comment">// 4. 打印统计结果</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n统计：普通文件%d个，目录%d个\n"</span>, file_count, dir_count);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-6">4. 关键注意事项</h4>
<ul>
<li><code>readdir</code>返回的<code>struct dirent</code>结构体中，<code>d_type</code>字段直接标识文件类型（无需额外判断），常用值：<code>DT_REG</code>（普通文件）、<code>DT_DIR</code>（目录）、<code>DT_LNK</code>（链接文件）；</li>
<li><code>rmdir</code>仅能删除<strong>空目录</strong>，若目录非空，需先删除目录内所有文件 / 子目录，再删除该目录；</li>
<li>创建多级目录时（如<code>a/b/c</code>），需按层级创建（先创建<code>a</code>，再创建<code>a/b</code>，最后创建<code>a/b/c</code>），<code>mkdir</code>不支持直接创建多级目录。</li>
</ul>
<h3 data-id="heading-7">三、实战 2：文件属性获取与解析（大小 / 权限 / 时间）</h3>
<p>文件属性包含文件大小、权限、创建时间、所有者等信息，核心通过<code>stat</code>系列函数获取，配合<code>struct stat</code>结构体解析，是日志统计、文件管理的核心技能。</p>
<h4 data-id="heading-8">1. 核心函数与结构体详解</h4>
<h5 data-id="heading-9">（1）3 个核心获取函数（按需选择）</h5>

























<table><thead><tr><th>函数</th><th>功能差异</th><th>适用场景</th></tr></thead><tbody><tr><td><code>stat</code></td><td>获取文件属性，不跟随符号链接</td><td>普通文件 / 目录属性查询</td></tr><tr><td><code>lstat</code></td><td>获取文件属性，跟随符号链接（返回链接文件本身的属性）</td><td>符号链接文件属性查询</td></tr><tr><td><code>fstat</code></td><td>通过文件描述符（<code>open</code>返回值）获取属性</td><td>已打开文件的属性查询（避免重复路径解析）</td></tr></tbody></table>
<h5 data-id="heading-10">（2）核心结构体<code>struct stat</code>关键字段</h5>








































<table><thead><tr><th>字段</th><th>含义</th><th>实用场景</th></tr></thead><tbody><tr><td><code>st_size</code></td><td>文件大小（字节）</td><td>统计文件占用空间、判断文件是否为空</td></tr><tr><td><code>st_mode</code></td><td>文件类型 + 权限</td><td>判断文件类型、解析文件权限（如<code>rw-r--r--</code>）</td></tr><tr><td><code>st_atime</code></td><td>最后访问时间（如<code>read</code>操作）</td><td>日志统计：文件最后被访问时间</td></tr><tr><td><code>st_mtime</code></td><td>最后修改时间（文件内容修改）</td><td>版本管理：判断文件是否被修改</td></tr><tr><td><code>st_ctime</code></td><td>最后状态修改时间（权限 / 所有者修改）</td><td>权限变更审计</td></tr><tr><td><code>st_uid</code>/<code>st_gid</code></td><td>文件所有者 ID / 组 ID</td><td>权限控制：判断当前用户是否有权操作文件</td></tr></tbody></table>
<h4 data-id="heading-11">2. 实战案例 1：解析文件属性（大小 / 权限 / 时间）</h4>
<p>获取<code>project/src</code>目录下某文件的属性，解析并打印文件大小、权限、创建时间：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-comment">// 解析文件权限（将st_mode转换为字符串格式，如rw-r--r--）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_file_permission</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode, <span class="hljs-type">char</span> *perm)</span> </span>{
    <span class="hljs-comment">// 初始化权限字符串（10个字符：-rwxrwxrwx）</span>
    <span class="hljs-built_in">memset</span>(perm, <span class="hljs-string">'-'</span>, <span class="hljs-number">10</span>);
    perm[<span class="hljs-number">10</span>] = <span class="hljs-string">'\0'</span>;

    <span class="hljs-comment">// 判断文件类型（第一个字符）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISREG</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'-'</span>;    <span class="hljs-comment">// 普通文件</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISDIR</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'d'</span>; <span class="hljs-comment">// 目录</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISLNK</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'l'</span>; <span class="hljs-comment">// 链接文件</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISCHR</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'c'</span>; <span class="hljs-comment">// 字符设备</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISBLK</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'b'</span>; <span class="hljs-comment">// 块设备</span>

    <span class="hljs-comment">// 所有者权限（r=4, w=2, x=1）</span>
    <span class="hljs-keyword">if</span> (mode &amp; S_IRUSR) perm[<span class="hljs-number">1</span>] = <span class="hljs-string">'r'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IWUSR) perm[<span class="hljs-number">2</span>] = <span class="hljs-string">'w'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IXUSR) perm[<span class="hljs-number">3</span>] = <span class="hljs-string">'x'</span>;

    <span class="hljs-comment">// 组用户权限</span>
    <span class="hljs-keyword">if</span> (mode &amp; S_IRGRP) perm[<span class="hljs-number">4</span>] = <span class="hljs-string">'r'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IWGRP) perm[<span class="hljs-number">5</span>] = <span class="hljs-string">'w'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IXGRP) perm[<span class="hljs-number">6</span>] = <span class="hljs-string">'x'</span>;

    <span class="hljs-comment">// 其他用户权限</span>
    <span class="hljs-keyword">if</span> (mode &amp; S_IROTH) perm[<span class="hljs-number">7</span>] = <span class="hljs-string">'r'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IWOTH) perm[<span class="hljs-number">8</span>] = <span class="hljs-string">'w'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IXOTH) perm[<span class="hljs-number">9</span>] = <span class="hljs-string">'x'</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> buf;
    <span class="hljs-type">char</span> perm[<span class="hljs-number">11</span>]; <span class="hljs-comment">// 存储权限字符串（如rw-r--r--）</span>

    <span class="hljs-comment">// 1. 获取文件属性（以project/src/test.c为例，需先创建该文件）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stat</span>(<span class="hljs-string">"project/src/test.c"</span>, &amp;buf) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"stat failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 2. 解析并打印属性</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件属性解析：\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件大小：%ld 字节\n"</span>, buf.st_size);

    <span class="hljs-comment">// 解析权限</span>
    <span class="hljs-built_in">get_file_permission</span>(buf.st_mode, perm);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件权限：%s\n"</span>, perm);

    <span class="hljs-comment">// 解析时间（转换为本地时间字符串）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"最后访问时间：%s"</span>, <span class="hljs-built_in">ctime</span>(&amp;buf.st_atime));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"最后修改时间：%s"</span>, <span class="hljs-built_in">ctime</span>(&amp;buf.st_mtime));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"创建时间：%s"</span>, <span class="hljs-built_in">ctime</span>(&amp;buf.st_ctime));

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-12">3. 实战案例 2：修改文件权限（<code>chmod</code>应用）</h4>
<p>将<code>test.c</code>文件权限修改为<code>rwxr-xr-x</code>（0755），再验证修改结果：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 修改文件权限为0755（rwxr-xr-x）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">chmod</span>(<span class="hljs-string">"project/src/test.c"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"chmod failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"权限修改成功！\n"</span>);

    <span class="hljs-comment">// 2. 验证修改结果</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> buf;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stat</span>(<span class="hljs-string">"project/src/test.c"</span>, &amp;buf) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"stat failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 打印修改后的权限（简化判断）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"修改后权限："</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IRUSR) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IWUSR) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IXUSR) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IRGRP) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IWGRP) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IXGRP) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IROTH) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IWOTH) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IXOTH) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-13">4. 关键注意事项</h4>
<ul>
<li>文件权限的八进制表示：<code>0755</code>对应<code>rwxr-xr-x</code>，<code>0644</code>对应<code>rw-r--r--</code>，嵌入式开发中常用这两种权限；</li>
<li><code>ctime</code>函数将时间戳转换为字符串时，会自动添加换行符，打印时无需额外加<code>\n</code>；</li>
<li><code>lstat</code>与<code>stat</code>的区别：对符号链接文件，<code>stat</code>返回链接指向的原文件属性，<code>lstat</code>返回链接文件本身的属性，需根据需求选择。</li>
</ul>
<h3 data-id="heading-14">四、综合实战：目录遍历 + 属性统计（批量文件管理）</h3>
<p>结合目录遍历和文件属性解析，实现一个 “目录文件统计工具”：遍历指定目录，统计普通文件个数、总大小、最大文件名称：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PATH 1024</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> {
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"用法：%s &lt;目录路径&gt;\n"</span>, argv[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    DIR *dir = opendir(argv[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> (dir == <span class="hljs-literal">NULL</span>) {
        perror(<span class="hljs-string">"opendir failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">entry</span>;</span>
    <span class="hljs-type">int</span> file_count = <span class="hljs-number">0</span>;
    <span class="hljs-type">long</span> total_size = <span class="hljs-number">0</span>;
    <span class="hljs-type">long</span> max_size = <span class="hljs-number">0</span>;
    <span class="hljs-type">char</span> max_file[MAX_PATH] = <span class="hljs-string">""</span>;

    <span class="hljs-keyword">while</span> ((entry = readdir(dir)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 拼接文件完整路径</span>
        <span class="hljs-type">char</span> file_path[MAX_PATH];
        <span class="hljs-built_in">snprintf</span>(file_path, <span class="hljs-keyword">sizeof</span>(file_path), <span class="hljs-string">"%s/%s"</span>, argv[<span class="hljs-number">1</span>], entry-&gt;d_name);

        <span class="hljs-comment">// 获取文件属性</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">buf</span>;</span>
        <span class="hljs-keyword">if</span> (stat(file_path, &amp;buf) == <span class="hljs-number">-1</span>) {
            perror(<span class="hljs-string">"stat failed"</span>);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 仅统计普通文件</span>
        <span class="hljs-keyword">if</span> (S_ISREG(buf.st_mode)) {
            file_count++;
            total_size += buf.st_size;

            <span class="hljs-comment">// 记录最大文件</span>
            <span class="hljs-keyword">if</span> (buf.st_size &gt; max_size) {
                max_size = buf.st_size;
                <span class="hljs-built_in">strcpy</span>(max_file, entry-&gt;d_name);
            }
        }
    }

    closedir(dir);

    <span class="hljs-comment">// 打印统计结果</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"目录：%s\n"</span>, argv[<span class="hljs-number">1</span>]);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"普通文件总数：%d\n"</span>, file_count);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件总大小：%ld 字节（%.2f KB）\n"</span>, total_size, total_size / <span class="hljs-number">1024.0</span>);
    <span class="hljs-keyword">if</span> (file_count &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"最大文件：%s（%ld 字节）\n"</span>, max_file, max_size);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-15">编译与运行</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译</span>
gcc dir_stat.c -o dir_stat
<span class="hljs-comment"># 运行（统计project目录）</span>
./dir_stat project
</code></pre>
<h4 data-id="heading-16">输出结果示例</h4>
<p>plaintext</p>
<pre><code class="hljs">目录：project
普通文件总数：3
文件总大小：1200 字节（1.17 KB）
最大文件：test.c（800 字节）
</code></pre>
<h3 data-id="heading-17">五、避坑指南：常见错误解决</h3>
<ol>
<li>
<p><strong>目录遍历时报错 “Too many open files”</strong> ：</p>
<ul>
<li>原因：打开目录后未调用<code>closedir</code>关闭，导致文件描述符泄露；</li>
<li>解决：遍历完成后必须调用<code>closedir(dir)</code>，释放目录描述符。</li>
</ul>
</li>
<li>
<p><strong><code>stat</code>函数报错 “No such file or directory”</strong> ：</p>
<ul>
<li>原因：文件路径错误（相对路径需基于当前工作目录，或使用绝对路径）；</li>
<li>解决：用<code>getcwd</code>确认当前工作目录，或拼接绝对路径（如<code>/home/user/project/test.c</code>）。</li>
</ul>
</li>
<li>
<p><strong>权限解析错误（如<code>x</code>权限未正确显示）</strong> ：</p>
<ul>
<li>原因：<code>st_mode</code>与权限掩码（如<code>S_IXUSR</code>）的按位与判断错误；</li>
<li>解决：确认权限掩码使用正确（所有者用<code>S_IRUSR</code>/<code>S_IWUSR</code>/<code>S_IXUSR</code>，组用户用<code>S_IRGRP</code>等）。</li>
</ul>
</li>
<li>
<p><strong><code>rmdir</code>报错 “Directory not empty”</strong> ：</p>
<ul>
<li>原因：目录内有文件 / 子目录，<code>rmdir</code>仅能删除空目录；</li>
<li>解决：先遍历目录删除所有文件 / 子目录，再删除该目录（可递归实现）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">六、总结：核心技能与应用场景</h3>
<ol>
<li>
<p>目录操作：</p>
<ul>
<li>基础操作（<code>mkdir</code>/<code>chdir</code>/<code>getcwd</code>）：适合项目初始化、工作目录切换；</li>
<li>遍历操作（<code>opendir</code>/<code>readdir</code>/<code>closedir</code>）：适合批量文件处理、目录统计；</li>
</ul>
</li>
<li>
<p>文件属性：</p>
<ul>
<li>属性获取（<code>stat</code>/<code>lstat</code>/<code>fstat</code>）：适合文件管理、日志统计、权限判断；</li>
<li>权限修改（<code>chmod</code>）：适合动态调整文件访问权限，保障系统安全；</li>
</ul>
</li>
<li>
<p>嵌入式适配：</p>
<ul>
<li>权限控制：嵌入式设备中文件权限需严格配置（如<code>0755</code>执行权限、<code>0644</code>只读权限），避免权限过高导致安全风险；</li>
<li>资源释放：目录 / 文件操作后必须关闭（<code>closedir</code>/<code>close</code>），避免嵌入式设备资源耗尽。</li>
</ul>
</li>
</ol>
<p>掌握目录操作和文件属性解析，能应对 Linux 开发中 90% 的文件系统相关需求，比如日志管理、批量部署、权限审计等。下一篇博客，我会给大家整理 “Linux 多进程 / 多线程编程”，解决并发执行、资源同步等问题，敬请关注！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）]]></title>    <link>https://juejin.cn/post/7600642904383471622</link>    <guid>https://juejin.cn/post/7600642904383471622</guid>    <pubDate>2026-01-30T00:54:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600642904383471622" data-draft-id="7600705405594861631" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）"/> <meta itemprop="keywords" content="后端,程序员,Linux"/> <meta itemprop="datePublished" content="2026-01-30T00:54:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:54:54.000Z" title="Fri Jan 30 2026 00:54:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）</h2>
<p>大家好，我是专注 Linux 技术分享的小杨。前面的教程中，我们已经系统学习了 Linux 目录操作和文件属性解析的核心 API，今天就将这些知识点落地 ——<strong>用 C 语言手写实现 Linux <code>ls</code>命令的核心功能</strong>！</p>
<p>我们将通过一份完整的可运行代码，实现遍历指定目录、解析并打印文件类型、权限、大小、修改时间、文件名等关键信息，完美复刻<code>ls</code>命令的基础输出效果。全程从代码逻辑拆解到功能解析，再到编译运行，手把手教你实现，新手也能直接复制代码测试！</p>
<h3 data-id="heading-1">一、先明确：我们要实现的核心功能</h3>
<p>本次手写的<code>ls</code>简易版程序，将实现 Linux 原生<code>ls</code>命令的核心特性，满足日常文件查看需求：</p>
<ol>
<li><strong>支持指定目录</strong>：运行时可传入目录路径（如<code>./my_ls /home</code>），未传入则默认遍历当前目录（<code>.</code>）；</li>
<li><strong>遍历目录内容</strong>：自动读取目录下所有文件 / 子目录，跳过<code>.</code>和<code>..</code>特殊目录；</li>
<li><strong>解析文件类型</strong>：区分普通文件、目录、链接文件、字符设备、块设备等 7 种文件类型；</li>
<li><strong>打印文件权限</strong>：以<code>rwxrwxrwx</code>格式展示所有者、组用户、其他用户的读写执行权限；</li>
<li><strong>展示文件信息</strong>：输出文件大小（字节）、最后修改时间（月 日 时：分）、文件名；</li>
<li><strong>路径自动拼接</strong>：兼容当前目录（<code>.</code>）和自定义目录，自动拼接文件完整路径，避免属性解析失败。</li>
</ol>
<h3 data-id="heading-2">二、核心技术栈：复用 Linux 文件系统核心 API</h3>
<p>整个程序基于前面学过的 Linux C 语言文件系统 API 开发，核心用到的头文件和函数如下，都是开发必备的基础接口：</p>
<h4 data-id="heading-3">核心头文件</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"stdio.h"</span>       <span class="hljs-comment">// 标准输入输出</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/types.h"</span>   <span class="hljs-comment">// 基础类型定义（如mode_t、time_t）</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/stat.h"</span>    <span class="hljs-comment">// 文件属性结构体struct stat及stat()函数</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"time.h"</span>        <span class="hljs-comment">// 时间类型及时间转换函数</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"string.h"</span>      <span class="hljs-comment">// 字符串操作（strlen、strcmp等）</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"dirent.h"</span>      <span class="hljs-comment">// 目录操作（DIR、dirent及opendir/readdir等）</span></span>
</code></pre>
<h4 data-id="heading-4">核心函数</h4>

































<table><thead><tr><th>函数</th><th>核心作用</th></tr></thead><tbody><tr><td><code>opendir/readdir/closedir</code></td><td>目录打开、遍历、关闭，获取目录下所有文件信息</td></tr><tr><td><code>stat</code></td><td>解析文件完整路径，获取文件属性（存在<code>struct stat</code>中）</td></tr><tr><td><code>localtime</code></td><td>将时间戳（time_t）转换为本地时间结构体（struct tm）</td></tr><tr><td><code>snprintf</code></td><td>安全拼接文件完整路径，避免缓冲区溢出</td></tr><tr><td><code>S_ISDIR/S_ISREG</code>等宏</td><td>判断文件类型（目录、普通文件、链接等）</td></tr><tr><td><code>S_IRUSR/S_IWUSR</code>等宏</td><td>判断文件权限（读、写、执行）</td></tr></tbody></table>
<h3 data-id="heading-5">三、完整可运行代码：手写 ls 核心功能</h3>
<p>以下是完整的 C 语言代码，包含<strong>主函数逻辑</strong>和<strong>4 个功能封装函数</strong>，代码结构清晰、注释详细，可直接复制到 Linux 环境中编译运行：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"stdio.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/types.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/stat.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"time.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"string.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"dirent.h"</span></span>

<span class="hljs-comment">// 函数声明：按功能拆分，高内聚低耦合</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintType</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>;    <span class="hljs-comment">// 打印文件类型（d/-/l/c/b/p/s）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printmode</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>;    <span class="hljs-comment">// 打印文件权限（rwxrwxrwx）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printtime</span><span class="hljs-params">(<span class="hljs-type">time_t</span> mtime)</span>;   <span class="hljs-comment">// 打印文件修改时间（月 日 时:分）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filepath)</span>; <span class="hljs-comment">// 打印单个文件所有信息</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> <span class="hljs-type">const</span> *argv[])</span>
{
    <span class="hljs-comment">// 确定遍历目录：未传参则默认当前目录，传参则使用指定目录</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dirpath = argc &lt; <span class="hljs-number">2</span> ? <span class="hljs-string">"."</span> : argv[<span class="hljs-number">1</span>];
    <span class="hljs-comment">// 打开目标目录</span>
    DIR *dir = opendir(dirpath);
    <span class="hljs-keyword">if</span> (!dir)  <span class="hljs-comment">// 目录打开失败（路径错误/权限不足）</span>
    {
        perror(<span class="hljs-string">"opendir fail!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">dirinfo</span> =</span> <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">// 存储单个文件/目录信息</span>
    <span class="hljs-type">char</span> filepath[<span class="hljs-number">1024</span>];            <span class="hljs-comment">// 存储文件完整路径，避免stat解析失败</span>
    <span class="hljs-comment">// 循环遍历目录下所有内容，readdir返回NULL表示遍历结束</span>
    <span class="hljs-keyword">while</span> ((dirinfo = readdir(dir)) != <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename = dirinfo-&gt;d_name;  <span class="hljs-comment">// 获取文件名/目录名</span>
        <span class="hljs-comment">// 拼接文件完整路径：兼容当前目录（.）和自定义目录</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(dirpath) == <span class="hljs-number">1</span> &amp;&amp; dirpath[<span class="hljs-number">0</span>] == <span class="hljs-string">'.'</span>)
        {
            <span class="hljs-built_in">snprintf</span>(filepath, <span class="hljs-keyword">sizeof</span>(filepath), <span class="hljs-string">"./%s"</span>, filename);
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-built_in">snprintf</span>(filepath, <span class="hljs-keyword">sizeof</span>(filepath), <span class="hljs-string">"%s/%s"</span>, dirpath, filename);
        }
        <span class="hljs-comment">// 打印当前文件/目录的所有属性信息</span>
        PrintFile(filename, filepath);
    }
    closedir(dir);  <span class="hljs-comment">// 关闭目录，释放文件描述符，避免资源泄漏</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 打印单个文件的完整属性信息：封装调用各功能函数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filepath)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>  <span class="hljs-comment">// 存储文件属性的核心结构体</span>
    <span class="hljs-comment">// 获取文件属性：成功返回0，失败则跳过（避免个别文件解析失败导致程序终止）</span>
    <span class="hljs-keyword">if</span> (stat(filepath, &amp;st) == <span class="hljs-number">0</span>)
    {
        PrintType(st.st_mode);  <span class="hljs-comment">// 第一步：打印文件类型</span>
        Printmode(st.st_mode);  <span class="hljs-comment">// 第二步：打印文件权限</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">" %ld "</span>, st.st_size);  <span class="hljs-comment">// 第三步：打印文件大小（字节）</span>
        Printtime(st.st_mtime);  <span class="hljs-comment">// 第四步：打印文件最后修改时间</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, filename);  <span class="hljs-comment">// 第五步：打印文件名</span>
    }
}

<span class="hljs-comment">// 解析文件类型并打印：基于st_mode，通过系统宏判断</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintType</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>
{
    <span class="hljs-keyword">if</span> (S_ISLNK(mode))        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"l"</span>);  <span class="hljs-comment">// 符号链接文件（link）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(mode))   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"d"</span>);  <span class="hljs-comment">// 目录文件（directory）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISCHR(mode))   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"c"</span>);  <span class="hljs-comment">// 字符设备文件（character）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISBLK(mode))   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"b"</span>);  <span class="hljs-comment">// 块设备文件（block）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISFIFO(mode))  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"p"</span>);  <span class="hljs-comment">// 管道文件（pipe/FIFO）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISSOCK(mode))  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"s"</span>);  <span class="hljs-comment">// 套接字文件（socket）</span>
    <span class="hljs-keyword">else</span>                      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"-"</span>);  <span class="hljs-comment">// 普通文件（regular）</span>
}

<span class="hljs-comment">// 解析文件权限并打印：rwxrwxrwx格式，按位与判断权限是否存在</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printmode</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>
{
    <span class="hljs-comment">// 所有者（User）权限：读(r)、写(w)、执行(x)</span>
    <span class="hljs-built_in">printf</span>((mode &amp; S_IRUSR) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IWUSR) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IXUSR) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-comment">// 组用户（Group）权限：读(r)、写(w)、执行(x)</span>
    <span class="hljs-built_in">printf</span>((mode &amp; S_IRGRP) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IWGRP) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IXGRP) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-comment">// 其他用户（Other）权限：读(r)、写(w)、执行(x)</span>
    <span class="hljs-built_in">printf</span>((mode &amp; S_IROTH) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IWOTH) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IXOTH) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
}

<span class="hljs-comment">// 解析并打印文件修改时间：格式化输出「月 日 时:分」，与原生ls一致</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printtime</span><span class="hljs-params">(<span class="hljs-type">time_t</span> mtime)</span>
{
    <span class="hljs-type">char</span> time_str[<span class="hljs-number">128</span>];  <span class="hljs-comment">// 存储格式化后的时间字符串</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tm</span> *<span class="hljs-title">lt</span> =</span> localtime(&amp;mtime);  <span class="hljs-comment">// 时间戳转本地时间结构体</span>
    <span class="hljs-comment">// 格式化：tm_mon从0开始，需+1；tm_mday=日期，tm_hour=小时，tm_min=分钟</span>
    <span class="hljs-built_in">sprintf</span>(time_str, <span class="hljs-string">"%d月  %d %d:%d"</span>, lt-&gt;tm_mon + <span class="hljs-number">1</span>, lt-&gt;tm_mday, lt-&gt;tm_hour, lt-&gt;tm_min);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s "</span>, time_str);
}
</code></pre>
<h3 data-id="heading-6">四、代码核心逻辑拆解：从主函数到功能函数</h3>
<p>整个程序采用<strong>模块化设计</strong>，主函数负责整体流程控制，4 个功能函数分别实现单一职责，代码易读、易扩展，符合 C 语言工程化开发规范。我们按<strong>执行流程</strong>逐步拆解核心逻辑：</p>
<h4 data-id="heading-7">步骤 1：确定遍历目录并打开（main 函数）</h4>
<ul>
<li>利用<code>argc/argv</code>处理命令行参数：<code>argc &lt; 2</code>表示未传参，默认遍历当前目录（<code>.</code>），否则使用传入的目录路径；</li>
<li>调用<code>opendir</code>打开目录，返回<code>DIR*</code>类型的目录描述符，失败则通过<code>perror</code>打印错误信息并退出，避免后续无效操作；</li>
<li>关键：<strong>必须检查<code>opendir</code>返回值</strong>，路径错误、权限不足、非目录路径都会导致打开失败。</li>
</ul>
<h4 data-id="heading-8">步骤 2：循环遍历目录内容（main 函数）</h4>
<ul>
<li>定义<code>struct dirent *dirinfo</code>，用于存储<code>readdir</code>读取的单个文件 / 目录信息，其<code>d_name</code>字段为文件名 / 目录名；</li>
<li><code>while ((dirinfo = readdir(dir)) != NULL)</code>：循环遍历目录，<code>readdir</code>每次读取一个文件信息，返回 NULL 表示遍历结束；</li>
<li>跳过<code>.</code>和<code>..</code>：代码中未显式跳过，但不影响功能（stat 可正常解析，最终会打印这两个特殊目录，与原生<code>ls</code>默认行为一致）。</li>
</ul>
<h4 data-id="heading-9">步骤 3：安全拼接文件完整路径（main 函数）</h4>
<ul>
<li>为什么要拼接路径？<code>readdir</code>仅返回文件名，<code>stat</code>函数需要<strong>完整路径</strong>才能正确解析文件属性（否则会在当前目录查找，导致解析失败）；</li>
<li>兼容处理：判断如果是当前目录（<code>.</code>），则拼接为<code>./文件名</code>，否则拼接为<code>目录路径/文件名</code>；</li>
<li>安全：使用<code>snprintf</code>而非<code>sprintf</code>，指定缓冲区大小（<code>sizeof(filepath)</code>），避免字符串溢出导致的程序崩溃。</li>
</ul>
<h4 data-id="heading-10">步骤 4：打印单个文件所有属性（PrintFile 函数）</h4>
<ul>
<li>核心结构体<code>struct stat st</code>：Linux 存储文件属性的标准结构体，<code>stat</code>函数将文件属性写入该结构体；</li>
<li>调用<code>stat(filepath, &amp;st)</code>获取属性：成功返回 0 则继续，失败则直接跳过（避免个别文件解析失败导致整个程序终止）；</li>
<li>功能封装：依次调用<code>PrintType</code>（类型）、<code>Printmode</code>（权限）、打印大小、<code>Printtime</code>（时间）、打印文件名，与原生<code>ls</code>输出顺序一致。</li>
</ul>
<h4 data-id="heading-11">步骤 5：解析并打印文件类型（PrintType 函数）</h4>
<ul>
<li>核心：利用 Linux 系统提供的<strong>文件类型判断宏</strong>（基于<code>st_mode</code>字段），无需手动解析位域，简单高效；</li>
<li>支持 7 种常见文件类型：覆盖 Linux 所有基础文件类型，比原生<code>ls</code>支持的类型更全面；</li>
<li>单一职责：仅负责判断并打印文件类型，无其他逻辑，符合模块化设计。</li>
</ul>
<h4 data-id="heading-12">步骤 6：解析并打印文件权限（Printmode 函数）</h4>
<ul>
<li>Linux 文件权限核心：<strong>9 位权限位</strong>，分为 3 组（所有者、组用户、其他用户），每组 3 位（读 r、写 w、执行 x）；</li>
<li>判断方式：<strong>按位与（&amp;）</strong> ，<code>mode &amp; 权限宏</code>结果非 0 表示拥有该权限，打印对应字符，否则打印<code>-</code>；</li>
<li>权限宏：<code>S_IRUSR</code>（所有者读）、<code>S_IWUSR</code>（所有者写）、<code>S_IXUSR</code>（所有者执行），组用户和其他用户对应<code>GRP</code>、<code>OTH</code>后缀。</li>
</ul>
<h4 data-id="heading-13">步骤 7：格式化打印文件修改时间（Printtime 函数）</h4>
<ul>
<li>时间戳转换：<code>st_mtime</code>是<code>time_t</code>类型的时间戳（从 1970-01-01 00:00:00 到修改时间的秒数），需通过<code>localtime</code>转换为<code>struct tm</code>本地时间结构体；</li>
<li>注意坑：<code>tm_mon</code>字段从 0 开始（0=1 月，11=12 月），必须<code>+1</code>才能得到正确月份；</li>
<li>格式化输出：使用<code>sprintf</code>将时间拼接为「月 日 时：分」格式，与原生<code>ls</code>的时间展示风格一致，更符合使用习惯。</li>
</ul>
<h4 data-id="heading-14">步骤 8：关闭目录，释放资源（main 函数）</h4>
<ul>
<li>遍历结束后调用<code>closedir(dir)</code>关闭目录描述符，释放系统资源；</li>
<li>关键：<strong>避免资源泄漏</strong>，尤其是在循环遍历、多目录处理场景中，未关闭的目录描述符会耗尽系统资源，导致 “Too many open files” 错误。</li>
</ul>
<h3 data-id="heading-15">五、编译与运行：Linux 环境下快速测试</h3>
<p>这份代码无需依赖第三方库，直接在 Linux 系统（Ubuntu/CentOS/ 嵌入式 Linux）中用<code>gcc</code>编译即可，步骤简单，全程只需 3 条命令：</p>
<h4 data-id="heading-16">步骤 1：保存代码</h4>
<p>将上述代码保存为<code>my_ls.c</code>（文件名可自定义，后缀必须为<code>.c</code>），比如保存到<code>/home/user/</code>目录下。</p>
<h4 data-id="heading-17">步骤 2：编译代码</h4>
<p>打开 Linux 终端，进入代码所在目录，执行<code>gcc</code>编译命令：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译：my_ls.c为源码文件，-o my_ls指定生成的可执行程序名为my_ls</span>
gcc my_ls.c -o my_ls
</code></pre>
<ul>
<li>若无任何输出，说明编译成功，当前目录会生成<code>my_ls</code>可执行程序；</li>
<li>若有编译错误，检查代码是否复制完整、是否有语法错误（如少分号、括号不匹配）。</li>
</ul>
<h4 data-id="heading-18">步骤 3：运行程序</h4>
<p>支持<strong>默认遍历当前目录</strong>和<strong>指定目录遍历</strong>两种方式，与原生<code>ls</code>命令用法一致：</p>
<h5 data-id="heading-19">方式 1：默认遍历当前目录</h5>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接运行，遍历当前目录下所有文件/目录</span>
./my_ls
</code></pre>
<h5 data-id="heading-20">方式 2：指定目录遍历</h5>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 遍历指定目录，如遍历/home目录、/usr/bin目录</span>
./my_ls /home
./my_ls /usr/bin
<span class="hljs-comment"># 遍历当前目录的子目录，如./test</span>
./my_ls ./test
</code></pre>
<h4 data-id="heading-21">运行效果示例</h4>
<p>以遍历当前目录为例，输出效果与原生<code>ls</code>高度一致，包含文件类型、权限、大小、修改时间、文件名：</p>
<p>plaintext</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">drwxr-xr-x</span> <span class="hljs-number">4096 </span><span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-string">:20</span> <span class="hljs-string">test_dir</span>
<span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1200 </span><span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">14</span><span class="hljs-string">:50</span> <span class="hljs-string">test.c</span>
<span class="hljs-string">-rwxr-xr-x</span> <span class="hljs-number">8960 </span><span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-string">:10</span> <span class="hljs-string">my_ls</span>
<span class="hljs-string">lrwxrwxrwx</span> <span class="hljs-number">6</span>    <span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-string">:00</span> <span class="hljs-string">test_link</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">test.c</span>
</code></pre>
<ul>
<li>第一列：文件类型 + 权限（如<code>drwxr-xr-x</code>= 目录 + 所有者 rwx / 组用户 r-x / 其他用户 r-x）；</li>
<li>第二列：文件大小（字节，目录默认 4096 字节）；</li>
<li>第三列：最后修改时间（月 日 时：分）；</li>
<li>第四列：文件名 / 目录名（链接文件会显示原文件名）。</li>
</ul>
<h3 data-id="heading-22">六、关键细节与避坑指南：新手必看</h3>
<p>这份代码看似简单，但包含了 Linux C 语言文件系统开发的<strong>多个关键细节和避坑点</strong>，也是面试高频考点，一定要掌握：</p>
<h4 data-id="heading-23">坑 1：忘记拼接文件完整路径，stat 解析失败</h4>
<ul>
<li>现象：编译成功，运行后无输出或仅打印部分文件；</li>
<li>原因：<code>readdir</code>返回的是文件名，<code>stat</code>在当前目录查找，指定目录下的文件无法找到；</li>
<li>解决：必须通过<code>snprintf</code>拼接<strong>目录路径 + 文件名</strong>的完整路径，确保 stat 能正确解析。</li>
</ul>
<h4 data-id="heading-24">坑 2：使用 sprintf 拼接路径，导致缓冲区溢出</h4>
<ul>
<li>现象：程序偶尔崩溃，或输出乱码；</li>
<li>原因：<code>sprintf</code>不检查缓冲区大小，若文件名过长，会导致字符串溢出，覆盖其他内存；</li>
<li>解决：使用<code>snprintf</code>，第三个参数指定缓冲区大小（<code>sizeof(filepath)</code>），自动截断过长字符串，保证安全。</li>
</ul>
<h4 data-id="heading-25">坑 3：未检查 opendir/stat 返回值，程序异常终止</h4>
<ul>
<li>现象：运行时提示 “Segmentation fault” 或直接退出；</li>
<li>原因：<code>opendir</code>打开失败后，<code>dir</code>为 NULL，后续调用<code>readdir(dir)</code>会访问空指针；<code>stat</code>解析失败后，<code>st</code>结构体未初始化，直接访问其字段会导致内存错误；</li>
<li>解决：<strong>必须检查系统调用返回值</strong>，<code>opendir</code>失败则直接退出，<code>stat</code>失败则跳过当前文件。</li>
</ul>
<h4 data-id="heading-26">坑 4：tm_mon 未 + 1，导致月份少 1</h4>
<ul>
<li>现象：文件修改时间的月份比实际少 1（如 1 月显示为 0 月，2 月显示为 1 月）；</li>
<li>原因：<code>struct tm</code>的<code>tm_mon</code>字段从 0 开始计数（0=1 月，11=12 月），是 Linux 时间编程的经典坑；</li>
<li>解决：格式化时间时，<code>tm_mon</code>必须<code>+1</code>，即<code>lt-&gt;tm_mon + 1</code>。</li>
</ul>
<h4 data-id="heading-27">坑 5：遍历结束后未关闭目录，资源泄漏</h4>
<ul>
<li>现象：短时间运行无问题，长期运行或循环遍历多目录时，程序提示 “Too many open files”；</li>
<li>原因：<code>opendir</code>会占用系统文件描述符，未调用<code>closedir</code>关闭，会导致文件描述符耗尽；</li>
<li>解决：遍历结束后，无论是否成功，都要调用<code>closedir(dir)</code>释放资源（可放在<code>finally</code>块，或直接在遍历结束后调用）。</li>
</ul>
<h4 data-id="heading-28">细节 1：文件类型判断宏的使用</h4>
<ul>
<li>不要手动解析<code>st_mode</code>的位域判断文件类型，Linux 提供了标准化的判断宏（<code>S_ISDIR</code>/<code>S_ISREG</code>等），兼容性更好、更简洁；</li>
<li>所有判断宏的参数都是<code>mode_t mode</code>（即<code>st.st_mode</code>），返回非 0 表示为对应类型。</li>
</ul>
<h4 data-id="heading-29">细节 2：权限判断的按位与操作</h4>
<ul>
<li>Linux 文件权限存储在<code>st_mode</code>的低 9 位，每 3 位为一组，分别对应所有者、组用户、其他用户；</li>
<li>按位与（&amp;）的原理：保留指定位的数值，其他位清 0，非 0 表示该权限位为 1（拥有该权限）。</li>
</ul>
<h3 data-id="heading-30">七、功能扩展：基于当前代码实现更多 ls 特性</h3>
<p>这份代码是<strong>基础版</strong>，实现了<code>ls</code>的核心功能，在此基础上可以轻松扩展，实现原生<code>ls</code>的更多特性，推荐几个实用的扩展方向，大家可以自己动手实现：</p>
<h4 data-id="heading-31">扩展 1：显式跳过<code>.</code>和<code>..</code>特殊目录</h4>
<p>在<code>readdir</code>循环中添加判断，跳过这两个特殊目录，与原生<code>ls -A</code>效果一致：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(dirinfo-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(dirinfo-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h4 data-id="heading-32">扩展 2：按文件大小 / 修改时间排序</h4>
<ul>
<li>定义数组存储所有文件的属性信息（文件名、大小、修改时间等）；</li>
<li>遍历完成后，通过自定义排序函数（如冒泡排序、快速排序）按大小 / 时间排序；</li>
<li>排序后再打印所有文件信息，实现<code>ls -S</code>（按大小排序）、<code>ls -t</code>（按时间排序）效果。</li>
</ul>
<h4 data-id="heading-33">扩展 3：添加文件所有者和组信息</h4>
<ul>
<li>通过<code>st.st_uid</code>（所有者 ID）和<code>st.st_gid</code>（组 ID），调用<code>getpwuid</code>和<code>getgrgid</code>函数转换为用户名和组名；</li>
<li>在打印权限后、大小前，添加用户名和组名的打印，实现<code>ls -l</code>的完整效果。</li>
</ul>
<h4 data-id="heading-34">扩展 4：支持递归遍历子目录</h4>
<ul>
<li>判断如果是目录文件（<code>S_ISDIR(mode)</code>），则递归调用主逻辑，打开并遍历该子目录；</li>
<li>实现<code>ls -R</code>的递归遍历效果，适合批量处理目录下所有文件。</li>
</ul>
<h4 data-id="heading-35">扩展 5：添加彩色输出</h4>
<ul>
<li>根据文件类型设置不同的输出颜色（如目录蓝色、普通文件白色、可执行文件绿色）；</li>
<li>Linux 终端彩色输出通过 ANSI 转义序列实现，如<code>\033[34m</code>（蓝色）、<code>\033[0m</code>（恢复默认）。</li>
</ul>
<h3 data-id="heading-36">八、总结：从手写 ls 到掌握 Linux 文件系统核心</h3>
<p>这份手写<code>ls</code>的代码，看似是一个简单的小程序，实则融合了<strong>Linux C 语言文件系统开发的所有核心知识点</strong>：目录操作、文件属性解析、命令行参数处理、模块化设计、系统调用返回值检查。</p>
<p>通过实现这个程序，你不仅能熟练掌握<code>opendir/readdir/closedir</code>、<code>stat</code>、<code>localtime</code>等核心 API 的用法，更能理解 Linux 文件系统的底层逻辑 ——<strong>一切皆文件</strong>，目录、设备、管道等都是特殊的文件，都可以通过统一的 API 进行操作。</p>
<p>同时，这份代码的<strong>模块化设计思路</strong>和<strong>错误处理规范</strong>，也是 C 语言工程化开发的基础，无论是嵌入式 Linux 开发还是服务器开发，都能直接复用。</p>
<p>从基础 API 学习到手写实用工具，这是 Linux C 语言开发的关键一步。接下来，你可以基于这份代码继续扩展，实现更完整的<code>ls</code>命令，甚至手写<code>cp</code>、<code>mv</code>等常用命令，真正做到 “知其然，更知其所以然”！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java锁机制]]></title>    <link>https://juejin.cn/post/7600704706550988840</link>    <guid>https://juejin.cn/post/7600704706550988840</guid>    <pubDate>2026-01-30T03:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706550988840" data-draft-id="7600670417858723874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java锁机制"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-30T03:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一边吃泡面"/> <meta itemprop="url" content="https://juejin.cn/user/2831995877458488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java锁机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831995877458488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一边吃泡面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:46:17.000Z" title="Fri Jan 30 2026 03:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<ol>
<li>按实现层面划分
<ul>
<li>[内置锁]：<code>synchronized</code>是JVM层面实现的，无需手动释放锁，属于内置锁。</li>
<li>[显式锁]：<code>ReentrantLock</code>为代表的显式锁，需要手动释放锁，功能更加灵活，位于<code>java.util.concurrent.locks</code>包，Java代码层面实现。</li>
</ul>
</li>
<li>按锁的竞争机制划分
<ul>
<li>[悲观锁]：<code>synchronized</code>和<code>ReentrantLock</code>都为悲观锁，每次操作资源都会加锁，阻塞其他线程。</li>
<li>[乐观锁]：不加锁直接操作，通过CAS验证操作是否成功，失败则重试，例如<code>AtomicInteger</code>。</li>
</ul>
</li>
<li>按锁的可重入性划分
<ul>
<li>[可重入锁]：对于已获取到锁的线程可再次获取同一把锁（避免自身死锁），<code>synchronized</code>和<code>ReentrantLock</code>均为可重入锁。</li>
<li>[不可重入锁]：持有锁的线程无法再次获取这把锁，容易引起自身死锁。</li>
</ul>
</li>
<li>锁的升级
<ul>
<li>偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁（JDK1.6优化后，<code>synchronized</code>会根据竞争激烈程度自动升级，逐步提升并发性能）</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">具体</h2>
<h3 data-id="heading-2">一、<code>synchronized</code></h3>
<h4 data-id="heading-3">1. 用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedDemo</span> { 
	<span class="hljs-comment">// 1. 修饰实例方法：锁的是「当前类的实例对象」（this） </span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">instanceMethod</span><span class="hljs-params">()</span> { 
		<span class="hljs-comment">// 线程安全的实例方法逻辑 </span>
		System.out.println(<span class="hljs-string">"修饰实例方法，锁："</span> + <span class="hljs-built_in">this</span>); 
	}
	
	<span class="hljs-comment">// 2. 修饰静态方法：锁的是「当前类的 Class 对象」（SynchronizedDemo.class）</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> { 
		<span class="hljs-comment">// 线程安全的静态方法逻辑 </span>
		System.out.println(<span class="hljs-string">"修饰静态方法，锁："</span> + SynchronizedDemo.class); 
	}
	
	<span class="hljs-comment">// 3. 修饰同步代码块：锁的是「括号内指定的对象」（灵活可控） </span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">codeBlockMethod</span><span class="hljs-params">()</span> { 
		<span class="hljs-comment">// 可选锁对象：this（实例对象）、Class 对象、自定义任意对象 </span>
		<span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); 
		<span class="hljs-keyword">synchronized</span> (lock) { 
		<span class="hljs-comment">// 线程安全的代码块逻辑 </span>
		System.out.println(<span class="hljs-string">"修饰代码块，锁："</span> + lock); 
		}
	}
}
</code></pre>
<p>⭐<code>synchronized</code> 竞争的是一个资源对象，无论是修饰的实例方法、静态方法还是代码块，只是对象的类型不同而已。（可以是方法当前类的实例对象、class对象、自定义的任意对象）</p>
<h4 data-id="heading-4">2. 实现原理</h4>
<p>依赖于「Java对象头」和「监视器锁」，不同JDK版本略有差异</p>
<ul>
<li><strong>JDK1.6之前</strong>：仅支持「重量级锁」，依赖操作系统的「互斥量（Mutex）」实现，线程竞争时会触发「用户态 &lt;-&gt; 内核态」的上下文切换，开销极大，性能较差。</li>
<li><strong>JDK1.6之后</strong>：引入了「锁升级」机制（偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁），根据竞争激烈程度逐步升级，大幅优化性能：
<ol>
<li><strong>偏向锁</strong>：无多线程竞争时，锁偏向第一个获取锁的线程，后续该线程再次获取锁时，无需任何竞争操作，直接获取锁（开销极低）。</li>
<li><strong>轻量级锁</strong>：出现少量线程竞争时，偏向锁升级为轻量级锁，通过「CAS 操作」实现锁的获取与释放，无需阻塞线程，仅存在少量自旋开销。</li>
<li><strong>重量级锁</strong>：出现大量线程竞争时，轻量级锁升级为重量级锁，依赖操作系统互斥量实现，竞争失败的线程会被阻塞挂起，避免空耗 CPU，此时开销最大，但能保证高并发场景下的稳定性。</li>
<li>⭐锁升级是单向的，无法降级。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">3. 核心特性</h4>
<ul>
<li><strong>可重入性</strong>：线程持有锁后，可再次获取同一把锁（如同步方法中调用另一同步方法），避免自身死锁。</li>
<li><strong>隐式释放锁</strong>：无需手动调用释放方法，同步代码块 / 方法执行完毕、抛出异常时，JVM 会自动释放锁，降低资源泄露风险。</li>
<li><strong>非公平锁</strong>：默认采用非公平锁策略（线程获取锁时，不遵守先到先得的顺序，可能存在插队现象），吞吐量更高（公平锁会带来额外的排队开销）。</li>
</ul>
<h3 data-id="heading-6">二、<code>ReentrantLock</code></h3>
<h4 data-id="heading-7">1. 用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLockDemo</span> {
    <span class="hljs-comment">// 1. 创建 ReentrantLock 实例（默认非公平锁，传入 true 为公平锁）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 2. 获取锁（lock() 方法，阻塞式获取）</span>
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 执行线程安全的业务逻辑</span>
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 已获取锁，执行任务"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 释放锁（必须在 finally 中，保证无论是否异常，都能释放锁）</span>
            lock.unlock();
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 已释放锁"</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReentrantLockDemo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLockDemo</span>();
        <span class="hljs-comment">// 启动 2 个线程竞争锁</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo::doTask, <span class="hljs-string">"线程1"</span>).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo::doTask, <span class="hljs-string">"线程2"</span>).start();
    }
}
</code></pre>
<p>⭐<code>finally</code>释放锁是必须的，防止try抛出异常，锁无法释放，会导致其他线程永久阻塞，引发死锁。</p>
<h4 data-id="heading-8">2. 核心功能扩展</h4>
<p><code>ReentrantLock</code>提供了<code>synchronized</code>不具备的高级功能：</p>
<ul>
<li>支持公平锁/非公平锁：创建实例的时候可以设置采用公平锁还是非公平锁，默认非公平锁（false）</li>
<li>支持获取锁超时：通过<code>trylock(long timeout, TimeUnit unit)</code>方法，设置锁获取超时时间，超时后自动放弃获取锁，返回false，避免长时间阻塞。</li>
<li>支持可中断获取锁：通过<code>lockInterruptibly()</code>方法，获取锁的线程可被其他线程中断（调用<code>thread.interrupt()</code>），中断后抛出 <code>InterruptedException</code>，并释放锁，灵活控制线程状态。</li>
<li>提供锁状态查询：如<code>isLocked()</code>（判断锁是否被持有）、<code>isHeldByCurrentThread()</code>（判断当前线程是否持有该锁）、<code>getHoldCount()</code>（获取当前线程持有该锁的次数），方便监控和调试。</li>
</ul>
<h4 data-id="heading-9">3. 原理</h4>
<p><code>ReentrantLock</code> 的底层基于 <strong>AQS（AbstractQueuedSynchronizer，抽象队列同步器）</strong> 实现，AQS 是 JUC 包中所有显式锁、同步工具类的核心框架。
核心逻辑：</p>
<ol>
<li>AQS 内部维护一个「volatile 状态变量 <code>state</code>」和一个「双向链表同步队列」。</li>
<li><code>state</code> 用于标记锁的状态：<code>state=0</code> 表示锁未被持有，<code>state&gt;0</code> 表示锁被持有（<code>state</code> 的值等于线程持有锁的次数，体现可重入性）。</li>
<li>线程获取锁时，通过 CAS 操作修改 <code>state</code>：若 <code>state=0</code>，则将 <code>state</code> 改为 1，获取成功；若 <code>state&gt;0</code> 且是当前线程持有，则 <code>state</code> 加 1（可重入），否则加入同步队列阻塞等待。</li>
<li>线程释放锁时，将 <code>state</code> 减 1，当 <code>state=0</code> 时，释放锁并唤醒同步队列中的下一个线程。</li>
</ol>
<h4 data-id="heading-10">4. 核心特性</h4>
<ol>
<li><strong>可重入性</strong>：和 <code>synchronized</code> 一样，支持线程重复获取同一把锁，通过 <code>state</code> 变量计数实现。</li>
<li><strong>显式释放锁</strong>：必须手动调用 <code>unlock()</code> 释放，依赖开发者规范，灵活性高但风险也高（容易遗漏释放）。</li>
<li><strong>功能灵活</strong>：支持公平锁、超时获取、可中断等高级功能，适配复杂并发场景。</li>
<li><strong>性能优异</strong>：在高并发场景下，性能略优于 <code>synchronized</code>（JDK 1.6 后 <code>synchronized</code> 优化，两者性能差距不大）。</li>
</ol>
<hr/>
<h3 data-id="heading-11">三、<code>synchronized</code>锁升级</h3>
<p>锁的载体 -- <strong>Java对象头</strong>：<code>synchronized</code> 锁的是「对象」，而锁状态的信息，就存储在 <strong>Java 对象头（Object Header）</strong> 中（仅针对普通对象，数组对象的对象头额外包含数组长度）。
Java 对象头在 32 位 JVM 和 64 位 JVM 中长度分别为 8 字节和 16 字节，核心包含两部分（以 64 位 JVM 为例）：</p>
<ol>
<li><strong>Mark Word</strong>（标记字段，8字节）：存储对象的锁状态、哈希码、GC年龄、偏向线程ID等核心信息，是锁升级的「核心载体」。</li>
<li><strong>Klass Pointer</strong>（类型指针，8字节）：指向对象所属类的Class对象，用于确定对象的类型。</li>
</ol>

























<table><thead><tr><th>锁状态</th><th>Mark Word 核心字段（64 位）</th></tr></thead><tbody><tr><td>无锁</td><td>哈希码（25 位）+ GC 年龄（4 位）+ 无锁标记（1 位）</td></tr><tr><td>偏向锁</td><td>偏向线程 ID（54 位）+ 偏向时间戳（2 位）+ GC 年龄（4 位）+ 偏向锁标记（1 位）</td></tr><tr><td>轻量级锁</td><td>指向栈中锁记录的指针（63 位）+ 轻量级锁标记（1 位）</td></tr><tr><td>重量级锁</td><td>指向监视器锁（Monitor）的指针（63 位）+ 重量级锁标记（1 位）</td></tr></tbody></table>
<h5 data-id="heading-12">第一步：无锁 -&gt; 偏向锁（无竞争场景）</h5>
<ol>
<li>第一个线程获取锁时，JVM 通过 CAS 操作，将 <code>Mark Word</code> 中的「偏向线程 ID」设置为当前线程的 ID，同时将「锁标记位」改为「偏向锁标记」。</li>
<li>该线程后续再次获取该对象的锁时，无需再执行 CAS 操作或阻塞，只需简单检查 <code>Mark Word</code> 中的：
<ul>
<li>偏向线程 ID 是否为当前线程 ID；</li>
<li>偏向锁标记是否有效。</li>
</ul>
</li>
<li>若两者都满足，直接获取锁成功（「偏向」的含义就是锁会「偏爱」这个线程），全程无额外开销，效率极高。</li>
</ol>
<h5 data-id="heading-13">第二步：偏向锁 → 轻量级锁（少量线程竞争，无阻塞）</h5>
<ol>
<li><strong>加锁流程</strong>：</li>
</ol>
<ul>
<li>线程获取锁时，先在自己的栈帧中创建一个「锁记录（Lock Record）」，用于存储对象 <code>Mark Word</code> 的副本（称为「Displaced Mark Word」）。</li>
<li>线程通过 CAS 操作，将对象 <code>Mark Word</code> 中的内容替换为「指向当前线程栈中锁记录的指针」。</li>
<li>若 CAS 成功，说明锁获取成功，将 <code>Mark Word</code> 的锁标记位改为「轻量级锁标记」，线程继续执行同步代码。</li>
<li>若 CAS 失败，说明有其他线程正在竞争该锁，当前线程不会被阻塞，而是进入「自旋」（反复执行 CAS 操作，尝试获取锁）。</li>
</ul>
<ol start="2">
<li><strong>解锁流程</strong>：</li>
</ol>
<ul>
<li>线程执行完同步代码后，通过 CAS 操作，将对象 <code>Mark Word</code> 中的「锁记录指针」替换回原来的「Displaced Mark Word」（栈中锁记录存储的副本）。</li>
<li>若 CAS 成功，说明无其他线程竞争，解锁成功，锁状态回到无锁。</li>
<li>若 CAS 失败，说明有其他线程在自旋竞争，此时会将轻量级锁升级为重量级锁，同时唤醒自旋的线程。</li>
</ul>
<h5 data-id="heading-14">第三步：轻量级锁 → 重量级锁（大量线程竞争，阻塞式竞争）</h5>
<ol>
<li><strong>加锁流程</strong>：</li>
</ol>
<ul>
<li>锁升级为重量级锁后，对象 <code>Mark Word</code> 中会存储「指向 Monitor 的指针」，Monitor 是一个用于管理锁竞争的核心数据结构。</li>
<li>线程获取锁时，会尝试获取 Monitor 的「持有权」（Monitor 中的 <code>owner</code> 字段记录持有锁的线程）。</li>
<li>若获取成功，<code>owner</code> 字段设置为当前线程，线程执行同步代码。</li>
<li>若获取失败，当前线程会被加入 Monitor 的「阻塞队列」，被操作系统挂起（从用户态切换到内核态），放弃 CPU 执行权，直到被唤醒。</li>
</ul>
<ol>
<li><strong>解锁流程</strong>：</li>
</ol>
<ul>
<li>线程执行完同步代码后，释放 Monitor 的持有权（将 <code>owner</code> 字段置为 null）。</li>
<li>唤醒阻塞队列中的一个线程（通过操作系统的唤醒机制），让其尝试获取锁。</li>
<li>锁状态保持为重量级锁，不会降级（单向升级）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android-封装一个超好用的权限工具类]]></title>    <link>https://juejin.cn/post/7600675515150745627</link>    <guid>https://juejin.cn/post/7600675515150745627</guid>    <pubDate>2026-01-30T02:25:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600675515150745627" data-draft-id="7600684978353815579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android-封装一个超好用的权限工具类"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-30T02:25:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ishibashi"/> <meta itemprop="url" content="https://juejin.cn/user/2019159609710904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android-封装一个超好用的权限工具类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2019159609710904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ishibashi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:25:50.000Z" title="Fri Jan 30 2026 02:25:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">封装一个好用的原生权限工具类，方便以后开发直接拿来用。</h4>
<p>思考1：工具类应具备的能力</p>
<blockquote>
<ol>
<li>
<p>权限判断</p>
</li>
<li>
<p>权限请求</p>
</li>
<li>
<p>权限回调处理 （权限同意、权限拒绝、权限拒绝且不再询问）</p>
</li>
</ol>
</blockquote>
<p>思考2：涉及的API：</p>
<blockquote>
<p><strong>权限判断-API：</strong>
ContextCompat.checkSelfPermission</p>
<p>tips:</p>
<p>有权限 PackageManager.PERMISSION_GRANTED</p>
<p>无权限 PackageManager.PERMISSION_DENIED</p>
<p>无权限且不再询问 PackageManager.PERMISSION_DENIED + !activity.shouldShowRequestPermissionRationale(permission)</p>
<p><strong>权限请求与回调-API：</strong></p>
<ul>
<li>方案1（旧版）：ActivityCompat.requestPermissions 与 ComponentActivity-重写onRequestPermissionsResult</li>
<li>方案2（推荐）：ComponentActivity-registerForActivityResult().launch 与  ComponentActivity-registerForActivityResult()</li>
</ul>
</blockquote>
<p>方案1这个菜有点老，本次我们吃方案2，新鲜点儿。</p>
<p>开始上菜~</p>
<h3 data-id="heading-1">一、构建权限工具类：PermissionNewHelper</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionNewHelper</span> {
    <span class="hljs-keyword">var</span> denialList = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> denialNeverList = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> requestCode = <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createPermissionLauncher</span><span class="hljs-params">(activity: <span class="hljs-type">ComponentActivity</span>, nextUnit:((<span class="hljs-type">Int</span>)-&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>, denialUnit:(()-&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>, neverUnit:(()-&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>)</span></span>:ActivityResultLauncher&lt;Array&lt;String&gt;&gt;{
        <span class="hljs-keyword">return</span> activity.registerForActivityResult(ActivityResultContracts.RequestMultiplePermissions(),<span class="hljs-keyword">object</span> :
            ActivityResultCallback&lt;Map&lt;String, <span class="hljs-built_in">Boolean</span>&gt;&gt;{
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityResult</span><span class="hljs-params">(result: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-built_in">Boolean</span>&gt;)</span></span> {
                denialList.clear()
                denialNeverList.clear()
                result.forEach {(permission, isGranted) -&gt;
                    <span class="hljs-keyword">if</span> (isGranted) {
                        <span class="hljs-comment">// 权限已授予</span>
                    } <span class="hljs-keyword">else</span> {
                        denialList.add(permission) <span class="hljs-comment">// 权限被拒绝，可提示用户手动开启</span>
                        <span class="hljs-keyword">if</span> (!activity.shouldShowRequestPermissionRationale(permission)) {
                            denialNeverList.add(permission) <span class="hljs-comment">// 用户选择了"不再询问"，需引导至设置页面</span>
                        }
                    }
                }
                <span class="hljs-keyword">if</span> (denialList.size == <span class="hljs-number">0</span>) {
                    nextUnit?.invoke(requestCode)
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (denialNeverList.size == <span class="hljs-number">0</span>) {
                        denialUnit?.invoke()
                    }<span class="hljs-keyword">else</span>{
                        neverUnit?.invoke()
                    }
                }
            }
        })
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPermissions</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, <span class="hljs-keyword">vararg</span> permissions: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span>{
        <span class="hljs-keyword">return</span> permissions.all { permission-&gt;
            ContextCompat.checkSelfPermission(context,permission) == PackageManager. PERMISSION_GRANTED
        }
    }

    <span class="hljs-comment">/**
    * 获取权限
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestPermissions</span><span class="hljs-params">(launcher:<span class="hljs-type">ActivityResultLauncher</span>&lt;<span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;&gt;, permissions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;, requestCode: <span class="hljs-type">Int</span>)</span></span>{
        <span class="hljs-keyword">this</span>.requestCode = requestCode
        launcher.launch(permissions)
    }
}
</code></pre>
<h3 data-id="heading-2">二、构建权限弹框辅助类：PermissionDialogHelper</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionDialogHelper</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showPermissionRequestPop</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, des:<span class="hljs-type">String</span>, next:()-&gt; <span class="hljs-type">Unit</span>)</span></span>{
        showPop(context,des,next)
    }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showPermissionJumpSettingPop</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, des:<span class="hljs-type">String</span>, next:()-&gt; <span class="hljs-type">Unit</span>)</span></span>{
        showPop(context,des,next)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showPop</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, des:<span class="hljs-type">String</span>, next:()-&gt; <span class="hljs-type">Unit</span>)</span></span>{
        <span class="hljs-keyword">var</span> create :AlertDialog? = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(context).setTitle(<span class="hljs-string">"温馨提示"</span>).setMessage(des)
            .setNegativeButton(<span class="hljs-string">"取消"</span>, <span class="hljs-keyword">object</span> :
                DialogInterface.OnClickListener {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(dialog: <span class="hljs-type">DialogInterface</span>?, which: <span class="hljs-type">Int</span>)</span></span> {
                    create?.dismiss()
                }
            }).setPositiveButton(<span class="hljs-string">"确定"</span>, <span class="hljs-keyword">object</span> : DialogInterface.OnClickListener {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(dialog: <span class="hljs-type">DialogInterface</span>?, which: <span class="hljs-type">Int</span>)</span></span> {
                create?.dismiss()
                next()
            }
        })
        create = dialog.create()
        create?.show()
    }
}
</code></pre>
<h3 data-id="heading-3">三、工具类的使用：</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionNewActivity</span>: <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">var</span> permission: Array&lt;String&gt; = arrayOf(Manifest.permission.ACCESS_FINE_LOCATION, Manifest.permission.CAMERA)
    <span class="hljs-keyword">val</span> mPermissionNewHelper <span class="hljs-keyword">by</span> lazy { PermissionNewHelper() }
    <span class="hljs-keyword">val</span> mPermissionDialogHelper <span class="hljs-keyword">by</span> lazy { PermissionDialogHelper() }
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mPermissionLauncher :ActivityResultLauncher&lt;Array&lt;String&gt;&gt;

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_test)

mPermissionLauncher = mPermissionNewHelper.createPermissionLauncher(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, { code-&gt;
            <span class="hljs-keyword">if</span>(code==<span class="hljs-number">7777</span>){
                Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"next"</span>, Toast.LENGTH_SHORT).show()
            }
        }, {
            Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"denial"</span>, Toast.LENGTH_SHORT).show()
        }, {
            Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"never"</span>, Toast.LENGTH_SHORT).show()
            mPermissionDialogHelper.showPermissionJumpSettingPop(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"跳转系统设置权限的描述"</span>) {
                <span class="hljs-comment">//前往系统设置</span>
                <span class="hljs-keyword">val</span> intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS)
                intent.setData(Uri.parse(<span class="hljs-string">"package:<span class="hljs-subst">${this@PermissionNewActivity.packageName}</span>"</span>))
                startActivity(intent)
            }
        })


findViewById&lt;Button&gt;(R.id.mBtn).setOnClickListener {
            <span class="hljs-keyword">val</span> check = mPermissionNewHelper.checkPermissions(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>,*permission)
            <span class="hljs-keyword">if</span>(check){
                Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"next"</span>, Toast.LENGTH_SHORT).show()
            }<span class="hljs-keyword">else</span>{
                mPermissionDialogHelper.showPermissionRequestPop(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>,<span class="hljs-string">"请求权限的描述"</span>) {
                    mPermissionNewHelper.requestPermissions(mPermissionLauncher,permission,<span class="hljs-number">7777</span>)
                }
            }
        }
    }

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【技术专题】Scikit-learn Python机器学习 - 回归分析算法之线性回归 (LinearRegression & SGDRegressor)]]></title>    <link>https://juejin.cn/post/7600684978353963035</link>    <guid>https://juejin.cn/post/7600684978353963035</guid>    <pubDate>2026-01-30T02:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600684978353963035" data-draft-id="7600684978353881115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【技术专题】Scikit-learn Python机器学习 - 回归分析算法之线性回归 (LinearRegression &amp; SGDRegressor)"/> <meta itemprop="keywords" content="机器学习,人工智能,Python"/> <meta itemprop="datePublished" content="2026-01-30T02:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小锋java1234"/> <meta itemprop="url" content="https://juejin.cn/user/4152222342709933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【技术专题】Scikit-learn Python机器学习 - 回归分析算法之线性回归 (LinearRegression &amp; SGDRegressor)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4152222342709933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小锋java1234
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:43:39.000Z" title="Fri Jan 30 2026 02:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是锋哥。最近连载更新《Scikit-learn Python机器学习》技术专题。 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e7477f400ac4a9aac6f4a78bd2b4836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=MmTDU0DYK2NinpaLTKU5jRZsRtY%3D" alt="image.png" loading="lazy"/> 本课程主要讲解基于Scikit-learn的Python机器学习知识，包括机器学习概述，特征工程(数据集，特征抽取，特征预处理，特征降维等)，分类算法(K-临近算法，朴素贝叶斯算法，决策树等)，回归与聚类算法(线性回归，欠拟合，逻辑回归与二分类，K-means算法)等。 同时也配套视频教程<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11reUzEEPH%2F" title="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11reUzEEPH%2F" target="_blank">《Scikit-learn Python机器学习 视频教程》</a></p>
<p>线性回归（Linear Regression）是一种基础的回归分析方法，它通过构建输入特征和输出结果之间的线性关系，来预测输出值。其核心思想是通过找到最合适的“拟合线”来预测未知数据的结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1651775f1c604bada62f1f9cd78e3b62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=ULaRiTRLfJXNsSKVb9%2FlmVuL41Y%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">1，线性回归模型的基本原理</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4196a6c900fe43d4b9400dd709f4cbd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=Yrpfe%2Fmk2ej8PffDJRnE7BgmmEA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2，损失函数</h2>
<p>在回归问题中，我们常用 <strong>均方误差（MSE）</strong> 作为损失函数，目标是最小化这个损失函数。均方误差计算公式为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eabf8df8e54d4e4db0b2f336775696ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=3YoQGuqu%2FYX9bW5e4aTl0sWlrpw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3，模型的求解</h2>
<p>线性回归的目标就是通过最小化损失函数来找到最合适的 <em>β</em> 参数。我们可以通过 <strong>梯度下降法</strong> 或者 <strong>正规方程法</strong> 来求解。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15e03d45189746899c67e42f242a1f1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=Ne1ix%2Bh95O%2BcqKHFr4wwTVgjv4Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">4，梯度下降法</h2>
<p>梯度下降法（Gradient Descent）是机器学习和深度学习中常用的一种优化算法。它的核心思想非常直观：我们通过不断“走下坡路”来找到一个最低点（即最优解）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0de275dedcfb4d79977117fd2cd63e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=6q4tsOd%2BVGMkJj1TB1oPLrjAaMw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>想象一下：</strong></p>
<p>假设你站在一个山坡上，你的目标是找到山谷的最低点。你无法看到整个山谷的情况，只能看到你当前所在位置的周围环境。为了找到最低点，你需要根据当前的位置判断哪个方向最陡峭，然后朝着这个方向走一小步。每走一步，你就能让自己离最低点更近一些。</p>
<p><strong>具体来说，梯度下降法是这样的：</strong></p>
<ol start="0">
<li><strong>山坡的斜率</strong>：在数学中，我们可以通过<strong>梯度</strong>来表示当前点的“坡度”或“斜率”。如果你在山坡的某个点站着，梯度就告诉你最陡的下坡方向。换句话说，梯度是一个向量，它指向函数下降最快的方向。</li>
<li><strong>向梯度的反方向走</strong>：为了找到最低点，我们不是沿着梯度的方向走，而是<strong>沿着梯度的反方向走</strong>。因为梯度告诉我们的是上坡的方向，我们反着走就是下坡。</li>
<li><strong>步长（学习率）</strong> ：每走一步时，我们需要决定步伐的大小，这就是所谓的<strong>学习率</strong>。如果步伐太大，可能会错过最低点；如果步伐太小，找到最低点的过程就会非常缓慢。</li>
</ol>
<p><strong>过程：</strong></p>
<ol start="0">
<li><strong>初始化</strong>：首先从一个随机点（位置）开始。这个点可以是任何地方，就像你站在山坡的某个随机位置。</li>
<li><strong>计算梯度</strong>：在当前位置，计算当前点的梯度（坡度）。梯度告诉你最陡的上坡方向。</li>
<li><strong>更新位置</strong>：沿着梯度的反方向走，更新你的位置。更新的幅度是梯度的反方向乘以步长（学习率）。</li>
<li><strong>重复</strong>：不断重复上述步骤，直到你到达一个相对平坦的区域，或者你已经足够接近最低点。</li>
</ol>
<p><strong>数学公式</strong></p>
<p>梯度下降的更新规则通常表示为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1bff47270d34da3886a350eda617816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=IkKWQjfFFJIe9jWwmxn82N8OURk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>例子：线性回归的梯度下降</strong></p>
<p>假设我们要通过梯度下降法求解线性回归模型的参数（例如直线的斜率和截距）。我们可以使用梯度下降来最小化均方误差（MSE）损失函数。每次通过计算梯度，调整参数，最终找到一个合适的拟合直线。</p>
<p><strong>关键要点：</strong></p>
<ul>
<li><strong>步长（学习率）</strong> ：如果学习率设置得太大，可能会“跳过”最低点；如果设置得太小，算法收敛得非常慢。</li>
<li><strong>局部最小值和全局最小值</strong>：梯度下降法有可能会停在局部最低点，但理想情况下我们希望找到全局最低点。为此，我们可以使用一些技巧，如<strong>随机初始化</strong>或<strong>动量法</strong>，来避免陷入局部最小值。</li>
</ul>
<p><strong>类比理解：</strong></p>
<ul>
<li><strong>攀登山峰</strong>：梯度下降就像你在山中探险，通过触摸周围的环境（计算梯度）来确定下一步走向。</li>
<li><strong>在迷雾中找路</strong>：如果你不能看到全貌，你就只能一步一步、逐渐判断方向，直到找到目的地。</li>
</ul>
<h2 data-id="heading-4">5，API介绍</h2>
<p>线性回归-正规方程使用 LinearRegression</p>
<p><code>LinearRegression</code> 类的参数不多，但它们控制着模型如何拟合数据和如何计算。</p>
<pre><code class="hljs language-ini" lang="ini">sklearn.linear_model.LinearRegression(
    *, 
    <span class="hljs-attr">fit_intercept</span>=<span class="hljs-literal">True</span>, 
    <span class="hljs-attr">copy_X</span>=<span class="hljs-literal">True</span>, 
    <span class="hljs-attr">n_jobs</span>=None, 
    <span class="hljs-attr">positive</span>=<span class="hljs-literal">False</span>
)
</code></pre>
<p>参数详解：</p>
<p><strong>1. <code>fit_intercept</code> : bool, default=True</strong></p>
<ul>
<li>
<p><strong>功能</strong>：决定是否计算模型的<strong>截距</strong>（也叫偏置项，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">w_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>fit_intercept=True</code> (默认)：模型会计算截距项 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">w_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。公式为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\hat{y} = w_0 + w_1x_1 + w_2x_2 + ... + w_nx_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。<strong>这是最常见的情况</strong>，除非你确信你的数据已经经过处理，其回归线理所当然地应该通过原点 (0,0)。</li>
<li><code>fit_intercept=False</code>：模型会强制截距为 0。公式变为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\hat{y} = w_1x_1 + w_2x_2 + ... + w_nx_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。这通常只在你有很强的先验知识（即当所有特征都为 0 时，目标值必须为 0）时使用。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li><strong>几乎总是保持默认值 True</strong>。</li>
<li>只有在非常特殊的情况下才设置为 <code>False</code>（例如，物理定律要求没有偏移）。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>2. <code>copy_X</code> : bool, default=True</strong></p>
<ul>
<li>
<p><strong>功能</strong>：决定是否复制特征数据 <code>X</code>。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>copy_X=True</code> (默认)：在拟合模型之前，会创建特征矩阵 <code>X</code> 的一个副本。原始数据 <code>X</code> 不会被修改。这是安全的选择。</li>
<li><code>copy_X=False</code>：模型会直接在原始数据 <code>X</code> 上进行计算。这可以节省内存，尤其是当 <code>X</code> 非常大时。<strong>但缺点是会覆盖原始数据</strong>。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li>通常保持默认值 <code>True</code>，以确保原始数据安全。</li>
<li>只有在内存极度紧张且你确定不再需要原始 <code>X</code> 数据时，才设置为 <code>False</code>。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>3. <code>n_jobs</code> : int, default=None</strong></p>
<ul>
<li>
<p><strong>功能</strong>：设置用于计算的 CPU 核心数量，用于并行化计算。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>n_jobs=None</code> (默认)：使用 1 个核心。</li>
<li><code>n_jobs=-1</code>：使用所有可用的 CPU 核心。</li>
<li><code>n_jobs=2</code>：使用 2 个核心。</li>
</ul>
</li>
<li>
<p><strong>何时有用</strong>：</p>
<ul>
<li>这个参数主要在目标值 <code>y</code> 是<strong>多维</strong>（例如，你同时要预测多个相关的目标变量）时才会生效。对于绝大多数单目标回归问题（<code>y</code> 是一维向量），设置 <code>n_jobs</code> 不会有任何性能提升，因为计算无法被并行化。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li>对于普通的房价预测等单目标问题，<strong>可以忽略此参数</strong>，保持默认 <code>None</code> 即可。</li>
<li>只有在进行多输出回归（Multi-output Regression）时，才考虑设置 <code>n_jobs=-1</code> 来加速。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>4. <code>positive</code> : bool, default=False</strong></p>
<ul>
<li>
<p><strong>功能</strong>：强制所有系数（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>w</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">w_1, w_2, ..., w_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）为<strong>非负数</strong>。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>positive=False</code> (默认)：系数可以是任意实数（正数、负数或零）。</li>
<li><code>positive=True</code>：约束所有系数 &gt;= 0。这相当于在求解最优化问题时增加了一个约束条件。</li>
</ul>
</li>
<li>
<p><strong>应用场景</strong>：</p>
<ul>
<li>当你根据业务逻辑或先验知识，确定特征与目标之间<strong>只能是正相关关系</strong>时。例如，在商品需求预测中，假设价格打折（折扣力度是一个特征）永远不会导致需求减少，那么就可以强制该特征的系数为非负。</li>
<li>它也可以作为一种<strong>正则化</strong>的形式，帮助防止过拟合，特别是在特征数量多或数据量小的情况下。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li>大多数情况下保持默认 <code>False</code>。</li>
<li>只有当你有明确的理由要求模型系数必须为正时，才设置为 <code>True</code>。</li>
</ul>
</li>
</ul>
<p>线性回归-梯度下降使用 SGDRegressor</p>
<p><code>SGDRegressor</code> 的参数可以分为几大类：<strong>损失函数</strong>、<strong>正则化</strong>、<strong>学习率</strong>和<strong>迭代控制</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">sklearn.linear_model.SGDRegressor(
    <span class="hljs-attr">loss</span>=<span class="hljs-string">'squared_error'</span>, 
    <span class="hljs-attr">penalty</span>=<span class="hljs-string">'l2'</span>, 
    <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.0001</span>, 
    <span class="hljs-attr">l1_ratio</span>=<span class="hljs-number">0.15</span>,
    <span class="hljs-attr">fit_intercept</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">max_iter</span>=<span class="hljs-number">1000</span>,
    <span class="hljs-attr">tol</span>=<span class="hljs-number">1</span>e-<span class="hljs-number">3</span>,
    <span class="hljs-attr">shuffle</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">learning_rate</span>=<span class="hljs-string">'invscaling'</span>,
    <span class="hljs-attr">eta0</span>=<span class="hljs-number">0.01</span>,
    <span class="hljs-attr">power_t</span>=<span class="hljs-number">0.25</span>,
    <span class="hljs-attr">early_stopping</span>=<span class="hljs-literal">False</span>,
    <span class="hljs-attr">validation_fraction</span>=<span class="hljs-number">0.1</span>,
    <span class="hljs-attr">n_iter_no_change</span>=<span class="hljs-number">5</span>,
    <span class="hljs-attr">epsilon</span>=<span class="hljs-number">0.1</span>,
    <span class="hljs-attr">random_state</span>=None,
    <span class="hljs-attr">verbose</span>=<span class="hljs-number">0</span>,
    <span class="hljs-attr">warm_start</span>=<span class="hljs-literal">False</span>,
)
</code></pre>
<p>参数详解：</p>
<p><strong>1. 损失函数相关参数 (<code>loss</code>)</strong></p>
<ul>
<li>
<p><strong>loss : str, default='squared_error'</strong></p>
<ul>
<li>
<p><strong>功能</strong>：指定要使用的损失函数，即要最小化的目标函数。</p>
</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>'squared_error'</code>：普通最小二乘，即线性回归。损失函数为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(y - \hat{y})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>。<strong>这是最常用的默认值</strong>。</li>
<li><code>'huber'</code>：Huber 损失，对异常值的敏感度低于平方损失。它是平方损失和绝对损失的结合，需要通过 <code>epsilon</code> 参数控制其敏感度。</li>
<li><code>'epsilon_insensitive'</code>：ε-不敏感损失，用于支持向量回归（SVR）。</li>
<li><code>'squared_epsilon_insensitive'</code>：平方的 ε-不敏感损失。</li>
</ul>
</li>
<li>
<p><strong>选择指南</strong>：</p>
<ul>
<li>数据干净，无明显异常值：<code>'squared_error'</code>。</li>
<li>数据中有异常值，希望模型更稳健：<code>'huber'</code> 并调整 <code>epsilon</code>。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>epsilon : float, default=0.1</strong></p>
<ul>
<li><strong>功能</strong>：当 <code>loss='huber'</code> 或 <code>'epsilon_insensitive'</code> 时，此参数决定了其对错误的容忍度。对于 Huber 损失，误差小于 <code>epsilon</code> 时是平方项，大于时是线性项。<strong>值越大，对异常值越不敏感</strong>。</li>
</ul>
</li>
</ul>
<p><strong>2. 正则化相关参数 (<code>penalty</code>, <code>alpha</code>, <code>l1_ratio</code>)</strong></p>
<p>这是 <code>SGDRegressor</code> 非常强大的一部分，你可以轻松实现多种正则化。</p>
<ul>
<li>
<p><strong>penalty : {'l2', 'l1', 'elasticnet'}, default='l2'</strong></p>
<ul>
<li>
<p><strong>功能</strong>：指定使用的正则化类型，用于防止过拟合。</p>
</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>'l2'</code> (默认)： Ridge 回归。惩罚系数大小的平方和。倾向于产生小而分散的系数。</li>
<li><code>'l1'</code>： Lasso 回归。惩罚系数大小的绝对值和。倾向于产生稀疏模型（许多系数为0），可用于特征选择。</li>
<li><code>'elasticnet'</code>： Elastic-Net。L1 和 L2 惩罚的凸组合。通过 <code>l1_ratio</code> 参数控制混合比例。</li>
<li><code>None</code>： 无正则化。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>alpha : float, default=0.0001</strong></p>
<ul>
<li><strong>功能</strong>：<strong>正则化项的强度</strong>。乘以损失函数的常数。</li>
<li><strong>详解</strong>：<strong>alpha 越大，正则化越强</strong>，模型系数会被压缩得越小（趋向于0），模型越简单，越可能欠拟合。<code>alpha</code> 越小，正则化越弱，模型更可能过拟合。</li>
<li><strong>注意</strong>：SGD 中的 <code>alpha</code> 等价于 <code>Ridge(alpha=alpha)</code> 和 <code>Lasso(alpha=alpha)</code> 中的 <code>alpha</code>。<strong>这是最重要的需要调优的参数之一</strong>，通常通过网格搜索（如 <code>GridSearchCV</code>）在 <code>[1e-5, 1e-4, ..., 1, 10]</code> 这样的范围内寻找最佳值。</li>
</ul>
</li>
<li>
<p><strong>l1_ratio : float, default=0.15</strong></p>
<ul>
<li>
<p><strong>功能</strong>：当 <code>penalty='elasticnet'</code> 时，<strong>Elastic-Net 混合参数</strong>。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>l1_ratio = 0</code>： 等价于 L2 惩罚。</li>
<li><code>0 &lt; l1_ratio &lt; 1</code>： 混合 L1 和 L2。</li>
<li><code>l1_ratio = 1</code>： 等价于 L1 惩罚。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>3. 学习率调度参数 (<code>learning_rate</code>, <code>eta0</code>, <code>power_t</code>)</strong></p>
<p>梯度下降中，学习率决定了每一步更新的步长。</p>
<ul>
<li>
<p><strong>learning_rate : str, default='invscaling'</strong></p>
<ul>
<li>
<p><strong>功能</strong>：学习率调度策略。</p>
</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>'constant'</code>： 恒定学习率，由 <code>eta0</code> 指定。<code>eta = eta0</code></li>
<li><code>'optimal'</code>： 基于原始论文的启发式选择，不需要调 <code>eta0</code>。</li>
<li><code>'invscaling'</code> (默认)： <strong>逐渐衰减的学习率</strong>。计算公式为 <code>eta = eta0 / pow(t, power_t)</code>，其中 <code>t</code> 是时间步（迭代次数）。这是最常用的策略，随着迭代进行，步长越来越小，有助于收敛。</li>
<li><code>'adaptive'</code>： 自适应学习率。只要损失持续下降，就保持 <code>eta0</code> 不变；当连续 <code>n_iter_no_change</code> 次迭代损失下降低于 <code>tol</code> 时，将学习率除以5。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>eta0 : float, default=0.01</strong></p>
<ul>
<li><strong>功能</strong>：<strong>初始学习率</strong>。当 <code>learning_rate</code> 为 <code>'constant'</code>, <code>'invscaling'</code> 或 <code>'adaptive'</code> 时使用。</li>
<li><strong>详解</strong>：学习率设置太大可能导致算法无法收敛（在最优值附近震荡甚至发散），设置太小则收敛速度过慢。<strong>0.01 是一个常见的起始点</strong>。</li>
</ul>
</li>
<li>
<p><strong>power_t : float, default=0.25</strong></p>
<ul>
<li><strong>功能</strong>：当 <code>learning_rate='invscaling'</code> 时，用于计算学习率的指数。</li>
</ul>
</li>
</ul>
<p><strong>4. 迭代与停止条件参数 (<code>max_iter</code>, <code>tol</code>, <code>early_stopping</code>)</strong></p>
<ul>
<li>
<p><strong>max_iter : int, default=1000</strong></p>
<ul>
<li><strong>功能</strong>：遍历训练数据的最大次数（epochs）。</li>
<li><strong>详解</strong>：SGD 是迭代算法，需要一个停止条件。对于中小型数据集，1000 通常足够。如果数据集很大，可能需要减少这个值。</li>
</ul>
</li>
<li>
<p><strong>tol : float, default=1e-3</strong></p>
<ul>
<li><strong>功能</strong>：停止训练的容忍度。</li>
<li><strong>详解</strong>：如果一次迭代中损失的下降小于 <code>tol</code>，且 <code>early_stopping=False</code>，则训练停止。<strong>调低 tol 可能会使模型拟合得更好，但也会增加训练时间</strong>。</li>
</ul>
</li>
<li>
<p><strong>early_stopping : bool, default=False</strong></p>
<ul>
<li><strong>功能</strong>：是否使用提前停止。</li>
<li><strong>详解</strong>：当设置为 <code>True</code> 时，会预留一部分数据（<code>validation_fraction</code>）作为验证集。当验证分数在连续 <code>n_iter_no_change</code> 次迭代中没有提高至少 <code>tol</code> 时，就停止训练。<strong>这是一种有效防止过拟合的方法</strong>。</li>
</ul>
</li>
<li>
<p><strong>n_iter_no_change : int, default=5</strong></p>
<ul>
<li><strong>功能</strong>：在提前停止或学习率自适应下降之前，等待验证集分数无改进的迭代次数。</li>
</ul>
</li>
<li>
<p><strong>validation_fraction : float, default=0.1</strong></p>
<ul>
<li><strong>功能</strong>：当 <code>early_stopping=True</code> 时，用作验证集的训练数据比例。</li>
</ul>
</li>
</ul>
<p><strong>5. 其他重要参数</strong></p>
<ul>
<li>
<p><strong>shuffle : bool, default=True</strong></p>
<ul>
<li><strong>功能</strong>：是否在每轮迭代后打乱训练数据。<strong>强烈建议保持 True</strong>，打乱数据是 SGD 工作的核心假设之一，可以防止循环出现不良的更新模式。</li>
</ul>
</li>
<li>
<p><strong>random_state : int, default=None</strong></p>
<ul>
<li><strong>功能</strong>：控制数据打乱和初始化的随机种子。设置一个固定的值可以确保每次运行的结果一致，<strong>对于复现实验结果至关重要</strong>。</li>
</ul>
</li>
<li>
<p><strong>warm_start : bool, default=False</strong></p>
<ul>
<li><strong>功能</strong>：如果设为 <code>True</code>，那么调用 <code>fit()</code> 时会使用上一次训练得到的系数作为初始化参数，从而实现增量训练。否则，每次 <code>fit()</code> 都会重新初始化。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">6，具体示例-加州房价预测</h2>
<p>加州房价数据集介绍</p>
<ol start="0">
<li>数据集概况</li>
</ol>
<ul>
<li><strong>来源</strong>：该数据集源自 <strong>1990 年的加州人口普查</strong>。</li>
<li><strong>用途</strong>：用于<strong>回归模型</strong>的练习和测试，目标是预测加州各区域的<strong>房屋中位价</strong>。</li>
<li><strong>样本数量</strong>：<strong>20,640</strong> 条记录。这比波士顿数据集（506条）大得多，能更好地体现机器学习算法的效果。</li>
<li><strong>特征数量</strong>：<strong>8 个</strong>数值型特征。这些特征涵盖了人口、地理位置和经济指标。</li>
<li><strong>目标变量</strong>：<code>MedHouseVal</code> - 街区群体的房屋中位价，单位是<strong>十万美元</strong>。</li>
</ul>
<blockquote>
<p><strong>注意</strong>：目标变量是<strong>分组中位价</strong>。这意味着一个街区的所有房屋都被分配了该街区的 median house value。对于任何位于该街区的房屋，目标值都是相同的。</p>
</blockquote>
<ol start="2">
<li>特征详细说明</li>
</ol>
<p>这8个特征提供了预测房价的不同维度信息，均无伦理问题：</p>
<ol start="0">
<li>
<p><strong>MedInc</strong>：街区居民的收入中位数。</p>
</li>
<li>
<p><strong>HouseAge</strong>：街区内房屋年龄中位数。</p>
</li>
<li>
<p><strong>AveRooms</strong>：平均房间数（每户）。</p>
</li>
<li>
<p><strong>AveBedrms</strong>：平均卧室数（每户）。</p>
</li>
<li>
<p><strong>Population</strong>：街区人口数。</p>
</li>
<li>
<p><strong>AveOccup</strong>：平均家庭成员数（每户）。</p>
</li>
<li>
<p><strong>Latitude</strong>：街区的纬度。</p>
</li>
<li>
<p><strong>Longitude</strong>：街区的经度。</p>
<p>3.目标变量：</p>
</li>
</ol>
<ul>
<li><strong>MedHouseVal</strong>：房屋中位价（单位：十万美元）。</li>
</ul>
<p>线性回归-正规方程使用 LinearRegression</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> fetch_california_housing
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
​
<span class="hljs-comment"># 1,加载数据</span>
california = fetch_california_housing()
<span class="hljs-built_in">print</span>(california.data, california.data.shape)
<span class="hljs-built_in">print</span>(california.target)
<span class="hljs-built_in">print</span>(california.feature_names)
​
<span class="hljs-comment"># 2,数据预处理</span>
X_train, X_test, y_train, y_test = train_test_split(california.data, california.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">20</span>)
scaler = StandardScaler()  <span class="hljs-comment"># 数据标准化：消除不同特征量纲的影响</span>
X_train_scaled = scaler.fit_transform(X_train)  <span class="hljs-comment"># fit计算生成模型，transform通过模型转换数据</span>
X_test_scaled = scaler.transform(X_test)  <span class="hljs-comment"># # 使用训练集的参数转换测试集</span>
​
<span class="hljs-comment"># 3,创建和训练线性回归模型(正规方程)</span>
lr_model = LinearRegression()  <span class="hljs-comment"># 创建分类器实例</span>
lr_model.fit(X_train_scaled, y_train)  <span class="hljs-comment"># 训练模型</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'权重系数：'</span>, lr_model.coef_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'偏置值：'</span>, lr_model.intercept_)  <span class="hljs-comment"># 在线性回归模型中，•偏置（截距）•（bias）是模型参数之一，表示当所有特征值为0时，目标变量的期望值。</span>
​
<span class="hljs-comment"># 4，模型评估</span>
y_predict = lr_model.predict(X_test_scaled)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'预测值：'</span>, y_predict)
mse = mean_squared_error(y_test, y_predict)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'正规方程-均方误差：'</span>, mse)
</code></pre>
<p>运行输出：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[[   8.3252       41.            6.98412698 ...    2.55555556    37.88       -122.23      ]</span>
 <span class="hljs-selector-attr">[   8.3014       21.            6.23813708 ...    2.10984183    37.86       -122.22      ]</span>
 <span class="hljs-selector-attr">[   7.2574       52.            8.28813559 ...    2.80225989    37.85       -122.24      ]</span>
 ...
 <span class="hljs-selector-attr">[   1.7          17.            5.20554273 ...    2.3256351    39.43       -121.22      ]</span>
 <span class="hljs-selector-attr">[   1.8672       18.            5.32951289 ...    2.12320917    39.43       -121.32      ]</span>
 <span class="hljs-selector-attr">[   2.3886       16.            5.25471698 ...    2.61698113    39.37       -121.24      ]</span>] (<span class="hljs-number">20640</span>, <span class="hljs-number">8</span>)
<span class="hljs-selector-attr">[4.526 3.585 3.521 ... 0.923 0.847 0.894]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'MedInc'</span>, <span class="hljs-string">'HouseAge'</span>, <span class="hljs-string">'AveRooms'</span>, <span class="hljs-string">'AveBedrms'</span>, <span class="hljs-string">'Population'</span>, <span class="hljs-string">'AveOccup'</span>, <span class="hljs-string">'Latitude'</span>, <span class="hljs-string">'Longitude'</span>]</span>
权重系数： <span class="hljs-selector-attr">[ 0.83275185  0.1173856  -0.27597663  0.29900186 -0.00795271 -0.03963673 -0.88241635 -0.85338011]</span>
偏置值： <span class="hljs-number">2.0678235537788865</span>
预测值： <span class="hljs-selector-attr">[1.58299034 3.01567949 1.75417605 ... 1.84161594 2.81049138 1.16693905]</span>
正规方程-均方误差： <span class="hljs-number">0.5410055769085323</span>
​
Process finished with exit <span class="hljs-selector-tag">code</span> <span class="hljs-number">0</span>
</code></pre>
<p>线性回归-梯度下降使用 SGDRegressor</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> fetch_california_housing
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> SGDRegressor
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
​
<span class="hljs-comment"># 1,加载数据</span>
california = fetch_california_housing()
<span class="hljs-built_in">print</span>(california.data, california.data.shape)
<span class="hljs-built_in">print</span>(california.target)
<span class="hljs-built_in">print</span>(california.feature_names)
​
<span class="hljs-comment"># 2,数据预处理</span>
X_train, X_test, y_train, y_test = train_test_split(california.data, california.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">20</span>)
scaler = StandardScaler()  <span class="hljs-comment"># 数据标准化：消除不同特征量纲的影响</span>
X_train_scaled = scaler.fit_transform(X_train)  <span class="hljs-comment"># fit计算生成模型，transform通过模型转换数据</span>
X_test_scaled = scaler.transform(X_test)  <span class="hljs-comment"># # 使用训练集的参数转换测试集</span>
​
<span class="hljs-comment"># 3,创建和训练线性回归模型(梯度下降)</span>
lr_model = SGDRegressor()  <span class="hljs-comment"># 创建分类器实例</span>
lr_model.fit(X_train_scaled, y_train)  <span class="hljs-comment"># 训练模型</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'权重系数：'</span>, lr_model.coef_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'偏置值：'</span>, lr_model.intercept_)  <span class="hljs-comment"># 在线性回归模型中，•偏置（截距）•（bias）是模型参数之一，表示当所有特征值为0时，目标变量的期望值。</span>
​
<span class="hljs-comment"># 4，模型评估</span>
y_predict = lr_model.predict(X_test_scaled)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'预测值：'</span>, y_predict)
mse = mean_squared_error(y_test, y_predict)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'梯度下降方程-均方误差：'</span>, mse)
</code></pre>
<p>运行输出：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[[   8.3252       41.            6.98412698 ...    2.55555556    37.88       -122.23      ]</span>
 <span class="hljs-selector-attr">[   8.3014       21.            6.23813708 ...    2.10984183    37.86       -122.22      ]</span>
 <span class="hljs-selector-attr">[   7.2574       52.            8.28813559 ...    2.80225989    37.85       -122.24      ]</span>
 ...
 <span class="hljs-selector-attr">[   1.7          17.            5.20554273 ...    2.3256351    39.43       -121.22      ]</span>
 <span class="hljs-selector-attr">[   1.8672       18.            5.32951289 ...    2.12320917    39.43       -121.32      ]</span>
 <span class="hljs-selector-attr">[   2.3886       16.            5.25471698 ...    2.61698113    39.37       -121.24      ]</span>] (<span class="hljs-number">20640</span>, <span class="hljs-number">8</span>)
<span class="hljs-selector-attr">[4.526 3.585 3.521 ... 0.923 0.847 0.894]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'MedInc'</span>, <span class="hljs-string">'HouseAge'</span>, <span class="hljs-string">'AveRooms'</span>, <span class="hljs-string">'AveBedrms'</span>, <span class="hljs-string">'Population'</span>, <span class="hljs-string">'AveOccup'</span>, <span class="hljs-string">'Latitude'</span>, <span class="hljs-string">'Longitude'</span>]</span>
权重系数： <span class="hljs-selector-attr">[ 9.00030244e-01  1.20593849e-01 -5.13860669e-01  2.43337638e-01 -5.14784939e-04 -1.24408200e-01 -7.15071233e-01 -6.91217595e-01]</span>
偏置值： <span class="hljs-selector-attr">[2.05038682]</span>
预测值： <span class="hljs-selector-attr">[1.67351153 2.91473399 1.719945   ... 1.93827611 2.66340199 1.29512693]</span>
梯度下降方程-均方误差： <span class="hljs-number">0.711588824356649</span>
</code></pre>
<h2 data-id="heading-6">7，回归性能评估</h2>
<p>均方误差（Mean Squared Error，MSE）是回归问题中常用的性能评估指标之一，它衡量了模型预测值与真实值之间的差异。MSE的公式如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df97952a736f42caa831530b7492814c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=OwmgZDsbSAt8k0vax8QBFX%2Ftx3M%3D" alt="image.png" loading="lazy"/></p>
<p>在 <code>scikit-learn</code> 中，计算均方误差非常简单，可以通过 <code>mean_squared_error</code> 函数来实现：</p>
<pre><code class="hljs language-ini" lang="ini">mean_squared_error(
    y_true, 
    y_pred, 
    *, 
    <span class="hljs-attr">sample_weight</span>=None, 
    <span class="hljs-attr">multioutput</span>=<span class="hljs-string">'uniform_average'</span>, 
    <span class="hljs-attr">squared</span>=<span class="hljs-literal">True</span>
)
</code></pre>
<p>参数详解：</p>
<p><strong>1. <code>y_true</code> : array-like of shape (n_samples,) or (n_samples, n_outputs)</strong></p>
<ul>
<li><strong>功能</strong>：<strong>真实值</strong>（Ground Truth / Actual Values）。</li>
<li><strong>要求</strong>：这是必需的定位参数（必须提供）。</li>
<li><strong>格式</strong>：可以是一维数组（单输出问题）或二维数组（多输出问题）。</li>
</ul>
<p><strong>2. <code>y_pred</code> : array-like of shape (n_samples,) or (n_samples, n_outputs)</strong></p>
<ul>
<li><strong>功能</strong>：<strong>预测值</strong>（Predicted Values）。</li>
<li><strong>要求</strong>：这是必需的定位参数（必须提供）。</li>
<li><strong>格式</strong>：必须与 <code>y_true</code> 具有相同的形状。</li>
</ul>
<p><strong>3. <code>sample_weight</code> : array-like of shape (n_samples,), default=None</strong></p>
<ul>
<li>
<p><strong>功能</strong>：<strong>样本权重</strong>。用于给每个样本的损失赋予不同的重要性。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>None</code> (默认)：所有样本的权重相等。</li>
<li>提供权重数组：权重大的样本，其预测误差对最终 MSE 的贡献也更大。</li>
</ul>
</li>
<li>
<p><strong>应用场景</strong>：</p>
<ul>
<li>某些样本在业务上更重要，需要模型更准确地预测它们。</li>
<li>处理类别不平衡的回归问题（虽然不常见）。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“能用”到“会用”｜如何写好一个 Skill]]></title>    <link>https://juejin.cn/post/7600791597168525355</link>    <guid>https://juejin.cn/post/7600791597168525355</guid>    <pubDate>2026-01-30T02:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600791597168525355" data-draft-id="7600705405595680831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“能用”到“会用”｜如何写好一个 Skill"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-30T02:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“能用”到“会用”｜如何写好一个 Skill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:46:58.000Z" title="Fri Jan 30 2026 02:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9c0d4f435e6430bbe05365a720ccfc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=EnVG%2Fo7Afg%2BjIrUumxfjzeeaoBM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：Jiaqi，TRAE 技术文档工程师</p>
</blockquote>
<p>之前带大家了解了 Skill 的原理和应用，本文继续带领大家从“能用”到“会用”，如何写好一个 Skill 至关重要。</p>
<p>本文为 Skill 设计与开发的一站式最佳实践指南，可助力你：</p>
<ul>
<li>
<p>系统厘清 Skill 的定义，规避常见认知误区；</p>
</li>
<li>
<p>熟练掌握高命中率、高稳定性 Skill 的设计标准与核心原则；</p>
</li>
<li>
<p>掌握 “评测驱动、失败优先” 的工程化 Skill 构建与迭代全流程；</p>
</li>
<li>
<p>掌握可维护、可扩展的 Skill 设计技巧；</p>
</li>
<li>
<p>依托 AI 高效完成 Skill 的创建、迭代与优化；</p>
</li>
<li>
<p>凭借反模式检查清单，精准规避 Skill 开发中的典型问题。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925c335469a84e45b9fc343d9d93c2e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=ycqzZY6cdm9Et6BSGzR615Xm0k4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是 Skill ？</strong></h2>
<h3 data-id="heading-1"><strong>定义</strong></h3>
<p>一个 Skill 是一份清晰、严谨、可执行的指令文档，用于明确告诉模型——在什么条件下（When），按照哪些步骤（How），产出什么结果（What）。</p>
<h3 data-id="heading-2"><strong>常见认知误区</strong></h3>
<p>在编写 Skill 之前，建议先了解以下几个常见误区。这些问题往往会直接导致 Skill 难以被正确触发，或在执行过程中表现不稳定。</p>
<h4 data-id="heading-3"><strong>误区一：Skill 等同于一段 Prompt</strong></h4>
<p>Skill 并不是一次性的对话提示。它是一个可长期复用、输入输出明确的能力模块，强调的是稳定、确定且易于工程化维护。而 Prompt 更偏向临时性、探索性和即兴交互，两者在设计目标和工程要求上完全不同。</p>
<h4 data-id="heading-4"><strong>误区二：Skill 是写给人看的文档</strong></h4>
<p>Skill 的目标不是“解释原理”，而是“下达指令”。<em><strong>SKILL.md</strong></em> 文件的内容应使用模型可解析的结构化语言，明确约束其行为边界，并精确描述何时使用（When）、如何执行（How）、输出结果（What）。</p>
<h4 data-id="heading-5"><strong>误区三：Skill 越复杂越强大</strong></h4>
<p>复杂度并不与 Skill 的能力强度挂钩。模型的推理与决策成本是显著的。职责单一、边界清晰的 Skill，更容易在正确的时机被选中并稳定执行。过于复杂的 Skill 反而会降低命中率。</p>
<blockquote>
<p><strong>提示</strong></p>
<p>模型的上下文窗口是有限且宝贵的公共资源。每一个被加载的 Skill 都在竞争有限的上下文资源。因此，Skill 文档应以最小必要信息为目标，避免冗余解释与不必要的背景铺垫。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f9fd9d99d4047fa8df1e73e23df891c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=uDLhWnSoobz5eZoAjTmk8YL%2BmDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>Skill 的设计标准与原则</strong></h2>
<p>以下标准是构建高命中率、高稳定性 Skill 的基础。可将其作为设计与评审 Skill 时的检查清单。</p>
<h3 data-id="heading-7"><strong>精准的元数据内容</strong></h3>
<p>Skill 的元数据（name 和 description）是模型发现和识别 Skill 的入口，其设计直接影响触发准确率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53534cd0028341789f32667c4427b688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=YOgSk2PwZtiIGJDAormvbgAGyfE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>指导方式的自由度分级</strong></h3>
<p>根据任务复杂度与容错要求，合理控制对模型的约束强度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bc1d5de6fd847b2b5dbf8b68923f31d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=IyvLxWY9rbntzp6XCvirBaSUV6U%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b641e70e0e4917b62abf1f3c6a1263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=k8mmW9gcXOzIXm5XdeflXRSmw1o%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc3071a12bc450bb88de44cca330f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=BMRsq4GG52LqbCzOp6mbk0nWA8k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>五个核心标准</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d624809950da4cd7b3a3cd97aa59cbc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=SCKvYQOUGryiT1G91F0G5r4K8q4%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb9b5ff3cd246038a73415d07af4a56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=fNs8IAyTWdP0mlCiJV7ba%2FUyNCU%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8a10f6a22b7449fb81436025c675cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=WOsFr0%2F%2BeAf%2B3e9bUdIze6U5CsE%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d69e9c2c6643409a36c1574ce343c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=Zf2VKaN41J0lDfMMi2VtmrJIYps%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d391f9bcc214bfd9e5770929c104d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=chGm%2FO9oemdfLk5DIg5FLn30Tow%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>构建与迭代 Skill 的最佳流程</strong></h2>
<p>Skill 的开发是一个以失败为起点、评测为牵引，持续迭代优化的工程化过程。</p>
<p>评测并非事后的验证环节，而是 Skill 设计的前提；Skill 也非基于假设的规则集合，而是针对已暴露问题的最小化解决方案。</p>
<p>遵循 “评测驱动、失败优先” 的原则，能确保 Skill 在实际使用场景中拥有清晰的能力边界、稳定的运行表现，以及可回归的质量保障体系。</p>
<h3 data-id="heading-11"><strong>第一步：建立无 Skill 基线，识别真实问题</strong></h3>
<p>在编写任何 Skill 之前，应先不使用 Skill，直接让模型执行目标任务，作为基线对照。</p>
<p>重点观察并记录以下问题：</p>
<ul>
<li>
<p>模型在哪些情况下表现不稳定或结果不可复现；</p>
</li>
<li>
<p>哪些输入会引发歧义、误解或走偏；</p>
</li>
<li>
<p>模型是否在错误的时机尝试“主动帮忙”。</p>
</li>
</ul>
<p>这些失败点和不确定行为，本质上就是 Skill 需要解决的真实能力缺口，也是后续评测用例的来源。</p>
<h3 data-id="heading-12"><strong>第二步：以“失败优先”为原则，定义评测用例</strong></h3>
<p>明确核心问题后，需优先编写评测用例，而非直接开发 Skill。评测是约束，Skill 是落地实现。脱离评测约束的 Skill，本质上是在放大模型的行为不确定性。</p>
<p>评测的核心作用是约束 Skill 的行为边界，明确以下信息：</p>
<ul>
<li>
<p>什么场景下属于 Skill 的正确使用范围？</p>
</li>
<li>
<p>什么场景下 Skill 必须拒绝执行或判定为失败？</p>
</li>
<li>
<p>什么样的输出结果才算稳定可用？</p>
</li>
</ul>
<p>推荐做法：</p>
<ul>
<li>
<p>针对已识别的问题，设计 3–5 个具体、可复现的评测用例；</p>
</li>
<li>
<p>每个用例均需明确 “通过 / 失败” 的判定标准；</p>
</li>
<li>
<p>优先覆盖模型最易误用 Skill 的场景。</p>
</li>
</ul>
<h3 data-id="heading-13"><strong>第三步：编写最小化 Skill，明确最短成功路径</strong></h3>
<p>在评测已经存在的前提下，开始编写 Skill。</p>
<p>此阶段不追求覆盖所有情况，而是只编写刚好能够通过当前评测的最小规则集合，重点关注三个要素：</p>
<ul>
<li>
<p><strong>明确失败条件（When NOT to use）</strong></p>
<p>将评测中识别的失败场景，显式写入 Skill 中，作为第一层防护，避免 Skill 被误触发或滥用。</p>
</li>
<li>
<p><strong>定义最短成功路径</strong></p>
<p>清晰描述 Skill 最简单、最核心的执行流程，确保最精简的有效输入能得到可预测的稳定输出。</p>
</li>
<li>
<p><strong>保持职责单一</strong></p>
<p>单个 Skill 仅解决一个明确问题，对应一个核心动作，避免在早期引入额外复杂度。</p>
</li>
</ul>
<p>这一阶段的 Skill，是评测结果的直接产物，而非凭经验预判的方案。</p>
<h3 data-id="heading-14"><strong>第四步：补充边界条件与结构化示例</strong></h3>
<p>当最短成功路径能稳定通过评测后，再逐步扩展 Skill 的适用范围。</p>
<p>完成以下三项核心工作：</p>
<ul>
<li>
<p>补充更多边界场景及对应的行为约束；</p>
</li>
<li>
<p>明确 Skill 输入（Input）、输出（Output）的结构化定义；</p>
</li>
<li>
<p>补充关键的输入、输出示例，帮助模型对齐行为预期。</p>
</li>
</ul>
<p><strong>核心原则：</strong> 所有新增规则，均需对应新增或已有评测用例，避免在无评测支撑的情况下将 Skill 复杂化。</p>
<h3 data-id="heading-15"><strong>第五步：评测回归与持续迭代</strong></h3>
<p>Skill 的迭代，需始终与评测结果强绑定，遵循以下规则：</p>
<ul>
<li>
<p>新增评测用例 → 推动 Skill 的增量修改；</p>
</li>
<li>
<p>任意修改 Skill → 必须通过已有评测的回归验证；</p>
</li>
<li>
<p>若评测未通过，优先简化 Skill，而非盲目叠加新规则。</p>
</li>
</ul>
<p>通过持续对比模型在 “无 Skill 基线” 与 “当前 Skill + 评测” 中的表现，可验证该 Skill 是否真正提升了模型执行目标任务的成功率与稳定性。</p>
<h3 data-id="heading-16"><strong>第六步：结合真实使用路径进行校准</strong></h3>
<p>评测仅能覆盖已知问题，在真实场景中使用 Skill 时，可能会暴露更多新的问题。</p>
<p>在 Skill 实际使用过程中，需持续观察以下情况：</p>
<ul>
<li>
<p>模型是否在非预期场景下误触发 Skill？</p>
</li>
<li>
<p>模型执行 Skill 时，是否遗漏关键参考文件或上下文？</p>
</li>
<li>
<p>模型是否会反复读取某一段内容，形成隐性依赖？</p>
</li>
</ul>
<p>上述这些信号，均需作为新的评测输入，重新进入 Step 2，形成 Skill 迭代的闭环。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d6496cadbc45959bca9dc12167b952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=kcFreYXQ%2FmdWP%2BvqH%2F9CTAzvFiM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>让 Skill 可维护与可拓展</strong></h2>
<h3 data-id="heading-18"><strong>渐进式披露</strong></h3>
<p><em><strong>SKILL.md</strong></em> 应当作为 Skill 的入口和导航，而不是一个包罗万象的大文件。详细的参考资料、示例、脚本或文档应拆分成独立文件，从而减轻模型初次加载的负担，让信息按需流动。</p>
<h4 data-id="heading-19"><strong>信息架构原则：从简单到复杂</strong></h4>
<p>​一个 Skill 的目录可以随着功能扩展逐步演化：从单一文件 → 多个参考文件和脚本组成的结构。通过渐进式披露，模型能快速抓住核心信息，再深入了解细节。</p>
<h4 data-id="heading-20"><strong>最佳实践</strong></h4>
<ul>
<li>
<p><strong>保持 SKILL.md 简洁：</strong> 主体内容尽量控制在 500 行以内，只包含必要信息。</p>
</li>
<li>
<p><strong>避免深度嵌套：</strong> 所有引用文件最好直接由 <em><strong>SKILL.md</strong></em> 链接，保持一层引用深度，避免链式引用（A → B → C），防止模型只读取部分内容。</p>
</li>
<li>
<p><strong>为长文件添加目录：</strong> 对于超过 100 行的参考文件，在文件顶部添加一个目录（Table of Contents），帮助模型快速了解文件结构。</p>
</li>
</ul>
<h4 data-id="heading-21"><strong>示例</strong></h4>
<p>以下为一个渐进式披露的 SKILL.md 示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># SKILL.md</span>

<span class="hljs-section">## 基础用法</span>
描述如何触发 CI/CD 流水线：
<span class="hljs-bullet">-</span> 检查 PR 状态
<span class="hljs-bullet">-</span> 执行单元测试
<span class="hljs-bullet">-</span> 更新 PR 测试状态

<span class="hljs-section">## 高级功能</span>
详细说明请参见 <span class="hljs-code">`ci-advanced-features.md`</span>：
<span class="hljs-bullet">-</span> 并行执行多分支测试
<span class="hljs-bullet">-</span> 条件触发不同类型的测试
<span class="hljs-bullet">-</span> 自定义失败处理策略

<span class="hljs-section">## API 参考</span>
所有方法与参数说明请参见 <span class="hljs-code">`ci-api-reference.md`</span>：
<span class="hljs-bullet">-</span> startPipeline(prId: string, branch: string)
<span class="hljs-bullet">-</span> getPipelineStatus(pipelineId: string)
<span class="hljs-bullet">-</span> cancelPipeline(pipelineId: string)
</code></pre>
<h3 data-id="heading-22"><strong>工作流与反馈闭环</strong></h3>
<p>对于包含多个步骤、且中间结果会影响最终质量的复杂任务，仅提供最终目标是不够的。必须显式定义工作流（Workflow）和 检查清单（Checklist），引导模型按步骤执行，并在关键节点建立 “验证 → 修正 → 再验证” 的反馈闭环。</p>
<p>工作流负责约束任务执行顺序，检查清单负责追踪任务的执行状态和质量。两者结合可以显著降低遗漏和跑偏的风险。</p>
<h4 data-id="heading-23"><strong>分析类任务的工作流</strong></h4>
<p>即使不涉及代码，分析类任务同样适合使用工作流。 检查清单可以帮助模型明确“当前做到哪一步”、“是否可以进入下一步”。例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">## 技术方案评估工作流

在开始执行前复制以下清单，并在每一步完成后显式标记状态。

- <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>：明确业务目标与技术约束（性能、成本、时限）
- <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>：列出所有可行的技术方案
- <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>：从复杂度、可维护性、风险角度逐一评估
- <span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>：对关键差异点进行对比分析；(反馈闭环) 若发现关键信息不足，应返回 <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span> 或 <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span> 补充分析
- <span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>：给出结论性建议，并说明取舍理由；(反馈闭环) 若结论无法支撑目标约束，应重新审视 <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span> 的前提条件
</code></pre>
<h4 data-id="heading-24"><strong>代码类任务的工作流</strong></h4>
<p>​代码类任务往往伴随不可逆或影响范围较大的操作，例如重构、依赖升级或配置变更。通过 “Plan → Validate → Execute” 模式，可以有效降低误操作风险。例如：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 依赖版本升级工作流</span>

<span class="hljs-bullet">-</span> Step 1（Plan）：
<span class="hljs-bullet">  -</span> 识别需要升级的依赖及当前版本
<span class="hljs-bullet">  -</span> 阅读目标版本的 Release Notes 与 Breaking Changes
<span class="hljs-bullet">-</span> Step 2（Plan）：
<span class="hljs-bullet">  -</span> 更新依赖配置文件（如 package.json / go.mod）
<span class="hljs-bullet">  -</span> 标注可能受影响的模块
<span class="hljs-bullet">-</span> Step 3（Validate）：
<span class="hljs-bullet">-</span> 执行依赖冲突检查与静态构建（运行 dependency<span class="hljs-emphasis">_check.sh）
  - 确认无版本冲突或构建失败
  - (反馈闭环) 若校验失败，必须回退到 Step 2 调整依赖配置
- Step 4（Execute）：
  - 安装新版本依赖
  - 运行完整测试集
- Step 5（Validate）：
  - 检查核心功能是否受影响
  - 对比升级前后的构建与运行结果
  - (反馈闭环) 若出现回归问题，应回滚升级并记录风险点
</span></code></pre>
<h3 data-id="heading-25"><strong>可执行脚本的加固原则</strong></h3>
<p>当 Skill 依赖可执行脚本时，脚本的健壮性应始终优先于代码的巧妙性。</p>
<p>Skill 本身不会理解或阅读你的代码逻辑，它只感知输入与输出。一旦脚本行为不可预测，模型就只能猜测，最终导致不稳定或错误的调用结果。因此，脚本必须做到：失败可预期、输出可理解、参数可解释。</p>
<h4 data-id="heading-26"><strong>显式处理错误，而不是让模型猜</strong></h4>
<p>不要将异常直接抛给模型处理。脚本应覆盖常见错误场景，并将技术异常转化为可理解、可决策的输出。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>捕获常见异常（如文件缺失、权限不足、配置错误）</p>
</li>
<li>
<p>为每类错误返回清晰的错误原因和下一步建议</p>
</li>
</ul>
<p><strong>示例：</strong> 配置文件校验脚本</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ERROR:</span> Config file <span class="hljs-built_in">not</span> found: ./deploy.yaml
<span class="hljs-symbol">HINT:</span> Please check whether the file path <span class="hljs-built_in">is</span> correct <span class="hljs-built_in">or</span> run init-config.sh <span class="hljs-keyword">to</span> generate a <span class="hljs-keyword">default</span> config.
</code></pre>
<h4 data-id="heading-27"><strong>输出自解释的日志与验证结果</strong></h4>
<p>脚本的输出本身就是模型的“上下文”。一个好的脚本不仅说明发生了什么，还说明为什么会这样，以及接下来可以怎么做。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>成功路径和失败路径都要有明确输出</p>
</li>
<li>
<p>验证类脚本应明确列出通过项与失败项</p>
</li>
</ul>
<p><strong>示例：</strong> 构建环境检查脚本</p>
<pre><code class="hljs language-markdown" lang="markdown">CHECK FAILED: Node.js version mismatch
<span class="hljs-bullet">-</span> Required: &gt;= 18.0.0
<span class="hljs-bullet">-</span> Detected: 16.14.0

VALID OPTIONS:
<span class="hljs-bullet">1.</span> Upgrade Node.js to a supported version
<span class="hljs-bullet">2.</span> Switch to a compatible build image
</code></pre>
<h4 data-id="heading-28"><strong>避免魔法数字，让参数“有来由”</strong></h4>
<p>脚本中的常量（如 <em><strong>TIMEOUT = 30</strong></em>）如果缺乏解释，模型和人都无法判断它是否合理。任何影响行为的数值，都应该是可解释、可调整的。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>为常量添加语义化名称</p>
</li>
<li>
<p>说明数值来源或设计依据</p>
</li>
<li>
<p>必要时允许通过参数覆盖默认值</p>
</li>
</ul>
<p><strong>示例：</strong> 部署等待脚本</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">TIMEOUT_SECONDS</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># Wait up to 30s because service startup usually completes within 10–20s</span>
</code></pre>
<p>或在输出中体现：</p>
<pre><code class="hljs language-rust" lang="rust">INFO: Waiting <span class="hljs-keyword">for</span> <span class="hljs-title class_">service</span> to <span class="hljs-keyword">become</span> <span class="hljs-title function_ invoke__">healthy</span> (timeout: <span class="hljs-number">30</span>s)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0086657e4fc4b938f0676a145dfc9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=2Vt0GyoX2JxUwMqALNQawCWmxZU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-29"><strong>巧妙使用 AI 来创建和迭代 Skill</strong></h2>
<p>在创建和迭代 Skill 的过程中，可以多用 AI。你负责定义问题和验收结果，AI 负责反复试错、总结规律并封装成可复用的 Skill。</p>
<h3 data-id="heading-30"><strong>阶段一：初次创建（从具体任务中抽象）</strong></h3>
<p>让 AI 从真实任务中抽象出创建 Skill 所需的信息，然后创建初版 Skill。</p>
<p><strong>1. 让 AI 直接执行真实任务</strong></p>
<p>提供完整目标与上下文，让 AI 自行尝试完成任务。执行过程中的追问、走偏和修正，本质上就是一次“隐式评测”。</p>
<p><strong>2. 引导 AI 进行结构化复盘</strong></p>
<p>任务完成后，要求 AI 从以下维度复盘：</p>
<ul>
<li>
<p>成功执行任务的完整步骤；</p>
</li>
<li>
<p>任务执行过程中的不确定性与失败点；</p>
</li>
<li>
<p>可抽象的固定流程与判断逻辑；</p>
</li>
<li>
<p>该流程和判断逻辑的适用场景与不适用场景。</p>
</li>
</ul>
<p><strong>3. 基于复盘生成 Skill 初稿</strong></p>
<p>要求 AI 按 Skill 规范生成 SKILL.md，明确：触发条件（When）、如何执行（How）、输出结果（What）、预设失败策略。</p>
<p><strong>4. 人工快速评审并入库</strong></p>
<p>你只需关注边界是否合理、步骤是否可执行，其余交由 AI 完成。确认后，让 AI 调用 skills-creator 正式创建该 Skill 并添加至你的项目。</p>
<h3 data-id="heading-31"><strong>阶段二：持续迭代（从使用反馈中优化）</strong></h3>
<p>当 Skill 在使用中暴露新问题时，对其进行优化。</p>
<p><strong>1. 对齐偏差来源</strong></p>
<p>引导 AI 分析问题源自 When / What / How 中的哪一部分。</p>
<p><strong>2. 直接修改 Skill 并验证回归</strong></p>
<p>更新 <em><strong>SKILL.md</strong></em>，并同时验证：</p>
<ul>
<li>
<p>确保本次迭代未破坏原有的“黄金路径”。</p>
</li>
<li>
<p>确保新发现的错误场景已被覆盖。</p>
</li>
</ul>
<h3 data-id="heading-32"><strong>在 TRAE 中创建 Skill 的其他方式</strong></h3>
<p>除了通过 AI 对话创建 Skill 外，你还以手动创建或导入外部 Skill。详细说明点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trae.cn%2Fide%2Fskills%238be9a856" target="_blank" title="https://docs.trae.cn/ide/skills#8be9a856" ref="nofollow noopener noreferrer">docs.trae.cn/ide/skills#…</a> 参考官网文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079af5a4818e47c0abe69194cf5b2ad3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=sFYVsv%2B6UlM299EIXgHtazNh9%2BI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-33"><strong>附录：反模式检查清单</strong></h2>
<p>本表列出了在 Skill 开发中常见的反模式（Anti-Patterns），以及相应的原因、正确示例和错误示例。通过遵循这些规范，可以提升 Skill 的稳定性、可维护性和跨平台兼容性，避免模型误用或运行失败。</p>
<p>该 Checklist 可作为开发、评审和迭代 Skill 时的快速参考指南。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50126de01144477b68e1e339e618485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=%2B5t%2FNmIBG5pQxC%2FXhVVOD0SYUeg%3D" alt="" loading="lazy"/></p>
<p><strong>参考资料</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderA2UI 总体设计：AI 驱动的架构师友好界面]]></title>    <link>https://juejin.cn/post/7600706866785419307</link>    <guid>https://juejin.cn/post/7600706866785419307</guid>    <pubDate>2026-01-30T03:57:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600706866785419307" data-draft-id="7600710943250481194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderA2UI 总体设计：AI 驱动的架构师友好界面"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T03:57:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderA2UI 总体设计：AI 驱动的架构师友好界面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:57:00.000Z" title="Fri Jan 30 2026 03:57:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ooderA2UI 总体设计：AI 驱动的架构师友好界面</h2>
<h3 data-id="heading-1">前言：ooderAgent 发布衔接</h3>
<p>ooderAgent 的正式发布标志着 Ooder 生态系统进入智能开发时代。作为一个基于插件架构的技能系统，ooderAgent 通过实现 <code>Skill</code> 接口扩展 IDE 能力，支持本地和远程技能两种模式。这一发布为 ooderA2UI 的诞生奠定了坚实基础，提供了技能注册、发现、执行的完整框架。</p>
<p><strong>核心价值</strong>：ooderAgent 不仅是一个插件系统，更是一个分布式能力中心，通过 API Bridge 实现远程技能调用，为后续的 A2UI 交互提供了必要的技术支撑。</p>
<h2 data-id="heading-2">一、A2UI 与 ooderAI 背景</h2>
<h3 data-id="heading-3">1.1 A2UI 背景</h3>
<p>A2UI（Architect-to-UI）是一种面向架构师的智能界面设计理念，旨在通过 AI 辅助，将架构师的设计意图直接转换为高质量的用户界面。它解决了传统开发中架构设计与前端实现之间的鸿沟，实现了从架构到 UI 的直接映射。在企业级应用场景中，A2UI 进一步突破了技术与业务的壁垒，成为连接架构设计、产品需求与落地实现的核心枢纽，其价值在架构师与产品经理的协同工作中尤为凸显。</p>
<h3 data-id="heading-4">1.2 ooderAI 背景</h3>
<p>ooderAI 是 Ooder 生态系统的智能核心，基于大语言模型（LLM）构建，专注于代码生成、架构理解和开发流程优化。它通过三级 SKILLS 体系，实现从自然语言到完整系统的转换，为 A2UI 提供了强大的智能引擎。不同于普通 A2UI 技术，ooderA2UI 依托 ooderAI 的工程感知能力和 ooderAgent 的插件扩展能力，更适配企业级应用的规模化、标准化、高可用需求，既能满足架构师的技术架构诉求，也能契合产品经理的业务落地需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c11db4a66144889d8153c96f09a4de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=JRmzaHYmVBL8eKjvxShPzQtKvoo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">二、ooderA2UI 总体设计</h2>
<h3 data-id="heading-6">2.1 核心架构</h3>
<p>ooderA2UI 采用分层架构设计，将 UI 生成过程分为三个核心层次：</p>
<h4 data-id="heading-7">2.1.1 视图结构层</h4>
<ul>
<li><strong>Component 基础组件类</strong>：定义组件的基本属性和行为</li>
<li><strong>ComponentList 组件列表管理</strong>：管理组件集合</li>
<li><strong>自定义组件实现</strong>：提供特定类型的组件功能</li>
<li><strong>组件层次树构建</strong>：通过父子关系构建组件树</li>
</ul>
<h4 data-id="heading-8">2.1.2 ViewBean 层</h4>
<ul>
<li><strong>CustomViewBean 抽象基类</strong>：视图模型的根本数据对象</li>
<li><strong>1:1 前端 JSON 对应</strong>：与前端的"四分离JSON"存在严格的 1:1 对应关系</li>
<li><strong>Annotation 映射机制</strong>：通过注解实现与后端代码的映射</li>
<li><strong>领域模型驱动设计</strong>：采用领域驱动设计思想，将 UI 组件抽象为领域模型</li>
</ul>
<h4 data-id="heading-9">2.1.3 OnecCode 层</h4>
<ul>
<li><strong>注解驱动代码生成</strong>：基于注解生成代码</li>
<li><strong>前后端代码结构</strong>：生成前端代码和后端代码</li>
<li><strong>服务支撑框架</strong>：集成菜单导航、安全认证等系统功能</li>
<li><strong>部署配置管理</strong>：生成部署和运行配置</li>
</ul>
<h3 data-id="heading-10">2.2 LLM 三级 SKILLS 工作流程</h3>
<h4 data-id="heading-11">2.2.1 第一级：预缓存与自然语言处理</h4>
<ol>
<li>
<p><strong>CustomView 预设缓存</strong>： - 预先定义和缓存常用的 CustomView 模板 - 建立视图类型与实现的映射关系</p>
</li>
<li>
<p><strong>自然语言处理</strong>： - 分析用户输入的自然语言需求（兼顾架构师的技术规范和产品经理的业务描述） - 完成 module、page、customView 的划分 - 初步确定视图类型和结构，同步匹配业务需求与技术规范</p>
</li>
</ol>
<h4 data-id="heading-12">2.2.2 第二级：前端组装与代码生成</h4>
<ol>
<li>
<p><strong>customViewBean 转换</strong>： - 根据第一级分析结果生成 customViewBean (JSON 结构) - 构建符合领域模型的视图结构</p>
</li>
<li>
<p><strong>前端组件组装</strong>： - 基于 customViewBean 组装前端 components - 通过 RAD 工具提供可视化预览，方便产品经理确认业务交互合理性、架构师校验技术可行性 - 允许用户进行交互式调整，支持双视角协同修改</p>
</li>
<li>
<p><strong>代码组装</strong>： - LLM 根据调整后的结构生成代码 - 确保代码符合工程规范和用户偏好，兼顾企业级应用的可维护性和可扩展性</p>
</li>
</ol>
<h4 data-id="heading-13">2.2.3 第三级：系统级封装与用户确认</h4>
<ol>
<li>
<p><strong>系统级封装</strong>： - 集成菜单导航系统 - 实现安全认证机制 - 构建代码部署结构 - 完成系统级配置，适配企业级应用的规模化部署需求</p>
</li>
<li>
<p><strong>A2UI 交互确认</strong>： - 通过 A2UI 向用户展示生成结果，分别提供技术视角（架构师）和业务视角（产品经理）的确认维度 - 提供页面权限、交互流程、用户喜好等选项，兼顾技术合规与业务体验 - 用户确认后进行最终调整，实现双视角需求的统一落地</p>
</li>
</ol>
<h2 data-id="heading-14">三、技术实现要点</h2>
<h3 data-id="heading-15">3.1 组件系统设计</h3>
<p>ooderA2UI 的组件系统基于泛型设计，支持类型安全的组件创建和管理。核心实现包括：</p>
<ul>
<li><strong>Component&lt;T extends Properties, K extends EventKey&gt;</strong> ：基础组件类，支持属性和事件的类型安全管理</li>
<li><strong>组件生命周期</strong>：实现组件的创建、初始化、更新、销毁完整生命周期</li>
<li><strong>事件系统</strong>：基于类型的事件分发机制，支持组件间的通信</li>
<li><strong>序列化支持</strong>：与前端 JSON 结构的双向转换</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9795cf6375ad4d5c853fe09a4cc30df9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=vSbncafYDajlK3H0jADnHSQFBuY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">3.2 CustomViewBean 设计</h3>
<p>CustomViewBean 采用领域驱动设计思想，实现了与前端 JSON 的 1:1 对应：</p>
<ul>
<li><strong>层次化结构</strong>：通过继承体系支持多种视图类型</li>
<li><strong>注解映射</strong>：通过注解实现与后端代码的自动映射</li>
<li><strong>扩展性</strong>：支持自定义视图类型和属性</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e7b1af0a4d4451b81125c279751983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=ef9%2Fu%2BrypZKhYUPxh6lrhdKUQ%2B4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-17">3.3 LLM 集成策略</h3>
<p>ooderA2UI 的核心优势在于 LLM 的深度集成，尤其适配企业级双视角协同需求：</p>
<ul>
<li><strong>上下文管理</strong>：维护设计上下文，确保生成结果的一致性，同步兼容架构师的技术规范和产品经理的业务需求</li>
<li><strong>多模态交互</strong>：支持文本、图像等多种输入方式，适配产品经理的原型描述和架构师的技术文档</li>
<li><strong>反馈机制</strong>：基于双视角用户反馈不断优化生成结果，平衡技术可行性与业务合理性</li>
<li><strong>工程感知</strong>：分析当前工程环境，生成符合工程规范的代码，同时匹配企业级业务场景的落地需求，通过标准化数据映射替代传统代码生成，进一步提升架构一致性与可维护性</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af06559e38d0428ca194e200fee3f7b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=8TlroyO9HvxcyMaTc79Eo0nfnRA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">四、架构师价值</h2>
<h3 data-id="heading-19">4.1 效率提升</h3>
<p>ooderA2UI 为架构师提供了从设计到实现的直接路径，显著提升开发效率：</p>
<ul>
<li><strong>架构设计直接转换</strong>：减少中间环节，提高设计到实现的转化率</li>
<li><strong>智能代码生成</strong>：避免重复劳动，专注于核心设计</li>
<li><strong>系统级封装</strong>：自动处理通用功能，减少样板代码</li>
</ul>
<h3 data-id="heading-20">4.2 质量保证</h3>
<p>通过 AI 辅助和规范约束，确保生成代码的质量：</p>
<ul>
<li><strong>符合工程规范的代码结构</strong>：遵循最佳实践和编码标准</li>
<li><strong>一致的设计风格</strong>：确保 UI 的视觉一致性</li>
<li><strong>完整的系统集成</strong>：自动处理依赖和配置</li>
</ul>
<h3 data-id="heading-21">4.3 决策支持</h3>
<p>在关键决策点提供智能建议：</p>
<ul>
<li><strong>架构选择建议</strong>：基于项目需求推荐合适的架构模式</li>
<li><strong>技术栈匹配</strong>：根据工程环境选择合适的技术栈</li>
<li><strong>性能优化建议</strong>：识别潜在的性能瓶颈并提供优化方案</li>
</ul>
<h2 data-id="heading-22">五、从架构师与产品经理视角看 A2UI 企业级应用</h2>
<p>A2UI 技术在企业级应用中的核心价值，在于打破架构设计与产品落地之间的壁垒，实现技术可行性与业务合理性的双向兼顾。架构师与产品经理作为企业级应用落地的核心角色，对 A2UI 的需求、价值感知及落地诉求存在差异，但最终目标一致——构建高效、稳定、贴合业务的企业级系统。以下从双视角出发，结合 ooderA2UI 的特性，剖析其企业级应用的核心逻辑与价值体现。</p>
<h3 data-id="heading-23">5.1 架构师视角：以技术合规为核心，赋能企业级规模化落地</h3>
<p>架构师在企业级应用中的核心职责是搭建稳定、可扩展、可维护的技术架构，平衡业务需求与技术成本，确保系统符合企业技术规范、安全合规要求，同时适配规模化部署与长期迭代。ooderA2UI 作为 AI 驱动的架构友好型工具，其企业级应用价值主要体现在以下4个核心维度，同时规避传统开发中的技术痛点：</p>
<h4 data-id="heading-24">5.1.1 降低架构落地成本，提升规模化交付效率</h4>
<p>企业级应用往往具备模块多、层级杂、交互复杂的特点，传统开发模式中，架构师的设计意图需要通过文档传递给前端、后端开发人员，存在理解偏差、落地变形等问题，且重复开发工作量大，规模化交付效率低下。ooderA2UI 支持架构师直接将架构设计（如组件分层、接口规范、权限架构）通过自然语言或模板输入，AI 基于三级 SKILLS 体系自动生成符合架构规范的 UI 代码、后端接口映射及部署配置，实现“设计即落地”。</p>
<h4 data-id="heading-25">5.1.2 确保架构一致性，规避技术债务</h4>
<p>企业级应用的长期迭代中，最核心的技术痛点是“架构漂移”——随着业务迭代、人员变动，后续开发逐渐偏离初始架构规范，导致代码冗余、维护成本攀升、技术债务积累，甚至影响系统稳定性。ooderA2UI 基于架构师预设的技术规范（如组件命名规范、代码风格、接口适配标准、安全合规要求），通过工程感知能力自动校验生成代码的合规性，确保所有 UI 模块、组件交互、数据绑定均符合架构设计，从源头规避架构漂移。</p>
<p>同时，ooderA2UI 的 Component 泛型设计、CustomViewBean 注解映射机制，支持组件的插件式扩展与统一管理，架构师可通过动态注册机制扩展组件类型，无需修改核心架构，既满足业务迭代需求，又确保架构的长期一致性，为企业级应用的长期迭代奠定基础。</p>
<h4 data-id="heading-26">5.1.3 平衡灵活性与规范性，适配企业级复杂场景</h4>
<p>企业级应用往往存在“标准化与个性化并存”的需求——既有通用模块（如登录、导航、数据统计）需要标准化交付，也有行业专属模块需要个性化定制。架构师需要在确保规范的前提下，提供足够的灵活性以适配个性化需求，传统工具难以兼顾二者平衡。</p>
<p>ooderA2UI 采用“架构规范预设+个性化调整”的模式，架构师可预设企业级通用架构模板（如安全认证架构、组件分层架构），AI 基于模板生成标准化模块；同时支持架构师通过 RAD 工具可视化调整个性化模块的组件结构、接口映射，无需修改核心架构规范，既保证了标准化模块的高效交付，又满足了个性化业务场景的需求，实现灵活性与规范性的平衡。</p>
<h4 data-id="heading-27">5.1.4 简化跨团队协同成本，对齐技术与业务认知</h4>
<p>企业级应用的落地需要架构师、产品经理、开发人员、测试人员跨团队协同，传统协同中，架构师的技术设计与产品经理的业务需求往往存在认知偏差，需要反复沟通对齐，协同成本高。ooderA2UI 提供可视化预览功能，架构师生成的 UI 原型的同时，自动展示其技术实现逻辑（如组件层级、接口映射、性能瓶颈），产品经理可直观看到架构设计对应的业务落地效果，架构师也可通过产品经理的反馈，快速调整架构设计中的不合理之处，实现技术与业务的同频对齐。</p>
<p>此外，ooderA2UI 依托 ooderAgent 的分布式技能系统，支持架构师与开发团队共享技能模板、架构规范，确保跨团队开发人员均遵循统一的架构标准，进一步降低协同成本。</p>
<h3 data-id="heading-28">5.2 产品经理视角：以业务价值为核心，实现需求快速落地与验证</h3>
<p>产品经理在企业级应用中的核心职责是挖掘业务需求、定义产品价值，确保系统贴合业务场景、提升用户体验（内部员工或外部客户），同时快速响应业务迭代，验证需求可行性，降低产品试错成本。ooderA2UI 对产品经理的价值，核心是“打破技术壁垒，让产品需求直接落地”，无需依赖开发人员，即可快速将业务需求转化为可预览、可验证的 UI 原型，其企业级应用价值主要体现在以下4个核心维度：</p>
<h4 data-id="heading-29">5.2.1 缩短需求落地周期，快速响应业务迭代</h4>
<p>企业级应用的业务需求往往具备“迭代快、需求杂”的特点，传统模式中，产品经理需要编写详细的需求文档、原型图，传递给开发团队，开发团队再基于文档进行开发，整个流程周期长，难以快速响应业务突发需求。ooderA2UI 支持产品经理直接将业务需求通过自然语言输入，AI 自动生成符合业务需求的 UI 原型，同时实现基础的数据交互逻辑，产品经理可实时预览效果，无需等待开发人员开发。</p>
<h4 data-id="heading-30">5.2.2 降低需求验证成本，规避产品试错风险</h4>
<p>企业级应用的需求往往涉及多部门、多角色，需求的合理性、交互的便捷性直接影响产品价值，传统模式中，需求的验证需要等到开发完成后，通过测试、灰度发布才能进行，若需求不合理，修改成本极高，试错风险大。ooderA2UI 生成的 UI 原型不仅具备可视化效果，还支持基础的交互操作（如按钮点击、表单输入、数据筛选），产品经理可快速将原型分享给业务部门、终端用户，收集反馈意见，验证需求的合理性与交互的便捷性。</p>
<h4 data-id="heading-31">5.2.3 打破技术壁垒，实现需求精准落地</h4>
<p>产品经理往往不具备专业的开发知识，传统模式中，产品需求与技术落地之间存在“断层”——产品经理描述的需求，开发人员可能因技术限制无法实现，或理解偏差导致落地效果与需求不符，需要反复沟通调整，影响需求落地效率。ooderA2UI 支持产品经理直接通过业务语言描述需求，AI 自动将业务需求转化为符合技术规范的 UI 原型，同时结合架构师预设的技术规范，确保需求在技术上具备可行性，避免“需求无法落地”的问题。</p>
<p>同时，ooderA2UI 的可视化调整功能，产品经理可直接修改 UI 布局、交互流程，无需依赖开发人员，实现需求的精准落地。</p>
<h4 data-id="heading-32">5.2.4 聚焦核心业务价值，提升产品竞争力</h4>
<p>企业级应用的核心竞争力在于“贴合业务、提升效率”，产品经理的核心精力应放在挖掘业务需求、优化用户体验上，而非花费大量时间协调开发、跟进需求落地。ooderA2UI 帮助产品经理摆脱对开发人员的依赖，将繁琐的“需求落地、原型制作”工作交给 AI 完成，让产品经理能够聚焦核心业务价值，如优化业务流程、提升终端用户体验、挖掘新的业务增长点。</p>
<h3 data-id="heading-33">5.3 双视角协同：实现企业级应用的“技术+业务”双向共赢</h3>
<p>企业级应用的成功落地，离不开架构师与产品经理的协同配合——架构师确保系统的技术稳定性、可扩展性，产品经理确保系统的业务价值、用户体验，二者缺一不可。ooderA2UI 作为连接双视角的核心工具，实现了“技术规范与业务需求的双向对齐”，其协同价值主要体现在：</p>
<ol>
<li>
<p>需求对齐：产品经理生成的业务原型，可实时同步给架构师，架构师校验原型的技术可行性，若存在技术风险（如性能瓶颈、合规问题），可快速反馈并调整，避免需求落地后再修改；</p>
</li>
<li>
<p>高效协同：架构师预设的技术规范，AI 会自动应用到产品经理生成的原型中，确保原型符合技术标准，无需双方反复沟通对齐；</p>
</li>
<li>
<p>迭代同步：业务迭代过程中，产品经理修改需求原型，架构师可实时看到修改内容，同步调整技术架构适配，确保技术迭代与业务迭代同频，实现“需求修改-架构适配-原型更新”的快速闭环；</p>
</li>
<li>
<p>价值统一：最终落地的系统，既符合架构师的技术规范，确保稳定可扩展，又贴合产品经理的业务需求，实现业务价值最大化，打造“技术合规、业务高效、体验优秀”的企业级应用。</p>
</li>
</ol>
<h2 data-id="heading-34">六、技术挑战与解决方案</h2>
<h3 data-id="heading-35">6.1 架构挑战</h3>
<h4 data-id="heading-36">6.1.1 组件类型扩展</h4>
<p><strong>挑战</strong>：组件类型通过枚举定义，扩展需要修改枚举类</p>
<p><strong>解决方案</strong>：采用动态注册机制，支持组件类型的插件式扩展，避免枚举修改的局限性</p>
<h4 data-id="heading-37">6.1.2 生命周期管理</h4>
<p><strong>挑战</strong>：缺乏明确的组件生命周期定义和管理</p>
<p><strong>解决方案</strong>：实现完整的组件生命周期钩子，支持创建、初始化、更新、销毁各阶段的自定义逻辑</p>
<h4 data-id="heading-38">6.1.3 错误处理</h4>
<p><strong>挑战</strong>：组件操作失败时的错误反馈不够明确</p>
<p><strong>解决方案</strong>：建立统一的异常体系，提供详细的错误信息和恢复机制，确保系统稳定性</p>
<h3 data-id="heading-39">6.2 集成挑战</h3>
<h4 data-id="heading-40">6.2.1 前端框架集成</h4>
<p><strong>挑战</strong>：与现代前端框架的集成不够灵活</p>
<p><strong>解决方案</strong>：提供适配器机制，支持与现代前端框架的无缝集成，实现组件属性的自动映射</p>
<h4 data-id="heading-41">6.2.2 后端服务集成</h4>
<p><strong>挑战</strong>：与后端服务的集成需要手动处理</p>
<p><strong>解决方案</strong>：实现与后端服务的自动集成，完善数据绑定机制，提供与数据库的映射工具</p>
<h4 data-id="heading-42">6.2.3 工具链集成</h4>
<p><strong>挑战</strong>：与开发工具的集成有限</p>
<p><strong>解决方案</strong>：开发组件可视化编辑工具，实现与 IDE 的集成插件，提供组件调试和诊断能力</p>
<h2 data-id="heading-43">七、未来发展</h2>
<h3 data-id="heading-44">7.1 技术演进</h3>
<ul>
<li><strong>AI 能力增强</strong>：提升 LLM 对复杂架构的理解能力和复杂业务需求的解析能力，实现更智能的代码生成和优化，同时强化双视角需求的精准识别，适配企业级复杂场景；提升声明式UI的标准化与兼容性。</li>
<li><strong>云原生支持</strong>：增强对云原生架构的支持，提供容器化部署能力，适配企业级规模化部署、弹性扩展需求，同时支持多租户隔离，满足企业级权限管控要求。</li>
<li><strong>实时协作</strong>：支持架构师、产品经理、开发人员多人实时协作设计，实现架构设计、业务需求、代码开发的实时同步与版本控制，进一步降低跨团队协同成本。</li>
</ul>
<h3 data-id="heading-45">7.2 生态扩展</h3>
<ul>
<li><strong>行业解决方案</strong>：针对金融、电商、政务等特定行业，开发定制化的视图模板、组件库与业务规则，提供行业专属的智能生成解决方案，积累行业最佳实践，适配行业专属的技术规范与业务需求，强化跨场景协同能力。</li>
<li><strong>技能市场</strong>：基于 ooderAgent 的插件架构，搭建官方技能市场，支持第三方开发者发布自定义组件、ViewBean 模板、SKILL 技能，实现技能的发布、共享与交易，丰富生态内容，同时支持架构师、产品经理上传行业专属模板，提升企业级应用落地效率。</li>
<li><strong>低代码平台</strong>：逐步拓展为完整的低代码开发平台，强化可视化设计与智能生成能力，支持更复杂的业务场景，适配不同技术水平的使用者，让产品经理可直接通过低代码平台完成简单业务系统的落地，架构师可聚焦复杂架构的设计与管控，进一步释放双视角价值。</li>
</ul>
<h2 data-id="heading-46">结论</h2>
<p>ooderA2UI 代表了现代 IDE 向智能开发工具演进的重要方向，通过 AI 辅助实现了从架构设计到 UI 实现的直接映射。它不仅是一个技术工具，更是一种新的开发范式，为架构师、产品经理提供了前所未有的协同开发体验，尤其适配企业级应用的规模化、标准化、快速迭代需求，同时融合当前行业最佳实践，具备极强的企业级落地价值。</p>
<p>从企业级应用视角来看，ooderA2UI 的核心价值的是实现“技术与业务的双向共赢”：对架构师而言，它降低了架构落地成本、确保了架构一致性，让架构师能够聚焦核心技术决策，规避技术债务，适配企业级规模化迭代需求；对产品经理而言，它打破了技术壁垒、缩短了需求落地周期，让产品经理能够聚焦核心业务价值，快速验证需求，提升产品竞争力。二者协同配合，依托 ooderAgent 的技能系统和 ooderAI 的智能能力，ooderA2UI 构建了一个完整的从需求到实现的闭环，显著提升了企业级应用的开发效率和产品质量。</p>
<p>这一技术的发展，标志着软件开发正在进入一个新的时代：架构驱动、AI 辅助、高效实现、双视角协同，为企业级应用的数字化转型注入了强大动力，助力企业构建更具竞争力的数字化系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NestJS 鉴权系统实战：从单Token到双Token架构的完整实现]]></title>    <link>https://juejin.cn/post/7600588379106263092</link>    <guid>https://juejin.cn/post/7600588379106263092</guid>    <pubDate>2026-01-29T15:27:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600588379106263092" data-draft-id="7600588379106246708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NestJS 鉴权系统实战：从单Token到双Token架构的完整实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T15:27:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NestJS 鉴权系统实战：从单Token到双Token架构的完整实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T15:27:27.000Z" title="Thu Jan 29 2026 15:27:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代Web应用开发中，身份验证和授权是构建安全系统的基石。随着网络安全威胁日益增多，传统的单一Token机制已无法满足高安全性的需求。本文将详细介绍如何在NestJS框架中实现一个健壮的双Token鉴权系统，并分享我在开发过程中遇到的真实Bug调试经验。</p>
<h2 data-id="heading-1">1. JWT协议基础</h2>
<h3 data-id="heading-2">什么是JWT？</h3>
<p>JWT（JSON Web Token）是一种开放标准（RFC 7519），定义了一种紧凑且自包含的方式，用于在各方之间安全地传输信息作为JSON对象。这种信息可以通过数字签名进行验证和信任。</p>
<p>JWT通常由三部分组成：</p>
<ul>
<li><strong>Header</strong>: 包含令牌类型和签名算法</li>
<li><strong>Payload</strong>: 包含声明（claims）</li>
<li><strong>Signature</strong>: 用于验证消息完整性</li>
</ul>
<h3 data-id="heading-3">NestJS中的JWT实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 安装必要的包</span>
npm install <span class="hljs-meta">@nestjs</span>/jwt <span class="hljs-meta">@nestjs</span>/passport passport passport-jwt

<span class="hljs-comment">// JWT服务配置</span>
<span class="hljs-meta">@Module({
  imports: [
    JwtModule.register({
      secret: process.env.JWT_SECRET,
      signOptions: { expiresIn: <span class="hljs-string">'15m'</span> }, // 15分钟过期
    }),
  ],
  providers: [JwtService],
})</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthModule</span> {}
</code></pre>
<h2 data-id="heading-4">2. 从单Token到双Token架构</h2>
<h3 data-id="heading-5">为什么要使用双Token机制？</h3>
<p>传统的单Token架构存在以下安全风险：</p>
<ul>
<li><strong>Token劫持风险</strong>：一旦Token被中间人捕获，攻击者可以在整个有效期内进行恶意操作</li>
<li><strong>长时间暴露</strong>：如果Token有效期设置较长，安全风险相应增加</li>
<li><strong>无法灵活控制</strong>：难以实现细粒度的权限管理</li>
</ul>
<h3 data-id="heading-6">双Token设计模式</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Token配置</span>
<span class="hljs-keyword">const</span> ACCESS_TOKEN_EXPIRES_IN = <span class="hljs-string">'15m'</span>;  <span class="hljs-comment">// 15分钟</span>
<span class="hljs-keyword">const</span> REFRESH_TOKEN_EXPIRES_IN = <span class="hljs-string">'7d'</span>;  <span class="hljs-comment">// 7天</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title">TokenPair</span> {
  accessToken: <span class="hljs-built_in">string</span>;
  refreshToken: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><strong>Access Token</strong>（短期Token）：</p>
<ul>
<li>有效期短（如15分钟）</li>
<li>用于日常API请求的身份验证</li>
<li>即使被劫持，影响范围有限</li>
</ul>
<p><strong>Refresh Token</strong>（长期Token）：</p>
<ul>
<li>有效期长（如7天）</li>
<li>仅用于刷新Access Token</li>
<li>存储在安全位置（如HttpOnly Cookie）</li>
</ul>
<h2 data-id="heading-7">3. 实战：双Token生成与验证</h2>
<h3 data-id="heading-8">3.1 Token生成服务</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> jwtService: JwtService,
    <span class="hljs-keyword">private</span> userService: UserService,
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-attr">credentials</span>: <span class="hljs-title class_">LoginDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TokenPair</span>&gt; {
    <span class="hljs-comment">// 验证用户凭据</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateUser</span>(credentials);
    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Invalid credentials'</span>);
    }

    <span class="hljs-comment">// 生成Token对</span>
    <span class="hljs-keyword">const</span> payload = { 
      <span class="hljs-attr">sub</span>: user.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>(), 
      <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span> 
    };

    <span class="hljs-keyword">const</span> [accessToken, refreshToken] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>(payload, { 
        <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">ACCESS_TOKEN_EXPIRES_IN</span> 
      }),
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>({
        ...payload,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>
      }, { 
        <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">REFRESH_TOKEN_EXPIRES_IN</span> 
      })
    ]);

    <span class="hljs-comment">// 存储Refresh Token（可选：存入数据库）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">storeRefreshToken</span>(user.<span class="hljs-property">id</span>, refreshToken);

    <span class="hljs-keyword">return</span> {
      accessToken,
      refreshToken
    };
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshTokens</span>(<span class="hljs-attr">refreshToken</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TokenPair</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 验证Refresh Token</span>
      <span class="hljs-keyword">const</span> payload = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">verifyAsync</span>(refreshToken, {
        <span class="hljs-attr">secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span>
      });

      <span class="hljs-comment">// 验证Token类型</span>
      <span class="hljs-keyword">if</span> (payload.<span class="hljs-property">type</span> !== <span class="hljs-string">'refresh'</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Invalid token type'</span>);
      }

      <span class="hljs-comment">// 检查Token是否在数据库中存在（防重放攻击）</span>
      <span class="hljs-keyword">const</span> isValid = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateStoredRefreshToken</span>(payload.<span class="hljs-property">sub</span>, refreshToken);
      <span class="hljs-keyword">if</span> (!isValid) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Token not found or invalid'</span>);
      }

      <span class="hljs-comment">// 生成新的Token对</span>
      <span class="hljs-keyword">const</span> newPayload = { 
        <span class="hljs-attr">sub</span>: payload.<span class="hljs-property">sub</span>, 
        <span class="hljs-attr">name</span>: payload.<span class="hljs-property">name</span> 
      };

      <span class="hljs-keyword">const</span> [newAccessToken, newRefreshToken] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>(newPayload, { 
          <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">ACCESS_TOKEN_EXPIRES_IN</span> 
        }),
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>({
          ...newPayload,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>
        }, { 
          <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">REFRESH_TOKEN_EXPIRES_IN</span> 
        })
      ]);

      <span class="hljs-comment">// 更新存储的Refresh Token</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateRefreshToken</span>(payload.<span class="hljs-property">sub</span>, refreshToken, newRefreshToken);

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">accessToken</span>: newAccessToken,
        <span class="hljs-attr">refreshToken</span>: newRefreshToken
      };

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Could not refresh token'</span>);
    }
  }
}
</code></pre>
<h3 data-id="heading-9">3.2 JWT策略配置</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PassportStrategy</span>(<span class="hljs-params"><span class="hljs-type">Strategy</span></span>) </span>{
  constructor(<span class="hljs-keyword">private</span> configService: <span class="hljs-type">ConfigService</span>) {
    <span class="hljs-keyword">super</span>({
      jwtFromRequest: <span class="hljs-type">ExtractJwt</span>.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: <span class="hljs-literal">false</span>,
      secretOrKey: configService.get&lt;string&gt;('<span class="hljs-type">JWT_SECRET</span>'),
    });
  }

  async validate(payload: any) {
    <span class="hljs-comment">// 验证Token类型（确保是Access Token而非Refresh Token）</span>
    <span class="hljs-keyword">if</span> (payload.<span class="hljs-keyword">type</span> === 'refresh') {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">UnauthorizedException</span>('<span class="hljs-type">Invalid</span> token <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">for</span> <span class="hljs-title">access</span>')</span>;
    }

    <span class="hljs-keyword">return</span> { 
      userId: parseInt(payload.sub), 
      username: payload.name 
    };
  }
}
</code></pre>
<h2 data-id="heading-10">4. Guard机制：路由保护的守护者</h2>
<h3 data-id="heading-11">4.1 UseGuards装饰器</h3>
<p><code>UseGuards</code>是NestJS提供的装饰器，用于在控制器或路由处理方法上应用守卫。它会在路由处理方法执行前先执行Guard函数。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Controller</span>(<span class="hljs-string">'posts'</span>)
export class PostsController {
  <span class="hljs-selector-tag">constructor</span>(private <span class="hljs-attribute">postsService</span>: PostsService) {}

  <span class="hljs-variable">@UseGuards</span>(JwtAuthGuard) <span class="hljs-comment">// 应用JWT守卫</span>
  <span class="hljs-variable">@Post</span>()
  async <span class="hljs-built_in">createPost</span>(<span class="hljs-variable">@Body</span>() <span class="hljs-attribute">createPostDto</span>: CreatePostDto, <span class="hljs-variable">@Req</span>() req) {
    <span class="hljs-comment">// 只有通过验证的用户才能创建帖子</span>
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.postsService</span><span class="hljs-selector-class">.createPost</span>(createPostDto, req.user.userId);
  }

  @<span class="hljs-selector-tag">UseGuards</span>(JwtAuthGuard)
  @<span class="hljs-selector-tag">Get</span>()
  <span class="hljs-selector-tag">async</span> <span class="hljs-selector-tag">getPosts</span>(<span class="hljs-variable">@Req</span>() req) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.postsService</span><span class="hljs-selector-class">.getUserPosts</span>(req.user.userId);
  }
}
</code></pre>
<h3 data-id="heading-12">4.2 自定义JWT守卫</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtAuthGuard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthGuard</span>(<span class="hljs-params">'jwt'</span>) </span>{
  canActivate(context: <span class="hljs-type">ExecutionContext</span>) {
    <span class="hljs-comment">// 调用父类的canActivate方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.canActivate(context);
  }

  handleRequest(err, user, info) {
    <span class="hljs-comment">// 处理验证结果</span>
    <span class="hljs-keyword">if</span> (err || !user) {
      <span class="hljs-keyword">throw</span> err || <span class="hljs-keyword">new</span> <span class="hljs-type">UnauthorizedException</span>('<span class="hljs-type">Authentication</span> failed');
    }
    <span class="hljs-keyword">return</span> user;
  }
}
</code></pre>
<h2 data-id="heading-13">5. 客户端集成：Axios请求拦截器</h2>
<h3 data-id="heading-14">5.1 请求拦截器</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// axios配置</span>
<span class="hljs-keyword">const</span> apiClient = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://localhost:3000/api'</span>,
});

<span class="hljs-comment">// 请求拦截器：自动添加Access Token</span>
apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>);
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-comment">// 响应拦截器：处理Token过期</span>
apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response,
  <span class="hljs-keyword">async</span> (error) =&gt; {
    <span class="hljs-keyword">const</span> originalRequest = error.<span class="hljs-property">config</span>;

    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; !originalRequest.<span class="hljs-property">_retry</span>) {
      originalRequest.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 使用Refresh Token刷新Access Token</span>
        <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'refreshToken'</span>);
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth/refresh'</span>, {
          refreshToken
        });

        <span class="hljs-keyword">const</span> { accessToken } = response.<span class="hljs-property">data</span>;
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'accessToken'</span>, accessToken);

        <span class="hljs-comment">// 重新发起原请求</span>
        originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">apiClient</span>(originalRequest);
      } <span class="hljs-keyword">catch</span> (refreshError) {
        <span class="hljs-comment">// 刷新失败，跳转到登录页</span>
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'accessToken'</span>);
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'refreshToken'</span>);
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(refreshError);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);
</code></pre>
<h2 data-id="heading-15">6. 错误处理：优雅的异常响应</h2>
<h3 data-id="heading-16">6.1 NestJS内置异常类</h3>
<p>NestJS提供了丰富的HTTP异常类，用于处理不同类型的错误：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 常见的HTTP异常</span>
BadRequestException    <span class="hljs-comment">// 400 - 请求参数错误</span>
UnauthorizedException  <span class="hljs-comment">// 401 - 未授权</span>
ForbiddenException     <span class="hljs-comment">// 403 - 禁止访问  </span>
NotFoundException      <span class="hljs-comment">// 404 - 资源不存在</span>
InternalServerErrorException <span class="hljs-comment">// 500 - 服务器内部错误</span>
</code></pre>
<h3 data-id="heading-17">6.2 全局异常过滤器</h3>
<pre><code class="hljs language-ini" lang="ini">@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const <span class="hljs-attr">ctx</span> = host.switchToHttp()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">response</span> = ctx.getResponse()<span class="hljs-comment">;</span>
    
    let status, message<span class="hljs-comment">;</span>
    
    if (exception instanceof HttpException) {
      <span class="hljs-attr">status</span> = exception.getStatus()<span class="hljs-comment">;</span>
      <span class="hljs-attr">message</span> = exception.getResponse()<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">status</span> = <span class="hljs-number">500</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">message</span> = {
        statusCode: 500,
        message: 'Internal server error',
        timestamp: new Date().toISOString(),
      }<span class="hljs-comment">;</span>
    }

    response.status(status).json(message)<span class="hljs-comment">;</span>
  }
}

// 在main.ts中注册
async function bootstrap() {
  const <span class="hljs-attr">app</span> = await NestFactory.create(AppModule)<span class="hljs-comment">;</span>
  app.useGlobalFilters(new AllExceptionsFilter())<span class="hljs-comment">;</span>
  await app.listen(3000)<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-18">7. 实战Bug调试：我的真实经历</h2>
<h3 data-id="heading-19">7.1 字段命名不一致导致的500错误</h3>
<p>在我开发过程中，遇到了一个典型的Bug：用户存在但创建帖子时返回500错误。</p>
<p><strong>错误日志</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">Null</span> <span class="hljs-keyword">constraint</span> violation <span class="hljs-keyword">on</span> the fields: (<span class="hljs-string">'userId'</span>)
</code></pre>
<p><strong>问题分析</strong>：</p>
<ol>
<li>JWT Payload: <code>{ sub: '30', name: 'admin', ... }</code> ✓</li>
<li>User object: <code>{ id: 30, name: 'admin' }</code> ✓</li>
<li>但 <code>req.user.userId</code> 是 <code>undefined</code></li>
</ol>
<p><strong>根本原因</strong>：<br/>
JWT策略返回的字段名与Controller期望的不匹配</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误的字段名</span>
<span class="hljs-keyword">return</span> { id: payload.sub, name: payload.name };

<span class="hljs-comment">// ✅ 正确的字段名</span>
<span class="hljs-keyword">return</span> { userId: parseInt(payload.sub), username: payload.name };
</code></pre>
<p><strong>调试过程</strong>：</p>
<ol>
<li>添加详细的日志输出</li>
<li>检查JWT Token的有效性</li>
<li>验证字段命名的一致性</li>
<li>确认数据流向的每个环节</li>
</ol>
<h3 data-id="heading-20">7.2 Token验证失败的排查</h3>
<p><strong>错误信息</strong>：<code>Unknown authentication strategy "jwt"</code></p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>确保正确导入 <code>@nestjs/passport</code></li>
<li>检查JWT策略是否正确注册</li>
<li>验证Passport模块的配置</li>
</ol>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// app.module.ts</span>
<span class="hljs-variable">@Module</span>({
  <span class="hljs-attribute">imports</span>: [
    PassportModule,
    JwtModule.<span class="hljs-built_in">register</span>({
      <span class="hljs-attribute">secret</span>: process.env.JWT_SECRET,
    }),
  ],
  <span class="hljs-attribute">providers</span>: [
    AuthService,
    JwtStrategy, <span class="hljs-comment">// 确保注册策略</span>
  ],
})
export class AppModule {}
</code></pre>
<h2 data-id="heading-21">8. 性能优化：Promise.all的实际应用</h2>
<p>在实际项目中，经常需要并发执行多个异步操作。例如，在获取文章列表时同时获取总数：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Controller</span>(<span class="hljs-string">'posts'</span>)
export class PostsController {
  <span class="hljs-variable">@UseGuards</span>(JwtAuthGuard)
  <span class="hljs-variable">@Get</span>()
  async <span class="hljs-built_in">getPosts</span>(
    <span class="hljs-variable">@Query</span>(<span class="hljs-string">'page'</span>) page = <span class="hljs-number">1</span>,
    <span class="hljs-variable">@Query</span>(<span class="hljs-string">'limit'</span>) limit = <span class="hljs-number">10</span>,
    <span class="hljs-variable">@Req</span>() req
  ) {
    <span class="hljs-comment">// 使用Promise.all并行执行，提高性能</span>
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-attr">[posts, totalCount]</span> = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">Promise</span><span class="hljs-selector-class">.all</span>([
      this.postsService.<span class="hljs-built_in">findMany</span>({
        <span class="hljs-attribute">where</span>: { <span class="hljs-attribute">userId</span>: req.user.userId },
        <span class="hljs-attribute">skip</span>: (page - <span class="hljs-number">1</span>) * limit,
        <span class="hljs-attribute">take</span>: limit,
      }),
      this.postsService.<span class="hljs-built_in">count</span>({ <span class="hljs-attribute">where</span>: { <span class="hljs-attribute">userId</span>: req.user.userId } })
    ]);

    <span class="hljs-selector-tag">return</span> {
      data: posts,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total: totalCount,
        pages: Math.ceil(totalCount / limit)
      }
    };
  }
}
</code></pre>
<h2 data-id="heading-22">9. 安全最佳实践</h2>
<h3 data-id="heading-23">9.1 Token存储安全</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 设置安全的Cookie选项</span>
res.<span class="hljs-built_in">cookie</span>(<span class="hljs-string">'refreshToken'</span>, refreshToken, {
  httpOnly: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 防止XSS攻击</span>
  secure: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// HTTPS only</span>
  sameSite: <span class="hljs-string">'strict'</span>,<span class="hljs-comment">// CSRF protection</span>
  maxAge: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 7天</span>
});
</code></pre>
<h3 data-id="heading-24">9.2 防重放攻击</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 验证Token是否已被使用</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">validateStoredRefreshToken</span>(<span class="hljs-attr">userId</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-keyword">const</span> storedToken = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">refreshToken</span>.<span class="hljs-title function_">findFirst</span>({
    <span class="hljs-attr">where</span>: {
      userId,
      token,
      <span class="hljs-attr">expiresAt</span>: { <span class="hljs-attr">gt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() },
      <span class="hljs-attr">used</span>: <span class="hljs-literal">false</span>
    }
  });
  
  <span class="hljs-keyword">return</span> !!storedToken;
}
</code></pre>
<h2 data-id="heading-25">10. 总结</h2>
<p>通过本文的详细阐述，我们深入了解了NestJS中双Token鉴权系统的完整实现：</p>
<ol>
<li><strong>架构设计</strong>：双Token机制提供了更好的安全性</li>
<li><strong>技术实现</strong>：从Token生成到验证的完整流程</li>
<li><strong>错误处理</strong>：优雅的异常响应和调试技巧</li>
<li><strong>性能优化</strong>：合理使用并发提升用户体验</li>
<li><strong>安全实践</strong>：多种安全措施保障系统安全</li>
</ol>
<p>在实际开发中，安全性和用户体验往往需要平衡考虑。双Token机制虽然增加了系统复杂度，但显著提升了安全性。通过合理的架构设计和完善的错误处理，我们可以构建既安全又高效的Web应用。</p>
<p>记住，安全是一个持续的过程，需要不断地学习、实践和完善。希望这篇文章能为你的鉴权系统开发提供有价值的参考。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 作用域与提升（学习笔记）]]></title>    <link>https://juejin.cn/post/7600622206268817418</link>    <guid>https://juejin.cn/post/7600622206268817418</guid>    <pubDate>2026-01-29T14:32:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206268817418" data-draft-id="7600628279215570970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 作用域与提升（学习笔记）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-29T14:32:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 作用域与提升（学习笔记）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T14:32:13.000Z" title="Thu Jan 29 2026 14:32:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 作用域与提升：从函数作用域到块级作用域的演进</h2>
<p>在 JavaScript 的世界中，<strong>作用域（Scope）</strong> 和 <strong>提升（Hoisting）</strong> 是理解变量生命周期、函数行为以及内存管理的核心基础。本文将系统梳理 JavaScript 中的作用域机制（包括函数作用域与块级作用域）、变量/函数提升规则，并结合典型示例与最佳实践，帮助开发者写出更安全、可维护的代码。</p>
<hr/>
<h3 data-id="heading-1">一、提升（Hoisting）：JavaScript 的“编译阶段”行为</h3>
<p>JavaScript 引擎在执行代码前会经历一个<strong>编译阶段</strong>，用于收集变量和函数声明。这一过程导致了“提升”现象——<strong>声明被移动到其所在作用域的顶部</strong>，但赋值操作保留在原地。</p>
<h4 data-id="heading-2">1. 变量提升（<code>var</code>）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// undefined（不是报错！）</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;
</code></pre>
<p>等价于：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> a;           <span class="hljs-comment">// 声明被提升</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);  <span class="hljs-comment">// undefined</span>
a = <span class="hljs-number">1</span>;           <span class="hljs-comment">// 赋值未提升</span>
</code></pre>
<ul>
<li><code>var</code> 声明会被提升到<strong>当前函数作用域</strong>顶部。</li>
<li>提升后变量初始化为 <code>undefined</code>，因此提前访问不会报错，但值不可用。</li>
</ul>
<h4 data-id="heading-3">2. 函数提升（Function Declaration）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// "Hello!" —— 可直接调用！</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello!"</span>);
}
</code></pre>
<ul>
<li><strong>函数声明（<code>function foo() {}</code>）会被完整提升（包括函数体）到当前函数作用域顶部</strong>。</li>
<li>这使得函数可以在声明前被调用。</li>
</ul>
<h4 data-id="heading-4">3. <code>let</code> / <code>const</code> 与暂时性死区（TDZ）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// ReferenceError: Cannot access 'b' before initialization</span>
<span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>;
</code></pre>
<ul>
<li><code>let</code> 和 <code>const</code> 也会被“提升”，但在声明前处于 <strong>暂时性死区（Temporal Dead Zone, TDZ）</strong>。</li>
<li>在 TDZ 中访问变量会抛出 <code>ReferenceError</code>，强制开发者“先声明后使用”。</li>
</ul>
<blockquote>
<p>✅ <strong>关键总结</strong>：</p>
<ul>
<li><strong>函数作用域是第一作用域</strong>：提升只发生在当前函数作用域内，不会跨作用域。</li>
<li><code>var</code> 提升 → 值为 <code>undefined</code></li>
<li>函数声明提升 → 完整函数体可用</li>
<li><code>let</code>/<code>const</code> 提升 → TDZ，禁止提前访问</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-5">二、函数作用域：JavaScript 的传统作用域模型</h3>
<p>在 ES6 之前，JavaScript <strong>只有函数作用域</strong>。这意味着：</p>
<blockquote>
<p><strong>每声明一个函数，就自动创建一层新的作用域；其他结构（如 <code>if</code>、<code>for</code>）不会创建作用域。</strong></p>
</blockquote>
<h4 data-id="heading-6">示例解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a</span>) {
    <span class="hljs-keyword">var</span> b = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">var</span> c = <span class="hljs-number">2</span>;
    }
}
</code></pre>
<ul>
<li><code>foo</code> 创建了一个函数作用域，包含参数 <code>a</code> 和变量 <code>b</code>。</li>
<li><code>bar</code> 在 <code>foo</code> 内部声明，<strong>自身又创建了一个新的函数作用域</strong>，包含 <code>c</code>。</li>
<li><code>a</code>、<code>b</code>、<code>c</code> 均<strong>不能在全局作用域中访问</strong>，实现了封装。</li>
</ul>
<h4 data-id="heading-7">易错点提醒</h4>
<ul>
<li><code>var b</code> 的提升仅限于 <code>foo</code> 作用域顶部，不会影响全局。</li>
<li><code>bar</code> 的函数提升也仅限于 <code>foo</code> 作用域顶部，外部无法调用。</li>
</ul>
<hr/>
<h3 data-id="heading-8">三、隐藏内部实现：利用函数作用域实现私有化</h3>
<p>函数作用域的自包含特性，使其成为<strong>隐藏内部实现</strong>的理想工具，符合 <strong>最小特权原则</strong>（Least Privilege Principle）：</p>
<blockquote>
<p><strong>一个程序、用户或组件，只应拥有完成任务所必需的最小权限。</strong></p>
</blockquote>
<h4 data-id="heading-9">避免命名冲突</h4>
<p>当多个脚本或第三方库共存时，全局变量极易冲突：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 库 A</span>
<span class="hljs-keyword">var</span> config = { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.a.com"</span> };

<span class="hljs-comment">// 库 B</span>
<span class="hljs-keyword">var</span> config = { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.b.com"</span> }; <span class="hljs-comment">// 覆盖了 A！</span>
</code></pre>
<h5 data-id="heading-10">解决方案 1：全局命名空间</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 库 A</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">LibA</span> = {
    <span class="hljs-attr">config</span>: { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.a.com"</span> },
    <span class="hljs-attr">init</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
};

<span class="hljs-comment">// 库 B</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">LibB</span> = {
    <span class="hljs-attr">config</span>: { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.b.com"</span> },
    <span class="hljs-attr">start</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
};
</code></pre>
<p>→ 所有功能打包为对象属性，避免污染全局。</p>
<h5 data-id="heading-11">解决方案 2：模块管理（现代方案）</h5>
<p>使用 ES6 模块或 CommonJS，通过 <code>import</code>/<code>require</code> 显式导入依赖，天然隔离作用域。</p>
<hr/>
<h3 data-id="heading-12">四、函数表达式 vs 函数声明：私有化的演进</h3>
<p>虽然函数声明能创建作用域，但它本身会<strong>污染所在作用域</strong>（函数名可见）。而<strong>函数表达式</strong>提供了更灵活的私有化方式。</p>
<h4 data-id="heading-13">函数表达式的优点</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 匿名函数表达式作为 IIFE</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> privateVar = <span class="hljs-string">"secret"</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">privateFn</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-comment">// 外部无法访问 privateVar 或 privateFn</span>
})();
</code></pre>
<ul>
<li>不创建额外的函数名标识符。</li>
<li>可立即执行，无需显式调用。</li>
</ul>
<h4 data-id="heading-14">函数表达式的弊端与解决</h4>





















<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>栈追踪无意义函数名</td><td>使用<strong>具名函数表达式</strong>：<code>const f = function meaningfulName() {}</code></td></tr><tr><td>无法递归引用自身</td><td>具名后可在内部调用 <code>meaningfulName()</code></td></tr><tr><td>可读性差</td><td>避免过度使用匿名函数；复杂逻辑提取为命名函数</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>行内函数表达式</strong>：强调“定义和使用在同一处”，常用于回调、事件处理等场景。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">五、立即执行函数表达式（IIFE）：作用域隔离的经典模式</h3>
<p>IIFE（Immediately Invoked Function Expression）是利用函数表达式实现<strong>一次性私有作用域</strong>的典范。</p>
<h4 data-id="heading-16">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 私有作用域</span>
})();
</code></pre>
<ul>
<li>第一个 <code>()</code>：将函数声明转为<strong>函数表达式</strong>。</li>
<li>第二个 <code>()</code>：<strong>立即调用</strong>该函数。</li>
</ul>
<h4 data-id="heading-17">箭头函数版 IIFE（ES6+）</h4>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, "</span> + name);
})(<span class="hljs-string">"Alice"</span>);
</code></pre>
<ul>
<li>同样创建私有作用域。</li>
<li>更简洁，但注意箭头函数无 <code>this</code> 和 <code>arguments</code>。</li>
</ul>
<h4 data-id="heading-18">IIFE 的用途</h4>
<ol>
<li><strong>避免全局污染</strong></li>
<li><strong>模拟私有变量</strong>（在无模块系统时）</li>
<li><strong>一次性初始化逻辑</strong></li>
</ol>
<blockquote>
<p>✅ <strong>最佳实践</strong>：即使在 ES6 模块时代，IIFE 在书签脚本、广告代码等单文件场景中仍非常实用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-19">六、块级作用域：ES6 的革命性改进</h3>
<p>ES6 引入 <code>let</code> 和 <code>const</code>，带来了真正的<strong>块级作用域（Block Scope）</strong>：</p>
<blockquote>
<p><strong>任何由 <code>{}</code> 包裹的代码块（如 <code>if</code>、<code>for</code>、<code>{}</code>）都能形成独立作用域。</strong></p>
</blockquote>
<h4 data-id="heading-20">经典问题：循环中的闭包</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// var 的问题</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 3,3,3</span>
}

<span class="hljs-comment">// let 的解决方案</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 0,1,2</span>
}
</code></pre>
<ul>
<li><code>let</code> 为每次循环迭代<strong>创建新的块级作用域</strong>，每个回调捕获自己的 <code>i</code>。</li>
</ul>
<h4 data-id="heading-21">块级作用域的其他形式</h4>
<ul>
<li><code>try...catch</code> 中的 <code>catch</code> 块</li>
<li><code>with</code> 语句（不推荐使用）</li>
<li>任意 <code>{}</code> 代码块</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-keyword">let</span> x = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> y = <span class="hljs-number">2</span>;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// ReferenceError</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">七、垃圾收集与作用域</h3>
<p>JavaScript 的<strong>垃圾收集（Garbage Collection）</strong> 机制依赖<strong>可达性（Reachability）</strong> 判断对象是否可回收。</p>
<h4 data-id="heading-23">块级作用域助力内存管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"/>) {
    {
        <span class="hljs-keyword">let</span> bigData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>);
        <span class="hljs-comment">// 处理数据...</span>
    } <span class="hljs-comment">// bigData 超出块作用域 → 可被 GC 回收</span>
    <span class="hljs-comment">// 其他逻辑...</span>
}
</code></pre>
<ul>
<li>引擎能更早识别 <code>bigData</code> 不再需要，及时释放内存。</li>
<li>相比 <code>var</code>（函数作用域），<code>let</code>/<code>const</code> 让内存生命周期更精确。</li>
</ul>
<blockquote>
<p>⚠️ <strong>注意</strong>：闭包会阻止外部变量被回收。合理使用块作用域可减少不必要的闭包引用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">八、<code>var</code> vs <code>let</code> vs <code>const</code>：作用域与提升对比</h3>









































<table><thead><tr><th>特性</th><th><code>var</code></th><th><code>let</code></th><th><code>const</code></th></tr></thead><tbody><tr><td><strong>作用域</strong></td><td>函数作用域</td><td>块级作用域</td><td>块级作用域</td></tr><tr><td><strong>提升</strong></td><td>是（初始化为 <code>undefined</code>）</td><td>是（TDZ）</td><td>是（TDZ）</td></tr><tr><td><strong>重复声明</strong></td><td>允许</td><td>禁止</td><td>禁止</td></tr><tr><td><strong>重新赋值</strong></td><td>允许</td><td>允许</td><td>禁止（绑定不可变）</td></tr><tr><td><strong>全局属性</strong></td><td>是（如 <code>window.a</code>）</td><td>否</td><td>否</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>现代开发建议</strong>：</p>
<ul>
<li>默认使用 <code>const</code></li>
<li>需要重赋值时用 <code>let</code></li>
<li>彻底避免 <code>var</code></li>
</ul>
</blockquote>
<h3 data-id="heading-25">详见：文章：<a href="https://juejin.cn/post/7598127455133220864" target="_blank" title="https://juejin.cn/post/7598127455133220864">juejin.cn/post/759812…</a></h3>
<h3 data-id="heading-26">九、结语：从混乱到规范</h3>
<p>从 <code>var</code> 的函数作用域到 <code>let</code>/<code>const</code> 的块级作用域，JavaScript 完成了作用域模型的一次重要进化。这一变化不仅修复了历史遗留问题（如变量泄漏、循环闭包陷阱），更推动了开发者编写更安全、可预测的代码。</p>
<p><strong>记住口诀</strong>：</p>
<blockquote>
<p><code>const</code> 优先，不变就用它；<br/>
需要重赋值，<code>let</code> 来保驾；<br/>
<code>var</code> 已过时，坚决不使用；<br/>
作用域清晰，bug 远离我！</p>
</blockquote>
<p>掌握这些原理，你不仅能写出正确的代码，更能深入理解 JavaScript 的执行机制，为学习闭包、异步、模块化等高级主题打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【React-4/Lesson79(2025-12-22)】React 组件化开发详解：Greeting、Card、Modal 的完整实践🧩]]></title>    <link>https://juejin.cn/post/7600663744192823332</link>    <guid>https://juejin.cn/post/7600663744192823332</guid>    <pubDate>2026-01-29T15:30:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600663744192823332" data-draft-id="7600606150733004843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【React-4/Lesson79(2025-12-22)】React 组件化开发详解：Greeting、Card、Modal 的完整实践🧩"/> <meta itemprop="keywords" content="React.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2026-01-29T15:30:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【React-4/Lesson79(2025-12-22)】React 组件化开发详解：Greeting、Card、Modal 的完整实践🧩
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T15:30:12.000Z" title="Thu Jan 29 2026 15:30:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🧩在现代前端工程中，React 以其声明式、组件化的思想成为构建用户界面的主流框架之一。本文将深入剖析一个典型 React 项目中的核心组件设计与实现，涵盖 <strong>Greeting</strong>、<strong>Card</strong> 和 <strong>Modal</strong> 三大组件，并结合样式、Props 校验、children 渲染机制、CSS-in-JS 与 CSS 模块化等关键知识点，全面展示 React 开发的最佳实践。</p>
<hr/>
<h2 data-id="heading-0">👋 Greeting 组件：Props 传递与默认值设定</h2>
<p><code>Greeting.jsx</code> 是一个典型的函数式组件，用于向用户打招呼。其核心在于 <strong>props 的接收与使用</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> { name, message, showIcon } = props
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-1">🔍 Props 解构与条件渲染</h3>
<ul>
<li>使用解构赋值从 <code>props</code> 中提取 <code>name</code>、<code>message</code> 和 <code>showIcon</code>。</li>
<li><code>showIcon &amp;&amp; &lt;span&gt;👋&lt;/span&gt;</code> 实现了<strong>条件渲染</strong>：只有当 <code>showIcon</code> 为 <code>true</code> 时才显示挥手 emoji。</li>
</ul>
<h3 data-id="heading-2">📦 PropTypes 与 defaultProps</h3>
<p>通过 <code>prop-types</code> 库进行类型校验和默认值设置：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title class_">Greeting</span>.<span class="hljs-property">propTypes</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>.<span class="hljs-property">isRequired</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>,
  <span class="hljs-attr">showIcon</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">bool</span>
};

<span class="hljs-title class_">Greeting</span>.<span class="hljs-property">defaultProps</span> = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello, I am default message! Welcome to join ByteDance!'</span>,
  <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span>
};
</code></pre>
<blockquote>
<p>⚠️ 注意：原文中 <code>defaultProps</code> 被错误地写在了 <code>propTypes</code> 内部（如 <code>message: PropTypes.string.defaultProps = ...</code>），这是语法错误。正确做法是<strong>单独定义 <code>defaultProps</code> 对象</strong>，如上所示。</p>
</blockquote>
<h3 data-id="heading-3">✅ 最佳实践建议</h3>
<ul>
<li>所有非必需 prop 都应提供 <code>defaultProps</code>。</li>
<li>必需 prop 使用 <code>.isRequired</code> 明确约束。</li>
<li>在开发环境下，PropTypes 会在控制台输出警告，帮助开发者快速定位问题。</li>
</ul>
<hr/>
<h2 data-id="heading-4">🃏 Card 组件：样式封装与 children 复用</h2>
<p><code>Card.jsx</code> 展示了如何构建一个<strong>可复用的 UI 容器组件</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ children, className = <span class="hljs-string">''</span> }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-5">🎨 样式来源：CSS 模块化</h3>
<p>配套的 <code>Card.css</code> 提供了完整的视觉样式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">8px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>);
}
</code></pre>
<h3 data-id="heading-6">🔁 children 模式：高度灵活的内容注入</h3>
<ul>
<li><code>children</code> 是 React 的特殊 prop，代表组件标签之间的内容。</li>
<li>在 <code>App.jsx</code> 中使用：</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Card</span> className=<span class="hljs-string">"user-card"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>小王<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>AI+全栈工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p>这使得 <code>Card</code> 成为一个<strong>布局容器</strong>，内部结构完全由使用者决定，极大提升复用性。</p>
<h3 data-id="heading-7">🧱 为什么用 <code>className</code> 而不是 <code>class</code>？</h3>
<ul>
<li>JSX 是 JavaScript 的语法扩展，最终编译为 <code>React.createElement()</code>。</li>
<li><code>class</code> 是 JavaScript 保留关键字，因此在 JSX 中必须使用 <code>className</code>。</li>
<li>这是 React 的约定，所有 DOM 属性在 JSX 中都采用驼峰命名（如 <code>onClick</code>, <code>tabIndex</code>）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">🪟 Modal 组件：高阶组件组合与自定义头部/底部</h2>
<p><code>Modal.jsx</code> 是一个<strong>复合型弹窗组件</strong>，展示了如何通过 props 传入自定义组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">HeaderComponent</span>, <span class="hljs-title class_">FooterComponent</span>, children } = props
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.modal}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HeaderComponent</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.content}</span>&gt;</span>
          {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">FooterComponent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-9">🧩 组件作为 Prop 传递</h3>
<ul>
<li><code>HeaderComponent</code> 和 <code>FooterComponent</code> 是函数组件（无状态组件）。</li>
<li>在 <code>App.jsx</code> 中定义并传入：</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyHeader</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">color:</span> '<span class="hljs-attr">blue</span>' }}&gt;</span>自定义标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyFooter</span> = (<span class="hljs-params"/>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">right</span>', <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> alert('关闭')} style={{ backgroundColor: 'pink' }}&gt;
      关闭
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)

<span class="hljs-comment">// 使用</span>
&lt;<span class="hljs-title class_">Modal</span> <span class="hljs-title class_">HeaderComponent</span>={<span class="hljs-title class_">MyHeader</span>} <span class="hljs-title class_">FooterComponent</span>={<span class="hljs-title class_">MyFooter</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以在这里显示任何JSX<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Modal</span>&gt;
</code></pre>
<blockquote>
<p>💡 注意：<code>HeaderComponent</code> 和 <code>FooterComponent</code> 是<strong>组件类型（函数）</strong> ，不是 JSX 元素（即不是 <code>&lt;MyHeader /&gt;</code>）。因此在 Modal 内部需以 <code>&lt;HeaderComponent /&gt;</code> 形式调用。</p>
</blockquote>
<h3 data-id="heading-10">🎨 CSS-in-JS 实现样式隔离</h3>
<p><code>Modal</code> 使用内联样式对象（CSS-in-JS 模式）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> styles = {
  <span class="hljs-attr">overlay</span>: {
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.5)'</span>,
    <span class="hljs-attr">position</span>: <span class="hljs-string">'fixed'</span>,
    <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">display</span>: <span class="hljs-string">'flex'</span>,
    <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>
  },
  <span class="hljs-attr">modal</span>: {
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'white'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-string">'1rem'</span>,
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">'8px'</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-string">'400px'</span>
  },
  <span class="hljs-attr">content</span>: {
    <span class="hljs-attr">margin</span>: <span class="hljs-string">'1rem 0'</span>
  }
}
</code></pre>
<h4 data-id="heading-11">✅ CSS-in-JS 优缺点</h4>
<ul>
<li><strong>优点</strong>：样式与组件逻辑紧耦合，避免全局污染；支持动态样式（如根据 props 改变颜色）。</li>
<li><strong>缺点</strong>：无法使用伪类（<code>:hover</code>）、媒体查询较繁琐（需额外库如 styled-components）；性能略低于原生 CSS。</li>
</ul>
<hr/>
<h2 data-id="heading-12">🏗️ App.jsx：组件组合的“乐高积木”</h2>
<p><code>App.jsx</code> 是整个应用的根组件，体现了 <strong>“组合优于继承”</strong> 的 React 哲学：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"王老板"</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"欢迎加入字节！！！"</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"王员工"</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"欢迎加入阿里！！！"</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"小王"</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"欢迎加入字节！！！"</span> <span class="hljs-attr">showIcon</span> /&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>小王<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>AI+全栈工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-13">🔗 组件通信：单向数据流</h3>
<ul>
<li>父组件（App）持有数据（如 <code>name</code>, <code>message</code>）。</li>
<li>通过 props 向子组件（Greeting, Card）传递数据。</li>
<li>子组件<strong>不能直接修改 props</strong>，若需交互（如 Modal 关闭），需通过回调函数（callback）通知父组件。</li>
</ul>
<blockquote>
<p>📌 虽然当前 Modal 的关闭按钮使用 <code>alert</code>，但在真实场景中应通过 <code>onClose</code> prop 触发父组件的状态更新（如 <code>setIsOpen(false)</code>）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">🛠️ 工程结构与协作规范</h2>
<p>根据 <code>readme.md</code> 的提示，项目遵循以下规范：</p>
<ul>
<li>
<p><strong>组件分类</strong>：</p>
<ul>
<li><code>components/</code>：通用 UI 组件（如 Greeting, Card, Modal）</li>
<li><code>pages/</code>：页面级组件（未展示，但通常包含路由和业务逻辑）</li>
</ul>
</li>
<li>
<p><strong>最小开发单元</strong>：每个组件是一个独立功能块，可像“乐高积木”一样拼装。</p>
</li>
<li>
<p><strong>协作方式</strong>：通过清晰的 props 接口定义，团队成员可并行开发不同组件。</p>
</li>
</ul>
<h3 data-id="heading-15">📦 依赖管理</h3>
<ul>
<li>
<p>使用 <code>prop-types</code> 进行运行时类型检查：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm install prop-types
<span class="hljs-meta"># 或</span>
pnpm <span class="hljs-keyword">add</span> prop-types
</code></pre>
</li>
</ul>
<hr/>
<h2 data-id="heading-16">🌐 全局样式与响应式设计</h2>
<p><code>index.css</code> 和 <code>App.css</code> 提供了基础样式：</p>
<h3 data-id="heading-17">🎨 主题与色彩</h3>
<ul>
<li>使用 <code>:root</code> 定义全局变量（虽未显式使用 CSS 变量，但设置了字体、颜色等）。</li>
<li>支持 <strong>prefers-color-scheme</strong> 媒体查询，自动适配系统亮/暗模式。</li>
</ul>
<h3 data-id="heading-18">📱 响应式布局</h3>
<ul>
<li><code>body</code> 使用 <code>min-height: 100vh</code> 和 <code>place-items: center</code> 实现垂直水平居中。</li>
<li><code>Card</code> 设置 <code>max-width: 400px</code> 和 <code>margin: 16px auto</code> 确保在移动端良好显示。</li>
</ul>
<hr/>
<h2 data-id="heading-19">🔚 总结：React 组件化的核心思想</h2>
<ol>
<li><strong>单一职责</strong>：每个组件只做一件事（Greeting 负责打招呼，Card 负责卡片布局）。</li>
<li><strong>可组合性</strong>：通过 <code>children</code> 和组件作为 prop，实现灵活嵌套。</li>
<li><strong>可配置性</strong>：通过 props 控制行为和外观（如 <code>showIcon</code>, <code>className</code>）。</li>
<li><strong>可维护性</strong>：样式隔离（CSS 模块 / CSS-in-JS）、类型校验（PropTypes）降低 bug 风险。</li>
<li><strong>工程化思维</strong>：目录结构清晰，组件分层，便于团队协作与长期迭代。</li>
</ol>
<p>通过以上实践，我们不仅构建了功能完整的 UI 组件，更掌握了 React 开发的底层逻辑与工程方法论。未来可进一步引入 <strong>Hooks（useState/useEffect）</strong> 管理状态、<strong>Context</strong> 实现跨层级通信、<strong>TypeScript</strong> 替代 PropTypes 实现编译期类型安全，持续提升代码质量与开发体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Vue.js前端开发实战》学习笔记 第2章 单文件组件、数据绑定]]></title>    <link>https://juejin.cn/post/7600588379106230324</link>    <guid>https://juejin.cn/post/7600588379106230324</guid>    <pubDate>2026-01-29T15:07:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600588379106230324" data-draft-id="7600600904095416354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Vue.js前端开发实战》学习笔记 第2章 单文件组件、数据绑定"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T15:07:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="滕青山"/> <meta itemprop="url" content="https://juejin.cn/user/3206601805674094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Vue.js前端开发实战》学习笔记 第2章 单文件组件、数据绑定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3206601805674094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    滕青山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T15:07:39.000Z" title="Thu Jan 29 2026 15:07:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、单文件组件（.vue）核心定义与结构</h2>
<p>每个<code>.vue</code>文件对应一个Vue单文件组件，是Vue组件的专属文件格式，由<strong>模板、样式、逻辑</strong>三部分构成，各部分各司其职且结构固定。</p>
<h3 data-id="heading-1">1. 三大组成部分说明</h3>





























<table><thead><tr><th>组成部分</th><th>对应标签</th><th>核心功能</th><th>关键注意点</th></tr></thead><tbody><tr><td>模板</td><td><code>&lt;template&gt;</code></td><td>搭建当前组件的DOM结构，仅作为包裹容器，不会被渲染为真实DOM元素</td><td>每个组件最多1个顶层<code>&lt;template&gt;</code>；Vue3支持<strong>多根节点</strong>，Vue2仅支持<strong>单根节点</strong>（必须有唯一外层根标签包裹）</td></tr><tr><td>样式</td><td><code>&lt;style&gt;</code></td><td>通过CSS代码为当前组件设置样式</td><td>可添加<code>scoped</code>属性实现组件样式隔离，避免样式污染</td></tr><tr><td>逻辑</td><td><code>&lt;script&gt;</code></td><td>通过JavaScript代码处理组件的数据定义、业务逻辑</td><td>Vue3提供<code>setup</code>语法糖，简化数据和方法的定义与暴露</td></tr></tbody></table>
<h2 data-id="heading-2">二、数据绑定核心内容</h2>
<p>Vue通过数据绑定实现<strong>数据与页面分离</strong>，最终达成<strong>数据驱动视图</strong>的效果，核心解决重复编写页面模板的问题（如图书商城复用图书详情页模板，仅修改数据展示不同内容）。
数据绑定分为<strong>定义数据</strong>和<strong>输出数据</strong>两个核心步骤，且普通数据无响应式，需通过专属函数处理为响应式数据，才能实现数据变化视图同步更新。</p>
<h3 data-id="heading-3">1. 初识数据绑定</h3>
<h4 data-id="heading-4">1.1 定义数据</h4>
<p>Vue3提供<strong>基础写法</strong>和<strong>setup语法糖写法</strong>（推荐），语法糖可大幅简化代码，提高开发效率。</p>
<h5 data-id="heading-5">写法1：基础写法（setup函数）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
	setup() {
		return {
			数据名: 数据值,
			// 可定义多个数据，以键值对形式存在
			...
		}
	}
}
&lt;/script&gt;
</code></pre>
<ul>
<li>核心要点：<code>export default</code>是模块导出语法；<code>setup()</code>是Vue3组合式API的起点，需通过<code>return</code>暴露数据给模板；组件实例创建时执行该代码。</li>
</ul>
<h5 data-id="heading-6">写法2：setup语法糖写法（推荐）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 直接定义变量即可，无需export和return，自动暴露给模板
const 数据名 = 数据值;
&lt;/script&gt;
</code></pre>
<ul>
<li>核心要点：在<code>&lt;script&gt;</code>标签添加<code>setup</code>属性即可使用，代码更简洁，是Vue3开发首选方式。</li>
</ul>
<h4 data-id="heading-7">1.2 输出数据</h4>
<p>使用Vue提供的<strong>Mustache语法（双大括号语法）</strong>，在<code>&lt;template&gt;</code>中作为占位符，页面渲染时会被替换为实际数据。</p>
<h5 data-id="heading-8">基本语法</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  {{ 数据名 }}
&lt;/template&gt;
</code></pre>
<h5 data-id="heading-9">支持的表达式类型</h5>
<p>Mustache语法可直接解析表达式，返回结果作为输出内容，示例如下：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  {{ 'Hello Vue.js' }}       &lt;!-- 字符串表达式 --&gt;
  {{ number + 1 }}            &lt;!-- 算术运算表达式 --&gt;
  {{ obj.name }}              &lt;!-- 对象属性取值表达式 --&gt;
  {{ ok ? 'YES' : 'NO' }}     &lt;!-- 三元运算符表达式 --&gt;
  {{ '&lt;div&gt;HTML标签&lt;/div&gt;' }} &lt;!-- HTML字符串（会被当作纯文本输出，不解析标签） --&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-10">1.3 基础数据绑定实操示例</h4>
<p><strong>步骤1</strong>：创建<code>src\components\Message.vue</code>文件，编写代码</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;{{ message }}&lt;/template&gt;
&lt;script setup&gt;
const message = '不积跬步,无以至千里'
&lt;/script&gt;
</code></pre>
<p><strong>步骤2</strong>：修改<code>src\main.js</code>文件，切换展示组件</p>
<pre><code class="hljs language-vue" lang="vue">import { createApp } from 'vue'
import './style.css'
// 替换为自定义的Message组件
import App from './components/Message.vue'

createApp(App).mount('#app')
</code></pre>
<h3 data-id="heading-11">2. 响应式数据绑定</h3>
<h4 data-id="heading-12">2.1 普通数据的问题</h4>
<p>直接定义的普通数据，修改后<strong>数据本身会变化，但页面视图不会同步更新</strong>，示例验证如下：
修改<code>src\components\Message.vue</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;{{ message }}&lt;/template&gt;
&lt;script setup&gt;
let message = '不积跬步,无以至千里'
// 2秒后修改数据
setTimeout(() =&gt; {
    console.log("更新前的message:" + message)
    message = '长风破浪会有时, 直挂云帆济沧海'
    console.log('更新后的message:' + message)
}, 2000)
&lt;/script&gt;
</code></pre>
<ul>
<li>控制台：能打印出更新前、后的数据值，说明数据本身已修改；</li>
<li>页面：始终显示原始数据，说明视图未同步更新。</li>
</ul>
<h4 data-id="heading-13">2.2 响应式数据定义函数</h4>
<p>Vue3提供<code>ref()</code>、<code>reactive()</code>、<code>toRef()</code>、<code>toRefs()</code>四个函数，用于将普通数据处理为<strong>响应式数据</strong>，实现<strong>数据变化 → 视图自动同步更新</strong>，四个函数适用场景不同，需按需选择。</p>
<h5 data-id="heading-14">函数1：ref()</h5>
<ul>
<li><strong>作用</strong>：将<strong>基本类型数据/引用类型数据</strong>转换为响应式数据，是Vue3中最常用的响应式函数；</li>
<li><strong>语法</strong>：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入ref函数</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 定义响应式数据</span>
<span class="hljs-keyword">const</span> 响应式数据 = <span class="hljs-title function_">ref</span>(初始数据值)
<span class="hljs-comment">// 修改响应式数据（必须通过.value属性）</span>
响应式数据.<span class="hljs-property">value</span> = 新值
</code></pre>
</li>
<li><strong>实操示例</strong>：
① 创建<code>src\components\Ref.vue</code>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;{{ message }}&lt;/template&gt;
&lt;script setup&gt;
// 导入ref函数
import { ref } from 'vue'
// 定义ref响应式数据
const message = ref('会当凌绝顶,一览众山小')
// 2秒后修改数据
setTimeout(() =&gt; {
    message.value = '锲而不舍,金石可镂'
}, 2000)
&lt;/script&gt;
</code></pre>
② 修改<code>src\main.js</code>切换组件
<pre><code class="hljs language-vue" lang="vue">import App from './components/Ref.vue'
</code></pre>
</li>
</ul>
<h5 data-id="heading-15">函数2：reactive()</h5>
<ul>
<li><strong>作用</strong>：专门创建<strong>响应式对象/响应式数组</strong>，仅支持引用类型（对象、数组），不支持基本类型；</li>
<li><strong>语法</strong>：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入reactive函数</span>
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 定义响应式对象/数组</span>
<span class="hljs-keyword">const</span> 响应式对象 = <span class="hljs-title function_">reactive</span>(普通对象/普通数组)
<span class="hljs-comment">// 修改响应式数据（直接修改属性/元素，无需.value）</span>
响应式对象.属性名 = 新值
</code></pre>
</li>
<li><strong>实操示例</strong>：
① 创建<code>src\components\Reactive.vue</code>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;{{ obj.message }}&lt;/template&gt;
&lt;script setup&gt;
// 导入reactive函数
import { reactive } from 'vue'
// 定义reactive响应式对象
const obj = reactive({ message: '不畏浮云遮望眼,自缘身在最高层' })
// 2秒后修改数据
setTimeout(() =&gt; {
    obj.message = '欲穷千里目,更上一层楼'
}, 2000)
&lt;/script&gt;
</code></pre>
② 修改<code>src\main.js</code>切换组件
<pre><code class="hljs language-vue" lang="vue">import App from './components/Reactive.vue'
</code></pre>
</li>
</ul>
<h5 data-id="heading-16">函数3：toRef()</h5>
<ul>
<li><strong>作用</strong>：将<strong>响应式对象中的单个属性</strong>转换为独立的响应式数据，修改该数据会同步更新原响应式对象；</li>
<li><strong>语法</strong>：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入reactive、toRef函数</span>
<span class="hljs-keyword">import</span> { reactive, toRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 先定义基础响应式对象</span>
<span class="hljs-keyword">const</span> 响应式对象 = <span class="hljs-title function_">reactive</span>({ 属性<span class="hljs-number">1</span>: 值<span class="hljs-number">1</span>, 属性<span class="hljs-number">2</span>: 值<span class="hljs-number">2</span> })
<span class="hljs-comment">// 将单个属性转为响应式数据</span>
<span class="hljs-keyword">const</span> 响应式属性 = <span class="hljs-title function_">toRef</span>(响应式对象, <span class="hljs-string">'属性名'</span>)
<span class="hljs-comment">// 修改数据（需通过.value）</span>
响应式属性.<span class="hljs-property">value</span> = 新值
</code></pre>
</li>
<li><strong>实操示例</strong>：
① 创建<code>src\components\ToRef.vue</code>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;div&gt;message的值:{{ message }}&lt;/div&gt;
    &lt;div&gt;obj.message的值:{{ obj.message }}&lt;/div&gt;
&lt;/template&gt;
&lt;script setup&gt;
// 导入所需函数
import { reactive, toRef } from 'vue'
// 定义基础响应式对象
const obj = reactive({ message: '黑发不知勤学早,白首方悔读书迟' })
// 将obj的message属性转为独立响应式数据
const message = toRef(obj, 'message')
// 2秒后修改数据
setTimeout(() =&gt; {
    message.value = '少壮不努力,老大徒伤悲'
}, 2000)
&lt;/script&gt;
</code></pre>
② 修改<code>src\main.js</code>切换组件
<pre><code class="hljs language-vue" lang="vue">import App from './components/ToRef.vue'
</code></pre>
</li>
</ul>
<h5 data-id="heading-17">函数4：toRefs()</h5>
<ul>
<li><strong>作用</strong>：将<strong>响应式对象中的所有属性</strong>一次性转换为独立的响应式数据，返回一个包含所有响应式属性的对象，可通过解构赋值快速使用，修改属性会同步更新原响应式对象；</li>
<li><strong>语法</strong>：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入reactive、toRefs函数</span>
<span class="hljs-keyword">import</span> { reactive, toRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 先定义基础响应式对象</span>
<span class="hljs-keyword">const</span> 响应式对象 = <span class="hljs-title function_">reactive</span>({ 属性<span class="hljs-number">1</span>: 值<span class="hljs-number">1</span>, 属性<span class="hljs-number">2</span>: 值<span class="hljs-number">2</span> })
<span class="hljs-comment">// 将所有属性转为响应式数据，解构赋值获取</span>
<span class="hljs-keyword">const</span> { 属性<span class="hljs-number">1</span>, 属性<span class="hljs-number">2</span> } = <span class="hljs-title function_">toRefs</span>(响应式对象)
<span class="hljs-comment">// 修改数据（需通过.value）</span>
属性<span class="hljs-number">1.</span>value = 新值
</code></pre>
</li>
<li><strong>实操示例</strong>：
① 创建<code>src\components\ToRefs.vue</code>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;div&gt;message的值:{{ message }}&lt;/div&gt;
    &lt;div&gt;obj.message的值:{{ obj.message }}&lt;/div&gt;
&lt;/template&gt;
&lt;script setup&gt;
// 导入所需函数
import { reactive, toRefs } from 'vue'
// 定义基础响应式对象
const obj = reactive({ message: '盛年不重来,一日难再晨' })
// 将obj的所有属性转为响应式数据，解构获取message
let { message } = toRefs(obj)
// 2秒后修改数据
setTimeout(() =&gt; {
    message.value = '及时当勉励,岁月不待人'
}, 2000)
&lt;/script&gt;
</code></pre>
② 修改<code>src\main.js</code>切换组件
<pre><code class="hljs language-vue" lang="vue">import App from './components/ToRefs.vue'
</code></pre>
</li>
</ul>
<h2 data-id="heading-18">三、核心知识点总结</h2>
<h3 data-id="heading-19">1. 单文件组件关键</h3>
<ol>
<li>Vue3 对<code>&lt;template&gt;</code>的根节点限制放宽，支持多根节点，解决Vue2外层根标签的冗余问题；</li>
<li><code>&lt;script setup&gt;</code>是Vue3推荐写法，无需<code>export default</code>和<code>return</code>，直接定义数据/方法即可暴露给模板；</li>
<li><code>&lt;style scoped&gt;</code>是组件样式隔离的核心方式，开发中建议默认添加。</li>
</ol>
<h3 data-id="heading-20">2. 数据绑定关键</h3>
<ol>
<li>基础数据绑定通过**定义数据（setup）+ 输出数据（双大括号）**实现，仅能完成数据的初始展示；</li>
<li>Mustache语法支持各类简单表达式，但会将HTML字符串解析为纯文本，无法渲染DOM。</li>
</ol>
<h3 data-id="heading-21">3. 响应式数据核心</h3>
<ol>
<li>响应式是Vue数据驱动视图的<strong>核心底层</strong>，普通数据需通过Vue3专属函数处理后才具备响应式；</li>
<li><code>ref()</code>是通用响应式函数，支持所有数据类型，修改时<strong>必须加.value</strong>（模板中使用无需加）；</li>
<li><code>reactive()</code>仅支持对象/数组，修改时直接操作属性/元素，<strong>无需.value</strong>；</li>
<li><code>toRef()</code>和<code>toRefs()</code>基于<strong>已有响应式对象</strong>创建，用于拆分对象属性，实现属性的独立响应式，修改后会同步更新原对象；</li>
<li>所有响应式函数使用前<strong>必须先从vue中导入</strong>，否则会报错。</li>
</ol>
<h3 data-id="heading-22">4. 开发实操注意</h3>
<ol>
<li>切换组件的核心方式是修改<code>src\main.js</code>中<code>import App from 'xxx'</code>的导入路径；</li>
<li>定时器是验证响应式的常用方式，可直观看到数据和视图的更新效果；</li>
<li>开发中优先使用<code>setup</code>语法糖，简化代码编写；优先使用<code>ref()</code>定义响应式数据，通用性更强。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React19 渲染流程]]></title>    <link>https://juejin.cn/post/7600663744192888868</link>    <guid>https://juejin.cn/post/7600663744192888868</guid>    <pubDate>2026-01-29T15:43:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600663744192888868" data-draft-id="7600663744192872484" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React19 渲染流程"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-29T15:43:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秀秀不只会前端"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React19 渲染流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秀秀不只会前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T15:43:06.000Z" title="Thu Jan 29 2026 15:43:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、React 渲染架构</h2>
<p>底层渲染流程大致可以分为两大阶段：render 阶段（Scheduler -&gt; Reconciler）、commit 阶段（Renderer）</p>
<blockquote>
<p>注意这里的 render 阶段和 Renderer 渲染器是两个东西！！！</p>
</blockquote>
<p>主要的阶段可以总结为两个公式：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reconcile</span>(update); <span class="hljs-comment">// 通过 reconciler 计算出最新的状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">UI</span> = <span class="hljs-title function_">commit</span>(state); <span class="hljs-comment">// 通过最新的 state 渲染出 UI</span>
</code></pre>
<h2 data-id="heading-1">二、调度器（Scheduler）：渲染的入口与优先级控制</h2>
<blockquote>
<p>Scheduler 类似于浏览器的原生 API requestIdleCallback。React 团队没有使用 requestIdleCallback 是因为考虑为兼容性问题。</p>
</blockquote>
<p>Scheduler 是整个渲染执行链条的入口，负责：</p>
<ol>
<li>将变更转化为任务</li>
<li>按优先级调度任务执行</li>
<li>支持时间切片与可中断渲染</li>
</ol>
<blockquote>
<p>虽然每一帧绘制时间约为 16.66ms，但是如果屏幕没有刷新，那么浏览器会安排长度为 50ms 左右的空闲时间。</p>
<p>研究表明，用户操作之后，100ms 以内的响应给用户的感觉都是瞬间发生，也就是说不会感受到延迟感，因此将空闲时间设置为 50，浏览器依然还剩下 50ms 可以处理用户的操作响应，不会让用户感到延迟，这就是我们面试题中常看到的浏览器渲染每帧的空闲时间。</p>
</blockquote>
<ol>
<li>
<h3 data-id="heading-2">更新任务被排队</h3>
</li>
</ol>
<p>当你调用 <code>setState</code>、<code>dispatch</code>、<code>startTransition</code>、事件触发更新时，React 内部会：</p>
<pre><code class="hljs language-Plain" lang="Plain">scheduleUpdateOnFiber(fiber, lane, eventTime)
</code></pre>
<p>这个函数是调度入口，它将更新附着在对应的 Fiber 上，并根据任务的 <em>lane（内部优先级）</em> 更新任务队列。</p>
<ol start="2">
<li>
<h3 data-id="heading-3">任务优先级系统（Lanes）</h3>
</li>
</ol>
<p>React 内部并不使用单一队列，而是用<strong>多 lane 机制。</strong></p>
<blockquote>
<p>优先级由 Scheduler 根据事件来源与延迟（expiration time）决定。</p>
</blockquote>
<ol start="3">
<li>
<h3 data-id="heading-4">时间切片（Time Slicing）</h3>
</li>
</ol>
<p>Scheduler 会根据浏览器的空闲时间，决定是在当前帧继续执行还是 yield 给浏览器，这样协调器起点也是不同的：</p>
<ul>
<li>performSyncWorkOnRoot（同步更新流程）</li>
<li>performConcurrentWorkOnRoot（并发更新流程）</li>
</ul>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// performSyncWorkOnRoot 会执行该方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopSync</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">while</span>(workInProgress !== <span class="hljs-literal">null</span>){
    <span class="hljs-title function_">performUnitOfWork</span>(workInProgress)
  }
}
<span class="hljs-comment">// performConcurrentWorkOnRoot 会执行该方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopConcurrent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// shouldYield 表明任务是否可以中断</span>
  <span class="hljs-comment">// 如果 workInProgress 为 null，说明已经没有下一个 FiberNode，也就是说明整颗 Fiber tree 树构建完毕</span>
  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) {
    <span class="hljs-comment">// performUnitOfWork创建下一个 FiberNode，并且将已创建的 FiberNode 连接起来（child、return、sibling），形成一个链表结构的 Fiber tree</span>
    workInProgress = <span class="hljs-title function_">performUnitOfWork</span>(workInProgress); 
  }
}
</code></pre>
<p><code>shouldYield</code> 判断当前帧是否该让出，避免阻塞主线程。</p>
<ol start="4">
<li>
<h3 data-id="heading-5">中断 + 恢复机制</h3>
</li>
</ol>
<p>如果有更高优先级的任务，中断当前 render，后续在合适时机 ​<em>恢复执行</em>​。这样能确保交互响应不会被大更新阻塞。</p>
<h2 data-id="heading-6">三、协调器（Reconciler）：Fiber 树的 diff 与标记</h2>
<p>协调器的核心任务是：</p>
<ol>
<li>对比新旧树，确定哪些节点变化</li>
<li>生成 <strong>workInProgress Fiber 树</strong></li>
<li>标记变化（Placement、Update、Deletion）</li>
<li>不直接修改 DOM，而是将变化收集起来</li>
<li>
<h3 data-id="heading-7">Fiber 数据结构</h3>
</li>
</ol>
<p>每一个组件在运行时都有一个 Fiber 节点：</p>
<ul>
<li>指向真实 DOM 实例</li>
<li>链接 child / sibling / return 三个方向</li>
<li>记录当前组件状态、props、更新队列、优先级等属性</li>
</ul>
<blockquote>
<p>这种结构不同于简单递归栈，它更像一颗​<strong>可分片执行的链表树</strong>​。</p>
</blockquote>
<ol start="2">
<li>
<h3 data-id="heading-8">Reconciler 工作循环 —— render 阶段</h3>
</li>
</ol>
<p>协调器是由 Scheduler 调度后执行的。React 会从 Root Fiber 开始 traverse。</p>
<h4 data-id="heading-9">a. beginWork</h4>
<p>处理当前节点逻辑，根据类型（函数组件 / 类组件 / Fragment 等）判断需要构建哪些子 Fiber。</p>
<h4 data-id="heading-10">b. completeWork</h4>
<p>在子节点构建完成后整合变化，把节点的更改标记写入 <code>flags</code>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 深度优先遍历</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiberNode</span>){
  <span class="hljs-comment">// 省略 beginWork </span>
  <span class="hljs-keyword">if</span>(fiberNode.<span class="hljs-property">child</span>){
    <span class="hljs-title function_">performUnitOfWork</span>(fiberNode.<span class="hljs-property">child</span>);
  }
  <span class="hljs-comment">// 省略 CompleteWork </span>
  <span class="hljs-keyword">if</span>(fiberNode.<span class="hljs-property">sibling</span>){
    <span class="hljs-title function_">performUnitOfWork</span>(fiberNode.<span class="hljs-property">sibling</span>);
  }
}
</code></pre>
<p>整个过程构成一个 ​<strong>双缓冲机制</strong>​：</p>
<ul>
<li>current Fiber（当前渲染状态）</li>
<li>workInProgress Fiber（正在构建的树）</li>
</ul>
<p>最终 <code>workInProgress</code> 树会用于提交阶段。</p>
<ol start="3">
<li>
<h3 data-id="heading-11">标记变化</h3>
</li>
</ol>
<p>协调器不会直接操作 DOM，而是根据差异为每个节点打上 flags：</p>
<ul>
<li>​<strong>Placement</strong>​：新节点插入</li>
<li>​<strong>Update</strong>​：属性/文本内容更新</li>
<li>​<strong>Deletion</strong>​：删除节点</li>
</ul>
<p>这些标记会在提交阶段被 Renderer 读取。</p>
<h2 data-id="heading-12">四、渲染器（Renderer）：真实环境应用变化</h2>
<p>Renderer 是把协调阶段生成的变化<strong>同步</strong>应用到最终环境，比如：</p>
<ul>
<li>浏览器的 DOM</li>
<li>React Native 原生视图</li>
<li>其他自定义渲染平台</li>
</ul>
<p>React 通过隔离平台实现了 Renderer 的可插拔。相较于 render 阶段，此时 commit 阶段不可中断恢复。</p>
<ol>
<li>
<h3 data-id="heading-13">提交阶段的三个子阶段</h3>
</li>
</ol>
<p>协调阶段完成后进入 ​<strong>commit 阶段</strong>​：</p>
<h4 data-id="heading-14">a. Before Mutation</h4>
<p>执行 <code>getSnapshotBeforeUpdate</code>（类组件），记录焦点、selection（输入框光标）等。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">commitBeforeMutationEffects</span>(root, finishedWork)
<span class="hljs-comment">// 读取旧的 DOM 状态</span>
</code></pre>
<h4 data-id="heading-15">b. Mutation</h4>
<p>​<strong>真实 DOM 操作发生位置</strong>​，根据 <code>flags</code> 做：appendChild、removeChild、update 属性、插入节点等。</p>
<p>然后切换 Fiber Tree（也就是上面提到的双缓冲机制，两棵树互换）。</p>
<h4 data-id="heading-16">c. Layout</h4>
<blockquote>
<p>useLayoutEffect 的意义是：在 DOM 更新完成后，浏览器绘制之前，同步读取或修改布局。</p>
</blockquote>
<p>执行 <code>useLayoutEffect、componentDidMount、componentDidUpdate</code> 的回调。</p>
<blockquote>
<p>注意哦！！！这里虽然 DOM 已经变更了，但是浏览器页面​<strong>还没有 paint，下一步才是绘制</strong>​。</p>
</blockquote>
<ol start="2">
<li>
<h3 data-id="heading-17">渲染器应用 DOM 改变</h3>
</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">commitUpdate</span>(domElement, updatePayload, type, oldProps, newProps)
<span class="hljs-comment">// 调用一系列 DOM API 为元素属性更新赋值</span>
</code></pre>
<blockquote>
<p>这里 paint 之后，才会执行 useEffect（异步）的回调。</p>
<p>所以如果需要操作 DOM ，要在 useLayoutEffect 钩子执行。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 单例模式的简单了解]]></title>    <link>https://juejin.cn/post/7600622206268899338</link>    <guid>https://juejin.cn/post/7600622206268899338</guid>    <pubDate>2026-01-29T15:13:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206268899338" data-draft-id="7600615229995188274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 单例模式的简单了解"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-29T15:13:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 单例模式的简单了解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T15:13:10.000Z" title="Thu Jan 29 2026 15:13:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基本概念</h2>
<h3 data-id="heading-1">定义</h3>
<p>确保一个类只有一个实例，并提供一个全局访问点来访问这个实例。</p>
<h3 data-id="heading-2">核心思想</h3>
<ul>
<li><strong>私有构造器</strong>：防止外部通过new创建实例</li>
<li><strong>静态实例引用</strong>：类自身持有唯一实例</li>
<li><strong>全局访问点</strong>：提供静态方法获取唯一实例</li>
</ul>
<h2 data-id="heading-3">二、实现方式详解</h2>
<h3 data-id="heading-4">1. 饿汉式 (Eager Initialization)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin实现</span>
<span class="hljs-keyword">object</span> Singleton {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"饿汉式单例"</span>)
    }
}

<span class="hljs-comment">// 使用</span>
Singleton.doSomething()

<span class="hljs-comment">// Java实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EagerSingleton</span> {
    <span class="hljs-comment">// 类加载时就初始化</span>
    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> EagerSingleton INSTANCE = new EagerSingleton();
    
    <span class="hljs-keyword">private</span> EagerSingleton() {
        <span class="hljs-comment">// 防止反射攻击</span>
        <span class="hljs-keyword">if</span> (INSTANCE != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> new RuntimeException(<span class="hljs-string">"单例模式禁止反射创建"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> static EagerSingleton getInstance() {
        <span class="hljs-keyword">return</span> INSTANCE;
    }
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>线程安全（类加载时初始化）</li>
<li>不支持延迟加载</li>
<li>可能浪费内存（即使不用也会创建）</li>
</ul>
<h3 data-id="heading-5">2. 懒汉式 (Lazy Initialization)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 线程不安全版本</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnsafeLazySingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> instance: UnsafeLazySingleton? = <span class="hljs-literal">null</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>: UnsafeLazySingleton {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = UnsafeLazySingleton() <span class="hljs-comment">// 多线程下可能创建多个实例</span>
            }
            <span class="hljs-keyword">return</span> instance!!
        }
    }
}

<span class="hljs-comment">// 线程安全版本 - 同步方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedLazySingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> instance: SynchronizedLazySingleton? = <span class="hljs-literal">null</span>
        
        <span class="hljs-meta">@Synchronized</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>: SynchronizedLazySingleton {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = SynchronizedLazySingleton()
            }
            <span class="hljs-keyword">return</span> instance!!
        }
    }
}
</code></pre>
<h3 data-id="heading-6">3. 双重检查锁定 (Double-Checked Locking)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleCheckedSingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-meta">@Volatile</span> <span class="hljs-comment">// 确保可见性，防止指令重排序</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> instance: DoubleCheckedSingleton? = <span class="hljs-literal">null</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>: DoubleCheckedSingleton {
            <span class="hljs-comment">// 第一次检查：不加锁，提高性能</span>
            <span class="hljs-keyword">return</span> instance ?: synchronized(<span class="hljs-keyword">this</span>) {
                <span class="hljs-comment">// 第二次检查：加锁，确保线程安全</span>
                instance ?: DoubleCheckedSingleton().also {
                    instance = it
                }
            }
        }
    }
}

<span class="hljs-comment">// Java实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleCheckedSingleton</span> {
    <span class="hljs-comment">// volatile关键字防止指令重排序</span>
    <span class="hljs-keyword">private</span> static volatile DoubleCheckedSingleton instance;
    
    <span class="hljs-keyword">private</span> DoubleCheckedSingleton() {}
    
    <span class="hljs-keyword">public</span> static DoubleCheckedSingleton getInstance() {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 第一次检查</span>
            synchronized (DoubleCheckedSingleton.<span class="hljs-keyword">class</span>) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 第二次检查</span>
                    instance = new DoubleCheckedSingleton();
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p><strong>原理分析</strong>：</p>
<ul>
<li><strong>第一次检查</strong>：避免不必要的同步</li>
<li><strong>同步块</strong>：确保只有一个线程进入</li>
<li><strong>第二次检查</strong>：防止多个线程通过第一次检查</li>
<li><strong>volatile</strong>：防止指令重排序，确保可见性</li>
</ul>
<h3 data-id="heading-7">4. 静态内部类 (Static Inner Class)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerClassSingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span> = Holder.INSTANCE
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">object</span> Holder {
        <span class="hljs-keyword">val</span> INSTANCE = InnerClassSingleton()
    }
}

<span class="hljs-comment">// Java实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticInnerClassSingleton</span> {
    <span class="hljs-keyword">private</span> StaticInnerClassSingleton() {}
    
    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> {
        <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> StaticInnerClassSingleton INSTANCE = 
            new StaticInnerClassSingleton();
    }
    
    <span class="hljs-keyword">public</span> static StaticInnerClassSingleton getInstance() {
        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;
    }
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>懒加载（只有调用getInstance时才加载内部类）</li>
<li>线程安全（类加载机制保证）</li>
<li>实现简单，性能好</li>
</ul>
<h3 data-id="heading-8">5. 枚举实现 (Enum Singleton) - 《Effective Java》推荐</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin</span>
<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumSingleton</span> {
    INSTANCE;
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"枚举单例"</span>)
    }
}

<span class="hljs-comment">// 使用</span>
EnumSingleton.INSTANCE.doSomething()

<span class="hljs-comment">// Java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> EnumSingleton {
    INSTANCE;
    
    <span class="hljs-keyword">public</span> void doSomething() {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"枚举单例"</span>);
    }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>绝对防止反射攻击</li>
<li>防止反序列化创建新实例</li>
<li>线程安全</li>
<li>实现简单</li>
</ul>
<h2 data-id="heading-9">三、单例模式的高级应用</h2>
<h3 data-id="heading-10">1. 参数化单例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigManager</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> configName: String
) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> properties = mutableMapOf&lt;String, Any&gt;()
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> instances = mutableMapOf&lt;String, ConfigManager&gt;()
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(configName: <span class="hljs-type">String</span>)</span></span>: ConfigManager {
            <span class="hljs-keyword">return</span> instances[configName] ?: synchronized(<span class="hljs-keyword">this</span>) {
                instances[configName] ?: ConfigManager(configName).also {
                    instances[configName] = it
                }
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setProperty</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, value: <span class="hljs-type">Any</span>)</span></span> {
        properties[key] = value
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getProperty</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: Any? {
        <span class="hljs-keyword">return</span> properties[key]
    }
}

<span class="hljs-comment">// 使用不同的配置实例</span>
<span class="hljs-keyword">val</span> userConfig = ConfigManager.getInstance(<span class="hljs-string">"user"</span>)
<span class="hljs-keyword">val</span> systemConfig = ConfigManager.getInstance(<span class="hljs-string">"system"</span>)
</code></pre>
<h3 data-id="heading-11">2. 单例工厂</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonFactory</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> instances = mutableMapOf&lt;String, T&gt;()
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: T
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: T {
        <span class="hljs-keyword">return</span> instances[key] ?: synchronized(<span class="hljs-keyword">this</span>) {
            instances[key] ?: create(key).also {
                instances[key] = it
            }
        }
    }
}

<span class="hljs-comment">// 具体实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseFactory</span> : <span class="hljs-type">SingletonFactory</span>&lt;<span class="hljs-type">Database</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: Database {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (key) {
            <span class="hljs-string">"user"</span> -&gt; UserDatabase()
            <span class="hljs-string">"product"</span> -&gt; ProductDatabase()
            <span class="hljs-keyword">else</span> -&gt; DefaultDatabase()
        }
    }
}
</code></pre>
<h2 data-id="heading-12">四、单例模式的问题与解决方案</h2>
<h3 data-id="heading-13">1. 内存泄漏问题</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误示例：单例持有Activity引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LeakySingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> activity: Activity) {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> instance: LeakySingleton? = <span class="hljs-literal">null</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>)</span></span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = LeakySingleton(activity) <span class="hljs-comment">// 持有Activity引用！</span>
            }
        }
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>: LeakySingleton? = instance
    }
}

<span class="hljs-comment">// 正确做法：使用Application Context</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeSingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> appContext = context.applicationContext
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-meta">@Volatile</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> instance: SafeSingleton? = <span class="hljs-literal">null</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: SafeSingleton {
            <span class="hljs-keyword">return</span> instance ?: synchronized(<span class="hljs-keyword">this</span>) {
                instance ?: SafeSingleton(context.applicationContext).also {
                    instance = it
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-14">2. 测试困难 - 使用依赖注入解决</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统单例 - 难以测试</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnalyticsManager</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> instance: AnalyticsManager? = <span class="hljs-literal">null</span>
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>: AnalyticsManager {
            <span class="hljs-keyword">return</span> instance ?: synchronized(<span class="hljs-keyword">this</span>) {
                instance ?: AnalyticsManager().also {
                    instance = it
                }
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trackEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 发送到服务器 - 测试时难以模拟</span>
    }
}

<span class="hljs-comment">// 使用接口和依赖注入</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Analytics</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trackEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnalyticsImpl</span> : <span class="hljs-type">Analytics</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trackEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 真实实现</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MockAnalytics</span> : <span class="hljs-type">Analytics</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trackEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 测试实现</span>
    }
}

<span class="hljs-comment">// 使用Dagger/Hilt依赖注入</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> AnalyticsModule {
    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span> <span class="hljs-comment">// Dagger会处理单例</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideAnalytics</span><span class="hljs-params">()</span></span>: Analytics = AnalyticsImpl()
}

<span class="hljs-comment">// ViewModel中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> analytics: Analytics  <span class="hljs-comment">// 由Dagger注入单例</span>
) : ViewModel() {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onButtonClick</span><span class="hljs-params">()</span></span> {
        analytics.trackEvent(<span class="hljs-string">"button_click"</span>)
    }
}
</code></pre>
<h2 data-id="heading-15">五、Kotlin特有的单例特性</h2>
<h3 data-id="heading-16">1. object声明</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> NetworkManager {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TIMEOUT = <span class="hljs-number">5000L</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeRequest</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// 网络请求</span>
    }
    
    <span class="hljs-comment">// object可以有init块</span>
    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"NetworkManager初始化"</span>)
    }
}

<span class="hljs-comment">// 反编译为Java看本质</span>
<span class="hljs-comment">/*
public final class NetworkManager {
    public static final NetworkManager INSTANCE;
    
    static {
        NetworkManager var0 = new NetworkManager();
        INSTANCE = var0;
        System.out.println("NetworkManager初始化");
    }
    
    private NetworkManager() {}
}
*/</span>
</code></pre>
<h3 data-id="heading-17">2. by lazy实现懒加载</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazySingleton</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> instance: LazySingleton <span class="hljs-keyword">by</span> lazy(LazyThreadSafetyMode.SYNCHRONIZED) {
            println(<span class="hljs-string">"初始化LazySingleton"</span>)
            LazySingleton()
        }
    }
}

<span class="hljs-comment">// 不同的线程安全模式</span>
<span class="hljs-keyword">val</span> unsafeInstance <span class="hljs-keyword">by</span> lazy(LazyThreadSafetyMode.NONE) { <span class="hljs-comment">/* 线程不安全 */</span> }
<span class="hljs-keyword">val</span> synchronizedInstance <span class="hljs-keyword">by</span> lazy(LazyThreadSafetyMode.SYNCHRONIZED) { <span class="hljs-comment">/* 线程安全 */</span> }
<span class="hljs-keyword">val</span> publicationInstance <span class="hljs-keyword">by</span> lazy(LazyThreadSafetyMode.PUBLICATION) { <span class="hljs-comment">/* 允许重复初始化 */</span> }
</code></pre>
<h2 data-id="heading-18">六、最佳实践指南</h2>
<h3 data-id="heading-19">何时使用单例模式？</h3>
<p>✅ <strong>适用场景</strong>：</p>
<ol>
<li>全局配置管理（如AppConfig）</li>
<li>日志记录器（如Logger）</li>
<li>数据库访问对象</li>
<li>网络请求客户端</li>
<li>缓存管理器</li>
<li>工具类（如DateFormatter）</li>
</ol>
<p>❌ <strong>避免使用场景</strong>：</p>
<ol>
<li>需要大量测试的类</li>
<li>可能有多态需求的类</li>
<li>需要参数化配置的类</li>
<li>状态频繁变化的类</li>
</ol>
<h3 data-id="heading-20">Android开发建议</h3>
<ul>
<li><strong>优先使用依赖注入</strong>（Dagger/Hilt）管理单例</li>
<li><strong>避免持有Context引用</strong>，必须使用时用Application Context</li>
<li><strong>注意生命周期</strong>，及时清理资源</li>
<li><strong>使用Kotlin object</strong>简化单例实现</li>
</ul>
<h3 data-id="heading-21">代码示例：完整的Android单例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用Kotlin object + 依赖注入思想</span>
<span class="hljs-keyword">object</span> ImageLoader {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MEMORY_CACHE_SIZE = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// 10MB</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> memoryCache: LruCache&lt;String, Bitmap&gt;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> executor: ExecutorService
    
    <span class="hljs-keyword">init</span> {
        memoryCache = <span class="hljs-keyword">object</span> : LruCache&lt;String, Bitmap&gt;(MEMORY_CACHE_SIZE) {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sizeOf</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, value: <span class="hljs-type">Bitmap</span>)</span></span>: <span class="hljs-built_in">Int</span> {
                <span class="hljs-keyword">return</span> value.byteCount
            }
        }
        
        executor = Executors.newFixedThreadPool(<span class="hljs-number">4</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadImage</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span> {
        <span class="hljs-comment">// 检查内存缓存</span>
        <span class="hljs-keyword">val</span> cachedBitmap = memoryCache.<span class="hljs-keyword">get</span>(url)
        <span class="hljs-keyword">if</span> (cachedBitmap != <span class="hljs-literal">null</span>) {
            imageView.setImageBitmap(cachedBitmap)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 异步加载</span>
        executor.submit {
            <span class="hljs-keyword">val</span> bitmap = downloadImage(url)
            bitmap?.let {
                memoryCache.put(url, it)
                
                <span class="hljs-comment">// 切回主线程更新UI</span>
                Handler(Looper.getMainLooper()).post {
                    imageView.setImageBitmap(it)
                }
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">()</span></span> {
        memoryCache.evictAll()
    }
}

<span class="hljs-comment">// 使用</span>
ImageLoader.loadImage(<span class="hljs-string">"https://example.com/image.jpg"</span>, imageView)
</code></pre>
<h2 data-id="heading-22">七、总结</h2>
<p>单例模式是Android开发中最常用的设计模式之一，但也是最容易被滥用的模式。正确使用单例模式需要注意：</p>
<ol>
<li><strong>线程安全</strong>：根据需求选择合适的线程安全方案</li>
<li><strong>内存管理</strong>：避免内存泄漏，特别是Context引用</li>
<li><strong>测试友好</strong>：考虑使用依赖注入提高可测试性</li>
<li><strong>Kotlin特性</strong>：充分利用object、by lazy等语言特性</li>
<li><strong>架构考虑</strong>：在MVVM等架构中合理使用单例</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级教程：十分钟快速搭建部署你的专属Moltbot！]]></title>    <link>https://juejin.cn/post/7600628279214931994</link>    <guid>https://juejin.cn/post/7600628279214931994</guid>    <pubDate>2026-01-29T10:51:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279214931994" data-draft-id="7600601482690363438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级教程：十分钟快速搭建部署你的专属Moltbot！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T10:51:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LiDayDay"/> <meta itemprop="url" content="https://juejin.cn/user/4464446331950568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级教程：十分钟快速搭建部署你的专属Moltbot！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4464446331950568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LiDayDay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:51:26.000Z" title="Thu Jan 29 2026 10:51:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    59
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>写在前面：</strong></p>
<p>🟡 快速体验 &amp; 项目反馈
欢迎大家下载并体验我们最新版本的 OpenChat，亲自感受本地多模型调度与智能助手融合的强大能力。</p>
<p>🌐 <strong>官方主页</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffastaistack.github.io%2FOpenChat%2F" target="_blank" title="https://fastaistack.github.io/OpenChat/" ref="nofollow noopener noreferrer">欢迎访问 OpenChat 官方网站，了解更多关于我们的团队愿景、产品动态与最新公告</a></p>
<p>🧩 <strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffastaistack%2FOpenChat" target="_blank" title="https://github.com/fastaistack/OpenChat" ref="nofollow noopener noreferrer">访问 OpenChat github 主页</a>  |  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ffastaistack%2Fopenchat" target="_blank" title="https://gitee.com/fastaistack/openchat" ref="nofollow noopener noreferrer">访问 OpenChat gitee 主页</a></p>
<p>🔗 <strong>下载应用</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffastaistack.github.io%2FOpenChat%2F" target="_blank" title="https://fastaistack.github.io/OpenChat/" ref="nofollow noopener noreferrer">点击下载OpenChat最新版本</a></p>
</blockquote>
<blockquote>
<p>我们非常期待您的宝贵反馈，无论是功能建议、使用体验，还是 Bug 报告，都将是我们持续优化的重要动力。下面我将介绍OpenChat与DeepSeek-OCR集成后具体的使用方式。</p>
</blockquote>
<h2 data-id="heading-0">一、快速介绍什么是Moltbot</h2>
<p align="left">Moltbot（原名 clawdbot）是一个运行在你自己设备上的开源高权限个人 AI 助手，深度集成 WhatsApp、Telegram、Discord、Slack、Signal、iMessage 等主流消息平台。它不是那种只能被动聊天的 AI，而是一个可以主动行动的 Agent：通过你最熟悉的聊天窗口，就能完成发邮件、排日程、做系统监控等自动化操作。</p>
<p align="left">Moltbot 支持多代理路由和高度可定制的技能系统，你可以像搭积木一样组合能力，把整个数字工作流交给它调度。它既可以跑在本地，完全掌控数据和权限，也可以部署到云端，实现 7×24 小时在线的长期运行，适合当成你真正的“常驻数字助手”。</p>
<p align="left">Moltbot 本身具备较高的系统操作权限。为降低安全风险、避免对本地环境产生直接影响，推荐在独立的云端隔离环境中进行部署和运行。通过将 Moltbot 与个人电脑或生产环境进行物理与权限层面的隔离，可以有效防止误操作带来的文件修改、配置污染等问题，使敏感操作更加可控、更加安心。</p>
<p align="left">接下来，我们将详细介绍如何在服务器上快速搭建属于你的 Moltbot 实例，并提供一个可直接使用的 Telegram 示例配置，帮助你在隔离环境中完成部署、连接与验证，快速体验 Moltbot 的完整能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b5681693a9f4a779a44d965b404efe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=WjOaEoxl7p5OxXCqkUpJQJ8EeM8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、服务器搭建你的moltbot</h2>
<h3 data-id="heading-2">1.准备一台服务器</h3>
<p>操作系统建议为 CentOS 或 Ubuntu。服务器基础配置建议为 4 核 CPU、16GB 内存（可根据实际业务负载进行调整）。
在服务器上提前完成 Docker 环境的安装与配置，以支持后续服务的容器化部署。 以下是为你需要的Dockfile，你可以依此构建容器。</p>
<pre><code class="hljs language-Dockfile" lang="Dockfile">FROM docker.m.daocloud.io/library/node:22-bookworm

# Use Aliyun APT mirror for faster package downloads in China
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

# Update package list and install OpenSSH Server and essential tools
RUN apt-get update &amp;&amp; \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    openssh-server \
    vim \
    curl \
    ca-certificates \
    procps \
    tmux &amp;&amp; \
    apt-get clean &amp;&amp; \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Enable pnpm via corepack
RUN corepack enable

# Use Aliyun npm mirror for faster package downloads
RUN npm config set registry https://registry.npmmirror.com

# Install moltbot globally
RUN npm install -g moltbot@latest

# Create SSH runtime directory
RUN mkdir -p /var/run/sshd

# Configure SSH Server
# - Change port to 2222
# - Allow root login
# - Enable password authentication
RUN sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config &amp;&amp; \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config &amp;&amp; \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Set root password (⚠️  CHANGE THIS IN PRODUCTION!)
RUN echo "root:moltbot123" | chpasswd

# Expose SSH port
EXPOSE 2222
EXPOSE 18789

# Set working directory
WORKDIR /root

# Start SSH daemon in foreground mode to keep container running
CMD ["/usr/sbin/sshd", "-D", "-p", "2222"]
</code></pre>
<h3 data-id="heading-3">2.构建你的专属容器</h3>
<p>端口号支持完全自定义，你可以根据现有网络环境或安全策略自由配置监听端口，避免与本机或服务器上已有服务产生冲突。通过自定义端口，不仅可以更好地融入现有的反向代理、防火墙或内网访问体系，也便于在多实例、多环境（如测试 / 生产）场景下同时运行 Moltbot，提高整体部署的灵活性与可控性。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 根据dockerfile构建容器</span>
docker build -f Dockerfile.ssh -t moltbot-ssh:latest .

docker run -d -p 2222:2222 --name moltbot-ssh moltbot-ssh:latest

<span class="hljs-comment"># ssh连接你的容器</span>
ssh root@&lt;ip&gt; -p 2222
<span class="hljs-comment"># 密码为：moltbot123 你可以按需在Dockerfile中配置你的密码</span>
</code></pre>
<h2 data-id="heading-4">3.进入你的moltbot内配置</h2>
<p>以下操作均在通过 SSH 连接至服务器后进行。请确保已成功登录目标主机，并具备相应的系统权限（如普通用户或 sudo 权限）。所有配置与运行过程均在远程服务器环境中完成，不会直接影响本地设备的文件系统或运行环境，适合用于云端隔离部署或长期在线运行场景。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化配置文件和工作目录</span>
moltbot setup

moltbot config <span class="hljs-built_in">set</span> gateway.port 18789
moltbot config <span class="hljs-built_in">set</span> gateway.mode <span class="hljs-string">"local"</span>
moltbot config <span class="hljs-built_in">set</span> gateway.bind <span class="hljs-string">"lan"</span>
moltbot config <span class="hljs-built_in">set</span> agents.defaults.workspace <span class="hljs-string">"/root/molt"</span>

<span class="hljs-comment"># 此命令可选（如果你需要自定义模型，编辑moltbot.json）</span>
vim .moltbot/moltbot.json

<span class="hljs-comment"># 修复一下moltbot.json以免失败</span>
moltbot doctor --fix

<span class="hljs-comment"># 禁用配置自动重载（推荐） 或者moltbot config set gateway.reload.mode "hot" 热加载不重启</span>
moltbot config <span class="hljs-built_in">set</span> gateway.reload.mode <span class="hljs-string">"off"</span>

<span class="hljs-comment"># 创建新的窗口，启动gateway(控制平面)</span>
tmux new -s molt
moltbot gateway run --<span class="hljs-built_in">bind</span> lan --port 18789
<span class="hljs-comment"># 使用ctrl+B 再按D退出，再次进入使用tmux attach -t molt</span>

<span class="hljs-comment"># 运行配置向导，你可以按需配置skills和其他选项</span>
moltbot onboard --install-daemon

<span class="hljs-comment"># 你可以依次选择</span>
-&gt; I understand this is powerful and inherently risky. Continue? (Yes)
-&gt; Onboarding mode (QuickStart)
-&gt; Config handling (Use existing values)
-&gt; Model/auth provider (Skip <span class="hljs-keyword">for</span> now) <span class="hljs-comment"># 或者选择你的模型</span>
-&gt; Filter models by provider (deepseek) <span class="hljs-comment"># 或者选择你自定义的模型</span>
-&gt; Default model (Keep current (deepseek/deepseek-chat))
-&gt; Select channel (QuickStart) (Skip <span class="hljs-keyword">for</span> now)
-&gt; Configure skills now? (No) 按需配置
-&gt; Enable hooks? (Skip <span class="hljs-keyword">for</span> now)
-&gt; How <span class="hljs-keyword">do</span> you want to hatch your bot? (Hatch <span class="hljs-keyword">in</span> TUI (recommended))
</code></pre>
<h3 data-id="heading-5">4.配置成功</h3>
<p>当出现如下界面时，你的机器人配置成功了，现在你可以跟他对话了！
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ff20680e8e849acbd5bf2ef23a95a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=ek%2FXS2SisT%2F%2F3BNpMv3FKBZ9oZs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6">5.注意事项</h3>
<p>如果你的模型在moltbot内未支持或者你想使用你自定义的模型，比如deepseek、kimi等，你可以编辑.moltbot/moltbot.json，将agents和models替换为如下内容.</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"defaults"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"primary"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deepseek/deepseek-chat"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"deepseek/deepseek-chat"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                    <span class="hljs-attr">"alias"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"DeepSeek Chat"</span>
                <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"merge"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"deepseek"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.deepseek.com/v1"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"YOUR_DEEPSEEK_API_KEY"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openai-completions"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                    <span class="hljs-punctuation">{</span>
                        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deepseek-chat"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"DeepSeek Chat"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"reasoning"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"cost"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                            <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                            <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                            <span class="hljs-attr">"cacheRead"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                            <span class="hljs-attr">"cacheWrite"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
                        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"contextWindow"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">64000</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"maxTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8192</span>
                    <span class="hljs-punctuation">}</span>
                <span class="hljs-punctuation">]</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-7">三、创建你的专属Telegram回复机器人</h2>
<ol>
<li>打开 Telegram，在聊天列表页面下拉搜索 @BotFather，并进入官方 Bot 管理对话。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5eab9b585ba470eae07852acb384d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=o4Z9g90O%2Bm0ASUZbyYe5D6AxwXg%3D" alt="在这里插入图片描述" loading="lazy"/></li>
<li>在对话中发送 /newbot 指令，用于创建一个新的 Telegram 机器人。</li>
<li>按照 BotFather 的提示，为你的机器人设置显示名称和用户名。
○ 用户名必须以 bot 结尾
○ 且不能与现有机器人重复</li>
<li>创建完成后，BotFather 会向你发送机器人的 访问链接 和 Bot API Token。
请妥善保存该 Token，它将用于 Moltbot 与 Telegram 的连接，格式类似：</li>
</ol>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">1234567890:ABCdefGHIjklMNOpqrsTUVwxyz</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f15e03f62d7849c6bbde01c7f1cb0811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=vN6RoTsj7UXUHYLP8LEPNyHRz%2Fo%3D" alt="在这里插入图片描述" loading="lazy"/>
5.打开 Moltbot 的配置界面，选择 Telegram（Bot API） 作为消息通道，并将上一步获得的 API Token 填入对应配置项中，保存配置。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb1205be61fb4d0db9a94283bcd27b7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=ABwwkuQ7bfM9%2BqQ6KXsYn3zlLhA%3D" alt="在这里插入图片描述" loading="lazy"/>
将API Token填入下面，填入后继续执行，可能需要重启一下gatewey和TUI
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a762d9992a4a4eb439a0f75035cb95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=b%2FQWd%2FatoBXPcn8gYq1gvXfqjQ4%3D" alt="在这里插入图片描述" loading="lazy"/>
6.配置完成后，在 Telegram 中进入该机器人的聊天页面，发送 /start 指令。机器人将返回一个 pairing code。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60407a74d36d40f89d9fd0a5d804a881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=xcwwHFEDAOatYXFXE4%2FzQb%2Bchs0%3D" alt="在这里插入图片描述" loading="lazy"/>
○ 将该 code 直接复制并粘贴到 Moltbot 的聊天回复配置中
○ 或使用命令：</p>
<pre><code class="hljs language-css" lang="css">moltbot pairing approve telegram &lt;<span class="hljs-selector-tag">code</span>&gt;
</code></pre>
<p>完成配对后重新进入即可生效。
7. 配对成功后，在 Telegram 中向该机器人发送测试消息，若 Moltbot 能正常回复，即表示 Telegram 通道已成功关联。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194a5e21fb4e43ada05b03cb912fa883~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=bPyR29PWK8qHO%2FgnfIBHLdq9UmY%3D" alt="在这里插入图片描述" loading="lazy"/>
8.进行文件传输等功能测试，确认消息与文件均可正常收发，说明机器人已配置完成并运行正常。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af7eca119250470d967e967a16c8a45a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlEYXlEYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770338616&amp;x-signature=STGXg%2BMJnjPFgA3pFrkWVJ1js%2BI%3D" alt="在这里插入图片描述" loading="lazy"/>至此，Moltbot 已完成部署并成功接入 Telegram。你现在可以仅通过手机上的聊天软件，对服务器和个人数字工作流进行集中控制：下发指令、触发自动化任务、接收系统状态与实时通知，所有操作都无需再直接登录服务器或打开电脑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[强化学习比你想象的还要更为低效...]]></title>    <link>https://juejin.cn/post/7600622206269947914</link>    <guid>https://juejin.cn/post/7600622206269947914</guid>    <pubDate>2026-01-30T02:20:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206269947914" data-draft-id="7600678255041396745" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="强化学习比你想象的还要更为低效..."/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2026-01-30T02:20:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            强化学习比你想象的还要更为低效...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:20:52.000Z" title="Fri Jan 30 2026 02:20:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 为什么在强化学习（RL）中，模型往往需要消耗比有监督学习多出数个数量级的计算资源，却只能换来看似微薄的性能提升，且常常陷入训练不稳定的泥潭？</p>
<p>本文从信息论角度出发，对比了有监督学习与强化学习在单位样本中可获取信息量的根本差异：前者通过明确的正确标签直接提供高信息密度的学习信号，而后者仅依赖二元的成功/失败反馈，其信息熵在通过率极低或极高时趋近于零。作者进一步指出，只有当模型的“通过率”处于约 50% 的“金发姑娘区”时，RL 才能高效学习，而这通常只出现在训练末期。此外，文章还剖析了 RL 中梯度估计方差巨大、容易被简单启发式策略主导、难以培养通用推理能力等深层问题，并反思了人类学习机制与当前 model-free RL 的本质差距。</p>
<p>这篇文章提醒我们：若想让强化学习真正释放其潜力，不能仅靠堆算力，而必须重新思考如何设计更密集、更结构化的反馈机制 —— 否则，我们可能只是在用极其昂贵的方式，重复确认一个早已写在预训练权重里的答案。</p>
</blockquote>
<p><strong>作者 | Dwarkesh Patel</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>最近，人们[1]一直在讨论[2]：在强化学习（RL）中生成单个样本所需的计算量（FLOPs）远高于有监督学习（supervised learning）。<strong>在预训练阶段</strong>，模型对每一个用于训练的 token 都能立即获得一个学习信号；<strong>而在 RL 中</strong>，必须展开一整条长达数万 tokens 的推理思维链，才能在最后得到一个奖励信号（例如，我写的代码单元测试是否通过？这道数学题的答案是否正确？等等）。</p>
<p>但这只是问题的一半。这里有一种简单的方法可以比较强化学习与有监督学习的学习效率：</p>
<p><strong>Bits/FLOP = Samples/Flop × Bits/Sample</strong></p>
<p>我还没听到有人讨论我们公式中的这一项：Bits/Sample（每个样本包含多少有用信息）。而且在训练的大部分阶段，强化学习的每一个样本所包含的“有效学习信息量”比有监督学习要低得多。</p>
<h2 data-id="heading-0"><strong>01 用大白话来说</strong></h2>
<p>在有监督学习（也就是预训练）中，模型只是在疯狂吸收信息（bits）。每一个 token 都像是一条线索，它不仅能帮你理解语言本身的构造，还能让你窥见创造这段语言的思维过程，以及那个思维所感知的现实世界。在训练初期，当你用一个完全随机初始化的模型时，你对这些内容都处于最大程度的不确定状态。因此，每个 token 都会让你“恍然大悟”。<strong>而且你会立刻得到一个精确的信号，知道自己对正确答案的预测错得多离谱，以及需要调整哪些参数来减少错误。</strong></p>
<p>假设你从一个随机初始化的模型开始，并启动训练。如果你使用有监督学习对 “The sky is” 这个短语做 next-token-prediction，那么训练循环会这样工作：“正确答案其实是 ‘blue’。你预测 ‘blue’ 的概率只有 0.001%。现在，请大幅加强那些本该指向 ‘blue’ 的连接权重。好了，下一个 token。”</p>
<p>而在使用策略梯度（policy gradient）的强化学习中，你会增加所有回答正确的轨迹的权重，并降低所有回答错误的轨迹的权重。<strong>但问题是，一个还没怎么学会东西的模型，几乎不可能凭运气就答对。</strong></p>
<p>如果你用 RL 来做“The sky is”的 next-token-prediction，训练循环大概会是这样：“好吧，‘halcyon’ 是错的，别再做导致输出‘halcyon’的操作了…… 好吧，‘serendipity’ 也是错的……” 然后就这样反复试错，猜错的次数差不多得有词汇表总量那么多（约 10 万次）。</p>
<h2 data-id="heading-1"><strong>02 详细分析</strong></h2>
<p>让我们思考一下：随着通过率（p）的变化，每个样本所能获得的最大信息量（bits/sample）会如何变化。<strong>这里的“通过率”指的是你给出正确答案的概率。</strong> 为简化起见，我们假设答案长度只有一个词元。那么，对于一个完全未经训练的模型，其通过率仅仅是 1/（词汇表大小）。</p>
<p>在有监督学习中，每个样本都会明确告诉你正确标签是什么。你学到的新信息量，取决于你看到正确答案时有多“惊讶” —— 你的通过率越低（即正确答案的先验概率越小），你从这个标签中学到的东西就越多。信息熵的基本公式告诉我们：在有监督学习中，你从每个样本中最多可以学到 -log(p) bits 的信息。</p>
<p>而在强化学习中，你只会被告知答案是否正确。你能从中提取的信息量，受限于你对这个二元结果（对/错）的不确定性。如果你几乎总是通过（p ≈ 1）或几乎总是失败（p ≈ 0），那么每次试验都很难让你感到意外。<strong>当通过的概率像抛硬币一样时（p ≈ 0.5），你学到的东西最多。</strong> 对于一个二元随机变量，其信息量的上限由熵公式给出：在 RL 中，你从每个样本中最多能学到 Entropy(p) = -p log(p) - (1-p) log(1-p)1 bits 的信息。</p>
<p>好，我们来画图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be618892de2c417da02b7fd8800fd17b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344453&amp;x-signature=42XXY9MFT003sVxHT4DsOctjcxc%3D" alt="image.png" loading="lazy"/></p>
<p>看起来还不算太糟。是的，在通过率前 50% 的范围内，预训练明显更好，但在后 50% 的范围内，强化学习表现更佳。然而，这张图极具误导性。<strong>根据缩放定律（scaling laws）中的幂律关系，每当你想把“通过率”（pass rate）提升一个数量级，你都需要投入大致相同量级的计算资源。</strong> 如果你花了 X FLOPs 将通过率从 1/100,000 提升到 1/10,000，那么你也需要 X FLOPs 才能将通过率从 1/10,000 提升到 1/1,000。因此，我们应该使用对数刻度来表示通过率 —— 以便使 X 轴的每一单位增量对应于相同数量的计算开销（FLOPs）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ab30a2cbed14b66b6d0a07d6a6db7b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344453&amp;x-signature=MApSMnaiAdk9mtHZs8t3dXF582U%3D" alt="image.png" loading="lazy"/></p>
<p>这张图看起来真令人沮丧。强化学习在样本信息密度上与预训练相当的区域，仅仅是训练末期的一小段，而且此时模型本身已经相当不错了。</p>
<p>再次强调，这一问题完全独立于另一个观点：即从强化学习中获取单个样本（也就是在得到任何信号前必须完整展开一整条推理轨迹）可能需要耗费高出数百万倍的计算量。</p>
<h2 data-id="heading-2"><strong>03 方差（variance）让实</strong> <strong>际情况甚至比这更糟</strong></h2>
<p>训练初期的强化学习，实际情况其实比上面描述的更为严峻。<strong>当通过率很低时，对梯度的估计会变得极其混乱且难以预测。</strong> 要么在当前 batch 生成的样本中，根本就没有采样到正确答案，在这种情况下，几乎得不到任何有用的学习信号。要么碰巧采样到了一次，然后就会得到一个巨大的梯度峰值。模型的训练过程会被剧烈地、不规则地“拉扯”（梯度忽大忽小、方向混乱），如果要追求高效、稳定的训练，这样是非常糟糕的。2</p>
<p>有趣的是，预训练的问题恰好相反，方差（variance）在训练末期会变得非常高。随着预训练的推进，你会逐渐耗尽那些可约损失（reducible loss，即模型实际能从数据中学到的东西）。剩下的主要都是不可约损失（irreducible loss），不可约损失指的是网络文本数据固有的不可预测性。</p>
<p>提示词 “Bob’s favorite color is” 应该怎么结尾？这完全取决于 Bob 是谁。对于这种问题，并不存在什么标准正确答案能让你的超级智能模型通过训练达到很高的预测准确率。但是，模型仍然会根据某人在网上留下的随机答案，获得梯度更新（gradient update）。而这种噪音，会淹没当前 batch 中少数几个真正可学习的词元为我们提供的真实信号。<strong>我不知道这是否准确，但预训练阶段末期出现的这种方差激增，似乎与为什么在预训练过程中需要增大 batch sizes 有关。</strong></p>
<h2 data-id="heading-3"><strong>04 进入 RL 的“金发姑娘区”（Goldilocks zone）</strong></h2>
<p>如果 RL 在通过率远高于 1% 时效果最佳，那么这就引出了一个问题：我们该如何设计 RL 训练过程，才能让模型进入并维持在这个高效学习的状态中？</p>
<p>例如，在进行强化学习（RL）时，我们可以通过“预训练更多的数据”和“增加推理时的计算量（比如让模型想得更久）”这两种方式，来让模型变得更聪明、回答得更准确，提高模型的“通过率”，从而让每个样本带来更多的有效信息（bits）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6380dc2f9c57455e89d4d6c3db19deb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344453&amp;x-signature=BGIQcG2NS%2Fx%2BrPJ%2BploUTRs85cA%3D" alt="image.png" loading="lazy"/></p>
<p>有观点指出，课程学习（curriculum learning）在预训练中作用不大[3]，但在 RL 中却常常不可或缺[4]。这完全说得通 —— 因为 RL 只有在通过率处于这个“金发姑娘区”时，每个样本才能带来有意义的信息量。<strong>因此，为了训练效果好，你必须精心安排学习内容的顺序，要保证问题的难度是随着模型能力的提升而同步加难的，不要一下子给太难的题，也不要一直做太简单的题。</strong></p>
<p>作者提出的“通过率”理论可以很好地解释为什么“自我对弈”（像 AlphaGo 那样自己跟自己下棋）在强化学习历史上特别管用。因为当你跟一个水平旗鼓相当的对手比赛时，你赢的概率大约就是 50%。在这个理论中，50%是一个最佳状态，意味着每次比赛结果（输或赢）带给你的信息量是最大的，能让你学得最快。</p>
<p>但自我对弈并不是唯一能让训练过程中保持高通过率的方法。我们还可以设计出一种“proxy evaluation”机制，这种机制能提供更密集的反馈信息。这里的“密集”具体指以下两种情况之一：</p>
<p>1）Samples/FLOP 密度：通过“proxy evaluation”方法，我们可以在一个强化学习回合刚开始不久时就估算出最终的奖励，而不必真的把整个过程跑完，从而省去了后续的大量计算消耗。这种机制其实就是所谓的“价值函数”。</p>
<p>2）Bits/Sample 密度：我们可以设计一个比最终目标更易达成的 proxy objectives 来指导模型。我能想到的最简单例子是过程奖励模型（process-reward model），它会这样说：“嘿，这次生成的答案虽然错了，但我看得出来，它一开始的推理方向是对的。那我们就给这些早期的 token 增加一点权重。”</p>
<p>Deepseek R1[5] 论文的 4.2 节讨论并解释了，为什么直到现在，要为大语言模型开发出像这样好用的 proxy objectives 依然是一件很难的事情。</p>
<h2 data-id="heading-4"><strong>05 信息量虽少，但价值高</strong></h2>
<p>虽然在强化学习中，每单位计算量（FLOP）学到的 bits 确实少得多，<strong>但这些 bits 却非常重要，它们与预训练中获得的 bits 信息不能简单地相提并论。</strong> 这其中主要有两个关键原因：</p>
<ul>
<li>预训练就像是让模型把互联网上现有的数据全记下来，但这种知识与“如何完成具有经济价值的任务”只有部分且间接的关联；而强化学习则是直接教模型怎么去解决那些真正有用、能产生价值的实际问题。</li>
<li>即使预训练语料中包含了完成某项任务的“操作说明”（比如教程、具体步骤或答案），它也缺少一种关键的东西 —— “思维轨迹”（thinking trace）。也就是说，数据里没有展示模型犯错时是怎么自我纠正的，也没有展示如何利用模型独特的、非人类的方式去组合技能来解决问题。而这些深层的思考痕迹，正是强化学习能提供的东西。</li>
</ul>
<p>反驳的观点认为，虽然这些信息很有价值，但它们只在一个非常窄的通过率范围内（比如模型已经挺聪明了，但还没完全学会的时候）才能被获取。之所以要强调这一点，是因为在训练的大部分时间里，模型的通过率都极低（接近0），在对数尺度上看，这些低通过率的阶段占据了很大的比重，这意味着真正能高效学习的窗口期其实很短。</p>
<p>现在我们就能理解那些关于 RLHF/RL 仅能激发预训练模型中已有的潜在能力的说法了[6]。事实当然如此。<strong>如果预训练模型初始的通过率不够高，那么强化学习的 bits/sample 就会低得可怜，从而根本无法进行有效学习。</strong> 围棋对战中的“第 37 手”是一个非常著名的案例，它证明了强化学习确实能教给模型一种全新的、前所未有的策略。值得注意的是，AlphaGo 是通过自我对弈训练出来的（见上文关于自我对弈如何提高通过率的论述），而且以当时的标准来看[7]，其计算消耗之巨令人吃惊。</p>
<h2 data-id="heading-5"><strong>06 强化学习的不均衡</strong></h2>
<p>人们指出，从经验上看，RLVR（强化学习 + 可验证奖励）实际上只是让模型将某种思维模式与特定问题类型关联起来，而并未真正培养出一种更通用的策略 —— 比如先退一步，再仔细思考最佳解法。</p>
<p>仔细想想。怎么会有模型在国际编程竞赛中达到世界顶尖水平，却同时在代码库中留下了大量本可预见的 Bug 和技术债务？</p>
<p>这种奇怪的不均衡该如何解释？也许 RLVR 无法区分一条成功的推理轨迹到底是模型通过某种通用的推理能力（举一反三）做出来的，还是仅仅靠死记硬背某种特定的解题模板（“看到这个形状就用这个套路”）做出来的。因为它没法区分这两种过程，所以模型可能学会了后者（简单的套路），而不是前者（通用的能力）。</p>
<p>当你使用策略梯度（policy gradient）进行 rollout（即让模型生成完整的行为序列）时，那种更复杂、更具泛化能力的策略几乎不可能被采样到；而简单的启发式策略却很容易被采样到，并随着训练不断被强化，出现频率越来越高，最终完全主导模型的行为（即达到“固定”状态）。<strong>与此同时，真正的通用策略则越来越难以被观察到，逐渐从训练过程中消失。</strong></p>
<p>那么问题来了，我们该如何搭建一座“短桥”，把简单的启发式解法，和那种更复杂、更具泛化能力的通用策略连接起来？而且，这座桥会不会随着任务时间跨度（time horizons）自然拉长而自动出现 —— 从而迫使模型发展出真正的泛化能力？</p>
<p>我担心的是，那种“先退一步、基于对世界的理解做出明智判断”的通用策略，即使在更长周期的任务中，也依然很难通过“可验证的奖励”（verifiable rewards）被有效识别和强化。<strong>因此，要解决这种不均衡问题，不能只靠扩大 RLVR 的规模，而必须设计更鲁棒的训练方法。</strong></p>
<h2 data-id="heading-6"><strong>07 人类的学习方式</strong></h2>
<p>本节我们讨论的只是 model-free RL —— 也就是仅从一个强化学习周期结束时的二元结果（成功/失败）中获得的信息量（bits/sample）。但显然，人类的学习效率远高于此。想想假如有一位连续创业者，我们会说她拥有大量来之不易的智慧和经验。而这些学习成果中，极少部分真正来自上一次创业的“one bit”结果（即创业成功与否）。</p>
<p><strong>目前还不清楚，在机器学习中，人类这种从经验中学习的方式对应的是什么机制。</strong> 显然，我们的观察与反思会不断更新我们的世界模型（world model） —— 而且这种更新并不依赖于最终结果是成功还是失败。这在人类学习过程中起着非常重要的作用。</p>
<p>也许我们不该只是想着“如何把 model-free RL 的通过率调到 50% 左右，因为这样做仅仅是试图从一个单一的“成功/失败”结果中，挤出那么一点点微薄的信息。也许我们应该转换思路，去研究人类是如何从环境中获取海量信息的。<strong>人类并不像现在的机器那样，只盯着最终的结果（成功或失败），而是能从过程、观察和反思中吸收大量的经验和教训。</strong></p>
<p>1 这个公式的意思是：从一个二元结果中学到的信息量 ＝p(样本正确) × (样本正确时获得的信息量) ＋p(样本错误) × (样本错误时获得的信息量)。</p>
<p>2 感谢 Lukas Berglund 指出我此前在这一点上的阐述有误。</p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓人类从失败中能学到远不止“0/1”的反馈——你觉得 AI 系统要如何模拟这种过程性反思能力？</strong></p>
<p><strong>文中链接</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tobyord.com%2Fwriting%2Finefficiency-of-reinforcement-learning" target="_blank" title="https://www.tobyord.com/writing/inefficiency-of-reinforcement-learning" ref="nofollow noopener noreferrer">www.tobyord.com/writing/ine…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fthinkingmachines.ai%2Fblog%2Flora%2F%23how-much-capacity-is-needed-by-supervised-and-reinforcement-learning" target="_blank" title="https://thinkingmachines.ai/blog/lora/#how-much-capacity-is-needed-by-supervised-and-reinforcement-learning" ref="nofollow noopener noreferrer">thinkingmachines.ai/blog/lora/#…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2012.03107" target="_blank" title="https://arxiv.org/pdf/2012.03107" ref="nofollow noopener noreferrer">arxiv.org/pdf/2012.03…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F1707.05300" target="_blank" title="https://arxiv.org/pdf/1707.05300" ref="nofollow noopener noreferrer">arxiv.org/pdf/1707.05…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2501.12948" target="_blank" title="https://arxiv.org/abs/2501.12948" ref="nofollow noopener noreferrer">arxiv.org/abs/2501.12…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.07364v3" target="_blank" title="https://arxiv.org/abs/2510.07364v3" ref="nofollow noopener noreferrer">arxiv.org/abs/2510.07…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fepoch.ai%2Fdata%2Fai-models" target="_blank" title="https://epoch.ai/data/ai-models" ref="nofollow noopener noreferrer">epoch.ai/data/ai-mod…</a></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dwarkesh.com%2Fp%2Fbits-per-sample" target="_blank" title="https://www.dwarkesh.com/p/bits-per-sample" ref="nofollow noopener noreferrer">www.dwarkesh.com/p/bits-per-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[96%准确率！中科院提出ACLNet，攻克骨架动作识别最难问题：相似动作区分]]></title>    <link>https://juejin.cn/post/7600665529112641536</link>    <guid>https://juejin.cn/post/7600665529112641536</guid>    <pubDate>2026-01-30T02:28:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600665529112641536" data-draft-id="7600607462585565219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="96%准确率！中科院提出ACLNet，攻克骨架动作识别最难问题：相似动作区分"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-30T02:28:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            96%准确率！中科院提出ACLNet，攻克骨架动作识别最难问题：相似动作区分
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:28:52.000Z" title="Fri Jan 30 2026 02:28:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在计算机视觉领域，基于骨架的人体动作识别一直备受关注。相比传统视频流，骨架数据不仅计算高效，还对环境光照、背景干扰有着天然的免疫力。然而，骨架模型也有自己的“心病”：由于缺乏物体信息和精细的体型特征，它很难分清那些动作极其相似的行为，比如“读书”和“写字”、“喝水”和“擦嘴”。</p>
<p>为了解决这一难题，中国科学院、中国科学院大学、北京邮电大学以及月之暗面等机构的研究者们联合提出了一种名为 ACLNet 的新框架，全称为 亲和对比学习网络。</p>
<p>该研究已被IEEE生物识别、行为与身份科学汇刊（T-BIOM 2026）录用，相关代码已在GitHub开源。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfcda1a54fe340f09afe23b827e26240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=4WiRvWgUS%2BcbKNRhOTz1Q%2BiWhzY%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文地址：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.16694" target="_blank" title="https://arxiv.org/abs/2601.16694" ref="nofollow noopener noreferrer">arxiv.org/abs/2601.16…</a></strong></p>
<p><strong>代码仓库：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffirework8%2FACLNet" target="_blank" title="https://github.com/firework8/ACLNet" ref="nofollow noopener noreferrer">github.com/firework8/A…</a></strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>传统对比学习的局限</strong></h2>
<p>当前的骨架识别方法大多采用通用对比学习范式：让同类样本靠拢，异类样本远离。这种看似完美的方案在实际应用中存在两个关键痛点：</p>
<ol>
<li><strong>忽视了类间的结构共性：</strong> 有些动作虽然类别不同，但运动模式高度相似。比如“读书”和“喝水”都有手部向头部靠拢的轨迹。如果只是简单地把它们推开，模型很难学到真正细微的判别特征。</li>
<li><strong>类内异常样本的干扰：</strong> 由于拍摄角度、动作幅度差异，同一类动作里可能存在“离群”的正样本。这些样本容易与相似类别的负样本混淆，导致模型在特征空间中产生错误的聚类。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3237dc1d0824d1791b72bf7a1d01e8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=Q4JJg8qB2djrpdN91TMEeXtRKnI%3D" alt="图片2.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>ACLNet：引入“亲和力”的新视角</strong></h2>
<p>为了应对上述挑战，ACLNet提出了两套核心策略：<strong>类间亲和对比学习</strong> 和 <strong>类内边缘对比学习。</strong></p>
<ul>
<li><strong>核心架构与流程</strong></li>
</ul>
<p>ACLNet的整体流程清晰明了：</p>
<p>输入：包含N帧、V个关节、每关节C维特征的原始骨架序列</p>
<p>处理：利用图卷积网络提取时空特征，通过投影层映射到256维对比特征空间</p>
<p>输出：一方面通过分类头输出动作预测标签，另一方面通过亲和对比学习损失函数优化特征分布</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4ded09da5d94856a5d35f13d87df891~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=ITQ7J%2BAcupPlFXvYK0WZR%2Bykdxg%3D" alt="图片3.png" loading="lazy"/></p>
<ul>
<li><strong>创新点1：寻找“动作家族”</strong></li>
</ul>
<p>ACLNet的妙招在于引入亲和相似度概念，不再只看两个类别是否直接混淆，还会考察它们是否拥有共同的“朋友圈”。</p>
<p>具体计算分两步：</p>
<p>直接关联：通过混淆矩阵统计易混淆类别</p>
<p>间接关联：如果类别A和B都经常被误判为类别C，则A和B存在隐藏的结构共性</p>
<p>通过这种方式，模型将具有相似运动模式的类别聚合成一个个动作家族。在训练时，模型会针对家族内部成员进行更有针对性的对比优化。</p>
<p>配合这一概念，作者还设计了族群感知温度调度：当家族规模较小时，使用较小温度值放大硬负样本差异；家族规模较大时，适当放宽条件保持聚类稳定性。这种“因材施教”的策略让模型在不同粒度上都能保持敏锐。</p>
<ul>
<li><strong>创新点2：强力分离硬样本</strong></li>
</ul>
<p>针对类内异常样本，ACLNet引入类内边缘对比损失。它在正负样本之间强行加入边缘约束，即使某个正样本长得很像负样本，模型也会强制拉开它们之间的距离，实现更稳健的特征分离。</p>
<h2 data-id="heading-2"><strong>性能表现：刷榜多项主流数据集</strong></h2>
<p>ACLNet在六大主流基准数据集上展现出稳健性能：</p>
<ul>
<li><strong>动作识别任务</strong></li>
</ul>

<ul>
<li>NTU RGB+D 60：X-Sub准确率93.6%，刷新SOTA记录</li>
<li>NTU RGB+D 120：X-Sub准确率90.7%，同样达到SOTA水平</li>
<li>Kinetics-Skeleton：Top-1准确率52.1%，相比之前的SOTA方法DS-GCN有明显提升</li>
<li>FineGYM：细粒度动作识别准确率达96.0%，证明其在区分极细微动作差异方面的卓越能力</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a35cee1a479a4502b513e4e3484695c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=d%2FYPWzM0udVtzZHCZnoz5vaEERM%3D" alt="图片4.png" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60496918ae334ad3ae9b056fdee1bafc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=ZC1xJaRRCQBqaVe6WoVMHQQqGtg%3D" alt="图片5.png" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/377bf9e20ada4e929a7572e4b50a73bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=ta%2FBFvfMm3HtXPGKfSSCrdkDWVs%3D" alt="图片6.png" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ffab2a9c88643d6a8b60578e1d538c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=W3oBOhBXfucCrO%2BJOpsMFWWOLME%3D" alt="图片7.png" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee0fbe8efac4e5295089a11951351e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=OS0fgRjTbdoSHgbLORaew8V%2BilM%3D" alt="图片8.png" loading="lazy"/></p>
<ul>
<li><strong>生物特征识别任务</strong></li>
</ul>

<ul>
<li>CASIA-B步态识别：平均准确率88.5%</li>
<li>行人重识别：N-N设置下达到82.8%</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faaf501790eb4f63ac9e163161bb24ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=%2Fj6uEafeqpWLdDXwu8ZwsY%2FzBn8%3D" alt="图片9.png" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/492e1190051b4f918574fe63d41e6fec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=2uWyaGQbVd2NvQ3GlDXAA4P6WcM%3D" alt="图片10.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>实验中的有趣发现</strong></h2>
<ul>
<li><strong>“动作家族”可视化</strong></li>
</ul>
<p>消融实验中展示了“动作家族”的直观案例。比如“读书”和“穿夹克”这两个动作，模型通过亲和力建模，精准捕捉到了它们在手部和手臂轨迹上的结构共性。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59cbb453b2204ccea6799c80344664ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=QXz1IibTxioKFWSv5yxU82AH42k%3D" alt="图片11.png" loading="lazy"/></p>
<ul>
<li><strong>超参数敏感性</strong></li>
</ul>
<p>模型对边缘约束和损失权重的选择非常讲究。实验表明，当边缘约束设为0.3且权重为0.1时，模型能达到最优平衡。这说明适度的约束比过度惩罚更能引导模型学习到泛化性强的特征。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f9fa74e974c49f3851150b18fb6c3c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=PKQPXOInVp2CHpp8GysnfKXUZWI%3D" alt="图片12.png" loading="lazy"/></p>
<ul>
<li><strong>对噪声数据的鲁棒性</strong></li>
</ul>
<p>ACLNet对噪声数据表现出极强的鲁棒性。在模拟遮挡的极端情况下（如缺少双臂或双腿），ACLNet的识别准确率依然大幅领先传统模型。</p>
<p>例如在缺少“双手”的情况下，ACLNet仍能保持79.6%的准确率，而经典模型MS-G3D仅剩17.1%。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19c7c90ba4f8484babfa17963907cbe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=YGP7KgUru7hzc98M5NtnrSBIRv8%3D" alt="图片13.png" loading="lazy"/></p>
<ul>
<li><strong>攻克相似动作“深水区”</strong></li>
</ul>
<p>类间改进差异分析显示，ACLNet提升最明显的正是传统模型最头疼的“重灾区”，如“打喷嚏/咳嗽”、“读书”和“打字”。这些动作在骨架空间中极其接近，但ACLNet通过亲和力约束，在特征空间中开辟了专属领地。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d49d9ae5df8b4748929fb3ada505e768~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=js5TqckvwkdX2SQ3v6lxvnpsL8U%3D" alt="图片14.png" loading="lazy"/></p>
<p>t-SNE可视化显示，随着训练进行，原本混杂的相似动作在特征空间中逐渐分离，聚类变得更加紧凑清晰。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b4ae6446813441383fc3b7ca138a096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344931&amp;x-signature=bTnnzAtDT%2BSwNV4lTE2wph1CyuM%3D" alt="图片15.png" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>结论</strong></h2>
<p>本文提出ACLNet——一种基于骨架的人类活动理解亲和对比学习网络。具体而言，我们的方法通过两大创新突破了现有技术的局限：首先引入亲和相似性概念，用于建模难分类别的语义关系，并通过跨类亲和学习实现针对性优化； 其次，我们提出边缘对比策略，通过显式控制困难正样本与负样本的分离度，增强了模型对类内变异的鲁棒性。在六个基准数据集上的广泛实验验证了ACLNet在骨架动作识别、步态识别及人脸再识别任务中的有效性。所提出的亲和建模范式为精细化活动分析与行为生物特征识别开辟了新路径，在安全防护、医疗健康及人机交互领域具有广阔应用前景。  </p>
<h2 data-id="heading-5"><strong>技术实现与开源</strong></h2>
<p>该项目已在GitHub开源，使用单张RTX 3090即可复现实验。代码结构清晰，模块化设计便于扩展和修改，为从事行为识别、步态分析或生物特征识别的研究者提供了一个扎实的基准模型。</p>
<p>ACLNet的突破在于告诉我们：对比学习不应只是简单地“拉近”和“推开”。通过引入“亲和力”这一维度，模型能够像人类一样理解动作之间的逻辑关联，从而在细微处见真章。</p>
<p>这一创新不仅提升了骨架动作识别的准确性，更为对比学习在复杂场景下的应用提供了新思路。随着相关代码的开源，我们期待看到更多研究者在此基础上开发出更加强大和智能的动作理解系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[文档切分实战：5种方法详解，打造高效RAG系统的第一步]]></title>    <link>https://juejin.cn/post/7600600904095006754</link>    <guid>https://juejin.cn/post/7600600904095006754</guid>    <pubDate>2026-01-29T12:00:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600600904095006754" data-draft-id="7600600904094941218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="文档切分实战：5种方法详解，打造高效RAG系统的第一步"/> <meta itemprop="keywords" content="机器学习"/> <meta itemprop="datePublished" content="2026-01-29T12:00:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狸猫算君"/> <meta itemprop="url" content="https://juejin.cn/user/643654644149178"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            文档切分实战：5种方法详解，打造高效RAG系统的第一步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/643654644149178/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狸猫算君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:00:39.000Z" title="Thu Jan 29 2026 12:00:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么文档切分是RAG的“灵魂一步”？</h2>
<p>大家好，我是专注于AI技术实践分享的博主狸猫算君~今天我们来聊聊RAG（检索增强生成）技术中那个看似简单却至关重要的环节——<strong>文档切分</strong>。</p>
<p>想象一下这个场景：你有一个几百页的产品手册，想让AI助手根据手册内容回答用户问题。如果直接把整个手册扔给模型，就像让人一眼看完百科全书再答题，效果可想而知。而文档切分，就是把这本“百科全书”拆分成一个个有逻辑的“知识点卡片”，让模型能快速找到最相关的那几页。</p>
<p>在实际应用中，文档切分质量直接决定了：</p>
<ul>
<li><strong>问答准确性</strong>：切得不好，模型可能检索到不完整的上下文</li>
<li><strong>响应速度</strong>：合理的分块能提升检索效率</li>
<li><strong>成本控制</strong>：减少不必要的token消耗</li>
</ul>
<p>无论是构建企业知识库、智能客服还是个人AI助手，掌握文档切分都是让大模型真正“理解”你专属数据的关键第一步。</p>
<h2 data-id="heading-1">技术原理：五大切分策略，哪种适合你的场景？</h2>
<h3 data-id="heading-2">1. 按句子切分：最自然的语义单元</h3>
<p><strong>核心思想</strong>：按照自然语言的标点符号（句号、感叹号、问号等）进行分割。<br/>
<strong>优点</strong>：保持了完整的语义边界，最符合人类阅读习惯<br/>
<strong>适用场景</strong>：普通文章、报告、邮件等自然语言文档</p>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">def</span> <span class="hljs-title function_">split_by_sentences</span>(<span class="hljs-params">text</span>):
    <span class="hljs-comment"># 匹配中英文句末标点</span>
    pattern = <span class="hljs-string">r"[。！？.!?]+"</span>
    sentences = re.split(pattern, text)
    <span class="hljs-keyword">return</span> [s.strip() <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> sentences <span class="hljs-keyword">if</span> s.strip()]

<span class="hljs-comment"># 示例：一段描述春节的文字</span>
text = <span class="hljs-string">"春节的脚步越来越近，大街小巷都布满了节日的气氛。商店门口挂满了红灯笼和春联..."</span>
chunks = split_by_sentences(text)
</code></pre>
<h3 data-id="heading-3">2. 固定字符数切分：简单粗暴的均匀分割</h3>
<p><strong>核心思想</strong>：像切香肠一样，每段固定长度，不考虑语义完整性。<br/>
<strong>优缺点</strong>：实现简单，但可能从句子中间切断<br/>
<strong>适用场景</strong>：日志文件、代码、结构化数据</p>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_by_length</span>(<span class="hljs-params">text, chunk_size=<span class="hljs-number">100</span></span>):
    <span class="hljs-keyword">return</span> [text[i:i+chunk_size] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(text), chunk_size)]
</code></pre>
<h3 data-id="heading-4">3. 固定字符数+重叠窗口：平衡的折中方案</h3>
<p><strong>核心思想</strong>：在固定长度的基础上，让相邻块有一定重叠，防止关键信息被切断。</p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">def split_with_overlap(text, <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">100</span>, overlap=<span class="hljs-number">20</span>):
    <span class="hljs-attr">chunks</span> = []
    <span class="hljs-attr">start</span> = <span class="hljs-number">0</span>
    while start &lt; len(text):
        <span class="hljs-attr">end</span> = start + chunk_size
        chunks.append(text<span class="hljs-section">[start:end]</span>)
        start += chunk_size - overlap  <span class="hljs-comment"># 滑动窗口，保留重叠部分</span>
    return chunks
</code></pre>
<p><strong>为什么需要重叠？</strong><br/>
假设我们查询“小朋友们在做什么”，如果关键信息“看到小朋友们手持烟花棒，欢笑声此起彼伏”刚好被切到两个块之间，没有重叠就会丢失上下文。有重叠窗口能确保关键信息在至少一个块中完整存在。</p>
<h3 data-id="heading-5">4. 递归切分：LangChain的默认选择</h3>
<p><strong>核心思想</strong>：智能分层切割，优先用换行符分割，不行再用空格，最后用字符。<br/>
<strong>工作流程</strong>：</p>
<ol>
<li>先用<code>\n\n</code>（空行）尝试分割</li>
<li>如果块还太大，用<code>\n</code>（换行）分割</li>
<li>继续用空格分割，最后用字符分割</li>
<li>确保每个块接近但不超预设大小</li>
</ol>
<p><strong>优势</strong>：在保持语义和均匀大小之间取得最佳平衡</p>
<h3 data-id="heading-6">5. 语义切分：未来方向</h3>
<p><strong>核心思想</strong>：用嵌入模型计算语义相似度，在语义变化处切分。<br/>
<strong>技术实现</strong>：计算句子向量，检测向量距离突变点<br/>
<strong>现状</strong>：效果最好但计算成本高，适合对质量要求极高的场景</p>
<h2 data-id="heading-7">实践步骤：从零开始实现文档切分</h2>
<h3 data-id="heading-8">环境准备</h3>
<p>python</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础环境</span>
pip install langchain langchain-text-splitters

<span class="hljs-comment"># 可选：用于处理特定格式</span>
pip install pypdf markdown
</code></pre>
<h3 data-id="heading-9">步骤一：处理普通文本文件</h3>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.text_splitter import RecursiveCharacterTextSplitter

<span class="hljs-comment"># 1. 读取文档</span>
with open("document.txt", "r", <span class="hljs-attr">encoding</span>=<span class="hljs-string">"utf-8"</span>) as f:
    <span class="hljs-attr">text</span> = f.read()

<span class="hljs-comment"># 2. 初始化分割器（推荐参数）</span>
<span class="hljs-attr">splitter</span> = RecursiveCharacterTextSplitter(
    <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">500</span>,      <span class="hljs-comment"># 每个块约500字符</span>
    <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">50</span>,    <span class="hljs-comment"># 重叠50字符保持连贯</span>
    <span class="hljs-attr">separators</span>=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]  <span class="hljs-comment"># 分层分割策略</span>
)

<span class="hljs-comment"># 3. 执行分割</span>
<span class="hljs-attr">chunks</span> = splitter.split_text(text)
print(f"总文档切分为 {len(chunks)} 个块")
</code></pre>
<h3 data-id="heading-10">步骤二：处理特殊格式文档</h3>
<p>不同的文档类型需要不同的处理策略：</p>
<p><strong>Markdown文档</strong>（保持标题结构）：</p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.text_splitter import MarkdownHeaderTextSplitter

<span class="hljs-attr">headers_to_split_on</span> = [
    (<span class="hljs-string">"#"</span>, <span class="hljs-string">"主标题"</span>),
    (<span class="hljs-string">"##"</span>, <span class="hljs-string">"二级标题"</span>),
    (<span class="hljs-string">"###"</span>, <span class="hljs-string">"三级标题"</span>),
]

<span class="hljs-attr">splitter</span> = MarkdownHeaderTextSplitter(headers_to_split_on)
<span class="hljs-attr">md_chunks</span> = splitter.split_text(markdown_content)
</code></pre>
<p><strong>PDF文档</strong>（先提取文本）：</p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">from PyPDF2 import PdfReader
from langchain.text_splitter import RecursiveCharacterTextSplitter

<span class="hljs-attr">reader</span> = PdfReader(<span class="hljs-string">"document.pdf"</span>)
<span class="hljs-attr">text</span> = <span class="hljs-string">""</span>
for page in reader.pages:
    text += page.extract_text()

<span class="hljs-attr">splitter</span> = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>)
<span class="hljs-attr">pdf_chunks</span> = splitter.split_text(text)
</code></pre>
<p><strong>代码文件</strong>（按语言特性分割）：</p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.text_splitter import Language, RecursiveCharacterTextSplitter

<span class="hljs-comment"># 支持Python、Java、JavaScript等15种语言</span>
<span class="hljs-attr">python_splitter</span> = RecursiveCharacterTextSplitter.from_language(
    <span class="hljs-attr">language</span>=Language.PYTHON,
    <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">400</span>,
    <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">40</span>
)
<span class="hljs-attr">code_chunks</span> = python_splitter.split_text(python_code)
</code></pre>
<h3 data-id="heading-11">步骤三：参数调优实战</h3>
<p>参数选择没有“银弹”，需要根据数据特点调整：</p>
<ol>
<li>
<p><strong>chunk_size选择指南</strong>：</p>
<ul>
<li>问答系统：200-500字符（精准匹配）</li>
<li>文档总结：800-1500字符（上下文完整）</li>
<li>代码分析：300-600字符（函数级完整）</li>
</ul>
</li>
<li>
<p><strong>chunk_overlap经验值</strong>：</p>
<ul>
<li>一般为chunk_size的10%-20%</li>
<li>重要文档可以增加到25%</li>
</ul>
</li>
<li>
<p><strong>快速测试脚本</strong>：</p>
</li>
</ol>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_chunking_params</span>(<span class="hljs-params">text, size, overlap</span>):
    splitter = RecursiveCharacterTextSplitter(
        chunk_size=size,
        chunk_overlap=overlap
    )
    chunks = splitter.split_text(text)
    
    <span class="hljs-comment"># 统计信息</span>
    avg_len = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> chunks) / <span class="hljs-built_in">len</span>(chunks)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数：size=<span class="hljs-subst">{size}</span>, overlap=<span class="hljs-subst">{overlap}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span>，平均长度：<span class="hljs-subst">{avg_len:<span class="hljs-number">.0</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"前3个块示例：\n<span class="hljs-subst">{chunks[:<span class="hljs-number">3</span>]}</span>\n"</span>)
    
    <span class="hljs-keyword">return</span> chunks

<span class="hljs-comment"># 测试不同参数</span>
test_chunking_params(your_text, <span class="hljs-number">300</span>, <span class="hljs-number">30</span>)
test_chunking_params(your_text, <span class="hljs-number">500</span>, <span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-12">步骤四：质量检查与修复</h3>
<p>切分后务必人工检查：</p>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_chunk_quality</span>(<span class="hljs-params">chunks</span>):
    issues = []
    <span class="hljs-keyword">for</span> i, chunk <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(chunks):
        <span class="hljs-comment"># 检查是否从句子中间切断</span>
        <span class="hljs-keyword">if</span> chunk <span class="hljs-keyword">and</span> chunk[-<span class="hljs-number">1</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">"。.?!！？"</span>:
            issues.append(<span class="hljs-string">f"块<span class="hljs-subst">{i}</span>可能不完整"</span>)
        
        <span class="hljs-comment"># 检查长度是否异常</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(chunk) &lt; <span class="hljs-number">50</span>:
            issues.append(<span class="hljs-string">f"块<span class="hljs-subst">{i}</span>过短：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk)}</span>字符"</span>)
    
    <span class="hljs-keyword">return</span> issues

<span class="hljs-comment"># 执行检查</span>
issues = check_chunk_quality(chunks)
<span class="hljs-keyword">if</span> issues:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"发现以下问题："</span>)
    <span class="hljs-keyword">for</span> issue <span class="hljs-keyword">in</span> issues:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{issue}</span>"</span>)
</code></pre>
<h2 data-id="heading-13">效果评估：如何验证切分质量？</h2>
<p><img src="https://p3-volc-community-sign.byteimg.com/tos-cn-i-tlddhu82om/0bc57c98decf457e85fb9dbf2a9227e1~tplv-tlddhu82om-image.image?=&amp;rk3s=8031ce6d&amp;x-expires=1769774406&amp;x-signature=dahzJTYc91sz6dwnjYUl1GobSLo%3D" alt="13414161591326003.jpeg" loading="lazy"/></p>
<h3 data-id="heading-14">量化评估指标</h3>
<ol>
<li><strong>检索准确率测试</strong>：</li>
</ol>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模拟查询测试</span>
test_queries = [<span class="hljs-string">"文档提到哪些关键点？"</span>, <span class="hljs-string">"具体操作步骤是什么？"</span>]
<span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> test_queries:
    <span class="hljs-comment"># 检索相关块（简单模拟）</span>
    relevant_chunks = retrieve_chunks(query, chunks)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询：<span class="hljs-subst">{query}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"检索到<span class="hljs-subst">{<span class="hljs-built_in">len</span>(relevant_chunks)}</span>个相关块"</span>)
    <span class="hljs-comment"># 人工评估相关性...</span>
</code></pre>
<ol start="2">
<li>
<p><strong>块完整性评分</strong>（0-1分）：</p>
<ul>
<li>1分：完整句子/段落</li>
<li>0.5分：语义基本完整</li>
<li>0分：明显截断</li>
</ul>
</li>
<li>
<p><strong>重叠必要性分析</strong>：</p>
<ul>
<li>统计有多少查询需要跨块信息</li>
<li>计算重叠部分的使用频率</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">真实场景测试建议</h3>
<ol>
<li><strong>准备测试集</strong>：包含各种类型的查询</li>
<li><strong>A/B测试</strong>：比较不同切分策略的问答效果</li>
<li><strong>用户反馈收集</strong>：实际使用中的准确率</li>
</ol>
<p><strong>经验法则</strong>：好的切分应该让AI回答时像“引用书中的某一页”，而不是“复述整本书”。</p>
<h2 data-id="heading-16">总结与展望</h2>
<h3 data-id="heading-17">核心要点回顾</h3>
<ol>
<li><strong>没有最好，只有最适合</strong>：根据文档类型选择切分策略</li>
<li><strong>参数需要调优</strong>：chunk_size和overlap需要实验确定</li>
<li><strong>格式感知</strong>：不同格式文档使用专用分割器</li>
<li><strong>质量检查必不可少</strong>：自动检查+人工抽样</li>
</ol>
<h3 data-id="heading-18">常见误区提醒</h3>
<ul>
<li>❌ 盲目追求小块：可能导致上下文不足</li>
<li>❌ 忽视重叠窗口：可能切断关键信息</li>
<li>❌ 一成不变：不同文档可能需要不同策略</li>
<li>❌ 忽视格式：PDF、Word需要先正确提取文本</li>
</ul>
<h3 data-id="heading-19">未来发展趋势</h3>
<ol>
<li><strong>自适应切分</strong>：AI自动学习最佳切分参数</li>
<li><strong>多模态切分</strong>：同时处理文本、表格、图片</li>
<li><strong>实时动态切分</strong>：根据查询动态调整块大小</li>
</ol>
<p>掌握了文档切分的理论基础后，如果你想快速实践一个完整的RAG应用，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.llamafactory.com.cn%2Fregister%3Futm_source%3Djslt_xtjj_wsy" target="_blank" title="https://www.llamafactory.com.cn/register?utm_source=jslt_xtjj_wsy" ref="nofollow noopener noreferrer"><strong>LLaMA-Factory Online</strong></a>提供了从文档上传、智能切分、向量化存储到模型微调的全流程支持。即使没有编程基础，也能通过可视化界面完成整个流程，真正实现“把自己的数据喂给大模型”，打造出理解你业务场景的专属AI助手。</p>
<h3 data-id="heading-20">动手实践建议</h3>
<ol>
<li><strong>从小开始</strong>：先用100KB以内的文档测试</li>
<li><strong>多样化测试</strong>：尝试不同参数组合</li>
<li><strong>记录结果</strong>：建立自己的参数经验库</li>
<li><strong>持续迭代</strong>：随着数据变化调整策略</li>
</ol>
<p>文档切分是连接原始数据与智能应用的桥梁。掌握好这项技术，你就能让大模型真正“读懂”你的数据，释放私有数据的最大价值。记住，好的开始是成功的一半，在RAG系统中，好的文档切分就是那个“好的开始”。</p>
<p>有任何问题或实践心得，欢迎在评论区交流讨论。下次我们将深入探讨向量化存储的最佳实践，敬请期待！</p>
<hr/>
<p><strong>声明</strong>：本文所有代码示例均可直接运行，建议在Jupyter Notebook中逐步实践。技术细节基于LangChain 0.1.x版本，具体实现可能随版本更新有所变化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[认识论的数学表示——梯度下降算法]]></title>    <link>https://juejin.cn/post/7600597995768610825</link>    <guid>https://juejin.cn/post/7600597995768610825</guid>    <pubDate>2026-01-29T12:52:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600597995768610825" data-draft-id="7600628279215144986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="认识论的数学表示——梯度下降算法"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T12:52:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在路上的达"/> <meta itemprop="url" content="https://juejin.cn/user/1628822092128964"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            认识论的数学表示——梯度下降算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1628822092128964/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在路上的达
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:52:58.000Z" title="Thu Jan 29 2026 12:52:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一篇一位学习者学习梯度下降算法时的一点思考与想法，记录了在此阶段的初步理解和认识。依照马克思主义认识论的观点，认识是一个从感性认识到理性认识不断上升，不断发展的过程。因此，我深知我对梯度下降算法的理解尚处于初级阶段，受限于知识背景和实践水平，文中可能或多或少出现理解上的不准确和局限性。</p>
<p>算法从根本上说，还是一个”工具“，工具无论如何”高大上“，都是为了”目的“服务的。那么，梯度下降的算法要解决的是一个什么问题呢？</p>
<p>在现实生活中，我们知道，它被用于训练机器学习模型。但是这对我们来说有些复杂，我们先来看一个简单的数学问题：二元线性回归。</p>
<p>数学是对现实世界的抽象，用抽象的符号和公式，反应现实世界的某种规律，但是在从现实事物到符号的抽象过程中，不可避免的出现”失真“的情况，换句话说，数学讨论的是一种理想情况。</p>
<h3 data-id="heading-0">文章结构</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">文章脉络:</span>
├── 问题概述 (二元线性回归、数学抽象与失真、待处理数据)
├── 梯度下降算法核心思想 (损失函数、下山比喻、偏导数与步长、参数迭代更新)
├── 梯度下降算法的四个要素 (初始值、计算梯度、迭代更新参数、停止条件)
├── 回到问题 - 实践篇
│   ├── 初始化参数 (w, lr, num_iterations)
│   └── 梯度下降核心步骤 (数学公式推导与Python代码实现)
│       ├── 计算预测值
│       ├── 计算损失
│       ├── 计算梯度 (w0, w1, w2)
│       └── 更新参数 (w0, w1, w2)
└── 结语
</code></pre>
<h3 data-id="heading-1">问题概述：二元线性回归</h3>
<p>首先什么是”线性回归“？线性回归是一个预测模型，也就是说，它会根据已有的信息总结出一个规律——用数学的语言表达就是：拟合出一条曲线——然后利用这个规律对未来的事情进行预测。所谓”二元“，就是变量有两个，有两个事情会对最终的结果产生影响。现在用数学公式对这个事情进行表达：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\hat{y} = w_{0} + w_{1}x_{1} + w_{2}x_{2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mn>0</mn><mo>−</mo><mn>2</mn></mrow></msub></mrow><annotation encoding="application/x-tex">w_{0-2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span> 叫做参数，是训练过程中由算法调整的，也就是输入到底经历了什么样的运算才到输出，我们究竟根据已有的经验建构了什么样的规律。</p>
<p>我们已有的数据如下：</p>













































<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></th></tr></thead><tbody><tr><td>10</td><td>3</td><td>60</td></tr><tr><td>20</td><td>3</td><td>85</td></tr><tr><td>25</td><td>3</td><td>100</td></tr><tr><td>28</td><td>2.5</td><td>120</td></tr><tr><td>30</td><td>2</td><td>140</td></tr><tr><td>35</td><td>2.5</td><td>145</td></tr><tr><td>40</td><td>2.5</td><td>163</td></tr></tbody></table>
<p>我们就是要从这堆数据中找到一个规律，一个从x到y的规律，以便于当我们遇到新的x时，可以预测出一个尽可能接近真实y的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span></span></span></span></span>。</p>
<h3 data-id="heading-2">梯度下降算法</h3>
<p>那么怎么找到这个规律呢？（怎么拟合这个曲线呢？）
利用这个规律得出的结果尽可能贴近现实情况就是一个”好“的规律，也就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span></span></span></span></span> 与 y 之间的差值越小，就越好。描述这个差值的东西数学上叫做：损失函数，公式如下</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msup><mi>y</mi><mi>i</mi></msup><mo>−</mo><mover accent="true"><msup><mi>y</mi><mi>i</mi></msup><mo>^</mo></mover><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L(w_{0},w_{1},w_{2}) = \frac{1}{n}\sum_{i = 1}^{n}(y^{i}-\hat{y^{i}})^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2641em;vertical-align:-0.25em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0141em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7507em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span><span style="top:-3.3197em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>这个例子中，需要调整的参数有三个，可能不太好理解，我们先考虑只有两个参数的损失函数，理解其精髓，然后类比理解三个参数。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msup><mi>y</mi><mi>i</mi></msup><mo>−</mo><mover accent="true"><msup><mi>y</mi><mi>i</mi></msup><mo>^</mo></mover><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L(w_{0},w_{1}) = \frac{1}{n}\sum_{i = 1}^{n}(y^{i}-\hat{y^{i}})^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2641em;vertical-align:-0.25em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0141em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7507em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span></span><span style="top:-3.3197em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48bed548736146d093a6d30b853e7925~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295983&amp;x-signature=Jg6sBT404S%2BjeML1C29z%2Fxe7vFs%3D" alt="Pasted image 20251026175436.png" loading="lazy"/></p>
<p>假如说你现在在一座浓雾弥漫的山上，想要尽快下山，奈何看不清远处的路，如何选择最快的下山路径呢？梯度下降的算法就是在当前位置选择最陡峭的一个方向走一步，然后再看哪个方向陡峭，再走一步，直到走到山底。</p>
<p>在随机给定一组参数的情况下<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(w_{0},w_{1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，判断哪个方向最陡峭使用的数学工具是偏导<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>2</mn></msub></mrow></mfrac><mo stretchy="false">(</mo><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[\frac{\partial f}{\partial w_{1}}(w_{0},w_{1}),\frac{\partial f}{\partial w_{2}}(w_{1},w_{2})]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3773em;vertical-align:-0.4451em;"/><span class="mopen">[</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span>，步长则使用导数值的负数乘一个小于1的数——这个小于1的数被称为学习率<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">lr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span>。</p>
<p>即</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mn>0</mn></msub><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>−</mo><mi>l</mi><mi>r</mi><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>0</mn></msub></mrow></mfrac><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">w_{0} = w_{0} - lr \frac{\partial f}{\partial w_{0}}(w_{0},w_{1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><mo>−</mo><mi>l</mi><mi>r</mi><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">w_{1} = w_{1} - lr \frac{\partial f}{\partial w_{1}}(w_{0},w_{1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>经过不断地迭代，就可以下山了，也就是找到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">Loss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span><span class="mord mathnormal">oss</span></span></span></span></span>最小的参数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(w_{0},w_{1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。</p>
<p>以上是两个参数的梯度下降，三个参数，多个参数的也是同理。</p>
<h3 data-id="heading-3">梯度下降算法的四个要素</h3>
<p>这四个要素是在具体使用这个算法进行计算时，必须要注意的事情：</p>
<h4 data-id="heading-4">初始值</h4>
<p>每一个参数，都要随机化一个初始值。</p>
<h4 data-id="heading-5">计算梯度</h4>
<p>梯度就是前文所提到的偏导值，需要计算梯度才能为接下来的迭代更新参数做准备。</p>
<h4 data-id="heading-6">迭代更新参数</h4>
<p>利用梯度值和学习率的乘积更新参数，不断减小Loss值。</p>
<h4 data-id="heading-7">停止条件</h4>
<p>可以预先设定一个迭代次数，也可以设置若连续更新参数Loss值不改变为停止条件。</p>
<h3 data-id="heading-8">回到问题</h3>
<p>对梯度下降算法有了一个整体的感性认识后，便可以动手实践检验我们的理论了，回到我们的问题，我们要利用这些数据拟合出来一条曲线，便于遇到新的输入值x时可以预测出来近似的y值。用生活化的语言表达就是：我们要根据已有的经验归纳总结出来一条规律，一个知识，便于我们遇到新情况的时候可以灵活应对，游刃有余。</p>













































<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></th></tr></thead><tbody><tr><td>10</td><td>3</td><td>60</td></tr><tr><td>20</td><td>3</td><td>85</td></tr><tr><td>25</td><td>3</td><td>100</td></tr><tr><td>28</td><td>2.5</td><td>120</td></tr><tr><td>30</td><td>2</td><td>140</td></tr><tr><td>35</td><td>2.5</td><td>145</td></tr><tr><td>40</td><td>2.5</td><td>163</td></tr></tbody></table>
<h4 data-id="heading-9">初始化参数</h4>
<p>根据前文的分析，在进行拟合之前，我们要对参数进行初始化，并设定一个学习率和迭代的次数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Feature 数据</span>
X = [[<span class="hljs-number">10</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">20</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">25</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">28</span>, <span class="hljs-number">2.5</span>], [<span class="hljs-number">30</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">35</span>, <span class="hljs-number">2.5</span>], [<span class="hljs-number">40</span>, <span class="hljs-number">2.5</span>]]
y = [<span class="hljs-number">60</span>, <span class="hljs-number">85</span>, <span class="hljs-number">100</span>, <span class="hljs-number">120</span>, <span class="hljs-number">140</span>, <span class="hljs-number">145</span>, <span class="hljs-number">163</span>]  <span class="hljs-comment"># Label 数据</span>
<span class="hljs-comment"># 初始化参数</span>
w = [<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>]  <span class="hljs-comment"># w0, w1, w2</span>
lr = <span class="hljs-number">0.0001</span>  <span class="hljs-comment"># 学习率</span>
num_iterations = <span class="hljs-number">10000</span>  <span class="hljs-comment"># 迭代次数</span>
</code></pre>
<h4 data-id="heading-10">梯度下降核心步骤</h4>
<p>整体上，这是一个不断迭代的过程，用编程的语言表达就是：这是一个循环。</p>
<p>为了实时看到机器学习这个规律的过程，每次迭代我们都计算一下预测值，并利用预测值和实际值计算出来Loss值。</p>
<p>也就是说，这个循环分为四个步骤，先用数学形式表达一下</p>
<ol>
<li>计算预测值</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\hat{y} = w_{0} + w_{1}x_{1} + w_{2}x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<ol start="2">
<li>计算Loss值</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msup><mo>−</mo><msup><mi>y</mi><mi>i</mi></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">loss = \frac{1}{n}\sum_{i = 1}^{n}(\hat{y}^{i} - y^{i})^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1247em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msubsup><mi>x</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msubsup><mi>x</mi><mn>2</mn><mi>i</mi></msubsup><mo>−</mo><msup><mi>y</mi><mi>i</mi></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">loss = \frac{1}{n}\sum_{i = 1}^{n}(w_{0} + w_{1}x_{1}^{i} + w_{2}x_{2}^{i}-y^{i})^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1247em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<ol start="3">
<li>计算梯度</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>0</mn></msub></mrow></mfrac><mo>=</mo><mfrac><mn>2</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msubsup><mi>x</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msubsup><mi>x</mi><mn>2</mn><mi>i</mi></msubsup><mo>−</mo><msup><mi>y</mi><mi>i</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{\partial loss}{\partial w_{0}} = \frac{2}{n}\sum_{i = 1}^{n}(w_{0} + w_{1}x_{1}^{i} + w_{2}x^{i}_{2} - y^{i})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1247em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac><mo>=</mo><mfrac><mn>2</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msubsup><mi>x</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msubsup><mi>x</mi><mn>2</mn><mi>i</mi></msubsup><mo>−</mo><msup><mi>y</mi><mi>i</mi></msup><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi>x</mi><mn>1</mn><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">\frac{\partial loss}{\partial w_{1}} = \frac{2}{n}\sum_{i = 1}^{n}(w_{0} + w_{1}x_{1}^{i} + w_{2}x_{2}^{i} - y^{i}) \cdot x_{1}^{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1247em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>2</mn></msub></mrow></mfrac><mo>=</mo><mfrac><mn>2</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msubsup><mi>x</mi><mn>1</mn><mi>i</mi></msubsup><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msubsup><mi>x</mi><mn>2</mn><mi>i</mi></msubsup><mo>−</mo><msup><mi>y</mi><mi>i</mi></msup><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi>x</mi><mn>2</mn><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">\frac{\partial loss}{\partial w_{2}} = \frac{2}{n}\sum_{i = 1}^{n}(w_{0} + w_{1}x_{1}^{i} + w_{2}x_{2}^{i} - y^{i}) \cdot x_{2}^{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1247em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<ol start="4">
<li>更新参数</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mn>0</mn></msub><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>−</mo><mi>l</mi><mi>r</mi><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>0</mn></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">w_{0} = w_{0} - lr \cdot \frac{\partial loss}{\partial w_{0}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><mo>−</mo><mi>l</mi><mi>r</mi><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">w_{1} = w_{1} - lr \cdot \frac{\partial loss}{\partial w_{1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>w</mi><mn>2</mn></msub><mo>=</mo><msub><mi>w</mi><mn>2</mn></msub><mo>−</mo><mi>l</mi><mi>r</mi><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>2</mn></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">w_{2} = w_{2} - lr \cdot \frac{\partial loss}{\partial w_{2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oss</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>然后把数学语言转化成python语言就行了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 梯度下降</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_iterations):
    <span class="hljs-comment"># 计算预测值</span>
    y_pred = [w[<span class="hljs-number">0</span>] + w[<span class="hljs-number">1</span>] * x[<span class="hljs-number">0</span>] + w[<span class="hljs-number">2</span>] * x[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> X]
    <span class="hljs-comment"># 计算损失</span>
    loss = <span class="hljs-built_in">sum</span>((y_pred[j] - y[j]) ** <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) / <span class="hljs-built_in">len</span>(y)
    <span class="hljs-comment"># 计算梯度</span>
    grad_w0 = <span class="hljs-built_in">sum</span>(y_pred[j] - y[j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) * <span class="hljs-number">2</span> / <span class="hljs-built_in">len</span>(y)
    grad_w1 = <span class="hljs-built_in">sum</span>((y_pred[j] - y[j]) * X[j][<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) * <span class="hljs-number">2</span> / <span class="hljs-built_in">len</span>(y)
    grad_w2 = <span class="hljs-built_in">sum</span>((y_pred[j] - y[j]) * X[j][<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) * <span class="hljs-number">2</span> / <span class="hljs-built_in">len</span>(y)
    <span class="hljs-comment"># 更新参数</span>
    w[<span class="hljs-number">0</span>] -= lr * grad_w0
    w[<span class="hljs-number">1</span>] -= lr * grad_w1
    w[<span class="hljs-number">2</span>] -= lr * grad_w2
    <span class="hljs-comment"># 输出结果</span>
    <span class="hljs-keyword">if</span> i % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Iteration <span class="hljs-subst">{i}</span>: Loss = <span class="hljs-subst">{loss}</span>, w = <span class="hljs-subst">{w}</span>'</span>)
<span class="hljs-comment"># 输出最终参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'final parameters: w = <span class="hljs-subst">{w}</span>'</span>)
</code></pre>
<p>完整的代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Feature 数据</span>
X = [[<span class="hljs-number">10</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">20</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">25</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">28</span>, <span class="hljs-number">2.5</span>], [<span class="hljs-number">30</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">35</span>, <span class="hljs-number">2.5</span>], [<span class="hljs-number">40</span>, <span class="hljs-number">2.5</span>]]
y = [<span class="hljs-number">60</span>, <span class="hljs-number">85</span>, <span class="hljs-number">100</span>, <span class="hljs-number">120</span>, <span class="hljs-number">140</span>, <span class="hljs-number">145</span>, <span class="hljs-number">163</span>]  <span class="hljs-comment"># Label 数据</span>
<span class="hljs-comment"># 初始化参数</span>
w = [<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>]  <span class="hljs-comment"># w0, w1, w2</span>
lr = <span class="hljs-number">0.0001</span>  <span class="hljs-comment"># 学习率</span>
num_iterations = <span class="hljs-number">10000</span>  <span class="hljs-comment"># 迭代次数</span>
<span class="hljs-comment"># 梯度下降</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_iterations):
    <span class="hljs-comment"># 计算预测值</span>
    y_pred = [w[<span class="hljs-number">0</span>] + w[<span class="hljs-number">1</span>] * x[<span class="hljs-number">0</span>] + w[<span class="hljs-number">2</span>] * x[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> X]
    <span class="hljs-comment"># 计算损失</span>
    loss = <span class="hljs-built_in">sum</span>((y_pred[j] - y[j]) ** <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) / <span class="hljs-built_in">len</span>(y)
    <span class="hljs-comment"># 计算梯度</span>
    grad_w0 = <span class="hljs-built_in">sum</span>(y_pred[j] - y[j] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) * <span class="hljs-number">2</span> / <span class="hljs-built_in">len</span>(y)
    grad_w1 = <span class="hljs-built_in">sum</span>((y_pred[j] - y[j]) * X[j][<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) * <span class="hljs-number">2</span> / <span class="hljs-built_in">len</span>(y)
    grad_w2 = <span class="hljs-built_in">sum</span>((y_pred[j] - y[j]) * X[j][<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y))) * <span class="hljs-number">2</span> / <span class="hljs-built_in">len</span>(y)
    <span class="hljs-comment"># 更新参数</span>
    w[<span class="hljs-number">0</span>] -= lr * grad_w0
    w[<span class="hljs-number">1</span>] -= lr * grad_w1
    w[<span class="hljs-number">2</span>] -= lr * grad_w2
    <span class="hljs-comment"># 输出结果</span>
    <span class="hljs-keyword">if</span> i % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Iteration <span class="hljs-subst">{i}</span>: Loss = <span class="hljs-subst">{loss}</span>, w = <span class="hljs-subst">{w}</span>'</span>)
<span class="hljs-comment"># 输出最终参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'final parameters: w = <span class="hljs-subst">{w}</span>'</span>)
</code></pre>
<p>至此我们用过往经验归纳出来了一条规律，至于这条规律如何，实践是检验真理的唯一标准，我们还需要在不断地实践-认识-实践的循环中加深理解，不断调整，趋近真理。</p>
<p>更多内容，关注同名公众号：“在路上的达”</p>
<p>参考：
[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rethink.fun%2F" target="_blank" title="https://www.rethink.fun/" ref="nofollow noopener noreferrer">www.rethink.fun/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[导数的双重身份：从商业决策到反向传播——反向传播算法]]></title>    <link>https://juejin.cn/post/7600601482690674734</link>    <guid>https://juejin.cn/post/7600601482690674734</guid>    <pubDate>2026-01-29T12:57:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600601482690674734" data-draft-id="7600628279215226906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="导数的双重身份：从商业决策到反向传播——反向传播算法"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T12:57:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在路上的达"/> <meta itemprop="url" content="https://juejin.cn/user/1628822092128964"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            导数的双重身份：从商业决策到反向传播——反向传播算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1628822092128964/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在路上的达
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:57:44.000Z" title="Thu Jan 29 2026 12:57:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在深度学习领域，梯度下降算法告诉我们训练模型的目标：调整参数，使得Loss最小；而反向传播算法则告诉我们如何做：如何高效调整参数。</p>
<p>从数学上来说：反向传播算法是数学中计算复合函数的导数，即链式法则的应用。</p>
<p>这里我们先来回忆一下高中学习的导数，这个让无数高考生头疼的数学工具，在现实生活中究竟有怎样的意义和价值，将理想概念世界的数学拉回到世俗的“泥潭”。</p>
<h3 data-id="heading-0">文章脉络</h3>
<pre><code class="hljs language-markdown" lang="markdown">文章脉络:
├── 反向传播算法概述 (梯度下降的目标与方法、数学本质)
├── 现实视角下的导数意义
│ ├── 速度和加速度
│ └── 商业中的决策 (边际效应、数学与现实的张力)
├── 计算图：反向传播的可视化工具
│ ├── 如何使用计算图 (超市购物例子)
│ ├── 计算图的局部计算特征 (信息流与流水线)
│ └── 导数在计算图中的表现
├── 计算图的反向传播——链式法则
│ ├── 链式法则原理 (复合函数求导)
│ ├── 乘法节点的反向传播
│ ├── 加法节点的反向传播
│ └── Python实现
│ ├── 乘法层
│ └── 加法层
├── 实践：回到超市
│ ├── 构建计算图
│ ├── 前向传播
│ └── 反向传播
├── 一些思考 (敏感度量化、因果逻辑、数学与现实的距离)
└── 参考资料
</code></pre>
<h3 data-id="heading-1">现实视角下的导数意义</h3>
<p>我们来看几个导数的应用场景，便可从中窥见一些导数在现实世界的“模样”。</p>
<h4 data-id="heading-2">速度和加速度</h4>
<p>速度和加速度是最广为人知的导数的意义：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>v</mi><mo>=</mo><mfrac><mrow><mi>d</mi><mi>s</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">v = \frac{ds}{dt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>a</mi><mo>=</mo><mfrac><mrow><mi>d</mi><mi>v</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">a = \frac{dv}{dt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>当时间无限趋于0时，取这么一小段时间行驶的距离作为一个新的物理量：速度。它告诉我们在一个固定的时间的变化量下，位移能够变化多少。这样说比较抽象，因为”导数“是一个概念，但是我们却用了一句话，即两个概念间关系来表达这个事情，这让我们的大脑有些”痛苦“，能否有”一个“现实生活中的概念能对应”导数“这个概念呢？导数描述的是A概念对B概念的影响程度，即B概念对A概念的”敏感度“，导数值越大，就说明越敏感，反之亦然。</p>
<h4 data-id="heading-3">商业中的决策</h4>
<p>我们再来看一个更加生活化的例子：</p>
<p>想象你是一家工厂的老板，这是你面临的情况：</p>


















































<table><thead><tr><th>项目</th><th>数值</th><th>单位</th></tr></thead><tbody><tr><td><strong>定价与销量</strong></td><td/><td/></tr><tr><td>销售价格</td><td>500</td><td>元/件</td></tr><tr><td>月销售量</td><td>10,000</td><td>件</td></tr><tr><td><strong>成本</strong></td><td/><td/></tr><tr><td>原材料单价</td><td>150</td><td>元/件</td></tr><tr><td>工人数量</td><td>50</td><td>人</td></tr><tr><td>月人工成本</td><td>4,000</td><td>元/人</td></tr><tr><td>月固定运输费</td><td>20</td><td>万元</td></tr></tbody></table>
<p>这是你的获利情况：</p>



































<table><thead><tr><th>项目</th><th>计算方式</th><th>数值</th></tr></thead><tbody><tr><td>销售额</td><td>500 元/件 × 10,000 件</td><td>500 万元</td></tr><tr><td>原材料成本</td><td>150 元/件 × 10,000 件</td><td>150 万元</td></tr><tr><td>人工成本</td><td>4,000 元/人 × 50 人</td><td>20 万元</td></tr><tr><td>固定运输费</td><td>—</td><td>20 万元</td></tr><tr><td><strong>月利润</strong></td><td><strong>500 - 150 - 20 - 20</strong></td><td><strong>310 万元</strong></td></tr></tbody></table>
<p>现在你想知道改变一下原材料的成本能带来多少的利润的变化，即你想知道月利润对原材料成本的敏感度。</p>
<p>通过计算得到：原材料成本每提高1元，月利润会下降10000元。</p>
<p>在经济学中，这种思考的模式叫做：边际效应。比如著名的边际递减效应就是运用了导数的这种数学工具。</p>
<p>在这个例子中，我们看到导数可以帮助我们在多个影响因素问题中仅仅关注于其中某个因素的对最终结果的影响情况，但是同时，直觉告诉我们，仅靠数学工具来进行决策好像会带来一丝不安，原材料成本的提高，不一定会带来月利润的下降，真实的生活中还有更多需要考虑的因素，比如品质的提高带来了更多的客户的青睐，这里先埋下一个伏笔，最后讲完反向传播算法后我们会回到这个问题探讨一些算法之外的思考。</p>
<h3 data-id="heading-4">反向传播算法的可视化工具</h3>
<p>为了更加清晰地理解反向传播算法，我们需要首先学会使用一个思考工具：计算图。</p>
<h4 data-id="heading-5">如何使用可视化工具：计算图</h4>
<p>我们来看一个生活化的例子：你到超市买东西，买了六瓶饮料，一瓶是10元，会员卡可以打八折</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d7ecc333424452884e27404d572a30a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=FYGL%2BlTvbxiMTM%2Fv1cVVRTUrAYM%3D" alt="Drawing 2025-11-16 01.44.27.excalidraw.png" loading="lazy"/></p>
<p>图中的圆圈表示计算方式，横线上计算的输入和输出</p>
<p>如果不仅买饮料，还买20支圆珠笔，每支笔是5元，同样可以打八折，那么这个计算图就会变成这个样子</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3c1c1e53d804757bff959144d300869~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=zuo4hj7VgAeeKRShiJv1HH6U50Q%3D" alt="Drawing 2025-11-16 01.58.47.excalidraw.png" loading="lazy"/></p>
<h4 data-id="heading-6">计算图的局部计算特征</h4>
<p>基于我目前对计算图这个工具的认识：我认为计算图通过一种整体上的信息流的设计使得独立的计算过程的效果得以累积。这句话有两个意思，其一是每一步计算的结果都对最终的结果产生一定的影响，即有整体效应；其二是，具体计算时不用关注整体发生了什么，只需要拿到上游的信息数据，做好本环节的计算，并向下游传递数据即可，就好像流水线上的工人一样，他们可能不知道公司的整体愿景，但是只要在流水线上做好自己分内的工作就会对最终的结果产生相应的效果。</p>
<h4 data-id="heading-7">一个小问题，回到导数的现实意义</h4>
<p>假设现在我们想要知道饮料单价的上涨多大程度上会影响最后的消费金额，即消费金额对饮料单价的”敏感度“，方便起见，我们先来看这个简单一点的计算图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c583b249a00e40f0ac722ebc7cb2b472~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=%2BY3ax4CB%2B7i6N5uJhDiLz%2BhNa2c%3D" alt="Drawing 2025-11-16 01.44.27.excalidraw.png" loading="lazy"/>
数学上，我们知道是计算消费金额对饮料的导数，用计算图如何表示呢，我们看看：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae44c77e0f94ac4b3a30b5e6c0b8ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=Kk0asP0A2yMqs2WdmYR46VceFwc%3D" alt="Drawing 2025-11-16 01.44.27.excalidraw 1.png" loading="lazy"/>
反向的横线就是求导数的过程，传递的是”局部的反向导数“，这也是反向传播算法名字的来由：与正向算法的信息流的方向是相反的。
从这个结果可知，消费金额对饮料单价的导数是4.8，即如果饮料的单价上涨1元，最终的消费金额会上涨4.8元。</p>
<p>现在你可能并不能理解计算图局部计算的强大之处，如果我继续问你，最终的消费金额对饮料个数的导数是多少，或者最终消费金额对折扣的导数是多少，你就会慢慢理解这种工具的强大了，下面再用一幅图感受一下清晰化的计算结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f44dac374ab494d8c6fd60d7bd65935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=dv2vaILCcj5Whh8isr5l6lgS5o4%3D" alt="Drawing 2025-11-16 01.44.27.excalidraw 2.png" loading="lazy"/>
可以清晰地从反向箭头看出来消费金额对饮料个数的导数是8，而对折扣的导数是60（不过这里折扣和饮料单价的量纲不同，所以60这个数可能会有些奇怪）</p>
<p>可能你还是没有理解这到底是什么意思，其实这里只是简单展示了一下计算图和反向传播算法的效果，后面会对具体的计算过程进行详细的介绍：即链式法则。</p>
<h3 data-id="heading-8">计算图的反向传播——链式法则</h3>
<p>关于链式法则，这里直接摘录百度百科的解释：“链式法则是微积分中的求导法则，用于求一个复合函数的导数，是在微积分的求导运算中一种常用的方法。复合函数的导数将是构成复合这有限个函数在相应点的导数的乘积，就像锁链一样一环套一环，故称链式法则。”</p>
<p>用一个例子来表示就是：现在有两个函数</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>z</mi><mo>=</mo><msup><mi>t</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">z = t^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8641em;"/><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>t</mi><mo>=</mo><mi>x</mi><mo>+</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">t = x + y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></div>
<p>那么求 z 对 x 的导数就是先求外层函数的导数，再求内层函数的导数</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi>d</mi><mi>t</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{dz}{dx} = \frac{dz}{dt} \cdot \frac{dt}{dx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>如果要简单从原理上理解一下的话就是：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><menclose notation="updiagonalstrike"><mrow><mi>d</mi><mi>t</mi></mrow></menclose></mfrac><mo>⋅</mo><mfrac><menclose notation="updiagonalstrike"><mrow><mi>d</mi><mi>t</mi></mrow></menclose><mrow><mi>d</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{dz}{dx} = \frac{dz}{\cancel{dt}} \cdot \frac{\cancel{dt}}{dx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord cancel-lap"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord cancel-pad"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span style="height:0.6944em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.6944em"><line x1="0" y1="100%" x2="100%" y2="0" stroke-width="0.046em"/></svg></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord cancel-lap"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord cancel-pad"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span style="height:0.6944em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.6944em"><line x1="0" y1="100%" x2="100%" y2="0" stroke-width="0.046em"/></svg></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>求得的结果就是</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mn>2</mn><mi>t</mi><mo>⋅</mo><mn>1</mn><mo>=</mo><mn>2</mn><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{dz}{dx} = 2t \cdot 1 = 2(x + y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span></div>
<p>而 z 对 y 的导数则是</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><mrow><mi>d</mi><mi>y</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>d</mi><mi>z</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi>d</mi><mi>t</mi></mrow><mrow><mi>d</mi><mi>y</mi></mrow></mfrac><mo>=</mo><mn>2</mn><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{dz}{dy} = \frac{dz}{dt} \cdot \frac{dt}{dy} = 2(x + y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span></div>
<p>而计算图中的反向计算公式如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce5b05127190420b979f6f904fc00d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=CoLFZ2uS0%2BKZv1Vr%2BWDk0gbHFWo%3D" alt="Drawing 2025-11-16 10.22.35.excalidraw.png" loading="lazy"/>
将反向输入的信号E乘上节点的局部导数f'(x)，然后将结果传给下一个节点</p>
<p>现在我们把刚才的符复合函数用计算图的方式表示一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56f80ead01bb47ce8eec12065d085f59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=Et59oGjwjQTvThNiMP71Zz1mb5A%3D" alt="Drawing 2025-11-16 10.31.06.excalidraw.png" loading="lazy"/>
在计算时，只需要把反向传递的上游的信息，乘上该节点的局部导数值即可，不需要考虑全局</p>
<h4 data-id="heading-9">乘、加法节点的反向传播</h4>
<h5 data-id="heading-10">乘法节点的反向传播</h5>
<p>毕竟节点的计算方法非常有限，研究清楚常见的几个算法，封装成“规律”，便可以省去每次都在底层原理上的纠结与挣扎。</p>
<p>乘法公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>z</mi><mo>=</mo><mi>x</mi><mo>⋅</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">z = x \cdot y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></div>
<p>求导结果：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">\frac{\partial z}{\partial x} = y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac><mo>=</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">\frac{\partial z}{\partial y} = x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span></div>
<p>计算图表示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac3e1d55045f4ef0995565e7601c0099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=WF1u1GfPmUcYuLdxnjvWGHjuFx0%3D" alt="Drawing 2025-11-16 10.45.41.excalidraw.png" loading="lazy"/>
反向上游传过来的信息是E，发现向下游传递时，传递的是“翻转值”，x这条路反向时乘上y，y这条路反向时乘上x。</p>
<h5 data-id="heading-11">加法节点的反向传播</h5>
<p>加法公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>z</mi><mo>=</mo><mi>x</mi><mo>+</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">z = x + y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span></div>
<p>求导结果：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\frac{\partial z}{\partial x} = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\frac{\partial z}{\partial y} = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></div>
<p>计算图表示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b08e81a8f6d84f49bbde2a30d1a1c592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyo6Lev5LiK55qE6L6-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296319&amp;x-signature=5wzXtZFzOseCBpjF5wCxvm3FQDE%3D" alt="Drawing 2025-11-16 10.51.55.excalidraw.png" loading="lazy"/>
结果也非常简单：就是原封不动地传递反向上游的信息即可</p>
<h4 data-id="heading-12">Python实现两种简单层</h4>
<p>这里把计算图的乘法节点和加法节点分别叫做“乘法层”和“加法层”，并根据上文总结的规律进行简单的实现</p>
<h5 data-id="heading-13">乘法层</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MulLayer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.x = <span class="hljs-literal">None</span>
        self.y = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self,x,y</span>):
        self.x = x
        self.y = y
        out = x * y
        <span class="hljs-keyword">return</span> out

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">self,dout</span>): <span class="hljs-comment"># dout 是从反向上游传过来的导数值</span>
        dx = dout * self.y <span class="hljs-comment"># 翻转x和y</span>
        dy = dout * self.x
        <span class="hljs-keyword">return</span> dx, dy
</code></pre>
<h5 data-id="heading-14">加法层</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AddLayer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">pass</span> <span class="hljs-comment"># 由于反向计算不依赖正向计算的值，因此不需要任何成员变量</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self,x,y</span>):
        out = x + y
        <span class="hljs-keyword">return</span> out

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">self,dout</span>):
        dx = dout * <span class="hljs-number">1</span>
        dy = dout * <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> dx, dy
</code></pre>
<h3 data-id="heading-15">回到超市</h3>
<p>还记得买饮料和圆珠笔的那个问题吗？之前我们用计算图表示了一遍，现在我们用代码实践一下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义乘法层和加法层</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MulLayer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.x = <span class="hljs-literal">None</span>
        self.y = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, y</span>):
        self.x = x
        self.y = y
        out = x * y
        <span class="hljs-keyword">return</span> out

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">self, dout</span>):
        dx = dout * self.y
        dy = dout * self.x
        <span class="hljs-keyword">return</span> dx, dy

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AddLayer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, y</span>):
        out = x + y
        <span class="hljs-keyword">return</span> out
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">self, dout</span>):
        dx = dout * <span class="hljs-number">1</span>
        dy = dout * <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> dx, dy



<span class="hljs-comment"># 构建计算图</span>
<span class="hljs-comment"># 创建层对象</span>
mul_drink = MulLayer()  
mul_pen = MulLayer()    
add_layer = AddLayer()  
mul_discount = MulLayer()  
  
  

<span class="hljs-comment"># 前向传播</span>
<span class="hljs-comment"># 1. 计算饮料总价</span>
drink_price = <span class="hljs-number">10</span>  
drink_num = <span class="hljs-number">6</span>    
drink_total = mul_drink.forward(drink_price, drink_num)
<span class="hljs-comment"># 2. 计算笔的总价</span>
pen_price = <span class="hljs-number">5</span>    
pen_num = <span class="hljs-number">20</span>      
pen_total = mul_pen.forward(pen_price, pen_num)
total_cost = add_layer.forward(drink_total, pen_total) 
<span class="hljs-comment"># 3. 应用折扣</span>
discount_rate = <span class="hljs-number">0.8</span>  
final_price = mul_discount.forward(total_cost, discount_rate)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"消费金额：<span class="hljs-subst">{final_price}</span>元"</span>)

  

<span class="hljs-comment"># 反向传播</span>
<span class="hljs-comment"># 以计算消费金额对饮料单价的导数为例</span>
<span class="hljs-comment"># 初始梯度</span>
dout = <span class="hljs-number">1</span>
<span class="hljs-comment"># 反向传播通过折扣层</span>
d_total_cost, d_discount_rate = mul_discount.backward(dout)
<span class="hljs-comment"># 反向传播通过加法层</span>
d_drink_total, d_pen_total = add_layer.backward(d_total_cost)
<span class="hljs-comment"># 反向传播通过饮料乘法层</span>
d_drink_price, d_drink_num = mul_drink.backward(d_drink_total)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"饮料单价每增加1元，最终价格增加<span class="hljs-subst">{d_drink_price:<span class="hljs-number">.2</span>f}</span>元"</span>)
</code></pre>
<p>最终输出结果如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">消费金额：128.0元
饮料单价每增加1元，最终价格增加4.80元
</code></pre>
<p>符合预期</p>
<h3 data-id="heading-16">一些思考</h3>
<p>反向传播求的每一个节点的局部导数，前面我们提到过导数是“敏感度”，是最终结果对当前这个局部节点的敏感度，也就是这个局部对全局的影响程度，反向传播算法量化了这个程度，让我们不仅可以看出正或负的影响效果，还能精确知道具体有多大的影响，指导我们下一步调整参数，使得Loss最小。</p>
<p>不过能够如此清晰地明确调整方向建立在一个基础上，就是计算图体现出来的：清晰严谨的因果逻辑，一张计算图，把所有的数据因果关系全部都描述清楚了，这里我想强调“关系”这个词，在没有具体的数据进入计算图的时候，计算图已经存在了，也就是数据的关系先于数据存在；也正因为有如此严谨的因果逻辑使得局部计算时不需要考虑全局，因为关系已经定“死”了。</p>
<p>有的人可能会把反向传播的逻辑应用到生活中，就像是有的人把导数引入到商业中辅助决策，但是绝对不能期望在商业中的应用能到达在计算图中这样“清晰严谨”的效果，现实不是数学，尽管数学非常复杂，但是数学只考虑了能被思维捕捉的影响因素和关系，现实可没有已经设定好的“计算图”。</p>
<p>还记得前文介绍导数现实意义时提到的商业决策的例子吗？当时的“不安”在这里是不是根本没有得到缓解呢？（哈哈哈）星空需要仰望，对待现实需要时刻谨慎。</p>
<p>更多内容，关注同名公众号：“在路上的达”</p>
<h3 data-id="heading-17">参考资料</h3>
<p>[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rethink.fun%2F" target="_blank" title="https://www.rethink.fun/" ref="nofollow noopener noreferrer">www.rethink.fun/</a>
[2] 斋藤康毅[日] . 深度学习入门：基于Python的理论与实现 . 人民邮电出版社 . 2018 .</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[黄啊码-耗时N天打磨的AI漫剧神器，创作变现一条龙，今天正式开源！]]></title>    <link>https://juejin.cn/post/7600705405595648063</link>    <guid>https://juejin.cn/post/7600705405595648063</guid>    <pubDate>2026-01-30T02:37:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600705405595648063" data-draft-id="7600709805468385323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="黄啊码-耗时N天打磨的AI漫剧神器，创作变现一条龙，今天正式开源！"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-30T02:37:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄啊码"/> <meta itemprop="url" content="https://juejin.cn/user/3910302505908312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            黄啊码-耗时N天打磨的AI漫剧神器，创作变现一条龙，今天正式开源！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3910302505908312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄啊码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:37:39.000Z" title="Fri Jan 30 2026 02:37:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近这么安静，相信很多人都觉得我在偷懒了吧</p>
<p>相反，“暴风雨来之前肯定会比较安静的”。今天，黄啊码又来了，我把耗时一个多月打磨的AI漫剧神器正式开源。</p>
<p>没错，就是那个能让你的脑洞秒变爆款漫剧的产品！不信？先看我用自家产品搓出来的漫剧本视频感受下👇
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Fvideo%2F85014" target="_blank" title="https://cloud.tencent.com/developer/video/85014" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/v…</a>
🤯 传统漫剧制作？熬秃头也难产！</p>
<p>编剧挠破头写剧本？分镜师肝到凌晨画场景？后期合成配字幕配解说累成狗？<strong>停！</strong> 这套苦情戏，今天该说拜拜了。</p>
<p>黄啊码的AI漫剧神器，把 <strong>“小说生成 <strong>→</strong> <strong>剧本创作</strong>→ <strong>角色定制</strong> → 分镜绘制 → 视频合成”</strong> 全流程打包搞定。<strong>你，只需要动动鼠标</strong></p>
<p>📖 <strong>第一步：小说，AI给你现编！</strong></p>
<p>打开神器首页，选好题材风格，输入核心情节关键描述内容</p>
<p><strong>卡文了？</strong> 右下角点“随机生成情节”，灵感秒来</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23a27902d48f4e979ba2864b5332fa5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=yqWK8NMGmjGINe9wtgESJzduw1c%3D" alt="图片" loading="lazy"/>​</p>
<p><strong>有梗不会写？</strong> 点“优化情节描述”</p>
<p>AI帮你润色成专业编剧水准（亲测：比我这程序员写的强多了😂）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c8c5b94b6aa4ae68ecb7c975d90d13b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=XEl8XavtIsI5%2BPmVFGTFqQ0J1%2Bk%3D" alt="图片" loading="lazy"/>​</p>
<p>选好篇幅（漫剧建议短篇起步）、设定角色和背景，<strong>点击创作</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f787c6a861a4ba48d2b97436da8c9bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=7Xfu%2B%2BoK1NCniFCCxQ7kdBhFQr8%3D" alt="图片" loading="lazy"/>​</p>
<p>几分钟后，1w+字完整小说出炉！某茄小说码半年？AI几分钟搞定！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994d519319e7464d8a2d648c3593fc94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=lihundEkly8KU4B9HQwuxTHFVPE%3D" alt="图片" loading="lazy"/>​</p>
<p>生成不满意？太正常了！点进【个人中心】</p>
<p>点击个人中心</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2410fb2bbe28414c8d99184c20fb4d12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=yj8Yvr%2FYJEINkU3breMGaUz4Xbw%3D" alt="图片" loading="lazy"/>​</p>
<p>点击编辑作品</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde4bb912a794a9bb6c51caf075463ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=zrFLZjMP%2FVgtJ0Qw5YX%2F6pDbTTQ%3D" alt="图片" loading="lazy"/>​</p>
<p>扩写、润色、改写随意调教，AI不完美，但绝对是你最强辅助</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2eab3689fb548ac976bd33680ed11e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=sj6zD9xzpLH14XXNmO2udHuzm4c%3D" alt="图片" loading="lazy"/>​</p>
<p>如果你只是想写一篇属于自己的小说，可以到此为止了</p>
<p>可是，我相信你打开我这篇文章不可能只是单纯为了写小说那么简单吧，生成自己的漫剧才是最终目的吧？所以，咱们开始吧。</p>
<p>🎬 <strong>第二步：小说一键智能转化</strong>剧本****</p>
<p>点击菜单栏上的码上做剧本，选择刚出炉的小说章节</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bd685f96dc447ca82d09d1637ad4835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=9aEK6Mc1bsIe693pPOvnsmDy8nw%3D" alt="图片" loading="lazy"/>​</p>
<p>选择章节，点击生成剧本，我这里直接选择全部</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b07d4b153274ebcaa7105420e51c3a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=SgNUyqtbgzCyddo3OG7A7ZG1c4I%3D" alt="图片" loading="lazy"/>​</p>
<p><strong>Duang~</strong> 几分钟，文字自动变身专业分场剧本！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f7ae474f374426a0dcd19a155ceee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=MHlwX1zFi34J3dB5KghjZSnpU2M%3D" alt="图片" loading="lazy"/>​</p>
<p>剧本都生成完毕了，是否该直接进行分镜生成呢？</p>
<p>🎨 <strong>第三步：服化道？AI全包圆！</strong></p>
<p>黄啊码并没有这么着急，有没有想到一个段子【道具！！！】对，布景和道具、演员的衣着都要安排一下。</p>
<p>点【码上准备】→ 分析剧本，AI瞬间输出：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39581ffbc2864d40a1c7d048aac42a9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=prHJ5NY1gML4YTzj5HyjNpl93FY%3D" alt="图片" loading="lazy"/>​</p>
<p>✅ 角色服装设计图+说明</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3860464e3d8a4236bfdd6e5847e6f5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=CAW45d4togp1HB%2FUUqTCHX5ikus%3D" alt="图片" loading="lazy"/>​</p>
<p>✅ 场景布景参考+清单</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16329526307f40b99408c8b582b3c44c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=xgISEa1iW%2BGU1D2j1JmpnA80es8%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09b292b5028e4aa9a04548b74c3f7bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=vglUyaz5Eq%2FzmLx6b8IXJxg7X8E%3D" alt="图片" loading="lazy"/>​</p>
<p>✅ 道具细节清单+图示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02de88cd05ac4d8c9427c88c9d3a3a22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=pflXct5BVi5cCk91WkuQaW0Iq30%3D" alt="图片" loading="lazy"/>​</p>
<p>不懂美术？不懂道具？没关系！你只管点鼠标，专业级方案AI全给！</p>
<p>接下来，重磅功能开启，生成漫剧</p>
<p>👤 <strong>第四步：角色&amp;分镜？精准拿捏！</strong></p>
<p>生成角色：从个人中心找到这本小说，点击继续创作</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9abb67697b9a4c5dbeb3fa2d9751cdc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=uqSMgSKT1bb5wwFu2iTRqkvLanM%3D" alt="图片" loading="lazy"/>​</p>
<p>小说都是AI生成的，让自己创建角色肯定是不可能的，所以黄啊码特地安排让AI自动提取角色</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b992072f2ef045858f5dd0c5f36e65f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=SEtuv3kfop3MUCdwbqLd3CyBLuA%3D" alt="图片" loading="lazy"/>​</p>
<p>提取完毕后点击选中，应用会自动将相关信息写入表单中</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24d04d7b55764371b8ba629b61620688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=KAvScrXV8%2FuVnZnyQUSXew2uUXI%3D" alt="图片" loading="lazy"/>​</p>
<p>你只需要动动鼠标，点击生成角色形象即可【额，黄啊码没有这么年轻】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1693909d487b439db9397ae62e5658b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=8MQ6dDAVIHzhyVtV8etI6iS5EyQ%3D" alt="图片" loading="lazy"/>​</p>
<p>生成分镜：点击菜单栏的码上拍戏，选择小说和相关章节</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2d51ae98ded405f838aa3262e342cf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=WG74WA6tUpb6IYc%2B6O6JPraIL3Y%3D" alt="图片" loading="lazy"/>​</p>
<p>章节对应的剧本会显示出来，然后你可以根据章节的场景内容布置内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7787031848224cd0ab2c1ecc214a0722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=MYePWDw24Jrinde6HPfWhttudGw%3D" alt="图片" loading="lazy"/>​</p>
<p>点击场景描述提示词旁边的查看参考内容，把想做的场景画面直接复制到文本框，点击生成图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc42e1b7918c47af822a0eaa17e4cdce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=ZbCto4H%2BzVeMqcqAv4NwlXI5K9U%3D" alt="图片" loading="lazy"/>​</p>
<p>你就会看到对应的分镜图片生成完毕，多个场景图就生成多张图片</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72bace283c024a6998217bb73201f0d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=zzP9gm8GIquLLDCFeUVCePWWdOs%3D" alt="图片" loading="lazy"/>​</p>
<p>接着点击生成视频，默认是直接采用场景画面的提示词，如果你想自己改造也是没问题的，均有支持</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b0f234b71d7455a988ded51f5a34b4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=K6%2F3gEE3jKOBxTaioSvfj9I9pOs%3D" alt="图片" loading="lazy"/>​</p>
<p>画面丝滑衔接，告别跳戏</p>
<p>当然很多人肯定想画面更具连贯性的，黄啊码肯定也要安排的，我在生成的视频采用了提取尾帧，只要点击后，你就可以在上边的画布中看到相关画面，然后你就可以在里边布置道具或者继续加人物，保证画面连贯性</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98170dc192b64534976f750904468ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=kVp9Pt1KOuIqke0pznSB%2F08BrOA%3D" alt="图片" loading="lazy"/>​</p>
<p>同场景批量生成，效率翻倍</p>
<p>如果你多个视频都打算用同个场景或画面，只需要点击批量生成通常同场景图片或视频，然后选择想要批量生成的场景，生成分镜图片和视频的逻辑跟上边的会保持一致</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fbaed6789b146a984ab1cf5cba63eb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=HbOYmyOYwXcW3BUOMpBCgQJV4B0%3D" alt="图片" loading="lazy"/>​</p>
<p>到此，生成视频全部完毕，你肯定会说：黄啊码，不够！不够！你这样生成的视频都是片段，我还要专门打开剪辑工具。</p>
<p>🎙️ <strong>第五步：合成大片，连剪辑软件都省了</strong></p>
<p><strong>怎么可能，片段有了，但还要导来导去剪？<strong>黄啊码连这步都给你省了。</strong></strong></p>
<p>点“生成视频解说”+“生成配音”，将他们分别复制，丢到黄啊码开发的视频合成工具里边。【工具在视频合成按钮跳转的链接里边，绝对免费】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e935fc8681d24b86b3e9aaf55e62fb95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=h4lkr1Slg%2Fw%2Fo2E%2B%2FNqyOu30hK4%3D" alt="图片" loading="lazy"/>​</p>
<p>点击开始合成</p>
<p>【注意：视频链接的数量、频频数量、场景数量要保持一致】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d42185e7459493a99f079f28fa1276d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=8WfITLUPYGehujO7kjkFyJsTKY4%3D" alt="图片" loading="lazy"/>​</p>
<p>粘贴→对齐→点击合成， <strong>2分钟！</strong> 带解说、字幕、画面的完整漫剧诞生。</p>
<p>当然如果你觉得生成的图片视频质量差，也可以在秒哒创建插件对接相关接口，比如苍何大佬推荐的Atlas平台，各种图片视频模型一应俱全，链接在此，需要自取即可<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.atlascloud.ai%2F%3Fref%3D6XTNXA" target="_blank" title="https://www.atlascloud.ai/?ref=6XTNXA" ref="nofollow noopener noreferrer">www.atlascloud.ai/?ref=6XTNXA</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b3fd852b07f48f3b8e94fa7b07355b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=b%2BaTioSocqjWiRJmvtutrgiM87M%3D" alt="图片" loading="lazy"/>​</p>
<p><strong>💰 <strong>第六步：完成商业化闭环</strong></strong></p>
<p>项目复制过去怎么使用？<strong>别急，神器连商业闭环都给你铺好了，系统自带</strong> <strong>会员功能 + 灵活积分体系（码分）</strong> ，让你轻松实现创作变现。</p>
<p>点击进入管理后台，点击码分设置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/228e4205c1654e17b028217050856bb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=kNscjRNTU36cLRUrBWn5sX9kozE%3D" alt="图片" loading="lazy"/>​</p>
<p>设置会员套餐</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef821b36f624fb3b3fb0385718b1205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=aOINYYewOe6FDYs13jjHm6eSpBc%3D" alt="图片" loading="lazy"/>​</p>
<p>设置功能码分消耗</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8519ae50573468b83cc75551537807e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=%2F0UqOjfYswToLj9S%2FB2B8x6WT%2Fo%3D" alt="图片" loading="lazy"/>​</p>
<p>然后自己在秒哒里边对接微信支付，用户就可以通过购买升级会员让你获得变现。【自己对接哦，别偷懒】</p>
<p>微信支付对接的说明文档</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.baidu.com%2Fdoc%2FMIAODA%2Fs%2FZmg4xp3fz" target="_blank" title="https://cloud.baidu.com/doc/MIAODA/s/Zmg4xp3fz" ref="nofollow noopener noreferrer">cloud.baidu.com/doc/MIAODA/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a76b4e1fc4e4c31b5297fd9a17d4e57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=RJP29TuU9vx%2Fu1hzMKIZoQ5txrI%3D" alt="图片" loading="lazy"/>​</p>
<p><strong>划重点：</strong></p>
<p>你不仅是创作者，更是平台规则的制定者，用码分控制成本，用会员锁定用户，用产品收割流量，<strong>这才是真正的睡后收入。</strong></p>
<p><strong>【额外话题】</strong></p>
<p><strong>🌌 <strong>第七步：平行世界和社区创作</strong></strong></p>
<p><strong><strong>独乐乐不如众乐乐，厌倦了单线剧情？想搞点颠覆性的如果？在这个平台，用户也可以直接Copy别人的热门小说</strong></strong></p>
<p><strong><strong>方法：点击进入平行世界，选择别人公开的小说或者你在社区购买的小说，然后选择你想要另写分支的小说章节，并写入接下来要发生的剧情</strong></strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/139b9ca9ebe1489eba599793fa919a9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=W3hRu8MbEe2MuXDxy86RBXTv3t8%3D" alt="图片" loading="lazy"/>​</p>
<p>从此刻起，副本正式启动，我的小说我做主</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28015f8182164ea2a12ec905b90f86ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=LD5E1up3fb5hGhXGVkwMaQK9oBI%3D" alt="图片" loading="lazy"/>​</p>
<p>为什么要创造社区模块？</p>
<p>你肯定会问，为什么有社区广场？因为AI生成的内容具有一定的不可复刻性，同一段提示词生成的内容都有可能千差万别，如果用户生成的小说非常好，却因为平台的原因或者不想免费无法分享，那是非常可惜的。</p>
<p>这一点是构成整个平台运营变现不可或缺的一部分，黄啊码当然也想到了，所以你只需要在小说列表中，把对应小说设置收费就可以公开出去了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09dbca0e326c48f58db5773d682e83bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=ym%2Fbao1FyaQ1lf09dRRDi6gLxzg%3D" alt="图片" loading="lazy"/>​</p>
<p>并且设置了码分兑换现金的机制，让用户花不出去的码分变成现金流</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be6a8cecbd6a4da9a2ae07d33684b68d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=JWR%2FbD3VN2R7sDyzDFSETgVzYfw%3D" alt="图片" loading="lazy"/>​</p>
<p>以及还有邀请获取积分等一系列促进用户拉新和老用户持续活跃且变现的功能，需要你们仔细去查看，黄啊码在此就不一一说明了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64dada7341d1442f9d3c6a1f3dc6ab32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=kdVp8uxouk15bonBz93EgoDmucA%3D" alt="图片" loading="lazy"/>​</p>
<p>怎么获取？</p>
<p>输入网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.miaoda.cn%2F%3Finvitecode%3Duser-6r6xw83yl62o" target="_blank" title="https://www.miaoda.cn/?invitecode=user-6r6xw83yl62o" ref="nofollow noopener noreferrer">www.miaoda.cn/?invitecode…</a></p>
<p>搜索码上制片厂，点击详情【可以的话给我点个赞更好】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff8cdab25e4249ea95d96fa6b59c0d2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=7wUbitzusjNC%2BBdDI%2FVRe97mFIk%3D" alt="图片" loading="lazy"/>​</p>
<p>点击复制应用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1224ca076e754a57a899f83b6e3cd81d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=c%2BD7Hq7hKKmD1Fpdn98SXYcnFig%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb196196a73d47cea80007153bc20e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=U%2B%2BRu9P%2B%2B%2BGNROQIsRMvKe8q8wQ%3D" alt="图片" loading="lazy"/>​</p>
<p>然后在你的个人应用就可以找到你copy的作品啦</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d74bec01d8544199691145e7205cb02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=erd8weTqhQK6GB6faLPjk8%2FmSZo%3D" alt="图片" loading="lazy"/>​</p>
<p>网友：黄啊码，你没开源源代码，属于伪开源。</p>
<p>what？我立马甩出来一个github链接堵住网友的嘴巴，是的，github同步开源。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuangama666%2Faimanju%25C2%25A0" target="_blank" title="https://github.com/huangama666/aimanju%C2%A0" ref="nofollow noopener noreferrer">github.com/huangama666…</a> 遵循的是Apache-2.0 license，意思就是可商用，可随便改</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fad771fea4ce48ba97771fa0aa89f790~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5ZWK56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345726&amp;x-signature=K5%2FvL%2FJ%2FnDdmzQmPLI3ruX68qkA%3D" alt="图片" loading="lazy"/>​</p>
<p>最后说一句，风口从不等人，红利期永远是短暂的，AI漫剧当前正是风口期，跟你说机会，你说没工具，现在有工具，你不要跟我说连鼠标都不想动吧？</p>
<p>我是黄啊码，码字的码，如果觉得受用，欢迎一键三连，另外如果想进入私人交流群一起交流学习，也可以扫码V我。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在AI时代下，程序员的2HourBuilder最小版本]]></title>    <link>https://juejin.cn/post/7600615229996400690</link>    <guid>https://juejin.cn/post/7600615229996400690</guid>    <pubDate>2026-01-30T02:40:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600615229996400690" data-draft-id="7600678255041626121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在AI时代下，程序员的2HourBuilder最小版本"/> <meta itemprop="keywords" content="前端,Vue.js,程序员"/> <meta itemprop="datePublished" content="2026-01-30T02:40:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小酒星小杜"/> <meta itemprop="url" content="https://juejin.cn/user/1512542215093479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在AI时代下，程序员的2HourBuilder最小版本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1512542215093479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小酒星小杜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:40:04.000Z" title="Fri Jan 30 2026 02:40:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#36ace1;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{color:#36ace1}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"";display:block;position:absolute;left:0;top:0;bottom:0;margin:auto;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAF8UlEQVRIS71Wa2wUVRT+7r0zu9t2t/RBaSioPCpYbIUfaEIQUogSAwZDAlUSGwgg/CBATExMCJH1D2hIfOEjFEUEhViCgBgIUCH44OkjPAMGBVqhpUCfW3Zn5z7MuQOE0hYxMdxJdmd25s53vnO+851leMCLPWA8/CfA2TsvL8n7q+nTFfNLG+4VqInHOeJLDQMzdz/3r4DGGDb9lxu+aPcE7U61JHDMDePcuv0O21ShugOefqDdtBie3Dk6K/O+Ab+qOjJiz7Ahv6c8hbDDwRiQlgYGDOcaWyEcjg8On+j71IpJndjGt9XO+jM7+pkywNvbazIfercieSdoJ4bE5sWjyZqMpDdeaQNXMNC34ME3LV8B56+1w3AOgk+EXe/Ub6uiLB6XdH/G/mYjeBCcFwnt3zQqWt4t4NjjnhzQ1CGkBhwOCMFAB71U0qsYgRlwBtQ1tiEJAy44OBdQUmFK3aWS06NLT+ukZAQoKCCjsfbDmk6p78RwX3ncWffmIj8U4kh6GpEwh+9rGy23LDU4GBrrm9DsuDYIGMAYIC/EUNQ7Cq1hn+WM2TI8f+jEyCmvjfn1FssuojHx6tDkyZOaCzr8TNpASzDAk8amlRIrEylcSGsYrcGIstIYWhgDDIM2BiGH3ywFkGAC1U9n38bpVqWGdk6r4HMWrZZaG1D5KLn0qYyBEAKnG1otAxLR8L7Z9nfP13CJHQ/ST4vK8sVHe8JsU0U6uO5hlexo8PI7vNDQomwoBRAwpSmtgJAAztS3QLsOsmBQlBtFJMQhlbbPUBBUR7o2hqHVddLbRsfCPQJ+u3TPw8uGl1yklAlHIJZKo3//XEhlLCtifPFyM7xwCI/lZ8IKTTBbS7pPLIggZZsSQ+zXbT4UYSsnet3UMM5HPT5LGbrDGYQroClyT2Jwnyj9aN949e8mDCwuRFoqKxRHUJ21BSDRELuQYGhvbMVV32Dp2RuxcfHSRBfAYTsbU9nJdFj5EiLkglHkRInC1xoxKbH9hQJIaTDvxxTCUddWl4wg0dCCtqSPDmoVx4Eitpxh64ZtsT6b5ie6pPRkfF90TllxOzEwmipMKRRgHODGgCuJkqIcvDdC2BZ5Y+tlHHMzkAKghbAxcQqQDiKrFBxhqg5MHTivS1tQ+sdsvaQl5Yd6yfdRXNQLsQwXnq/AQFLXEIIjzBSuNaaR0SuEtkQKl9IKjAsbJaWfzo1USDsM6zceDJfeVGgnhhN2N7YOyo5kJz1pa2AbgfrO1gRwXW6vSRQNtddR+EhvKGmseskgTtY2Q7kucYWWgToPHzyUyXry0iXfnBtfl5f/PaWPvPNW/zkOAQegJHltFE5dSaCskHqPVEnqpMAMEgkPtR1pKxyh/N0/vTToubtH1G3RmLjhM8ubKXfWB2mRa9ySOaWS2uT8lTZ0cI6I52Ngv7zAbW9mQVm1cpytu441P38XeXTlQu+e46nyh+bjLkMZRU0MCYTCJWZSG1y7cBWNURpxBlxqFBfEwGnGGhaYPSNwhpSv4DK+/vPynBk9MqRIiOWs8a2WJTm9a+cgh6SaMIMz9W1WjYHHMtv0wSmZdWB9gdsya/rcYVg7JoffCdqlD6ceTpiY59tM0PhJp5WNvra+BQkejCMyBarr8KKYDcZi8sDaCDKYFIGRk+FnSVXzyTO9JxBwF8DLc1dlLn65ooNEYN0fBsu21fTvL6PXnhxXlnLIqqhYYBian4lQ2Lk9ogiALsimiLC1QYfhlV1Hnxh7JfcMqxrpd7U2GFa5t9nOd7Kr+kg4uWvnCpromlJeXlq3Os3ZLOlrZBmNQf1ybVqpxhbA7mRIOCy1+esDOWhIyDv/+3Q7LRbsqH+rKRJ+nba+/+WW7II1s9vvVBuNr7KNF1WUM1bSt5f1Vq01jUVkKfnx8uoti3Or5rbd9782M61azJz/rFywYU/OyKqK1p5G2MS1Z18tGFDwTkvIxcK9RwaMP3a9/tbc62lPj/Nw5B9ey9Ehy/MY4oEqelgNleuyCgdXJlmc3fO5Ll56r5f+n/f+AWFf9jvBgaHpAAAAAElFTkSuQmCC);animation:spin 2s linear 1s infinite}.markdown-body h1{position:relative;font-size:30px;padding:12px 38px;margin:30px 0}.markdown-body h1:before{width:30px;height:30px;background-size:30px 30px}.markdown-body h2{position:relative;font-size:24px;padding:12px 36px;margin:28px 0}.markdown-body h2:before{width:28px;height:28px;background-size:28px 28px}.markdown-body h3{position:relative;font-size:18px;padding:4px 32px;margin:26px 0}.markdown-body h3:before{width:24px;height:24px;background-size:24px 24px}.markdown-body h4{position:relative;padding:4px 28px;font-size:16px;margin:22px 0}.markdown-body h4:before{width:20px;height:20px;background-size:20px 20px}.markdown-body h5{position:relative;padding:4px 26px;font-size:15px;margin:20px 0}.markdown-body h5:before{width:18px;height:18px;background-size:18px 18px}.markdown-body h6{position:relative;padding:4px 22px;font-size:14px;margin:16px 0}.markdown-body h6:before{width:16px;height:16px;background-size:16px 16px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#36ace1,#dff0fe,#36ace1);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:50px;height:24px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAEgElEQVRIS72Va0xbZRjH/z2FcimbchEQFDYRCIRAAWFQ2MaCXBwmUxYDLGGEcRFkH9wmk04zG0Bo2dwNIisERANqhjqdEmhd4nRbuwpsXDYWLLoRgeG4Chu9QHvMOQ0dpTAKH3y/tDnv8/5/z/Oc//scBv6nxdgoJ14gVYPEuITHdTdHY12gRIH0T0KljlqwthqUFHGtzAEsxqwLtPvkdc+FeeI3BgMeAMEhdOqR1mM7xswBrgmKE8pfIUhtm7fbZsft/i7wc98MtrUFxmbU6ByYgFwxjtFp5Q+WpF1mCy9wajXoqqD4E91saOf603e+5B7t99xTkyZJEiKJAl2DE9Xio1HvrBS8IuhVwVUP503swdJ9QWAw1izaoDs6pQT/655BMS9yy3KYiUoM/7adu7NmtnQfx5zWm8Q8Ui3gyGcddyU8rv/STRNQouDGP5/mhTubX4dpPv3DMzh1qS9LwuPWr+i63WVyn5QYj/4d/i4bqmbpoQ+auvBlQYghX6PE4wTSOzV5EUYlb5Q4MDqLk9/3cMRF27spDSNQamUnWZ4ebNB+OKNCyYVeFCZ5wZ5tiePN/UiP2YoQL0cUX+iFt4sNUiLdcaVvHJLecQiWnKVE8s5LvxAXRWeYgHLre0hecgAN0sxr0XBZgbJUP6OiLnaM4ivZCBrzOWBZEIY9rY5E8pl2nM0KMzzLq5aPiXmRzgbQm2VyR8KGGK/ICAFB6IusbvsDwhRf+n/jtSHc/nsGgjR9V6/1TyLa1wGU+FtnO1CbHQTHTSzIFJOYJ1jwcGLTccMTcyhp7oW4KFJ/SV4/IScrc55kQj07WNuOn94Lpw8kCm/Qv3W5HLjbWxsyfuNUO1TzWjAJBloKt2FBS+Jz6ShiA12NupBdLWugQcmn28lPMkONNql3U5cTSD9Lq+qEUqPFt++G0aKL687wDAqb+pAU7IKCuK2493AOPQ9UCNpib6T1tkg+RZ9KKJcNn8sJc1vac8o16jklLWLuOiDqwvHUIKPw7vtTON+iCDKkl/Cx9FeSYET5um1mHt6jN0Dz9ftwYjORudNjTdaBmi7kxvvA1d6Gjs0X/Q5Sp3tMEMSHre9HnDEZAPFCWUNVdliGJVPvqEP1Hbh4yPj9LadSY6fu6gPsCX+B3mq7NYLv2od8fj4aoViMNQGFijos/XVMTXGavgUisQIle71hwVx9KFEutLVjw8GORTuxoEbeJS7iPrmQyy/sIj2hQpqYHO7ZGs95nnZS4y8K8Pfqrb58UZ+IlKqbqNgfQm8da+pC9xjLqo8foFkau2qaCeXSyvzXfA9SDrp1bxJ/DU/jSJKXEWdBR2J/9U0UpwXTFZ/+8S76h/71FvO4A8sTeuqQThDKalOiPLN3BbhiYlaNsm964elkCztrC4xMqeDqYIus2JdB3cbS5l4MTag44qJt9GxbF4gKThRKY59lW13+KCUQ1pZMEwHKviKx4pFSqXzxCn/X9Gr2NO+zw+cTiTbxmUyCqH3GlsWg2kRNhOnHmhlrFkIvHTZt1borWvMCmRnwH4usn58STiycAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body del{color:#36ace1}.markdown-body code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#282c34;color:#4ec9b0;padding:.24em .46em;margin:0 4px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;font-size:12px;border-radius:10px;padding:15px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#4ec9b0;background:#282c34}.markdown-body a{text-decoration:none;color:#409eff;border-bottom:1px solid #409eff}.markdown-body a:active,.markdown-body a:hover{color:#007bff;border-bottom:1px solid #007bff}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;padding:8px 26px;background-color:rgba(54,172,225,.75);margin:16px 0;border-left:4px solid #409eff;border-radius:5px}.markdown-body blockquote:before{content:"❝";top:10px;left:8px;color:#409eff;font-size:20px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:20px;position:absolute;right:8px;bottom:0;color:#409eff;opacity:.7}.markdown-body blockquote&gt;p{color:#fff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Builder 的一周节律（直接可执行）</h2>
<h3 data-id="heading-1">2-Hour 的真实用途</h3>
<p>先说明，这2小时不是用来“把事情做完”的。</p>
<p>它的用户是确保你<strong>每天至少发生一次“现实接触”。</strong></p>
<hr/>
<h3 data-id="heading-2">推荐的周节律</h3>
<p>这是一个可以直接复制的最小节奏：</p>
<p>1️⃣ 2天用于构建/思考</p>
<p>2️⃣ 2天公开输出</p>
<p>3️⃣ 1天对话和转化</p>
<p>4️⃣ 2天休息和输入</p>
<p>你可以调整顺序和天数，<strong>但是一定要保持输入日的存在。</strong></p>
<p>一周里必须有明确的对外输出时间，</p>
<p>否则你只是一个准备得很认真的隐形人。</p>
<hr/>
<h2 data-id="heading-3">为什么这个 OS 能避免“反 Demo 地狱”</h2>
<h3 data-id="heading-4">Demo 地狱的本质</h3>
<p>不是技术问题，而是：</p>
<blockquote>
<p><strong>你一直在为“未来的观众”准备内容。</strong></p>
</blockquote>
<p>一直在等待，从来不发布，<strong>于是永远在为一个不存在的时刻服务。</strong></p>
<hr/>
<h3 data-id="heading-5">OS 如何强制你面对现实</h3>
<p>Builder OS 直接切断这一条退路</p>
<ul>
<li><strong>输出必须公开</strong></li>
<li><strong>反馈必须发生</strong></li>
<li><strong>交易必须尝试</strong></li>
</ul>
<p>没有“等一等”，你每天都要站在现实面前，哪怕是半成品。</p>
<hr/>
<h2 data-id="heading-6">Builder OS 的最低实现版本</h2>
<h3 data-id="heading-7">你只需要 3 个东西</h3>
<p>1️⃣ 一个记录假设的地方</p>
<ul>
<li>我在解决什么？</li>
<li>我假设谁在乎</li>
<li>我今天验证了没有？</li>
</ul>
<p>2️⃣ 一个固定输出渠道</p>
<ul>
<li>永远是同一个地方</li>
<li>不纠结平台，不追热点</li>
</ul>
<p>3️⃣ 一个能收钱的入口</p>
<ul>
<li>哪怕今天没人付款</li>
<li>但“可以付”这件事必须存在</li>
</ul>
<p>📌 重点：</p>
<blockquote>
<p><strong>工具选型不重要，行为结构才重要。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-8">OS 失败的唯一原因</h3>
<p>Builder OS 只会因为一件事失败：</p>
<p><strong>你允许自己，今天不面对现实。</strong></p>
<p>不是你不够聪明，</p>
<p>不是你资源不好， 不是你状态不好。</p>
<p><strong>而是你给了自己一个“今天可以不发布”的特权。</strong></p>
<hr/>
<h2 data-id="heading-9">本章总结</h2>
<h3 data-id="heading-10">Builder OS 的一句话版本</h3>
<blockquote>
<p><strong>把每天的一小段时间，</strong> <strong>稳定转换为：</strong> <strong>一次公开表达 + 一次现实反馈。</strong></p>
</blockquote>
<p>只要这件事发生了，这一天就是成功的。</p>
<hr/>
<h3 data-id="heading-11">你不需要再“优化系统”</h3>
<p>你只需要回答一个问题：</p>
<blockquote>
<p><strong>这个系统，明天会不会逼我再次暴露？</strong></p>
</blockquote>
<p>如果答案是“会”，它就是对的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude 3.5 Sonnet 在 SWE-bench Verified 上的性能突破]]></title>    <link>https://juejin.cn/post/7600663744192725028</link>    <guid>https://juejin.cn/post/7600663744192725028</guid>    <pubDate>2026-01-29T14:33:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600663744192725028" data-draft-id="7600606150732922923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude 3.5 Sonnet 在 SWE-bench Verified 上的性能突破"/> <meta itemprop="keywords" content="LLM,Agent"/> <meta itemprop="datePublished" content="2026-01-29T14:33:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户53021213292"/> <meta itemprop="url" content="https://juejin.cn/user/3054878532050676"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude 3.5 Sonnet 在 SWE-bench Verified 上的性能突破
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3054878532050676/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户53021213292
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T14:33:20.000Z" title="Thu Jan 29 2026 14:33:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude 3.5 Sonnet 在 SWE-bench Verified 上的性能突破</h2>
<blockquote>
<p>原文链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fswe-bench-sonnet" target="_blank" title="https://www.anthropic.com/engineering/swe-bench-sonnet" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p>发布日期: 2025年1月6日</p>
</blockquote>
<h3 data-id="heading-1">核心成果概述</h3>
<p>Anthropic 2025年1月发布的升级版 Claude 3.5 Sonnet 在 SWE-bench Verified 软件工程评估基准测试中取得了 <strong>49%</strong> 的成绩，超越了此前最先进模型的 45% 的表现。本文详细解释了围绕该模型构建的"智能体"（agent）系统，旨在帮助开发者从 Claude 3.5 Sonnet 中获得最佳性能。</p>
<hr/>
<h3 data-id="heading-2">什么是 SWE-bench</h3>
<p>SWE-bench 是一个 AI 评估基准，用于评估模型完成真实世界软件工程任务的能力。具体来说，它测试模型如何解决来自流行开源 Python 仓库的 GitHub 问题。对于基准测试中的每个任务，AI 模型会获得一个已配置好的 Python 环境，以及该问题解决之前的仓库检出（本地工作副本）。然后，模型需要理解、修改和测试代码，最后提交其提议的解决方案。</p>
<p>每个解决方案都会根据关闭原始 GitHub 问题的拉取请求中的真实单元测试进行评分。这测试了 AI 模型是否能够实现与原始 PR 人类作者相同的功能。</p>
<p>SWE-bench 不仅仅是孤立地评估 AI 模型，而是评估整个"智能体"系统。在这个上下文中，"智能体"指的是 AI 模型与其周围软件脚手架的组合。这个脚手架负责生成输入模型的提示词、解析模型的输出以采取行动，以及管理交互循环（将模型先前行动的结果纳入其下一个提示词中）。即使使用相同的底层 AI 模型，智能体在 SWE-bench 上的性能也会因这个脚手架而有显著差异。</p>
<p><strong>💡 SWE-bench 评估流程</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[GitHub Issue] --&gt; B[AI 模型接收任务]
    B --&gt; C[Python 环境 + 仓库检出]
    C --&gt; D[模型理解问题]
    D --&gt; E[修改代码]
    E --&gt; F[测试代码]
    F --&gt; G{通过测试?}
    G --&gt;|否| D
    G --&gt;|是| H[提交解决方案]
    H --&gt; I[运行真实单元测试]
    I --&gt; J[评分]
</code></pre>
<hr/>
<h3 data-id="heading-3">SWE-bench 的独特优势</h3>
<p>虽然有许多其他用于评估大型语言模型编码能力的基准测试，但 SWE-bench 因以下几个原因而越来越受欢迎：</p>
<ol>
<li>
<p><strong>真实工程任务</strong>：它使用来自实际项目的真实工程任务，而不是竞赛或面试式问题；</p>
</li>
<li>
<p><strong>尚未饱和</strong>：仍有充足的改进空间。还没有模型在 SWE-bench Verified 上超过 50% 的完成率（尽管截至2025年1月时，升级版 Claude 3.5 Sonnet 达到了 49%）；</p>
</li>
<li>
<p><strong>整体评估</strong>：它衡量的是整个"智能体"，而不是孤立的模型。开源开发者和初创公司在优化脚手架方面取得了巨大成功，大幅提升了相同模型的性能。</p>
</li>
</ol>
<p><strong>💡 SWE-bench 三大优势</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Root((SWE-bench 优势))
    Root --&gt; A[真实任务]
    Root --&gt; B[未饱和]
    Root --&gt; C[整体评估]
    
    A --&gt; A1[实际项目]
    A --&gt; A2[GitHub Issues]
    
    B --&gt; B1[最高 49%]
    B --&gt; B2[改进空间大]
    
    C --&gt; C1[模型+脚手架]
    C --&gt; C2[完整系统]
</code></pre>
<hr/>
<h3 data-id="heading-4">SWE-bench Verified 数据集说明</h3>
<p>需要注意的是，原始 SWE-bench 数据集包含一些在没有 GitHub 问题之外的额外上下文（例如关于要返回的特定错误消息）的情况下无法解决的任务。<strong>SWE-bench Verified</strong> 是 SWE-bench 的一个包含 500 个问题的子集，经过人工审查以确保它们是可解决的，因此提供了编码智能体性能最清晰的衡量标准。本文将主要参考这个基准测试。</p>
<hr/>
<h3 data-id="heading-5">实现最先进性能的方法</h3>
<h4 data-id="heading-6">工具使用智能体架构</h4>
<p>在为升级版 Claude 3.5 Sonnet 优化智能体脚手架时，我们的设计理念是<strong>尽可能多地将控制权交给语言模型本身，并保持脚手架最小化</strong>。该智能体包含：</p>
<ul>
<li>一个<strong>提示词</strong></li>
<li>一个用于执行 bash 命令的 <strong>Bash 工具</strong></li>
<li>一个用于查看和编辑文件和目录的<strong>编辑工具</strong></li>
</ul>
<p>我们持续采样，直到模型决定完成任务，或超过其 200k 上下文长度限制。这种脚手架允许模型根据自己的判断来处理问题，而不是被硬编码到特定的模式或工作流程中。</p>
<p>提示词概述了模型的建议方法，但对于这项任务来说，它并不太长或过于详细。模型可以自由选择如何从一个步骤过渡到另一个步骤，而不是有严格和离散的转换。如果你对令牌（token）不敏感，明确鼓励模型产生长响应会有所帮助。</p>
<p><strong>💡 智能体架构设计</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Agent((智能体系统))
    
    Agent --&gt; Model[AI 模型]
    Agent --&gt; Scaffold[脚手架]
    
    Model --&gt; M1[Claude 3.5 Sonnet]
    Model --&gt; M2[200k 上下文窗口]
    Model --&gt; M3[自主决策能力]
    
    Scaffold --&gt; S1[提示词]
    Scaffold --&gt; S2[Bash 工具]
    Scaffold --&gt; S3[编辑工具]
    
    S1 --&gt; P1[建议方法]
    S1 --&gt; P2[灵活步骤]
    
    S2 --&gt; B1[执行命令]
    S2 --&gt; B2[环境管理]
    
    S3 --&gt; E1[查看文件]
    S3 --&gt; E2[编辑文件]
    S3 --&gt; E3[字符串替换]
</code></pre>
<hr/>
<h4 data-id="heading-7">智能体提示词</h4>
<p>以下代码展示了我们智能体脚手架的提示词：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">&lt;uploaded_files&gt;
{location}
&lt;/uploaded_files&gt;
I<span class="hljs-comment">'ve uploaded a python code repository in the directory {location} (not in /tmp/inputs). Consider the following PR description:</span>

&lt;pr_description&gt;
{pr_description}
&lt;/pr_description&gt;

Can you help <span class="hljs-keyword">me</span> implement the necessary changes <span class="hljs-keyword">to</span> the repository so that the requirements specified <span class="hljs-keyword">in</span> the &lt;pr_description&gt; are met?
I<span class="hljs-comment">'ve already taken care of all changes to any of the test files described in the &lt;pr_description&gt;. This means you DON'T have to modify the testing logic or any of the tests in any way!</span>

Your task <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span> make the minimal changes <span class="hljs-keyword">to</span> non-tests files <span class="hljs-keyword">in</span> the {location} directory <span class="hljs-keyword">to</span> ensure the &lt;pr_description&gt; <span class="hljs-built_in">is</span> satisfied.

Follow these steps <span class="hljs-keyword">to</span> resolve the issue:
<span class="hljs-number">1</span>. <span class="hljs-keyword">As</span> a first <span class="hljs-keyword">step</span>, it might be a good idea <span class="hljs-keyword">to</span> explore the repo <span class="hljs-keyword">to</span> familiarize yourself <span class="hljs-keyword">with</span> its <span class="hljs-keyword">structure</span>.
<span class="hljs-number">2</span>. Create a script <span class="hljs-keyword">to</span> reproduce the <span class="hljs-keyword">error</span> <span class="hljs-built_in">and</span> execute it <span class="hljs-keyword">with</span> `python &lt;filename.py&gt;` <span class="hljs-keyword">using</span> the BashTool, <span class="hljs-keyword">to</span> confirm the <span class="hljs-keyword">error</span>
<span class="hljs-number">3</span>. Edit the sourcecode <span class="hljs-keyword">of</span> the repo <span class="hljs-keyword">to</span> resolve the issue
<span class="hljs-number">4</span>. Rerun your reproduce script <span class="hljs-built_in">and</span> confirm that the <span class="hljs-keyword">error</span> <span class="hljs-built_in">is</span> fixed!
<span class="hljs-number">5</span>. Think about edgecases <span class="hljs-built_in">and</span> make sure your fix <span class="hljs-keyword">handles</span> them <span class="hljs-keyword">as</span> well

Your thinking should be thorough <span class="hljs-built_in">and</span> so it<span class="hljs-comment">'s fine if it's very long.</span>
</code></pre>
<p><strong>💡 建议的问题解决步骤</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[1. 探索仓库结构] --&gt; B[2. 创建重现脚本]
    B --&gt; C[3. 确认错误]
    C --&gt; D[4. 修改源代码]
    D --&gt; E[5. 重新测试]
    E --&gt; F{修复成功?}
    F --&gt;|否| D
    F --&gt;|是| G[6. 检查边界情况]
    G --&gt; H[完成]
</code></pre>
<hr/>
<h4 data-id="heading-8">Bash 工具规范</h4>
<p>模型的第一个工具执行 Bash 命令。架构很简单，只需要在环境中运行的命令。然而，工具的描述更重要。它包含了对模型的更详细说明，包括转义输入、缺乏互联网访问，以及如何在后台运行命令。</p>
<p>以下是 Bash 工具的规范：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bash"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Run commands in a bash shell\n
* When invoking this tool, the contents of the \"command\" parameter does NOT need to be XML-escaped.\n
* You don't have access to the internet via this tool.\n
* You do have access to a mirror of common linux and python packages via apt and pip.\n
* State is persistent across command calls and discussions with the user.\n
* To inspect a particular line range of a file, e.g. lines 10-25, try 'sed -n 10,25p /path/to/the/file'.\n
* Please avoid commands that may produce a very large amount of output.\n
* Please run long lived commands in the background, e.g. 'sleep 10 &amp;' or start a server in the background."</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"input_schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
       <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
           <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"The bash command to run."</span>
           <span class="hljs-punctuation">}</span>
       <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"command"</span><span class="hljs-punctuation">]</span>
   <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>💡 Bash 工具关键说明</strong></p>

































<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>XML 转义</td><td>命令参数不需要 XML 转义</td></tr><tr><td>网络访问</td><td>❌ 无互联网访问</td></tr><tr><td>包管理</td><td>✅ 可通过 apt 和 pip 安装常用包</td></tr><tr><td>状态持久化</td><td>✅ 跨命令调用保持状态</td></tr><tr><td>输出限制</td><td>避免产生大量输出的命令</td></tr><tr><td>后台运行</td><td>支持后台运行长时命令</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-9">编辑工具规范</h4>
<p>模型的第二个工具（编辑工具）要复杂得多，包含了模型查看、创建和编辑文件所需的一切。同样，我们的工具描述包含了关于如何使用该工具的详细信息。</p>
<p>我们在各种智能体任务中对这些工具的描述和规范投入了大量精力。我们对它们进行了测试，以发现模型可能误解规范的任何方式，或使用工具的可能陷阱，然后编辑描述以预防这些问题。<strong>我们认为，应该像对设计人类工具界面投入大量关注一样，对为模型设计工具界面投入更多关注。</strong></p>
<p>以下代码展示了编辑工具的描述：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"str_replace_editor"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Custom editing tool for viewing, creating and editing files\n
* State is persistent across command calls and discussions with the user\n
* If `path` is a file, `view` displays the result of applying `cat -n`. If `path` is a directory, `view` lists non-hidden files and directories up to 2 levels deep\n
* The `create` command cannot be used if the specified `path` already exists as a file\n
* If a `command` generates a long output, it will be truncated and marked with `&lt;response clipped&gt;` \n
* The `undo_edit` command will revert the last edit made to the file at `path`\n
\n
Notes for using the `str_replace` command:\n
* The `old_str` parameter should match EXACTLY one or more consecutive lines from the original file. Be mindful of whitespaces!\n
* If the `old_str` parameter is not unique in the file, the replacement will not be performed. Make sure to include enough context in `old_str` to make it unique\n
* The `new_str` parameter should contain the edited lines that should replace the `old_str`"</span><span class="hljs-punctuation">,</span>
...
<span class="hljs-punctuation">}</span>
</code></pre>
<p>编辑工具的完整输入规范如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"input_schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
       <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
           <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"enum"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"view"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"create"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"str_replace"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"insert"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"undo_edit"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"The commands to run. Allowed options are: `view`, `create`, `str_replace`, `insert`, `undo_edit`."</span>
           <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
           <span class="hljs-attr">"file_text"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Required parameter of `create` command, with the content of the file to be created."</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
           <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
           <span class="hljs-attr">"insert_line"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Required parameter of `insert` command. The `new_str` will be inserted AFTER the line `insert_line` of `path`."</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"integer"</span>
           <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
           <span class="hljs-attr">"new_str"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Required parameter of `str_replace` command containing the new string. Required parameter of `insert` command containing the string to insert."</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
           <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
           <span class="hljs-attr">"old_str"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Required parameter of `str_replace` command containing the string in `path` to replace."</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
           <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
           <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Absolute path to file or directory, e.g. `/repo/file.py` or `/repo`."</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
           <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
           <span class="hljs-attr">"view_range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
               <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Optional parameter of `view` command when `path` points to a file. If none is given, the full file is shown. If provided, the file will be shown in the indicated line number range, e.g. [11, 12] will show lines 11 and 12. Indexing at 1 to start. Setting `[start_line, -1]` shows all lines from `start_line` to the end of the file."</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"items"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                   <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"integer"</span>
               <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
               <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"array"</span>
           <span class="hljs-punctuation">}</span>
       <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"path"</span><span class="hljs-punctuation">]</span>
   <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>💡 编辑工具命令对比</strong></p>









































<table><thead><tr><th>命令</th><th>用途</th><th>必需参数</th><th>说明</th></tr></thead><tbody><tr><td><code>view</code></td><td>查看文件/目录</td><td>path</td><td>文件显示带行号，目录显示2级深度</td></tr><tr><td><code>create</code></td><td>创建新文件</td><td>path, file_text</td><td>文件已存在时不可用</td></tr><tr><td><code>str_replace</code></td><td>替换字符串</td><td>path, old_str, new_str</td><td>old_str 必须唯一匹配</td></tr><tr><td><code>insert</code></td><td>插入内容</td><td>path, insert_line, new_str</td><td>在指定行后插入</td></tr><tr><td><code>undo_edit</code></td><td>撤销编辑</td><td>path</td><td>撤销最后一次编辑</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-10">工具改进：错误防护</h4>
<p>我们改进性能的一个方法是让我们的工具"防错"。例如，有时模型在智能体移出根目录后可能会搞乱相对文件路径。为了防止这种情况，我们简单地<strong>让工具始终要求使用绝对路径</strong>。</p>
<p>我们尝试了几种不同的策略来指定对现有文件的编辑，并发现<strong>字符串替换</strong>的可靠性最高，其中模型在给定文件中指定要用 <code>new_str</code> 替换的 <code>old_str</code>。只有当 <code>old_str</code> 恰好有一个匹配时，才会进行替换。如果匹配数量更多或更少，模型会看到适当的错误消息以便重试。</p>
<p><strong>💡 防错设计原则</strong></p>






























<table><thead><tr><th>问题</th><th>解决方案</th><th>效果</th></tr></thead><tbody><tr><td>相对路径混乱</td><td>强制使用绝对路径</td><td>消除路径歧义</td></tr><tr><td>多处匹配</td><td>要求唯一匹配</td><td>精确定位修改</td></tr><tr><td>匹配失败</td><td>显示错误消息</td><td>允许重试</td></tr><tr><td>状态丢失</td><td>跨调用持久化</td><td>保持上下文</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">性能结果</h3>
<p>总体而言，升级版 Claude 3.5 Sonnet 展示了比我们之前的模型和之前最先进的模型更高的推理、编码和数学能力。它还展示了改进的智能体能力：工具和脚手架有助于将这些改进的能力发挥到最佳用途。</p>
<h4 data-id="heading-12">性能对比表</h4>

























<table><thead><tr><th>模型</th><th>SWE-bench Verified 得分</th></tr></thead><tbody><tr><td><strong>Claude 3.5 Sonnet (升级版)</strong></td><td><strong>49%</strong></td></tr><tr><td>之前的 SOTA</td><td>45%</td></tr><tr><td>Claude 3.5 Sonnet (旧版)</td><td>33%</td></tr><tr><td>Claude 3 Opus</td><td>22%</td></tr></tbody></table>
<p><em>所有模型均使用此智能体脚手架在 SWE-bench Verified 上的得分</em></p>
<p><strong>💡 性能提升路径</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Claude 3 Opus&lt;br/&gt;22%] --&gt;|+11%| B[Sonnet 旧版&lt;br/&gt;33%]
    B --&gt;|+12%| C[之前 SOTA&lt;br/&gt;45%]
    C --&gt;|+4%| D[Sonnet 新版&lt;br/&gt;49%]
    D -.-&gt;|目标| E[50% 里程碑]
    
    style D fill:#90EE90
    style E fill:#FFD700
</code></pre>
<hr/>
<h3 data-id="heading-13">智能体行为示例</h3>
<p>为了运行基准测试，我们使用 <strong>SWE-Agent</strong> 框架作为智能体代码的基础。在下面的日志中，我们将智能体的文本输出、工具调用和工具响应呈现为 THOUGHT（思考）、ACTION（行动）和 OBSERVATION（观察），尽管我们并没有将模型限制在固定的顺序中。</p>
<p>以下代码块将演示 Sonnet 3.5 解决 SWE-bench 问题的典型案例。</p>
<h4 data-id="heading-14">步骤 1：初始提示和问题描述</h4>
<p>在第一个代码块中，你可以看到给模型的部分初始提示，其中 <code>{pr_description}</code> 被填充为来自 SWE-bench 任务的实际值。重要的是，此任务包含重现问题的步骤，这将为模型提供宝贵的调查起点。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">&lt;uploaded_files&gt;
/repo
&lt;/uploaded_files&gt;
I<span class="hljs-comment">'ve uploaded a python code repository in the directory /repo (not in /tmp/inputs). Consider the following PR description:</span>

&lt;pr_description&gt;
linear_model.RidgeClassifierCV<span class="hljs-comment">'s Parameter store_cv_values issue</span>

#### Description
Parameter store_cv_values <span class="hljs-keyword">error</span> <span class="hljs-keyword">on</span> sklearn.linear_model.RidgeClassifierCV

#### Steps/Code <span class="hljs-keyword">to</span> Reproduce
import numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> sklearn import linear_model <span class="hljs-keyword">as</span> lm

#test database
n = <span class="hljs-number">100</span>
x = np.random.randn(n, <span class="hljs-number">30</span>)
y = np.random.normal(size = n)

rr = lm.RidgeClassifierCV(alphas = np.arange(<span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">0.1</span>), normalize = <span class="hljs-literal">True</span>, 
                                         store_cv_values = <span class="hljs-literal">True</span>).fit(x, y)

#### Expected Results
Expected <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> the usual ridge regression model output, keeping the cross validation predictions <span class="hljs-keyword">as</span> attribute.

#### Actual Results
<span class="hljs-symbol">TypeError:</span> __init__() got an unexpected keyword argument <span class="hljs-comment">'store_cv_values'</span>

lm.RidgeClassifierCV actually has no parameter store_cv_values, even though some attributes depends <span class="hljs-keyword">on</span> it.
&lt;/pr_description&gt;
</code></pre>
<h4 data-id="heading-15">步骤 2：探索仓库结构</h4>
<p>模型首先使用编辑工具查看仓库结构：</p>
<pre><code class="hljs language-bash" lang="bash">THOUGHT:
I<span class="hljs-string">'ll help you implement the changes to satisfy the PR description. Let'</span>s follow the steps you outlined.

1. First, <span class="hljs-built_in">let</span><span class="hljs-string">'s explore the repo structure:

ACTION (str_replace_editor):
command: view
path: /repo

OBSERVATION:
Here'</span>s the files and directories up to 2 levels deep <span class="hljs-keyword">in</span> /repo, excluding hidden items:
/repo
/repo/PULL_REQUEST_TEMPLATE.md
/repo/ISSUE_TEMPLATE.md
/repo/sklearn
/repo/sklearn/decomposition
/repo/sklearn/kernel_ridge.py
/repo/sklearn/model_selection
/repo/sklearn/covariance
/repo/sklearn/cluster
/repo/sklearn/base.py
/repo/sklearn/dummy.py
/repo/sklearn/naive_bayes.py
...
</code></pre>
<h4 data-id="heading-16">步骤 3：创建重现脚本</h4>
<p>模型使用编辑工具创建一个新脚本，用于重现问题并测试其修复：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">THOUGHT:</span>
Based <span class="hljs-keyword">on</span> the repository <span class="hljs-keyword">structure</span>, we<span class="hljs-comment">'ll need to modify the Ridge Classifier in the `sklearn/linear_model` directory.</span>

<span class="hljs-keyword">Let</span><span class="hljs-comment">'s create a script to reproduce the error:</span>

ACTION (str_replace_editor):
<span class="hljs-symbol">command:</span> create
<span class="hljs-symbol">path:</span> /repo/reproduce_error.py
<span class="hljs-symbol">file_text:</span>
import numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> sklearn import linear_model <span class="hljs-keyword">as</span> lm

#test database
n = <span class="hljs-number">100</span>
x = np.random.randn(n, <span class="hljs-number">30</span>)
y = np.random.normal(size = n)

rr = lm.RidgeClassifierCV(alphas=np.arange(<span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">0.1</span>), normalize=<span class="hljs-literal">True</span>, 
                         store_cv_values=<span class="hljs-literal">True</span>).fit(x, y)

<span class="hljs-symbol">OBSERVATION:</span>
File created successfully at: /repo/reproduce_error.py
</code></pre>
<h4 data-id="heading-17">步骤 4：执行脚本确认错误</h4>
<p>模型使用 Bash 工具执行脚本，成功重现问题：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">THOUGHT:</span>
<span class="hljs-keyword">Let</span><span class="hljs-comment">'s verify that we can reproduce the error:</span>

ACTION (bash):
<span class="hljs-symbol">command:</span> python3 /repo/reproduce_error.py

<span class="hljs-symbol">OBSERVATION:</span>
Traceback (most recent <span class="hljs-keyword">call</span> last):
  File <span class="hljs-string">"/repo/reproduce_error.py"</span>, line <span class="hljs-number">10</span>, <span class="hljs-keyword">in</span> &lt;<span class="hljs-keyword">module</span>&gt;
    store_cv_values=<span class="hljs-literal">True</span>).fit(x, y)
<span class="hljs-symbol">TypeError:</span> __init__() got an unexpected keyword argument <span class="hljs-comment">'store_cv_values'</span>
</code></pre>
<h4 data-id="heading-18">步骤 5：修复源代码</h4>
<p>模型使用编辑工具更改仓库中的源代码：</p>
<pre><code class="hljs language-ini" lang="ini">THOUGHT:
The error is reproducible. Looking at the code, I can see that the issue is that while the `RidgeClassifierCV` class inherits from `_BaseRidgeCV`, it fails to pass the `store_cv_values` parameter from its constructor through to the base class constructor.

Let's fix this:

ACTION (str_replace_editor):
command: str_replace
path: /repo/sklearn/linear_model/ridge.py
old_str:
    def __init__(self, <span class="hljs-attr">alphas</span>=(<span class="hljs-number">0.1</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">10.0</span>), fit_intercept=<span class="hljs-literal">True</span>,
                 <span class="hljs-attr">normalize</span>=<span class="hljs-literal">False</span>, scoring=None, cv=None, class_weight=None):
        super(RidgeClassifierCV, self).__init__(
            <span class="hljs-attr">alphas</span>=alphas, fit_intercept=fit_intercept, normalize=normalize,
            <span class="hljs-attr">scoring</span>=scoring, cv=cv)
        <span class="hljs-attr">self.class_weight</span> = class_weight

new_str:
    def __init__(self, <span class="hljs-attr">alphas</span>=(<span class="hljs-number">0.1</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">10.0</span>), fit_intercept=<span class="hljs-literal">True</span>,
                 <span class="hljs-attr">normalize</span>=<span class="hljs-literal">False</span>, scoring=None, cv=None, class_weight=None,
                 <span class="hljs-attr">store_cv_values</span>=<span class="hljs-literal">False</span>):
        super(RidgeClassifierCV, self).__init__(
            <span class="hljs-attr">alphas</span>=alphas, fit_intercept=fit_intercept, normalize=normalize,
            <span class="hljs-attr">scoring</span>=scoring, cv=cv, store_cv_values=store_cv_values)
        <span class="hljs-attr">self.class_weight</span> = class_weight
</code></pre>
<p><strong>💡 问题解决工作流</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Model as Claude 模型
    participant Edit as 编辑工具
    participant Bash as Bash 工具
    participant Test as 测试系统

    Model-&gt;&gt;Edit: 查看仓库结构
    Edit--&gt;&gt;Model: 返回目录树
    Model-&gt;&gt;Edit: 创建重现脚本
    Edit--&gt;&gt;Model: 脚本创建成功
    Model-&gt;&gt;Bash: 执行重现脚本
    Bash--&gt;&gt;Model: 返回错误信息
    Model-&gt;&gt;Model: 分析问题根因
    Model-&gt;&gt;Edit: 修改源代码 (str_replace)
    Edit--&gt;&gt;Model: 修改成功
    Model-&gt;&gt;Bash: 重新运行测试
    Bash--&gt;&gt;Model: 测试通过
    Model-&gt;&gt;Test: 提交解决方案
</code></pre>
<h4 data-id="heading-19">任务完成</h4>
<p>在这个特定示例中，模型工作了 <strong>12 个步骤</strong>后决定准备提交。然后任务的测试成功运行，验证了模型的解决方案解决了问题。一些任务在模型提交解决方案之前花费了<strong>超过 100 个回合</strong>；在其他任务中，模型一直尝试直到耗尽上下文。</p>
<p>从审查升级版 Claude 3.5 Sonnet 与旧模型的尝试中，我们发现升级版 3.5 Sonnet <strong>更频繁地自我纠正</strong>。它还显示出尝试多种不同解决方案的能力，而不是一遍又一遍地犯同样的错误。</p>
<hr/>
<h3 data-id="heading-20">面临的挑战</h3>
<p>SWE-bench Verified 是一个强大的评估，但它运行起来也比简单的单轮评估更复杂。以下是我们在使用它时面临的一些挑战——其他 AI 开发者也可能会遇到这些挑战。</p>
<h4 data-id="heading-21">1. 持续时间和高令牌成本</h4>
<p>上面的示例来自一个在 12 个步骤中成功完成的案例。然而，许多成功的运行需要数百个回合才能解决，并且使用了<strong>超过 10 万个令牌</strong>。升级版 Claude 3.5 Sonnet 非常坚韧：如果有足够的时间，它通常可以找到解决问题的方法，但这可能很昂贵。</p>
<h4 data-id="heading-22">2. 评分问题</h4>
<p>在检查失败的任务时，我们发现了一些模型行为正确但存在环境设置问题，或安装补丁被应用两次的问题的情况。解决这些系统问题对于准确了解 AI 智能体的性能至关重要。</p>
<h4 data-id="heading-23">3. 隐藏测试</h4>
<p>由于模型无法看到它被评分的测试，它经常"认为"自己已经成功，但任务实际上是失败的。其中一些失败是因为模型在错误的抽象级别上解决了问题（打补丁而不是更深层次的重构）。其他失败感觉不太公平：它们解决了问题，但与原始任务的单元测试不匹配。</p>
<h4 data-id="heading-24">4. 多模态能力未充分利用</h4>
<p>尽管升级版 Claude 3.5 Sonnet 具有出色的视觉和多模态能力，但我们没有实现让它查看保存到文件系统或作为 URL 引用的文件的方法。这使得调试某些任务（特别是来自 Matplotlib 的任务）特别困难，并且也容易导致模型产生幻觉。这里对于开发者来说肯定有唾手可得的成果可以改进——而且 SWE-bench 已经推出了一个专注于多模态任务的新评估。我们期待看到开发者在不久的将来使用 Claude 在这个评估上取得更高的分数。</p>
<p><strong>💡 挑战与应对策略</strong></p>



































<table><thead><tr><th>挑战</th><th>具体表现</th><th>影响</th><th>潜在解决方案</th></tr></thead><tbody><tr><td><strong>高成本</strong></td><td>100+ 回合，10万+ tokens</td><td>资源密集</td><td>优化提示词，减少无效尝试</td></tr><tr><td><strong>评分复杂性</strong></td><td>环境问题，补丁重复</td><td>误判性能</td><td>标准化环境，改进测试流程</td></tr><tr><td><strong>隐藏测试</strong></td><td>模型无法看到评分标准</td><td>误判成功</td><td>提供测试提示，改进反馈</td></tr><tr><td><strong>多模态受限</strong></td><td>无法查看图片/可视化</td><td>调试困难</td><td>集成视觉能力，支持文件预览</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-25">总结与展望</h3>
<p>升级版 Claude 3.5 Sonnet 在 SWE-bench Verified 上取得了 <strong>49%</strong> 的成绩，超越了之前最先进的 45%，仅使用了一个简单的提示词和两个通用工具。我们相信，使用新的 Claude 3.5 Sonnet 进行构建的开发者将很快找到新的、更好的方法来提高 SWE-bench 分数，超过我们在这里最初展示的水平。</p>
<hr/>
<h3 data-id="heading-26">致谢</h3>
<p>Erik Schluntz 优化了 SWE-bench 智能体并撰写了这篇博客文章。Simon Biggs、Dawn Drain 和 Eric Christiansen 帮助实现了基准测试。Shauna Kravec、Dawn Drain、Felipe Rosso、Nova DasSarma、Ven Chandrasekaran 以及许多其他人为训练 Claude 3.5 Sonnet 在智能体编码方面表现出色做出了贡献。</p>
<hr/>
<h3 data-id="heading-27">📝 总结</h3>
<h4 data-id="heading-28">核心要点</h4>
<ol>
<li>
<p><strong>性能里程碑</strong>：Claude 3.5 Sonnet 达到 49%，距离 50% 里程碑仅一步之遥</p>
</li>
<li>
<p><strong>架构创新</strong>：最小化脚手架 + 最大化模型自主权的设计理念</p>
</li>
<li>
<p><strong>工具设计</strong>：两个精心设计的通用工具（Bash + 编辑）胜过复杂系统</p>
</li>
<li>
<p><strong>设计哲学</strong>：</p>
<ul>
<li>让 AI 自主决策工作流程，而非硬编码固定模式</li>
<li>绝对路径、精确匹配等设计减少错误</li>
<li>像设计人机界面一样精心设计 AI-工具界面</li>
</ul>
</li>
<li>
<p><strong>智能体能力</strong>：</p>
<ul>
<li>能够尝试多种方案，不重复犯错</li>
<li>可以进行 100+ 回合的长期问题解决</li>
<li>在实际工程任务上表现出色</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>原文作者</strong>: Erik Schluntz (Anthropic Engineering Team)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[git版本控制]公钥和私钥是如何建立安全身份认证的]]></title>    <link>https://juejin.cn/post/7600628279215652890</link>    <guid>https://juejin.cn/post/7600628279215652890</guid>    <pubDate>2026-01-29T14:41:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279215652890" data-draft-id="7600615229995171890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[git版本控制]公钥和私钥是如何建立安全身份认证的"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-29T14:41:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [git版本控制]公钥和私钥是如何建立安全身份认证的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T14:41:17.000Z" title="Thu Jan 29 2026 14:41:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. <strong>目的：建立安全的身份认证通道</strong></h2>
<p>将公钥填写到GitHub账户的SSH Keys设置中，核心目的是：<strong>允许你的本地Git客户端通过SSH协议安全地向GitHub证明“你就是你”，而无需每次输入密码。</strong></p>
<p>这解决了两个问题：</p>
<ul>
<li><strong>安全性</strong>：使用非对称加密，比密码更安全（抗暴力破解）。</li>
<li><strong>便捷性</strong>：配置一次后，后续的<code>git push</code>、<code>git pull</code>等操作无需再输入凭证。</li>
</ul>
<h2 data-id="heading-1">2. <strong>匹配机制：不是简单的“存储-比对”</strong></h2>
<p>你的理解“GitHub会根据这个公钥和本地的私钥进行匹配”<strong>不完全准确</strong>。更精确的流程是：</p>
<p>GitHub<strong>不会主动</strong>去尝试匹配你的私钥。它只是<strong>将你提供的公钥与你账户绑定并存储起来</strong>。</p>
<p>当你（客户端）尝试连接时，会触发一个<strong>加密挑战-应答流程</strong>：</p>
<ol>
<li>你执行 <code>git push origin main</code>。</li>
<li>GitHub服务器收到连接请求，发现连接尝试来自一个声称拥有某个公钥对应身份的客户端。</li>
<li>GitHub会生成一个随机字符串（挑战），并用你之前存储在它那里的<strong>公钥</strong>对这个字符串进行<strong>加密</strong>，然后将加密后的数据发回给你的客户端。</li>
<li>你的本地Git/SSH客户端收到这个加密的挑战后，必须使用你本地计算机上对应的、且保密的<strong>私钥</strong>来<strong>解密</strong>这个字符串。</li>
<li>客户端将解密出的原始字符串发回给GitHub服务器。</li>
<li>GitHub服务器验证发回来的字符串是否与自己最初生成的随机字符串一致。</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong>只有拥有正确私钥的客户端</strong>才能完成第4步的解密。因为公钥加密的数据，只有配对的私钥能解开。</li>
<li>GitHub<strong>永远不会看到或收到你的私钥</strong>，私钥始终只存在于你的本地机器上。这是非对称加密安全性的基石。</li>
<li>验证的核心是**“能否用私钥解开用对应公钥加密的信息”**，而不是直接比对密钥本身。</li>
</ul>
<h2 data-id="heading-2">3. <strong>验证成功的结果</strong></h2>
<p>如果上述挑战-应答成功（即你证明了拥有私钥），GitHub就确认了“操作者是与该公钥绑定的账户所有者”，于是允许你执行相应的操作（如推送代码到你有权限的仓库）。</p>
<p>你的理解“如果匹配上了就算验证成功了”从这个意义上说是对的，但需要明确这个“匹配”是指<strong>成功通过了加密挑战</strong>，而非简单的字符串比对。</p>
<hr/>
<h2 data-id="heading-3"><strong>总结与类比</strong></h2>
<p>可以把整个流程想象成一个高科技的<strong>门禁系统</strong>：</p>
<ol>
<li><strong>登记公钥</strong>：你把一个特制的、只能加密不能解密的“锁”（公钥）交给GitHub管理员，并告诉他：“以后拿这把锁锁住的信息，我能打开”。</li>
<li><strong>发起访问</strong>：你去访问仓库大门。</li>
<li><strong>发起挑战</strong>：门禁系统（GitHub）随机写一张小纸条（挑战码），用你给它的那把“锁”（公钥）把纸条锁进一个盒子，然后把盒子递给你。</li>
<li><strong>证明身份</strong>：你用自己的、独一无二的“钥匙”（私钥）打开这个盒子，取出纸条，把纸条内容给门禁看。</li>
<li><strong>授权通过</strong>：门禁验证纸条内容正确，就确信你是钥匙的主人，为你开门。</li>
</ol>
<p><strong>流程图如下：</strong></p>
<pre><code class="hljs language-lua" lang="lua">你的本地机器                          GitHub服务器
    |                                    |
    | <span class="hljs-number">1.</span> git push (发起连接)              |
    |<span class="hljs-comment">-----------------------------------&gt;|</span>
    |                                    |
    |     <span class="hljs-number">2.</span> 找到关联公钥，生成随机挑战R    |
    |     <span class="hljs-number">3.</span> 用公钥加密挑战: {R}_公钥      |
    |&lt;<span class="hljs-comment">-----------------------------------|</span>
    |                                    |
    | <span class="hljs-number">4.</span> 用私钥解密得到: R                 |
    |                                    |
    | <span class="hljs-number">5.</span> 发送解密后的挑战 R                |
    |<span class="hljs-comment">-----------------------------------&gt;|</span>
    |                                    |
    |     <span class="hljs-number">6.</span> 验证 R 是否匹配               |
    |     <span class="hljs-number">7.</span> 验证成功，允许操作            |
    |&lt;<span class="hljs-comment">-----------------------------------|</span>
    |                                    |
</code></pre>
<p>所以，你的理解方向是对的，核心是<strong>通过加密和解密操作来完成身份验证</strong>，而不是简单的存储和匹配。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习OpenGL——第十一天]]></title>    <link>https://juejin.cn/post/7600663744191954980</link>    <guid>https://juejin.cn/post/7600663744191954980</guid>    <pubDate>2026-01-29T11:14:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600663744191954980" data-draft-id="7600560664407605311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习OpenGL——第十一天"/> <meta itemprop="keywords" content="OpenGL"/> <meta itemprop="datePublished" content="2026-01-29T11:14:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kimoro"/> <meta itemprop="url" content="https://juejin.cn/user/3889451248137260"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习OpenGL——第十一天
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3889451248137260/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kimoro
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:14:04.000Z" title="Thu Jan 29 2026 11:14:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">光照模型详解：定向光、点光源与聚光</h2>
<hr/>
<h3 data-id="heading-1">一、平行光（定向光）</h3>
<p>当光源距离极远时，光线近似为平行，这种理想化的光源称为定向光。此时，无论物体或观察者的位置如何，场景中的所有光线都来自同一方向，与光源具体位置无关。</p>
<ul>
<li>典型例子：太阳。虽然太阳不是无限远，但在光照计算中可视为无限远，因此可将太阳光近似为平行光线。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c35d140d2754fb884133f2bd2e14ab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770290043&amp;x-signature=1lryktFB06GKtj8mnnR1XUfoWrE%3D" alt="image.png" loading="lazy"/></p>
<p>定向光的特点：</p>
<ul>
<li>所有光线方向一致，物体与光源的相对位置不影响光照方向。</li>
<li>着色时可直接定义光的方向向量，无需光源位置。</li>
</ul>
<p>实现方式：</p>
<ul>
<li>在着色器中定义光的方向向量（direction），而非位置向量。</li>
<li>计算光照时，需将方向向量取反，并进行标准化。</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DirLight</span> {</span>
vec3 direction;
    vec3 ambient;
    vec3 diffuse;
    vec3 specular;
};

vec3 <span class="hljs-title function_">CalcDirLight</span><span class="hljs-params">(DirLight light, vec3 normal, vec3 viewDir)</span>{
    vec3 lightDir = normalize(-light.direction);
    <span class="hljs-type">float</span> diff = max(dot(normal, lightDir), <span class="hljs-number">0.0</span>);
    vec3 reflectDir = reflect(-lightDir, normal);
    <span class="hljs-type">float</span> spec = <span class="hljs-built_in">pow</span>(max(dot(viewDir, reflectDir), <span class="hljs-number">0.0</span>), material.shininess);
    vec3 ambient = light.ambient * vec3(texture(material.diffuseMap, TexCoords));
    vec3 diffuse = light.diffuse * diff * vec3(texture(material.diffuseMap, TexCoords));
    vec3 specular = light.specular * spec * vec3(texture(material.specularMap, TexCoords));
    <span class="hljs-keyword">return</span> (ambient + diffuse + specular);
}
</code></pre>
<p>注意事项：</p>
<ul>
<li>光线方向需取反（从片段指向光源）。</li>
<li>向量需标准化，避免错误计算。</li>
<li>使用vec4表示向量时，方向向量的w分量应为0.0，位置向量为1.0，可用于区分光照类型。</li>
</ul>
<blockquote>
<p>旧OpenGL通过检测w分量判断光源类型：w=0为定向光，w=1为位置光源。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、点光源</h3>
<p>点光源位于世界中的某一点，向四周均匀发射光线，光强随距离递减。常见的点光源包括灯泡、火把等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/609decd6e5654744bfe8572227a36c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770290043&amp;x-signature=7zUS6533E0ZcEhdxBfa4RgdtlJw%3D" alt="image.png" loading="lazy"/></p>
<p>点光源特点：</p>
<ul>
<li>光照随距离衰减，称为Attenuation（衰减）。</li>
<li>实际中，采用二次方程进行光强衰减以更真实地模拟物理现象。</li>
</ul>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mrow><mi>a</mi><mi>t</mi><mi>t</mi></mrow></msub><mo>=</mo><mfrac><mn>1.0</mn><mrow><msub><mi>K</mi><mi>c</mi></msub><mo>+</mo><msub><mi>K</mi><mi>i</mi></msub><mo>∗</mo><mi>d</mi><mo>+</mo><msub><mi>K</mi><mi>d</mi></msub><mo>∗</mo><msup><mi>d</mi><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">F_{att} = \frac{1.0}{K_c+K_i*d+K_d*d^2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">tt</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.296em;vertical-align:-0.4509em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">∗</span><span class="mord mathnormal mtight">d</span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span><span class="mbin mtight">∗</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1.0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4509em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>衰减参数说明：</p>
<ul>
<li>常数项（Kc）：通常为1.0，保证分母不小于1，防止光强异常。</li>
<li>一次项（Kl）：与距离成正比，线性递减光强。</li>
<li>二次项（Kq）：与距离的平方成正比，远距离时影响更大。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c290ca36416b48588ff1445b252c1598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770290043&amp;x-signature=zMa5%2By9JEbYOz5mn59Svt9NV258%3D" alt="image.png" loading="lazy"/></p>
<p>点光源结构体定义：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PointLight</span> {</span>
    vec3 position;

    <span class="hljs-type">float</span> constant;
    <span class="hljs-type">float</span> linear;
    <span class="hljs-type">float</span> quadratic;

    vec3 ambient;
    vec3 diffuse;
    vec3 specular;
}; 
</code></pre>
<p>实现方式：</p>
<ul>
<li>计算片段与光源距离，代入衰减公式，分别作用于环境光、漫反射和镜面光分量。</li>
</ul>
<pre><code class="hljs language-c" lang="c">vec3 <span class="hljs-title function_">CalcPointLight</span><span class="hljs-params">(PointLight light, vec3 normal, vec3 fragPos, vec3 viewDir)</span>{
    vec3 lightDir = normalize(light.position - fragPos);
    <span class="hljs-type">float</span> diff = max(dot(normal, lightDir), <span class="hljs-number">0.0</span>);
    vec3 reflectDir = reflect(-lightDir, normal);
    <span class="hljs-type">float</span> spec = <span class="hljs-built_in">pow</span>(max(dot(viewDir, reflectDir), <span class="hljs-number">0.0</span>), material.shininess);
    <span class="hljs-type">float</span> distance = length(light.position - fragPos);
    <span class="hljs-type">float</span> attenuation = <span class="hljs-number">1.0</span> / (light.constant + light.linear * distance + light.quadratic * (distance * distance));    
    vec3 ambient  = light.ambient  * vec3(texture(material.diffuseMap, TexCoords));
    vec3 diffuse  = light.diffuse  * diff * vec3(texture(material.diffuseMap, TexCoords));
    vec3 specular = light.specular * spec * vec3(texture(material.specularMap, TexCoords));
    <span class="hljs-keyword">return</span> (ambient + diffuse + specular) * attenuation;
}
</code></pre>
<hr/>
<h3 data-id="heading-3">三、聚光（Spotlight）</h3>
<p>聚光是一种只在某一方向、特定角度范围内发射光线的光源，类似于路灯或手电筒。只有位于聚光锥体内的物体会被照亮，其余部分保持黑暗。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bdc1625252c40d3ae1935755c0616b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770290043&amp;x-signature=XnT%2B4dLXOex2w0BoOhQaTrU5svE%3D" alt="image.png" loading="lazy"/></p>
<p>聚光参数说明：</p>
<ul>
<li>LightDir：从片段指向光源的向量。</li>
<li>SpotDir：聚光方向向量。</li>
<li>Cutoff Angle（切光角）：决定聚光锥体的半径。</li>
<li>Theta：LightDir与SpotDir的夹角，判断片段是否在锥体内。</li>
</ul>
<p>结构体定义：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SpotLight</span> {</span>
    vec3 position;
    vec3 direction;
    <span class="hljs-type">float</span> cutOff;
    <span class="hljs-type">float</span> outerCutOff;

    <span class="hljs-type">float</span> constant;
    <span class="hljs-type">float</span> linear;
    <span class="hljs-type">float</span> quadratic;

    vec3 ambient;
    vec3 diffuse;
    vec3 specular;
};
</code></pre>
<p>边缘平滑处理：</p>
<ul>
<li>定义内圆锥（cutOff）和外圆锥（outerCutOff），在二者之间，光强平滑过渡。</li>
</ul>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>=</mo><mfrac><mrow><mi>θ</mi><mo>−</mo><mi>γ</mi></mrow><mi>ϵ</mi></mfrac></mrow><annotation encoding="application/x-tex">I=\frac{θ-γ}{ϵ}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ϵ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<ul>
<li>通过计算theta与cutOff、outerCutOff的关系，利用clamp函数将强度约束在0到1之间。</li>
</ul>
<p>聚光实现示例：</p>
<pre><code class="hljs language-c" lang="c">vec3 <span class="hljs-title function_">CalcSpotLight</span><span class="hljs-params">(SpotLight light, vec3 normal, vec3 fragPos, vec3 viewDir)</span>{
    vec3 lightDir = normalize(light.position - fragPos);
    <span class="hljs-type">float</span> diff = max(dot(normal, lightDir), <span class="hljs-number">0.0</span>);
    vec3 reflectDir = reflect(-lightDir, normal);
    <span class="hljs-type">float</span> spec = <span class="hljs-built_in">pow</span>(max(dot(viewDir, reflectDir), <span class="hljs-number">0.0</span>), material.shininess);
    <span class="hljs-type">float</span> distance = length(light.position - fragPos);
    <span class="hljs-type">float</span> attenuation = <span class="hljs-number">1.0</span> / (light.constant + light.linear * distance + light.quadratic * (distance * distance));    
    vec3 ambient  = light.ambient  * vec3(texture(material.diffuseMap, TexCoords));
    vec3 diffuse  = light.diffuse  * diff * vec3(texture(material.diffuseMap, TexCoords));
    vec3 specular = light.specular * spec * vec3(texture(material.specularMap, TexCoords));
    <span class="hljs-type">float</span> theta     = dot(lightDir, normalize(-light.direction));
    <span class="hljs-type">float</span> epsilon   = light.cutOff - light.outerCutOff;
    <span class="hljs-type">float</span> intensity = clamp((theta - light.outerCutOff) / epsilon, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
    <span class="hljs-keyword">return</span> (ambient + diffuse + specular) * attenuation * intensity;
}
</code></pre>
<blockquote>
<p>提示：clamp函数确保强度值始终在0~1之间，保证光照过渡自然。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[STM32之GPIO输出]]></title>    <link>https://juejin.cn/post/7600615229994909746</link>    <guid>https://juejin.cn/post/7600615229994909746</guid>    <pubDate>2026-01-29T12:36:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600615229994909746" data-draft-id="7600489282840068106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="STM32之GPIO输出"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2026-01-29T12:36:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RobotMu"/> <meta itemprop="url" content="https://juejin.cn/user/2684353293115578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            STM32之GPIO输出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2684353293115578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RobotMu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:36:00.000Z" title="Thu Jan 29 2026 12:36:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>达成成就：点灯大师！！！</strong> 记录下学到的一些要点</p>
<h2 data-id="heading-0">操作 GPIO 步骤分解</h2>
<blockquote>
<p><strong>总共涉及了<code>RCC</code>和<code>GPIO</code>两个外设</strong></p>
<ol>
<li>使用<code>RCC</code>开启<code>GPIO</code>的时钟</li>
<li>使用<code>GPIO_Init</code>函数初始化<code>GPIO</code></li>
<li>使用输出或者输入的函数控制<code>GPIO</code>口</li>
</ol>
<p><strong>两个外设的库函数</strong></p>
<blockquote>
<p><code>RCC</code>最主要的只有三个函数：<code>RCC AHB</code>外设时钟控制 || <code>RCC APB2</code>外设时钟控制 || <code>RCC APB1</code>外设时钟控制</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8be63970f236482c8cf77800d4b2509a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ib3RNdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294963&amp;x-signature=%2FWVeNDuPnZXC3X%2F5WgZAZByF2MA%3D" alt="image-20260129095454888.png" loading="lazy"/></p>
<p><code>GPIO</code>最主要的是<code>GPIO_Init</code>和八个读写函数</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4496c8613874e7f804437edf80ae524~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ib3RNdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294963&amp;x-signature=Gxxh7Nj8h7zlDI3AI8dUD7TNzj0%3D" alt="image-20260129100330064.png" loading="lazy"/></p>
</blockquote>
</blockquote>
<h2 data-id="heading-1">点亮 LED 代码</h2>
<blockquote>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include "stm32f10x.h"                  // Device header</span>
​
int main(void)
{
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE)<span class="hljs-comment">;</span>
    
    GPIO_InitTypeDef GPIO_InitStruct<span class="hljs-comment">;</span>
    <span class="hljs-attr">GPIO_InitStruct.GPIO_Mode</span> = GPIO_Mode_Out_PP<span class="hljs-comment">;</span>
    <span class="hljs-attr">GPIO_InitStruct.GPIO_Pin</span> = GPIO_Pin_0<span class="hljs-comment">;</span>
    <span class="hljs-attr">GPIO_InitStruct.GPIO_Speed</span> = GPIO_Speed_50MHz<span class="hljs-comment">;</span>
    
    GPIO_Init(GPIOA, &amp;GPIO_InitStruct)<span class="hljs-comment">;</span>
    
    GPIO_ResetBits(GPIOA, GPIO_Pin_0)<span class="hljs-comment">;</span>
    
    while (1)
    {
    
    }
}
​
</code></pre>
<p>这里学到了一些新东西，主要在第一行<code>RCC</code>开启时钟</p>
<p><code>RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</code>可以翻译成：请 <code>RCC</code> 给 <strong>APB2 总线上的 GPIOA 外设</strong> 打开时钟，让它开始工作</p>
<ul>
<li>
<p><code>RCC</code>的三个函数<code>RCC_AHBPeriphClockCmd、RCC_APB1PeriphClockCmd、RCC_APB2PeriphClockCmd</code>表示的是要开启时钟的外设在哪条<strong>总线</strong>上</p>
<p><strong>不记得没关系</strong>，可以跳转到定义查看，以<code>RCC_APB2PeriphClockCmd</code>为例，其定义如下（<strong>可以看到 GPIOA 外设在这上面</strong>）</p>
<blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27da1c71d2dd4f94988fc00fb6d5e15c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ib3RNdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294963&amp;x-signature=nDAei0tn7UcqtuCRrPPx7EO1LFY%3D" alt="image-20260129104023111.png" loading="lazy"/></p>
</blockquote>
</li>
<li>
<p>时钟是给外设的，不是给某个引脚的。这里我们要操作的是<code>GPIOA</code>上的<code>0</code>号引脚，所以用<code>RCC</code>开启<code>GPIOA</code>的时钟</p>
</li>
</ul>
</blockquote>
<h2 data-id="heading-2">LED 闪烁代码</h2>
<blockquote>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include "stm32f10x.h"                  // Device header</span>
<span class="hljs-comment">#include "Delay.h"</span>
​
int main(void)
{
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE)<span class="hljs-comment">;</span>
    
    GPIO_InitTypeDef GPIO_InitStruct<span class="hljs-comment">;</span>
    
    <span class="hljs-attr">GPIO_InitStruct.GPIO_Mode</span> = GPIO_Mode_Out_PP<span class="hljs-comment">;</span>
    <span class="hljs-attr">GPIO_InitStruct.GPIO_Pin</span> = GPIO_Pin_0<span class="hljs-comment">;</span>
    <span class="hljs-attr">GPIO_InitStruct.GPIO_Speed</span> = GPIO_Speed_50MHz<span class="hljs-comment">;</span>
    
    GPIO_Init(GPIOA, &amp;GPIO_InitStruct)<span class="hljs-comment">;</span>
    
    while (1)
    {
        GPIO_WriteBit(GPIOA, GPIO_Pin_0, Bit_RESET)<span class="hljs-comment">;</span>
        Delay_ms(500)<span class="hljs-comment">;</span>
        GPIO_WriteBit(GPIOA, GPIO_Pin_0, Bit_SET)<span class="hljs-comment">;</span>
        Delay_ms(2000)<span class="hljs-comment">;</span>
    }
}
​
</code></pre>
<p>这里并没有什么特别的，新学了<code>GPIO</code>的写函数<code>GPIO_WriteBit(GPIOA, GPIO_Pin_0, Bit_SET);</code>功能上感觉和<code>GPIO_SetBits</code>、<code>GPIO_ResetBits</code>没什么区别，这个函数可以通过<strong>第三个参数来决定高/低电平</strong></p>
</blockquote>
<h2 data-id="heading-3">LED 流水灯代码</h2>
<blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#include</span> "stm32f10x<span class="hljs-selector-class">.h</span>"                  <span class="hljs-comment">// Device header</span>
<span class="hljs-selector-id">#include</span> "Delay<span class="hljs-selector-class">.h</span>"
​
int <span class="hljs-selector-tag">main</span>(void)
{
    <span class="hljs-built_in">RCC_APB2PeriphClockCmd</span>(RCC_APB2Periph_GPIOA, ENABLE);
    
    GPIO_InitTypeDef GPIO_InitStruct;
    GPIO_InitStruct<span class="hljs-selector-class">.GPIO_Mode</span> = GPIO_Mode_Out_PP;
    GPIO_InitStruct<span class="hljs-selector-class">.GPIO_Pin</span> = GPIO_Pin_All;
    GPIO_InitStruct<span class="hljs-selector-class">.GPIO_Speed</span> = GPIO_Speed_50MHz;
    
    <span class="hljs-built_in">GPIO_Init</span>(GPIOA, &amp;GPIO_InitStruct);
    
    while (<span class="hljs-number">1</span>)
    {
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0001); <span class="hljs-comment">// 0000 0000 0000 0001</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0002); <span class="hljs-comment">// 0000 0000 0000 0010</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0004); <span class="hljs-comment">// 0000 0000 0000 0100</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0008); <span class="hljs-comment">// 0000 0000 0000 1000</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0010); <span class="hljs-comment">// 0000 0000 0001 0000</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0020); <span class="hljs-comment">// 0000 0000 0010 0000</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0040); <span class="hljs-comment">// 0000 0000 0100 0000</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
        <span class="hljs-built_in">GPIO_Write</span>(GPIOA, ~<span class="hljs-number">0</span>x0080); <span class="hljs-comment">// 0000 0000 1000 0000</span>
        <span class="hljs-built_in">Delay_ms</span>(<span class="hljs-number">500</span>);
    }
}
​
</code></pre>
<ul>
<li>这里获得了非常重要的印象：<strong>一个比特位控制一个引脚</strong></li>
<li><code>GPIO_Write(GPIOA, ~0x0001);</code>是<code>GPIO</code>的第四个写函数，它的特别之处在于通过<code>16</code>进制数据（第二个参数）来一次设置指定的<code>GPIO</code>外设的全部引脚的电平</li>
</ul>
<p><strong>思考与体会</strong></p>
<p>我现在觉得很好玩的一点是我点亮了<code>8</code>个<code>LED</code>组成的流水灯，改动一下程序不就可以传各种信息了吗，只要有对应的协议，比如摩斯密码这种（想到了寄生虫电影里的情节，也是通过灯亮和频率来传递信息的）。所以这相当于是硬件之间通信的一种外显对吗，其实原理是差不多的</p>
<p>所以后面要学的各种通信协议也都像这个小灯一样吗？<strong>保留这种印象学习吧</strong></p>
<p><strong>给自己准备的小练习</strong></p>
<p>我们可以用这个流水灯写一个这样的小程序，来输出字符串，比如 <code>hello world</code></p>
<p>英文单词一共26个，只需要用5个流水灯来表示，后3个流水灯来指示输出的开始、结束、单词拼写的开始、结束</p>
<p><strong>实现代码如下：</strong></p>
</blockquote>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"stm32f10x.h"</span>                  <span class="hljs-comment">// Device header</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Delay.h"</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);
	
	GPIO_InitTypeDef GPIO_InitStruct;
	GPIO_InitStruct.GPIO_Mode = GPIO_Mode_Out_PP;
	GPIO_InitStruct.GPIO_Pin = GPIO_Pin_All;
	GPIO_InitStruct.GPIO_Speed = GPIO_Speed_50MHz;
	
	GPIO_Init(GPIOA, &amp;GPIO_InitStruct);
        
	<span class="hljs-comment">// 字母对应的16进制码</span>
	<span class="hljs-type">uint16_t</span> letter_table[<span class="hljs-number">26</span>] = {
		<span class="hljs-number">0x0001</span>, <span class="hljs-comment">// a 0000 0001</span>
		<span class="hljs-number">0x0002</span>, <span class="hljs-comment">// b 0000 0010</span>
		<span class="hljs-number">0x0003</span>, <span class="hljs-comment">// c 0000 0011</span>
		<span class="hljs-number">0x0004</span>, <span class="hljs-comment">// d 0000 0100</span>
		<span class="hljs-number">0x0005</span>, <span class="hljs-comment">// e 0000 0101</span>
		<span class="hljs-number">0x0006</span>, <span class="hljs-comment">// f 0000 0110</span>
		<span class="hljs-number">0x0007</span>, <span class="hljs-comment">// g 0000 0111</span>
		<span class="hljs-number">0x0008</span>, <span class="hljs-comment">// h 0000 1000</span>
		<span class="hljs-number">0x0009</span>, <span class="hljs-comment">// i 0000 1001</span>
		<span class="hljs-number">0x000A</span>, <span class="hljs-comment">// j 0000 1010</span>
		<span class="hljs-number">0x000B</span>, <span class="hljs-comment">// k 0000 1011</span>
		<span class="hljs-number">0x000C</span>, <span class="hljs-comment">// l 0000 1100</span>
		<span class="hljs-number">0x000D</span>, <span class="hljs-comment">// m 0000 1101</span>
		<span class="hljs-number">0x000E</span>, <span class="hljs-comment">// n 0000 1110</span>
		<span class="hljs-number">0x000F</span>, <span class="hljs-comment">// o 0000 1111</span>
		<span class="hljs-number">0x0010</span>, <span class="hljs-comment">// p 0001 0000</span>
		<span class="hljs-number">0x0011</span>, <span class="hljs-comment">// q 0001 0001</span>
		<span class="hljs-number">0x0012</span>, <span class="hljs-comment">// r 0001 0010</span>
		<span class="hljs-number">0x0013</span>, <span class="hljs-comment">// s 0001 0011</span>
		<span class="hljs-number">0x0014</span>, <span class="hljs-comment">// t 0001 0100</span>
		<span class="hljs-number">0x0015</span>, <span class="hljs-comment">// u 0001 0101</span>
		<span class="hljs-number">0x0016</span>, <span class="hljs-comment">// v 0001 0110</span>
		<span class="hljs-number">0x0017</span>, <span class="hljs-comment">// w 0001 0111</span>
		<span class="hljs-number">0x0018</span>, <span class="hljs-comment">// x 0001 1000</span>
		<span class="hljs-number">0x0019</span>, <span class="hljs-comment">// y 0001 1001</span>
		<span class="hljs-number">0x001A</span>  <span class="hljs-comment">// z 0001 1010</span>
};
	
	<span class="hljs-comment">// 准备好要输出的字符串</span>
	<span class="hljs-type">char</span> str[] = <span class="hljs-string">"hello world and world peace"</span>;
	
	<span class="hljs-comment">// 后三个灯全亮表示开始</span>
	GPIO_Write(GPIOA, ~<span class="hljs-number">0x00E0</span>);
	Delay_ms(<span class="hljs-number">2000</span>);
	
	<span class="hljs-comment">// 遍历的方式用前5个LED灯逐个输出字符</span>
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; str[i] != <span class="hljs-string">'\0'</span>; i++)
	{
		<span class="hljs-type">char</span> c = str[i];
		
		<span class="hljs-comment">// 用空格来标记单词的结束，配合尾灯特效</span>
		<span class="hljs-keyword">if</span>(c == <span class="hljs-string">' '</span>) 
		{
			GPIO_Write(GPIOA, ~<span class="hljs-number">0x0020</span>);
			Delay_ms(<span class="hljs-number">500</span>);
			GPIO_Write(GPIOA, ~<span class="hljs-number">0x0040</span>);
			Delay_ms(<span class="hljs-number">500</span>);
			GPIO_Write(GPIOA, ~<span class="hljs-number">0x0080</span>);
			Delay_ms(<span class="hljs-number">500</span>);
		}
		<span class="hljs-keyword">else</span> 
		{
			<span class="hljs-type">int</span> num = c - <span class="hljs-string">'a'</span>;
			<span class="hljs-type">uint16_t</span> code = letter_table[num];
			GPIO_Write(GPIOA, ~code);
			Delay_ms(<span class="hljs-number">1000</span>);
		
			<span class="hljs-comment">// 全暗表示一个字符输出结束</span>
			GPIO_Write(GPIOA, <span class="hljs-number">0xFFFF</span>);
			Delay_ms(<span class="hljs-number">500</span>);
		}
		
	}
	
	<span class="hljs-comment">// 后三个灯第二次全亮表示结束</span>
	GPIO_Write(GPIOA, ~<span class="hljs-number">0x00E0</span>);
	Delay_ms(<span class="hljs-number">2000</span>);
	
	GPIO_Write(GPIOA, <span class="hljs-number">0xFFFF</span>);
		
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)
	{
		
	}
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入揭秘 Linux 虚拟文件系统 VFS （下）]]></title>    <link>https://juejin.cn/post/7600426046425907235</link>    <guid>https://juejin.cn/post/7600426046425907235</guid>    <pubDate>2026-01-29T12:20:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600426046425907235" data-draft-id="7600588379105787956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 深入揭秘 Linux 虚拟文件系统 VFS （下）"/> <meta itemprop="keywords" content="Linux,面试"/> <meta itemprop="datePublished" content="2026-01-29T12:20:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlp666hub"/> <meta itemprop="url" content="https://juejin.cn/user/2965810860569131"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             深入揭秘 Linux 虚拟文件系统 VFS （下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2965810860569131/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlp666hub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:20:57.000Z" title="Thu Jan 29 2026 12:20:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>上一篇文章我们逐个学习了 VFS 的四大核心对象，那么本篇文章我们将更加深入内核，深度拆解这些对象是如何通过路径查找、接口多态来协作完成一次真实的文件操作的。</p>
<p>我们话不多说，直接进入正题。</p>
<h2 data-id="heading-1">2. 路径查找</h2>
<p>我们在写代码时，通常像下面这样打开一个文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> fd = open(<span class="hljs-string">"/home/user/a.txt"</span>, O_RDONLY);
</code></pre>
<p>这里使用的路径是绝对路径，也可以使用相对路径。</p>
<p>对于用户程序来说，我们只是提供了一个冷冰冰的<strong>字符串</strong>路径，但是对于内核来说，它只认识 <strong>Inode</strong>。</p>
<p>那么，内核究竟是如何把这个字符串 <code>/home/user/a.txt</code>，一步步转换成内存中具体的 <code>struct inode</code> 的？其实这个过程在 Linux 内核中被称为 <strong>Path Walking（路径查找）</strong> 。</p>
<p>具有一定编程思维的人可能在阅读内核源码之前就已经有思路了：只需要把字符串按 <code>/</code> 切分，一级一级找不就行了。</p>
<p>这个思路其实很简单，逻辑上也确实是这样的。但在工程实现上，为了保证极致的性能和功能的灵活性，就不能每切分一级目录就去读一次磁盘，还要做好对挂载点的处理，因此 Linux 在这里设计了极其精妙的机制。</p>
<h3 data-id="heading-2">2.1 目录项缓存 Dcache</h3>
<p>如果真的像最原始的逻辑那样，每查找一级目录，都要去读一次物理磁盘，那么 Linux 的 I/O 性能将慢得令人崩溃。</p>
<p>我们按照这个原始逻辑感受一下，查找 <code>/usr/bin/vim</code> 这个路径：</p>
<ol>
<li>读取根目录 <code>/</code> 的 Inode，这是磁盘 IO。然后解析数据块，再找到 <code>usr</code> 的位置。</li>
<li>读取 <code>usr</code> 的 Inode，这是磁盘 IO。然后解析数据块，找到 <code>bin</code> 的位置。</li>
<li>读取 <code>bin</code> 的 Inode，这是磁盘 IO。解析数据块，最后找到 <code>vim</code> 的位置。</li>
</ol>
<p>每一次磁盘 IO 都是毫秒级的开销，为了避免这种耗时的操作，VFS 引入了 <strong>Dcache (Dentry Cache)</strong> 。</p>
<p>还记得我们上篇文章讲的<code>struct dentry</code>吗？它不仅仅代表路径，在内存中它还是一个<strong>哈希表节点</strong>。</p>
<p>当内核开始解析路径时，它的第一反应绝不是读磁盘，而是查内存：<strong>看看 Dcache 里有没有缓存过 usr 这个目录项？</strong></p>
<p>如果 <strong>Cache Hit（缓存命中）</strong> ：直接拿到 <code>dentry</code>，不需要读盘，<strong>纳秒级</strong>完成。</p>
<p>如果 <strong>Cache Miss（缓存未命中）</strong> ：就调用具体文件系统的 <code>lookup</code> 接口，去磁盘读取元数据，构建一个新的 <code>dentry</code> 放入缓存，以便下次高效查找。</p>
<p>这里讲一个冷知识：Linux 系统中 90% 以上的空闲内存往往都被 Page Cache 和 Dcache 占据。当你发现系统内存占用很高但运行流畅时，通常就是它们在替你加速。</p>
<h3 data-id="heading-3">2.2 路径解析的详细流程</h3>
<p>让我们模拟一下内核解析 <code>/home/user/a.txt</code> 的全过程。虽然内核源码中负责此工作的 <code>filename_lookup</code> 函数非常复杂，但逻辑上我们分析个大概还是没有什么难度的。</p>
<ol>
<li>
<p><strong>确定起点</strong></p>
<p>内核首先要判断从用户层接收到的字符串路径到底是<strong>绝对路径</strong>还是<strong>相对路径</strong>。这就是前面提到的<code>open</code>中不论填绝对路径还是相对路径都可以，内核中已经把判断的逻辑写好了。</p>
<p>如果字符串以<code>/</code>开头，那就说明是绝对路径，从 <code>current-&gt;fs-&gt;root</code>开始走。</p>
<p>如果字符串不以 / 开头，那就说明是相对路径，从<code>current-&gt;fs-&gt;pwd</code>开始走。</p>
<p>本例中，我们是绝对路径，从根目录 <code>/</code> 出发。 这里补充一点：可能有不少人知道<code>current-&gt;fs-&gt;root</code>大致是什么意思，但疑惑它到底是个什么，这部分内容将会放在本章小结中为大家解释。</p>
</li>
<li>
<p><strong>逐级解析路径</strong> 内核会将路径字符串拆解为三个分量，即 <code>home</code>、<code>user</code>、<code>a.txt</code>，然后开始一个循环。</p>
<p>第一步：拿根目录的 <code>dentry</code> 和字符串 <code>"home"</code> 计算哈希值，在 Dcache 中查找。如果没找到，就让 EXT4 去磁盘把 <code>home</code> 目录读出来，生成一个 <code>dentry</code> 放在内存里。此外还会检查该进程有没有权限访问<code>home</code>目录。 第二步：拿着刚才找到的 <code>home</code> 的 <code>dentry</code>，在下面查找 <code>"user"</code>，查找步骤与第一步相同。 第三步：同理，可以查找到<code>"a.txt"</code>。最终找到了目标文件的 <code>dentry</code> 和对应的 <code>inode</code>。</p>
</li>
<li>
<p><strong>穿越挂载点</strong></p>
<p>这可以说是路径查找中最让人摸不着头脑的地方。 假设你的系统里挂载了一个 U 盘，挂载点是 <code>/mnt/usb</code>。当你访问路径 <code>/mnt/usb/photo.jpg</code> 时，内核在解析到 <code>usb</code> 这一层时，会发现<code>usb</code> 这个目录项被打上了一个特殊的标记——<strong><code>DCACHE_MOUNTED</code></strong>。 这时 VFS 会意识到：<strong>这里虽然叫 usb，以及虽然是从 /mnt 走过来的，但它已经不是原来的那个目录了，它是另一个文件系统的入口</strong>。</p>
<p>此时，内核会根据挂载记录，<strong>自动跳转</strong>到对应文件系统的<strong>根目录 Dentry</strong> 上。</p>
</li>
</ol>
<p>这些操作对用户是完全透明的，用户根本感觉不到自己已经跨越了文件系统的边界，从一个文件系统的地盘跳到了另一个文件系统的地盘。这就是 VFS 屏蔽底层差异的核心手段之一。</p>
<h3 data-id="heading-4">2.3 路径查找进入尾声</h3>
<p>截至现在，VFS 终于找到了 <code>a.txt</code> 对应的 <code>struct inode</code>。</p>
<p>但 <code>open()</code> 系统调用返回给用户的，却是一个简单的整数 <code>fd</code>。虽然大家都知道这就是文件描述符，但我还是想讲一下它到底是怎么来的？</p>
<p>内核在创建 <strong>File 对象</strong>时，会分配一个全新的 <code>struct file</code>，将 <code>f_path.dentry</code> 指向刚才找到的 <code>dentry</code>，将 <code>f_path.mnt</code> 指向对应的挂载点，再初始化 <code>f_pos</code> 为 0。</p>
<p>然后在当前进程的文件描述符表<code>fd_array</code>中，找一个最小的空闲下标，作为文件描述符<code>fd</code>。</p>
<p>接着建立文件描述符表中相应位置与<code>struct file</code>指针的关系：</p>
<pre><code class="hljs language-arduino" lang="arduino">fd_array[fd] = 这个新的 <span class="hljs-keyword">struct</span> file 指针
</code></pre>
<p>最后将<code>fd</code>返回给用户。</p>
<p>正因为 <code>open</code> 做了繁重的路径查找工作，并建立好了 <code>fd</code> 到 <code>struct file</code> 的映射，所以后续的 <code>read</code> 操作才能极其高效。内核直接通过 <code>fd</code> 就能拿到 <code>file</code> 和 <code>inode</code>，再也不用去解析那长长的字符串路径了。</p>
<h3 data-id="heading-5">2.4 小结</h3>
<p>下面我们来讲一下<code>current-&gt;fs-&gt;root</code>到底在干什么。</p>
<p><code>current</code>是内核中最重要的宏之一，它始终指向<strong>当前正在 CPU 上运行的那个进程</strong>的进程控制块（<code>struct task_struct</code>）。</p>
<p><code>fs</code>是<code>struct task_struct</code>中的一个成员<code>struct fs_struct</code>，专门用来存储<strong>该进程与文件系统相关的上下文信息</strong>。它记录了根目录在哪、当前工作目录在哪。</p>
<p><code>root</code>指向了该进程认为的根目录的<code>dentry</code>。</p>
<p><code>pwd</code>指向了该进程认为的当前工作目录的<code>dentry</code>。</p>
<p>根目录作为一个所有进程都可能访问的目录，为什么要放在进程里面，而不是作为一个全局变量呢？</p>
<p>实际上，通常情况下所有进程的 <code>root</code> 都指向真正的系统根目录 <code>/</code>。但是，Linux 允许我们修改这个指向，这就是 <strong>chroot 命令</strong> 以及现代 <strong>容器技术（Docker）</strong> 的核心原理。</p>
<ol>
<li><strong>对于宿主机进程</strong>：<code>current-&gt;fs-&gt;root</code> 指向真正的磁盘根目录 <code>/</code>。</li>
<li><strong>对于 Docker 容器内的进程</strong>：内核把它的 <code>current-&gt;fs-&gt;root</code> 修改指向了宿主机上的某个子目录，作为 Docker 内进程的根目录。</li>
</ol>
<p>结果当容器内的进程去访问 <code>/etc/passwd</code> 时，内核从它的 <code>fs-&gt;root</code> 开始找，实际上找到的是宿主机那个子目录下的文件。容器进程就像被关在了一个小黑屋里，它以为自己看到了全世界（根目录），其实它看到的只是宿主机的一个角落，也就是我们想让它看到的东西。</p>
<h2 data-id="heading-6">3. 接口与多态</h2>
<p>VFS 作为一个抽象层，它自己是<strong>不存储数据</strong>的。它不知道数据是在磁盘的第几个扇区，也不知道网卡收到了什么包。真正干活的，是底层的 EXT4，FAT32 或者 TCP/IP 协议栈。</p>
<p>而 VFS 在这个过程中要做的就只有<strong>标准化接口</strong>。</p>
<p>用面向对象的语言来说，这叫做<strong>多态</strong>。但 C 语言没有 <code>interface</code> 关键字，Linux 内核的大佬们就用<strong>函数指针</strong>手搓了一套多态机制。</p>
<h3 data-id="heading-7">3.1 三个操作集</h3>
<p>这三个操作集结构体的内容都是比较多的，我就不放源码了，下文中只介绍关键成员，想看完整内核源码可以去源码目录<code>/include/linux/fs.h</code>中找，三个结构体连着定义的，很好找。</p>
<h4 data-id="heading-8">3.1.1 文件内容操作</h4>
<p>文件内容操作<code>struct file_operations</code>：这是平时写应用程序时最常用的接口，它定义了<strong>对打开的文件内容</strong>可以做哪些操作。</p>
<p>该结构体的核心成员包括：<code>read</code>读文件内容，<code>write</code>写文件内容，<code>mmap</code>内存映射，<code>open</code>打开，<code>release</code>关闭。</p>
<p>下面具体描述一下：</p>
<p>如果我们要读的是 EXT4 文件，就将<code>read</code>对应的函数指针初始化为 <code>ext4_file_read_iter</code>，而<code>ext4_file_read_iter</code>的实现并不属于 VFS 的管理范畴，它是 EXT4 文件系统底层需要完成的。</p>
<p>如果是 Socket 套接字，函数指针就初始化为 <code>sock_read_iter</code>。</p>
<p>这就是将操作与相应函数对应起来的方法。</p>
<h4 data-id="heading-9">3.1.2 元数据操作</h4>
<p><code>struct inode_operations</code>这组接口关注的是文件<strong>本身</strong>或者说是目录项的操作，而不是文件里面的内容。</p>
<p>核心成员有：<code>create</code>创建新文件，<code>mkdir</code>创建目录，<code>lookup</code>在目录中查找文件，<code>setattr</code>修改权限和时间戳。</p>
<p>这里 <strong>file_op 和 inode_op</strong> 一定要区分开，有些操作是不需要打开文件就可以执行的。比如 <code>mkdir</code>，你不需要打开一个目录就能创建它。比如 <code>rm</code> (调用 <code>unlink</code>)，你删除文件时也不需要先 <code>open</code> 它。这些操作针对的是 Inode（文件实体）而非 File（句柄）。</p>
<h4 data-id="heading-10">3.1.3 文件系统整体操作</h4>
<p><code>struct super_operations</code>管理的是<strong>整个文件系统</strong>的生命周期。</p>
<p>核心成员：</p>
<ol>
<li><code>alloc_inode</code>: 为这个文件系统分配一个 <code>inode</code>。</li>
<li><code>write_inode</code>: 把内存里的 <code>inode</code> 刷回磁盘。</li>
<li><code>sync_fs</code>: 把所有脏数据刷盘。</li>
</ol>
<h3 data-id="heading-11">3.2 具体场景演示</h3>
<p>下面让我们看看当用户执行 <code>read</code> 时，内核里发生了什么？</p>
<p>在 VFS 层（源码目录<code>fs/read_write.c</code>），代码逻辑非常简洁，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e04967ec9884be78f3c06beb2b711b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=YXK81v1S1g%2BHAvRX6%2BhRIgtdseo%3D" alt="1. read源码.png" loading="lazy"/></p>
<p>核心逻辑我们从第 493 行开始看，VFS 层直接调用函数指针，根本不关心它是 EXT4 文件系统还是 FAT32 文件系统。为什么可以这样做呢？</p>
<p>实际上，当 EXT4 文件创建时，内核把 <code>inode-&gt;i_fop</code> 指向了全局变量 <code>ext4_file_operations</code>，一个具体文件打开时，<code>struct file</code>出现了，<code>file-&gt;f_op</code>会继承 <code>inode-&gt;i_fop</code>，然后<code>vfs_read</code> 调用 <code>file-&gt;f_op-&gt;read</code>，实际上执行的是 <code>ext4_file_read_iter</code>。这就是 VFS 层调用再通向某个文件系统具体调用的过程。下面我们来看看这个过程在内核源码中的体现。</p>
<p>当 EXT4 从磁盘读出一个 Inode 时。如果发现这个 Inode 是个普通文件<code>S_ISREG</code>，就把 <code>ext4_file_operations</code> 挂上去，这样以后对它的 <code>read</code> 就会调用 EXT4 的读函数。如果发现它是个目录<code>S_ISDIR</code>，就把 <code>ext4_dir_operations</code> 挂上去，这样对它的 <code>read</code>就会去读取目录项列表。这个过程在函数<code>__ext4_iget</code>中实现，该函数位于内核源码<code>/fs/ext4/inode.c</code>中，这个函数有好几百行，我只截取了重要的几行，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82ebba3acaaf44c3b1c50d5713e8fe94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=GEB8MvqIIER3P5UUcZKVW9GdgPY%3D" alt="2. ext4_iget函数.png" loading="lazy"/>
两个操作集的实现在<code>/fs/ext4/file.c</code>中，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a44e21303ed4ecc93fa90ca4fdc2ec4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=R%2FgfNICj%2BiCUOPJM0cK0pg6IAR8%3D" alt="3. ext4操作集.png" loading="lazy"/></p>
<p>就是在这里完成 VFS 层的读操作到EXT4文件系统读函数的映射的。</p>
<p>到此，我们已经把用户层调用<code>read</code>到具体的文件系统执行相关读函数这条线捋清了。</p>
<h2 data-id="heading-12">4. 全链路追踪一个read请求</h2>
<p>假设应用程序执行了这样一行简单的代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">ssize_t</span> n = read(<span class="hljs-number">3</span>, buf, <span class="hljs-number">4096</span>);
</code></pre>
<p>这是一个极其普通的调用，但在 Linux 内核的微观世界里，却相当复杂。</p>
<p>让我们结合内核源码，一行行追踪数据的流向。</p>
<h3 data-id="heading-13">4.1 系统调用入口</h3>
<p>当用户程序执行 <code>read</code> 时，CPU 发生模式切换，通过系统调用表跳转到内核入口。在 Linux 源码中，系统调用的定义通常使用 <code>SYSCALL_DEFINE</code> 宏。</p>
<p>源码位于<code>fs/read_write.c</code>中，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72c5f2abefc345f08769016542bb1d16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=IvihhaROD3LVkrVYWN%2B0sn5tu3I%3D" alt="4. 系统调用入口（1）.png" loading="lazy"/></p>
<p>宏展开后就是 <code>sys_read</code> 函数，调用 <code>ksys_read</code>，这是内核内部的通用入口。</p>
<p>在<code>ksys_read</code>内部，根据用户传入的 <code>fd</code> 获取 <code>struct file</code> 指针，其实<code>fdget_pos</code> 就是去当前进程的 <code>files_struct</code>文件描述符表里查，把整数 <code>fd</code>变成了 <code>struct file *</code> 指针。第 629 行获取当前文件的读取位置。第 634 行进入 VFS 的通用读取逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7047f51a5e5c43159067b5f6a36a9606~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=dFzgwqFPrLYWOS4pI006pXQKd9U%3D" alt="5. ksys_read.png" loading="lazy"/></p>
<p>到此，我们已经踏入 VFS 的大门了。</p>
<h3 data-id="heading-14">4.2 VFS 分发</h3>
<p><code>vfs_read</code> 可以理解为一个具有分发功能的函数，它不负责具体的读写，只负责<strong>路由分发</strong>。它要根据文件系统的实现情况，决定调用哪个函数。源码位置：<code>fs/read_write.c</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/724b73c085ae40ce8cdd11c20a5686cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=9Pc%2BwHThLACN0KYJ%2BLmc6e8cN%2Fg%3D" alt="6. vfs_read.png" loading="lazy"/></p>
<p>前面都是一些权限检查之类的操作，核心逻辑从 493 行开始。</p>
<p>第 493 行可以看到，VFS 会优先调用 <code>read</code>，没有<code>read</code>则调用 <code>read_iter</code>，区别在于<code>read_iter</code>比较现代，EXT4，XFS 等现代文件系统都在这里。</p>
<p>这里体现了 C 语言的多态。EXT4 没有实现 <code>.read</code>，而是实现了 <code>.read_iter</code>，所以逻辑会走到 <code>new_sync_read</code>。</p>
<p>该函数实现如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c33d0846ff14536a3ac0f528c38d247~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=bAW2ep%2BqkfG7v2zxoa28oxeuBtw%3D" alt="7. new_read.png" loading="lazy"/></p>
<p>可以看到它最终调用了<code>call_read_iter</code>，它位于<code>include/linux/fs.h</code>，我们继续跳转：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2ae8b4014c4ef3b566fc2089b90ebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=nDKJ%2B%2Fdst0qZlK6yOANVLYGUH1E%3D" alt="8. call_read_iter.png" loading="lazy"/></p>
<p>到这里是不是有点熟悉的感觉。继续：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8f83e9fa0904d038fdf189dde011167~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=J0fUKbX4ebffcdN4bGtAFZ4fqTU%3D" alt="9. op.png" loading="lazy"/></p>
<p>不管是<code>read</code>还是<code>read_iter</code>，兜兜转转都是来到了这里。</p>
<p>下一步我们将会离开 VFS，进入 EXT4 的领地。</p>
<h3 data-id="heading-15">4.3 进入EXT4</h3>
<p>经过 VFS 的分发，控制权终于来到了具体的文件系统手中。源码位置<code>fs/ext4/file.c</code>。</p>
<p>我们来看看这个函数的具体实现：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf00f850c134b8abf8dbd280146a979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=gs6ZiWyKanM60rskj1vqxAFkg9I%3D" alt="10. ext4_read.png" loading="lazy"/></p>
<p>这个函数最后又调用了<code>generic_file_read_iter</code>函数，EXT4 最终又把脏活累活都外包给了 Linux 的<strong>内存管理子系统</strong>。</p>
<p>这其实正是 Linux 设计精妙之处，对于基于磁盘的文件系统，读取逻辑高度相似，<strong>都是查 Page Cache，没有就读盘</strong>，所以内核在 <code>mm</code>内存管理子系统里提供了一套通用的标准实现。</p>
<h3 data-id="heading-16">4.4 页缓存 Page Cache</h3>
<p>这是 IO 性能的关键点，<code>generic_file_read_iter</code> 会去查询页缓存，该函数的实现位于<code>mm/filemap.c</code>。该函数依然只贴出关键部分的截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eece88f56b3462b81b44d2d24845f1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=DRFm1bPrXfUoig4hmhbsb4AonHc%3D" alt="11. read_iter.png" loading="lazy"/></p>
<p>第 2525 行到第 2535 行是 Direct I/O 的执行逻辑，如果用户在 <code>open</code> 时加了 <code>O_DIRECT</code> 标志，<code>iocb-&gt;ki_flags</code> 就会有 <code>IOCB_DIRECT</code>，这样会绕过 Page Cache，直接调用文件系统的 <code>direct_IO</code> 接口。如果在这里读取成功，或者读完了，就直接在<code>goto out</code>，不走下面的缓存逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7723896603e44e27b428c89c69d6481a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=9ouO1csjtG3WCOQQJLbkvMHSJ6Y%3D" alt="12. 非direct.png" loading="lazy"/></p>
<p>其实绝大多数都是走查缓存逻辑的，代码会执行 2560 行的<code>generic_file_buffered_read</code>。</p>
<p>这个函数极长，好几百行，这里就不贴代码了，这么多代码主要做了两件事。第一件是<strong>查缓存</strong>，去找有没有现成的页。第二件事是<strong>预读</strong>，如果没有现成的页，它不仅会把当前需要的页读进来，还会把后面几页也顺便读进来，以提高性能。</p>
<h3 data-id="heading-17">4.5 查找物理块</h3>
<p>当内存子系统决定要从磁盘读数据时，它会问 EXT4 文件的第 0 页对应磁盘的哪个块。</p>
<p>该部分源码位置<code>fs/ext4/inode.c</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47b92779538e4df0afd415a34ac01c19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770294059&amp;x-signature=KbnLOO6RBGoxlD0r3wT6oRjbDdM%3D" alt="13. 读盘.png" loading="lazy"/></p>
<p>将逻辑偏移量转换为物理扇区号，最终<code>map-&gt;m_pblk</code> 存储了物理磁盘块号。</p>
<p>拿到了物理块号，内核将其封装成一个 <code>struct bio</code> (Block IO) 请求，提交给通用块层。</p>
<p><code>submit_bio</code> 会将请求放入<strong>电梯调度队列</strong>，最终由 NVMe 或 SATA 驱动通过 DMA 将数据搬运到内存。</p>
<h3 data-id="heading-18">4.6 小结</h3>
<p>看到这里，你应该明白了，<strong>Linux 的 VFS 不仅仅是一层接口，它更像是一套精密的流水线。</strong> 上层的 <code>read_write.c</code> 负责接待，中层的 <code>filemap.c</code> 负责缓存加速，底层的 <code>ext4</code> 负责物理寻址，分工很明确。</p>
<h2 data-id="heading-19">5. 总结</h2>
<p>至此，我们完成了对 Linux VFS 的拆解。</p>
<p>无论底层是 EXT4、FAT32 还是网络 NFS，VFS 都把它们伪装成统一的 <code>struct file</code> 和 <code>struct inode</code>。使得应用开发变的如此简单。</p>
<p>Linux 内核用最古老的 C 语言，通过结构体和函数指针，实现了最极致的<strong>多态</strong>与<strong>抽象</strong>，Linux 内核本身就是一本教科书。</p>
<p>希望通过这个系列文章，当你下次敲下 <code>open()</code> 或 <code>read()</code> 时，脑海中不再只是枯燥的 API 和记不完的参数，而是能浮现出那张巨大的关系图：从 <code>fd</code> 到 <code>dentry</code>，从 <code>inode</code> 到驱动，真真切切地感受内核中的数据漂流。</p>
<p>本文完。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[godot-rust（gdext）你的第一个2D游戏 - 4]]></title>    <link>https://juejin.cn/post/7600587732992229418</link>    <guid>https://juejin.cn/post/7600587732992229418</guid>    <pubDate>2026-01-29T13:12:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600587732992229418" data-draft-id="7600469605476089898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="godot-rust（gdext）你的第一个2D游戏 - 4"/> <meta itemprop="keywords" content="游戏"/> <meta itemprop="datePublished" content="2026-01-29T13:12:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="柚要做甚码"/> <meta itemprop="url" content="https://juejin.cn/user/2200546203156138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            godot-rust（gdext）你的第一个2D游戏 - 4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200546203156138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    柚要做甚码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T13:12:08.000Z" title="Thu Jan 29 2026 13:12:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>本文以<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a>为蓝本撰写，godot-rust提供了该教程的一个rust的实现<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">dodge-the-creeps</a>，与本文方法会稍有不同。如果你对rust、godot等内容比较生疏或感到疑惑，可以先阅读<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" target="_blank">godot-rust入门文档</a>。</p>
<p>本文搭建在<a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目</a>的基础之上，如果你对该部分内容感到生疏，可以先阅读这部分内容，为接下来的操作做好准备。</p>
<p><strong>注意，本文使用的godot版本为4.5.1，godot版本的变化可能会导致一些内容失效</strong>。</p>
<p>本文操作均在Windows上执行。</p>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">创建敌人场景</h3>
<p>如你在创建<code>Player</code>时所做的工作一样，在rust中创建<code>Mob</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(GodotClass)]</span>
<span class="hljs-meta">#[class(base=RigidBody2D)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Mob</span> {
    base: Base&lt;RigidBody2D&gt;,
}
<span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IRigidBody2D</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Mob</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(base: Base&lt;RigidBody2D&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { base }
    }
}
</code></pre>
<p>编译rust</p>
<pre><code class="hljs">cargo build
</code></pre>
<p>回到godot编辑器，在左上角点击<strong>场景</strong>-&gt;<strong>新建场景</strong>-&gt;<strong>其他节点</strong>，创建<code>Mob</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/046ec1c3e7004de495b4bdded7301e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=PTDJfVL%2FcVDPjmtQjYtRQhLmnkI%3D" alt="创建Mob" loading="lazy"/></p>
<p>为<code>Mob</code>添加以下子节点:</p>
<ul>
<li><code>AnimatedSprite2D</code></li>
<li><code>CollisionShape2D</code></li>
<li><code>VisibleOnScreenNotifier2D</code></li>
</ul>
<p>同样将Mob<strong>编组</strong>，这时你的<code>Mob</code>节点看上去应该像这样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9979437cfec4482fa3219da1c1abfd82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=K8yIgH2VqDGuDHhybRuLBHPDHng%3D" alt="Mob和子节点" loading="lazy"/></p>
<p>选中<code>Mob</code>节点，在检查器的<code>RigidBody2D</code>面板中把<code>Gravity Scale</code>设置为<code>0</code>，这样可以防止怪物自由落体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9cde415eb44865820e5e4d4ea7d0e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=6o6uKJ4nvcizWnuuWpuOvopAlEw%3D" alt="修改Mob的Gravity Scale" loading="lazy"/></p>
<p>在<code>RigidBody2D</code>下方的<code>CollisionObject2D</code>面板中，展开<code>Collision</code>分组并取消选中<code>Mask</code>属性里的<code>1</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70a423060aee4fd99c66c61ca3fba2bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=SSt%2FxwuWq2fw5%2FqjnaQQ3neAL7M%3D" alt="确保Mob之前不会碰撞" loading="lazy"/></p>
<blockquote>
<p>这将确保怪物们不会相互碰撞。</p>
</blockquote>
<p><em>原文中这句话中文翻译有歧义，通常我们会理解成字面意思，即怪物之间不会发生碰撞。但通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Ftutorials%2Fphysics%2Fphysics_introduction.html%23collision-layers-and-masks" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/tutorials/physics/physics_introduction.html#collision-layers-and-masks" ref="nofollow noopener noreferrer">手册物理介绍</a>条目可知，取消遮罩层<code>1</code>是<code>Mob</code>忽略<code>Layer 1</code>中任何碰撞检测，推测这是优化设置，但<strong>注意<code>Mob</code>自己依然在<code>Layer 1</code></strong></em></p>
<p>选中<code>AnimatedSprite2D</code>子节点，和之前一样操作设置三个动画，<code>fly</code>、<code>swim</code>、<code>walk</code>，将三个动画的对应动画速度值都调整为<code>3 FPS</code>，从文件夹<strong>art</strong>中拖动对应的图片：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad69f7fdde48415faf6cb57c541841de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=xGSjLCAqjukcozY3GXpn2%2FIB0nQ%3D" alt="fly动画" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf56ffbd27b4303b1b510b94c3ceb6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=cB2uUFHlvuOuBJSCvx51WbA9yC0%3D" alt="swim动画" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f839020779a4d35b6e7290cfa6e0f85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=Czrvug0m%2FnnjrDj6coNvEXd%2FzyY%3D" alt="walk动画" loading="lazy"/></p>
<p>然后将<code>AnimatedSprite2D</code>的<code>Scale</code>属性设为<code>x = 0.75, y = 0.75</code>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21880db28d974bef9e2cd1020e9aa302~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=sHIGzyyhPpck9SwksD2fVTDOGeA%3D" alt="调整AnimatedSprite2D的Scale" loading="lazy"/></p>
<p>像在<code>Player</code>一样，选中<code>CollisionShape2D</code>，为其添加一个<code>CapsuleShape2D</code>，并在<strong>Transform</strong>-&gt;<strong>Rotation</strong>为<code>90</code>。由于三个动画大小不一，我们折中调整碰撞形状大小。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ab1f968aab4878803ef8a83f99e91e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=wzJJJZFm9FITo%2BXTHRP9sMbuwTI%3D" alt="调整CapsuleShape2D的Rotation" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/812a3127e7c34143a6b6ace2cfbc9754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=BXhqE%2FINyg3PCfPqEFrreFygtVo%3D" alt="调增CapsuleShape2D的碰撞形状" loading="lazy"/></p>
<p>保存<code>Mob</code>场景，这时你的<strong>文件系统</strong>面板中应该像这样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b123eeca48bf46f68fb7ef4dad243686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=DtJ07Ib75U91fiYobiigMG33mRQ%3D" alt="保存Mob" loading="lazy"/></p>
<h3 data-id="heading-3">编写敌人代码</h3>
<p>原文的<code>gdscript</code>代码是这样的：</p>
<pre><code class="hljs language-gdscript" lang="gdscript">func _ready():
    var mob_types = Array($AnimatedSprite2D.sprite_frames.get_animation_names())
    $AnimatedSprite2D.animation = mob_types.pick_random()
    $AnimatedSprite2D.play()
</code></pre>
<p>这段代码的逻辑是，从<code>AnimatedSprite2D</code>中获取全部动画名称，随机选择一个动画并播放。但rust中获得的<code>mob_types</code>数据结构中并没有<code>pick_random()</code>这个方法。在godot-rust给出的demo中使用了这样的代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">sprite</span> = <span class="hljs-keyword">self</span>
    .<span class="hljs-title function_ invoke__">base</span>()
    .get_node_as::&lt;AnimatedSprite2D&gt;(<span class="hljs-string">"AnimatedSprite2D"</span>);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">anim_names</span> = sprite.<span class="hljs-title function_ invoke__">get_sprite_frames</span>().<span class="hljs-title function_ invoke__">unwrap</span>().<span class="hljs-title function_ invoke__">get_animation_names</span>();
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">anim_names</span> = anim_names.<span class="hljs-title function_ invoke__">to_typed_array</span>();
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">animation_name</span> = anim_names.<span class="hljs-title function_ invoke__">pick_random</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
</code></pre>
<p>而实际上编译器会在<code>to_typed_array()</code>方法这里报错。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bccd06d07d54852b5a7d20768a6e49a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770297128&amp;x-signature=aCUzMwAciU%2FDd2%2FpN1KvvS6O4xg%3D" alt="代码无效" loading="lazy"/></p>
<p>不着急，我们自己实现一个<code>pick_random()</code>，为rust添加<code>rand crate</code>。</p>
<pre><code class="hljs language-csharp" lang="csharp">cargo <span class="hljs-keyword">add</span> rand
</code></pre>
<p>为godot-rust编写一个trait：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> godot::{builtin::PackedArray, meta::PackedArrayElement};
<span class="hljs-keyword">use</span> rand::Rng;

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">PickRandom</span>&lt;T: PackedArrayElement&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pick_random</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> T;
}
<span class="hljs-keyword">impl</span>&lt;T: PackedArrayElement&gt; PickRandom&lt;T&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">PackedArray</span>&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pick_random</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> T {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rng</span> = rand::<span class="hljs-title function_ invoke__">rng</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">index</span> = rng.<span class="hljs-title function_ invoke__">random_range</span>(<span class="hljs-number">0</span>..<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">len</span>());

        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get</span>(index).<span class="hljs-title function_ invoke__">unwrap</span>()
    }
}
</code></pre>
<p>我们的<code>ready()</code>方法就应该是这样:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">ready</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">sprite</span> = <span class="hljs-keyword">self</span>
        .<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;AnimatedSprite2D&gt;(<span class="hljs-string">"AnimatedSprite2D"</span>);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">random_name</span> = sprite
        .<span class="hljs-title function_ invoke__">get_sprite_frames</span>()
        .<span class="hljs-title function_ invoke__">unwrap</span>()
        .<span class="hljs-title function_ invoke__">get_animation_names</span>()
        .<span class="hljs-title function_ invoke__">pick_random</span>();

    sprite.<span class="hljs-title function_ invoke__">set_animation</span>(random_name.<span class="hljs-title function_ invoke__">arg</span>());
    sprite.<span class="hljs-title function_ invoke__">play</span>();
}
</code></pre>
<p>最后，我们需要在<code>Mob</code>离开屏幕时删除自己，这需要调用<code>VisibleOnScreenNotifier2D</code>节点的<code>screen_exited()</code>信号。我们先写<code>handle</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Mob</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_screen_exited</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">queue_free</span>();
    }
}
</code></pre>
<p>在<code>ready()</code>后面将<strong>信号</strong>和<code>handle</code>连接起来：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">ready</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    ......

    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;VisibleOnScreenNotifier2D&gt;(<span class="hljs-string">"VisibleOnScreenNotifier2D"</span>)
        .<span class="hljs-title function_ invoke__">signals</span>()
        .<span class="hljs-title function_ invoke__">screen_exited</span>()
        .<span class="hljs-title function_ invoke__">connect_other</span>(<span class="hljs-keyword">self</span>, <span class="hljs-keyword">Self</span>::on_screen_exited);
}
</code></pre>
<p>敌人场景就创建完了，接下来我们需要一个游戏场景把<code>Player</code>和<code>Mob</code>联系起来。</p>
<h2 data-id="heading-4">参考</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a></li>
<li><a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fgodot%2F0.4.5%2Fgodot%2F" target="_blank" title="https://docs.rs/godot/0.4.5/godot/" ref="nofollow noopener noreferrer">godot - Rust</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">demo-projects/dodge-the-creeps at master · godot-rust/demo-projects · GitHub</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flowable工作流：从入门到实战]]></title>    <link>https://juejin.cn/post/7600622206269440010</link>    <guid>https://juejin.cn/post/7600622206269440010</guid>    <pubDate>2026-01-30T01:10:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206269440010" data-draft-id="7600606150732890155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flowable工作流：从入门到实战"/> <meta itemprop="keywords" content="工作流引擎"/> <meta itemprop="datePublished" content="2026-01-30T01:10:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flowable工作流：从入门到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:10:21.000Z" title="Fri Jan 30 2026 01:10:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flowable工作流：从入门到实战</h2>
<h3 data-id="heading-1">一、什么是Flowable</h3>
<p>Flowable是一个开源的轻量级业务流程引擎（BPMN 2.0），它起源于Activiti项目，是Activiti的继任者。Flowable提供了完整的工作流和业务流程管理（BPM）平台，支持流程定义、部署、执行、监控等全生命周期管理。</p>
<h4 data-id="heading-2">1.1 核心特性</h4>
<ul>
<li><strong>BPMN 2.0标准支持</strong>：完全符合BPMN 2.0规范</li>
<li><strong>轻量级</strong>：可嵌入到任何Java应用中</li>
<li><strong>高性能</strong>：支持高并发场景</li>
<li><strong>灵活扩展</strong>：提供丰富的扩展点</li>
<li><strong>云原生</strong>：支持微服务架构</li>
</ul>
<h4 data-id="heading-3">1.2 核心组件</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3311a7a20cf6442b94326a9b3ce2b7a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=VCt%2F22i6HOeSLnLRLvIH8LUDybY%3D" alt="" loading="lazy"/></p>
<p>Flowable主要由以下核心组件构成：</p>
<ul>
<li><strong>Flowable Engine</strong>：核心流程引擎</li>
<li><strong>Flowable Modeler</strong>：流程建模工具</li>
<li><strong>Flowable Task</strong>：任务管理应用</li>
<li><strong>Flowable Admin</strong>：管理监控界面</li>
<li><strong>Flowable REST</strong>：REST API接口</li>
</ul>
<h3 data-id="heading-4">二、核心概念详解</h3>
<h4 data-id="heading-5">2.1 BPMN 2.0基础</h4>
<p>BPMN（Business Process Model and Notation）是业务流程建模与 notation 的标准。BPMN 2.0定义了一套标准的图形符号来表示业务流程。</p>
<h5 data-id="heading-6">基本元素</h5>
<ul>
<li><strong>事件（Event）</strong>：流程中发生的事情，如开始事件、结束事件</li>
<li><strong>活动（Activity）</strong>：流程中的工作单元，如用户任务、服务任务</li>
<li><strong>网关（Gateway）</strong>：控制流程分支，如排他网关、并行网关</li>
<li><strong>连接线（Sequence Flow）</strong>：连接各个元素</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15604c79c6764d2e8122efbc1be76eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=4gXyatOBhMRV5Ex%2BUPQHEvlHXpU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.2 流程定义</h4>
<p>流程定义是业务流程的静态描述，使用BPMN XML格式定义。一个典型的请假流程定义如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">definitions</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span>
             <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"Examples"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 开始事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"开始"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 员工填写请假单 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"employeeTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"填写请假单"</span>
                  <span class="hljs-attr">flowable:assignee</span>=<span class="hljs-string">"${employee}"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 部门经理审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"经理审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"managers"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 排他网关：根据天数决定是否需要HR审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"gateway"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- HR审批（超过3天需要） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hrTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"HR审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"hr"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 结束事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"endEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"结束"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 连接线 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"employeeTask"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"employeeTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"managerTask"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"managerTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"gateway"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"hrTask"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${days &gt; 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"endEvent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${days &lt;= 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"hrTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"endEvent"</span>/&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">definitions</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">2.3 流程实例与执行</h4>
<p>流程实例是流程定义的一次具体执行。一个流程定义可以创建多个流程实例，每个实例有独立的执行状态和变量。</p>
<h3 data-id="heading-9">三、快速入门</h3>
<h4 data-id="heading-10">3.1 环境搭建</h4>
<p>首先创建Maven项目，添加Flowable依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Flowable核心引擎 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Flowable REST API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flowable<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flowable-rest<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 数据库连接 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.224<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 日志 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">3.2 初始化流程引擎</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowableEngineConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessEngine processEngine;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProcessEngine <span class="hljs-title function_">getProcessEngine</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (processEngine == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (FlowableEngineConfig.class) {
                <span class="hljs-keyword">if</span> (processEngine == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 配置流程引擎</span>
                    <span class="hljs-type">ProcessEngineConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ProcessEngineConfiguration
                            .createStandaloneProcessEngineConfiguration();

                    <span class="hljs-comment">// 配置数据库连接</span>
                    configuration.setJdbcDriver(<span class="hljs-string">"org.h2.Driver"</span>);
                    configuration.setJdbcUrl(<span class="hljs-string">"jdbc:h2:mem:flowable;DB_CLOSE_DELAY=-1"</span>);
                    configuration.setJdbcUsername(<span class="hljs-string">"sa"</span>);
                    configuration.setJdbcPassword(<span class="hljs-string">""</span>);

                    <span class="hljs-comment">// 自动创建/更新数据库表结构</span>
                    configuration.setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);

                    <span class="hljs-comment">// 创建流程引擎</span>
                    processEngine = configuration.buildProcessEngine();
                }
            }
        }
        <span class="hljs-keyword">return</span> processEngine;
    }

    <span class="hljs-comment">// 获取各个服务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RepositoryService <span class="hljs-title function_">getRepositoryService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getRepositoryService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RuntimeService <span class="hljs-title function_">getRuntimeService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getRuntimeService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskService <span class="hljs-title function_">getTaskService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getTaskService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HistoryService <span class="hljs-title function_">getHistoryService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getHistoryService();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ManagementService <span class="hljs-title function_">getManagementService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> getProcessEngine().getManagementService();
    }
}
</code></pre>
<h4 data-id="heading-12">3.3 部署流程定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessDeploymentService</span> {

    <span class="hljs-comment">/**
     * 部署流程定义
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deployProcess</span><span class="hljs-params">(String processName, String resourcePath)</span> {
        <span class="hljs-type">Deployment</span> <span class="hljs-variable">deployment</span> <span class="hljs-operator">=</span> FlowableEngineConfig.getRepositoryService()
                .createDeployment()
                .name(processName)
                .addClasspathResource(resourcePath)
                .deploy();

        System.out.println(<span class="hljs-string">"流程部署成功，部署ID: "</span> + deployment.getId());
        <span class="hljs-keyword">return</span> deployment.getId();
    }

    <span class="hljs-comment">/**
     * 查询已部署的流程列表
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProcessDefinition&gt; <span class="hljs-title function_">listProcesses</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> FlowableEngineConfig.getRepositoryService()
                .createProcessDefinitionQuery()
                .orderByProcessDefinitionName()
                .asc()
                .list();
    }
}
</code></pre>
<h4 data-id="heading-13">3.4 启动流程实例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessInstanceService</span> {

    <span class="hljs-comment">/**
     * 启动流程实例
     */</span>
    <span class="hljs-keyword">public</span> ProcessInstance <span class="hljs-title function_">startProcess</span><span class="hljs-params">(String processDefinitionKey, Map&lt;String, Object&gt; variables)</span> {
        <span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> FlowableEngineConfig.getRuntimeService()
                .startProcessInstanceByKey(processDefinitionKey, variables);

        System.out.println(<span class="hljs-string">"流程实例启动成功，实例ID: "</span> + processInstance.getId());
        System.out.println(<span class="hljs-string">"业务Key: "</span> + processInstance.getBusinessKey());

        <span class="hljs-keyword">return</span> processInstance;
    }

    <span class="hljs-comment">/**
     * 查询运行中的流程实例
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProcessInstance&gt; <span class="hljs-title function_">listRunningInstances</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> FlowableEngineConfig.getRuntimeService()
                .createProcessInstanceQuery()
                .orderByStartTime()
                .desc()
                .list();
    }
}
</code></pre>
<h3 data-id="heading-14">四、核心服务详解</h3>
<p>Flowable通过服务层对外提供功能，主要包括以下服务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac5929ac76274dec9c565013fda3fceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=8CBrIwwOVEd%2FyU2lwRFlgZPr2Ck%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">4.1 RepositoryService（仓库服务）</h4>
<p>管理流程定义和部署对象：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 部署流程</span>
<span class="hljs-type">Deployment</span> <span class="hljs-variable">deployment</span> <span class="hljs-operator">=</span> repositoryService.createDeployment()
    .name(<span class="hljs-string">"请假流程"</span>)
    .addClasspathResource(<span class="hljs-string">"processes/leave-request.bpmn20.xml"</span>)
    .deploy();

<span class="hljs-comment">// 查询流程定义</span>
<span class="hljs-type">ProcessDefinition</span> <span class="hljs-variable">processDefinition</span> <span class="hljs-operator">=</span> repositoryService
    .createProcessDefinitionQuery()
    .processDefinitionKey(<span class="hljs-string">"leaveRequest"</span>)
    .singleResult();

<span class="hljs-comment">// 挂起/激活流程定义</span>
repositoryService.suspendProcessDefinitionById(processDefinitionId);
repositoryService.activateProcessDefinitionById(processDefinitionId);

<span class="hljs-comment">// 删除流程定义</span>
repositoryService.deleteDeployment(deploymentId, <span class="hljs-literal">true</span>);
</code></pre>
<h4 data-id="heading-16">4.2 RuntimeService（运行时服务）</h4>
<p>管理流程实例和执行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 启动流程实例</span>
<span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> runtimeService
    .startProcessInstanceByKey(<span class="hljs-string">"leaveRequest"</span>, variables);

<span class="hljs-comment">// 设置流程变量</span>
runtimeService.setVariable(processInstanceId, <span class="hljs-string">"days"</span>, <span class="hljs-number">5</span>);
runtimeService.setVariable(processInstanceId, <span class="hljs-string">"reason"</span>, <span class="hljs-string">"休息"</span>);

<span class="hljs-comment">// 获取流程变量</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">days</span> <span class="hljs-operator">=</span> (Integer) runtimeService.getVariable(processInstanceId, <span class="hljs-string">"days"</span>);

<span class="hljs-comment">// 触发流程执行</span>
runtimeService.trigger(executionId);

<span class="hljs-comment">// 挂起/激活流程实例</span>
runtimeService.suspendProcessInstanceById(processInstanceId);
runtimeService.activateProcessInstanceById(processInstanceId);

<span class="hljs-comment">// 删除流程实例</span>
runtimeService.deleteProcessInstance(processInstanceId, <span class="hljs-string">"取消申请"</span>);
</code></pre>
<h4 data-id="heading-17">4.3 TaskService（任务服务）</h4>
<p>管理用户任务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询用户的待办任务</span>
List&lt;Task&gt; tasks = taskService.createTaskQuery()
    .taskAssignee(<span class="hljs-string">"zhangsan"</span>)
    .orderByTaskCreateTime()
    .desc()
    .list();

<span class="hljs-comment">// 完成任务</span>
taskService.complete(taskId);

<span class="hljs-comment">// 带变量完成任务</span>
Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
variables.put(<span class="hljs-string">"approved"</span>, <span class="hljs-literal">true</span>);
taskService.complete(taskId, variables);

<span class="hljs-comment">// 认领任务（候选任务）</span>
taskService.claim(taskId, <span class="hljs-string">"lisi"</span>);

<span class="hljs-comment">// 委派任务</span>
taskService.delegateTask(taskId, <span class="hljs-string">"wangwu"</span>);

<span class="hljs-comment">// 设置任务优先级</span>
taskService.setPriority(taskId, <span class="hljs-number">50</span>);
</code></pre>
<h4 data-id="heading-18">4.4 HistoryService（历史服务）</h4>
<p>查询历史数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询已完成的流程实例</span>
List&lt;HistoricProcessInstance&gt; finishedInstances = historyService
    .createHistoricProcessInstanceQuery()
    .finished()
    .orderByProcessInstanceEndTime()
    .desc()
    .list();

<span class="hljs-comment">// 查询历史任务</span>
List&lt;HistoricTaskInstance&gt; historicTasks = historyService
    .createHistoricTaskInstanceQuery()
    .taskAssignee(<span class="hljs-string">"zhangsan"</span>)
    .finished()
    .list();

<span class="hljs-comment">// 查询历史变量</span>
List&lt;HistoricVariableInstance&gt; variables = historyService
    .createHistoricVariableInstanceQuery()
    .processInstanceId(processInstanceId)
    .list();

<span class="hljs-comment">// 查询流程实例历史（按时间线）</span>
List&lt;HistoricActivityInstance&gt; activities = historyService
    .createHistoricActivityInstanceQuery()
    .processInstanceId(processInstanceId)
    .orderByHistoricActivityInstanceStartTime()
    .asc()
    .list();
</code></pre>
<h4 data-id="heading-19">4.5 ManagementService（管理服务）</h4>
<p>执行管理操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取数据库表信息</span>
<span class="hljs-type">TableMetaData</span> <span class="hljs-variable">tableMetaData</span> <span class="hljs-operator">=</span> managementService
    .getTablesMetaData()
    .get(<span class="hljs-string">"ACT_RU_TASK"</span>);

<span class="hljs-comment">// 执行自定义SQL</span>
List&lt;Map&lt;String, Object&gt;&gt; results = managementService
    .executeCustomSql(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractCustomSqlExecution</span>&lt;CustomQuery, List&lt;Map&lt;String, Object&gt;&gt;&gt;(CustomQuery.class) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">(Configuration configuration)</span> {
                <span class="hljs-comment">// 自定义SQL执行逻辑</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }
    );

<span class="hljs-comment">// 获取作业列表</span>
List&lt;Job&gt; jobs = managementService.createJobQuery().list();
</code></pre>
<h3 data-id="heading-20">五、实战案例：请假审批系统</h3>
<h4 data-id="heading-21">5.1 业务需求</h4>
<p>实现一个企业内部请假审批系统，支持以下功能：</p>
<ol>
<li>员工提交请假申请</li>
<li>部门经理审批（1-3天直接通过）</li>
<li>HR审批（超过3天需要HR审批）</li>
<li>审批通过/驳回</li>
<li>查询请假记录</li>
</ol>
<h4 data-id="heading-22">5.2 系统架构设计</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc2e5a1e5e58411d87e458289074bf86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=MOQYdYbaqMfA0OKE9XEDVJKkGpE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">5.3 流程定义</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">definitions</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span>
             <span class="hljs-attr">xmlns:flowable</span>=<span class="hljs-string">"http://flowable.org/bpmn"</span>
             <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"Examples"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假审批流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 开始事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"提交申请"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 员工填写请假单 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitLeave"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"填写请假单"</span>
                  <span class="hljs-attr">flowable:assignee</span>=<span class="hljs-string">"${initiator}"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>员工填写请假信息，包括请假天数、原因等<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 部门经理审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerApproval"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"经理审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"managers"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>部门经理审批请假申请<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 排他网关：根据审批结果和天数决定流程走向 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"approvalGateway"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 驳回处理 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"rejectHandler"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"处理驳回"</span>
                     <span class="hljs-attr">flowable:class</span>=<span class="hljs-string">"com.example.flowable.delegate.RejectDelegate"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- HR审批（超过3天） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hrApproval"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"HR审批"</span>
                  <span class="hljs-attr">flowable:candidateGroups</span>=<span class="hljs-string">"hr"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>HR审批长期请假申请<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 通知员工 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"发送通知"</span>
                     <span class="hljs-attr">flowable:class</span>=<span class="hljs-string">"com.example.flowable.delegate.NotifyDelegate"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 结束事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"approveEnd"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批通过"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"rejectEnd"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批驳回"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 连接线 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow1"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"submitLeave"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow2"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"submitLeave"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"managerApproval"</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow3"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"managerApproval"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"approvalGateway"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 驳回 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow4"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"approvalGateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"rejectHandler"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${approved == false}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow5"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"rejectHandler"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"notifyEmployee"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow6"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"rejectEnd"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 通过但需要HR审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow7"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"approvalGateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"hrApproval"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${approved == true &amp;&amp; days &gt; 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow8"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"hrApproval"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"notifyEmployee"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow9"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"approveEnd"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 通过且不需要HR审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow10"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"approvalGateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"notifyEmployee"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span>&gt;</span>${approved == true &amp;&amp; days &lt;= 3}<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow11"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"notifyEmployee"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"approveEnd"</span>/&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">definitions</span>&gt;</span>
</code></pre>
<h4 data-id="heading-24">5.4 服务层实现</h4>
<h5 data-id="heading-25">请假服务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequestService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;

    <span class="hljs-comment">/**
     * 创建请假申请
     */</span>
    <span class="hljs-keyword">public</span> LeaveRequest <span class="hljs-title function_">createLeaveRequest</span><span class="hljs-params">(LeaveRequest request)</span> {
        <span class="hljs-comment">// 设置流程变量</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"initiator"</span>, request.getEmployeeId());
        variables.put(<span class="hljs-string">"days"</span>, request.getDays());
        variables.put(<span class="hljs-string">"reason"</span>, request.getReason());
        variables.put(<span class="hljs-string">"startDate"</span>, request.getStartDate());
        variables.put(<span class="hljs-string">"endDate"</span>, request.getEndDate());

        <span class="hljs-comment">// 启动流程实例</span>
        <span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> runtimeService
                .startProcessInstanceByKey(<span class="hljs-string">"leaveRequest"</span>, request.getBusinessKey(), variables);

        <span class="hljs-comment">// 完成填写请假单任务，自动流转到经理审批</span>
        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTaskQuery()
                .processInstanceId(processInstance.getId())
                .taskAssignee(request.getEmployeeId())
                .singleResult();

        <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) {
            taskService.complete(task.getId());
        }

        <span class="hljs-comment">// 保存流程实例ID</span>
        request.setProcessInstanceId(processInstance.getId());
        request.setStatus(<span class="hljs-string">"pending"</span>);

        <span class="hljs-keyword">return</span> request;
    }

    <span class="hljs-comment">/**
     * 经理审批
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">managerApproval</span><span class="hljs-params">(String taskId, <span class="hljs-type">boolean</span> approved, String comment)</span> {
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"approved"</span>, approved);
        variables.put(<span class="hljs-string">"managerComment"</span>, comment);

        <span class="hljs-comment">// 添加审批意见</span>
        taskService.addComment(taskId, <span class="hljs-literal">null</span>, comment);

        <span class="hljs-comment">// 完成任务</span>
        taskService.complete(taskId, variables);
    }

    <span class="hljs-comment">/**
     * HR审批
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hrApproval</span><span class="hljs-params">(String taskId, <span class="hljs-type">boolean</span> approved, String comment)</span> {
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"approved"</span>, approved);
        variables.put(<span class="hljs-string">"hrComment"</span>, comment);

        taskService.addComment(taskId, <span class="hljs-literal">null</span>, comment);
        taskService.complete(taskId, variables);
    }

    <span class="hljs-comment">/**
     * 获取用户的待办任务
     */</span>
    <span class="hljs-keyword">public</span> List&lt;TaskDTO&gt; <span class="hljs-title function_">getMyTasks</span><span class="hljs-params">(String userId)</span> {
        List&lt;Task&gt; tasks = taskService.createTaskQuery()
                .taskAssignee(userId)
                .orderByTaskCreateTime()
                .desc()
                .list();

        <span class="hljs-keyword">return</span> tasks.stream()
                .map(<span class="hljs-built_in">this</span>::convertToDTO)
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 获取组任务（候选任务）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;TaskDTO&gt; <span class="hljs-title function_">getCandidateTasks</span><span class="hljs-params">(String groupId)</span> {
        List&lt;Task&gt; tasks = taskService.createTaskQuery()
                .taskCandidateGroup(groupId)
                .orderByTaskCreateTime()
                .desc()
                .list();

        <span class="hljs-keyword">return</span> tasks.stream()
                .map(<span class="hljs-built_in">this</span>::convertToDTO)
                .collect(Collectors.toList());
    }

    <span class="hljs-comment">/**
     * 认领任务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">claimTask</span><span class="hljs-params">(String taskId, String userId)</span> {
        taskService.claim(taskId, userId);
    }

    <span class="hljs-comment">/**
     * 查询请假历史记录
     */</span>
    <span class="hljs-keyword">public</span> List&lt;LeaveRequestHistory&gt; <span class="hljs-title function_">getLeaveHistory</span><span class="hljs-params">(String employeeId)</span> {
        List&lt;HistoricProcessInstance&gt; instances = historyService
                .createHistoricProcessInstanceQuery()
                .variableValueEquals(<span class="hljs-string">"initiator"</span>, employeeId)
                .orderByProcessInstanceStartTime()
                .desc()
                .list();

        <span class="hljs-keyword">return</span> instances.stream()
                .map(<span class="hljs-built_in">this</span>::convertToHistory)
                .collect(Collectors.toList());
    }

    <span class="hljs-keyword">private</span> TaskDTO <span class="hljs-title function_">convertToDTO</span><span class="hljs-params">(Task task)</span> {
        <span class="hljs-type">TaskDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskDTO</span>();
        dto.setTaskId(task.getId());
        dto.setTaskName(task.getName());
        dto.setProcessInstanceId(task.getProcessInstanceId());
        dto.setCreateTime(task.getCreateTime());
        dto.setAssignee(task.getAssignee());

        <span class="hljs-comment">// 获取流程变量</span>
        Map&lt;String, Object&gt; variables = taskService.getVariables(task.getId());
        dto.setVariables(variables);

        <span class="hljs-keyword">return</span> dto;
    }
}
</code></pre>
<h5 data-id="heading-26">驳回处理委托</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RejectDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JavaDelegate</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> execution.getProcessInstanceId();
        <span class="hljs-type">String</span> <span class="hljs-variable">initiator</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"initiator"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">reason</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"reason"</span>);

        <span class="hljs-comment">// 记录驳回原因</span>
        execution.setVariable(<span class="hljs-string">"rejectReason"</span>, <span class="hljs-string">"请假申请被驳回"</span>);

        <span class="hljs-comment">// 这里可以发送通知、更新业务系统状态等</span>
        System.out.println(<span class="hljs-string">"驳回请假申请: "</span> + processInstanceId);
        System.out.println(<span class="hljs-string">"申请人: "</span> + initiator);
        System.out.println(<span class="hljs-string">"请假原因: "</span> + reason);

        <span class="hljs-comment">// 可以调用外部服务发送邮件、短信通知</span>
        <span class="hljs-comment">// notificationService.sendRejectNotification(initiator);</span>
    }
}
</code></pre>
<h5 data-id="heading-27">通知委托</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotifyDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JavaDelegate</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> execution.getProcessInstanceId();
        <span class="hljs-type">String</span> <span class="hljs-variable">initiator</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"initiator"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">approved</span> <span class="hljs-operator">=</span> (Boolean) execution.getVariable(<span class="hljs-string">"approved"</span>);

        <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(approved)) {
            System.out.println(<span class="hljs-string">"审批通过通知: "</span> + processInstanceId);
            <span class="hljs-comment">// 发送通过通知</span>
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"审批驳回通知: "</span> + processInstanceId);
            <span class="hljs-comment">// 发送驳回通知</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-28">5.5 REST API</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/leave")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequestController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LeaveRequestService leaveRequestService;

    <span class="hljs-comment">/**
     * 提交请假申请
     */</span>
    <span class="hljs-meta">@PostMapping("/submit")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;LeaveRequest&gt; <span class="hljs-title function_">submitLeave</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LeaveRequest request)</span> {
        <span class="hljs-type">LeaveRequest</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> leaveRequestService.createLeaveRequest(request);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(result);
    }

    <span class="hljs-comment">/**
     * 获取我的待办任务
     */</span>
    <span class="hljs-meta">@GetMapping("/my-tasks")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;TaskDTO&gt;&gt; <span class="hljs-title function_">getMyTasks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String userId)</span> {
        List&lt;TaskDTO&gt; tasks = leaveRequestService.getMyTasks(userId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(tasks);
    }

    <span class="hljs-comment">/**
     * 获取候选任务
     */</span>
    <span class="hljs-meta">@GetMapping("/candidate-tasks")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;TaskDTO&gt;&gt; <span class="hljs-title function_">getCandidateTasks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String groupId)</span> {
        List&lt;TaskDTO&gt; tasks = leaveRequestService.getCandidateTasks(groupId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(tasks);
    }

    <span class="hljs-comment">/**
     * 认领任务
     */</span>
    <span class="hljs-meta">@PostMapping("/tasks/{taskId}/claim")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">claimTask</span><span class="hljs-params">(
            <span class="hljs-meta">@PathVariable</span> String taskId,
            <span class="hljs-meta">@RequestParam</span> String userId)</span> {
        leaveRequestService.claimTask(taskId, userId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok().build();
    }

    <span class="hljs-comment">/**
     * 完成审批
     */</span>
    <span class="hljs-meta">@PostMapping("/tasks/{taskId}/complete")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">completeTask</span><span class="hljs-params">(
            <span class="hljs-meta">@PathVariable</span> String taskId,
            <span class="hljs-meta">@RequestBody</span> ApprovalRequest approval)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"managerApproval"</span>.equals(approval.getTaskName())) {
            leaveRequestService.managerApproval(taskId, approval.isApproved(), approval.getComment());
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"hrApproval"</span>.equals(approval.getTaskName())) {
            leaveRequestService.hrApproval(taskId, approval.isApproved(), approval.getComment());
        }
        <span class="hljs-keyword">return</span> ResponseEntity.ok().build();
    }

    <span class="hljs-comment">/**
     * 查询请假历史
     */</span>
    <span class="hljs-meta">@GetMapping("/history")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;LeaveRequestHistory&gt;&gt; <span class="hljs-title function_">getHistory</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String employeeId)</span> {
        List&lt;LeaveRequestHistory&gt; history = leaveRequestService.getLeaveHistory(employeeId);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(history);
    }
}
</code></pre>
<h3 data-id="heading-29">六、高级特性</h3>
<h4 data-id="heading-30">6.1 并行网关</h4>
<p>并行网关用于处理多个并发任务：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parallelGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fork"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parallelGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"join"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 分支1 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"任务1"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"fork"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"task1"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"task1"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"join"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 分支2 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task2"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"任务2"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"fork"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"task2"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"task2"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"join"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 分支3 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"task3"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"任务3"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"fork"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"task3"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"task3"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"join"</span>/&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/538e42783af64a28b77a4692a8aac1e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=PcjUBaboK3BzAJmkrZU3us3snvE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-31">6.2 子流程</h4>
<p>子流程用于封装可重用的流程片段：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">subProcess</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subProcess"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批子流程"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subStart"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"子流程任务"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"subEnd"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"subStart"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"subTask"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"subTask"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"subEnd"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subProcess</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">callActivity</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"callSubProcess"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"调用子流程"</span>
               <span class="hljs-attr">calledElement</span>=<span class="hljs-string">"subProcess"</span>/&gt;</span>
</code></pre>
<h4 data-id="heading-32">6.3 事件机制</h4>
<p>Flowable支持多种事件类型：</p>
<ul>
<li><strong>定时器事件</strong>：基于时间的触发</li>
<li><strong>消息事件</strong>：异步消息传递</li>
<li><strong>信号事件</strong>：广播式通知</li>
<li><strong>错误事件</strong>：异常处理</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 定时器事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">intermediateCatchEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"timerEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"等待通知"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">timerEventDefinition</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">timeDuration</span>&gt;</span>PT2H<span class="hljs-tag">&lt;/<span class="hljs-name">timeDuration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">timerEventDefinition</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">intermediateCatchEvent</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 消息事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">intermediateCatchEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messageEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"接收消息"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">messageEventDefinition</span> <span class="hljs-attr">messageRef</span>=<span class="hljs-string">"approvalMessage"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">intermediateCatchEvent</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 边界定时器事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">boundaryEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"boundaryTimer"</span> <span class="hljs-attr">attachedToRef</span>=<span class="hljs-string">"userTask"</span>
               <span class="hljs-attr">cancelActivity</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">timerEventDefinition</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">timeDuration</span>&gt;</span>PT1H<span class="hljs-tag">&lt;/<span class="hljs-name">timeDuration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">timerEventDefinition</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">boundaryEvent</span>&gt;</span>
</code></pre>
<h4 data-id="heading-33">6.4 监听器</h4>
<p>通过监听器实现业务逻辑的扩展：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 流程启动监听器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessStartListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutionListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processDefinitionId</span> <span class="hljs-operator">=</span> execution.getProcessDefinitionId();
        System.out.println(<span class="hljs-string">"流程启动: "</span> + processDefinitionId);

        <span class="hljs-comment">// 记录日志、发送通知等</span>
    }
}

<span class="hljs-comment">// 任务创建监听器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskCreateListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaskListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(DelegateTask delegateTask)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">taskName</span> <span class="hljs-operator">=</span> delegateTask.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">assignee</span> <span class="hljs-operator">=</span> delegateTask.getAssignee();
        System.out.println(<span class="hljs-string">"任务创建: "</span> + taskName + <span class="hljs-string">", 分配给: "</span> + assignee);

        <span class="hljs-comment">// 发送任务通知</span>
    }
}
</code></pre>
<p>配置监听器：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">flowable:executionListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"start"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.flowable.listener.ProcessStartListener"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerTask"</span> <span class="hljs-attr">flowable:assignee</span>=<span class="hljs-string">"${manager}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">flowable:taskListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"create"</span>
                <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.flowable.listener.TaskCreateListener"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
</code></pre>
<h3 data-id="heading-34">七、生产环境最佳实践</h3>
<h4 data-id="heading-35">7.1 数据库优化</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为常用查询字段添加索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_ru_task_ASSIGNEE <span class="hljs-keyword">ON</span> ACT_RU_TASK(ASSIGNEE_);
<span class="hljs-keyword">CREATE</span> INDEX idx_ru_task_PROC_INST <span class="hljs-keyword">ON</span> ACT_RU_TASK(PROC_INST_ID_);
<span class="hljs-keyword">CREATE</span> INDEX idx_hi_procinst_BUS_KEY <span class="hljs-keyword">ON</span> ACT_HI_PROCINST(BUS_KEY_);
<span class="hljs-keyword">CREATE</span> INDEX idx_hi_actinst_PROC_INST <span class="hljs-keyword">ON</span> ACT_HI_ACTINST(PROC_INST_ID_);

<span class="hljs-comment">-- 定期清理历史数据（根据业务需求配置保留时长）</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> ACT_HI_VARINST <span class="hljs-keyword">WHERE</span> END_TIME_ <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> ACT_HI_DETAIL <span class="hljs-keyword">WHERE</span> TIME_ <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);
</code></pre>
<h4 data-id="heading-36">7.2 性能优化</h4>
<ol>
<li><strong>异步执行</strong>：对耗时操作使用异步任务</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"asyncTask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"异步任务"</span>
             <span class="hljs-attr">flowable:async</span>=<span class="hljs-string">"true"</span>
             <span class="hljs-attr">flowable:class</span>=<span class="hljs-string">"com.example.flowable.delegate.AsyncTaskDelegate"</span>/&gt;</span>
</code></pre>
<ol start="2">
<li><strong>批量操作</strong>：使用批量查询和操作API</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 批量查询任务</span>
List&lt;Task&gt; tasks = taskService.createTaskQuery()
    .taskAssignee(<span class="hljs-string">"user1"</span>)
    .listPage(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>);

<span class="hljs-comment">// 批量完成任务</span>
List&lt;String&gt; taskIds = Arrays.asList(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>, <span class="hljs-string">"task3"</span>);
taskService.completeBatchTasks(taskIds);
</code></pre>
<ol start="3">
<li><strong>缓存配置</strong>：启用流程定义缓存</li>
</ol>
<pre><code class="hljs language-java" lang="java">configuration.setProcessDefinitionCacheSize(<span class="hljs-number">100</span>);
configuration.setEnableProcessDefinitionInfoCache(<span class="hljs-literal">true</span>);
</code></pre>
<h4 data-id="heading-37">7.3 安全配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置用户权限管理</span>
<span class="hljs-type">IdentityService</span> <span class="hljs-variable">identityService</span> <span class="hljs-operator">=</span> processEngine.getIdentityService();

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> identityService.newUser(<span class="hljs-string">"zhangsan"</span>);
user.setFirstName(<span class="hljs-string">"三"</span>);
user.setLastName(<span class="hljs-string">"张"</span>);
user.setEmail(<span class="hljs-string">"zhangsan@example.com"</span>);
identityService.saveUser(user);

<span class="hljs-comment">// 创建组</span>
<span class="hljs-type">Group</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> identityService.newGroup(<span class="hljs-string">"managers"</span>);
group.setName(<span class="hljs-string">"经理组"</span>);
identityService.saveGroup(group);

<span class="hljs-comment">// 分配用户到组</span>
identityService.createMembership(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"managers"</span>);
</code></pre>
<h4 data-id="heading-38">7.4 监控与告警</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1d0cda076c485e921861d27222f888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770340220&amp;x-signature=Jf5%2Fh9ldNIll%2FjRcknHzxtFRikw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowableMonitorService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ManagementService managementService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-comment">/**
     * 获取运行中的流程统计
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Long&gt; <span class="hljs-title function_">getProcessStatistics</span><span class="hljs-params">()</span> {
        Map&lt;String, Long&gt; stats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 各流程运行实例数</span>
        List&lt;ProcessInstance&gt; instances = runtimeService.createProcessInstanceQuery().list();
        Map&lt;String, Long&gt; countByProcess = instances.stream()
            .collect(Collectors.groupingBy(
                ProcessInstance::getProcessDefinitionKey,
                Collectors.counting()
            ));
        stats.putAll(countByProcess);

        <span class="hljs-comment">// 待办任务统计</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">pendingTasks</span> <span class="hljs-operator">=</span> managementService.createTaskQuery().count();
        stats.put(<span class="hljs-string">"pendingTasks"</span>, pendingTasks);

        <span class="hljs-keyword">return</span> stats;
    }

    <span class="hljs-comment">/**
     * 检测异常流程（运行时间过长）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProcessInstance&gt; <span class="hljs-title function_">detectLongRunningProcesses</span><span class="hljs-params">(<span class="hljs-type">int</span> thresholdHours)</span> {
        <span class="hljs-type">Date</span> <span class="hljs-variable">threshold</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() - thresholdHours * <span class="hljs-number">3600000L</span>);

        <span class="hljs-keyword">return</span> runtimeService.createProcessInstanceQuery()
            .startedBefore(threshold)
            .list();
    }

    <span class="hljs-comment">/**
     * 获取数据库表信息
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getDatabaseInfo</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 获取各表记录数</span>
        String[] tables = {<span class="hljs-string">"ACT_RU_EXECUTION"</span>, <span class="hljs-string">"ACT_RU_TASK"</span>, <span class="hljs-string">"ACT_HI_PROCINST"</span>};
        <span class="hljs-keyword">for</span> (String table : tables) {
            <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> managementService.createTablePageQuery()
                .tableName(table)
                .listPage(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
                .getTotal();
            info.put(table, count);
        }

        <span class="hljs-keyword">return</span> info;
    }
}
</code></pre>
<h3 data-id="heading-39">八、微服务集成</h3>
<p>在微服务架构中使用Flowable：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml配置</span>
<span class="hljs-attr">flowable:</span>
  <span class="hljs-comment"># 数据库配置</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/flowable?useSSL=false</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">flowable</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">flowable</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

  <span class="hljs-comment"># 异步执行器配置</span>
  <span class="hljs-attr">async-executor-activate:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">async-executor-max-jobs-per-acquisition:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">async-executor-default-queue-size:</span> <span class="hljs-number">100</span>

  <span class="hljs-comment"># REST API配置</span>
  <span class="hljs-attr">rest:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>

  <span class="hljs-comment"># 邮件服务器配置</span>
  <span class="hljs-attr">mail:</span>
    <span class="hljs-attr">server:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-string">smtp.example.com</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">587</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">noreply@example.com</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">password</span>
</code></pre>
<p>服务间通信示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowIntegrationService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;

    <span class="hljs-comment">/**
     * 跨服务启动流程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startCrossServiceProcess</span><span class="hljs-params">(WorkflowRequest request)</span> {
        <span class="hljs-comment">// 调用其他服务获取数据</span>
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(
            <span class="hljs-string">"http://user-service/api/users/"</span> + request.getUserId(),
            UserDTO.class
        );

        <span class="hljs-comment">// 设置流程变量</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"user"</span>, user);
        variables.put(<span class="hljs-string">"request"</span>, request);

        <span class="hljs-comment">// 启动流程</span>
        runtimeService.startProcessInstanceByKey(
            <span class="hljs-string">"crossServiceProcess"</span>,
            request.getBusinessKey(),
            variables
        );
    }

    <span class="hljs-comment">/**
     * 流程回调处理
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleProcessCallback</span><span class="hljs-params">(String processInstanceId, String eventType)</span> {
        <span class="hljs-comment">// 根据事件类型执行不同操作</span>
        <span class="hljs-keyword">switch</span> (eventType) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"completed"</span>:
                <span class="hljs-comment">// 流程完成后的处理</span>
                handleProcessCompleted(processInstanceId);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"cancelled"</span>:
                <span class="hljs-comment">// 流程取消后的处理</span>
                handleProcessCancelled(processInstanceId);
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-40">九、总结</h3>
<p>Flowable作为一款优秀的开源工作流引擎，具有以下优势：</p>
<ol>
<li><strong>标准化</strong>：完全符合BPMN 2.0标准，学习成本低</li>
<li><strong>轻量级</strong>：可嵌入任何Java应用，部署简单</li>
<li><strong>高性能</strong>：支持高并发场景，适合企业级应用</li>
<li><strong>灵活扩展</strong>：提供丰富的扩展点，易于定制</li>
<li><strong>社区活跃</strong>：文档完善，社区支持良好</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 2.3.20 重磅更新：GC 默认启用并发标记，UI 响应速度大幅提升]]></title>    <link>https://juejin.cn/post/7600616270003650598</link>    <guid>https://juejin.cn/post/7600616270003650598</guid>    <pubDate>2026-01-30T01:24:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600616270003650598" data-draft-id="7600684978352979995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 2.3.20 重磅更新：GC 默认启用并发标记，UI 响应速度大幅提升"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-30T01:24:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄林晴"/> <meta itemprop="url" content="https://juejin.cn/user/3985057546510423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 2.3.20 重磅更新：GC 默认启用并发标记，UI 响应速度大幅提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3985057546510423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄林晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:24:23.000Z" title="Fri Jan 30 2026 01:24:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2026 年 1 月 29 日，Kotlin 2.3.20-Beta2 发布。这次更新虽然还是 Beta 版，但带来了一个<strong>实验性但意义重大</strong>的变化：<strong>Kotlin/Native 的垃圾回收器（GC）默认启用了并发标记（Concurrent Marking）</strong>。</p>
<h2 data-id="heading-0">一、什么是并发标记 GC？</h2>
<h3 data-id="heading-1">先说问题</h3>
<p>在之前的默认配置 PMCS（Parallel Mark Concurrent Sweep）中：</p>
<blockquote>
<p>GC 标记阶段必须暂停所有应用线程。</p>
</blockquote>
<p>这意味着什么？当 GC 需要标记堆中的对象时，<strong>你的应用会停下来等待</strong>。</p>
<p>对于延迟敏感的应用——尤其是 UI 应用，这种"暂停"直接表现为<strong>卡顿、掉帧</strong>。</p>
<h3 data-id="heading-2">再说解决</h3>
<p>CMS（Concurrent Mark and Sweep）的核心改进：</p>
<blockquote>
<p><strong>标记阶段可以与应用线程并发执行！</strong></p>
</blockquote>
<p>简单来说：GC 标记对象时，你的应用可以继续运行。</p>
<h2 data-id="heading-3">二、实际效果</h2>
<p>官方已经用 Compose Multiplatform UI 应用做了基准测试：</p>
<blockquote>
<p><strong>CMS 显著改善了性能表现。</strong></p>
</blockquote>
<p>这意味着：</p>
<ul>
<li>更短的 GC 暂停时间</li>
<li>更流畅的用户界面</li>
<li>更好的响应速度</li>
</ul>
<h2 data-id="heading-4">三、如何使用</h2>
<h3 data-id="heading-5">默认启用（Beta 版）</h3>
<p>在 Kotlin 2.3.20-Beta1 和 Beta2 中，<strong>CMS 已经是默认配置</strong>。</p>
<p>你什么都不用改，直接升级版本就能体验：</p>
<pre><code class="hljs language-gradle" lang="gradle">kotlin("multiplatform") version "2.3.20-Beta2"
</code></pre>
<h3 data-id="heading-6">如果遇到问题</h3>
<p>CMS 仍然是<strong>实验性功能</strong>，在某些情况下可能导致：</p>
<ul>
<li>运行时崩溃</li>
<li>吞吐量下降</li>
<li>内存占用增加</li>
</ul>
<p>如果遇到回归问题，可以手动切回 PMCS：</p>
<pre><code class="hljs language-properties" lang="properties"># gradle.properties
kotlin.native.useNativeCms=false
</code></pre>
<h2 data-id="heading-7">四、开发者的谨慎</h2>
<p>Kotlin 团队采取的是<strong>渐进式发布策略</strong>：</p>





















<table><thead><tr><th>版本</th><th>GC 模式</th></tr></thead><tbody><tr><td>2.3.20-Beta1/2</td><td>CMS（默认，收集反馈）</td></tr><tr><td>2.3.20-RC</td><td>回滚到 PMCS</td></tr><tr><td>2.3.20 正式版</td><td>待定</td></tr></tbody></table>
<p><strong>为什么这么做？</strong></p>
<p>官方说得很直白：</p>
<blockquote>
<p>需要收集更多反馈，确保发现所有问题。</p>
</blockquote>
<p>这是负责任的态度——先在 Beta 版让广大开发者帮忙"压力测试"，收集足够数据后再决定正式版是否默认启用。</p>
<h2 data-id="heading-8">五、其他更新亮点</h2>
<h3 data-id="heading-9">1. C/Obj-C 互操作新模式</h3>
<p>如果你在 Kotlin Multiplatform 中使用 C 或 Objective-C 库，可以尝试新的互操作模式：</p>
<pre><code class="hljs language-gradle" lang="gradle">kotlin {
    targets.withType&lt;org.jetbrains.kotlin.gradle.plugin.mpp.KotlinNativeTarget&gt;().configureEach {
        compilations.configureEach {
            cinterops.configureEach {
                extraOpts += listOf("-Xccall-mode", "direct")
            }
        }
    }
}
</code></pre>
<blockquote>
<p>注意：新模式仍是实验性，<strong>不要用此模式发布库</strong>。</p>
</blockquote>
<h3 data-id="heading-10">2. JPA 插件增强</h3>
<p><code>kotlin.plugin.jpa</code> 现在自动应用 <code>all-open</code> 插件的 JPA 预设：</p>
<pre><code class="hljs language-gradle" lang="gradle">plugins {
    kotlin("plugin.jpa") version "2.3.20-Beta2"
}
</code></pre>
<p>JPA 实体类自动变成 <code>open</code>，无需手动配置 <code>all-open</code>。</p>
<p>支持的注解：</p>
<ul>
<li><code>javax.persistence.Entity</code></li>
<li><code>javax.persistence.Embeddable</code></li>
<li><code>javax.persistence.MappedSuperclass</code></li>
<li><code>jakarta.persistence.Entity</code></li>
<li><code>jakarta.persistence.Embeddable</code></li>
<li><code>jakarta.persistence.MappedSuperclass</code></li>
</ul>
<h3 data-id="heading-11">3. Maven 配置简化</h3>
<p>新建 Kotlin Maven 项目时，不再需要手动：</p>
<ul>
<li>创建源码目录</li>
<li>添加 <code>kotlin-stdlib</code> 依赖</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sourceRootsAutoDetection</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">sourceRootsAutoDetection</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">4. Gradle 9.3.0 兼容</h3>
<p>支持 Gradle 7.6.3 到 9.3.0。</p>
<p>Kotlin/JVM 编译默认使用 Build tools API (BTA)。</p>
<h3 data-id="heading-13">5. 标准库新增 API</h3>
<p><code>Map.Entry.copy()</code> 扩展函数，用于创建 <code>Map.Entry</code> 的不可变副本：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalStdlibApi::class)</span>
<span class="hljs-keyword">val</span> mutableMap = mutableMapOf(<span class="hljs-string">"key"</span> to <span class="hljs-string">"value"</span>)
<span class="hljs-keyword">val</span> entry = mutableMap.entries.first()
<span class="hljs-keyword">val</span> copy = entry.copy() <span class="hljs-comment">// 创建不可变副本</span>
</code></pre>
<h2 data-id="heading-14">六、写到最后</h2>
<p>Kotlin 2.3 的 GC 改进，对 Kotlin/Native 生态——尤其是 Compose Multiplatform 开发者来说，是一个<strong>值得期待的进步</strong>。</p>
<p>虽然目前还是 Beta 实验，但：</p>
<ul>
<li>如果你开发 UI 应用</li>
<li>你在意用户体验</li>
<li>你受够了 GC 卡顿</li>
</ul>
<p><strong>不妨现在就试试 Beta 版，把你的反馈提交给官方。</strong></p>
<p>你的每一个问题报告，都是在帮 Kotlin 变得更好。</p>
<hr/>
<h2 data-id="heading-15">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fwhatsnew-eap.html" target="_blank" title="https://kotlinlang.org/docs/whatsnew-eap.html" ref="nofollow noopener noreferrer">Kotlin 2.3.20-Beta2 发布说明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fyoutrack.jetbrains.com%2Fissues%2FKT" target="_blank" title="https://youtrack.jetbrains.com/issues/KT" ref="nofollow noopener noreferrer">YouTrack 问题追踪</a></li>
</ul>
<p><strong>升级提醒</strong>：IDE 支持 Kotlin 2.3.20-Beta2 的插件已捆绑在最新版 IntelliJ IDEA 和 Android Studio 中，只需修改 <code>build.gradle.kts</code> 中的版本号即可。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当AI取代客服、设计师、程序员，我们还剩下什么？]]></title>    <link>https://juejin.cn/post/7600597995769348105</link>    <guid>https://juejin.cn/post/7600597995769348105</guid>    <pubDate>2026-01-30T01:26:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600597995769348105" data-draft-id="7600684978353012763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当AI取代客服、设计师、程序员，我们还剩下什么？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T01:26:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当AI取代客服、设计师、程序员，我们还剩下什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:26:03.000Z" title="Fri Jan 30 2026 01:26:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0"><strong>引言</strong></h2>
<p>人工智能（AI）的狂飙突进正深刻改变我们的工作方式：<br/>
AI客服能与百万用户同时对话，平面设计AI在几分钟内产出海报，代码生成模型甚至能自动构建应用。</p>
<p>这一切令人惊叹，却也让人不安。<br/>
当AI逐步取代客服、设计师、程序员等曾被认为“创造性强”或“技术门槛高”的岗位，人类在生产体系中还剩下什么？<br/>
本文将从<strong>技术原理、替代机制与未来趋势</strong>三个角度剖析这一问题，并探讨人类在AI主导时代中的新定位。</p>
<hr/>
<h2 data-id="heading-1"><strong>一、背景：AI的“技能渗透”现象</strong></h2>
<p>过去十年，AI从感知智能（识图、识音）发展到生成智能（文本、图像、代码），核心驱动力在于 <strong>Transformer架构与大模型（LLM）技术的演进</strong>。</p>

























<table><thead><tr><th>领域</th><th>曾被认为“人类专属”的任务</th><th>当前AI能力体现</th></tr></thead><tbody><tr><td>客服</td><td>情绪识别、语言应答、复杂查询</td><td>Chatbot + 情感分析模型</td></tr><tr><td>设计</td><td>概念创意、配色、空间构图</td><td>文生图模型（如Stable Diffusion、DALL·E）</td></tr><tr><td>程序开发</td><td>程序逻辑设计、调试、算法落地</td><td>AI编程助手（如GitHub Copilot、Code Llama）</td></tr></tbody></table>
<p>这意味着AI已经从“自动化重复劳动”迈向“认知性劳动”替代阶段。</p>
<hr/>
<h2 data-id="heading-2"><strong>二、技术逻辑：AI如何“取代人类工作”</strong></h2>
<h3 data-id="heading-3"><strong>1. 客服领域：语言模型 + 知识检索</strong></h3>
<p>AI客服的核心技术包括两部分：</p>
<ul>
<li><strong>自然语言理解（NLU）</strong> ：负责理解用户意图；</li>
<li><strong>知识增强生成（RAG）</strong> ：让语言模型接入实时知识库回答复杂问题。</li>
</ul>
<p><strong>示例：Python实现一个极简AI客服系统</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> pipeline

qa = pipeline(<span class="hljs-string">"question-answering"</span>, model=<span class="hljs-string">"deepset/roberta-base-squad2"</span>)

context = <span class="hljs-string">"""
公司提供AI SaaS服务，包括文本生成、语音识别和知识图谱分析。
客服支持时间为周一至周五9:00-18:00。
"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">ai_customer_service</span>(<span class="hljs-params">question</span>):
    result = qa(question=question, context=context)
    <span class="hljs-keyword">return</span> result[<span class="hljs-string">"answer"</span>]

<span class="hljs-built_in">print</span>(ai_customer_service(<span class="hljs-string">"你们的客服什么时候上线？"</span>))
</code></pre>
<p>🔹 技术要点：<br/>
这种AI客服基于<strong>语义匹配与上下文理解</strong>，能够自动回答FAQ、引导用户操作，甚至进行表情与情感识别。</p>
<hr/>
<h3 data-id="heading-4"><strong>2. 设计领域：Diffusion模型 + Prompt工程</strong></h3>
<p>AI设计核心逻辑是 <strong>从文本生成视觉表达</strong>。<br/>
其技术基石是 <strong>扩散模型（Diffusion Model）</strong> ，通过逐步反噪还原高维视觉信息。</p>
<p>生成流程如下：</p>
<ol>
<li>输入文本提示词（Prompt）</li>
<li>语言模型解析语义 → 形成视觉特征向量</li>
<li>扩散模型生成对应图像</li>
</ol>
<p><strong>伪代码展示流程：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> torch
from diffusers <span class="hljs-keyword">import</span> StableDiffusionPipeline

pipe = StableDiffusionPipeline.<span class="hljs-built_in">from_pretrained</span>(<span class="hljs-string">"CompVis/stable-diffusion-v1-4"</span>)
pipe.<span class="hljs-built_in">to</span>(<span class="hljs-string">"cuda"</span>)

prompt = <span class="hljs-string">"A futuristic workspace with robots and humans collaborating, cyberpunk style"</span>
image = <span class="hljs-built_in">pipe</span>(prompt, guidance_scale=<span class="hljs-number">7.5</span>).images[<span class="hljs-number">0</span>]
image.<span class="hljs-built_in">save</span>(<span class="hljs-string">"future_workspace.png"</span>)
</code></pre>
<p>🔹 当前AI设计已可实现：</p>
<ul>
<li>LOGO生成、广告视觉构图；</li>
<li>工业设计草图草拟；</li>
<li>UI自动化设计（通过文本描述生成交互界面）。</li>
</ul>
<hr/>
<h3 data-id="heading-5"><strong>3. 编程领域：语言模型 + 语义执行</strong></h3>
<p>AI编程助手的典型工作流程如下：</p>
<ol>
<li>用户输入需求（自然语言）；</li>
<li>模型分析语义 → 生成代码；</li>
<li>工具化环境自动执行与调试；</li>
<li>模型根据执行反馈自我修正。</li>
</ol>
<p><strong>示例：自动生成一个计算平均成绩的Python脚本</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_prompt</span> = <span class="hljs-string">"写一个Python脚本，读取学生成绩，并计算平均分"</span>

<span class="hljs-comment"># AI模型推理结果（简化示例）</span>
<span class="hljs-attr">generated_code</span> = <span class="hljs-string">"""
scores = [89, 92, 76, 84]
avg = sum(scores) / len(scores)
print(f"Average score: {avg}")
"""</span>
exec(generated_code)
</code></pre>
<p>🔹 实际上，AI编程模型（如GPT-4/CodeLlama）不仅能写代码，还能进行：</p>
<ul>
<li>Debug与代码审查；</li>
<li>单元测试生成；</li>
<li>系统架构推理（结合自然语言设计大型系统）。</li>
</ul>
<hr/>
<h2 data-id="heading-6"><strong>三、AI“取代”的底层逻辑</strong></h2>
<p>AI并非“理解”世界，而是在<strong>统计意义上接近人类认知过程的预测系统</strong>。<br/>
它能：</p>
<ul>
<li>模拟语言（通过上下文预测单词）；</li>
<li>模拟设计（通过学习视觉分布）；</li>
<li>模拟编程（通过语义到逻辑的映射）。</li>
</ul>
<p>这使它能快速复制人类劳动的“结果形态”，但其创造动机与伦理判断仍然缺位。</p>
<hr/>
<h2 data-id="heading-7"><strong>四、AI替代的优缺点与人类再定位</strong></h2>






























<table><thead><tr><th>维度</th><th>AI的优势</th><th>AI的局限</th></tr></thead><tbody><tr><td>效率</td><td>可同时服务百万用户</td><td>缺乏真正的情感理解</td></tr><tr><td>创造力</td><td>快速生成多样方案</td><td>缺乏文化与上下文美学</td></tr><tr><td>成本</td><td>极低的人力与时间成本</td><td>技术维护与偏差风险高</td></tr><tr><td>责任归属</td><td>可自动执行任务</td><td>决策透明性不足</td></tr></tbody></table>
<h3 data-id="heading-8"><strong>实践建议</strong></h3>
<ol>
<li>
<p><strong>人机协同，而非对抗</strong><br/>
未来的核心竞争力不是“抗AI”，而是“用AI”：</p>
<ul>
<li>客服 → 客户体验管理师</li>
<li>设计师 → Prompt艺术家</li>
<li>程序员 → AI系统工程师</li>
</ul>
</li>
<li>
<p><strong>强化人类软技能（Meta Skill）</strong><br/>
包括系统思维、跨领域整合与价值判断，这些仍是AI无法直接学习的认知层。</p>
</li>
<li>
<p><strong>建立AI伦理与验证机制</strong><br/>
为AI产出建立可溯源的审核与安全标准。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-9"><strong>五、结论：人类的地位将重回“意义制造者”</strong></h2>
<p>AI正在重塑“劳动”的定义。<br/>
未来十年，AI不是仅仅“取代岗位”，而是将 <strong>人从执行者转变为设计者、监督者与意义创造者</strong>。</p>
<blockquote>
<p>“当AI取代我们的技能，我们需要培养的不是新的技能，而是新的认知层次。”</p>
</blockquote>
<p>在AI生产力浪潮中，人类真正不可替代的，将是：</p>
<ul>
<li>对价值的理解；</li>
<li>对社会伦理的把握；</li>
<li>对未知世界的想象力。</li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>参考资料</strong></h2>
<ol>
<li>Vaswani et al., <em>“Attention is All You Need”</em> , NeurIPS, 2017.</li>
<li>OpenAI, <em>ChatGPT Technical Report</em>, 2023.</li>
<li>Stability AI, <em>Stable Diffusion Model Card</em>, 2022.</li>
<li>DeepMind, <em>AlphaCode: Generating Code with LLMs</em>, 2022.</li>
<li>哈弗商业评论，《AI不是威胁，而是人类能力的倍增器》，2024年。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Prompt艺术家（Prompt Engineer / Prompt Artist）]]></title>    <link>https://juejin.cn/post/7600675515150385179</link>    <guid>https://juejin.cn/post/7600675515150385179</guid>    <pubDate>2026-01-30T01:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600675515150385179" data-draft-id="7600597995769380873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Prompt艺术家（Prompt Engineer / Prompt Artist）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T01:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Prompt艺术家（Prompt Engineer / Prompt Artist）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:29:27.000Z" title="Fri Jan 30 2026 01:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>通过语言、结构与思维技巧，<strong>引导人工智能生成理想化的创作输出</strong> —— 就像导演指导演员、作曲家操控乐器，只不过他们的“画笔”是指令文字。</p>
</blockquote>
<p>下面我们从技术、技能、流程和未来发展四个维度，系统拆解这个职业。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、什么是Prompt艺术家？</strong></h2>
<h3 data-id="heading-1">✅ <strong>定义</strong></h3>
<p><strong>Prompt艺术家</strong>是指能够设计、编排和优化文本提示（Prompt），以高效地让生成式AI（如GPT、Midjourney、DALL·E、Stable Diffusion）产生符合特定需求内容的专业人士。</p>
<p>他们的工作不在于手动创造图像、文案或代码，而在于：</p>
<ul>
<li><strong>定义意图（Intention）</strong></li>
<li><strong>描述约束（Constraint）</strong></li>
<li><strong>控制风格（Style）</strong></li>
<li><strong>引导AI输出所需的创意结果（Guidance）</strong></li>
</ul>
<p>简单来说：</p>
<blockquote>
<p>Prompt艺术家是“对AI说话的艺术家”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2"><strong>二、工作内容与职责</strong></h2>



































<table><thead><tr><th>工作内容</th><th>说明</th><th>典型工具</th></tr></thead><tbody><tr><td><strong>1. 需求理解与语义分解</strong></td><td>把客户或团队的模糊需求转化为可在Prompt中描述的参数（风格、场景、光影、语气等）。</td><td>ChatGPT、Claude、Midjourney</td></tr><tr><td><strong>2. Prompt编写与优化</strong></td><td>编写结构化Prompt，对AI输出结果进行多轮调试与Re-Prompt。</td><td>LangChain、PromptLayer、FlowGPT</td></tr><tr><td><strong>3. Prompt模板化与复用</strong></td><td>设计可重复的模板（如品牌视觉风格、岗位招聘Prompt库）。</td><td>Notion / Airtable / JSON脚本</td></tr><tr><td><strong>4. 数据反馈与风格一致性调优</strong></td><td>分析AI生成内容表现，持续改进Prompt逻辑，形成“风格资产”。</td><td>TensorBoard、Embedding分析工具</td></tr><tr><td><strong>5. 教育与标准化</strong></td><td>指导公司或创意团队培训AI使用标准，撰写Prompt指南或规则库。</td><td>文档系统、教学视频</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3"><strong>三、技术原理：为什么Prompt能控制AI？</strong></h2>
<p>Prompt工程背后的本质是 <strong>“条件概率调控”</strong> 。<br/>
对大语言模型（LLM）而言，Prompt并非命令，而是<strong>语义条件约束</strong>，AI通过概率分布预测下一个最可能的token。</p>
<p>例如，输入：</p>
<blockquote>
<p>“写一篇具有村上春树风格的夜晚咖啡馆故事。”</p>
</blockquote>
<p>AI会自动在训练语料中调用“村上春树 + 夜晚 + 都市 + 内心独白”相关的语言模式，从而生成相符的文本。</p>
<p><strong>对图像生成模型而言：</strong></p>
<p>Prompt 相当于 “高维语义编码器的可控输入”。<br/>
在 Stable Diffusion 模型中，Prompt通过 CLIP 模块转化为特征向量，引导扩散解码器生成特定风格图像。</p>
<pre><code class="hljs language-css" lang="css">Prompt → <span class="hljs-attribute">CLIP</span>文本编码器 → 语义向量 → 噪声反向扩散 → 图像输出
</code></pre>
<p>这就是为什么不同词序、句式、权重符号（如 <code>::</code>、<code>--ar</code>, <code>--v</code>）都会显著改变生成效果。</p>
<hr/>
<h2 data-id="heading-4"><strong>四、技能要求：成为Prompt艺术家需要什么能力？</strong></h2>





























<table><thead><tr><th>能力领域</th><th>关键技能</th></tr></thead><tbody><tr><td><strong>语言理解与逻辑表达</strong></td><td>能够清晰定义意图、风格、语气及约束条件。</td></tr><tr><td><strong>美学与创意感知</strong></td><td>对画面、配色、节奏、叙事有独特判断。</td></tr><tr><td><strong>AI模型机制理解</strong></td><td>理解文本到图像/语音/代码生成的底层逻辑。</td></tr><tr><td><strong>批判性思维与实验精神</strong></td><td>善于A/B测试Prompt差异、分析结果。</td></tr><tr><td><strong>多模态跨界能力</strong></td><td>能结合文字+图像+音频Prompt进行联合生成（如视频创意脚本）。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5"><strong>五、Prompt编写的实际案例</strong></h2>
<h3 data-id="heading-6"><strong>案例1：AI绘画</strong></h3>
<p><strong>目标：</strong><br/>
让AI生成一张“未来城市中孤独少年的科幻插画”。</p>
<p><strong>Prompt示例（英文版，适合Midjourney）：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">a lone teenager standing <span class="hljs-keyword">on</span> a futuristic skyscraper rooftop at night, neon lights reflecting <span class="hljs-keyword">on</span> glass, cyberpunk style, atmospheric lighting, cinematic mood, highly detailed, <span class="hljs-number">8</span>K, <span class="hljs-keyword">by</span> syd mead
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>a lone teenager...</code> → 主体定义</li>
<li><code>cyberpunk style</code> → 风格约束</li>
<li><code>by syd mead</code> → 模仿艺术家风格</li>
<li><code>8K, highly detailed</code> → 输出质量</li>
</ul>
<p>一位专业Prompt艺术家会通过反复调整这些描述，控制光影结构、情绪张力或画面构图。</p>
<hr/>
<h3 data-id="heading-7"><strong>案例2：AI文案</strong></h3>
<p><strong>目标：</strong><br/>
为一款智能家居灯具撰写广告语。</p>
<p><strong>Prompt示例：</strong></p>
<blockquote>
<p>"请以苹果公司广告的极简风格，撰写10条关于智能照明灯具的中文宣传语，每条不超过12字，情感基调温暖、科技感强。"</p>
</blockquote>
<p>输出示例：</p>
<ul>
<li>“光懂你心意。”</li>
<li>“让夜有温度。”</li>
<li>“点亮的不止空间。”</li>
</ul>
<p>Prompt艺术家的任务不仅仅是写Prompt，还包括评估输出中是否符合品牌语调，并持续微调。</p>
<hr/>
<h3 data-id="heading-8"><strong>案例3：AI编程辅助</strong></h3>
<p><strong>目标：</strong><br/>
让AI根据业务逻辑自动生成API接口文档。</p>
<p><strong>Prompt示例：</strong></p>
<blockquote>
<p>“根据以下函数定义，生成一份Swagger风格的API文档，包括参数解释、返回值示例和错误码说明。”</p>
</blockquote>
<p>Prompt艺术家在此既要掌握技术语言，也要知道如何控制输出格式与结构化内容。</p>
<hr/>
<h2 data-id="heading-9"><strong>六、职业价值与发展方向</strong></h2>

























<table><thead><tr><th>方向</th><th>描述</th></tr></thead><tbody><tr><td><strong>Prompt设计顾问（Prompt Consultant）</strong></td><td>为企业AI应用场景定制Prompt模板与自动化指令系统。</td></tr><tr><td><strong>AI内容创意导演（AI Creative Director）</strong></td><td>统筹AI生成视觉、文案、视频等跨媒体创意项目。</td></tr><tr><td><strong>Prompt系统工程师（Prompt System Engineer）</strong></td><td>用语言 + 程序构建动态Prompt（如在LangChain中编排多AI模块）。</td></tr><tr><td><strong>数据与风格归档师（AI Styling Curator）</strong></td><td>对Prompt版本进行管理，沉淀企业AI风格资产。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10"><strong>七、AI支持下的Prompt工作流示意</strong></h2>
<pre><code class="hljs">需求输入 → 意图分解 → Prompt编写与测试
   ↓
AI生成内容 → 输出评估 → Prompt改进与优化
   ↓
最终交付 / 模板沉淀 / 知识复用
</code></pre>
<hr/>
<h2 data-id="heading-11"><strong>八、未来展望</strong></h2>
<p>随着多模态AI（如GPT-5、Gemini、Sora）的发展，<br/>
Prompt艺术家的工作将从“写指令”上升到“设计语义结构”，即：</p>
<ul>
<li>不再仅局限于命令，而是<strong>语言 + 上下文 + 知识结构的整体编排</strong>；</li>
<li>AI会逐渐理解“Prompt意图”，Prompt艺术家则成为“AI思维设计师（Cognitive Designer）”。</li>
</ul>
<p>未来，这个职位可能演化为：</p>
<blockquote>
<ul>
<li>人类与AI之间的“语义翻译官”；</li>
<li>数字创作流程中的“导演级思维设计者”。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-12"><strong>参考资料</strong></h2>
<ol>
<li>OpenAI，《Prompt Engineering Guide》，2024</li>
<li>Anthropic，《Effective Prompting for Claude》，2025</li>
<li>Stability AI，《Prompt Design in Diffusion Models》，2023</li>
<li>LangChain 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2F" target="_blank" title="https://python.langchain.com/" ref="nofollow noopener noreferrer">python.langchain.com/</a></li>
<li>Simon Willison，《The emerging profession of Prompt Engineering》，2024</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring依赖注入神器：ObjectProvider深度解析]]></title>    <link>https://juejin.cn/post/7600606150732382251</link>    <guid>https://juejin.cn/post/7600606150732382251</guid>    <pubDate>2026-01-29T11:12:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600606150732382251" data-draft-id="7600562816458883114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring依赖注入神器：ObjectProvider深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T11:12:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ffmenw"/> <meta itemprop="url" content="https://juejin.cn/user/2738248275727619"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring依赖注入神器：ObjectProvider深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2738248275727619/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ffmenw
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:12:18.000Z" title="Thu Jan 29 2026 11:12:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring生态中，依赖注入（DI）是核心特性之一，但传统依赖注入的“刚性问题”（Bean不存在必报错、多实例冲突、启动加载冗余），曾是开发者频繁踩坑的痛点。Spring 4.3版本引入的<code>ObjectProvider</code>，作为<code>ObjectFactory</code>的增强子接口，专为解决这些痛点而生，成为Spring容器中Bean延迟查找、柔性依赖注入的核心工具，广泛应用于Spring Boot、Spring Cloud等主流开发场景。</p>
<p>本文将从核心定位、设计初衷、核心特性、API详解、实战场景、对比区别、注意事项7个维度，深度拆解<code>ObjectProvider</code>，帮你彻底掌握其原理与实战技巧，规避使用误区。</p>
<h2 data-id="heading-0">一、核心定位与设计初衷</h2>
<h3 data-id="heading-1">1. 核心定位：Spring容器的“柔性Bean查找器”</h3>
<p><code>ObjectProvider</code>隶属于<code>org.springframework.beans.factory</code>包，是<code>ObjectFactory</code>的子接口并做了功能增强。其核心定位是「Bean查找代理」——注入到目标类中的并非实际Bean实例，而是<code>ObjectProvider</code>代理对象；目标类可在<strong>需要时</strong>通过该代理获取Bean，实现“按需加载”，同时具备丰富的容错、批量处理能力，打破了传统依赖注入的刚性限制。</p>
<h3 data-id="heading-2">2. 设计初衷：解决传统@Autowired的3大痛点</h3>
<p>传统<code>@Autowired</code>依赖注入虽便捷，但存在3个难以规避的刚性问题，<code>ObjectProvider</code>的设计初衷就是精准破解这些痛点：</p>
<ul>
<li>
<p><strong>即时注入冗余</strong>：容器启动时即解析所有依赖并初始化Bean，若Bean初始化成本高（如加载大文件、连接第三方数据源）且非启动必需，会严重拖慢容器启动速度；</p>
</li>
<li>
<p><strong>强依赖必报错</strong>：默认情况下，被注入的Bean不存在则直接抛出<code>NoSuchBeanDefinitionException</code>，无法实现“可选依赖”（Bean不存在时不影响程序运行）；</p>
</li>
<li>
<p><strong>多实例冲突</strong>：当存在多个同类型Bean时，未指定<code>@Qualifier</code>则抛出<code>NoUniqueBeanDefinitionException</code>，无原生批量处理能力，需手动编写大量判空、筛选逻辑。</p>
</li>
</ul>
<h2 data-id="heading-3">二、核心特性：柔性+延迟，碾压传统注入/ObjectFactory</h2>
<p><code>ObjectProvider</code>的核心价值的在于「柔性依赖」和「延迟加载」，相比传统<code>@Autowired</code>和父接口<code>ObjectFactory</code>，其优势更突出，核心特性可概括为4点：</p>
<h3 data-id="heading-4">1. 延迟查找与延迟注入（核心特性）</h3>
<p>这是<code>ObjectProvider</code>最核心的能力，也是区别于传统<code>@Autowired</code>的关键：</p>
<ul>
<li>
<p>传统<code>@Autowired</code>：容器启动阶段完成Bean实例化和依赖注入，属于「即时注入」，无论Bean是否被使用，都会提前初始化；</p>
</li>
<li>
<p><code>ObjectProvider</code>：注入的是<code>ObjectProvider</code>代理对象，实际Bean的获取延迟到调用<code>getObject()</code>、<code>getIfAvailable()</code>等方法时，真正实现“按需加载”，大幅降低容器启动时的依赖解析压力。</p>
</li>
</ul>
<h3 data-id="heading-5">2. 非唯一Bean的优雅处理</h3>
<p>针对“多个同类型Bean存在”的场景，<code>ObjectProvider</code>无需额外配置<code>@Qualifier</code>，提供「有序获取、批量流式处理」能力，避免直接抛出冲突异常：</p>
<p>支持通过<code>stream()</code>获取所有同类型Bean的流式实例，通过<code>orderedStream()</code>按优先级（<code>@Order</code>注解/<code>Ordered</code>接口）获取，可直接结合Lambda表达式完成筛选、遍历，代码更简洁优雅。</p>
<h3 data-id="heading-6">3. 不存在Bean的容错处理（柔性依赖核心）</h3>
<p>提供非侵入式的可选依赖支持，彻底替代传统<code>@Autowired(required = false)</code>的繁琐判空逻辑：</p>
<p>通过<code>getIfAvailable()</code>、<code>getIfUnique()</code>等专属方法，实现“Bean存在则获取，不存在则返回null/默认值”，无需手动检查Bean是否为<code>null</code>，大幅简化代码。</p>
<h3 data-id="heading-7">4. JDK8+流式API原生支持</h3>
<p>适配JDK8及以上的流式编程风格，原生提供<code>stream()</code>/<code>orderedStream()</code>方法，直接返回<code>Stream&lt;T&gt;</code>，可结合Lambda表达式对多实例Bean进行高效批量处理（过滤、映射、遍历等），符合现代Java编程习惯，大幅提升开发效率。</p>
<h2 data-id="heading-8">三、核心API方法详解（Spring 5.x+全量支持）</h2>
<p><code>ObjectProvider</code>继承了<code>ObjectFactory</code>的唯一方法<code>getObject()</code>，并扩展了一系列实用方法，按功能可分为4大类，重点掌握“容错获取”和“批量获取”方法，避免滥用无容错能力的基础方法。</p>
<h3 data-id="heading-9">1. 基础获取（继承自ObjectFactory，慎用）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">T <span class="hljs-title">getObject</span>() throws BeansException</span>;
</code></pre>
<ul>
<li>
<p>功能：获取唯一的Bean实例，<strong>无任何容错能力</strong>；</p>
</li>
<li>
<p>异常场景：Bean不存在、存在多个同类型Bean时，直接抛出传统Spring异常（与<code>ObjectFactory</code>行为完全一致）；</p>
</li>
<li>
<p>适用场景：明确Bean唯一且必存在，仅需要延迟加载时使用（不推荐，优先用容错方法）。</p>
</li>
</ul>
<h3 data-id="heading-10">2. 容错获取（核心推荐，实现可选依赖）</h3>
<p>这类方法是<code>ObjectProvider</code>的核心价值所在，彻底解决“Bean不存在必报错”的问题，推荐日常开发优先使用：</p>
<p>（1）<code>T getIfAvailable() throws BeansException;</code></p>
<ul>
<li>
<p>核心功能：Bean存在则返回实例，不存在则返回<code>null</code>，<strong>无异常抛出</strong>；</p>
</li>
<li>
<p>价值：替代<code>@Autowired(required = false)</code>，无需手动判空，实现优雅的可选依赖。</p>
</li>
</ul>
<p>（2）<code>T getIfAvailable(Supplier&lt;T&gt; defaultSupplier) throws BeansException;</code></p>
<ul>
<li>核心功能：Bean存在则返回实例，<strong><code>Supplier</code></strong> <strong>不存在则执行获取默认值</strong>；</li>
</ul>
<p>（3）<code>T getIfUnique() throws BeansException;</code></p>
<ul>
<li>核心功能：<strong><code>null</code></strong> <strong>仅当存在唯一的同类型Bean时返回实例，否则返回</strong>（0个或多个同类型Bean均返回<code>null</code>）；</li>
</ul>
<p>（4）<code>T getOrDefault(T defaultInstance) throws BeansException;</code></p>
<ul>
<li>
<p>核心功能：Bean存在则返回实例，不存在则返回指定的默认实例；</p>
</li>
<li>
<p>与<code>getIfAvailable(Supplier)</code>区别：直接传入默认实例（即时创建），而非延迟创建的<code>Supplier</code>（按需创建），根据默认实例的创建成本选择使用。</p>
</li>
</ul>
<h3 data-id="heading-11">3. 有序/批量获取（处理多同类型Bean）</h3>
<p>针对多同类型Bean场景，提供批量获取能力，支持有序排列，无需手动筛选：</p>
<p>（1）<code>Stream&lt;T&gt; stream() throws BeansException;</code></p>
<ul>
<li>
<p>功能：返回所有同类型Bean的流式实例，<strong>无顺序保证</strong>（按容器注册顺序返回）；</p>
</li>
<li>
<p>适用场景：批量处理所有同类型Bean，无需区分优先级（如批量执行所有处理器）。</p>
</li>
</ul>
<p>（2）<code>Stream&lt;T&gt; orderedStream() throws BeansException;</code></p>
<ul>
<li>
<p>功能：返回按优先级排序后的同类型Bean流式实例；</p>
</li>
<li>
<p>排序规则：遵循Spring的有序机制，优先按<code>@Order</code>注解值（值越小优先级越高），其次按<code>Ordered</code>接口的<code>getOrder()</code>方法返回值；</p>
</li>
<li>
<p>适用场景：需要按优先级执行多实例Bean的场景（如拦截器、处理器链）。</p>
</li>
</ul>
<h3 data-id="heading-12">4. 带参数创建（动态传参实例化Bean）</h3>
<pre><code class="hljs language-java" lang="java">T <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object... args)</span> <span class="hljs-keyword">throws</span> BeansException;
</code></pre>
<ul>
<li>
<p>核心功能：获取Bean时，<strong>动态传入构造器/工厂方法参数</strong>，实现Bean的动态实例化；</p>
</li>
<li>
<p>适用场景：Bean的创建需要运行时动态参数（如根据用户请求参数创建实例），传统注入无法支持此场景（传统注入仅支持容器启动时的固定参数）。</p>
</li>
</ul>
<h2 data-id="heading-13">四、典型实战场景（附优化后代码示例）</h2>
<p><code>ObjectProvider</code>的使用需结合Spring依赖注入（推荐构造器注入，符合Spring最佳实践），注入后按需调用对应方法。以下是4个最常用、最高频的实战场景，代码示例简洁可直接套用。</p>
<h3 data-id="heading-14">场景1：可选依赖注入（替代@Autowired(required = false)）</h3>
<p>需求：某个服务依赖的配置类/处理器为可选，存在则使用，不存在则执行默认逻辑，无需手动判空。</p>
<pre><code class="hljs language-csharp" lang="csharp">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> {
    <span class="hljs-comment">// 注入ObjectProvider，目标Bean为OptionalHandler（可选）</span>
    <span class="hljs-keyword">private</span> final ObjectProvider&lt;OptionalHandler&gt; optionalHandlerProvider;

    <span class="hljs-comment">// 推荐构造器注入（保证对象不可变，符合Spring最佳实践）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserService</span>(<span class="hljs-params">ObjectProvider&lt;OptionalHandler&gt; optionalHandlerProvider</span>)</span> {
        <span class="hljs-keyword">this</span>.optionalHandlerProvider = optionalHandlerProvider;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doHandle</span>()</span> {
        <span class="hljs-comment">// 场景1：存在则使用，不存在则执行默认逻辑（无需判空）</span>
        optionalHandlerProvider.ifAvailable(OptionalHandler::handle, 
            () -&gt; System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"可选处理器不存在，执行默认逻辑"</span>));

        <span class="hljs-comment">// 进阶：不存在则使用默认实现（Lambda提供默认Bean）</span>
        OptionalHandler defaultHandler = optionalHandlerProvider.getIfAvailable(DefaultOptionalHandler::<span class="hljs-keyword">new</span>);
        defaultHandler.handle();
    }
}

<span class="hljs-comment">// 可选处理器（可不存在）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">OptionalHandler</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">handle</span>()</span>;
}

<span class="hljs-comment">// 默认实现类（Bean不存在时使用）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DefaultOptionalHandler</span> <span class="hljs-title">implements</span> <span class="hljs-title">OptionalHandler</span> {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handle</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认处理器执行逻辑"</span>);
    }
}
</code></pre>
<h3 data-id="heading-15">场景2：多同类型Bean批量处理（按优先级执行）</h3>
<p>需求：存在多个<code>Handler</code>接口实现类，需按优先级批量执行所有处理器，无需手动筛选排序。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 处理器接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Handler</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 实现类1：优先级1（值越小优先级越高）</span>
<span class="hljs-meta">@Order(1)</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FirstHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Handler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"优先级1：FirstHandler 执行"</span>);
    }
}

<span class="hljs-comment">// 实现类2：优先级2</span>
<span class="hljs-meta">@Order(2)</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Handler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"优先级2：SecondHandler 执行"</span>);
    }
}

<span class="hljs-comment">// 业务服务：批量执行所有处理器（按优先级）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectProvider&lt;Handler&gt; handlerProvider;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HandlerService</span><span class="hljs-params">(ObjectProvider&lt;Handler&gt; handlerProvider)</span> {
        <span class="hljs-built_in">this</span>.handlerProvider = handlerProvider;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeAll</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 按@Order排序后，批量执行所有处理器（核心代码，简洁高效）</span>
        handlerProvider.orderedStream().forEach(Handler::execute);
    }
}
</code></pre>
<h3 data-id="heading-16">场景3：延迟加载Bean（减少容器启动耗时）</h3>
<p>需求：某个Bean（如大数据初始化的<code>DataLoader</code>）初始化成本高，且非容器启动必需，仅在首次调用数据查询时才初始化。</p>
<pre><code class="hljs language-csharp" lang="csharp">​<span class="hljs-comment">// 初始化成本高的Bean（如加载大文件、连接第三方数据源）</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataLoader</span> {
    <span class="hljs-comment">// 模拟高成本初始化逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataLoader</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"DataLoader 延迟初始化（仅首次调用时执行）..."</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loadData</span>()</span> {
        <span class="hljs-comment">// 数据加载核心逻辑</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"数据加载完成"</span>);
    }
}

<span class="hljs-comment">// 业务服务：仅在查询数据时初始化DataLoader</span>
@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataQueryService</span> {
    <span class="hljs-keyword">private</span> final ObjectProvider&lt;DataLoader&gt; dataLoaderProvider;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataQueryService</span>(<span class="hljs-params">ObjectProvider&lt;DataLoader&gt; dataLoaderProvider</span>)</span> {
        <span class="hljs-keyword">this</span>.dataLoaderProvider = dataLoaderProvider;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">queryData</span>(<span class="hljs-params">String id</span>)</span> {
        <span class="hljs-comment">// 首次调用时初始化DataLoader，后续调用复用单例实例（遵循Bean作用域）</span>
        DataLoader dataLoader = dataLoaderProvider.getObject();
        dataLoader.loadData();
        <span class="hljs-comment">// 后续查询逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果："</span> + id;
    }
}
</code></pre>
<h3 data-id="heading-17">场景4：动态传参创建Bean（运行时参数注入）</h3>
<p>需求：Bean的创建需要运行时动态参数（如根据用户请求参数创建实例），传统注入无法支持，需通过<code>ObjectProvider</code>动态传参。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 需动态传参的Bean（无需@Component注解，由容器动态创建）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicBean</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> runtimeParam;

    <span class="hljs-comment">// 构造器需要运行时动态参数</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DynamicBean</span><span class="hljs-params">(<span class="hljs-type">String</span> runtimeParam)</span> </span>{
        <span class="hljs-keyword">this</span>.runtimeParam = runtimeParam;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"运行时动态参数："</span> + runtimeParam);
    }
}

<span class="hljs-comment">// 业务服务：动态传参创建Bean</span>
@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectProvider&lt;DynamicBean&gt; dynamicBeanProvider;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DynamicService</span><span class="hljs-params">(ObjectProvider&lt;DynamicBean&gt; dynamicBeanProvider)</span> </span>{
        <span class="hljs-keyword">this</span>.dynamicBeanProvider = dynamicBeanProvider;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-type">String</span> userParam)</span> </span>{
        <span class="hljs-comment">// 运行时传入参数，动态创建Bean实例（每次传参可创建不同实例，遵循原型作用域）</span>
        DynamicBean dynamicBean = dynamicBeanProvider.<span class="hljs-built_in">getObject</span>(userParam);
        dynamicBean.<span class="hljs-built_in">doSomething</span>();
    }
}
</code></pre>
<h2 data-id="heading-18">五、与ObjectFactory的核心对比（官方推荐优先用ObjectProvider）</h2>
<p><code>ObjectProvider</code>是<code>ObjectFactory</code>的子接口和增强版，Spring官方明确推荐优先使用<code>ObjectProvider</code>替代<code>ObjectFactory</code>，二者的核心差异体现在多个维度：</p>
<ol>
<li>
<p>继承关系：<code>ObjectFactory</code>是基础工厂接口，无父接口；<code>ObjectProvider</code>作为其子接口，继承了<code>ObjectFactory</code>并完整保留了其基础能力。</p>
</li>
<li>
<p>API丰富度：<code>ObjectFactory</code>仅提供1个方法<code>getObject()</code>，功能单一；<code>ObjectProvider</code>拥有丰富的方法体系，包含容错、批量、流式等类型，可覆盖多种开发场景。</p>
</li>
<li>
<p>容错能力：<code>ObjectFactory</code>无容错设计，当目标Bean不存在或存在多实例时会直接报错；<code>ObjectProvider</code>的容错能力<strong>强，支持getIfAvailable/getIfUnique等容错方法（核心优势）</strong>，可妥善处理Bean不存在、多实例等异常场景。</p>
</li>
<li>
<p>流式支持：<code>ObjectFactory</code>无流式处理能力，无法对多实例Bean进行批量处理；<code>ObjectProvider</code><strong>原生支持stream/orderedStream，适配流式编程</strong>，便捷实现多实例的流式处理。</p>
</li>
<li>
<p>多实例处理：<code>ObjectFactory</code>仅能获取单个Bean实例，遇到多实例场景会直接报错，无对应处理能力；<code>ObjectProvider</code><strong>支持批量、有序获取多实例，无需额外配置</strong>，可高效处理多实例Bean场景。</p>
</li>
<li>
<p>延迟加载：二者均支持该能力，这是<code>ObjectFactory</code>的核心能力，仅能实现基础的Bean延迟获取；<code>ObjectProvider</code>在继承该能力的基础上做了增强，结合自身的容错、批量等特性，让延迟加载的实际业务价值更大。</p>
</li>
<li>
<p>使用场景：<code>ObjectFactory</code>仅适用于简单的Bean延迟创建场景，且场景中无容错、多实例的相关需求；<code>ObjectProvider</code>的适用场景更广泛，可满足<strong>可选依赖、多实例批量处理、高成本Bean延迟加载、动态传参（主流场景）等</strong>开发需求。</p>
</li>
</ol>
<p>核心结论：<code>ObjectFactory</code>是Spring的基础工厂接口，仅提供最基础的Bean延迟创建能力；<code>ObjectProvider</code>在继承其基础能力的前提下，补充了「容错、批量、流式」等核心功能，更适配现代Spring开发的复杂场景，是Spring中处理Bean依赖的首选工具。</p>
<h2 data-id="heading-19">六、关键注意事项（规避90%的使用误区）</h2>
<p>掌握<code>ObjectProvider</code>的同时，需规避以下5个高频误区，避免踩坑：</p>
<h3 data-id="heading-20">1. 版本依赖：仅Spring 4.3及以上支持</h3>
<p>若项目基于Spring 4.3以下版本（如Spring 4.2及更低），无<code>ObjectProvider</code>接口，需使用<code>ObjectFactory</code>结合手动判空，实现类似可选依赖、延迟加载功能。</p>
<h3 data-id="heading-21">2. 注入方式：优先选择构造器注入</h3>
<p><code>ObjectProvider</code>支持<code>@Autowired</code>字段注入、构造器注入、setter注入，但<strong>推荐构造器注入</strong>：</p>
<p>构造器注入可保证目标对象不可变（final修饰），符合Spring官方依赖注入最佳实践，同时避免字段注入可能出现的空指针异常（注入时机问题）。</p>
<h3 data-id="heading-22">3. 慎用getObject()方法，避免失去柔性优势</h3>
<p><code>getObject()</code>继承自<code>ObjectFactory</code>，无任何容错能力，使用前需确保Bean「唯一且必存在」，否则会抛出传统Spring异常（失去<code>ObjectProvider</code>的柔性优势）。</p>
<p>日常开发优先使用<code>getIfAvailable()</code>、<code>orderedStream()</code>等容错、批量方法。</p>
<h3 data-id="heading-23">4. 遵循Bean作用域，不可忽视实例复用逻辑</h3>
<p>通过<code>ObjectProvider</code>获取的Bean实例，完全遵循其在Spring容器中配置的作用域：</p>
<ul>
<li>
<p>单例（singleton）：每次获取的是同一个实例，即使多次调用<code>getObject()</code>，也不会重新初始化；</p>
</li>
<li>
<p>原型（prototype）：每次获取的是新实例，多次调用<code>getObject()</code>会创建多个实例，需注意资源释放。</p>
</li>
</ul>
<h3 data-id="heading-24">5. 区分ObjectProvider与Optional（避免混淆使用）</h3>
<p>很多开发者会混淆二者，其实二者定位完全不同，可结合使用但不可替代：</p>
<ul>
<li>
<p><code>ObjectProvider</code>：<strong>Spring容器层面的Bean查找工具</strong>，结合了容器的依赖管理、作用域控制，核心是“Bean查找+柔性容错”；</p>
</li>
<li>
<p><code>java.util.Optional</code>：<strong>JDK的空值包装类</strong>，仅用于空值处理，无Bean查找能力，不依赖Spring容器。</p>
</li>
</ul>
<p>推荐结合使用：<code>Optional.ofNullable(provider.getIfAvailable())</code>，既利用<code>ObjectProvider</code>的Bean查找能力，又利用<code>Optional</code>的空值处理能力，代码更优雅。</p>
<h2 data-id="heading-25">七、总结：ObjectProvider的核心价值与应用场景</h2>
<p><code>ObjectProvider</code>作为Spring 4.3引入的增强型工厂接口，核心是解决「传统依赖注入的刚性问题」，其价值可概括为「延迟加载+柔性依赖」，是现代Spring开发中处理Bean依赖的核心工具：</p>
<ol>
<li>
<p>核心定位：<code>ObjectFactory</code>的增强子接口，Spring容器的“柔性Bean查找器”，实现Bean的按需加载与容错注入；</p>
</li>
<li>
<p>核心优势：解决了<code>@Autowired</code>即时注入、强依赖、多实例冲突的三大痛点，补充了容错、批量、流式、动态传参等核心功能；</p>
</li>
<li>
<p>高频场景：可选依赖注入、多同类型Bean批量处理、高成本Bean延迟加载、运行时动态传参创建Bean；</p>
</li>
<li>
<p>官方推荐：优先使用<code>ObjectProvider</code>替代<code>ObjectFactory</code>，契合Spring依赖注入的最佳实践，大幅提升代码简洁度与健壮性。</p>
</li>
</ol>
<p>掌握<code>ObjectProvider</code>，不仅能规避传统依赖注入的高频踩坑点，还能让Bean依赖管理更灵活、更高效，尤其在Spring Boot、Spring Cloud等主流框架开发中，其应用场景极为广泛，是Spring开发者必备的核心技能之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[清华开源！GitHub 上 4600 人 Star 的 RAG 应用神器更新了。]]></title>    <link>https://juejin.cn/post/7600674821308006436</link>    <guid>https://juejin.cn/post/7600674821308006436</guid>    <pubDate>2026-01-30T01:56:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600674821308006436" data-draft-id="7600706866784550955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="清华开源！GitHub 上 4600 人 Star 的 RAG 应用神器更新了。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-30T01:56:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            清华开源！GitHub 上 4600 人 Star 的 RAG 应用神器更新了。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:56:10.000Z" title="Fri Jan 30 2026 01:56:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个叫 UltraRAG 的开源项目，已经在 GitHub 上获得 4600+ 的 Star 了。</p>
<p>它由<strong>清华大学 THUNLP 实验室、东北大学 NEUIR 实验室、OpenBMB 、面壁智能与 AI9Stars 等联合发布的，是首个基于 MCP 的轻量级 RAG 开发框架。</strong> <strong>简单总结就是</strong>用 YAML 配置逻辑，用 MCP 做组件，用 UI 打通从「算法」到「应用」的最后一公里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aed64dfec4004dc0849d74a53b6a2cbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770342969&amp;x-signature=Ir4I4drgSnAlxG3%2BKlgia%2FP6g3Q%3D" alt="图片" loading="lazy"/></p>
<p>最近，它们发布了 UltraRAG 3.0。</p>
<p>直接把定位写得非常激进：拒绝“盲盒”开发，让每一行推理逻辑都清晰可见。</p>
<p>如果你正在做知识库问答、DeepResearch、多轮复杂推理，又被各种 Agent + RAG 的黑盒流水线折磨，UltraRAG 3.0 值得你认真看一眼。</p>
<p>而且目前已经登上了 GitHub 开源热榜的 TOP 3 了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e00658689eac435082320b31f5773a4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770342969&amp;x-signature=gCslVSEQ2GlX1ehXHjyZJvnxWBw%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/OpenBMB/UltraRAG</span>
</code></pre>
<p>01</p>
<p><strong>UltraRAG 3.0 发布了</strong></p>
<p><strong>下面就重点看看刚更新的 3.0 有哪些东西，整体来说还是比较顶的。</strong></p>
<p>① 逻辑即应用</p>
<p>说白了就是不需要你自己写对话界面的 UI 了。以前是：</p>
<p>想一个算法 → 写个 pipeline → 跑通 → 再自己写个前端 UI 包一层 → 再调交互细节。</p>
<p>在 UltraRAG 3.0 里，不用这么麻烦了：</p>
<p>写 YAML / 画流程 → 一键 Build → 自动生成对话式 Web 界面。</p>
<p>可以看到，你只需定义好 YAML pipeline，框架就能自动把它变成一套标准交互 demo。</p>
<p>在 UI 上拖拽、连线组件，像搭积木一样画流程。直接改 YAML，画布视图也能实时跟进。</p>
<p>直观感受：你写好的逻辑，本质上就是一个可运行的产品雏形，不再只是伪 demo。</p>
<p>② 全链路白盒化</p>
<p>Show Thinking，把每一步想法摊开给你看。</p>
<p>UltraRAG 3.0 把 Chat 界面升级成了一个 推理过程观察窗。它有一个 Show Thinking 面板，可以流式展示每个 Step：</p>
<p>比如哪次检索召回了哪些 chunk、哪个 Tool 被调用了几次，在第几轮循环里分支走向了哪边。</p>
<p>结构化、时间顺序很清晰。</p>
<p>多轮查询改写、多次检索、多工具协作，以前真的很难一眼看全流程，有了这个能力，问题定位变得非常直接。</p>
<p>之前发现答案错了，需要通过打 log 或者其它办法来看是检索问题还是模型幻觉。</p>
<p>现在直接在界面上看就行了。对复杂任务尤其有价值，比如 DeepResearch 场景。UltraRAG 3.0 把整个「思考过程」完全展开出来，确实方便很多。</p>
<p>③ 内置智能开发助手</p>
<p>UltraRAG 3.0 直接把开发文档和最佳实践塞进了一个内置的智能助手里。</p>
<p>从看文档→理解→翻译成配置这一整段心智负担都帮你省了。</p>
<p>下面这个图就是内置的开发助手能做的一些事情：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/643ede440db24d0d9547285b65bd3465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770342969&amp;x-signature=7SCsTz3pKfZrgMyWkOcuWTjCMZA%3D" alt="图片" loading="lazy"/></p>
<p>02</p>
<p><strong>如何使用</strong></p>
<p>如果你是第一次接触 UltraRAG，可以按这条路线来：</p>
<h3 data-id="heading-0">第一步：安装 &amp; 验证</h3>
<p><strong>本地安装，推荐 uv：</strong></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/OpenBMB/UltraRAG.git --depth 1cd UltraRAG<span class="hljs-comment"># 同步全部依赖uv sync --all-extras# 激活环境（以 macOS/Linux 为例）source .venv/bin/activate# 跑个最简单的例子ultrarag run examples/sayhello.yaml# 预期输出：Hello, UltraRAG v3!</span>
</code></pre>
<p><strong>Docker 快速体验 UI：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"># 拉镜像 / 或者本地构建docker build -t ultrarag:v0<span class="hljs-number">.3</span><span class="hljs-number">.0</span> .# 跑起来（默认 <span class="hljs-number">5050</span> 端口）docker run -it --gpus all -p <span class="hljs-number">5050</span>:<span class="hljs-number">5050</span> ultrarag:v0<span class="hljs-number">.3</span><span class="hljs-number">.0</span># 浏览器打开 http:<span class="hljs-comment">//localhost:5050</span>
</code></pre>
<p>先随便玩几个官方示例 pipeline，感受一下「Show Thinking」和可视化 builder 的味道。</p>
<p>第二步：学会读/写一份简单的 YAML Pipeline</p>
<p>你至少要掌握：</p>
<p>servers: 部分：声明你会用到哪些 MCP Servers（retriever / generation / evaluation…）</p>
<p>pipeline: 部分：声明执行的步骤，以及循环/分支逻辑</p>
<p>典型结构大概是这样的：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">servers:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">generation</span>    <span class="hljs-attr">type:</span> <span class="hljs-string">generation</span>    <span class="hljs-string">params:</span>      <span class="hljs-attr">model:</span> <span class="hljs-string">qwen3-7b</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">retriever</span>    <span class="hljs-attr">type:</span> <span class="hljs-string">retriever</span>    <span class="hljs-string">params:</span>      <span class="hljs-attr">index:</span> <span class="hljs-string">milvuspipeline:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">init_query</span>    <span class="hljs-attr">server:</span> <span class="hljs-string">generation</span>    <span class="hljs-attr">input:</span> <span class="hljs-string">user_question</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">search_loop</span>    <span class="hljs-string">loop:</span>      <span class="hljs-attr">times:</span> <span class="hljs-number">5</span>      <span class="hljs-string">steps:</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">server:</span> <span class="hljs-string">retriever</span>        <span class="hljs-bullet">-</span> <span class="hljs-attr">server:</span> <span class="hljs-string">generation</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">decide</span>    <span class="hljs-string">branch:</span>      <span class="hljs-string">condition:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{need_more}}</span>"</span>      <span class="hljs-attr">true:</span> <span class="hljs-string">search_loop</span>      <span class="hljs-attr">false:</span> <span class="hljs-string">final_answer</span>
</code></pre>
<p>可以先在 UI 里用画布模式拖出一个流程，再去看同步生成的 YAML 长什么样。有任何不懂的字段，直接问内置智能助手，比翻文档快。</p>
<p>接下来，你就能把你已有的 RAG 逻辑迁到 UltraRAG。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[VertexColor节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7600684978353471515</link>    <guid>https://juejin.cn/post/7600684978353471515</guid>    <pubDate>2026-01-30T02:00:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600684978353471515" data-draft-id="7600615229996007474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[VertexColor节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2026-01-30T02:00:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[VertexColor节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:00:40.000Z" title="Fri Jan 30 2026 02:00:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>VertexColor节点是Unity URP Shader Graph中一个基础且功能强大的节点，它允许着色器访问网格的顶点颜色数据。顶点颜色是存储在网格每个顶点上的颜色信息，可以用于各种视觉效果和着色技术。在实时渲染中，顶点颜色提供了一种高效的方式来为模型添加颜色变化、遮罩信息或其他每顶点数据，而无需额外的纹理采样。</p>
<p>顶点颜色数据通常由3D建模软件（如Blender、Maya、3ds Max）创建并导出，或者在Unity中通过脚本动态修改。每个顶点可以存储RGBA（红、绿、蓝、透明度）四个通道的颜色值，这些值在顶点之间进行插值，然后在片元着色器中使用。</p>
<p>在Shader Graph中，VertexColor节点是连接网格数据与着色器逻辑的重要桥梁。理解并熟练使用这个节点，可以大大扩展着色器的创作可能性，从简单的颜色着色到复杂的动态效果都能实现。</p>
<h2 data-id="heading-0">VertexColor节点基本概念</h2>
<p>顶点颜色是直接存储在网格顶点上的颜色信息，与纹理贴图不同，它不依赖于UV坐标映射，而是与网格的顶点结构紧密相关。当渲染网格时，顶点颜色会在三角形表面进行平滑插值，创造出渐变效果。</p>
<h3 data-id="heading-1">顶点颜色的工作原理</h3>
<p>在计算机图形学中，网格由顶点和三角形组成。每个顶点除了包含位置坐标外，还可以存储其他属性，如法线、纹理坐标和颜色。当Shader Graph使用VertexColor节点时，它实际上是在访问这些预存的顶点颜色数据。</p>
<p>顶点颜色的处理发生在图形管线的不同阶段：</p>
<ul>
<li>在顶点着色器阶段，可以访问原始的顶点颜色值</li>
<li>在光栅化过程中，顶点颜色会在三角形表面进行插值</li>
<li>在片元着色器阶段，可以访问插值后的顶点颜色</li>
</ul>
<p>这种插值机制意味着即使网格的顶点数量相对较少，也能呈现出平滑的颜色过渡效果。</p>
<h3 data-id="heading-2">顶点颜色与纹理的对比</h3>
<p>顶点颜色和纹理贴图都是为模型添加颜色信息的方法，但它们各有优缺点：</p>
<ul>
<li>顶点颜色的优势：
<ul>
<li>性能开销低，不需要纹理采样</li>
<li>不受UV映射问题影响</li>
<li>适合表示大面积的平滑渐变</li>
<li>可以与其他顶点数据（如位置、法线）结合使用</li>
</ul>
</li>
<li>顶点颜色的局限性：
<ul>
<li>分辨率受顶点密度限制</li>
<li>难以表现复杂的图案和细节</li>
<li>修改颜色需要更改网格数据</li>
</ul>
</li>
<li>纹理贴图的优势：
<ul>
<li>可以表现高度复杂的图案和细节</li>
<li>分辨率独立于网格密度</li>
<li>可以重复使用在不同模型上</li>
</ul>
</li>
<li>纹理贴图的局限性：
<ul>
<li>需要额外的内存存储纹理</li>
<li>需要纹理采样操作，有一定性能开销</li>
<li>需要正确的UV映射</li>
</ul>
</li>
</ul>
<p>在实际项目中，顶点颜色和纹理贴图经常结合使用，以发挥各自的优势。</p>
<h2 data-id="heading-3">VertexColor节点端口详解</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/VertexColorNodeThumb.png" alt="" loading="lazy"/></p>
<p>VertexColor节点只有一个输出端口，但理解这个端口的特性和使用方法至关重要。</p>
<h3 data-id="heading-4">输出端口特性</h3>
<p>VertexColor节点的输出端口标记为"Out"，类型为Vector 4，对应RGBA四个通道的颜色值：</p>
<ul>
<li>R通道：红色分量，取值范围通常为[0,1]</li>
<li>G通道：绿色分量，取值范围通常为[0,1]</li>
<li>B通道：蓝色分量，取值范围通常为[0,1]</li>
<li>A通道：透明度分量，取值范围通常为[0,1]</li>
</ul>
<p>输出值取决于当前处理的顶点或片元位置，以及网格的顶点颜色数据。如果网格没有顶点颜色数据，Unity通常会使用默认值（通常是白色或黑色，取决于导入设置）。</p>
<h3 data-id="heading-5">数据类型与精度</h3>
<p>VertexColor节点输出的Vector 4数据类型在Shader Graph中具有完整的浮点精度，这意味着它可以表示非常细微的颜色变化。这种高精度使得顶点颜色适合用于各种计算，而不仅仅是简单的颜色显示。</p>
<p>在内部，顶点颜色数据通常以8位每通道的精度存储（即0-255整数值），但在着色器中被标准化为0-1的浮点值。当在着色器中进行计算时，这些值会以全浮点精度处理，只有在最终输出到帧缓冲区时才会根据显示设备的限制进行量化。</p>
<h2 data-id="heading-6">顶点颜色的创建与导入</h2>
<p>要在Shader Graph中使用VertexColor节点，首先需要确保网格包含顶点颜色数据。有多种方法可以为网格创建和添加顶点颜色。</p>
<h3 data-id="heading-7">在3D建模软件中创建顶点颜色</h3>
<p>大多数专业3D建模软件都支持顶点颜色的创建和编辑：</p>
<ul>
<li>Blender：
<ul>
<li>进入顶点绘制模式（Vertex Paint Mode）</li>
<li>使用画笔工具直接在模型上绘制颜色</li>
<li>可以调整笔刷大小、强度和颜色</li>
<li>支持图层和遮罩等高级功能</li>
</ul>
</li>
<li>Maya：
<ul>
<li>使用顶点颜色集（Vertex Color Sets）</li>
<li>通过颜色绘画工具（Color Paint Tool）直接绘制</li>
<li>支持通过属性编辑器调整颜色值</li>
</ul>
</li>
<li>3ds Max：
<ul>
<li>使用顶点绘制修改器（Vertex Paint Modifier）</li>
<li>提供直观的绘制界面和多种笔刷选项</li>
<li>支持将顶点颜色转换为纹理</li>
</ul>
</li>
</ul>
<p>在导出模型时，确保选择支持顶点颜色的文件格式（如FBX），并检查导出设置中已启用顶点颜色选项。</p>
<h3 data-id="heading-8">在Unity中处理顶点颜色</h3>
<p>将带有顶点颜色的模型导入Unity后，需要检查导入设置以确保顶点颜色被正确识别：</p>
<ul>
<li>在Project窗口中选择模型文件</li>
<li>在Inspector窗口中查看Model选项卡</li>
<li>确保"Import Vertex Colors"选项被启用</li>
<li>检查"Bake IK"和"Optimize Mesh"等选项是否会影响顶点颜色数据</li>
</ul>
<p>如果模型不包含顶点颜色，或者需要修改现有的顶点颜色，可以使用Unity的脚本API动态处理：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 为网格添加顶点颜色的示例代码</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">AddVertexColors</span>(<span class="hljs-params">Mesh mesh, Color[] colors</span>)</span>
{
    <span class="hljs-keyword">if</span> (mesh.vertexCount != colors.Length)
    {
        Debug.LogError(<span class="hljs-string">"顶点颜色数量必须与顶点数量匹配"</span>);
        <span class="hljs-keyword">return</span>;
    }

    mesh.colors = colors;
}

<span class="hljs-comment">// 创建渐变顶点颜色的示例</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CreateGradientVertexColors</span>(<span class="hljs-params">Mesh mesh, Color topColor, Color bottomColor</span>)</span>
{
    Vector3[] vertices = mesh.vertices;
    Color[] colors = <span class="hljs-keyword">new</span> Color[vertices.Length];

    <span class="hljs-comment">// 找到Y轴的最小和最大值</span>
    <span class="hljs-built_in">float</span> minY = <span class="hljs-built_in">float</span>.MaxValue;
    <span class="hljs-built_in">float</span> maxY = <span class="hljs-built_in">float</span>.MinValue;

    <span class="hljs-keyword">foreach</span> (Vector3 vertex <span class="hljs-keyword">in</span> vertices)
    {
        <span class="hljs-keyword">if</span> (vertex.y &lt; minY) minY = vertex.y;
        <span class="hljs-keyword">if</span> (vertex.y &gt; maxY) maxY = vertex.y;
    }

    <span class="hljs-comment">// 根据Y值分配颜色</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; vertices.Length; i++)
    {
        <span class="hljs-built_in">float</span> t = (vertices[i].y - minY) / (maxY - minY);
        colors[i] = Color.Lerp(bottomColor, topColor, t);
    }

    mesh.colors = colors;
}
</code></pre>
<p>这种方法特别适用于程序化生成的网格或需要运行时修改顶点颜色的情况。</p>
<h2 data-id="heading-9">VertexColor节点的基本应用</h2>
<p>VertexColor节点在Shader Graph中有多种基本应用方式，从简单的颜色显示到复杂的材质效果都能实现。</p>
<h3 data-id="heading-10">直接显示顶点颜色</h3>
<p>最简单的应用是直接将顶点颜色输出到材质的基色：</p>
<ul>
<li>创建新的PBR Graph或Unlit Graph</li>
<li>添加VertexColor节点到图中</li>
<li>将VertexColor节点的输出连接到Master节点的Base Color输入</li>
<li>保存并应用材质到带有顶点颜色的模型</li>
</ul>
<p>这种设置会完全按照网格的顶点颜色数据显示模型，适用于展示艺术家的原始设计或验证顶点颜色数据是否正确导入。</p>
<h3 data-id="heading-11">与纹理结合使用</h3>
<p>顶点颜色经常与纹理贴图结合使用，以创建更复杂的材质效果：</p>
<ul>
<li>乘法混合：将顶点颜色与纹理颜色相乘，常用于色调调整或局部变暗/变亮</li>
<li>加法混合：将顶点颜色与纹理颜色相加，常用于发光效果或高光增强</li>
<li>插值混合：使用顶点颜色的某个通道（如Alpha）在两种纹理间进行插值</li>
</ul>
<p>以下是一个乘法混合的示例设置：</p>
<ul>
<li>添加Texture2D节点并分配纹理</li>
<li>添加VertexColor节点</li>
<li>添加Multiply节点</li>
<li>将Texture2D和VertexColor连接到Multiply的输入</li>
<li>将Multiply的输出连接到Base Color</li>
</ul>
<p>这种技术常用于为环境资产添加变化，比如使地面纹理在不同区域呈现不同的色调。</p>
<h3 data-id="heading-12">作为遮罩数据使用</h3>
<p>顶点颜色的各个通道可以单独提取并用作遮罩，控制材质的不同方面：</p>
<ul>
<li>R通道：控制漫反射强度或特殊效果区域</li>
<li>G通道：控制高光强度或金属度</li>
<li>B通道：控制自发光或透明度</li>
<li>A通道：通常用于透明度混合或边缘褪色</li>
</ul>
<p>例如，可以使用顶点颜色的红色通道控制材质的金属度：</p>
<ul>
<li>添加VertexColor节点</li>
<li>使用Split节点分离RGBA通道</li>
<li>将R通道输出连接到Master节点的Metallic输入</li>
<li>调整连接强度可能需要使用Multiply节点进行标量乘法</li>
</ul>
<p>这种方法在角色材质中特别常见，比如在不同部位表现不同的材质属性（皮肤、布料、金属等）。</p>
<h2 data-id="heading-13">高级技巧与创意应用</h2>
<p>除了基本应用，VertexColor节点还可以用于实现各种高级效果和创意着色器。</p>
<h3 data-id="heading-14">动态效果与动画</h3>
<p>顶点颜色可以与时间节点结合，创建动态材质效果：</p>
<ul>
<li>脉动效果：使用正弦函数随时间改变顶点颜色的强度</li>
<li>颜色循环：使用时间节点循环变换顶点颜色的色调</li>
<li>扫描效果：结合顶点位置和顶点颜色创建移动的光带</li>
</ul>
<p>以下是一个简单的脉动效果示例：</p>
<ul>
<li>添加Time节点</li>
<li>添加Sine节点连接到Time</li>
<li>添加Multiply节点调整脉动幅度和频率</li>
<li>添加VertexColor节点</li>
<li>将Sine和VertexColor的输出相乘</li>
<li>连接到Base Color输入</li>
</ul>
<p>这种技术可以用于创建呼吸效果的发光物体、脉动的能量场等动态场景元素。</p>
<h3 data-id="heading-15">程序化地形着色</h3>
<p>在大型地形系统中，顶点颜色常用于混合多种纹理：</p>
<ul>
<li>使用红色通道控制草地纹理的强度</li>
<li>使用绿色通道控制岩石纹理的强度</li>
<li>使用蓝色通道控制沙地纹理的强度</li>
<li>使用Alpha通道控制雪地纹理的强度</li>
</ul>
<p>设置方法：</p>
<ul>
<li>添加多个Texture2D节点，分别代表不同地形类型的纹理</li>
<li>添加VertexColor节点并使用Split分离通道</li>
<li>使用多个Lerp节点根据顶点颜色通道混合纹理</li>
<li>最终混合结果连接到Base Color</li>
</ul>
<p>这种方法允许美术师在3D软件中绘制地形分布，并在Unity中实现复杂的多纹理混合，而无需使用高分辨率的重量纹理。</p>
<h3 data-id="heading-16">特效与粒子系统</h3>
<p>顶点颜色在粒子系统和特效着色器中尤为重要：</p>
<ul>
<li>使用顶点颜色控制粒子生命周期中的颜色变化</li>
<li>结合顶点Alpha通道实现软粒子效果</li>
<li>使用RGB通道存储自定义数据，如速度、大小或旋转</li>
</ul>
<p>在Visual Effect Graph或旧版粒子系统中，可以在着色器中使用VertexColor节点访问粒子颜色数据，实现复杂的粒子行为。</p>
<h2 data-id="heading-17">性能优化与最佳实践</h2>
<p>正确使用VertexColor节点不仅可以创造出色的视觉效果，还能保持高性能。</p>
<h3 data-id="heading-18">性能考量</h3>
<p>顶点颜色数据对性能的影响主要取决于几个因素：</p>
<ul>
<li>网格复杂度：顶点数量越多，需要传输和处理的颜色数据也越多</li>
<li>平台限制：移动设备对顶点数据有更严格的限制</li>
<li>带宽使用：顶点颜色会增加顶点缓冲区的大小，影响内存带宽</li>
</ul>
<p>优化建议：</p>
<ul>
<li>在不需要顶点颜色的模型上禁用顶点颜色导入</li>
<li>使用适当的LOD（Level of Detail）系统，在远距离模型上使用简化的顶点数据</li>
<li>考虑使用顶点颜色与纹理的组合，而不是完全依赖顶点颜色表现细节</li>
</ul>
<h3 data-id="heading-19">工作流程最佳实践</h3>
<p>为了确保顶点颜色工作流程的顺畅，建议遵循以下最佳实践：</p>
<ul>
<li>在3D建模软件中明确命名顶点颜色层，便于识别和管理</li>
<li>在团队中建立统一的顶点颜色通道规范（如R通道总是表示某种特定遮罩）</li>
<li>在Unity中创建材质模板，预设常用的顶点颜色应用模式</li>
<li>使用自定义Shader Graph子图封装复杂的顶点颜色逻辑，提高复用性</li>
</ul>
<h3 data-id="heading-20">调试与问题解决</h3>
<p>当顶点颜色不按预期显示时，可以采取以下调试步骤：</p>
<ul>
<li>检查模型导入设置中的顶点颜色选项是否启用</li>
<li>在Scene视图中使用Vertex Color显示模式可视化顶点颜色数据</li>
<li>在Shader Graph中使用Preview节点检查VertexColor节点的输出值</li>
<li>确保材质正确应用到了目标模型上</li>
<li>检查是否有其他着色器功能（如光照、雾效）覆盖了顶点颜色效果</li>
</ul>
<p>常见问题及解决方案：</p>
<ul>
<li>顶点颜色显示为黑色或白色：可能是模型没有顶点颜色数据，或导入设置不正确</li>
<li>颜色插值不连续：检查网格是否有重复顶点或UV接缝问题</li>
<li>性能突然下降：检查是否在低端设备上使用了高顶点数的网格配合顶点颜色</li>
</ul>
<h2 data-id="heading-21">实际案例分析与实现</h2>
<p>通过具体案例更好地理解VertexColor节点的应用。</p>
<h3 data-id="heading-22">案例一：风格化水体着色器</h3>
<p>创建一个使用顶点颜色控制的水体着色器：</p>
<ul>
<li>使用顶点颜色的蓝色通道控制水深</li>
<li>使用顶点颜色的绿色通道控制水体清澈度</li>
<li>使用顶点颜色的红色通道控制波浪强度</li>
<li>使用顶点Alpha通道控制泡沫分布</li>
</ul>
<p>实现步骤：</p>
<ol>
<li>创建新的PBR Graph</li>
<li>添加VertexColor节点并分离各通道</li>
<li>使用蓝色通道与深度纹理结合计算水下效果</li>
<li>使用绿色通道调整水体透明度</li>
<li>使用红色通道控制法线贴图的强度，模拟波浪</li>
<li>使用Alpha通道混合泡沫纹理</li>
<li>将所有效果组合到Base Color、Normal和Emission输出</li>
</ol>
<p>这种技术允许美术师通过绘制顶点颜色直接控制水体的视觉效果，无需编写复杂的水体着色器代码。</p>
<h3 data-id="heading-23">案例二：可交互的熔岩材质</h3>
<p>创建一个使用顶点颜色和顶点动画的熔岩材质：</p>
<ul>
<li>使用顶点颜色的红色通道控制熔岩温度</li>
<li>使用绿色通道控制熔岩流速</li>
<li>使用蓝色通道控制熔岩发光强度</li>
<li>结合时间节点创建流动效果</li>
</ul>
<p>实现步骤：</p>
<ol>
<li>创建Unlit Graph以完全控制颜色输出</li>
<li>添加VertexColor节点和Time节点</li>
<li>使用噪声纹理和绿色通道创建流动图案</li>
<li>使用红色通道调整熔岩基础颜色（从暗红到亮黄）</li>
<li>使用蓝色通道控制自发光强度</li>
<li>添加顶点偏移模拟熔岩表面的轻微起伏</li>
<li>将所有组件组合到最终颜色输出</li>
</ol>
<p>这种材质可以应用于火山环境、魔法效果或科幻场景中的能量流体。</p>
<h3 data-id="heading-24">案例三：动态植被着色器</h3>
<p>创建响应风效和季节变化的植被着色器：</p>
<ul>
<li>使用顶点红色通道标记树叶位置</li>
<li>使用绿色通道控制树枝弯曲强度</li>
<li>使用蓝色通道控制颜色变化（如季节更替）</li>
<li>使用Alpha通道控制叶片透明度</li>
</ul>
<p>实现步骤：</p>
<ol>
<li>创建PBR Graph支持真实感渲染</li>
<li>添加VertexColor节点并分离通道</li>
<li>使用绿色通道与风效节点结合，实现基于顶点颜色的差异化弯曲</li>
<li>使用蓝色通道与时间节点结合，模拟季节颜色变化</li>
<li>使用红色通道标记的树叶区域应用特殊的透光效果</li>
<li>使用Alpha通道实现叶片边缘透明，减少视觉锯齿</li>
<li>组合所有效果输出到PBR主节点</li>
</ol>
<p>这种着色器可以让植被更加生动自然，同时保持较低的性能开销。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从内存到磁盘：数据结构选型——ArrayList、HashMap]]></title>    <link>https://juejin.cn/post/7600628279215112218</link>    <guid>https://juejin.cn/post/7600628279215112218</guid>    <pubDate>2026-01-29T12:45:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279215112218" data-draft-id="7600628279215095834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从内存到磁盘：数据结构选型——ArrayList、HashMap"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-29T12:45:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SereneDream"/> <meta itemprop="url" content="https://juejin.cn/user/4250057782345273"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从内存到磁盘：数据结构选型——ArrayList、HashMap
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4250057782345273/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SereneDream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:45:53.000Z" title="Thu Jan 29 2026 12:45:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：数据结构没有好坏，只有场景。</h2>
<p>世界上没有绝对的事情，所有事情，所有的东西都是相对而言。</p>
<p>就像是选择笔记本电脑一样，</p>
<p>轻薄本 不能兼顾太多的性能，但是轻薄本易于携带，更加轻便</p>
<p>游戏本/性能本 重量较大，不方便携带，但是提供了更强大的性能</p>
<p>不同场景中有不同的选择，没有绝对一说</p>
<h2 data-id="heading-1">CPU 缓存的“偏爱”</h2>
<h3 data-id="heading-2">内存与缓存</h3>
<p>相关文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.hello-algo.com%2Fchapter_array_and_linkedlist%2Fram_and_cache%2F" target="_blank" title="https://www.hello-algo.com/chapter_array_and_linkedlist/ram_and_cache/" ref="nofollow noopener noreferrer">Hello 算法 - 内存与缓存*</a></p>
<p>我们知道，数据结构中的“数组”与“链表”由于它们采用两种相反的存储策略，因此各种性质和操作效率也呈现对立的特点。</p>
<p>在计算机物理层中，硬盘，内存，缓存 都能够存储数据，但是他们都有对应的特点</p>



































<table><thead><tr><th>****</th><th><strong>硬盘</strong></th><th><strong>内存</strong></th><th><strong>缓存</strong></th></tr></thead><tbody><tr><td>用途</td><td>长期存储数据，包括操作系统、程序、文件等</td><td>临时存储当前运行的程序和正在处理的数据</td><td>存储经常访问的数据和指令，减少 CPU 访问内存的次数</td></tr><tr><td>易失性</td><td>断电后数据不会丢失</td><td>断电后数据会丢失</td><td>断电后数据会丢失</td></tr><tr><td>容量</td><td>较大，TB 级别</td><td>较小，GB 级别</td><td>非常小，MB 级别</td></tr><tr><td>速度</td><td>较慢，几百到几千 MB/s</td><td>较快，几十 GB/s</td><td>非常快，几十到几百 GB/s</td></tr></tbody></table>
<p>多层级的设计并非偶然，而是计算机科学家和工程师们经过深思熟虑的结果。</p>
<ul>
<li><strong>硬盘难以被内存取代</strong>。内存中的数据在断电后会丢失，它不适合长期存储数据。</li>
<li><strong>缓存的大容量和高速度难以兼得</strong>。随着缓存的容量逐步增大，其物理尺寸会变大，与 CPU 核心之间的物理距离会变远，从而导致数据传输时间增加，元素访问延迟变高。</li>
</ul>
<p>而为了使得 CPU 的读写效率更高，CPU 会采取算法，将内存中的可能需要，或者频繁访问的数据加入缓存（内存同理）</p>
<p>如果 CPU 加入缓存的数据恰好是需要使用的数据则叫做 缓存命中</p>
<p>相反叫做 缓存未命中，若是缓存未命中就意味着 CPU 需要再耗费时间和性能从内存，甚至是硬盘中获取对应的数据，那样子太耗费时间和性能</p>
<p>这也引申出了 缓存命中率（即 CPU 从缓存中获取成功数据的比例）</p>
<h3 data-id="heading-3">缓存的数据结构</h3>
<p>缓存的底层既可以使用数组，也可以使用链表，以下是在 Java 中使用数组和链表构建的缓存亲和度对比，实验记录了 CPU 使用不同底层数据结构（底层是数组或链表）进行相同活动（插入数据）所损耗的时间</p>
<p>代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// ArrayList 的底层使用【数组】实现</span>
        List&lt;Integer&gt; arrayList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 记录开始前时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime();

        <span class="hljs-comment">// 往当前 arrayList 中插入巨量数据</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
            arrayList.add(i);
        }

        <span class="hljs-comment">// 记录结束时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">nowTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime();

        System.out.printf(<span class="hljs-string">"当前使用的数据结构底层使用【数组】，使用了百万次插入方法消耗的时间为 %d "</span>, nowTime - time);
    }
}
</code></pre>
<p>运行结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85607a0c2a3b4d5a937d3b56edccf595~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295556&amp;x-signature=osTW33V3VnVWNbXJFhk%2FB3r5jiE%3D" alt="" loading="lazy"/></p>
<p>代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.LinkedList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// linkedList 的底层使用【链表】实现</span>
        List&lt;Integer&gt; linkedList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

        <span class="hljs-comment">// 记录开始前时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime();

        <span class="hljs-comment">// 往当前 linkedList 中插入巨量数据</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
            linkedList.add(i);
        }

        <span class="hljs-comment">// 记录结束时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">nowTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime();

        System.out.printf(<span class="hljs-string">"当前使用的数据结构底层使用【链表】，使用了百万次插入方法消耗的时间为 %d "</span>, nowTime - time);
    }
}
</code></pre>
<p>运行结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53329c72b0064f778d73065ca2df2f73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295556&amp;x-signature=X2iGn%2BO56RNq7IktyFZKVd1bliQ%3D" alt="" loading="lazy"/></p>
<p>对比两次实验我们不难发现，使用数组所损耗的时间远小于链表</p>
<h4 data-id="heading-4">为什么数组的缓存亲和度会比链表高？</h4>
<p>无论是数据还是链表，当在创建之后，他都会进入内存，而 CPU 会根据缓存命中算法来提高效率</p>
<p><strong>缓存中数组和链表的利用效率是不同的</strong></p>
<ul>
<li><strong>占用空间</strong>：链表元素比数组元素占用空间更多（链表除去本身存储的数据除外还需要存储下一个链表的地址值），导致缓存中容纳的有效数据量更少。</li>
<li><strong>缓存行</strong>：链表数据分散在内存各处，而缓存是“按行加载”的，因此加载到无效数据的比例更高。</li>
<li><strong>预取机制</strong>：数组比链表的数据访问模式更具“可预测性”（因为数组在内存中的地址是连续的），即系统更容易猜出即将被加载的数据。</li>
<li><strong>空间局部性</strong>：数组被存储在集中的内存空间中，因此被加载数据附近的数据更有可能即将被访问。</li>
</ul>
<p>总体而言，<strong>数组具有更高的缓存命中率，因此它在操作效率上通常优于链表</strong>。这使得在解决算法问题时，基于数组实现的数据结构往往更受欢迎。</p>
<h2 data-id="heading-5">内存中 JDK 哈希奇闻：链表会进化成红黑树？</h2>
<h3 data-id="heading-6">哈希表是什么？</h3>
<p>哈希表，是一个键（key）对应一个值（value）的键值对散列表。字典/映射/map 通常使用哈希表来实现</p>
<p>“桶”是存储数据的基本单元。哈希函数将一个键转换成一个数组索引，这个索引对应的位置就是一个“桶”。</p>
<p>桶可以简单理解成哈希表中对应的值（value）</p>
<h4 data-id="heading-7">如何实现</h4>
<p>从本质上看，哈希函数的作用是将所有 <code>key</code> 构成的输入空间映射到数组所有索引构成的输出空间，而输入空间往往远大于输出空间。</p>
<p>注意！这里的空间指的是地址值，举一个简单的例子：</p>
<p>我们使用数组来模拟哈希表，那么数组若是在内存中的地址为 0~255，则代表哈希表的 value 必须映射到对应的地址，而数组中的偏移量（下标）刚好与数组内的数据唯一对应，所以我们可以采取 - 想存入哈希表的元素地址，我们对 255 取余，余后就是需要被放入数组的地址值</p>
<h3 data-id="heading-8">哈希冲突！</h3>
<p>由于输入的空间往往远大于输入空间，因此，<strong>理论上一定存在“多个输入对应相同输出”的情况</strong></p>
<p>哈希冲突，由此产生</p>
<h4 data-id="heading-9">如何解决哈希冲突</h4>
<h5 data-id="heading-10">最笨的方式：扩容</h5>
<p>哈希表容量越大，多个 <code>key</code> 被分配到同一个桶中的概率就越低，冲突就越少。因此，<strong>我们可以通过扩容哈希表来减少哈希冲突</strong>。</p>
<p>但是我们不难想到频繁扩容带来的后果：</p>
<ol>
<li>哈希表的构建需要哈希值 / 哈希表中每个值（value）都需要 键（key）% 对应的哈希表长度（初始数组长度）</li>
<li>产生冲突之后进行扩容会改变哈希表长度（初始数组长度被改变）</li>
</ol>
<p>这样子会引发一些问题：哈希表一旦扩容，内部的键值对需要重新洗牌存入，这样子做即耗时又损耗性能</p>
<h5 data-id="heading-11">JDK 底层是如何解决哈希冲突的</h5>
<p>以下是 JDK 源码 HashMap 注释文档部分，我进行了机翻和转述，其中讲述了 JDK 底层对于 哈希表 的各种操作，提及了线程安全和负载因子</p>
<pre><code class="hljs language-markdown" lang="markdown">/**
<span class="hljs-bullet"> *</span> Hash table based implementation of the {@code Map} interface.  This
<span class="hljs-bullet"> *</span> implementation provides all of the optional map operations, and permits
<span class="hljs-bullet"> *</span> {@code null} values and the {@code null} key.  (The {@code HashMap}
<span class="hljs-bullet"> *</span> class is roughly equivalent to {@code Hashtable}, except that it is
<span class="hljs-bullet"> *</span> unsynchronized and permits nulls.)  This class makes no guarantees as to
<span class="hljs-bullet"> *</span> the order of the map; in particular, it does not guarantee that the order
<span class="hljs-bullet"> *</span> will remain constant over time.
<span class="hljs-bullet"> *</span> 【第一段讲解了相关与 HashMap 类实现的相关内容】
<span class="hljs-bullet"> *</span> 基于哈希表的Map接口实现。
<span class="hljs-bullet"> *</span> 此实现提供了所有可选的映射操作，并允许使用null值和null键。
<span class="hljs-bullet"> *</span> （HashMap类大致等同于Hashtable，但它是非同步的，且允许使用null值。）
<span class="hljs-bullet"> *</span> 此类不对映射的顺序做出任何保证；特别是，它不保证顺序会随时间保持不变。
<span class="hljs-bullet"> *</span> 【即： HashMap 在 push 后不保证数据在物理地址以及逻辑地址上的先后性】
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>This implementation provides constant-time performance for the basic
<span class="hljs-bullet"> *</span> operations ({@code get} and {@code put}), assuming the hash function
<span class="hljs-bullet"> *</span> disperses the elements properly among the buckets.  Iteration over
<span class="hljs-bullet"> *</span> collection views requires time proportional to the "capacity" of the
<span class="hljs-bullet"> *</span> {@code HashMap} instance (the number of buckets) plus its size (the number
<span class="hljs-bullet"> *</span> of key-value mappings).  Thus, it's very important not to set the initial
<span class="hljs-bullet"> *</span> capacity too high (or the load factor too low) if iteration performance is
<span class="hljs-bullet"> *</span> important.
<span class="hljs-bullet"> *</span> 此实现为基本操作（get 和 put）提供了常数时间性能【即：时间复杂度为 O(1)】，
<span class="hljs-bullet"> *</span> 前提是哈希函数【即：哈希算法】能在桶【②桶可以简单理解成哈希表中对应的值（value）】之间正确分散元素。
<span class="hljs-bullet"> *</span> 【即：如果发生了错误导致哈希冲突，所有的数据都堆砌到同一个桶中，虽然 JDK 会将对应的链表转为红黑树，但是会使得查找和添加的时间复杂度上升】
<span class="hljs-bullet"> *</span> 遍历集合视图所需的时间与 HashMap 实例的“容量”（桶的数量）加上其大小（键值映射的数量）成正比。
<span class="hljs-bullet"> *</span> 【①遍历 HashMap 的时间 与 HashMap 底层哈希表（组成哈希表的数组）的大小和哈希表中存储的值的数量 成正比】
<span class="hljs-bullet"> *</span> 因此，如果遍历性能很重要，则不要将初始容量【即哈希表初始大小】设置得太高（或将负载因子设置得太低），这一点非常重要。
<span class="hljs-bullet"> *</span> 【负载因子是一个数值，为哈希表的元素数量除以桶数量】
<span class="hljs-bullet"> *</span> 【这里提及了负载因子和初始容量，初始容量设置得过高会使得遍历性能下降，】
<span class="hljs-bullet"> *</span> 【而负载因子设置的太低会导致 HashMap 底层的哈希表扩容的频率提高（引发初始容量升高）】
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>An instance of {@code HashMap} has two parameters that affect its
<span class="hljs-bullet"> *</span> performance: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>initial capacity<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span> and <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>load factor<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span>.  The
<span class="hljs-bullet"> *</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>capacity<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span> is the number of buckets in the hash table, and the initial
<span class="hljs-bullet"> *</span> capacity is simply the capacity at the time the hash table is created.  The
<span class="hljs-bullet"> *</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>load factor<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span> is a measure of how full the hash table is allowed to
<span class="hljs-bullet"> *</span> get before its capacity is automatically increased.  When the number of
<span class="hljs-bullet"> *</span> entries in the hash table exceeds the product of the load factor and the
<span class="hljs-bullet"> *</span> current capacity, the hash table is <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>rehashed<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span> (that is, internal data
<span class="hljs-bullet"> *</span> structures are rebuilt) so that the hash table has approximately twice the
<span class="hljs-bullet"> *</span> number of buckets.
<span class="hljs-bullet"> *</span> HashMap的一个实例有两个影响其性能的参数：初始容量【即哈希表初始大小】和负载因子（翻译可能会翻译成加载因子，需要注意）。
<span class="hljs-bullet"> *</span> 【即：哈希表的底层有两个参数会影响其性能，可能是遍历（容量越大遍历时间越长，在上一段①处标明成正比关系）】
<span class="hljs-bullet"> *</span> 【也可能是说当哈希表重新哈希化增加哈希表容量这一过程（在重新哈希化的过程中需要耗费额外性能进行操作）】
<span class="hljs-bullet"> *</span> 容量是指哈希表中的桶数【哈希表中能容纳多少的桶】，而初始容量则是指哈希表创建时的容量。
<span class="hljs-bullet"> *</span> 负载因子是衡量哈希表在自动增加容量之前允许达到的满载程度的一个指标。
<span class="hljs-bullet"> *</span> 【JDK 底层会使用一个哈希表扩容算法，其中 负载因子 到达一定的数值时哈希表会扩容】
<span class="hljs-bullet"> *</span> 当哈希表中的元素数超过负载因子与当前容量的乘积时，哈希表会被重新哈希化（即重建内部数据结构），以便哈希表中的桶数大约增加一倍。
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>As a general rule, the default load factor (.75) offers a good
<span class="hljs-bullet"> *</span> tradeoff between time and space costs.  Higher values decrease the
<span class="hljs-bullet"> *</span> space overhead but increase the lookup cost (reflected in most of
<span class="hljs-bullet"> *</span> the operations of the {@code HashMap} class, including
<span class="hljs-bullet"> *</span> {@code get} and {@code put}).  The expected number of entries in
<span class="hljs-bullet"> *</span> the map and its load factor should be taken into account when
<span class="hljs-bullet"> *</span> setting its initial capacity, so as to minimize the number of
<span class="hljs-bullet"> *</span> rehash operations.  If the initial capacity is greater than the
<span class="hljs-bullet"> *</span> maximum number of entries divided by the load factor, no rehash
<span class="hljs-bullet"> *</span> operations will ever occur.
<span class="hljs-bullet"> *</span> 通常，默认的负载因子（0.75）在时间和空间成本之间取得了良好的平衡。
<span class="hljs-bullet"> *</span> 更高的值会减少空间开销，但会增加查找成本（体现在HashMap类的大多数操作中，包括get和put）。
<span class="hljs-bullet"> *</span> 【当哈希表固定大小时只有固定的几个桶存储数据，在 JDK 中会采取链表 -&gt; 红黑树 来进行桶扩容操作，本意是降低查找成本】
<span class="hljs-bullet"> *</span> 【但当这个红黑树过大时，相对于直接扩容哈希表，查找成本较高】
<span class="hljs-bullet"> *</span> 在设置其初始容量时，应考虑映射中预期的元素数及其负载因子，以尽量减少重新哈希操作的数量。
<span class="hljs-bullet"> *</span> 【上文提及，频繁哈希化很影响性能】
<span class="hljs-bullet"> *</span> 如果初始容量大于元素最大数量除以负载因子所得的值，则永远不会发生重新哈希操作。
<span class="hljs-bullet"> *</span> 【哈希表的元素数量 / 桶数量 = 负载因子的值】
<span class="hljs-bullet"> *</span> 【元素最大数量除以负载因子所得的值 是 负载因子的逆推公式，仅此而已】
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>If many mappings are to be stored in a {@code HashMap}
<span class="hljs-bullet"> *</span> instance, creating it with a sufficiently large capacity will allow
<span class="hljs-bullet"> *</span> the mappings to be stored more efficiently than letting it perform
<span class="hljs-bullet"> *</span> automatic rehashing as needed to grow the table.  Note that using
<span class="hljs-bullet"> *</span> many keys with the same {@code hashCode()} is a sure way to slow
<span class="hljs-bullet"> *</span> down performance of any hash table. To ameliorate impact, when keys
<span class="hljs-bullet"> *</span> are {@link Comparable}, this class may use comparison order among
<span class="hljs-bullet"> *</span> keys to help break ties.
<span class="hljs-bullet"> *</span> 如果要在HashMap实例中存储多个映射，那么使用足够大的容量来创建它，相比于让它根据需要自动重新散列以扩展表，将能更高效地存储这些映射。
<span class="hljs-bullet"> *</span> 【这里 JDK 底层提及了：如果使用了足够大的容量去创建哈希表（引起哈希冲突的概率无限小），这会比让哈希表的桶生成链表更高效（单指时间复杂度）】
<span class="hljs-bullet"> *</span> 请注意，使用多个具有相同hashCode()的键肯定会降低任何哈希表的性能。
<span class="hljs-bullet"> *</span> 【即如果存在两个相同映射的键值对存入一个桶中，那么这个存在重复映射的哈希表 比 一个重复映射都没有的哈希表 性能低】
<span class="hljs-bullet"> *</span> 为了减轻影响，当键是Comparable时，这个类可能会使用键之间的比较顺序来帮助打破平局
<span class="hljs-bullet"> *</span> 【减轻重复键值对的影响】
<span class="hljs-bullet"> *</span> 【这里 JDK 创建了一个新的类 - Comparable，这是一个接口，只有一个方法：compareTo 比较的意思】
<span class="hljs-bullet"> *</span> 【打破平局的意思是： 单纯比较的意思】
<span class="hljs-bullet"> *</span> 【注：目前还不知道为什么比较，以及比较什么东西，再往下看看】
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span></span>Note that this implementation is not synchronized.<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span></span>
<span class="hljs-bullet"> *</span> If multiple threads access a hash map concurrently, and at least one of
<span class="hljs-bullet"> *</span> the threads modifies the map structurally, it <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>must<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span> be
<span class="hljs-bullet"> *</span> synchronized externally.  (A structural modification is any operation
<span class="hljs-bullet"> *</span> that adds or deletes one or more mappings; merely changing the value
<span class="hljs-bullet"> *</span> associated with a key that an instance already contains is not a
<span class="hljs-bullet"> *</span> structural modification.)  This is typically accomplished by
<span class="hljs-bullet"> *</span> synchronizing on some object that naturally encapsulates the map.
<span class="hljs-bullet"> *</span> If no such object exists, the map should be "wrapped" using the
<span class="hljs-bullet"> *</span> {@link Collections#synchronizedMap Collections.synchronizedMap}
<span class="hljs-bullet"> *</span> method.  This is best done at creation time, to prevent accidental
<span class="hljs-bullet"> *</span> unsynchronized access to the map:<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span></span>
<span class="hljs-bullet"> *</span>   Map m = Collections.synchronizedMap(new HashMap(...));<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span>
<span class="hljs-bullet"> *</span> 【这段话表达了，为了保障 HashMap 的线程安全性，不允许多个线程同时访问，所以给他加了锁】
<span class="hljs-bullet"> *</span> 请注意，此实现不是同步的。
<span class="hljs-bullet"> *</span> 如果多个线程同时访问 HashMap，并且至少有一个线程在结构上修改了映射，
<span class="hljs-bullet"> *</span> 则必须在外部进行同步。
<span class="hljs-bullet"> *</span> 【这段话的意思是，如果上述情况可能会发生，那么我们必须要对其进行互斥操作，也就是加锁】
<span class="hljs-bullet"> *</span> （结构修改是添加或删除一个或多个映射的任何操作；仅仅更改与实例已包含的键关联的值不是结构修改。）
<span class="hljs-bullet"> *</span> 这通常是通过在自然封装映射的某个对象上同步来实现的。
<span class="hljs-bullet"> *</span> 如果不存在这样的对象，则应使用Collections.synchronizedMap方法对映射进行“包装”。
<span class="hljs-bullet"> *</span> 这最好在创建时完成，以防止意外不同步地访问 map
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>The iterators returned by all of this class's "collection view methods"
<span class="hljs-bullet"> *</span> are <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>fail-fast<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span>: if the map is structurally modified at any time after
<span class="hljs-bullet"> *</span> the iterator is created, in any way except through the iterator's own
<span class="hljs-bullet"> *</span> {@code remove} method, the iterator will throw a
<span class="hljs-bullet"> *</span> {@link ConcurrentModificationException}.  Thus, in the face of concurrent
<span class="hljs-bullet"> *</span> modification, the iterator fails quickly and cleanly, rather than risking
<span class="hljs-bullet"> *</span> arbitrary, non-deterministic behavior at an undetermined time in the
<span class="hljs-bullet"> *</span> future.
<span class="hljs-bullet"> *</span> 【即：当 HashMap 被一个进程使用时，另一个进程想要访问，会使得前一个进程报错】
<span class="hljs-bullet"> *</span> 此类所有“集合视图方法”返回的迭代器都是快速失败的：
<span class="hljs-bullet"> *</span> 如果在迭代器创建后的任何时候，
<span class="hljs-bullet"> *</span> 以除迭代器自身的remove方法外的任何方式对映射进行结构修改，
<span class="hljs-bullet"> *</span> 迭代器将抛出ConcurrentModificationException。
<span class="hljs-bullet"> *</span> 因此，面对并发修改，迭代器会快速且干净地失败，而不是冒着在未来不确定的时间产生任意、非确定性行为的风险。
<span class="hljs-bullet"> *</span> 【这一段话的含义是： 倘若一个线程正在访问 HashMap 时，另一个线程也想访问，则会返回 ConcurrentModificationException 错误，并终止两个线程】
<span class="hljs-bullet"> *</span> 【详情请见实验 makeConcurrentModificationException 见本文最下方附件】
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>Note that the fail-fast behavior of an iterator cannot be guaranteed
<span class="hljs-bullet"> *</span> as it is, generally speaking, impossible to make any hard guarantees in the
<span class="hljs-bullet"> *</span> presence of unsynchronized concurrent modification.  Fail-fast iterators
<span class="hljs-bullet"> *</span> throw {@code ConcurrentModificationException} on a best-effort basis.
<span class="hljs-bullet"> *</span> Therefore, it would be wrong to write a program that depended on this
<span class="hljs-bullet"> *</span> exception for its correctness: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span></span>the fail-fast behavior of iterators
<span class="hljs-bullet"> *</span> should be used only to detect bugs.<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span>
<span class="hljs-bullet"> *</span> 【还是那句话，为了保障 HashMap 的线程安全， JDK 做了什么】
<span class="hljs-bullet"> *</span> 请注意，此实现不是同步的。
<span class="hljs-bullet"> *</span> 如果多个线程同时访问哈希映射，
<span class="hljs-bullet"> *</span> 并且至少有一个线程在结构上修改了映射，则必须在外部进行同步。
<span class="hljs-bullet"> *</span> （结构修改是添加或删除一个或多个映射的任何操作；仅仅更改与实例已包含的键关联的值不是结构修改。）
<span class="hljs-bullet"> *</span> 这通常是通过在自然封装映射的某个对象上同步来实现的。
<span class="hljs-bullet"> *</span> 如果不存在这样的对象，则应使用Collections.synchronizedMap方法对映射进行“包装”。
<span class="hljs-bullet"> *</span> 这最好在创建时完成，以防止意外不同步地访问地图：
<span class="hljs-bullet"> *</span>
 * <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span>This class is a member of the
<span class="hljs-bullet"> *</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"{@docRoot}/java.base/java/util/package-summary.html#CollectionsFramework"</span>&gt;</span></span>
<span class="hljs-bullet"> *</span> Java Collections Framework<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span>.
<span class="hljs-bullet"> *</span>
 * @param <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">K</span>&gt;</span></span> the type of keys maintained by this map
<span class="hljs-bullet"> *</span> @param <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">V</span>&gt;</span></span> the type of mapped values
<span class="hljs-bullet"> *</span> @author Doug Lea
<span class="hljs-bullet"> *</span> @author Josh Bloch
<span class="hljs-bullet"> *</span> @author Arthur van Hoff
<span class="hljs-bullet"> *</span> @author Neal Gafter
<span class="hljs-bullet"> *</span> @see Object#hashCode()
<span class="hljs-bullet"> *</span> @see Collection
<span class="hljs-bullet"> *</span> @see Map
<span class="hljs-bullet"> *</span> @see TreeMap
<span class="hljs-bullet"> *</span> @see Hashtable
<span class="hljs-bullet"> *</span> @since 1.2
 <span class="hljs-emphasis">*/
</span></code></pre>
<p>以下仍是 JDK 源码，简述了 JDK 对于哈希表的策略</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*
 * Implementation notes.
 *
 * This map usually acts as a binned (bucketed) hash table, but
 * when bins get too large, they are transformed into bins of
 * TreeNodes, each structured similarly to those in
 * java.util.TreeMap. Most methods try to use normal bins, but
 * relay to TreeNode methods when applicable (simply by checking
 * instanceof a node).  Bins of TreeNodes may be traversed and
 * used like any others, but additionally support faster lookup
 * when overpopulated. However, since the vast majority of bins in
 * normal use are not overpopulated, checking for existence of
 * tree bins may be delayed in the course of table methods.
 * 此映射通常充当一个分箱（bucketed）哈希表，
 * 【分箱可以简单理解为 桶】
 * 但当分箱太大时，它们会被转换为 TreeNodes 的分箱，每个分箱的结构都类似于java.util.中的分箱、树状图。
 * 【当 哈希表 桶内链表太大了，就会被转成树】
 * 大多数方法都尝试使用普通的容器，但在适用的情况下会中继到TreeNode方法（只需检查节点的实例）。
 * 【大多数时候都会采取链表，或者其他的普通桶，但是在合适的时候会转变成树】
 * TreeNodes的Bins【桶】可以像其他任何Bins一样被遍历和使用，但在过度填充时还支持更快的查找。
 * 然而，由于正常使用中的绝大多数桶都没有“人满为患”，在表格方法的过程中可能会延迟检查树箱的存在。
 *
 * Tree bins (i.e., bins whose elements are all TreeNodes) are
 * ordered primarily by hashCode, but in the case of ties, if two
 * elements are of the same "class C implements Comparable&lt;C&gt;",
 * type then their compareTo method is used for ordering. (We
 * conservatively check generic types via reflection to validate
 * this -- see method comparableClassFor).  The added complexity
 * of tree bins is worthwhile in providing worst-case O(log n)
 * operations when keys either have distinct hashes or are
 * orderable, Thus, performance degrades gracefully under
 * accidental or malicious usages in which hashCode() methods
 * return values that are poorly distributed, as well as those in
 * which many keys share a hashCode, so long as they are also
 * Comparable. (If neither of these apply, we may waste about a
 * factor of two in time and space compared to taking no
 * precautions. But the only known cases stem from poor user
 * programming practices that are already so slow that this makes
 * little difference.)
 * 树容器（即其元素都是TreeNode的容器）主要按hashCode排序，
 * 但在关系的情况下，如果两个元素属于相同的“类C实现Comparable&lt;C&gt;”，则使用其compareTo方法进行排序。
 * 【这里能发现 JDK 转变的是红黑树 - 从根节点开始，大于当前节点的树向向右，小于当前节点的树向左】
 * （我们通过反射保守地检查泛型类型以验证这一点——请参阅方法compareClassFor）。
 * 当键具有不同的哈希值或可排序时，树箱的额外复杂性在提供最坏情况下的O（log n）操作方面是值得的。
 * 【当发生哈希冲突过多，导致链表过长时，转变为红黑树会降低时间复杂度】
 * 因此，在意外或恶意使用下，性能会优雅地下降，
 * 【这里说，如果有人想要恶意使用相同的键值对想要搞崩哈希表，转变为红黑树的桶能降低性能损耗】
 * 其中hashCode()方法返回分布不均的值，以及许多键共享hashCode的值，只要它们也是可比的。
 * 【这里说，只要 桶 内元素的哈希值是可比的，红黑树就塞得下】
 * （如果这两种情况都不适用，与不采取预防措施相比，我们可能会浪费大约两倍的时间和空间。
 * 【如果这两个策略都不去使用，那就会浪费大概两倍的空间和时间】
 * 但唯一已知的情况源于糟糕的用户编程实践，这些实践已经非常缓慢，几乎没有什么区别。）
 * 【这里 JDK 开发者在吐槽】
 *
 * Because TreeNodes are about twice the size of regular nodes, we
 * use them only when bins contain enough nodes to warrant use
 * (see TREEIFY_THRESHOLD). And when they become too small (due to
 * removal or resizing) they are converted back to plain bins.  In
 * usages with well-distributed user hashCodes, tree bins are
 * rarely used.  Ideally, under random hashCodes, the frequency of
 * nodes in bins follows a Poisson distribution
 * (http://en.wikipedia.org/wiki/Poisson_distribution) with a
 * parameter of about 0.5 on average for the default resizing
 * threshold of 0.75, although with a large variance because of
 * resizing granularity. Ignoring variance, the expected
 * occurrences of list size k are (exp(-0.5) * pow(0.5, k) /
 * factorial(k)).
 * 因为TreeNodes的大小大约是常规节点的两倍，所以我们只在容器包含足够的节点时才使用它们（请参阅TREEIFY_THRESHOLD）。
 * 【这里说树的空间更大，只有空间足够时才会用】
 * 当它们变得太小（由于删除或调整大小）时，它们会被转换回普通垃圾箱。
 * 【这里说，如果树变小了，那可能会调整回链表】
 * 在使用分布良好的用户hashCode时，很少使用树箱。
 * 理想情况下，在随机hashCode下，bin中节点的频率遵循泊松分布默认的调整大小阈值0.75的参数平均约为0.5，尽管由于调整大小的粒度存在较大的差异。
 * 忽略方差，列表大小k的预期出现次数为（exp（-0.5）*pow（0.5，k）/阶乘（k））。
 * 【这里说产生树最大子节点的概率】
 *
 * The first values are:
 *
 * 0:    0.60653066
 * 1:    0.30326533
 * 2:    0.07581633
 * 3:    0.01263606
 * 4:    0.00157952
 * 5:    0.00015795
 * 6:    0.00001316
 * 7:    0.00000094
 * 8:    0.00000006
 * more: less than 1 in ten million
 *
 * The root of a tree bin is normally its first node.  However,
 * sometimes (currently only upon Iterator.remove), the root might
 * be elsewhere, but can be recovered following parent links
 * (method TreeNode.root()).
 * 树bin的根通常是它的第一个节点。
 * 然而，有时（目前仅在Iterator.remove时），根可能在其他地方，但可以在父链接后恢复（方法TreeNode.root（））。
 *
 * All applicable internal methods accept a hash code as an
 * argument (as normally supplied from a public method), allowing
 * them to call each other without recomputing user hashCodes.
 * Most internal methods also accept a "tab" argument, that is
 * normally the current table, but may be a new or old one when
 * resizing or converting.
 * 所有适用的内部方法都接受哈希码作为参数（通常由公共方法提供），允许它们在不重新计算用户哈希码的情况下相互调用。
 * 大多数内部方法也接受“tab”参数，通常是当前表，但在调整大小或转换时可能是新的或旧的。
 *
 * When bin lists are treeified, split, or untreeified, we keep
 * them in the same relative access/traversal order (i.e., field
 * Node.next) to better preserve locality, and to slightly
 * simplify handling of splits and traversals that invoke
 * iterator.remove. When using comparators on insertion, to keep a
 * total ordering (or as close as is required here) across
 * rebalancings, we compare classes and identityHashCodes as
 * tie-breakers.
 * 当bin列表被树化、拆分或未经测试时，
 * 我们将它们保持在相同的相对访问/遍历顺序中（即字段Node.next），以更好地保持局部性，并稍微简化对调用itera.remove的拆分和遍历的处理。
 * 当在插入时使用比较器时，为了在重新平衡过程中保持总顺序（或尽可能接近此处要求的顺序），
 * 我们将类和identityHashCodes作为连接断路器进行比较。
 *
 * The use and transitions among plain vs tree modes is
 * complicated by the existence of subclass LinkedHashMap. See
 * below for hook methods defined to be invoked upon insertion,
 * removal and access that allow LinkedHashMap internals to
 * otherwise remain independent of these mechanics. (This also
 * requires that a map instance be passed to some utility methods
 * that may create new nodes.)
 * 子类LinkedHashMap的存在使纯模式与树模式之间的使用和转换变得复杂。
 * 请参阅下文，了解在插入、删除和访问时定义的钩子方法，这些方法允许LinkedHashMap内部保持独立于这些机制。
 * （这也要求将映射实例传递给一些可能创建新节点的实用方法。）
 *
 * The concurrent-programming-like SSA-based coding style helps
 * avoid aliasing errors amid all of the twisty pointer operations.
 */</span>
</code></pre>
<p>以下是 JDK 怎么使用这些策略的</p>
<p>其中的重要分支（下图红色方框），则代表 判断链表长度是否满足创建树的条件，当条件满足时创建树，而这个创建树的条件是，链表长度大于 8</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/864e025aa47f424889113c1ad13a5148~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295556&amp;x-signature=qUpyVU0Xs%2FxMozFTfrqTo2d3FUM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">哈希算法</h3>
<p>哈希算法在源码中及其精简</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8537970af06a472f8f7c6f6278e104e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295556&amp;x-signature=kPTH8Qck4SN3mvOLiqilYFSbPao%3D" alt="" loading="lazy"/></p>
<p>你敢相信，这一段就是哈希算法吗？</p>
<p>让我们分割一下每一段运算，我们首先得知道：哈希值二进制是 32 位</p>
<ul>
<li>三元运算符：先判断 key 是否为 null 如果是 返回 0，如果不是 返回后面这一大段看起来很复杂的运算式</li>
<li>获取当前 key 的哈希值，并将它赋值给 h</li>
<li>将 h (32 位) 右移 16 位</li>
<li>按位异或 两个 32 位数</li>
</ul>
<p>着重讲一下为什么右移 bit 位、按位异或是什么以及为什么要按位异或</p>
<ul>
<li>右移 16 位的原因：结合哈希表的计算公式(哈希值对桶数量（数组长度）<code>capacity</code> 取模，从而获取该 <code>key</code> 对应的桶（数组索引）<code>index</code>)和桶数量不会过大这两个我们能知道，哈希表计算时基本上只有低位在进行运算，右移 16 位是获取当前哈希值的最高位。</li>
<li>什么是按位异或： 异或的规则非常简单：两个位相同则为 0，不同则为 1。</li>
<li>为什么要按位异或：为了扰动函数 (Perturbation) ，能让哈希值的高位与低位都参与运算，让高位的信息也参与到下标计算中，把“冲突”的概率降到最低。</li>
</ul>
<h5 data-id="heading-13">扩容机制</h5>
<p>扩容机制在 JDK 1.7 之前和 JDK 1.8 之后有着天壤之别</p>
<ul>
<li>JDK 1.7 之前： 扩容时需要重新计算每个元素的 Hash 值再塞到新表里，非常耗性能。</li>
<li>JDK 1.8 之后：👇</li>
</ul>
<p>利用了“扩容是 2 倍”的特性，不需要重新计算 Hash。它只需要检查 Hash 值中新增的那一个二进制位。</p>
<p>如果是 0：下标不变。</p>
<p>如果是 1：下标变为 原下标 + 原容量。</p>
<p>这极其高效，因为这只是一个简单的位运算判断，避免了大量的取模运算。这就是计算机底层位运算的魅力！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3d8697299684d5a82b9de4d269dce61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295556&amp;x-signature=8K0SyytFXENONg76C%2BEShxt9Dc8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">总结：</h2>
<p>内存里追求 CPU 缓存命中（用数组）。</p>
<p>复杂计算追求时间复杂度（用红黑树）。</p>
<p>磁盘存储追求减少 I/O（用 B+ 树）。</p>
<h2 data-id="heading-15">附件</h2>
<h3 data-id="heading-16">makeConcurrentModificationException</h3>
<p>代码：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-comment">/**
 * Writer: Serene Dream
 * Time: 2025/11/25 : 19:58
 * Explanation:
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">makeConcurrentModificationException</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-comment">// 先在 map 中增加一些数据</span>
        HashMap&lt;Integer, Integer&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            map.<span class="hljs-built_in">put</span>(i, i);
        }
        <span class="hljs-comment">// 两个进程，一个进程在使用 HashMap 还未完成时，另一个进程插入会发生什么</span>

        Thread t1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-comment">// 第一个进程对 map 内容进行访问，遍历</span>
            <span class="hljs-comment">// 我发现 map 中没有迭代器，只有对应的 Set 中才有，但是迭代器的作用就是循环，所以我认为迭代器的意思就是循环遍历</span>
            <span class="hljs-comment">// 文档中迭代器的意思可能代指正在遍历访问 HashMap 或者修改其中数据</span>
            Set&lt;Integer&gt; set = map.<span class="hljs-built_in">keySet</span>();
            <span class="hljs-keyword">for</span> (Integer key : set) {
                Integer value = map.<span class="hljs-built_in">get</span>(key);
                System.out.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"key = %d， value = %d"</span>, key, value);

                <span class="hljs-comment">// 让进程循环中开始睡眠，模拟还在占用 HashMap</span>
                <span class="hljs-keyword">try</span> {
                    Thread.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">1000</span>);
                } <span class="hljs-built_in">catch</span> (InterruptedException e) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(e);
                }
            }
        });

        Thread t2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-comment">// 让进程二睡眠一会，保证进程二在访问 HashMap 时 HashMap 必须被 t1 占用</span>
            <span class="hljs-keyword">try</span> {
                Thread.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">1000</span>);
            } <span class="hljs-built_in">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(e);
            }
            <span class="hljs-comment">// 第二个进程对 map 内容进行删除</span>
            map.<span class="hljs-built_in">remove</span>(<span class="hljs-number">1</span>);
        });

        t1.<span class="hljs-built_in">start</span>();
        t2.<span class="hljs-built_in">start</span>();
    }
}
</code></pre>
<p>运行结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/859494054c754d1bb4b5c163334d1a1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VyZW5lRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295556&amp;x-signature=9zWvcfFayVf%2BKeth1X95K3%2B23V4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！]]></title>    <link>https://juejin.cn/post/7600607462584860707</link>    <guid>https://juejin.cn/post/7600607462584860707</guid>    <pubDate>2026-01-30T00:18:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600607462584860707" data-draft-id="7600600904095678498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T00:18:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:18:27.000Z" title="Fri Jan 30 2026 00:18:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>Java开发者必知的5个性能优化黑魔法，让你的应用快如闪电！</strong></h3>
<h3 data-id="heading-1">引言</h3>
<p>在当今高并发的互联网时代，Java应用的性能优化已成为开发者必须掌握的技能。无论是应对百万级QPS的电商系统，还是处理海量数据的金融平台，性能瓶颈往往隐藏在代码的细微之处。本文将揭示5个鲜为人知但极其有效的Java性能优化"黑魔法"，这些技术源于JVM底层原理、JDK内部机制以及一线大厂的实战经验。掌握它们，你的Java应用将实现从"能跑"到"飞起"的质的飞跃。</p>
<h3 data-id="heading-2">1. 对象池化：超越GC的极限</h3>
<h4 data-id="heading-3">问题背景</h4>
<p>JVM的垃圾回收(GC)是Java著名的双刃剑。在高频创建/销毁对象的场景下（如HTTP请求处理），GC会成为性能杀手。</p>
<h4 data-id="heading-4">黑魔法实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Apache Commons Pool2示例</span>
GenericObjectPool&lt;ExpensiveObject&gt; pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasePooledObjectFactory</span>&lt;ExpensiveObject&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ExpensiveObject <span class="hljs-title function_">create</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpensiveObject</span>(); <span class="hljs-comment">// 初始化成本高的对象</span>
        }
    }
);

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">try</span> (PooledObject&lt;ExpensiveObject&gt; pooledObj = pool.borrowObject()) {
    <span class="hljs-type">ExpensiveObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> pooledObj.getObject();
    <span class="hljs-comment">// 使用obj...</span>
}
</code></pre>
<h4 data-id="heading-5">深度解析</h4>
<ul>
<li><strong>优势</strong>：避免频繁GC，对象复用率可达90%以上</li>
<li><strong>陷阱</strong>：必须确保返还的对象状态干净（参考Redis连接池的实现）</li>
<li><strong>进阶技巧</strong>：
<ul>
<li>使用ThreadLocal结合对象池实现线程级缓存</li>
<li>Netflix推荐的动态扩容策略：根据系统负载自动调整池大小</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">2. Unsafe类：绕过JVM的安全枷锁</h3>
<h4 data-id="heading-7">JVM的隐藏后门</h4>
<p><code>sun.misc.Unsafe</code>提供了直接操作内存、CAS原子操作等底层能力：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SuperFastCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> offset;
    
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            offset = unsafe.objectFieldOffset(
                SuperFastCounter.class.getDeclaredField(<span class="hljs-string">"value"</span>));
        } <span class="hljs-keyword">catch</span> (Exception ex) { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(ex); }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> value;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        unsafe.getAndAddLong(<span class="hljs-built_in">this</span>, offset, <span class="hljs-number">1L</span>);
    }
}
</code></pre>
<h4 data-id="heading-8">性能对比</h4>





















<table><thead><tr><th>操作方式</th><th>ops/ms (i9-13900K)</th></tr></thead><tbody><tr><td>synchronized</td><td>12,000</td></tr><tr><td>AtomicLong</td><td>48,000</td></tr><tr><td>Unsafe</td><td>65,000</td></tr></tbody></table>
<h4 data-id="heading-9">注意事项</h4>
<ul>
<li>Java模块系统限制了Unsafe的使用（可通过<code>--add-opens</code>解决）</li>
<li>Azul Zing JVM提供了更安全的替代API</li>
</ul>
<h3 data-id="heading-10">3. JMH微基准测试：发现隐藏的性能陷阱</h3>
<h4 data-id="heading-11">why JMH?</h4>
<p>传统计时方式无法避免JIT预热、死码消除等问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListBenchmark</span> {
    
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testForEach</span><span class="hljs-params">(Blackhole bh)</span> {
        List&lt;Integer&gt; list = IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">1000</span>)
                                .boxed().collect(toList());
        <span class="hljs-keyword">for</span>(Integer i : list) { bh.consume(i); }
    }
    
    <span class="hljs-meta">@Benchmark</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testForLoop</span><span class="hljs-params">(Blackhole bh)</span> {
        List&lt;Integer&gt; list = IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">1000</span>)
                                .boxed().collect(toList());
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;list.size(); i++) {
            bh.consume(list.get(i));
        }
    }
}
</code></pre>
<h4 data-id="heading-12">JMH揭示的真相：</h4>
<ol>
<li>ArrayList遍历时，for-index比foreach快15%（连续内存访问模式）</li>
<li>LinkedList场景完全相反（指针跳转成本）</li>
</ol>
<h3 data-id="heading-13">4. GraalVM Native Image：突破JIT天花板</h3>
<h4 data-id="heading-14">AOT编译实践：</h4>
<pre><code class="hljs language-bash" lang="bash">native-image -jar your-app.jar \
             --no-fallback \
             -H:+OptimizeForPerformance \
             -H:MaxHeapSize=2g \
             --enable-preview
</code></pre>
<h4 data-id="heading-15">Spring Boot集成：</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">Startup Time对比：</h4>




















<table><thead><tr><th>Runtime</th><th>Memory Footprint</th><th>Startup Time</th></tr></thead><tbody><tr><td>OpenJDK11</td><td>~300MB</td><td>~3s</td></tr><tr><td>Native Image</td><td>~45MB</td><td>~50ms</td></tr></tbody></table>
<p>适用场景：Serverless函数、CLI工具、K8S sidecar容器</p>
<h3 data-id="heading-17">5. Escape Analysis：让栈分配为你所用</h3>
<h4 data-id="heading-18">JIT的神奇优化：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> x, y;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> { 
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1_000_000</span>; i++) { 
            calculate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(i, i+<span class="hljs-number">1</span>)); <span class="hljs-comment">// Allocation eliminated!</span>
        } 
    } 
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(Point p)</span> { ... } 
} 
</code></pre>
<p>通过<code>-XX:+PrintEscapeAnalysis</code>查看优化日志：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">+++++ Eliminated allocation ...</span>
</code></pre>
<h4 data-id="heading-19">Stack Allocation规则：</h4>
<ol>
<li>Object不会传递到方法外部（非全局逃逸）</li>
<li>Object不会被其他线程访问（非线程逃逸）</li>
<li>Object未覆盖finalize()</li>
</ol>
<p>阿里中间件团队实测可减少30%以上的临时对象分配</p>
<h3 data-id="heading-20">CPU Cache友好编程</h3>
<h4 data-id="heading-21">False Sharing解决方案：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Contended</span> <span class="hljs-comment">// JDK8+注解（需开启-XX:-RestrictContended）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterCell</span> {
     <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> value;
}

<span class="hljs-comment">// OR手动填充：</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddedAtomicLong</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AtomicLong</span> { 
      <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> p1,p2,p3,p4,p5,p6,p7; <span class="hljs-comment">// pad to avoid false sharing </span>
}
</code></pre>
<p>Disruptor框架实测效果：</p>
<p><img alt="False Sharing对比图" src="" loading="lazy"/></p>
<h3 data-id="heading-22">JNI临界区优化技巧</h3>
<p>传统方式的问题：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processArray</span><span class="hljs-params">(JNIEnv *env, jintArray arr)</span> </span>{  
   jint *elements = env-&gt;<span class="hljs-built_in">GetIntArrayElements</span>(arr, <span class="hljs-literal">NULL</span>);
   <span class="hljs-keyword">if</span> (elements == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;
   
   <span class="hljs-comment">/* Heavy processing */</span>
   
   env-&gt;<span class="hljs-built_in">ReleaseIntArrayElements</span>(arr, elements, JNI_COMMIT); 
}  
</code></pre>
<p>改进方案——使用GetPrimitiveArrayCritical：</p>
<pre><code class="hljs language-c++" lang="c++">jint *elements = (jint *)env-&gt;<span class="hljs-built_in">GetPrimitiveArrayCritical</span>(arr, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">if</span> (elements == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;

<span class="hljs-comment">/* Faster access but NO JNI calls allowed */</span>

env-&gt;<span class="hljs-built_in">ReleasePrimitiveArrayCritical</span>(arr, elements, JNI_COMMIT);
</code></pre>
<p>实测吞吐量提升40%（特别是在ARM架构）</p>
<h3 data-id="heading-23">Garbage Collector调优新思路</h3>
<p>ZGC的秘密参数：</p>
<pre><code class="hljs language-ini" lang="ini">-XX:+UseZGC \
-XX:<span class="hljs-attr">ConcGCThreads</span>=<span class="hljs-number">4</span> \      <span class="hljs-comment"># CPU核心数的1/4  </span>
-XX:<span class="hljs-attr">SoftMaxHeapSize</span>=<span class="hljs-number">32</span>G \ <span class="hljs-comment"># Elastic Heap关键  </span>
-Xms24G -Xmx24G           <span class="hljs-comment"># Fixed heap建议模式  </span>
</code></pre>
<p>关键指标监控：</p>
<pre><code class="hljs language-bash" lang="bash">jstat -gcutil &lt;pid&gt; <span class="hljs-built_in">ls</span> ns ps ys cs gcc ygc fygc cgc gct ngcmn ngcmx ngc...
</code></pre>
<p>JDK17+新增功能——弹性元空间：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MetaspaceReclaimPolicy=balanced</span> \
-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+MetaspaceReclaimQuickStart</span> \
</code></pre>
<h3 data-id="heading-24">Vector API实战：SIMD加速计算</h3>
<p>JDK16预览示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">vectorComputation</span><span class="hljs-params">(<span class="hljs-type">float</span>[] a, <span class="hljs-type">float</span>[] b, <span class="hljs-type">float</span>[] c)</span> {  
   <span class="hljs-type">var</span> <span class="hljs-variable">va</span> <span class="hljs-operator">=</span> FloatVector.fromArray(FloatVector.SPECIES_256(), a, <span class="hljs-number">0</span>);  
   <span class="hljs-type">var</span> <span class="hljs-variable">vb</span> <span class="hljs-operator">=</span> FloatVector.fromArray(FloatVector.SPECIES_256(), b, <span class="hljs-number">0</span>);  
   <span class="hljs-type">var</span> <span class="hljs-variable">vc</span> <span class="hljs-operator">=</span> va.mul(va).add(vb.mul(vb)).neg();  
   vc.intoArray(c, <span class="hljs-number">0</span>);  
}  
</code></pre>
<p>与标量代码对比：</p>
<p><img alt="SIMD加速比" src="" loading="lazy"/></p>
<p>Intel AVX-512环境下矩阵运算提速8倍+</p>
<h3 data-id="heading-25">Java并发新模式：虚拟线程尝鲜</h3>
<p>Loom项目前瞻：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {     
   IntStream.range(<span class="hljs-number">0</span>,<span class="hljs-number">10_000</span>).forEach(i -&gt; executor.submit(() -&gt;{
      Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>));
      <span class="hljs-keyword">return</span> i;     
   }));
} <span class="hljs-comment">// Launch million threads!  </span>

<span class="hljs-comment">// Carrier threads实际数量=CPU核心数  </span>
</code></pre>
<p>与传统线程池对比：</p>
<p><img alt="虚拟线程吞吐量" src="" loading="lazy"/></p>
<p>适用于高并发IO密集型场景（如微服务网关）</p>
<hr/>
<h2 data-id="heading-26">The End</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>